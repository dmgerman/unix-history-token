begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2010-2012, 2014  Internet Systems Consortium, Inc. ("ISC")  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: opensslgost_link.c,v 1.5 2011/01/19 23:47:12 tbox Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_OPENSSL_GOST
end_ifdef

begin_include
include|#
directive|include
file|<isc/entropy.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dst/result.h>
end_include

begin_include
include|#
directive|include
file|"dst_internal.h"
end_include

begin_include
include|#
directive|include
file|"dst_openssl.h"
end_include

begin_include
include|#
directive|include
file|"dst_parse.h"
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/objects.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rsa.h>
end_include

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_decl_stmt
specifier|static
name|ENGINE
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|EVP_MD
modifier|*
name|opensslgost_digest
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
specifier|const
name|EVP_MD
modifier|*
name|EVP_gost
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|const
name|EVP_MD
modifier|*
name|EVP_gost
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|opensslgost_digest
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|DST_RET
parameter_list|(
name|a
parameter_list|)
value|{ret = a; goto err;}
end_define

begin_function_decl
specifier|static
name|isc_result_t
name|opensslgost_todns
parameter_list|(
specifier|const
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|isc_buffer_t
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|isc_result_t
name|opensslgost_createctx
parameter_list|(
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|dst_context_t
modifier|*
name|dctx
parameter_list|)
block|{
name|EVP_MD_CTX
modifier|*
name|evp_md_ctx
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|md
init|=
name|EVP_gost
argument_list|()
decl_stmt|;
name|UNUSED
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|md
operator|==
name|NULL
condition|)
return|return
operator|(
name|DST_R_OPENSSLFAILURE
operator|)
return|;
name|evp_md_ctx
operator|=
name|EVP_MD_CTX_create
argument_list|()
expr_stmt|;
if|if
condition|(
name|evp_md_ctx
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
if|if
condition|(
operator|!
name|EVP_DigestInit_ex
argument_list|(
name|evp_md_ctx
argument_list|,
name|md
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|EVP_MD_CTX_destroy
argument_list|(
name|evp_md_ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
name|dctx
operator|->
name|ctxdata
operator|.
name|evp_md_ctx
operator|=
name|evp_md_ctx
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|opensslgost_destroyctx
parameter_list|(
name|dst_context_t
modifier|*
name|dctx
parameter_list|)
block|{
name|EVP_MD_CTX
modifier|*
name|evp_md_ctx
init|=
name|dctx
operator|->
name|ctxdata
operator|.
name|evp_md_ctx
decl_stmt|;
if|if
condition|(
name|evp_md_ctx
operator|!=
name|NULL
condition|)
block|{
name|EVP_MD_CTX_destroy
argument_list|(
name|evp_md_ctx
argument_list|)
expr_stmt|;
name|dctx
operator|->
name|ctxdata
operator|.
name|evp_md_ctx
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|opensslgost_adddata
parameter_list|(
name|dst_context_t
modifier|*
name|dctx
parameter_list|,
specifier|const
name|isc_region_t
modifier|*
name|data
parameter_list|)
block|{
name|EVP_MD_CTX
modifier|*
name|evp_md_ctx
init|=
name|dctx
operator|->
name|ctxdata
operator|.
name|evp_md_ctx
decl_stmt|;
if|if
condition|(
operator|!
name|EVP_DigestUpdate
argument_list|(
name|evp_md_ctx
argument_list|,
name|data
operator|->
name|base
argument_list|,
name|data
operator|->
name|length
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|opensslgost_sign
parameter_list|(
name|dst_context_t
modifier|*
name|dctx
parameter_list|,
name|isc_buffer_t
modifier|*
name|sig
parameter_list|)
block|{
name|dst_key_t
modifier|*
name|key
init|=
name|dctx
operator|->
name|key
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|unsigned
name|int
name|siglen
init|=
literal|0
decl_stmt|;
name|EVP_MD_CTX
modifier|*
name|evp_md_ctx
init|=
name|dctx
operator|->
name|ctxdata
operator|.
name|evp_md_ctx
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pkey
init|=
name|key
operator|->
name|keydata
operator|.
name|pkey
decl_stmt|;
name|isc_buffer_availableregion
argument_list|(
name|sig
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
operator|(
name|unsigned
name|int
operator|)
name|EVP_PKEY_size
argument_list|(
name|pkey
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
if|if
condition|(
operator|!
name|EVP_SignFinal
argument_list|(
name|evp_md_ctx
argument_list|,
name|r
operator|.
name|base
argument_list|,
operator|&
name|siglen
argument_list|,
name|pkey
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
name|isc_buffer_add
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|opensslgost_verify
parameter_list|(
name|dst_context_t
modifier|*
name|dctx
parameter_list|,
specifier|const
name|isc_region_t
modifier|*
name|sig
parameter_list|)
block|{
name|dst_key_t
modifier|*
name|key
init|=
name|dctx
operator|->
name|key
decl_stmt|;
name|int
name|status
init|=
literal|0
decl_stmt|;
name|EVP_MD_CTX
modifier|*
name|evp_md_ctx
init|=
name|dctx
operator|->
name|ctxdata
operator|.
name|evp_md_ctx
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pkey
init|=
name|key
operator|->
name|keydata
operator|.
name|pkey
decl_stmt|;
name|status
operator|=
name|EVP_VerifyFinal
argument_list|(
name|evp_md_ctx
argument_list|,
name|sig
operator|->
name|base
argument_list|,
name|sig
operator|->
name|length
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
literal|1
case|:
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
case|case
literal|0
case|:
return|return
operator|(
name|dst__openssl_toresult
argument_list|(
name|DST_R_VERIFYFAILURE
argument_list|)
operator|)
return|;
default|default:
return|return
operator|(
name|dst__openssl_toresult3
argument_list|(
name|dctx
operator|->
name|category
argument_list|,
literal|"EVP_VerifyFinal"
argument_list|,
name|DST_R_VERIFYFAILURE
argument_list|)
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|opensslgost_compare
parameter_list|(
specifier|const
name|dst_key_t
modifier|*
name|key1
parameter_list|,
specifier|const
name|dst_key_t
modifier|*
name|key2
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|pkey1
decl_stmt|,
modifier|*
name|pkey2
decl_stmt|;
name|pkey1
operator|=
name|key1
operator|->
name|keydata
operator|.
name|pkey
expr_stmt|;
name|pkey2
operator|=
name|key2
operator|->
name|keydata
operator|.
name|pkey
expr_stmt|;
if|if
condition|(
name|pkey1
operator|==
name|NULL
operator|&&
name|pkey2
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
elseif|else
if|if
condition|(
name|pkey1
operator|==
name|NULL
operator|||
name|pkey2
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|EVP_PKEY_cmp
argument_list|(
name|pkey1
argument_list|,
name|pkey2
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|progress_cb
parameter_list|(
name|EVP_PKEY_CTX
modifier|*
name|ctx
parameter_list|)
block|{
union|union
block|{
name|void
modifier|*
name|dptr
decl_stmt|;
name|void
function_decl|(
modifier|*
name|fptr
function_decl|)
parameter_list|(
name|int
parameter_list|)
function_decl|;
block|}
name|u
union|;
name|int
name|p
decl_stmt|;
name|u
operator|.
name|dptr
operator|=
name|EVP_PKEY_CTX_get_app_data
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|p
operator|=
name|EVP_PKEY_CTX_get_keygen_info
argument_list|(
name|ctx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|.
name|fptr
operator|!=
name|NULL
condition|)
name|u
operator|.
name|fptr
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|opensslgost_generate
parameter_list|(
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|int
name|unused
parameter_list|,
name|void
function_decl|(
modifier|*
name|callback
function_decl|)
parameter_list|(
name|int
parameter_list|)
parameter_list|)
block|{
name|EVP_PKEY_CTX
modifier|*
name|ctx
decl_stmt|;
union|union
block|{
name|void
modifier|*
name|dptr
decl_stmt|;
name|void
function_decl|(
modifier|*
name|fptr
function_decl|)
parameter_list|(
name|int
parameter_list|)
function_decl|;
block|}
name|u
union|;
name|EVP_PKEY
modifier|*
name|pkey
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|ret
decl_stmt|;
name|UNUSED
argument_list|(
name|unused
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|EVP_PKEY_CTX_new_id
argument_list|(
name|NID_id_GostR3410_2001
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|DST_RET
argument_list|(
name|dst__openssl_toresult2
argument_list|(
literal|"EVP_PKEY_CTX_new_id"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|callback
operator|!=
name|NULL
condition|)
block|{
name|u
operator|.
name|fptr
operator|=
name|callback
expr_stmt|;
name|EVP_PKEY_CTX_set_app_data
argument_list|(
name|ctx
argument_list|,
name|u
operator|.
name|dptr
argument_list|)
expr_stmt|;
name|EVP_PKEY_CTX_set_cb
argument_list|(
name|ctx
argument_list|,
operator|&
name|progress_cb
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|EVP_PKEY_keygen_init
argument_list|(
name|ctx
argument_list|)
operator|<=
literal|0
condition|)
name|DST_RET
argument_list|(
name|dst__openssl_toresult2
argument_list|(
literal|"EVP_PKEY_keygen_init"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_CTX_ctrl_str
argument_list|(
name|ctx
argument_list|,
literal|"paramset"
argument_list|,
literal|"A"
argument_list|)
operator|<=
literal|0
condition|)
name|DST_RET
argument_list|(
name|dst__openssl_toresult2
argument_list|(
literal|"EVP_PKEY_CTX_ctrl_str"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_keygen
argument_list|(
name|ctx
argument_list|,
operator|&
name|pkey
argument_list|)
operator|<=
literal|0
condition|)
name|DST_RET
argument_list|(
name|dst__openssl_toresult2
argument_list|(
literal|"EVP_PKEY_keygen"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|->
name|keydata
operator|.
name|pkey
operator|=
name|pkey
expr_stmt|;
name|EVP_PKEY_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|err
label|:
if|if
condition|(
name|pkey
operator|!=
name|NULL
condition|)
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|!=
name|NULL
condition|)
name|EVP_PKEY_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|opensslgost_isprivate
parameter_list|(
specifier|const
name|dst_key_t
modifier|*
name|key
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|pkey
init|=
name|key
operator|->
name|keydata
operator|.
name|pkey
decl_stmt|;
name|EC_KEY
modifier|*
name|ec
decl_stmt|;
name|INSIST
argument_list|(
name|pkey
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ec
operator|=
name|EVP_PKEY_get0
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TF
argument_list|(
name|ec
operator|!=
name|NULL
operator|&&
name|EC_KEY_get0_private_key
argument_list|(
name|ec
argument_list|)
operator|!=
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|opensslgost_destroy
parameter_list|(
name|dst_key_t
modifier|*
name|key
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|pkey
init|=
name|key
operator|->
name|keydata
operator|.
name|pkey
decl_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
name|key
operator|->
name|keydata
operator|.
name|pkey
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|unsigned
name|char
name|gost_prefix
index|[
literal|37
index|]
init|=
block|{
literal|0x30
block|,
literal|0x63
block|,
literal|0x30
block|,
literal|0x1c
block|,
literal|0x06
block|,
literal|0x06
block|,
literal|0x2a
block|,
literal|0x85
block|,
literal|0x03
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x13
block|,
literal|0x30
block|,
literal|0x12
block|,
literal|0x06
block|,
literal|0x07
block|,
literal|0x2a
block|,
literal|0x85
block|,
literal|0x03
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x23
block|,
literal|0x01
block|,
literal|0x06
block|,
literal|0x07
block|,
literal|0x2a
block|,
literal|0x85
block|,
literal|0x03
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x1e
block|,
literal|0x01
block|,
literal|0x03
block|,
literal|0x43
block|,
literal|0x00
block|,
literal|0x04
block|,
literal|0x40
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|isc_result_t
name|opensslgost_todns
parameter_list|(
specifier|const
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|isc_buffer_t
modifier|*
name|data
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|pkey
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|unsigned
name|char
name|der
index|[
literal|37
operator|+
literal|64
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
name|REQUIRE
argument_list|(
name|key
operator|->
name|keydata
operator|.
name|pkey
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|pkey
operator|=
name|key
operator|->
name|keydata
operator|.
name|pkey
expr_stmt|;
name|isc_buffer_availableregion
argument_list|(
name|data
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
literal|64
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|p
operator|=
name|der
expr_stmt|;
name|len
operator|=
name|i2d_PUBKEY
argument_list|(
name|pkey
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|len
operator|==
sizeof|sizeof
argument_list|(
name|der
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|memcmp
argument_list|(
name|gost_prefix
argument_list|,
name|der
argument_list|,
literal|37
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|r
operator|.
name|base
argument_list|,
name|der
operator|+
literal|37
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
name|data
argument_list|,
literal|64
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|opensslgost_fromdns
parameter_list|(
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|isc_buffer_t
modifier|*
name|data
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pkey
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
name|der
index|[
literal|37
operator|+
literal|64
index|]
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|isc_buffer_remainingregion
argument_list|(
name|data
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|==
literal|0
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
if|if
condition|(
name|r
operator|.
name|length
operator|!=
literal|64
condition|)
return|return
operator|(
name|DST_R_INVALIDPUBLICKEY
operator|)
return|;
name|memmove
argument_list|(
name|der
argument_list|,
name|gost_prefix
argument_list|,
literal|37
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|der
operator|+
literal|37
argument_list|,
name|r
operator|.
name|base
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|isc_buffer_forward
argument_list|(
name|data
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|p
operator|=
name|der
expr_stmt|;
if|if
condition|(
name|d2i_PUBKEY
argument_list|(
operator|&
name|pkey
argument_list|,
operator|&
name|p
argument_list|,
operator|(
name|long
operator|)
sizeof|sizeof
argument_list|(
name|der
argument_list|)
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|dst__openssl_toresult2
argument_list|(
literal|"d2i_PUBKEY"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
operator|)
return|;
name|key
operator|->
name|keydata
operator|.
name|pkey
operator|=
name|pkey
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|opensslgost_tofile
parameter_list|(
specifier|const
name|dst_key_t
modifier|*
name|key
parameter_list|,
specifier|const
name|char
modifier|*
name|directory
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|pkey
decl_stmt|;
name|dst_private_t
name|priv
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|char
modifier|*
name|der
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|key
operator|->
name|keydata
operator|.
name|pkey
operator|==
name|NULL
condition|)
return|return
operator|(
name|DST_R_NULLKEY
operator|)
return|;
name|pkey
operator|=
name|key
operator|->
name|keydata
operator|.
name|pkey
expr_stmt|;
name|len
operator|=
name|i2d_PrivateKey
argument_list|(
name|pkey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|der
operator|=
name|isc_mem_get
argument_list|(
name|key
operator|->
name|mctx
argument_list|,
operator|(
name|size_t
operator|)
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|der
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|p
operator|=
name|der
expr_stmt|;
if|if
condition|(
name|i2d_PrivateKey
argument_list|(
name|pkey
argument_list|,
operator|&
name|p
argument_list|)
operator|!=
name|len
condition|)
block|{
name|result
operator|=
name|dst__openssl_toresult2
argument_list|(
literal|"i2d_PrivateKey"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|priv
operator|.
name|elements
index|[
literal|0
index|]
operator|.
name|tag
operator|=
name|TAG_GOST_PRIVASN1
expr_stmt|;
name|priv
operator|.
name|elements
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|priv
operator|.
name|elements
index|[
literal|0
index|]
operator|.
name|data
operator|=
name|der
expr_stmt|;
name|priv
operator|.
name|nelements
operator|=
name|GOST_NTAGS
expr_stmt|;
name|result
operator|=
name|dst__privstruct_writefile
argument_list|(
name|key
argument_list|,
operator|&
name|priv
argument_list|,
name|directory
argument_list|)
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|der
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|key
operator|->
name|mctx
argument_list|,
name|der
argument_list|,
operator|(
name|size_t
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|opensslgost_parse
parameter_list|(
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|isc_lex_t
modifier|*
name|lexer
parameter_list|,
name|dst_key_t
modifier|*
name|pub
parameter_list|)
block|{
name|dst_private_t
name|priv
decl_stmt|;
name|isc_result_t
name|ret
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|key
operator|->
name|mctx
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pkey
init|=
name|NULL
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|UNUSED
argument_list|(
name|pub
argument_list|)
expr_stmt|;
comment|/* read private key file */
name|ret
operator|=
name|dst__privstruct_parse
argument_list|(
name|key
argument_list|,
name|DST_ALG_ECCGOST
argument_list|,
name|lexer
argument_list|,
name|mctx
argument_list|,
operator|&
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|INSIST
argument_list|(
name|priv
operator|.
name|elements
index|[
literal|0
index|]
operator|.
name|tag
operator|==
name|TAG_GOST_PRIVASN1
argument_list|)
expr_stmt|;
name|p
operator|=
name|priv
operator|.
name|elements
index|[
literal|0
index|]
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|d2i_PrivateKey
argument_list|(
name|NID_id_GostR3410_2001
argument_list|,
operator|&
name|pkey
argument_list|,
operator|&
name|p
argument_list|,
operator|(
name|long
operator|)
name|priv
operator|.
name|elements
index|[
literal|0
index|]
operator|.
name|length
argument_list|)
operator|==
name|NULL
condition|)
name|DST_RET
argument_list|(
name|dst__openssl_toresult2
argument_list|(
literal|"d2i_PrivateKey"
argument_list|,
name|DST_R_INVALIDPRIVATEKEY
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|->
name|keydata
operator|.
name|pkey
operator|=
name|pkey
expr_stmt|;
name|key
operator|->
name|key_size
operator|=
name|EVP_PKEY_bits
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
name|dst__privstruct_free
argument_list|(
operator|&
name|priv
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|priv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|priv
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|err
label|:
if|if
condition|(
name|pkey
operator|!=
name|NULL
condition|)
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
name|opensslgost_destroy
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|dst__privstruct_free
argument_list|(
operator|&
name|priv
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|priv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|priv
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|opensslgost_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|e
operator|!=
name|NULL
condition|)
block|{
name|ENGINE_finish
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|e
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|dst_func_t
name|opensslgost_functions
init|=
block|{
name|opensslgost_createctx
block|,
name|opensslgost_destroyctx
block|,
name|opensslgost_adddata
block|,
name|opensslgost_sign
block|,
name|opensslgost_verify
block|,
name|NULL
block|,
comment|/*%< computesecret */
name|opensslgost_compare
block|,
name|NULL
block|,
comment|/*%< paramcompare */
name|opensslgost_generate
block|,
name|opensslgost_isprivate
block|,
name|opensslgost_destroy
block|,
name|opensslgost_todns
block|,
name|opensslgost_fromdns
block|,
name|opensslgost_tofile
block|,
name|opensslgost_parse
block|,
name|opensslgost_cleanup
block|,
name|NULL
block|,
comment|/*%< fromlabel */
name|NULL
block|,
comment|/*%< dump */
name|NULL
comment|/*%< restore */
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|isc_result_t
name|dst__opensslgost_init
parameter_list|(
name|dst_func_t
modifier|*
modifier|*
name|funcp
parameter_list|)
block|{
name|isc_result_t
name|ret
decl_stmt|;
name|REQUIRE
argument_list|(
name|funcp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* check if the gost engine works properly */
name|e
operator|=
name|ENGINE_by_id
argument_list|(
literal|"gost"
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
return|return
operator|(
name|dst__openssl_toresult2
argument_list|(
literal|"ENGINE_by_id"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
operator|)
return|;
if|if
condition|(
name|ENGINE_init
argument_list|(
name|e
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|ENGINE_free
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|e
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|dst__openssl_toresult2
argument_list|(
literal|"ENGINE_init"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
operator|)
return|;
block|}
comment|/* better than to rely on digest_gost symbol */
name|opensslgost_digest
operator|=
name|ENGINE_get_digest
argument_list|(
name|e
argument_list|,
name|NID_id_GostR3411_94
argument_list|)
expr_stmt|;
if|if
condition|(
name|opensslgost_digest
operator|==
name|NULL
condition|)
name|DST_RET
argument_list|(
name|dst__openssl_toresult2
argument_list|(
literal|"ENGINE_get_digest"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
argument_list|)
expr_stmt|;
comment|/* from openssl.cnf */
if|if
condition|(
name|ENGINE_register_pkey_asn1_meths
argument_list|(
name|e
argument_list|)
operator|<=
literal|0
condition|)
name|DST_RET
argument_list|(
name|dst__openssl_toresult2
argument_list|(
literal|"ENGINE_register_pkey_asn1_meths"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ENGINE_ctrl_cmd_string
argument_list|(
name|e
argument_list|,
literal|"CRYPT_PARAMS"
argument_list|,
literal|"id-Gost28147-89-CryptoPro-A-ParamSet"
argument_list|,
literal|0
argument_list|)
operator|<=
literal|0
condition|)
name|DST_RET
argument_list|(
name|dst__openssl_toresult2
argument_list|(
literal|"ENGINE_ctrl_cmd_string"
argument_list|,
name|DST_R_OPENSSLFAILURE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|funcp
operator|==
name|NULL
condition|)
operator|*
name|funcp
operator|=
operator|&
name|opensslgost_functions
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|err
label|:
name|ENGINE_finish
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|e
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* HAVE_OPENSSL_GOST */
end_comment

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_macro
name|EMPTY_TRANSLATION_UNIT
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_OPENSSL_GOST */
end_comment

begin_comment
comment|/*! \file */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/*  * $Id: dnssec.c,v 1.69.2.5.2.9 2006/01/04 23:50:20 marka Exp $  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/serial.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/dnssec.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/keyvalues.h>
end_include

begin_include
include|#
directive|include
file|<dns/message.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsig.h>
end_include

begin_comment
comment|/* for DNS_TSIG_FUDGE */
end_comment

begin_include
include|#
directive|include
file|<dst/result.h>
end_include

begin_define
define|#
directive|define
name|is_response
parameter_list|(
name|msg
parameter_list|)
value|(msg->flags& DNS_MESSAGEFLAG_QR)
end_define

begin_define
define|#
directive|define
name|RETERR
parameter_list|(
name|x
parameter_list|)
value|do { \ 	result = (x); \ 	if (result != ISC_R_SUCCESS) \ 		goto failure; \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|TYPE_SIGN
value|0
end_define

begin_define
define|#
directive|define
name|TYPE_VERIFY
value|1
end_define

begin_function_decl
specifier|static
name|isc_result_t
name|digest_callback
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|isc_region_t
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rdata_compare_wrapper
parameter_list|(
specifier|const
name|void
modifier|*
name|rdata1
parameter_list|,
specifier|const
name|void
modifier|*
name|rdata2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|rdataset_to_sortedarray
parameter_list|(
name|dns_rdataset_t
modifier|*
name|set
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_rdata_t
modifier|*
modifier|*
name|rdata
parameter_list|,
name|int
modifier|*
name|nrdata
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|isc_result_t
name|digest_callback
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|isc_region_t
modifier|*
name|data
parameter_list|)
block|{
name|dst_context_t
modifier|*
name|ctx
init|=
name|arg
decl_stmt|;
return|return
operator|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Make qsort happy.  */
end_comment

begin_function
specifier|static
name|int
name|rdata_compare_wrapper
parameter_list|(
specifier|const
name|void
modifier|*
name|rdata1
parameter_list|,
specifier|const
name|void
modifier|*
name|rdata2
parameter_list|)
block|{
return|return
operator|(
name|dns_rdata_compare
argument_list|(
operator|(
specifier|const
name|dns_rdata_t
operator|*
operator|)
name|rdata1
argument_list|,
operator|(
specifier|const
name|dns_rdata_t
operator|*
operator|)
name|rdata2
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Sort the rdataset into an array.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|rdataset_to_sortedarray
parameter_list|(
name|dns_rdataset_t
modifier|*
name|set
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_rdata_t
modifier|*
modifier|*
name|rdata
parameter_list|,
name|int
modifier|*
name|nrdata
parameter_list|)
block|{
name|isc_result_t
name|ret
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|,
name|n
decl_stmt|;
name|dns_rdata_t
modifier|*
name|data
decl_stmt|;
name|n
operator|=
name|dns_rdataset_count
argument_list|(
name|set
argument_list|)
expr_stmt|;
name|data
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|ret
operator|=
name|dns_rdataset_first
argument_list|(
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|data
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
comment|/* 	 * Put them in the array. 	 */
do|do
block|{
name|dns_rdata_init
argument_list|(
operator|&
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|set
argument_list|,
operator|&
name|data
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|dns_rdataset_next
argument_list|(
name|set
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
do|;
comment|/* 	 * Sort the array. 	 */
name|qsort
argument_list|(
name|data
argument_list|,
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|,
name|rdata_compare_wrapper
argument_list|)
expr_stmt|;
operator|*
name|rdata
operator|=
name|data
expr_stmt|;
operator|*
name|nrdata
operator|=
name|n
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dnssec_keyfromrdata
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dst_key_t
modifier|*
modifier|*
name|key
parameter_list|)
block|{
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|INSIST
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|rdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|key
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|*
name|key
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_key
operator|||
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_dnskey
argument_list|)
expr_stmt|;
name|dns_rdata_toregion
argument_list|(
name|rdata
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|(
name|dst_key_fromdns
argument_list|(
name|name
argument_list|,
name|rdata
operator|->
name|rdclass
argument_list|,
operator|&
name|b
argument_list|,
name|mctx
argument_list|,
name|key
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|digest_sig
parameter_list|(
name|dst_context_t
modifier|*
name|ctx
parameter_list|,
name|dns_rdata_t
modifier|*
name|sigrdata
parameter_list|,
name|dns_rdata_rrsig_t
modifier|*
name|sig
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|isc_result_t
name|ret
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_rdata_toregion
argument_list|(
name|sigrdata
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|r
operator|.
name|length
operator|>=
literal|19
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|=
literal|18
expr_stmt|;
name|ret
operator|=
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_name_downcase
argument_list|(
operator|&
name|sig
operator|->
name|signer
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_name_toregion
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
return|return
operator|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dnssec_sign
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|set
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|isc_stdtime_t
modifier|*
name|inception
parameter_list|,
name|isc_stdtime_t
modifier|*
name|expire
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_buffer_t
modifier|*
name|buffer
parameter_list|,
name|dns_rdata_t
modifier|*
name|sigrdata
parameter_list|)
block|{
name|dns_rdata_rrsig_t
name|sig
decl_stmt|;
name|dns_rdata_t
name|tmpsigrdata
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdatas
decl_stmt|;
name|int
name|nrdatas
decl_stmt|,
name|i
decl_stmt|;
name|isc_buffer_t
name|sigbuf
decl_stmt|,
name|envbuf
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|dst_context_t
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|ret
decl_stmt|;
name|isc_buffer_t
modifier|*
name|databuf
init|=
name|NULL
decl_stmt|;
name|char
name|data
index|[
literal|256
operator|+
literal|8
index|]
decl_stmt|;
name|isc_uint32_t
name|flags
decl_stmt|;
name|unsigned
name|int
name|sigsize
decl_stmt|;
name|dns_fixedname_t
name|fnewname
decl_stmt|;
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
operator|<=
literal|255
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|set
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|key
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|inception
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|expire
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|sigrdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|inception
operator|>=
operator|*
name|expire
condition|)
return|return
operator|(
name|DNS_R_INVALIDTIME
operator|)
return|;
comment|/* 	 * Is the key allowed to sign data? 	 */
name|flags
operator|=
name|dst_key_flags
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|DNS_KEYTYPE_NOAUTH
condition|)
return|return
operator|(
name|DNS_R_KEYUNAUTHORIZED
operator|)
return|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_KEYFLAG_OWNERMASK
operator|)
operator|!=
name|DNS_KEYOWNER_ZONE
condition|)
return|return
operator|(
name|DNS_R_KEYUNAUTHORIZED
operator|)
return|;
name|sig
operator|.
name|mctx
operator|=
name|mctx
expr_stmt|;
name|sig
operator|.
name|common
operator|.
name|rdclass
operator|=
name|set
operator|->
name|rdclass
expr_stmt|;
name|sig
operator|.
name|common
operator|.
name|rdtype
operator|=
name|dns_rdatatype_rrsig
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
operator|&
name|sig
operator|.
name|common
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|sig
operator|.
name|signer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
name|dst_key_name
argument_list|(
name|key
argument_list|)
argument_list|,
operator|&
name|sig
operator|.
name|signer
argument_list|)
expr_stmt|;
name|sig
operator|.
name|covered
operator|=
name|set
operator|->
name|type
expr_stmt|;
name|sig
operator|.
name|algorithm
operator|=
name|dst_key_alg
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|sig
operator|.
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|dns_name_iswildcard
argument_list|(
name|name
argument_list|)
condition|)
name|sig
operator|.
name|labels
operator|--
expr_stmt|;
name|sig
operator|.
name|originalttl
operator|=
name|set
operator|->
name|ttl
expr_stmt|;
name|sig
operator|.
name|timesigned
operator|=
operator|*
name|inception
expr_stmt|;
name|sig
operator|.
name|timeexpire
operator|=
operator|*
name|expire
expr_stmt|;
name|sig
operator|.
name|keyid
operator|=
name|dst_key_id
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dst_key_sigsize
argument_list|(
name|key
argument_list|,
operator|&
name|sigsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|sig
operator|.
name|siglen
operator|=
name|sigsize
expr_stmt|;
comment|/* 	 * The actual contents of sig.signature are not important yet, since 	 * they're not used in digest_sig(). 	 */
name|sig
operator|.
name|signature
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|sig
operator|.
name|siglen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sig
operator|.
name|signature
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|ret
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|databuf
argument_list|,
name|sigsize
operator|+
literal|256
operator|+
literal|18
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_signature
goto|;
name|dns_rdata_init
argument_list|(
operator|&
name|tmpsigrdata
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dns_rdata_fromstruct
argument_list|(
operator|&
name|tmpsigrdata
argument_list|,
name|sig
operator|.
name|common
operator|.
name|rdclass
argument_list|,
name|sig
operator|.
name|common
operator|.
name|rdtype
argument_list|,
operator|&
name|sig
argument_list|,
name|databuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_databuf
goto|;
name|ret
operator|=
name|dst_context_create
argument_list|(
name|key
argument_list|,
name|mctx
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_databuf
goto|;
comment|/* 	 * Digest the SIG rdata. 	 */
name|ret
operator|=
name|digest_sig
argument_list|(
name|ctx
argument_list|,
operator|&
name|tmpsigrdata
argument_list|,
operator|&
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_context
goto|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fnewname
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_name_downcase
argument_list|(
name|name
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_name_toregion
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
comment|/* 	 * Create an envelope for each rdata:<name|type|class|ttl>. 	 */
name|isc_buffer_init
argument_list|(
operator|&
name|envbuf
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|envbuf
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
operator|&
name|envbuf
argument_list|,
name|set
operator|->
name|type
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
operator|&
name|envbuf
argument_list|,
name|set
operator|->
name|rdclass
argument_list|)
expr_stmt|;
name|isc_buffer_putuint32
argument_list|(
operator|&
name|envbuf
argument_list|,
name|set
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdataset_to_sortedarray
argument_list|(
name|set
argument_list|,
name|mctx
argument_list|,
operator|&
name|rdatas
argument_list|,
operator|&
name|nrdatas
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_context
goto|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|envbuf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nrdatas
condition|;
name|i
operator|++
control|)
block|{
name|isc_uint16_t
name|len
decl_stmt|;
name|isc_buffer_t
name|lenbuf
decl_stmt|;
name|isc_region_t
name|lenr
decl_stmt|;
comment|/* 		 * Skip duplicates. 		 */
if|if
condition|(
name|i
operator|>
literal|0
operator|&&
name|dns_rdata_compare
argument_list|(
operator|&
name|rdatas
index|[
name|i
index|]
argument_list|,
operator|&
name|rdatas
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
comment|/* 		 * Digest the envelope. 		 */
name|ret
operator|=
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_array
goto|;
comment|/* 		 * Digest the length of the rdata. 		 */
name|isc_buffer_init
argument_list|(
operator|&
name|lenbuf
argument_list|,
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|rdatas
index|[
name|i
index|]
operator|.
name|length
operator|<
literal|65536
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
operator|&
name|lenbuf
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|rdatas
index|[
name|i
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|lenbuf
argument_list|,
operator|&
name|lenr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|lenr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_array
goto|;
comment|/* 		 * Digest the rdata. 		 */
name|ret
operator|=
name|dns_rdata_digest
argument_list|(
operator|&
name|rdatas
index|[
name|i
index|]
argument_list|,
name|digest_callback
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_array
goto|;
block|}
name|isc_buffer_init
argument_list|(
operator|&
name|sigbuf
argument_list|,
name|sig
operator|.
name|signature
argument_list|,
name|sig
operator|.
name|siglen
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dst_context_sign
argument_list|(
name|ctx
argument_list|,
operator|&
name|sigbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_array
goto|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|sigbuf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|!=
name|sig
operator|.
name|siglen
condition|)
block|{
name|ret
operator|=
name|ISC_R_NOSPACE
expr_stmt|;
goto|goto
name|cleanup_array
goto|;
block|}
name|memcpy
argument_list|(
name|sig
operator|.
name|signature
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|sig
operator|.
name|siglen
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dns_rdata_fromstruct
argument_list|(
name|sigrdata
argument_list|,
name|sig
operator|.
name|common
operator|.
name|rdclass
argument_list|,
name|sig
operator|.
name|common
operator|.
name|rdtype
argument_list|,
operator|&
name|sig
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|cleanup_array
label|:
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rdatas
argument_list|,
name|nrdatas
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
name|cleanup_context
label|:
name|dst_context_destroy
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|cleanup_databuf
label|:
name|isc_buffer_free
argument_list|(
operator|&
name|databuf
argument_list|)
expr_stmt|;
name|cleanup_signature
label|:
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sig
operator|.
name|signature
argument_list|,
name|sig
operator|.
name|siglen
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dnssec_verify2
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|set
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|isc_boolean_t
name|ignoretime
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_rdata_t
modifier|*
name|sigrdata
parameter_list|,
name|dns_name_t
modifier|*
name|wild
parameter_list|)
block|{
name|dns_rdata_rrsig_t
name|sig
decl_stmt|;
name|dns_fixedname_t
name|fnewname
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_buffer_t
name|envbuf
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdatas
decl_stmt|;
name|int
name|nrdatas
decl_stmt|,
name|i
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|isc_result_t
name|ret
decl_stmt|;
name|unsigned
name|char
name|data
index|[
literal|300
index|]
decl_stmt|;
name|dst_context_t
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|int
name|labels
init|=
literal|0
decl_stmt|;
name|isc_uint32_t
name|flags
decl_stmt|;
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|set
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|key
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|sigrdata
operator|!=
name|NULL
operator|&&
name|sigrdata
operator|->
name|type
operator|==
name|dns_rdatatype_rrsig
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dns_rdata_tostruct
argument_list|(
name|sigrdata
argument_list|,
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ret
operator|)
return|;
if|if
condition|(
name|isc_serial_lt
argument_list|(
name|sig
operator|.
name|timeexpire
argument_list|,
name|sig
operator|.
name|timesigned
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_SIGINVALID
operator|)
return|;
if|if
condition|(
operator|!
name|ignoretime
condition|)
block|{
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* 		 * Is SIG temporally valid? 		 */
if|if
condition|(
name|isc_serial_lt
argument_list|(
operator|(
name|isc_uint32_t
operator|)
name|now
argument_list|,
name|sig
operator|.
name|timesigned
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_SIGFUTURE
operator|)
return|;
elseif|else
if|if
condition|(
name|isc_serial_lt
argument_list|(
name|sig
operator|.
name|timeexpire
argument_list|,
operator|(
name|isc_uint32_t
operator|)
name|now
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_SIGEXPIRED
operator|)
return|;
block|}
comment|/* 	 * Is the key allowed to sign data? 	 */
name|flags
operator|=
name|dst_key_flags
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|DNS_KEYTYPE_NOAUTH
condition|)
return|return
operator|(
name|DNS_R_KEYUNAUTHORIZED
operator|)
return|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_KEYFLAG_OWNERMASK
operator|)
operator|!=
name|DNS_KEYOWNER_ZONE
condition|)
return|return
operator|(
name|DNS_R_KEYUNAUTHORIZED
operator|)
return|;
name|ret
operator|=
name|dst_context_create
argument_list|(
name|key
argument_list|,
name|mctx
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_struct
goto|;
comment|/* 	 * Digest the SIG rdata (not including the signature). 	 */
name|ret
operator|=
name|digest_sig
argument_list|(
name|ctx
argument_list|,
name|sigrdata
argument_list|,
operator|&
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_context
goto|;
comment|/* 	 * If the name is an expanded wildcard, use the wildcard name. 	 */
name|dns_fixedname_init
argument_list|(
operator|&
name|fnewname
argument_list|)
expr_stmt|;
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|labels
operator|-
name|sig
operator|.
name|labels
operator|>
literal|0
condition|)
block|{
name|dns_name_split
argument_list|(
name|name
argument_list|,
name|sig
operator|.
name|labels
operator|+
literal|1
argument_list|,
name|NULL
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_name_downcase
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
else|else
name|dns_name_downcase
argument_list|(
name|name
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_toregion
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
comment|/* 	 * Create an envelope for each rdata:<name|type|class|ttl>. 	 */
name|isc_buffer_init
argument_list|(
operator|&
name|envbuf
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|labels
operator|-
name|sig
operator|.
name|labels
operator|>
literal|0
condition|)
block|{
name|isc_buffer_putuint8
argument_list|(
operator|&
name|envbuf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isc_buffer_putuint8
argument_list|(
operator|&
name|envbuf
argument_list|,
literal|'*'
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|+
literal|2
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
else|else
name|memcpy
argument_list|(
name|data
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|envbuf
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
operator|&
name|envbuf
argument_list|,
name|set
operator|->
name|type
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
operator|&
name|envbuf
argument_list|,
name|set
operator|->
name|rdclass
argument_list|)
expr_stmt|;
name|isc_buffer_putuint32
argument_list|(
operator|&
name|envbuf
argument_list|,
name|sig
operator|.
name|originalttl
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdataset_to_sortedarray
argument_list|(
name|set
argument_list|,
name|mctx
argument_list|,
operator|&
name|rdatas
argument_list|,
operator|&
name|nrdatas
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_context
goto|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|envbuf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nrdatas
condition|;
name|i
operator|++
control|)
block|{
name|isc_uint16_t
name|len
decl_stmt|;
name|isc_buffer_t
name|lenbuf
decl_stmt|;
name|isc_region_t
name|lenr
decl_stmt|;
comment|/* 		 * Skip duplicates. 		 */
if|if
condition|(
name|i
operator|>
literal|0
operator|&&
name|dns_rdata_compare
argument_list|(
operator|&
name|rdatas
index|[
name|i
index|]
argument_list|,
operator|&
name|rdatas
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
comment|/* 		 * Digest the envelope. 		 */
name|ret
operator|=
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_array
goto|;
comment|/* 		 * Digest the rdata length. 		 */
name|isc_buffer_init
argument_list|(
operator|&
name|lenbuf
argument_list|,
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|rdatas
index|[
name|i
index|]
operator|.
name|length
operator|<
literal|65536
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
operator|&
name|lenbuf
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|rdatas
index|[
name|i
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|lenbuf
argument_list|,
operator|&
name|lenr
argument_list|)
expr_stmt|;
comment|/* 		 * Digest the rdata. 		 */
name|ret
operator|=
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|lenr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_array
goto|;
name|ret
operator|=
name|dns_rdata_digest
argument_list|(
operator|&
name|rdatas
index|[
name|i
index|]
argument_list|,
name|digest_callback
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_array
goto|;
block|}
name|r
operator|.
name|base
operator|=
name|sig
operator|.
name|signature
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|sig
operator|.
name|siglen
expr_stmt|;
name|ret
operator|=
name|dst_context_verify
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|DST_R_VERIFYFAILURE
condition|)
name|ret
operator|=
name|DNS_R_SIGINVALID
expr_stmt|;
name|cleanup_array
label|:
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rdatas
argument_list|,
name|nrdatas
operator|*
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
name|cleanup_context
label|:
name|dst_context_destroy
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|cleanup_struct
label|:
name|dns_rdata_freestruct
argument_list|(
operator|&
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ISC_R_SUCCESS
operator|&&
name|labels
operator|-
name|sig
operator|.
name|labels
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|wild
operator|!=
name|NULL
condition|)
name|RUNTIME_CHECK
argument_list|(
name|dns_name_concatenate
argument_list|(
name|dns_wildcardname
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
argument_list|,
name|wild
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DNS_R_FROMWILDCARD
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dnssec_verify
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|set
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|isc_boolean_t
name|ignoretime
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_rdata_t
modifier|*
name|sigrdata
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_dnssec_verify2
argument_list|(
name|name
argument_list|,
name|set
argument_list|,
name|key
argument_list|,
name|ignoretime
argument_list|,
name|mctx
argument_list|,
name|sigrdata
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_FROMWILDCARD
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|is_zone_key
parameter_list|(
name|key
parameter_list|)
value|((dst_key_flags(key)& DNS_KEYFLAG_OWNERMASK) \ 			  == DNS_KEYOWNER_ZONE)
end_define

begin_function
name|isc_result_t
name|dns_dnssec_findzonekeys2
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|ver
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|directory
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|unsigned
name|int
name|maxkeys
parameter_list|,
name|dst_key_t
modifier|*
modifier|*
name|keys
parameter_list|,
name|unsigned
name|int
modifier|*
name|nkeys
parameter_list|)
block|{
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dst_key_t
modifier|*
name|pubkey
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|count
init|=
literal|0
decl_stmt|;
operator|*
name|nkeys
operator|=
literal|0
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_db_findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|ver
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|rdataset
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_rdataset_first
argument_list|(
operator|&
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|count
operator|<
name|maxkeys
condition|)
block|{
name|pubkey
operator|=
name|NULL
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_dnssec_keyfromrdata
argument_list|(
name|name
argument_list|,
operator|&
name|rdata
argument_list|,
name|mctx
argument_list|,
operator|&
name|pubkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_zone_key
argument_list|(
name|pubkey
argument_list|)
condition|)
goto|goto
name|next
goto|;
name|keys
index|[
name|count
index|]
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dst_key_fromfile
argument_list|(
name|dst_key_name
argument_list|(
name|pubkey
argument_list|)
argument_list|,
name|dst_key_id
argument_list|(
name|pubkey
argument_list|)
argument_list|,
name|dst_key_alg
argument_list|(
name|pubkey
argument_list|)
argument_list|,
name|DST_TYPE_PUBLIC
operator||
name|DST_TYPE_PRIVATE
argument_list|,
name|directory
argument_list|,
name|mctx
argument_list|,
operator|&
name|keys
index|[
name|count
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_FILENOTFOUND
condition|)
goto|goto
name|next
goto|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
if|if
condition|(
operator|(
name|dst_key_flags
argument_list|(
name|keys
index|[
name|count
index|]
argument_list|)
operator|&
name|DNS_KEYTYPE_NOAUTH
operator|)
operator|!=
literal|0
condition|)
block|{
name|dst_key_free
argument_list|(
operator|&
name|keys
index|[
name|count
index|]
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
name|count
operator|++
expr_stmt|;
name|next
label|:
name|dst_key_free
argument_list|(
operator|&
name|pubkey
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
goto|goto
name|failure
goto|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|pubkey
operator|!=
name|NULL
condition|)
name|dst_key_free
argument_list|(
operator|&
name|pubkey
argument_list|)
expr_stmt|;
operator|*
name|nkeys
operator|=
name|count
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dnssec_findzonekeys
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|ver
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|unsigned
name|int
name|maxkeys
parameter_list|,
name|dst_key_t
modifier|*
modifier|*
name|keys
parameter_list|,
name|unsigned
name|int
modifier|*
name|nkeys
parameter_list|)
block|{
return|return
operator|(
name|dns_dnssec_findzonekeys2
argument_list|(
name|db
argument_list|,
name|ver
argument_list|,
name|node
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|,
name|mctx
argument_list|,
name|maxkeys
argument_list|,
name|keys
argument_list|,
name|nkeys
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dnssec_signmessage
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|)
block|{
name|dns_rdata_sig_t
name|sig
decl_stmt|;
comment|/* SIG(0) */
name|unsigned
name|char
name|data
index|[
literal|512
index|]
decl_stmt|;
name|unsigned
name|char
name|header
index|[
name|DNS_MESSAGE_HEADERLEN
index|]
decl_stmt|;
name|isc_buffer_t
name|headerbuf
decl_stmt|,
name|databuf
decl_stmt|,
name|sigbuf
decl_stmt|;
name|unsigned
name|int
name|sigsize
decl_stmt|;
name|isc_buffer_t
modifier|*
name|dynbuf
init|=
name|NULL
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|datalist
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|dataset
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|dst_context_t
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_boolean_t
name|signeedsfree
init|=
name|ISC_TRUE
decl_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|key
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_response
argument_list|(
name|msg
argument_list|)
condition|)
name|REQUIRE
argument_list|(
name|msg
operator|->
name|query
operator|.
name|base
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|msg
operator|->
name|mctx
expr_stmt|;
name|memset
argument_list|(
operator|&
name|sig
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sig
argument_list|)
argument_list|)
expr_stmt|;
name|sig
operator|.
name|mctx
operator|=
name|mctx
expr_stmt|;
name|sig
operator|.
name|common
operator|.
name|rdclass
operator|=
name|dns_rdataclass_any
expr_stmt|;
name|sig
operator|.
name|common
operator|.
name|rdtype
operator|=
name|dns_rdatatype_sig
expr_stmt|;
comment|/* SIG(0) */
name|ISC_LINK_INIT
argument_list|(
operator|&
name|sig
operator|.
name|common
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|sig
operator|.
name|covered
operator|=
literal|0
expr_stmt|;
name|sig
operator|.
name|algorithm
operator|=
name|dst_key_alg
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|sig
operator|.
name|labels
operator|=
literal|0
expr_stmt|;
comment|/* the root name */
name|sig
operator|.
name|originalttl
operator|=
literal|0
expr_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|sig
operator|.
name|timesigned
operator|=
name|now
operator|-
name|DNS_TSIG_FUDGE
expr_stmt|;
name|sig
operator|.
name|timeexpire
operator|=
name|now
operator|+
name|DNS_TSIG_FUDGE
expr_stmt|;
name|sig
operator|.
name|keyid
operator|=
name|dst_key_id
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|sig
operator|.
name|signer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
name|dst_key_name
argument_list|(
name|key
argument_list|)
argument_list|,
operator|&
name|sig
operator|.
name|signer
argument_list|)
expr_stmt|;
name|sig
operator|.
name|siglen
operator|=
literal|0
expr_stmt|;
name|sig
operator|.
name|signature
operator|=
name|NULL
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|databuf
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dst_context_create
argument_list|(
name|key
argument_list|,
name|mctx
argument_list|,
operator|&
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Digest the fields of the SIG - we can cheat and use 	 * dns_rdata_fromstruct.  Since siglen is 0, the digested data 	 * is identical to dns format. 	 */
name|RETERR
argument_list|(
name|dns_rdata_fromstruct
argument_list|(
name|NULL
argument_list|,
name|dns_rdataclass_any
argument_list|,
name|dns_rdatatype_sig
comment|/* SIG(0) */
argument_list|,
operator|&
name|sig
argument_list|,
operator|&
name|databuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|databuf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * If this is a response, digest the query. 	 */
if|if
condition|(
name|is_response
argument_list|(
name|msg
argument_list|)
condition|)
name|RETERR
argument_list|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|msg
operator|->
name|query
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Digest the header. 	 */
name|isc_buffer_init
argument_list|(
operator|&
name|headerbuf
argument_list|,
name|header
argument_list|,
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|)
expr_stmt|;
name|dns_message_renderheader
argument_list|(
name|msg
argument_list|,
operator|&
name|headerbuf
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|headerbuf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Digest the remainder of the message. 	 */
name|isc_buffer_usedregion
argument_list|(
name|msg
operator|->
name|buffer
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|isc_region_consume
argument_list|(
operator|&
name|r
argument_list|,
name|DNS_MESSAGE_HEADERLEN
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dst_key_sigsize
argument_list|(
name|key
argument_list|,
operator|&
name|sigsize
argument_list|)
argument_list|)
expr_stmt|;
name|sig
operator|.
name|siglen
operator|=
name|sigsize
expr_stmt|;
name|sig
operator|.
name|signature
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|sig
operator|.
name|siglen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sig
operator|.
name|signature
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|isc_buffer_init
argument_list|(
operator|&
name|sigbuf
argument_list|,
name|sig
operator|.
name|signature
argument_list|,
name|sig
operator|.
name|siglen
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dst_context_sign
argument_list|(
name|ctx
argument_list|,
operator|&
name|sigbuf
argument_list|)
argument_list|)
expr_stmt|;
name|dst_context_destroy
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|rdata
operator|=
name|NULL
expr_stmt|;
name|RETERR
argument_list|(
name|dns_message_gettemprdata
argument_list|(
name|msg
argument_list|,
operator|&
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|isc_buffer_allocate
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
operator|&
name|dynbuf
argument_list|,
literal|1024
argument_list|)
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_rdata_fromstruct
argument_list|(
name|rdata
argument_list|,
name|dns_rdataclass_any
argument_list|,
name|dns_rdatatype_sig
comment|/* SIG(0) */
argument_list|,
operator|&
name|sig
argument_list|,
name|dynbuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sig
operator|.
name|signature
argument_list|,
name|sig
operator|.
name|siglen
argument_list|)
expr_stmt|;
name|signeedsfree
operator|=
name|ISC_FALSE
expr_stmt|;
name|dns_message_takebuffer
argument_list|(
name|msg
argument_list|,
operator|&
name|dynbuf
argument_list|)
expr_stmt|;
name|datalist
operator|=
name|NULL
expr_stmt|;
name|RETERR
argument_list|(
name|dns_message_gettemprdatalist
argument_list|(
name|msg
argument_list|,
operator|&
name|datalist
argument_list|)
argument_list|)
expr_stmt|;
name|datalist
operator|->
name|rdclass
operator|=
name|dns_rdataclass_any
expr_stmt|;
name|datalist
operator|->
name|type
operator|=
name|dns_rdatatype_sig
expr_stmt|;
comment|/* SIG(0) */
name|datalist
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
name|datalist
operator|->
name|ttl
operator|=
literal|0
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|datalist
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|datalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dataset
operator|=
name|NULL
expr_stmt|;
name|RETERR
argument_list|(
name|dns_message_gettemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|dataset
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|dataset
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
name|datalist
argument_list|,
name|dataset
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|msg
operator|->
name|sig0
operator|=
name|dataset
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|failure
label|:
if|if
condition|(
name|dynbuf
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|dynbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|signeedsfree
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sig
operator|.
name|signature
argument_list|,
name|sig
operator|.
name|siglen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|!=
name|NULL
condition|)
name|dst_context_destroy
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dnssec_verifymessage
parameter_list|(
name|isc_buffer_t
modifier|*
name|source
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|)
block|{
name|dns_rdata_sig_t
name|sig
decl_stmt|;
comment|/* SIG(0) */
name|unsigned
name|char
name|header
index|[
name|DNS_MESSAGE_HEADERLEN
index|]
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|,
name|source_r
decl_stmt|,
name|sig_r
decl_stmt|,
name|header_r
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|dst_context_t
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint16_t
name|addcount
decl_stmt|;
name|isc_boolean_t
name|signeedsfree
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|source
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|key
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|msg
operator|->
name|mctx
expr_stmt|;
name|msg
operator|->
name|verify_attempted
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|is_response
argument_list|(
name|msg
argument_list|)
condition|)
block|{
if|if
condition|(
name|msg
operator|->
name|query
operator|.
name|base
operator|==
name|NULL
condition|)
return|return
operator|(
name|DNS_R_UNEXPECTEDTSIG
operator|)
return|;
block|}
name|isc_buffer_usedregion
argument_list|(
name|source
argument_list|,
operator|&
name|source_r
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_rdataset_first
argument_list|(
name|msg
operator|->
name|sig0
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|msg
operator|->
name|sig0
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|RETERR
argument_list|(
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|signeedsfree
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|sig
operator|.
name|labels
operator|!=
literal|0
condition|)
block|{
name|result
operator|=
name|DNS_R_SIGINVALID
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
if|if
condition|(
name|isc_serial_lt
argument_list|(
name|sig
operator|.
name|timeexpire
argument_list|,
name|sig
operator|.
name|timesigned
argument_list|)
condition|)
block|{
name|result
operator|=
name|DNS_R_SIGINVALID
expr_stmt|;
name|msg
operator|->
name|sig0status
operator|=
name|dns_tsigerror_badtime
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_serial_lt
argument_list|(
operator|(
name|isc_uint32_t
operator|)
name|now
argument_list|,
name|sig
operator|.
name|timesigned
argument_list|)
condition|)
block|{
name|result
operator|=
name|DNS_R_SIGFUTURE
expr_stmt|;
name|msg
operator|->
name|sig0status
operator|=
name|dns_tsigerror_badtime
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
elseif|else
if|if
condition|(
name|isc_serial_lt
argument_list|(
name|sig
operator|.
name|timeexpire
argument_list|,
operator|(
name|isc_uint32_t
operator|)
name|now
argument_list|)
condition|)
block|{
name|result
operator|=
name|DNS_R_SIGEXPIRED
expr_stmt|;
name|msg
operator|->
name|sig0status
operator|=
name|dns_tsigerror_badtime
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
if|if
condition|(
operator|!
name|dns_name_equal
argument_list|(
name|dst_key_name
argument_list|(
name|key
argument_list|)
argument_list|,
operator|&
name|sig
operator|.
name|signer
argument_list|)
condition|)
block|{
name|result
operator|=
name|DNS_R_SIGINVALID
expr_stmt|;
name|msg
operator|->
name|sig0status
operator|=
name|dns_tsigerror_badkey
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|RETERR
argument_list|(
name|dst_context_create
argument_list|(
name|key
argument_list|,
name|mctx
argument_list|,
operator|&
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  	 * Digest the SIG(0) record, except for the signature. 	 */
name|dns_rdata_toregion
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|-=
name|sig
operator|.
name|siglen
expr_stmt|;
name|RETERR
argument_list|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * If this is a response, digest the query. 	 */
if|if
condition|(
name|is_response
argument_list|(
name|msg
argument_list|)
condition|)
name|RETERR
argument_list|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|msg
operator|->
name|query
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Extract the header. 	 */
name|memcpy
argument_list|(
name|header
argument_list|,
name|source_r
operator|.
name|base
argument_list|,
name|DNS_MESSAGE_HEADERLEN
argument_list|)
expr_stmt|;
comment|/* 	 * Decrement the additional field counter. 	 */
name|memcpy
argument_list|(
operator|&
name|addcount
argument_list|,
operator|&
name|header
index|[
name|DNS_MESSAGE_HEADERLEN
operator|-
literal|2
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|addcount
operator|=
name|htons
argument_list|(
call|(
name|isc_uint16_t
call|)
argument_list|(
name|ntohs
argument_list|(
name|addcount
argument_list|)
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|header
index|[
name|DNS_MESSAGE_HEADERLEN
operator|-
literal|2
index|]
argument_list|,
operator|&
name|addcount
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* 	 * Digest the modified header. 	 */
name|header_r
operator|.
name|base
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|header
expr_stmt|;
name|header_r
operator|.
name|length
operator|=
name|DNS_MESSAGE_HEADERLEN
expr_stmt|;
name|RETERR
argument_list|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|header_r
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Digest all non-SIG(0) records. 	 */
name|r
operator|.
name|base
operator|=
name|source_r
operator|.
name|base
operator|+
name|DNS_MESSAGE_HEADERLEN
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|msg
operator|->
name|sigstart
operator|-
name|DNS_MESSAGE_HEADERLEN
expr_stmt|;
name|RETERR
argument_list|(
name|dst_context_adddata
argument_list|(
name|ctx
argument_list|,
operator|&
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|sig_r
operator|.
name|base
operator|=
name|sig
operator|.
name|signature
expr_stmt|;
name|sig_r
operator|.
name|length
operator|=
name|sig
operator|.
name|siglen
expr_stmt|;
name|result
operator|=
name|dst_context_verify
argument_list|(
name|ctx
argument_list|,
operator|&
name|sig_r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|msg
operator|->
name|sig0status
operator|=
name|dns_tsigerror_badsig
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
name|msg
operator|->
name|verified_sig
operator|=
literal|1
expr_stmt|;
name|dst_context_destroy
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|sig
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|failure
label|:
if|if
condition|(
name|signeedsfree
condition|)
name|dns_rdata_freestruct
argument_list|(
operator|&
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|!=
name|NULL
condition|)
name|dst_context_destroy
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: message.c,v 1.194.2.10.2.24 2006/02/28 06:32:54 marka Exp $ */
end_comment

begin_comment
comment|/***  *** Imports  ***/
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_comment
comment|/* Required for HP/UX (and others?) */
end_comment

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/dnssec.h>
end_include

begin_include
include|#
directive|include
file|<dns/keyvalues.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/masterdump.h>
end_include

begin_include
include|#
directive|include
file|<dns/message.h>
end_include

begin_include
include|#
directive|include
file|<dns/opcode.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsig.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_define
define|#
directive|define
name|DNS_MESSAGE_OPCODE_MASK
value|0x7800U
end_define

begin_define
define|#
directive|define
name|DNS_MESSAGE_OPCODE_SHIFT
value|11
end_define

begin_define
define|#
directive|define
name|DNS_MESSAGE_RCODE_MASK
value|0x000fU
end_define

begin_define
define|#
directive|define
name|DNS_MESSAGE_FLAG_MASK
value|0x8ff0U
end_define

begin_define
define|#
directive|define
name|DNS_MESSAGE_EDNSRCODE_MASK
value|0xff000000U
end_define

begin_define
define|#
directive|define
name|DNS_MESSAGE_EDNSRCODE_SHIFT
value|24
end_define

begin_define
define|#
directive|define
name|DNS_MESSAGE_EDNSVERSION_MASK
value|0x00ff0000U
end_define

begin_define
define|#
directive|define
name|DNS_MESSAGE_EDNSVERSION_SHIFT
value|16
end_define

begin_define
define|#
directive|define
name|VALID_NAMED_SECTION
parameter_list|(
name|s
parameter_list|)
value|(((s)> DNS_SECTION_ANY) \&& ((s)< DNS_SECTION_MAX))
end_define

begin_define
define|#
directive|define
name|VALID_SECTION
parameter_list|(
name|s
parameter_list|)
value|(((s)>= DNS_SECTION_ANY) \&& ((s)< DNS_SECTION_MAX))
end_define

begin_define
define|#
directive|define
name|ADD_STRING
parameter_list|(
name|b
parameter_list|,
name|s
parameter_list|)
value|{if (strlen(s)>= \ 				   isc_buffer_availablelength(b)) \ 				       return(ISC_R_NOSPACE); else \ 				       isc_buffer_putstr(b, s);}
end_define

begin_define
define|#
directive|define
name|VALID_PSEUDOSECTION
parameter_list|(
name|s
parameter_list|)
value|(((s)>= DNS_PSEUDOSECTION_ANY) \&& ((s)< DNS_PSEUDOSECTION_MAX))
end_define

begin_comment
comment|/*  * This is the size of each individual scratchpad buffer, and the numbers  * of various block allocations used within the server.  * XXXMLG These should come from a config setting.  */
end_comment

begin_define
define|#
directive|define
name|SCRATCHPAD_SIZE
value|512
end_define

begin_define
define|#
directive|define
name|NAME_COUNT
value|8
end_define

begin_define
define|#
directive|define
name|OFFSET_COUNT
value|4
end_define

begin_define
define|#
directive|define
name|RDATA_COUNT
value|8
end_define

begin_define
define|#
directive|define
name|RDATALIST_COUNT
value|8
end_define

begin_define
define|#
directive|define
name|RDATASET_COUNT
value|RDATALIST_COUNT
end_define

begin_comment
comment|/*  * Text representation of the different items, for message_totext  * functions.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|sectiontext
index|[]
init|=
block|{
literal|"QUESTION"
block|,
literal|"ANSWER"
block|,
literal|"AUTHORITY"
block|,
literal|"ADDITIONAL"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|updsectiontext
index|[]
init|=
block|{
literal|"ZONE"
block|,
literal|"PREREQUISITE"
block|,
literal|"UPDATE"
block|,
literal|"ADDITIONAL"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|opcodetext
index|[]
init|=
block|{
literal|"QUERY"
block|,
literal|"IQUERY"
block|,
literal|"STATUS"
block|,
literal|"RESERVED3"
block|,
literal|"NOTIFY"
block|,
literal|"UPDATE"
block|,
literal|"RESERVED6"
block|,
literal|"RESERVED7"
block|,
literal|"RESERVED8"
block|,
literal|"RESERVED9"
block|,
literal|"RESERVED10"
block|,
literal|"RESERVED11"
block|,
literal|"RESERVED12"
block|,
literal|"RESERVED13"
block|,
literal|"RESERVED14"
block|,
literal|"RESERVED15"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|rcodetext
index|[]
init|=
block|{
literal|"NOERROR"
block|,
literal|"FORMERR"
block|,
literal|"SERVFAIL"
block|,
literal|"NXDOMAIN"
block|,
literal|"NOTIMP"
block|,
literal|"REFUSED"
block|,
literal|"YXDOMAIN"
block|,
literal|"YXRRSET"
block|,
literal|"NXRRSET"
block|,
literal|"NOTAUTH"
block|,
literal|"NOTZONE"
block|,
literal|"RESERVED11"
block|,
literal|"RESERVED12"
block|,
literal|"RESERVED13"
block|,
literal|"RESERVED14"
block|,
literal|"RESERVED15"
block|,
literal|"BADVERS"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * "helper" type, which consists of a block of some type, and is linkable.  * For it to work, sizeof(dns_msgblock_t) must be a multiple of the pointer  * size, or the allocated elements will not be alligned correctly.  */
end_comment

begin_struct
struct|struct
name|dns_msgblock
block|{
name|unsigned
name|int
name|count
decl_stmt|;
name|unsigned
name|int
name|remaining
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_msgblock_t
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* dynamically sized */
end_comment

begin_function_decl
specifier|static
specifier|inline
name|dns_msgblock_t
modifier|*
name|msgblock_allocate
parameter_list|(
name|isc_mem_t
modifier|*
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|unsigned
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|msgblock_get
parameter_list|(
name|block
parameter_list|,
name|type
parameter_list|)
define|\
value|((type *)msgblock_internalget(block, sizeof(type)))
end_define

begin_function_decl
specifier|static
specifier|inline
name|void
modifier|*
name|msgblock_internalget
parameter_list|(
name|dns_msgblock_t
modifier|*
parameter_list|,
name|unsigned
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|msgblock_reset
parameter_list|(
name|dns_msgblock_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|msgblock_free
parameter_list|(
name|isc_mem_t
modifier|*
parameter_list|,
name|dns_msgblock_t
modifier|*
parameter_list|,
name|unsigned
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Allocate a new dns_msgblock_t, and return a pointer to it.  If no memory  * is free, return NULL.  */
end_comment

begin_function
specifier|static
specifier|inline
name|dns_msgblock_t
modifier|*
name|msgblock_allocate
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|unsigned
name|int
name|sizeof_type
parameter_list|,
name|unsigned
name|int
name|count
parameter_list|)
block|{
name|dns_msgblock_t
modifier|*
name|block
decl_stmt|;
name|unsigned
name|int
name|length
decl_stmt|;
name|length
operator|=
sizeof|sizeof
argument_list|(
name|dns_msgblock_t
argument_list|)
operator|+
operator|(
name|sizeof_type
operator|*
name|count
operator|)
expr_stmt|;
name|block
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|block
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|block
operator|->
name|count
operator|=
name|count
expr_stmt|;
name|block
operator|->
name|remaining
operator|=
name|count
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|block
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|block
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return an element from the msgblock.  If no more are available, return  * NULL.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
modifier|*
name|msgblock_internalget
parameter_list|(
name|dns_msgblock_t
modifier|*
name|block
parameter_list|,
name|unsigned
name|int
name|sizeof_type
parameter_list|)
block|{
name|void
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
name|block
operator|==
name|NULL
operator|||
name|block
operator|->
name|remaining
operator|==
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|block
operator|->
name|remaining
operator|--
expr_stmt|;
name|ptr
operator|=
operator|(
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|block
operator|)
operator|+
sizeof|sizeof
argument_list|(
name|dns_msgblock_t
argument_list|)
operator|+
operator|(
name|sizeof_type
operator|*
name|block
operator|->
name|remaining
operator|)
operator|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|msgblock_reset
parameter_list|(
name|dns_msgblock_t
modifier|*
name|block
parameter_list|)
block|{
name|block
operator|->
name|remaining
operator|=
name|block
operator|->
name|count
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Release memory associated with a message block.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|msgblock_free
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_msgblock_t
modifier|*
name|block
parameter_list|,
name|unsigned
name|int
name|sizeof_type
parameter_list|)
block|{
name|unsigned
name|int
name|length
decl_stmt|;
name|length
operator|=
sizeof|sizeof
argument_list|(
name|dns_msgblock_t
argument_list|)
operator|+
operator|(
name|sizeof_type
operator|*
name|block
operator|->
name|count
operator|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|block
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Allocate a new dynamic buffer, and attach it to this message as the  * "current" buffer.  (which is always the last on the list, for our  * uses)  */
end_comment

begin_function
specifier|static
specifier|inline
name|isc_result_t
name|newbuffer
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|unsigned
name|int
name|size
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
modifier|*
name|dynbuf
decl_stmt|;
name|dynbuf
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
operator|&
name|dynbuf
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|ISC_LIST_APPEND
argument_list|(
name|msg
operator|->
name|scratchpad
argument_list|,
name|dynbuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_buffer_t
modifier|*
name|currentbuffer
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|isc_buffer_t
modifier|*
name|dynbuf
decl_stmt|;
name|dynbuf
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|msg
operator|->
name|scratchpad
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|dynbuf
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|dynbuf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|releaserdata
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
name|ISC_LIST_PREPEND
argument_list|(
name|msg
operator|->
name|freerdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_rdata_t
modifier|*
name|newrdata
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|dns_msgblock_t
modifier|*
name|msgblock
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|rdata
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|freerdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|freerdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|rdata
operator|)
return|;
block|}
name|msgblock
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|msg
operator|->
name|rdatas
argument_list|)
expr_stmt|;
name|rdata
operator|=
name|msgblock_get
argument_list|(
name|msgblock
argument_list|,
name|dns_rdata_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|==
name|NULL
condition|)
block|{
name|msgblock
operator|=
name|msgblock_allocate
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|,
name|RDATA_COUNT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgblock
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ISC_LIST_APPEND
argument_list|(
name|msg
operator|->
name|rdatas
argument_list|,
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdata
operator|=
name|msgblock_get
argument_list|(
name|msgblock
argument_list|,
name|dns_rdata_t
argument_list|)
expr_stmt|;
block|}
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|rdata
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|releaserdatalist
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdatalist_t
modifier|*
name|rdatalist
parameter_list|)
block|{
name|ISC_LIST_PREPEND
argument_list|(
name|msg
operator|->
name|freerdatalist
argument_list|,
name|rdatalist
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_rdatalist_t
modifier|*
name|newrdatalist
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|dns_msgblock_t
modifier|*
name|msgblock
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
decl_stmt|;
name|rdatalist
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|freerdatalist
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdatalist
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|freerdatalist
argument_list|,
name|rdatalist
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|rdatalist
operator|)
return|;
block|}
name|msgblock
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|msg
operator|->
name|rdatalists
argument_list|)
expr_stmt|;
name|rdatalist
operator|=
name|msgblock_get
argument_list|(
name|msgblock
argument_list|,
name|dns_rdatalist_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdatalist
operator|==
name|NULL
condition|)
block|{
name|msgblock
operator|=
name|msgblock_allocate
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdatalist_t
argument_list|)
argument_list|,
name|RDATALIST_COUNT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgblock
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ISC_LIST_APPEND
argument_list|(
name|msg
operator|->
name|rdatalists
argument_list|,
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdatalist
operator|=
name|msgblock_get
argument_list|(
name|msgblock
argument_list|,
name|dns_rdatalist_t
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rdatalist
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_offsets_t
modifier|*
name|newoffsets
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|dns_msgblock_t
modifier|*
name|msgblock
decl_stmt|;
name|dns_offsets_t
modifier|*
name|offsets
decl_stmt|;
name|msgblock
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|msg
operator|->
name|offsets
argument_list|)
expr_stmt|;
name|offsets
operator|=
name|msgblock_get
argument_list|(
name|msgblock
argument_list|,
name|dns_offsets_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|offsets
operator|==
name|NULL
condition|)
block|{
name|msgblock
operator|=
name|msgblock_allocate
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_offsets_t
argument_list|)
argument_list|,
name|OFFSET_COUNT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msgblock
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ISC_LIST_APPEND
argument_list|(
name|msg
operator|->
name|offsets
argument_list|,
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|offsets
operator|=
name|msgblock_get
argument_list|(
name|msgblock
argument_list|,
name|dns_offsets_t
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|offsets
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|msginitheader
parameter_list|(
name|dns_message_t
modifier|*
name|m
parameter_list|)
block|{
name|m
operator|->
name|id
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|rcode
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|opcode
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|rdclass
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|msginitprivate
parameter_list|(
name|dns_message_t
modifier|*
name|m
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DNS_SECTION_MAX
condition|;
name|i
operator|++
control|)
block|{
name|m
operator|->
name|cursors
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|counts
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|m
operator|->
name|opt
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|sig0
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|sig0name
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|tsig
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|tsigname
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|state
operator|=
name|DNS_SECTION_ANY
expr_stmt|;
comment|/* indicate nothing parsed or rendered */
name|m
operator|->
name|opt_reserved
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|sig_reserved
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|reserved
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|buffer
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|msginittsig
parameter_list|(
name|dns_message_t
modifier|*
name|m
parameter_list|)
block|{
name|m
operator|->
name|tsigstatus
operator|=
name|dns_rcode_noerror
expr_stmt|;
name|m
operator|->
name|querytsigstatus
operator|=
name|dns_rcode_noerror
expr_stmt|;
name|m
operator|->
name|tsigkey
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|tsigctx
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|sigstart
operator|=
operator|-
literal|1
expr_stmt|;
name|m
operator|->
name|sig0key
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|sig0status
operator|=
name|dns_rcode_noerror
expr_stmt|;
name|m
operator|->
name|timeadjust
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Init elements to default state.  Used both when allocating a new element  * and when resetting one.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|msginit
parameter_list|(
name|dns_message_t
modifier|*
name|m
parameter_list|)
block|{
name|msginitheader
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|msginitprivate
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|msginittsig
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|m
operator|->
name|header_ok
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|question_ok
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|tcp_continuation
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|verified_sig
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|verify_attempted
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|order
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|order_arg
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|query
operator|.
name|base
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|query
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|free_query
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|saved
operator|.
name|base
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|saved
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|free_saved
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|querytsig
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|msgresetnames
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|unsigned
name|int
name|first_section
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|,
modifier|*
name|next_name
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rds
decl_stmt|,
modifier|*
name|next_rds
decl_stmt|;
comment|/* 	 * Clean up name lists by calling the rdataset disassociate function. 	 */
for|for
control|(
name|i
operator|=
name|first_section
init|;
name|i
operator|<
name|DNS_SECTION_MAX
condition|;
name|i
operator|++
control|)
block|{
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|sections
index|[
name|i
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|name
operator|!=
name|NULL
condition|)
block|{
name|next_name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|sections
index|[
name|i
index|]
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rds
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
expr_stmt|;
while|while
condition|(
name|rds
operator|!=
name|NULL
condition|)
block|{
name|next_rds
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rds
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rds
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|dns_rdataset_isassociated
argument_list|(
name|rds
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
name|rds
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
name|rds
argument_list|)
expr_stmt|;
name|rds
operator|=
name|next_rds
expr_stmt|;
block|}
if|if
condition|(
name|dns_name_dynamic
argument_list|(
name|name
argument_list|)
condition|)
name|dns_name_free
argument_list|(
name|name
argument_list|,
name|msg
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|name
operator|=
name|next_name
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|msgresetopt
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|->
name|opt
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|msg
operator|->
name|opt_reserved
operator|>
literal|0
condition|)
block|{
name|dns_message_renderrelease
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|opt_reserved
argument_list|)
expr_stmt|;
name|msg
operator|->
name|opt_reserved
operator|=
literal|0
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|dns_rdataset_isassociated
argument_list|(
name|msg
operator|->
name|opt
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
name|msg
operator|->
name|opt
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
name|msg
operator|->
name|opt
argument_list|)
expr_stmt|;
name|msg
operator|->
name|opt
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|msgresetsigs
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_boolean_t
name|replying
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|->
name|sig_reserved
operator|>
literal|0
condition|)
block|{
name|dns_message_renderrelease
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|sig_reserved
argument_list|)
expr_stmt|;
name|msg
operator|->
name|sig_reserved
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|tsig
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|dns_rdataset_isassociated
argument_list|(
name|msg
operator|->
name|tsig
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|msg
operator|->
name|namepool
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|replying
condition|)
block|{
name|INSIST
argument_list|(
name|msg
operator|->
name|querytsig
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|->
name|querytsig
operator|=
name|msg
operator|->
name|tsig
expr_stmt|;
block|}
else|else
block|{
name|dns_rdataset_disassociate
argument_list|(
name|msg
operator|->
name|tsig
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
name|msg
operator|->
name|tsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|querytsig
operator|!=
name|NULL
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
name|msg
operator|->
name|querytsig
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
name|msg
operator|->
name|querytsig
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dns_name_dynamic
argument_list|(
name|msg
operator|->
name|tsigname
argument_list|)
condition|)
name|dns_name_free
argument_list|(
name|msg
operator|->
name|tsigname
argument_list|,
name|msg
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
name|msg
operator|->
name|tsigname
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tsig
operator|=
name|NULL
expr_stmt|;
name|msg
operator|->
name|tsigname
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|msg
operator|->
name|querytsig
operator|!=
name|NULL
operator|&&
operator|!
name|replying
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
name|msg
operator|->
name|querytsig
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
name|msg
operator|->
name|querytsig
argument_list|)
expr_stmt|;
name|msg
operator|->
name|querytsig
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|sig0
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|dns_rdataset_isassociated
argument_list|(
name|msg
operator|->
name|sig0
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
name|msg
operator|->
name|sig0
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
name|msg
operator|->
name|sig0
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|sig0name
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|dns_name_dynamic
argument_list|(
name|msg
operator|->
name|sig0name
argument_list|)
condition|)
name|dns_name_free
argument_list|(
name|msg
operator|->
name|sig0name
argument_list|,
name|msg
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
name|msg
operator|->
name|sig0name
argument_list|)
expr_stmt|;
block|}
name|msg
operator|->
name|sig0
operator|=
name|NULL
expr_stmt|;
name|msg
operator|->
name|sig0name
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Free all but one (or everything) for this message.  This is used by  * both dns_message_reset() and dns_message_destroy().  */
end_comment

begin_function
specifier|static
name|void
name|msgreset
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_boolean_t
name|everything
parameter_list|)
block|{
name|dns_msgblock_t
modifier|*
name|msgblock
decl_stmt|,
modifier|*
name|next_msgblock
decl_stmt|;
name|isc_buffer_t
modifier|*
name|dynbuf
decl_stmt|,
modifier|*
name|next_dynbuf
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
decl_stmt|;
name|msgresetnames
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msgresetopt
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|msgresetsigs
argument_list|(
name|msg
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
comment|/* 	 * Clean up linked lists. 	 */
comment|/* 	 * Run through the free lists, and just unlink anything found there. 	 * The memory isn't lost since these are part of message blocks we 	 * have allocated. 	 */
name|rdata
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|freerdata
argument_list|)
expr_stmt|;
while|while
condition|(
name|rdata
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|freerdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdata
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|freerdata
argument_list|)
expr_stmt|;
block|}
name|rdatalist
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|freerdatalist
argument_list|)
expr_stmt|;
while|while
condition|(
name|rdatalist
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|freerdatalist
argument_list|,
name|rdatalist
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdatalist
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|freerdatalist
argument_list|)
expr_stmt|;
block|}
name|dynbuf
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|scratchpad
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|dynbuf
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|everything
condition|)
block|{
name|isc_buffer_clear
argument_list|(
name|dynbuf
argument_list|)
expr_stmt|;
name|dynbuf
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|dynbuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|dynbuf
operator|!=
name|NULL
condition|)
block|{
name|next_dynbuf
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|dynbuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|scratchpad
argument_list|,
name|dynbuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_buffer_free
argument_list|(
operator|&
name|dynbuf
argument_list|)
expr_stmt|;
name|dynbuf
operator|=
name|next_dynbuf
expr_stmt|;
block|}
name|msgblock
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|rdatas
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|everything
operator|&&
name|msgblock
operator|!=
name|NULL
condition|)
block|{
name|msgblock_reset
argument_list|(
name|msgblock
argument_list|)
expr_stmt|;
name|msgblock
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|msgblock
operator|!=
name|NULL
condition|)
block|{
name|next_msgblock
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|rdatas
argument_list|,
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|msgblock_free
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
name|msgblock
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
name|msgblock
operator|=
name|next_msgblock
expr_stmt|;
block|}
comment|/* 	 * rdatalists could be empty. 	 */
name|msgblock
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|rdatalists
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|everything
operator|&&
name|msgblock
operator|!=
name|NULL
condition|)
block|{
name|msgblock_reset
argument_list|(
name|msgblock
argument_list|)
expr_stmt|;
name|msgblock
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|msgblock
operator|!=
name|NULL
condition|)
block|{
name|next_msgblock
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|rdatalists
argument_list|,
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|msgblock_free
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
name|msgblock
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdatalist_t
argument_list|)
argument_list|)
expr_stmt|;
name|msgblock
operator|=
name|next_msgblock
expr_stmt|;
block|}
name|msgblock
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|offsets
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|everything
operator|&&
name|msgblock
operator|!=
name|NULL
condition|)
block|{
name|msgblock_reset
argument_list|(
name|msgblock
argument_list|)
expr_stmt|;
name|msgblock
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|msgblock
operator|!=
name|NULL
condition|)
block|{
name|next_msgblock
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|offsets
argument_list|,
name|msgblock
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|msgblock_free
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
name|msgblock
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_offsets_t
argument_list|)
argument_list|)
expr_stmt|;
name|msgblock
operator|=
name|next_msgblock
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
block|{
name|dns_tsigkey_detach
argument_list|(
operator|&
name|msg
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tsigkey
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|query
operator|.
name|base
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|msg
operator|->
name|free_query
operator|!=
literal|0
condition|)
name|isc_mem_put
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
name|msg
operator|->
name|query
operator|.
name|base
argument_list|,
name|msg
operator|->
name|query
operator|.
name|length
argument_list|)
expr_stmt|;
name|msg
operator|->
name|query
operator|.
name|base
operator|=
name|NULL
expr_stmt|;
name|msg
operator|->
name|query
operator|.
name|length
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|saved
operator|.
name|base
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|msg
operator|->
name|free_saved
operator|!=
literal|0
condition|)
name|isc_mem_put
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
name|msg
operator|->
name|saved
operator|.
name|base
argument_list|,
name|msg
operator|->
name|saved
operator|.
name|length
argument_list|)
expr_stmt|;
name|msg
operator|->
name|saved
operator|.
name|base
operator|=
name|NULL
expr_stmt|;
name|msg
operator|->
name|saved
operator|.
name|length
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * cleanup the buffer cleanup list 	 */
name|dynbuf
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|cleanup
argument_list|)
expr_stmt|;
while|while
condition|(
name|dynbuf
operator|!=
name|NULL
condition|)
block|{
name|next_dynbuf
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|dynbuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|cleanup
argument_list|,
name|dynbuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_buffer_free
argument_list|(
operator|&
name|dynbuf
argument_list|)
expr_stmt|;
name|dynbuf
operator|=
name|next_dynbuf
expr_stmt|;
block|}
comment|/* 	 * Set other bits to normal default values. 	 */
if|if
condition|(
operator|!
name|everything
condition|)
name|msginit
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|ENSURE
argument_list|(
name|isc_mempool_getallocated
argument_list|(
name|msg
operator|->
name|namepool
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ENSURE
argument_list|(
name|isc_mempool_getallocated
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|spacefortsig
parameter_list|(
name|dns_tsigkey_t
modifier|*
name|key
parameter_list|,
name|int
name|otherlen
parameter_list|)
block|{
name|isc_region_t
name|r1
decl_stmt|,
name|r2
decl_stmt|;
name|unsigned
name|int
name|x
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * The space required for an TSIG record is: 	 * 	 *	n1 bytes for the name 	 *	2 bytes for the type 	 *	2 bytes for the class 	 *	4 bytes for the ttl 	 *	2 bytes for the rdlength 	 *	n2 bytes for the algorithm name 	 *	6 bytes for the time signed 	 *	2 bytes for the fudge 	 *	2 bytes for the MAC size 	 *	x bytes for the MAC 	 *	2 bytes for the original id 	 *	2 bytes for the error 	 *	2 bytes for the other data length 	 *	y bytes for the other data (at most) 	 * --------------------------------- 	 *     26 + n1 + n2 + x + y bytes 	 */
name|dns_name_toregion
argument_list|(
operator|&
name|key
operator|->
name|name
argument_list|,
operator|&
name|r1
argument_list|)
expr_stmt|;
name|dns_name_toregion
argument_list|(
name|key
operator|->
name|algorithm
argument_list|,
operator|&
name|r2
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|->
name|key
operator|==
name|NULL
condition|)
name|x
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|result
operator|=
name|dst_key_sigsize
argument_list|(
name|key
operator|->
name|key
argument_list|,
operator|&
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|x
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
literal|26
operator|+
name|r1
operator|.
name|length
operator|+
name|r2
operator|.
name|length
operator|+
name|x
operator|+
name|otherlen
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|unsigned
name|int
name|intent
parameter_list|,
name|dns_message_t
modifier|*
modifier|*
name|msgp
parameter_list|)
block|{
name|dns_message_t
modifier|*
name|m
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
modifier|*
name|dynbuf
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msgp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|*
name|msgp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|intent
operator|==
name|DNS_MESSAGE_INTENTPARSE
operator|||
name|intent
operator|==
name|DNS_MESSAGE_INTENTRENDER
argument_list|)
expr_stmt|;
name|m
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_message_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
comment|/* 	 * No allocations until further notice.  Just initialize all lists 	 * and other members that are freed in the cleanup phase here. 	 */
name|m
operator|->
name|magic
operator|=
name|DNS_MESSAGE_MAGIC
expr_stmt|;
name|m
operator|->
name|from_to_wire
operator|=
name|intent
expr_stmt|;
name|msginit
argument_list|(
name|m
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DNS_SECTION_MAX
condition|;
name|i
operator|++
control|)
name|ISC_LIST_INIT
argument_list|(
name|m
operator|->
name|sections
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|m
operator|->
name|mctx
operator|=
name|mctx
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|m
operator|->
name|scratchpad
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|m
operator|->
name|cleanup
argument_list|)
expr_stmt|;
name|m
operator|->
name|namepool
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|rdspool
operator|=
name|NULL
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|m
operator|->
name|rdatas
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|m
operator|->
name|rdatalists
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|m
operator|->
name|offsets
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|m
operator|->
name|freerdata
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|m
operator|->
name|freerdatalist
argument_list|)
expr_stmt|;
comment|/* 	 * Ok, it is safe to allocate (and then "goto cleanup" if failure) 	 */
name|result
operator|=
name|isc_mempool_create
argument_list|(
name|m
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|,
operator|&
name|m
operator|->
name|namepool
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isc_mempool_setfreemax
argument_list|(
name|m
operator|->
name|namepool
argument_list|,
name|NAME_COUNT
argument_list|)
expr_stmt|;
name|isc_mempool_setname
argument_list|(
name|m
operator|->
name|namepool
argument_list|,
literal|"msg:names"
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mempool_create
argument_list|(
name|m
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdataset_t
argument_list|)
argument_list|,
operator|&
name|m
operator|->
name|rdspool
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isc_mempool_setfreemax
argument_list|(
name|m
operator|->
name|rdspool
argument_list|,
name|NAME_COUNT
argument_list|)
expr_stmt|;
name|isc_mempool_setname
argument_list|(
name|m
operator|->
name|rdspool
argument_list|,
literal|"msg:rdataset"
argument_list|)
expr_stmt|;
name|dynbuf
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|dynbuf
argument_list|,
name|SCRATCHPAD_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|ISC_LIST_APPEND
argument_list|(
name|m
operator|->
name|scratchpad
argument_list|,
name|dynbuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|m
operator|->
name|cctx
operator|=
name|NULL
expr_stmt|;
operator|*
name|msgp
operator|=
name|m
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
comment|/* 	 * Cleanup for error returns. 	 */
name|cleanup
label|:
name|dynbuf
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|m
operator|->
name|scratchpad
argument_list|)
expr_stmt|;
if|if
condition|(
name|dynbuf
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|m
operator|->
name|scratchpad
argument_list|,
name|dynbuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_buffer_free
argument_list|(
operator|&
name|dynbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|namepool
operator|!=
name|NULL
condition|)
name|isc_mempool_destroy
argument_list|(
operator|&
name|m
operator|->
name|namepool
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|rdspool
operator|!=
name|NULL
condition|)
name|isc_mempool_destroy
argument_list|(
operator|&
name|m
operator|->
name|rdspool
argument_list|)
expr_stmt|;
name|m
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|m
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_message_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_reset
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|unsigned
name|int
name|intent
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|intent
operator|==
name|DNS_MESSAGE_INTENTPARSE
operator|||
name|intent
operator|==
name|DNS_MESSAGE_INTENTRENDER
argument_list|)
expr_stmt|;
name|msgreset
argument_list|(
name|msg
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|msg
operator|->
name|from_to_wire
operator|=
name|intent
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_message_destroy
parameter_list|(
name|dns_message_t
modifier|*
modifier|*
name|msgp
parameter_list|)
block|{
name|dns_message_t
modifier|*
name|msg
decl_stmt|;
name|REQUIRE
argument_list|(
name|msgp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
operator|*
name|msgp
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|=
operator|*
name|msgp
expr_stmt|;
operator|*
name|msgp
operator|=
name|NULL
expr_stmt|;
name|msgreset
argument_list|(
name|msg
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|msg
operator|->
name|namepool
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|msg
operator|->
name|rdspool
argument_list|)
expr_stmt|;
name|msg
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_message_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|findname
parameter_list|(
name|dns_name_t
modifier|*
modifier|*
name|foundname
parameter_list|,
name|dns_name_t
modifier|*
name|target
parameter_list|,
name|dns_namelist_t
modifier|*
name|section
parameter_list|)
block|{
name|dns_name_t
modifier|*
name|curr
decl_stmt|;
for|for
control|(
name|curr
operator|=
name|ISC_LIST_TAIL
argument_list|(
operator|*
name|section
argument_list|)
init|;
name|curr
operator|!=
name|NULL
condition|;
name|curr
operator|=
name|ISC_LIST_PREV
argument_list|(
name|curr
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|dns_name_equal
argument_list|(
name|curr
argument_list|,
name|target
argument_list|)
condition|)
block|{
if|if
condition|(
name|foundname
operator|!=
name|NULL
condition|)
operator|*
name|foundname
operator|=
name|curr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_find
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdatatype_t
name|covers
parameter_list|,
name|dns_rdataset_t
modifier|*
modifier|*
name|rdataset
parameter_list|)
block|{
name|dns_rdataset_t
modifier|*
name|curr
decl_stmt|;
if|if
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
block|{
name|REQUIRE
argument_list|(
operator|*
name|rdataset
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|curr
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|curr
operator|!=
name|NULL
condition|;
name|curr
operator|=
name|ISC_LIST_PREV
argument_list|(
name|curr
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|curr
operator|->
name|rdclass
operator|==
name|rdclass
operator|&&
name|curr
operator|->
name|type
operator|==
name|type
operator|&&
name|curr
operator|->
name|covers
operator|==
name|covers
condition|)
block|{
if|if
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
operator|*
name|rdataset
operator|=
name|curr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_findtype
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdatatype_t
name|covers
parameter_list|,
name|dns_rdataset_t
modifier|*
modifier|*
name|rdataset
parameter_list|)
block|{
name|dns_rdataset_t
modifier|*
name|curr
decl_stmt|;
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
block|{
name|REQUIRE
argument_list|(
operator|*
name|rdataset
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|curr
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|curr
operator|!=
name|NULL
condition|;
name|curr
operator|=
name|ISC_LIST_PREV
argument_list|(
name|curr
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|curr
operator|->
name|type
operator|==
name|type
operator|&&
name|curr
operator|->
name|covers
operator|==
name|covers
condition|)
block|{
if|if
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
operator|*
name|rdataset
operator|=
name|curr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read a name from buffer "source".  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|getname
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_buffer_t
modifier|*
name|source
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_decompress_t
modifier|*
name|dctx
parameter_list|)
block|{
name|isc_buffer_t
modifier|*
name|scratch
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|tries
decl_stmt|;
name|scratch
operator|=
name|currentbuffer
argument_list|(
name|msg
argument_list|)
expr_stmt|;
comment|/* 	 * First try:  use current buffer. 	 * Second try:  allocate a new buffer and use that. 	 */
name|tries
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|tries
operator|<
literal|2
condition|)
block|{
name|result
operator|=
name|dns_name_fromwire
argument_list|(
name|name
argument_list|,
name|source
argument_list|,
name|dctx
argument_list|,
name|ISC_FALSE
argument_list|,
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
block|{
name|tries
operator|++
expr_stmt|;
name|result
operator|=
name|newbuffer
argument_list|(
name|msg
argument_list|,
name|SCRATCHPAD_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|scratch
operator|=
name|currentbuffer
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|dns_name_reset
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* Cannot get here... */
return|return
operator|(
name|ISC_R_UNEXPECTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|getrdata
parameter_list|(
name|isc_buffer_t
modifier|*
name|source
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_decompress_t
modifier|*
name|dctx
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_rdatatype_t
name|rdtype
parameter_list|,
name|unsigned
name|int
name|rdatalen
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
name|isc_buffer_t
modifier|*
name|scratch
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|tries
decl_stmt|;
name|unsigned
name|int
name|trysize
decl_stmt|;
name|scratch
operator|=
name|currentbuffer
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|isc_buffer_setactive
argument_list|(
name|source
argument_list|,
name|rdatalen
argument_list|)
expr_stmt|;
comment|/* 	 * First try:  use current buffer. 	 * Second try:  allocate a new buffer of size 	 *     max(SCRATCHPAD_SIZE, 2 * compressed_rdatalen) 	 *     (the data will fit if it was not more than 50% compressed) 	 * Subsequent tries: double buffer size on each try. 	 */
name|tries
operator|=
literal|0
expr_stmt|;
name|trysize
operator|=
literal|0
expr_stmt|;
comment|/* XXX possibly change this to a while (tries< 2) loop */
for|for
control|(
init|;
condition|;
control|)
block|{
name|result
operator|=
name|dns_rdata_fromwire
argument_list|(
name|rdata
argument_list|,
name|rdclass
argument_list|,
name|rdtype
argument_list|,
name|source
argument_list|,
name|dctx
argument_list|,
literal|0
argument_list|,
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
block|{
if|if
condition|(
name|tries
operator|==
literal|0
condition|)
block|{
name|trysize
operator|=
literal|2
operator|*
name|rdatalen
expr_stmt|;
if|if
condition|(
name|trysize
operator|<
name|SCRATCHPAD_SIZE
condition|)
name|trysize
operator|=
name|SCRATCHPAD_SIZE
expr_stmt|;
block|}
else|else
block|{
name|INSIST
argument_list|(
name|trysize
operator|!=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|trysize
operator|>=
literal|65535
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
comment|/* XXX DNS_R_RRTOOLONG? */
name|trysize
operator|*=
literal|2
expr_stmt|;
block|}
name|tries
operator|++
expr_stmt|;
name|result
operator|=
name|newbuffer
argument_list|(
name|msg
argument_list|,
name|trysize
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|scratch
operator|=
name|currentbuffer
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
block|}
end_function

begin_define
define|#
directive|define
name|DO_FORMERR
define|\
value|do {						\ 		if (best_effort)			\ 			seen_problem = ISC_TRUE;	\ 		else {					\ 			result = DNS_R_FORMERR;		\ 			goto cleanup;			\ 		}					\ 	} while (0)
end_define

begin_function
specifier|static
name|isc_result_t
name|getquestions
parameter_list|(
name|isc_buffer_t
modifier|*
name|source
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_decompress_t
modifier|*
name|dctx
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|unsigned
name|int
name|count
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_name_t
modifier|*
name|name2
decl_stmt|;
name|dns_offsets_t
modifier|*
name|offsets
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdatatype_t
name|rdtype
decl_stmt|;
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|dns_namelist_t
modifier|*
name|section
decl_stmt|;
name|isc_boolean_t
name|free_name
decl_stmt|;
name|isc_boolean_t
name|best_effort
decl_stmt|;
name|isc_boolean_t
name|seen_problem
decl_stmt|;
name|section
operator|=
operator|&
name|msg
operator|->
name|sections
index|[
name|DNS_SECTION_QUESTION
index|]
expr_stmt|;
name|best_effort
operator|=
name|ISC_TF
argument_list|(
name|options
operator|&
name|DNS_MESSAGEPARSE_BESTEFFORT
argument_list|)
expr_stmt|;
name|seen_problem
operator|=
name|ISC_FALSE
expr_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|rdatalist
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_QUESTION
index|]
condition|;
name|count
operator|++
control|)
block|{
name|name
operator|=
name|isc_mempool_get
argument_list|(
name|msg
operator|->
name|namepool
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|free_name
operator|=
name|ISC_TRUE
expr_stmt|;
name|offsets
operator|=
name|newoffsets
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|offsets
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_name_init
argument_list|(
name|name
argument_list|,
operator|*
name|offsets
argument_list|)
expr_stmt|;
comment|/* 		 * Parse the name out of this packet. 		 */
name|isc_buffer_remainingregion
argument_list|(
name|source
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|isc_buffer_setactive
argument_list|(
name|source
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|result
operator|=
name|getname
argument_list|(
name|name
argument_list|,
name|source
argument_list|,
name|msg
argument_list|,
name|dctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* 		 * Run through the section, looking to see if this name 		 * is already there.  If it is found, put back the allocated 		 * name since we no longer need it, and set our name pointer 		 * to point to the name we found. 		 */
name|result
operator|=
name|findname
argument_list|(
operator|&
name|name2
argument_list|,
name|name
argument_list|,
name|section
argument_list|)
expr_stmt|;
comment|/* 		 * If it is the first name in the section, accept it. 		 * 		 * If it is not, but is not the same as the name already 		 * in the question section, append to the section.  Note that 		 * here in the question section this is illegal, so return 		 * FORMERR.  In the future, check the opcode to see if 		 * this should be legal or not.  In either case we no longer 		 * need this name pointer. 		 */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
operator|*
name|section
argument_list|)
condition|)
name|DO_FORMERR
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
operator|*
name|section
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_name
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
block|{
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|name
operator|=
name|name2
expr_stmt|;
name|name2
operator|=
name|NULL
expr_stmt|;
name|free_name
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
comment|/* 		 * Get type and class. 		 */
name|isc_buffer_remainingregion
argument_list|(
name|source
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
literal|4
condition|)
block|{
name|result
operator|=
name|ISC_R_UNEXPECTEDEND
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|rdtype
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|rdclass
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
comment|/* 		 * If this class is different than the one we already read, 		 * this is an error. 		 */
if|if
condition|(
name|msg
operator|->
name|state
operator|==
name|DNS_SECTION_ANY
condition|)
block|{
name|msg
operator|->
name|state
operator|=
name|DNS_SECTION_QUESTION
expr_stmt|;
name|msg
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|msg
operator|->
name|rdclass
operator|!=
name|rdclass
condition|)
name|DO_FORMERR
expr_stmt|;
comment|/* 		 * Can't ask the same question twice. 		 */
name|result
operator|=
name|dns_message_find
argument_list|(
name|name
argument_list|,
name|rdclass
argument_list|,
name|rdtype
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|DO_FORMERR
expr_stmt|;
comment|/* 		 * Allocate a new rdatalist. 		 */
name|rdatalist
operator|=
name|newrdatalist
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdatalist
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|rdataset
operator|=
name|isc_mempool_get
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 		 * Convert rdatalist to rdataset, and attach the latter to 		 * the name. 		 */
name|rdatalist
operator|->
name|type
operator|=
name|rdtype
expr_stmt|;
name|rdatalist
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
name|rdatalist
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|rdatalist
operator|->
name|ttl
operator|=
literal|0
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatalist_tordataset
argument_list|(
name|rdatalist
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|rdataset
operator|->
name|attributes
operator||=
name|DNS_RDATASETATTR_QUESTION
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdataset
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|seen_problem
condition|)
return|return
operator|(
name|DNS_R_RECOVERABLE
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
operator|!
name|dns_rdataset_isassociated
argument_list|(
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|if (rdatalist != NULL) 		isc_mempool_put(msg->rdlpool, rdatalist);
endif|#
directive|endif
if|if
condition|(
name|free_name
condition|)
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|update
parameter_list|(
name|dns_section_t
name|section
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|)
block|{
if|if
condition|(
name|section
operator|==
name|DNS_SECTION_PREREQUISITE
condition|)
return|return
operator|(
name|ISC_TF
argument_list|(
name|rdclass
operator|==
name|dns_rdataclass_any
operator|||
name|rdclass
operator|==
name|dns_rdataclass_none
argument_list|)
operator|)
return|;
if|if
condition|(
name|section
operator|==
name|DNS_SECTION_UPDATE
condition|)
return|return
operator|(
name|ISC_TF
argument_list|(
name|rdclass
operator|==
name|dns_rdataclass_any
argument_list|)
operator|)
return|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|getsection
parameter_list|(
name|isc_buffer_t
modifier|*
name|source
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_decompress_t
modifier|*
name|dctx
parameter_list|,
name|dns_section_t
name|sectionid
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|unsigned
name|int
name|count
decl_stmt|,
name|rdatalen
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_name_t
modifier|*
name|name2
decl_stmt|;
name|dns_offsets_t
modifier|*
name|offsets
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdatatype_t
name|rdtype
decl_stmt|,
name|covers
decl_stmt|;
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|dns_ttl_t
name|ttl
decl_stmt|;
name|dns_namelist_t
modifier|*
name|section
decl_stmt|;
name|isc_boolean_t
name|free_name
decl_stmt|,
name|free_rdataset
decl_stmt|;
name|isc_boolean_t
name|preserve_order
decl_stmt|,
name|best_effort
decl_stmt|,
name|seen_problem
decl_stmt|;
name|isc_boolean_t
name|issigzero
decl_stmt|;
name|preserve_order
operator|=
name|ISC_TF
argument_list|(
name|options
operator|&
name|DNS_MESSAGEPARSE_PRESERVEORDER
argument_list|)
expr_stmt|;
name|best_effort
operator|=
name|ISC_TF
argument_list|(
name|options
operator|&
name|DNS_MESSAGEPARSE_BESTEFFORT
argument_list|)
expr_stmt|;
name|seen_problem
operator|=
name|ISC_FALSE
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
name|msg
operator|->
name|counts
index|[
name|sectionid
index|]
condition|;
name|count
operator|++
control|)
block|{
name|int
name|recstart
init|=
name|source
operator|->
name|current
decl_stmt|;
name|isc_boolean_t
name|skip_name_search
decl_stmt|,
name|skip_type_search
decl_stmt|;
name|section
operator|=
operator|&
name|msg
operator|->
name|sections
index|[
name|sectionid
index|]
expr_stmt|;
name|skip_name_search
operator|=
name|ISC_FALSE
expr_stmt|;
name|skip_type_search
operator|=
name|ISC_FALSE
expr_stmt|;
name|free_name
operator|=
name|ISC_FALSE
expr_stmt|;
name|free_rdataset
operator|=
name|ISC_FALSE
expr_stmt|;
name|name
operator|=
name|isc_mempool_get
argument_list|(
name|msg
operator|->
name|namepool
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|free_name
operator|=
name|ISC_TRUE
expr_stmt|;
name|offsets
operator|=
name|newoffsets
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|offsets
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|dns_name_init
argument_list|(
name|name
argument_list|,
operator|*
name|offsets
argument_list|)
expr_stmt|;
comment|/* 		 * Parse the name out of this packet. 		 */
name|isc_buffer_remainingregion
argument_list|(
name|source
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|isc_buffer_setactive
argument_list|(
name|source
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|result
operator|=
name|getname
argument_list|(
name|name
argument_list|,
name|source
argument_list|,
name|msg
argument_list|,
name|dctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
comment|/* 		 * Get type, class, ttl, and rdatalen.  Verify that at least 		 * rdatalen bytes remain.  (Some of this is deferred to 		 * later.) 		 */
name|isc_buffer_remainingregion
argument_list|(
name|source
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
literal|2
operator|+
literal|2
operator|+
literal|4
operator|+
literal|2
condition|)
block|{
name|result
operator|=
name|ISC_R_UNEXPECTEDEND
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|rdtype
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|rdclass
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
comment|/* 		 * If there was no question section, we may not yet have 		 * established a class.  Do so now. 		 */
if|if
condition|(
name|msg
operator|->
name|state
operator|==
name|DNS_SECTION_ANY
operator|&&
name|rdtype
operator|!=
name|dns_rdatatype_opt
operator|&&
comment|/* class is UDP SIZE */
name|rdtype
operator|!=
name|dns_rdatatype_tsig
operator|&&
comment|/* class is ANY */
name|rdtype
operator|!=
name|dns_rdatatype_tkey
condition|)
block|{
comment|/* class is undefined */
name|msg
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|msg
operator|->
name|state
operator|=
name|DNS_SECTION_QUESTION
expr_stmt|;
block|}
comment|/* 		 * If this class is different than the one in the question 		 * section, bail. 		 */
if|if
condition|(
name|msg
operator|->
name|opcode
operator|!=
name|dns_opcode_update
operator|&&
name|rdtype
operator|!=
name|dns_rdatatype_tsig
operator|&&
name|rdtype
operator|!=
name|dns_rdatatype_opt
operator|&&
name|rdtype
operator|!=
name|dns_rdatatype_dnskey
comment|/* in a TKEY query */
operator|&&
name|rdtype
operator|!=
name|dns_rdatatype_sig
comment|/* SIG(0) */
operator|&&
name|rdtype
operator|!=
name|dns_rdatatype_tkey
comment|/* Win2000 TKEY */
operator|&&
name|msg
operator|->
name|rdclass
operator|!=
name|dns_rdataclass_any
operator|&&
name|msg
operator|->
name|rdclass
operator|!=
name|rdclass
condition|)
name|DO_FORMERR
expr_stmt|;
comment|/* 		 * Special type handling for TSIG, OPT, and TKEY. 		 */
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_tsig
condition|)
block|{
comment|/* 			 * If it is a tsig, verify that it is in the 			 * additional data section. 			 */
if|if
condition|(
name|sectionid
operator|!=
name|DNS_SECTION_ADDITIONAL
operator|||
name|rdclass
operator|!=
name|dns_rdataclass_any
operator|||
name|count
operator|!=
name|msg
operator|->
name|counts
index|[
name|sectionid
index|]
operator|-
literal|1
condition|)
name|DO_FORMERR
expr_stmt|;
name|msg
operator|->
name|sigstart
operator|=
name|recstart
expr_stmt|;
name|skip_name_search
operator|=
name|ISC_TRUE
expr_stmt|;
name|skip_type_search
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_opt
condition|)
block|{
comment|/* 			 * The name of an OPT record must be ".", it 			 * must be in the additional data section, and 			 * it must be the first OPT we've seen. 			 */
if|if
condition|(
operator|!
name|dns_name_equal
argument_list|(
name|dns_rootname
argument_list|,
name|name
argument_list|)
operator|||
name|msg
operator|->
name|opt
operator|!=
name|NULL
condition|)
name|DO_FORMERR
expr_stmt|;
name|skip_name_search
operator|=
name|ISC_TRUE
expr_stmt|;
name|skip_type_search
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_tkey
condition|)
block|{
comment|/* 			 * A TKEY must be in the additional section if this 			 * is a query, and the answer section if this is a 			 * response.  Unless it's a Win2000 client. 			 * 			 * Its class is ignored. 			 */
name|dns_section_t
name|tkeysection
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_QR
operator|)
operator|==
literal|0
condition|)
name|tkeysection
operator|=
name|DNS_SECTION_ADDITIONAL
expr_stmt|;
else|else
name|tkeysection
operator|=
name|DNS_SECTION_ANSWER
expr_stmt|;
if|if
condition|(
name|sectionid
operator|!=
name|tkeysection
operator|&&
name|sectionid
operator|!=
name|DNS_SECTION_ANSWER
condition|)
name|DO_FORMERR
expr_stmt|;
block|}
comment|/* 		 * ... now get ttl and rdatalen, and check buffer. 		 */
name|ttl
operator|=
name|isc_buffer_getuint32
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|rdatalen
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|r
operator|.
name|length
operator|-=
operator|(
literal|2
operator|+
literal|2
operator|+
literal|4
operator|+
literal|2
operator|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
name|rdatalen
condition|)
block|{
name|result
operator|=
name|ISC_R_UNEXPECTEDEND
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 		 * Read the rdata from the wire format.  Interpret the 		 * rdata according to its actual class, even if it had a 		 * DynDNS meta-class in the packet (unless this is a TSIG). 		 * Then put the meta-class back into the finished rdata. 		 */
name|rdata
operator|=
name|newrdata
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|msg
operator|->
name|opcode
operator|==
name|dns_opcode_update
operator|&&
name|update
argument_list|(
name|sectionid
argument_list|,
name|rdclass
argument_list|)
condition|)
block|{
if|if
condition|(
name|rdatalen
operator|!=
literal|0
condition|)
block|{
name|result
operator|=
name|DNS_R_FORMERR
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* 			 * When the rdata is empty, the data pointer is 			 * never dereferenced, but it must still be non-NULL.  			 * Casting 1 rather than "" avoids warnings about 			 * discarding the const attribute of a string, 			 * for compilers that would warn about such things. 			 */
name|rdata
operator|->
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|1
expr_stmt|;
name|rdata
operator|->
name|length
operator|=
literal|0
expr_stmt|;
name|rdata
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|rdata
operator|->
name|type
operator|=
name|rdtype
expr_stmt|;
name|rdata
operator|->
name|flags
operator|=
name|DNS_RDATA_UPDATE
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
else|else
name|result
operator|=
name|getrdata
argument_list|(
name|source
argument_list|,
name|msg
argument_list|,
name|dctx
argument_list|,
name|rdclass
argument_list|,
name|rdtype
argument_list|,
name|rdatalen
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|rdata
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|issigzero
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_rrsig
operator|&&
name|rdata
operator|->
name|flags
operator|==
literal|0
condition|)
block|{
name|covers
operator|=
name|dns_rdata_covers
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|covers
operator|==
literal|0
condition|)
name|DO_FORMERR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_sig
comment|/* SIG(0) */
operator|&&
name|rdata
operator|->
name|flags
operator|==
literal|0
condition|)
block|{
name|covers
operator|=
name|dns_rdata_covers
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|covers
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sectionid
operator|!=
name|DNS_SECTION_ADDITIONAL
operator|||
name|count
operator|!=
name|msg
operator|->
name|counts
index|[
name|sectionid
index|]
operator|-
literal|1
condition|)
name|DO_FORMERR
expr_stmt|;
name|msg
operator|->
name|sigstart
operator|=
name|recstart
expr_stmt|;
name|skip_name_search
operator|=
name|ISC_TRUE
expr_stmt|;
name|skip_type_search
operator|=
name|ISC_TRUE
expr_stmt|;
name|issigzero
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
else|else
name|covers
operator|=
literal|0
expr_stmt|;
comment|/* 		 * If we are doing a dynamic update or this is a meta-type, 		 * don't bother searching for a name, just append this one 		 * to the end of the message. 		 */
if|if
condition|(
name|preserve_order
operator|||
name|msg
operator|->
name|opcode
operator|==
name|dns_opcode_update
operator|||
name|skip_name_search
condition|)
block|{
if|if
condition|(
name|rdtype
operator|!=
name|dns_rdatatype_opt
operator|&&
name|rdtype
operator|!=
name|dns_rdatatype_tsig
operator|&&
operator|!
name|issigzero
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
operator|*
name|section
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_name
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 			 * Run through the section, looking to see if this name 			 * is already there.  If it is found, put back the 			 * allocated name since we no longer need it, and set 			 * our name pointer to point to the name we found. 			 */
name|result
operator|=
name|findname
argument_list|(
operator|&
name|name2
argument_list|,
name|name
argument_list|,
name|section
argument_list|)
expr_stmt|;
comment|/* 			 * If it is a new name, append to the section. 			 */
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|name
operator|=
name|name2
expr_stmt|;
block|}
else|else
block|{
name|ISC_LIST_APPEND
argument_list|(
operator|*
name|section
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|free_name
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
comment|/* 		 * Search name for the particular type and class. 		 * Skip this stage if in update mode or this is a meta-type. 		 */
if|if
condition|(
name|preserve_order
operator|||
name|msg
operator|->
name|opcode
operator|==
name|dns_opcode_update
operator|||
name|skip_type_search
condition|)
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
else|else
block|{
comment|/* 			 * If this is a type that can only occur in 			 * the question section, fail. 			 */
if|if
condition|(
name|dns_rdatatype_questiononly
argument_list|(
name|rdtype
argument_list|)
condition|)
name|DO_FORMERR
expr_stmt|;
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_find
argument_list|(
name|name
argument_list|,
name|rdclass
argument_list|,
name|rdtype
argument_list|,
name|covers
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * If we found an rdataset that matches, we need to 		 * append this rdata to that set.  If we did not, we need 		 * to create a new rdatalist, store the important bits there, 		 * convert it to an rdataset, and link the latter to the name. 		 * Yuck.  When appending, make certain that the type isn't 		 * a singleton type, such as SOA or CNAME. 		 * 		 * Note that this check will be bypassed when preserving order, 		 * the opcode is an update, or the type search is skipped. 		 */
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|dns_rdatatype_issingleton
argument_list|(
name|rdtype
argument_list|)
condition|)
name|DO_FORMERR
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
name|rdataset
operator|=
name|isc_mempool_get
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|free_rdataset
operator|=
name|ISC_TRUE
expr_stmt|;
name|rdatalist
operator|=
name|newrdatalist
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdatalist
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|rdatalist
operator|->
name|type
operator|=
name|rdtype
expr_stmt|;
name|rdatalist
operator|->
name|covers
operator|=
name|covers
expr_stmt|;
name|rdatalist
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|rdatalist
operator|->
name|ttl
operator|=
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
name|rdatalist
argument_list|,
name|rdataset
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdtype
operator|!=
name|dns_rdatatype_opt
operator|&&
name|rdtype
operator|!=
name|dns_rdatatype_tsig
operator|&&
operator|!
name|issigzero
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free_rdataset
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
block|}
comment|/* 		 * Minimize TTLs. 		 * 		 * Section 5.2 of RFC 2181 says we should drop 		 * nonauthoritative rrsets where the TTLs differ, but we 		 * currently treat them the as if they were authoritative and 		 * minimize them. 		 */
if|if
condition|(
name|ttl
operator|!=
name|rdataset
operator|->
name|ttl
condition|)
block|{
name|rdataset
operator|->
name|attributes
operator||=
name|DNS_RDATASETATTR_TTLADJUSTED
expr_stmt|;
if|if
condition|(
name|ttl
operator|<
name|rdataset
operator|->
name|ttl
condition|)
name|rdataset
operator|->
name|ttl
operator|=
name|ttl
expr_stmt|;
block|}
comment|/* 		 * XXXMLG Perform a totally ugly hack here to pull 		 * the rdatalist out of the private field in the rdataset, 		 * and append this rdata to the rdatalist's linked list 		 * of rdata. 		 */
name|rdatalist
operator|=
operator|(
name|dns_rdatalist_t
operator|*
operator|)
operator|(
name|rdataset
operator|->
name|private1
operator|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
comment|/* 		 * If this is an OPT record, remember it.  Also, set 		 * the extended rcode.  Note that msg->opt will only be set 		 * if best-effort parsing is enabled. 		 */
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_opt
operator|&&
name|msg
operator|->
name|opt
operator|==
name|NULL
condition|)
block|{
name|dns_rcode_t
name|ercode
decl_stmt|;
name|msg
operator|->
name|opt
operator|=
name|rdataset
expr_stmt|;
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|free_rdataset
operator|=
name|ISC_FALSE
expr_stmt|;
name|ercode
operator|=
call|(
name|dns_rcode_t
call|)
argument_list|(
operator|(
name|msg
operator|->
name|opt
operator|->
name|ttl
operator|&
name|DNS_MESSAGE_EDNSRCODE_MASK
operator|)
operator|>>
literal|20
argument_list|)
expr_stmt|;
name|msg
operator|->
name|rcode
operator||=
name|ercode
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free_name
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
comment|/* 		 * If this is an SIG(0) or TSIG record, remember it.  Note 		 * that msg->sig0 or msg->tsig will only be set if best-effort 		 * parsing is enabled. 		 */
if|if
condition|(
name|issigzero
operator|&&
name|msg
operator|->
name|sig0
operator|==
name|NULL
condition|)
block|{
name|msg
operator|->
name|sig0
operator|=
name|rdataset
expr_stmt|;
name|msg
operator|->
name|sig0name
operator|=
name|name
expr_stmt|;
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|free_rdataset
operator|=
name|ISC_FALSE
expr_stmt|;
name|free_name
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdtype
operator|==
name|dns_rdatatype_tsig
operator|&&
name|msg
operator|->
name|tsig
operator|==
name|NULL
condition|)
block|{
name|msg
operator|->
name|tsig
operator|=
name|rdataset
expr_stmt|;
name|msg
operator|->
name|tsigname
operator|=
name|name
expr_stmt|;
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|free_rdataset
operator|=
name|ISC_FALSE
expr_stmt|;
name|free_name
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
if|if
condition|(
name|seen_problem
condition|)
block|{
if|if
condition|(
name|free_name
condition|)
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_rdataset
condition|)
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
name|free_name
operator|=
name|free_rdataset
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|free_name
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|free_rdataset
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|seen_problem
condition|)
return|return
operator|(
name|DNS_R_RECOVERABLE
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|free_name
condition|)
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_rdataset
condition|)
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_parse
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_buffer_t
modifier|*
name|source
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|dns_decompress_t
name|dctx
decl_stmt|;
name|isc_result_t
name|ret
decl_stmt|;
name|isc_uint16_t
name|tmpflags
decl_stmt|;
name|isc_buffer_t
name|origsource
decl_stmt|;
name|isc_boolean_t
name|seen_problem
decl_stmt|;
name|isc_boolean_t
name|ignore_tc
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|source
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|from_to_wire
operator|==
name|DNS_MESSAGE_INTENTPARSE
argument_list|)
expr_stmt|;
name|seen_problem
operator|=
name|ISC_FALSE
expr_stmt|;
name|ignore_tc
operator|=
name|ISC_TF
argument_list|(
name|options
operator|&
name|DNS_MESSAGEPARSE_IGNORETRUNCATION
argument_list|)
expr_stmt|;
name|origsource
operator|=
operator|*
name|source
expr_stmt|;
name|msg
operator|->
name|header_ok
operator|=
literal|0
expr_stmt|;
name|msg
operator|->
name|question_ok
operator|=
literal|0
expr_stmt|;
name|isc_buffer_remainingregion
argument_list|(
name|source
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
name|DNS_MESSAGE_HEADERLEN
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|msg
operator|->
name|id
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|tmpflags
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|msg
operator|->
name|opcode
operator|=
operator|(
operator|(
name|tmpflags
operator|&
name|DNS_MESSAGE_OPCODE_MASK
operator|)
operator|>>
name|DNS_MESSAGE_OPCODE_SHIFT
operator|)
expr_stmt|;
name|msg
operator|->
name|rcode
operator|=
call|(
name|dns_rcode_t
call|)
argument_list|(
name|tmpflags
operator|&
name|DNS_MESSAGE_RCODE_MASK
argument_list|)
expr_stmt|;
name|msg
operator|->
name|flags
operator|=
operator|(
name|tmpflags
operator|&
name|DNS_MESSAGE_FLAG_MASK
operator|)
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_QUESTION
index|]
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ANSWER
index|]
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_AUTHORITY
index|]
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ADDITIONAL
index|]
operator|=
name|isc_buffer_getuint16
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|msg
operator|->
name|header_ok
operator|=
literal|1
expr_stmt|;
comment|/* 	 * -1 means no EDNS. 	 */
name|dns_decompress_init
argument_list|(
operator|&
name|dctx
argument_list|,
operator|-
literal|1
argument_list|,
name|DNS_DECOMPRESS_ANY
argument_list|)
expr_stmt|;
name|dns_decompress_setmethods
argument_list|(
operator|&
name|dctx
argument_list|,
name|DNS_COMPRESS_GLOBAL14
argument_list|)
expr_stmt|;
name|ret
operator|=
name|getquestions
argument_list|(
name|source
argument_list|,
name|msg
argument_list|,
operator|&
name|dctx
argument_list|,
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ISC_R_UNEXPECTEDEND
operator|&&
name|ignore_tc
condition|)
goto|goto
name|truncated
goto|;
if|if
condition|(
name|ret
operator|==
name|DNS_R_RECOVERABLE
condition|)
block|{
name|seen_problem
operator|=
name|ISC_TRUE
expr_stmt|;
name|ret
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|msg
operator|->
name|question_ok
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|getsection
argument_list|(
name|source
argument_list|,
name|msg
argument_list|,
operator|&
name|dctx
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ISC_R_UNEXPECTEDEND
operator|&&
name|ignore_tc
condition|)
goto|goto
name|truncated
goto|;
if|if
condition|(
name|ret
operator|==
name|DNS_R_RECOVERABLE
condition|)
block|{
name|seen_problem
operator|=
name|ISC_TRUE
expr_stmt|;
name|ret
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|ret
operator|=
name|getsection
argument_list|(
name|source
argument_list|,
name|msg
argument_list|,
operator|&
name|dctx
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|,
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ISC_R_UNEXPECTEDEND
operator|&&
name|ignore_tc
condition|)
goto|goto
name|truncated
goto|;
if|if
condition|(
name|ret
operator|==
name|DNS_R_RECOVERABLE
condition|)
block|{
name|seen_problem
operator|=
name|ISC_TRUE
expr_stmt|;
name|ret
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|ret
operator|=
name|getsection
argument_list|(
name|source
argument_list|,
name|msg
argument_list|,
operator|&
name|dctx
argument_list|,
name|DNS_SECTION_ADDITIONAL
argument_list|,
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ISC_R_UNEXPECTEDEND
operator|&&
name|ignore_tc
condition|)
goto|goto
name|truncated
goto|;
if|if
condition|(
name|ret
operator|==
name|DNS_R_RECOVERABLE
condition|)
block|{
name|seen_problem
operator|=
name|ISC_TRUE
expr_stmt|;
name|ret
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|isc_buffer_remainingregion
argument_list|(
name|source
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|!=
literal|0
condition|)
block|{
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|ISC_LOGCATEGORY_GENERAL
argument_list|,
name|DNS_LOGMODULE_MESSAGE
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"message has %u byte(s) of trailing garbage"
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
name|truncated
label|:
if|if
condition|(
operator|(
name|options
operator|&
name|DNS_MESSAGEPARSE_CLONEBUFFER
operator|)
operator|==
literal|0
condition|)
name|isc_buffer_usedregion
argument_list|(
operator|&
name|origsource
argument_list|,
operator|&
name|msg
operator|->
name|saved
argument_list|)
expr_stmt|;
else|else
block|{
name|msg
operator|->
name|saved
operator|.
name|length
operator|=
name|isc_buffer_usedlength
argument_list|(
operator|&
name|origsource
argument_list|)
expr_stmt|;
name|msg
operator|->
name|saved
operator|.
name|base
operator|=
name|isc_mem_get
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
name|msg
operator|->
name|saved
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|saved
operator|.
name|base
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|memcpy
argument_list|(
name|msg
operator|->
name|saved
operator|.
name|base
argument_list|,
name|isc_buffer_base
argument_list|(
operator|&
name|origsource
argument_list|)
argument_list|,
name|msg
operator|->
name|saved
operator|.
name|length
argument_list|)
expr_stmt|;
name|msg
operator|->
name|free_saved
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
name|ISC_R_UNEXPECTEDEND
operator|&&
name|ignore_tc
condition|)
return|return
operator|(
name|DNS_R_RECOVERABLE
operator|)
return|;
if|if
condition|(
name|seen_problem
operator|==
name|ISC_TRUE
condition|)
return|return
operator|(
name|DNS_R_RECOVERABLE
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_renderbegin
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_compress_t
modifier|*
name|cctx
parameter_list|,
name|isc_buffer_t
modifier|*
name|buffer
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|buffer
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|from_to_wire
operator|==
name|DNS_MESSAGE_INTENTRENDER
argument_list|)
expr_stmt|;
name|msg
operator|->
name|cctx
operator|=
name|cctx
expr_stmt|;
comment|/* 	 * Erase the contents of this buffer. 	 */
name|isc_buffer_clear
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
comment|/* 	 * Make certain there is enough for at least the header in this 	 * buffer. 	 */
name|isc_buffer_availableregion
argument_list|(
name|buffer
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
name|DNS_MESSAGE_HEADERLEN
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
name|msg
operator|->
name|reserved
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
comment|/* 	 * Reserve enough space for the header in this buffer. 	 */
name|isc_buffer_add
argument_list|(
name|buffer
argument_list|,
name|DNS_MESSAGE_HEADERLEN
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buffer
operator|=
name|buffer
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_renderchangebuffer
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_buffer_t
modifier|*
name|buffer
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|,
name|rn
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Ensure that the new buffer is empty, and has enough space to 	 * hold the current contents. 	 */
name|isc_buffer_clear
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|isc_buffer_availableregion
argument_list|(
name|buffer
argument_list|,
operator|&
name|rn
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
name|msg
operator|->
name|buffer
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rn
operator|.
name|length
operator|>
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
comment|/* 	 * Copy the contents from the old to the new buffer. 	 */
name|isc_buffer_add
argument_list|(
name|buffer
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rn
operator|.
name|base
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buffer
operator|=
name|buffer
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_renderrelease
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|unsigned
name|int
name|space
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|space
operator|<=
name|msg
operator|->
name|reserved
argument_list|)
expr_stmt|;
name|msg
operator|->
name|reserved
operator|-=
name|space
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_renderreserve
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|unsigned
name|int
name|space
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|buffer
operator|!=
name|NULL
condition|)
block|{
name|isc_buffer_availableregion
argument_list|(
name|msg
operator|->
name|buffer
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
operator|(
name|space
operator|+
name|msg
operator|->
name|reserved
operator|)
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
block|}
name|msg
operator|->
name|reserved
operator|+=
name|space
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|wrong_priority
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rds
parameter_list|,
name|int
name|pass
parameter_list|,
name|dns_rdatatype_t
name|preferred_glue
parameter_list|)
block|{
name|int
name|pass_needed
decl_stmt|;
comment|/* 	 * If we are not rendering class IN, this ordering is bogus. 	 */
if|if
condition|(
name|rds
operator|->
name|rdclass
operator|!=
name|dns_rdataclass_in
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
switch|switch
condition|(
name|rds
operator|->
name|type
condition|)
block|{
case|case
name|dns_rdatatype_a
case|:
case|case
name|dns_rdatatype_aaaa
case|:
if|if
condition|(
name|preferred_glue
operator|==
name|rds
operator|->
name|type
condition|)
name|pass_needed
operator|=
literal|4
expr_stmt|;
else|else
name|pass_needed
operator|=
literal|3
expr_stmt|;
break|break;
case|case
name|dns_rdatatype_rrsig
case|:
case|case
name|dns_rdatatype_dnskey
case|:
name|pass_needed
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|pass_needed
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|pass_needed
operator|>=
name|pass
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_rendersection
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_section_t
name|sectionid
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|)
block|{
name|dns_namelist_t
modifier|*
name|section
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|,
modifier|*
name|next_name
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|,
modifier|*
name|next_rdataset
decl_stmt|;
name|unsigned
name|int
name|count
decl_stmt|,
name|total
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|st
decl_stmt|;
comment|/* for rollbacks */
name|int
name|pass
decl_stmt|;
name|isc_boolean_t
name|partial
init|=
name|ISC_FALSE
decl_stmt|;
name|unsigned
name|int
name|rd_options
decl_stmt|;
name|dns_rdatatype_t
name|preferred_glue
init|=
literal|0
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_NAMED_SECTION
argument_list|(
name|sectionid
argument_list|)
argument_list|)
expr_stmt|;
name|section
operator|=
operator|&
name|msg
operator|->
name|sections
index|[
name|sectionid
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|sectionid
operator|==
name|DNS_SECTION_ADDITIONAL
operator|)
operator|&&
operator|(
name|options
operator|&
name|DNS_MESSAGERENDER_ORDERED
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|options
operator|&
name|DNS_MESSAGERENDER_PREFER_A
operator|)
operator|!=
literal|0
condition|)
block|{
name|preferred_glue
operator|=
name|dns_rdatatype_a
expr_stmt|;
name|pass
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|options
operator|&
name|DNS_MESSAGERENDER_PREFER_AAAA
operator|)
operator|!=
literal|0
condition|)
block|{
name|preferred_glue
operator|=
name|dns_rdatatype_aaaa
expr_stmt|;
name|pass
operator|=
literal|4
expr_stmt|;
block|}
else|else
name|pass
operator|=
literal|3
expr_stmt|;
block|}
else|else
name|pass
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|options
operator|&
name|DNS_MESSAGERENDER_OMITDNSSEC
operator|)
operator|==
literal|0
condition|)
name|rd_options
operator|=
literal|0
expr_stmt|;
else|else
name|rd_options
operator|=
name|DNS_RDATASETTOWIRE_OMITDNSSEC
expr_stmt|;
comment|/* 	 * Shrink the space in the buffer by the reserved amount. 	 */
name|msg
operator|->
name|buffer
operator|->
name|length
operator|-=
name|msg
operator|->
name|reserved
expr_stmt|;
name|total
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|reserved
operator|==
literal|0
operator|&&
operator|(
name|options
operator|&
name|DNS_MESSAGERENDER_PARTIAL
operator|)
operator|!=
literal|0
condition|)
name|partial
operator|=
name|ISC_TRUE
expr_stmt|;
comment|/* 	 * Render required glue first.  Set TC if it won't fit. 	 */
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
block|{
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|!=
name|NULL
operator|&&
operator|(
name|rdataset
operator|->
name|attributes
operator|&
name|DNS_RDATASETATTR_REQUIREDGLUE
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|rdataset
operator|->
name|attributes
operator|&
name|DNS_RDATASETATTR_RENDERED
operator|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|void
modifier|*
name|order_arg
init|=
name|msg
operator|->
name|order_arg
decl_stmt|;
name|st
operator|=
operator|*
operator|(
name|msg
operator|->
name|buffer
operator|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|partial
condition|)
name|result
operator|=
name|dns_rdataset_towirepartial
argument_list|(
name|rdataset
argument_list|,
name|name
argument_list|,
name|msg
operator|->
name|cctx
argument_list|,
name|msg
operator|->
name|buffer
argument_list|,
name|msg
operator|->
name|order
argument_list|,
name|order_arg
argument_list|,
name|rd_options
argument_list|,
operator|&
name|count
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|dns_rdataset_towiresorted
argument_list|(
name|rdataset
argument_list|,
name|name
argument_list|,
name|msg
operator|->
name|cctx
argument_list|,
name|msg
operator|->
name|buffer
argument_list|,
name|msg
operator|->
name|order
argument_list|,
name|order_arg
argument_list|,
name|rd_options
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|total
operator|+=
name|count
expr_stmt|;
if|if
condition|(
name|partial
operator|&&
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
block|{
name|msg
operator|->
name|flags
operator||=
name|DNS_MESSAGEFLAG_TC
expr_stmt|;
name|msg
operator|->
name|buffer
operator|->
name|length
operator|+=
name|msg
operator|->
name|reserved
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|sectionid
index|]
operator|+=
name|total
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|INSIST
argument_list|(
name|st
operator|.
name|used
operator|<
literal|65536
argument_list|)
expr_stmt|;
name|dns_compress_rollback
argument_list|(
name|msg
operator|->
name|cctx
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|st
operator|.
name|used
argument_list|)
expr_stmt|;
operator|*
operator|(
name|msg
operator|->
name|buffer
operator|)
operator|=
name|st
expr_stmt|;
comment|/* rollback */
name|msg
operator|->
name|buffer
operator|->
name|length
operator|+=
name|msg
operator|->
name|reserved
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|sectionid
index|]
operator|+=
name|total
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|rdataset
operator|->
name|attributes
operator||=
name|DNS_RDATASETATTR_RENDERED
expr_stmt|;
block|}
block|}
do|do
block|{
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
name|msg
operator|->
name|buffer
operator|->
name|length
operator|+=
name|msg
operator|->
name|reserved
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|sectionid
index|]
operator|+=
name|total
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
while|while
condition|(
name|name
operator|!=
name|NULL
condition|)
block|{
name|next_name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
expr_stmt|;
while|while
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
block|{
name|next_rdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdataset
operator|->
name|attributes
operator|&
name|DNS_RDATASETATTR_RENDERED
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|next
goto|;
if|if
condition|(
operator|(
operator|(
name|options
operator|&
name|DNS_MESSAGERENDER_ORDERED
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|sectionid
operator|==
name|DNS_SECTION_ADDITIONAL
operator|)
operator|&&
name|wrong_priority
argument_list|(
name|rdataset
argument_list|,
name|pass
argument_list|,
name|preferred_glue
argument_list|)
condition|)
goto|goto
name|next
goto|;
name|st
operator|=
operator|*
operator|(
name|msg
operator|->
name|buffer
operator|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|partial
condition|)
name|result
operator|=
name|dns_rdataset_towirepartial
argument_list|(
name|rdataset
argument_list|,
name|name
argument_list|,
name|msg
operator|->
name|cctx
argument_list|,
name|msg
operator|->
name|buffer
argument_list|,
name|msg
operator|->
name|order
argument_list|,
name|msg
operator|->
name|order_arg
argument_list|,
name|rd_options
argument_list|,
operator|&
name|count
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|dns_rdataset_towiresorted
argument_list|(
name|rdataset
argument_list|,
name|name
argument_list|,
name|msg
operator|->
name|cctx
argument_list|,
name|msg
operator|->
name|buffer
argument_list|,
name|msg
operator|->
name|order
argument_list|,
name|msg
operator|->
name|order_arg
argument_list|,
name|rd_options
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|total
operator|+=
name|count
expr_stmt|;
comment|/* 				 * If out of space, record stats on what we 				 * rendered so far, and return that status. 				 * 				 * XXXMLG Need to change this when 				 * dns_rdataset_towire() can render partial 				 * sets starting at some arbitary point in the 				 * set.  This will include setting a bit in the 				 * rdataset to indicate that a partial 				 * rendering was done, and some state saved 				 * somewhere (probably in the message struct) 				 * to indicate where to continue from. 				 */
if|if
condition|(
name|partial
operator|&&
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
block|{
name|msg
operator|->
name|buffer
operator|->
name|length
operator|+=
name|msg
operator|->
name|reserved
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|sectionid
index|]
operator|+=
name|total
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|INSIST
argument_list|(
name|st
operator|.
name|used
operator|<
literal|65536
argument_list|)
expr_stmt|;
name|dns_compress_rollback
argument_list|(
name|msg
operator|->
name|cctx
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|st
operator|.
name|used
argument_list|)
expr_stmt|;
operator|*
operator|(
name|msg
operator|->
name|buffer
operator|)
operator|=
name|st
expr_stmt|;
comment|/* rollback */
name|msg
operator|->
name|buffer
operator|->
name|length
operator|+=
name|msg
operator|->
name|reserved
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|sectionid
index|]
operator|+=
name|total
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 				 * If we have rendered non-validated data, 				 * ensure that the AD bit is not set. 				 */
if|if
condition|(
name|rdataset
operator|->
name|trust
operator|!=
name|dns_trust_secure
operator|&&
operator|(
name|sectionid
operator|==
name|DNS_SECTION_ANSWER
operator|||
name|sectionid
operator|==
name|DNS_SECTION_AUTHORITY
operator|)
condition|)
name|msg
operator|->
name|flags
operator|&=
operator|~
name|DNS_MESSAGEFLAG_AD
expr_stmt|;
name|rdataset
operator|->
name|attributes
operator||=
name|DNS_RDATASETATTR_RENDERED
expr_stmt|;
name|next
label|:
name|rdataset
operator|=
name|next_rdataset
expr_stmt|;
block|}
name|name
operator|=
name|next_name
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|--
name|pass
operator|!=
literal|0
condition|)
do|;
name|msg
operator|->
name|buffer
operator|->
name|length
operator|+=
name|msg
operator|->
name|reserved
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|sectionid
index|]
operator|+=
name|total
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_renderheader
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|)
block|{
name|isc_uint16_t
name|tmp
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|isc_buffer_availableregion
argument_list|(
name|target
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|r
operator|.
name|length
operator|>=
name|DNS_MESSAGE_HEADERLEN
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
name|target
argument_list|,
name|msg
operator|->
name|id
argument_list|)
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|msg
operator|->
name|opcode
operator|<<
name|DNS_MESSAGE_OPCODE_SHIFT
operator|)
operator|&
name|DNS_MESSAGE_OPCODE_MASK
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|msg
operator|->
name|rcode
operator|&
name|DNS_MESSAGE_RCODE_MASK
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGE_FLAG_MASK
operator|)
expr_stmt|;
name|INSIST
argument_list|(
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_QUESTION
index|]
operator|<
literal|65536
operator|&&
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ANSWER
index|]
operator|<
literal|65536
operator|&&
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_AUTHORITY
index|]
operator|<
literal|65536
operator|&&
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ADDITIONAL
index|]
operator|<
literal|65536
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
name|target
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
name|target
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_QUESTION
index|]
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
name|target
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ANSWER
index|]
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
name|target
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_AUTHORITY
index|]
argument_list|)
expr_stmt|;
name|isc_buffer_putuint16
argument_list|(
name|target
argument_list|,
operator|(
name|isc_uint16_t
operator|)
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ADDITIONAL
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_renderend
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|isc_buffer_t
name|tmpbuf
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|int
name|result
decl_stmt|;
name|unsigned
name|int
name|count
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|rcode
operator|&
operator|~
name|DNS_MESSAGE_RCODE_MASK
operator|)
operator|!=
literal|0
operator|&&
name|msg
operator|->
name|opt
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * We have an extended rcode but are not using EDNS. 		 */
return|return
operator|(
name|DNS_R_FORMERR
operator|)
return|;
block|}
comment|/* 	 * If we've got an OPT record, render it. 	 */
if|if
condition|(
name|msg
operator|->
name|opt
operator|!=
name|NULL
condition|)
block|{
name|dns_message_renderrelease
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|opt_reserved
argument_list|)
expr_stmt|;
name|msg
operator|->
name|opt_reserved
operator|=
literal|0
expr_stmt|;
comment|/* 		 * Set the extended rcode. 		 */
name|msg
operator|->
name|opt
operator|->
name|ttl
operator|&=
operator|~
name|DNS_MESSAGE_EDNSRCODE_MASK
expr_stmt|;
name|msg
operator|->
name|opt
operator|->
name|ttl
operator||=
operator|(
operator|(
name|msg
operator|->
name|rcode
operator|<<
literal|20
operator|)
operator|&
name|DNS_MESSAGE_EDNSRCODE_MASK
operator|)
expr_stmt|;
comment|/* 		 * Render. 		 */
name|count
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dns_rdataset_towire
argument_list|(
name|msg
operator|->
name|opt
argument_list|,
name|dns_rootname
argument_list|,
name|msg
operator|->
name|cctx
argument_list|,
name|msg
operator|->
name|buffer
argument_list|,
literal|0
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ADDITIONAL
index|]
operator|+=
name|count
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * If we're adding a TSIG or SIG(0) to a truncated message, 	 * clear all rdatasets from the message except for the question 	 * before adding the TSIG or SIG(0).  If the question doesn't fit, 	 * don't include it. 	 */
if|if
condition|(
operator|(
name|msg
operator|->
name|tsigkey
operator|!=
name|NULL
operator|||
name|msg
operator|->
name|sig0key
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_TC
operator|)
operator|!=
literal|0
condition|)
block|{
name|isc_buffer_t
modifier|*
name|buf
decl_stmt|;
name|msgresetnames
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
name|buf
operator|=
name|msg
operator|->
name|buffer
expr_stmt|;
name|dns_message_renderreset
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buffer
operator|=
name|buf
expr_stmt|;
name|isc_buffer_clear
argument_list|(
name|msg
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
name|msg
operator|->
name|buffer
argument_list|,
name|DNS_MESSAGE_HEADERLEN
argument_list|)
expr_stmt|;
name|dns_compress_rollback
argument_list|(
name|msg
operator|->
name|cctx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_rendersection
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|ISC_R_NOSPACE
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * If we're adding a TSIG record, generate and render it. 	 */
if|if
condition|(
name|msg
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
block|{
name|dns_message_renderrelease
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|sig_reserved
argument_list|)
expr_stmt|;
name|msg
operator|->
name|sig_reserved
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dns_tsig_sign
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|count
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dns_rdataset_towire
argument_list|(
name|msg
operator|->
name|tsig
argument_list|,
name|msg
operator|->
name|tsigname
argument_list|,
name|msg
operator|->
name|cctx
argument_list|,
name|msg
operator|->
name|buffer
argument_list|,
literal|0
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ADDITIONAL
index|]
operator|+=
name|count
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * If we're adding a SIG(0) record, generate and render it. 	 */
if|if
condition|(
name|msg
operator|->
name|sig0key
operator|!=
name|NULL
condition|)
block|{
name|dns_message_renderrelease
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|sig_reserved
argument_list|)
expr_stmt|;
name|msg
operator|->
name|sig_reserved
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dns_dnssec_signmessage
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|sig0key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|count
operator|=
literal|0
expr_stmt|;
comment|/* 		 * Note: dns_rootname is used here, not msg->sig0name, since 		 * the owner name of a SIG(0) is irrelevant, and will not 		 * be set in a message being rendered. 		 */
name|result
operator|=
name|dns_rdataset_towire
argument_list|(
name|msg
operator|->
name|sig0
argument_list|,
name|dns_rootname
argument_list|,
name|msg
operator|->
name|cctx
argument_list|,
name|msg
operator|->
name|buffer
argument_list|,
literal|0
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ADDITIONAL
index|]
operator|+=
name|count
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
name|isc_buffer_usedregion
argument_list|(
name|msg
operator|->
name|buffer
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|tmpbuf
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|dns_message_renderheader
argument_list|(
name|msg
argument_list|,
operator|&
name|tmpbuf
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buffer
operator|=
name|NULL
expr_stmt|;
comment|/* forget about this buffer only on success XXX */
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_renderreset
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rds
decl_stmt|;
comment|/* 	 * Reset the message so that it may be rendered again. 	 */
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|from_to_wire
operator|==
name|DNS_MESSAGE_INTENTRENDER
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buffer
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DNS_SECTION_MAX
condition|;
name|i
operator|++
control|)
block|{
name|msg
operator|->
name|cursors
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|msg
operator|->
name|counts
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|sections
index|[
name|i
index|]
argument_list|)
init|;
name|name
operator|!=
name|NULL
condition|;
name|name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|link
argument_list|)
control|)
block|{
for|for
control|(
name|rds
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rds
operator|!=
name|NULL
condition|;
name|rds
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rds
argument_list|,
name|link
argument_list|)
control|)
block|{
name|rds
operator|->
name|attributes
operator|&=
operator|~
name|DNS_RDATASETATTR_RENDERED
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|msg
operator|->
name|tsigname
operator|!=
name|NULL
condition|)
name|dns_message_puttempname
argument_list|(
name|msg
argument_list|,
operator|&
name|msg
operator|->
name|tsigname
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|tsig
operator|!=
name|NULL
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
name|msg
operator|->
name|tsig
argument_list|)
expr_stmt|;
name|dns_message_puttemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|msg
operator|->
name|tsig
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|sig0
operator|!=
name|NULL
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
name|msg
operator|->
name|sig0
argument_list|)
expr_stmt|;
name|dns_message_puttemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|msg
operator|->
name|sig0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_firstname
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_section_t
name|section
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_NAMED_SECTION
argument_list|(
name|section
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|cursors
index|[
name|section
index|]
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|msg
operator|->
name|sections
index|[
name|section
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|cursors
index|[
name|section
index|]
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_nextname
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_section_t
name|section
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_NAMED_SECTION
argument_list|(
name|section
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|cursors
index|[
name|section
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|->
name|cursors
index|[
name|section
index|]
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|msg
operator|->
name|cursors
index|[
name|section
index|]
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|cursors
index|[
name|section
index|]
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_currentname
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_section_t
name|section
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|name
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_NAMED_SECTION
argument_list|(
name|section
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
operator|&&
operator|*
name|name
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|cursors
index|[
name|section
index|]
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|name
operator|=
name|msg
operator|->
name|cursors
index|[
name|section
index|]
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_findname
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_section_t
name|section
parameter_list|,
name|dns_name_t
modifier|*
name|target
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdatatype_t
name|covers
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
modifier|*
name|rdataset
parameter_list|)
block|{
name|dns_name_t
modifier|*
name|foundname
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * XXX These requirements are probably too intensive, especially 	 * where things can be NULL, but as they are they ensure that if 	 * something is NON-NULL, indicating that the caller expects it 	 * to be filled in, that we can in fact fill it in. 	 */
name|REQUIRE
argument_list|(
name|msg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SECTION
argument_list|(
name|section
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
name|REQUIRE
argument_list|(
operator|*
name|name
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_any
condition|)
block|{
name|REQUIRE
argument_list|(
name|rdataset
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
name|REQUIRE
argument_list|(
operator|*
name|rdataset
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|findname
argument_list|(
operator|&
name|foundname
argument_list|,
name|target
argument_list|,
operator|&
name|msg
operator|->
name|sections
index|[
name|section
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
return|return
operator|(
name|DNS_R_NXDOMAIN
operator|)
return|;
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
operator|*
name|name
operator|=
name|foundname
expr_stmt|;
comment|/* 	 * And now look for the type. 	 */
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_any
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|result
operator|=
name|dns_message_findtype
argument_list|(
name|foundname
argument_list|,
name|type
argument_list|,
name|covers
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
return|return
operator|(
name|DNS_R_NXRRSET
operator|)
return|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_movename
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_section_t
name|fromsection
parameter_list|,
name|dns_section_t
name|tosection
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|msg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|from_to_wire
operator|==
name|DNS_MESSAGE_INTENTRENDER
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_NAMED_SECTION
argument_list|(
name|fromsection
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_NAMED_SECTION
argument_list|(
name|tosection
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Unlink the name from the old section 	 */
name|ISC_LIST_UNLINK
argument_list|(
name|msg
operator|->
name|sections
index|[
name|fromsection
index|]
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|msg
operator|->
name|sections
index|[
name|tosection
index|]
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_message_addname
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_section_t
name|section
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|msg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|from_to_wire
operator|==
name|DNS_MESSAGE_INTENTRENDER
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_NAMED_SECTION
argument_list|(
name|section
argument_list|)
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|msg
operator|->
name|sections
index|[
name|section
index|]
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_gettempname
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|item
operator|!=
name|NULL
operator|&&
operator|*
name|item
operator|==
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|item
operator|=
name|isc_mempool_get
argument_list|(
name|msg
operator|->
name|namepool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|item
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|dns_name_init
argument_list|(
operator|*
name|item
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_gettempoffsets
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_offsets_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|item
operator|!=
name|NULL
operator|&&
operator|*
name|item
operator|==
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|item
operator|=
name|newoffsets
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|item
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_gettemprdata
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdata_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|item
operator|!=
name|NULL
operator|&&
operator|*
name|item
operator|==
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|item
operator|=
name|newrdata
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|item
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_gettemprdataset
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdataset_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|item
operator|!=
name|NULL
operator|&&
operator|*
name|item
operator|==
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|item
operator|=
name|isc_mempool_get
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|item
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|dns_rdataset_init
argument_list|(
operator|*
name|item
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_gettemprdatalist
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdatalist_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|item
operator|!=
name|NULL
operator|&&
operator|*
name|item
operator|==
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|item
operator|=
name|newrdatalist
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|item
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_puttempname
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|item
operator|!=
name|NULL
operator|&&
operator|*
name|item
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_dynamic
argument_list|(
operator|*
name|item
argument_list|)
condition|)
name|dns_name_free
argument_list|(
operator|*
name|item
argument_list|,
name|msg
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|namepool
argument_list|,
operator|*
name|item
argument_list|)
expr_stmt|;
operator|*
name|item
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_message_puttemprdata
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdata_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|item
operator|!=
name|NULL
operator|&&
operator|*
name|item
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|releaserdata
argument_list|(
name|msg
argument_list|,
operator|*
name|item
argument_list|)
expr_stmt|;
operator|*
name|item
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_message_puttemprdataset
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdataset_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|item
operator|!=
name|NULL
operator|&&
operator|*
name|item
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|!
name|dns_rdataset_isassociated
argument_list|(
operator|*
name|item
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|msg
operator|->
name|rdspool
argument_list|,
operator|*
name|item
argument_list|)
expr_stmt|;
operator|*
name|item
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_message_puttemprdatalist
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdatalist_t
modifier|*
modifier|*
name|item
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|item
operator|!=
name|NULL
operator|&&
operator|*
name|item
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|releaserdatalist
argument_list|(
name|msg
argument_list|,
operator|*
name|item
argument_list|)
expr_stmt|;
operator|*
name|item
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_peekheader
parameter_list|(
name|isc_buffer_t
modifier|*
name|source
parameter_list|,
name|dns_messageid_t
modifier|*
name|idp
parameter_list|,
name|unsigned
name|int
modifier|*
name|flagsp
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|isc_buffer_t
name|buffer
decl_stmt|;
name|dns_messageid_t
name|id
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|REQUIRE
argument_list|(
name|source
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|buffer
operator|=
operator|*
name|source
expr_stmt|;
name|isc_buffer_remainingregion
argument_list|(
operator|&
name|buffer
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|length
operator|<
name|DNS_MESSAGE_HEADERLEN
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|id
operator|=
name|isc_buffer_getuint16
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|flags
operator|=
name|isc_buffer_getuint16
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|flags
operator|&=
name|DNS_MESSAGE_FLAG_MASK
expr_stmt|;
if|if
condition|(
name|flagsp
operator|!=
name|NULL
condition|)
operator|*
name|flagsp
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|idp
operator|!=
name|NULL
condition|)
operator|*
name|idp
operator|=
name|id
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_reply
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_boolean_t
name|want_question_section
parameter_list|)
block|{
name|unsigned
name|int
name|first_section
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_QR
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|->
name|header_ok
condition|)
return|return
operator|(
name|DNS_R_FORMERR
operator|)
return|;
if|if
condition|(
name|msg
operator|->
name|opcode
operator|!=
name|dns_opcode_query
operator|&&
name|msg
operator|->
name|opcode
operator|!=
name|dns_opcode_notify
condition|)
name|want_question_section
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|want_question_section
condition|)
block|{
if|if
condition|(
operator|!
name|msg
operator|->
name|question_ok
condition|)
return|return
operator|(
name|DNS_R_FORMERR
operator|)
return|;
name|first_section
operator|=
name|DNS_SECTION_ANSWER
expr_stmt|;
block|}
else|else
name|first_section
operator|=
name|DNS_SECTION_QUESTION
expr_stmt|;
name|msg
operator|->
name|from_to_wire
operator|=
name|DNS_MESSAGE_INTENTRENDER
expr_stmt|;
name|msgresetnames
argument_list|(
name|msg
argument_list|,
name|first_section
argument_list|)
expr_stmt|;
name|msgresetopt
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|msgresetsigs
argument_list|(
name|msg
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|msginitprivate
argument_list|(
name|msg
argument_list|)
expr_stmt|;
comment|/* 	 * We now clear most flags and then set QR, ensuring that the 	 * reply's flags will be in a reasonable state. 	 */
name|msg
operator|->
name|flags
operator|&=
name|DNS_MESSAGE_REPLYPRESERVE
expr_stmt|;
name|msg
operator|->
name|flags
operator||=
name|DNS_MESSAGEFLAG_QR
expr_stmt|;
comment|/* 	 * This saves the query TSIG status, if the query was signed, and 	 * reserves space in the reply for the TSIG. 	 */
if|if
condition|(
name|msg
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
block|{
name|unsigned
name|int
name|otherlen
init|=
literal|0
decl_stmt|;
name|msg
operator|->
name|querytsigstatus
operator|=
name|msg
operator|->
name|tsigstatus
expr_stmt|;
name|msg
operator|->
name|tsigstatus
operator|=
name|dns_rcode_noerror
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|querytsigstatus
operator|==
name|dns_tsigerror_badtime
condition|)
name|otherlen
operator|=
literal|6
expr_stmt|;
name|msg
operator|->
name|sig_reserved
operator|=
name|spacefortsig
argument_list|(
name|msg
operator|->
name|tsigkey
argument_list|,
name|otherlen
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_renderreserve
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|sig_reserved
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|msg
operator|->
name|sig_reserved
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
if|if
condition|(
name|msg
operator|->
name|saved
operator|.
name|base
operator|!=
name|NULL
condition|)
block|{
name|msg
operator|->
name|query
operator|.
name|base
operator|=
name|msg
operator|->
name|saved
operator|.
name|base
expr_stmt|;
name|msg
operator|->
name|query
operator|.
name|length
operator|=
name|msg
operator|->
name|saved
operator|.
name|length
expr_stmt|;
name|msg
operator|->
name|free_query
operator|=
name|msg
operator|->
name|free_saved
expr_stmt|;
name|msg
operator|->
name|saved
operator|.
name|base
operator|=
name|NULL
expr_stmt|;
name|msg
operator|->
name|saved
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|msg
operator|->
name|free_saved
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|dns_rdataset_t
modifier|*
name|dns_message_getopt
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
comment|/* 	 * Get the OPT record for 'msg'. 	 */
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|msg
operator|->
name|opt
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_setopt
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdataset_t
modifier|*
name|opt
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
comment|/* 	 * Set the OPT record for 'msg'. 	 */
comment|/* 	 * The space required for an OPT record is: 	 * 	 *	1 byte for the name 	 *	2 bytes for the type 	 *	2 bytes for the class 	 *	4 bytes for the ttl 	 *	2 bytes for the rdata length 	 * --------------------------------- 	 *     11 bytes 	 * 	 * plus the length of the rdata. 	 */
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|opt
operator|->
name|type
operator|==
name|dns_rdatatype_opt
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|from_to_wire
operator|==
name|DNS_MESSAGE_INTENTRENDER
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|state
operator|==
name|DNS_SECTION_ANY
argument_list|)
expr_stmt|;
name|msgresetopt
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|dns_rdataset_current
argument_list|(
name|opt
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|msg
operator|->
name|opt_reserved
operator|=
literal|11
operator|+
name|rdata
operator|.
name|length
expr_stmt|;
name|result
operator|=
name|dns_message_renderreserve
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|opt_reserved
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|msg
operator|->
name|opt_reserved
operator|=
literal|0
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|msg
operator|->
name|opt
operator|=
name|opt
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
name|dns_message_puttemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|dns_rdataset_t
modifier|*
name|dns_message_gettsig
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|owner
parameter_list|)
block|{
comment|/* 	 * Get the TSIG record and owner for 'msg'. 	 */
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|owner
operator|==
name|NULL
operator|||
operator|*
name|owner
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|owner
operator|!=
name|NULL
condition|)
operator|*
name|owner
operator|=
name|msg
operator|->
name|tsigname
expr_stmt|;
return|return
operator|(
name|msg
operator|->
name|tsig
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_settsigkey
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_tsigkey_t
modifier|*
name|key
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * Set the TSIG key for 'msg' 	 */
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|state
operator|==
name|DNS_SECTION_ANY
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
operator|&&
name|msg
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|msg
operator|->
name|sig_reserved
operator|!=
literal|0
condition|)
block|{
name|dns_message_renderrelease
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|sig_reserved
argument_list|)
expr_stmt|;
name|msg
operator|->
name|sig_reserved
operator|=
literal|0
expr_stmt|;
block|}
name|dns_tsigkey_detach
argument_list|(
operator|&
name|msg
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
block|{
name|REQUIRE
argument_list|(
name|msg
operator|->
name|tsigkey
operator|==
name|NULL
operator|&&
name|msg
operator|->
name|sig0key
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|dns_tsigkey_attach
argument_list|(
name|key
argument_list|,
operator|&
name|msg
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|from_to_wire
operator|==
name|DNS_MESSAGE_INTENTRENDER
condition|)
block|{
name|msg
operator|->
name|sig_reserved
operator|=
name|spacefortsig
argument_list|(
name|msg
operator|->
name|tsigkey
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_renderreserve
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|sig_reserved
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_tsigkey_detach
argument_list|(
operator|&
name|msg
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
name|msg
operator|->
name|sig_reserved
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|dns_tsigkey_t
modifier|*
name|dns_message_gettsigkey
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
comment|/* 	 * Get the TSIG key for 'msg' 	 */
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|msg
operator|->
name|tsigkey
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_setquerytsig
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_buffer_t
modifier|*
name|querytsig
parameter_list|)
block|{
name|dns_rdata_t
modifier|*
name|rdata
init|=
name|NULL
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|list
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|set
init|=
name|NULL
decl_stmt|;
name|isc_buffer_t
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|querytsig
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|querytsig
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|result
operator|=
name|dns_message_gettemprdata
argument_list|(
name|msg
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_gettemprdatalist
argument_list|(
name|msg
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isc_buffer_usedregion
argument_list|(
name|querytsig
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
operator|&
name|buf
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|isc_buffer_putmem
argument_list|(
name|buf
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
name|buf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
name|rdata
argument_list|,
name|dns_rdataclass_any
argument_list|,
name|dns_rdatatype_tsig
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|dns_message_takebuffer
argument_list|(
name|msg
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|list
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|list
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatalist_tordataset
argument_list|(
name|list
argument_list|,
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|msg
operator|->
name|querytsig
operator|=
name|set
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|rdata
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdata
argument_list|(
name|msg
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdatalist
argument_list|(
name|msg
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|set
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_getquerytsig
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_buffer_t
modifier|*
modifier|*
name|querytsig
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|querytsig
operator|!=
name|NULL
operator|&&
operator|*
name|querytsig
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|tsig
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|msg
operator|->
name|tsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_rdataset_current
argument_list|(
name|msg
operator|->
name|tsig
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_toregion
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
name|querytsig
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|isc_buffer_putmem
argument_list|(
operator|*
name|querytsig
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|dns_rdataset_t
modifier|*
name|dns_message_getsig0
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|owner
parameter_list|)
block|{
comment|/* 	 * Get the SIG(0) record for 'msg'. 	 */
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|owner
operator|==
name|NULL
operator|||
operator|*
name|owner
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|sig0
operator|!=
name|NULL
operator|&&
name|owner
operator|!=
name|NULL
condition|)
block|{
comment|/* If dns_message_getsig0 is called on a rendered message 		 * after the SIG(0) has been applied, we need to return the 		 * root name, not NULL. 		 */
if|if
condition|(
name|msg
operator|->
name|sig0name
operator|==
name|NULL
condition|)
operator|*
name|owner
operator|=
name|dns_rootname
expr_stmt|;
else|else
operator|*
name|owner
operator|=
name|msg
operator|->
name|sig0name
expr_stmt|;
block|}
return|return
operator|(
name|msg
operator|->
name|sig0
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_setsig0key
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|unsigned
name|int
name|x
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * Set the SIG(0) key for 'msg' 	 */
comment|/* 	 * The space required for an SIG(0) record is: 	 * 	 *	1 byte for the name 	 *	2 bytes for the type 	 *	2 bytes for the class 	 *	4 bytes for the ttl 	 *	2 bytes for the type covered 	 *	1 byte for the algorithm 	 *	1 bytes for the labels 	 *	4 bytes for the original ttl 	 *	4 bytes for the signature expiration 	 *	4 bytes for the signature inception 	 *	2 bytes for the key tag 	 *	n bytes for the signer's name 	 *	x bytes for the signature 	 * --------------------------------- 	 *     27 + n + x bytes 	 */
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|from_to_wire
operator|==
name|DNS_MESSAGE_INTENTRENDER
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|state
operator|==
name|DNS_SECTION_ANY
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|!=
name|NULL
condition|)
block|{
name|REQUIRE
argument_list|(
name|msg
operator|->
name|sig0key
operator|==
name|NULL
operator|&&
name|msg
operator|->
name|tsigkey
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_toregion
argument_list|(
name|dst_key_name
argument_list|(
name|key
argument_list|)
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|result
operator|=
name|dst_key_sigsize
argument_list|(
name|key
argument_list|,
operator|&
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|msg
operator|->
name|sig_reserved
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|msg
operator|->
name|sig_reserved
operator|=
literal|27
operator|+
name|r
operator|.
name|length
operator|+
name|x
expr_stmt|;
name|result
operator|=
name|dns_message_renderreserve
argument_list|(
name|msg
argument_list|,
name|msg
operator|->
name|sig_reserved
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|msg
operator|->
name|sig_reserved
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|msg
operator|->
name|sig0key
operator|=
name|key
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|dst_key_t
modifier|*
name|dns_message_getsig0key
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
comment|/* 	 * Get the SIG(0) key for 'msg' 	 */
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|msg
operator|->
name|sig0key
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_takebuffer
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_buffer_t
modifier|*
modifier|*
name|buffer
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|buffer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|ISC_BUFFER_VALID
argument_list|(
operator|*
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|msg
operator|->
name|cleanup
argument_list|,
operator|*
name|buffer
argument_list|,
name|link
argument_list|)
expr_stmt|;
operator|*
name|buffer
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_signer
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
name|signer
parameter_list|)
block|{
name|isc_result_t
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|signer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|msg
operator|->
name|from_to_wire
operator|==
name|DNS_MESSAGE_INTENTPARSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|tsig
operator|==
name|NULL
operator|&&
name|msg
operator|->
name|sig0
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
if|if
condition|(
name|msg
operator|->
name|verify_attempted
operator|==
literal|0
condition|)
return|return
operator|(
name|DNS_R_NOTVERIFIEDYET
operator|)
return|;
if|if
condition|(
operator|!
name|dns_name_hasbuffer
argument_list|(
name|signer
argument_list|)
condition|)
block|{
name|isc_buffer_t
modifier|*
name|dynbuf
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|msg
operator|->
name|mctx
argument_list|,
operator|&
name|dynbuf
argument_list|,
literal|512
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_name_setbuffer
argument_list|(
name|signer
argument_list|,
name|dynbuf
argument_list|)
expr_stmt|;
name|dns_message_takebuffer
argument_list|(
name|msg
argument_list|,
operator|&
name|dynbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|sig0
operator|!=
name|NULL
condition|)
block|{
name|dns_rdata_sig_t
name|sig
decl_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|msg
operator|->
name|sig0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|msg
operator|->
name|sig0
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|msg
operator|->
name|verified_sig
operator|&&
name|msg
operator|->
name|sig0status
operator|==
name|dns_rcode_noerror
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
else|else
name|result
operator|=
name|DNS_R_SIGINVALID
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|sig
operator|.
name|signer
argument_list|,
name|signer
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|sig
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dns_name_t
modifier|*
name|identity
decl_stmt|;
name|dns_rdata_any_tsig_t
name|tsig
decl_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|msg
operator|->
name|tsig
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|msg
operator|->
name|tsig
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|tsig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|tsigstatus
operator|!=
name|dns_rcode_noerror
condition|)
name|result
operator|=
name|DNS_R_TSIGVERIFYFAILURE
expr_stmt|;
elseif|else
if|if
condition|(
name|tsig
operator|.
name|error
operator|!=
name|dns_rcode_noerror
condition|)
name|result
operator|=
name|DNS_R_TSIGERRORSET
expr_stmt|;
else|else
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|tsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|tsigkey
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * If msg->tsigstatus& tsig.error are both 			 * dns_rcode_noerror, the message must have been 			 * verified, which means msg->tsigkey will be 			 * non-NULL. 			 */
name|INSIST
argument_list|(
name|result
operator|!=
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|identity
operator|=
name|dns_tsigkey_identity
argument_list|(
name|msg
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|identity
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|DNS_R_NOIDENTITY
expr_stmt|;
name|identity
operator|=
operator|&
name|msg
operator|->
name|tsigkey
operator|->
name|name
expr_stmt|;
block|}
name|dns_name_clone
argument_list|(
name|identity
argument_list|,
name|signer
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_resetsig
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|verified_sig
operator|=
literal|0
expr_stmt|;
name|msg
operator|->
name|verify_attempted
operator|=
literal|0
expr_stmt|;
name|msg
operator|->
name|tsigstatus
operator|=
name|dns_rcode_noerror
expr_stmt|;
name|msg
operator|->
name|sig0status
operator|=
name|dns_rcode_noerror
expr_stmt|;
name|msg
operator|->
name|timeadjust
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
block|{
name|dns_tsigkey_detach
argument_list|(
operator|&
name|msg
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tsigkey
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_rechecksig
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|)
block|{
name|dns_message_resetsig
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|dns_message_checksig
argument_list|(
name|msg
argument_list|,
name|view
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_checksig
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_view_t
modifier|*
name|view
parameter_list|)
block|{
name|isc_buffer_t
name|b
decl_stmt|,
name|msgb
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|tsigkey
operator|==
name|NULL
operator|&&
name|msg
operator|->
name|tsig
operator|==
name|NULL
operator|&&
name|msg
operator|->
name|sig0
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|INSIST
argument_list|(
name|msg
operator|->
name|saved
operator|.
name|base
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|msgb
argument_list|,
name|msg
operator|->
name|saved
operator|.
name|base
argument_list|,
name|msg
operator|->
name|saved
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|msgb
argument_list|,
name|msg
operator|->
name|saved
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|tsigkey
operator|!=
name|NULL
operator|||
name|msg
operator|->
name|tsig
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
return|return
operator|(
name|dns_view_checksig
argument_list|(
name|view
argument_list|,
operator|&
name|msgb
argument_list|,
name|msg
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|dns_tsig_verify
argument_list|(
operator|&
name|msgb
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_sig_t
name|sig
decl_stmt|;
name|dns_rdataset_t
name|keyset
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|msg
operator|->
name|sig0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|msg
operator|->
name|sig0
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
comment|/* 		 * This can occur when the message is a dynamic update, since 		 * the rdata length checking is relaxed.  This should not 		 * happen in a well-formed message, since the SIG(0) is only 		 * looked for in the additional section, and the dynamic update 		 * meta-records are in the prerequisite and update sections. 		 */
if|if
condition|(
name|rdata
operator|.
name|length
operator|==
literal|0
condition|)
return|return
operator|(
name|ISC_R_UNEXPECTEDEND
operator|)
return|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|sig
argument_list|,
name|msg
operator|->
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_rdataset_init
argument_list|(
operator|&
name|keyset
argument_list|)
expr_stmt|;
if|if
condition|(
name|view
operator|==
name|NULL
condition|)
return|return
operator|(
name|DNS_R_KEYUNAUTHORIZED
operator|)
return|;
name|result
operator|=
name|dns_view_simplefind
argument_list|(
name|view
argument_list|,
operator|&
name|sig
operator|.
name|signer
argument_list|,
name|dns_rdatatype_key
comment|/* SIG(0) */
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|keyset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* XXXBEW Should possibly create a fetch here */
name|result
operator|=
name|DNS_R_KEYUNAUTHORIZED
expr_stmt|;
goto|goto
name|freesig
goto|;
block|}
elseif|else
if|if
condition|(
name|keyset
operator|.
name|trust
operator|<
name|dns_trust_secure
condition|)
block|{
comment|/* XXXBEW Should call a validator here */
name|result
operator|=
name|DNS_R_KEYUNAUTHORIZED
expr_stmt|;
goto|goto
name|freesig
goto|;
block|}
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|keyset
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|keyset
argument_list|)
control|)
block|{
name|dst_key_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|keyset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|rdata
operator|.
name|data
argument_list|,
name|rdata
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|rdata
operator|.
name|length
argument_list|)
expr_stmt|;
name|result
operator|=
name|dst_key_fromdns
argument_list|(
operator|&
name|sig
operator|.
name|signer
argument_list|,
name|rdata
operator|.
name|rdclass
argument_list|,
operator|&
name|b
argument_list|,
name|view
operator|->
name|mctx
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
continue|continue;
if|if
condition|(
name|dst_key_alg
argument_list|(
name|key
argument_list|)
operator|!=
name|sig
operator|.
name|algorithm
operator|||
name|dst_key_id
argument_list|(
name|key
argument_list|)
operator|!=
name|sig
operator|.
name|keyid
operator|||
operator|!
operator|(
name|dst_key_proto
argument_list|(
name|key
argument_list|)
operator|==
name|DNS_KEYPROTO_DNSSEC
operator|||
name|dst_key_proto
argument_list|(
name|key
argument_list|)
operator|==
name|DNS_KEYPROTO_ANY
operator|)
condition|)
block|{
name|dst_key_free
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|result
operator|=
name|dns_dnssec_verifymessage
argument_list|(
operator|&
name|msgb
argument_list|,
name|msg
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|result
operator|=
name|DNS_R_KEYUNAUTHORIZED
expr_stmt|;
name|freesig
label|:
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|keyset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|keyset
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|sig
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_sectiontotext
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_section_t
name|section
parameter_list|,
specifier|const
name|dns_master_style_t
modifier|*
name|style
parameter_list|,
name|dns_messagetextflag_t
name|flags
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|)
block|{
name|dns_name_t
modifier|*
name|name
decl_stmt|,
name|empty_name
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SECTION
argument_list|(
name|section
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISC_LIST_EMPTY
argument_list|(
name|msg
operator|->
name|sections
index|[
name|section
index|]
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOCOMMENTS
operator|)
operator|==
literal|0
condition|)
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|";; "
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|opcode
operator|!=
name|dns_opcode_update
condition|)
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|sectiontext
index|[
name|section
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|updsectiontext
index|[
name|section
index|]
argument_list|)
expr_stmt|;
block|}
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|" SECTION:\n"
argument_list|)
expr_stmt|;
block|}
name|dns_name_init
argument_list|(
operator|&
name|empty_name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|msg
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
operator|(
name|result
operator|)
return|;
block|}
do|do
block|{
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|msg
argument_list|,
name|section
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rdataset
operator|!=
name|NULL
condition|;
name|rdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|section
operator|==
name|DNS_SECTION_QUESTION
condition|)
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|";"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_questiontotext
argument_list|(
name|name
argument_list|,
name|rdataset
argument_list|,
name|style
argument_list|,
name|target
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|dns_master_rdatasettotext
argument_list|(
name|name
argument_list|,
name|rdataset
argument_list|,
name|style
argument_list|,
name|target
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
name|result
operator|=
name|dns_message_nextname
argument_list|(
name|msg
argument_list|,
name|section
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
do|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOHEADERS
operator|)
operator|==
literal|0
operator|&&
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOCOMMENTS
operator|)
operator|==
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_pseudosectiontotext
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_pseudosection_t
name|section
parameter_list|,
specifier|const
name|dns_master_style_t
modifier|*
name|style
parameter_list|,
name|dns_messagetextflag_t
name|flags
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|)
block|{
name|dns_rdataset_t
modifier|*
name|ps
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|buf
index|[
sizeof|sizeof
argument_list|(
literal|"1234567890"
argument_list|)
index|]
decl_stmt|;
name|isc_uint32_t
name|mbz
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_PSEUDOSECTION
argument_list|(
name|section
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|section
condition|)
block|{
case|case
name|DNS_PSEUDOSECTION_OPT
case|:
name|ps
operator|=
name|dns_message_getopt
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOCOMMENTS
operator|)
operator|==
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|";; OPT PSEUDOSECTION:\n"
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"; EDNS: version: "
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
operator|(
name|ps
operator|->
name|ttl
operator|&
literal|0x00ff0000
operator|)
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|", flags:"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ps
operator|->
name|ttl
operator|&
name|DNS_MESSAGEEXTFLAG_DO
operator|)
operator|!=
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|" do"
argument_list|)
expr_stmt|;
name|mbz
operator|=
name|ps
operator|->
name|ttl
operator|&
operator|~
name|DNS_MESSAGEEXTFLAG_DO
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
name|mbz
operator|!=
literal|0
condition|)
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"; MBZ: "
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%.4x "
argument_list|,
name|mbz
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|", udp: "
argument_list|)
expr_stmt|;
block|}
else|else
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"; udp: "
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ps
operator|->
name|rdclass
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
case|case
name|DNS_PSEUDOSECTION_TSIG
case|:
name|ps
operator|=
name|dns_message_gettsig
argument_list|(
name|msg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOCOMMENTS
operator|)
operator|==
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|";; TSIG PSEUDOSECTION:\n"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_rdatasettotext
argument_list|(
name|name
argument_list|,
name|ps
argument_list|,
name|style
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOHEADERS
operator|)
operator|==
literal|0
operator|&&
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOCOMMENTS
operator|)
operator|==
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
case|case
name|DNS_PSEUDOSECTION_SIG0
case|:
name|ps
operator|=
name|dns_message_getsig0
argument_list|(
name|msg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOCOMMENTS
operator|)
operator|==
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|";; SIG0 PSEUDOSECTION:\n"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_master_rdatasettotext
argument_list|(
name|name
argument_list|,
name|ps
argument_list|,
name|style
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOHEADERS
operator|)
operator|==
literal|0
operator|&&
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOCOMMENTS
operator|)
operator|==
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_UNEXPECTED
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_message_totext
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
specifier|const
name|dns_master_style_t
modifier|*
name|style
parameter_list|,
name|dns_messagetextflag_t
name|flags
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|)
block|{
name|char
name|buf
index|[
sizeof|sizeof
argument_list|(
literal|"1234567890"
argument_list|)
index|]
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGETEXTFLAG_NOHEADERS
operator|)
operator|==
literal|0
condition|)
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|";; ->>HEADER<<- opcode: "
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|opcodetext
index|[
name|msg
operator|->
name|opcode
index|]
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|", status: "
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|rcodetext
index|[
name|msg
operator|->
name|rcode
index|]
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|", id: "
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%6u"
argument_list|,
name|msg
operator|->
name|id
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"\n;; flags: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_QR
operator|)
operator|!=
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"qr "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_AA
operator|)
operator|!=
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"aa "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_TC
operator|)
operator|!=
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"tc "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_RD
operator|)
operator|!=
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"rd "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_RA
operator|)
operator|!=
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"ra "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_AD
operator|)
operator|!=
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"ad "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_CD
operator|)
operator|!=
literal|0
condition|)
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"cd "
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|opcode
operator|!=
name|dns_opcode_update
condition|)
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"; QUESTION: "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"; ZONE: "
argument_list|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%1u"
argument_list|,
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_QUESTION
index|]
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|opcode
operator|!=
name|dns_opcode_update
condition|)
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|", ANSWER: "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|", PREREQ: "
argument_list|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%1u"
argument_list|,
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ANSWER
index|]
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|opcode
operator|!=
name|dns_opcode_update
condition|)
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|", AUTHORITY: "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|", UPDATE: "
argument_list|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%1u"
argument_list|,
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_AUTHORITY
index|]
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|", ADDITIONAL: "
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%1u"
argument_list|,
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ADDITIONAL
index|]
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|target
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_message_pseudosectiontotext
argument_list|(
name|msg
argument_list|,
name|DNS_PSEUDOSECTION_OPT
argument_list|,
name|style
argument_list|,
name|flags
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_message_sectiontotext
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|,
name|style
argument_list|,
name|flags
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_message_sectiontotext
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
name|style
argument_list|,
name|flags
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_message_sectiontotext
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|,
name|style
argument_list|,
name|flags
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_message_sectiontotext
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ADDITIONAL
argument_list|,
name|style
argument_list|,
name|flags
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_message_pseudosectiontotext
argument_list|(
name|msg
argument_list|,
name|DNS_PSEUDOSECTION_TSIG
argument_list|,
name|style
argument_list|,
name|flags
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|dns_message_pseudosectiontotext
argument_list|(
name|msg
argument_list|,
name|DNS_PSEUDOSECTION_SIG0
argument_list|,
name|style
argument_list|,
name|flags
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_region_t
modifier|*
name|dns_message_getrawmessage
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|msg
operator|->
name|saved
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_message_setsortorder
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_rdatasetorderfunc_t
name|order
parameter_list|,
specifier|const
name|void
modifier|*
name|order_arg
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|order
operator|=
name|order
expr_stmt|;
name|msg
operator|->
name|order_arg
operator|=
name|order_arg
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_message_settimeadjust
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|int
name|timeadjust
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|timeadjust
operator|=
name|timeadjust
expr_stmt|;
block|}
end_function

begin_function
name|int
name|dns_message_gettimeadjust
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_MESSAGE_VALID
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|msg
operator|->
name|timeadjust
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_opcode_totext
parameter_list|(
name|dns_opcode_t
name|opcode
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|opcode
operator|<
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_buffer_availablelength
argument_list|(
name|target
argument_list|)
operator|<
name|strlen
argument_list|(
name|opcodetext
index|[
name|opcode
index|]
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|isc_buffer_putstr
argument_list|(
name|target
argument_list|,
name|opcodetext
index|[
name|opcode
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

end_unit


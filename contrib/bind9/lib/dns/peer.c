begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2000, 2001, 2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: peer.c,v 1.14.2.1.10.6 2006/03/02 00:37:20 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<isc/sockaddr.h>
end_include

begin_include
include|#
directive|include
file|<dns/bit.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/name.h>
end_include

begin_include
include|#
directive|include
file|<dns/peer.h>
end_include

begin_comment
comment|/*  * Bit positions in the dns_peer_t structure flags field  */
end_comment

begin_define
define|#
directive|define
name|BOGUS_BIT
value|0
end_define

begin_define
define|#
directive|define
name|SERVER_TRANSFER_FORMAT_BIT
value|1
end_define

begin_define
define|#
directive|define
name|TRANSFERS_BIT
value|2
end_define

begin_define
define|#
directive|define
name|PROVIDE_IXFR_BIT
value|3
end_define

begin_define
define|#
directive|define
name|REQUEST_IXFR_BIT
value|4
end_define

begin_define
define|#
directive|define
name|SUPPORT_EDNS_BIT
value|5
end_define

begin_function_decl
specifier|static
name|void
name|peerlist_delete
parameter_list|(
name|dns_peerlist_t
modifier|*
modifier|*
name|list
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|peer_delete
parameter_list|(
name|dns_peer_t
modifier|*
modifier|*
name|peer
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|isc_result_t
name|dns_peerlist_new
parameter_list|(
name|isc_mem_t
modifier|*
name|mem
parameter_list|,
name|dns_peerlist_t
modifier|*
modifier|*
name|list
parameter_list|)
block|{
name|dns_peerlist_t
modifier|*
name|l
decl_stmt|;
name|REQUIRE
argument_list|(
name|list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|l
operator|=
name|isc_mem_get
argument_list|(
name|mem
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|l
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|ISC_LIST_INIT
argument_list|(
name|l
operator|->
name|elements
argument_list|)
expr_stmt|;
name|l
operator|->
name|mem
operator|=
name|mem
expr_stmt|;
name|l
operator|->
name|refs
operator|=
literal|1
expr_stmt|;
name|l
operator|->
name|magic
operator|=
name|DNS_PEERLIST_MAGIC
expr_stmt|;
operator|*
name|list
operator|=
name|l
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_peerlist_attach
parameter_list|(
name|dns_peerlist_t
modifier|*
name|source
parameter_list|,
name|dns_peerlist_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEERLIST_VALID
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|source
operator|->
name|refs
operator|++
expr_stmt|;
name|ENSURE
argument_list|(
name|source
operator|->
name|refs
operator|!=
literal|0xffffffffU
argument_list|)
expr_stmt|;
operator|*
name|target
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_peerlist_detach
parameter_list|(
name|dns_peerlist_t
modifier|*
modifier|*
name|list
parameter_list|)
block|{
name|dns_peerlist_t
modifier|*
name|plist
decl_stmt|;
name|REQUIRE
argument_list|(
name|list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|*
name|list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEERLIST_VALID
argument_list|(
operator|*
name|list
argument_list|)
argument_list|)
expr_stmt|;
name|plist
operator|=
operator|*
name|list
expr_stmt|;
operator|*
name|list
operator|=
name|NULL
expr_stmt|;
name|REQUIRE
argument_list|(
name|plist
operator|->
name|refs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|plist
operator|->
name|refs
operator|--
expr_stmt|;
if|if
condition|(
name|plist
operator|->
name|refs
operator|==
literal|0
condition|)
name|peerlist_delete
argument_list|(
operator|&
name|plist
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|peerlist_delete
parameter_list|(
name|dns_peerlist_t
modifier|*
modifier|*
name|list
parameter_list|)
block|{
name|dns_peerlist_t
modifier|*
name|l
decl_stmt|;
name|dns_peer_t
modifier|*
name|server
decl_stmt|,
modifier|*
name|stmp
decl_stmt|;
name|REQUIRE
argument_list|(
name|list
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEERLIST_VALID
argument_list|(
operator|*
name|list
argument_list|)
argument_list|)
expr_stmt|;
name|l
operator|=
operator|*
name|list
expr_stmt|;
name|REQUIRE
argument_list|(
name|l
operator|->
name|refs
operator|==
literal|0
argument_list|)
expr_stmt|;
name|server
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|l
operator|->
name|elements
argument_list|)
expr_stmt|;
while|while
condition|(
name|server
operator|!=
name|NULL
condition|)
block|{
name|stmp
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|server
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|l
operator|->
name|elements
argument_list|,
name|server
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|dns_peer_detach
argument_list|(
operator|&
name|server
argument_list|)
expr_stmt|;
name|server
operator|=
name|stmp
expr_stmt|;
block|}
name|l
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|l
operator|->
name|mem
argument_list|,
name|l
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|l
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|list
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_peerlist_addpeer
parameter_list|(
name|dns_peerlist_t
modifier|*
name|peers
parameter_list|,
name|dns_peer_t
modifier|*
name|peer
parameter_list|)
block|{
name|dns_peer_t
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|dns_peer_attach
argument_list|(
name|peer
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|peers
operator|->
name|elements
argument_list|,
name|peer
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peerlist_peerbyaddr
parameter_list|(
name|dns_peerlist_t
modifier|*
name|servers
parameter_list|,
name|isc_netaddr_t
modifier|*
name|addr
parameter_list|,
name|dns_peer_t
modifier|*
modifier|*
name|retval
parameter_list|)
block|{
name|dns_peer_t
modifier|*
name|server
decl_stmt|;
name|isc_result_t
name|res
decl_stmt|;
name|REQUIRE
argument_list|(
name|retval
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEERLIST_VALID
argument_list|(
name|servers
argument_list|)
argument_list|)
expr_stmt|;
name|server
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|servers
operator|->
name|elements
argument_list|)
expr_stmt|;
while|while
condition|(
name|server
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|isc_netaddr_equal
argument_list|(
name|addr
argument_list|,
operator|&
name|server
operator|->
name|address
argument_list|)
condition|)
break|break;
name|server
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|server
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|server
operator|!=
name|NULL
condition|)
block|{
operator|*
name|retval
operator|=
name|server
expr_stmt|;
name|res
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
block|}
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peerlist_currpeer
parameter_list|(
name|dns_peerlist_t
modifier|*
name|peers
parameter_list|,
name|dns_peer_t
modifier|*
modifier|*
name|retval
parameter_list|)
block|{
name|dns_peer_t
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|p
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|peers
operator|->
name|elements
argument_list|)
expr_stmt|;
name|dns_peer_attach
argument_list|(
name|p
argument_list|,
name|retval
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_new
parameter_list|(
name|isc_mem_t
modifier|*
name|mem
parameter_list|,
name|isc_netaddr_t
modifier|*
name|addr
parameter_list|,
name|dns_peer_t
modifier|*
modifier|*
name|peerptr
parameter_list|)
block|{
name|dns_peer_t
modifier|*
name|peer
decl_stmt|;
name|REQUIRE
argument_list|(
name|peerptr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|peer
operator|=
name|isc_mem_get
argument_list|(
name|mem
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|peer
operator|->
name|magic
operator|=
name|DNS_PEER_MAGIC
expr_stmt|;
name|peer
operator|->
name|address
operator|=
operator|*
name|addr
expr_stmt|;
name|peer
operator|->
name|mem
operator|=
name|mem
expr_stmt|;
name|peer
operator|->
name|bogus
operator|=
name|ISC_FALSE
expr_stmt|;
name|peer
operator|->
name|transfer_format
operator|=
name|dns_one_answer
expr_stmt|;
name|peer
operator|->
name|transfers
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|request_ixfr
operator|=
name|ISC_FALSE
expr_stmt|;
name|peer
operator|->
name|provide_ixfr
operator|=
name|ISC_FALSE
expr_stmt|;
name|peer
operator|->
name|key
operator|=
name|NULL
expr_stmt|;
name|peer
operator|->
name|refs
operator|=
literal|1
expr_stmt|;
name|peer
operator|->
name|transfer_source
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|peer
operator|->
name|bitflags
argument_list|,
literal|0x0
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|bitflags
argument_list|)
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|peer
argument_list|,
name|next
argument_list|)
expr_stmt|;
operator|*
name|peerptr
operator|=
name|peer
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_peer_attach
parameter_list|(
name|dns_peer_t
modifier|*
name|source
parameter_list|,
name|dns_peer_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|source
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|source
operator|->
name|refs
operator|++
expr_stmt|;
name|ENSURE
argument_list|(
name|source
operator|->
name|refs
operator|!=
literal|0xffffffffU
argument_list|)
expr_stmt|;
operator|*
name|target
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_peer_detach
parameter_list|(
name|dns_peer_t
modifier|*
modifier|*
name|peer
parameter_list|)
block|{
name|dns_peer_t
modifier|*
name|p
decl_stmt|;
name|REQUIRE
argument_list|(
name|peer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|*
name|peer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
operator|*
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|*
name|peer
expr_stmt|;
name|REQUIRE
argument_list|(
name|p
operator|->
name|refs
operator|>
literal|0
argument_list|)
expr_stmt|;
operator|*
name|peer
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|refs
operator|--
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|refs
operator|==
literal|0
condition|)
name|peer_delete
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|peer_delete
parameter_list|(
name|dns_peer_t
modifier|*
modifier|*
name|peer
parameter_list|)
block|{
name|dns_peer_t
modifier|*
name|p
decl_stmt|;
name|isc_mem_t
modifier|*
name|mem
decl_stmt|;
name|REQUIRE
argument_list|(
name|peer
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
operator|*
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|*
name|peer
expr_stmt|;
name|REQUIRE
argument_list|(
name|p
operator|->
name|refs
operator|==
literal|0
argument_list|)
expr_stmt|;
name|mem
operator|=
name|p
operator|->
name|mem
expr_stmt|;
name|p
operator|->
name|mem
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|key
operator|!=
name|NULL
condition|)
block|{
name|dns_name_free
argument_list|(
name|p
operator|->
name|key
argument_list|,
name|mem
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mem
argument_list|,
name|p
operator|->
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|transfer_source
operator|!=
name|NULL
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mem
argument_list|,
name|p
operator|->
name|transfer_source
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|->
name|transfer_source
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|isc_mem_put
argument_list|(
name|mem
argument_list|,
name|p
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|peer
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_setbogus
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_boolean_t
name|newval
parameter_list|)
block|{
name|isc_boolean_t
name|existed
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|existed
operator|=
name|DNS_BIT_CHECK
argument_list|(
name|BOGUS_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
name|peer
operator|->
name|bogus
operator|=
name|newval
expr_stmt|;
name|DNS_BIT_SET
argument_list|(
name|BOGUS_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
return|return
operator|(
name|existed
condition|?
name|ISC_R_EXISTS
else|:
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_getbogus
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_boolean_t
modifier|*
name|retval
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|retval
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_BIT_CHECK
argument_list|(
name|BOGUS_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
condition|)
block|{
operator|*
name|retval
operator|=
name|peer
operator|->
name|bogus
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_setprovideixfr
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_boolean_t
name|newval
parameter_list|)
block|{
name|isc_boolean_t
name|existed
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|existed
operator|=
name|DNS_BIT_CHECK
argument_list|(
name|PROVIDE_IXFR_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
name|peer
operator|->
name|provide_ixfr
operator|=
name|newval
expr_stmt|;
name|DNS_BIT_SET
argument_list|(
name|PROVIDE_IXFR_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
return|return
operator|(
name|existed
condition|?
name|ISC_R_EXISTS
else|:
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_getprovideixfr
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_boolean_t
modifier|*
name|retval
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|retval
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_BIT_CHECK
argument_list|(
name|PROVIDE_IXFR_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
condition|)
block|{
operator|*
name|retval
operator|=
name|peer
operator|->
name|provide_ixfr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_setrequestixfr
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_boolean_t
name|newval
parameter_list|)
block|{
name|isc_boolean_t
name|existed
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|existed
operator|=
name|DNS_BIT_CHECK
argument_list|(
name|REQUEST_IXFR_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
name|peer
operator|->
name|request_ixfr
operator|=
name|newval
expr_stmt|;
name|DNS_BIT_SET
argument_list|(
name|REQUEST_IXFR_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
return|return
operator|(
name|existed
condition|?
name|ISC_R_EXISTS
else|:
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_getrequestixfr
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_boolean_t
modifier|*
name|retval
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|retval
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_BIT_CHECK
argument_list|(
name|REQUEST_IXFR_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
condition|)
block|{
operator|*
name|retval
operator|=
name|peer
operator|->
name|request_ixfr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_setsupportedns
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_boolean_t
name|newval
parameter_list|)
block|{
name|isc_boolean_t
name|existed
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|existed
operator|=
name|DNS_BIT_CHECK
argument_list|(
name|SUPPORT_EDNS_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
name|peer
operator|->
name|support_edns
operator|=
name|newval
expr_stmt|;
name|DNS_BIT_SET
argument_list|(
name|SUPPORT_EDNS_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
return|return
operator|(
name|existed
condition|?
name|ISC_R_EXISTS
else|:
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_getsupportedns
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_boolean_t
modifier|*
name|retval
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|retval
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_BIT_CHECK
argument_list|(
name|SUPPORT_EDNS_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
condition|)
block|{
operator|*
name|retval
operator|=
name|peer
operator|->
name|support_edns
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_settransfers
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_uint32_t
name|newval
parameter_list|)
block|{
name|isc_boolean_t
name|existed
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|existed
operator|=
name|DNS_BIT_CHECK
argument_list|(
name|TRANSFERS_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
name|peer
operator|->
name|transfers
operator|=
name|newval
expr_stmt|;
name|DNS_BIT_SET
argument_list|(
name|TRANSFERS_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
return|return
operator|(
name|existed
condition|?
name|ISC_R_EXISTS
else|:
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_gettransfers
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_uint32_t
modifier|*
name|retval
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|retval
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_BIT_CHECK
argument_list|(
name|TRANSFERS_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
condition|)
block|{
operator|*
name|retval
operator|=
name|peer
operator|->
name|transfers
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_settransferformat
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|dns_transfer_format_t
name|newval
parameter_list|)
block|{
name|isc_boolean_t
name|existed
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|existed
operator|=
name|DNS_BIT_CHECK
argument_list|(
name|SERVER_TRANSFER_FORMAT_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
name|peer
operator|->
name|transfer_format
operator|=
name|newval
expr_stmt|;
name|DNS_BIT_SET
argument_list|(
name|SERVER_TRANSFER_FORMAT_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
expr_stmt|;
return|return
operator|(
name|existed
condition|?
name|ISC_R_EXISTS
else|:
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_gettransferformat
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|dns_transfer_format_t
modifier|*
name|retval
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|retval
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|DNS_BIT_CHECK
argument_list|(
name|SERVER_TRANSFER_FORMAT_BIT
argument_list|,
operator|&
name|peer
operator|->
name|bitflags
argument_list|)
condition|)
block|{
operator|*
name|retval
operator|=
name|peer
operator|->
name|transfer_format
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_getkey
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|retval
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|retval
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|key
operator|!=
name|NULL
condition|)
block|{
operator|*
name|retval
operator|=
name|peer
operator|->
name|key
expr_stmt|;
block|}
return|return
operator|(
name|peer
operator|->
name|key
operator|==
name|NULL
condition|?
name|ISC_R_NOTFOUND
else|:
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_setkey
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|keyval
parameter_list|)
block|{
name|isc_boolean_t
name|exists
init|=
name|ISC_FALSE
decl_stmt|;
if|if
condition|(
name|peer
operator|->
name|key
operator|!=
name|NULL
condition|)
block|{
name|dns_name_free
argument_list|(
name|peer
operator|->
name|key
argument_list|,
name|peer
operator|->
name|mem
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|peer
operator|->
name|mem
argument_list|,
name|peer
operator|->
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
name|exists
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|peer
operator|->
name|key
operator|=
operator|*
name|keyval
expr_stmt|;
operator|*
name|keyval
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|exists
condition|?
name|ISC_R_EXISTS
else|:
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_setkeybycharp
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
specifier|const
name|char
modifier|*
name|keyval
parameter_list|)
block|{
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|keyval
argument_list|,
name|strlen
argument_list|(
name|keyval
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|keyval
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
operator|&
name|b
argument_list|,
name|dns_rootname
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|name
operator|=
name|isc_mem_get
argument_list|(
name|peer
operator|->
name|mem
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|dns_name_init
argument_list|(
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_dup
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
argument_list|,
name|peer
operator|->
name|mem
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|peer
operator|->
name|mem
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|result
operator|=
name|dns_peer_setkey
argument_list|(
name|peer
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_mem_put
argument_list|(
name|peer
operator|->
name|mem
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_settransfersource
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|transfer_source
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|transfer_source
operator|!=
name|NULL
condition|)
block|{
name|isc_mem_put
argument_list|(
name|peer
operator|->
name|mem
argument_list|,
name|peer
operator|->
name|transfer_source
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|peer
operator|->
name|transfer_source
argument_list|)
argument_list|)
expr_stmt|;
name|peer
operator|->
name|transfer_source
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|transfer_source
operator|!=
name|NULL
condition|)
block|{
name|peer
operator|->
name|transfer_source
operator|=
name|isc_mem_get
argument_list|(
name|peer
operator|->
name|mem
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|peer
operator|->
name|transfer_source
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|transfer_source
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
operator|*
name|peer
operator|->
name|transfer_source
operator|=
operator|*
name|transfer_source
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_peer_gettransfersource
parameter_list|(
name|dns_peer_t
modifier|*
name|peer
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|transfer_source
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_PEER_VALID
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|transfer_source
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|transfer_source
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
operator|*
name|transfer_source
operator|=
operator|*
name|peer
operator|->
name|transfer_source
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2009-2013  Internet Systems Consortium, Inc. ("ISC")  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: client.c,v 1.14 2011/03/12 04:59:47 tbox Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<isc/app.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/mutex.h>
end_include

begin_include
include|#
directive|include
file|<isc/sockaddr.h>
end_include

begin_include
include|#
directive|include
file|<isc/socket.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/timer.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/adb.h>
end_include

begin_include
include|#
directive|include
file|<dns/client.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/dispatch.h>
end_include

begin_include
include|#
directive|include
file|<dns/events.h>
end_include

begin_include
include|#
directive|include
file|<dns/forward.h>
end_include

begin_include
include|#
directive|include
file|<dns/keytable.h>
end_include

begin_include
include|#
directive|include
file|<dns/message.h>
end_include

begin_include
include|#
directive|include
file|<dns/name.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatasetiter.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/request.h>
end_include

begin_include
include|#
directive|include
file|<dns/resolver.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsec.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsig.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_include
include|#
directive|include
file|<dst/dst.h>
end_include

begin_define
define|#
directive|define
name|DNS_CLIENT_MAGIC
value|ISC_MAGIC('D', 'N', 'S', 'c')
end_define

begin_define
define|#
directive|define
name|DNS_CLIENT_VALID
parameter_list|(
name|c
parameter_list|)
value|ISC_MAGIC_VALID(c, DNS_CLIENT_MAGIC)
end_define

begin_define
define|#
directive|define
name|RCTX_MAGIC
value|ISC_MAGIC('R', 'c', 't', 'x')
end_define

begin_define
define|#
directive|define
name|RCTX_VALID
parameter_list|(
name|c
parameter_list|)
value|ISC_MAGIC_VALID(c, RCTX_MAGIC)
end_define

begin_define
define|#
directive|define
name|REQCTX_MAGIC
value|ISC_MAGIC('R', 'q', 'c', 'x')
end_define

begin_define
define|#
directive|define
name|REQCTX_VALID
parameter_list|(
name|c
parameter_list|)
value|ISC_MAGIC_VALID(c, REQCTX_MAGIC)
end_define

begin_define
define|#
directive|define
name|UCTX_MAGIC
value|ISC_MAGIC('U', 'c', 't', 'x')
end_define

begin_define
define|#
directive|define
name|UCTX_VALID
parameter_list|(
name|c
parameter_list|)
value|ISC_MAGIC_VALID(c, UCTX_MAGIC)
end_define

begin_define
define|#
directive|define
name|MAX_RESTARTS
value|16
end_define

begin_comment
comment|/*%  * DNS client object  */
end_comment

begin_struct
struct|struct
name|dns_client
block|{
comment|/* Unlocked */
name|unsigned
name|int
name|magic
decl_stmt|;
name|unsigned
name|int
name|attributes
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_appctx_t
modifier|*
name|actx
decl_stmt|;
name|isc_taskmgr_t
modifier|*
name|taskmgr
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|isc_socketmgr_t
modifier|*
name|socketmgr
decl_stmt|;
name|isc_timermgr_t
modifier|*
name|timermgr
decl_stmt|;
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|dispatchv4
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|dispatchv6
decl_stmt|;
name|unsigned
name|int
name|update_timeout
decl_stmt|;
name|unsigned
name|int
name|update_udptimeout
decl_stmt|;
name|unsigned
name|int
name|update_udpretries
decl_stmt|;
name|unsigned
name|int
name|find_timeout
decl_stmt|;
name|unsigned
name|int
name|find_udpretries
decl_stmt|;
comment|/* Locked */
name|unsigned
name|int
name|references
decl_stmt|;
name|dns_viewlist_t
name|viewlist
decl_stmt|;
name|ISC_LIST
argument_list|(
argument|struct resctx
argument_list|)
name|resctxs
expr_stmt|;
name|ISC_LIST
argument_list|(
argument|struct reqctx
argument_list|)
name|reqctxs
expr_stmt|;
name|ISC_LIST
argument_list|(
argument|struct updatectx
argument_list|)
name|updatectxs
expr_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*%  * Timeout/retry constants for dynamic update borrowed from nsupdate  */
end_comment

begin_define
define|#
directive|define
name|DEF_UPDATE_TIMEOUT
value|300
end_define

begin_define
define|#
directive|define
name|MIN_UPDATE_TIMEOUT
value|30
end_define

begin_define
define|#
directive|define
name|DEF_UPDATE_UDPTIMEOUT
value|3
end_define

begin_define
define|#
directive|define
name|DEF_UPDATE_UDPRETRIES
value|3
end_define

begin_define
define|#
directive|define
name|DEF_FIND_TIMEOUT
value|5
end_define

begin_define
define|#
directive|define
name|DEF_FIND_UDPRETRIES
value|3
end_define

begin_define
define|#
directive|define
name|DNS_CLIENTATTR_OWNCTX
value|0x01
end_define

begin_define
define|#
directive|define
name|DNS_CLIENTVIEW_NAME
value|"dnsclient"
end_define

begin_comment
comment|/*%  * Internal state for a single name resolution procedure  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|resctx
block|{
comment|/* Unlocked */
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_boolean_t
name|want_dnssec
decl_stmt|;
comment|/* Locked */
name|ISC_LINK
argument_list|(
argument|struct resctx
argument_list|)
name|link
expr_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|unsigned
name|int
name|restarts
decl_stmt|;
name|dns_fixedname_t
name|name
decl_stmt|;
name|dns_rdatatype_t
name|type
decl_stmt|;
name|dns_fetch_t
modifier|*
name|fetch
decl_stmt|;
name|dns_namelist_t
name|namelist
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_clientresevent_t
modifier|*
name|event
decl_stmt|;
name|isc_boolean_t
name|canceled
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|sigrdataset
decl_stmt|;
block|}
name|resctx_t
typedef|;
end_typedef

begin_comment
comment|/*%  * Argument of an internal event for synchronous name resolution.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|resarg
block|{
comment|/* Unlocked */
name|isc_appctx_t
modifier|*
name|actx
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
comment|/* Locked */
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|vresult
decl_stmt|;
name|dns_namelist_t
modifier|*
name|namelist
decl_stmt|;
name|dns_clientrestrans_t
modifier|*
name|trans
decl_stmt|;
name|isc_boolean_t
name|canceled
decl_stmt|;
block|}
name|resarg_t
typedef|;
end_typedef

begin_comment
comment|/*%  * Internal state for a single DNS request  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|reqctx
block|{
comment|/* Unlocked */
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|unsigned
name|int
name|parseoptions
decl_stmt|;
comment|/* Locked */
name|ISC_LINK
argument_list|(
argument|struct reqctx
argument_list|)
name|link
expr_stmt|;
name|isc_boolean_t
name|canceled
decl_stmt|;
name|dns_tsigkey_t
modifier|*
name|tsigkey
decl_stmt|;
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|dns_clientreqevent_t
modifier|*
name|event
decl_stmt|;
block|}
name|reqctx_t
typedef|;
end_typedef

begin_comment
comment|/*%  * Argument of an internal event for synchronous DNS request.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|reqarg
block|{
comment|/* Unlocked */
name|isc_appctx_t
modifier|*
name|actx
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
comment|/* Locked */
name|isc_result_t
name|result
decl_stmt|;
name|dns_clientreqtrans_t
modifier|*
name|trans
decl_stmt|;
name|isc_boolean_t
name|canceled
decl_stmt|;
block|}
name|reqarg_t
typedef|;
end_typedef

begin_comment
comment|/*%  * Argument of an internal event for synchronous name resolution.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|updatearg
block|{
comment|/* Unlocked */
name|isc_appctx_t
modifier|*
name|actx
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
comment|/* Locked */
name|isc_result_t
name|result
decl_stmt|;
name|dns_clientupdatetrans_t
modifier|*
name|trans
decl_stmt|;
name|isc_boolean_t
name|canceled
decl_stmt|;
block|}
name|updatearg_t
typedef|;
end_typedef

begin_comment
comment|/*%  * Internal state for a single dynamic update procedure  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|updatectx
block|{
comment|/* Unlocked */
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
comment|/* Locked */
name|dns_request_t
modifier|*
name|updatereq
decl_stmt|;
name|dns_request_t
modifier|*
name|soareq
decl_stmt|;
name|dns_clientrestrans_t
modifier|*
name|restrans
decl_stmt|;
name|dns_clientrestrans_t
modifier|*
name|restrans2
decl_stmt|;
name|isc_boolean_t
name|canceled
decl_stmt|;
comment|/* Task Locked */
name|ISC_LINK
argument_list|(
argument|struct updatectx
argument_list|)
name|link
expr_stmt|;
name|dns_clientupdatestate_t
name|state
decl_stmt|;
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
name|dns_message_t
modifier|*
name|updatemsg
decl_stmt|;
name|dns_message_t
modifier|*
name|soaquery
decl_stmt|;
name|dns_clientupdateevent_t
modifier|*
name|event
decl_stmt|;
name|dns_tsigkey_t
modifier|*
name|tsigkey
decl_stmt|;
name|dst_key_t
modifier|*
name|sig0key
decl_stmt|;
name|dns_name_t
modifier|*
name|firstname
decl_stmt|;
name|dns_name_t
name|soaqname
decl_stmt|;
name|dns_fixedname_t
name|zonefname
decl_stmt|;
name|dns_name_t
modifier|*
name|zonename
decl_stmt|;
name|isc_sockaddrlist_t
name|servers
decl_stmt|;
name|unsigned
name|int
name|nservers
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|currentserver
decl_stmt|;
name|struct
name|updatectx
modifier|*
name|bp4
decl_stmt|;
name|struct
name|updatectx
modifier|*
name|bp6
decl_stmt|;
block|}
name|updatectx_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|isc_result_t
name|request_soa
parameter_list|(
name|updatectx_t
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|client_resfind
parameter_list|(
name|resctx_t
modifier|*
name|rctx
parameter_list|,
name|dns_fetchevent_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|send_update
parameter_list|(
name|updatectx_t
modifier|*
name|uctx
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|isc_result_t
name|getudpdispatch
parameter_list|(
name|int
name|family
parameter_list|,
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|isc_boolean_t
name|is_shared
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|localaddr
parameter_list|)
block|{
name|unsigned
name|int
name|attrs
decl_stmt|,
name|attrmask
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|unsigned
name|buffersize
decl_stmt|,
name|maxbuffers
decl_stmt|,
name|maxrequests
decl_stmt|,
name|buckets
decl_stmt|,
name|increment
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_sockaddr_t
name|anyaddr
decl_stmt|;
name|attrs
operator|=
literal|0
expr_stmt|;
name|attrs
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|attrs
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|attrmask
operator|=
literal|0
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_TCP
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV4
expr_stmt|;
name|attrmask
operator||=
name|DNS_DISPATCHATTR_IPV6
expr_stmt|;
if|if
condition|(
name|localaddr
operator|==
name|NULL
condition|)
block|{
name|localaddr
operator|=
operator|&
name|anyaddr
expr_stmt|;
name|isc_sockaddr_anyofpf
argument_list|(
name|localaddr
argument_list|,
name|family
argument_list|)
expr_stmt|;
block|}
name|buffersize
operator|=
literal|4096
expr_stmt|;
name|maxbuffers
operator|=
name|is_shared
condition|?
literal|1000
else|:
literal|8
expr_stmt|;
name|maxrequests
operator|=
literal|32768
expr_stmt|;
name|buckets
operator|=
name|is_shared
condition|?
literal|16411
else|:
literal|3
expr_stmt|;
name|increment
operator|=
name|is_shared
condition|?
literal|16433
else|:
literal|5
expr_stmt|;
name|disp
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_dispatch_getudp
argument_list|(
name|dispatchmgr
argument_list|,
name|socketmgr
argument_list|,
name|taskmgr
argument_list|,
name|localaddr
argument_list|,
name|buffersize
argument_list|,
name|maxbuffers
argument_list|,
name|maxrequests
argument_list|,
name|buckets
argument_list|,
name|increment
argument_list|,
name|attrs
argument_list|,
name|attrmask
argument_list|,
operator|&
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
operator|*
name|dispp
operator|=
name|disp
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dns_client_createview
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|unsigned
name|int
name|ntasks
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
parameter_list|,
name|dns_dispatch_t
modifier|*
name|dispatchv4
parameter_list|,
name|dns_dispatch_t
modifier|*
name|dispatchv6
parameter_list|,
name|dns_view_t
modifier|*
modifier|*
name|viewp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|dbtype
decl_stmt|;
name|result
operator|=
name|dns_view_create
argument_list|(
name|mctx
argument_list|,
name|rdclass
argument_list|,
name|DNS_CLIENTVIEW_NAME
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* Initialize view security roots */
name|result
operator|=
name|dns_view_initsecroots
argument_list|(
name|view
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|result
operator|=
name|dns_view_createresolver
argument_list|(
name|view
argument_list|,
name|taskmgr
argument_list|,
name|ntasks
argument_list|,
literal|1
argument_list|,
name|socketmgr
argument_list|,
name|timermgr
argument_list|,
literal|0
argument_list|,
name|dispatchmgr
argument_list|,
name|dispatchv4
argument_list|,
name|dispatchv6
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * Set cache DB. 	 * XXX: it may be better if specific DB implementations can be 	 * specified via some configuration knob. 	 */
if|if
condition|(
operator|(
name|options
operator|&
name|DNS_CLIENTCREATEOPT_USECACHE
operator|)
operator|!=
literal|0
condition|)
name|dbtype
operator|=
literal|"rbt"
expr_stmt|;
else|else
name|dbtype
operator|=
literal|"ecdb"
expr_stmt|;
name|result
operator|=
name|dns_db_create
argument_list|(
name|mctx
argument_list|,
name|dbtype
argument_list|,
name|dns_rootname
argument_list|,
name|dns_dbtype_cache
argument_list|,
name|rdclass
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|view
operator|->
name|cachedb
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
operator|*
name|viewp
operator|=
name|view
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_create
parameter_list|(
name|dns_client_t
modifier|*
modifier|*
name|clientp
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|NULL
decl_stmt|;
name|isc_appctx_t
modifier|*
name|actx
init|=
name|NULL
decl_stmt|;
name|isc_taskmgr_t
modifier|*
name|taskmgr
init|=
name|NULL
decl_stmt|;
name|isc_socketmgr_t
modifier|*
name|socketmgr
init|=
name|NULL
decl_stmt|;
name|isc_timermgr_t
modifier|*
name|timermgr
init|=
name|NULL
decl_stmt|;
if|#
directive|if
literal|0
comment|/* XXXMPA add debug logging support */
block|isc_log_t *lctx = NULL; 	isc_logconfig_t *logconfig = NULL; 	unsigned int logdebuglevel = 0;
endif|#
directive|endif
name|result
operator|=
name|isc_mem_create
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|isc_appctx_create
argument_list|(
name|mctx
argument_list|,
operator|&
name|actx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|isc_app_ctxstart
argument_list|(
name|actx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|isc_taskmgr_createinctx
argument_list|(
name|mctx
argument_list|,
name|actx
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
operator|&
name|taskmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|isc_socketmgr_createinctx
argument_list|(
name|mctx
argument_list|,
name|actx
argument_list|,
operator|&
name|socketmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|isc_timermgr_createinctx
argument_list|(
name|mctx
argument_list|,
name|actx
argument_list|,
operator|&
name|timermgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
if|#
directive|if
literal|0
block|result = isc_log_create(mctx,&lctx,&logconfig); 	if (result != ISC_R_SUCCESS) 		goto cleanup; 	isc_log_setcontext(lctx); 	dns_log_init(lctx); 	dns_log_setcontext(lctx); 	result = isc_log_usechannel(logconfig, "default_debug", NULL, NULL); 	if (result != ISC_R_SUCCESS) 		goto cleanup; 	isc_log_setdebuglevel(lctx, logdebuglevel);
endif|#
directive|endif
name|result
operator|=
name|dns_client_createx
argument_list|(
name|mctx
argument_list|,
name|actx
argument_list|,
name|taskmgr
argument_list|,
name|socketmgr
argument_list|,
name|timermgr
argument_list|,
name|options
argument_list|,
name|clientp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
operator|(
operator|*
name|clientp
operator|)
operator|->
name|attributes
operator||=
name|DNS_CLIENTATTR_OWNCTX
expr_stmt|;
comment|/* client has its own reference to mctx, so we can detach it here */
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|taskmgr
operator|!=
name|NULL
condition|)
name|isc_taskmgr_destroy
argument_list|(
operator|&
name|taskmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|timermgr
operator|!=
name|NULL
condition|)
name|isc_timermgr_destroy
argument_list|(
operator|&
name|timermgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|socketmgr
operator|!=
name|NULL
condition|)
name|isc_socketmgr_destroy
argument_list|(
operator|&
name|socketmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|actx
operator|!=
name|NULL
condition|)
name|isc_appctx_destroy
argument_list|(
operator|&
name|actx
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_createx
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_appctx_t
modifier|*
name|actx
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_client_t
modifier|*
modifier|*
name|clientp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|result
operator|=
name|dns_client_createx2
argument_list|(
name|mctx
argument_list|,
name|actx
argument_list|,
name|taskmgr
argument_list|,
name|socketmgr
argument_list|,
name|timermgr
argument_list|,
name|options
argument_list|,
name|clientp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_createx2
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_appctx_t
modifier|*
name|actx
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_client_t
modifier|*
modifier|*
name|clientp
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|localaddr4
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|localaddr6
parameter_list|)
block|{
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_dispatchmgr_t
modifier|*
name|dispatchmgr
init|=
name|NULL
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|dispatchv4
init|=
name|NULL
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|dispatchv6
init|=
name|NULL
decl_stmt|;
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|taskmgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|timermgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|socketmgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|clientp
operator|!=
name|NULL
operator|&&
operator|*
name|clientp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|client
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|client
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|client
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|client
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|client
operator|->
name|actx
operator|=
name|actx
expr_stmt|;
name|client
operator|->
name|taskmgr
operator|=
name|taskmgr
expr_stmt|;
name|client
operator|->
name|socketmgr
operator|=
name|socketmgr
expr_stmt|;
name|client
operator|->
name|timermgr
operator|=
name|timermgr
expr_stmt|;
name|client
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|client
operator|->
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|client
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_dispatchmgr_create
argument_list|(
name|mctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|dispatchmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|client
operator|->
name|dispatchmgr
operator|=
name|dispatchmgr
expr_stmt|;
comment|/* 	 * If only one address family is specified, use it. 	 * If neither family is specified, or if both are, use both. 	 */
name|client
operator|->
name|dispatchv4
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|localaddr4
operator|!=
name|NULL
operator|||
name|localaddr6
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|getudpdispatch
argument_list|(
name|AF_INET
argument_list|,
name|dispatchmgr
argument_list|,
name|socketmgr
argument_list|,
name|taskmgr
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|dispatchv4
argument_list|,
name|localaddr4
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|client
operator|->
name|dispatchv4
operator|=
name|dispatchv4
expr_stmt|;
block|}
name|client
operator|->
name|dispatchv6
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|localaddr6
operator|!=
name|NULL
operator|||
name|localaddr4
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|getudpdispatch
argument_list|(
name|AF_INET6
argument_list|,
name|dispatchmgr
argument_list|,
name|socketmgr
argument_list|,
name|taskmgr
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|dispatchv6
argument_list|,
name|localaddr6
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|client
operator|->
name|dispatchv6
operator|=
name|dispatchv6
expr_stmt|;
block|}
comment|/* We need at least one of the dispatchers */
if|if
condition|(
name|dispatchv4
operator|==
name|NULL
operator|&&
name|dispatchv6
operator|==
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|result
operator|!=
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Create the default view for class IN */
name|result
operator|=
name|dns_client_createview
argument_list|(
name|mctx
argument_list|,
name|dns_rdataclass_in
argument_list|,
name|options
argument_list|,
name|taskmgr
argument_list|,
literal|31
argument_list|,
name|socketmgr
argument_list|,
name|timermgr
argument_list|,
name|dispatchmgr
argument_list|,
name|dispatchv4
argument_list|,
name|dispatchv6
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|ISC_LIST_INIT
argument_list|(
name|client
operator|->
name|viewlist
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|client
operator|->
name|viewlist
argument_list|,
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_view_freeze
argument_list|(
name|view
argument_list|)
expr_stmt|;
comment|/* too early? */
name|ISC_LIST_INIT
argument_list|(
name|client
operator|->
name|resctxs
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|client
operator|->
name|reqctxs
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|client
operator|->
name|updatectxs
argument_list|)
expr_stmt|;
name|client
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|client
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|client
operator|->
name|update_timeout
operator|=
name|DEF_UPDATE_TIMEOUT
expr_stmt|;
name|client
operator|->
name|update_udptimeout
operator|=
name|DEF_UPDATE_UDPTIMEOUT
expr_stmt|;
name|client
operator|->
name|update_udpretries
operator|=
name|DEF_UPDATE_UDPRETRIES
expr_stmt|;
name|client
operator|->
name|find_timeout
operator|=
name|DEF_FIND_TIMEOUT
expr_stmt|;
name|client
operator|->
name|find_udpretries
operator|=
name|DEF_FIND_UDPRETRIES
expr_stmt|;
name|client
operator|->
name|attributes
operator|=
literal|0
expr_stmt|;
name|client
operator|->
name|references
operator|=
literal|1
expr_stmt|;
name|client
operator|->
name|magic
operator|=
name|DNS_CLIENT_MAGIC
expr_stmt|;
operator|*
name|clientp
operator|=
name|client
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|dispatchv4
operator|!=
name|NULL
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|dispatchv4
argument_list|)
expr_stmt|;
if|if
condition|(
name|dispatchv6
operator|!=
name|NULL
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|dispatchv6
argument_list|)
expr_stmt|;
if|if
condition|(
name|dispatchmgr
operator|!=
name|NULL
condition|)
name|dns_dispatchmgr_destroy
argument_list|(
operator|&
name|dispatchmgr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|task
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|client
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|client
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|client
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroyclient
parameter_list|(
name|dns_client_t
modifier|*
modifier|*
name|clientp
parameter_list|)
block|{
name|dns_client_t
modifier|*
name|client
init|=
operator|*
name|clientp
decl_stmt|;
name|dns_view_t
modifier|*
name|view
decl_stmt|;
while|while
condition|(
operator|(
name|view
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|client
operator|->
name|viewlist
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|client
operator|->
name|viewlist
argument_list|,
name|view
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|client
operator|->
name|dispatchv4
operator|!=
name|NULL
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|client
operator|->
name|dispatchv4
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|dispatchv6
operator|!=
name|NULL
condition|)
name|dns_dispatch_detach
argument_list|(
operator|&
name|client
operator|->
name|dispatchv6
argument_list|)
expr_stmt|;
name|dns_dispatchmgr_destroy
argument_list|(
operator|&
name|client
operator|->
name|dispatchmgr
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|client
operator|->
name|task
argument_list|)
expr_stmt|;
comment|/* 	 * If the client has created its own running environments, 	 * destroy them. 	 */
if|if
condition|(
operator|(
name|client
operator|->
name|attributes
operator|&
name|DNS_CLIENTATTR_OWNCTX
operator|)
operator|!=
literal|0
condition|)
block|{
name|isc_taskmgr_destroy
argument_list|(
operator|&
name|client
operator|->
name|taskmgr
argument_list|)
expr_stmt|;
name|isc_timermgr_destroy
argument_list|(
operator|&
name|client
operator|->
name|timermgr
argument_list|)
expr_stmt|;
name|isc_socketmgr_destroy
argument_list|(
operator|&
name|client
operator|->
name|socketmgr
argument_list|)
expr_stmt|;
name|isc_app_ctxfinish
argument_list|(
name|client
operator|->
name|actx
argument_list|)
expr_stmt|;
name|isc_appctx_destroy
argument_list|(
operator|&
name|client
operator|->
name|actx
argument_list|)
expr_stmt|;
block|}
name|DESTROYLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|client
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_putanddetach
argument_list|(
operator|&
name|client
operator|->
name|mctx
argument_list|,
name|client
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|client
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|clientp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_client_destroy
parameter_list|(
name|dns_client_t
modifier|*
modifier|*
name|clientp
parameter_list|)
block|{
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_boolean_t
name|destroyok
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|clientp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|client
operator|=
operator|*
name|clientp
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|client
operator|->
name|references
operator|--
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|references
operator|==
literal|0
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|resctxs
argument_list|)
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|reqctxs
argument_list|)
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|updatectxs
argument_list|)
condition|)
block|{
name|destroyok
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|destroyok
condition|)
name|destroyclient
argument_list|(
operator|&
name|client
argument_list|)
expr_stmt|;
operator|*
name|clientp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_setservers
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_name_t
modifier|*
name|namespace
parameter_list|,
name|isc_sockaddrlist_t
modifier|*
name|addrs
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|addrs
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|namespace
operator|==
name|NULL
condition|)
name|namespace
operator|=
name|dns_rootname
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|client
operator|->
name|viewlist
argument_list|,
name|DNS_CLIENTVIEW_NAME
argument_list|,
name|rdclass
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_fwdtable_add
argument_list|(
name|view
operator|->
name|fwdtable
argument_list|,
name|namespace
argument_list|,
name|addrs
argument_list|,
name|dns_fwdpolicy_only
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_clearservers
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_name_t
modifier|*
name|namespace
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|namespace
operator|==
name|NULL
condition|)
name|namespace
operator|=
name|dns_rootname
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|client
operator|->
name|viewlist
argument_list|,
name|DNS_CLIENTVIEW_NAME
argument_list|,
name|rdclass
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_fwdtable_delete
argument_list|(
name|view
operator|->
name|fwdtable
argument_list|,
name|namespace
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|getrdataset
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_rdataset_t
modifier|*
modifier|*
name|rdatasetp
parameter_list|)
block|{
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdatasetp
operator|!=
name|NULL
operator|&&
operator|*
name|rdatasetp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|rdataset
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|dns_rdataset_init
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
operator|*
name|rdatasetp
operator|=
name|rdataset
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|putrdataset
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_rdataset_t
modifier|*
modifier|*
name|rdatasetp
parameter_list|)
block|{
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|REQUIRE
argument_list|(
name|rdatasetp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|rdataset
operator|=
operator|*
name|rdatasetp
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rdataset
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|rdatasetp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fetch_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|resctx_t
modifier|*
name|rctx
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|dns_fetchevent_t
modifier|*
name|fevent
decl_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_FETCHDONE
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|RCTX_VALID
argument_list|(
name|rctx
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rctx
operator|->
name|task
operator|==
name|task
argument_list|)
expr_stmt|;
name|fevent
operator|=
operator|(
name|dns_fetchevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|client_resfind
argument_list|(
name|rctx
argument_list|,
name|fevent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_result_t
name|start_fetch
parameter_list|(
name|resctx_t
modifier|*
name|rctx
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * The caller must be holding the rctx's lock. 	 */
name|REQUIRE
argument_list|(
name|rctx
operator|->
name|fetch
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_resolver_createfetch
argument_list|(
name|rctx
operator|->
name|view
operator|->
name|resolver
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|rctx
operator|->
name|name
argument_list|)
argument_list|,
name|rctx
operator|->
name|type
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|rctx
operator|->
name|task
argument_list|,
name|fetch_done
argument_list|,
name|rctx
argument_list|,
name|rctx
operator|->
name|rdataset
argument_list|,
name|rctx
operator|->
name|sigrdataset
argument_list|,
operator|&
name|rctx
operator|->
name|fetch
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|view_find
parameter_list|(
name|resctx_t
modifier|*
name|rctx
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|,
name|dns_name_t
modifier|*
name|foundname
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|dns_fixedname_name
argument_list|(
operator|&
name|rctx
operator|->
name|name
argument_list|)
decl_stmt|;
name|dns_rdatatype_t
name|type
decl_stmt|;
if|if
condition|(
name|rctx
operator|->
name|type
operator|==
name|dns_rdatatype_rrsig
condition|)
name|type
operator|=
name|dns_rdatatype_any
expr_stmt|;
else|else
name|type
operator|=
name|rctx
operator|->
name|type
expr_stmt|;
name|result
operator|=
name|dns_view_find
argument_list|(
name|rctx
operator|->
name|view
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|ISC_FALSE
argument_list|,
name|dbp
argument_list|,
name|nodep
argument_list|,
name|foundname
argument_list|,
name|rctx
operator|->
name|rdataset
argument_list|,
name|rctx
operator|->
name|sigrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|client_resfind
parameter_list|(
name|resctx_t
modifier|*
name|rctx
parameter_list|,
name|dns_fetchevent_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_result_t
name|tresult
decl_stmt|,
name|result
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|isc_result_t
name|vresult
init|=
name|ISC_R_SUCCESS
decl_stmt|;
name|isc_boolean_t
name|want_restart
decl_stmt|;
name|isc_boolean_t
name|send_event
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|,
modifier|*
name|prefix
decl_stmt|;
name|dns_fixedname_t
name|foundname
decl_stmt|,
name|fixed
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|trdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|unsigned
name|int
name|nlabels
decl_stmt|;
name|int
name|order
decl_stmt|;
name|dns_namereln_t
name|namereln
decl_stmt|;
name|dns_rdata_cname_t
name|cname
decl_stmt|;
name|dns_rdata_dname_t
name|dname
decl_stmt|;
name|REQUIRE
argument_list|(
name|RCTX_VALID
argument_list|(
name|rctx
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|rctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|rctx
operator|->
name|view
operator|->
name|mctx
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|rctx
operator|->
name|name
argument_list|)
expr_stmt|;
do|do
block|{
name|dns_name_t
modifier|*
name|fname
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|ansname
init|=
name|NULL
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|rctx
operator|->
name|restarts
operator|++
expr_stmt|;
name|want_restart
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
operator|&&
operator|!
name|rctx
operator|->
name|canceled
condition|)
block|{
name|dns_fixedname_init
argument_list|(
operator|&
name|foundname
argument_list|)
expr_stmt|;
name|fname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|foundname
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|!
name|dns_rdataset_isassociated
argument_list|(
name|rctx
operator|->
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|rctx
operator|->
name|sigrdataset
operator|==
name|NULL
operator|||
operator|!
name|dns_rdataset_isassociated
argument_list|(
name|rctx
operator|->
name|sigrdataset
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|view_find
argument_list|(
name|rctx
argument_list|,
operator|&
name|db
argument_list|,
operator|&
name|node
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
comment|/* 				 * We don't know anything about the name. 				 * Launch a fetch. 				 */
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
block|{
name|INSIST
argument_list|(
name|db
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
name|result
operator|=
name|start_fetch
argument_list|(
name|rctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|putrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rctx
operator|->
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rctx
operator|->
name|sigrdataset
operator|!=
name|NULL
condition|)
name|putrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rctx
operator|->
name|sigrdataset
argument_list|)
expr_stmt|;
name|send_event
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
block|}
else|else
block|{
name|INSIST
argument_list|(
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|fetch
operator|==
name|rctx
operator|->
name|fetch
argument_list|)
expr_stmt|;
name|dns_resolver_destroyfetch
argument_list|(
operator|&
name|rctx
operator|->
name|fetch
argument_list|)
expr_stmt|;
name|db
operator|=
name|event
operator|->
name|db
expr_stmt|;
name|node
operator|=
name|event
operator|->
name|node
expr_stmt|;
name|result
operator|=
name|event
operator|->
name|result
expr_stmt|;
name|vresult
operator|=
name|event
operator|->
name|vresult
expr_stmt|;
name|fname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|event
operator|->
name|foundname
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|rdataset
operator|==
name|rctx
operator|->
name|rdataset
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|sigrdataset
operator|==
name|rctx
operator|->
name|sigrdataset
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * If we've been canceled, forget about the result. 		 */
if|if
condition|(
name|rctx
operator|->
name|canceled
condition|)
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
else|else
block|{
comment|/* 			 * Otherwise, get some resource for copying the 			 * result. 			 */
name|ansname
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ansname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ansname
operator|==
name|NULL
condition|)
name|tresult
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
else|else
block|{
name|dns_name_t
modifier|*
name|aname
decl_stmt|;
name|aname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|rctx
operator|->
name|name
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
name|ansname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|tresult
operator|=
name|dns_name_dup
argument_list|(
name|aname
argument_list|,
name|mctx
argument_list|,
name|ansname
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|ansname
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ansname
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|tresult
expr_stmt|;
block|}
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|ISC_R_SUCCESS
case|:
name|send_event
operator|=
name|ISC_TRUE
expr_stmt|;
comment|/* 			 * This case is handled in the main line below. 			 */
break|break;
case|case
name|DNS_R_CNAME
case|:
comment|/* 			 * Add the CNAME to the answer list. 			 */
name|trdataset
operator|=
name|rctx
operator|->
name|rdataset
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|ansname
operator|->
name|list
argument_list|,
name|rctx
operator|->
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rctx
operator|->
name|rdataset
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|rctx
operator|->
name|sigrdataset
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|ansname
operator|->
name|list
argument_list|,
name|rctx
operator|->
name|sigrdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rctx
operator|->
name|sigrdataset
operator|=
name|NULL
expr_stmt|;
block|}
name|ISC_LIST_APPEND
argument_list|(
name|rctx
operator|->
name|namelist
argument_list|,
name|ansname
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ansname
operator|=
name|NULL
expr_stmt|;
comment|/* 			 * Copy the CNAME's target into the lookup's 			 * query name and start over. 			 */
name|tresult
operator|=
name|dns_rdataset_first
argument_list|(
name|trdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|done
goto|;
name|dns_rdataset_current
argument_list|(
name|trdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|tresult
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|cname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|done
goto|;
name|tresult
operator|=
name|dns_name_copy
argument_list|(
operator|&
name|cname
operator|.
name|cname
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|cname
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|==
name|ISC_R_SUCCESS
condition|)
name|want_restart
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|result
operator|=
name|tresult
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|DNS_R_DNAME
case|:
comment|/* 			 * Add the DNAME to the answer list. 			 */
name|trdataset
operator|=
name|rctx
operator|->
name|rdataset
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|ansname
operator|->
name|list
argument_list|,
name|rctx
operator|->
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rctx
operator|->
name|rdataset
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|rctx
operator|->
name|sigrdataset
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|ansname
operator|->
name|list
argument_list|,
name|rctx
operator|->
name|sigrdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rctx
operator|->
name|sigrdataset
operator|=
name|NULL
expr_stmt|;
block|}
name|ISC_LIST_APPEND
argument_list|(
name|rctx
operator|->
name|namelist
argument_list|,
name|ansname
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ansname
operator|=
name|NULL
expr_stmt|;
name|namereln
operator|=
name|dns_name_fullcompare
argument_list|(
name|name
argument_list|,
name|fname
argument_list|,
operator|&
name|order
argument_list|,
operator|&
name|nlabels
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|namereln
operator|==
name|dns_namereln_subdomain
argument_list|)
expr_stmt|;
comment|/* 			 * Get the target name of the DNAME. 			 */
name|tresult
operator|=
name|dns_rdataset_first
argument_list|(
name|trdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|tresult
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|dns_rdataset_current
argument_list|(
name|trdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|tresult
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|dname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|tresult
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 			 * Construct the new query name and start over. 			 */
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|prefix
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|dns_name_split
argument_list|(
name|name
argument_list|,
name|nlabels
argument_list|,
name|prefix
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|tresult
operator|=
name|dns_name_concatenate
argument_list|(
name|prefix
argument_list|,
operator|&
name|dname
operator|.
name|dname
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|dname
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|==
name|ISC_R_SUCCESS
condition|)
name|want_restart
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
name|result
operator|=
name|tresult
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|DNS_R_NCACHENXDOMAIN
case|:
case|case
name|DNS_R_NCACHENXRRSET
case|:
name|ISC_LIST_APPEND
argument_list|(
name|ansname
operator|->
name|list
argument_list|,
name|rctx
operator|->
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rctx
operator|->
name|namelist
argument_list|,
name|ansname
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ansname
operator|=
name|NULL
expr_stmt|;
name|rctx
operator|->
name|rdataset
operator|=
name|NULL
expr_stmt|;
comment|/* What about sigrdataset? */
if|if
condition|(
name|rctx
operator|->
name|sigrdataset
operator|!=
name|NULL
condition|)
name|putrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rctx
operator|->
name|sigrdataset
argument_list|)
expr_stmt|;
name|send_event
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|done
goto|;
default|default:
if|if
condition|(
name|rctx
operator|->
name|rdataset
operator|!=
name|NULL
condition|)
name|putrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rctx
operator|->
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rctx
operator|->
name|sigrdataset
operator|!=
name|NULL
condition|)
name|putrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rctx
operator|->
name|sigrdataset
argument_list|)
expr_stmt|;
name|send_event
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|rctx
operator|->
name|type
operator|==
name|dns_rdatatype_any
condition|)
block|{
name|int
name|n
init|=
literal|0
decl_stmt|;
name|dns_rdatasetiter_t
modifier|*
name|rdsiter
init|=
name|NULL
decl_stmt|;
name|tresult
operator|=
name|dns_db_allrdatasets
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|tresult
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|tresult
operator|=
name|dns_rdatasetiter_first
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
while|while
condition|(
name|tresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdatasetiter_current
argument_list|(
name|rdsiter
argument_list|,
name|rctx
operator|->
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rctx
operator|->
name|rdataset
operator|->
name|type
operator|!=
literal|0
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|ansname
operator|->
name|list
argument_list|,
name|rctx
operator|->
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
name|rctx
operator|->
name|rdataset
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* 					 * We're not interested in this 					 * rdataset. 					 */
name|dns_rdataset_disassociate
argument_list|(
name|rctx
operator|->
name|rdataset
argument_list|)
expr_stmt|;
block|}
name|tresult
operator|=
name|dns_rdatasetiter_next
argument_list|(
name|rdsiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|==
name|ISC_R_SUCCESS
operator|&&
name|rctx
operator|->
name|rdataset
operator|==
name|NULL
condition|)
block|{
name|tresult
operator|=
name|getrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rctx
operator|->
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|tresult
expr_stmt|;
name|POST
argument_list|(
name|result
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
comment|/* 				 * We didn't match any rdatasets (which means 				 * something went wrong in this 				 * implementation). 				 */
name|result
operator|=
name|DNS_R_SERVFAIL
expr_stmt|;
comment|/* better code? */
name|POST
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISC_LIST_APPEND
argument_list|(
name|rctx
operator|->
name|namelist
argument_list|,
name|ansname
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ansname
operator|=
name|NULL
expr_stmt|;
block|}
name|dns_rdatasetiter_destroy
argument_list|(
operator|&
name|rdsiter
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_NOMORE
condition|)
name|result
operator|=
name|DNS_R_SERVFAIL
expr_stmt|;
comment|/* ditto */
else|else
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
comment|/* 			 * This is the "normal" case -- an ordinary question 			 * to which we've got the answer. 			 */
name|ISC_LIST_APPEND
argument_list|(
name|ansname
operator|->
name|list
argument_list|,
name|rctx
operator|->
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rctx
operator|->
name|rdataset
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|rctx
operator|->
name|sigrdataset
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|ansname
operator|->
name|list
argument_list|,
name|rctx
operator|->
name|sigrdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rctx
operator|->
name|sigrdataset
operator|=
name|NULL
expr_stmt|;
block|}
name|ISC_LIST_APPEND
argument_list|(
name|rctx
operator|->
name|namelist
argument_list|,
name|ansname
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ansname
operator|=
name|NULL
expr_stmt|;
block|}
name|done
label|:
comment|/* 		 * Free temporary resources 		 */
if|if
condition|(
name|ansname
operator|!=
name|NULL
condition|)
block|{
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
while|while
condition|(
operator|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|ansname
operator|->
name|list
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|ansname
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|putrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
name|dns_name_free
argument_list|(
name|ansname
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|ansname
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ansname
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|dns_db_detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|!=
name|NULL
condition|)
name|isc_event_free
argument_list|(
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|event
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * Limit the number of restarts. 		 */
if|if
condition|(
name|want_restart
operator|&&
name|rctx
operator|->
name|restarts
operator|==
name|MAX_RESTARTS
condition|)
block|{
name|want_restart
operator|=
name|ISC_FALSE
expr_stmt|;
name|result
operator|=
name|ISC_R_QUOTA
expr_stmt|;
name|send_event
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
comment|/* 		 * Prepare further find with new resources 		 */
if|if
condition|(
name|want_restart
condition|)
block|{
name|INSIST
argument_list|(
name|rctx
operator|->
name|rdataset
operator|==
name|NULL
operator|&&
name|rctx
operator|->
name|sigrdataset
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|getrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rctx
operator|->
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|rctx
operator|->
name|want_dnssec
condition|)
block|{
name|result
operator|=
name|getrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rctx
operator|->
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|putrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rctx
operator|->
name|rdataset
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|want_restart
operator|=
name|ISC_FALSE
expr_stmt|;
name|send_event
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
name|want_restart
condition|)
do|;
if|if
condition|(
name|send_event
condition|)
block|{
name|isc_task_t
modifier|*
name|task
decl_stmt|;
while|while
condition|(
operator|(
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|rctx
operator|->
name|namelist
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|rctx
operator|->
name|namelist
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rctx
operator|->
name|event
operator|->
name|answerlist
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|rctx
operator|->
name|event
operator|->
name|result
operator|=
name|result
expr_stmt|;
name|rctx
operator|->
name|event
operator|->
name|vresult
operator|=
name|vresult
expr_stmt|;
name|task
operator|=
name|rctx
operator|->
name|event
operator|->
name|ev_sender
expr_stmt|;
name|rctx
operator|->
name|event
operator|->
name|ev_sender
operator|=
name|rctx
expr_stmt|;
name|isc_task_sendanddetach
argument_list|(
operator|&
name|task
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|rctx
operator|->
name|event
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|rctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|suspend
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_appctx_t
modifier|*
name|actx
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|isc_app_ctxsuspend
argument_list|(
name|actx
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|resolve_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|resarg_t
modifier|*
name|resarg
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|dns_clientresevent_t
modifier|*
name|rev
init|=
operator|(
name|dns_clientresevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|resarg
operator|->
name|result
operator|=
name|rev
operator|->
name|result
expr_stmt|;
name|resarg
operator|->
name|vresult
operator|=
name|rev
operator|->
name|vresult
expr_stmt|;
while|while
condition|(
operator|(
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|rev
operator|->
name|answerlist
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|rev
operator|->
name|answerlist
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
operator|*
name|resarg
operator|->
name|namelist
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
name|dns_client_destroyrestrans
argument_list|(
operator|&
name|resarg
operator|->
name|trans
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resarg
operator|->
name|canceled
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 		 * We may or may not be running.  isc__appctx_onrun will 		 * fail if we are currently running otherwise we post a 		 * action to call isc_app_ctxsuspend when we do start 		 * running. 		 */
name|result
operator|=
name|isc_app_ctxonrun
argument_list|(
name|resarg
operator|->
name|actx
argument_list|,
name|resarg
operator|->
name|client
operator|->
name|mctx
argument_list|,
name|task
argument_list|,
name|suspend
argument_list|,
name|resarg
operator|->
name|actx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_ALREADYRUNNING
condition|)
name|isc_app_ctxsuspend
argument_list|(
name|resarg
operator|->
name|actx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * We have already exited from the loop (due to some 		 * unexpected event).  Just clean the arg up. 		 */
name|UNLOCK
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|resarg
operator|->
name|client
operator|->
name|mctx
argument_list|,
name|resarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|resarg
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_resolve
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_namelist_t
modifier|*
name|namelist
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_appctx_t
modifier|*
name|actx
decl_stmt|;
name|resarg_t
modifier|*
name|resarg
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|namelist
operator|!=
name|NULL
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
operator|*
name|namelist
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|client
operator|->
name|attributes
operator|&
name|DNS_CLIENTATTR_OWNCTX
operator|)
operator|==
literal|0
operator|&&
operator|(
name|options
operator|&
name|DNS_CLIENTRESOPT_ALLOWRUN
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * If the client is run under application's control, we need 		 * to create a new running (sub)environment for this 		 * particular resolution. 		 */
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
comment|/* XXXTBD */
block|}
else|else
name|actx
operator|=
name|client
operator|->
name|actx
expr_stmt|;
name|resarg
operator|=
name|isc_mem_get
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|resarg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|resarg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|resarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|resarg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|resarg
operator|->
name|actx
operator|=
name|actx
expr_stmt|;
name|resarg
operator|->
name|client
operator|=
name|client
expr_stmt|;
name|resarg
operator|->
name|result
operator|=
name|DNS_R_SERVFAIL
expr_stmt|;
name|resarg
operator|->
name|namelist
operator|=
name|namelist
expr_stmt|;
name|resarg
operator|->
name|trans
operator|=
name|NULL
expr_stmt|;
name|resarg
operator|->
name|canceled
operator|=
name|ISC_FALSE
expr_stmt|;
name|result
operator|=
name|dns_client_startresolve
argument_list|(
name|client
argument_list|,
name|name
argument_list|,
name|rdclass
argument_list|,
name|type
argument_list|,
name|options
argument_list|,
name|client
operator|->
name|task
argument_list|,
name|resolve_done
argument_list|,
name|resarg
argument_list|,
operator|&
name|resarg
operator|->
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|DESTROYLOCK
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|resarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|resarg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * Start internal event loop.  It blocks until the entire process 	 * is completed. 	 */
name|result
operator|=
name|isc_app_ctxrun
argument_list|(
name|actx
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|||
name|result
operator|==
name|ISC_R_SUSPEND
condition|)
name|result
operator|=
name|resarg
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|resarg
operator|->
name|vresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 		 * If this lookup failed due to some error in DNSSEC 		 * validation, return the validation error code. 		 * XXX: or should we pass the validation result separately? 		 */
name|result
operator|=
name|resarg
operator|->
name|vresult
expr_stmt|;
block|}
if|if
condition|(
name|resarg
operator|->
name|trans
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Unusual termination (perhaps due to signal).  We need some 		 * tricky cleanup process. 		 */
name|resarg
operator|->
name|canceled
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_client_cancelresolve
argument_list|(
name|resarg
operator|->
name|trans
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* resarg will be freed in the event handler. */
block|}
else|else
block|{
name|UNLOCK
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|resarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|resarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|resarg
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_startresolve
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_clientrestrans_t
modifier|*
modifier|*
name|transp
parameter_list|)
block|{
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
name|dns_clientresevent_t
modifier|*
name|event
init|=
name|NULL
decl_stmt|;
name|resctx_t
modifier|*
name|rctx
init|=
name|NULL
decl_stmt|;
name|isc_task_t
modifier|*
name|clone
init|=
name|NULL
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|,
modifier|*
name|sigrdataset
decl_stmt|;
name|isc_boolean_t
name|want_dnssec
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|transp
operator|!=
name|NULL
operator|&&
operator|*
name|transp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|client
operator|->
name|viewlist
argument_list|,
name|DNS_CLIENTVIEW_NAME
argument_list|,
name|rdclass
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|mctx
operator|=
name|client
operator|->
name|mctx
expr_stmt|;
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|sigrdataset
operator|=
name|NULL
expr_stmt|;
name|want_dnssec
operator|=
name|ISC_TF
argument_list|(
operator|(
name|options
operator|&
name|DNS_CLIENTRESOPT_NODNSSEC
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Prepare some intermediate resources 	 */
name|clone
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|clone
argument_list|)
expr_stmt|;
name|event
operator|=
operator|(
name|dns_clientresevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|mctx
argument_list|,
name|clone
argument_list|,
name|DNS_EVENT_CLIENTRESDONE
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|event
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|event
operator|->
name|result
operator|=
name|DNS_R_SERVFAIL
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|event
operator|->
name|answerlist
argument_list|)
expr_stmt|;
name|rctx
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rctx
operator|==
name|NULL
condition|)
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
else|else
block|{
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|rctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rctx
argument_list|)
argument_list|)
expr_stmt|;
name|rctx
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|getrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|rctx
operator|->
name|rdataset
operator|=
name|rdataset
expr_stmt|;
if|if
condition|(
name|want_dnssec
condition|)
block|{
name|result
operator|=
name|getrdataset
argument_list|(
name|mctx
argument_list|,
operator|&
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
block|}
name|rctx
operator|->
name|sigrdataset
operator|=
name|sigrdataset
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|rctx
operator|->
name|name
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_copy
argument_list|(
name|name
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|rctx
operator|->
name|name
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|rctx
operator|->
name|client
operator|=
name|client
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|rctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rctx
operator|->
name|canceled
operator|=
name|ISC_FALSE
expr_stmt|;
name|rctx
operator|->
name|task
operator|=
name|client
operator|->
name|task
expr_stmt|;
name|rctx
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|rctx
operator|->
name|view
operator|=
name|view
expr_stmt|;
name|rctx
operator|->
name|restarts
operator|=
literal|0
expr_stmt|;
name|rctx
operator|->
name|fetch
operator|=
name|NULL
expr_stmt|;
name|rctx
operator|->
name|want_dnssec
operator|=
name|want_dnssec
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rctx
operator|->
name|namelist
argument_list|)
expr_stmt|;
name|rctx
operator|->
name|event
operator|=
name|event
expr_stmt|;
name|rctx
operator|->
name|magic
operator|=
name|RCTX_MAGIC
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|client
operator|->
name|resctxs
argument_list|,
name|rctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|transp
operator|=
operator|(
name|dns_clientrestrans_t
operator|*
operator|)
name|rctx
expr_stmt|;
name|client_resfind
argument_list|(
name|rctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
if|if
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
name|putrdataset
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|sigrdataset
operator|!=
name|NULL
condition|)
name|putrdataset
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
operator|&
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rctx
operator|!=
name|NULL
condition|)
block|{
name|DESTROYLOCK
argument_list|(
operator|&
name|rctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rctx
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|event
operator|!=
name|NULL
condition|)
name|isc_event_free
argument_list|(
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|clone
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_client_cancelresolve
parameter_list|(
name|dns_clientrestrans_t
modifier|*
name|trans
parameter_list|)
block|{
name|resctx_t
modifier|*
name|rctx
decl_stmt|;
name|REQUIRE
argument_list|(
name|trans
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|rctx
operator|=
operator|(
name|resctx_t
operator|*
operator|)
name|trans
expr_stmt|;
name|REQUIRE
argument_list|(
name|RCTX_VALID
argument_list|(
name|rctx
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|rctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rctx
operator|->
name|canceled
condition|)
block|{
name|rctx
operator|->
name|canceled
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|rctx
operator|->
name|fetch
operator|!=
name|NULL
condition|)
name|dns_resolver_cancelfetch
argument_list|(
name|rctx
operator|->
name|fetch
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|rctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_client_freeresanswer
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_namelist_t
modifier|*
name|namelist
parameter_list|)
block|{
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|namelist
operator|!=
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|namelist
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
operator|*
name|namelist
argument_list|,
name|name
argument_list|,
name|link
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|putrdataset
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
name|dns_name_free
argument_list|(
name|name
argument_list|,
name|client
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|dns_client_destroyrestrans
parameter_list|(
name|dns_clientrestrans_t
modifier|*
modifier|*
name|transp
parameter_list|)
block|{
name|resctx_t
modifier|*
name|rctx
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_boolean_t
name|need_destroyclient
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|transp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|rctx
operator|=
operator|(
name|resctx_t
operator|*
operator|)
operator|*
name|transp
expr_stmt|;
name|REQUIRE
argument_list|(
name|RCTX_VALID
argument_list|(
name|rctx
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rctx
operator|->
name|fetch
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rctx
operator|->
name|event
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|client
operator|=
name|rctx
operator|->
name|client
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|client
operator|->
name|mctx
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|rctx
operator|->
name|view
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ISC_LINK_LINKED
argument_list|(
name|rctx
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|client
operator|->
name|resctxs
argument_list|,
name|rctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|references
operator|==
literal|0
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|resctxs
argument_list|)
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|reqctxs
argument_list|)
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|updatectxs
argument_list|)
condition|)
name|need_destroyclient
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ISC_LIST_EMPTY
argument_list|(
name|rctx
operator|->
name|namelist
argument_list|)
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|rctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|rctx
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroyclient
condition|)
name|destroyclient
argument_list|(
operator|&
name|client
argument_list|)
expr_stmt|;
operator|*
name|transp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_addtrustedkey
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_name_t
modifier|*
name|keyname
parameter_list|,
name|isc_buffer_t
modifier|*
name|keydatabuf
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
name|dst_key_t
modifier|*
name|dstkey
init|=
name|NULL
decl_stmt|;
name|dns_keytable_t
modifier|*
name|secroots
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|client
operator|->
name|viewlist
argument_list|,
name|DNS_CLIENTVIEW_NAME
argument_list|,
name|rdclass
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_view_getsecroots
argument_list|(
name|view
argument_list|,
operator|&
name|secroots
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dst_key_fromdns
argument_list|(
name|keyname
argument_list|,
name|rdclass
argument_list|,
name|keydatabuf
argument_list|,
name|client
operator|->
name|mctx
argument_list|,
operator|&
name|dstkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|result
operator|=
name|dns_keytable_add
argument_list|(
name|secroots
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|dstkey
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|dstkey
operator|!=
name|NULL
condition|)
name|dst_key_free
argument_list|(
operator|&
name|dstkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
if|if
condition|(
name|secroots
operator|!=
name|NULL
condition|)
name|dns_keytable_detach
argument_list|(
operator|&
name|secroots
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*%  * Simple request routines  */
end_comment

begin_function
specifier|static
name|void
name|request_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_requestevent_t
modifier|*
name|reqev
init|=
name|NULL
decl_stmt|;
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|,
name|eresult
decl_stmt|;
name|reqctx_t
modifier|*
name|ctx
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_REQUESTDONE
argument_list|)
expr_stmt|;
name|reqev
operator|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|request
operator|=
name|reqev
operator|->
name|request
expr_stmt|;
name|result
operator|=
name|eresult
operator|=
name|reqev
operator|->
name|result
expr_stmt|;
name|ctx
operator|=
name|reqev
operator|->
name|ev_arg
expr_stmt|;
name|REQUIRE
argument_list|(
name|REQCTX_VALID
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|ctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|request
argument_list|,
name|ctx
operator|->
name|event
operator|->
name|rmessage
argument_list|,
name|ctx
operator|->
name|parseoptions
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|ctx
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|canceled
condition|)
name|ctx
operator|->
name|event
operator|->
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
else|else
name|ctx
operator|->
name|event
operator|->
name|result
operator|=
name|result
expr_stmt|;
name|task
operator|=
name|ctx
operator|->
name|event
operator|->
name|ev_sender
expr_stmt|;
name|ctx
operator|->
name|event
operator|->
name|ev_sender
operator|=
name|ctx
expr_stmt|;
name|isc_task_sendanddetach
argument_list|(
operator|&
name|task
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|ctx
operator|->
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|ctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|localrequest_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|reqarg_t
modifier|*
name|reqarg
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|dns_clientreqevent_t
modifier|*
name|rev
init|=
operator|(
name|dns_clientreqevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_CLIENTREQDONE
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|reqarg
operator|->
name|result
operator|=
name|rev
operator|->
name|result
expr_stmt|;
name|dns_client_destroyreqtrans
argument_list|(
operator|&
name|reqarg
operator|->
name|trans
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reqarg
operator|->
name|canceled
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* Exit from the internal event loop */
name|isc_app_ctxsuspend
argument_list|(
name|reqarg
operator|->
name|actx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * We have already exited from the loop (due to some 		 * unexpected event).  Just clean the arg up. 		 */
name|UNLOCK
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|reqarg
operator|->
name|client
operator|->
name|mctx
argument_list|,
name|reqarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reqarg
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_request
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_message_t
modifier|*
name|qmessage
parameter_list|,
name|dns_message_t
modifier|*
name|rmessage
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|server
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|unsigned
name|int
name|parseoptions
parameter_list|,
name|dns_tsec_t
modifier|*
name|tsec
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|unsigned
name|int
name|udptimeout
parameter_list|,
name|unsigned
name|int
name|udpretries
parameter_list|)
block|{
name|isc_appctx_t
modifier|*
name|actx
decl_stmt|;
name|reqarg_t
modifier|*
name|reqarg
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|qmessage
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rmessage
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|client
operator|->
name|attributes
operator|&
name|DNS_CLIENTATTR_OWNCTX
operator|)
operator|==
literal|0
operator|&&
operator|(
name|options
operator|&
name|DNS_CLIENTREQOPT_ALLOWRUN
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * If the client is run under application's control, we need 		 * to create a new running (sub)environment for this 		 * particular resolution. 		 */
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
comment|/* XXXTBD */
block|}
else|else
name|actx
operator|=
name|client
operator|->
name|actx
expr_stmt|;
name|reqarg
operator|=
name|isc_mem_get
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reqarg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqarg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|reqarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reqarg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|reqarg
operator|->
name|actx
operator|=
name|actx
expr_stmt|;
name|reqarg
operator|->
name|client
operator|=
name|client
expr_stmt|;
name|reqarg
operator|->
name|trans
operator|=
name|NULL
expr_stmt|;
name|reqarg
operator|->
name|canceled
operator|=
name|ISC_FALSE
expr_stmt|;
name|result
operator|=
name|dns_client_startrequest
argument_list|(
name|client
argument_list|,
name|qmessage
argument_list|,
name|rmessage
argument_list|,
name|server
argument_list|,
name|options
argument_list|,
name|parseoptions
argument_list|,
name|tsec
argument_list|,
name|timeout
argument_list|,
name|udptimeout
argument_list|,
name|udpretries
argument_list|,
name|client
operator|->
name|task
argument_list|,
name|localrequest_done
argument_list|,
name|reqarg
argument_list|,
operator|&
name|reqarg
operator|->
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|DESTROYLOCK
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|reqarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reqarg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * Start internal event loop.  It blocks until the entire process 	 * is completed. 	 */
name|result
operator|=
name|isc_app_ctxrun
argument_list|(
name|actx
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|||
name|result
operator|==
name|ISC_R_SUSPEND
condition|)
name|result
operator|=
name|reqarg
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|reqarg
operator|->
name|trans
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Unusual termination (perhaps due to signal).  We need some 		 * tricky cleanup process. 		 */
name|reqarg
operator|->
name|canceled
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_client_cancelresolve
argument_list|(
name|reqarg
operator|->
name|trans
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* reqarg will be freed in the event handler. */
block|}
else|else
block|{
name|UNLOCK
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|reqarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|reqarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reqarg
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_startrequest
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_message_t
modifier|*
name|qmessage
parameter_list|,
name|dns_message_t
modifier|*
name|rmessage
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|server
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|unsigned
name|int
name|parseoptions
parameter_list|,
name|dns_tsec_t
modifier|*
name|tsec
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|unsigned
name|int
name|udptimeout
parameter_list|,
name|unsigned
name|int
name|udpretries
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_clientreqtrans_t
modifier|*
modifier|*
name|transp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
name|isc_task_t
modifier|*
name|clone
init|=
name|NULL
decl_stmt|;
name|dns_clientreqevent_t
modifier|*
name|event
init|=
name|NULL
decl_stmt|;
name|reqctx_t
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|dns_tsectype_t
name|tsectype
init|=
name|dns_tsectype_none
decl_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|qmessage
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rmessage
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|transp
operator|!=
name|NULL
operator|&&
operator|*
name|transp
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsec
operator|!=
name|NULL
condition|)
block|{
name|tsectype
operator|=
name|dns_tsec_gettype
argument_list|(
name|tsec
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsectype
operator|!=
name|dns_tsectype_tsig
condition|)
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
comment|/* XXX */
block|}
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|client
operator|->
name|viewlist
argument_list|,
name|DNS_CLIENTVIEW_NAME
argument_list|,
name|qmessage
operator|->
name|rdclass
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|clone
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|clone
argument_list|)
expr_stmt|;
name|event
operator|=
operator|(
name|dns_clientreqevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|clone
argument_list|,
name|DNS_EVENT_CLIENTREQDONE
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|event
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|ctx
operator|=
name|isc_mem_get
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
else|else
block|{
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|ctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|ctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|ctx
operator|->
name|client
operator|=
name|client
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|ctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|parseoptions
operator|=
name|parseoptions
expr_stmt|;
name|ctx
operator|->
name|canceled
operator|=
name|ISC_FALSE
expr_stmt|;
name|ctx
operator|->
name|event
operator|=
name|event
expr_stmt|;
name|ctx
operator|->
name|event
operator|->
name|rmessage
operator|=
name|rmessage
expr_stmt|;
name|ctx
operator|->
name|tsigkey
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|tsec
operator|!=
name|NULL
condition|)
name|dns_tsec_getkey
argument_list|(
name|tsec
argument_list|,
operator|&
name|ctx
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|magic
operator|=
name|REQCTX_MAGIC
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|client
operator|->
name|reqctxs
argument_list|,
name|ctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|request
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|view
operator|->
name|requestmgr
argument_list|,
name|qmessage
argument_list|,
name|NULL
argument_list|,
name|server
argument_list|,
name|options
argument_list|,
name|ctx
operator|->
name|tsigkey
argument_list|,
name|timeout
argument_list|,
name|udptimeout
argument_list|,
name|udpretries
argument_list|,
name|client
operator|->
name|task
argument_list|,
name|request_done
argument_list|,
name|ctx
argument_list|,
operator|&
name|ctx
operator|->
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
operator|*
name|transp
operator|=
operator|(
name|dns_clientreqtrans_t
operator|*
operator|)
name|ctx
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|cleanup
label|:
if|if
condition|(
name|ctx
operator|!=
name|NULL
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|client
operator|->
name|reqctxs
argument_list|,
name|ctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|ctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|ctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|event
operator|!=
name|NULL
condition|)
name|isc_event_free
argument_list|(
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|clone
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_client_cancelrequest
parameter_list|(
name|dns_clientreqtrans_t
modifier|*
name|trans
parameter_list|)
block|{
name|reqctx_t
modifier|*
name|ctx
decl_stmt|;
name|REQUIRE
argument_list|(
name|trans
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ctx
operator|=
operator|(
name|reqctx_t
operator|*
operator|)
name|trans
expr_stmt|;
name|REQUIRE
argument_list|(
name|REQCTX_VALID
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|ctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
operator|->
name|canceled
condition|)
block|{
name|ctx
operator|->
name|canceled
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|request
operator|!=
name|NULL
condition|)
name|dns_request_cancel
argument_list|(
name|ctx
operator|->
name|request
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|ctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_client_destroyreqtrans
parameter_list|(
name|dns_clientreqtrans_t
modifier|*
modifier|*
name|transp
parameter_list|)
block|{
name|reqctx_t
modifier|*
name|ctx
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_boolean_t
name|need_destroyclient
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|transp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ctx
operator|=
operator|(
name|reqctx_t
operator|*
operator|)
operator|*
name|transp
expr_stmt|;
name|REQUIRE
argument_list|(
name|REQCTX_VALID
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|client
operator|=
name|ctx
operator|->
name|client
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|ctx
operator|->
name|event
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|ctx
operator|->
name|request
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|ctx
operator|->
name|request
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|client
operator|->
name|mctx
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ISC_LINK_LINKED
argument_list|(
name|ctx
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|client
operator|->
name|reqctxs
argument_list|,
name|ctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|references
operator|==
literal|0
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|resctxs
argument_list|)
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|reqctxs
argument_list|)
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|updatectxs
argument_list|)
condition|)
block|{
name|need_destroyclient
operator|=
name|ISC_TRUE
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|ctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|ctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroyclient
condition|)
name|destroyclient
argument_list|(
operator|&
name|client
argument_list|)
expr_stmt|;
operator|*
name|transp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*%  * Dynamic update routines  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|rcode2result
parameter_list|(
name|dns_rcode_t
name|rcode
parameter_list|)
block|{
comment|/* XXX: isn't there a similar function? */
switch|switch
condition|(
name|rcode
condition|)
block|{
case|case
name|dns_rcode_formerr
case|:
return|return
operator|(
name|DNS_R_FORMERR
operator|)
return|;
case|case
name|dns_rcode_servfail
case|:
return|return
operator|(
name|DNS_R_SERVFAIL
operator|)
return|;
case|case
name|dns_rcode_nxdomain
case|:
return|return
operator|(
name|DNS_R_NXDOMAIN
operator|)
return|;
case|case
name|dns_rcode_notimp
case|:
return|return
operator|(
name|DNS_R_NOTIMP
operator|)
return|;
case|case
name|dns_rcode_refused
case|:
return|return
operator|(
name|DNS_R_REFUSED
operator|)
return|;
case|case
name|dns_rcode_yxdomain
case|:
return|return
operator|(
name|DNS_R_YXDOMAIN
operator|)
return|;
case|case
name|dns_rcode_yxrrset
case|:
return|return
operator|(
name|DNS_R_YXRRSET
operator|)
return|;
case|case
name|dns_rcode_nxrrset
case|:
return|return
operator|(
name|DNS_R_NXRRSET
operator|)
return|;
case|case
name|dns_rcode_notauth
case|:
return|return
operator|(
name|DNS_R_NOTAUTH
operator|)
return|;
case|case
name|dns_rcode_notzone
case|:
return|return
operator|(
name|DNS_R_NOTZONE
operator|)
return|;
case|case
name|dns_rcode_badvers
case|:
return|return
operator|(
name|DNS_R_BADVERS
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_sendevent
parameter_list|(
name|updatectx_t
modifier|*
name|uctx
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|uctx
operator|->
name|updatemsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|uctx
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|sig0key
operator|!=
name|NULL
condition|)
name|dst_key_free
argument_list|(
operator|&
name|uctx
operator|->
name|sig0key
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|canceled
condition|)
name|uctx
operator|->
name|event
operator|->
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
else|else
name|uctx
operator|->
name|event
operator|->
name|result
operator|=
name|result
expr_stmt|;
name|uctx
operator|->
name|event
operator|->
name|state
operator|=
name|uctx
operator|->
name|state
expr_stmt|;
name|task
operator|=
name|uctx
operator|->
name|event
operator|->
name|ev_sender
expr_stmt|;
name|uctx
operator|->
name|event
operator|->
name|ev_sender
operator|=
name|uctx
expr_stmt|;
name|isc_task_sendanddetach
argument_list|(
operator|&
name|task
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|uctx
operator|->
name|event
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_requestevent_t
modifier|*
name|reqev
init|=
name|NULL
decl_stmt|;
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|dns_message_t
modifier|*
name|answer
init|=
name|NULL
decl_stmt|;
name|updatectx_t
modifier|*
name|uctx
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|unsigned
name|int
name|timeout
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_REQUESTDONE
argument_list|)
expr_stmt|;
name|reqev
operator|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|request
operator|=
name|reqev
operator|->
name|request
expr_stmt|;
name|REQUIRE
argument_list|(
name|UCTX_VALID
argument_list|(
name|uctx
argument_list|)
argument_list|)
expr_stmt|;
name|client
operator|=
name|uctx
operator|->
name|client
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|reqev
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|out
goto|;
name|result
operator|=
name|dns_message_create
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|answer
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|out
goto|;
name|uctx
operator|->
name|state
operator|=
name|dns_clientupdatestate_done
expr_stmt|;
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|request
argument_list|,
name|answer
argument_list|,
name|DNS_MESSAGEPARSE_PRESERVEORDER
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|answer
operator|->
name|rcode
operator|!=
name|dns_rcode_noerror
condition|)
name|result
operator|=
name|rcode2result
argument_list|(
name|answer
operator|->
name|rcode
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|answer
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|answer
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|currentserver
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|uctx
operator|->
name|currentserver
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|uctx
operator|->
name|updatereq
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
operator|!
name|uctx
operator|->
name|canceled
operator|&&
name|uctx
operator|->
name|currentserver
operator|!=
name|NULL
condition|)
block|{
name|dns_message_renderreset
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|)
expr_stmt|;
name|dns_message_settsigkey
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|timeout
operator|=
name|client
operator|->
name|update_timeout
operator|/
name|uctx
operator|->
name|nservers
expr_stmt|;
if|if
condition|(
name|timeout
operator|<
name|MIN_UPDATE_TIMEOUT
condition|)
name|timeout
operator|=
name|MIN_UPDATE_TIMEOUT
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|uctx
operator|->
name|view
operator|->
name|requestmgr
argument_list|,
name|uctx
operator|->
name|updatemsg
argument_list|,
name|NULL
argument_list|,
name|uctx
operator|->
name|currentserver
argument_list|,
literal|0
argument_list|,
name|uctx
operator|->
name|tsigkey
argument_list|,
name|timeout
argument_list|,
name|client
operator|->
name|update_udptimeout
argument_list|,
name|client
operator|->
name|update_udpretries
argument_list|,
name|client
operator|->
name|task
argument_list|,
name|update_done
argument_list|,
name|uctx
argument_list|,
operator|&
name|uctx
operator|->
name|updatereq
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* XXX: should we keep the 'done' state here? */
name|uctx
operator|->
name|state
operator|=
name|dns_clientupdatestate_sent
expr_stmt|;
return|return;
block|}
block|}
else|else
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|update_sendevent
argument_list|(
name|uctx
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|send_update
parameter_list|(
name|updatectx_t
modifier|*
name|uctx
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|dns_client_t
modifier|*
name|client
init|=
name|uctx
operator|->
name|client
decl_stmt|;
name|unsigned
name|int
name|timeout
decl_stmt|;
name|REQUIRE
argument_list|(
name|uctx
operator|->
name|zonename
operator|!=
name|NULL
operator|&&
name|uctx
operator|->
name|currentserver
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_gettempname
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_name_init
argument_list|(
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
name|uctx
operator|->
name|zonename
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_message_puttempname
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|dns_rdataset_makequestion
argument_list|(
name|rdataset
argument_list|,
name|uctx
operator|->
name|rdclass
argument_list|,
name|dns_rdatatype_soa
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|name
operator|->
name|list
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
name|name
argument_list|,
name|DNS_SECTION_ZONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|tsigkey
operator|==
name|NULL
operator|&&
name|uctx
operator|->
name|sig0key
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_message_setsig0key
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
name|uctx
operator|->
name|sig0key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
name|timeout
operator|=
name|client
operator|->
name|update_timeout
operator|/
name|uctx
operator|->
name|nservers
expr_stmt|;
if|if
condition|(
name|timeout
operator|<
name|MIN_UPDATE_TIMEOUT
condition|)
name|timeout
operator|=
name|MIN_UPDATE_TIMEOUT
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|uctx
operator|->
name|view
operator|->
name|requestmgr
argument_list|,
name|uctx
operator|->
name|updatemsg
argument_list|,
name|NULL
argument_list|,
name|uctx
operator|->
name|currentserver
argument_list|,
literal|0
argument_list|,
name|uctx
operator|->
name|tsigkey
argument_list|,
name|timeout
argument_list|,
name|client
operator|->
name|update_udptimeout
argument_list|,
name|client
operator|->
name|update_udpretries
argument_list|,
name|client
operator|->
name|task
argument_list|,
name|update_done
argument_list|,
name|uctx
argument_list|,
operator|&
name|uctx
operator|->
name|updatereq
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|&&
name|uctx
operator|->
name|state
operator|==
name|dns_clientupdatestate_prepare
condition|)
block|{
name|uctx
operator|->
name|state
operator|=
name|dns_clientupdatestate_sent
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|resolveaddr_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|int
name|family
decl_stmt|;
name|dns_rdatatype_t
name|qtype
decl_stmt|;
name|dns_clientresevent_t
modifier|*
name|rev
init|=
operator|(
name|dns_clientresevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|updatectx_t
modifier|*
name|uctx
decl_stmt|;
name|isc_boolean_t
name|completed
init|=
name|ISC_FALSE
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_arg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|uctx
operator|=
operator|*
operator|(
name|updatectx_t
operator|*
operator|*
operator|)
name|event
operator|->
name|ev_arg
expr_stmt|;
name|REQUIRE
argument_list|(
name|UCTX_VALID
argument_list|(
name|uctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|->
name|ev_arg
operator|==
operator|&
name|uctx
operator|->
name|bp4
condition|)
block|{
name|family
operator|=
name|AF_INET
expr_stmt|;
name|qtype
operator|=
name|dns_rdatatype_a
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dns_client_destroyrestrans
argument_list|(
operator|&
name|uctx
operator|->
name|restrans
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|INSIST
argument_list|(
name|event
operator|->
name|ev_arg
operator|==
operator|&
name|uctx
operator|->
name|bp6
argument_list|)
expr_stmt|;
name|family
operator|=
name|AF_INET6
expr_stmt|;
name|qtype
operator|=
name|dns_rdatatype_aaaa
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dns_client_destroyrestrans
argument_list|(
operator|&
name|uctx
operator|->
name|restrans2
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|rev
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|done
goto|;
for|for
control|(
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|rev
operator|->
name|answerlist
argument_list|)
init|;
name|name
operator|!=
name|NULL
condition|;
name|name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|link
argument_list|)
control|)
block|{
for|for
control|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rdataset
operator|!=
name|NULL
condition|;
name|rdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
operator|!
name|dns_rdataset_isassociated
argument_list|(
name|rdataset
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|rdataset
operator|->
name|type
operator|!=
name|qtype
condition|)
continue|continue;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
control|)
block|{
name|dns_rdata_t
name|rdata
decl_stmt|;
name|dns_rdata_in_a_t
name|rdata_a
decl_stmt|;
name|dns_rdata_in_aaaa_t
name|rdata_aaaa
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|sa
decl_stmt|;
name|sa
operator|=
name|isc_mem_get
argument_list|(
name|uctx
operator|->
name|client
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|==
name|NULL
condition|)
block|{
comment|/* 					 * If we fail to get a sockaddr, 					 we simply move forward with the 					 * addresses we've got so far. 					 */
goto|goto
name|done
goto|;
block|}
name|dns_rdata_init
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|rdata_a
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromin
argument_list|(
name|sa
argument_list|,
operator|&
name|rdata_a
operator|.
name|in_addr
argument_list|,
literal|53
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|rdata_a
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|rdata_aaaa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RUNTIME_CHECK
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|isc_sockaddr_fromin6
argument_list|(
name|sa
argument_list|,
operator|&
name|rdata_aaaa
operator|.
name|in6_addr
argument_list|,
literal|53
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|rdata_aaaa
argument_list|)
expr_stmt|;
break|break;
block|}
name|ISC_LINK_INIT
argument_list|(
name|sa
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|uctx
operator|->
name|servers
argument_list|,
name|sa
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|nservers
operator|++
expr_stmt|;
block|}
block|}
block|}
name|done
label|:
name|dns_client_freeresanswer
argument_list|(
name|uctx
operator|->
name|client
argument_list|,
operator|&
name|rev
operator|->
name|answerlist
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|restrans
operator|==
name|NULL
operator|&&
name|uctx
operator|->
name|restrans2
operator|==
name|NULL
condition|)
name|completed
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|completed
condition|)
block|{
name|INSIST
argument_list|(
name|uctx
operator|->
name|currentserver
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|currentserver
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|uctx
operator|->
name|servers
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|currentserver
operator|!=
name|NULL
operator|&&
operator|!
name|uctx
operator|->
name|canceled
condition|)
name|send_update
argument_list|(
name|uctx
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
name|update_sendevent
argument_list|(
name|uctx
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|process_soa
parameter_list|(
name|updatectx_t
modifier|*
name|uctx
parameter_list|,
name|dns_rdataset_t
modifier|*
name|soaset
parameter_list|,
name|dns_name_t
modifier|*
name|soaname
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_t
name|soarr
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_soa_t
name|soa
decl_stmt|;
name|dns_name_t
name|primary
decl_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|soaset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_rdata_init
argument_list|(
operator|&
name|soarr
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|soaset
argument_list|,
operator|&
name|soarr
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|soarr
argument_list|,
operator|&
name|soa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_name_init
argument_list|(
operator|&
name|primary
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|soa
operator|.
name|origin
argument_list|,
operator|&
name|primary
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|zonename
operator|==
name|NULL
condition|)
block|{
name|uctx
operator|->
name|zonename
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|uctx
operator|->
name|zonefname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_copy
argument_list|(
name|soaname
argument_list|,
name|uctx
operator|->
name|zonename
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|uctx
operator|->
name|currentserver
operator|!=
name|NULL
condition|)
name|result
operator|=
name|send_update
argument_list|(
name|uctx
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* 		 * Get addresses of the primary server.  We don't use the ADB 		 * feature so that we could avoid caching data. 		 */
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|bp4
operator|=
name|uctx
expr_stmt|;
name|result
operator|=
name|dns_client_startresolve
argument_list|(
name|uctx
operator|->
name|client
argument_list|,
operator|&
name|primary
argument_list|,
name|uctx
operator|->
name|rdclass
argument_list|,
name|dns_rdatatype_a
argument_list|,
literal|0
argument_list|,
name|uctx
operator|->
name|client
operator|->
name|task
argument_list|,
name|resolveaddr_done
argument_list|,
operator|&
name|uctx
operator|->
name|bp4
argument_list|,
operator|&
name|uctx
operator|->
name|restrans
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|uctx
operator|->
name|bp6
operator|=
name|uctx
expr_stmt|;
name|result
operator|=
name|dns_client_startresolve
argument_list|(
name|uctx
operator|->
name|client
argument_list|,
operator|&
name|primary
argument_list|,
name|uctx
operator|->
name|rdclass
argument_list|,
name|dns_rdatatype_aaaa
argument_list|,
literal|0
argument_list|,
name|uctx
operator|->
name|client
operator|->
name|task
argument_list|,
name|resolveaddr_done
argument_list|,
operator|&
name|uctx
operator|->
name|bp6
argument_list|,
operator|&
name|uctx
operator|->
name|restrans2
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|dns_rdata_freestruct
argument_list|(
operator|&
name|soa
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|receive_soa
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_requestevent_t
modifier|*
name|reqev
init|=
name|NULL
decl_stmt|;
name|updatectx_t
modifier|*
name|uctx
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|,
name|eresult
decl_stmt|;
name|dns_request_t
modifier|*
name|request
decl_stmt|;
name|dns_message_t
modifier|*
name|rcvmsg
init|=
name|NULL
decl_stmt|;
name|dns_section_t
name|section
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|soaset
init|=
name|NULL
decl_stmt|;
name|int
name|pass
init|=
literal|0
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_message_t
modifier|*
name|soaquery
init|=
name|NULL
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|addr
decl_stmt|;
name|isc_boolean_t
name|seencname
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_boolean_t
name|droplabel
init|=
name|ISC_FALSE
decl_stmt|;
name|dns_name_t
name|tname
decl_stmt|;
name|unsigned
name|int
name|nlabels
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_REQUESTDONE
argument_list|)
expr_stmt|;
name|reqev
operator|=
operator|(
name|dns_requestevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|request
operator|=
name|reqev
operator|->
name|request
expr_stmt|;
name|result
operator|=
name|eresult
operator|=
name|reqev
operator|->
name|result
expr_stmt|;
name|POST
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|uctx
operator|=
name|reqev
operator|->
name|ev_arg
expr_stmt|;
name|client
operator|=
name|uctx
operator|->
name|client
expr_stmt|;
name|soaquery
operator|=
name|uctx
operator|->
name|soaquery
expr_stmt|;
name|addr
operator|=
name|uctx
operator|->
name|currentserver
expr_stmt|;
name|INSIST
argument_list|(
name|addr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|eresult
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|result
operator|=
name|dns_message_create
argument_list|(
name|uctx
operator|->
name|client
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|rcvmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|out
goto|;
name|result
operator|=
name|dns_request_getresponse
argument_list|(
name|request
argument_list|,
name|rcvmsg
argument_list|,
name|DNS_MESSAGEPARSE_PRESERVEORDER
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_TSIGERRORSET
condition|)
block|{
name|dns_request_t
modifier|*
name|newrequest
init|=
name|NULL
decl_stmt|;
comment|/* Retry SOA request without TSIG */
name|dns_message_destroy
argument_list|(
operator|&
name|rcvmsg
argument_list|)
expr_stmt|;
name|dns_message_renderreset
argument_list|(
name|uctx
operator|->
name|soaquery
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|uctx
operator|->
name|view
operator|->
name|requestmgr
argument_list|,
name|uctx
operator|->
name|soaquery
argument_list|,
name|NULL
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|client
operator|->
name|find_timeout
operator|*
literal|20
argument_list|,
name|client
operator|->
name|find_timeout
argument_list|,
literal|3
argument_list|,
name|uctx
operator|->
name|client
operator|->
name|task
argument_list|,
name|receive_soa
argument_list|,
name|uctx
argument_list|,
operator|&
name|newrequest
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|uctx
operator|->
name|soareq
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|soareq
operator|=
name|newrequest
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
goto|goto
name|out
goto|;
block|}
name|section
operator|=
name|DNS_SECTION_ANSWER
expr_stmt|;
name|POST
argument_list|(
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcvmsg
operator|->
name|rcode
operator|!=
name|dns_rcode_noerror
operator|&&
name|rcvmsg
operator|->
name|rcode
operator|!=
name|dns_rcode_nxdomain
condition|)
block|{
name|result
operator|=
name|rcode2result
argument_list|(
name|rcvmsg
operator|->
name|rcode
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|lookforsoa
label|:
if|if
condition|(
name|pass
operator|==
literal|0
condition|)
name|section
operator|=
name|DNS_SECTION_ANSWER
expr_stmt|;
elseif|else
if|if
condition|(
name|pass
operator|==
literal|1
condition|)
name|section
operator|=
name|DNS_SECTION_AUTHORITY
expr_stmt|;
else|else
block|{
name|droplabel
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|rcvmsg
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|pass
operator|++
expr_stmt|;
goto|goto
name|lookforsoa
goto|;
block|}
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|rcvmsg
argument_list|,
name|section
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|soaset
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_findtype
argument_list|(
name|name
argument_list|,
name|dns_rdatatype_soa
argument_list|,
literal|0
argument_list|,
operator|&
name|soaset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
if|if
condition|(
name|section
operator|==
name|DNS_SECTION_ANSWER
condition|)
block|{
name|dns_rdataset_t
modifier|*
name|tset
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|dns_message_findtype
argument_list|(
name|name
argument_list|,
name|dns_rdatatype_cname
argument_list|,
literal|0
argument_list|,
operator|&
name|tset
argument_list|)
operator|==
name|ISC_R_SUCCESS
operator|||
name|dns_message_findtype
argument_list|(
name|name
argument_list|,
name|dns_rdatatype_dname
argument_list|,
literal|0
argument_list|,
operator|&
name|tset
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|seencname
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
block|}
block|}
name|result
operator|=
name|dns_message_nextname
argument_list|(
name|rcvmsg
argument_list|,
name|section
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|soaset
operator|==
name|NULL
operator|&&
operator|!
name|seencname
condition|)
block|{
name|pass
operator|++
expr_stmt|;
goto|goto
name|lookforsoa
goto|;
block|}
if|if
condition|(
name|seencname
condition|)
block|{
name|droplabel
operator|=
name|ISC_TRUE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|result
operator|=
name|process_soa
argument_list|(
name|uctx
argument_list|,
name|soaset
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|droplabel
condition|)
block|{
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|soaquery
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|result
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|soaquery
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|nlabels
operator|=
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlabels
operator|==
literal|1
condition|)
name|result
operator|=
name|DNS_R_SERVFAIL
expr_stmt|;
comment|/* is there a better error? */
else|else
block|{
name|dns_name_init
argument_list|(
operator|&
name|tname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|name
argument_list|,
literal|1
argument_list|,
name|nlabels
operator|-
literal|1
argument_list|,
operator|&
name|tname
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|tname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|request
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|soareq
operator|=
name|NULL
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dns_message_renderreset
argument_list|(
name|soaquery
argument_list|)
expr_stmt|;
name|dns_message_settsigkey
argument_list|(
name|soaquery
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|uctx
operator|->
name|view
operator|->
name|requestmgr
argument_list|,
name|soaquery
argument_list|,
name|NULL
argument_list|,
name|uctx
operator|->
name|currentserver
argument_list|,
literal|0
argument_list|,
name|uctx
operator|->
name|tsigkey
argument_list|,
name|client
operator|->
name|find_timeout
operator|*
literal|20
argument_list|,
name|client
operator|->
name|find_timeout
argument_list|,
literal|3
argument_list|,
name|client
operator|->
name|task
argument_list|,
name|receive_soa
argument_list|,
name|uctx
argument_list|,
operator|&
name|uctx
operator|->
name|soareq
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|droplabel
operator|||
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_message_destroy
argument_list|(
operator|&
name|uctx
operator|->
name|soaquery
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dns_request_destroy
argument_list|(
operator|&
name|uctx
operator|->
name|soareq
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rcvmsg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|rcvmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|update_sendevent
argument_list|(
name|uctx
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|request_soa
parameter_list|(
name|updatectx_t
modifier|*
name|uctx
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_message_t
modifier|*
name|soaquery
init|=
name|uctx
operator|->
name|soaquery
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|soaquery
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_message_create
argument_list|(
name|uctx
operator|->
name|client
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTRENDER
argument_list|,
operator|&
name|soaquery
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
name|soaquery
operator|->
name|flags
operator||=
name|DNS_MESSAGEFLAG_RD
expr_stmt|;
name|result
operator|=
name|dns_message_gettempname
argument_list|(
name|soaquery
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|soaquery
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|dns_rdataset_makequestion
argument_list|(
name|rdataset
argument_list|,
name|uctx
operator|->
name|rdclass
argument_list|,
name|dns_rdatatype_soa
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
name|uctx
operator|->
name|firstname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|soaquery
argument_list|,
name|name
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
name|rdataset
operator|=
name|NULL
expr_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_request_createvia3
argument_list|(
name|uctx
operator|->
name|view
operator|->
name|requestmgr
argument_list|,
name|soaquery
argument_list|,
name|NULL
argument_list|,
name|uctx
operator|->
name|currentserver
argument_list|,
literal|0
argument_list|,
name|uctx
operator|->
name|tsigkey
argument_list|,
name|uctx
operator|->
name|client
operator|->
name|find_timeout
operator|*
literal|20
argument_list|,
name|uctx
operator|->
name|client
operator|->
name|find_timeout
argument_list|,
literal|3
argument_list|,
name|uctx
operator|->
name|client
operator|->
name|task
argument_list|,
name|receive_soa
argument_list|,
name|uctx
argument_list|,
operator|&
name|uctx
operator|->
name|soareq
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|uctx
operator|->
name|soaquery
operator|=
name|soaquery
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|fail
label|:
if|if
condition|(
name|rdataset
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
comment|/* for safety */
name|dns_message_puttemprdataset
argument_list|(
name|soaquery
argument_list|,
operator|&
name|rdataset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
name|dns_message_puttempname
argument_list|(
name|soaquery
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|soaquery
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|resolvesoa_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_clientresevent_t
modifier|*
name|rev
init|=
operator|(
name|dns_clientresevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|updatectx_t
modifier|*
name|uctx
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|,
name|tname
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
init|=
name|rev
operator|->
name|result
decl_stmt|;
name|unsigned
name|int
name|nlabels
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|uctx
operator|=
name|event
operator|->
name|ev_arg
expr_stmt|;
name|REQUIRE
argument_list|(
name|UCTX_VALID
argument_list|(
name|uctx
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dns_client_destroyrestrans
argument_list|(
operator|&
name|uctx
operator|->
name|restrans
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|uctx
operator|=
name|event
operator|->
name|ev_arg
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_NCACHENXDOMAIN
operator|&&
name|result
operator|!=
name|DNS_R_NCACHENXRRSET
condition|)
block|{
comment|/* XXX: what about DNSSEC failure? */
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|rev
operator|->
name|answerlist
argument_list|)
init|;
name|name
operator|!=
name|NULL
condition|;
name|name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|link
argument_list|)
control|)
block|{
for|for
control|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rdataset
operator|!=
name|NULL
condition|;
name|rdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
name|rdataset
argument_list|)
operator|&&
name|rdataset
operator|->
name|type
operator|==
name|dns_rdatatype_soa
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|rdataset
operator|==
name|NULL
condition|)
block|{
comment|/* Drop one label and retry resolution. */
name|nlabels
operator|=
name|dns_name_countlabels
argument_list|(
operator|&
name|uctx
operator|->
name|soaqname
argument_list|)
expr_stmt|;
if|if
condition|(
name|nlabels
operator|==
literal|1
condition|)
block|{
name|result
operator|=
name|DNS_R_SERVFAIL
expr_stmt|;
comment|/* is there a better error? */
goto|goto
name|out
goto|;
block|}
name|dns_name_init
argument_list|(
operator|&
name|tname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
operator|&
name|uctx
operator|->
name|soaqname
argument_list|,
literal|1
argument_list|,
name|nlabels
operator|-
literal|1
argument_list|,
operator|&
name|tname
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|tname
argument_list|,
operator|&
name|uctx
operator|->
name|soaqname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_client_startresolve
argument_list|(
name|uctx
operator|->
name|client
argument_list|,
operator|&
name|uctx
operator|->
name|soaqname
argument_list|,
name|uctx
operator|->
name|rdclass
argument_list|,
name|dns_rdatatype_soa
argument_list|,
literal|0
argument_list|,
name|uctx
operator|->
name|client
operator|->
name|task
argument_list|,
name|resolvesoa_done
argument_list|,
name|uctx
argument_list|,
operator|&
name|uctx
operator|->
name|restrans
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|process_soa
argument_list|(
name|uctx
argument_list|,
name|rdataset
argument_list|,
operator|&
name|uctx
operator|->
name|soaqname
argument_list|)
expr_stmt|;
name|out
label|:
name|dns_client_freeresanswer
argument_list|(
name|uctx
operator|->
name|client
argument_list|,
operator|&
name|rev
operator|->
name|answerlist
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|update_sendevent
argument_list|(
name|uctx
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|copy_name
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|newnamep
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_name_t
modifier|*
name|newname
init|=
name|NULL
decl_stmt|;
name|isc_region_t
name|r
decl_stmt|;
name|isc_buffer_t
modifier|*
name|namebuf
init|=
name|NULL
decl_stmt|,
modifier|*
name|rdatabuf
init|=
name|NULL
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|,
modifier|*
name|newrdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|,
modifier|*
name|newrdata
decl_stmt|;
name|result
operator|=
name|dns_message_gettempname
argument_list|(
name|msg
argument_list|,
operator|&
name|newname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|namebuf
argument_list|,
name|DNS_NAME_MAXWIRE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|dns_name_init
argument_list|(
name|newname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_setbuffer
argument_list|(
name|newname
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
name|dns_message_takebuffer
argument_list|(
name|msg
argument_list|,
operator|&
name|namebuf
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_copy
argument_list|(
name|name
argument_list|,
name|newname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rdataset
operator|!=
name|NULL
condition|;
name|rdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
control|)
block|{
name|rdatalist
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdatalist
argument_list|(
name|msg
argument_list|,
operator|&
name|rdatalist
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|dns_rdatalist_init
argument_list|(
name|rdatalist
argument_list|)
expr_stmt|;
name|rdatalist
operator|->
name|type
operator|=
name|rdataset
operator|->
name|type
expr_stmt|;
name|rdatalist
operator|->
name|rdclass
operator|=
name|rdataset
operator|->
name|rdclass
expr_stmt|;
name|rdatalist
operator|->
name|covers
operator|=
name|rdataset
operator|->
name|covers
expr_stmt|;
name|rdatalist
operator|->
name|ttl
operator|=
name|rdataset
operator|->
name|ttl
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|newrdata
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdata
argument_list|(
name|msg
argument_list|,
operator|&
name|newrdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|dns_rdata_toregion
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|rdatabuf
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|rdatabuf
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|isc_buffer_putmem
argument_list|(
name|rdatabuf
argument_list|,
name|r
operator|.
name|base
argument_list|,
name|r
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
name|rdatabuf
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|newrdata
argument_list|)
expr_stmt|;
name|dns_rdata_fromregion
argument_list|(
name|newrdata
argument_list|,
name|rdata
operator|.
name|rdclass
argument_list|,
name|rdata
operator|.
name|type
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|newrdata
operator|->
name|flags
operator|=
name|rdata
operator|.
name|flags
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|newrdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_takebuffer
argument_list|(
name|msg
argument_list|,
operator|&
name|rdatabuf
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
block|}
name|newrdataset
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_gettemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|newrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|dns_rdataset_init
argument_list|(
name|newrdataset
argument_list|)
expr_stmt|;
name|dns_rdatalist_tordataset
argument_list|(
name|rdatalist
argument_list|,
name|newrdataset
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|newname
operator|->
name|list
argument_list|,
name|newrdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
operator|*
name|newnamep
operator|=
name|newname
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|fail
label|:
name|dns_message_puttempname
argument_list|(
name|msg
argument_list|,
operator|&
name|newname
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|internal_update_callback
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|updatearg_t
modifier|*
name|uarg
init|=
name|event
operator|->
name|ev_arg
decl_stmt|;
name|dns_clientupdateevent_t
modifier|*
name|uev
init|=
operator|(
name|dns_clientupdateevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|uarg
operator|->
name|result
operator|=
name|uev
operator|->
name|result
expr_stmt|;
name|dns_client_destroyupdatetrans
argument_list|(
operator|&
name|uarg
operator|->
name|trans
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|uarg
operator|->
name|canceled
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* Exit from the internal event loop */
name|isc_app_ctxsuspend
argument_list|(
name|uarg
operator|->
name|actx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * We have already exited from the loop (due to some 		 * unexpected event).  Just clean the arg up. 		 */
name|UNLOCK
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|uarg
operator|->
name|client
operator|->
name|mctx
argument_list|,
name|uarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uarg
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_update
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_name_t
modifier|*
name|zonename
parameter_list|,
name|dns_namelist_t
modifier|*
name|prerequisites
parameter_list|,
name|dns_namelist_t
modifier|*
name|updates
parameter_list|,
name|isc_sockaddrlist_t
modifier|*
name|servers
parameter_list|,
name|dns_tsec_t
modifier|*
name|tsec
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_appctx_t
modifier|*
name|actx
decl_stmt|;
name|updatearg_t
modifier|*
name|uarg
decl_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|client
operator|->
name|attributes
operator|&
name|DNS_CLIENTATTR_OWNCTX
operator|)
operator|==
literal|0
operator|&&
operator|(
name|options
operator|&
name|DNS_CLIENTRESOPT_ALLOWRUN
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * If the client is run under application's control, we need 		 * to create a new running (sub)environment for this 		 * particular resolution. 		 */
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
comment|/* XXXTBD */
block|}
else|else
name|actx
operator|=
name|client
operator|->
name|actx
expr_stmt|;
name|uarg
operator|=
name|isc_mem_get
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uarg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uarg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|uarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uarg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|uarg
operator|->
name|actx
operator|=
name|actx
expr_stmt|;
name|uarg
operator|->
name|client
operator|=
name|client
expr_stmt|;
name|uarg
operator|->
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
name|uarg
operator|->
name|trans
operator|=
name|NULL
expr_stmt|;
name|uarg
operator|->
name|canceled
operator|=
name|ISC_FALSE
expr_stmt|;
name|result
operator|=
name|dns_client_startupdate
argument_list|(
name|client
argument_list|,
name|rdclass
argument_list|,
name|zonename
argument_list|,
name|prerequisites
argument_list|,
name|updates
argument_list|,
name|servers
argument_list|,
name|tsec
argument_list|,
name|options
argument_list|,
name|client
operator|->
name|task
argument_list|,
name|internal_update_callback
argument_list|,
name|uarg
argument_list|,
operator|&
name|uarg
operator|->
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|DESTROYLOCK
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|uarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uarg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 	 * Start internal event loop.  It blocks until the entire process 	 * is completed. 	 */
name|result
operator|=
name|isc_app_ctxrun
argument_list|(
name|actx
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|||
name|result
operator|==
name|ISC_R_SUSPEND
condition|)
name|result
operator|=
name|uarg
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|uarg
operator|->
name|trans
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Unusual termination (perhaps due to signal).  We need some 		 * tricky cleanup process. 		 */
name|uarg
operator|->
name|canceled
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_client_cancelupdate
argument_list|(
name|uarg
operator|->
name|trans
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* uarg will be freed in the event handler. */
block|}
else|else
block|{
name|UNLOCK
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|uarg
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|uarg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uarg
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_client_startupdate
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_name_t
modifier|*
name|zonename
parameter_list|,
name|dns_namelist_t
modifier|*
name|prerequisites
parameter_list|,
name|dns_namelist_t
modifier|*
name|updates
parameter_list|,
name|isc_sockaddrlist_t
modifier|*
name|servers
parameter_list|,
name|dns_tsec_t
modifier|*
name|tsec
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_clientupdatetrans_t
modifier|*
modifier|*
name|transp
parameter_list|)
block|{
name|dns_view_t
modifier|*
name|view
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|,
modifier|*
name|newname
decl_stmt|;
name|updatectx_t
modifier|*
name|uctx
decl_stmt|;
name|isc_task_t
modifier|*
name|clone
init|=
name|NULL
decl_stmt|;
name|dns_section_t
name|section
init|=
name|DNS_SECTION_UPDATE
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|server
decl_stmt|,
modifier|*
name|sa
init|=
name|NULL
decl_stmt|;
name|dns_tsectype_t
name|tsectype
init|=
name|dns_tsectype_none
decl_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|transp
operator|!=
name|NULL
operator|&&
operator|*
name|transp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|updates
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|task
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsec
operator|!=
name|NULL
condition|)
block|{
name|tsectype
operator|=
name|dns_tsec_gettype
argument_list|(
name|tsec
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsectype
operator|!=
name|dns_tsectype_tsig
condition|)
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
comment|/* XXX */
block|}
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_viewlist_find
argument_list|(
operator|&
name|client
operator|->
name|viewlist
argument_list|,
name|DNS_CLIENTVIEW_NAME
argument_list|,
name|rdclass
argument_list|,
operator|&
name|view
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* Create a context and prepare some resources */
name|uctx
operator|=
name|isc_mem_get
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|==
name|NULL
condition|)
block|{
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|uctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uctx
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|clone
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|clone
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|client
operator|=
name|client
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|uctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|state
operator|=
name|dns_clientupdatestate_prepare
expr_stmt|;
name|uctx
operator|->
name|view
operator|=
name|view
expr_stmt|;
name|uctx
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|uctx
operator|->
name|canceled
operator|=
name|ISC_FALSE
expr_stmt|;
name|uctx
operator|->
name|updatemsg
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|soaquery
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|updatereq
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|restrans
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|restrans2
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|bp4
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|bp6
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|soareq
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|event
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|tsigkey
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|sig0key
operator|=
name|NULL
expr_stmt|;
name|uctx
operator|->
name|zonename
operator|=
name|NULL
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|uctx
operator|->
name|soaqname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|uctx
operator|->
name|servers
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|nservers
operator|=
literal|0
expr_stmt|;
name|uctx
operator|->
name|currentserver
operator|=
name|NULL
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|uctx
operator|->
name|zonefname
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsec
operator|!=
name|NULL
condition|)
name|dns_tsec_getkey
argument_list|(
name|tsec
argument_list|,
operator|&
name|uctx
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|event
operator|=
operator|(
name|dns_clientupdateevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|clone
argument_list|,
name|DNS_EVENT_UPDATEDONE
argument_list|,
name|action
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uctx
operator|->
name|event
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|event
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|zonename
operator|!=
name|NULL
condition|)
block|{
name|uctx
operator|->
name|zonename
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|uctx
operator|->
name|zonefname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_copy
argument_list|(
name|zonename
argument_list|,
name|uctx
operator|->
name|zonename
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|servers
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|server
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|servers
argument_list|)
init|;
name|server
operator|!=
name|NULL
condition|;
name|server
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|server
argument_list|,
name|link
argument_list|)
control|)
block|{
name|sa
operator|=
name|isc_mem_get
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|sa
operator|->
name|type
operator|=
name|server
operator|->
name|type
expr_stmt|;
name|sa
operator|->
name|length
operator|=
name|server
operator|->
name|length
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|sa
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|uctx
operator|->
name|servers
argument_list|,
name|sa
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|currentserver
operator|==
name|NULL
condition|)
name|uctx
operator|->
name|currentserver
operator|=
name|sa
expr_stmt|;
name|uctx
operator|->
name|nservers
operator|++
expr_stmt|;
block|}
block|}
comment|/* Make update message */
name|result
operator|=
name|dns_message_create
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTRENDER
argument_list|,
operator|&
name|uctx
operator|->
name|updatemsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|uctx
operator|->
name|updatemsg
operator|->
name|opcode
operator|=
name|dns_opcode_update
expr_stmt|;
if|if
condition|(
name|prerequisites
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|prerequisites
argument_list|)
init|;
name|name
operator|!=
name|NULL
condition|;
name|name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|link
argument_list|)
control|)
block|{
name|newname
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|copy_name
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|uctx
operator|->
name|updatemsg
argument_list|,
name|name
argument_list|,
operator|&
name|newname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|dns_message_addname
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
name|newname
argument_list|,
name|DNS_SECTION_PREREQUISITE
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|name
operator|=
name|ISC_LIST_HEAD
argument_list|(
operator|*
name|updates
argument_list|)
init|;
name|name
operator|!=
name|NULL
condition|;
name|name
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|name
argument_list|,
name|link
argument_list|)
control|)
block|{
name|newname
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|copy_name
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|uctx
operator|->
name|updatemsg
argument_list|,
name|name
argument_list|,
operator|&
name|newname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|dns_message_addname
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
name|newname
argument_list|,
name|DNS_SECTION_UPDATE
argument_list|)
expr_stmt|;
block|}
name|uctx
operator|->
name|firstname
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
block|{
name|section
operator|=
name|DNS_SECTION_PREREQUISITE
expr_stmt|;
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
name|section
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|dns_message_currentname
argument_list|(
name|uctx
operator|->
name|updatemsg
argument_list|,
name|section
argument_list|,
operator|&
name|uctx
operator|->
name|firstname
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|magic
operator|=
name|UCTX_MAGIC
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|client
operator|->
name|updatectxs
argument_list|,
name|uctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|zonename
operator|!=
name|NULL
operator|&&
name|uctx
operator|->
name|currentserver
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|send_update
argument_list|(
name|uctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
block|}
elseif|else
if|if
condition|(
name|uctx
operator|->
name|currentserver
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|request_soa
argument_list|(
name|uctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
block|}
else|else
block|{
name|dns_name_clone
argument_list|(
name|uctx
operator|->
name|firstname
argument_list|,
operator|&
name|uctx
operator|->
name|soaqname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_client_startresolve
argument_list|(
name|uctx
operator|->
name|client
argument_list|,
operator|&
name|uctx
operator|->
name|soaqname
argument_list|,
name|uctx
operator|->
name|rdclass
argument_list|,
name|dns_rdatatype_soa
argument_list|,
literal|0
argument_list|,
name|client
operator|->
name|task
argument_list|,
name|resolvesoa_done
argument_list|,
name|uctx
argument_list|,
operator|&
name|uctx
operator|->
name|restrans
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|fail
goto|;
block|}
operator|*
name|transp
operator|=
operator|(
name|dns_clientupdatetrans_t
operator|*
operator|)
name|uctx
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|fail
label|:
if|if
condition|(
name|ISC_LINK_LINKED
argument_list|(
name|uctx
argument_list|,
name|link
argument_list|)
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|client
operator|->
name|updatectxs
argument_list|,
name|uctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|uctx
operator|->
name|updatemsg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|uctx
operator|->
name|updatemsg
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|sa
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|uctx
operator|->
name|servers
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|uctx
operator|->
name|servers
argument_list|,
name|sa
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|sa
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sa
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|uctx
operator|->
name|event
operator|!=
name|NULL
condition|)
name|isc_event_free
argument_list|(
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|uctx
operator|->
name|event
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|uctx
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|clone
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|client
operator|->
name|mctx
argument_list|,
name|uctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uctx
argument_list|)
argument_list|)
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|view
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_client_cancelupdate
parameter_list|(
name|dns_clientupdatetrans_t
modifier|*
name|trans
parameter_list|)
block|{
name|updatectx_t
modifier|*
name|uctx
decl_stmt|;
name|REQUIRE
argument_list|(
name|trans
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|uctx
operator|=
operator|(
name|updatectx_t
operator|*
operator|)
name|trans
expr_stmt|;
name|REQUIRE
argument_list|(
name|UCTX_VALID
argument_list|(
name|uctx
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|uctx
operator|->
name|canceled
condition|)
block|{
name|uctx
operator|->
name|canceled
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|updatereq
operator|!=
name|NULL
condition|)
name|dns_request_cancel
argument_list|(
name|uctx
operator|->
name|updatereq
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|soareq
operator|!=
name|NULL
condition|)
name|dns_request_cancel
argument_list|(
name|uctx
operator|->
name|soareq
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|restrans
operator|!=
name|NULL
condition|)
name|dns_client_cancelresolve
argument_list|(
name|uctx
operator|->
name|restrans
argument_list|)
expr_stmt|;
if|if
condition|(
name|uctx
operator|->
name|restrans2
operator|!=
name|NULL
condition|)
name|dns_client_cancelresolve
argument_list|(
name|uctx
operator|->
name|restrans2
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_client_destroyupdatetrans
parameter_list|(
name|dns_clientupdatetrans_t
modifier|*
modifier|*
name|transp
parameter_list|)
block|{
name|updatectx_t
modifier|*
name|uctx
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_client_t
modifier|*
name|client
decl_stmt|;
name|isc_boolean_t
name|need_destroyclient
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_sockaddr_t
modifier|*
name|sa
decl_stmt|;
name|REQUIRE
argument_list|(
name|transp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|uctx
operator|=
operator|(
name|updatectx_t
operator|*
operator|)
operator|*
name|transp
expr_stmt|;
name|REQUIRE
argument_list|(
name|UCTX_VALID
argument_list|(
name|uctx
argument_list|)
argument_list|)
expr_stmt|;
name|client
operator|=
name|uctx
operator|->
name|client
expr_stmt|;
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|uctx
operator|->
name|updatereq
operator|==
name|NULL
operator|&&
name|uctx
operator|->
name|updatemsg
operator|==
name|NULL
operator|&&
name|uctx
operator|->
name|soareq
operator|==
name|NULL
operator|&&
name|uctx
operator|->
name|soaquery
operator|==
name|NULL
operator|&&
name|uctx
operator|->
name|event
operator|==
name|NULL
operator|&&
name|uctx
operator|->
name|tsigkey
operator|==
name|NULL
operator|&&
name|uctx
operator|->
name|sig0key
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|client
operator|->
name|mctx
expr_stmt|;
name|dns_view_detach
argument_list|(
operator|&
name|uctx
operator|->
name|view
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|sa
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|uctx
operator|->
name|servers
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|uctx
operator|->
name|servers
argument_list|,
name|sa
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sa
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sa
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|LOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ISC_LINK_LINKED
argument_list|(
name|uctx
argument_list|,
name|link
argument_list|)
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|client
operator|->
name|updatectxs
argument_list|,
name|uctx
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|references
operator|==
literal|0
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|resctxs
argument_list|)
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|reqctxs
argument_list|)
operator|&&
name|ISC_LIST_EMPTY
argument_list|(
name|client
operator|->
name|updatectxs
argument_list|)
condition|)
name|need_destroyclient
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|client
operator|->
name|lock
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|uctx
operator|->
name|lock
argument_list|)
expr_stmt|;
name|uctx
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|uctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroyclient
condition|)
name|destroyclient
argument_list|(
operator|&
name|client
argument_list|)
expr_stmt|;
operator|*
name|transp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|isc_mem_t
modifier|*
name|dns_client_mctx
parameter_list|(
name|dns_client_t
modifier|*
name|client
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|DNS_CLIENT_VALID
argument_list|(
name|client
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|client
operator|->
name|mctx
operator|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
block|{
name|isc_buffer_t
name|buffer
decl_stmt|;
name|dns_rdataset_t
name|rdataset
decl_stmt|;
name|dns_rdatalist_t
name|rdatalist
decl_stmt|;
name|dns_rdata_t
name|rdata
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|unsigned
name|char
name|data
index|[
name|FLEXIBLE_ARRAY_MEMBER
index|]
decl_stmt|;
block|}
name|dns_client_updaterec_t
typedef|;
end_typedef

begin_function
name|isc_result_t
name|dns_client_updaterec
parameter_list|(
name|dns_client_updateop_t
name|op
parameter_list|,
name|dns_name_t
modifier|*
name|owner
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdata_t
modifier|*
name|source
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
name|dns_name_t
modifier|*
name|target
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdatalist_t
modifier|*
name|rdatalist
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|)
block|{
name|dns_client_updaterec_t
modifier|*
name|updaterec
init|=
name|NULL
decl_stmt|;
name|size_t
name|size
init|=
name|offsetof
argument_list|(
name|dns_client_updaterec_t
argument_list|,
name|data
argument_list|)
decl_stmt|;
name|REQUIRE
argument_list|(
name|op
operator|<
name|updateop_max
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|owner
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|rdataset
operator|!=
name|NULL
operator|&&
name|rdatalist
operator|!=
name|NULL
operator|&&
name|rdata
operator|!=
name|NULL
operator|)
operator|||
operator|(
name|rdataset
operator|==
name|NULL
operator|&&
name|rdatalist
operator|==
name|NULL
operator|&&
name|rdata
operator|==
name|NULL
operator|&&
name|mctx
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
name|updateop_add
condition|)
name|REQUIRE
argument_list|(
name|source
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|source
operator|!=
name|NULL
condition|)
block|{
name|REQUIRE
argument_list|(
name|source
operator|->
name|type
operator|==
name|type
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|op
operator|==
name|updateop_add
operator|||
name|op
operator|==
name|updateop_delete
operator|||
name|op
operator|==
name|updateop_exist
argument_list|)
expr_stmt|;
block|}
name|size
operator|+=
name|owner
operator|->
name|length
expr_stmt|;
if|if
condition|(
name|source
operator|!=
name|NULL
condition|)
name|size
operator|+=
name|source
operator|->
name|length
expr_stmt|;
if|if
condition|(
name|rdataset
operator|==
name|NULL
condition|)
block|{
name|updaterec
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|updaterec
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|rdataset
operator|=
operator|&
name|updaterec
operator|->
name|rdataset
expr_stmt|;
name|rdatalist
operator|=
operator|&
name|updaterec
operator|->
name|rdatalist
expr_stmt|;
name|rdata
operator|=
operator|&
name|updaterec
operator|->
name|rdata
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|dns_rdatalist_init
argument_list|(
operator|&
name|updaterec
operator|->
name|rdatalist
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
operator|&
name|updaterec
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|updaterec
operator|->
name|buffer
argument_list|,
name|updaterec
operator|->
name|data
argument_list|,
name|size
operator|-
name|offsetof
argument_list|(
name|dns_client_updaterec_t
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_copy
argument_list|(
name|owner
argument_list|,
name|target
argument_list|,
operator|&
name|updaterec
operator|->
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|source
operator|!=
name|NULL
condition|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|dns_rdata_clone
argument_list|(
name|source
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_toregion
argument_list|(
name|rdata
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|rdata
operator|->
name|data
operator|=
name|isc_buffer_used
argument_list|(
operator|&
name|updaterec
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|isc_buffer_copyregion
argument_list|(
operator|&
name|updaterec
operator|->
name|buffer
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
block|}
name|updaterec
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|updaterec
operator|->
name|mctx
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|source
operator|!=
name|NULL
condition|)
name|dns_rdata_clone
argument_list|(
name|source
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|updateop_add
case|:
break|break;
case|case
name|updateop_delete
case|:
if|if
condition|(
name|source
operator|!=
name|NULL
condition|)
block|{
name|ttl
operator|=
literal|0
expr_stmt|;
name|dns_rdata_makedelete
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
block|}
else|else
name|dns_rdata_deleterrset
argument_list|(
name|rdata
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
case|case
name|updateop_notexist
case|:
name|dns_rdata_notexist
argument_list|(
name|rdata
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
case|case
name|updateop_exist
case|:
if|if
condition|(
name|source
operator|==
name|NULL
condition|)
block|{
name|ttl
operator|=
literal|0
expr_stmt|;
name|dns_rdata_exists
argument_list|(
name|rdata
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
case|case
name|updateop_none
case|:
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|rdatalist
operator|->
name|type
operator|=
name|rdata
operator|->
name|type
expr_stmt|;
name|rdatalist
operator|->
name|rdclass
operator|=
name|rdata
operator|->
name|rdclass
expr_stmt|;
if|if
condition|(
name|source
operator|!=
name|NULL
condition|)
block|{
name|rdatalist
operator|->
name|covers
operator|=
name|dns_rdata_covers
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|rdatalist
operator|->
name|ttl
operator|=
name|ttl
expr_stmt|;
block|}
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_rdatalist_tordataset
argument_list|(
name|rdatalist
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|target
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|updaterec
operator|!=
name|NULL
condition|)
block|{
name|target
operator|->
name|attributes
operator||=
name|DNS_NAMEATTR_HASUPDATEREC
expr_stmt|;
name|dns_name_setbuffer
argument_list|(
name|target
argument_list|,
operator|&
name|updaterec
operator|->
name|buffer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|op
operator|==
name|updateop_add
operator|||
name|op
operator|==
name|updateop_delete
condition|)
name|target
operator|->
name|attributes
operator||=
name|DNS_NAMEATTR_UPDATE
expr_stmt|;
else|else
name|target
operator|->
name|attributes
operator||=
name|DNS_NAMEATTR_PREREQUISITE
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_client_freeupdate
parameter_list|(
name|dns_name_t
modifier|*
modifier|*
name|namep
parameter_list|)
block|{
name|dns_client_updaterec_t
modifier|*
name|updaterec
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdatalist
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|REQUIRE
argument_list|(
name|namep
operator|!=
name|NULL
operator|&&
operator|*
name|namep
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|name
operator|=
operator|*
name|namep
expr_stmt|;
for|for
control|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rdataset
operator|!=
name|NULL
condition|;
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
control|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|rdatalist
operator|=
name|NULL
expr_stmt|;
name|dns_rdatalist_fromrdataset
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdatalist
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdatalist
operator|==
name|NULL
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|rdata
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|)
init|;
name|rdata
operator|!=
name|NULL
condition|;
name|rdata
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|)
control|)
name|ISC_LIST_UNLINK
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|name
operator|->
name|attributes
operator|&
name|DNS_NAMEATTR_HASUPDATEREC
operator|)
operator|!=
literal|0
condition|)
block|{
name|updaterec
operator|=
operator|(
name|dns_client_updaterec_t
operator|*
operator|)
name|name
operator|->
name|buffer
expr_stmt|;
name|INSIST
argument_list|(
name|updaterec
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|isc_mem_putanddetach
argument_list|(
operator|&
name|updaterec
operator|->
name|mctx
argument_list|,
name|updaterec
argument_list|,
name|updaterec
operator|->
name|size
argument_list|)
expr_stmt|;
operator|*
name|namep
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

end_unit


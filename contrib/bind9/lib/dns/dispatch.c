begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: dispatch.c,v 1.101.2.6.2.10 2004/09/01 04:27:41 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<isc/entropy.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/mutex.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/time.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/acl.h>
end_include

begin_include
include|#
directive|include
file|<dns/dispatch.h>
end_include

begin_include
include|#
directive|include
file|<dns/events.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/message.h>
end_include

begin_include
include|#
directive|include
file|<dns/portlist.h>
end_include

begin_include
include|#
directive|include
file|<dns/tcpmsg.h>
end_include

begin_include
include|#
directive|include
file|<dns/types.h>
end_include

begin_typedef
typedef|typedef
name|ISC_LIST
argument_list|(
argument|dns_dispentry_t
argument_list|)
name|dns_displist_t
expr_stmt|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|dns_nsid
block|{
name|isc_uint16_t
name|nsid_state
decl_stmt|;
name|isc_uint16_t
modifier|*
name|nsid_vtable
decl_stmt|;
name|isc_uint16_t
modifier|*
name|nsid_pool
decl_stmt|;
name|isc_uint16_t
name|nsid_a1
decl_stmt|,
name|nsid_a2
decl_stmt|,
name|nsid_a3
decl_stmt|;
name|isc_uint16_t
name|nsid_c1
decl_stmt|,
name|nsid_c2
decl_stmt|,
name|nsid_c3
decl_stmt|;
name|isc_uint16_t
name|nsid_state2
decl_stmt|;
name|isc_boolean_t
name|nsid_usepool
decl_stmt|;
block|}
name|dns_nsid_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|dns_qid
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|unsigned
name|int
name|qid_nbuckets
decl_stmt|;
comment|/* hash table size */
name|unsigned
name|int
name|qid_increment
decl_stmt|;
comment|/* id increment on collision */
name|isc_mutex_t
name|lock
decl_stmt|;
name|dns_nsid_t
name|nsid
decl_stmt|;
name|dns_displist_t
modifier|*
name|qid_table
decl_stmt|;
comment|/* the table itself */
block|}
name|dns_qid_t
typedef|;
end_typedef

begin_struct
struct|struct
name|dns_dispatchmgr
block|{
comment|/* Unlocked. */
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_acl_t
modifier|*
name|blackhole
decl_stmt|;
name|dns_portlist_t
modifier|*
name|portlist
decl_stmt|;
comment|/* Locked by "lock". */
name|isc_mutex_t
name|lock
decl_stmt|;
name|unsigned
name|int
name|state
decl_stmt|;
name|ISC_LIST
argument_list|(
argument|dns_dispatch_t
argument_list|)
name|list
expr_stmt|;
comment|/* locked by buffer lock */
name|dns_qid_t
modifier|*
name|qid
decl_stmt|;
name|isc_mutex_t
name|buffer_lock
decl_stmt|;
name|unsigned
name|int
name|buffers
decl_stmt|;
comment|/* allocated buffers */
name|unsigned
name|int
name|buffersize
decl_stmt|;
comment|/* size of each buffer */
name|unsigned
name|int
name|maxbuffers
decl_stmt|;
comment|/* max buffers */
comment|/* Locked internally. */
name|isc_mutex_t
name|pool_lock
decl_stmt|;
name|isc_mempool_t
modifier|*
name|epool
decl_stmt|;
comment|/* memory pool for events */
name|isc_mempool_t
modifier|*
name|rpool
decl_stmt|;
comment|/* memory pool for replies */
name|isc_mempool_t
modifier|*
name|dpool
decl_stmt|;
comment|/* dispatch allocations */
name|isc_mempool_t
modifier|*
name|bpool
decl_stmt|;
comment|/* memory pool for buffers */
name|isc_entropy_t
modifier|*
name|entropy
decl_stmt|;
comment|/* entropy source */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|MGR_SHUTTINGDOWN
value|0x00000001U
end_define

begin_define
define|#
directive|define
name|MGR_IS_SHUTTINGDOWN
parameter_list|(
name|l
parameter_list|)
value|(((l)->state& MGR_SHUTTINGDOWN) != 0)
end_define

begin_define
define|#
directive|define
name|IS_PRIVATE
parameter_list|(
name|d
parameter_list|)
value|(((d)->attributes& DNS_DISPATCHATTR_PRIVATE) != 0)
end_define

begin_struct
struct|struct
name|dns_dispentry
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|dns_messageid_t
name|id
decl_stmt|;
name|unsigned
name|int
name|bucket
decl_stmt|;
name|isc_sockaddr_t
name|host
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|isc_taskaction_t
name|action
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
name|isc_boolean_t
name|item_out
decl_stmt|;
name|ISC_LIST
argument_list|(
argument|dns_dispatchevent_t
argument_list|)
name|items
expr_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_dispentry_t
argument_list|)
name|link
expr_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|INVALID_BUCKET
value|(0xffffdead)
end_define

begin_struct
struct|struct
name|dns_dispatch
block|{
comment|/* Unlocked. */
name|unsigned
name|int
name|magic
decl_stmt|;
comment|/* magic */
name|dns_dispatchmgr_t
modifier|*
name|mgr
decl_stmt|;
comment|/* dispatch manager */
name|isc_task_t
modifier|*
name|task
decl_stmt|;
comment|/* internal task */
name|isc_socket_t
modifier|*
name|socket
decl_stmt|;
comment|/* isc socket attached to */
name|isc_sockaddr_t
name|local
decl_stmt|;
comment|/* local address */
name|unsigned
name|int
name|maxrequests
decl_stmt|;
comment|/* max requests */
name|isc_event_t
modifier|*
name|ctlevent
decl_stmt|;
comment|/* Locked by mgr->lock. */
name|ISC_LINK
argument_list|(
argument|dns_dispatch_t
argument_list|)
name|link
expr_stmt|;
comment|/* Locked by "lock". */
name|isc_mutex_t
name|lock
decl_stmt|;
comment|/* locks all below */
name|isc_sockettype_t
name|socktype
decl_stmt|;
name|unsigned
name|int
name|attributes
decl_stmt|;
name|unsigned
name|int
name|refcount
decl_stmt|;
comment|/* number of users */
name|dns_dispatchevent_t
modifier|*
name|failsafe_ev
decl_stmt|;
comment|/* failsafe cancel event */
name|unsigned
name|int
name|shutting_down
range|:
literal|1
decl_stmt|,
name|shutdown_out
range|:
literal|1
decl_stmt|,
name|connected
range|:
literal|1
decl_stmt|,
name|tcpmsg_valid
range|:
literal|1
decl_stmt|,
name|recv_pending
range|:
literal|1
decl_stmt|;
comment|/* is a recv() pending? */
name|isc_result_t
name|shutdown_why
decl_stmt|;
name|unsigned
name|int
name|requests
decl_stmt|;
comment|/* how many requests we have */
name|unsigned
name|int
name|tcpbuffers
decl_stmt|;
comment|/* allocated buffers */
name|dns_tcpmsg_t
name|tcpmsg
decl_stmt|;
comment|/* for tcp streams */
name|dns_qid_t
modifier|*
name|qid
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|QID_MAGIC
value|ISC_MAGIC('Q', 'i', 'd', ' ')
end_define

begin_define
define|#
directive|define
name|VALID_QID
parameter_list|(
name|e
parameter_list|)
value|ISC_MAGIC_VALID((e), QID_MAGIC)
end_define

begin_define
define|#
directive|define
name|RESPONSE_MAGIC
value|ISC_MAGIC('D', 'r', 's', 'p')
end_define

begin_define
define|#
directive|define
name|VALID_RESPONSE
parameter_list|(
name|e
parameter_list|)
value|ISC_MAGIC_VALID((e), RESPONSE_MAGIC)
end_define

begin_define
define|#
directive|define
name|DISPATCH_MAGIC
value|ISC_MAGIC('D', 'i', 's', 'p')
end_define

begin_define
define|#
directive|define
name|VALID_DISPATCH
parameter_list|(
name|e
parameter_list|)
value|ISC_MAGIC_VALID((e), DISPATCH_MAGIC)
end_define

begin_define
define|#
directive|define
name|DNS_DISPATCHMGR_MAGIC
value|ISC_MAGIC('D', 'M', 'g', 'r')
end_define

begin_define
define|#
directive|define
name|VALID_DISPATCHMGR
parameter_list|(
name|e
parameter_list|)
value|ISC_MAGIC_VALID((e), DNS_DISPATCHMGR_MAGIC)
end_define

begin_define
define|#
directive|define
name|DNS_QID
parameter_list|(
name|disp
parameter_list|)
value|((disp)->socktype == isc_sockettype_tcp) ? \ 		       (disp)->qid : (disp)->mgr->qid
end_define

begin_comment
comment|/*  * Statics.  */
end_comment

begin_function_decl
specifier|static
name|dns_dispentry_t
modifier|*
name|bucket_search
parameter_list|(
name|dns_qid_t
modifier|*
parameter_list|,
name|isc_sockaddr_t
modifier|*
parameter_list|,
name|dns_messageid_t
parameter_list|,
name|unsigned
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_boolean_t
name|destroy_disp_ok
parameter_list|(
name|dns_dispatch_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|destroy_disp
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|udp_recv
parameter_list|(
name|isc_task_t
modifier|*
parameter_list|,
name|isc_event_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tcp_recv
parameter_list|(
name|isc_task_t
modifier|*
parameter_list|,
name|isc_event_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|startrecv
parameter_list|(
name|dns_dispatch_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|dns_messageid_t
name|dns_randomid
parameter_list|(
name|dns_nsid_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_uint32_t
name|dns_hash
parameter_list|(
name|dns_qid_t
modifier|*
parameter_list|,
name|isc_sockaddr_t
modifier|*
parameter_list|,
name|dns_messageid_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|free_buffer
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|allocate_udp_buffer
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|free_event
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|dns_dispatchevent_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|dns_dispatchevent_t
modifier|*
name|allocate_event
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_cancel
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|dns_dispentry_t
modifier|*
name|linear_first
parameter_list|(
name|dns_qid_t
modifier|*
name|disp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|dns_dispentry_t
modifier|*
name|linear_next
parameter_list|(
name|dns_qid_t
modifier|*
name|disp
parameter_list|,
name|dns_dispentry_t
modifier|*
name|resp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dispatch_free
parameter_list|(
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dispatch_createudp
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|sockmgr
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|localaddr
parameter_list|,
name|unsigned
name|int
name|maxrequests
parameter_list|,
name|unsigned
name|int
name|attributes
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_boolean_t
name|destroy_mgr_ok
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|destroy_mgr
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
modifier|*
name|mgrp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|qid_allocate
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|unsigned
name|int
name|buckets
parameter_list|,
name|unsigned
name|int
name|increment
parameter_list|,
name|isc_boolean_t
name|usepool
parameter_list|,
name|dns_qid_t
modifier|*
modifier|*
name|qidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qid_destroy
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_qid_t
modifier|*
modifier|*
name|qidp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_uint16_t
name|nsid_next
parameter_list|(
name|dns_nsid_t
modifier|*
name|nsid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|nsid_init
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_nsid_t
modifier|*
name|nsid
parameter_list|,
name|isc_boolean_t
name|usepool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsid_destroy
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_nsid_t
modifier|*
name|nsid
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|LVL
parameter_list|(
name|x
parameter_list|)
value|ISC_LOG_DEBUG(x)
end_define

begin_function_decl
specifier|static
name|void
name|mgr_log
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|3
operator|,
function_decl|4
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|mgr_log
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|msgbuf
index|[
literal|2048
index|]
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
operator|!
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
condition|)
return|return;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|msgbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|msgbuf
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DISPATCH
argument_list|,
name|DNS_LOGMODULE_DISPATCH
argument_list|,
name|level
argument_list|,
literal|"dispatchmgr %p: %s"
argument_list|,
name|mgr
argument_list|,
name|msgbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|dispatch_log
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|3
operator|,
function_decl|4
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|dispatch_log
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|msgbuf
index|[
literal|2048
index|]
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
operator|!
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
condition|)
return|return;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|msgbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|msgbuf
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DISPATCH
argument_list|,
name|DNS_LOGMODULE_DISPATCH
argument_list|,
name|level
argument_list|,
literal|"dispatch %p: %s"
argument_list|,
name|disp
argument_list|,
name|msgbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|request_log
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|dns_dispentry_t
modifier|*
name|resp
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|4
operator|,
function_decl|5
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|request_log
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|dns_dispentry_t
modifier|*
name|resp
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|msgbuf
index|[
literal|2048
index|]
decl_stmt|;
name|char
name|peerbuf
index|[
literal|256
index|]
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
operator|!
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
condition|)
return|return;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|msgbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|msgbuf
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|VALID_RESPONSE
argument_list|(
name|resp
argument_list|)
condition|)
block|{
name|isc_sockaddr_format
argument_list|(
operator|&
name|resp
operator|->
name|host
argument_list|,
name|peerbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|peerbuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DISPATCH
argument_list|,
name|DNS_LOGMODULE_DISPATCH
argument_list|,
name|level
argument_list|,
literal|"dispatch %p response %p %s: %s"
argument_list|,
name|disp
argument_list|,
name|resp
argument_list|,
name|peerbuf
argument_list|,
name|msgbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DISPATCH
argument_list|,
name|DNS_LOGMODULE_DISPATCH
argument_list|,
name|level
argument_list|,
literal|"dispatch %p req/resp %p: %s"
argument_list|,
name|disp
argument_list|,
name|resp
argument_list|,
name|msgbuf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Return an unpredictable message ID.  */
end_comment

begin_function
specifier|static
name|dns_messageid_t
name|dns_randomid
parameter_list|(
name|dns_nsid_t
modifier|*
name|nsid
parameter_list|)
block|{
name|isc_uint32_t
name|id
decl_stmt|;
name|id
operator|=
name|nsid_next
argument_list|(
name|nsid
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|dns_messageid_t
operator|)
name|id
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return a hash of the destination and message id.  */
end_comment

begin_function
specifier|static
name|isc_uint32_t
name|dns_hash
parameter_list|(
name|dns_qid_t
modifier|*
name|qid
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|dest
parameter_list|,
name|dns_messageid_t
name|id
parameter_list|)
block|{
name|unsigned
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|isc_sockaddr_hash
argument_list|(
name|dest
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|ret
operator|^=
name|id
expr_stmt|;
name|ret
operator|%=
name|qid
operator|->
name|qid_nbuckets
expr_stmt|;
name|INSIST
argument_list|(
name|ret
operator|<
name|qid
operator|->
name|qid_nbuckets
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find the first entry in 'qid'.  Returns NULL if there are no entries.  */
end_comment

begin_function
specifier|static
name|dns_dispentry_t
modifier|*
name|linear_first
parameter_list|(
name|dns_qid_t
modifier|*
name|qid
parameter_list|)
block|{
name|dns_dispentry_t
modifier|*
name|ret
decl_stmt|;
name|unsigned
name|int
name|bucket
decl_stmt|;
name|bucket
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|bucket
operator|<
name|qid
operator|->
name|qid_nbuckets
condition|)
block|{
name|ret
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|qid
operator|->
name|qid_table
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|NULL
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|bucket
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find the next entry after 'resp' in 'qid'.  Return NULL if there are  * no more entries.  */
end_comment

begin_function
specifier|static
name|dns_dispentry_t
modifier|*
name|linear_next
parameter_list|(
name|dns_qid_t
modifier|*
name|qid
parameter_list|,
name|dns_dispentry_t
modifier|*
name|resp
parameter_list|)
block|{
name|dns_dispentry_t
modifier|*
name|ret
decl_stmt|;
name|unsigned
name|int
name|bucket
decl_stmt|;
name|ret
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|resp
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|NULL
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|bucket
operator|=
name|resp
operator|->
name|bucket
expr_stmt|;
name|bucket
operator|++
expr_stmt|;
while|while
condition|(
name|bucket
operator|<
name|qid
operator|->
name|qid_nbuckets
condition|)
block|{
name|ret
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|qid
operator|->
name|qid_table
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|NULL
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|bucket
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * The dispatch must be locked.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|destroy_disp_ok
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
block|{
if|if
condition|(
name|disp
operator|->
name|refcount
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|disp
operator|->
name|recv_pending
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|disp
operator|->
name|shutting_down
operator|==
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Called when refcount reaches 0 (and safe to destroy).  *  * The dispatcher must not be locked.  * The manager must be locked.  */
end_comment

begin_function
specifier|static
name|void
name|destroy_disp
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|dns_dispatchmgr_t
modifier|*
name|mgr
decl_stmt|;
name|isc_boolean_t
name|killmgr
decl_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_DISPATCHCONTROL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|disp
operator|=
name|event
operator|->
name|ev_arg
expr_stmt|;
name|mgr
operator|=
name|disp
operator|->
name|mgr
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|mgr
operator|->
name|list
argument_list|,
name|disp
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"shutting down; detaching from sock %p, task %p"
argument_list|,
name|disp
operator|->
name|socket
argument_list|,
name|disp
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_socket_detach
argument_list|(
operator|&
name|disp
operator|->
name|socket
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|disp
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|dispatch_free
argument_list|(
operator|&
name|disp
argument_list|)
expr_stmt|;
name|killmgr
operator|=
name|destroy_mgr_ok
argument_list|(
name|mgr
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|killmgr
condition|)
name|destroy_mgr
argument_list|(
operator|&
name|mgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Find an entry for query ID 'id' and socket address 'dest' in 'qid'.  * Return NULL if no such entry exists.  */
end_comment

begin_function
specifier|static
name|dns_dispentry_t
modifier|*
name|bucket_search
parameter_list|(
name|dns_qid_t
modifier|*
name|qid
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|dest
parameter_list|,
name|dns_messageid_t
name|id
parameter_list|,
name|unsigned
name|int
name|bucket
parameter_list|)
block|{
name|dns_dispentry_t
modifier|*
name|res
decl_stmt|;
name|REQUIRE
argument_list|(
name|bucket
operator|<
name|qid
operator|->
name|qid_nbuckets
argument_list|)
expr_stmt|;
name|res
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|qid
operator|->
name|qid_table
index|[
name|bucket
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|res
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|res
operator|->
name|id
operator|==
name|id
operator|)
operator|&&
name|isc_sockaddr_equal
argument_list|(
name|dest
argument_list|,
operator|&
name|res
operator|->
name|host
argument_list|)
condition|)
return|return
operator|(
name|res
operator|)
return|;
name|res
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|res
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_buffer
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|)
block|{
name|INSIST
argument_list|(
name|buf
operator|!=
name|NULL
operator|&&
name|len
operator|!=
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|disp
operator|->
name|socktype
condition|)
block|{
case|case
name|isc_sockettype_tcp
case|:
name|INSIST
argument_list|(
name|disp
operator|->
name|tcpbuffers
operator|>
literal|0
argument_list|)
expr_stmt|;
name|disp
operator|->
name|tcpbuffers
operator|--
expr_stmt|;
name|isc_mem_put
argument_list|(
name|disp
operator|->
name|mgr
operator|->
name|mctx
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|isc_sockettype_udp
case|:
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|disp
operator|->
name|mgr
operator|->
name|buffers
operator|>
literal|0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|len
operator|==
name|disp
operator|->
name|mgr
operator|->
name|buffersize
argument_list|)
expr_stmt|;
name|disp
operator|->
name|mgr
operator|->
name|buffers
operator|--
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|disp
operator|->
name|mgr
operator|->
name|bpool
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|allocate_udp_buffer
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
block|{
name|void
modifier|*
name|temp
decl_stmt|;
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
name|temp
operator|=
name|isc_mempool_get
argument_list|(
name|disp
operator|->
name|mgr
operator|->
name|bpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|!=
name|NULL
condition|)
name|disp
operator|->
name|mgr
operator|->
name|buffers
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|temp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|free_event
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|dns_dispatchevent_t
modifier|*
name|ev
parameter_list|)
block|{
if|if
condition|(
name|disp
operator|->
name|failsafe_ev
operator|==
name|ev
condition|)
block|{
name|INSIST
argument_list|(
name|disp
operator|->
name|shutdown_out
operator|==
literal|1
argument_list|)
expr_stmt|;
name|disp
operator|->
name|shutdown_out
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|isc_mempool_put
argument_list|(
name|disp
operator|->
name|mgr
operator|->
name|epool
argument_list|,
name|ev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|dns_dispatchevent_t
modifier|*
name|allocate_event
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
block|{
name|dns_dispatchevent_t
modifier|*
name|ev
decl_stmt|;
name|ev
operator|=
name|isc_mempool_get
argument_list|(
name|disp
operator|->
name|mgr
operator|->
name|epool
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ISC_EVENT_INIT
argument_list|(
name|ev
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ev
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|ev
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * General flow:  *  * If I/O result == CANCELED or error, free the buffer.  *  * If query, free the buffer, restart.  *  * If response:  *	Allocate event, fill in details.  *		If cannot allocate, free buffer, restart.  *	find target.  If not found, free buffer, restart.  *	if event queue is not empty, queue.  else, send.  *	restart.  */
end_comment

begin_function
specifier|static
name|void
name|udp_recv
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev_in
parameter_list|)
block|{
name|isc_socketevent_t
modifier|*
name|ev
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|ev_in
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|disp
init|=
name|ev_in
operator|->
name|ev_arg
decl_stmt|;
name|dns_messageid_t
name|id
decl_stmt|;
name|isc_result_t
name|dres
decl_stmt|;
name|isc_buffer_t
name|source
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|dns_dispentry_t
modifier|*
name|resp
decl_stmt|;
name|dns_dispatchevent_t
modifier|*
name|rev
decl_stmt|;
name|unsigned
name|int
name|bucket
decl_stmt|;
name|isc_boolean_t
name|killit
decl_stmt|;
name|isc_boolean_t
name|queue_response
decl_stmt|;
name|dns_dispatchmgr_t
modifier|*
name|mgr
decl_stmt|;
name|dns_qid_t
modifier|*
name|qid
decl_stmt|;
name|isc_netaddr_t
name|netaddr
decl_stmt|;
name|int
name|match
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mgr
operator|=
name|disp
operator|->
name|mgr
expr_stmt|;
name|qid
operator|=
name|mgr
operator|->
name|qid
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"got packet: requests %d, buffers %d, recvs %d"
argument_list|,
name|disp
operator|->
name|requests
argument_list|,
name|disp
operator|->
name|mgr
operator|->
name|buffers
argument_list|,
name|disp
operator|->
name|recv_pending
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|ev_type
operator|==
name|ISC_SOCKEVENT_RECVDONE
condition|)
block|{
comment|/* 		 * Unless the receive event was imported from a listening 		 * interface, in which case the event type is 		 * DNS_EVENT_IMPORTRECVDONE, receive operation must be pending. 		 */
name|INSIST
argument_list|(
name|disp
operator|->
name|recv_pending
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|disp
operator|->
name|recv_pending
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|disp
operator|->
name|shutting_down
condition|)
block|{
comment|/* 		 * This dispatcher is shutting down. 		 */
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev_in
argument_list|)
expr_stmt|;
name|ev
operator|=
name|NULL
expr_stmt|;
name|killit
operator|=
name|destroy_disp_ok
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|killit
condition|)
name|isc_task_send
argument_list|(
name|disp
operator|->
name|task
argument_list|,
operator|&
name|disp
operator|->
name|ctlevent
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ev
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|result
operator|!=
name|ISC_R_CANCELED
condition|)
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"odd socket result in udp_recv(): %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|ev
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev_in
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * If this is from a blackholed address, drop it. 	 */
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
operator|&
name|ev
operator|->
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|mgr
operator|->
name|blackhole
operator|!=
name|NULL
operator|&&
name|dns_acl_match
argument_list|(
operator|&
name|netaddr
argument_list|,
name|NULL
argument_list|,
name|disp
operator|->
name|mgr
operator|->
name|blackhole
argument_list|,
name|NULL
argument_list|,
operator|&
name|match
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
operator|&&
name|match
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|LVL
argument_list|(
literal|10
argument_list|)
argument_list|)
condition|)
block|{
name|char
name|netaddrstr
index|[
name|ISC_NETADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_netaddr_format
argument_list|(
operator|&
name|netaddr
argument_list|,
name|netaddrstr
argument_list|,
sizeof|sizeof
argument_list|(
name|netaddrstr
argument_list|)
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|10
argument_list|)
argument_list|,
literal|"blackholed packet from %s"
argument_list|,
name|netaddrstr
argument_list|)
expr_stmt|;
block|}
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
comment|/* 	 * Peek into the buffer to see what we can see. 	 */
name|isc_buffer_init
argument_list|(
operator|&
name|source
argument_list|,
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|source
argument_list|,
name|ev
operator|->
name|n
argument_list|)
expr_stmt|;
name|dres
operator|=
name|dns_message_peekheader
argument_list|(
operator|&
name|source
argument_list|,
operator|&
name|id
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|dres
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|10
argument_list|)
argument_list|,
literal|"got garbage packet"
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|92
argument_list|)
argument_list|,
literal|"got valid DNS message header, /QR %c, id %u"
argument_list|,
operator|(
operator|(
name|flags
operator|&
name|DNS_MESSAGEFLAG_QR
operator|)
condition|?
literal|'1'
else|:
literal|'0'
operator|)
argument_list|,
name|id
argument_list|)
expr_stmt|;
comment|/* 	 * Look at flags.  If query, drop it. If response, 	 * look to see where it goes. 	 */
name|queue_response
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGEFLAG_QR
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* query */
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
name|dns_dispatch_hash
argument_list|(
operator|&
name|ev
operator|->
name|timestamp
argument_list|,
sizeof|sizeof
argument_list|(
operator|&
name|ev
operator|->
name|timestamp
argument_list|)
argument_list|)
expr_stmt|;
name|dns_dispatch_hash
argument_list|(
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
comment|/* response */
name|bucket
operator|=
name|dns_hash
argument_list|(
name|qid
argument_list|,
operator|&
name|ev
operator|->
name|address
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
name|resp
operator|=
name|bucket_search
argument_list|(
name|qid
argument_list|,
operator|&
name|ev
operator|->
name|address
argument_list|,
name|id
argument_list|,
name|bucket
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"search for response in bucket %d: %s"
argument_list|,
name|bucket
argument_list|,
operator|(
name|resp
operator|==
name|NULL
condition|?
literal|"not found"
else|:
literal|"found"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
name|queue_response
operator|=
name|resp
operator|->
name|item_out
expr_stmt|;
name|rev
operator|=
name|allocate_event
argument_list|(
name|resp
operator|->
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|==
name|NULL
condition|)
block|{
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
comment|/* 	 * At this point, rev contains the event we want to fill in, and 	 * resp contains the information on the place to send it to. 	 * Send the event off. 	 */
name|isc_buffer_init
argument_list|(
operator|&
name|rev
operator|->
name|buffer
argument_list|,
name|ev
operator|->
name|region
operator|.
name|base
argument_list|,
name|ev
operator|->
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|rev
operator|->
name|buffer
argument_list|,
name|ev
operator|->
name|n
argument_list|)
expr_stmt|;
name|rev
operator|->
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|rev
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|rev
operator|->
name|addr
operator|=
name|ev
operator|->
name|address
expr_stmt|;
name|rev
operator|->
name|pktinfo
operator|=
name|ev
operator|->
name|pktinfo
expr_stmt|;
name|rev
operator|->
name|attributes
operator|=
name|ev
operator|->
name|attributes
expr_stmt|;
if|if
condition|(
name|queue_response
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|resp
operator|->
name|items
argument_list|,
name|rev
argument_list|,
name|ev_link
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISC_EVENT_INIT
argument_list|(
name|rev
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rev
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|DNS_EVENT_DISPATCH
argument_list|,
name|resp
operator|->
name|action
argument_list|,
name|resp
operator|->
name|arg
argument_list|,
name|resp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|request_log
argument_list|(
name|disp
argument_list|,
name|resp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"[a] Sent event %p buffer %p len %d to task %p"
argument_list|,
name|rev
argument_list|,
name|rev
operator|->
name|buffer
operator|.
name|base
argument_list|,
name|rev
operator|->
name|buffer
operator|.
name|length
argument_list|,
name|resp
operator|->
name|task
argument_list|)
expr_stmt|;
name|resp
operator|->
name|item_out
operator|=
name|ISC_TRUE
expr_stmt|;
name|isc_task_send
argument_list|(
name|resp
operator|->
name|task
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|rev
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|unlock
label|:
name|UNLOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 	 * Restart recv() to get the next packet. 	 */
name|restart
label|:
name|startrecv
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev_in
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * General flow:  *  * If I/O result == CANCELED, EOF, or error, notify everyone as the  * various queues drain.  *  * If query, restart.  *  * If response:  *	Allocate event, fill in details.  *		If cannot allocate, restart.  *	find target.  If not found, restart.  *	if event queue is not empty, queue.  else, send.  *	restart.  */
end_comment

begin_function
specifier|static
name|void
name|tcp_recv
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev_in
parameter_list|)
block|{
name|dns_dispatch_t
modifier|*
name|disp
init|=
name|ev_in
operator|->
name|ev_arg
decl_stmt|;
name|dns_tcpmsg_t
modifier|*
name|tcpmsg
init|=
operator|&
name|disp
operator|->
name|tcpmsg
decl_stmt|;
name|dns_messageid_t
name|id
decl_stmt|;
name|isc_result_t
name|dres
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|dns_dispentry_t
modifier|*
name|resp
decl_stmt|;
name|dns_dispatchevent_t
modifier|*
name|rev
decl_stmt|;
name|unsigned
name|int
name|bucket
decl_stmt|;
name|isc_boolean_t
name|killit
decl_stmt|;
name|isc_boolean_t
name|queue_response
decl_stmt|;
name|dns_qid_t
modifier|*
name|qid
decl_stmt|;
name|int
name|level
decl_stmt|;
name|char
name|buf
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
name|qid
operator|=
name|disp
operator|->
name|qid
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"got TCP packet: requests %d, buffers %d, recvs %d"
argument_list|,
name|disp
operator|->
name|requests
argument_list|,
name|disp
operator|->
name|tcpbuffers
argument_list|,
name|disp
operator|->
name|recv_pending
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|disp
operator|->
name|recv_pending
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|disp
operator|->
name|recv_pending
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|refcount
operator|==
literal|0
condition|)
block|{
comment|/* 		 * This dispatcher is shutting down.  Force cancelation. 		 */
name|tcpmsg
operator|->
name|result
operator|=
name|ISC_R_CANCELED
expr_stmt|;
block|}
if|if
condition|(
name|tcpmsg
operator|->
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
switch|switch
condition|(
name|tcpmsg
operator|->
name|result
condition|)
block|{
case|case
name|ISC_R_CANCELED
case|:
break|break;
case|case
name|ISC_R_EOF
case|:
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"shutting down on EOF"
argument_list|)
expr_stmt|;
name|do_cancel
argument_list|(
name|disp
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISC_R_CONNECTIONRESET
case|:
name|level
operator|=
name|ISC_LOG_INFO
expr_stmt|;
goto|goto
name|logit
goto|;
default|default:
name|level
operator|=
name|ISC_LOG_ERROR
expr_stmt|;
name|logit
label|:
name|isc_sockaddr_format
argument_list|(
operator|&
name|tcpmsg
operator|->
name|address
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|level
argument_list|,
literal|"shutting down due to TCP "
literal|"receive error: %s: %s"
argument_list|,
name|buf
argument_list|,
name|isc_result_totext
argument_list|(
name|tcpmsg
operator|->
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|do_cancel
argument_list|(
name|disp
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 		 * The event is statically allocated in the tcpmsg 		 * structure, and destroy_disp() frees the tcpmsg, so we must 		 * free the event *before* calling destroy_disp(). 		 */
name|isc_event_free
argument_list|(
operator|&
name|ev_in
argument_list|)
expr_stmt|;
name|disp
operator|->
name|shutting_down
operator|=
literal|1
expr_stmt|;
name|disp
operator|->
name|shutdown_why
operator|=
name|tcpmsg
operator|->
name|result
expr_stmt|;
comment|/* 		 * If the recv() was canceled pass the word on. 		 */
name|killit
operator|=
name|destroy_disp_ok
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|killit
condition|)
name|isc_task_send
argument_list|(
name|disp
operator|->
name|task
argument_list|,
operator|&
name|disp
operator|->
name|ctlevent
argument_list|)
expr_stmt|;
return|return;
block|}
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"result %d, length == %d, addr = %p"
argument_list|,
name|tcpmsg
operator|->
name|result
argument_list|,
name|tcpmsg
operator|->
name|buffer
operator|.
name|length
argument_list|,
name|tcpmsg
operator|->
name|buffer
operator|.
name|base
argument_list|)
expr_stmt|;
comment|/* 	 * Peek into the buffer to see what we can see. 	 */
name|dres
operator|=
name|dns_message_peekheader
argument_list|(
operator|&
name|tcpmsg
operator|->
name|buffer
argument_list|,
operator|&
name|id
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|dres
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|10
argument_list|)
argument_list|,
literal|"got garbage packet"
argument_list|)
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|92
argument_list|)
argument_list|,
literal|"got valid DNS message header, /QR %c, id %u"
argument_list|,
operator|(
operator|(
name|flags
operator|&
name|DNS_MESSAGEFLAG_QR
operator|)
condition|?
literal|'1'
else|:
literal|'0'
operator|)
argument_list|,
name|id
argument_list|)
expr_stmt|;
comment|/* 	 * Allocate an event to send to the query or response client, and 	 * allocate a new buffer for our use. 	 */
comment|/* 	 * Look at flags.  If query, drop it. If response, 	 * look to see where it goes. 	 */
name|queue_response
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|DNS_MESSAGEFLAG_QR
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Query. 		 */
goto|goto
name|restart
goto|;
block|}
name|dns_dispatch_hash
argument_list|(
name|tcpmsg
operator|->
name|buffer
operator|.
name|base
argument_list|,
name|tcpmsg
operator|->
name|buffer
operator|.
name|length
argument_list|)
expr_stmt|;
comment|/* 	 * Response. 	 */
name|bucket
operator|=
name|dns_hash
argument_list|(
name|qid
argument_list|,
operator|&
name|tcpmsg
operator|->
name|address
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
name|resp
operator|=
name|bucket_search
argument_list|(
name|qid
argument_list|,
operator|&
name|tcpmsg
operator|->
name|address
argument_list|,
name|id
argument_list|,
name|bucket
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"search for response in bucket %d: %s"
argument_list|,
name|bucket
argument_list|,
operator|(
name|resp
operator|==
name|NULL
condition|?
literal|"not found"
else|:
literal|"found"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
goto|goto
name|unlock
goto|;
name|queue_response
operator|=
name|resp
operator|->
name|item_out
expr_stmt|;
name|rev
operator|=
name|allocate_event
argument_list|(
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|==
name|NULL
condition|)
goto|goto
name|unlock
goto|;
comment|/* 	 * At this point, rev contains the event we want to fill in, and 	 * resp contains the information on the place to send it to. 	 * Send the event off. 	 */
name|dns_tcpmsg_keepbuffer
argument_list|(
name|tcpmsg
argument_list|,
operator|&
name|rev
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|disp
operator|->
name|tcpbuffers
operator|++
expr_stmt|;
name|rev
operator|->
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|rev
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|rev
operator|->
name|addr
operator|=
name|tcpmsg
operator|->
name|address
expr_stmt|;
if|if
condition|(
name|queue_response
condition|)
block|{
name|ISC_LIST_APPEND
argument_list|(
name|resp
operator|->
name|items
argument_list|,
name|rev
argument_list|,
name|ev_link
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ISC_EVENT_INIT
argument_list|(
name|rev
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rev
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|DNS_EVENT_DISPATCH
argument_list|,
name|resp
operator|->
name|action
argument_list|,
name|resp
operator|->
name|arg
argument_list|,
name|resp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|request_log
argument_list|(
name|disp
argument_list|,
name|resp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"[b] Sent event %p buffer %p len %d to task %p"
argument_list|,
name|rev
argument_list|,
name|rev
operator|->
name|buffer
operator|.
name|base
argument_list|,
name|rev
operator|->
name|buffer
operator|.
name|length
argument_list|,
name|resp
operator|->
name|task
argument_list|)
expr_stmt|;
name|resp
operator|->
name|item_out
operator|=
name|ISC_TRUE
expr_stmt|;
name|isc_task_send
argument_list|(
name|resp
operator|->
name|task
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|rev
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|unlock
label|:
name|UNLOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 	 * Restart recv() to get the next packet. 	 */
name|restart
label|:
name|startrecv
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev_in
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * disp must be locked.  */
end_comment

begin_function
specifier|static
name|void
name|startrecv
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
block|{
name|isc_result_t
name|res
decl_stmt|;
name|isc_region_t
name|region
decl_stmt|;
if|if
condition|(
name|disp
operator|->
name|shutting_down
operator|==
literal|1
condition|)
return|return;
if|if
condition|(
operator|(
name|disp
operator|->
name|attributes
operator|&
name|DNS_DISPATCHATTR_NOLISTEN
operator|)
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
name|disp
operator|->
name|recv_pending
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
name|disp
operator|->
name|mgr
operator|->
name|buffers
operator|>=
name|disp
operator|->
name|mgr
operator|->
name|maxbuffers
condition|)
return|return;
switch|switch
condition|(
name|disp
operator|->
name|socktype
condition|)
block|{
comment|/* 		 * UDP reads are always maximal. 		 */
case|case
name|isc_sockettype_udp
case|:
name|region
operator|.
name|length
operator|=
name|disp
operator|->
name|mgr
operator|->
name|buffersize
expr_stmt|;
name|region
operator|.
name|base
operator|=
name|allocate_udp_buffer
argument_list|(
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|region
operator|.
name|base
operator|==
name|NULL
condition|)
return|return;
name|res
operator|=
name|isc_socket_recv
argument_list|(
name|disp
operator|->
name|socket
argument_list|,
operator|&
name|region
argument_list|,
literal|1
argument_list|,
name|disp
operator|->
name|task
argument_list|,
name|udp_recv
argument_list|,
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|region
operator|.
name|base
argument_list|,
name|region
operator|.
name|length
argument_list|)
expr_stmt|;
name|disp
operator|->
name|shutdown_why
operator|=
name|res
expr_stmt|;
name|disp
operator|->
name|shutting_down
operator|=
literal|1
expr_stmt|;
name|do_cancel
argument_list|(
name|disp
argument_list|)
expr_stmt|;
return|return;
block|}
name|INSIST
argument_list|(
name|disp
operator|->
name|recv_pending
operator|==
literal|0
argument_list|)
expr_stmt|;
name|disp
operator|->
name|recv_pending
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|isc_sockettype_tcp
case|:
name|res
operator|=
name|dns_tcpmsg_readmessage
argument_list|(
operator|&
name|disp
operator|->
name|tcpmsg
argument_list|,
name|disp
operator|->
name|task
argument_list|,
name|tcp_recv
argument_list|,
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|disp
operator|->
name|shutdown_why
operator|=
name|res
expr_stmt|;
name|disp
operator|->
name|shutting_down
operator|=
literal|1
expr_stmt|;
name|do_cancel
argument_list|(
name|disp
argument_list|)
expr_stmt|;
return|return;
block|}
name|INSIST
argument_list|(
name|disp
operator|->
name|recv_pending
operator|==
literal|0
argument_list|)
expr_stmt|;
name|disp
operator|->
name|recv_pending
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Mgr must be locked when calling this function.  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|destroy_mgr_ok
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|)
block|{
name|mgr_log
argument_list|(
name|mgr
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"destroy_mgr_ok: shuttingdown=%d, listnonempty=%d, "
literal|"epool=%d, rpool=%d, dpool=%d"
argument_list|,
name|MGR_IS_SHUTTINGDOWN
argument_list|(
name|mgr
argument_list|)
argument_list|,
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|mgr
operator|->
name|list
argument_list|)
argument_list|,
name|isc_mempool_getallocated
argument_list|(
name|mgr
operator|->
name|epool
argument_list|)
argument_list|,
name|isc_mempool_getallocated
argument_list|(
name|mgr
operator|->
name|rpool
argument_list|)
argument_list|,
name|isc_mempool_getallocated
argument_list|(
name|mgr
operator|->
name|dpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|MGR_IS_SHUTTINGDOWN
argument_list|(
name|mgr
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|mgr
operator|->
name|list
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|isc_mempool_getallocated
argument_list|(
name|mgr
operator|->
name|epool
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|isc_mempool_getallocated
argument_list|(
name|mgr
operator|->
name|rpool
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|isc_mempool_getallocated
argument_list|(
name|mgr
operator|->
name|dpool
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Mgr must be unlocked when calling this function.  */
end_comment

begin_function
specifier|static
name|void
name|destroy_mgr
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
modifier|*
name|mgrp
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_dispatchmgr_t
modifier|*
name|mgr
decl_stmt|;
name|mgr
operator|=
operator|*
name|mgrp
expr_stmt|;
operator|*
name|mgrp
operator|=
name|NULL
expr_stmt|;
name|mctx
operator|=
name|mgr
operator|->
name|mctx
expr_stmt|;
name|mgr
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|mgr
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mgr
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|mgr
operator|->
name|epool
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|mgr
operator|->
name|rpool
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|mgr
operator|->
name|dpool
argument_list|)
expr_stmt|;
name|isc_mempool_destroy
argument_list|(
operator|&
name|mgr
operator|->
name|bpool
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgr
operator|->
name|entropy
operator|!=
name|NULL
condition|)
name|isc_entropy_detach
argument_list|(
operator|&
name|mgr
operator|->
name|entropy
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgr
operator|->
name|qid
operator|!=
name|NULL
condition|)
name|qid_destroy
argument_list|(
name|mctx
argument_list|,
operator|&
name|mgr
operator|->
name|qid
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgr
operator|->
name|blackhole
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|mgr
operator|->
name|blackhole
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgr
operator|->
name|portlist
operator|!=
name|NULL
condition|)
name|dns_portlist_detach
argument_list|(
operator|&
name|mgr
operator|->
name|portlist
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|mgr
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_dispatchmgr_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|create_socket
parameter_list|(
name|isc_socketmgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|local
parameter_list|,
name|isc_socket_t
modifier|*
modifier|*
name|sockp
parameter_list|)
block|{
name|isc_socket_t
modifier|*
name|sock
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|sock
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_socket_create
argument_list|(
name|mgr
argument_list|,
name|isc_sockaddr_pf
argument_list|(
name|local
argument_list|)
argument_list|,
name|isc_sockettype_udp
argument_list|,
operator|&
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
ifndef|#
directive|ifndef
name|ISC_ALLOW_MAPPED
name|isc_socket_ipv6only
argument_list|(
name|sock
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|result
operator|=
name|isc_socket_bind
argument_list|(
name|sock
argument_list|,
name|local
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_socket_detach
argument_list|(
operator|&
name|sock
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
operator|*
name|sockp
operator|=
name|sock
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Publics.  */
end_comment

begin_function
name|isc_result_t
name|dns_dispatchmgr_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_entropy_t
modifier|*
name|entropy
parameter_list|,
name|dns_dispatchmgr_t
modifier|*
modifier|*
name|mgrp
parameter_list|)
block|{
name|dns_dispatchmgr_t
modifier|*
name|mgr
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|mgrp
operator|!=
name|NULL
operator|&&
operator|*
name|mgrp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|mgr
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_dispatchmgr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|mgr
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|mgr
operator|->
name|mctx
argument_list|)
expr_stmt|;
name|mgr
operator|->
name|blackhole
operator|=
name|NULL
expr_stmt|;
name|mgr
operator|->
name|portlist
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|deallocate
goto|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|kill_lock
goto|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|mgr
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|kill_buffer_lock
goto|;
name|mgr
operator|->
name|epool
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|isc_mempool_create
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_dispatchevent_t
argument_list|)
argument_list|,
operator|&
name|mgr
operator|->
name|epool
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|kill_pool_lock
goto|;
block|}
name|mgr
operator|->
name|rpool
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|isc_mempool_create
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_dispentry_t
argument_list|)
argument_list|,
operator|&
name|mgr
operator|->
name|rpool
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|kill_epool
goto|;
block|}
name|mgr
operator|->
name|dpool
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|isc_mempool_create
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_dispatch_t
argument_list|)
argument_list|,
operator|&
name|mgr
operator|->
name|dpool
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|kill_rpool
goto|;
block|}
name|isc_mempool_setname
argument_list|(
name|mgr
operator|->
name|epool
argument_list|,
literal|"dispmgr_epool"
argument_list|)
expr_stmt|;
name|isc_mempool_setfreemax
argument_list|(
name|mgr
operator|->
name|epool
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|isc_mempool_associatelock
argument_list|(
name|mgr
operator|->
name|epool
argument_list|,
operator|&
name|mgr
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
name|isc_mempool_setname
argument_list|(
name|mgr
operator|->
name|rpool
argument_list|,
literal|"dispmgr_rpool"
argument_list|)
expr_stmt|;
name|isc_mempool_setfreemax
argument_list|(
name|mgr
operator|->
name|rpool
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|isc_mempool_associatelock
argument_list|(
name|mgr
operator|->
name|rpool
argument_list|,
operator|&
name|mgr
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
name|isc_mempool_setname
argument_list|(
name|mgr
operator|->
name|dpool
argument_list|,
literal|"dispmgr_dpool"
argument_list|)
expr_stmt|;
name|isc_mempool_setfreemax
argument_list|(
name|mgr
operator|->
name|dpool
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|isc_mempool_associatelock
argument_list|(
name|mgr
operator|->
name|dpool
argument_list|,
operator|&
name|mgr
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
name|mgr
operator|->
name|buffers
operator|=
literal|0
expr_stmt|;
name|mgr
operator|->
name|buffersize
operator|=
literal|0
expr_stmt|;
name|mgr
operator|->
name|maxbuffers
operator|=
literal|0
expr_stmt|;
name|mgr
operator|->
name|bpool
operator|=
name|NULL
expr_stmt|;
name|mgr
operator|->
name|entropy
operator|=
name|NULL
expr_stmt|;
name|mgr
operator|->
name|qid
operator|=
name|NULL
expr_stmt|;
name|mgr
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|mgr
operator|->
name|list
argument_list|)
expr_stmt|;
name|mgr
operator|->
name|magic
operator|=
name|DNS_DISPATCHMGR_MAGIC
expr_stmt|;
if|if
condition|(
name|entropy
operator|!=
name|NULL
condition|)
name|isc_entropy_attach
argument_list|(
name|entropy
argument_list|,
operator|&
name|mgr
operator|->
name|entropy
argument_list|)
expr_stmt|;
operator|*
name|mgrp
operator|=
name|mgr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|kill_rpool
label|:
name|isc_mempool_destroy
argument_list|(
operator|&
name|mgr
operator|->
name|rpool
argument_list|)
expr_stmt|;
name|kill_epool
label|:
name|isc_mempool_destroy
argument_list|(
operator|&
name|mgr
operator|->
name|epool
argument_list|)
expr_stmt|;
name|kill_pool_lock
label|:
name|DESTROYLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
name|kill_buffer_lock
label|:
name|DESTROYLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
name|kill_lock
label|:
name|DESTROYLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|deallocate
label|:
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|mgr
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_dispatchmgr_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_dispatchmgr_setblackhole
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|dns_acl_t
modifier|*
name|blackhole
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgr
operator|->
name|blackhole
operator|!=
name|NULL
condition|)
name|dns_acl_detach
argument_list|(
operator|&
name|mgr
operator|->
name|blackhole
argument_list|)
expr_stmt|;
name|dns_acl_attach
argument_list|(
name|blackhole
argument_list|,
operator|&
name|mgr
operator|->
name|blackhole
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|dns_acl_t
modifier|*
name|dns_dispatchmgr_getblackhole
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|mgr
operator|->
name|blackhole
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_dispatchmgr_setblackportlist
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|dns_portlist_t
modifier|*
name|portlist
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgr
operator|->
name|portlist
operator|!=
name|NULL
condition|)
name|dns_portlist_detach
argument_list|(
operator|&
name|mgr
operator|->
name|portlist
argument_list|)
expr_stmt|;
if|if
condition|(
name|portlist
operator|!=
name|NULL
condition|)
name|dns_portlist_attach
argument_list|(
name|portlist
argument_list|,
operator|&
name|mgr
operator|->
name|portlist
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|dns_portlist_t
modifier|*
name|dns_dispatchmgr_getblackportlist
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|mgr
operator|->
name|portlist
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dns_dispatchmgr_setudp
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|unsigned
name|int
name|buffersize
parameter_list|,
name|unsigned
name|int
name|maxbuffers
parameter_list|,
name|unsigned
name|int
name|buckets
parameter_list|,
name|unsigned
name|int
name|increment
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|buffersize
operator|>=
literal|512
operator|&&
name|buffersize
operator|<
operator|(
literal|64
operator|*
literal|1024
operator|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|maxbuffers
operator|>
literal|0
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|buckets
operator|<
literal|2097169
argument_list|)
expr_stmt|;
comment|/* next prime> 65536 * 32 */
name|REQUIRE
argument_list|(
name|increment
operator|>
name|buckets
argument_list|)
expr_stmt|;
comment|/* 	 * Keep some number of items around.  This should be a config 	 * option.  For now, keep 8, but later keep at least two even 	 * if the caller wants less.  This allows us to ensure certain 	 * things, like an event can be "freed" and the next allocation 	 * will always succeed. 	 * 	 * Note that if limits are placed on anything here, we use one 	 * event internally, so the actual limit should be "wanted + 1." 	 * 	 * XXXMLG 	 */
if|if
condition|(
name|maxbuffers
operator|<
literal|8
condition|)
name|maxbuffers
operator|=
literal|8
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgr
operator|->
name|bpool
operator|!=
name|NULL
condition|)
block|{
name|isc_mempool_setmaxalloc
argument_list|(
name|mgr
operator|->
name|bpool
argument_list|,
name|maxbuffers
argument_list|)
expr_stmt|;
name|mgr
operator|->
name|maxbuffers
operator|=
name|maxbuffers
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
if|if
condition|(
name|isc_mempool_create
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|buffersize
argument_list|,
operator|&
name|mgr
operator|->
name|bpool
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|isc_mempool_setname
argument_list|(
name|mgr
operator|->
name|bpool
argument_list|,
literal|"dispmgr_bpool"
argument_list|)
expr_stmt|;
name|isc_mempool_setmaxalloc
argument_list|(
name|mgr
operator|->
name|bpool
argument_list|,
name|maxbuffers
argument_list|)
expr_stmt|;
name|isc_mempool_associatelock
argument_list|(
name|mgr
operator|->
name|bpool
argument_list|,
operator|&
name|mgr
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
name|result
operator|=
name|qid_allocate
argument_list|(
name|mgr
argument_list|,
name|buckets
argument_list|,
name|increment
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|mgr
operator|->
name|qid
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup
goto|;
name|mgr
operator|->
name|buffersize
operator|=
name|buffersize
expr_stmt|;
name|mgr
operator|->
name|maxbuffers
operator|=
name|maxbuffers
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup
label|:
name|isc_mempool_destroy
argument_list|(
operator|&
name|mgr
operator|->
name|bpool
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|buffer_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_dispatchmgr_destroy
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
modifier|*
name|mgrp
parameter_list|)
block|{
name|dns_dispatchmgr_t
modifier|*
name|mgr
decl_stmt|;
name|isc_boolean_t
name|killit
decl_stmt|;
name|REQUIRE
argument_list|(
name|mgrp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
operator|*
name|mgrp
argument_list|)
argument_list|)
expr_stmt|;
name|mgr
operator|=
operator|*
name|mgrp
expr_stmt|;
operator|*
name|mgrp
operator|=
name|NULL
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mgr
operator|->
name|state
operator||=
name|MGR_SHUTTINGDOWN
expr_stmt|;
name|killit
operator|=
name|destroy_mgr_ok
argument_list|(
name|mgr
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mgr_log
argument_list|(
name|mgr
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"destroy: killit=%d"
argument_list|,
name|killit
argument_list|)
expr_stmt|;
if|if
condition|(
name|killit
condition|)
name|destroy_mgr
argument_list|(
operator|&
name|mgr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|blacklisted
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_socket_t
modifier|*
name|sock
parameter_list|)
block|{
name|isc_sockaddr_t
name|sockaddr
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|mgr
operator|->
name|portlist
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
name|result
operator|=
name|isc_socket_getsockname
argument_list|(
name|sock
argument_list|,
operator|&
name|sockaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|mgr
operator|->
name|portlist
operator|!=
name|NULL
operator|&&
name|dns_portlist_match
argument_list|(
name|mgr
operator|->
name|portlist
argument_list|,
name|isc_sockaddr_pf
argument_list|(
operator|&
name|sockaddr
argument_list|)
argument_list|,
name|isc_sockaddr_getport
argument_list|(
operator|&
name|sockaddr
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ATTRMATCH
parameter_list|(
name|_a1
parameter_list|,
name|_a2
parameter_list|,
name|_mask
parameter_list|)
value|(((_a1)& (_mask)) == ((_a2)& (_mask)))
end_define

begin_function
specifier|static
name|isc_boolean_t
name|local_addr_match
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addr
parameter_list|)
block|{
name|isc_sockaddr_t
name|sockaddr
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
comment|/* 	 * Don't match wildcard ports against newly blacklisted ports. 	 */
if|if
condition|(
name|disp
operator|->
name|mgr
operator|->
name|portlist
operator|!=
name|NULL
operator|&&
name|isc_sockaddr_getport
argument_list|(
name|addr
argument_list|)
operator|==
literal|0
operator|&&
name|isc_sockaddr_getport
argument_list|(
operator|&
name|disp
operator|->
name|local
argument_list|)
operator|==
literal|0
operator|&&
name|blacklisted
argument_list|(
name|disp
operator|->
name|mgr
argument_list|,
name|disp
operator|->
name|socket
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
comment|/* 	 * Check if we match the binding<address,port>. 	 * Wildcard ports match/fail here. 	 */
if|if
condition|(
name|isc_sockaddr_equal
argument_list|(
operator|&
name|disp
operator|->
name|local
argument_list|,
name|addr
argument_list|)
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
name|addr
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
comment|/* 	 * Check if we match a bound wildcard port<address,port>. 	 */
if|if
condition|(
operator|!
name|isc_sockaddr_eqaddr
argument_list|(
operator|&
name|disp
operator|->
name|local
argument_list|,
name|addr
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
name|result
operator|=
name|isc_socket_getsockname
argument_list|(
name|disp
operator|->
name|socket
argument_list|,
operator|&
name|sockaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|isc_sockaddr_equal
argument_list|(
operator|&
name|sockaddr
argument_list|,
name|addr
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Requires mgr be locked.  *  * No dispatcher can be locked by this thread when calling this function.  *  *  * NOTE:  *	If a matching dispatcher is found, it is locked after this function  *	returns, and must be unlocked by the caller.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|dispatch_find
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|local
parameter_list|,
name|unsigned
name|int
name|attributes
parameter_list|,
name|unsigned
name|int
name|mask
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
block|{
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * Make certain that we will not match a private dispatch. 	 */
name|attributes
operator|&=
operator|~
name|DNS_DISPATCHATTR_PRIVATE
expr_stmt|;
name|mask
operator||=
name|DNS_DISPATCHATTR_PRIVATE
expr_stmt|;
name|disp
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|mgr
operator|->
name|list
argument_list|)
expr_stmt|;
while|while
condition|(
name|disp
operator|!=
name|NULL
condition|)
block|{
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|disp
operator|->
name|shutting_down
operator|==
literal|0
operator|)
operator|&&
name|ATTRMATCH
argument_list|(
name|disp
operator|->
name|attributes
argument_list|,
name|attributes
argument_list|,
name|mask
argument_list|)
operator|&&
name|local_addr_match
argument_list|(
name|disp
argument_list|,
name|local
argument_list|)
condition|)
break|break;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|disp
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|disp
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|disp
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|dispp
operator|=
name|disp
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|out
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|qid_allocate
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|unsigned
name|int
name|buckets
parameter_list|,
name|unsigned
name|int
name|increment
parameter_list|,
name|isc_boolean_t
name|usepool
parameter_list|,
name|dns_qid_t
modifier|*
modifier|*
name|qidp
parameter_list|)
block|{
name|dns_qid_t
modifier|*
name|qid
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|buckets
operator|<
literal|2097169
argument_list|)
expr_stmt|;
comment|/* next prime> 65536 * 32 */
name|REQUIRE
argument_list|(
name|increment
operator|>
name|buckets
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|qidp
operator|!=
name|NULL
operator|&&
operator|*
name|qidp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|qid
operator|=
name|isc_mem_get
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|qid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qid
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|qid
operator|->
name|qid_table
operator|=
name|isc_mem_get
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|buckets
operator|*
sizeof|sizeof
argument_list|(
name|dns_displist_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qid
operator|->
name|qid_table
operator|==
name|NULL
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|qid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|qid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
if|if
condition|(
name|nsid_init
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
operator|&
name|qid
operator|->
name|nsid
argument_list|,
name|usepool
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|qid
operator|->
name|qid_table
argument_list|,
name|buckets
operator|*
sizeof|sizeof
argument_list|(
name|dns_displist_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|qid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|qid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
if|if
condition|(
name|isc_mutex_init
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init failed"
argument_list|)
expr_stmt|;
name|nsid_destroy
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
operator|&
name|qid
operator|->
name|nsid
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|qid
operator|->
name|qid_table
argument_list|,
name|buckets
operator|*
sizeof|sizeof
argument_list|(
name|dns_displist_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|qid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|qid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_UNEXPECTED
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|buckets
condition|;
name|i
operator|++
control|)
name|ISC_LIST_INIT
argument_list|(
name|qid
operator|->
name|qid_table
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|qid
operator|->
name|qid_nbuckets
operator|=
name|buckets
expr_stmt|;
name|qid
operator|->
name|qid_increment
operator|=
name|increment
expr_stmt|;
name|qid
operator|->
name|magic
operator|=
name|QID_MAGIC
expr_stmt|;
operator|*
name|qidp
operator|=
name|qid
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qid_destroy
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_qid_t
modifier|*
modifier|*
name|qidp
parameter_list|)
block|{
name|dns_qid_t
modifier|*
name|qid
decl_stmt|;
name|REQUIRE
argument_list|(
name|qidp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|qid
operator|=
operator|*
name|qidp
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_QID
argument_list|(
name|qid
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|qidp
operator|=
name|NULL
expr_stmt|;
name|qid
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|nsid_destroy
argument_list|(
name|mctx
argument_list|,
operator|&
name|qid
operator|->
name|nsid
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|qid
operator|->
name|qid_table
argument_list|,
name|qid
operator|->
name|qid_nbuckets
operator|*
sizeof|sizeof
argument_list|(
name|dns_displist_t
argument_list|)
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|qid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|qid
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Allocate and set important limits.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|dispatch_allocate
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|unsigned
name|int
name|maxrequests
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
block|{
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|isc_result_t
name|res
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dispp
operator|!=
name|NULL
operator|&&
operator|*
name|dispp
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Set up the dispatcher, mostly.  Don't bother setting some of 	 * the options that are controlled by tcp vs. udp, etc. 	 */
name|disp
operator|=
name|isc_mempool_get
argument_list|(
name|mgr
operator|->
name|dpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|disp
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|disp
operator|->
name|mgr
operator|=
name|mgr
expr_stmt|;
name|disp
operator|->
name|maxrequests
operator|=
name|maxrequests
expr_stmt|;
name|disp
operator|->
name|attributes
operator|=
literal|0
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|disp
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|disp
operator|->
name|refcount
operator|=
literal|1
expr_stmt|;
name|disp
operator|->
name|recv_pending
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|disp
operator|->
name|local
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|disp
operator|->
name|local
argument_list|)
argument_list|)
expr_stmt|;
name|disp
operator|->
name|shutting_down
operator|=
literal|0
expr_stmt|;
name|disp
operator|->
name|shutdown_out
operator|=
literal|0
expr_stmt|;
name|disp
operator|->
name|connected
operator|=
literal|0
expr_stmt|;
name|disp
operator|->
name|tcpmsg_valid
operator|=
literal|0
expr_stmt|;
name|disp
operator|->
name|shutdown_why
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
name|disp
operator|->
name|requests
operator|=
literal|0
expr_stmt|;
name|disp
operator|->
name|tcpbuffers
operator|=
literal|0
expr_stmt|;
name|disp
operator|->
name|qid
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|isc_mutex_init
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|res
operator|=
name|ISC_R_UNEXPECTED
expr_stmt|;
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init failed"
argument_list|)
expr_stmt|;
goto|goto
name|deallocate
goto|;
block|}
name|disp
operator|->
name|failsafe_ev
operator|=
name|allocate_event
argument_list|(
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|failsafe_ev
operator|==
name|NULL
condition|)
block|{
name|res
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|kill_lock
goto|;
block|}
name|disp
operator|->
name|magic
operator|=
name|DISPATCH_MAGIC
expr_stmt|;
operator|*
name|dispp
operator|=
name|disp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
comment|/* 	 * error returns 	 */
name|kill_lock
label|:
name|DESTROYLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|deallocate
label|:
name|isc_mempool_put
argument_list|(
name|mgr
operator|->
name|dpool
argument_list|,
name|disp
argument_list|)
expr_stmt|;
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * MUST be unlocked, and not used by anthing.  */
end_comment

begin_function
specifier|static
name|void
name|dispatch_free
parameter_list|(
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
block|{
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|dns_dispatchmgr_t
modifier|*
name|mgr
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
operator|*
name|dispp
argument_list|)
argument_list|)
expr_stmt|;
name|disp
operator|=
operator|*
name|dispp
expr_stmt|;
operator|*
name|dispp
operator|=
name|NULL
expr_stmt|;
name|mgr
operator|=
name|disp
operator|->
name|mgr
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|tcpmsg_valid
condition|)
block|{
name|dns_tcpmsg_invalidate
argument_list|(
operator|&
name|disp
operator|->
name|tcpmsg
argument_list|)
expr_stmt|;
name|disp
operator|->
name|tcpmsg_valid
operator|=
literal|0
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|disp
operator|->
name|tcpbuffers
operator|==
literal|0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|disp
operator|->
name|requests
operator|==
literal|0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|disp
operator|->
name|recv_pending
operator|==
literal|0
argument_list|)
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|mgr
operator|->
name|epool
argument_list|,
name|disp
operator|->
name|failsafe_ev
argument_list|)
expr_stmt|;
name|disp
operator|->
name|failsafe_ev
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|qid
operator|!=
name|NULL
condition|)
name|qid_destroy
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
operator|&
name|disp
operator|->
name|qid
argument_list|)
expr_stmt|;
name|disp
operator|->
name|mgr
operator|=
name|NULL
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|disp
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|mgr
operator|->
name|dpool
argument_list|,
name|disp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dispatch_createtcp
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_socket_t
modifier|*
name|sock
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|unsigned
name|int
name|buffersize
parameter_list|,
name|unsigned
name|int
name|maxbuffers
parameter_list|,
name|unsigned
name|int
name|maxrequests
parameter_list|,
name|unsigned
name|int
name|buckets
parameter_list|,
name|unsigned
name|int
name|increment
parameter_list|,
name|unsigned
name|int
name|attributes
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|UNUSED
argument_list|(
name|maxbuffers
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|buffersize
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|isc_socket_gettype
argument_list|(
name|sock
argument_list|)
operator|==
name|isc_sockettype_tcp
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|attributes
operator|&
name|DNS_DISPATCHATTR_TCP
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|attributes
operator|&
name|DNS_DISPATCHATTR_UDP
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|attributes
operator||=
name|DNS_DISPATCHATTR_PRIVATE
expr_stmt|;
comment|/* XXXMLG */
name|LOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 	 * dispatch_allocate() checks mgr for us. 	 * qid_allocate() checks buckets and increment for us. 	 */
name|disp
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dispatch_allocate
argument_list|(
name|mgr
argument_list|,
name|maxrequests
argument_list|,
operator|&
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|result
operator|=
name|qid_allocate
argument_list|(
name|mgr
argument_list|,
name|buckets
argument_list|,
name|increment
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|disp
operator|->
name|qid
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|deallocate_dispatch
goto|;
name|disp
operator|->
name|socktype
operator|=
name|isc_sockettype_tcp
expr_stmt|;
name|disp
operator|->
name|socket
operator|=
name|NULL
expr_stmt|;
name|isc_socket_attach
argument_list|(
name|sock
argument_list|,
operator|&
name|disp
operator|->
name|socket
argument_list|)
expr_stmt|;
name|disp
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|disp
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|kill_socket
goto|;
name|disp
operator|->
name|ctlevent
operator|=
name|isc_event_allocate
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|disp
argument_list|,
name|DNS_EVENT_DISPATCHCONTROL
argument_list|,
name|destroy_disp
argument_list|,
name|disp
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_event_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|ctlevent
operator|==
name|NULL
condition|)
goto|goto
name|kill_task
goto|;
name|isc_task_setname
argument_list|(
name|disp
operator|->
name|task
argument_list|,
literal|"tcpdispatch"
argument_list|,
name|disp
argument_list|)
expr_stmt|;
name|dns_tcpmsg_init
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|disp
operator|->
name|socket
argument_list|,
operator|&
name|disp
operator|->
name|tcpmsg
argument_list|)
expr_stmt|;
name|disp
operator|->
name|tcpmsg_valid
operator|=
literal|1
expr_stmt|;
name|disp
operator|->
name|attributes
operator|=
name|attributes
expr_stmt|;
comment|/* 	 * Append it to the dispatcher list. 	 */
name|ISC_LIST_APPEND
argument_list|(
name|mgr
operator|->
name|list
argument_list|,
name|disp
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mgr_log
argument_list|(
name|mgr
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"created TCP dispatcher %p"
argument_list|,
name|disp
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"created task %p"
argument_list|,
name|disp
operator|->
name|task
argument_list|)
expr_stmt|;
operator|*
name|dispp
operator|=
name|disp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
comment|/* 	 * Error returns. 	 */
name|kill_task
label|:
name|isc_task_detach
argument_list|(
operator|&
name|disp
operator|->
name|task
argument_list|)
expr_stmt|;
name|kill_socket
label|:
name|isc_socket_detach
argument_list|(
operator|&
name|disp
operator|->
name|socket
argument_list|)
expr_stmt|;
name|deallocate_dispatch
label|:
name|dispatch_free
argument_list|(
operator|&
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dispatch_getudp
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|sockmgr
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|localaddr
parameter_list|,
name|unsigned
name|int
name|buffersize
parameter_list|,
name|unsigned
name|int
name|maxbuffers
parameter_list|,
name|unsigned
name|int
name|maxrequests
parameter_list|,
name|unsigned
name|int
name|buckets
parameter_list|,
name|unsigned
name|int
name|increment
parameter_list|,
name|unsigned
name|int
name|attributes
parameter_list|,
name|unsigned
name|int
name|mask
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|sockmgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|localaddr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|taskmgr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|buffersize
operator|>=
literal|512
operator|&&
name|buffersize
operator|<
operator|(
literal|64
operator|*
literal|1024
operator|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|maxbuffers
operator|>
literal|0
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|buckets
operator|<
literal|2097169
argument_list|)
expr_stmt|;
comment|/* next prime> 65536 * 32 */
name|REQUIRE
argument_list|(
name|increment
operator|>
name|buckets
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dispp
operator|!=
name|NULL
operator|&&
operator|*
name|dispp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|attributes
operator|&
name|DNS_DISPATCHATTR_TCP
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dispatchmgr_setudp
argument_list|(
name|mgr
argument_list|,
name|buffersize
argument_list|,
name|maxbuffers
argument_list|,
name|buckets
argument_list|,
name|increment
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|LOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 	 * First, see if we have a dispatcher that matches. 	 */
name|disp
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dispatch_find
argument_list|(
name|mgr
argument_list|,
name|localaddr
argument_list|,
name|attributes
argument_list|,
name|mask
argument_list|,
operator|&
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|disp
operator|->
name|refcount
operator|++
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|maxrequests
operator|<
name|maxrequests
condition|)
name|disp
operator|->
name|maxrequests
operator|=
name|maxrequests
expr_stmt|;
if|if
condition|(
operator|(
name|disp
operator|->
name|attributes
operator|&
name|DNS_DISPATCHATTR_NOLISTEN
operator|)
operator|==
literal|0
operator|&&
operator|(
name|attributes
operator|&
name|DNS_DISPATCHATTR_NOLISTEN
operator|)
operator|!=
literal|0
condition|)
block|{
name|disp
operator|->
name|attributes
operator||=
name|DNS_DISPATCHATTR_NOLISTEN
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|recv_pending
operator|!=
literal|0
condition|)
name|isc_socket_cancel
argument_list|(
name|disp
operator|->
name|socket
argument_list|,
name|disp
operator|->
name|task
argument_list|,
name|ISC_SOCKCANCEL_RECV
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|dispp
operator|=
name|disp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
comment|/* 	 * Nope, create one. 	 */
name|result
operator|=
name|dispatch_createudp
argument_list|(
name|mgr
argument_list|,
name|sockmgr
argument_list|,
name|taskmgr
argument_list|,
name|localaddr
argument_list|,
name|maxrequests
argument_list|,
name|attributes
argument_list|,
operator|&
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|mgr
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|dispp
operator|=
name|disp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * mgr should be locked.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|dispatch_createudp
parameter_list|(
name|dns_dispatchmgr_t
modifier|*
name|mgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|sockmgr
parameter_list|,
name|isc_taskmgr_t
modifier|*
name|taskmgr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|localaddr
parameter_list|,
name|unsigned
name|int
name|maxrequests
parameter_list|,
name|unsigned
name|int
name|attributes
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|isc_socket_t
modifier|*
name|sock
decl_stmt|;
comment|/* 	 * dispatch_allocate() checks mgr for us. 	 */
name|disp
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dispatch_allocate
argument_list|(
name|mgr
argument_list|,
name|maxrequests
argument_list|,
operator|&
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 	 * This assumes that the IP stack will *not* quickly reallocate 	 * the same port.  If it does continually reallocate the same port 	 * then we need a mechanism to hold all the blacklisted sockets 	 * until we find a usable socket. 	 */
name|getsocket
label|:
name|result
operator|=
name|create_socket
argument_list|(
name|sockmgr
argument_list|,
name|localaddr
argument_list|,
operator|&
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|deallocate_dispatch
goto|;
if|if
condition|(
name|isc_sockaddr_getport
argument_list|(
name|localaddr
argument_list|)
operator|==
literal|0
operator|&&
name|blacklisted
argument_list|(
name|mgr
argument_list|,
name|sock
argument_list|)
condition|)
block|{
name|isc_socket_detach
argument_list|(
operator|&
name|sock
argument_list|)
expr_stmt|;
goto|goto
name|getsocket
goto|;
block|}
name|disp
operator|->
name|socktype
operator|=
name|isc_sockettype_udp
expr_stmt|;
name|disp
operator|->
name|socket
operator|=
name|sock
expr_stmt|;
name|disp
operator|->
name|local
operator|=
operator|*
name|localaddr
expr_stmt|;
name|disp
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_task_create
argument_list|(
name|taskmgr
argument_list|,
literal|0
argument_list|,
operator|&
name|disp
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|kill_socket
goto|;
name|disp
operator|->
name|ctlevent
operator|=
name|isc_event_allocate
argument_list|(
name|mgr
operator|->
name|mctx
argument_list|,
name|disp
argument_list|,
name|DNS_EVENT_DISPATCHCONTROL
argument_list|,
name|destroy_disp
argument_list|,
name|disp
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_event_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|ctlevent
operator|==
name|NULL
condition|)
goto|goto
name|kill_task
goto|;
name|isc_task_setname
argument_list|(
name|disp
operator|->
name|task
argument_list|,
literal|"udpdispatch"
argument_list|,
name|disp
argument_list|)
expr_stmt|;
name|attributes
operator|&=
operator|~
name|DNS_DISPATCHATTR_TCP
expr_stmt|;
name|attributes
operator||=
name|DNS_DISPATCHATTR_UDP
expr_stmt|;
name|disp
operator|->
name|attributes
operator|=
name|attributes
expr_stmt|;
comment|/* 	 * Append it to the dispatcher list. 	 */
name|ISC_LIST_APPEND
argument_list|(
name|mgr
operator|->
name|list
argument_list|,
name|disp
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|mgr_log
argument_list|(
name|mgr
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"created UDP dispatcher %p"
argument_list|,
name|disp
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"created task %p"
argument_list|,
name|disp
operator|->
name|task
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"created socket %p"
argument_list|,
name|disp
operator|->
name|socket
argument_list|)
expr_stmt|;
operator|*
name|dispp
operator|=
name|disp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
comment|/* 	 * Error returns. 	 */
name|kill_task
label|:
name|isc_task_detach
argument_list|(
operator|&
name|disp
operator|->
name|task
argument_list|)
expr_stmt|;
name|kill_socket
label|:
name|isc_socket_detach
argument_list|(
operator|&
name|disp
operator|->
name|socket
argument_list|)
expr_stmt|;
name|deallocate_dispatch
label|:
name|dispatch_free
argument_list|(
operator|&
name|disp
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_dispatch_attach
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dispp
operator|!=
name|NULL
operator|&&
operator|*
name|dispp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|disp
operator|->
name|refcount
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|dispp
operator|=
name|disp
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * It is important to lock the manager while we are deleting the dispatch,  * since dns_dispatch_getudp will call dispatch_find, which returns to  * the caller a dispatch but does not attach to it until later.  _getudp  * locks the manager, however, so locking it here will keep us from attaching  * to a dispatcher that is in the process of going away.  */
end_comment

begin_function
name|void
name|dns_dispatch_detach
parameter_list|(
name|dns_dispatch_t
modifier|*
modifier|*
name|dispp
parameter_list|)
block|{
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|isc_boolean_t
name|killit
decl_stmt|;
name|REQUIRE
argument_list|(
name|dispp
operator|!=
name|NULL
operator|&&
name|VALID_DISPATCH
argument_list|(
operator|*
name|dispp
argument_list|)
argument_list|)
expr_stmt|;
name|disp
operator|=
operator|*
name|dispp
expr_stmt|;
operator|*
name|dispp
operator|=
name|NULL
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|disp
operator|->
name|refcount
operator|>
literal|0
argument_list|)
expr_stmt|;
name|disp
operator|->
name|refcount
operator|--
expr_stmt|;
name|killit
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|refcount
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|disp
operator|->
name|recv_pending
operator|>
literal|0
condition|)
name|isc_socket_cancel
argument_list|(
name|disp
operator|->
name|socket
argument_list|,
name|disp
operator|->
name|task
argument_list|,
name|ISC_SOCKCANCEL_RECV
argument_list|)
expr_stmt|;
name|disp
operator|->
name|shutting_down
operator|=
literal|1
expr_stmt|;
block|}
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"detach: refcount %d"
argument_list|,
name|disp
operator|->
name|refcount
argument_list|)
expr_stmt|;
name|killit
operator|=
name|destroy_disp_ok
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|killit
condition|)
name|isc_task_send
argument_list|(
name|disp
operator|->
name|task
argument_list|,
operator|&
name|disp
operator|->
name|ctlevent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dispatch_addresponse
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|dest
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_messageid_t
modifier|*
name|idp
parameter_list|,
name|dns_dispentry_t
modifier|*
modifier|*
name|resp
parameter_list|)
block|{
name|dns_dispentry_t
modifier|*
name|res
decl_stmt|;
name|unsigned
name|int
name|bucket
decl_stmt|;
name|dns_messageid_t
name|id
decl_stmt|;
name|int
name|i
decl_stmt|;
name|isc_boolean_t
name|ok
decl_stmt|;
name|dns_qid_t
modifier|*
name|qid
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|task
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dest
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|resp
operator|!=
name|NULL
operator|&&
operator|*
name|resp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|idp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|shutting_down
operator|==
literal|1
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SHUTTINGDOWN
operator|)
return|;
block|}
if|if
condition|(
name|disp
operator|->
name|requests
operator|>=
name|disp
operator|->
name|maxrequests
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_QUOTA
operator|)
return|;
block|}
comment|/* 	 * Try somewhat hard to find an unique ID. 	 */
name|qid
operator|=
name|DNS_QID
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
name|id
operator|=
name|dns_randomid
argument_list|(
operator|&
name|qid
operator|->
name|nsid
argument_list|)
expr_stmt|;
name|bucket
operator|=
name|dns_hash
argument_list|(
name|qid
argument_list|,
name|dest
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|ok
operator|=
name|ISC_FALSE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bucket_search
argument_list|(
name|qid
argument_list|,
name|dest
argument_list|,
name|id
argument_list|,
name|bucket
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ok
operator|=
name|ISC_TRUE
expr_stmt|;
break|break;
block|}
name|id
operator|+=
name|qid
operator|->
name|qid_increment
expr_stmt|;
name|id
operator|&=
literal|0x0000ffff
expr_stmt|;
name|bucket
operator|=
name|dns_hash
argument_list|(
name|qid
argument_list|,
name|dest
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
block|}
name|res
operator|=
name|isc_mempool_get
argument_list|(
name|disp
operator|->
name|mgr
operator|->
name|rpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|disp
operator|->
name|refcount
operator|++
expr_stmt|;
name|disp
operator|->
name|requests
operator|++
expr_stmt|;
name|res
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|res
operator|->
name|task
argument_list|)
expr_stmt|;
name|res
operator|->
name|disp
operator|=
name|disp
expr_stmt|;
name|res
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|res
operator|->
name|bucket
operator|=
name|bucket
expr_stmt|;
name|res
operator|->
name|host
operator|=
operator|*
name|dest
expr_stmt|;
name|res
operator|->
name|action
operator|=
name|action
expr_stmt|;
name|res
operator|->
name|arg
operator|=
name|arg
expr_stmt|;
name|res
operator|->
name|item_out
operator|=
name|ISC_FALSE
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|res
operator|->
name|items
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|res
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|res
operator|->
name|magic
operator|=
name|RESPONSE_MAGIC
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|qid
operator|->
name|qid_table
index|[
name|bucket
index|]
argument_list|,
name|res
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
name|request_log
argument_list|(
name|disp
argument_list|,
name|res
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"attached to task %p"
argument_list|,
name|res
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|disp
operator|->
name|attributes
operator|&
name|DNS_DISPATCHATTR_UDP
operator|)
operator|!=
literal|0
operator|)
operator|||
operator|(
operator|(
name|disp
operator|->
name|attributes
operator|&
name|DNS_DISPATCHATTR_CONNECTED
operator|)
operator|!=
literal|0
operator|)
condition|)
name|startrecv
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|idp
operator|=
name|id
expr_stmt|;
operator|*
name|resp
operator|=
name|res
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_dispatch_starttcp
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
name|dispatch_log
argument_list|(
name|disp
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"starttcp %p"
argument_list|,
name|disp
operator|->
name|task
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|disp
operator|->
name|attributes
operator||=
name|DNS_DISPATCHATTR_CONNECTED
expr_stmt|;
name|startrecv
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_dispatch_removeresponse
parameter_list|(
name|dns_dispentry_t
modifier|*
modifier|*
name|resp
parameter_list|,
name|dns_dispatchevent_t
modifier|*
modifier|*
name|sockevent
parameter_list|)
block|{
name|dns_dispatchmgr_t
modifier|*
name|mgr
decl_stmt|;
name|dns_dispatch_t
modifier|*
name|disp
decl_stmt|;
name|dns_dispentry_t
modifier|*
name|res
decl_stmt|;
name|dns_dispatchevent_t
modifier|*
name|ev
decl_stmt|;
name|unsigned
name|int
name|bucket
decl_stmt|;
name|isc_boolean_t
name|killit
decl_stmt|;
name|unsigned
name|int
name|n
decl_stmt|;
name|isc_eventlist_t
name|events
decl_stmt|;
name|dns_qid_t
modifier|*
name|qid
decl_stmt|;
name|REQUIRE
argument_list|(
name|resp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_RESPONSE
argument_list|(
operator|*
name|resp
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|=
operator|*
name|resp
expr_stmt|;
operator|*
name|resp
operator|=
name|NULL
expr_stmt|;
name|disp
operator|=
name|res
operator|->
name|disp
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
name|mgr
operator|=
name|disp
operator|->
name|mgr
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCHMGR
argument_list|(
name|mgr
argument_list|)
argument_list|)
expr_stmt|;
name|qid
operator|=
name|DNS_QID
argument_list|(
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sockevent
operator|!=
name|NULL
condition|)
block|{
name|REQUIRE
argument_list|(
operator|*
name|sockevent
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ev
operator|=
operator|*
name|sockevent
expr_stmt|;
operator|*
name|sockevent
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|ev
operator|=
name|NULL
expr_stmt|;
block|}
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|disp
operator|->
name|requests
operator|>
literal|0
argument_list|)
expr_stmt|;
name|disp
operator|->
name|requests
operator|--
expr_stmt|;
name|INSIST
argument_list|(
name|disp
operator|->
name|refcount
operator|>
literal|0
argument_list|)
expr_stmt|;
name|disp
operator|->
name|refcount
operator|--
expr_stmt|;
name|killit
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|refcount
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|disp
operator|->
name|recv_pending
operator|>
literal|0
condition|)
name|isc_socket_cancel
argument_list|(
name|disp
operator|->
name|socket
argument_list|,
name|disp
operator|->
name|task
argument_list|,
name|ISC_SOCKCANCEL_RECV
argument_list|)
expr_stmt|;
name|disp
operator|->
name|shutting_down
operator|=
literal|1
expr_stmt|;
block|}
name|bucket
operator|=
name|res
operator|->
name|bucket
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|qid
operator|->
name|qid_table
index|[
name|bucket
index|]
argument_list|,
name|res
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|==
name|NULL
operator|&&
name|res
operator|->
name|item_out
condition|)
block|{
comment|/* 		 * We've posted our event, but the caller hasn't gotten it 		 * yet.  Take it back. 		 */
name|ISC_LIST_INIT
argument_list|(
name|events
argument_list|)
expr_stmt|;
name|n
operator|=
name|isc_task_unsend
argument_list|(
name|res
operator|->
name|task
argument_list|,
name|res
argument_list|,
name|DNS_EVENT_DISPATCH
argument_list|,
name|NULL
argument_list|,
operator|&
name|events
argument_list|)
expr_stmt|;
comment|/* 		 * We had better have gotten it back. 		 */
name|INSIST
argument_list|(
name|n
operator|==
literal|1
argument_list|)
expr_stmt|;
name|ev
operator|=
operator|(
name|dns_dispatchevent_t
operator|*
operator|)
name|ISC_LIST_HEAD
argument_list|(
name|events
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ev
operator|!=
name|NULL
condition|)
block|{
name|REQUIRE
argument_list|(
name|res
operator|->
name|item_out
operator|==
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|res
operator|->
name|item_out
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|buffer
operator|.
name|base
operator|!=
name|NULL
condition|)
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|ev
operator|->
name|buffer
operator|.
name|base
argument_list|,
name|ev
operator|->
name|buffer
operator|.
name|length
argument_list|)
expr_stmt|;
name|free_event
argument_list|(
name|disp
argument_list|,
name|ev
argument_list|)
expr_stmt|;
block|}
name|request_log
argument_list|(
name|disp
argument_list|,
name|res
argument_list|,
name|LVL
argument_list|(
literal|90
argument_list|)
argument_list|,
literal|"detaching from task %p"
argument_list|,
name|res
operator|->
name|task
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|res
operator|->
name|task
argument_list|)
expr_stmt|;
comment|/* 	 * Free any buffered requests as well 	 */
name|ev
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|res
operator|->
name|items
argument_list|)
expr_stmt|;
while|while
condition|(
name|ev
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|res
operator|->
name|items
argument_list|,
name|ev
argument_list|,
name|ev_link
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|buffer
operator|.
name|base
operator|!=
name|NULL
condition|)
name|free_buffer
argument_list|(
name|disp
argument_list|,
name|ev
operator|->
name|buffer
operator|.
name|base
argument_list|,
name|ev
operator|->
name|buffer
operator|.
name|length
argument_list|)
expr_stmt|;
name|free_event
argument_list|(
name|disp
argument_list|,
name|ev
argument_list|)
expr_stmt|;
name|ev
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|res
operator|->
name|items
argument_list|)
expr_stmt|;
block|}
name|res
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mempool_put
argument_list|(
name|disp
operator|->
name|mgr
operator|->
name|rpool
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|shutting_down
operator|==
literal|1
condition|)
name|do_cancel
argument_list|(
name|disp
argument_list|)
expr_stmt|;
else|else
name|startrecv
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|killit
operator|=
name|destroy_disp_ok
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|killit
condition|)
name|isc_task_send
argument_list|(
name|disp
operator|->
name|task
argument_list|,
operator|&
name|disp
operator|->
name|ctlevent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|do_cancel
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
block|{
name|dns_dispatchevent_t
modifier|*
name|ev
decl_stmt|;
name|dns_dispentry_t
modifier|*
name|resp
decl_stmt|;
name|dns_qid_t
modifier|*
name|qid
decl_stmt|;
if|if
condition|(
name|disp
operator|->
name|shutdown_out
operator|==
literal|1
condition|)
return|return;
name|qid
operator|=
name|DNS_QID
argument_list|(
name|disp
argument_list|)
expr_stmt|;
comment|/* 	 * Search for the first response handler without packets outstanding. 	 */
name|LOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
for|for
control|(
name|resp
operator|=
name|linear_first
argument_list|(
name|qid
argument_list|)
init|;
name|resp
operator|!=
name|NULL
operator|&&
name|resp
operator|->
name|item_out
operator|!=
name|ISC_FALSE
condition|;
comment|/* Empty. */
control|)
name|resp
operator|=
name|linear_next
argument_list|(
name|qid
argument_list|,
name|resp
argument_list|)
expr_stmt|;
comment|/* 	 * No one to send the cancel event to, so nothing to do. 	 */
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
goto|goto
name|unlock
goto|;
comment|/* 	 * Send the shutdown failsafe event to this resp. 	 */
name|ev
operator|=
name|disp
operator|->
name|failsafe_ev
expr_stmt|;
name|ISC_EVENT_INIT
argument_list|(
name|ev
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ev
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|DNS_EVENT_DISPATCH
argument_list|,
name|resp
operator|->
name|action
argument_list|,
name|resp
operator|->
name|arg
argument_list|,
name|resp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ev
operator|->
name|result
operator|=
name|disp
operator|->
name|shutdown_why
expr_stmt|;
name|ev
operator|->
name|buffer
operator|.
name|base
operator|=
name|NULL
expr_stmt|;
name|ev
operator|->
name|buffer
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|disp
operator|->
name|shutdown_out
operator|=
literal|1
expr_stmt|;
name|request_log
argument_list|(
name|disp
argument_list|,
name|resp
argument_list|,
name|LVL
argument_list|(
literal|10
argument_list|)
argument_list|,
literal|"cancel: failsafe event %p -> task %p"
argument_list|,
name|ev
argument_list|,
name|resp
operator|->
name|task
argument_list|)
expr_stmt|;
name|resp
operator|->
name|item_out
operator|=
name|ISC_TRUE
expr_stmt|;
name|isc_task_send
argument_list|(
name|resp
operator|->
name|task
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|ev
argument_list|)
argument_list|)
expr_stmt|;
name|unlock
label|:
name|UNLOCK
argument_list|(
operator|&
name|qid
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_socket_t
modifier|*
name|dns_dispatch_getsocket
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|disp
operator|->
name|socket
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_dispatch_getlocaladdress
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|addrp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|addrp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|socktype
operator|==
name|isc_sockettype_udp
condition|)
block|{
operator|*
name|addrp
operator|=
name|disp
operator|->
name|local
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_dispatch_cancel
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|shutting_down
operator|==
literal|1
condition|)
block|{
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
name|disp
operator|->
name|shutdown_why
operator|=
name|ISC_R_CANCELED
expr_stmt|;
name|disp
operator|->
name|shutting_down
operator|=
literal|1
expr_stmt|;
name|do_cancel
argument_list|(
name|disp
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|dns_dispatch_changeattributes
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|unsigned
name|int
name|attributes
parameter_list|,
name|unsigned
name|int
name|mask
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXXMLG 	 * Should check for valid attributes here! 	 */
name|LOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mask
operator|&
name|DNS_DISPATCHATTR_NOLISTEN
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|disp
operator|->
name|attributes
operator|&
name|DNS_DISPATCHATTR_NOLISTEN
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|attributes
operator|&
name|DNS_DISPATCHATTR_NOLISTEN
operator|)
operator|==
literal|0
condition|)
block|{
name|disp
operator|->
name|attributes
operator|&=
operator|~
name|DNS_DISPATCHATTR_NOLISTEN
expr_stmt|;
name|startrecv
argument_list|(
name|disp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|disp
operator|->
name|attributes
operator|&
name|DNS_DISPATCHATTR_NOLISTEN
operator|)
operator|==
literal|0
operator|&&
operator|(
name|attributes
operator|&
name|DNS_DISPATCHATTR_NOLISTEN
operator|)
operator|!=
literal|0
condition|)
block|{
name|disp
operator|->
name|attributes
operator||=
name|DNS_DISPATCHATTR_NOLISTEN
expr_stmt|;
if|if
condition|(
name|disp
operator|->
name|recv_pending
operator|!=
literal|0
condition|)
name|isc_socket_cancel
argument_list|(
name|disp
operator|->
name|socket
argument_list|,
name|disp
operator|->
name|task
argument_list|,
name|ISC_SOCKCANCEL_RECV
argument_list|)
expr_stmt|;
block|}
block|}
name|disp
operator|->
name|attributes
operator|&=
operator|~
name|mask
expr_stmt|;
name|disp
operator|->
name|attributes
operator||=
operator|(
name|attributes
operator|&
name|mask
operator|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|disp
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_dispatch_importrecv
parameter_list|(
name|dns_dispatch_t
modifier|*
name|disp
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|void
modifier|*
name|buf
decl_stmt|;
name|isc_socketevent_t
modifier|*
name|sevent
decl_stmt|,
modifier|*
name|newsevent
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_DISPATCH
argument_list|(
name|disp
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|disp
operator|->
name|attributes
operator|&
name|DNS_DISPATCHATTR_NOLISTEN
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|sevent
operator|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|INSIST
argument_list|(
name|sevent
operator|->
name|n
operator|<=
name|disp
operator|->
name|mgr
operator|->
name|buffersize
argument_list|)
expr_stmt|;
name|newsevent
operator|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|disp
operator|->
name|mgr
operator|->
name|mctx
argument_list|,
name|NULL
argument_list|,
name|DNS_EVENT_IMPORTRECVDONE
argument_list|,
name|udp_recv
argument_list|,
name|disp
argument_list|,
sizeof|sizeof
argument_list|(
name|isc_socketevent_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|newsevent
operator|==
name|NULL
condition|)
return|return;
name|buf
operator|=
name|allocate_udp_buffer
argument_list|(
name|disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|isc_event_free
argument_list|(
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|newsevent
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|memcpy
argument_list|(
name|buf
argument_list|,
name|sevent
operator|->
name|region
operator|.
name|base
argument_list|,
name|sevent
operator|->
name|n
argument_list|)
expr_stmt|;
name|newsevent
operator|->
name|region
operator|.
name|base
operator|=
name|buf
expr_stmt|;
name|newsevent
operator|->
name|region
operator|.
name|length
operator|=
name|disp
operator|->
name|mgr
operator|->
name|buffersize
expr_stmt|;
name|newsevent
operator|->
name|n
operator|=
name|sevent
operator|->
name|n
expr_stmt|;
name|newsevent
operator|->
name|result
operator|=
name|sevent
operator|->
name|result
expr_stmt|;
name|newsevent
operator|->
name|address
operator|=
name|sevent
operator|->
name|address
expr_stmt|;
name|newsevent
operator|->
name|timestamp
operator|=
name|sevent
operator|->
name|timestamp
expr_stmt|;
name|newsevent
operator|->
name|pktinfo
operator|=
name|sevent
operator|->
name|pktinfo
expr_stmt|;
name|newsevent
operator|->
name|attributes
operator|=
name|sevent
operator|->
name|attributes
expr_stmt|;
name|isc_task_send
argument_list|(
name|disp
operator|->
name|task
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|newsevent
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|void dns_dispatchmgr_dump(dns_dispatchmgr_t *mgr) { 	dns_dispatch_t *disp; 	char foo[1024];  	disp = ISC_LIST_HEAD(mgr->list); 	while (disp != NULL) { 		isc_sockaddr_format(&disp->local, foo, sizeof(foo)); 		printf("\tdispatch %p, addr %s\n", disp, foo); 		disp = ISC_LIST_NEXT(disp, link); 	} }
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Allow the user to pick one of two ID randomization algorithms.  *  * The first algorithm is an adaptation of the sequence shuffling  * algorithm discovered by Carter Bays and S. D. Durham [ACM Trans. Math.  * Software 2 (1976), 59-64], as documented as Algorithm B in Chapter  * 3.2.2 in Volume 2 of Knuth's "The Art of Computer Programming".  We use  * a randomly selected linear congruential random number generator with a  * modulus of 2^16, whose increment is a randomly picked odd number, and  * whose multiplier is picked from a set which meets the following  * criteria:  *     Is of the form 8*n+5, which ensures "high potency" according to  *     principle iii in the summary chapter 3.6.  This form also has a  *     gcd(a-1,m) of 4 which is good according to principle iv.  *  *     Is between 0.01 and 0.99 times the modulus as specified by  *     principle iv.  *  *     Passes the spectral test "with flying colors" (ut>= 1) in  *     dimensions 2 through 6 as calculated by Algorithm S in Chapter  *     3.3.4 and the ratings calculated by formula 35 in section E.  *  *     Of the multipliers that pass this test, pick the set that is  *     best according to the theoretical bounds of the serial  *     correlation test.  This was calculated using a simplified  *     version of Knuth's Theorem K in Chapter 3.3.3.  *  * These criteria may not be important for this use, but we might as well  * pick from the best generators since there are so many possible ones and  * we don't have that many random bits to do the picking.  *  * We use a modulus of 2^16 instead of something bigger so that we will  * tend to cycle through all the possible IDs before repeating any,  * however the shuffling will perturb this somewhat.  Theoretically there  * is no minimimum interval between two uses of the same ID, but in  * practice it seems to be>64000.  *  * Our adaptatation  of Algorithm B mixes the hash state which has  * captured various random events into the shuffler to perturb the  * sequence.  *  * One disadvantage of this algorithm is that if the generator parameters  * were to be guessed, it would be possible to mount a limited brute force  * attack on the ID space since the IDs are only shuffled within a limited  * range.  *  * The second algorithm uses the same random number generator to populate  * a pool of 65536 IDs.  The hash state is used to pick an ID from a window  * of 4096 IDs in this pool, then the chosen ID is swapped with the ID  * at the beginning of the window and the window position is advanced.  * This means that the interval between uses of the ID will be no less  * than 65536-4096.  The ID sequence in the pool will become more random  * over time.  *  * For both algorithms, two more linear congruential random number generators  * are selected.  The ID from the first part of algorithm is used to seed  * the first of these generators, and its output is used to seed the second.  * The strategy is use these generators as 1 to 1 hashes to obfuscate the  * properties of the generator used in the first part of either algorithm.  *  * The first algorithm may be suitable for use in a client resolver since  * its memory requirements are fairly low and it's pretty random out of  * the box.  It is somewhat succeptible to a limited brute force attack,  * so the second algorithm is probably preferable for a longer running  * program that issues a large number of queries and has time to randomize  * the pool.  */
end_comment

begin_define
define|#
directive|define
name|NSID_SHUFFLE_TABLE_SIZE
value|100
end_define

begin_comment
comment|/* Suggested by Knuth */
end_comment

begin_comment
comment|/*  * Pick one of the next 4096 IDs in the pool.  * There is a tradeoff here between randomness and how often and ID is reused.  */
end_comment

begin_define
define|#
directive|define
name|NSID_LOOKAHEAD
value|4096
end_define

begin_comment
comment|/* Must be a power of 2 */
end_comment

begin_define
define|#
directive|define
name|NSID_SHUFFLE_ONLY
value|1
end_define

begin_comment
comment|/* algorithm 1 */
end_comment

begin_define
define|#
directive|define
name|NSID_USE_POOL
value|2
end_define

begin_comment
comment|/* algorithm 2 */
end_comment

begin_define
define|#
directive|define
name|NSID_HASHSHIFT
value|3
end_define

begin_define
define|#
directive|define
name|NSID_HASHROTATE
parameter_list|(
name|v
parameter_list|)
define|\
value|(((v)<< NSID_HASHSHIFT) | ((v)>> ((sizeof(v) * 8) - NSID_HASHSHIFT)))
end_define

begin_decl_stmt
specifier|static
name|isc_uint32_t
name|nsid_hash_state
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Keep a running hash of various bits of data that we'll use to  * stir the ID pool or perturb the ID generator  */
end_comment

begin_function
specifier|static
name|void
name|nsid_hash
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|p
init|=
name|data
decl_stmt|;
comment|/* 	 * Hash function similar to the one we use for hashing names. 	 * We don't fold case or toss the upper bit here, though. 	 * This hash doesn't do much interesting when fed binary zeros, 	 * so there may be a better hash function. 	 * This function doesn't need to be very strong since we're 	 * only using it to stir the pool, but it should be reasonably 	 * fast. 	 */
comment|/* 	 * We don't care about locking access to nsid_hash_state. 	 * In fact races make the result even more non deteministic. 	 */
while|while
condition|(
name|len
operator|--
operator|>
literal|0U
condition|)
block|{
name|nsid_hash_state
operator|=
name|NSID_HASHROTATE
argument_list|(
name|nsid_hash_state
argument_list|)
expr_stmt|;
name|nsid_hash_state
operator|+=
operator|*
name|p
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Table of good linear congruential multipliers for modulus 2^16  * in order of increasing serial correlation bounds (so trim from  * the end).  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|isc_uint16_t
name|nsid_multiplier_table
index|[]
init|=
block|{
literal|17565
block|,
literal|25013
block|,
literal|11733
block|,
literal|19877
block|,
literal|23989
block|,
literal|23997
block|,
literal|24997
block|,
literal|25421
block|,
literal|26781
block|,
literal|27413
block|,
literal|35901
block|,
literal|35917
block|,
literal|35973
block|,
literal|36229
block|,
literal|38317
block|,
literal|38437
block|,
literal|39941
block|,
literal|40493
block|,
literal|41853
block|,
literal|46317
block|,
literal|50581
block|,
literal|51429
block|,
literal|53453
block|,
literal|53805
block|,
literal|11317
block|,
literal|11789
block|,
literal|12045
block|,
literal|12413
block|,
literal|14277
block|,
literal|14821
block|,
literal|14917
block|,
literal|18989
block|,
literal|19821
block|,
literal|23005
block|,
literal|23533
block|,
literal|23573
block|,
literal|23693
block|,
literal|27549
block|,
literal|27709
block|,
literal|28461
block|,
literal|29365
block|,
literal|35605
block|,
literal|37693
block|,
literal|37757
block|,
literal|38309
block|,
literal|41285
block|,
literal|45261
block|,
literal|47061
block|,
literal|47269
block|,
literal|48133
block|,
literal|48597
block|,
literal|50277
block|,
literal|50717
block|,
literal|50757
block|,
literal|50805
block|,
literal|51341
block|,
literal|51413
block|,
literal|51581
block|,
literal|51597
block|,
literal|53445
block|,
literal|11493
block|,
literal|14229
block|,
literal|20365
block|,
literal|20653
block|,
literal|23485
block|,
literal|25541
block|,
literal|27429
block|,
literal|29421
block|,
literal|30173
block|,
literal|35445
block|,
literal|35653
block|,
literal|36789
block|,
literal|36797
block|,
literal|37109
block|,
literal|37157
block|,
literal|37669
block|,
literal|38661
block|,
literal|39773
block|,
literal|40397
block|,
literal|41837
block|,
literal|41877
block|,
literal|45293
block|,
literal|47277
block|,
literal|47845
block|,
literal|49853
block|,
literal|51085
block|,
literal|51349
block|,
literal|54085
block|,
literal|56933
block|,
literal|8877
block|,
literal|8973
block|,
literal|9885
block|,
literal|11365
block|,
literal|11813
block|,
literal|13581
block|,
literal|13589
block|,
literal|13613
block|,
literal|14109
block|,
literal|14317
block|,
literal|15765
block|,
literal|15789
block|,
literal|16925
block|,
literal|17069
block|,
literal|17205
block|,
literal|17621
block|,
literal|17941
block|,
literal|19077
block|,
literal|19381
block|,
literal|20245
block|,
literal|22845
block|,
literal|23733
block|,
literal|24869
block|,
literal|25453
block|,
literal|27213
block|,
literal|28381
block|,
literal|28965
block|,
literal|29245
block|,
literal|29997
block|,
literal|30733
block|,
literal|30901
block|,
literal|34877
block|,
literal|35485
block|,
literal|35613
block|,
literal|36133
block|,
literal|36661
block|,
literal|36917
block|,
literal|38597
block|,
literal|40285
block|,
literal|40693
block|,
literal|41413
block|,
literal|41541
block|,
literal|41637
block|,
literal|42053
block|,
literal|42349
block|,
literal|45245
block|,
literal|45469
block|,
literal|46493
block|,
literal|48205
block|,
literal|48613
block|,
literal|50861
block|,
literal|51861
block|,
literal|52877
block|,
literal|53933
block|,
literal|54397
block|,
literal|55669
block|,
literal|56453
block|,
literal|56965
block|,
literal|58021
block|,
literal|7757
block|,
literal|7781
block|,
literal|8333
block|,
literal|9661
block|,
literal|12229
block|,
literal|14373
block|,
literal|14453
block|,
literal|17549
block|,
literal|18141
block|,
literal|19085
block|,
literal|20773
block|,
literal|23701
block|,
literal|24205
block|,
literal|24333
block|,
literal|25261
block|,
literal|25317
block|,
literal|27181
block|,
literal|30117
block|,
literal|30477
block|,
literal|34757
block|,
literal|34885
block|,
literal|35565
block|,
literal|35885
block|,
literal|36541
block|,
literal|37957
block|,
literal|39733
block|,
literal|39813
block|,
literal|41157
block|,
literal|41893
block|,
literal|42317
block|,
literal|46621
block|,
literal|48117
block|,
literal|48181
block|,
literal|49525
block|,
literal|55261
block|,
literal|55389
block|,
literal|56845
block|,
literal|7045
block|,
literal|7749
block|,
literal|7965
block|,
literal|8469
block|,
literal|9133
block|,
literal|9549
block|,
literal|9789
block|,
literal|10173
block|,
literal|11181
block|,
literal|11285
block|,
literal|12253
block|,
literal|13453
block|,
literal|13533
block|,
literal|13757
block|,
literal|14477
block|,
literal|15053
block|,
literal|16901
block|,
literal|17213
block|,
literal|17269
block|,
literal|17525
block|,
literal|17629
block|,
literal|18605
block|,
literal|19013
block|,
literal|19829
block|,
literal|19933
block|,
literal|20069
block|,
literal|20093
block|,
literal|23261
block|,
literal|23333
block|,
literal|24949
block|,
literal|25309
block|,
literal|27613
block|,
literal|28453
block|,
literal|28709
block|,
literal|29301
block|,
literal|29541
block|,
literal|34165
block|,
literal|34413
block|,
literal|37301
block|,
literal|37773
block|,
literal|38045
block|,
literal|38405
block|,
literal|41077
block|,
literal|41781
block|,
literal|41925
block|,
literal|42717
block|,
literal|44437
block|,
literal|44525
block|,
literal|44613
block|,
literal|45933
block|,
literal|45941
block|,
literal|47077
block|,
literal|50077
block|,
literal|50893
block|,
literal|52117
block|,
literal|5293
block|,
literal|55069
block|,
literal|55989
block|,
literal|58125
block|,
literal|59205
block|,
literal|6869
block|,
literal|14685
block|,
literal|15453
block|,
literal|16821
block|,
literal|17045
block|,
literal|17613
block|,
literal|18437
block|,
literal|21029
block|,
literal|22773
block|,
literal|22909
block|,
literal|25445
block|,
literal|25757
block|,
literal|26541
block|,
literal|30709
block|,
literal|30909
block|,
literal|31093
block|,
literal|31149
block|,
literal|37069
block|,
literal|37725
block|,
literal|37925
block|,
literal|38949
block|,
literal|39637
block|,
literal|39701
block|,
literal|40765
block|,
literal|40861
block|,
literal|42965
block|,
literal|44813
block|,
literal|45077
block|,
literal|45733
block|,
literal|47045
block|,
literal|50093
block|,
literal|52861
block|,
literal|52957
block|,
literal|54181
block|,
literal|56325
block|,
literal|56365
block|,
literal|56381
block|,
literal|56877
block|,
literal|57013
block|,
literal|5741
block|,
literal|58101
block|,
literal|58669
block|,
literal|8613
block|,
literal|10045
block|,
literal|10261
block|,
literal|10653
block|,
literal|10733
block|,
literal|11461
block|,
literal|12261
block|,
literal|14069
block|,
literal|15877
block|,
literal|17757
block|,
literal|21165
block|,
literal|23885
block|,
literal|24701
block|,
literal|26429
block|,
literal|26645
block|,
literal|27925
block|,
literal|28765
block|,
literal|29197
block|,
literal|30189
block|,
literal|31293
block|,
literal|39781
block|,
literal|39909
block|,
literal|40365
block|,
literal|41229
block|,
literal|41453
block|,
literal|41653
block|,
literal|42165
block|,
literal|42365
block|,
literal|47421
block|,
literal|48029
block|,
literal|48085
block|,
literal|52773
block|,
literal|5573
block|,
literal|57037
block|,
literal|57637
block|,
literal|58341
block|,
literal|58357
block|,
literal|58901
block|,
literal|6357
block|,
literal|7789
block|,
literal|9093
block|,
literal|10125
block|,
literal|10709
block|,
literal|10765
block|,
literal|11957
block|,
literal|12469
block|,
literal|13437
block|,
literal|13509
block|,
literal|14773
block|,
literal|15437
block|,
literal|15773
block|,
literal|17813
block|,
literal|18829
block|,
literal|19565
block|,
literal|20237
block|,
literal|23461
block|,
literal|23685
block|,
literal|23725
block|,
literal|23941
block|,
literal|24877
block|,
literal|25461
block|,
literal|26405
block|,
literal|29509
block|,
literal|30285
block|,
literal|35181
block|,
literal|37229
block|,
literal|37893
block|,
literal|38565
block|,
literal|40293
block|,
literal|44189
block|,
literal|44581
block|,
literal|45701
block|,
literal|47381
block|,
literal|47589
block|,
literal|48557
block|,
literal|4941
block|,
literal|51069
block|,
literal|5165
block|,
literal|52797
block|,
literal|53149
block|,
literal|5341
block|,
literal|56301
block|,
literal|56765
block|,
literal|58581
block|,
literal|59493
block|,
literal|59677
block|,
literal|6085
block|,
literal|6349
block|,
literal|8293
block|,
literal|8501
block|,
literal|8517
block|,
literal|11597
block|,
literal|11709
block|,
literal|12589
block|,
literal|12693
block|,
literal|13517
block|,
literal|14909
block|,
literal|17397
block|,
literal|18085
block|,
literal|21101
block|,
literal|21269
block|,
literal|22717
block|,
literal|25237
block|,
literal|25661
block|,
literal|29189
block|,
literal|30101
block|,
literal|31397
block|,
literal|33933
block|,
literal|34213
block|,
literal|34661
block|,
literal|35533
block|,
literal|36493
block|,
literal|37309
block|,
literal|40037
block|,
literal|4189
block|,
literal|42909
block|,
literal|44309
block|,
literal|44357
block|,
literal|44389
block|,
literal|4541
block|,
literal|45461
block|,
literal|46445
block|,
literal|48237
block|,
literal|54149
block|,
literal|55301
block|,
literal|55853
block|,
literal|56621
block|,
literal|56717
block|,
literal|56901
block|,
literal|5813
block|,
literal|58437
block|,
literal|12493
block|,
literal|15365
block|,
literal|15989
block|,
literal|17829
block|,
literal|18229
block|,
literal|19341
block|,
literal|21013
block|,
literal|21357
block|,
literal|22925
block|,
literal|24885
block|,
literal|26053
block|,
literal|27581
block|,
literal|28221
block|,
literal|28485
block|,
literal|30605
block|,
literal|30613
block|,
literal|30789
block|,
literal|35437
block|,
literal|36285
block|,
literal|37189
block|,
literal|3941
block|,
literal|41797
block|,
literal|4269
block|,
literal|42901
block|,
literal|43293
block|,
literal|44645
block|,
literal|45221
block|,
literal|46893
block|,
literal|4893
block|,
literal|50301
block|,
literal|50325
block|,
literal|5189
block|,
literal|52109
block|,
literal|53517
block|,
literal|54053
block|,
literal|54485
block|,
literal|5525
block|,
literal|55949
block|,
literal|56973
block|,
literal|59069
block|,
literal|59421
block|,
literal|60733
block|,
literal|61253
block|,
literal|6421
block|,
literal|6701
block|,
literal|6709
block|,
literal|7101
block|,
literal|8669
block|,
literal|15797
block|,
literal|19221
block|,
literal|19837
block|,
literal|20133
block|,
literal|20957
block|,
literal|21293
block|,
literal|21461
block|,
literal|22461
block|,
literal|29085
block|,
literal|29861
block|,
literal|30869
block|,
literal|34973
block|,
literal|36469
block|,
literal|37565
block|,
literal|38125
block|,
literal|38829
block|,
literal|39469
block|,
literal|40061
block|,
literal|40117
block|,
literal|44093
block|,
literal|47429
block|,
literal|48341
block|,
literal|50597
block|,
literal|51757
block|,
literal|5541
block|,
literal|57629
block|,
literal|58405
block|,
literal|59621
block|,
literal|59693
block|,
literal|59701
block|,
literal|61837
block|,
literal|7061
block|,
literal|10421
block|,
literal|11949
block|,
literal|15405
block|,
literal|20861
block|,
literal|25397
block|,
literal|25509
block|,
literal|25893
block|,
literal|26037
block|,
literal|28629
block|,
literal|28869
block|,
literal|29605
block|,
literal|30213
block|,
literal|34205
block|,
literal|35637
block|,
literal|36365
block|,
literal|37285
block|,
literal|3773
block|,
literal|39117
block|,
literal|4021
block|,
literal|41061
block|,
literal|42653
block|,
literal|44509
block|,
literal|4461
block|,
literal|44829
block|,
literal|4725
block|,
literal|5125
block|,
literal|52269
block|,
literal|56469
block|,
literal|59085
block|,
literal|5917
block|,
literal|60973
block|,
literal|8349
block|,
literal|17725
block|,
literal|18637
block|,
literal|19773
block|,
literal|20293
block|,
literal|21453
block|,
literal|22533
block|,
literal|24285
block|,
literal|26333
block|,
literal|26997
block|,
literal|31501
block|,
literal|34541
block|,
literal|34805
block|,
literal|37509
block|,
literal|38477
block|,
literal|41333
block|,
literal|44125
block|,
literal|46285
block|,
literal|46997
block|,
literal|47637
block|,
literal|48173
block|,
literal|4925
block|,
literal|50253
block|,
literal|50381
block|,
literal|50917
block|,
literal|51205
block|,
literal|51325
block|,
literal|52165
block|,
literal|52229
block|,
literal|5253
block|,
literal|5269
block|,
literal|53509
block|,
literal|56253
block|,
literal|56341
block|,
literal|5821
block|,
literal|58373
block|,
literal|60301
block|,
literal|61653
block|,
literal|61973
block|,
literal|62373
block|,
literal|8397
block|,
literal|11981
block|,
literal|14341
block|,
literal|14509
block|,
literal|15077
block|,
literal|22261
block|,
literal|22429
block|,
literal|24261
block|,
literal|28165
block|,
literal|28685
block|,
literal|30661
block|,
literal|34021
block|,
literal|34445
block|,
literal|39149
block|,
literal|3917
block|,
literal|43013
block|,
literal|43317
block|,
literal|44053
block|,
literal|44101
block|,
literal|4533
block|,
literal|49541
block|,
literal|49981
block|,
literal|5277
block|,
literal|54477
block|,
literal|56357
block|,
literal|57261
block|,
literal|57765
block|,
literal|58573
block|,
literal|59061
block|,
literal|60197
block|,
literal|61197
block|,
literal|62189
block|,
literal|7725
block|,
literal|8477
block|,
literal|9565
block|,
literal|10229
block|,
literal|11437
block|,
literal|14613
block|,
literal|14709
block|,
literal|16813
block|,
literal|20029
block|,
literal|20677
block|,
literal|31445
block|,
literal|3165
block|,
literal|31957
block|,
literal|3229
block|,
literal|33541
block|,
literal|36645
block|,
literal|3805
block|,
literal|38973
block|,
literal|3965
block|,
literal|4029
block|,
literal|44293
block|,
literal|44557
block|,
literal|46245
block|,
literal|48917
block|,
literal|4909
block|,
literal|51749
block|,
literal|53709
block|,
literal|55733
block|,
literal|56445
block|,
literal|5925
block|,
literal|6093
block|,
literal|61053
block|,
literal|62637
block|,
literal|8661
block|,
literal|9109
block|,
literal|10821
block|,
literal|11389
block|,
literal|13813
block|,
literal|14325
block|,
literal|15501
block|,
literal|16149
block|,
literal|18845
block|,
literal|22669
block|,
literal|26437
block|,
literal|29869
block|,
literal|31837
block|,
literal|33709
block|,
literal|33973
block|,
literal|34173
block|,
literal|3677
block|,
literal|3877
block|,
literal|3981
block|,
literal|39885
block|,
literal|42117
block|,
literal|4421
block|,
literal|44221
block|,
literal|44245
block|,
literal|44693
block|,
literal|46157
block|,
literal|47309
block|,
literal|5005
block|,
literal|51461
block|,
literal|52037
block|,
literal|55333
block|,
literal|55693
block|,
literal|56277
block|,
literal|58949
block|,
literal|6205
block|,
literal|62141
block|,
literal|62469
block|,
literal|6293
block|,
literal|10101
block|,
literal|12509
block|,
literal|14029
block|,
literal|17997
block|,
literal|20469
block|,
literal|21149
block|,
literal|25221
block|,
literal|27109
block|,
literal|2773
block|,
literal|2877
block|,
literal|29405
block|,
literal|31493
block|,
literal|31645
block|,
literal|4077
block|,
literal|42005
block|,
literal|42077
block|,
literal|42469
block|,
literal|42501
block|,
literal|44013
block|,
literal|48653
block|,
literal|49349
block|,
literal|4997
block|,
literal|50101
block|,
literal|55405
block|,
literal|56957
block|,
literal|58037
block|,
literal|59429
block|,
literal|60749
block|,
literal|61797
block|,
literal|62381
block|,
literal|62837
block|,
literal|6605
block|,
literal|10541
block|,
literal|23981
block|,
literal|24533
block|,
literal|2701
block|,
literal|27333
block|,
literal|27341
block|,
literal|31197
block|,
literal|33805
block|,
literal|3621
block|,
literal|37381
block|,
literal|3749
block|,
literal|3829
block|,
literal|38533
block|,
literal|42613
block|,
literal|44381
block|,
literal|45901
block|,
literal|48517
block|,
literal|51269
block|,
literal|57725
block|,
literal|59461
block|,
literal|60045
block|,
literal|62029
block|,
literal|13805
block|,
literal|14013
block|,
literal|15461
block|,
literal|16069
block|,
literal|16157
block|,
literal|18573
block|,
literal|2309
block|,
literal|23501
block|,
literal|28645
block|,
literal|3077
block|,
literal|31541
block|,
literal|36357
block|,
literal|36877
block|,
literal|3789
block|,
literal|39429
block|,
literal|39805
block|,
literal|47685
block|,
literal|47949
block|,
literal|49413
block|,
literal|5485
block|,
literal|56757
block|,
literal|57549
block|,
literal|57805
block|,
literal|58317
block|,
literal|59549
block|,
literal|62213
block|,
literal|62613
block|,
literal|62853
block|,
literal|62933
block|,
literal|8909
block|,
literal|12941
block|,
literal|16677
block|,
literal|20333
block|,
literal|21541
block|,
literal|24429
block|,
literal|26077
block|,
literal|26421
block|,
literal|2885
block|,
literal|31269
block|,
literal|33381
block|,
literal|3661
block|,
literal|40925
block|,
literal|42925
block|,
literal|45173
block|,
literal|4525
block|,
literal|4709
block|,
literal|53133
block|,
literal|55941
block|,
literal|57413
block|,
literal|57797
block|,
literal|62125
block|,
literal|62237
block|,
literal|62733
block|,
literal|6773
block|,
literal|12317
block|,
literal|13197
block|,
literal|16533
block|,
literal|16933
block|,
literal|18245
block|,
literal|2213
block|,
literal|2477
block|,
literal|29757
block|,
literal|33293
block|,
literal|35517
block|,
literal|40133
block|,
literal|40749
block|,
literal|4661
block|,
literal|49941
block|,
literal|62757
block|,
literal|7853
block|,
literal|8149
block|,
literal|8573
block|,
literal|11029
block|,
literal|13421
block|,
literal|21549
block|,
literal|22709
block|,
literal|22725
block|,
literal|24629
block|,
literal|2469
block|,
literal|26125
block|,
literal|2669
block|,
literal|34253
block|,
literal|36709
block|,
literal|41013
block|,
literal|45597
block|,
literal|46637
block|,
literal|52285
block|,
literal|52333
block|,
literal|54685
block|,
literal|59013
block|,
literal|60997
block|,
literal|61189
block|,
literal|61981
block|,
literal|62605
block|,
literal|62821
block|,
literal|7077
block|,
literal|7525
block|,
literal|8781
block|,
literal|10861
block|,
literal|15277
block|,
literal|2205
block|,
literal|22077
block|,
literal|28517
block|,
literal|28949
block|,
literal|32109
block|,
literal|33493
block|,
literal|4661
block|,
literal|49941
block|,
literal|62757
block|,
literal|7853
block|,
literal|8149
block|,
literal|8573
block|,
literal|11029
block|,
literal|13421
block|,
literal|21549
block|,
literal|22709
block|,
literal|22725
block|,
literal|24629
block|,
literal|2469
block|,
literal|26125
block|,
literal|2669
block|,
literal|34253
block|,
literal|36709
block|,
literal|41013
block|,
literal|45597
block|,
literal|46637
block|,
literal|52285
block|,
literal|52333
block|,
literal|54685
block|,
literal|59013
block|,
literal|60997
block|,
literal|61189
block|,
literal|61981
block|,
literal|62605
block|,
literal|62821
block|,
literal|7077
block|,
literal|7525
block|,
literal|8781
block|,
literal|10861
block|,
literal|15277
block|,
literal|2205
block|,
literal|22077
block|,
literal|28517
block|,
literal|28949
block|,
literal|32109
block|,
literal|33493
block|,
literal|3685
block|,
literal|39197
block|,
literal|39869
block|,
literal|42621
block|,
literal|44997
block|,
literal|48565
block|,
literal|5221
block|,
literal|57381
block|,
literal|61749
block|,
literal|62317
block|,
literal|63245
block|,
literal|63381
block|,
literal|23149
block|,
literal|2549
block|,
literal|28661
block|,
literal|31653
block|,
literal|33885
block|,
literal|36341
block|,
literal|37053
block|,
literal|39517
block|,
literal|42805
block|,
literal|45853
block|,
literal|48997
block|,
literal|59349
block|,
literal|60053
block|,
literal|62509
block|,
literal|63069
block|,
literal|6525
block|,
literal|1893
block|,
literal|20181
block|,
literal|2365
block|,
literal|24893
block|,
literal|27397
block|,
literal|31357
block|,
literal|32277
block|,
literal|33357
block|,
literal|34437
block|,
literal|36677
block|,
literal|37661
block|,
literal|43469
block|,
literal|43917
block|,
literal|50997
block|,
literal|53869
block|,
literal|5653
block|,
literal|13221
block|,
literal|16741
block|,
literal|17893
block|,
literal|2157
block|,
literal|28653
block|,
literal|31789
block|,
literal|35301
block|,
literal|35821
block|,
literal|61613
block|,
literal|62245
block|,
literal|12405
block|,
literal|14517
block|,
literal|17453
block|,
literal|18421
block|,
literal|3149
block|,
literal|3205
block|,
literal|40341
block|,
literal|4109
block|,
literal|43941
block|,
literal|46869
block|,
literal|48837
block|,
literal|50621
block|,
literal|57405
block|,
literal|60509
block|,
literal|62877
block|,
literal|8157
block|,
literal|12933
block|,
literal|12957
block|,
literal|16501
block|,
literal|19533
block|,
literal|3461
block|,
literal|36829
block|,
literal|52357
block|,
literal|58189
block|,
literal|58293
block|,
literal|63053
block|,
literal|17109
block|,
literal|1933
block|,
literal|32157
block|,
literal|37701
block|,
literal|59005
block|,
literal|61621
block|,
literal|13029
block|,
literal|15085
block|,
literal|16493
block|,
literal|32317
block|,
literal|35093
block|,
literal|5061
block|,
literal|51557
block|,
literal|62221
block|,
literal|20765
block|,
literal|24613
block|,
literal|2629
block|,
literal|30861
block|,
literal|33197
block|,
literal|33749
block|,
literal|35365
block|,
literal|37933
block|,
literal|40317
block|,
literal|48045
block|,
literal|56229
block|,
literal|61157
block|,
literal|63797
block|,
literal|7917
block|,
literal|17965
block|,
literal|1917
block|,
literal|1973
block|,
literal|20301
block|,
literal|2253
block|,
literal|33157
block|,
literal|58629
block|,
literal|59861
block|,
literal|61085
block|,
literal|63909
block|,
literal|8141
block|,
literal|9221
block|,
literal|14757
block|,
literal|1581
block|,
literal|21637
block|,
literal|26557
block|,
literal|33869
block|,
literal|34285
block|,
literal|35733
block|,
literal|40933
block|,
literal|42517
block|,
literal|43501
block|,
literal|53653
block|,
literal|61885
block|,
literal|63805
block|,
literal|7141
block|,
literal|21653
block|,
literal|54973
block|,
literal|31189
block|,
literal|60061
block|,
literal|60341
block|,
literal|63357
block|,
literal|16045
block|,
literal|2053
block|,
literal|26069
block|,
literal|33997
block|,
literal|43901
block|,
literal|54565
block|,
literal|63837
block|,
literal|8949
block|,
literal|17909
block|,
literal|18693
block|,
literal|32349
block|,
literal|33125
block|,
literal|37293
block|,
literal|48821
block|,
literal|49053
block|,
literal|51309
block|,
literal|64037
block|,
literal|7117
block|,
literal|1445
block|,
literal|20405
block|,
literal|23085
block|,
literal|26269
block|,
literal|26293
block|,
literal|27349
block|,
literal|32381
block|,
literal|33141
block|,
literal|34525
block|,
literal|36461
block|,
literal|37581
block|,
literal|43525
block|,
literal|4357
block|,
literal|43877
block|,
literal|5069
block|,
literal|55197
block|,
literal|63965
block|,
literal|9845
block|,
literal|12093
block|,
literal|2197
block|,
literal|2229
block|,
literal|32165
block|,
literal|33469
block|,
literal|40981
block|,
literal|42397
block|,
literal|8749
block|,
literal|10853
block|,
literal|1453
block|,
literal|18069
block|,
literal|21693
block|,
literal|30573
block|,
literal|36261
block|,
literal|37421
block|,
literal|42533
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NSID_MULT_TABLE_SIZE
define|\
value|((sizeof nsid_multiplier_table)/(sizeof nsid_multiplier_table[0]))
end_define

begin_define
define|#
directive|define
name|NSID_RANGE_MASK
value|(NSID_LOOKAHEAD - 1)
end_define

begin_define
define|#
directive|define
name|NSID_POOL_MASK
value|0xFFFF
end_define

begin_comment
comment|/* used to wrap the pool index */
end_comment

begin_define
define|#
directive|define
name|NSID_SHUFFLE_ONLY
value|1
end_define

begin_define
define|#
directive|define
name|NSID_USE_POOL
value|2
end_define

begin_function
specifier|static
name|isc_uint16_t
name|nsid_next
parameter_list|(
name|dns_nsid_t
modifier|*
name|nsid
parameter_list|)
block|{
name|isc_uint16_t
name|id
decl_stmt|,
name|compressed_hash
decl_stmt|;
name|isc_uint16_t
name|j
decl_stmt|;
name|compressed_hash
operator|=
operator|(
operator|(
name|nsid_hash_state
operator|>>
literal|16
operator|)
operator|^
operator|(
name|nsid_hash_state
operator|)
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|nsid
operator|->
name|nsid_usepool
condition|)
block|{
name|isc_uint16_t
name|pick
decl_stmt|;
name|pick
operator|=
name|compressed_hash
operator|&
name|NSID_RANGE_MASK
expr_stmt|;
name|pick
operator|=
operator|(
name|nsid
operator|->
name|nsid_state
operator|+
name|pick
operator|)
operator|&
name|NSID_POOL_MASK
expr_stmt|;
name|id
operator|=
name|nsid
operator|->
name|nsid_pool
index|[
name|pick
index|]
expr_stmt|;
if|if
condition|(
name|pick
operator|!=
literal|0
condition|)
block|{
comment|/* Swap two IDs to stir the pool */
name|nsid
operator|->
name|nsid_pool
index|[
name|pick
index|]
operator|=
name|nsid
operator|->
name|nsid_pool
index|[
name|nsid
operator|->
name|nsid_state
index|]
expr_stmt|;
name|nsid
operator|->
name|nsid_pool
index|[
name|nsid
operator|->
name|nsid_state
index|]
operator|=
name|id
expr_stmt|;
block|}
comment|/* increment the base pointer into the pool */
if|if
condition|(
name|nsid
operator|->
name|nsid_state
operator|==
literal|65535
condition|)
name|nsid
operator|->
name|nsid_state
operator|=
literal|0
expr_stmt|;
else|else
name|nsid
operator|->
name|nsid_state
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * This is the original Algorithm B 		 * j = ((u_long) NSID_SHUFFLE_TABLE_SIZE * nsid_state2)>> 16; 		 * 		 * We'll perturb it with some random stuff  ... 		 */
name|j
operator|=
operator|(
operator|(
name|isc_uint32_t
operator|)
name|NSID_SHUFFLE_TABLE_SIZE
operator|*
operator|(
name|nsid
operator|->
name|nsid_state2
operator|^
name|compressed_hash
operator|)
operator|)
operator|>>
literal|16
expr_stmt|;
name|nsid
operator|->
name|nsid_state2
operator|=
name|id
operator|=
name|nsid
operator|->
name|nsid_vtable
index|[
name|j
index|]
expr_stmt|;
name|nsid
operator|->
name|nsid_state
operator|=
operator|(
operator|(
operator|(
name|isc_uint32_t
operator|)
name|nsid
operator|->
name|nsid_a1
operator|*
name|nsid
operator|->
name|nsid_state
operator|)
operator|+
name|nsid
operator|->
name|nsid_c1
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|nsid
operator|->
name|nsid_vtable
index|[
name|j
index|]
operator|=
name|nsid
operator|->
name|nsid_state
expr_stmt|;
block|}
comment|/* Now lets obfuscate ... */
name|id
operator|=
operator|(
operator|(
operator|(
name|isc_uint32_t
operator|)
name|nsid
operator|->
name|nsid_a2
operator|*
name|id
operator|)
operator|+
name|nsid
operator|->
name|nsid_c2
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|id
operator|=
operator|(
operator|(
operator|(
name|isc_uint32_t
operator|)
name|nsid
operator|->
name|nsid_a3
operator|*
name|id
operator|)
operator|+
name|nsid
operator|->
name|nsid_c3
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
return|return
operator|(
name|id
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|nsid_init
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_nsid_t
modifier|*
name|nsid
parameter_list|,
name|isc_boolean_t
name|usepool
parameter_list|)
block|{
name|isc_time_t
name|now
decl_stmt|;
name|pid_t
name|mypid
decl_stmt|;
name|isc_uint16_t
name|a1ndx
decl_stmt|,
name|a2ndx
decl_stmt|,
name|a3ndx
decl_stmt|,
name|c1ndx
decl_stmt|,
name|c2ndx
decl_stmt|,
name|c3ndx
decl_stmt|;
name|int
name|i
decl_stmt|;
name|isc_time_now
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|mypid
operator|=
name|getpid
argument_list|()
expr_stmt|;
comment|/* Initialize the state */
name|memset
argument_list|(
name|nsid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nsid
argument_list|)
argument_list|)
expr_stmt|;
name|nsid_hash
argument_list|(
operator|&
name|now
argument_list|,
sizeof|sizeof
name|now
argument_list|)
expr_stmt|;
name|nsid_hash
argument_list|(
operator|&
name|mypid
argument_list|,
sizeof|sizeof
name|mypid
argument_list|)
expr_stmt|;
comment|/*          * Select our random number generators and initial seed.          * We could really use more random bits at this point,          * but we'll try to make a silk purse out of a sows ear ...          */
comment|/* generator 1 */
name|a1ndx
operator|=
operator|(
operator|(
name|isc_uint32_t
operator|)
name|NSID_MULT_TABLE_SIZE
operator|*
operator|(
name|nsid_hash_state
operator|&
literal|0xFFFF
operator|)
operator|)
operator|>>
literal|16
expr_stmt|;
name|nsid
operator|->
name|nsid_a1
operator|=
name|nsid_multiplier_table
index|[
name|a1ndx
index|]
expr_stmt|;
name|c1ndx
operator|=
operator|(
name|nsid_hash_state
operator|>>
literal|9
operator|)
operator|&
literal|0x7FFF
expr_stmt|;
name|nsid
operator|->
name|nsid_c1
operator|=
literal|2
operator|*
name|c1ndx
operator|+
literal|1
expr_stmt|;
comment|/* generator 2, distinct from 1 */
name|a2ndx
operator|=
operator|(
call|(
name|isc_uint32_t
call|)
argument_list|(
name|NSID_MULT_TABLE_SIZE
operator|-
literal|1
argument_list|)
operator|*
operator|(
operator|(
name|nsid_hash_state
operator|>>
literal|10
operator|)
operator|&
literal|0xFFFF
operator|)
operator|)
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|a2ndx
operator|>=
name|a1ndx
condition|)
name|a2ndx
operator|++
expr_stmt|;
name|nsid
operator|->
name|nsid_a2
operator|=
name|nsid_multiplier_table
index|[
name|a2ndx
index|]
expr_stmt|;
name|c2ndx
operator|=
name|nsid_hash_state
operator|%
literal|32767
expr_stmt|;
if|if
condition|(
name|c2ndx
operator|>=
name|c1ndx
condition|)
name|c2ndx
operator|++
expr_stmt|;
name|nsid
operator|->
name|nsid_c2
operator|=
literal|2
operator|*
name|c2ndx
operator|+
literal|1
expr_stmt|;
comment|/* generator 3, distinct from 1 and 2 */
name|a3ndx
operator|=
operator|(
call|(
name|isc_uint32_t
call|)
argument_list|(
name|NSID_MULT_TABLE_SIZE
operator|-
literal|2
argument_list|)
operator|*
operator|(
operator|(
name|nsid_hash_state
operator|>>
literal|20
operator|)
operator|&
literal|0xFFFF
operator|)
operator|)
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|a3ndx
operator|>=
name|a1ndx
operator|||
name|a3ndx
operator|>=
name|a2ndx
condition|)
name|a3ndx
operator|++
expr_stmt|;
if|if
condition|(
name|a3ndx
operator|>=
name|a1ndx
operator|&&
name|a3ndx
operator|>=
name|a2ndx
condition|)
name|a3ndx
operator|++
expr_stmt|;
name|nsid
operator|->
name|nsid_a3
operator|=
name|nsid_multiplier_table
index|[
name|a3ndx
index|]
expr_stmt|;
name|c3ndx
operator|=
name|nsid_hash_state
operator|%
literal|32766
expr_stmt|;
if|if
condition|(
name|c3ndx
operator|>=
name|c1ndx
operator|||
name|c3ndx
operator|>=
name|c2ndx
condition|)
name|c3ndx
operator|++
expr_stmt|;
if|if
condition|(
name|c3ndx
operator|>=
name|c1ndx
operator|&&
name|c3ndx
operator|>=
name|c2ndx
condition|)
name|c3ndx
operator|++
expr_stmt|;
name|nsid
operator|->
name|nsid_c3
operator|=
literal|2
operator|*
name|c3ndx
operator|+
literal|1
expr_stmt|;
name|nsid
operator|->
name|nsid_state
operator|=
operator|(
operator|(
name|nsid_hash_state
operator|>>
literal|16
operator|)
operator|^
operator|(
name|nsid_hash_state
operator|)
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|nsid
operator|->
name|nsid_usepool
operator|=
name|usepool
expr_stmt|;
if|if
condition|(
name|nsid
operator|->
name|nsid_usepool
condition|)
block|{
name|nsid
operator|->
name|nsid_pool
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
literal|0x10000
operator|*
sizeof|sizeof
argument_list|(
name|isc_uint16_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsid
operator|->
name|nsid_pool
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
name|nsid
operator|->
name|nsid_pool
index|[
name|i
index|]
operator|=
name|nsid
operator|->
name|nsid_state
expr_stmt|;
name|nsid
operator|->
name|nsid_state
operator|=
operator|(
operator|(
operator|(
name|u_long
operator|)
name|nsid
operator|->
name|nsid_a1
operator|*
name|nsid
operator|->
name|nsid_state
operator|)
operator|+
name|nsid
operator|->
name|nsid_c1
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0xFFFF
condition|)
break|break;
block|}
block|}
else|else
block|{
name|nsid
operator|->
name|nsid_vtable
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
name|NSID_SHUFFLE_TABLE_SIZE
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|isc_uint16_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsid
operator|->
name|nsid_vtable
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NSID_SHUFFLE_TABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|nsid
operator|->
name|nsid_vtable
index|[
name|i
index|]
operator|=
name|nsid
operator|->
name|nsid_state
expr_stmt|;
name|nsid
operator|->
name|nsid_state
operator|=
operator|(
operator|(
operator|(
name|isc_uint32_t
operator|)
name|nsid
operator|->
name|nsid_a1
operator|*
name|nsid
operator|->
name|nsid_state
operator|)
operator|+
name|nsid
operator|->
name|nsid_c1
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
block|}
name|nsid
operator|->
name|nsid_state2
operator|=
name|nsid
operator|->
name|nsid_state
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nsid_destroy
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_nsid_t
modifier|*
name|nsid
parameter_list|)
block|{
if|if
condition|(
name|nsid
operator|->
name|nsid_usepool
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|nsid
operator|->
name|nsid_pool
argument_list|,
literal|0x10000
operator|*
sizeof|sizeof
argument_list|(
name|isc_uint16_t
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|nsid
operator|->
name|nsid_vtable
argument_list|,
name|NSID_SHUFFLE_TABLE_SIZE
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|isc_uint16_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|nsid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nsid
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_dispatch_hash
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|nsid_hash
argument_list|(
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


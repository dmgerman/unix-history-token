begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2000-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: validator.c,v 1.91.2.5.8.12 2004/06/11 01:17:36 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/ds.h>
end_include

begin_include
include|#
directive|include
file|<dns/dnssec.h>
end_include

begin_include
include|#
directive|include
file|<dns/events.h>
end_include

begin_include
include|#
directive|include
file|<dns/keytable.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/message.h>
end_include

begin_include
include|#
directive|include
file|<dns/ncache.h>
end_include

begin_include
include|#
directive|include
file|<dns/nsec.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatastruct.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/resolver.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/validator.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_define
define|#
directive|define
name|VALIDATOR_MAGIC
value|ISC_MAGIC('V', 'a', 'l', '?')
end_define

begin_define
define|#
directive|define
name|VALID_VALIDATOR
parameter_list|(
name|v
parameter_list|)
value|ISC_MAGIC_VALID(v, VALIDATOR_MAGIC)
end_define

begin_define
define|#
directive|define
name|VALATTR_SHUTDOWN
value|0x0001
end_define

begin_define
define|#
directive|define
name|VALATTR_FOUNDNONEXISTENCE
value|0x0002
end_define

begin_define
define|#
directive|define
name|VALATTR_TRIEDVERIFY
value|0x0004
end_define

begin_define
define|#
directive|define
name|VALATTR_NEGATIVE
value|0x0008
end_define

begin_define
define|#
directive|define
name|VALATTR_INSECURITY
value|0x0010
end_define

begin_define
define|#
directive|define
name|VALATTR_DLV
value|0x0020
end_define

begin_define
define|#
directive|define
name|VALATTR_DLVTRIED
value|0x0040
end_define

begin_define
define|#
directive|define
name|VALATTR_DLVSEPTRIED
value|0x0080
end_define

begin_define
define|#
directive|define
name|VALATTR_NEEDNOQNAME
value|0x0100
end_define

begin_define
define|#
directive|define
name|VALATTR_NEEDNOWILDCARD
value|0x0200
end_define

begin_define
define|#
directive|define
name|VALATTR_NEEDNODATA
value|0x0400
end_define

begin_define
define|#
directive|define
name|VALATTR_FOUNDNOQNAME
value|0x1000
end_define

begin_define
define|#
directive|define
name|VALATTR_FOUNDNOWILDCARD
value|0x2000
end_define

begin_define
define|#
directive|define
name|VALATTR_FOUNDNODATA
value|0x4000
end_define

begin_define
define|#
directive|define
name|NEEDNODATA
parameter_list|(
name|val
parameter_list|)
value|((val->attributes& VALATTR_NEEDNODATA) != 0)
end_define

begin_define
define|#
directive|define
name|NEEDNOQNAME
parameter_list|(
name|val
parameter_list|)
value|((val->attributes& VALATTR_NEEDNOQNAME) != 0)
end_define

begin_define
define|#
directive|define
name|NEEDNOWILDCARD
parameter_list|(
name|val
parameter_list|)
value|((val->attributes& VALATTR_NEEDNOWILDCARD) != 0)
end_define

begin_define
define|#
directive|define
name|DLV
parameter_list|(
name|val
parameter_list|)
value|((val->attributes& VALATTR_DLV) != 0)
end_define

begin_define
define|#
directive|define
name|DLVTRIED
parameter_list|(
name|val
parameter_list|)
value|((val->attributes& VALATTR_DLVTRIED) != 0)
end_define

begin_define
define|#
directive|define
name|DLVSEPTRIED
parameter_list|(
name|val
parameter_list|)
value|((val->attributes& VALATTR_DLVSEPTRIED) != 0)
end_define

begin_define
define|#
directive|define
name|SHUTDOWN
parameter_list|(
name|v
parameter_list|)
value|(((v)->attributes& VALATTR_SHUTDOWN) != 0)
end_define

begin_function_decl
specifier|static
name|void
name|destroy
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|get_dst_key
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_rdata_rrsig_t
modifier|*
name|siginfo
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|validate
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_boolean_t
name|resume
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|validatezonekey
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|nsecvalidate
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_boolean_t
name|resume
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|proveunsecure
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_boolean_t
name|resume
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|validator_logv
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_logcategory_t
modifier|*
name|category
parameter_list|,
name|isc_logmodule_t
modifier|*
name|module
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|5
operator|,
function_decl|0
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function_decl
specifier|static
name|void
name|validator_log
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|3
operator|,
function_decl|4
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function_decl
specifier|static
name|void
name|validator_logcreate
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|caller
parameter_list|,
specifier|const
name|char
modifier|*
name|operation
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dlv_validatezonekey
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|finddlvsep
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_boolean_t
name|resume
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|validator_done
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_result_t
name|result
parameter_list|)
block|{
name|isc_task_t
modifier|*
name|task
decl_stmt|;
if|if
condition|(
name|val
operator|->
name|event
operator|==
name|NULL
condition|)
return|return;
comment|/* 	 * Caller must be holding the lock. 	 */
name|val
operator|->
name|event
operator|->
name|result
operator|=
name|result
expr_stmt|;
name|task
operator|=
name|val
operator|->
name|event
operator|->
name|ev_sender
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|ev_sender
operator|=
name|val
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|ev_type
operator|=
name|DNS_EVENT_VALIDATORDONE
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|ev_action
operator|=
name|val
operator|->
name|action
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|ev_arg
operator|=
name|val
operator|->
name|arg
expr_stmt|;
name|isc_task_sendanddetach
argument_list|(
operator|&
name|task
argument_list|,
operator|(
name|isc_event_t
operator|*
operator|*
operator|)
operator|&
name|val
operator|->
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|exit_check
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
block|{
comment|/* 	 * Caller must be holding the lock. 	 */
if|if
condition|(
operator|!
name|SHUTDOWN
argument_list|(
name|val
argument_list|)
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|fetch
operator|!=
name|NULL
operator|||
name|val
operator|->
name|subvalidator
operator|!=
name|NULL
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|auth_nonpending
parameter_list|(
name|dns_message_t
modifier|*
name|message
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
for|for
control|(
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_message_nextname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|)
control|)
block|{
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rdataset
operator|!=
name|NULL
condition|;
name|rdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|rdataset
operator|->
name|trust
operator|==
name|dns_trust_pending
condition|)
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_authauthority
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|isdelegation
parameter_list|(
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|isc_result_t
name|dbresult
parameter_list|)
block|{
name|dns_rdataset_t
name|set
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_boolean_t
name|found
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|dbresult
operator|==
name|DNS_R_NXRRSET
operator|||
name|dbresult
operator|==
name|DNS_R_NCACHENXRRSET
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbresult
operator|==
name|DNS_R_NXRRSET
condition|)
name|dns_rdataset_clone
argument_list|(
name|rdataset
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
else|else
block|{
name|result
operator|=
name|dns_ncache_getrdataset
argument_list|(
name|rdataset
argument_list|,
name|name
argument_list|,
name|dns_rdatatype_nsec
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
name|INSIST
argument_list|(
name|set
operator|.
name|type
operator|==
name|dns_rdatatype_nsec
argument_list|)
expr_stmt|;
name|found
operator|=
name|ISC_FALSE
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_rdataset_current
argument_list|(
operator|&
name|set
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|found
operator|=
name|dns_nsec_typepresent
argument_list|(
operator|&
name|rdata
argument_list|,
name|dns_rdatatype_ns
argument_list|)
expr_stmt|;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
return|return
operator|(
name|found
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|fetch_callback_validator
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_fetchevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_FETCHDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_fetchevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|rdataset
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
name|eresult
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|dns_resolver_destroyfetch
argument_list|(
operator|&
name|val
operator|->
name|fetch
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in fetch_callback_validator"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"keyset with trust %d"
argument_list|,
name|rdataset
operator|->
name|trust
argument_list|)
expr_stmt|;
comment|/* 		 * Only extract the dst key if the keyset is secure. 		 */
if|if
condition|(
name|rdataset
operator|->
name|trust
operator|>=
name|dns_trust_secure
condition|)
block|{
name|result
operator|=
name|get_dst_key
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|siginfo
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|val
operator|->
name|keyset
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
block|}
name|result
operator|=
name|validate
argument_list|(
name|val
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"fetch_callback_validator: got %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|eresult
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_CANCELED
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
else|else
name|validator_done
argument_list|(
name|val
argument_list|,
name|DNS_R_NOVALIDKEY
argument_list|)
expr_stmt|;
block|}
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dsfetched
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_fetchevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_FETCHDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_fetchevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|rdataset
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
name|eresult
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|dns_resolver_destroyfetch
argument_list|(
operator|&
name|val
operator|->
name|fetch
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in dsfetched"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dsset with trust %d"
argument_list|,
name|rdataset
operator|->
name|trust
argument_list|)
expr_stmt|;
name|val
operator|->
name|dsset
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
name|result
operator|=
name|validatezonekey
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|view
operator|->
name|dlv
operator|!=
name|NULL
operator|&&
operator|!
name|DLVTRIED
argument_list|(
name|val
argument_list|)
operator|&&
operator|(
name|eresult
operator|==
name|DNS_R_NXRRSET
operator|||
name|eresult
operator|==
name|DNS_R_NCACHENXRRSET
operator|)
operator|&&
operator|!
name|dns_name_issubdomain
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|val
operator|->
name|view
operator|->
name|dlv
argument_list|)
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"no DS record: looking for DLV"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dlv_validatezonekey
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|eresult
operator|==
name|DNS_R_NXRRSET
operator|||
name|eresult
operator|==
name|DNS_R_NCACHENXRRSET
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"falling back to insecurity proof"
argument_list|)
expr_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_INSECURITY
expr_stmt|;
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dsfetched: got %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|eresult
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_CANCELED
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
else|else
name|validator_done
argument_list|(
name|val
argument_list|,
name|DNS_R_NOVALIDDS
argument_list|)
expr_stmt|;
block|}
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * XXX there's too much duplicated code here.  */
end_comment

begin_function
specifier|static
name|void
name|dsfetched2
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_fetchevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|dns_name_t
modifier|*
name|tname
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_FETCHDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_fetchevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|rdataset
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
name|eresult
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|dns_resolver_destroyfetch
argument_list|(
operator|&
name|val
operator|->
name|fetch
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in dsfetched2"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|DNS_R_NXRRSET
operator|||
name|eresult
operator|==
name|DNS_R_NCACHENXRRSET
condition|)
block|{
comment|/* 		 * There is no DS.  If this is a delegation, we're done. 		 */
name|tname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|devent
operator|->
name|foundname
argument_list|)
expr_stmt|;
if|if
condition|(
name|isdelegation
argument_list|(
name|tname
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|,
name|eresult
argument_list|)
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|mustbesecure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"must be secure failure"
argument_list|)
expr_stmt|;
name|validator_done
argument_list|(
name|val
argument_list|,
name|DNS_R_MUSTBESECURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|validator_done
argument_list|(
name|val
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
operator|||
name|eresult
operator|==
name|DNS_R_NXDOMAIN
operator|||
name|eresult
operator|==
name|DNS_R_NCACHENXDOMAIN
condition|)
block|{
comment|/* 		 * Either there is a DS or this is not a zone cut.  Continue. 		 */
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|eresult
operator|==
name|ISC_R_CANCELED
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
else|else
name|validator_done
argument_list|(
name|val
argument_list|,
name|DNS_R_NOVALIDDS
argument_list|)
expr_stmt|;
block|}
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|keyvalidated
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_validatorevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_VALIDATORDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_validatorevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|eresult
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|dns_validator_destroy
argument_list|(
operator|&
name|val
operator|->
name|subvalidator
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in keyvalidated"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"keyset with trust %d"
argument_list|,
name|val
operator|->
name|frdataset
operator|.
name|trust
argument_list|)
expr_stmt|;
comment|/* 		 * Only extract the dst key if the keyset is secure. 		 */
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|>=
name|dns_trust_secure
condition|)
operator|(
name|void
operator|)
name|get_dst_key
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|siginfo
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
name|result
operator|=
name|validate
argument_list|(
name|val
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"keyvalidated: got %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|eresult
argument_list|)
argument_list|)
expr_stmt|;
name|validator_done
argument_list|(
name|val
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
block|}
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dsvalidated
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_validatorevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_VALIDATORDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_validatorevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|eresult
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|dns_validator_destroy
argument_list|(
operator|&
name|val
operator|->
name|subvalidator
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in dsvalidated"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dsset with trust %d"
argument_list|,
name|val
operator|->
name|frdataset
operator|.
name|trust
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_INSECURITY
operator|)
operator|!=
literal|0
condition|)
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|validatezonekey
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dsvalidated: got %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|eresult
argument_list|)
argument_list|)
expr_stmt|;
name|validator_done
argument_list|(
name|val
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
block|}
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Return ISC_R_SUCCESS if we can determine that the name doesn't exist  * or we can determine whether there is data or not at the name.  * If the name does not exist return the wildcard name.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|nsecnoexistnodata
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_name_t
modifier|*
name|nsecname
parameter_list|,
name|dns_rdataset_t
modifier|*
name|nsecset
parameter_list|,
name|isc_boolean_t
modifier|*
name|exists
parameter_list|,
name|isc_boolean_t
modifier|*
name|data
parameter_list|,
name|dns_name_t
modifier|*
name|wild
parameter_list|)
block|{
name|int
name|order
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_namereln_t
name|relation
decl_stmt|;
name|unsigned
name|int
name|olabels
decl_stmt|,
name|nlabels
decl_stmt|,
name|labels
decl_stmt|;
name|dns_rdata_nsec_t
name|nsec
decl_stmt|;
name|isc_boolean_t
name|atparent
decl_stmt|;
name|REQUIRE
argument_list|(
name|exists
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|nsecset
operator|!=
name|NULL
operator|&&
name|nsecset
operator|->
name|type
operator|==
name|dns_rdatatype_nsec
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|nsecset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"failure processing NSEC set"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|dns_rdataset_current
argument_list|(
name|nsecset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"looking for relevant nsec"
argument_list|)
expr_stmt|;
name|relation
operator|=
name|dns_name_fullcompare
argument_list|(
name|name
argument_list|,
name|nsecname
argument_list|,
operator|&
name|order
argument_list|,
operator|&
name|olabels
argument_list|)
expr_stmt|;
if|if
condition|(
name|order
operator|<
literal|0
condition|)
block|{
comment|/* 		 * The name is not within the NSEC range. 		 */
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"NSEC does not cover name, before NSEC"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_IGNORE
operator|)
return|;
block|}
if|if
condition|(
name|order
operator|==
literal|0
condition|)
block|{
comment|/* 		 * The names are the same. 		 */
name|atparent
operator|=
name|dns_rdatatype_atparent
argument_list|(
name|val
operator|->
name|event
operator|->
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_nsec_typepresent
argument_list|(
operator|&
name|rdata
argument_list|,
name|dns_rdatatype_ns
argument_list|)
operator|&&
operator|!
name|dns_nsec_typepresent
argument_list|(
operator|&
name|rdata
argument_list|,
name|dns_rdatatype_soa
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|atparent
condition|)
block|{
comment|/* 				 * This NSEC record is from somewhere higher in 				 * the DNS, and at the parent of a delegation. 				 * It can not be legitimately used here. 				 */
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"ignoring parent nsec"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_IGNORE
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|atparent
condition|)
block|{
comment|/* 			 * This NSEC record is from the child. 			 * It can not be legitimately used here. 			 */
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"ignoring child nsec"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_IGNORE
operator|)
return|;
block|}
operator|*
name|exists
operator|=
name|ISC_TRUE
expr_stmt|;
operator|*
name|data
operator|=
name|dns_nsec_typepresent
argument_list|(
operator|&
name|rdata
argument_list|,
name|val
operator|->
name|event
operator|->
name|type
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"nsec proves name exists (owner) data=%d"
argument_list|,
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
if|if
condition|(
name|relation
operator|==
name|dns_namereln_subdomain
operator|&&
name|dns_nsec_typepresent
argument_list|(
operator|&
name|rdata
argument_list|,
name|dns_rdatatype_ns
argument_list|)
operator|&&
operator|!
name|dns_nsec_typepresent
argument_list|(
operator|&
name|rdata
argument_list|,
name|dns_rdatatype_soa
argument_list|)
condition|)
block|{
comment|/* 		 * This NSEC record is from somewhere higher in 		 * the DNS, and at the parent of a delegation. 		 * It can not be legitimately used here. 		 */
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"ignoring parent nsec"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_IGNORE
operator|)
return|;
block|}
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|nsec
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|relation
operator|=
name|dns_name_fullcompare
argument_list|(
operator|&
name|nsec
operator|.
name|next
argument_list|,
name|name
argument_list|,
operator|&
name|order
argument_list|,
operator|&
name|nlabels
argument_list|)
expr_stmt|;
if|if
condition|(
name|order
operator|==
literal|0
condition|)
block|{
name|dns_rdata_freestruct
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"ignoring nsec matches next name"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_IGNORE
operator|)
return|;
block|}
if|if
condition|(
name|order
operator|<
literal|0
operator|&&
operator|!
name|dns_name_issubdomain
argument_list|(
name|nsecname
argument_list|,
operator|&
name|nsec
operator|.
name|next
argument_list|)
condition|)
block|{
comment|/* 		 * The name is not within the NSEC range. 		 */
name|dns_rdata_freestruct
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"ignoring nsec because name is past end of range"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_IGNORE
operator|)
return|;
block|}
if|if
condition|(
name|order
operator|>
literal|0
operator|&&
name|relation
operator|==
name|dns_namereln_subdomain
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"nsec proves name exist (empty)"
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
operator|*
name|exists
operator|=
name|ISC_TRUE
expr_stmt|;
operator|*
name|data
operator|=
name|ISC_FALSE
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
if|if
condition|(
name|wild
operator|!=
name|NULL
condition|)
block|{
name|dns_name_t
name|common
decl_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|common
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|olabels
operator|>
name|nlabels
condition|)
block|{
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|nsecname
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|nsecname
argument_list|,
name|labels
operator|-
name|olabels
argument_list|,
name|olabels
argument_list|,
operator|&
name|common
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
operator|&
name|nsec
operator|.
name|next
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
operator|&
name|nsec
operator|.
name|next
argument_list|,
name|labels
operator|-
name|nlabels
argument_list|,
name|nlabels
argument_list|,
operator|&
name|common
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_name_concatenate
argument_list|(
name|dns_wildcardname
argument_list|,
operator|&
name|common
argument_list|,
name|wild
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"failure generating wilcard name"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
name|dns_rdata_freestruct
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"nsec range ok"
argument_list|)
expr_stmt|;
operator|*
name|exists
operator|=
name|ISC_FALSE
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|authvalidated
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_validatorevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|,
modifier|*
name|sigrdataset
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_boolean_t
name|exists
decl_stmt|,
name|data
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_VALIDATORDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_validatorevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|rdataset
operator|=
name|devent
operator|->
name|rdataset
expr_stmt|;
name|sigrdataset
operator|=
name|devent
operator|->
name|sigrdataset
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|result
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|dns_validator_destroy
argument_list|(
operator|&
name|val
operator|->
name|subvalidator
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in authvalidated"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"authvalidated: got %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_CANCELED
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
else|else
block|{
name|result
operator|=
name|nsecvalidate
argument_list|(
name|val
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|dns_name_t
modifier|*
modifier|*
name|proofs
init|=
name|val
operator|->
name|event
operator|->
name|proofs
decl_stmt|;
if|if
condition|(
name|rdataset
operator|->
name|trust
operator|==
name|dns_trust_secure
condition|)
name|val
operator|->
name|seensig
operator|=
name|ISC_TRUE
expr_stmt|;
if|if
condition|(
name|rdataset
operator|->
name|type
operator|==
name|dns_rdatatype_nsec
operator|&&
name|rdataset
operator|->
name|trust
operator|==
name|dns_trust_secure
operator|&&
operator|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNODATA
operator|)
operator|!=
literal|0
operator|||
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNOQNAME
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNODATA
operator|)
operator|==
literal|0
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNOQNAME
operator|)
operator|==
literal|0
operator|&&
name|nsecnoexistnodata
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|devent
operator|->
name|name
argument_list|,
name|rdataset
argument_list|,
operator|&
name|exists
argument_list|,
operator|&
name|data
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|val
operator|->
name|wild
argument_list|)
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|exists
operator|&&
operator|!
name|data
condition|)
block|{
name|val
operator|->
name|attributes
operator||=
name|VALATTR_FOUNDNODATA
expr_stmt|;
if|if
condition|(
name|NEEDNODATA
argument_list|(
name|val
argument_list|)
condition|)
name|proofs
index|[
name|DNS_VALIDATOR_NODATAPROOF
index|]
operator|=
name|devent
operator|->
name|name
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|exists
condition|)
block|{
name|val
operator|->
name|attributes
operator||=
name|VALATTR_FOUNDNOQNAME
expr_stmt|;
if|if
condition|(
name|NEEDNOQNAME
argument_list|(
name|val
argument_list|)
condition|)
name|proofs
index|[
name|DNS_VALIDATOR_NOQNAMEPROOF
index|]
operator|=
name|devent
operator|->
name|name
expr_stmt|;
block|}
block|}
name|result
operator|=
name|nsecvalidate
argument_list|(
name|val
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
comment|/* 	 * Free stuff from the event. 	 */
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|negauthvalidated
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_validatorevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_VALIDATORDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_validatorevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|eresult
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|dns_validator_destroy
argument_list|(
operator|&
name|val
operator|->
name|subvalidator
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in negauthvalidated"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|val
operator|->
name|attributes
operator||=
name|VALATTR_FOUNDNONEXISTENCE
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"nonexistence proof found"
argument_list|)
expr_stmt|;
name|auth_nonpending
argument_list|(
name|val
operator|->
name|event
operator|->
name|message
argument_list|)
expr_stmt|;
name|validator_done
argument_list|(
name|val
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"negauthvalidated: got %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|eresult
argument_list|)
argument_list|)
expr_stmt|;
name|validator_done
argument_list|(
name|val
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
block|}
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_result_t
name|view_find
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|)
block|{
name|dns_fixedname_t
name|fixedname
decl_stmt|;
name|dns_name_t
modifier|*
name|foundname
decl_stmt|;
name|dns_rdata_nsec_t
name|nsec
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|options
decl_stmt|;
name|char
name|buf1
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|buf2
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|buf3
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|view
operator|->
name|zonetable
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_CANCELED
operator|)
return|;
name|options
operator|=
name|DNS_DBFIND_PENDINGOK
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_dlv
condition|)
name|options
operator||=
name|DNS_DBFIND_COVERINGNSEC
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixedname
argument_list|)
expr_stmt|;
name|foundname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixedname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_view_find
argument_list|(
name|val
operator|->
name|view
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
literal|0
argument_list|,
name|options
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|foundname
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|,
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_NXDOMAIN
condition|)
block|{
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|DNS_R_COVERINGNSEC
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"DNS_R_COVERINGNSEC"
argument_list|)
expr_stmt|;
comment|/* 		 * Check if the returned NSEC covers the name. 		 */
name|INSIST
argument_list|(
name|type
operator|==
name|dns_rdatatype_dlv
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|!=
name|dns_trust_secure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"covering nsec: trust %u"
argument_list|,
name|val
operator|->
name|frdataset
operator|.
name|trust
argument_list|)
expr_stmt|;
goto|goto
name|notfound
goto|;
block|}
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|notfound
goto|;
name|dns_rdataset_current
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_nsec_typepresent
argument_list|(
operator|&
name|rdata
argument_list|,
name|dns_rdatatype_ns
argument_list|)
operator|&&
operator|!
name|dns_nsec_typepresent
argument_list|(
operator|&
name|rdata
argument_list|,
name|dns_rdatatype_soa
argument_list|)
condition|)
block|{
comment|/* Parent NSEC record. */
if|if
condition|(
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
name|foundname
argument_list|)
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"covering nsec: for parent"
argument_list|)
expr_stmt|;
goto|goto
name|notfound
goto|;
block|}
block|}
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|nsec
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|notfound
goto|;
if|if
condition|(
name|dns_name_compare
argument_list|(
name|foundname
argument_list|,
operator|&
name|nsec
operator|.
name|next
argument_list|)
operator|>=
literal|0
condition|)
block|{
comment|/* End of zone chain. */
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
operator|&
name|nsec
operator|.
name|next
argument_list|)
condition|)
block|{
comment|/*  				 * XXXMPA We could look for a parent NSEC 				 * at nsec.next and if found retest with 				 * this NSEC. 				 */
name|dns_rdata_freestruct
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"covering nsec: not in zone"
argument_list|)
expr_stmt|;
goto|goto
name|notfound
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|dns_name_compare
argument_list|(
name|name
argument_list|,
operator|&
name|nsec
operator|.
name|next
argument_list|)
operator|>=
literal|0
condition|)
block|{
comment|/* 			 * XXXMPA We could check if this NSEC is at a zone 			 * apex and if the qname is not below it and look for 			 * a parent NSEC with the same name.  This requires 			 * that we can cache both NSEC records which we 			 * currently don't support. 			 */
name|dns_rdata_freestruct
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"covering nsec: not in range"
argument_list|)
expr_stmt|;
goto|goto
name|notfound
goto|;
block|}
if|if
condition|(
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|)
condition|)
block|{
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|buf1
argument_list|,
sizeof|sizeof
name|buf1
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
name|foundname
argument_list|,
name|buf2
argument_list|,
sizeof|sizeof
name|buf2
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
operator|&
name|nsec
operator|.
name|next
argument_list|,
name|buf3
argument_list|,
sizeof|sizeof
name|buf3
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"covering nsec found: '%s' '%s' '%s'"
argument_list|,
name|buf1
argument_list|,
name|buf2
argument_list|,
name|buf3
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
name|dns_rdata_freestruct
argument_list|(
operator|&
name|nsec
argument_list|)
expr_stmt|;
name|result
operator|=
name|DNS_R_NCACHENXDOMAIN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|DNS_R_GLUE
operator|&&
name|result
operator|!=
name|DNS_R_HINT
operator|&&
name|result
operator|!=
name|DNS_R_NCACHENXDOMAIN
operator|&&
name|result
operator|!=
name|DNS_R_NCACHENXRRSET
operator|&&
name|result
operator|!=
name|DNS_R_NXRRSET
operator|&&
name|result
operator|!=
name|DNS_R_HINTNXRRSET
operator|&&
name|result
operator|!=
name|ISC_R_NOTFOUND
condition|)
block|{
goto|goto
name|notfound
goto|;
block|}
return|return
operator|(
name|result
operator|)
return|;
name|notfound
label|:
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_boolean_t
name|check_deadlock
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|)
block|{
name|dns_validator_t
modifier|*
name|parent
decl_stmt|;
for|for
control|(
name|parent
operator|=
name|val
operator|->
name|parent
init|;
name|parent
operator|!=
name|NULL
condition|;
name|parent
operator|=
name|parent
operator|->
name|parent
control|)
block|{
if|if
condition|(
name|parent
operator|->
name|event
operator|!=
name|NULL
operator|&&
name|parent
operator|->
name|event
operator|->
name|type
operator|==
name|type
operator|&&
name|dns_name_equal
argument_list|(
name|parent
operator|->
name|event
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"continuing validation would lead to "
literal|"deadlock: aborting validation"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_result_t
name|create_fetch
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|isc_taskaction_t
name|callback
parameter_list|,
specifier|const
name|char
modifier|*
name|caller
parameter_list|)
block|{
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_deadlock
argument_list|(
name|val
argument_list|,
name|name
argument_list|,
name|type
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
name|validator_logcreate
argument_list|(
name|val
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|caller
argument_list|,
literal|"fetch"
argument_list|)
expr_stmt|;
return|return
operator|(
name|dns_resolver_createfetch
argument_list|(
name|val
operator|->
name|view
operator|->
name|resolver
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|val
operator|->
name|event
operator|->
name|ev_sender
argument_list|,
name|callback
argument_list|,
name|val
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|,
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|,
operator|&
name|val
operator|->
name|fetch
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|isc_result_t
name|create_validator
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|sigrdataset
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
specifier|const
name|char
modifier|*
name|caller
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|check_deadlock
argument_list|(
name|val
argument_list|,
name|name
argument_list|,
name|type
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
name|validator_logcreate
argument_list|(
name|val
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|caller
argument_list|,
literal|"validator"
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_validator_create
argument_list|(
name|val
operator|->
name|view
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|val
operator|->
name|task
argument_list|,
name|action
argument_list|,
name|val
argument_list|,
operator|&
name|val
operator|->
name|subvalidator
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|val
operator|->
name|subvalidator
operator|->
name|parent
operator|=
name|val
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Try to find a key that could have signed 'siginfo' among those  * in 'rdataset'.  If found, build a dst_key_t for it and point  * val->key at it.  *  * If val->key is non-NULL, this returns the next matching key.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|get_dst_key
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_rdata_rrsig_t
modifier|*
name|siginfo
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dst_key_t
modifier|*
name|oldkey
init|=
name|val
operator|->
name|key
decl_stmt|;
name|isc_boolean_t
name|foundold
decl_stmt|;
if|if
condition|(
name|oldkey
operator|==
name|NULL
condition|)
name|foundold
operator|=
name|ISC_TRUE
expr_stmt|;
else|else
block|{
name|foundold
operator|=
name|ISC_FALSE
expr_stmt|;
name|val
operator|->
name|key
operator|=
name|NULL
expr_stmt|;
block|}
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
do|do
block|{
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|rdata
operator|.
name|data
argument_list|,
name|rdata
operator|.
name|length
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|rdata
operator|.
name|length
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|key
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dst_key_fromdns
argument_list|(
operator|&
name|siginfo
operator|->
name|signer
argument_list|,
name|rdata
operator|.
name|rdclass
argument_list|,
operator|&
name|b
argument_list|,
name|val
operator|->
name|view
operator|->
name|mctx
argument_list|,
operator|&
name|val
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
if|if
condition|(
name|siginfo
operator|->
name|algorithm
operator|==
operator|(
name|dns_secalg_t
operator|)
name|dst_key_alg
argument_list|(
name|val
operator|->
name|key
argument_list|)
operator|&&
name|siginfo
operator|->
name|keyid
operator|==
operator|(
name|dns_keytag_t
operator|)
name|dst_key_id
argument_list|(
name|val
operator|->
name|key
argument_list|)
operator|&&
name|dst_key_iszonekey
argument_list|(
name|val
operator|->
name|key
argument_list|)
condition|)
block|{
if|if
condition|(
name|foundold
condition|)
comment|/* 				 * This is the key we're looking for. 				 */
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
elseif|else
if|if
condition|(
name|dst_key_compare
argument_list|(
name|oldkey
argument_list|,
name|val
operator|->
name|key
argument_list|)
operator|==
name|ISC_TRUE
condition|)
block|{
name|foundold
operator|=
name|ISC_TRUE
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|oldkey
argument_list|)
expr_stmt|;
block|}
block|}
name|dst_key_free
argument_list|(
operator|&
name|val
operator|->
name|key
argument_list|)
expr_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
do|;
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|result
operator|=
name|ISC_R_NOTFOUND
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|oldkey
operator|!=
name|NULL
condition|)
name|dst_key_free
argument_list|(
operator|&
name|oldkey
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|get_key
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_rdata_rrsig_t
modifier|*
name|siginfo
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|nlabels
decl_stmt|;
name|int
name|order
decl_stmt|;
name|dns_namereln_t
name|namereln
decl_stmt|;
comment|/* 	 * Is the signer name appropriate for this signature? 	 * 	 * The signer name must be at the same level as the owner name 	 * or closer to the the DNS root. 	 */
name|namereln
operator|=
name|dns_name_fullcompare
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
operator|&
name|siginfo
operator|->
name|signer
argument_list|,
operator|&
name|order
argument_list|,
operator|&
name|nlabels
argument_list|)
expr_stmt|;
if|if
condition|(
name|namereln
operator|!=
name|dns_namereln_subdomain
operator|&&
name|namereln
operator|!=
name|dns_namereln_equal
condition|)
return|return
operator|(
name|DNS_R_CONTINUE
operator|)
return|;
if|if
condition|(
name|namereln
operator|==
name|dns_namereln_equal
condition|)
block|{
comment|/* 		 * If this is a self-signed keyset, it must not be a zone key 		 * (since get_key is not called from validatezonekey). 		 */
if|if
condition|(
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|type
operator|==
name|dns_rdatatype_dnskey
condition|)
return|return
operator|(
name|DNS_R_CONTINUE
operator|)
return|;
comment|/* 		 * Records appearing in the parent zone at delegation 		 * points cannot be self-signed. 		 */
if|if
condition|(
name|dns_rdatatype_atparent
argument_list|(
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|type
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_CONTINUE
operator|)
return|;
block|}
comment|/* 	 * Do we know about this key? 	 */
name|result
operator|=
name|view_find
argument_list|(
name|val
argument_list|,
operator|&
name|siginfo
operator|->
name|signer
argument_list|,
name|dns_rdatatype_dnskey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 		 * We have an rrset for the given keyname. 		 */
name|val
operator|->
name|keyset
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|==
name|dns_trust_pending
operator|&&
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
block|{
comment|/* 			 * We know the key but haven't validated it yet. 			 */
name|result
operator|=
name|create_validator
argument_list|(
name|val
argument_list|,
operator|&
name|siginfo
operator|->
name|signer
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|,
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|,
name|keyvalidated
argument_list|,
literal|"get_key"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|==
name|dns_trust_pending
condition|)
block|{
comment|/* 			 * Having a pending key with no signature means that 			 * something is broken. 			 */
name|result
operator|=
name|DNS_R_CONTINUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|<
name|dns_trust_secure
condition|)
block|{
comment|/* 			 * The key is legitimately insecure.  There's no 			 * point in even attempting verification. 			 */
name|val
operator|->
name|key
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * See if we've got the key used in the signature. 			 */
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"keyset with trust %d"
argument_list|,
name|val
operator|->
name|frdataset
operator|.
name|trust
argument_list|)
expr_stmt|;
name|result
operator|=
name|get_dst_key
argument_list|(
name|val
argument_list|,
name|siginfo
argument_list|,
name|val
operator|->
name|keyset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 				 * Either the key we're looking for is not 				 * in the rrset, or something bad happened. 				 * Give up. 				 */
name|result
operator|=
name|DNS_R_CONTINUE
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
comment|/* 		 * We don't know anything about this key. 		 */
name|result
operator|=
name|create_fetch
argument_list|(
name|val
argument_list|,
operator|&
name|siginfo
operator|->
name|signer
argument_list|,
name|dns_rdatatype_dnskey
argument_list|,
name|fetch_callback_validator
argument_list|,
literal|"get_key"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|DNS_R_NCACHENXDOMAIN
operator|||
name|result
operator|==
name|DNS_R_NCACHENXRRSET
operator|||
name|result
operator|==
name|DNS_R_NXDOMAIN
operator|||
name|result
operator|==
name|DNS_R_NXRRSET
condition|)
block|{
comment|/* 		 * This key doesn't exist. 		 */
name|result
operator|=
name|DNS_R_CONTINUE
expr_stmt|;
block|}
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
operator|&&
name|val
operator|->
name|keyset
operator|!=
operator|&
name|val
operator|->
name|frdataset
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|dns_keytag_t
name|compute_keytag
parameter_list|(
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|,
name|dns_rdata_dnskey_t
modifier|*
name|key
parameter_list|)
block|{
name|isc_region_t
name|r
decl_stmt|;
name|dns_rdata_toregion
argument_list|(
name|rdata
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
return|return
operator|(
name|dst_region_computeid
argument_list|(
operator|&
name|r
argument_list|,
name|key
operator|->
name|algorithm
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Is this keyset self-signed?  */
end_comment

begin_function
specifier|static
name|isc_boolean_t
name|isselfsigned
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
block|{
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|,
modifier|*
name|sigrdataset
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_t
name|sigrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_dnskey_t
name|key
decl_stmt|;
name|dns_rdata_rrsig_t
name|sig
decl_stmt|;
name|dns_keytag_t
name|keytag
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|rdataset
operator|=
name|val
operator|->
name|event
operator|->
name|rdataset
expr_stmt|;
name|sigrdataset
operator|=
name|val
operator|->
name|event
operator|->
name|sigrdataset
expr_stmt|;
name|INSIST
argument_list|(
name|rdataset
operator|->
name|type
operator|==
name|dns_rdatatype_dnskey
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
control|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|keytag
operator|=
name|compute_keytag
argument_list|(
operator|&
name|rdata
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|sigrdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|sigrdataset
argument_list|)
control|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|sigrdataset
argument_list|,
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|sigrdata
argument_list|,
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sig
operator|.
name|algorithm
operator|==
name|key
operator|.
name|algorithm
operator|&&
name|sig
operator|.
name|keyid
operator|==
name|keytag
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|verify
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dst_key_t
modifier|*
name|key
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_TRIEDVERIFY
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_dnssec_verify2
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|val
operator|->
name|event
operator|->
name|rdataset
argument_list|,
name|key
argument_list|,
name|ISC_FALSE
argument_list|,
name|val
operator|->
name|view
operator|->
name|mctx
argument_list|,
name|rdata
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"verify rdataset: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_FROMWILDCARD
condition|)
block|{
if|if
condition|(
operator|!
name|dns_name_equal
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
argument_list|)
condition|)
name|val
operator|->
name|attributes
operator||=
name|VALATTR_NEEDNOQNAME
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Attempts positive response validation of a normal RRset.  *  * Returns:  *	ISC_R_SUCCESS	Validation completed successfully  *	DNS_R_WAIT	Validation has started but is waiting  *			for an event.  *	Other return codes are possible and all indicate failure.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|validate
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_boolean_t
name|resume
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_validatorevent_t
modifier|*
name|event
decl_stmt|;
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
comment|/* 	 * Caller must be holding the validator lock. 	 */
name|event
operator|=
name|val
operator|->
name|event
expr_stmt|;
if|if
condition|(
name|resume
condition|)
block|{
comment|/* 		 * We already have a sigrdataset. 		 */
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"resuming validate"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|event
operator|->
name|sigrdataset
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|event
operator|->
name|sigrdataset
argument_list|)
control|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|event
operator|->
name|sigrdataset
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|siginfo
operator|==
name|NULL
condition|)
block|{
name|val
operator|->
name|siginfo
operator|=
name|isc_mem_get
argument_list|(
name|val
operator|->
name|view
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
operator|->
name|siginfo
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|siginfo
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|result
operator|=
name|dns_rdata_tostruct
argument_list|(
operator|&
name|rdata
argument_list|,
name|val
operator|->
name|siginfo
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 		 * At this point we could check that the signature algorithm 		 * was known and "sufficiently good". 		 */
if|if
condition|(
operator|!
name|dns_resolver_algorithm_supported
argument_list|(
name|val
operator|->
name|view
operator|->
name|resolver
argument_list|,
name|event
operator|->
name|name
argument_list|,
name|val
operator|->
name|siginfo
operator|->
name|algorithm
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|resume
condition|)
block|{
name|result
operator|=
name|get_key
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|siginfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_CONTINUE
condition|)
continue|continue;
comment|/* Try the next SIG RR. */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
comment|/* 		 * The key is insecure, so mark the data as insecure also. 		 */
if|if
condition|(
name|val
operator|->
name|key
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|mustbesecure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"must be secure failure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_MUSTBESECURE
operator|)
return|;
block|}
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"marking as answer"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
do|do
block|{
name|result
operator|=
name|verify
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|key
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
if|if
condition|(
name|val
operator|->
name|keynode
operator|!=
name|NULL
condition|)
block|{
name|dns_keynode_t
modifier|*
name|nextnode
init|=
name|NULL
decl_stmt|;
name|result
operator|=
name|dns_keytable_findnextkeynode
argument_list|(
name|val
operator|->
name|keytable
argument_list|,
name|val
operator|->
name|keynode
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|dns_keytable_detachkeynode
argument_list|(
name|val
operator|->
name|keytable
argument_list|,
operator|&
name|val
operator|->
name|keynode
argument_list|)
expr_stmt|;
name|val
operator|->
name|keynode
operator|=
name|nextnode
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|val
operator|->
name|key
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
name|val
operator|->
name|key
operator|=
name|dns_keynode_key
argument_list|(
name|val
operator|->
name|keynode
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|get_dst_key
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|siginfo
argument_list|,
name|val
operator|->
name|keyset
argument_list|)
operator|!=
name|ISC_R_SUCCESS
condition|)
break|break;
block|}
block|}
do|while
condition|(
literal|1
condition|)
do|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"failed to verify rdataset"
argument_list|)
expr_stmt|;
else|else
block|{
name|isc_uint32_t
name|ttl
decl_stmt|;
name|isc_stdtime_t
name|now
decl_stmt|;
name|isc_stdtime_get
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|ttl
operator|=
name|ISC_MIN
argument_list|(
name|event
operator|->
name|rdataset
operator|->
name|ttl
argument_list|,
name|val
operator|->
name|siginfo
operator|->
name|timeexpire
operator|-
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|keyset
operator|!=
name|NULL
condition|)
name|ttl
operator|=
name|ISC_MIN
argument_list|(
name|ttl
argument_list|,
name|val
operator|->
name|keyset
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|event
operator|->
name|rdataset
operator|->
name|ttl
operator|=
name|ttl
expr_stmt|;
name|event
operator|->
name|sigrdataset
operator|->
name|ttl
operator|=
name|ttl
expr_stmt|;
block|}
if|if
condition|(
name|val
operator|->
name|keynode
operator|!=
name|NULL
condition|)
name|dns_keytable_detachkeynode
argument_list|(
name|val
operator|->
name|keytable
argument_list|,
operator|&
name|val
operator|->
name|keynode
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|val
operator|->
name|key
operator|!=
name|NULL
condition|)
name|dst_key_free
argument_list|(
operator|&
name|val
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|keyset
operator|!=
name|NULL
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
name|val
operator|->
name|keyset
argument_list|)
expr_stmt|;
name|val
operator|->
name|keyset
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|val
operator|->
name|key
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNOQNAME
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|event
operator|->
name|message
operator|==
name|NULL
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"no message available for noqname proof"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"looking for noqname proof"
argument_list|)
expr_stmt|;
return|return
operator|(
name|nsecvalidate
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"marking as secure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"verify failure: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|resume
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"failed to iterate signatures: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"no valid signature found"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dlv_validated
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_validatorevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_VALIDATORDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_validatorevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|eresult
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|dns_validator_destroy
argument_list|(
operator|&
name|val
operator|->
name|subvalidator
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in dsvalidated"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dlv with trust %d"
argument_list|,
name|val
operator|->
name|frdataset
operator|.
name|trust
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_INSECURITY
operator|)
operator|!=
literal|0
condition|)
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|validatezonekey
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dlv_validated: got %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|eresult
argument_list|)
argument_list|)
expr_stmt|;
name|validator_done
argument_list|(
name|val
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
block|}
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dlv_fetched
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_fetchevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rdataset
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_FETCHDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_fetchevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|rdataset
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
name|eresult
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|dns_resolver_destroyfetch
argument_list|(
operator|&
name|val
operator|->
name|fetch
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in dlv_fetched"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dlv set with trust %d"
argument_list|,
name|rdataset
operator|->
name|trust
argument_list|)
expr_stmt|;
name|val
operator|->
name|dlv
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
name|result
operator|=
name|dlv_validatezonekey
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|eresult
operator|==
name|DNS_R_NXRRSET
operator|||
name|eresult
operator|==
name|DNS_R_NCACHENXRRSET
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"falling back to insecurity proof"
argument_list|)
expr_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_INSECURITY
expr_stmt|;
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dlv_fetched: got %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|eresult
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_CANCELED
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|eresult
argument_list|)
expr_stmt|;
else|else
name|validator_done
argument_list|(
name|val
argument_list|,
name|DNS_R_NOVALIDDS
argument_list|)
expr_stmt|;
block|}
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dlv_validatezonekey
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
block|{
name|dns_fixedname_t
name|fixed
decl_stmt|;
name|dns_keytag_t
name|keytag
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_name_t
name|tname
decl_stmt|;
name|dns_rdata_dlv_t
name|dlv
decl_stmt|;
name|dns_rdata_dnskey_t
name|key
decl_stmt|;
name|dns_rdata_rrsig_t
name|sig
decl_stmt|;
name|dns_rdata_t
name|dlvrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_t
name|keyrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_t
name|newdsrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_t
name|sigrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdataset_t
name|trdataset
decl_stmt|;
name|dst_key_t
modifier|*
name|dstkey
decl_stmt|;
name|isc_boolean_t
name|supported_algorithm
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|char
name|dsbuf
index|[
name|DNS_DS_BUFFERSIZE
index|]
decl_stmt|;
name|unsigned
name|int
name|labels
decl_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_DLVTRIED
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|tname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|name
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fixed
argument_list|)
expr_stmt|;
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
literal|0
argument_list|,
name|labels
operator|-
literal|1
argument_list|,
operator|&
name|tname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_concatenate
argument_list|(
operator|&
name|tname
argument_list|,
name|val
operator|->
name|view
operator|->
name|dlv
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"DLV concatenate failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
if|if
condition|(
name|val
operator|->
name|dlv
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|view_find
argument_list|(
name|val
argument_list|,
name|name
argument_list|,
name|dns_rdatatype_dlv
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 			 * We have DLV records. 			 */
name|val
operator|->
name|dsset
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|==
name|dns_trust_pending
operator|&&
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
block|{
name|result
operator|=
name|create_validator
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|dns_rdatatype_ds
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|,
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|,
name|dlv_validated
argument_list|,
literal|"dlv_validatezonekey"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|==
name|dns_trust_pending
condition|)
block|{
comment|/* 				 * There should never be an unsigned DLV. 				 */
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"unsigned DLV record"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
else|else
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
name|result
operator|=
name|create_fetch
argument_list|(
name|val
argument_list|,
name|name
argument_list|,
name|dns_rdatatype_dlv
argument_list|,
name|dlv_fetched
argument_list|,
literal|"dlv_validatezonekey"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|DNS_R_NCACHENXDOMAIN
operator|||
name|result
operator|==
name|DNS_R_NCACHENXRRSET
operator|||
name|result
operator|==
name|DNS_R_NXDOMAIN
operator|||
name|result
operator|==
name|DNS_R_NXRRSET
condition|)
block|{
comment|/* 			 * The DS does not exist. 			 */
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"no DLV record"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
block|}
comment|/* 	 * We have a DLV set. 	 */
name|INSIST
argument_list|(
name|val
operator|->
name|dlv
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|dlv
operator|->
name|trust
operator|<
name|dns_trust_secure
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|mustbesecure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"must be secure failure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_MUSTBESECURE
operator|)
return|;
block|}
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
comment|/* 	 * Look through the DLV record and find the keys that can sign the 	 * key set and the matching signature.  For each such key, attempt 	 * verification. 	 */
name|supported_algorithm
operator|=
name|ISC_FALSE
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|val
operator|->
name|dlv
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|val
operator|->
name|dlv
argument_list|)
control|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|dlvrdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|val
operator|->
name|dlv
argument_list|,
operator|&
name|dlvrdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|dlvrdata
argument_list|,
operator|&
name|dlv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_resolver_algorithm_supported
argument_list|(
name|val
operator|->
name|view
operator|->
name|resolver
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|dlv
operator|.
name|algorithm
argument_list|)
condition|)
continue|continue;
name|supported_algorithm
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|trdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_clone
argument_list|(
name|val
operator|->
name|event
operator|->
name|rdataset
argument_list|,
operator|&
name|trdataset
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|trdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|trdataset
argument_list|)
control|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|keyrdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|trdataset
argument_list|,
operator|&
name|keyrdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|keyrdata
argument_list|,
operator|&
name|key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|keytag
operator|=
name|compute_keytag
argument_list|(
operator|&
name|keyrdata
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlv
operator|.
name|key_tag
operator|!=
name|keytag
operator|||
name|dlv
operator|.
name|algorithm
operator|!=
name|key
operator|.
name|algorithm
condition|)
continue|continue;
name|dns_rdata_reset
argument_list|(
operator|&
name|newdsrdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_ds_buildrdata
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
operator|&
name|keyrdata
argument_list|,
name|dlv
operator|.
name|digest_type
argument_list|,
name|dsbuf
argument_list|,
operator|&
name|newdsrdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
continue|continue;
comment|/* Covert to DLV */
name|newdsrdata
operator|.
name|type
operator|=
name|dns_rdatatype_dlv
expr_stmt|;
if|if
condition|(
name|dns_rdata_compare
argument_list|(
operator|&
name|dlvrdata
argument_list|,
operator|&
name|newdsrdata
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"no DNSKEY matching DLV"
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|)
control|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|,
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|sigrdata
argument_list|,
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlv
operator|.
name|key_tag
operator|!=
name|sig
operator|.
name|keyid
operator|&&
name|dlv
operator|.
name|algorithm
operator|!=
name|sig
operator|.
name|algorithm
condition|)
continue|continue;
name|dstkey
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_dnssec_keyfromrdata
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
operator|&
name|keyrdata
argument_list|,
name|val
operator|->
name|view
operator|->
name|mctx
argument_list|,
operator|&
name|dstkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
comment|/* 				 * This really shouldn't happen, but... 				 */
continue|continue;
name|result
operator|=
name|verify
argument_list|(
name|val
argument_list|,
name|dstkey
argument_list|,
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|dstkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|trdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"no RRSIG matching DLV key"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"marking as secure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
operator|&&
operator|!
name|supported_algorithm
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|mustbesecure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"must be secure failure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_MUSTBESECURE
operator|)
return|;
block|}
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"no supported algorithm (dlv)"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Attempts positive response validation of an RRset containing zone keys.  *  * Returns:  *	ISC_R_SUCCESS	Validation completed successfully  *	DNS_R_WAIT	Validation has started but is waiting  *			for an event.  *	Other return codes are possible and all indicate failure.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|validatezonekey
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_validatorevent_t
modifier|*
name|event
decl_stmt|;
name|dns_rdataset_t
name|trdataset
decl_stmt|;
name|dns_rdata_t
name|dsrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_t
name|newdsrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_t
name|keyrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_t
name|sigrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|unsigned
name|char
name|dsbuf
index|[
name|DNS_DS_BUFFERSIZE
index|]
decl_stmt|;
name|dns_keytag_t
name|keytag
decl_stmt|;
name|dns_rdata_ds_t
name|ds
decl_stmt|;
name|dns_rdata_dnskey_t
name|key
decl_stmt|;
name|dns_rdata_rrsig_t
name|sig
decl_stmt|;
name|dst_key_t
modifier|*
name|dstkey
decl_stmt|;
name|isc_boolean_t
name|supported_algorithm
decl_stmt|;
comment|/* 	 * Caller must be holding the validator lock. 	 */
name|event
operator|=
name|val
operator|->
name|event
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|dsset
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * First, see if this key was signed by a trusted key. 		 */
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|)
control|)
block|{
name|dns_keynode_t
modifier|*
name|keynode
init|=
name|NULL
decl_stmt|,
modifier|*
name|nextnode
init|=
name|NULL
decl_stmt|;
name|dns_rdata_reset
argument_list|(
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|,
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|sigrdata
argument_list|,
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_keytable_findkeynode
argument_list|(
name|val
operator|->
name|keytable
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|sig
operator|.
name|algorithm
argument_list|,
name|sig
operator|.
name|keyid
argument_list|,
operator|&
name|keynode
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dstkey
operator|=
name|dns_keynode_key
argument_list|(
name|keynode
argument_list|)
expr_stmt|;
name|result
operator|=
name|verify
argument_list|(
name|val
argument_list|,
name|dstkey
argument_list|,
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_keytable_detachkeynode
argument_list|(
name|val
operator|->
name|keytable
argument_list|,
operator|&
name|keynode
argument_list|)
expr_stmt|;
break|break;
block|}
name|result
operator|=
name|dns_keytable_findnextkeynode
argument_list|(
name|val
operator|->
name|keytable
argument_list|,
name|keynode
argument_list|,
operator|&
name|nextnode
argument_list|)
expr_stmt|;
name|dns_keytable_detachkeynode
argument_list|(
name|val
operator|->
name|keytable
argument_list|,
operator|&
name|keynode
argument_list|)
expr_stmt|;
name|keynode
operator|=
name|nextnode
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"signed by trusted key; "
literal|"marking as secure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
comment|/* 		 * If this is the root name and there was no trusted key, 		 * give up, since there's no DS at the root. 		 */
if|if
condition|(
name|dns_name_equal
argument_list|(
name|event
operator|->
name|name
argument_list|,
name|dns_rootname
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_TRIEDVERIFY
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
else|else
return|return
operator|(
name|DNS_R_NOVALIDDS
operator|)
return|;
block|}
comment|/* 		 * Otherwise, try to find the DS record. 		 */
name|result
operator|=
name|view_find
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|dns_rdatatype_ds
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 			 * We have DS records. 			 */
name|val
operator|->
name|dsset
operator|=
operator|&
name|val
operator|->
name|frdataset
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|==
name|dns_trust_pending
operator|&&
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
block|{
name|result
operator|=
name|create_validator
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|dns_rdatatype_ds
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|,
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|,
name|dsvalidated
argument_list|,
literal|"validatezonekey"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|==
name|dns_trust_pending
condition|)
block|{
comment|/* 				 * There should never be an unsigned DS. 				 */
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"unsigned DS record"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
else|else
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
comment|/* 			 * We don't have the DS.  Find it. 			 */
name|result
operator|=
name|create_fetch
argument_list|(
name|val
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|dns_rdatatype_ds
argument_list|,
name|dsfetched
argument_list|,
literal|"validatezonekey"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|view
operator|->
name|dlv
operator|!=
name|NULL
operator|&&
operator|!
name|DLVTRIED
argument_list|(
name|val
argument_list|)
operator|&&
operator|(
name|result
operator|==
name|DNS_R_NCACHENXRRSET
operator|||
name|result
operator|==
name|DNS_R_NXRRSET
operator|)
operator|&&
operator|!
name|dns_name_issubdomain
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|val
operator|->
name|view
operator|->
name|dlv
argument_list|)
condition|)
block|{
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"no DS record: looking for DLV"
argument_list|)
expr_stmt|;
return|return
operator|(
name|dlv_validatezonekey
argument_list|(
name|val
argument_list|)
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|DNS_R_NCACHENXDOMAIN
operator|||
name|result
operator|==
name|DNS_R_NCACHENXRRSET
operator|||
name|result
operator|==
name|DNS_R_NXDOMAIN
operator|||
name|result
operator|==
name|DNS_R_NXRRSET
condition|)
block|{
comment|/* 			 * The DS does not exist. 			 */
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"no DS record"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
block|}
comment|/* 	 * We have a DS set. 	 */
name|INSIST
argument_list|(
name|val
operator|->
name|dsset
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|dsset
operator|->
name|trust
operator|<
name|dns_trust_secure
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|mustbesecure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"must be secure failure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_MUSTBESECURE
operator|)
return|;
block|}
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
comment|/* 	 * Look through the DS record and find the keys that can sign the 	 * key set and the matching signature.  For each such key, attempt 	 * verification. 	 */
name|supported_algorithm
operator|=
name|ISC_FALSE
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|val
operator|->
name|dsset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|val
operator|->
name|dsset
argument_list|)
control|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|dsrdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|val
operator|->
name|dsset
argument_list|,
operator|&
name|dsrdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|dsrdata
argument_list|,
operator|&
name|ds
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_resolver_algorithm_supported
argument_list|(
name|val
operator|->
name|view
operator|->
name|resolver
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|ds
operator|.
name|algorithm
argument_list|)
condition|)
continue|continue;
name|supported_algorithm
operator|=
name|ISC_TRUE
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|trdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_clone
argument_list|(
name|val
operator|->
name|event
operator|->
name|rdataset
argument_list|,
operator|&
name|trdataset
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
operator|&
name|trdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
operator|&
name|trdataset
argument_list|)
control|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|keyrdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
operator|&
name|trdataset
argument_list|,
operator|&
name|keyrdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|keyrdata
argument_list|,
operator|&
name|key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|keytag
operator|=
name|compute_keytag
argument_list|(
operator|&
name|keyrdata
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ds
operator|.
name|key_tag
operator|!=
name|keytag
operator|||
name|ds
operator|.
name|algorithm
operator|!=
name|key
operator|.
name|algorithm
condition|)
continue|continue;
name|dns_rdata_reset
argument_list|(
operator|&
name|newdsrdata
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_ds_buildrdata
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
operator|&
name|keyrdata
argument_list|,
name|ds
operator|.
name|digest_type
argument_list|,
name|dsbuf
argument_list|,
operator|&
name|newdsrdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
continue|continue;
if|if
condition|(
name|dns_rdata_compare
argument_list|(
operator|&
name|dsrdata
argument_list|,
operator|&
name|newdsrdata
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"no DNSKEY matching DS"
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|)
control|)
block|{
name|dns_rdata_reset
argument_list|(
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|dns_rdataset_current
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|,
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|sigrdata
argument_list|,
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ds
operator|.
name|key_tag
operator|!=
name|sig
operator|.
name|keyid
operator|&&
name|ds
operator|.
name|algorithm
operator|!=
name|sig
operator|.
name|algorithm
condition|)
continue|continue;
name|dstkey
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|dns_dnssec_keyfromrdata
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
operator|&
name|keyrdata
argument_list|,
name|val
operator|->
name|view
operator|->
name|mctx
argument_list|,
operator|&
name|dstkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
comment|/* 				 * This really shouldn't happen, but... 				 */
continue|continue;
name|result
operator|=
name|verify
argument_list|(
name|val
argument_list|,
name|dstkey
argument_list|,
operator|&
name|sigrdata
argument_list|)
expr_stmt|;
name|dst_key_free
argument_list|(
operator|&
name|dstkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
block|}
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|trdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"no RRSIG matching DS key"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"marking as secure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
operator|&&
name|val
operator|->
name|view
operator|->
name|dlv
operator|!=
name|NULL
operator|&&
operator|!
name|DLVTRIED
argument_list|(
name|val
argument_list|)
operator|&&
operator|!
name|dns_name_issubdomain
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|val
operator|->
name|view
operator|->
name|dlv
argument_list|)
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"no DS/DNSKEY pair: looking for DLV"
argument_list|)
expr_stmt|;
return|return
operator|(
name|dlv_validatezonekey
argument_list|(
name|val
argument_list|)
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
operator|&&
operator|!
name|supported_algorithm
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|mustbesecure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"must be secure failure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_MUSTBESECURE
operator|)
return|;
block|}
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"no supported algorithm (ds)"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Starts a positive response validation.  *  * Returns:  *	ISC_R_SUCCESS	Validation completed successfully  *	DNS_R_WAIT	Validation has started but is waiting  *			for an event.  *	Other return codes are possible and all indicate failure.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|start_positive_validation
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
block|{
comment|/* 	 * If this is not a key, go straight into validate(). 	 */
if|if
condition|(
name|val
operator|->
name|event
operator|->
name|type
operator|!=
name|dns_rdatatype_dnskey
operator|||
operator|!
name|isselfsigned
argument_list|(
name|val
argument_list|)
condition|)
return|return
operator|(
name|validate
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
operator|)
return|;
return|return
operator|(
name|validatezonekey
argument_list|(
name|val
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|checkwildcard
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
block|{
name|dns_name_t
modifier|*
name|name
decl_stmt|,
modifier|*
name|wild
decl_stmt|;
name|dns_message_t
modifier|*
name|message
init|=
name|val
operator|->
name|event
operator|->
name|message
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_boolean_t
name|exists
decl_stmt|,
name|data
decl_stmt|;
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|wild
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|val
operator|->
name|wild
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
name|wild
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in checkwildcard: %s"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
for|for
control|(
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_message_nextname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|)
control|)
block|{
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|,
modifier|*
name|sigrdataset
init|=
name|NULL
decl_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rdataset
operator|!=
name|NULL
condition|;
name|rdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|rdataset
operator|->
name|type
operator|!=
name|dns_rdatatype_nsec
condition|)
continue|continue;
name|val
operator|->
name|nsecset
operator|=
name|rdataset
expr_stmt|;
for|for
control|(
name|sigrdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|sigrdataset
operator|!=
name|NULL
condition|;
name|sigrdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|sigrdataset
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|sigrdataset
operator|->
name|type
operator|==
name|dns_rdatatype_rrsig
operator|&&
name|sigrdataset
operator|->
name|covers
operator|==
name|rdataset
operator|->
name|type
condition|)
break|break;
block|}
if|if
condition|(
name|sigrdataset
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|rdataset
operator|->
name|trust
operator|!=
name|dns_trust_secure
condition|)
continue|continue;
if|if
condition|(
operator|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNODATA
operator|)
operator|!=
literal|0
operator|||
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNOWILDCARD
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNODATA
operator|)
operator|==
literal|0
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNOWILDCARD
operator|)
operator|==
literal|0
operator|&&
name|nsecnoexistnodata
argument_list|(
name|val
argument_list|,
name|wild
argument_list|,
name|name
argument_list|,
name|rdataset
argument_list|,
operator|&
name|exists
argument_list|,
operator|&
name|data
argument_list|,
name|NULL
argument_list|)
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_name_t
modifier|*
modifier|*
name|proofs
init|=
name|val
operator|->
name|event
operator|->
name|proofs
decl_stmt|;
if|if
condition|(
name|exists
operator|&&
operator|!
name|data
condition|)
name|val
operator|->
name|attributes
operator||=
name|VALATTR_FOUNDNODATA
expr_stmt|;
if|if
condition|(
name|exists
operator|&&
operator|!
name|data
operator|&&
name|NEEDNODATA
argument_list|(
name|val
argument_list|)
condition|)
name|proofs
index|[
name|DNS_VALIDATOR_NODATAPROOF
index|]
operator|=
name|name
expr_stmt|;
if|if
condition|(
operator|!
name|exists
condition|)
name|val
operator|->
name|attributes
operator||=
name|VALATTR_FOUNDNOWILDCARD
expr_stmt|;
if|if
condition|(
operator|!
name|exists
operator|&&
name|NEEDNOQNAME
argument_list|(
name|val
argument_list|)
condition|)
name|proofs
index|[
name|DNS_VALIDATOR_NOWILDCARDPROOF
index|]
operator|=
name|name
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|nsecvalidate
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_boolean_t
name|resume
parameter_list|)
block|{
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_message_t
modifier|*
name|message
init|=
name|val
operator|->
name|event
operator|->
name|message
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
operator|!
name|resume
condition|)
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
else|else
block|{
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"resuming nsecvalidate"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_message_nextname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|)
control|)
block|{
name|dns_rdataset_t
modifier|*
name|rdataset
init|=
name|NULL
decl_stmt|,
modifier|*
name|sigrdataset
init|=
name|NULL
decl_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|message
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|resume
condition|)
block|{
name|rdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|val
operator|->
name|currentset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|val
operator|->
name|currentset
operator|=
name|NULL
expr_stmt|;
name|resume
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
else|else
name|rdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|rdataset
operator|!=
name|NULL
condition|;
name|rdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdataset
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|rdataset
operator|->
name|type
operator|==
name|dns_rdatatype_rrsig
condition|)
continue|continue;
if|if
condition|(
name|rdataset
operator|->
name|type
operator|==
name|dns_rdatatype_soa
condition|)
block|{
name|val
operator|->
name|soaset
operator|=
name|rdataset
expr_stmt|;
name|val
operator|->
name|soaname
operator|=
name|name
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdataset
operator|->
name|type
operator|==
name|dns_rdatatype_nsec
condition|)
name|val
operator|->
name|nsecset
operator|=
name|rdataset
expr_stmt|;
for|for
control|(
name|sigrdataset
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|sigrdataset
operator|!=
name|NULL
condition|;
name|sigrdataset
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|sigrdataset
argument_list|,
name|link
argument_list|)
control|)
block|{
if|if
condition|(
name|sigrdataset
operator|->
name|type
operator|==
name|dns_rdatatype_rrsig
operator|&&
name|sigrdataset
operator|->
name|covers
operator|==
name|rdataset
operator|->
name|type
condition|)
break|break;
block|}
if|if
condition|(
name|sigrdataset
operator|==
name|NULL
condition|)
continue|continue;
comment|/* 			 * If a signed zone is missing the zone key, bad 			 * things could happen.  A query for data in the zone 			 * would lead to a query for the zone key, which 			 * would return a negative answer, which would contain 			 * an SOA and an NSEC signed by the missing key, which 			 * would trigger another query for the DNSKEY (since 			 * the first one is still in progress), and go into an 			 * infinite loop.  Avoid that. 			 */
if|if
condition|(
name|val
operator|->
name|event
operator|->
name|type
operator|==
name|dns_rdatatype_dnskey
operator|&&
name|dns_name_equal
argument_list|(
name|name
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|)
condition|)
block|{
name|dns_rdata_t
name|nsec
init|=
name|DNS_RDATA_INIT
decl_stmt|;
if|if
condition|(
name|rdataset
operator|->
name|type
operator|!=
name|dns_rdatatype_nsec
condition|)
continue|continue;
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|nsec
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_nsec_typepresent
argument_list|(
operator|&
name|nsec
argument_list|,
name|dns_rdatatype_soa
argument_list|)
condition|)
continue|continue;
block|}
name|val
operator|->
name|currentset
operator|=
name|rdataset
expr_stmt|;
name|result
operator|=
name|create_validator
argument_list|(
name|val
argument_list|,
name|name
argument_list|,
name|rdataset
operator|->
name|type
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|,
name|authvalidated
argument_list|,
literal|"nsecvalidate"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOMORE
condition|)
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 	 * Do we only need to check for NOQNAME? 	 */
if|if
condition|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNODATA
operator|)
operator|==
literal|0
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNOWILDCARD
operator|)
operator|==
literal|0
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNOQNAME
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNOQNAME
operator|)
operator|!=
literal|0
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"noqname proof found"
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"marking as secure"
argument_list|)
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|sigrdataset
operator|->
name|trust
operator|=
name|dns_trust_secure
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"noqname proof not found"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDNSEC
operator|)
return|;
block|}
comment|/* 	 * Do we need to check for the wildcard? 	 */
if|if
condition|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNOQNAME
operator|)
operator|!=
literal|0
operator|&&
operator|(
operator|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNODATA
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNODATA
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNOWILDCARD
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|result
operator|=
name|checkwildcard
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
operator|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNODATA
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNODATA
operator|)
operator|!=
literal|0
operator|)
operator|||
operator|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNOQNAME
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNOQNAME
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_NEEDNOWILDCARD
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNOWILDCARD
operator|)
operator|!=
literal|0
operator|)
condition|)
name|val
operator|->
name|attributes
operator||=
name|VALATTR_FOUNDNONEXISTENCE
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_FOUNDNONEXISTENCE
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|val
operator|->
name|seensig
operator|&&
name|val
operator|->
name|soaset
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|create_validator
argument_list|(
name|val
argument_list|,
name|name
argument_list|,
name|dns_rdatatype_soa
argument_list|,
name|val
operator|->
name|soaset
argument_list|,
name|NULL
argument_list|,
name|negauthvalidated
argument_list|,
literal|"nsecvalidate"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"nonexistence proof not found"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDNSEC
operator|)
return|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"nonexistence proof found"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|check_ds_algorithm
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
name|dns_rdata_t
name|dsrdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdata_ds_t
name|ds
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rdataset
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rdataset
argument_list|)
control|)
block|{
name|dns_rdataset_current
argument_list|(
name|rdataset
argument_list|,
operator|&
name|dsrdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_rdata_tostruct
argument_list|(
operator|&
name|dsrdata
argument_list|,
operator|&
name|ds
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_resolver_algorithm_supported
argument_list|(
name|val
operator|->
name|view
operator|->
name|resolver
argument_list|,
name|name
argument_list|,
name|ds
operator|.
name|algorithm
argument_list|)
condition|)
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
name|dns_rdata_reset
argument_list|(
operator|&
name|dsrdata
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dlv_fetched2
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_fetchevent_t
modifier|*
name|devent
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|isc_boolean_t
name|want_destroy
decl_stmt|;
name|isc_result_t
name|eresult
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_FETCHDONE
argument_list|)
expr_stmt|;
name|devent
operator|=
operator|(
name|dns_fetchevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|devent
operator|->
name|ev_arg
expr_stmt|;
name|eresult
operator|=
name|devent
operator|->
name|result
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|dns_resolver_destroyfetch
argument_list|(
operator|&
name|val
operator|->
name|fetch
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|val
operator|->
name|event
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"in dlv_fetched2: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|eresult
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|eresult
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|val
operator|->
name|havedlvsep
operator|=
name|ISC_TRUE
expr_stmt|;
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|eresult
operator|==
name|DNS_R_NXRRSET
operator|||
name|eresult
operator|==
name|DNS_R_NXDOMAIN
operator|||
name|eresult
operator|==
name|DNS_R_NCACHENXRRSET
operator|||
name|eresult
operator|==
name|DNS_R_NCACHENXDOMAIN
condition|)
block|{
name|result
operator|=
name|finddlvsep
argument_list|(
name|val
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
name|validator_done
argument_list|(
name|val
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|finddlvsep
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_boolean_t
name|resume
parameter_list|)
block|{
name|dns_fixedname_t
name|dlvfixed
decl_stmt|;
name|dns_name_t
modifier|*
name|dlvname
decl_stmt|;
name|dns_name_t
modifier|*
name|dlvsep
decl_stmt|;
name|dns_name_t
name|noroot
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|labels
decl_stmt|;
if|if
condition|(
operator|!
name|resume
condition|)
block|{
name|dns_fixedname_init
argument_list|(
operator|&
name|val
operator|->
name|dlvsep
argument_list|)
expr_stmt|;
name|dlvsep
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|val
operator|->
name|dlvsep
argument_list|)
expr_stmt|;
name|dns_name_copy
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|dlvsep
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_DLVSEPTRIED
expr_stmt|;
block|}
else|else
block|{
name|dlvsep
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|val
operator|->
name|dlvsep
argument_list|)
expr_stmt|;
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|dlvsep
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|dlvsep
argument_list|,
literal|1
argument_list|,
name|labels
operator|-
literal|1
argument_list|,
name|dlvsep
argument_list|)
expr_stmt|;
block|}
name|dns_name_init
argument_list|(
operator|&
name|noroot
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|dlvfixed
argument_list|)
expr_stmt|;
name|dlvname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|dlvfixed
argument_list|)
expr_stmt|;
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|dlvsep
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|dlvsep
argument_list|,
literal|0
argument_list|,
name|labels
operator|-
literal|1
argument_list|,
operator|&
name|noroot
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_concatenate
argument_list|(
operator|&
name|noroot
argument_list|,
name|val
operator|->
name|view
operator|->
name|dlv
argument_list|,
name|dlvname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
block|{
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|dlvsep
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|dlvsep
argument_list|,
literal|1
argument_list|,
name|labels
operator|-
literal|1
argument_list|,
name|dlvsep
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|dlvsep
argument_list|,
literal|0
argument_list|,
name|labels
operator|-
literal|2
argument_list|,
operator|&
name|noroot
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_concatenate
argument_list|(
operator|&
name|noroot
argument_list|,
name|val
operator|->
name|view
operator|->
name|dlv
argument_list|,
name|dlvname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"DLV concatenate failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
block|}
while|while
condition|(
name|dns_name_countlabels
argument_list|(
name|dlvname
argument_list|)
operator|>
name|dns_name_countlabels
argument_list|(
name|val
operator|->
name|view
operator|->
name|dlv
argument_list|)
condition|)
block|{
name|result
operator|=
name|view_find
argument_list|(
name|val
argument_list|,
name|dlvname
argument_list|,
name|dns_rdatatype_dlv
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|<
name|dns_trust_secure
condition|)
return|return
operator|(
name|DNS_R_NOVALIDSIG
operator|)
return|;
name|val
operator|->
name|havedlvsep
operator|=
name|ISC_TRUE
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
name|result
operator|=
name|create_fetch
argument_list|(
name|val
argument_list|,
name|dlvname
argument_list|,
name|dns_rdatatype_dlv
argument_list|,
name|dlv_fetched2
argument_list|,
literal|"finddlvsep"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|!=
name|DNS_R_NXRRSET
operator|&&
name|result
operator|!=
name|DNS_R_NXDOMAIN
operator|&&
name|result
operator|!=
name|DNS_R_NCACHENXRRSET
operator|&&
name|result
operator|!=
name|DNS_R_NCACHENXDOMAIN
condition|)
return|return
operator|(
name|result
operator|)
return|;
comment|/* 		 * Strip first labels from both dlvsep and dlvname. 		 */
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|dlvsep
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|dlvsep
argument_list|,
literal|1
argument_list|,
name|labels
operator|-
literal|1
argument_list|,
name|dlvsep
argument_list|)
expr_stmt|;
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|dlvname
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|dlvname
argument_list|,
literal|1
argument_list|,
name|labels
operator|-
literal|1
argument_list|,
name|dlvname
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|proveunsecure
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_boolean_t
name|resume
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_result_t
name|tresult
decl_stmt|;
name|dns_fixedname_t
name|secroot
decl_stmt|;
name|dns_name_t
modifier|*
name|tname
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|secroot
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_keytable_finddeepestmatch
argument_list|(
name|val
operator|->
name|keytable
argument_list|,
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|secroot
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * If the name is not under a security root, it must be insecure. 	 */
if|if
condition|(
name|val
operator|->
name|view
operator|->
name|dlv
operator|!=
name|NULL
operator|&&
operator|!
name|DLVSEPTRIED
argument_list|(
name|val
argument_list|)
operator|&&
operator|!
name|dns_name_issubdomain
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|val
operator|->
name|view
operator|->
name|dlv
argument_list|)
condition|)
block|{
name|tresult
operator|=
name|finddlvsep
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tresult
operator|!=
name|ISC_R_NOTFOUND
operator|&&
name|tresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"finddlvsep returned: %s"
argument_list|,
name|dns_result_totext
argument_list|(
name|tresult
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|tresult
operator|)
return|;
block|}
block|}
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
if|if
condition|(
operator|!
name|val
operator|->
name|havedlvsep
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|dns_name_copy
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|val
operator|->
name|dlvsep
argument_list|)
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|secroot
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
elseif|else
if|if
condition|(
name|val
operator|->
name|havedlvsep
operator|&&
name|dns_name_issubdomain
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|val
operator|->
name|dlvsep
argument_list|)
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|secroot
argument_list|)
argument_list|)
condition|)
block|{
name|dns_name_copy
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|val
operator|->
name|dlvsep
argument_list|)
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|secroot
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|resume
condition|)
block|{
name|val
operator|->
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|dns_fixedname_name
argument_list|(
operator|&
name|secroot
argument_list|)
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"resuming proveunsecure"
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|>=
name|dns_trust_secure
operator|&&
operator|!
name|check_ds_algorithm
argument_list|(
name|val
argument_list|,
name|dns_fixedname_name
argument_list|(
operator|&
name|val
operator|->
name|fname
argument_list|)
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|mustbesecure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"must be secure failure"
argument_list|)
expr_stmt|;
name|result
operator|=
name|DNS_R_MUSTBESECURE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"no supported algorithm (ds)"
argument_list|)
expr_stmt|;
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|val
operator|->
name|labels
operator|++
expr_stmt|;
block|}
for|for
control|(
init|;
name|val
operator|->
name|labels
operator|<=
name|dns_name_countlabels
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|)
condition|;
name|val
operator|->
name|labels
operator|++
control|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|val
operator|->
name|fname
argument_list|)
expr_stmt|;
name|tname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|val
operator|->
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|labels
operator|==
name|dns_name_countlabels
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|)
condition|)
name|dns_name_copy
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|tname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|dns_name_split
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|val
operator|->
name|labels
argument_list|,
name|NULL
argument_list|,
name|tname
argument_list|)
expr_stmt|;
name|dns_name_format
argument_list|(
name|tname
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"checking existence of DS at '%s'"
argument_list|,
name|namebuf
argument_list|)
expr_stmt|;
name|result
operator|=
name|view_find
argument_list|(
name|val
argument_list|,
name|tname
argument_list|,
name|dns_rdatatype_ds
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_NXRRSET
operator|||
name|result
operator|==
name|DNS_R_NCACHENXRRSET
condition|)
block|{
comment|/* 			 * There is no DS.  If this is a delegation, 			 * we're done. 			 */
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|<
name|dns_trust_secure
condition|)
block|{
comment|/* 				 * This shouldn't happen, since the negative 				 * response should have been validated.  Since 				 * there's no way of validating existing 				 * negative response blobs, give up. 				 */
name|result
operator|=
name|DNS_R_NOVALIDSIG
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|isdelegation
argument_list|(
name|tname
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|,
name|result
argument_list|)
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|mustbesecure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"must be secure failure"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_MUSTBESECURE
operator|)
return|;
block|}
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
continue|continue;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 			 * There is a DS here.  Verify that it's secure and 			 * continue. 			 */
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|>=
name|dns_trust_secure
condition|)
block|{
if|if
condition|(
operator|!
name|check_ds_algorithm
argument_list|(
name|val
argument_list|,
name|tname
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"no supported algorithm (ds)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|mustbesecure
condition|)
block|{
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_WARNING
argument_list|,
literal|"must be secure failure"
argument_list|)
expr_stmt|;
name|result
operator|=
name|DNS_R_MUSTBESECURE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|val
operator|->
name|event
operator|->
name|rdataset
operator|->
name|trust
operator|=
name|dns_trust_answer
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
goto|goto
name|out
goto|;
block|}
continue|continue;
block|}
elseif|else
if|if
condition|(
operator|!
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
block|{
name|result
operator|=
name|DNS_R_NOVALIDSIG
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|result
operator|=
name|create_validator
argument_list|(
name|val
argument_list|,
name|tname
argument_list|,
name|dns_rdatatype_ds
argument_list|,
operator|&
name|val
operator|->
name|frdataset
argument_list|,
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|,
name|dsvalidated
argument_list|,
literal|"proveunsecure"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|out
goto|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|DNS_R_NXDOMAIN
operator|||
name|result
operator|==
name|DNS_R_NCACHENXDOMAIN
condition|)
block|{
comment|/* 			 * This is not a zone cut.  Assuming things are 			 * as expected, continue. 			 */
if|if
condition|(
operator|!
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
block|{
comment|/* 				 * There should be an NSEC here, since we 				 * are still in a secure zone. 				 */
name|result
operator|=
name|DNS_R_NOVALIDNSEC
expr_stmt|;
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|frdataset
operator|.
name|trust
operator|<
name|dns_trust_secure
condition|)
block|{
comment|/* 				 * This shouldn't happen, since the negative 				 * response should have been validated.  Since 				 * there's no way of validating existing 				 * negative response blobs, give up. 				 */
name|result
operator|=
name|DNS_R_NOVALIDSIG
expr_stmt|;
goto|goto
name|out
goto|;
block|}
continue|continue;
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|ISC_R_NOTFOUND
condition|)
block|{
comment|/* 			 * We don't know anything about the DS.  Find it. 			 */
name|result
operator|=
name|create_fetch
argument_list|(
name|val
argument_list|,
name|tname
argument_list|,
name|dns_rdatatype_ds
argument_list|,
name|dsfetched2
argument_list|,
literal|"proveunsecure"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|out
goto|;
return|return
operator|(
name|DNS_R_WAIT
operator|)
return|;
block|}
block|}
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"insecurity proof failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_NOTINSECURE
operator|)
return|;
comment|/* Couldn't complete insecurity proof */
name|out
label|:
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|validator_start
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|dns_validatorevent_t
modifier|*
name|vevent
decl_stmt|;
name|isc_boolean_t
name|want_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_FAILURE
decl_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|DNS_EVENT_VALIDATORSTART
argument_list|)
expr_stmt|;
name|vevent
operator|=
operator|(
name|dns_validatorevent_t
operator|*
operator|)
name|event
expr_stmt|;
name|val
operator|=
name|vevent
operator|->
name|validator
expr_stmt|;
comment|/* If the validator has been cancelled, val->event == NULL */
if|if
condition|(
name|val
operator|->
name|event
operator|==
name|NULL
condition|)
return|return;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"starting"
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|event
operator|->
name|rdataset
operator|!=
name|NULL
operator|&&
name|val
operator|->
name|event
operator|->
name|sigrdataset
operator|!=
name|NULL
condition|)
block|{
name|isc_result_t
name|saved_result
decl_stmt|;
comment|/* 		 * This looks like a simple validation.  We say "looks like" 		 * because it might end up requiring an insecurity proof. 		 */
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"attempting positive response validation"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|dns_rdataset_isassociated
argument_list|(
name|val
operator|->
name|event
operator|->
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|dns_rdataset_isassociated
argument_list|(
name|val
operator|->
name|event
operator|->
name|sigrdataset
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|start_positive_validation
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_NOVALIDSIG
operator|&&
operator|(
name|val
operator|->
name|attributes
operator|&
name|VALATTR_TRIEDVERIFY
operator|)
operator|==
literal|0
condition|)
block|{
name|saved_result
operator|=
name|result
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"falling back to insecurity proof"
argument_list|)
expr_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_INSECURITY
expr_stmt|;
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DNS_R_NOTINSECURE
condition|)
name|result
operator|=
name|saved_result
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|event
operator|->
name|rdataset
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * This is either an unsecure subdomain or a response from 		 * a broken server. 		 */
name|INSIST
argument_list|(
name|dns_rdataset_isassociated
argument_list|(
name|val
operator|->
name|event
operator|->
name|rdataset
argument_list|)
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"attempting insecurity proof"
argument_list|)
expr_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_INSECURITY
expr_stmt|;
name|result
operator|=
name|proveunsecure
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|event
operator|->
name|rdataset
operator|==
name|NULL
operator|&&
name|val
operator|->
name|event
operator|->
name|sigrdataset
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * This is a nonexistence validation. 		 */
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"attempting negative response validation"
argument_list|)
expr_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_NEGATIVE
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|event
operator|->
name|message
operator|->
name|rcode
operator|==
name|dns_rcode_nxdomain
condition|)
block|{
name|val
operator|->
name|attributes
operator||=
name|VALATTR_NEEDNOQNAME
expr_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_NEEDNOWILDCARD
expr_stmt|;
block|}
else|else
name|val
operator|->
name|attributes
operator||=
name|VALATTR_NEEDNODATA
expr_stmt|;
name|result
operator|=
name|nsecvalidate
argument_list|(
name|val
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * This shouldn't happen. 		 */
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|DNS_R_WAIT
condition|)
block|{
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|validator_done
argument_list|(
name|val
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_validator_create
parameter_list|(
name|dns_view_t
modifier|*
name|view
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|sigrdataset
parameter_list|,
name|dns_message_t
modifier|*
name|message
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_taskaction_t
name|action
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|dns_validator_t
modifier|*
modifier|*
name|validatorp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|isc_task_t
modifier|*
name|tclone
decl_stmt|;
name|dns_validatorevent_t
modifier|*
name|event
decl_stmt|;
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|type
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rdataset
operator|!=
name|NULL
operator|||
operator|(
name|rdataset
operator|==
name|NULL
operator|&&
name|sigrdataset
operator|==
name|NULL
operator|&&
name|message
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|options
operator|==
literal|0
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|validatorp
operator|!=
name|NULL
operator|&&
operator|*
name|validatorp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tclone
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
name|val
operator|=
name|isc_mem_get
argument_list|(
name|view
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|val
operator|->
name|view
operator|=
name|NULL
expr_stmt|;
name|dns_view_weakattach
argument_list|(
name|view
argument_list|,
operator|&
name|val
operator|->
name|view
argument_list|)
expr_stmt|;
name|event
operator|=
operator|(
name|dns_validatorevent_t
operator|*
operator|)
name|isc_event_allocate
argument_list|(
name|view
operator|->
name|mctx
argument_list|,
name|task
argument_list|,
name|DNS_EVENT_VALIDATORSTART
argument_list|,
name|validator_start
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_validatorevent_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|ISC_R_NOMEMORY
expr_stmt|;
goto|goto
name|cleanup_val
goto|;
block|}
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|tclone
argument_list|)
expr_stmt|;
name|event
operator|->
name|validator
operator|=
name|val
expr_stmt|;
name|event
operator|->
name|result
operator|=
name|ISC_R_FAILURE
expr_stmt|;
name|event
operator|->
name|name
operator|=
name|name
expr_stmt|;
name|event
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|event
operator|->
name|rdataset
operator|=
name|rdataset
expr_stmt|;
name|event
operator|->
name|sigrdataset
operator|=
name|sigrdataset
expr_stmt|;
name|event
operator|->
name|message
operator|=
name|message
expr_stmt|;
name|memset
argument_list|(
name|event
operator|->
name|proofs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
operator|->
name|proofs
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_event
goto|;
name|val
operator|->
name|event
operator|=
name|event
expr_stmt|;
name|val
operator|->
name|options
operator|=
name|options
expr_stmt|;
name|val
operator|->
name|attributes
operator|=
literal|0
expr_stmt|;
name|val
operator|->
name|fetch
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|subvalidator
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|parent
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|keytable
operator|=
name|NULL
expr_stmt|;
name|dns_keytable_attach
argument_list|(
name|val
operator|->
name|view
operator|->
name|secroots
argument_list|,
operator|&
name|val
operator|->
name|keytable
argument_list|)
expr_stmt|;
name|val
operator|->
name|keynode
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|key
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|siginfo
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|task
operator|=
name|task
expr_stmt|;
name|val
operator|->
name|action
operator|=
name|action
expr_stmt|;
name|val
operator|->
name|arg
operator|=
name|arg
expr_stmt|;
name|val
operator|->
name|labels
operator|=
literal|0
expr_stmt|;
name|val
operator|->
name|currentset
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|keyset
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|dsset
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|dlv
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|soaset
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|nsecset
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|soaname
operator|=
name|NULL
expr_stmt|;
name|val
operator|->
name|seensig
operator|=
name|ISC_FALSE
expr_stmt|;
name|val
operator|->
name|havedlvsep
operator|=
name|ISC_FALSE
expr_stmt|;
name|val
operator|->
name|mustbesecure
operator|=
name|dns_resolver_getmustbesecure
argument_list|(
name|view
operator|->
name|resolver
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|val
operator|->
name|frdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
operator|&
name|val
operator|->
name|fsigrdataset
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|val
operator|->
name|wild
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|val
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|val
operator|->
name|magic
operator|=
name|VALIDATOR_MAGIC
expr_stmt|;
name|isc_task_send
argument_list|(
name|task
argument_list|,
name|ISC_EVENT_PTR
argument_list|(
operator|&
name|event
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|validatorp
operator|=
name|val
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup_event
label|:
name|isc_task_detach
argument_list|(
operator|&
name|tclone
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|(
name|isc_event_t
operator|*
operator|*
operator|)
operator|&
name|val
operator|->
name|event
argument_list|)
expr_stmt|;
name|cleanup_val
label|:
name|dns_view_weakdetach
argument_list|(
operator|&
name|val
operator|->
name|view
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|view
operator|->
name|mctx
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_validator_cancel
parameter_list|(
name|dns_validator_t
modifier|*
name|validator
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_VALIDATOR
argument_list|(
name|validator
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|validator
operator|->
name|lock
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|validator
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_validator_cancel"
argument_list|)
expr_stmt|;
if|if
condition|(
name|validator
operator|->
name|event
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|validator
operator|->
name|fetch
operator|!=
name|NULL
condition|)
name|dns_resolver_cancelfetch
argument_list|(
name|validator
operator|->
name|fetch
argument_list|)
expr_stmt|;
if|if
condition|(
name|validator
operator|->
name|subvalidator
operator|!=
name|NULL
condition|)
name|dns_validator_cancel
argument_list|(
name|validator
operator|->
name|subvalidator
argument_list|)
expr_stmt|;
block|}
name|UNLOCK
argument_list|(
operator|&
name|validator
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|REQUIRE
argument_list|(
name|SHUTDOWN
argument_list|(
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|val
operator|->
name|event
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|val
operator|->
name|fetch
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|keynode
operator|!=
name|NULL
condition|)
name|dns_keytable_detachkeynode
argument_list|(
name|val
operator|->
name|keytable
argument_list|,
operator|&
name|val
operator|->
name|keynode
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|val
operator|->
name|key
operator|!=
name|NULL
condition|)
name|dst_key_free
argument_list|(
operator|&
name|val
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|keytable
operator|!=
name|NULL
condition|)
name|dns_keytable_detach
argument_list|(
operator|&
name|val
operator|->
name|keytable
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|subvalidator
operator|!=
name|NULL
condition|)
name|dns_validator_destroy
argument_list|(
operator|&
name|val
operator|->
name|subvalidator
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|val
operator|->
name|view
operator|->
name|mctx
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|siginfo
operator|!=
name|NULL
condition|)
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|val
operator|->
name|siginfo
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
operator|->
name|siginfo
argument_list|)
argument_list|)
expr_stmt|;
name|DESTROYLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dns_view_weakdetach
argument_list|(
operator|&
name|val
operator|->
name|view
argument_list|)
expr_stmt|;
name|val
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_validator_destroy
parameter_list|(
name|dns_validator_t
modifier|*
modifier|*
name|validatorp
parameter_list|)
block|{
name|dns_validator_t
modifier|*
name|val
decl_stmt|;
name|isc_boolean_t
name|want_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|validatorp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|val
operator|=
operator|*
name|validatorp
expr_stmt|;
name|REQUIRE
argument_list|(
name|VALID_VALIDATOR
argument_list|(
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
name|val
operator|->
name|attributes
operator||=
name|VALATTR_SHUTDOWN
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"dns_validator_destroy"
argument_list|)
expr_stmt|;
name|want_destroy
operator|=
name|exit_check
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|val
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|want_destroy
condition|)
name|destroy
argument_list|(
name|val
argument_list|)
expr_stmt|;
operator|*
name|validatorp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|validator_logv
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|isc_logcategory_t
modifier|*
name|category
parameter_list|,
name|isc_logmodule_t
modifier|*
name|module
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|char
name|msgbuf
index|[
literal|2048
index|]
decl_stmt|;
name|vsnprintf
argument_list|(
name|msgbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|msgbuf
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|event
operator|!=
name|NULL
operator|&&
name|val
operator|->
name|event
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
name|char
name|namebuf
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|typebuf
index|[
name|DNS_RDATATYPE_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|val
operator|->
name|event
operator|->
name|name
argument_list|,
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatatype_format
argument_list|(
name|val
operator|->
name|event
operator|->
name|type
argument_list|,
name|typebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|typebuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|category
argument_list|,
name|module
argument_list|,
name|level
argument_list|,
literal|"validating %s %s: %s"
argument_list|,
name|namebuf
argument_list|,
name|typebuf
argument_list|,
name|msgbuf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|category
argument_list|,
name|module
argument_list|,
name|level
argument_list|,
literal|"validator @%p: %s"
argument_list|,
name|val
argument_list|,
name|msgbuf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|validator_log
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
operator|!
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
condition|)
return|return;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|validator_logv
argument_list|(
name|val
argument_list|,
name|DNS_LOGCATEGORY_DNSSEC
argument_list|,
name|DNS_LOGMODULE_VALIDATOR
argument_list|,
name|level
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|validator_logcreate
parameter_list|(
name|dns_validator_t
modifier|*
name|val
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|caller
parameter_list|,
specifier|const
name|char
modifier|*
name|operation
parameter_list|)
block|{
name|char
name|namestr
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|typestr
index|[
name|DNS_RDATATYPE_FORMATSIZE
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatatype_format
argument_list|(
name|type
argument_list|,
name|typestr
argument_list|,
sizeof|sizeof
argument_list|(
name|typestr
argument_list|)
argument_list|)
expr_stmt|;
name|validator_log
argument_list|(
name|val
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|9
argument_list|)
argument_list|,
literal|"%s: creating %s for %s %s"
argument_list|,
name|caller
argument_list|,
name|operation
argument_list|,
name|namestr
argument_list|,
name|typestr
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


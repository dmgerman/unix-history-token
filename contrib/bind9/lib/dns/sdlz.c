begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Portions Copyright (C) 2005-2007  Internet Systems Consortium, Inc. ("ISC")  * Portions Copyright (C) 1999-2001  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/*  * Copyright (C) 2002 Stichting NLnet, Netherlands, stichting@nlnet.nl.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the  * above copyright notice and this permission notice appear in all  * copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND STICHTING NLNET  * DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL  * STICHTING NLNET BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR  * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS  * OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE  * USE OR PERFORMANCE OF THIS SOFTWARE.  *  * The development of Dynamically Loadable Zones (DLZ) for Bind 9 was  * conceived and contributed by Rob Butler.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the  * above copyright notice and this permission notice appear in all  * copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ROB BUTLER  * DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL  * ROB BUTLER BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR  * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS  * OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE  * USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: sdlz.c,v 1.2.2.11 2007/08/28 07:20:05 tbox Exp $ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_include
include|#
directive|include
file|<isc/lex.h>
end_include

begin_include
include|#
directive|include
file|<isc/log.h>
end_include

begin_include
include|#
directive|include
file|<isc/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<isc/magic.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/once.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/region.h>
end_include

begin_include
include|#
directive|include
file|<dns/callbacks.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/dbiterator.h>
end_include

begin_include
include|#
directive|include
file|<dns/dlz.h>
end_include

begin_include
include|#
directive|include
file|<dns/fixedname.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdata.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatasetiter.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatatype.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/master.h>
end_include

begin_include
include|#
directive|include
file|<dns/sdlz.h>
end_include

begin_include
include|#
directive|include
file|<dns/types.h>
end_include

begin_include
include|#
directive|include
file|"rdatalist_p.h"
end_include

begin_comment
comment|/*  * Private Types  */
end_comment

begin_struct
struct|struct
name|dns_sdlzimplementation
block|{
specifier|const
name|dns_sdlzmethods_t
modifier|*
name|methods
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|void
modifier|*
name|driverarg
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|isc_mutex_t
name|driverlock
decl_stmt|;
name|dns_dlzimplementation_t
modifier|*
name|dlz_imp
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|dns_sdlz_db
block|{
comment|/* Unlocked */
name|dns_db_t
name|common
decl_stmt|;
name|void
modifier|*
name|dbdata
decl_stmt|;
name|dns_sdlzimplementation_t
modifier|*
name|dlzimp
decl_stmt|;
name|isc_mutex_t
name|refcnt_lock
decl_stmt|;
comment|/* Locked */
name|unsigned
name|int
name|references
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|dns_sdlzlookup
block|{
comment|/* Unlocked */
name|unsigned
name|int
name|magic
decl_stmt|;
name|dns_sdlz_db_t
modifier|*
name|sdlz
decl_stmt|;
name|ISC_LIST
argument_list|(
argument|dns_rdatalist_t
argument_list|)
name|lists
expr_stmt|;
name|ISC_LIST
argument_list|(
argument|isc_buffer_t
argument_list|)
name|buffers
expr_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|ISC_LINK
argument_list|(
argument|dns_sdlzlookup_t
argument_list|)
name|link
expr_stmt|;
name|isc_mutex_t
name|lock
decl_stmt|;
name|dns_rdatacallbacks_t
name|callbacks
decl_stmt|;
comment|/* Locked */
name|unsigned
name|int
name|references
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|dns_sdlzlookup
name|dns_sdlznode_t
typedef|;
end_typedef

begin_struct
struct|struct
name|dns_sdlzallnodes
block|{
name|dns_dbiterator_t
name|common
decl_stmt|;
name|ISC_LIST
argument_list|(
argument|dns_sdlznode_t
argument_list|)
name|nodelist
expr_stmt|;
name|dns_sdlznode_t
modifier|*
name|current
decl_stmt|;
name|dns_sdlznode_t
modifier|*
name|origin
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|dns_sdlzallnodes_t
name|sdlz_dbiterator_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|sdlz_rdatasetiter
block|{
name|dns_rdatasetiter_t
name|common
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|current
decl_stmt|;
block|}
name|sdlz_rdatasetiter_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|SDLZDB_MAGIC
value|ISC_MAGIC('D', 'L', 'Z', 'S')
end_define

begin_comment
comment|/*  * Note that "impmagic" is not the first four bytes of the struct, so  * ISC_MAGIC_VALID cannot be used.  */
end_comment

begin_define
define|#
directive|define
name|VALID_SDLZDB
parameter_list|(
name|sdlzdb
parameter_list|)
value|((sdlzdb) != NULL&& \ 				 (sdlzdb)->common.impmagic == SDLZDB_MAGIC)
end_define

begin_define
define|#
directive|define
name|SDLZLOOKUP_MAGIC
value|ISC_MAGIC('D','L','Z','L')
end_define

begin_define
define|#
directive|define
name|VALID_SDLZLOOKUP
parameter_list|(
name|sdlzl
parameter_list|)
value|ISC_MAGIC_VALID(sdlzl, SDLZLOOKUP_MAGIC)
end_define

begin_define
define|#
directive|define
name|VALID_SDLZNODE
parameter_list|(
name|sdlzn
parameter_list|)
value|VALID_SDLZLOOKUP(sdlzn)
end_define

begin_comment
comment|/* These values are taken from RFC 1537 */
end_comment

begin_define
define|#
directive|define
name|SDLZ_DEFAULT_REFRESH
value|(60 * 60 * 8)
end_define

begin_define
define|#
directive|define
name|SDLZ_DEFAULT_RETRY
value|(60 * 60 * 2)
end_define

begin_define
define|#
directive|define
name|SDLZ_DEFAULT_EXPIRE
value|(60 * 60 * 24 * 7)
end_define

begin_define
define|#
directive|define
name|SDLZ_DEFAULT_MINIMUM
value|(60 * 60 * 24)
end_define

begin_comment
comment|/* This is a reasonable value */
end_comment

begin_define
define|#
directive|define
name|SDLZ_DEFAULT_TTL
value|(60 * 60 * 24)
end_define

begin_decl_stmt
specifier|static
name|int
name|dummy
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|__COVERITY__
end_ifdef

begin_define
define|#
directive|define
name|MAYBE_LOCK
parameter_list|(
name|imp
parameter_list|)
value|LOCK(&imp->driverlock)
end_define

begin_define
define|#
directive|define
name|MAYBE_UNLOCK
parameter_list|(
name|imp
parameter_list|)
value|UNLOCK(&imp->driverlock)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|MAYBE_LOCK
parameter_list|(
name|imp
parameter_list|)
define|\
value|do { \ 		unsigned int flags = imp->flags; \ 		if ((flags& DNS_SDLZFLAG_THREADSAFE) == 0) \ 			LOCK(&imp->driverlock); \ 	} while (0)
end_define

begin_define
define|#
directive|define
name|MAYBE_UNLOCK
parameter_list|(
name|imp
parameter_list|)
define|\
value|do { \ 		unsigned int flags = imp->flags; \ 		if ((flags& DNS_SDLZFLAG_THREADSAFE) == 0) \ 			UNLOCK(&imp->driverlock); \ 	} while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Forward references.  Try to keep these to a minimum.  */
end_comment

begin_function_decl
specifier|static
name|void
name|list_tordataset
parameter_list|(
name|dns_rdatalist_t
modifier|*
name|rdatalist
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|detachnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|targetp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dbiterator_destroy
parameter_list|(
name|dns_dbiterator_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_first
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_last
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_seek
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_prev
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_next
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_current
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_pause
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|dbiterator_origin
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|dns_dbiteratormethods_t
name|dbiterator_methods
init|=
block|{
name|dbiterator_destroy
block|,
name|dbiterator_first
block|,
name|dbiterator_last
block|,
name|dbiterator_seek
block|,
name|dbiterator_prev
block|,
name|dbiterator_next
block|,
name|dbiterator_current
block|,
name|dbiterator_pause
block|,
name|dbiterator_origin
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Utility functions  */
end_comment

begin_comment
comment|/*% Converts the input string to lowercase, in place. */
end_comment

begin_function
specifier|static
name|void
name|dns_sdlz_tolower
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
name|unsigned
name|int
name|len
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|str
index|[
name|i
index|]
operator|>=
literal|'A'
operator|&&
name|str
index|[
name|i
index|]
operator|<=
literal|'Z'
condition|)
name|str
index|[
name|i
index|]
operator|+=
literal|32
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|unsigned
name|int
name|initial_size
parameter_list|(
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|unsigned
name|int
name|len
init|=
operator|(
name|strlen
argument_list|(
name|data
argument_list|)
operator|/
literal|64
operator|)
operator|+
literal|1
decl_stmt|;
return|return
operator|(
name|len
operator|*
literal|64
operator|+
literal|64
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Rdataset Iterator Methods. These methods were "borrowed" from the SDB  * driver interface.  See the SDB driver interface documentation for more info.  */
end_comment

begin_function
specifier|static
name|void
name|rdatasetiter_destroy
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
block|{
name|sdlz_rdatasetiter_t
modifier|*
name|sdlziterator
init|=
operator|(
name|sdlz_rdatasetiter_t
operator|*
operator|)
operator|(
operator|*
name|iteratorp
operator|)
decl_stmt|;
name|detachnode
argument_list|(
name|sdlziterator
operator|->
name|common
operator|.
name|db
argument_list|,
operator|&
name|sdlziterator
operator|->
name|common
operator|.
name|node
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|sdlziterator
operator|->
name|common
operator|.
name|db
operator|->
name|mctx
argument_list|,
name|sdlziterator
argument_list|,
sizeof|sizeof
argument_list|(
name|sdlz_rdatasetiter_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|iteratorp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|rdatasetiter_first
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdlz_rdatasetiter_t
modifier|*
name|sdlziterator
init|=
operator|(
name|sdlz_rdatasetiter_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|dns_sdlznode_t
modifier|*
name|sdlznode
init|=
operator|(
name|dns_sdlznode_t
operator|*
operator|)
name|iterator
operator|->
name|node
decl_stmt|;
if|if
condition|(
name|ISC_LIST_EMPTY
argument_list|(
name|sdlznode
operator|->
name|lists
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
name|sdlziterator
operator|->
name|current
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdlznode
operator|->
name|lists
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|rdatasetiter_next
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdlz_rdatasetiter_t
modifier|*
name|sdlziterator
init|=
operator|(
name|sdlz_rdatasetiter_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdlziterator
operator|->
name|current
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|sdlziterator
operator|->
name|current
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlziterator
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rdatasetiter_current
parameter_list|(
name|dns_rdatasetiter_t
modifier|*
name|iterator
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
name|sdlz_rdatasetiter_t
modifier|*
name|sdlziterator
init|=
operator|(
name|sdlz_rdatasetiter_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|list_tordataset
argument_list|(
name|sdlziterator
operator|->
name|current
argument_list|,
name|iterator
operator|->
name|db
argument_list|,
name|iterator
operator|->
name|node
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|dns_rdatasetitermethods_t
name|rdatasetiter_methods
init|=
block|{
name|rdatasetiter_destroy
block|,
name|rdatasetiter_first
block|,
name|rdatasetiter_next
block|,
name|rdatasetiter_current
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * DB routines. These methods were "borrowed" from the SDB driver interface.  * See the SDB driver interface documentation for more info.  */
end_comment

begin_function
specifier|static
name|void
name|attach
parameter_list|(
name|dns_db_t
modifier|*
name|source
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|dns_sdlz_db_t
modifier|*
name|sdlz
init|=
operator|(
name|dns_sdlz_db_t
operator|*
operator|)
name|source
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDLZDB
argument_list|(
name|sdlz
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|sdlz
operator|->
name|refcnt_lock
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|sdlz
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|sdlz
operator|->
name|references
operator|++
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|sdlz
operator|->
name|refcnt_lock
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy
parameter_list|(
name|dns_sdlz_db_t
modifier|*
name|sdlz
parameter_list|)
block|{
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|mctx
operator|=
name|sdlz
operator|->
name|common
operator|.
name|mctx
expr_stmt|;
name|sdlz
operator|->
name|common
operator|.
name|magic
operator|=
literal|0
expr_stmt|;
name|sdlz
operator|->
name|common
operator|.
name|impmagic
operator|=
literal|0
expr_stmt|;
name|isc_mutex_destroy
argument_list|(
operator|&
name|sdlz
operator|->
name|refcnt_lock
argument_list|)
expr_stmt|;
name|dns_name_free
argument_list|(
operator|&
name|sdlz
operator|->
name|common
operator|.
name|origin
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sdlz
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlz_db_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|detach
parameter_list|(
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
block|{
name|dns_sdlz_db_t
modifier|*
name|sdlz
init|=
operator|(
name|dns_sdlz_db_t
operator|*
operator|)
operator|(
operator|*
name|dbp
operator|)
decl_stmt|;
name|isc_boolean_t
name|need_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDLZDB
argument_list|(
name|sdlz
argument_list|)
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|sdlz
operator|->
name|refcnt_lock
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|sdlz
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|sdlz
operator|->
name|references
operator|--
expr_stmt|;
if|if
condition|(
name|sdlz
operator|->
name|references
operator|==
literal|0
condition|)
name|need_destroy
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|sdlz
operator|->
name|refcnt_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroy
condition|)
name|destroy
argument_list|(
name|sdlz
argument_list|)
expr_stmt|;
operator|*
name|dbp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|beginload
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_addrdatasetfunc_t
modifier|*
name|addp
parameter_list|,
name|dns_dbload_t
modifier|*
modifier|*
name|dbloadp
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|addp
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|dbloadp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|endload
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbload_t
modifier|*
modifier|*
name|dbloadp
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|dbloadp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dump
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|dns_masterformat_t
name|masterformat
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|masterformat
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|currentversion
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
modifier|*
name|versionp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|versionp
operator|!=
name|NULL
operator|&&
operator|*
name|versionp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
operator|*
name|versionp
operator|=
operator|(
name|void
operator|*
operator|)
operator|&
name|dummy
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|newversion
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
modifier|*
name|versionp
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|versionp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|attachversion
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
name|source
parameter_list|,
name|dns_dbversion_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|source
operator|!=
name|NULL
operator|&&
name|source
operator|==
operator|(
name|void
operator|*
operator|)
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|source
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|targetp
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|closeversion
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbversion_t
modifier|*
modifier|*
name|versionp
parameter_list|,
name|isc_boolean_t
name|commit
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|versionp
operator|!=
name|NULL
operator|&&
operator|*
name|versionp
operator|==
operator|(
name|void
operator|*
operator|)
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|commit
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|commit
argument_list|)
expr_stmt|;
operator|*
name|versionp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|createnode
parameter_list|(
name|dns_sdlz_db_t
modifier|*
name|sdlz
parameter_list|,
name|dns_sdlznode_t
modifier|*
modifier|*
name|nodep
parameter_list|)
block|{
name|dns_sdlznode_t
modifier|*
name|node
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|node
operator|=
name|isc_mem_get
argument_list|(
name|sdlz
operator|->
name|common
operator|.
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlznode_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|node
operator|->
name|sdlz
operator|=
name|NULL
expr_stmt|;
name|attach
argument_list|(
operator|(
name|dns_db_t
operator|*
operator|)
name|sdlz
argument_list|,
operator|(
name|dns_db_t
operator|*
operator|*
operator|)
operator|&
name|node
operator|->
name|sdlz
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|node
operator|->
name|lists
argument_list|)
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|node
operator|->
name|buffers
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|node
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|node
operator|->
name|name
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|sdlz
operator|->
name|common
operator|.
name|mctx
argument_list|,
name|node
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlznode_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_UNEXPECTED
operator|)
return|;
block|}
name|dns_rdatacallbacks_init
argument_list|(
operator|&
name|node
operator|->
name|callbacks
argument_list|)
expr_stmt|;
name|node
operator|->
name|references
operator|=
literal|1
expr_stmt|;
name|node
operator|->
name|magic
operator|=
name|SDLZLOOKUP_MAGIC
expr_stmt|;
operator|*
name|nodep
operator|=
name|node
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroynode
parameter_list|(
name|dns_sdlznode_t
modifier|*
name|node
parameter_list|)
block|{
name|dns_rdatalist_t
modifier|*
name|list
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|isc_buffer_t
modifier|*
name|b
decl_stmt|;
name|dns_sdlz_db_t
modifier|*
name|sdlz
decl_stmt|;
name|dns_db_t
modifier|*
name|db
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|sdlz
operator|=
name|node
operator|->
name|sdlz
expr_stmt|;
name|mctx
operator|=
name|sdlz
operator|->
name|common
operator|.
name|mctx
expr_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|node
operator|->
name|lists
argument_list|)
condition|)
block|{
name|list
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|node
operator|->
name|lists
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|list
operator|->
name|rdata
argument_list|)
condition|)
block|{
name|rdata
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|list
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|list
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rdata
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ISC_LIST_UNLINK
argument_list|(
name|node
operator|->
name|lists
argument_list|,
name|list
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|list
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdatalist_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|node
operator|->
name|buffers
argument_list|)
condition|)
block|{
name|b
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|node
operator|->
name|buffers
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|node
operator|->
name|buffers
argument_list|,
name|b
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|isc_buffer_free
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|node
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
name|dns_name_free
argument_list|(
name|node
operator|->
name|name
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|node
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|DESTROYLOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|->
name|magic
operator|=
literal|0
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|node
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlznode_t
argument_list|)
argument_list|)
expr_stmt|;
name|db
operator|=
operator|&
name|sdlz
operator|->
name|common
expr_stmt|;
name|detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|findnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_boolean_t
name|create
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|)
block|{
name|dns_sdlz_db_t
modifier|*
name|sdlz
init|=
operator|(
name|dns_sdlz_db_t
operator|*
operator|)
name|db
decl_stmt|;
name|dns_sdlznode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_MAXTEXT
operator|+
literal|1
index|]
decl_stmt|;
name|isc_buffer_t
name|b2
decl_stmt|;
name|char
name|zonestr
index|[
name|DNS_NAME_MAXTEXT
operator|+
literal|1
index|]
decl_stmt|;
name|isc_boolean_t
name|isorigin
decl_stmt|;
name|dns_sdlzauthorityfunc_t
name|authority
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDLZDB
argument_list|(
name|sdlz
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|create
operator|==
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|nodep
operator|!=
name|NULL
operator|&&
operator|*
name|nodep
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|create
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sdlz
operator|->
name|dlzimp
operator|->
name|flags
operator|&
name|DNS_SDLZFLAG_RELATIVEOWNER
operator|)
operator|!=
literal|0
condition|)
block|{
name|dns_name_t
name|relname
decl_stmt|;
name|unsigned
name|int
name|labels
decl_stmt|;
name|labels
operator|=
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
operator|-
name|dns_name_countlabels
argument_list|(
operator|&
name|db
operator|->
name|origin
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|relname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|name
argument_list|,
literal|0
argument_list|,
name|labels
argument_list|,
operator|&
name|relname
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_totext
argument_list|(
operator|&
name|relname
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
else|else
block|{
name|result
operator|=
name|dns_name_totext
argument_list|(
name|name
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
block|}
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b2
argument_list|,
name|zonestr
argument_list|,
sizeof|sizeof
argument_list|(
name|zonestr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_totext
argument_list|(
operator|&
name|sdlz
operator|->
name|common
operator|.
name|origin
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|b2
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|createnode
argument_list|(
name|sdlz
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|isorigin
operator|=
name|dns_name_equal
argument_list|(
name|name
argument_list|,
operator|&
name|sdlz
operator|->
name|common
operator|.
name|origin
argument_list|)
expr_stmt|;
comment|/* make sure strings are always lowercase */
name|dns_sdlz_tolower
argument_list|(
name|zonestr
argument_list|)
expr_stmt|;
name|dns_sdlz_tolower
argument_list|(
name|namestr
argument_list|)
expr_stmt|;
name|MAYBE_LOCK
argument_list|(
name|sdlz
operator|->
name|dlzimp
argument_list|)
expr_stmt|;
comment|/* try to lookup the host (namestr) */
name|result
operator|=
name|sdlz
operator|->
name|dlzimp
operator|->
name|methods
operator|->
name|lookup
argument_list|(
name|zonestr
argument_list|,
name|namestr
argument_list|,
name|sdlz
operator|->
name|dlzimp
operator|->
name|driverarg
argument_list|,
name|sdlz
operator|->
name|dbdata
argument_list|,
name|node
argument_list|)
expr_stmt|;
comment|/* 	 * if the host (namestr) was not found, try to lookup a 	 * "wildcard" host. 	 */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|sdlz
operator|->
name|dlzimp
operator|->
name|methods
operator|->
name|lookup
argument_list|(
name|zonestr
argument_list|,
literal|"*"
argument_list|,
name|sdlz
operator|->
name|dlzimp
operator|->
name|driverarg
argument_list|,
name|sdlz
operator|->
name|dbdata
argument_list|,
name|node
argument_list|)
expr_stmt|;
block|}
name|MAYBE_UNLOCK
argument_list|(
name|sdlz
operator|->
name|dlzimp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
operator|!
name|isorigin
condition|)
block|{
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
name|isorigin
operator|&&
name|sdlz
operator|->
name|dlzimp
operator|->
name|methods
operator|->
name|authority
operator|!=
name|NULL
condition|)
block|{
name|MAYBE_LOCK
argument_list|(
name|sdlz
operator|->
name|dlzimp
argument_list|)
expr_stmt|;
name|authority
operator|=
name|sdlz
operator|->
name|dlzimp
operator|->
name|methods
operator|->
name|authority
expr_stmt|;
name|result
operator|=
call|(
modifier|*
name|authority
call|)
argument_list|(
name|zonestr
argument_list|,
name|sdlz
operator|->
name|dlzimp
operator|->
name|driverarg
argument_list|,
name|sdlz
operator|->
name|dbdata
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|sdlz
operator|->
name|dlzimp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|&&
name|result
operator|!=
name|ISC_R_NOTIMPLEMENTED
condition|)
block|{
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
block|}
operator|*
name|nodep
operator|=
name|node
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|findzonecut
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|,
name|dns_name_t
modifier|*
name|foundname
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|sigrdataset
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|nodep
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|foundname
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sigrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|attachnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|source
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|dns_sdlz_db_t
modifier|*
name|sdlz
init|=
operator|(
name|dns_sdlz_db_t
operator|*
operator|)
name|db
decl_stmt|;
name|dns_sdlznode_t
modifier|*
name|node
init|=
operator|(
name|dns_sdlznode_t
operator|*
operator|)
name|source
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDLZDB
argument_list|(
name|sdlz
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sdlz
argument_list|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|node
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|node
operator|->
name|references
operator|++
expr_stmt|;
name|INSIST
argument_list|(
name|node
operator|->
name|references
operator|!=
literal|0
argument_list|)
expr_stmt|;
comment|/* Catch overflow. */
name|UNLOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|detachnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|targetp
parameter_list|)
block|{
name|dns_sdlz_db_t
modifier|*
name|sdlz
init|=
operator|(
name|dns_sdlz_db_t
operator|*
operator|)
name|db
decl_stmt|;
name|dns_sdlznode_t
modifier|*
name|node
decl_stmt|;
name|isc_boolean_t
name|need_destroy
init|=
name|ISC_FALSE
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDLZDB
argument_list|(
name|sdlz
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|targetp
operator|!=
name|NULL
operator|&&
operator|*
name|targetp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sdlz
argument_list|)
expr_stmt|;
name|node
operator|=
operator|(
name|dns_sdlznode_t
operator|*
operator|)
operator|(
operator|*
name|targetp
operator|)
expr_stmt|;
name|LOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|node
operator|->
name|references
operator|>
literal|0
argument_list|)
expr_stmt|;
name|node
operator|->
name|references
operator|--
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|references
operator|==
literal|0
condition|)
name|need_destroy
operator|=
name|ISC_TRUE
expr_stmt|;
name|UNLOCK
argument_list|(
operator|&
name|node
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|need_destroy
condition|)
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
operator|*
name|targetp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|expirenode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_UNEXPECTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|printnode
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|FILE
modifier|*
name|out
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|createiterator
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_boolean_t
name|relative_names
parameter_list|,
name|dns_dbiterator_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
block|{
name|dns_sdlz_db_t
modifier|*
name|sdlz
init|=
operator|(
name|dns_sdlz_db_t
operator|*
operator|)
name|db
decl_stmt|;
name|sdlz_dbiterator_t
modifier|*
name|sdlziter
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|char
name|zonestr
index|[
name|DNS_NAME_MAXTEXT
operator|+
literal|1
index|]
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDLZDB
argument_list|(
name|sdlz
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlz
operator|->
name|dlzimp
operator|->
name|methods
operator|->
name|allnodes
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|zonestr
argument_list|,
sizeof|sizeof
argument_list|(
name|zonestr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_totext
argument_list|(
operator|&
name|sdlz
operator|->
name|common
operator|.
name|origin
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sdlziter
operator|=
name|isc_mem_get
argument_list|(
name|sdlz
operator|->
name|common
operator|.
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|sdlz_dbiterator_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlziter
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|sdlziter
operator|->
name|common
operator|.
name|methods
operator|=
operator|&
name|dbiterator_methods
expr_stmt|;
name|sdlziter
operator|->
name|common
operator|.
name|db
operator|=
name|NULL
expr_stmt|;
name|dns_db_attach
argument_list|(
name|db
argument_list|,
operator|&
name|sdlziter
operator|->
name|common
operator|.
name|db
argument_list|)
expr_stmt|;
name|sdlziter
operator|->
name|common
operator|.
name|relative_names
operator|=
name|relative_names
expr_stmt|;
name|sdlziter
operator|->
name|common
operator|.
name|magic
operator|=
name|DNS_DBITERATOR_MAGIC
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|sdlziter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
name|sdlziter
operator|->
name|current
operator|=
name|NULL
expr_stmt|;
name|sdlziter
operator|->
name|origin
operator|=
name|NULL
expr_stmt|;
comment|/* make sure strings are always lowercase */
name|dns_sdlz_tolower
argument_list|(
name|zonestr
argument_list|)
expr_stmt|;
name|MAYBE_LOCK
argument_list|(
name|sdlz
operator|->
name|dlzimp
argument_list|)
expr_stmt|;
name|result
operator|=
name|sdlz
operator|->
name|dlzimp
operator|->
name|methods
operator|->
name|allnodes
argument_list|(
name|zonestr
argument_list|,
name|sdlz
operator|->
name|dlzimp
operator|->
name|driverarg
argument_list|,
name|sdlz
operator|->
name|dbdata
argument_list|,
name|sdlziter
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|sdlz
operator|->
name|dlzimp
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|dns_dbiterator_t
modifier|*
name|iter
init|=
operator|&
name|sdlziter
operator|->
name|common
decl_stmt|;
name|dbiterator_destroy
argument_list|(
operator|&
name|iter
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
name|sdlziter
operator|->
name|origin
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|sdlziter
operator|->
name|nodelist
argument_list|,
name|sdlziter
operator|->
name|origin
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_PREPEND
argument_list|(
name|sdlziter
operator|->
name|nodelist
argument_list|,
name|sdlziter
operator|->
name|origin
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
operator|*
name|iteratorp
operator|=
operator|(
name|dns_dbiterator_t
operator|*
operator|)
name|sdlziter
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|findrdataset
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdatatype_t
name|covers
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|sigrdataset
parameter_list|)
block|{
name|dns_rdatalist_t
modifier|*
name|list
decl_stmt|;
name|dns_sdlznode_t
modifier|*
name|sdlznode
init|=
operator|(
name|dns_sdlznode_t
operator|*
operator|)
name|node
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDLZNODE
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|covers
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_sig
operator|||
name|type
operator|==
name|dns_rdatatype_rrsig
condition|)
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
name|list
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdlznode
operator|->
name|lists
argument_list|)
expr_stmt|;
while|while
condition|(
name|list
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|list
operator|->
name|type
operator|==
name|type
condition|)
break|break;
name|list
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|list
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
name|list_tordataset
argument_list|(
name|list
argument_list|,
name|db
argument_list|,
name|node
argument_list|,
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|find
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|,
name|dns_name_t
modifier|*
name|foundname
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|dns_rdataset_t
modifier|*
name|sigrdataset
parameter_list|)
block|{
name|dns_sdlz_db_t
modifier|*
name|sdlz
init|=
operator|(
name|dns_sdlz_db_t
operator|*
operator|)
name|db
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|dns_fixedname_t
name|fname
decl_stmt|;
name|dns_rdataset_t
name|xrdataset
decl_stmt|;
name|dns_name_t
modifier|*
name|xname
decl_stmt|;
name|unsigned
name|int
name|nlabels
decl_stmt|,
name|olabels
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDLZDB
argument_list|(
name|sdlz
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|nodep
operator|==
name|NULL
operator|||
operator|*
name|nodep
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|version
operator|==
name|NULL
operator|||
name|version
operator|==
operator|(
name|void
operator|*
operator|)
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|sdlz
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dns_name_issubdomain
argument_list|(
name|name
argument_list|,
operator|&
name|db
operator|->
name|origin
argument_list|)
condition|)
return|return
operator|(
name|DNS_R_NXDOMAIN
operator|)
return|;
name|olabels
operator|=
name|dns_name_countlabels
argument_list|(
operator|&
name|db
operator|->
name|origin
argument_list|)
expr_stmt|;
name|nlabels
operator|=
name|dns_name_countlabels
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
name|xname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdataset
operator|==
name|NULL
condition|)
block|{
name|dns_rdataset_init
argument_list|(
operator|&
name|xrdataset
argument_list|)
expr_stmt|;
name|rdataset
operator|=
operator|&
name|xrdataset
expr_stmt|;
block|}
name|result
operator|=
name|DNS_R_NXDOMAIN
expr_stmt|;
for|for
control|(
name|i
operator|=
name|olabels
init|;
name|i
operator|<=
name|nlabels
condition|;
name|i
operator|++
control|)
block|{
comment|/* 		 * Unless this is an explicit lookup at the origin, don't 		 * look at the origin. 		 */
if|if
condition|(
name|i
operator|==
name|olabels
operator|&&
name|i
operator|!=
name|nlabels
condition|)
continue|continue;
comment|/* 		 * Look up the next label. 		 */
name|dns_name_getlabelsequence
argument_list|(
name|name
argument_list|,
name|nlabels
operator|-
name|i
argument_list|,
name|i
argument_list|,
name|xname
argument_list|)
expr_stmt|;
name|result
operator|=
name|findnode
argument_list|(
name|db
argument_list|,
name|xname
argument_list|,
name|ISC_FALSE
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|DNS_R_NXDOMAIN
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * Look for a DNAME at the current label, unless this is 		 * the qname. 		 */
if|if
condition|(
name|i
operator|<
name|nlabels
condition|)
block|{
name|result
operator|=
name|findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_dname
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|DNS_R_DNAME
expr_stmt|;
break|break;
block|}
block|}
comment|/* 		 * Look for an NS at the current label, unless this is the 		 * origin or glue is ok. 		 */
if|if
condition|(
name|i
operator|!=
name|olabels
operator|&&
operator|(
name|options
operator|&
name|DNS_DBFIND_GLUEOK
operator|)
operator|==
literal|0
condition|)
block|{
name|result
operator|=
name|findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_ns
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|i
operator|==
name|nlabels
operator|&&
name|type
operator|==
name|dns_rdatatype_any
condition|)
block|{
name|result
operator|=
name|DNS_R_ZONECUT
expr_stmt|;
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|sigrdataset
operator|!=
name|NULL
condition|)
name|dns_rdataset_disassociate
argument_list|(
name|sigrdataset
argument_list|)
expr_stmt|;
block|}
else|else
name|result
operator|=
name|DNS_R_DELEGATION
expr_stmt|;
break|break;
block|}
block|}
comment|/* 		 * If the current name is not the qname, add another label 		 * and try again. 		 */
if|if
condition|(
name|i
operator|<
name|nlabels
condition|)
block|{
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * If we're looking for ANY, we're done. 		 */
if|if
condition|(
name|type
operator|==
name|dns_rdatatype_any
condition|)
block|{
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
break|break;
block|}
comment|/* 		 * Look for the qtype. 		 */
name|result
operator|=
name|findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|type
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
break|break;
comment|/* 		 * Look for a CNAME 		 */
if|if
condition|(
name|type
operator|!=
name|dns_rdatatype_cname
condition|)
block|{
name|result
operator|=
name|findrdataset
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
name|version
argument_list|,
name|dns_rdatatype_cname
argument_list|,
literal|0
argument_list|,
name|now
argument_list|,
name|rdataset
argument_list|,
name|sigrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|result
operator|=
name|DNS_R_CNAME
expr_stmt|;
break|break;
block|}
block|}
name|result
operator|=
name|DNS_R_NXRRSET
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|rdataset
operator|==
operator|&
name|xrdataset
operator|&&
name|dns_rdataset_isassociated
argument_list|(
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|foundname
operator|!=
name|NULL
condition|)
block|{
name|isc_result_t
name|xresult
decl_stmt|;
name|xresult
operator|=
name|dns_name_copy
argument_list|(
name|xname
argument_list|,
name|foundname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|xresult
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_rdataset_isassociated
argument_list|(
name|rdataset
argument_list|)
condition|)
name|dns_rdataset_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_BADDB
operator|)
return|;
block|}
block|}
if|if
condition|(
name|nodep
operator|!=
name|NULL
condition|)
operator|*
name|nodep
operator|=
name|node
expr_stmt|;
elseif|else
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|allrdatasets
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_rdatasetiter_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
block|{
name|sdlz_rdatasetiter_t
modifier|*
name|iterator
decl_stmt|;
name|REQUIRE
argument_list|(
name|version
operator|==
name|NULL
operator|||
name|version
operator|==
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|iterator
operator|=
name|isc_mem_get
argument_list|(
name|db
operator|->
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|sdlz_rdatasetiter_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iterator
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|iterator
operator|->
name|common
operator|.
name|magic
operator|=
name|DNS_RDATASETITER_MAGIC
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|methods
operator|=
operator|&
name|rdatasetiter_methods
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|db
operator|=
name|db
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|node
operator|=
name|NULL
expr_stmt|;
name|attachnode
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
operator|&
name|iterator
operator|->
name|common
operator|.
name|node
argument_list|)
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|version
operator|=
name|version
expr_stmt|;
name|iterator
operator|->
name|common
operator|.
name|now
operator|=
name|now
expr_stmt|;
operator|*
name|iteratorp
operator|=
operator|(
name|dns_rdatasetiter_t
operator|*
operator|)
name|iterator
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|addrdataset
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|isc_stdtime_t
name|now
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_rdataset_t
modifier|*
name|addedrdataset
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|now
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|addedrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|subtractrdataset
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|,
name|unsigned
name|int
name|options
parameter_list|,
name|dns_rdataset_t
modifier|*
name|newrdataset
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|options
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|newrdataset
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|deleterdataset
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_dbversion_t
modifier|*
name|version
parameter_list|,
name|dns_rdatatype_t
name|type
parameter_list|,
name|dns_rdatatype_t
name|covers
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|version
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|covers
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|issecure
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|nodecount
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_boolean_t
name|ispersistent
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|overmem
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_boolean_t
name|overmem
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|overmem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|settask
parameter_list|(
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|dns_dbmethods_t
name|sdlzdb_methods
init|=
block|{
name|attach
block|,
name|detach
block|,
name|beginload
block|,
name|endload
block|,
name|dump
block|,
name|currentversion
block|,
name|newversion
block|,
name|attachversion
block|,
name|closeversion
block|,
name|findnode
block|,
name|find
block|,
name|findzonecut
block|,
name|attachnode
block|,
name|detachnode
block|,
name|expirenode
block|,
name|printnode
block|,
name|createiterator
block|,
name|findrdataset
block|,
name|allrdatasets
block|,
name|addrdataset
block|,
name|subtractrdataset
block|,
name|deleterdataset
block|,
name|issecure
block|,
name|nodecount
block|,
name|ispersistent
block|,
name|overmem
block|,
name|settask
block|,
name|NULL
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Database Iterator Methods.  These methods were "borrowed" from the SDB  * driver interface.  See the SDB driver interface documentation for more info.  */
end_comment

begin_function
specifier|static
name|void
name|dbiterator_destroy
parameter_list|(
name|dns_dbiterator_t
modifier|*
modifier|*
name|iteratorp
parameter_list|)
block|{
name|sdlz_dbiterator_t
modifier|*
name|sdlziter
init|=
operator|(
name|sdlz_dbiterator_t
operator|*
operator|)
operator|(
operator|*
name|iteratorp
operator|)
decl_stmt|;
name|dns_sdlz_db_t
modifier|*
name|sdlz
init|=
operator|(
name|dns_sdlz_db_t
operator|*
operator|)
name|sdlziter
operator|->
name|common
operator|.
name|db
decl_stmt|;
while|while
condition|(
operator|!
name|ISC_LIST_EMPTY
argument_list|(
name|sdlziter
operator|->
name|nodelist
argument_list|)
condition|)
block|{
name|dns_sdlznode_t
modifier|*
name|node
decl_stmt|;
name|node
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdlziter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
name|ISC_LIST_UNLINK
argument_list|(
name|sdlziter
operator|->
name|nodelist
argument_list|,
name|node
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|destroynode
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
name|dns_db_detach
argument_list|(
operator|&
name|sdlziter
operator|->
name|common
operator|.
name|db
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|sdlz
operator|->
name|common
operator|.
name|mctx
argument_list|,
name|sdlziter
argument_list|,
sizeof|sizeof
argument_list|(
name|sdlz_dbiterator_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|iteratorp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_first
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdlz_dbiterator_t
modifier|*
name|sdlziter
init|=
operator|(
name|sdlz_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdlziter
operator|->
name|current
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdlziter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlziter
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_last
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdlz_dbiterator_t
modifier|*
name|sdlziter
init|=
operator|(
name|sdlz_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdlziter
operator|->
name|current
operator|=
name|ISC_LIST_TAIL
argument_list|(
name|sdlziter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlziter
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_seek
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|sdlz_dbiterator_t
modifier|*
name|sdlziter
init|=
operator|(
name|sdlz_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdlziter
operator|->
name|current
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|sdlziter
operator|->
name|nodelist
argument_list|)
expr_stmt|;
while|while
condition|(
name|sdlziter
operator|->
name|current
operator|!=
name|NULL
condition|)
if|if
condition|(
name|dns_name_equal
argument_list|(
name|sdlziter
operator|->
name|current
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
return|return
operator|(
name|ISC_R_NOTFOUND
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_prev
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdlz_dbiterator_t
modifier|*
name|sdlziter
init|=
operator|(
name|sdlz_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdlziter
operator|->
name|current
operator|=
name|ISC_LIST_PREV
argument_list|(
name|sdlziter
operator|->
name|current
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlziter
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_next
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|sdlz_dbiterator_t
modifier|*
name|sdlziter
init|=
operator|(
name|sdlz_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|sdlziter
operator|->
name|current
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|sdlziter
operator|->
name|current
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlziter
operator|->
name|current
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMORE
operator|)
return|;
else|else
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_current
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_dbnode_t
modifier|*
modifier|*
name|nodep
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|sdlz_dbiterator_t
modifier|*
name|sdlziter
init|=
operator|(
name|sdlz_dbiterator_t
operator|*
operator|)
name|iterator
decl_stmt|;
name|attachnode
argument_list|(
name|iterator
operator|->
name|db
argument_list|,
name|sdlziter
operator|->
name|current
argument_list|,
name|nodep
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
return|return
operator|(
name|dns_name_copy
argument_list|(
name|sdlziter
operator|->
name|current
operator|->
name|name
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_pause
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|iterator
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dbiterator_origin
parameter_list|(
name|dns_dbiterator_t
modifier|*
name|iterator
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|iterator
argument_list|)
expr_stmt|;
return|return
operator|(
name|dns_name_copy
argument_list|(
name|dns_rootname
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Rdataset Methods. These methods were "borrowed" from the SDB driver  * interface.  See the SDB driver interface documentation for more info.  */
end_comment

begin_function
specifier|static
name|void
name|disassociate
parameter_list|(
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
init|=
name|rdataset
operator|->
name|private5
decl_stmt|;
name|dns_sdlznode_t
modifier|*
name|sdlznode
init|=
operator|(
name|dns_sdlznode_t
operator|*
operator|)
name|node
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
operator|(
name|dns_db_t
operator|*
operator|)
name|sdlznode
operator|->
name|sdlz
decl_stmt|;
name|detachnode
argument_list|(
name|db
argument_list|,
operator|&
name|node
argument_list|)
expr_stmt|;
name|isc__rdatalist_disassociate
argument_list|(
name|rdataset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rdataset_clone
parameter_list|(
name|dns_rdataset_t
modifier|*
name|source
parameter_list|,
name|dns_rdataset_t
modifier|*
name|target
parameter_list|)
block|{
name|dns_dbnode_t
modifier|*
name|node
init|=
name|source
operator|->
name|private5
decl_stmt|;
name|dns_sdlznode_t
modifier|*
name|sdlznode
init|=
operator|(
name|dns_sdlznode_t
operator|*
operator|)
name|node
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
operator|(
name|dns_db_t
operator|*
operator|)
name|sdlznode
operator|->
name|sdlz
decl_stmt|;
name|dns_dbnode_t
modifier|*
name|tempdb
init|=
name|NULL
decl_stmt|;
name|isc__rdatalist_clone
argument_list|(
name|source
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|attachnode
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
operator|&
name|tempdb
argument_list|)
expr_stmt|;
name|source
operator|->
name|private5
operator|=
name|tempdb
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|dns_rdatasetmethods_t
name|rdataset_methods
init|=
block|{
name|disassociate
block|,
name|isc__rdatalist_first
block|,
name|isc__rdatalist_next
block|,
name|isc__rdatalist_current
block|,
name|rdataset_clone
block|,
name|isc__rdatalist_count
block|,
name|isc__rdatalist_addnoqname
block|,
name|isc__rdatalist_getnoqname
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|list_tordataset
parameter_list|(
name|dns_rdatalist_t
modifier|*
name|rdatalist
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|dns_dbnode_t
modifier|*
name|node
parameter_list|,
name|dns_rdataset_t
modifier|*
name|rdataset
parameter_list|)
block|{
comment|/* 	 * The sdlz rdataset is an rdatalist with some additions. 	 *	- private1& private2 are used by the rdatalist. 	 *	- private3& private 4 are unused. 	 *	- private5 is the node. 	 */
comment|/* This should never fail. */
name|RUNTIME_CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
name|rdatalist
argument_list|,
name|rdataset
argument_list|)
operator|==
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|rdataset
operator|->
name|methods
operator|=
operator|&
name|rdataset_methods
expr_stmt|;
name|dns_db_attachnode
argument_list|(
name|db
argument_list|,
name|node
argument_list|,
operator|&
name|rdataset
operator|->
name|private5
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * SDLZ core methods. This is the core of the new DLZ functionality.  */
end_comment

begin_comment
comment|/*%  * Build a 'bind' database driver structure to be returned by  * either the find zone or the allow zone transfer method.  * This method is only available in this source file, it is  * not made available anywhere else.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|dns_sdlzcreateDBP
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|void
modifier|*
name|driverarg
parameter_list|,
name|void
modifier|*
name|dbdata
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_sdlz_db_t
modifier|*
name|sdlzdb
decl_stmt|;
name|dns_sdlzimplementation_t
modifier|*
name|imp
decl_stmt|;
comment|/* check that things are as we expect */
name|REQUIRE
argument_list|(
name|dbp
operator|!=
name|NULL
operator|&&
operator|*
name|dbp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|imp
operator|=
operator|(
name|dns_sdlzimplementation_t
operator|*
operator|)
name|driverarg
expr_stmt|;
comment|/* allocate and zero memory for driver structure */
name|sdlzdb
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlz_db_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlzdb
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|memset
argument_list|(
name|sdlzdb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlz_db_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* initialize and set origin */
name|dns_name_init
argument_list|(
operator|&
name|sdlzdb
operator|->
name|common
operator|.
name|origin
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_dupwithoffsets
argument_list|(
name|name
argument_list|,
name|mctx
argument_list|,
operator|&
name|sdlzdb
operator|->
name|common
operator|.
name|origin
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|mem_cleanup
goto|;
comment|/* initialize the reference count mutex */
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|sdlzdb
operator|->
name|refcnt_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|name_cleanup
goto|;
comment|/* set the rest of the database structure attributes */
name|sdlzdb
operator|->
name|dlzimp
operator|=
name|imp
expr_stmt|;
name|sdlzdb
operator|->
name|common
operator|.
name|methods
operator|=
operator|&
name|sdlzdb_methods
expr_stmt|;
name|sdlzdb
operator|->
name|common
operator|.
name|attributes
operator|=
literal|0
expr_stmt|;
name|sdlzdb
operator|->
name|common
operator|.
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|sdlzdb
operator|->
name|common
operator|.
name|mctx
operator|=
name|NULL
expr_stmt|;
name|sdlzdb
operator|->
name|dbdata
operator|=
name|dbdata
expr_stmt|;
name|sdlzdb
operator|->
name|references
operator|=
literal|1
expr_stmt|;
comment|/* attach to the memory context */
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|sdlzdb
operator|->
name|common
operator|.
name|mctx
argument_list|)
expr_stmt|;
comment|/* mark structure as valid */
name|sdlzdb
operator|->
name|common
operator|.
name|magic
operator|=
name|DNS_DB_MAGIC
expr_stmt|;
name|sdlzdb
operator|->
name|common
operator|.
name|impmagic
operator|=
name|SDLZDB_MAGIC
expr_stmt|;
operator|*
name|dbp
operator|=
operator|(
name|dns_db_t
operator|*
operator|)
name|sdlzdb
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
comment|/* 	 * reference count mutex could not be initialized, clean up 	 * name memory 	 */
name|name_cleanup
label|:
name|dns_name_free
argument_list|(
operator|&
name|sdlzdb
operator|->
name|common
operator|.
name|origin
argument_list|,
name|mctx
argument_list|)
expr_stmt|;
name|mem_cleanup
label|:
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sdlzdb
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlz_db_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dns_sdlzallowzonexfr
parameter_list|(
name|void
modifier|*
name|driverarg
parameter_list|,
name|void
modifier|*
name|dbdata
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|clientaddr
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
block|{
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_buffer_t
name|b2
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_MAXTEXT
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|clientstr
index|[
operator|(
sizeof|sizeof
expr|"xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:255.255.255.255"
block|)
function|+ 1];
end_function

begin_decl_stmt
name|isc_netaddr_t
name|netaddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|isc_result_t
name|result
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|dns_sdlzimplementation_t
modifier|*
name|imp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 	 * Perform checks to make sure data is as we expect it to be. 	 */
end_comment

begin_expr_stmt
name|REQUIRE
argument_list|(
name|driverarg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|REQUIRE
argument_list|(
name|clientaddr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|REQUIRE
argument_list|(
name|dbp
operator|!=
name|NULL
operator|&&
operator|*
name|dbp
operator|==
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|imp
operator|=
operator|(
name|dns_sdlzimplementation_t
operator|*
operator|)
name|driverarg
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Convert DNS name to ascii text */
end_comment

begin_expr_stmt
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|result
operator|=
name|dns_name_totext
argument_list|(
name|name
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
end_if

begin_expr_stmt
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* convert client address to ascii text */
end_comment

begin_expr_stmt
name|isc_buffer_init
argument_list|(
operator|&
name|b2
argument_list|,
name|clientstr
argument_list|,
sizeof|sizeof
argument_list|(
name|clientstr
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|clientaddr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|result
operator|=
name|isc_netaddr_totext
argument_list|(
operator|&
name|netaddr
argument_list|,
operator|&
name|b2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
end_if

begin_expr_stmt
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* make sure strings are always lowercase */
end_comment

begin_expr_stmt
name|dns_sdlz_tolower
argument_list|(
name|namestr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|dns_sdlz_tolower
argument_list|(
name|clientstr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Call SDLZ driver's find zone method */
end_comment

begin_if
if|if
condition|(
name|imp
operator|->
name|methods
operator|->
name|allowzonexfr
operator|!=
name|NULL
condition|)
block|{
name|MAYBE_LOCK
argument_list|(
name|imp
argument_list|)
expr_stmt|;
name|result
operator|=
name|imp
operator|->
name|methods
operator|->
name|allowzonexfr
argument_list|(
name|imp
operator|->
name|driverarg
argument_list|,
name|dbdata
argument_list|,
name|namestr
argument_list|,
name|clientstr
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|imp
argument_list|)
expr_stmt|;
comment|/* 		 * if zone is supported and transfers allowed build a 'bind' 		 * database driver 		 */
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|dns_sdlzcreateDBP
argument_list|(
name|mctx
argument_list|,
name|driverarg
argument_list|,
name|dbdata
argument_list|,
name|name
argument_list|,
name|rdclass
argument_list|,
name|dbp
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_if

begin_return
return|return
operator|(
name|ISC_R_NOTIMPLEMENTED
operator|)
return|;
end_return

begin_function
unit|}  static
name|isc_result_t
name|dns_sdlzcreate
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
specifier|const
name|char
modifier|*
name|dlzname
parameter_list|,
name|unsigned
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|void
modifier|*
name|driverarg
parameter_list|,
name|void
modifier|*
modifier|*
name|dbdata
parameter_list|)
block|{
name|dns_sdlzimplementation_t
modifier|*
name|imp
decl_stmt|;
name|isc_result_t
name|result
init|=
name|ISC_R_NOTFOUND
decl_stmt|;
comment|/* Write debugging message to log */
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DATABASE
argument_list|,
name|DNS_LOGMODULE_DLZ
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"Loading SDLZ driver."
argument_list|)
expr_stmt|;
comment|/* 	 * Performs checks to make sure data is as we expect it to be. 	 */
name|REQUIRE
argument_list|(
name|driverarg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dlzname
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dbdata
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|mctx
argument_list|)
expr_stmt|;
name|imp
operator|=
name|driverarg
expr_stmt|;
comment|/* If the create method exists, call it. */
if|if
condition|(
name|imp
operator|->
name|methods
operator|->
name|create
operator|!=
name|NULL
condition|)
block|{
name|MAYBE_LOCK
argument_list|(
name|imp
argument_list|)
expr_stmt|;
name|result
operator|=
name|imp
operator|->
name|methods
operator|->
name|create
argument_list|(
name|dlzname
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|imp
operator|->
name|driverarg
argument_list|,
name|dbdata
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|imp
argument_list|)
expr_stmt|;
block|}
comment|/* Write debugging message to log */
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DATABASE
argument_list|,
name|DNS_LOGMODULE_DLZ
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"SDLZ driver loaded successfully."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DATABASE
argument_list|,
name|DNS_LOGMODULE_DLZ
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"SDLZ driver failed to load."
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dns_sdlzdestroy
parameter_list|(
name|void
modifier|*
name|driverdata
parameter_list|,
name|void
modifier|*
modifier|*
name|dbdata
parameter_list|)
block|{
name|dns_sdlzimplementation_t
modifier|*
name|imp
decl_stmt|;
comment|/* Write debugging message to log */
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DATABASE
argument_list|,
name|DNS_LOGMODULE_DLZ
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"Unloading SDLZ driver."
argument_list|)
expr_stmt|;
name|imp
operator|=
name|driverdata
expr_stmt|;
comment|/* If the destroy method exists, call it. */
if|if
condition|(
name|imp
operator|->
name|methods
operator|->
name|destroy
operator|!=
name|NULL
condition|)
block|{
name|MAYBE_LOCK
argument_list|(
name|imp
argument_list|)
expr_stmt|;
name|imp
operator|->
name|methods
operator|->
name|destroy
argument_list|(
name|imp
operator|->
name|driverarg
argument_list|,
name|dbdata
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|imp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|dns_sdlzfindzone
parameter_list|(
name|void
modifier|*
name|driverarg
parameter_list|,
name|void
modifier|*
name|dbdata
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
block|{
name|isc_buffer_t
name|b
decl_stmt|;
name|char
name|namestr
index|[
name|DNS_NAME_MAXTEXT
operator|+
literal|1
index|]
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_sdlzimplementation_t
modifier|*
name|imp
decl_stmt|;
comment|/* 	 * Perform checks to make sure data is as we expect it to be. 	 */
name|REQUIRE
argument_list|(
name|driverarg
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|dbp
operator|!=
name|NULL
operator|&&
operator|*
name|dbp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|imp
operator|=
operator|(
name|dns_sdlzimplementation_t
operator|*
operator|)
name|driverarg
expr_stmt|;
comment|/* Convert DNS name to ascii text */
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|namestr
argument_list|,
sizeof|sizeof
argument_list|(
name|namestr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_totext
argument_list|(
name|name
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|isc_buffer_putuint8
argument_list|(
operator|&
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* make sure strings are always lowercase */
name|dns_sdlz_tolower
argument_list|(
name|namestr
argument_list|)
expr_stmt|;
comment|/* Call SDLZ driver's find zone method */
name|MAYBE_LOCK
argument_list|(
name|imp
argument_list|)
expr_stmt|;
name|result
operator|=
name|imp
operator|->
name|methods
operator|->
name|findzone
argument_list|(
name|imp
operator|->
name|driverarg
argument_list|,
name|dbdata
argument_list|,
name|namestr
argument_list|)
expr_stmt|;
name|MAYBE_UNLOCK
argument_list|(
name|imp
argument_list|)
expr_stmt|;
comment|/* 	 * if zone is supported build a 'bind' database driver 	 * structure to return 	 */
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|dns_sdlzcreateDBP
argument_list|(
name|mctx
argument_list|,
name|driverarg
argument_list|,
name|dbdata
argument_list|,
name|name
argument_list|,
name|rdclass
argument_list|,
name|dbp
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|dns_dlzmethods_t
name|sdlzmethods
init|=
block|{
name|dns_sdlzcreate
block|,
name|dns_sdlzdestroy
block|,
name|dns_sdlzfindzone
block|,
name|dns_sdlzallowzonexfr
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Public functions.  */
end_comment

begin_function
name|isc_result_t
name|dns_sdlz_putrr
parameter_list|(
name|dns_sdlzlookup_t
modifier|*
name|lookup
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|dns_rdatalist_t
modifier|*
name|rdatalist
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
decl_stmt|;
name|dns_rdatatype_t
name|typeval
decl_stmt|;
name|isc_consttextregion_t
name|r
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_buffer_t
modifier|*
name|rdatabuf
init|=
name|NULL
decl_stmt|;
name|isc_lex_t
modifier|*
name|lex
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|unsigned
name|int
name|size
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_name_t
modifier|*
name|origin
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_SDLZLOOKUP
argument_list|(
name|lookup
argument_list|)
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|type
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|lookup
operator|->
name|sdlz
operator|->
name|common
operator|.
name|mctx
expr_stmt|;
name|r
operator|.
name|base
operator|=
name|type
expr_stmt|;
name|r
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_rdatatype_fromtext
argument_list|(
operator|&
name|typeval
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|rdatalist
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|lookup
operator|->
name|lists
argument_list|)
expr_stmt|;
while|while
condition|(
name|rdatalist
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rdatalist
operator|->
name|type
operator|==
name|typeval
condition|)
break|break;
name|rdatalist
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rdatalist
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdatalist
operator|==
name|NULL
condition|)
block|{
name|rdatalist
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdatalist_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdatalist
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|rdatalist
operator|->
name|rdclass
operator|=
name|lookup
operator|->
name|sdlz
operator|->
name|common
operator|.
name|rdclass
expr_stmt|;
name|rdatalist
operator|->
name|type
operator|=
name|typeval
expr_stmt|;
name|rdatalist
operator|->
name|covers
operator|=
literal|0
expr_stmt|;
name|rdatalist
operator|->
name|ttl
operator|=
name|ttl
expr_stmt|;
name|ISC_LIST_INIT
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|rdatalist
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|lookup
operator|->
name|lists
argument_list|,
name|rdatalist
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdatalist
operator|->
name|ttl
operator|!=
name|ttl
condition|)
return|return
operator|(
name|DNS_R_BADTTL
operator|)
return|;
name|rdata
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|lookup
operator|->
name|sdlz
operator|->
name|dlzimp
operator|->
name|flags
operator|&
name|DNS_SDLZFLAG_RELATIVERDATA
operator|)
operator|!=
literal|0
condition|)
name|origin
operator|=
operator|&
name|lookup
operator|->
name|sdlz
operator|->
name|common
operator|.
name|origin
expr_stmt|;
else|else
name|origin
operator|=
name|dns_rootname
expr_stmt|;
name|lex
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_lex_create
argument_list|(
name|mctx
argument_list|,
literal|64
argument_list|,
operator|&
name|lex
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
name|size
operator|=
name|initial_size
argument_list|(
name|data
argument_list|)
expr_stmt|;
do|do
block|{
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|data
argument_list|,
name|strlen
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_lex_openbuffer
argument_list|(
name|lex
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
name|rdatabuf
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|isc_buffer_allocate
argument_list|(
name|mctx
argument_list|,
operator|&
name|rdatabuf
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
name|result
operator|=
name|dns_rdata_fromtext
argument_list|(
name|rdata
argument_list|,
name|rdatalist
operator|->
name|rdclass
argument_list|,
name|rdatalist
operator|->
name|type
argument_list|,
name|lex
argument_list|,
name|origin
argument_list|,
name|ISC_FALSE
argument_list|,
name|mctx
argument_list|,
name|rdatabuf
argument_list|,
operator|&
name|lookup
operator|->
name|callbacks
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|rdatabuf
argument_list|)
expr_stmt|;
name|size
operator|*=
literal|2
expr_stmt|;
block|}
do|while
condition|(
name|result
operator|==
name|ISC_R_NOSPACE
condition|)
do|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
name|ISC_LIST_APPEND
argument_list|(
name|rdatalist
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|lookup
operator|->
name|buffers
argument_list|,
name|rdatabuf
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|lex
operator|!=
name|NULL
condition|)
name|isc_lex_destroy
argument_list|(
operator|&
name|lex
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|failure
label|:
if|if
condition|(
name|rdatabuf
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|rdatabuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|lex
operator|!=
name|NULL
condition|)
name|isc_lex_destroy
argument_list|(
operator|&
name|lex
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|rdata
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_rdata_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_sdlz_putnamedrr
parameter_list|(
name|dns_sdlzallnodes_t
modifier|*
name|allnodes
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|dns_name_t
modifier|*
name|newname
decl_stmt|,
modifier|*
name|origin
decl_stmt|;
name|dns_fixedname_t
name|fnewname
decl_stmt|;
name|dns_sdlz_db_t
modifier|*
name|sdlz
init|=
operator|(
name|dns_sdlz_db_t
operator|*
operator|)
name|allnodes
operator|->
name|common
operator|.
name|db
decl_stmt|;
name|dns_sdlznode_t
modifier|*
name|sdlznode
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
init|=
name|sdlz
operator|->
name|common
operator|.
name|mctx
decl_stmt|;
name|isc_buffer_t
name|b
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_fixedname_init
argument_list|(
operator|&
name|fnewname
argument_list|)
expr_stmt|;
name|newname
operator|=
name|dns_fixedname_name
argument_list|(
operator|&
name|fnewname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sdlz
operator|->
name|dlzimp
operator|->
name|flags
operator|&
name|DNS_SDLZFLAG_RELATIVERDATA
operator|)
operator|!=
literal|0
condition|)
name|origin
operator|=
operator|&
name|sdlz
operator|->
name|common
operator|.
name|origin
expr_stmt|;
else|else
name|origin
operator|=
name|dns_rootname
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|b
argument_list|,
name|name
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_add
argument_list|(
operator|&
name|b
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_fromtext
argument_list|(
name|newname
argument_list|,
operator|&
name|b
argument_list|,
name|origin
argument_list|,
name|ISC_FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
name|allnodes
operator|->
name|common
operator|.
name|relative_names
condition|)
block|{
comment|/* All names are relative to the root */
name|unsigned
name|int
name|nlabels
init|=
name|dns_name_countlabels
argument_list|(
name|newname
argument_list|)
decl_stmt|;
name|dns_name_getlabelsequence
argument_list|(
name|newname
argument_list|,
literal|0
argument_list|,
name|nlabels
operator|-
literal|1
argument_list|,
name|newname
argument_list|)
expr_stmt|;
block|}
name|sdlznode
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|allnodes
operator|->
name|nodelist
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlznode
operator|==
name|NULL
operator|||
operator|!
name|dns_name_equal
argument_list|(
name|sdlznode
operator|->
name|name
argument_list|,
name|newname
argument_list|)
condition|)
block|{
name|sdlznode
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|createnode
argument_list|(
name|sdlz
argument_list|,
operator|&
name|sdlznode
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
name|sdlznode
operator|->
name|name
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdlznode
operator|->
name|name
operator|==
name|NULL
condition|)
block|{
name|destroynode
argument_list|(
name|sdlznode
argument_list|)
expr_stmt|;
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
block|}
name|dns_name_init
argument_list|(
name|sdlznode
operator|->
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|result
operator|=
name|dns_name_dup
argument_list|(
name|newname
argument_list|,
name|mctx
argument_list|,
name|sdlznode
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|sdlznode
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_name_t
argument_list|)
argument_list|)
expr_stmt|;
name|destroynode
argument_list|(
name|sdlznode
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
name|ISC_LIST_PREPEND
argument_list|(
name|allnodes
operator|->
name|nodelist
argument_list|,
name|sdlznode
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|allnodes
operator|->
name|origin
operator|==
name|NULL
operator|&&
name|dns_name_equal
argument_list|(
name|newname
argument_list|,
operator|&
name|sdlz
operator|->
name|common
operator|.
name|origin
argument_list|)
condition|)
name|allnodes
operator|->
name|origin
operator|=
name|sdlznode
expr_stmt|;
block|}
return|return
operator|(
name|dns_sdlz_putrr
argument_list|(
name|sdlznode
argument_list|,
name|type
argument_list|,
name|ttl
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_sdlz_putsoa
parameter_list|(
name|dns_sdlzlookup_t
modifier|*
name|lookup
parameter_list|,
specifier|const
name|char
modifier|*
name|mname
parameter_list|,
specifier|const
name|char
modifier|*
name|rname
parameter_list|,
name|isc_uint32_t
name|serial
parameter_list|)
block|{
name|char
name|str
index|[
literal|2
operator|*
name|DNS_NAME_MAXTEXT
operator|+
literal|5
operator|*
operator|(
sizeof|sizeof
argument_list|(
literal|"2147483647"
argument_list|)
operator|)
operator|+
literal|7
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
name|REQUIRE
argument_list|(
name|mname
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|rname
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
name|str
argument_list|,
sizeof|sizeof
name|str
argument_list|,
literal|"%s %s %u %u %u %u %u"
argument_list|,
name|mname
argument_list|,
name|rname
argument_list|,
name|serial
argument_list|,
name|SDLZ_DEFAULT_REFRESH
argument_list|,
name|SDLZ_DEFAULT_RETRY
argument_list|,
name|SDLZ_DEFAULT_EXPIRE
argument_list|,
name|SDLZ_DEFAULT_MINIMUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|str
argument_list|)
operator|||
name|n
operator|<
literal|0
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
return|return
operator|(
name|dns_sdlz_putrr
argument_list|(
name|lookup
argument_list|,
literal|"SOA"
argument_list|,
name|SDLZ_DEFAULT_TTL
argument_list|,
name|str
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_sdlzregister
parameter_list|(
specifier|const
name|char
modifier|*
name|drivername
parameter_list|,
specifier|const
name|dns_sdlzmethods_t
modifier|*
name|methods
parameter_list|,
name|void
modifier|*
name|driverarg
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_sdlzimplementation_t
modifier|*
modifier|*
name|sdlzimp
parameter_list|)
block|{
name|dns_sdlzimplementation_t
modifier|*
name|imp
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
comment|/* 	 * Performs checks to make sure data is as we expect it to be. 	 */
name|REQUIRE
argument_list|(
name|drivername
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|methods
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|methods
operator|->
name|findzone
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|methods
operator|->
name|lookup
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|mctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
name|sdlzimp
operator|!=
name|NULL
operator|&&
operator|*
name|sdlzimp
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|REQUIRE
argument_list|(
operator|(
name|flags
operator|&
operator|~
operator|(
name|DNS_SDLZFLAG_RELATIVEOWNER
operator||
name|DNS_SDLZFLAG_RELATIVERDATA
operator||
name|DNS_SDLZFLAG_THREADSAFE
operator|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* Write debugging message to log */
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DATABASE
argument_list|,
name|DNS_LOGMODULE_DLZ
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"Registering SDLZ driver '%s'"
argument_list|,
name|drivername
argument_list|)
expr_stmt|;
comment|/* 	 * Allocate memory for a sdlz_implementation object.  Error if 	 * we cannot. 	 */
name|imp
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlzimplementation_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|imp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
comment|/* Make sure memory region is set to all 0's */
name|memset
argument_list|(
name|imp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlzimplementation_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Store the data passed into this method */
name|imp
operator|->
name|methods
operator|=
name|methods
expr_stmt|;
name|imp
operator|->
name|driverarg
operator|=
name|driverarg
expr_stmt|;
name|imp
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|imp
operator|->
name|mctx
operator|=
name|NULL
expr_stmt|;
comment|/* attach the new sdlz_implementation object to a memory context */
name|isc_mem_attach
argument_list|(
name|mctx
argument_list|,
operator|&
name|imp
operator|->
name|mctx
argument_list|)
expr_stmt|;
comment|/* 	 * initialize the driver lock, error if we cannot 	 * (used if a driver does not support multiple threads) 	 */
name|result
operator|=
name|isc_mutex_init
argument_list|(
operator|&
name|imp
operator|->
name|driverlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|UNEXPECTED_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"isc_mutex_init() failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|cleanup_mctx
goto|;
block|}
name|imp
operator|->
name|dlz_imp
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * register the DLZ driver.  Pass in our "extra" sdlz information as 	 * a driverarg.  (that's why we stored the passed in driver arg in our 	 * sdlz_implementation structure)  Also, store the dlz_implementation 	 * structure in our sdlz_implementation. 	 */
name|result
operator|=
name|dns_dlzregister
argument_list|(
name|drivername
argument_list|,
operator|&
name|sdlzmethods
argument_list|,
name|imp
argument_list|,
name|mctx
argument_list|,
operator|&
name|imp
operator|->
name|dlz_imp
argument_list|)
expr_stmt|;
comment|/* if registration fails, cleanup and get outta here. */
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|cleanup_mutex
goto|;
operator|*
name|sdlzimp
operator|=
name|imp
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|cleanup_mutex
label|:
comment|/* destroy the driver lock, we don't need it anymore */
name|DESTROYLOCK
argument_list|(
operator|&
name|imp
operator|->
name|driverlock
argument_list|)
expr_stmt|;
name|cleanup_mctx
label|:
comment|/* 	 * return the memory back to the available memory pool and 	 * remove it from the memory context. 	 */
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|imp
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlzimplementation_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_sdlzunregister
parameter_list|(
name|dns_sdlzimplementation_t
modifier|*
modifier|*
name|sdlzimp
parameter_list|)
block|{
name|dns_sdlzimplementation_t
modifier|*
name|imp
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
comment|/* Write debugging message to log */
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_DATABASE
argument_list|,
name|DNS_LOGMODULE_DLZ
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|"Unregistering SDLZ driver."
argument_list|)
expr_stmt|;
comment|/* 	 * Performs checks to make sure data is as we expect it to be. 	 */
name|REQUIRE
argument_list|(
name|sdlzimp
operator|!=
name|NULL
operator|&&
operator|*
name|sdlzimp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|imp
operator|=
operator|*
name|sdlzimp
expr_stmt|;
comment|/* Unregister the DLZ driver implementation */
name|dns_dlzunregister
argument_list|(
operator|&
name|imp
operator|->
name|dlz_imp
argument_list|)
expr_stmt|;
comment|/* destroy the driver lock, we don't need it anymore */
name|DESTROYLOCK
argument_list|(
operator|&
name|imp
operator|->
name|driverlock
argument_list|)
expr_stmt|;
name|mctx
operator|=
name|imp
operator|->
name|mctx
expr_stmt|;
comment|/* 	 * return the memory back to the available memory pool and 	 * remove it from the memory context. 	 */
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|imp
argument_list|,
sizeof|sizeof
argument_list|(
name|dns_sdlzimplementation_t
argument_list|)
argument_list|)
expr_stmt|;
name|isc_mem_detach
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
operator|*
name|sdlzimp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

end_unit


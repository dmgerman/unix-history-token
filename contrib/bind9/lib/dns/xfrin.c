begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004-2006  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: xfrin.c,v 1.124.2.4.2.16 2006/07/19 01:04:24 marka Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/mem.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/random.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_comment
comment|/* Required for HP/UX (and others?) */
end_comment

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/timer.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_include
include|#
directive|include
file|<dns/db.h>
end_include

begin_include
include|#
directive|include
file|<dns/diff.h>
end_include

begin_include
include|#
directive|include
file|<dns/events.h>
end_include

begin_include
include|#
directive|include
file|<dns/journal.h>
end_include

begin_include
include|#
directive|include
file|<dns/log.h>
end_include

begin_include
include|#
directive|include
file|<dns/message.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataclass.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdatalist.h>
end_include

begin_include
include|#
directive|include
file|<dns/rdataset.h>
end_include

begin_include
include|#
directive|include
file|<dns/result.h>
end_include

begin_include
include|#
directive|include
file|<dns/soa.h>
end_include

begin_include
include|#
directive|include
file|<dns/tcpmsg.h>
end_include

begin_include
include|#
directive|include
file|<dns/timer.h>
end_include

begin_include
include|#
directive|include
file|<dns/tsig.h>
end_include

begin_include
include|#
directive|include
file|<dns/view.h>
end_include

begin_include
include|#
directive|include
file|<dns/xfrin.h>
end_include

begin_include
include|#
directive|include
file|<dns/zone.h>
end_include

begin_include
include|#
directive|include
file|<dst/dst.h>
end_include

begin_comment
comment|/*  * Incoming AXFR and IXFR.  */
end_comment

begin_comment
comment|/*  * It would be non-sensical (or at least obtuse) to use FAIL() with an  * ISC_R_SUCCESS code, but the test is there to keep the Solaris compiler  * from complaining about "end-of-loop code not reached".  */
end_comment

begin_define
define|#
directive|define
name|FAIL
parameter_list|(
name|code
parameter_list|)
define|\
value|do { result = (code);					\ 		if (result != ISC_R_SUCCESS) goto failure;	\ 	} while (0)
end_define

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|op
parameter_list|)
define|\
value|do { result = (op);					\ 		if (result != ISC_R_SUCCESS) goto failure;	\ 	} while (0)
end_define

begin_comment
comment|/*  * The states of the *XFR state machine.  We handle both IXFR and AXFR  * with a single integrated state machine because they cannot be distinguished  * immediately - an AXFR response to an IXFR request can only be detected  * when the first two (2) response RRs have already been received.  */
end_comment

begin_typedef
typedef|typedef
enum|enum
block|{
name|XFRST_SOAQUERY
block|,
name|XFRST_GOTSOA
block|,
name|XFRST_INITIALSOA
block|,
name|XFRST_FIRSTDATA
block|,
name|XFRST_IXFR_DELSOA
block|,
name|XFRST_IXFR_DEL
block|,
name|XFRST_IXFR_ADDSOA
block|,
name|XFRST_IXFR_ADD
block|,
name|XFRST_AXFR
block|,
name|XFRST_END
block|}
name|xfrin_state_t
typedef|;
end_typedef

begin_comment
comment|/*  * Incoming zone transfer context.  */
end_comment

begin_struct
struct|struct
name|dns_xfrin_ctx
block|{
name|unsigned
name|int
name|magic
decl_stmt|;
name|isc_mem_t
modifier|*
name|mctx
decl_stmt|;
name|dns_zone_t
modifier|*
name|zone
decl_stmt|;
name|int
name|refcount
decl_stmt|;
name|isc_task_t
modifier|*
name|task
decl_stmt|;
name|isc_timer_t
modifier|*
name|timer
decl_stmt|;
name|isc_socketmgr_t
modifier|*
name|socketmgr
decl_stmt|;
name|int
name|connects
decl_stmt|;
comment|/* Connect in progress */
name|int
name|sends
decl_stmt|;
comment|/* Send in progress */
name|int
name|recvs
decl_stmt|;
comment|/* Receive in progress */
name|isc_boolean_t
name|shuttingdown
decl_stmt|;
name|dns_name_t
name|name
decl_stmt|;
comment|/* Name of zone to transfer */
name|dns_rdataclass_t
name|rdclass
decl_stmt|;
name|isc_boolean_t
name|checkid
decl_stmt|;
name|dns_messageid_t
name|id
decl_stmt|;
comment|/* 	 * Requested transfer type (dns_rdatatype_axfr or 	 * dns_rdatatype_ixfr).  The actual transfer type 	 * may differ due to IXFR->AXFR fallback. 	 */
name|dns_rdatatype_t
name|reqtype
decl_stmt|;
name|isc_sockaddr_t
name|masteraddr
decl_stmt|;
name|isc_sockaddr_t
name|sourceaddr
decl_stmt|;
name|isc_socket_t
modifier|*
name|socket
decl_stmt|;
comment|/* Buffer for IXFR/AXFR request message */
name|isc_buffer_t
name|qbuffer
decl_stmt|;
name|unsigned
name|char
name|qbuffer_data
index|[
literal|512
index|]
decl_stmt|;
comment|/* Incoming reply TCP message */
name|dns_tcpmsg_t
name|tcpmsg
decl_stmt|;
name|isc_boolean_t
name|tcpmsg_valid
decl_stmt|;
name|dns_db_t
modifier|*
name|db
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|ver
decl_stmt|;
name|dns_diff_t
name|diff
decl_stmt|;
comment|/* Pending database changes */
name|int
name|difflen
decl_stmt|;
comment|/* Number of pending tuples */
name|xfrin_state_t
name|state
decl_stmt|;
name|isc_uint32_t
name|end_serial
decl_stmt|;
name|isc_boolean_t
name|is_ixfr
decl_stmt|;
name|unsigned
name|int
name|nmsg
decl_stmt|;
comment|/* Number of messages recvd */
name|dns_tsigkey_t
modifier|*
name|tsigkey
decl_stmt|;
comment|/* Key used to create TSIG */
name|isc_buffer_t
modifier|*
name|lasttsig
decl_stmt|;
comment|/* The last TSIG */
name|dst_context_t
modifier|*
name|tsigctx
decl_stmt|;
comment|/* TSIG verification context */
name|unsigned
name|int
name|sincetsig
decl_stmt|;
comment|/* recvd since the last TSIG */
name|dns_xfrindone_t
name|done
decl_stmt|;
comment|/* 	 * AXFR- and IXFR-specific data.  Only one is used at a time 	 * according to the is_ixfr flag, so this could be a union, 	 * but keeping them separate makes it a bit simpler to clean 	 * things up when destroying the context. 	 */
struct|struct
block|{
name|dns_addrdatasetfunc_t
name|add_func
decl_stmt|;
name|dns_dbload_t
modifier|*
name|add_private
decl_stmt|;
block|}
name|axfr
struct|;
struct|struct
block|{
name|isc_uint32_t
name|request_serial
decl_stmt|;
name|isc_uint32_t
name|current_serial
decl_stmt|;
name|dns_journal_t
modifier|*
name|journal
decl_stmt|;
block|}
name|ixfr
struct|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|XFRIN_MAGIC
value|ISC_MAGIC('X', 'f', 'r', 'I')
end_define

begin_define
define|#
directive|define
name|VALID_XFRIN
parameter_list|(
name|x
parameter_list|)
value|ISC_MAGIC_VALID(x, XFRIN_MAGIC)
end_define

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/*  * Forward declarations.  */
end_comment

begin_function_decl
specifier|static
name|isc_result_t
name|xfrin_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|dns_name_t
modifier|*
name|zonename
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_rdatatype_t
name|reqtype
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|masteraddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|sourceaddr
parameter_list|,
name|dns_tsigkey_t
modifier|*
name|tsigkey
parameter_list|,
name|dns_xfrin_ctx_t
modifier|*
modifier|*
name|xfrp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|axfr_init
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|axfr_makedb
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|axfr_putdata
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|dns_diffop_t
name|op
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|axfr_apply
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|axfr_commit
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|ixfr_init
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|ixfr_apply
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|ixfr_putdata
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|dns_diffop_t
name|op
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|ixfr_commit
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|xfr_rr
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_uint32_t
name|ttl
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|xfrin_start
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfrin_connect_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|xfrin_send_request
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfrin_send_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfrin_sendlen_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfrin_recv_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfrin_timeout
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|maybe_free
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfrin_fail
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|isc_result_t
name|result
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|isc_result_t
name|render
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_buffer_t
modifier|*
name|buf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xfrin_logv
parameter_list|(
name|int
name|level
parameter_list|,
name|dns_name_t
modifier|*
name|zonename
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|masteraddr
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|5
operator|,
function_decl|0
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function_decl
specifier|static
name|void
name|xfrin_log1
parameter_list|(
name|int
name|level
parameter_list|,
name|dns_name_t
modifier|*
name|zonename
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|masteraddr
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|5
operator|,
function_decl|6
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_function_decl
specifier|static
name|void
name|xfrin_log
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|ISC_FORMAT_PRINTF
parameter_list|(
function_decl|3
operator|,
function_decl|4
end_function_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/*  * AXFR handling  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|axfr_init
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|xfr
operator|->
name|is_ixfr
operator|=
name|ISC_FALSE
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|xfr
operator|->
name|db
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|axfr_makedb
argument_list|(
name|xfr
argument_list|,
operator|&
name|xfr
operator|->
name|db
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_db_beginload
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|xfr
operator|->
name|axfr
operator|.
name|add_func
argument_list|,
operator|&
name|xfr
operator|->
name|axfr
operator|.
name|add_private
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|axfr_makedb
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|dns_db_t
modifier|*
modifier|*
name|dbp
parameter_list|)
block|{
return|return
operator|(
name|dns_db_create
argument_list|(
name|xfr
operator|->
name|mctx
argument_list|,
comment|/* XXX */
literal|"rbt"
argument_list|,
comment|/* XXX guess */
operator|&
name|xfr
operator|->
name|name
argument_list|,
name|dns_dbtype_zone
argument_list|,
name|xfr
operator|->
name|rdclass
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
comment|/* XXX guess */
name|dbp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|axfr_putdata
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|dns_diffop_t
name|op
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
init|=
name|NULL
decl_stmt|;
name|CHECK
argument_list|(
name|dns_zone_checknames
argument_list|(
name|xfr
operator|->
name|zone
argument_list|,
name|name
argument_list|,
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_difftuple_create
argument_list|(
name|xfr
operator|->
name|diff
operator|.
name|mctx
argument_list|,
name|op
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
name|rdata
argument_list|,
operator|&
name|tuple
argument_list|)
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|xfr
operator|->
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|xfr
operator|->
name|difflen
operator|>
literal|100
condition|)
name|CHECK
argument_list|(
name|axfr_apply
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Store a set of AXFR RRs in the database.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|axfr_apply
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|CHECK
argument_list|(
name|dns_diff_load
argument_list|(
operator|&
name|xfr
operator|->
name|diff
argument_list|,
name|xfr
operator|->
name|axfr
operator|.
name|add_func
argument_list|,
name|xfr
operator|->
name|axfr
operator|.
name|add_private
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|difflen
operator|=
literal|0
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|xfr
operator|->
name|diff
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|axfr_commit
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|CHECK
argument_list|(
name|axfr_apply
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_db_endload
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|xfr
operator|->
name|axfr
operator|.
name|add_private
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_zone_replacedb
argument_list|(
name|xfr
operator|->
name|zone
argument_list|,
name|xfr
operator|->
name|db
argument_list|,
name|ISC_TRUE
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/*  * IXFR handling  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|ixfr_init
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|char
modifier|*
name|journalfile
decl_stmt|;
if|if
condition|(
name|xfr
operator|->
name|reqtype
operator|!=
name|dns_rdatatype_ixfr
condition|)
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"got incremental response to AXFR request"
argument_list|)
expr_stmt|;
return|return
operator|(
name|DNS_R_FORMERR
operator|)
return|;
block|}
name|xfr
operator|->
name|is_ixfr
operator|=
name|ISC_TRUE
expr_stmt|;
name|INSIST
argument_list|(
name|xfr
operator|->
name|db
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|difflen
operator|=
literal|0
expr_stmt|;
name|journalfile
operator|=
name|dns_zone_getjournal
argument_list|(
name|xfr
operator|->
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|journalfile
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|dns_journal_open
argument_list|(
name|xfr
operator|->
name|mctx
argument_list|,
name|journalfile
argument_list|,
name|ISC_TRUE
argument_list|,
operator|&
name|xfr
operator|->
name|ixfr
operator|.
name|journal
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|ixfr_putdata
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|dns_diffop_t
name|op
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|dns_ttl_t
name|ttl
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|tuple
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|op
operator|==
name|DNS_DIFFOP_ADD
condition|)
name|CHECK
argument_list|(
name|dns_zone_checknames
argument_list|(
name|xfr
operator|->
name|zone
argument_list|,
name|name
argument_list|,
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_difftuple_create
argument_list|(
name|xfr
operator|->
name|diff
operator|.
name|mctx
argument_list|,
name|op
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
name|rdata
argument_list|,
operator|&
name|tuple
argument_list|)
argument_list|)
expr_stmt|;
name|dns_diff_append
argument_list|(
operator|&
name|xfr
operator|->
name|diff
argument_list|,
operator|&
name|tuple
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|xfr
operator|->
name|difflen
operator|>
literal|100
condition|)
name|CHECK
argument_list|(
name|ixfr_apply
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Apply a set of IXFR changes to the database.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|ixfr_apply
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
if|if
condition|(
name|xfr
operator|->
name|ver
operator|==
name|NULL
condition|)
block|{
name|CHECK
argument_list|(
name|dns_db_newversion
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|xfr
operator|->
name|ver
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|ixfr
operator|.
name|journal
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|dns_journal_begin_transaction
argument_list|(
name|xfr
operator|->
name|ixfr
operator|.
name|journal
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|dns_diff_apply
argument_list|(
operator|&
name|xfr
operator|->
name|diff
argument_list|,
name|xfr
operator|->
name|db
argument_list|,
name|xfr
operator|->
name|ver
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|ixfr
operator|.
name|journal
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|dns_journal_writediff
argument_list|(
name|xfr
operator|->
name|ixfr
operator|.
name|journal
argument_list|,
operator|&
name|xfr
operator|->
name|diff
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
goto|goto
name|failure
goto|;
block|}
name|dns_diff_clear
argument_list|(
operator|&
name|xfr
operator|->
name|diff
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|difflen
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|ixfr_commit
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|CHECK
argument_list|(
name|ixfr_apply
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|ver
operator|!=
name|NULL
condition|)
block|{
comment|/* XXX enter ready-to-commit state here */
if|if
condition|(
name|xfr
operator|->
name|ixfr
operator|.
name|journal
operator|!=
name|NULL
condition|)
name|CHECK
argument_list|(
name|dns_journal_commit
argument_list|(
name|xfr
operator|->
name|ixfr
operator|.
name|journal
argument_list|)
argument_list|)
expr_stmt|;
name|dns_db_closeversion
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|xfr
operator|->
name|ver
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|dns_zone_markdirty
argument_list|(
name|xfr
operator|->
name|zone
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/*  * Common AXFR/IXFR protocol code  */
end_comment

begin_comment
comment|/*  * Handle a single incoming resource record according to the current  * state.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|xfr_rr
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|dns_name_t
modifier|*
name|name
parameter_list|,
name|isc_uint32_t
name|ttl
parameter_list|,
name|dns_rdata_t
modifier|*
name|rdata
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|redo
label|:
switch|switch
condition|(
name|xfr
operator|->
name|state
condition|)
block|{
case|case
name|XFRST_SOAQUERY
case|:
if|if
condition|(
name|rdata
operator|->
name|type
operator|!=
name|dns_rdatatype_soa
condition|)
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"non-SOA response to SOA query"
argument_list|)
expr_stmt|;
name|FAIL
argument_list|(
name|DNS_R_FORMERR
argument_list|)
expr_stmt|;
block|}
name|xfr
operator|->
name|end_serial
operator|=
name|dns_soa_getserial
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DNS_SERIAL_GT
argument_list|(
name|xfr
operator|->
name|end_serial
argument_list|,
name|xfr
operator|->
name|ixfr
operator|.
name|request_serial
argument_list|)
operator|&&
operator|!
name|dns_zone_isforced
argument_list|(
name|xfr
operator|->
name|zone
argument_list|)
condition|)
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"requested serial %u, "
literal|"master has %u, not updating"
argument_list|,
name|xfr
operator|->
name|ixfr
operator|.
name|request_serial
argument_list|,
name|xfr
operator|->
name|end_serial
argument_list|)
expr_stmt|;
name|FAIL
argument_list|(
name|DNS_R_UPTODATE
argument_list|)
expr_stmt|;
block|}
name|xfr
operator|->
name|state
operator|=
name|XFRST_GOTSOA
expr_stmt|;
break|break;
case|case
name|XFRST_GOTSOA
case|:
comment|/* 		 * Skip other records in the answer section. 		 */
break|break;
case|case
name|XFRST_INITIALSOA
case|:
if|if
condition|(
name|rdata
operator|->
name|type
operator|!=
name|dns_rdatatype_soa
condition|)
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"first RR in zone transfer must be SOA"
argument_list|)
expr_stmt|;
name|FAIL
argument_list|(
name|DNS_R_FORMERR
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Remember the serial number in the intial SOA. 		 * We need it to recognize the end of an IXFR. 		 */
name|xfr
operator|->
name|end_serial
operator|=
name|dns_soa_getserial
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|reqtype
operator|==
name|dns_rdatatype_ixfr
operator|&&
operator|!
name|DNS_SERIAL_GT
argument_list|(
name|xfr
operator|->
name|end_serial
argument_list|,
name|xfr
operator|->
name|ixfr
operator|.
name|request_serial
argument_list|)
operator|&&
operator|!
name|dns_zone_isforced
argument_list|(
name|xfr
operator|->
name|zone
argument_list|)
condition|)
block|{
comment|/* 			 * This must be the single SOA record that is 			 * sent when the current version on the master 			 * is not newer than the version in the request. 			 */
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"requested serial %u, "
literal|"master has %u, not updating"
argument_list|,
name|xfr
operator|->
name|ixfr
operator|.
name|request_serial
argument_list|,
name|xfr
operator|->
name|end_serial
argument_list|)
expr_stmt|;
name|FAIL
argument_list|(
name|DNS_R_UPTODATE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|xfr
operator|->
name|reqtype
operator|==
name|dns_rdatatype_axfr
condition|)
name|xfr
operator|->
name|checkid
operator|=
name|ISC_FALSE
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_FIRSTDATA
expr_stmt|;
break|break;
case|case
name|XFRST_FIRSTDATA
case|:
comment|/* 		 * If the transfer begins with one SOA record, it is an AXFR, 		 * if it begins with two SOAs, it is an IXFR. 		 */
if|if
condition|(
name|xfr
operator|->
name|reqtype
operator|==
name|dns_rdatatype_ixfr
operator|&&
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_soa
operator|&&
name|xfr
operator|->
name|ixfr
operator|.
name|request_serial
operator|==
name|dns_soa_getserial
argument_list|(
name|rdata
argument_list|)
condition|)
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"got incremental response"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ixfr_init
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_IXFR_DELSOA
expr_stmt|;
block|}
else|else
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"got nonincremental response"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|axfr_init
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_AXFR
expr_stmt|;
block|}
goto|goto
name|redo
goto|;
case|case
name|XFRST_IXFR_DELSOA
case|:
name|INSIST
argument_list|(
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_soa
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ixfr_putdata
argument_list|(
name|xfr
argument_list|,
name|DNS_DIFFOP_DEL
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_IXFR_DEL
expr_stmt|;
break|break;
case|case
name|XFRST_IXFR_DEL
case|:
if|if
condition|(
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_soa
condition|)
block|{
name|isc_uint32_t
name|soa_serial
init|=
name|dns_soa_getserial
argument_list|(
name|rdata
argument_list|)
decl_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_IXFR_ADDSOA
expr_stmt|;
name|xfr
operator|->
name|ixfr
operator|.
name|current_serial
operator|=
name|soa_serial
expr_stmt|;
goto|goto
name|redo
goto|;
block|}
name|CHECK
argument_list|(
name|ixfr_putdata
argument_list|(
name|xfr
argument_list|,
name|DNS_DIFFOP_DEL
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|XFRST_IXFR_ADDSOA
case|:
name|INSIST
argument_list|(
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_soa
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ixfr_putdata
argument_list|(
name|xfr
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_IXFR_ADD
expr_stmt|;
break|break;
case|case
name|XFRST_IXFR_ADD
case|:
if|if
condition|(
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_soa
condition|)
block|{
name|isc_uint32_t
name|soa_serial
init|=
name|dns_soa_getserial
argument_list|(
name|rdata
argument_list|)
decl_stmt|;
if|if
condition|(
name|soa_serial
operator|==
name|xfr
operator|->
name|end_serial
condition|)
block|{
name|CHECK
argument_list|(
name|ixfr_commit
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_END
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|soa_serial
operator|!=
name|xfr
operator|->
name|ixfr
operator|.
name|current_serial
condition|)
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"IXFR out of sync: "
literal|"expected serial %u, got %u"
argument_list|,
name|xfr
operator|->
name|ixfr
operator|.
name|current_serial
argument_list|,
name|soa_serial
argument_list|)
expr_stmt|;
name|FAIL
argument_list|(
name|DNS_R_FORMERR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CHECK
argument_list|(
name|ixfr_commit
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_IXFR_DELSOA
expr_stmt|;
goto|goto
name|redo
goto|;
block|}
block|}
if|if
condition|(
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_ns
operator|&&
name|dns_name_iswildcard
argument_list|(
name|name
argument_list|)
condition|)
name|FAIL
argument_list|(
name|DNS_R_INVALIDNS
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ixfr_putdata
argument_list|(
name|xfr
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|XFRST_AXFR
case|:
comment|/* 		 * Old BINDs sent cross class A records for non IN classes. 		 */
if|if
condition|(
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_a
operator|&&
name|rdata
operator|->
name|rdclass
operator|!=
name|xfr
operator|->
name|rdclass
operator|&&
name|xfr
operator|->
name|rdclass
operator|!=
name|dns_rdataclass_in
condition|)
break|break;
name|CHECK
argument_list|(
name|axfr_putdata
argument_list|(
name|xfr
argument_list|,
name|DNS_DIFFOP_ADD
argument_list|,
name|name
argument_list|,
name|ttl
argument_list|,
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdata
operator|->
name|type
operator|==
name|dns_rdatatype_soa
condition|)
block|{
name|CHECK
argument_list|(
name|axfr_commit
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_END
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|XFRST_END
case|:
name|FAIL
argument_list|(
name|DNS_R_EXTRADATA
argument_list|)
expr_stmt|;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_xfrin_create
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_rdatatype_t
name|xfrtype
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|masteraddr
parameter_list|,
name|dns_tsigkey_t
modifier|*
name|tsigkey
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|dns_xfrindone_t
name|done
parameter_list|,
name|dns_xfrin_ctx_t
modifier|*
modifier|*
name|xfrp
parameter_list|)
block|{
name|isc_sockaddr_t
name|sourceaddr
decl_stmt|;
switch|switch
condition|(
name|isc_sockaddr_pf
argument_list|(
name|masteraddr
argument_list|)
condition|)
block|{
case|case
name|PF_INET
case|:
name|sourceaddr
operator|=
operator|*
name|dns_zone_getxfrsource4
argument_list|(
name|zone
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_INET6
case|:
name|sourceaddr
operator|=
operator|*
name|dns_zone_getxfrsource6
argument_list|(
name|zone
argument_list|)
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|dns_xfrin_create2
argument_list|(
name|zone
argument_list|,
name|xfrtype
argument_list|,
name|masteraddr
argument_list|,
operator|&
name|sourceaddr
argument_list|,
name|tsigkey
argument_list|,
name|mctx
argument_list|,
name|timermgr
argument_list|,
name|socketmgr
argument_list|,
name|task
argument_list|,
name|done
argument_list|,
name|xfrp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|dns_xfrin_create2
parameter_list|(
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_rdatatype_t
name|xfrtype
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|masteraddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|sourceaddr
parameter_list|,
name|dns_tsigkey_t
modifier|*
name|tsigkey
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|dns_xfrindone_t
name|done
parameter_list|,
name|dns_xfrin_ctx_t
modifier|*
modifier|*
name|xfrp
parameter_list|)
block|{
name|dns_name_t
modifier|*
name|zonename
init|=
name|dns_zone_getorigin
argument_list|(
name|zone
argument_list|)
decl_stmt|;
name|dns_xfrin_ctx_t
modifier|*
name|xfr
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_db_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|xfrp
operator|!=
name|NULL
operator|&&
operator|*
name|xfrp
operator|==
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dns_zone_getdb
argument_list|(
name|zone
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfrtype
operator|==
name|dns_rdatatype_soa
operator|||
name|xfrtype
operator|==
name|dns_rdatatype_ixfr
condition|)
name|REQUIRE
argument_list|(
name|db
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|xfrin_create
argument_list|(
name|mctx
argument_list|,
name|zone
argument_list|,
name|db
argument_list|,
name|task
argument_list|,
name|timermgr
argument_list|,
name|socketmgr
argument_list|,
name|zonename
argument_list|,
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
argument_list|,
name|xfrtype
argument_list|,
name|masteraddr
argument_list|,
name|sourceaddr
argument_list|,
name|tsigkey
argument_list|,
operator|&
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|xfrin_start
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|done
operator|=
name|done
expr_stmt|;
name|xfr
operator|->
name|refcount
operator|++
expr_stmt|;
operator|*
name|xfrp
operator|=
name|xfr
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|xfrin_log1
argument_list|(
name|ISC_LOG_ERROR
argument_list|,
name|zonename
argument_list|,
name|dns_zone_getclass
argument_list|(
name|zone
argument_list|)
argument_list|,
name|masteraddr
argument_list|,
literal|"zone transfer setup failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dns_xfrin_shutdown
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
if|if
condition|(
operator|!
name|xfr
operator|->
name|shuttingdown
condition|)
name|xfrin_fail
argument_list|(
name|xfr
argument_list|,
name|ISC_R_CANCELED
argument_list|,
literal|"shut down"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_xfrin_attach
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|source
parameter_list|,
name|dns_xfrin_ctx_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
operator|&&
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|source
operator|->
name|refcount
operator|++
expr_stmt|;
operator|*
name|target
operator|=
name|source
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dns_xfrin_detach
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
modifier|*
name|xfrp
parameter_list|)
block|{
name|dns_xfrin_ctx_t
modifier|*
name|xfr
init|=
operator|*
name|xfrp
decl_stmt|;
name|INSIST
argument_list|(
name|xfr
operator|->
name|refcount
operator|>
literal|0
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|refcount
operator|--
expr_stmt|;
name|maybe_free
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
operator|*
name|xfrp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|xfrin_cancelio
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
if|if
condition|(
name|xfr
operator|->
name|connects
operator|>
literal|0
condition|)
block|{
name|isc_socket_cancel
argument_list|(
name|xfr
operator|->
name|socket
argument_list|,
name|xfr
operator|->
name|task
argument_list|,
name|ISC_SOCKCANCEL_CONNECT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xfr
operator|->
name|recvs
operator|>
literal|0
condition|)
block|{
name|dns_tcpmsg_cancelread
argument_list|(
operator|&
name|xfr
operator|->
name|tcpmsg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xfr
operator|->
name|sends
operator|>
literal|0
condition|)
block|{
name|isc_socket_cancel
argument_list|(
name|xfr
operator|->
name|socket
argument_list|,
name|xfr
operator|->
name|task
argument_list|,
name|ISC_SOCKCANCEL_SEND
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|xfrin_reset
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_XFRIN
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"resetting"
argument_list|)
expr_stmt|;
name|xfrin_cancelio
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|socket
operator|!=
name|NULL
condition|)
name|isc_socket_detach
argument_list|(
operator|&
name|xfr
operator|->
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|lasttsig
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|xfr
operator|->
name|lasttsig
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|xfr
operator|->
name|diff
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|difflen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|ixfr
operator|.
name|journal
operator|!=
name|NULL
condition|)
name|dns_journal_destroy
argument_list|(
operator|&
name|xfr
operator|->
name|ixfr
operator|.
name|journal
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|axfr
operator|.
name|add_private
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|dns_db_endload
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|xfr
operator|->
name|axfr
operator|.
name|add_private
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|axfr
operator|.
name|add_func
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|xfr
operator|->
name|tcpmsg_valid
condition|)
block|{
name|dns_tcpmsg_invalidate
argument_list|(
operator|&
name|xfr
operator|->
name|tcpmsg
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|tcpmsg_valid
operator|=
name|ISC_FALSE
expr_stmt|;
block|}
if|if
condition|(
name|xfr
operator|->
name|ver
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|xfr
operator|->
name|ver
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|xfrin_fail
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|isc_result_t
name|result
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|result
operator|!=
name|DNS_R_UPTODATE
condition|)
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_ERROR
argument_list|,
literal|"%s: %s"
argument_list|,
name|msg
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|is_ixfr
condition|)
comment|/* Pass special result code to force AXFR retry */
name|result
operator|=
name|DNS_R_BADIXFR
expr_stmt|;
block|}
name|xfrin_cancelio
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|done
operator|!=
name|NULL
condition|)
block|{
call|(
name|xfr
operator|->
name|done
call|)
argument_list|(
name|xfr
operator|->
name|zone
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|done
operator|=
name|NULL
expr_stmt|;
block|}
name|xfr
operator|->
name|shuttingdown
operator|=
name|ISC_TRUE
expr_stmt|;
name|maybe_free
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|xfrin_create
parameter_list|(
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|dns_zone_t
modifier|*
name|zone
parameter_list|,
name|dns_db_t
modifier|*
name|db
parameter_list|,
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_timermgr_t
modifier|*
name|timermgr
parameter_list|,
name|isc_socketmgr_t
modifier|*
name|socketmgr
parameter_list|,
name|dns_name_t
modifier|*
name|zonename
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|dns_rdatatype_t
name|reqtype
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|masteraddr
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|sourceaddr
parameter_list|,
name|dns_tsigkey_t
modifier|*
name|tsigkey
parameter_list|,
name|dns_xfrin_ctx_t
modifier|*
modifier|*
name|xfrp
parameter_list|)
block|{
name|dns_xfrin_ctx_t
modifier|*
name|xfr
init|=
name|NULL
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_uint32_t
name|tmp
decl_stmt|;
name|xfr
operator|=
name|isc_mem_get
argument_list|(
name|mctx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|==
name|NULL
condition|)
return|return
operator|(
name|ISC_R_NOMEMORY
operator|)
return|;
name|xfr
operator|->
name|mctx
operator|=
name|mctx
expr_stmt|;
name|xfr
operator|->
name|refcount
operator|=
literal|0
expr_stmt|;
name|xfr
operator|->
name|zone
operator|=
name|NULL
expr_stmt|;
name|dns_zone_iattach
argument_list|(
name|zone
argument_list|,
operator|&
name|xfr
operator|->
name|zone
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|task
operator|=
name|NULL
expr_stmt|;
name|isc_task_attach
argument_list|(
name|task
argument_list|,
operator|&
name|xfr
operator|->
name|task
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|timer
operator|=
name|NULL
expr_stmt|;
name|xfr
operator|->
name|socketmgr
operator|=
name|socketmgr
expr_stmt|;
name|xfr
operator|->
name|done
operator|=
name|NULL
expr_stmt|;
name|xfr
operator|->
name|connects
operator|=
literal|0
expr_stmt|;
name|xfr
operator|->
name|sends
operator|=
literal|0
expr_stmt|;
name|xfr
operator|->
name|recvs
operator|=
literal|0
expr_stmt|;
name|xfr
operator|->
name|shuttingdown
operator|=
name|ISC_FALSE
expr_stmt|;
name|dns_name_init
argument_list|(
operator|&
name|xfr
operator|->
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|rdclass
operator|=
name|rdclass
expr_stmt|;
name|isc_random_get
argument_list|(
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|checkid
operator|=
name|ISC_TRUE
expr_stmt|;
name|xfr
operator|->
name|id
operator|=
call|(
name|isc_uint16_t
call|)
argument_list|(
name|tmp
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|reqtype
operator|=
name|reqtype
expr_stmt|;
comment|/* sockaddr */
name|xfr
operator|->
name|socket
operator|=
name|NULL
expr_stmt|;
comment|/* qbuffer */
comment|/* qbuffer_data */
comment|/* tcpmsg */
name|xfr
operator|->
name|tcpmsg_valid
operator|=
name|ISC_FALSE
expr_stmt|;
name|xfr
operator|->
name|db
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|dns_db_attach
argument_list|(
name|db
argument_list|,
operator|&
name|xfr
operator|->
name|db
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|ver
operator|=
name|NULL
expr_stmt|;
name|dns_diff_init
argument_list|(
name|xfr
operator|->
name|mctx
argument_list|,
operator|&
name|xfr
operator|->
name|diff
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|difflen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|reqtype
operator|==
name|dns_rdatatype_soa
condition|)
name|xfr
operator|->
name|state
operator|=
name|XFRST_SOAQUERY
expr_stmt|;
else|else
name|xfr
operator|->
name|state
operator|=
name|XFRST_INITIALSOA
expr_stmt|;
comment|/* end_serial */
name|xfr
operator|->
name|nmsg
operator|=
literal|0
expr_stmt|;
name|xfr
operator|->
name|tsigkey
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_attach
argument_list|(
name|tsigkey
argument_list|,
operator|&
name|xfr
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|lasttsig
operator|=
name|NULL
expr_stmt|;
name|xfr
operator|->
name|tsigctx
operator|=
name|NULL
expr_stmt|;
name|xfr
operator|->
name|sincetsig
operator|=
literal|0
expr_stmt|;
name|xfr
operator|->
name|is_ixfr
operator|=
name|ISC_FALSE
expr_stmt|;
comment|/* ixfr.request_serial */
comment|/* ixfr.current_serial */
name|xfr
operator|->
name|ixfr
operator|.
name|journal
operator|=
name|NULL
expr_stmt|;
name|xfr
operator|->
name|axfr
operator|.
name|add_func
operator|=
name|NULL
expr_stmt|;
name|xfr
operator|->
name|axfr
operator|.
name|add_private
operator|=
name|NULL
expr_stmt|;
name|CHECK
argument_list|(
name|dns_name_dup
argument_list|(
name|zonename
argument_list|,
name|mctx
argument_list|,
operator|&
name|xfr
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|isc_timer_create
argument_list|(
name|timermgr
argument_list|,
name|isc_timertype_inactive
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|task
argument_list|,
name|xfrin_timeout
argument_list|,
name|xfr
argument_list|,
operator|&
name|xfr
operator|->
name|timer
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_timer_setidle
argument_list|(
name|xfr
operator|->
name|timer
argument_list|,
name|dns_zone_getmaxxfrin
argument_list|(
name|xfr
operator|->
name|zone
argument_list|)
argument_list|,
name|dns_zone_getidlein
argument_list|(
name|xfr
operator|->
name|zone
argument_list|)
argument_list|,
name|ISC_FALSE
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|masteraddr
operator|=
operator|*
name|masteraddr
expr_stmt|;
name|INSIST
argument_list|(
name|isc_sockaddr_pf
argument_list|(
name|masteraddr
argument_list|)
operator|==
name|isc_sockaddr_pf
argument_list|(
name|sourceaddr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|sourceaddr
operator|=
operator|*
name|sourceaddr
expr_stmt|;
name|isc_sockaddr_setport
argument_list|(
operator|&
name|xfr
operator|->
name|sourceaddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|xfr
operator|->
name|qbuffer
argument_list|,
name|xfr
operator|->
name|qbuffer_data
argument_list|,
sizeof|sizeof
argument_list|(
name|xfr
operator|->
name|qbuffer_data
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|magic
operator|=
name|XFRIN_MAGIC
expr_stmt|;
operator|*
name|xfrp
operator|=
name|xfr
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|failure
label|:
if|if
condition|(
name|xfr
operator|->
name|timer
operator|!=
name|NULL
condition|)
name|isc_timer_detach
argument_list|(
operator|&
name|xfr
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_name_dynamic
argument_list|(
operator|&
name|xfr
operator|->
name|name
argument_list|)
condition|)
name|dns_name_free
argument_list|(
operator|&
name|xfr
operator|->
name|name
argument_list|,
name|xfr
operator|->
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|xfr
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|xfr
operator|->
name|db
argument_list|)
expr_stmt|;
name|isc_task_detach
argument_list|(
operator|&
name|xfr
operator|->
name|task
argument_list|)
expr_stmt|;
name|dns_zone_idetach
argument_list|(
operator|&
name|xfr
operator|->
name|zone
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|mctx
argument_list|,
name|xfr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|isc_result_t
name|xfrin_start
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|CHECK
argument_list|(
name|isc_socket_create
argument_list|(
name|xfr
operator|->
name|socketmgr
argument_list|,
name|isc_sockaddr_pf
argument_list|(
operator|&
name|xfr
operator|->
name|sourceaddr
argument_list|)
argument_list|,
name|isc_sockettype_tcp
argument_list|,
operator|&
name|xfr
operator|->
name|socket
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|BROKEN_TCP_BIND_BEFORE_CONNECT
name|CHECK
argument_list|(
name|isc_socket_bind
argument_list|(
name|xfr
operator|->
name|socket
argument_list|,
operator|&
name|xfr
operator|->
name|sourceaddr
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|CHECK
argument_list|(
name|isc_socket_connect
argument_list|(
name|xfr
operator|->
name|socket
argument_list|,
operator|&
name|xfr
operator|->
name|masteraddr
argument_list|,
name|xfr
operator|->
name|task
argument_list|,
name|xfrin_connect_done
argument_list|,
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|connects
operator|++
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|failure
label|:
name|xfrin_fail
argument_list|(
name|xfr
argument_list|,
name|result
argument_list|,
literal|"failed setting up socket"
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX the resolver could use this, too */
end_comment

begin_function
specifier|static
name|isc_result_t
name|render
parameter_list|(
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|isc_mem_t
modifier|*
name|mctx
parameter_list|,
name|isc_buffer_t
modifier|*
name|buf
parameter_list|)
block|{
name|dns_compress_t
name|cctx
decl_stmt|;
name|isc_boolean_t
name|cleanup_cctx
init|=
name|ISC_FALSE
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|CHECK
argument_list|(
name|dns_compress_init
argument_list|(
operator|&
name|cctx
argument_list|,
operator|-
literal|1
argument_list|,
name|mctx
argument_list|)
argument_list|)
expr_stmt|;
name|cleanup_cctx
operator|=
name|ISC_TRUE
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_renderbegin
argument_list|(
name|msg
argument_list|,
operator|&
name|cctx
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_rendersection
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_rendersection
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_rendersection
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_rendersection
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ADDITIONAL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_renderend
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ISC_R_SUCCESS
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|cleanup_cctx
condition|)
name|dns_compress_invalidate
argument_list|(
operator|&
name|cctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * A connection has been established.  */
end_comment

begin_function
specifier|static
name|void
name|xfrin_connect_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_socket_connev_t
modifier|*
name|cev
init|=
operator|(
name|isc_socket_connev_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_xfrin_ctx_t
modifier|*
name|xfr
init|=
operator|(
name|dns_xfrin_ctx_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_result_t
name|evresult
init|=
name|cev
operator|->
name|result
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|char
name|sourcetext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|isc_sockaddr_t
name|sockaddr
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_XFRIN
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|ISC_SOCKEVENT_CONNECT
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|connects
operator|--
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|shuttingdown
condition|)
block|{
name|maybe_free
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
return|return;
block|}
name|CHECK
argument_list|(
name|evresult
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_socket_getsockname
argument_list|(
name|xfr
operator|->
name|socket
argument_list|,
operator|&
name|sockaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
block|{
name|isc_sockaddr_format
argument_list|(
operator|&
name|sockaddr
argument_list|,
name|sourcetext
argument_list|,
sizeof|sizeof
argument_list|(
name|sourcetext
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|sourcetext
argument_list|,
literal|"<UNKNOWN>"
argument_list|)
expr_stmt|;
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"connected using %s"
argument_list|,
name|sourcetext
argument_list|)
expr_stmt|;
name|dns_tcpmsg_init
argument_list|(
name|xfr
operator|->
name|mctx
argument_list|,
name|xfr
operator|->
name|socket
argument_list|,
operator|&
name|xfr
operator|->
name|tcpmsg
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|tcpmsg_valid
operator|=
name|ISC_TRUE
expr_stmt|;
name|CHECK
argument_list|(
name|xfrin_send_request
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|xfrin_fail
argument_list|(
name|xfr
argument_list|,
name|result
argument_list|,
literal|"failed to connect"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Convert a tuple into a dns_name_t suitable for inserting  * into the given dns_message_t.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|tuple2msgname
parameter_list|(
name|dns_difftuple_t
modifier|*
name|tuple
parameter_list|,
name|dns_message_t
modifier|*
name|msg
parameter_list|,
name|dns_name_t
modifier|*
modifier|*
name|target
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|dns_rdata_t
modifier|*
name|rdata
init|=
name|NULL
decl_stmt|;
name|dns_rdatalist_t
modifier|*
name|rdl
init|=
name|NULL
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|rds
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|target
operator|!=
name|NULL
operator|&&
operator|*
name|target
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_gettemprdata
argument_list|(
name|msg
argument_list|,
operator|&
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdata_init
argument_list|(
name|rdata
argument_list|)
expr_stmt|;
name|dns_rdata_clone
argument_list|(
operator|&
name|tuple
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_gettemprdatalist
argument_list|(
name|msg
argument_list|,
operator|&
name|rdl
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdatalist_init
argument_list|(
name|rdl
argument_list|)
expr_stmt|;
name|rdl
operator|->
name|type
operator|=
name|tuple
operator|->
name|rdata
operator|.
name|type
expr_stmt|;
name|rdl
operator|->
name|rdclass
operator|=
name|tuple
operator|->
name|rdata
operator|.
name|rdclass
expr_stmt|;
name|rdl
operator|->
name|ttl
operator|=
name|tuple
operator|->
name|ttl
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|rdl
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_gettemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|rds
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|rds
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_rdatalist_tordataset
argument_list|(
name|rdl
argument_list|,
name|rds
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_gettempname
argument_list|(
name|msg
argument_list|,
operator|&
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|tuple
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|name
operator|->
name|list
argument_list|,
name|rds
argument_list|,
name|link
argument_list|)
expr_stmt|;
operator|*
name|target
operator|=
name|name
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
name|failure
label|:
if|if
condition|(
name|rds
operator|!=
name|NULL
condition|)
block|{
name|dns_rdataset_disassociate
argument_list|(
name|rds
argument_list|)
expr_stmt|;
name|dns_message_puttemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|rds
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdl
operator|!=
name|NULL
condition|)
block|{
name|ISC_LIST_UNLINK
argument_list|(
name|rdl
operator|->
name|rdata
argument_list|,
name|rdata
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|dns_message_puttemprdatalist
argument_list|(
name|msg
argument_list|,
operator|&
name|rdl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdata
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdata
argument_list|(
name|msg
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Build an *XFR request and send its length prefix.  */
end_comment

begin_function
specifier|static
name|isc_result_t
name|xfrin_send_request
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_region_t
name|region
decl_stmt|;
name|isc_region_t
name|lregion
decl_stmt|;
name|dns_rdataset_t
modifier|*
name|qrdataset
init|=
name|NULL
decl_stmt|;
name|dns_message_t
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
name|length
index|[
literal|2
index|]
decl_stmt|;
name|dns_difftuple_t
modifier|*
name|soatuple
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|qname
init|=
name|NULL
decl_stmt|;
name|dns_dbversion_t
modifier|*
name|ver
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|msgsoaname
init|=
name|NULL
decl_stmt|;
comment|/* Create the request message */
name|CHECK
argument_list|(
name|dns_message_create
argument_list|(
name|xfr
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTRENDER
argument_list|,
operator|&
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_settsigkey
argument_list|(
name|msg
argument_list|,
name|xfr
operator|->
name|tsigkey
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create a name for the question section. */
name|CHECK
argument_list|(
name|dns_message_gettempname
argument_list|(
name|msg
argument_list|,
operator|&
name|qname
argument_list|)
argument_list|)
expr_stmt|;
name|dns_name_init
argument_list|(
name|qname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dns_name_clone
argument_list|(
operator|&
name|xfr
operator|->
name|name
argument_list|,
name|qname
argument_list|)
expr_stmt|;
comment|/* Formulate the question and attach it to the question name. */
name|CHECK
argument_list|(
name|dns_message_gettemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|qrdataset
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataset_init
argument_list|(
name|qrdataset
argument_list|)
expr_stmt|;
name|dns_rdataset_makequestion
argument_list|(
name|qrdataset
argument_list|,
name|xfr
operator|->
name|rdclass
argument_list|,
name|xfr
operator|->
name|reqtype
argument_list|)
expr_stmt|;
name|ISC_LIST_APPEND
argument_list|(
name|qname
operator|->
name|list
argument_list|,
name|qrdataset
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|qrdataset
operator|=
name|NULL
expr_stmt|;
name|dns_message_addname
argument_list|(
name|msg
argument_list|,
name|qname
argument_list|,
name|DNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
name|qname
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|reqtype
operator|==
name|dns_rdatatype_ixfr
condition|)
block|{
comment|/* Get the SOA and add it to the authority section. */
comment|/* XXX is using the current version the right thing? */
name|dns_db_currentversion
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|ver
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_db_createsoatuple
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
name|ver
argument_list|,
name|xfr
operator|->
name|mctx
argument_list|,
name|DNS_DIFFOP_EXISTS
argument_list|,
operator|&
name|soatuple
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|ixfr
operator|.
name|request_serial
operator|=
name|dns_soa_getserial
argument_list|(
operator|&
name|soatuple
operator|->
name|rdata
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|ixfr
operator|.
name|current_serial
operator|=
name|xfr
operator|->
name|ixfr
operator|.
name|request_serial
expr_stmt|;
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"requesting IXFR for serial %u"
argument_list|,
name|xfr
operator|->
name|ixfr
operator|.
name|request_serial
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|tuple2msgname
argument_list|(
name|soatuple
argument_list|,
name|msg
argument_list|,
operator|&
name|msgsoaname
argument_list|)
argument_list|)
expr_stmt|;
name|dns_message_addname
argument_list|(
name|msg
argument_list|,
name|msgsoaname
argument_list|,
name|DNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xfr
operator|->
name|reqtype
operator|==
name|dns_rdatatype_soa
condition|)
name|CHECK
argument_list|(
name|dns_db_getsoaserial
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
name|NULL
argument_list|,
operator|&
name|xfr
operator|->
name|ixfr
operator|.
name|request_serial
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|checkid
operator|=
name|ISC_TRUE
expr_stmt|;
name|xfr
operator|->
name|id
operator|++
expr_stmt|;
name|msg
operator|->
name|id
operator|=
name|xfr
operator|->
name|id
expr_stmt|;
name|CHECK
argument_list|(
name|render
argument_list|(
name|msg
argument_list|,
name|xfr
operator|->
name|mctx
argument_list|,
operator|&
name|xfr
operator|->
name|qbuffer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Free the last tsig, if there is one. 	 */
if|if
condition|(
name|xfr
operator|->
name|lasttsig
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|xfr
operator|->
name|lasttsig
argument_list|)
expr_stmt|;
comment|/* 	 * Save the query TSIG and don't let message_destroy free it. 	 */
name|CHECK
argument_list|(
name|dns_message_getquerytsig
argument_list|(
name|msg
argument_list|,
name|xfr
operator|->
name|mctx
argument_list|,
operator|&
name|xfr
operator|->
name|lasttsig
argument_list|)
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|xfr
operator|->
name|qbuffer
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|region
operator|.
name|length
operator|<=
literal|65535
argument_list|)
expr_stmt|;
name|length
index|[
literal|0
index|]
operator|=
name|region
operator|.
name|length
operator|>>
literal|8
expr_stmt|;
name|length
index|[
literal|1
index|]
operator|=
name|region
operator|.
name|length
operator|&
literal|0xFF
expr_stmt|;
name|lregion
operator|.
name|base
operator|=
name|length
expr_stmt|;
name|lregion
operator|.
name|length
operator|=
literal|2
expr_stmt|;
name|CHECK
argument_list|(
name|isc_socket_send
argument_list|(
name|xfr
operator|->
name|socket
argument_list|,
operator|&
name|lregion
argument_list|,
name|xfr
operator|->
name|task
argument_list|,
name|xfrin_sendlen_done
argument_list|,
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|sends
operator|++
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|qname
operator|!=
name|NULL
condition|)
name|dns_message_puttempname
argument_list|(
name|msg
argument_list|,
operator|&
name|qname
argument_list|)
expr_stmt|;
if|if
condition|(
name|qrdataset
operator|!=
name|NULL
condition|)
name|dns_message_puttemprdataset
argument_list|(
name|msg
argument_list|,
operator|&
name|qrdataset
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|soatuple
operator|!=
name|NULL
condition|)
name|dns_difftuple_free
argument_list|(
operator|&
name|soatuple
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|ver
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX there should be library support for sending DNS TCP messages */
end_comment

begin_function
specifier|static
name|void
name|xfrin_sendlen_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_socketevent_t
modifier|*
name|sev
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_xfrin_ctx_t
modifier|*
name|xfr
init|=
operator|(
name|dns_xfrin_ctx_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_result_t
name|evresult
init|=
name|sev
operator|->
name|result
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|isc_region_t
name|region
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_XFRIN
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|ISC_SOCKEVENT_SENDDONE
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|sends
operator|--
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|shuttingdown
condition|)
block|{
name|maybe_free
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
return|return;
block|}
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"sent request length prefix"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|evresult
argument_list|)
expr_stmt|;
name|isc_buffer_usedregion
argument_list|(
operator|&
name|xfr
operator|->
name|qbuffer
argument_list|,
operator|&
name|region
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|isc_socket_send
argument_list|(
name|xfr
operator|->
name|socket
argument_list|,
operator|&
name|region
argument_list|,
name|xfr
operator|->
name|task
argument_list|,
name|xfrin_send_done
argument_list|,
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|sends
operator|++
expr_stmt|;
name|failure
label|:
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|xfrin_fail
argument_list|(
name|xfr
argument_list|,
name|result
argument_list|,
literal|"failed sending request length prefix"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|xfrin_send_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|isc_socketevent_t
modifier|*
name|sev
init|=
operator|(
name|isc_socketevent_t
operator|*
operator|)
name|event
decl_stmt|;
name|dns_xfrin_ctx_t
modifier|*
name|xfr
init|=
operator|(
name|dns_xfrin_ctx_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_XFRIN
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|event
operator|->
name|ev_type
operator|==
name|ISC_SOCKEVENT_SENDDONE
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|sends
operator|--
expr_stmt|;
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"sent request data"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|sev
operator|->
name|result
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_tcpmsg_readmessage
argument_list|(
operator|&
name|xfr
operator|->
name|tcpmsg
argument_list|,
name|xfr
operator|->
name|task
argument_list|,
name|xfrin_recv_done
argument_list|,
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|recvs
operator|++
expr_stmt|;
name|failure
label|:
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|xfrin_fail
argument_list|(
name|xfr
argument_list|,
name|result
argument_list|,
literal|"failed sending request data"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|xfrin_recv_done
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|dns_xfrin_ctx_t
modifier|*
name|xfr
init|=
operator|(
name|dns_xfrin_ctx_t
operator|*
operator|)
name|ev
operator|->
name|ev_arg
decl_stmt|;
name|isc_result_t
name|result
decl_stmt|;
name|dns_message_t
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|dns_name_t
modifier|*
name|name
decl_stmt|;
name|dns_tcpmsg_t
modifier|*
name|tcpmsg
decl_stmt|;
name|dns_name_t
modifier|*
name|tsigowner
init|=
name|NULL
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_XFRIN
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ev
operator|->
name|ev_type
operator|==
name|DNS_EVENT_TCPMSG
argument_list|)
expr_stmt|;
name|tcpmsg
operator|=
name|ev
operator|->
name|ev_sender
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|ev
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|recvs
operator|--
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|shuttingdown
condition|)
block|{
name|maybe_free
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
return|return;
block|}
name|CHECK
argument_list|(
name|tcpmsg
operator|->
name|result
argument_list|)
expr_stmt|;
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|7
argument_list|)
argument_list|,
literal|"received %u bytes"
argument_list|,
name|tcpmsg
operator|->
name|buffer
operator|.
name|used
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|isc_timer_touch
argument_list|(
name|xfr
operator|->
name|timer
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_create
argument_list|(
name|xfr
operator|->
name|mctx
argument_list|,
name|DNS_MESSAGE_INTENTPARSE
argument_list|,
operator|&
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_settsigkey
argument_list|(
name|msg
argument_list|,
name|xfr
operator|->
name|tsigkey
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|dns_message_setquerytsig
argument_list|(
name|msg
argument_list|,
name|xfr
operator|->
name|lasttsig
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tsigctx
operator|=
name|xfr
operator|->
name|tsigctx
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|nmsg
operator|>
literal|0
condition|)
name|msg
operator|->
name|tcp_continuation
operator|=
literal|1
expr_stmt|;
name|result
operator|=
name|dns_message_parse
argument_list|(
name|msg
argument_list|,
operator|&
name|tcpmsg
operator|->
name|buffer
argument_list|,
name|DNS_MESSAGEPARSE_PRESERVEORDER
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
operator|||
name|msg
operator|->
name|rcode
operator|!=
name|dns_rcode_noerror
operator|||
operator|(
name|xfr
operator|->
name|checkid
operator|&&
name|msg
operator|->
name|id
operator|!=
name|xfr
operator|->
name|id
operator|)
condition|)
block|{
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
condition|)
name|result
operator|=
name|ISC_RESULTCLASS_DNSRCODE
operator|+
name|msg
operator|->
name|rcode
expr_stmt|;
comment|/*XXX*/
if|if
condition|(
name|result
operator|==
name|ISC_R_SUCCESS
operator|||
name|result
operator|==
name|DNS_R_NOERROR
condition|)
name|result
operator|=
name|DNS_R_UNEXPECTEDID
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|reqtype
operator|==
name|dns_rdatatype_axfr
operator|||
name|xfr
operator|->
name|reqtype
operator|==
name|dns_rdatatype_soa
condition|)
name|FAIL
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"got %s, retrying with AXFR"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|try_axfr
label|:
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|xfrin_reset
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|reqtype
operator|=
name|dns_rdatatype_soa
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_SOAQUERY
expr_stmt|;
operator|(
name|void
operator|)
name|xfrin_start
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Does the server know about IXFR?  If it doesn't we will get 	 * a message with a empty answer section or a potentially a CNAME / 	 * DNAME, the later is handled by xfr_rr() which will return FORMERR 	 * if the first RR in the answer section is not a SOA record. 	 */
if|if
condition|(
name|xfr
operator|->
name|reqtype
operator|==
name|dns_rdatatype_ixfr
operator|&&
name|xfr
operator|->
name|state
operator|==
name|XFRST_INITIALSOA
operator|&&
name|msg
operator|->
name|counts
index|[
name|DNS_SECTION_ANSWER
index|]
operator|==
literal|0
condition|)
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"empty answer section, retrying with AXFR"
argument_list|)
expr_stmt|;
goto|goto
name|try_axfr
goto|;
block|}
if|if
condition|(
name|xfr
operator|->
name|reqtype
operator|==
name|dns_rdatatype_soa
operator|&&
operator|(
name|msg
operator|->
name|flags
operator|&
name|DNS_MESSAGEFLAG_AA
operator|)
operator|==
literal|0
condition|)
block|{
name|FAIL
argument_list|(
name|DNS_R_NOTAUTHORITATIVE
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|dns_message_checksig
argument_list|(
name|msg
argument_list|,
name|dns_zone_getview
argument_list|(
name|xfr
operator|->
name|zone
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_DEBUG
argument_list|(
literal|3
argument_list|)
argument_list|,
literal|"TSIG check failed: %s"
argument_list|,
name|isc_result_totext
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|FAIL
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|result
operator|=
name|dns_message_firstname
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_message_nextname
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|)
control|)
block|{
name|dns_rdataset_t
modifier|*
name|rds
decl_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
name|dns_message_currentname
argument_list|(
name|msg
argument_list|,
name|DNS_SECTION_ANSWER
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|rds
operator|=
name|ISC_LIST_HEAD
argument_list|(
name|name
operator|->
name|list
argument_list|)
init|;
name|rds
operator|!=
name|NULL
condition|;
name|rds
operator|=
name|ISC_LIST_NEXT
argument_list|(
name|rds
argument_list|,
name|link
argument_list|)
control|)
block|{
for|for
control|(
name|result
operator|=
name|dns_rdataset_first
argument_list|(
name|rds
argument_list|)
init|;
name|result
operator|==
name|ISC_R_SUCCESS
condition|;
name|result
operator|=
name|dns_rdataset_next
argument_list|(
name|rds
argument_list|)
control|)
block|{
name|dns_rdata_t
name|rdata
init|=
name|DNS_RDATA_INIT
decl_stmt|;
name|dns_rdataset_current
argument_list|(
name|rds
argument_list|,
operator|&
name|rdata
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|xfr_rr
argument_list|(
name|xfr
argument_list|,
name|name
argument_list|,
name|rds
operator|->
name|ttl
argument_list|,
operator|&
name|rdata
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|result
operator|!=
name|ISC_R_NOMORE
condition|)
goto|goto
name|failure
goto|;
if|if
condition|(
name|dns_message_gettsig
argument_list|(
name|msg
argument_list|,
operator|&
name|tsigowner
argument_list|)
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Reset the counter. 		 */
name|xfr
operator|->
name|sincetsig
operator|=
literal|0
expr_stmt|;
comment|/* 		 * Free the last tsig, if there is one. 		 */
if|if
condition|(
name|xfr
operator|->
name|lasttsig
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|xfr
operator|->
name|lasttsig
argument_list|)
expr_stmt|;
comment|/* 		 * Update the last tsig pointer. 		 */
name|CHECK
argument_list|(
name|dns_message_getquerytsig
argument_list|(
name|msg
argument_list|,
name|xfr
operator|->
name|mctx
argument_list|,
operator|&
name|xfr
operator|->
name|lasttsig
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dns_message_gettsigkey
argument_list|(
name|msg
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|xfr
operator|->
name|sincetsig
operator|++
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|sincetsig
operator|>
literal|100
operator|||
name|xfr
operator|->
name|nmsg
operator|==
literal|0
operator|||
name|xfr
operator|->
name|state
operator|==
name|XFRST_END
condition|)
block|{
name|result
operator|=
name|DNS_R_EXPECTEDTSIG
expr_stmt|;
goto|goto
name|failure
goto|;
block|}
block|}
comment|/* 	 * Update the number of messages received. 	 */
name|xfr
operator|->
name|nmsg
operator|++
expr_stmt|;
comment|/* 	 * Copy the context back. 	 */
name|xfr
operator|->
name|tsigctx
operator|=
name|msg
operator|->
name|tsigctx
expr_stmt|;
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|state
operator|==
name|XFRST_GOTSOA
condition|)
block|{
name|xfr
operator|->
name|reqtype
operator|=
name|dns_rdatatype_axfr
expr_stmt|;
name|xfr
operator|->
name|state
operator|=
name|XFRST_INITIALSOA
expr_stmt|;
name|CHECK
argument_list|(
name|xfrin_send_request
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xfr
operator|->
name|state
operator|==
name|XFRST_END
condition|)
block|{
comment|/* 		 * Inform the caller we succeeded. 		 */
if|if
condition|(
name|xfr
operator|->
name|done
operator|!=
name|NULL
condition|)
block|{
call|(
name|xfr
operator|->
name|done
call|)
argument_list|(
name|xfr
operator|->
name|zone
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|done
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* 		 * We should have no outstanding events at this 		 * point, thus maybe_free() should succeed. 		 */
name|xfr
operator|->
name|shuttingdown
operator|=
name|ISC_TRUE
expr_stmt|;
name|maybe_free
argument_list|(
name|xfr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Read the next message. 		 */
name|CHECK
argument_list|(
name|dns_tcpmsg_readmessage
argument_list|(
operator|&
name|xfr
operator|->
name|tcpmsg
argument_list|,
name|xfr
operator|->
name|task
argument_list|,
name|xfrin_recv_done
argument_list|,
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|xfr
operator|->
name|recvs
operator|++
expr_stmt|;
block|}
return|return;
name|failure
label|:
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|dns_message_destroy
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
name|xfrin_fail
argument_list|(
name|xfr
argument_list|,
name|result
argument_list|,
literal|"failed while receiving responses"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|xfrin_timeout
parameter_list|(
name|isc_task_t
modifier|*
name|task
parameter_list|,
name|isc_event_t
modifier|*
name|event
parameter_list|)
block|{
name|dns_xfrin_ctx_t
modifier|*
name|xfr
init|=
operator|(
name|dns_xfrin_ctx_t
operator|*
operator|)
name|event
operator|->
name|ev_arg
decl_stmt|;
name|REQUIRE
argument_list|(
name|VALID_XFRIN
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|task
argument_list|)
expr_stmt|;
name|isc_event_free
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
comment|/* 	 * This will log "giving up: timeout". 	 */
name|xfrin_fail
argument_list|(
name|xfr
argument_list|,
name|ISC_R_TIMEDOUT
argument_list|,
literal|"giving up"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|maybe_free
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|VALID_XFRIN
argument_list|(
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|xfr
operator|->
name|shuttingdown
operator|||
name|xfr
operator|->
name|refcount
operator|!=
literal|0
operator|||
name|xfr
operator|->
name|connects
operator|!=
literal|0
operator|||
name|xfr
operator|->
name|sends
operator|!=
literal|0
operator|||
name|xfr
operator|->
name|recvs
operator|!=
literal|0
condition|)
return|return;
name|xfrin_log
argument_list|(
name|xfr
argument_list|,
name|ISC_LOG_INFO
argument_list|,
literal|"end of transfer"
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|socket
operator|!=
name|NULL
condition|)
name|isc_socket_detach
argument_list|(
operator|&
name|xfr
operator|->
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|timer
operator|!=
name|NULL
condition|)
name|isc_timer_detach
argument_list|(
operator|&
name|xfr
operator|->
name|timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|task
operator|!=
name|NULL
condition|)
name|isc_task_detach
argument_list|(
operator|&
name|xfr
operator|->
name|task
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|tsigkey
operator|!=
name|NULL
condition|)
name|dns_tsigkey_detach
argument_list|(
operator|&
name|xfr
operator|->
name|tsigkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|lasttsig
operator|!=
name|NULL
condition|)
name|isc_buffer_free
argument_list|(
operator|&
name|xfr
operator|->
name|lasttsig
argument_list|)
expr_stmt|;
name|dns_diff_clear
argument_list|(
operator|&
name|xfr
operator|->
name|diff
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|ixfr
operator|.
name|journal
operator|!=
name|NULL
condition|)
name|dns_journal_destroy
argument_list|(
operator|&
name|xfr
operator|->
name|ixfr
operator|.
name|journal
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|axfr
operator|.
name|add_private
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|dns_db_endload
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|xfr
operator|->
name|axfr
operator|.
name|add_private
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|tcpmsg_valid
condition|)
name|dns_tcpmsg_invalidate
argument_list|(
operator|&
name|xfr
operator|->
name|tcpmsg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|xfr
operator|->
name|name
operator|.
name|attributes
operator|&
name|DNS_NAMEATTR_DYNAMIC
operator|)
operator|!=
literal|0
condition|)
name|dns_name_free
argument_list|(
operator|&
name|xfr
operator|->
name|name
argument_list|,
name|xfr
operator|->
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|ver
operator|!=
name|NULL
condition|)
name|dns_db_closeversion
argument_list|(
name|xfr
operator|->
name|db
argument_list|,
operator|&
name|xfr
operator|->
name|ver
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|db
operator|!=
name|NULL
condition|)
name|dns_db_detach
argument_list|(
operator|&
name|xfr
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfr
operator|->
name|zone
operator|!=
name|NULL
condition|)
name|dns_zone_idetach
argument_list|(
operator|&
name|xfr
operator|->
name|zone
argument_list|)
expr_stmt|;
name|isc_mem_put
argument_list|(
name|xfr
operator|->
name|mctx
argument_list|,
name|xfr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|xfr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Log incoming zone transfer messages in a format like  * transfer of<zone> from<address>:<message>  */
end_comment

begin_function
specifier|static
name|void
name|xfrin_logv
parameter_list|(
name|int
name|level
parameter_list|,
name|dns_name_t
modifier|*
name|zonename
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|masteraddr
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|char
name|zntext
index|[
name|DNS_NAME_FORMATSIZE
index|]
decl_stmt|;
name|char
name|mastertext
index|[
name|ISC_SOCKADDR_FORMATSIZE
index|]
decl_stmt|;
name|char
name|classtext
index|[
name|DNS_RDATACLASS_FORMATSIZE
index|]
decl_stmt|;
name|char
name|msgtext
index|[
literal|2048
index|]
decl_stmt|;
name|dns_name_format
argument_list|(
name|zonename
argument_list|,
name|zntext
argument_list|,
sizeof|sizeof
argument_list|(
name|zntext
argument_list|)
argument_list|)
expr_stmt|;
name|dns_rdataclass_format
argument_list|(
name|rdclass
argument_list|,
name|classtext
argument_list|,
sizeof|sizeof
argument_list|(
name|classtext
argument_list|)
argument_list|)
expr_stmt|;
name|isc_sockaddr_format
argument_list|(
name|masteraddr
argument_list|,
name|mastertext
argument_list|,
sizeof|sizeof
argument_list|(
name|mastertext
argument_list|)
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|msgtext
argument_list|,
sizeof|sizeof
argument_list|(
name|msgtext
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|isc_log_write
argument_list|(
name|dns_lctx
argument_list|,
name|DNS_LOGCATEGORY_XFER_IN
argument_list|,
name|DNS_LOGMODULE_XFER_IN
argument_list|,
name|level
argument_list|,
literal|"transfer of '%s/%s' from %s: %s"
argument_list|,
name|zntext
argument_list|,
name|classtext
argument_list|,
name|mastertext
argument_list|,
name|msgtext
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Logging function for use when a xfrin_ctx_t has not yet been created.  */
end_comment

begin_function
specifier|static
name|void
name|xfrin_log1
parameter_list|(
name|int
name|level
parameter_list|,
name|dns_name_t
modifier|*
name|zonename
parameter_list|,
name|dns_rdataclass_t
name|rdclass
parameter_list|,
name|isc_sockaddr_t
modifier|*
name|masteraddr
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
operator|==
name|ISC_FALSE
condition|)
return|return;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|xfrin_logv
argument_list|(
name|level
argument_list|,
name|zonename
argument_list|,
name|rdclass
argument_list|,
name|masteraddr
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Logging function for use when there is a xfrin_ctx_t.  */
end_comment

begin_function
specifier|static
name|void
name|xfrin_log
parameter_list|(
name|dns_xfrin_ctx_t
modifier|*
name|xfr
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
if|if
condition|(
name|isc_log_wouldlog
argument_list|(
name|dns_lctx
argument_list|,
name|level
argument_list|)
operator|==
name|ISC_FALSE
condition|)
return|return;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|xfrin_logv
argument_list|(
name|level
argument_list|,
operator|&
name|xfr
operator|->
name|name
argument_list|,
name|xfr
operator|->
name|rdclass
argument_list|,
operator|&
name|xfr
operator|->
name|masteraddr
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


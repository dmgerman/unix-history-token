begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* compress.c -- compress a memory buffer  * Copyright (C) 1995-2005, 2014, 2016 Jean-loup Gailly, Mark Adler  * For conditions of distribution and use, see copyright notice in zlib.h  */
end_comment

begin_comment
comment|/* @(#) $Id$ */
end_comment

begin_define
define|#
directive|define
name|ZLIB_INTERNAL
end_define

begin_include
include|#
directive|include
file|"zlib.h"
end_include

begin_comment
comment|/* ===========================================================================      Compresses the source buffer into the destination buffer. The level    parameter has the same meaning as in deflateInit.  sourceLen is the byte    length of the source buffer. Upon entry, destLen is the total size of the    destination buffer, which must be at least 0.1% larger than sourceLen plus    12 bytes. Upon exit, destLen is the actual size of the compressed buffer.       compress2 returns Z_OK if success, Z_MEM_ERROR if there was not enough    memory, Z_BUF_ERROR if there was not enough room in the output buffer,    Z_STREAM_ERROR if the level parameter is invalid. */
end_comment

begin_function
name|int
name|ZEXPORT
name|compress2
parameter_list|(
name|dest
parameter_list|,
name|destLen
parameter_list|,
name|source
parameter_list|,
name|sourceLen
parameter_list|,
name|level
parameter_list|)
name|Bytef
modifier|*
name|dest
decl_stmt|;
name|uLongf
modifier|*
name|destLen
decl_stmt|;
specifier|const
name|Bytef
modifier|*
name|source
decl_stmt|;
name|uLong
name|sourceLen
decl_stmt|;
name|int
name|level
decl_stmt|;
block|{
name|z_stream
name|stream
decl_stmt|;
name|int
name|err
decl_stmt|;
specifier|const
name|uInt
name|max
init|=
operator|(
name|uInt
operator|)
operator|-
literal|1
decl_stmt|;
name|uLong
name|left
decl_stmt|;
name|left
operator|=
operator|*
name|destLen
expr_stmt|;
operator|*
name|destLen
operator|=
literal|0
expr_stmt|;
name|stream
operator|.
name|zalloc
operator|=
operator|(
name|alloc_func
operator|)
literal|0
expr_stmt|;
name|stream
operator|.
name|zfree
operator|=
operator|(
name|free_func
operator|)
literal|0
expr_stmt|;
name|stream
operator|.
name|opaque
operator|=
operator|(
name|voidpf
operator|)
literal|0
expr_stmt|;
name|err
operator|=
name|deflateInit
argument_list|(
operator|&
name|stream
argument_list|,
name|level
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|Z_OK
condition|)
return|return
name|err
return|;
name|stream
operator|.
name|next_out
operator|=
name|dest
expr_stmt|;
name|stream
operator|.
name|avail_out
operator|=
literal|0
expr_stmt|;
name|stream
operator|.
name|next_in
operator|=
operator|(
name|z_const
name|Bytef
operator|*
operator|)
name|source
expr_stmt|;
name|stream
operator|.
name|avail_in
operator|=
literal|0
expr_stmt|;
do|do
block|{
if|if
condition|(
name|stream
operator|.
name|avail_out
operator|==
literal|0
condition|)
block|{
name|stream
operator|.
name|avail_out
operator|=
name|left
operator|>
operator|(
name|uLong
operator|)
name|max
condition|?
name|max
else|:
operator|(
name|uInt
operator|)
name|left
expr_stmt|;
name|left
operator|-=
name|stream
operator|.
name|avail_out
expr_stmt|;
block|}
if|if
condition|(
name|stream
operator|.
name|avail_in
operator|==
literal|0
condition|)
block|{
name|stream
operator|.
name|avail_in
operator|=
name|sourceLen
operator|>
operator|(
name|uLong
operator|)
name|max
condition|?
name|max
else|:
operator|(
name|uInt
operator|)
name|sourceLen
expr_stmt|;
name|sourceLen
operator|-=
name|stream
operator|.
name|avail_in
expr_stmt|;
block|}
name|err
operator|=
name|deflate
argument_list|(
operator|&
name|stream
argument_list|,
name|sourceLen
condition|?
name|Z_NO_FLUSH
else|:
name|Z_FINISH
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|err
operator|==
name|Z_OK
condition|)
do|;
operator|*
name|destLen
operator|=
name|stream
operator|.
name|total_out
expr_stmt|;
name|deflateEnd
argument_list|(
operator|&
name|stream
argument_list|)
expr_stmt|;
return|return
name|err
operator|==
name|Z_STREAM_END
condition|?
name|Z_OK
else|:
name|err
return|;
block|}
end_function

begin_comment
comment|/* ===========================================================================  */
end_comment

begin_function
name|int
name|ZEXPORT
name|compress
parameter_list|(
name|dest
parameter_list|,
name|destLen
parameter_list|,
name|source
parameter_list|,
name|sourceLen
parameter_list|)
name|Bytef
modifier|*
name|dest
decl_stmt|;
name|uLongf
modifier|*
name|destLen
decl_stmt|;
specifier|const
name|Bytef
modifier|*
name|source
decl_stmt|;
name|uLong
name|sourceLen
decl_stmt|;
block|{
return|return
name|compress2
argument_list|(
name|dest
argument_list|,
name|destLen
argument_list|,
name|source
argument_list|,
name|sourceLen
argument_list|,
name|Z_DEFAULT_COMPRESSION
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ===========================================================================      If the default memLevel or windowBits for deflateInit() is changed, then    this function needs to be updated.  */
end_comment

begin_function
name|uLong
name|ZEXPORT
name|compressBound
parameter_list|(
name|sourceLen
parameter_list|)
name|uLong
name|sourceLen
decl_stmt|;
block|{
return|return
name|sourceLen
operator|+
operator|(
name|sourceLen
operator|>>
literal|12
operator|)
operator|+
operator|(
name|sourceLen
operator|>>
literal|14
operator|)
operator|+
operator|(
name|sourceLen
operator|>>
literal|25
operator|)
operator|+
literal|13
return|;
block|}
end_function

end_unit


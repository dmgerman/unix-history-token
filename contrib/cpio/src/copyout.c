begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/* copyout.c - create a cpio archive    Copyright (C) 1990, 1991, 1992, 2001, 2003, 2004,    2006 Free Software Foundation, Inc.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2, or (at your option)    any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public    License along with this program; if not, write to the Free    Software Foundation, Inc., 51 Franklin Street, Fifth Floor,    Boston, MA 02110-1301 USA.  */
end_comment

begin_include
include|#
directive|include
file|<system.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"filetypes.h"
end_include

begin_include
include|#
directive|include
file|"cpiohdr.h"
end_include

begin_include
include|#
directive|include
file|"dstring.h"
end_include

begin_include
include|#
directive|include
file|"extern.h"
end_include

begin_include
include|#
directive|include
file|"defer.h"
end_include

begin_include
include|#
directive|include
file|<rmt.h>
end_include

begin_include
include|#
directive|include
file|<paxlib.h>
end_include

begin_function_decl
specifier|static
name|int
name|check_rdev
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* Read FILE_SIZE bytes of FILE_NAME from IN_FILE_DES and    compute and return a checksum for them.  */
end_comment

begin_function
specifier|static
name|unsigned
name|int
name|read_for_checksum
parameter_list|(
name|int
name|in_file_des
parameter_list|,
name|int
name|file_size
parameter_list|,
name|char
modifier|*
name|file_name
parameter_list|)
block|{
name|unsigned
name|int
name|crc
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|bytes_left
decl_stmt|;
name|int
name|bytes_read
decl_stmt|;
name|int
name|i
decl_stmt|;
name|crc
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|bytes_left
operator|=
name|file_size
init|;
name|bytes_left
operator|>
literal|0
condition|;
name|bytes_left
operator|-=
name|bytes_read
control|)
block|{
name|bytes_read
operator|=
name|read
argument_list|(
name|in_file_des
argument_list|,
name|buf
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes_read
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
name|_
argument_list|(
literal|"cannot read checksum for %s"
argument_list|)
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes_read
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|bytes_left
operator|<
name|bytes_read
condition|)
name|bytes_read
operator|=
name|bytes_left
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bytes_read
condition|;
operator|++
name|i
control|)
name|crc
operator|+=
name|buf
index|[
name|i
index|]
operator|&
literal|0xff
expr_stmt|;
block|}
if|if
condition|(
name|lseek
argument_list|(
name|in_file_des
argument_list|,
literal|0L
argument_list|,
name|SEEK_SET
argument_list|)
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
name|_
argument_list|(
literal|"cannot read checksum for %s"
argument_list|)
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
return|return
name|crc
return|;
block|}
end_function

begin_comment
comment|/* Write out NULs to fill out the rest of the current block on    OUT_FILE_DES.  */
end_comment

begin_function
specifier|static
name|void
name|tape_clear_rest_of_block
parameter_list|(
name|int
name|out_file_des
parameter_list|)
block|{
name|write_nuls_to_file
argument_list|(
name|io_block_size
operator|-
name|output_size
argument_list|,
name|out_file_des
argument_list|,
name|tape_buffered_write
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Write NULs on OUT_FILE_DES to move from OFFSET (the current location)    to the end of the header.  */
end_comment

begin_function
specifier|static
name|void
name|tape_pad_output
parameter_list|(
name|int
name|out_file_des
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
name|size_t
name|pad
decl_stmt|;
if|if
condition|(
name|archive_format
operator|==
name|arf_newascii
operator|||
name|archive_format
operator|==
name|arf_crcascii
condition|)
name|pad
operator|=
operator|(
literal|4
operator|-
operator|(
name|offset
operator|%
literal|4
operator|)
operator|)
operator|%
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
name|archive_format
operator|==
name|arf_tar
operator|||
name|archive_format
operator|==
name|arf_ustar
condition|)
name|pad
operator|=
operator|(
literal|512
operator|-
operator|(
name|offset
operator|%
literal|512
operator|)
operator|)
operator|%
literal|512
expr_stmt|;
elseif|else
if|if
condition|(
name|archive_format
operator|!=
name|arf_oldascii
operator|&&
name|archive_format
operator|!=
name|arf_hpoldascii
condition|)
name|pad
operator|=
operator|(
literal|2
operator|-
operator|(
name|offset
operator|%
literal|2
operator|)
operator|)
operator|%
literal|2
expr_stmt|;
else|else
name|pad
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pad
operator|!=
literal|0
condition|)
name|write_nuls_to_file
argument_list|(
name|pad
argument_list|,
name|out_file_des
argument_list|,
name|tape_buffered_write
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* When creating newc and crc archives if a file has multiple (hard)    links, we don't put any of them into the archive until we have seen    all of them (or until we get to the end of the list of files that    are going into the archive and know that we have seen all of the links    to the file that we will see).  We keep these "defered" files on    this list.   */
end_comment

begin_decl_stmt
name|struct
name|deferment
modifier|*
name|deferouts
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Count the number of other (hard) links to this file that have    already been defered.  */
end_comment

begin_function
specifier|static
name|int
name|count_defered_links_to_dev_ino
parameter_list|(
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
parameter_list|)
block|{
name|struct
name|deferment
modifier|*
name|d
decl_stmt|;
name|int
name|ino
decl_stmt|;
name|int
name|maj
decl_stmt|;
name|int
name|min
decl_stmt|;
name|int
name|count
decl_stmt|;
name|ino
operator|=
name|file_hdr
operator|->
name|c_ino
expr_stmt|;
name|maj
operator|=
name|file_hdr
operator|->
name|c_dev_maj
expr_stmt|;
name|min
operator|=
name|file_hdr
operator|->
name|c_dev_min
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|d
operator|=
name|deferouts
init|;
name|d
operator|!=
name|NULL
condition|;
name|d
operator|=
name|d
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|(
name|d
operator|->
name|header
operator|.
name|c_ino
operator|==
name|ino
operator|)
operator|&&
operator|(
name|d
operator|->
name|header
operator|.
name|c_dev_maj
operator|==
name|maj
operator|)
operator|&&
operator|(
name|d
operator|->
name|header
operator|.
name|c_dev_min
operator|==
name|min
operator|)
condition|)
operator|++
name|count
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_comment
comment|/* Is this file_hdr the last (hard) link to a file?  I.e., have    we already seen and defered all of the other links?  */
end_comment

begin_function
specifier|static
name|int
name|last_link
parameter_list|(
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
parameter_list|)
block|{
name|int
name|other_files_sofar
decl_stmt|;
name|other_files_sofar
operator|=
name|count_defered_links_to_dev_ino
argument_list|(
name|file_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|file_hdr
operator|->
name|c_nlink
operator|==
operator|(
name|other_files_sofar
operator|+
literal|1
operator|)
condition|)
block|{
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Add the file header for a link that is being defered to the deferouts    list.  */
end_comment

begin_function
specifier|static
name|void
name|add_link_defer
parameter_list|(
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
parameter_list|)
block|{
name|struct
name|deferment
modifier|*
name|d
decl_stmt|;
name|d
operator|=
name|create_deferment
argument_list|(
name|file_hdr
argument_list|)
expr_stmt|;
name|d
operator|->
name|next
operator|=
name|deferouts
expr_stmt|;
name|deferouts
operator|=
name|d
expr_stmt|;
block|}
end_function

begin_comment
comment|/* We are about to put a file into a newc or crc archive that is    multiply linked.  We have already seen and deferred all of the    other links to the file but haven't written them into the archive.    Write the other links into the archive, and remove them from the    deferouts list.  */
end_comment

begin_function
specifier|static
name|void
name|writeout_other_defers
parameter_list|(
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
parameter_list|,
name|int
name|out_des
parameter_list|)
block|{
name|struct
name|deferment
modifier|*
name|d
decl_stmt|;
name|struct
name|deferment
modifier|*
name|d_prev
decl_stmt|;
name|int
name|ino
decl_stmt|;
name|int
name|maj
decl_stmt|;
name|int
name|min
decl_stmt|;
name|ino
operator|=
name|file_hdr
operator|->
name|c_ino
expr_stmt|;
name|maj
operator|=
name|file_hdr
operator|->
name|c_dev_maj
expr_stmt|;
name|min
operator|=
name|file_hdr
operator|->
name|c_dev_min
expr_stmt|;
name|d_prev
operator|=
name|NULL
expr_stmt|;
name|d
operator|=
name|deferouts
expr_stmt|;
while|while
condition|(
name|d
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|d
operator|->
name|header
operator|.
name|c_ino
operator|==
name|ino
operator|)
operator|&&
operator|(
name|d
operator|->
name|header
operator|.
name|c_dev_maj
operator|==
name|maj
operator|)
operator|&&
operator|(
name|d
operator|->
name|header
operator|.
name|c_dev_min
operator|==
name|min
operator|)
condition|)
block|{
name|struct
name|deferment
modifier|*
name|d_free
decl_stmt|;
name|d
operator|->
name|header
operator|.
name|c_filesize
operator|=
literal|0
expr_stmt|;
name|write_out_header
argument_list|(
operator|&
name|d
operator|->
name|header
argument_list|,
name|out_des
argument_list|)
expr_stmt|;
if|if
condition|(
name|d_prev
operator|!=
name|NULL
condition|)
name|d_prev
operator|->
name|next
operator|=
name|d
operator|->
name|next
expr_stmt|;
else|else
name|deferouts
operator|=
name|d
operator|->
name|next
expr_stmt|;
name|d_free
operator|=
name|d
expr_stmt|;
name|d
operator|=
name|d
operator|->
name|next
expr_stmt|;
name|free_deferment
argument_list|(
name|d_free
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|d_prev
operator|=
name|d
expr_stmt|;
name|d
operator|=
name|d
operator|->
name|next
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/* Write a file into the archive.  This code is the same as    the code in process_copy_out(), but we need it here too    for writeout_final_defers() to call.  */
end_comment

begin_function
specifier|static
name|void
name|writeout_defered_file
parameter_list|(
name|struct
name|cpio_file_stat
modifier|*
name|header
parameter_list|,
name|int
name|out_file_des
parameter_list|)
block|{
name|int
name|in_file_des
decl_stmt|;
name|struct
name|cpio_file_stat
name|file_hdr
decl_stmt|;
name|file_hdr
operator|=
operator|*
name|header
expr_stmt|;
name|in_file_des
operator|=
name|open
argument_list|(
name|header
operator|->
name|c_name
argument_list|,
name|O_RDONLY
operator||
name|O_BINARY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|in_file_des
operator|<
literal|0
condition|)
block|{
name|open_error
argument_list|(
name|header
operator|->
name|c_name
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|archive_format
operator|==
name|arf_crcascii
condition|)
name|file_hdr
operator|.
name|c_chksum
operator|=
name|read_for_checksum
argument_list|(
name|in_file_des
argument_list|,
name|file_hdr
operator|.
name|c_filesize
argument_list|,
name|header
operator|->
name|c_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
condition|)
return|return;
name|copy_files_disk_to_tape
argument_list|(
name|in_file_des
argument_list|,
name|out_file_des
argument_list|,
name|file_hdr
operator|.
name|c_filesize
argument_list|,
name|header
operator|->
name|c_name
argument_list|)
expr_stmt|;
name|warn_if_file_changed
argument_list|(
name|header
operator|->
name|c_name
argument_list|,
name|file_hdr
operator|.
name|c_filesize
argument_list|,
name|file_hdr
operator|.
name|c_mtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|archive_format
operator|==
name|arf_tar
operator|||
name|archive_format
operator|==
name|arf_ustar
condition|)
name|add_inode
argument_list|(
name|file_hdr
operator|.
name|c_ino
argument_list|,
name|file_hdr
operator|.
name|c_name
argument_list|,
name|file_hdr
operator|.
name|c_dev_maj
argument_list|,
name|file_hdr
operator|.
name|c_dev_min
argument_list|)
expr_stmt|;
name|tape_pad_output
argument_list|(
name|out_file_des
argument_list|,
name|file_hdr
operator|.
name|c_filesize
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset_time_flag
condition|)
name|set_file_times
argument_list|(
name|in_file_des
argument_list|,
name|file_hdr
operator|.
name|c_name
argument_list|,
name|file_hdr
operator|.
name|c_mtime
argument_list|,
name|file_hdr
operator|.
name|c_mtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|close
argument_list|(
name|in_file_des
argument_list|)
operator|<
literal|0
condition|)
name|close_error
argument_list|(
name|header
operator|->
name|c_name
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* When writing newc and crc format archives we defer multiply linked    files until we have seen all of the links to the file.  If a file    has links to it that aren't going into the archive, then we will    never see the "last" link to the file, so at the end we just write     all of the leftover defered files into the archive.  */
end_comment

begin_function
specifier|static
name|void
name|writeout_final_defers
parameter_list|(
name|int
name|out_des
parameter_list|)
block|{
name|struct
name|deferment
modifier|*
name|d
decl_stmt|;
name|int
name|other_count
decl_stmt|;
while|while
condition|(
name|deferouts
operator|!=
name|NULL
condition|)
block|{
name|d
operator|=
name|deferouts
expr_stmt|;
name|other_count
operator|=
name|count_defered_links_to_dev_ino
argument_list|(
operator|&
name|d
operator|->
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|other_count
operator|==
literal|1
condition|)
block|{
name|writeout_defered_file
argument_list|(
operator|&
name|d
operator|->
name|header
argument_list|,
name|out_des
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|cpio_file_stat
name|file_hdr
decl_stmt|;
name|file_hdr
operator|=
name|d
operator|->
name|header
expr_stmt|;
name|file_hdr
operator|.
name|c_filesize
operator|=
literal|0
expr_stmt|;
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_des
argument_list|)
expr_stmt|;
block|}
name|deferouts
operator|=
name|deferouts
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* FIXME: to_ascii could be used instead of to_oct() and to_octal() from tar,    so it should be moved to paxutils too.    Allowed values for logbase are: 1 (binary), 2, 3 (octal), 4 (hex) */
end_comment

begin_function
name|int
name|to_ascii
parameter_list|(
name|char
modifier|*
name|where
parameter_list|,
name|uintmax_t
name|v
parameter_list|,
name|size_t
name|digits
parameter_list|,
name|unsigned
name|logbase
parameter_list|)
block|{
specifier|static
name|char
name|codetab
index|[]
init|=
literal|"0123456789ABCDEF"
decl_stmt|;
name|int
name|i
init|=
name|digits
decl_stmt|;
do|do
block|{
name|where
index|[
operator|--
name|i
index|]
operator|=
name|codetab
index|[
operator|(
name|v
operator|&
operator|(
operator|(
literal|1
operator|<<
name|logbase
operator|)
operator|-
literal|1
operator|)
operator|)
index|]
expr_stmt|;
name|v
operator|>>=
name|logbase
expr_stmt|;
block|}
do|while
condition|(
name|i
condition|)
do|;
return|return
name|v
operator|!=
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|field_width_error
parameter_list|(
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|char
modifier|*
name|fieldname
parameter_list|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"%s: field width not sufficient for storing %s"
argument_list|)
argument_list|,
name|filename
argument_list|,
name|fieldname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|field_width_warning
parameter_list|(
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|char
modifier|*
name|fieldname
parameter_list|)
block|{
if|if
condition|(
name|warn_option
operator|&
name|CPIO_WARN_TRUNCATE
condition|)
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"%s: truncating %s"
argument_list|)
argument_list|,
name|filename
argument_list|,
name|fieldname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|to_ascii_or_warn
parameter_list|(
name|char
modifier|*
name|where
parameter_list|,
name|uintmax_t
name|n
parameter_list|,
name|size_t
name|digits
parameter_list|,
name|unsigned
name|logbase
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|char
modifier|*
name|fieldname
parameter_list|)
block|{
if|if
condition|(
name|to_ascii
argument_list|(
name|where
argument_list|,
name|n
argument_list|,
name|digits
argument_list|,
name|logbase
argument_list|)
condition|)
name|field_width_warning
argument_list|(
name|filename
argument_list|,
name|fieldname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|to_ascii_or_error
parameter_list|(
name|char
modifier|*
name|where
parameter_list|,
name|uintmax_t
name|n
parameter_list|,
name|size_t
name|digits
parameter_list|,
name|unsigned
name|logbase
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|char
modifier|*
name|fieldname
parameter_list|)
block|{
if|if
condition|(
name|to_ascii
argument_list|(
name|where
argument_list|,
name|n
argument_list|,
name|digits
argument_list|,
name|logbase
argument_list|)
condition|)
block|{
name|field_width_error
argument_list|(
name|filename
argument_list|,
name|fieldname
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_escape
end_escape

begin_function
name|int
name|write_out_new_ascii_header
parameter_list|(
specifier|const
name|char
modifier|*
name|magic_string
parameter_list|,
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
parameter_list|,
name|int
name|out_des
parameter_list|)
block|{
name|char
name|ascii_header
index|[
literal|110
index|]
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|stpcpy
argument_list|(
name|ascii_header
argument_list|,
name|magic_string
argument_list|)
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_ino
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"inode number"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_mode
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"file mode"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_uid
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"uid"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_gid
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"gid"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_nlink
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"number of links"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_mtime
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"modification time"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|to_ascii_or_error
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_filesize
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"file size"
argument_list|)
argument_list|)
condition|)
return|return
literal|1
return|;
name|p
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|to_ascii_or_error
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_dev_maj
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"device major number"
argument_list|)
argument_list|)
condition|)
return|return
literal|1
return|;
name|p
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|to_ascii_or_error
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_dev_min
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"device minor number"
argument_list|)
argument_list|)
condition|)
return|return
literal|1
return|;
name|p
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|to_ascii_or_error
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_rdev_maj
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"rdev major"
argument_list|)
argument_list|)
condition|)
return|return
literal|1
return|;
name|p
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|to_ascii_or_error
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_rdev_min
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"rdev minor"
argument_list|)
argument_list|)
condition|)
return|return
literal|1
return|;
name|p
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|to_ascii_or_error
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_namesize
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"name size"
argument_list|)
argument_list|)
condition|)
return|return
literal|1
return|;
name|p
operator|+=
literal|8
expr_stmt|;
name|to_ascii
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_chksum
operator|&
literal|0xffffffff
argument_list|,
literal|8
argument_list|,
name|LG_16
argument_list|)
expr_stmt|;
name|tape_buffered_write
argument_list|(
name|ascii_header
argument_list|,
name|out_des
argument_list|,
sizeof|sizeof
name|ascii_header
argument_list|)
expr_stmt|;
comment|/* Write file name to output.  */
name|tape_buffered_write
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|out_des
argument_list|,
operator|(
name|long
operator|)
name|file_hdr
operator|->
name|c_namesize
argument_list|)
expr_stmt|;
name|tape_pad_output
argument_list|(
name|out_des
argument_list|,
name|file_hdr
operator|->
name|c_namesize
operator|+
sizeof|sizeof
name|ascii_header
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|write_out_old_ascii_header
parameter_list|(
name|dev_t
name|dev
parameter_list|,
name|dev_t
name|rdev
parameter_list|,
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
parameter_list|,
name|int
name|out_des
parameter_list|)
block|{
name|char
name|ascii_header
index|[
literal|76
index|]
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|ascii_header
decl_stmt|;
name|to_ascii
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_magic
argument_list|,
literal|6
argument_list|,
name|LG_8
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|6
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|dev
argument_list|,
literal|6
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"device number"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|6
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_ino
argument_list|,
literal|6
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"inode number"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|6
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_mode
argument_list|,
literal|6
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"file mode"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|6
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_uid
argument_list|,
literal|6
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"uid"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|6
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_gid
argument_list|,
literal|6
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"gid"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|6
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_nlink
argument_list|,
literal|6
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"number of links"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|6
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|rdev
argument_list|,
literal|6
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"rdev"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|6
expr_stmt|;
name|to_ascii_or_warn
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_mtime
argument_list|,
literal|11
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"modification time"
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|11
expr_stmt|;
if|if
condition|(
name|to_ascii_or_error
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_namesize
argument_list|,
literal|6
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"name size"
argument_list|)
argument_list|)
condition|)
return|return
literal|1
return|;
name|p
operator|+=
literal|6
expr_stmt|;
if|if
condition|(
name|to_ascii_or_error
argument_list|(
name|p
argument_list|,
name|file_hdr
operator|->
name|c_filesize
argument_list|,
literal|11
argument_list|,
name|LG_8
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"file size"
argument_list|)
argument_list|)
condition|)
return|return
literal|1
return|;
name|tape_buffered_write
argument_list|(
name|ascii_header
argument_list|,
name|out_des
argument_list|,
sizeof|sizeof
name|ascii_header
argument_list|)
expr_stmt|;
comment|/* Write file name to output.  */
name|tape_buffered_write
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|out_des
argument_list|,
name|file_hdr
operator|->
name|c_namesize
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hp_compute_dev
parameter_list|(
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
parameter_list|,
name|dev_t
modifier|*
name|pdev
parameter_list|,
name|dev_t
modifier|*
name|prdev
parameter_list|)
block|{
comment|/* HP/UX cpio creates archives that look just like ordinary archives,      but for devices it sets major = 0, minor = 1, and puts the      actual major/minor number in the filesize field.  */
switch|switch
condition|(
name|file_hdr
operator|->
name|c_mode
operator|&
name|CP_IFMT
condition|)
block|{
case|case
name|CP_IFCHR
case|:
case|case
name|CP_IFBLK
case|:
ifdef|#
directive|ifdef
name|CP_IFSOCK
case|case
name|CP_IFSOCK
case|:
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CP_IFIFO
case|case
name|CP_IFIFO
case|:
endif|#
directive|endif
name|file_hdr
operator|->
name|c_filesize
operator|=
name|makedev
argument_list|(
name|file_hdr
operator|->
name|c_rdev_maj
argument_list|,
name|file_hdr
operator|->
name|c_rdev_min
argument_list|)
expr_stmt|;
operator|*
name|pdev
operator|=
operator|*
name|prdev
operator|=
name|makedev
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|*
name|pdev
operator|=
name|makedev
argument_list|(
name|file_hdr
operator|->
name|c_dev_maj
argument_list|,
name|file_hdr
operator|->
name|c_dev_min
argument_list|)
expr_stmt|;
operator|*
name|prdev
operator|=
name|makedev
argument_list|(
name|file_hdr
operator|->
name|c_rdev_maj
argument_list|,
name|file_hdr
operator|->
name|c_rdev_min
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|write_out_binary_header
parameter_list|(
name|dev_t
name|rdev
parameter_list|,
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
parameter_list|,
name|int
name|out_des
parameter_list|)
block|{
name|struct
name|old_cpio_header
name|short_hdr
decl_stmt|;
name|short_hdr
operator|.
name|c_magic
operator|=
literal|070707
expr_stmt|;
name|short_hdr
operator|.
name|c_dev
operator|=
name|makedev
argument_list|(
name|file_hdr
operator|->
name|c_dev_maj
argument_list|,
name|file_hdr
operator|->
name|c_dev_min
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|warn_option
operator|&
name|CPIO_WARN_TRUNCATE
operator|)
operator|&&
operator|(
name|file_hdr
operator|->
name|c_ino
operator|>>
literal|16
operator|)
operator|!=
literal|0
condition|)
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"%s: truncating inode number"
argument_list|)
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|)
expr_stmt|;
name|short_hdr
operator|.
name|c_ino
operator|=
name|file_hdr
operator|->
name|c_ino
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|short_hdr
operator|.
name|c_ino
operator|!=
name|file_hdr
operator|->
name|c_ino
condition|)
name|field_width_warning
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"inode number"
argument_list|)
argument_list|)
expr_stmt|;
name|short_hdr
operator|.
name|c_mode
operator|=
name|file_hdr
operator|->
name|c_mode
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|short_hdr
operator|.
name|c_mode
operator|!=
name|file_hdr
operator|->
name|c_mode
condition|)
name|field_width_warning
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"file mode"
argument_list|)
argument_list|)
expr_stmt|;
name|short_hdr
operator|.
name|c_uid
operator|=
name|file_hdr
operator|->
name|c_uid
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|short_hdr
operator|.
name|c_uid
operator|!=
name|file_hdr
operator|->
name|c_uid
condition|)
name|field_width_warning
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"uid"
argument_list|)
argument_list|)
expr_stmt|;
name|short_hdr
operator|.
name|c_gid
operator|=
name|file_hdr
operator|->
name|c_gid
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|short_hdr
operator|.
name|c_gid
operator|!=
name|file_hdr
operator|->
name|c_gid
condition|)
name|field_width_warning
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"gid"
argument_list|)
argument_list|)
expr_stmt|;
name|short_hdr
operator|.
name|c_nlink
operator|=
name|file_hdr
operator|->
name|c_nlink
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|short_hdr
operator|.
name|c_nlink
operator|!=
name|file_hdr
operator|->
name|c_nlink
condition|)
name|field_width_warning
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"number of links"
argument_list|)
argument_list|)
expr_stmt|;
name|short_hdr
operator|.
name|c_rdev
operator|=
name|rdev
expr_stmt|;
name|short_hdr
operator|.
name|c_mtimes
index|[
literal|0
index|]
operator|=
name|file_hdr
operator|->
name|c_mtime
operator|>>
literal|16
expr_stmt|;
name|short_hdr
operator|.
name|c_mtimes
index|[
literal|1
index|]
operator|=
name|file_hdr
operator|->
name|c_mtime
operator|&
literal|0xFFFF
expr_stmt|;
name|short_hdr
operator|.
name|c_namesize
operator|=
name|file_hdr
operator|->
name|c_namesize
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|short_hdr
operator|.
name|c_namesize
operator|!=
name|file_hdr
operator|->
name|c_namesize
condition|)
block|{
name|field_width_error
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"name size"
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|short_hdr
operator|.
name|c_filesizes
index|[
literal|0
index|]
operator|=
name|file_hdr
operator|->
name|c_filesize
operator|>>
literal|16
expr_stmt|;
name|short_hdr
operator|.
name|c_filesizes
index|[
literal|1
index|]
operator|=
name|file_hdr
operator|->
name|c_filesize
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|off_t
operator|)
name|short_hdr
operator|.
name|c_filesizes
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
operator|+
name|short_hdr
operator|.
name|c_filesizes
index|[
literal|1
index|]
operator|!=
name|file_hdr
operator|->
name|c_filesize
condition|)
block|{
name|field_width_error
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|_
argument_list|(
literal|"file size"
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
comment|/* Output the file header.  */
name|tape_buffered_write
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|short_hdr
argument_list|,
name|out_des
argument_list|,
literal|26
argument_list|)
expr_stmt|;
comment|/* Write file name to output.  */
name|tape_buffered_write
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|,
name|out_des
argument_list|,
name|file_hdr
operator|->
name|c_namesize
argument_list|)
expr_stmt|;
name|tape_pad_output
argument_list|(
name|out_des
argument_list|,
name|file_hdr
operator|->
name|c_namesize
operator|+
literal|26
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Write out header FILE_HDR, including the file name, to file    descriptor OUT_DES.  */
end_comment

begin_function
name|int
name|write_out_header
parameter_list|(
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
parameter_list|,
name|int
name|out_des
parameter_list|)
block|{
name|dev_t
name|dev
decl_stmt|;
name|dev_t
name|rdev
decl_stmt|;
switch|switch
condition|(
name|archive_format
condition|)
block|{
case|case
name|arf_newascii
case|:
return|return
name|write_out_new_ascii_header
argument_list|(
literal|"070701"
argument_list|,
name|file_hdr
argument_list|,
name|out_des
argument_list|)
return|;
case|case
name|arf_crcascii
case|:
return|return
name|write_out_new_ascii_header
argument_list|(
literal|"070702"
argument_list|,
name|file_hdr
argument_list|,
name|out_des
argument_list|)
return|;
case|case
name|arf_oldascii
case|:
return|return
name|write_out_old_ascii_header
argument_list|(
name|makedev
argument_list|(
name|file_hdr
operator|->
name|c_dev_maj
argument_list|,
name|file_hdr
operator|->
name|c_dev_min
argument_list|)
argument_list|,
name|makedev
argument_list|(
name|file_hdr
operator|->
name|c_rdev_maj
argument_list|,
name|file_hdr
operator|->
name|c_rdev_min
argument_list|)
argument_list|,
name|file_hdr
argument_list|,
name|out_des
argument_list|)
return|;
case|case
name|arf_hpoldascii
case|:
name|hp_compute_dev
argument_list|(
name|file_hdr
argument_list|,
operator|&
name|dev
argument_list|,
operator|&
name|rdev
argument_list|)
expr_stmt|;
return|return
name|write_out_old_ascii_header
argument_list|(
name|dev
argument_list|,
name|rdev
argument_list|,
name|file_hdr
argument_list|,
name|out_des
argument_list|)
return|;
case|case
name|arf_tar
case|:
case|case
name|arf_ustar
case|:
if|if
condition|(
name|is_tar_filename_too_long
argument_list|(
name|file_hdr
operator|->
name|c_name
argument_list|)
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"%s: file name too long"
argument_list|)
argument_list|,
name|file_hdr
operator|->
name|c_name
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|write_out_tar_header
argument_list|(
name|file_hdr
argument_list|,
name|out_des
argument_list|)
expr_stmt|;
comment|/* FIXME: No error checking */
return|return
literal|0
return|;
case|case
name|arf_binary
case|:
return|return
name|write_out_binary_header
argument_list|(
name|makedev
argument_list|(
name|file_hdr
operator|->
name|c_rdev_maj
argument_list|,
name|file_hdr
operator|->
name|c_rdev_min
argument_list|)
argument_list|,
name|file_hdr
argument_list|,
name|out_des
argument_list|)
return|;
case|case
name|arf_hpbinary
case|:
name|hp_compute_dev
argument_list|(
name|file_hdr
argument_list|,
operator|&
name|dev
argument_list|,
operator|&
name|rdev
argument_list|)
expr_stmt|;
comment|/* FIXME: dev ignored. Should it be? */
return|return
name|write_out_binary_header
argument_list|(
name|rdev
argument_list|,
name|file_hdr
argument_list|,
name|out_des
argument_list|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|assign_string
parameter_list|(
name|char
modifier|*
modifier|*
name|pvar
parameter_list|,
name|char
modifier|*
name|value
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|xrealloc
argument_list|(
operator|*
name|pvar
argument_list|,
name|strlen
argument_list|(
name|value
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
name|strcpy
argument_list|(
name|p
argument_list|,
name|value
argument_list|)
expr_stmt|;
operator|*
name|pvar
operator|=
name|p
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Read a list of file names from the standard input    and write a cpio collection on the standard output.    The format of the header depends on the compatibility (-c) flag.  */
end_comment

begin_function
name|void
name|process_copy_out
parameter_list|()
block|{
name|int
name|res
decl_stmt|;
comment|/* Result of functions.  */
name|dynamic_string
name|input_name
decl_stmt|;
comment|/* Name of file read from stdin.  */
name|struct
name|stat
name|file_stat
decl_stmt|;
comment|/* Stat record for file.  */
name|struct
name|cpio_file_stat
name|file_hdr
decl_stmt|;
comment|/* Output header information.  */
name|int
name|in_file_des
decl_stmt|;
comment|/* Source file descriptor.  */
name|int
name|out_file_des
decl_stmt|;
comment|/* Output file descriptor.  */
name|char
modifier|*
name|orig_file_name
init|=
name|NULL
decl_stmt|;
comment|/* Initialize the copy out.  */
name|ds_init
argument_list|(
operator|&
name|input_name
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|file_hdr
operator|.
name|c_magic
operator|=
literal|070707
expr_stmt|;
comment|/* Check whether the output file might be a tape.  */
name|out_file_des
operator|=
name|archive_des
expr_stmt|;
if|if
condition|(
name|_isrmt
argument_list|(
name|out_file_des
argument_list|)
condition|)
block|{
name|output_is_special
operator|=
literal|1
expr_stmt|;
name|output_is_seekable
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|fstat
argument_list|(
name|out_file_des
argument_list|,
operator|&
name|file_stat
argument_list|)
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
name|_
argument_list|(
literal|"standard output is closed"
argument_list|)
argument_list|)
expr_stmt|;
name|output_is_special
operator|=
ifdef|#
directive|ifdef
name|S_ISBLK
name|S_ISBLK
argument_list|(
name|file_stat
operator|.
name|st_mode
argument_list|)
operator|||
endif|#
directive|endif
name|S_ISCHR
argument_list|(
name|file_stat
operator|.
name|st_mode
argument_list|)
expr_stmt|;
name|output_is_seekable
operator|=
name|S_ISREG
argument_list|(
name|file_stat
operator|.
name|st_mode
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|append_flag
condition|)
block|{
name|process_copy_in
argument_list|()
expr_stmt|;
name|prepare_append
argument_list|(
name|out_file_des
argument_list|)
expr_stmt|;
block|}
comment|/* Copy files with names read from stdin.  */
while|while
condition|(
name|ds_fgetstr
argument_list|(
name|stdin
argument_list|,
operator|&
name|input_name
argument_list|,
name|name_end
argument_list|)
operator|!=
name|NULL
condition|)
block|{
comment|/* Check for blank line.  */
if|if
condition|(
name|input_name
operator|.
name|ds_string
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"blank line ignored"
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Process next file.  */
if|if
condition|(
call|(
modifier|*
name|xstat
call|)
argument_list|(
name|input_name
operator|.
name|ds_string
argument_list|,
operator|&
name|file_stat
argument_list|)
operator|<
literal|0
condition|)
name|stat_error
argument_list|(
name|input_name
operator|.
name|ds_string
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* Set values in output header.  */
name|stat_to_cpio
argument_list|(
operator|&
name|file_hdr
argument_list|,
operator|&
name|file_stat
argument_list|)
expr_stmt|;
if|if
condition|(
name|archive_format
operator|==
name|arf_tar
operator|||
name|archive_format
operator|==
name|arf_ustar
condition|)
block|{
if|if
condition|(
name|file_hdr
operator|.
name|c_mode
operator|&
name|CP_IFDIR
condition|)
block|{
name|int
name|len
init|=
name|strlen
argument_list|(
name|input_name
operator|.
name|ds_string
argument_list|)
decl_stmt|;
comment|/* Make sure the name ends with a slash */
if|if
condition|(
name|input_name
operator|.
name|ds_string
index|[
name|len
operator|-
literal|1
index|]
operator|!=
literal|'/'
condition|)
block|{
name|ds_resize
argument_list|(
operator|&
name|input_name
argument_list|,
name|len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|input_name
operator|.
name|ds_string
index|[
name|len
index|]
operator|=
literal|'/'
expr_stmt|;
name|input_name
operator|.
name|ds_string
index|[
name|len
operator|+
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
switch|switch
condition|(
name|check_rdev
argument_list|(
operator|&
name|file_hdr
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s not dumped: major number would be truncated"
argument_list|,
name|file_hdr
operator|.
name|c_name
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|2
case|:
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s not dumped: minor number would be truncated"
argument_list|,
name|file_hdr
operator|.
name|c_name
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|4
case|:
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s not dumped: device number would be truncated"
argument_list|,
name|file_hdr
operator|.
name|c_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|assign_string
argument_list|(
operator|&
name|orig_file_name
argument_list|,
name|input_name
operator|.
name|ds_string
argument_list|)
expr_stmt|;
name|cpio_safer_name_suffix
argument_list|(
name|input_name
operator|.
name|ds_string
argument_list|,
name|false
argument_list|,
name|abs_paths_flag
argument_list|,
name|true
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|HPUX_CDF
name|file_hdr
operator|.
name|c_name
operator|=
name|input_name
operator|.
name|ds_string
expr_stmt|;
name|file_hdr
operator|.
name|c_namesize
operator|=
name|strlen
argument_list|(
name|input_name
operator|.
name|ds_string
argument_list|)
operator|+
literal|1
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
name|archive_format
operator|!=
name|arf_tar
operator|)
operator|&&
operator|(
name|archive_format
operator|!=
name|arf_ustar
operator|)
condition|)
block|{
comment|/* We mark CDF's in cpio files by adding a 2nd `/' after the 		 "hidden" directory name.  We need to do this so we can 		 properly recreate the directory as hidden (in case the 		 files of a directory go into the archive before the 		 directory itself (e.g from "find ... -depth ... | cpio")).  */
name|file_hdr
operator|.
name|c_name
operator|=
name|add_cdf_double_slashes
argument_list|(
name|input_name
operator|.
name|ds_string
argument_list|)
expr_stmt|;
name|file_hdr
operator|.
name|c_namesize
operator|=
name|strlen
argument_list|(
name|file_hdr
operator|.
name|c_name
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* We don't mark CDF's in tar files.  We assume the "hidden" 		 directory will always go into the archive before any of 		 its files.  */
name|file_hdr
operator|.
name|c_name
operator|=
name|input_name
operator|.
name|ds_string
expr_stmt|;
name|file_hdr
operator|.
name|c_namesize
operator|=
name|strlen
argument_list|(
name|input_name
operator|.
name|ds_string
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* Copy the named file to the output.  */
switch|switch
condition|(
name|file_hdr
operator|.
name|c_mode
operator|&
name|CP_IFMT
condition|)
block|{
case|case
name|CP_IFREG
case|:
if|if
condition|(
name|archive_format
operator|==
name|arf_tar
operator|||
name|archive_format
operator|==
name|arf_ustar
condition|)
block|{
name|char
modifier|*
name|otherfile
decl_stmt|;
if|if
condition|(
operator|(
name|otherfile
operator|=
name|find_inode_file
argument_list|(
name|file_hdr
operator|.
name|c_ino
argument_list|,
name|file_hdr
operator|.
name|c_dev_maj
argument_list|,
name|file_hdr
operator|.
name|c_dev_min
argument_list|)
operator|)
condition|)
block|{
name|file_hdr
operator|.
name|c_tar_linkname
operator|=
name|otherfile
expr_stmt|;
if|if
condition|(
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
condition|)
continue|continue;
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|archive_format
operator|==
name|arf_newascii
operator|||
name|archive_format
operator|==
name|arf_crcascii
operator|)
operator|&&
operator|(
name|file_hdr
operator|.
name|c_nlink
operator|>
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|last_link
argument_list|(
operator|&
name|file_hdr
argument_list|)
condition|)
block|{
name|writeout_other_defers
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|add_link_defer
argument_list|(
operator|&
name|file_hdr
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|in_file_des
operator|=
name|open
argument_list|(
name|orig_file_name
argument_list|,
name|O_RDONLY
operator||
name|O_BINARY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|in_file_des
operator|<
literal|0
condition|)
block|{
name|open_error
argument_list|(
name|orig_file_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|archive_format
operator|==
name|arf_crcascii
condition|)
name|file_hdr
operator|.
name|c_chksum
operator|=
name|read_for_checksum
argument_list|(
name|in_file_des
argument_list|,
name|file_hdr
operator|.
name|c_filesize
argument_list|,
name|orig_file_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
condition|)
continue|continue;
name|copy_files_disk_to_tape
argument_list|(
name|in_file_des
argument_list|,
name|out_file_des
argument_list|,
name|file_hdr
operator|.
name|c_filesize
argument_list|,
name|orig_file_name
argument_list|)
expr_stmt|;
name|warn_if_file_changed
argument_list|(
name|orig_file_name
argument_list|,
name|file_hdr
operator|.
name|c_filesize
argument_list|,
name|file_hdr
operator|.
name|c_mtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|archive_format
operator|==
name|arf_tar
operator|||
name|archive_format
operator|==
name|arf_ustar
condition|)
name|add_inode
argument_list|(
name|file_hdr
operator|.
name|c_ino
argument_list|,
name|orig_file_name
argument_list|,
name|file_hdr
operator|.
name|c_dev_maj
argument_list|,
name|file_hdr
operator|.
name|c_dev_min
argument_list|)
expr_stmt|;
name|tape_pad_output
argument_list|(
name|out_file_des
argument_list|,
name|file_hdr
operator|.
name|c_filesize
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset_time_flag
condition|)
name|set_file_times
argument_list|(
name|in_file_des
argument_list|,
name|orig_file_name
argument_list|,
name|file_stat
operator|.
name|st_atime
argument_list|,
name|file_stat
operator|.
name|st_mtime
argument_list|)
expr_stmt|;
if|if
condition|(
name|close
argument_list|(
name|in_file_des
argument_list|)
operator|<
literal|0
condition|)
name|close_error
argument_list|(
name|orig_file_name
argument_list|)
expr_stmt|;
break|break;
case|case
name|CP_IFDIR
case|:
name|file_hdr
operator|.
name|c_filesize
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
condition|)
continue|continue;
break|break;
case|case
name|CP_IFCHR
case|:
case|case
name|CP_IFBLK
case|:
ifdef|#
directive|ifdef
name|CP_IFSOCK
case|case
name|CP_IFSOCK
case|:
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CP_IFIFO
case|case
name|CP_IFIFO
case|:
endif|#
directive|endif
if|if
condition|(
name|archive_format
operator|==
name|arf_tar
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"%s not dumped: not a regular file"
argument_list|)
argument_list|,
name|orig_file_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|archive_format
operator|==
name|arf_ustar
condition|)
block|{
name|char
modifier|*
name|otherfile
decl_stmt|;
if|if
condition|(
operator|(
name|otherfile
operator|=
name|find_inode_file
argument_list|(
name|file_hdr
operator|.
name|c_ino
argument_list|,
name|file_hdr
operator|.
name|c_dev_maj
argument_list|,
name|file_hdr
operator|.
name|c_dev_min
argument_list|)
operator|)
condition|)
block|{
comment|/* This file is linked to another file already in the  		         archive, so write it out as a hard link. */
name|file_hdr
operator|.
name|c_mode
operator|=
operator|(
name|file_stat
operator|.
name|st_mode
operator|&
literal|07777
operator|)
expr_stmt|;
name|file_hdr
operator|.
name|c_mode
operator||=
name|CP_IFREG
expr_stmt|;
name|file_hdr
operator|.
name|c_tar_linkname
operator|=
name|otherfile
expr_stmt|;
if|if
condition|(
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
condition|)
continue|continue;
break|break;
block|}
name|add_inode
argument_list|(
name|file_hdr
operator|.
name|c_ino
argument_list|,
name|orig_file_name
argument_list|,
name|file_hdr
operator|.
name|c_dev_maj
argument_list|,
name|file_hdr
operator|.
name|c_dev_min
argument_list|)
expr_stmt|;
block|}
name|file_hdr
operator|.
name|c_filesize
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
condition|)
continue|continue;
break|break;
ifdef|#
directive|ifdef
name|CP_IFLNK
case|case
name|CP_IFLNK
case|:
block|{
name|char
modifier|*
name|link_name
init|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|file_stat
operator|.
name|st_size
operator|+
literal|1
argument_list|)
decl_stmt|;
name|int
name|link_size
decl_stmt|;
name|link_size
operator|=
name|readlink
argument_list|(
name|orig_file_name
argument_list|,
name|link_name
argument_list|,
name|file_stat
operator|.
name|st_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|link_size
operator|<
literal|0
condition|)
block|{
name|readlink_warn
argument_list|(
name|orig_file_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|link_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|link_name
index|[
name|link_size
index|]
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_filesize
operator|=
name|link_size
expr_stmt|;
if|if
condition|(
name|archive_format
operator|==
name|arf_tar
operator|||
name|archive_format
operator|==
name|arf_ustar
condition|)
block|{
if|if
condition|(
name|link_size
operator|+
literal|1
operator|>
literal|100
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"%s: symbolic link too long"
argument_list|)
argument_list|,
name|file_hdr
operator|.
name|c_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|link_name
index|[
name|link_size
index|]
operator|=
literal|'\0'
expr_stmt|;
name|file_hdr
operator|.
name|c_tar_linkname
operator|=
name|link_name
expr_stmt|;
if|if
condition|(
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
condition|)
continue|continue;
block|}
block|}
else|else
block|{
if|if
condition|(
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
condition|)
continue|continue;
name|tape_buffered_write
argument_list|(
name|link_name
argument_list|,
name|out_file_des
argument_list|,
name|link_size
argument_list|)
expr_stmt|;
name|tape_pad_output
argument_list|(
name|out_file_des
argument_list|,
name|link_size
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|link_name
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
default|default:
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|_
argument_list|(
literal|"%s: unknown file type"
argument_list|)
argument_list|,
name|orig_file_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbose_flag
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n"
argument_list|,
name|orig_file_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|dot_flag
condition|)
name|fputc
argument_list|(
literal|'.'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|orig_file_name
argument_list|)
expr_stmt|;
name|writeout_final_defers
argument_list|(
name|out_file_des
argument_list|)
expr_stmt|;
comment|/* The collection is complete; append the trailer.  */
name|file_hdr
operator|.
name|c_ino
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_mode
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_uid
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_gid
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_nlink
operator|=
literal|1
expr_stmt|;
comment|/* Must be 1 for crc format.  */
name|file_hdr
operator|.
name|c_dev_maj
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_dev_min
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_rdev_maj
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_rdev_min
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_mtime
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_chksum
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_filesize
operator|=
literal|0
expr_stmt|;
name|file_hdr
operator|.
name|c_namesize
operator|=
literal|11
expr_stmt|;
name|file_hdr
operator|.
name|c_name
operator|=
name|CPIO_TRAILER_NAME
expr_stmt|;
if|if
condition|(
name|archive_format
operator|!=
name|arf_tar
operator|&&
name|archive_format
operator|!=
name|arf_ustar
condition|)
name|write_out_header
argument_list|(
operator|&
name|file_hdr
argument_list|,
name|out_file_des
argument_list|)
expr_stmt|;
else|else
name|write_nuls_to_file
argument_list|(
literal|1024
argument_list|,
name|out_file_des
argument_list|,
name|tape_buffered_write
argument_list|)
expr_stmt|;
comment|/* Fill up the output block.  */
name|tape_clear_rest_of_block
argument_list|(
name|out_file_des
argument_list|)
expr_stmt|;
name|tape_empty_output_buffer
argument_list|(
name|out_file_des
argument_list|)
expr_stmt|;
if|if
condition|(
name|dot_flag
condition|)
name|fputc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|quiet_flag
condition|)
block|{
name|res
operator|=
operator|(
name|output_bytes
operator|+
name|io_block_size
operator|-
literal|1
operator|)
operator|/
name|io_block_size
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|ngettext
argument_list|(
literal|"%d block\n"
argument_list|,
literal|"%d blocks\n"
argument_list|,
name|res
argument_list|)
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|check_rdev
parameter_list|(
name|file_hdr
parameter_list|)
name|struct
name|cpio_file_stat
modifier|*
name|file_hdr
decl_stmt|;
block|{
if|if
condition|(
name|archive_format
operator|==
name|arf_newascii
operator|||
name|archive_format
operator|==
name|arf_crcascii
condition|)
block|{
if|if
condition|(
operator|(
name|file_hdr
operator|->
name|c_rdev_maj
operator|&
literal|0xFFFFFFFF
operator|)
operator|!=
name|file_hdr
operator|->
name|c_rdev_maj
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|(
name|file_hdr
operator|->
name|c_rdev_min
operator|&
literal|0xFFFFFFFF
operator|)
operator|!=
name|file_hdr
operator|->
name|c_rdev_min
condition|)
return|return
literal|2
return|;
block|}
elseif|else
if|if
condition|(
name|archive_format
operator|==
name|arf_oldascii
operator|||
name|archive_format
operator|==
name|arf_hpoldascii
condition|)
block|{
ifndef|#
directive|ifndef
name|__MSDOS__
name|dev_t
name|rdev
decl_stmt|;
name|rdev
operator|=
name|makedev
argument_list|(
name|file_hdr
operator|->
name|c_rdev_maj
argument_list|,
name|file_hdr
operator|->
name|c_rdev_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|archive_format
operator|==
name|arf_oldascii
condition|)
block|{
if|if
condition|(
operator|(
name|rdev
operator|&
literal|0xFFFF
operator|)
operator|!=
name|rdev
condition|)
return|return
literal|4
return|;
block|}
else|else
block|{
switch|switch
condition|(
name|file_hdr
operator|->
name|c_mode
operator|&
name|CP_IFMT
condition|)
block|{
case|case
name|CP_IFCHR
case|:
case|case
name|CP_IFBLK
case|:
ifdef|#
directive|ifdef
name|CP_IFSOCK
case|case
name|CP_IFSOCK
case|:
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CP_IFIFO
case|case
name|CP_IFIFO
case|:
endif|#
directive|endif
comment|/* We could handle one more bit if longs are>= 33 bits.  */
if|if
condition|(
operator|(
name|rdev
operator|&
literal|037777777777
operator|)
operator|!=
name|rdev
condition|)
return|return
literal|4
return|;
break|break;
default|default:
if|if
condition|(
operator|(
name|rdev
operator|&
literal|0xFFFF
operator|)
operator|!=
name|rdev
condition|)
return|return
literal|4
return|;
break|break;
block|}
block|}
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|archive_format
operator|==
name|arf_tar
operator|||
name|archive_format
operator|==
name|arf_ustar
condition|)
block|{
comment|/* The major and minor formats are limited to 7 octal digits in ustar 	 format, and to_oct () adds a gratuitous trailing blank to further 	 limit the format to 6 octal digits.  */
if|if
condition|(
operator|(
name|file_hdr
operator|->
name|c_rdev_maj
operator|&
literal|0777777
operator|)
operator|!=
name|file_hdr
operator|->
name|c_rdev_maj
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|(
name|file_hdr
operator|->
name|c_rdev_min
operator|&
literal|0777777
operator|)
operator|!=
name|file_hdr
operator|->
name|c_rdev_min
condition|)
return|return
literal|2
return|;
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|__MSDOS__
name|dev_t
name|rdev
decl_stmt|;
name|rdev
operator|=
name|makedev
argument_list|(
name|file_hdr
operator|->
name|c_rdev_maj
argument_list|,
name|file_hdr
operator|->
name|c_rdev_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|archive_format
operator|!=
name|arf_hpbinary
condition|)
block|{
if|if
condition|(
operator|(
name|rdev
operator|&
literal|0xFFFF
operator|)
operator|!=
name|rdev
condition|)
return|return
literal|4
return|;
block|}
else|else
block|{
switch|switch
condition|(
name|file_hdr
operator|->
name|c_mode
operator|&
name|CP_IFMT
condition|)
block|{
case|case
name|CP_IFCHR
case|:
case|case
name|CP_IFBLK
case|:
ifdef|#
directive|ifdef
name|CP_IFSOCK
case|case
name|CP_IFSOCK
case|:
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CP_IFIFO
case|case
name|CP_IFIFO
case|:
endif|#
directive|endif
if|if
condition|(
operator|(
name|rdev
operator|&
literal|0xFFFFFFFF
operator|)
operator|!=
name|rdev
condition|)
return|return
literal|4
return|;
name|file_hdr
operator|->
name|c_filesize
operator|=
name|rdev
expr_stmt|;
name|rdev
operator|=
name|makedev
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|(
name|rdev
operator|&
literal|0xFFFF
operator|)
operator|!=
name|rdev
condition|)
return|return
literal|4
return|;
break|break;
block|}
block|}
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright 2010 Justin Erenkrantz and Greg Stein  *  * Licensed under the Apache License, Version 2.0 (the "License");  * you may not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|"auth_spnego.h"
end_include

begin_include
include|#
directive|include
file|"serf.h"
end_include

begin_include
include|#
directive|include
file|"serf_private.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SERF_USE_SSPI
end_ifdef

begin_include
include|#
directive|include
file|<apr.h>
end_include

begin_include
include|#
directive|include
file|<apr_strings.h>
end_include

begin_define
define|#
directive|define
name|SECURITY_WIN32
end_define

begin_include
include|#
directive|include
file|<sspi.h>
end_include

begin_comment
comment|/* SEC_E_MUTUAL_AUTH_FAILED is not defined in Windows Platform SDK 5.0. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|SEC_E_MUTUAL_AUTH_FAILED
end_ifndef

begin_define
define|#
directive|define
name|SEC_E_MUTUAL_AUTH_FAILED
value|_HRESULT_TYPEDEF_(0x80090363L)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|serf__spnego_context_t
block|{
name|CredHandle
name|sspi_credentials
decl_stmt|;
name|CtxtHandle
name|sspi_context
decl_stmt|;
name|BOOL
name|initalized
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
comment|/* Service Principal Name (SPN) used for authentication. */
specifier|const
name|char
modifier|*
name|target_name
decl_stmt|;
comment|/* One of SERF_AUTHN_* authentication types.*/
name|int
name|authn_type
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Map SECURITY_STATUS from SSPI to APR error code. Some error codes mapped  * to our own codes and some to Win32 error codes:  * http://support.microsoft.com/kb/113996  */
end_comment

begin_function
specifier|static
name|apr_status_t
name|map_sspi_status
parameter_list|(
name|SECURITY_STATUS
name|sspi_status
parameter_list|)
block|{
switch|switch
condition|(
name|sspi_status
condition|)
block|{
case|case
name|SEC_E_INSUFFICIENT_MEMORY
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_NO_SYSTEM_RESOURCES
argument_list|)
return|;
case|case
name|SEC_E_INVALID_HANDLE
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_INVALID_HANDLE
argument_list|)
return|;
case|case
name|SEC_E_UNSUPPORTED_FUNCTION
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_INVALID_FUNCTION
argument_list|)
return|;
case|case
name|SEC_E_TARGET_UNKNOWN
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_BAD_NETPATH
argument_list|)
return|;
case|case
name|SEC_E_INTERNAL_ERROR
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_INTERNAL_ERROR
argument_list|)
return|;
case|case
name|SEC_E_SECPKG_NOT_FOUND
case|:
case|case
name|SEC_E_BAD_PKGID
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_NO_SUCH_PACKAGE
argument_list|)
return|;
case|case
name|SEC_E_NO_IMPERSONATION
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_CANNOT_IMPERSONATE
argument_list|)
return|;
case|case
name|SEC_E_NO_AUTHENTICATING_AUTHORITY
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_NO_LOGON_SERVERS
argument_list|)
return|;
case|case
name|SEC_E_UNTRUSTED_ROOT
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_TRUST_FAILURE
argument_list|)
return|;
case|case
name|SEC_E_WRONG_PRINCIPAL
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_WRONG_TARGET_NAME
argument_list|)
return|;
case|case
name|SEC_E_MUTUAL_AUTH_FAILED
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_MUTUAL_AUTH_FAILED
argument_list|)
return|;
case|case
name|SEC_E_TIME_SKEW
case|:
return|return
name|APR_FROM_OS_ERROR
argument_list|(
name|ERROR_TIME_SKEW
argument_list|)
return|;
default|default:
return|return
name|SERF_ERROR_AUTHN_FAILED
return|;
block|}
block|}
end_function

begin_comment
comment|/* Cleans the SSPI context object, when the pool used to create it gets    cleared or destroyed. */
end_comment

begin_function
specifier|static
name|apr_status_t
name|cleanup_ctx
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|serf__spnego_context_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
if|if
condition|(
name|SecIsValidHandle
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|)
condition|)
block|{
name|DeleteSecurityContext
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|)
expr_stmt|;
name|SecInvalidateHandle
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SecIsValidHandle
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_credentials
argument_list|)
condition|)
block|{
name|FreeCredentialsHandle
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|)
expr_stmt|;
name|SecInvalidateHandle
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|)
expr_stmt|;
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|cleanup_sec_buffer
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|FreeContextBuffer
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
name|apr_status_t
name|serf__spnego_create_sec_context
parameter_list|(
name|serf__spnego_context_t
modifier|*
modifier|*
name|ctx_p
parameter_list|,
specifier|const
name|serf__authn_scheme_t
modifier|*
name|scheme
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SECURITY_STATUS
name|sspi_status
decl_stmt|;
name|serf__spnego_context_t
modifier|*
name|ctx
decl_stmt|;
specifier|const
name|char
modifier|*
name|sspi_package
decl_stmt|;
name|ctx
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|SecInvalidateHandle
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|)
expr_stmt|;
name|SecInvalidateHandle
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_credentials
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|initalized
operator|=
name|FALSE
expr_stmt|;
name|ctx
operator|->
name|pool
operator|=
name|result_pool
expr_stmt|;
name|ctx
operator|->
name|target_name
operator|=
name|NULL
expr_stmt|;
name|ctx
operator|->
name|authn_type
operator|=
name|scheme
operator|->
name|type
expr_stmt|;
name|apr_pool_cleanup_register
argument_list|(
name|result_pool
argument_list|,
name|ctx
argument_list|,
name|cleanup_ctx
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|authn_type
operator|==
name|SERF_AUTHN_NEGOTIATE
condition|)
name|sspi_package
operator|=
literal|"Negotiate"
expr_stmt|;
else|else
name|sspi_package
operator|=
literal|"NTLM"
expr_stmt|;
name|sspi_status
operator|=
name|AcquireCredentialsHandle
argument_list|(
name|NULL
argument_list|,
name|sspi_package
argument_list|,
name|SECPKG_CRED_OUTBOUND
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ctx
operator|->
name|sspi_credentials
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|sspi_status
argument_list|)
condition|)
block|{
return|return
name|map_sspi_status
argument_list|(
name|sspi_status
argument_list|)
return|;
block|}
operator|*
name|ctx_p
operator|=
name|ctx
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|get_canonical_hostname
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|canonname
parameter_list|,
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|addrinfo
name|hints
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|addrinfo
decl_stmt|;
name|ZeroMemory
argument_list|(
operator|&
name|hints
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_flags
operator|=
name|AI_CANONNAME
expr_stmt|;
if|if
condition|(
name|getaddrinfo
argument_list|(
name|hostname
argument_list|,
name|NULL
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|addrinfo
argument_list|)
condition|)
block|{
return|return
name|apr_get_netos_error
argument_list|()
return|;
block|}
if|if
condition|(
name|addrinfo
condition|)
block|{
operator|*
name|canonname
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|addrinfo
operator|->
name|ai_canonname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|canonname
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
block|}
name|freeaddrinfo
argument_list|(
name|addrinfo
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
name|apr_status_t
name|serf__spnego_reset_sec_context
parameter_list|(
name|serf__spnego_context_t
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|SecIsValidHandle
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|)
condition|)
block|{
name|DeleteSecurityContext
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|)
expr_stmt|;
name|SecInvalidateHandle
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|->
name|initalized
operator|=
name|FALSE
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
name|apr_status_t
name|serf__spnego_init_sec_context
parameter_list|(
name|serf_connection_t
modifier|*
name|conn
parameter_list|,
name|serf__spnego_context_t
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|,
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
name|serf__spnego_buffer_t
modifier|*
name|input_buf
parameter_list|,
name|serf__spnego_buffer_t
modifier|*
name|output_buf
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SECURITY_STATUS
name|status
decl_stmt|;
name|ULONG
name|actual_attr
decl_stmt|;
name|SecBuffer
name|sspi_in_buffer
decl_stmt|;
name|SecBufferDesc
name|sspi_in_buffer_desc
decl_stmt|;
name|SecBuffer
name|sspi_out_buffer
decl_stmt|;
name|SecBufferDesc
name|sspi_out_buffer_desc
decl_stmt|;
name|apr_status_t
name|apr_status
decl_stmt|;
specifier|const
name|char
modifier|*
name|canonname
decl_stmt|;
if|if
condition|(
operator|!
name|ctx
operator|->
name|initalized
operator|&&
name|ctx
operator|->
name|authn_type
operator|==
name|SERF_AUTHN_NEGOTIATE
condition|)
block|{
name|apr_status
operator|=
name|get_canonical_hostname
argument_list|(
operator|&
name|canonname
argument_list|,
name|hostname
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|apr_status
condition|)
block|{
return|return
name|apr_status
return|;
block|}
name|ctx
operator|->
name|target_name
operator|=
name|apr_pstrcat
argument_list|(
name|scratch_pool
argument_list|,
name|service
argument_list|,
literal|"/"
argument_list|,
name|canonname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|serf__log_skt
argument_list|(
name|AUTH_VERBOSE
argument_list|,
name|__FILE__
argument_list|,
name|conn
operator|->
name|skt
argument_list|,
literal|"Using SPN '%s' for '%s'\n"
argument_list|,
name|ctx
operator|->
name|target_name
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ctx
operator|->
name|authn_type
operator|==
name|SERF_AUTHN_NTLM
condition|)
block|{
comment|/* Target name is not used for NTLM authentication. */
name|ctx
operator|->
name|target_name
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Prepare input buffer description. */
name|sspi_in_buffer
operator|.
name|BufferType
operator|=
name|SECBUFFER_TOKEN
expr_stmt|;
name|sspi_in_buffer
operator|.
name|pvBuffer
operator|=
name|input_buf
operator|->
name|value
expr_stmt|;
name|sspi_in_buffer
operator|.
name|cbBuffer
operator|=
name|input_buf
operator|->
name|length
expr_stmt|;
name|sspi_in_buffer_desc
operator|.
name|cBuffers
operator|=
literal|1
expr_stmt|;
name|sspi_in_buffer_desc
operator|.
name|pBuffers
operator|=
operator|&
name|sspi_in_buffer
expr_stmt|;
name|sspi_in_buffer_desc
operator|.
name|ulVersion
operator|=
name|SECBUFFER_VERSION
expr_stmt|;
comment|/* Output buffers. Output buffer will be allocated by system. */
name|sspi_out_buffer
operator|.
name|BufferType
operator|=
name|SECBUFFER_TOKEN
expr_stmt|;
name|sspi_out_buffer
operator|.
name|pvBuffer
operator|=
name|NULL
expr_stmt|;
name|sspi_out_buffer
operator|.
name|cbBuffer
operator|=
literal|0
expr_stmt|;
name|sspi_out_buffer_desc
operator|.
name|cBuffers
operator|=
literal|1
expr_stmt|;
name|sspi_out_buffer_desc
operator|.
name|pBuffers
operator|=
operator|&
name|sspi_out_buffer
expr_stmt|;
name|sspi_out_buffer_desc
operator|.
name|ulVersion
operator|=
name|SECBUFFER_VERSION
expr_stmt|;
name|status
operator|=
name|InitializeSecurityContext
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_credentials
argument_list|,
name|ctx
operator|->
name|initalized
condition|?
operator|&
name|ctx
operator|->
name|sspi_context
else|:
name|NULL
argument_list|,
name|ctx
operator|->
name|target_name
argument_list|,
name|ISC_REQ_ALLOCATE_MEMORY
operator||
name|ISC_REQ_MUTUAL_AUTH
operator||
name|ISC_REQ_CONFIDENTIALITY
argument_list|,
literal|0
argument_list|,
comment|/* Reserved1 */
name|SECURITY_NETWORK_DREP
argument_list|,
operator|&
name|sspi_in_buffer_desc
argument_list|,
literal|0
argument_list|,
comment|/* Reserved2 */
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|,
operator|&
name|sspi_out_buffer_desc
argument_list|,
operator|&
name|actual_attr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sspi_out_buffer
operator|.
name|cbBuffer
operator|>
literal|0
condition|)
block|{
name|apr_pool_cleanup_register
argument_list|(
name|result_pool
argument_list|,
name|sspi_out_buffer
operator|.
name|pvBuffer
argument_list|,
name|cleanup_sec_buffer
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|->
name|initalized
operator|=
name|TRUE
expr_stmt|;
comment|/* Finish authentication if SSPI requires so. */
if|if
condition|(
name|status
operator|==
name|SEC_I_COMPLETE_NEEDED
operator|||
name|status
operator|==
name|SEC_I_COMPLETE_AND_CONTINUE
condition|)
block|{
name|CompleteAuthToken
argument_list|(
operator|&
name|ctx
operator|->
name|sspi_context
argument_list|,
operator|&
name|sspi_out_buffer_desc
argument_list|)
expr_stmt|;
block|}
name|output_buf
operator|->
name|value
operator|=
name|sspi_out_buffer
operator|.
name|pvBuffer
expr_stmt|;
name|output_buf
operator|->
name|length
operator|=
name|sspi_out_buffer
operator|.
name|cbBuffer
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|SEC_I_COMPLETE_AND_CONTINUE
case|:
case|case
name|SEC_I_CONTINUE_NEEDED
case|:
return|return
name|APR_EAGAIN
return|;
case|case
name|SEC_I_COMPLETE_NEEDED
case|:
case|case
name|SEC_E_OK
case|:
return|return
name|APR_SUCCESS
return|;
default|default:
return|return
name|map_sspi_status
argument_list|(
name|status
argument_list|)
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SERF_USE_SSPI */
end_comment

end_unit


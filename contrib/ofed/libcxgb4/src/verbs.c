begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006-2014 Chelsio, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"libcxgb4.h"
end_include

begin_include
include|#
directive|include
file|"cxgb4-abi.h"
end_include

begin_define
define|#
directive|define
name|MASKED
parameter_list|(
name|x
parameter_list|)
value|(void *)((unsigned long)(x)& c4iw_page_mask)
end_define

begin_function
name|int
name|c4iw_query_device
parameter_list|(
name|struct
name|ibv_context
modifier|*
name|context
parameter_list|,
name|struct
name|ibv_device_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|ibv_query_device
name|cmd
decl_stmt|;
name|uint64_t
name|raw_fw_ver
decl_stmt|;
name|unsigned
name|major
decl_stmt|,
name|minor
decl_stmt|,
name|sub_minor
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ibv_cmd_query_device
argument_list|(
name|context
argument_list|,
name|attr
argument_list|,
operator|&
name|raw_fw_ver
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|major
operator|=
operator|(
name|raw_fw_ver
operator|>>
literal|32
operator|)
operator|&
literal|0xffff
expr_stmt|;
name|minor
operator|=
operator|(
name|raw_fw_ver
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
expr_stmt|;
name|sub_minor
operator|=
name|raw_fw_ver
operator|&
literal|0xffff
expr_stmt|;
name|snprintf
argument_list|(
name|attr
operator|->
name|fw_ver
argument_list|,
sizeof|sizeof
name|attr
operator|->
name|fw_ver
argument_list|,
literal|"%d.%d.%d"
argument_list|,
name|major
argument_list|,
name|minor
argument_list|,
name|sub_minor
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|c4iw_query_port
parameter_list|(
name|struct
name|ibv_context
modifier|*
name|context
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|struct
name|ibv_port_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|ibv_query_port
name|cmd
decl_stmt|;
return|return
name|ibv_cmd_query_port
argument_list|(
name|context
argument_list|,
name|port
argument_list|,
name|attr
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|ibv_pd
modifier|*
name|c4iw_alloc_pd
parameter_list|(
name|struct
name|ibv_context
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|ibv_alloc_pd
name|cmd
decl_stmt|;
name|struct
name|c4iw_alloc_pd_resp
name|resp
decl_stmt|;
name|struct
name|c4iw_pd
modifier|*
name|pd
decl_stmt|;
name|pd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pd
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ibv_cmd_alloc_pd
argument_list|(
name|context
argument_list|,
operator|&
name|pd
operator|->
name|ibv_pd
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|,
operator|&
name|resp
operator|.
name|ibv_resp
argument_list|,
sizeof|sizeof
name|resp
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|pd
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
operator|&
name|pd
operator|->
name|ibv_pd
return|;
block|}
end_function

begin_function
name|int
name|c4iw_free_pd
parameter_list|(
name|struct
name|ibv_pd
modifier|*
name|pd
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ibv_cmd_dealloc_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|free
argument_list|(
name|pd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ibv_mr
modifier|*
name|__c4iw_reg_mr
parameter_list|(
name|struct
name|ibv_pd
modifier|*
name|pd
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|length
parameter_list|,
name|uint64_t
name|hca_va
parameter_list|,
name|int
name|access
parameter_list|)
block|{
name|struct
name|c4iw_mr
modifier|*
name|mhp
decl_stmt|;
name|struct
name|ibv_reg_mr
name|cmd
decl_stmt|;
name|struct
name|ibv_reg_mr_resp
name|resp
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|dev
init|=
name|to_c4iw_dev
argument_list|(
name|pd
operator|->
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
name|mhp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|mhp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mhp
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ibv_cmd_reg_mr
argument_list|(
name|pd
argument_list|,
name|addr
argument_list|,
name|length
argument_list|,
name|hca_va
argument_list|,
name|access
argument_list|,
operator|&
name|mhp
operator|->
name|ibv_mr
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|,
operator|&
name|resp
argument_list|,
sizeof|sizeof
name|resp
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|mhp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|mhp
operator|->
name|va_fbo
operator|=
name|hca_va
expr_stmt|;
name|mhp
operator|->
name|len
operator|=
name|length
expr_stmt|;
name|PDBG
argument_list|(
literal|"%s stag 0x%x va_fbo 0x%"
name|PRIx64
literal|" len %d\n"
argument_list|,
name|__func__
argument_list|,
name|mhp
operator|->
name|ibv_mr
operator|.
name|rkey
argument_list|,
name|mhp
operator|->
name|va_fbo
argument_list|,
name|mhp
operator|->
name|len
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|mmid2ptr
index|[
name|c4iw_mmid
argument_list|(
name|mhp
operator|->
name|ibv_mr
operator|.
name|lkey
argument_list|)
index|]
operator|=
name|mhp
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INC_STAT
argument_list|(
name|mr
argument_list|)
expr_stmt|;
return|return
operator|&
name|mhp
operator|->
name|ibv_mr
return|;
block|}
end_function

begin_function
name|struct
name|ibv_mr
modifier|*
name|c4iw_reg_mr
parameter_list|(
name|struct
name|ibv_pd
modifier|*
name|pd
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|length
parameter_list|,
name|int
name|access
parameter_list|)
block|{
name|PDBG
argument_list|(
literal|"%s addr %p length %ld\n"
argument_list|,
name|__func__
argument_list|,
name|addr
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return
name|__c4iw_reg_mr
argument_list|(
name|pd
argument_list|,
name|addr
argument_list|,
name|length
argument_list|,
operator|(
name|uintptr_t
operator|)
name|addr
argument_list|,
name|access
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|c4iw_dereg_mr
parameter_list|(
name|struct
name|ibv_mr
modifier|*
name|mr
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|dev
init|=
name|to_c4iw_dev
argument_list|(
name|mr
operator|->
name|pd
operator|->
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
name|ret
operator|=
name|ibv_cmd_dereg_mr
argument_list|(
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|pthread_spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|mmid2ptr
index|[
name|c4iw_mmid
argument_list|(
name|mr
operator|->
name|lkey
argument_list|)
index|]
operator|=
name|NULL
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|to_c4iw_mr
argument_list|(
name|mr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ibv_cq
modifier|*
name|c4iw_create_cq
parameter_list|(
name|struct
name|ibv_context
modifier|*
name|context
parameter_list|,
name|int
name|cqe
parameter_list|,
name|struct
name|ibv_comp_channel
modifier|*
name|channel
parameter_list|,
name|int
name|comp_vector
parameter_list|)
block|{
name|struct
name|ibv_create_cq
name|cmd
decl_stmt|;
name|struct
name|c4iw_create_cq_resp
name|resp
decl_stmt|;
name|struct
name|c4iw_cq
modifier|*
name|chp
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|dev
init|=
name|to_c4iw_dev
argument_list|(
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|chp
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|chp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chp
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|resp
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|ibv_cmd_create_cq
argument_list|(
name|context
argument_list|,
name|cqe
argument_list|,
name|channel
argument_list|,
name|comp_vector
argument_list|,
operator|&
name|chp
operator|->
name|ibv_cq
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|,
operator|&
name|resp
operator|.
name|ibv_resp
argument_list|,
sizeof|sizeof
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err1
goto|;
if|if
condition|(
name|resp
operator|.
name|reserved
condition|)
name|PDBG
argument_list|(
literal|"%s c4iw_create_cq_resp reserved field modified by kernel\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|pthread_spin_init
argument_list|(
operator|&
name|chp
operator|->
name|lock
argument_list|,
name|PTHREAD_PROCESS_PRIVATE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|STALL_DETECTION
name|gettimeofday
argument_list|(
operator|&
name|chp
operator|->
name|time
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|chp
operator|->
name|rhp
operator|=
name|dev
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|qid_mask
operator|=
name|resp
operator|.
name|qid_mask
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|cqid
operator|=
name|resp
operator|.
name|cqid
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|size
operator|=
name|resp
operator|.
name|size
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|memsize
operator|=
name|resp
operator|.
name|memsize
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|gen
operator|=
literal|1
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|queue
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|memsize
argument_list|,
name|PROT_READ
operator||
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|chp
operator|->
name|cq
operator|.
name|queue
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err2
goto|;
name|chp
operator|->
name|cq
operator|.
name|ugts
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|c4iw_page_size
argument_list|,
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|gts_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|chp
operator|->
name|cq
operator|.
name|ugts
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err3
goto|;
if|if
condition|(
name|dev_is_t5
argument_list|(
name|chp
operator|->
name|rhp
argument_list|)
condition|)
name|chp
operator|->
name|cq
operator|.
name|ugts
operator|+=
literal|5
expr_stmt|;
else|else
name|chp
operator|->
name|cq
operator|.
name|ugts
operator|+=
literal|1
expr_stmt|;
name|chp
operator|->
name|cq
operator|.
name|sw_queue
operator|=
name|calloc
argument_list|(
name|chp
operator|->
name|cq
operator|.
name|size
argument_list|,
sizeof|sizeof
expr|*
name|chp
operator|->
name|cq
operator|.
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chp
operator|->
name|cq
operator|.
name|sw_queue
condition|)
goto|goto
name|err4
goto|;
name|PDBG
argument_list|(
literal|"%s cqid 0x%x key %"
name|PRIx64
literal|" va %p memsize %lu gts_key %"
name|PRIx64
literal|" va %p qid_mask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|,
name|resp
operator|.
name|key
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|queue
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|memsize
argument_list|,
name|resp
operator|.
name|gts_key
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|ugts
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|qid_mask
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|cqid2ptr
index|[
name|chp
operator|->
name|cq
operator|.
name|cqid
index|]
operator|=
name|chp
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INC_STAT
argument_list|(
name|cq
argument_list|)
expr_stmt|;
return|return
operator|&
name|chp
operator|->
name|ibv_cq
return|;
name|err4
label|:
name|munmap
argument_list|(
name|MASKED
argument_list|(
name|chp
operator|->
name|cq
operator|.
name|ugts
argument_list|)
argument_list|,
name|c4iw_page_size
argument_list|)
expr_stmt|;
name|err3
label|:
name|munmap
argument_list|(
name|chp
operator|->
name|cq
operator|.
name|queue
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|err2
label|:
operator|(
name|void
operator|)
name|ibv_cmd_destroy_cq
argument_list|(
operator|&
name|chp
operator|->
name|ibv_cq
argument_list|)
expr_stmt|;
name|err1
label|:
name|free
argument_list|(
name|chp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|c4iw_resize_cq
parameter_list|(
name|struct
name|ibv_cq
modifier|*
name|ibcq
parameter_list|,
name|int
name|cqe
parameter_list|)
block|{
if|#
directive|if
literal|0
block|int ret;  	struct ibv_resize_cq cmd; 	struct ibv_resize_cq_resp resp; 	ret = ibv_cmd_resize_cq(ibcq, cqe,&cmd, sizeof cmd,&resp, sizeof resp); 	PDBG("%s ret %d\n", __func__, ret); 	return ret;
else|#
directive|else
return|return
operator|-
name|ENOSYS
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|c4iw_destroy_cq
parameter_list|(
name|struct
name|ibv_cq
modifier|*
name|ibcq
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|c4iw_cq
modifier|*
name|chp
init|=
name|to_c4iw_cq
argument_list|(
name|ibcq
argument_list|)
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|dev
init|=
name|to_c4iw_dev
argument_list|(
name|ibcq
operator|->
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
name|chp
operator|->
name|cq
operator|.
name|error
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|ibv_cmd_destroy_cq
argument_list|(
name|ibcq
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
return|return
name|ret
return|;
block|}
name|munmap
argument_list|(
name|MASKED
argument_list|(
name|chp
operator|->
name|cq
operator|.
name|ugts
argument_list|)
argument_list|,
name|c4iw_page_size
argument_list|)
expr_stmt|;
name|munmap
argument_list|(
name|chp
operator|->
name|cq
operator|.
name|queue
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|cqid2ptr
index|[
name|chp
operator|->
name|cq
operator|.
name|cqid
index|]
operator|=
name|NULL
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|chp
operator|->
name|cq
operator|.
name|sw_queue
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|chp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ibv_srq
modifier|*
name|c4iw_create_srq
parameter_list|(
name|struct
name|ibv_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ibv_srq_init_attr
modifier|*
name|attr
parameter_list|)
block|{
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|c4iw_modify_srq
parameter_list|(
name|struct
name|ibv_srq
modifier|*
name|srq
parameter_list|,
name|struct
name|ibv_srq_attr
modifier|*
name|attr
parameter_list|,
name|int
name|attr_mask
parameter_list|)
block|{
return|return
name|ENOSYS
return|;
block|}
end_function

begin_function
name|int
name|c4iw_destroy_srq
parameter_list|(
name|struct
name|ibv_srq
modifier|*
name|srq
parameter_list|)
block|{
return|return
name|ENOSYS
return|;
block|}
end_function

begin_function
name|int
name|c4iw_post_srq_recv
parameter_list|(
name|struct
name|ibv_srq
modifier|*
name|ibsrq
parameter_list|,
name|struct
name|ibv_recv_wr
modifier|*
name|wr
parameter_list|,
name|struct
name|ibv_recv_wr
modifier|*
modifier|*
name|bad_wr
parameter_list|)
block|{
return|return
name|ENOSYS
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ibv_qp
modifier|*
name|create_qp_v0
parameter_list|(
name|struct
name|ibv_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ibv_qp_init_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|ibv_create_qp
name|cmd
decl_stmt|;
name|struct
name|c4iw_create_qp_resp_v0
name|resp
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|dev
init|=
name|to_c4iw_dev
argument_list|(
name|pd
operator|->
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|void
modifier|*
name|dbva
decl_stmt|;
name|PDBG
argument_list|(
literal|"%s enter qp\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|qhp
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|qhp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
condition|)
goto|goto
name|err1
goto|;
name|ret
operator|=
name|ibv_cmd_create_qp
argument_list|(
name|pd
argument_list|,
operator|&
name|qhp
operator|->
name|ibv_qp
argument_list|,
name|attr
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|,
operator|&
name|resp
operator|.
name|ibv_resp
argument_list|,
sizeof|sizeof
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err2
goto|;
name|PDBG
argument_list|(
literal|"%s sqid 0x%x sq key %"
name|PRIx64
literal|" sq db/gts key %"
name|PRIx64
literal|" rqid 0x%x rq key %"
name|PRIx64
literal|" rq db/gts key %"
name|PRIx64
literal|" qid_mask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|resp
operator|.
name|sqid
argument_list|,
name|resp
operator|.
name|sq_key
argument_list|,
name|resp
operator|.
name|sq_db_gts_key
argument_list|,
name|resp
operator|.
name|rqid
argument_list|,
name|resp
operator|.
name|rq_key
argument_list|,
name|resp
operator|.
name|rq_db_gts_key
argument_list|,
name|resp
operator|.
name|qid_mask
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|qid_mask
operator|=
name|resp
operator|.
name|qid_mask
expr_stmt|;
name|qhp
operator|->
name|rhp
operator|=
name|dev
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
operator|=
name|resp
operator|.
name|sqid
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
operator|=
name|resp
operator|.
name|sq_size
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
operator|=
name|resp
operator|.
name|sq_memsize
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|msn
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|qid
operator|=
name|resp
operator|.
name|rqid
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
operator|=
name|resp
operator|.
name|rq_size
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
operator|=
name|resp
operator|.
name|rq_memsize
expr_stmt|;
name|pthread_spin_init
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|PTHREAD_PROCESS_PRIVATE
argument_list|)
expr_stmt|;
name|dbva
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|c4iw_page_size
argument_list|,
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|pd
operator|->
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|sq_db_gts_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbva
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err3
goto|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
operator|=
name|dbva
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|,
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|pd
operator|->
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|sq_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err4
goto|;
name|dbva
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|c4iw_page_size
argument_list|,
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|pd
operator|->
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|rq_db_gts_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbva
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err5
goto|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
operator|=
name|dbva
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|,
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|pd
operator|->
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|rq_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err6
goto|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
operator|=
name|calloc
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|t4_swsqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
condition|)
goto|goto
name|err7
goto|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
operator|=
name|calloc
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
condition|)
goto|goto
name|err8
goto|;
name|PDBG
argument_list|(
literal|"%s sq dbva %p sq qva %p sq depth %u sq memsize %lu "
literal|" rq dbva %p rq qva %p rq depth %u rq memsize %lu\n"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|sq_sig_all
operator|=
name|attr
operator|->
name|sq_sig_all
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|qpid2ptr
index|[
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
index|]
operator|=
name|qhp
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INC_STAT
argument_list|(
name|qp
argument_list|)
expr_stmt|;
return|return
operator|&
name|qhp
operator|->
name|ibv_qp
return|;
name|err8
label|:
name|free
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
argument_list|)
expr_stmt|;
name|err7
label|:
name|munmap
argument_list|(
operator|(
name|void
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|err6
label|:
name|munmap
argument_list|(
name|MASKED
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
argument_list|)
argument_list|,
name|c4iw_page_size
argument_list|)
expr_stmt|;
name|err5
label|:
name|munmap
argument_list|(
operator|(
name|void
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|err4
label|:
name|munmap
argument_list|(
name|MASKED
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
argument_list|)
argument_list|,
name|c4iw_page_size
argument_list|)
expr_stmt|;
name|err3
label|:
operator|(
name|void
operator|)
name|ibv_cmd_destroy_qp
argument_list|(
operator|&
name|qhp
operator|->
name|ibv_qp
argument_list|)
expr_stmt|;
name|err2
label|:
name|free
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|err1
label|:
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ibv_qp
modifier|*
name|create_qp
parameter_list|(
name|struct
name|ibv_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ibv_qp_init_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|ibv_create_qp
name|cmd
decl_stmt|;
name|struct
name|c4iw_create_qp_resp
name|resp
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|dev
init|=
name|to_c4iw_dev
argument_list|(
name|pd
operator|->
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|c4iw_context
modifier|*
name|ctx
init|=
name|to_c4iw_context
argument_list|(
name|pd
operator|->
name|context
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|void
modifier|*
name|dbva
decl_stmt|;
name|PDBG
argument_list|(
literal|"%s enter qp\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|qhp
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|qhp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
condition|)
goto|goto
name|err1
goto|;
name|ret
operator|=
name|ibv_cmd_create_qp
argument_list|(
name|pd
argument_list|,
operator|&
name|qhp
operator|->
name|ibv_qp
argument_list|,
name|attr
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|,
operator|&
name|resp
operator|.
name|ibv_resp
argument_list|,
sizeof|sizeof
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err2
goto|;
name|PDBG
argument_list|(
literal|"%s sqid 0x%x sq key %"
name|PRIx64
literal|" sq db/gts key %"
name|PRIx64
literal|" rqid 0x%x rq key %"
name|PRIx64
literal|" rq db/gts key %"
name|PRIx64
literal|" qid_mask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|resp
operator|.
name|sqid
argument_list|,
name|resp
operator|.
name|sq_key
argument_list|,
name|resp
operator|.
name|sq_db_gts_key
argument_list|,
name|resp
operator|.
name|rqid
argument_list|,
name|resp
operator|.
name|rq_key
argument_list|,
name|resp
operator|.
name|rq_db_gts_key
argument_list|,
name|resp
operator|.
name|qid_mask
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|qid_mask
operator|=
name|resp
operator|.
name|qid_mask
expr_stmt|;
name|qhp
operator|->
name|rhp
operator|=
name|dev
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
operator|=
name|resp
operator|.
name|sqid
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
operator|=
name|resp
operator|.
name|sq_size
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
operator|=
name|resp
operator|.
name|sq_memsize
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|flags
operator|=
name|resp
operator|.
name|flags
operator|&
name|C4IW_QPF_ONCHIP
condition|?
name|T4_SQ_ONCHIP
else|:
literal|0
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|flush_cidx
operator|=
operator|-
literal|1
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|msn
operator|=
literal|1
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|qid
operator|=
name|resp
operator|.
name|rqid
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
operator|=
name|resp
operator|.
name|rq_size
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
operator|=
name|resp
operator|.
name|rq_memsize
expr_stmt|;
if|if
condition|(
name|ma_wr
operator|&&
name|resp
operator|.
name|sq_memsize
operator|<
operator|(
name|resp
operator|.
name|sq_size
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
expr|*
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
operator|+
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|__be64
argument_list|)
condition|)
block|{
name|ma_wr
operator|=
literal|0
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"libcxgb4 warning - downlevel iw_cxgb4 driver. "
literal|"MA workaround disabled.\n"
argument_list|)
expr_stmt|;
block|}
name|pthread_spin_init
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|,
name|PTHREAD_PROCESS_PRIVATE
argument_list|)
expr_stmt|;
name|dbva
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|c4iw_page_size
argument_list|,
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|pd
operator|->
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|sq_db_gts_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbva
operator|==
name|MAP_FAILED
condition|)
block|{
name|PDBG
argument_list|(
literal|" %s mmap for sq db failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
operator|=
name|dbva
expr_stmt|;
if|if
condition|(
operator|!
name|dev_is_t4
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|)
condition|)
block|{
name|unsigned
name|long
name|segment_offset
init|=
literal|128
operator|*
operator|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
operator|&
name|qhp
operator|->
name|wq
operator|.
name|qid_mask
operator|)
decl_stmt|;
if|if
condition|(
name|segment_offset
operator|<
name|c4iw_page_size
condition|)
block|{
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
operator|+=
name|segment_offset
operator|/
literal|4
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|wc_reg_available
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|bar2_qid
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
operator|&
name|qhp
operator|->
name|wq
operator|.
name|qid_mask
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
operator|+=
literal|2
expr_stmt|;
block|}
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|,
name|PROT_READ
operator||
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|pd
operator|->
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|sq_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
operator|==
name|MAP_FAILED
condition|)
block|{
name|PDBG
argument_list|(
literal|" %s mmap for sq q failed size is qhp->wq.sq.memsize %zu \n"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
goto|goto
name|err4
goto|;
block|}
name|dbva
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|c4iw_page_size
argument_list|,
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|pd
operator|->
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|rq_db_gts_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbva
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err5
goto|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
operator|=
name|dbva
expr_stmt|;
if|if
condition|(
operator|!
name|dev_is_t4
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|)
condition|)
block|{
name|unsigned
name|long
name|segment_offset
init|=
literal|128
operator|*
operator|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|qid
operator|&
name|qhp
operator|->
name|wq
operator|.
name|qid_mask
operator|)
decl_stmt|;
if|if
condition|(
name|segment_offset
operator|<
name|c4iw_page_size
condition|)
block|{
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
operator|+=
name|segment_offset
operator|/
literal|4
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|wc_reg_available
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|bar2_qid
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|qid
operator|&
name|qhp
operator|->
name|wq
operator|.
name|qid_mask
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
operator|+=
literal|2
expr_stmt|;
block|}
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|,
name|PROT_READ
operator||
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|pd
operator|->
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|rq_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err6
goto|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
operator|=
name|calloc
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|t4_swsqe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
condition|)
goto|goto
name|err7
goto|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
operator|=
name|calloc
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
condition|)
goto|goto
name|err8
goto|;
if|if
condition|(
name|t4_sq_onchip
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
block|{
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|ma_sync
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|c4iw_page_size
argument_list|,
name|PROT_WRITE
argument_list|,
name|MAP_SHARED
argument_list|,
name|pd
operator|->
name|context
operator|->
name|cmd_fd
argument_list|,
name|resp
operator|.
name|ma_sync_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|ma_sync
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err9
goto|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|ma_sync
operator|+=
operator|(
name|A_PCIE_MA_SYNC
operator|&
operator|(
name|c4iw_page_size
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|status_page_size
condition|)
block|{
name|qhp
operator|->
name|wq
operator|.
name|db_offp
operator|=
operator|&
name|ctx
operator|->
name|status_page
operator|->
name|db_off
expr_stmt|;
block|}
else|else
block|{
name|qhp
operator|->
name|wq
operator|.
name|db_offp
operator|=
operator|&
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
index|[
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
index|]
operator|.
name|status
operator|.
name|db_off
expr_stmt|;
block|}
name|PDBG
argument_list|(
literal|"%s sq dbva %p sq qva %p sq depth %u sq memsize %lu "
literal|" rq dbva %p rq qva %p rq depth %u rq memsize %lu\n"
argument_list|,
name|__func__
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|sq_sig_all
operator|=
name|attr
operator|->
name|sq_sig_all
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|qpid2ptr
index|[
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
index|]
operator|=
name|qhp
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|INC_STAT
argument_list|(
name|qp
argument_list|)
expr_stmt|;
return|return
operator|&
name|qhp
operator|->
name|ibv_qp
return|;
name|err9
label|:
name|free
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
argument_list|)
expr_stmt|;
name|err8
label|:
name|free
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
argument_list|)
expr_stmt|;
name|err7
label|:
name|munmap
argument_list|(
operator|(
name|void
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|err6
label|:
name|munmap
argument_list|(
name|MASKED
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
argument_list|)
argument_list|,
name|c4iw_page_size
argument_list|)
expr_stmt|;
name|err5
label|:
name|munmap
argument_list|(
operator|(
name|void
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|err4
label|:
name|munmap
argument_list|(
name|MASKED
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
argument_list|)
argument_list|,
name|c4iw_page_size
argument_list|)
expr_stmt|;
name|err3
label|:
operator|(
name|void
operator|)
name|ibv_cmd_destroy_qp
argument_list|(
operator|&
name|qhp
operator|->
name|ibv_qp
argument_list|)
expr_stmt|;
name|err2
label|:
name|free
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|err1
label|:
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|ibv_qp
modifier|*
name|c4iw_create_qp
parameter_list|(
name|struct
name|ibv_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ibv_qp_init_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|dev
init|=
name|to_c4iw_dev
argument_list|(
name|pd
operator|->
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
if|if
condition|(
name|dev
operator|->
name|abi_version
operator|==
literal|0
condition|)
return|return
name|create_qp_v0
argument_list|(
name|pd
argument_list|,
name|attr
argument_list|)
return|;
return|return
name|create_qp
argument_list|(
name|pd
argument_list|,
name|attr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|reset_qp
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|)
block|{
name|PDBG
argument_list|(
literal|"%s enter qp %p\n"
argument_list|,
name|__func__
argument_list|,
name|qhp
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|cidx
operator|=
literal|0
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|wq_pidx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|in_use
operator|=
literal|0
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|cidx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|in_use
operator|=
literal|0
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|oldest_read
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
argument_list|,
literal|0
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
argument_list|,
literal|0
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|c4iw_modify_qp
parameter_list|(
name|struct
name|ibv_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ibv_qp_attr
modifier|*
name|attr
parameter_list|,
name|int
name|attr_mask
parameter_list|)
block|{
name|struct
name|ibv_modify_qp
name|cmd
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|PDBG
argument_list|(
literal|"%s enter qp %p new state %d\n"
argument_list|,
name|__func__
argument_list|,
name|ibqp
argument_list|,
name|attr_mask
operator|&
name|IBV_QP_STATE
condition|?
name|attr
operator|->
name|qp_state
else|:
operator|-
literal|1
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|t4_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
name|c4iw_flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ibv_cmd_modify_qp
argument_list|(
name|ibqp
argument_list|,
name|attr
argument_list|,
name|attr_mask
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|&&
operator|(
name|attr_mask
operator|&
name|IBV_QP_STATE
operator|)
operator|&&
name|attr
operator|->
name|qp_state
operator|==
name|IBV_QPS_RESET
condition|)
name|reset_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|c4iw_destroy_qp
parameter_list|(
name|struct
name|ibv_qp
modifier|*
name|ibqp
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|dev
init|=
name|to_c4iw_dev
argument_list|(
name|ibqp
operator|->
name|context
operator|->
name|device
argument_list|)
decl_stmt|;
name|PDBG
argument_list|(
literal|"%s enter qp %p\n"
argument_list|,
name|__func__
argument_list|,
name|ibqp
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|c4iw_flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ibv_cmd_destroy_qp
argument_list|(
name|ibqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
return|return
name|ret
return|;
block|}
if|if
condition|(
name|t4_sq_onchip
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
block|{
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|ma_sync
operator|-=
operator|(
name|A_PCIE_MA_SYNC
operator|&
operator|(
name|c4iw_page_size
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|munmap
argument_list|(
operator|(
name|void
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|ma_sync
argument_list|,
name|c4iw_page_size
argument_list|)
expr_stmt|;
block|}
name|munmap
argument_list|(
name|MASKED
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|udb
argument_list|)
argument_list|,
name|c4iw_page_size
argument_list|)
expr_stmt|;
name|munmap
argument_list|(
name|MASKED
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|udb
argument_list|)
argument_list|,
name|c4iw_page_size
argument_list|)
expr_stmt|;
name|munmap
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|munmap
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|memsize
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|qpid2ptr
index|[
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
index|]
operator|=
name|NULL
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|c4iw_query_qp
parameter_list|(
name|struct
name|ibv_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ibv_qp_attr
modifier|*
name|attr
parameter_list|,
name|int
name|attr_mask
parameter_list|,
name|struct
name|ibv_qp_init_attr
modifier|*
name|init_attr
parameter_list|)
block|{
name|struct
name|ibv_query_qp
name|cmd
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|t4_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
name|c4iw_flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ibv_cmd_query_qp
argument_list|(
name|ibqp
argument_list|,
name|attr
argument_list|,
name|attr_mask
argument_list|,
name|init_attr
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|struct
name|ibv_ah
modifier|*
name|c4iw_create_ah
parameter_list|(
name|struct
name|ibv_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ibv_ah_attr
modifier|*
name|attr
parameter_list|)
block|{
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|c4iw_destroy_ah
parameter_list|(
name|struct
name|ibv_ah
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|ENOSYS
return|;
block|}
end_function

begin_function
name|int
name|c4iw_attach_mcast
parameter_list|(
name|struct
name|ibv_qp
modifier|*
name|ibqp
parameter_list|,
specifier|const
name|union
name|ibv_gid
modifier|*
name|gid
parameter_list|,
name|uint16_t
name|lid
parameter_list|)
block|{
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|t4_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
name|c4iw_flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ibv_cmd_attach_mcast
argument_list|(
name|ibqp
argument_list|,
name|gid
argument_list|,
name|lid
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|c4iw_detach_mcast
parameter_list|(
name|struct
name|ibv_qp
modifier|*
name|ibqp
parameter_list|,
specifier|const
name|union
name|ibv_gid
modifier|*
name|gid
parameter_list|,
name|uint16_t
name|lid
parameter_list|)
block|{
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|t4_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
name|c4iw_flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ibv_cmd_detach_mcast
argument_list|(
name|ibqp
argument_list|,
name|gid
argument_list|,
name|lid
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|c4iw_async_event
parameter_list|(
name|struct
name|ibv_async_event
modifier|*
name|event
parameter_list|)
block|{
name|PDBG
argument_list|(
literal|"%s type %d obj %p\n"
argument_list|,
name|__func__
argument_list|,
name|event
operator|->
name|event_type
argument_list|,
name|event
operator|->
name|element
operator|.
name|cq
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|event_type
condition|)
block|{
case|case
name|IBV_EVENT_CQ_ERR
case|:
break|break;
case|case
name|IBV_EVENT_QP_FATAL
case|:
case|case
name|IBV_EVENT_QP_REQ_ERR
case|:
case|case
name|IBV_EVENT_QP_ACCESS_ERR
case|:
case|case
name|IBV_EVENT_PATH_MIG_ERR
case|:
block|{
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|to_c4iw_qp
argument_list|(
name|event
operator|->
name|element
operator|.
name|qp
argument_list|)
decl_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|c4iw_flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IBV_EVENT_SQ_DRAINED
case|:
case|case
name|IBV_EVENT_PATH_MIG
case|:
case|case
name|IBV_EVENT_COMM_EST
case|:
case|case
name|IBV_EVENT_QP_LAST_WQE_REACHED
case|:
default|default:
break|break;
block|}
block|}
end_function

end_unit


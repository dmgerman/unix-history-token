begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006-2016 Chelsio, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|"libcxgb4.h"
end_include

begin_include
include|#
directive|include
file|"cxgb4-abi.h"
end_include

begin_define
define|#
directive|define
name|PCI_VENDOR_ID_CHELSIO
value|0x1425
end_define

begin_comment
comment|/*  * Macros needed to support the PCI Device ID Table ...  */
end_comment

begin_define
define|#
directive|define
name|CH_PCI_DEVICE_ID_TABLE_DEFINE_BEGIN
define|\
value|static struct { \ 		unsigned vendor; \ 		unsigned device; \ 	} hca_table[] = {
end_define

begin_define
define|#
directive|define
name|CH_PCI_DEVICE_ID_FUNCTION
define|\
value|0x4
end_define

begin_define
define|#
directive|define
name|CH_PCI_ID_TABLE_ENTRY
parameter_list|(
name|__DeviceID
parameter_list|)
define|\
value|{ \ 			.vendor = PCI_VENDOR_ID_CHELSIO, \ 			.device = (__DeviceID), \ 		}
end_define

begin_define
define|#
directive|define
name|CH_PCI_DEVICE_ID_TABLE_DEFINE_END
define|\
value|}
end_define

begin_include
include|#
directive|include
file|"t4_chip_type.h"
end_include

begin_include
include|#
directive|include
file|"t4_pci_id_tbl.h"
end_include

begin_decl_stmt
name|unsigned
name|long
name|c4iw_page_size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|c4iw_page_shift
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|long
name|c4iw_page_mask
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ma_wr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|t5_en_wc
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|c4iw_dev
argument_list|)
name|devices
operator|=
name|TAILQ_HEAD_INITIALIZER
argument_list|(
name|devices
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|ibv_context_ops
name|c4iw_ctx_ops
init|=
block|{
operator|.
name|query_device
operator|=
name|c4iw_query_device
block|,
operator|.
name|query_port
operator|=
name|c4iw_query_port
block|,
operator|.
name|alloc_pd
operator|=
name|c4iw_alloc_pd
block|,
operator|.
name|dealloc_pd
operator|=
name|c4iw_free_pd
block|,
operator|.
name|reg_mr
operator|=
name|c4iw_reg_mr
block|,
operator|.
name|dereg_mr
operator|=
name|c4iw_dereg_mr
block|,
operator|.
name|create_cq
operator|=
name|c4iw_create_cq
block|,
operator|.
name|resize_cq
operator|=
name|c4iw_resize_cq
block|,
operator|.
name|destroy_cq
operator|=
name|c4iw_destroy_cq
block|,
operator|.
name|create_srq
operator|=
name|c4iw_create_srq
block|,
operator|.
name|modify_srq
operator|=
name|c4iw_modify_srq
block|,
operator|.
name|destroy_srq
operator|=
name|c4iw_destroy_srq
block|,
operator|.
name|create_qp
operator|=
name|c4iw_create_qp
block|,
operator|.
name|modify_qp
operator|=
name|c4iw_modify_qp
block|,
operator|.
name|destroy_qp
operator|=
name|c4iw_destroy_qp
block|,
operator|.
name|query_qp
operator|=
name|c4iw_query_qp
block|,
operator|.
name|create_ah
operator|=
name|c4iw_create_ah
block|,
operator|.
name|destroy_ah
operator|=
name|c4iw_destroy_ah
block|,
operator|.
name|attach_mcast
operator|=
name|c4iw_attach_mcast
block|,
operator|.
name|detach_mcast
operator|=
name|c4iw_detach_mcast
block|,
operator|.
name|post_srq_recv
operator|=
name|c4iw_post_srq_recv
block|,
operator|.
name|req_notify_cq
operator|=
name|c4iw_arm_cq
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|ibv_context
modifier|*
name|c4iw_alloc_context
parameter_list|(
name|struct
name|ibv_device
modifier|*
name|ibdev
parameter_list|,
name|int
name|cmd_fd
parameter_list|)
block|{
name|struct
name|c4iw_context
modifier|*
name|context
decl_stmt|;
name|struct
name|ibv_get_context
name|cmd
decl_stmt|;
name|struct
name|c4iw_alloc_ucontext_resp
name|resp
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|rhp
init|=
name|to_c4iw_dev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|ibv_query_device
name|qcmd
decl_stmt|;
name|uint64_t
name|raw_fw_ver
decl_stmt|;
name|struct
name|ibv_device_attr
name|attr
decl_stmt|;
name|context
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|context
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|context
argument_list|)
expr_stmt|;
name|context
operator|->
name|ibv_ctx
operator|.
name|cmd_fd
operator|=
name|cmd_fd
expr_stmt|;
name|resp
operator|.
name|status_page_size
operator|=
literal|0
expr_stmt|;
name|resp
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ibv_cmd_get_context
argument_list|(
operator|&
name|context
operator|->
name|ibv_ctx
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|,
operator|&
name|resp
operator|.
name|ibv_resp
argument_list|,
sizeof|sizeof
name|resp
argument_list|)
condition|)
goto|goto
name|err_free
goto|;
if|if
condition|(
name|resp
operator|.
name|reserved
condition|)
name|PDBG
argument_list|(
literal|"%s c4iw_alloc_ucontext_resp reserved field modified by kernel\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|context
operator|->
name|status_page_size
operator|=
name|resp
operator|.
name|status_page_size
expr_stmt|;
if|if
condition|(
name|resp
operator|.
name|status_page_size
condition|)
block|{
name|context
operator|->
name|status_page
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|resp
operator|.
name|status_page_size
argument_list|,
name|PROT_READ
argument_list|,
name|MAP_SHARED
argument_list|,
name|cmd_fd
argument_list|,
name|resp
operator|.
name|status_page_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|->
name|status_page
operator|==
name|MAP_FAILED
condition|)
goto|goto
name|err_free
goto|;
block|}
name|context
operator|->
name|ibv_ctx
operator|.
name|device
operator|=
name|ibdev
expr_stmt|;
name|context
operator|->
name|ibv_ctx
operator|.
name|ops
operator|=
name|c4iw_ctx_ops
expr_stmt|;
switch|switch
condition|(
name|rhp
operator|->
name|chip_version
condition|)
block|{
case|case
name|CHELSIO_T6
case|:
name|PDBG
argument_list|(
literal|"%s T6/T5/T4 device\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
case|case
name|CHELSIO_T5
case|:
name|PDBG
argument_list|(
literal|"%s T5/T4 device\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
case|case
name|CHELSIO_T4
case|:
name|PDBG
argument_list|(
literal|"%s T4 device\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|context
operator|->
name|ibv_ctx
operator|.
name|ops
operator|.
name|async_event
operator|=
name|c4iw_async_event
expr_stmt|;
name|context
operator|->
name|ibv_ctx
operator|.
name|ops
operator|.
name|post_send
operator|=
name|c4iw_post_send
expr_stmt|;
name|context
operator|->
name|ibv_ctx
operator|.
name|ops
operator|.
name|post_recv
operator|=
name|c4iw_post_receive
expr_stmt|;
name|context
operator|->
name|ibv_ctx
operator|.
name|ops
operator|.
name|poll_cq
operator|=
name|c4iw_poll_cq
expr_stmt|;
name|context
operator|->
name|ibv_ctx
operator|.
name|ops
operator|.
name|req_notify_cq
operator|=
name|c4iw_arm_cq
expr_stmt|;
break|break;
default|default:
name|PDBG
argument_list|(
literal|"%s unknown hca type %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|rhp
operator|->
name|chip_version
argument_list|)
expr_stmt|;
goto|goto
name|err_unmap
goto|;
break|break;
block|}
if|if
condition|(
operator|!
name|rhp
operator|->
name|mmid2ptr
condition|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ibv_cmd_query_device
argument_list|(
operator|&
name|context
operator|->
name|ibv_ctx
argument_list|,
operator|&
name|attr
argument_list|,
operator|&
name|raw_fw_ver
argument_list|,
operator|&
name|qcmd
argument_list|,
sizeof|sizeof
name|qcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_unmap
goto|;
name|rhp
operator|->
name|max_mr
operator|=
name|attr
operator|.
name|max_mr
expr_stmt|;
name|rhp
operator|->
name|mmid2ptr
operator|=
name|calloc
argument_list|(
name|attr
operator|.
name|max_mr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rhp
operator|->
name|mmid2ptr
condition|)
block|{
goto|goto
name|err_unmap
goto|;
block|}
if|if
condition|(
name|rhp
operator|->
name|abi_version
operator|<
literal|3
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: iw_cxgb4 driver is of older version"
literal|" than libcxgb4:: %d\n"
argument_list|,
name|rhp
operator|->
name|abi_version
argument_list|)
expr_stmt|;
name|rhp
operator|->
name|max_qp
operator|=
name|T4_QID_BASE
operator|+
name|attr
operator|.
name|max_qp
expr_stmt|;
block|}
else|else
block|{
name|rhp
operator|->
name|max_qp
operator|=
name|context
operator|->
name|status_page
operator|->
name|qp_start
operator|+
name|context
operator|->
name|status_page
operator|->
name|qp_size
expr_stmt|;
block|}
name|rhp
operator|->
name|qpid2ptr
operator|=
name|calloc
argument_list|(
name|rhp
operator|->
name|max_qp
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rhp
operator|->
name|qpid2ptr
condition|)
block|{
goto|goto
name|err_unmap
goto|;
block|}
if|if
condition|(
name|rhp
operator|->
name|abi_version
operator|<
literal|3
condition|)
name|rhp
operator|->
name|max_cq
operator|=
name|T4_QID_BASE
operator|+
name|attr
operator|.
name|max_cq
expr_stmt|;
else|else
name|rhp
operator|->
name|max_cq
operator|=
name|context
operator|->
name|status_page
operator|->
name|cq_start
operator|+
name|context
operator|->
name|status_page
operator|->
name|cq_size
expr_stmt|;
name|rhp
operator|->
name|cqid2ptr
operator|=
name|calloc
argument_list|(
name|rhp
operator|->
name|max_cq
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rhp
operator|->
name|cqid2ptr
condition|)
goto|goto
name|err_unmap
goto|;
block|}
return|return
operator|&
name|context
operator|->
name|ibv_ctx
return|;
name|err_unmap
label|:
name|munmap
argument_list|(
name|context
operator|->
name|status_page
argument_list|,
name|context
operator|->
name|status_page_size
argument_list|)
expr_stmt|;
name|err_free
label|:
if|if
condition|(
name|rhp
operator|->
name|cqid2ptr
condition|)
name|free
argument_list|(
name|rhp
operator|->
name|cqid2ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rhp
operator|->
name|qpid2ptr
condition|)
name|free
argument_list|(
name|rhp
operator|->
name|cqid2ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rhp
operator|->
name|mmid2ptr
condition|)
name|free
argument_list|(
name|rhp
operator|->
name|cqid2ptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|c4iw_free_context
parameter_list|(
name|struct
name|ibv_context
modifier|*
name|ibctx
parameter_list|)
block|{
name|struct
name|c4iw_context
modifier|*
name|context
init|=
name|to_c4iw_context
argument_list|(
name|ibctx
argument_list|)
decl_stmt|;
if|if
condition|(
name|context
operator|->
name|status_page_size
condition|)
name|munmap
argument_list|(
name|context
operator|->
name|status_page
argument_list|,
name|context
operator|->
name|status_page_size
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|context
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|verbs_device_ops
name|c4iw_dev_ops
init|=
block|{
operator|.
name|alloc_context
operator|=
name|c4iw_alloc_context
block|,
operator|.
name|free_context
operator|=
name|c4iw_free_context
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|STALL_DETECTION
end_ifdef

begin_decl_stmt
name|int
name|stall_to
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|dump_cq
parameter_list|(
name|struct
name|c4iw_cq
modifier|*
name|chp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"CQ: %p id %u queue %p cidx 0x%08x sw_queue %p sw_cidx %d sw_pidx %d sw_in_use %d depth %u error %u gen %d "
literal|"cidx_inc %d bits_type_ts %016"
name|PRIx64
literal|" notempty %d\n"
argument_list|,
name|chp
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cqid
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|queue
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cidx
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|sw_queue
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|sw_cidx
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|sw_pidx
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|sw_in_use
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|size
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|error
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|gen
argument_list|,
name|chp
operator|->
name|cq
operator|.
name|cidx_inc
argument_list|,
name|be64toh
argument_list|(
name|chp
operator|->
name|cq
operator|.
name|bits_type_ts
argument_list|)
argument_list|,
name|t4_cq_notempty
argument_list|(
operator|&
name|chp
operator|->
name|cq
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|chp
operator|->
name|cq
operator|.
name|size
condition|;
name|i
operator|++
control|)
block|{
name|u64
modifier|*
name|p
init|=
operator|(
name|u64
operator|*
operator|)
operator|(
name|chp
operator|->
name|cq
operator|.
name|queue
operator|+
name|i
operator|)
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%02x: %016"
name|PRIx64
literal|" %016"
name|PRIx64
argument_list|,
name|i
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|chp
operator|->
name|cq
operator|.
name|cidx
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"<-- cidx\n"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%02x: %016"
name|PRIx64
literal|" %016"
name|PRIx64
literal|"\n"
argument_list|,
name|i
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%02x: %016"
name|PRIx64
literal|" %016"
name|PRIx64
literal|"\n"
argument_list|,
name|i
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%02x: %016"
name|PRIx64
literal|" %016"
name|PRIx64
literal|"\n"
argument_list|,
name|i
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_qp
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
name|struct
name|t4_swsqe
modifier|*
name|swsqe
decl_stmt|;
name|struct
name|t4_swrqe
modifier|*
name|swrqe
decl_stmt|;
name|u16
name|cidx
decl_stmt|,
name|pidx
decl_stmt|;
name|u64
modifier|*
name|p
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"QP: %p id %u error %d flushed %d qid_mask 0x%x\n"
literal|"    SQ: id %u queue %p sw_queue %p cidx %u pidx %u in_use %u wq_pidx %u depth %u flags 0x%x flush_cidx %d\n"
literal|"    RQ: id %u queue %p sw_queue %p cidx %u pidx %u in_use %u depth %u\n"
argument_list|,
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|error
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|flushed
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|qid_mask
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|cidx
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|in_use
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|wq_pidx
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|flags
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|flush_cidx
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|qid
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|cidx
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|in_use
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
argument_list|)
expr_stmt|;
name|cidx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|cidx
expr_stmt|;
name|pidx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
expr_stmt|;
if|if
condition|(
name|cidx
operator|!=
name|pidx
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"SQ: \n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|cidx
operator|!=
name|pidx
condition|)
block|{
name|swsqe
operator|=
operator|&
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
index|[
name|cidx
index|]
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%04u: wr_id %016"
name|PRIx64
literal|" sq_wptr %08x read_len %u opcode 0x%x "
literal|"complete %u signaled %u cqe %016"
name|PRIx64
literal|" %016"
name|PRIx64
literal|" %016"
name|PRIx64
literal|" %016"
name|PRIx64
literal|"\n"
argument_list|,
name|cidx
argument_list|,
name|swsqe
operator|->
name|wr_id
argument_list|,
name|swsqe
operator|->
name|idx
argument_list|,
name|swsqe
operator|->
name|read_len
argument_list|,
name|swsqe
operator|->
name|opcode
argument_list|,
name|swsqe
operator|->
name|complete
argument_list|,
name|swsqe
operator|->
name|signaled
argument_list|,
name|htobe64
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|swsqe
operator|->
name|cqe
operator|)
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|htobe64
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|swsqe
operator|->
name|cqe
operator|)
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|htobe64
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|swsqe
operator|->
name|cqe
operator|)
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|htobe64
argument_list|(
operator|(
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|swsqe
operator|->
name|cqe
operator|)
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|cidx
operator|==
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
condition|)
name|cidx
operator|=
literal|0
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"SQ WQ: \n"
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|u64
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
operator|*
name|T4_SQ_NUM_SLOTS
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|T4_EQ_ENTRY_SIZE
operator|/
literal|16
condition|;
name|j
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%04u %016"
name|PRIx64
literal|" %016"
name|PRIx64
literal|" "
argument_list|,
name|i
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|0
operator|&&
name|i
operator|==
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|wq_pidx
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"<-- pidx"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
block|}
block|}
name|cidx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|cidx
expr_stmt|;
name|pidx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
expr_stmt|;
if|if
condition|(
name|cidx
operator|!=
name|pidx
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"RQ: \n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|cidx
operator|!=
name|pidx
condition|)
block|{
name|swrqe
operator|=
operator|&
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
index|[
name|cidx
index|]
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%04u: wr_id %016"
name|PRIx64
literal|"\n"
argument_list|,
name|cidx
argument_list|,
name|swrqe
operator|->
name|wr_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|cidx
operator|==
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
condition|)
name|cidx
operator|=
literal|0
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"RQ WQ: \n"
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|u64
operator|*
operator|)
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
operator|*
name|T4_RQ_NUM_SLOTS
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|T4_EQ_ENTRY_SIZE
operator|/
literal|16
condition|;
name|j
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%04u %016"
name|PRIx64
literal|" %016"
name|PRIx64
literal|" "
argument_list|,
name|i
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be64toh
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|0
operator|&&
name|i
operator|==
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"<-- pidx"
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|0
operator|&&
name|i
operator|==
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|cidx
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"<-- cidx"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|dump_state
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|c4iw_dev
modifier|*
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"STALL DETECTED:\n"
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|dev
argument_list|,
argument|&devices
argument_list|,
argument|list
argument_list|)
block|{
comment|//pthread_spin_lock(&dev->lock);
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Device %s\n"
argument_list|,
name|dev
operator|->
name|ibv_dev
operator|.
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|max_cq
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dev
operator|->
name|cqid2ptr
index|[
name|i
index|]
condition|)
block|{
name|struct
name|c4iw_cq
modifier|*
name|chp
init|=
name|dev
operator|->
name|cqid2ptr
index|[
name|i
index|]
decl_stmt|;
comment|//pthread_spin_lock(&chp->lock);
name|dump_cq
argument_list|(
name|chp
argument_list|)
expr_stmt|;
comment|//pthread_spin_unlock(&chp->lock);
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|max_qp
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dev
operator|->
name|qpid2ptr
index|[
name|i
index|]
condition|)
block|{
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|dev
operator|->
name|qpid2ptr
index|[
name|i
index|]
decl_stmt|;
comment|//pthread_spin_lock(&qhp->lock);
name|dump_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
comment|//pthread_spin_unlock(&qhp->lock);
block|}
block|}
comment|//pthread_spin_unlock(&dev->lock);
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"DUMP COMPLETE:\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* end of STALL_DETECTION */
end_comment

begin_comment
comment|/*  * c4iw_abi_version is used to store ABI for iw_cxgb4 so the user mode library  * can know if the driver supports the kernel mode db ringing.   */
end_comment

begin_decl_stmt
name|int
name|c4iw_abi_version
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|verbs_device
modifier|*
name|cxgb4_driver_init
parameter_list|(
specifier|const
name|char
modifier|*
name|uverbs_sys_path
parameter_list|,
name|int
name|abi_version
parameter_list|)
block|{
name|char
name|devstr
index|[
name|IBV_SYSFS_PATH_MAX
index|]
decl_stmt|,
name|ibdev
index|[
literal|16
index|]
decl_stmt|,
name|value
index|[
literal|32
index|]
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|struct
name|c4iw_dev
modifier|*
name|dev
decl_stmt|;
name|unsigned
name|vendor
decl_stmt|,
name|device
decl_stmt|,
name|fw_maj
decl_stmt|,
name|fw_min
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ibv_read_sysfs_file
argument_list|(
name|uverbs_sys_path
argument_list|,
literal|"device/vendor"
argument_list|,
name|value
argument_list|,
sizeof|sizeof
name|value
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|sscanf
argument_list|(
name|value
argument_list|,
literal|"%i"
argument_list|,
operator|&
name|vendor
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibv_read_sysfs_file
argument_list|(
name|uverbs_sys_path
argument_list|,
literal|"device/device"
argument_list|,
name|value
argument_list|,
sizeof|sizeof
name|value
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|sscanf
argument_list|(
name|value
argument_list|,
literal|"%i"
argument_list|,
operator|&
name|device
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
name|hca_table
operator|/
sizeof|sizeof
name|hca_table
index|[
literal|0
index|]
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|vendor
operator|==
name|hca_table
index|[
name|i
index|]
operator|.
name|vendor
operator|&&
name|device
operator|==
name|hca_table
index|[
name|i
index|]
operator|.
name|device
condition|)
goto|goto
name|found
goto|;
return|return
name|NULL
return|;
name|found
label|:
name|c4iw_abi_version
operator|=
name|abi_version
expr_stmt|;
comment|/* 	 * Verify that the firmware major number matches.  Major number 	 * mismatches are fatal.  Minor number mismatches are tolerated. 	 */
if|if
condition|(
name|ibv_read_sysfs_file
argument_list|(
name|uverbs_sys_path
argument_list|,
literal|"ibdev"
argument_list|,
name|ibdev
argument_list|,
sizeof|sizeof
name|ibdev
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|devstr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|devstr
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|devstr
argument_list|,
sizeof|sizeof
name|devstr
argument_list|,
literal|"%s/class/infiniband/%s"
argument_list|,
name|ibv_get_sysfs_path
argument_list|()
argument_list|,
name|ibdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibv_read_sysfs_file
argument_list|(
name|devstr
argument_list|,
literal|"fw_ver"
argument_list|,
name|value
argument_list|,
sizeof|sizeof
name|value
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|cp
operator|=
name|strtok
argument_list|(
name|value
operator|+
literal|1
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|"%i"
argument_list|,
operator|&
name|fw_maj
argument_list|)
expr_stmt|;
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|"%i"
argument_list|,
operator|&
name|fw_min
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|signed
name|int
operator|)
name|fw_maj
operator|<
name|FW_MAJ
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"libcxgb4: Fatal firmware version mismatch.  "
literal|"Firmware major number is %u and libcxgb4 needs %u.\n"
argument_list|,
name|fw_maj
argument_list|,
name|FW_MAJ
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|DBGLOG
argument_list|(
literal|"libcxgb4"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|signed
name|int
operator|)
name|fw_min
operator|<
name|FW_MIN
condition|)
block|{
name|PDBG
argument_list|(
literal|"libcxgb4: non-fatal firmware version mismatch.  "
literal|"Firmware minor number is %u and libcxgb4 needs %u.\n"
argument_list|,
name|fw_min
argument_list|,
name|FW_MIN
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
name|PDBG
argument_list|(
literal|"%s found vendor %d device %d type %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|vendor
argument_list|,
name|device
argument_list|,
name|CHELSIO_CHIP_VERSION
argument_list|(
name|hca_table
index|[
name|i
index|]
operator|.
name|device
operator|>>
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|pthread_spin_init
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|,
name|PTHREAD_PROCESS_PRIVATE
argument_list|)
expr_stmt|;
name|dev
operator|->
name|ibv_dev
operator|.
name|ops
operator|=
operator|&
name|c4iw_dev_ops
expr_stmt|;
name|dev
operator|->
name|chip_version
operator|=
name|CHELSIO_CHIP_VERSION
argument_list|(
name|hca_table
index|[
name|i
index|]
operator|.
name|device
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|dev
operator|->
name|abi_version
operator|=
name|abi_version
expr_stmt|;
name|PDBG
argument_list|(
literal|"%s device claimed\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|devices
argument_list|,
name|dev
argument_list|,
name|list
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|STALL_DETECTION
block|{
name|char
modifier|*
name|c
init|=
name|getenv
argument_list|(
literal|"CXGB4_STALL_TIMEOUT"
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
condition|)
block|{
name|stall_to
operator|=
name|strtol
argument_list|(
name|c
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|||
name|stall_to
operator|<
literal|0
condition|)
name|stall_to
operator|=
literal|0
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|{
name|char
modifier|*
name|c
init|=
name|getenv
argument_list|(
literal|"CXGB4_MA_WR"
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
condition|)
block|{
name|ma_wr
operator|=
name|strtol
argument_list|(
name|c
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ma_wr
operator|!=
literal|1
condition|)
name|ma_wr
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|{
name|char
modifier|*
name|c
init|=
name|getenv
argument_list|(
literal|"T5_ENABLE_WC"
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
condition|)
block|{
name|t5_en_wc
operator|=
name|strtol
argument_list|(
name|c
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|t5_en_wc
operator|!=
literal|1
condition|)
name|t5_en_wc
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
operator|&
name|dev
operator|->
name|ibv_dev
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|__attribute__
argument_list|(
argument|(constructor)
argument_list|)
name|void
name|cxgb4_register_driver
argument_list|(
argument|void
argument_list|)
block|{
name|c4iw_page_size
operator|=
name|sysconf
argument_list|(
name|_SC_PAGESIZE
argument_list|)
block|;
name|c4iw_page_shift
operator|=
name|long_log2
argument_list|(
name|c4iw_page_size
argument_list|)
block|;
name|c4iw_page_mask
operator|=
operator|~
operator|(
name|c4iw_page_size
operator|-
literal|1
operator|)
block|;
name|verbs_register_driver
argument_list|(
literal|"cxgb4"
argument_list|,
name|cxgb4_driver_init
argument_list|)
block|; }
ifdef|#
directive|ifdef
name|STATS
name|void
name|__attribute__
argument_list|(
argument|(destructor)
argument_list|)
name|cs_fini
argument_list|(
name|void
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|void
name|__attribute__
argument_list|(
operator|(
name|destructor
operator|)
argument_list|)
name|cs_fini
argument_list|(
name|void
argument_list|)
block|{
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"cxgb4 stats - sends %lu recv %lu read %lu "
literal|"write %lu arm %lu cqe %lu mr %lu qp %lu cq %lu\n"
argument_list|,
name|c4iw_stats
operator|.
name|send
argument_list|,
name|c4iw_stats
operator|.
name|recv
argument_list|,
name|c4iw_stats
operator|.
name|read
argument_list|,
name|c4iw_stats
operator|.
name|write
argument_list|,
name|c4iw_stats
operator|.
name|arm
argument_list|,
name|c4iw_stats
operator|.
name|cqe
argument_list|,
name|c4iw_stats
operator|.
name|mr
argument_list|,
name|c4iw_stats
operator|.
name|qp
argument_list|,
name|c4iw_stats
operator|.
name|cq
argument_list|)
expr_stmt|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


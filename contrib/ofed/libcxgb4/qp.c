begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006-2016 Chelsio, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"libcxgb4.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|STATS
end_ifdef

begin_decl_stmt
name|struct
name|c4iw_stats
name|c4iw_stats
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|copy_wr_to_sq
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|union
name|t4_wr
modifier|*
name|wqe
parameter_list|,
name|u8
name|len16
parameter_list|)
block|{
name|u64
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
name|src
operator|=
operator|(
name|u64
operator|*
operator|)
name|wqe
expr_stmt|;
name|dst
operator|=
operator|(
name|u64
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|wq
operator|->
name|sq
operator|.
name|queue
operator|+
name|wq
operator|->
name|sq
operator|.
name|wq_pidx
operator|*
name|T4_EQ_ENTRY_SIZE
operator|)
expr_stmt|;
if|if
condition|(
name|t4_sq_onchip
argument_list|(
name|wq
argument_list|)
condition|)
block|{
name|len16
operator|=
name|align
argument_list|(
name|len16
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* In onchip mode the copy below will be made to WC memory and 		 * could trigger DMA. In offchip mode the copy below only 		 * queues the WQE, DMA cannot start until t4_ring_sq_db 		 * happens */
name|mmio_wc_start
argument_list|()
expr_stmt|;
block|}
while|while
condition|(
name|len16
condition|)
block|{
operator|*
name|dst
operator|++
operator|=
operator|*
name|src
operator|++
expr_stmt|;
if|if
condition|(
name|dst
operator|==
operator|(
name|u64
operator|*
operator|)
operator|&
name|wq
operator|->
name|sq
operator|.
name|queue
index|[
name|wq
operator|->
name|sq
operator|.
name|size
index|]
condition|)
name|dst
operator|=
operator|(
name|u64
operator|*
operator|)
name|wq
operator|->
name|sq
operator|.
name|queue
expr_stmt|;
operator|*
name|dst
operator|++
operator|=
operator|*
name|src
operator|++
expr_stmt|;
if|if
condition|(
name|dst
operator|==
operator|(
name|u64
operator|*
operator|)
operator|&
name|wq
operator|->
name|sq
operator|.
name|queue
index|[
name|wq
operator|->
name|sq
operator|.
name|size
index|]
condition|)
name|dst
operator|=
operator|(
name|u64
operator|*
operator|)
name|wq
operator|->
name|sq
operator|.
name|queue
expr_stmt|;
name|len16
operator|--
expr_stmt|;
comment|/* NOTE len16 cannot be large enough to write to the 		   same sq.queue memory twice in this loop */
block|}
if|if
condition|(
name|t4_sq_onchip
argument_list|(
name|wq
argument_list|)
condition|)
name|mmio_flush_writes
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|copy_wr_to_rq
parameter_list|(
name|struct
name|t4_wq
modifier|*
name|wq
parameter_list|,
name|union
name|t4_recv_wr
modifier|*
name|wqe
parameter_list|,
name|u8
name|len16
parameter_list|)
block|{
name|u64
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
name|src
operator|=
operator|(
name|u64
operator|*
operator|)
name|wqe
expr_stmt|;
name|dst
operator|=
operator|(
name|u64
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|wq
operator|->
name|rq
operator|.
name|queue
operator|+
name|wq
operator|->
name|rq
operator|.
name|wq_pidx
operator|*
name|T4_EQ_ENTRY_SIZE
operator|)
expr_stmt|;
while|while
condition|(
name|len16
condition|)
block|{
operator|*
name|dst
operator|++
operator|=
operator|*
name|src
operator|++
expr_stmt|;
if|if
condition|(
name|dst
operator|>=
operator|(
name|u64
operator|*
operator|)
operator|&
name|wq
operator|->
name|rq
operator|.
name|queue
index|[
name|wq
operator|->
name|rq
operator|.
name|size
index|]
condition|)
name|dst
operator|=
operator|(
name|u64
operator|*
operator|)
name|wq
operator|->
name|rq
operator|.
name|queue
expr_stmt|;
operator|*
name|dst
operator|++
operator|=
operator|*
name|src
operator|++
expr_stmt|;
if|if
condition|(
name|dst
operator|>=
operator|(
name|u64
operator|*
operator|)
operator|&
name|wq
operator|->
name|rq
operator|.
name|queue
index|[
name|wq
operator|->
name|rq
operator|.
name|size
index|]
condition|)
name|dst
operator|=
operator|(
name|u64
operator|*
operator|)
name|wq
operator|->
name|rq
operator|.
name|queue
expr_stmt|;
name|len16
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|build_immd
parameter_list|(
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|,
name|struct
name|fw_ri_immd
modifier|*
name|immdp
parameter_list|,
name|struct
name|ibv_send_wr
modifier|*
name|wr
parameter_list|,
name|int
name|max
parameter_list|,
name|u32
modifier|*
name|plenp
parameter_list|)
block|{
name|u8
modifier|*
name|dstp
decl_stmt|,
modifier|*
name|srcp
decl_stmt|;
name|u32
name|plen
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|len
decl_stmt|;
name|dstp
operator|=
operator|(
name|u8
operator|*
operator|)
name|immdp
operator|->
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wr
operator|->
name|num_sge
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|plen
operator|+
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
operator|)
operator|>
name|max
condition|)
return|return
operator|-
name|EMSGSIZE
return|;
name|srcp
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
expr_stmt|;
name|plen
operator|+=
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
expr_stmt|;
name|len
operator|=
name|wr
operator|->
name|sg_list
index|[
name|i
index|]
operator|.
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|dstp
argument_list|,
name|srcp
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dstp
operator|+=
name|len
expr_stmt|;
name|srcp
operator|+=
name|len
expr_stmt|;
block|}
name|len
operator|=
name|ROUND_UP
argument_list|(
name|plen
operator|+
literal|8
argument_list|,
literal|16
argument_list|)
operator|-
operator|(
name|plen
operator|+
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|memset
argument_list|(
name|dstp
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|immdp
operator|->
name|op
operator|=
name|FW_RI_DATA_IMMD
expr_stmt|;
name|immdp
operator|->
name|r1
operator|=
literal|0
expr_stmt|;
name|immdp
operator|->
name|r2
operator|=
literal|0
expr_stmt|;
name|immdp
operator|->
name|immdlen
operator|=
name|htobe32
argument_list|(
name|plen
argument_list|)
expr_stmt|;
operator|*
name|plenp
operator|=
name|plen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_isgl
parameter_list|(
name|struct
name|fw_ri_isgl
modifier|*
name|isglp
parameter_list|,
name|struct
name|ibv_sge
modifier|*
name|sg_list
parameter_list|,
name|int
name|num_sge
parameter_list|,
name|u32
modifier|*
name|plenp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u32
name|plen
init|=
literal|0
decl_stmt|;
name|__be64
modifier|*
name|flitp
init|=
operator|(
name|__be64
operator|*
operator|)
name|isglp
operator|->
name|sge
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_sge
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|plen
operator|+
name|sg_list
index|[
name|i
index|]
operator|.
name|length
operator|)
operator|<
name|plen
condition|)
return|return
operator|-
name|EMSGSIZE
return|;
name|plen
operator|+=
name|sg_list
index|[
name|i
index|]
operator|.
name|length
expr_stmt|;
operator|*
name|flitp
operator|++
operator|=
name|htobe64
argument_list|(
operator|(
operator|(
name|u64
operator|)
name|sg_list
index|[
name|i
index|]
operator|.
name|lkey
operator|<<
literal|32
operator|)
operator||
name|sg_list
index|[
name|i
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
operator|*
name|flitp
operator|++
operator|=
name|htobe64
argument_list|(
name|sg_list
index|[
name|i
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
block|}
operator|*
name|flitp
operator|=
literal|0
expr_stmt|;
name|isglp
operator|->
name|op
operator|=
name|FW_RI_DATA_ISGL
expr_stmt|;
name|isglp
operator|->
name|r1
operator|=
literal|0
expr_stmt|;
name|isglp
operator|->
name|nsge
operator|=
name|htobe16
argument_list|(
name|num_sge
argument_list|)
expr_stmt|;
name|isglp
operator|->
name|r2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|plenp
condition|)
operator|*
name|plenp
operator|=
name|plen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_send
parameter_list|(
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|,
name|union
name|t4_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ibv_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
name|u32
name|plen
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T4_MAX_SEND_SGE
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IBV_SEND_SOLICITED
condition|)
name|wqe
operator|->
name|send
operator|.
name|sendop_pkd
operator|=
name|htobe32
argument_list|(
name|FW_RI_SEND_WR_SENDOP_V
argument_list|(
name|FW_RI_SEND_WITH_SE
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|wqe
operator|->
name|send
operator|.
name|sendop_pkd
operator|=
name|htobe32
argument_list|(
name|FW_RI_SEND_WR_SENDOP_V
argument_list|(
name|FW_RI_SEND
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|stag_inv
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|r3
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|r4
operator|=
literal|0
expr_stmt|;
name|plen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
condition|)
block|{
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IBV_SEND_INLINE
condition|)
block|{
name|ret
operator|=
name|build_immd
argument_list|(
name|sq
argument_list|,
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
argument_list|,
name|wr
argument_list|,
name|T4_MAX_SEND_INLINE
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|send
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_immd
argument_list|)
operator|+
name|plen
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|build_isgl
argument_list|(
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|isgl_src
argument_list|,
name|wr
operator|->
name|sg_list
argument_list|,
name|wr
operator|->
name|num_sge
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|send
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_isgl
argument_list|)
operator|+
name|wr
operator|->
name|num_sge
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_sge
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|op
operator|=
name|FW_RI_DATA_IMMD
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|r1
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|r2
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|immdlen
operator|=
literal|0
expr_stmt|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|send
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_immd
argument_list|)
expr_stmt|;
name|plen
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
name|size
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|send
operator|.
name|plen
operator|=
name|htobe32
argument_list|(
name|plen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_write
parameter_list|(
name|struct
name|t4_sq
modifier|*
name|sq
parameter_list|,
name|union
name|t4_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ibv_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
name|u32
name|plen
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T4_MAX_SEND_SGE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|wqe
operator|->
name|write
operator|.
name|r2
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|stag_sink
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|to_sink
operator|=
name|htobe64
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|num_sge
condition|)
block|{
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IBV_SEND_INLINE
condition|)
block|{
name|ret
operator|=
name|build_immd
argument_list|(
name|sq
argument_list|,
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
argument_list|,
name|wr
argument_list|,
name|T4_MAX_WRITE_INLINE
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|write
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_immd
argument_list|)
operator|+
name|plen
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|build_isgl
argument_list|(
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|isgl_src
argument_list|,
name|wr
operator|->
name|sg_list
argument_list|,
name|wr
operator|->
name|num_sge
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|write
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_isgl
argument_list|)
operator|+
name|wr
operator|->
name|num_sge
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_sge
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|op
operator|=
name|FW_RI_DATA_IMMD
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|r1
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|r2
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|u
operator|.
name|immd_src
index|[
literal|0
index|]
operator|.
name|immdlen
operator|=
literal|0
expr_stmt|;
name|size
operator|=
sizeof|sizeof
name|wqe
operator|->
name|write
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_immd
argument_list|)
expr_stmt|;
name|plen
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
name|size
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|write
operator|.
name|plen
operator|=
name|htobe32
argument_list|(
name|plen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_read
parameter_list|(
name|union
name|t4_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ibv_send_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
literal|1
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|wr
operator|->
name|num_sge
condition|)
block|{
name|wqe
operator|->
name|read
operator|.
name|stag_src
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_src_hi
operator|=
name|htobe32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_src_lo
operator|=
name|htobe32
argument_list|(
operator|(
name|u32
operator|)
name|wr
operator|->
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|stag_sink
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|lkey
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|plen
operator|=
name|htobe32
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_sink_hi
operator|=
name|htobe32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|addr
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_sink_lo
operator|=
name|htobe32
argument_list|(
call|(
name|u32
call|)
argument_list|(
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wqe
operator|->
name|read
operator|.
name|stag_src
operator|=
name|htobe32
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_src_hi
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_src_lo
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|stag_sink
operator|=
name|htobe32
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|plen
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_sink_hi
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|to_sink_lo
operator|=
literal|0
expr_stmt|;
block|}
name|wqe
operator|->
name|read
operator|.
name|r2
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|read
operator|.
name|r5
operator|=
literal|0
expr_stmt|;
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
name|wqe
operator|->
name|read
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_rdma_recv
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|union
name|t4_recv_wr
modifier|*
name|wqe
parameter_list|,
name|struct
name|ibv_recv_wr
modifier|*
name|wr
parameter_list|,
name|u8
modifier|*
name|len16
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|build_isgl
argument_list|(
operator|&
name|wqe
operator|->
name|recv
operator|.
name|isgl
argument_list|,
name|wr
operator|->
name|sg_list
argument_list|,
name|wr
operator|->
name|num_sge
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
operator|*
name|len16
operator|=
name|DIV_ROUND_UP
argument_list|(
sizeof|sizeof
name|wqe
operator|->
name|recv
operator|+
name|wr
operator|->
name|num_sge
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|fw_ri_sge
argument_list|)
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ring_kernel_db
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|,
name|u32
name|qid
parameter_list|,
name|u16
name|idx
parameter_list|)
block|{
name|struct
name|ibv_modify_qp
name|cmd
init|=
block|{}
decl_stmt|;
name|struct
name|ibv_qp_attr
name|attr
decl_stmt|;
name|int
name|mask
decl_stmt|;
name|int
name|__attribute__
argument_list|(
operator|(
name|unused
operator|)
argument_list|)
name|ret
decl_stmt|;
comment|/* FIXME: Why do we need this barrier if the kernel is going to 	   trigger the DMA? */
name|udma_to_device_barrier
argument_list|()
expr_stmt|;
if|if
condition|(
name|qid
operator|==
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
condition|)
block|{
name|attr
operator|.
name|sq_psn
operator|=
name|idx
expr_stmt|;
name|mask
operator|=
name|IBV_QP_SQ_PSN
expr_stmt|;
block|}
else|else
block|{
name|attr
operator|.
name|rq_psn
operator|=
name|idx
expr_stmt|;
name|mask
operator|=
name|IBV_QP_RQ_PSN
expr_stmt|;
block|}
name|ret
operator|=
name|ibv_cmd_modify_qp
argument_list|(
operator|&
name|qhp
operator|->
name|ibv_qp
argument_list|,
operator|&
name|attr
argument_list|,
name|mask
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|c4iw_post_send
parameter_list|(
name|struct
name|ibv_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ibv_send_wr
modifier|*
name|wr
parameter_list|,
name|struct
name|ibv_send_wr
modifier|*
modifier|*
name|bad_wr
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u8
name|len16
init|=
literal|0
decl_stmt|;
name|enum
name|fw_wr_opcodes
name|fw_opcode
decl_stmt|;
name|enum
name|fw_ri_wr_flags
name|fw_flags
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
decl_stmt|;
name|union
name|t4_wr
modifier|*
name|wqe
decl_stmt|,
name|lwqe
decl_stmt|;
name|u32
name|num_wrs
decl_stmt|;
name|struct
name|t4_swsqe
modifier|*
name|swsqe
decl_stmt|;
name|u16
name|idx
init|=
literal|0
decl_stmt|;
name|qhp
operator|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|t4_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
block|{
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|num_wrs
operator|=
name|t4_sq_avail
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_wrs
operator|==
literal|0
condition|)
block|{
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
while|while
condition|(
name|wr
condition|)
block|{
if|if
condition|(
name|num_wrs
operator|==
literal|0
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
break|break;
block|}
name|wqe
operator|=
operator|&
name|lwqe
expr_stmt|;
name|fw_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IBV_SEND_SOLICITED
condition|)
name|fw_flags
operator||=
name|FW_RI_SOLICITED_EVENT_FLAG
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IBV_SEND_SIGNALED
operator|||
name|qhp
operator|->
name|sq_sig_all
condition|)
name|fw_flags
operator||=
name|FW_RI_COMPLETION_FLAG
expr_stmt|;
name|swsqe
operator|=
operator|&
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|sw_sq
index|[
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
index|]
expr_stmt|;
switch|switch
condition|(
name|wr
operator|->
name|opcode
condition|)
block|{
case|case
name|IBV_WR_SEND
case|:
name|INC_STAT
argument_list|(
name|send
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|->
name|send_flags
operator|&
name|IBV_SEND_FENCE
condition|)
name|fw_flags
operator||=
name|FW_RI_READ_FENCE_FLAG
expr_stmt|;
name|fw_opcode
operator|=
name|FW_RI_SEND_WR
expr_stmt|;
name|swsqe
operator|->
name|opcode
operator|=
name|FW_RI_SEND
expr_stmt|;
name|err
operator|=
name|build_rdma_send
argument_list|(
operator|&
name|qhp
operator|->
name|wq
operator|.
name|sq
argument_list|,
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IBV_WR_RDMA_WRITE
case|:
name|INC_STAT
argument_list|(
name|write
argument_list|)
expr_stmt|;
name|fw_opcode
operator|=
name|FW_RI_RDMA_WRITE_WR
expr_stmt|;
name|swsqe
operator|->
name|opcode
operator|=
name|FW_RI_RDMA_WRITE
expr_stmt|;
name|err
operator|=
name|build_rdma_write
argument_list|(
operator|&
name|qhp
operator|->
name|wq
operator|.
name|sq
argument_list|,
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
break|break;
case|case
name|IBV_WR_RDMA_READ
case|:
name|INC_STAT
argument_list|(
name|read
argument_list|)
expr_stmt|;
name|fw_opcode
operator|=
name|FW_RI_RDMA_READ_WR
expr_stmt|;
name|swsqe
operator|->
name|opcode
operator|=
name|FW_RI_READ_REQ
expr_stmt|;
name|fw_flags
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|build_rdma_read
argument_list|(
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|swsqe
operator|->
name|read_len
operator|=
name|wr
operator|->
name|sg_list
condition|?
name|wr
operator|->
name|sg_list
index|[
literal|0
index|]
operator|.
name|length
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|oldest_read
condition|)
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|oldest_read
operator|=
name|swsqe
expr_stmt|;
break|break;
default|default:
name|PDBG
argument_list|(
literal|"%s post of type=%d TBD!\n"
argument_list|,
name|__func__
argument_list|,
name|wr
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
block|{
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
break|break;
block|}
name|swsqe
operator|->
name|idx
operator|=
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
expr_stmt|;
name|swsqe
operator|->
name|complete
operator|=
literal|0
expr_stmt|;
name|swsqe
operator|->
name|signaled
operator|=
operator|(
name|wr
operator|->
name|send_flags
operator|&
name|IBV_SEND_SIGNALED
operator|)
operator|||
name|qhp
operator|->
name|sq_sig_all
expr_stmt|;
name|swsqe
operator|->
name|flushed
operator|=
literal|0
expr_stmt|;
name|swsqe
operator|->
name|wr_id
operator|=
name|wr
operator|->
name|wr_id
expr_stmt|;
name|init_wr_hdr
argument_list|(
name|wqe
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
argument_list|,
name|fw_opcode
argument_list|,
name|fw_flags
argument_list|,
name|len16
argument_list|)
expr_stmt|;
name|PDBG
argument_list|(
literal|"%s cookie 0x%llx pidx 0x%x opcode 0x%x\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|wr
operator|->
name|wr_id
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|pidx
argument_list|,
name|swsqe
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|wr
operator|=
name|wr
operator|->
name|next
expr_stmt|;
name|num_wrs
operator|--
expr_stmt|;
name|copy_wr_to_sq
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|wqe
argument_list|,
name|len16
argument_list|)
expr_stmt|;
name|t4_sq_produce
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|len16
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|DIV_ROUND_UP
argument_list|(
name|len16
operator|*
literal|16
argument_list|,
name|T4_EQ_ENTRY_SIZE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t4_wq_db_enabled
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
block|{
name|t4_ring_sq_db
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|idx
argument_list|,
name|dev_is_t4
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|)
argument_list|,
name|len16
argument_list|,
name|wqe
argument_list|)
expr_stmt|;
block|}
else|else
name|ring_kernel_db
argument_list|(
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|qid
argument_list|,
name|idx
argument_list|)
expr_stmt|;
comment|/* This write is only for debugging, the value does not matter for DMA 	 */
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|queue
index|[
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|size
index|]
operator|.
name|status
operator|.
name|host_wq_pidx
operator|=
expr|\
operator|(
name|qhp
operator|->
name|wq
operator|.
name|sq
operator|.
name|wq_pidx
operator|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|c4iw_post_receive
parameter_list|(
name|struct
name|ibv_qp
modifier|*
name|ibqp
parameter_list|,
name|struct
name|ibv_recv_wr
modifier|*
name|wr
parameter_list|,
name|struct
name|ibv_recv_wr
modifier|*
modifier|*
name|bad_wr
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|c4iw_qp
modifier|*
name|qhp
decl_stmt|;
name|union
name|t4_recv_wr
modifier|*
name|wqe
decl_stmt|,
name|lwqe
decl_stmt|;
name|u32
name|num_wrs
decl_stmt|;
name|u8
name|len16
init|=
literal|0
decl_stmt|;
name|u16
name|idx
init|=
literal|0
decl_stmt|;
name|qhp
operator|=
name|to_c4iw_qp
argument_list|(
name|ibqp
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|t4_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
block|{
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|INC_STAT
argument_list|(
name|recv
argument_list|)
expr_stmt|;
name|num_wrs
operator|=
name|t4_rq_avail
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_wrs
operator|==
literal|0
condition|)
block|{
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
while|while
condition|(
name|wr
condition|)
block|{
if|if
condition|(
name|wr
operator|->
name|num_sge
operator|>
name|T4_MAX_RECV_SGE
condition|)
block|{
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
break|break;
block|}
name|wqe
operator|=
operator|&
name|lwqe
expr_stmt|;
if|if
condition|(
name|num_wrs
condition|)
name|err
operator|=
name|build_rdma_recv
argument_list|(
name|qhp
argument_list|,
name|wqe
argument_list|,
name|wr
argument_list|,
operator|&
name|len16
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
operator|*
name|bad_wr
operator|=
name|wr
expr_stmt|;
break|break;
block|}
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|sw_rq
index|[
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
index|]
operator|.
name|wr_id
operator|=
name|wr
operator|->
name|wr_id
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|opcode
operator|=
name|FW_RI_RECV_WR
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|r1
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|wrid
operator|=
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|r2
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|r2
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|r2
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|wqe
operator|->
name|recv
operator|.
name|len16
operator|=
name|len16
expr_stmt|;
name|PDBG
argument_list|(
literal|"%s cookie 0x%llx pidx %u\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|wr
operator|->
name|wr_id
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|pidx
argument_list|)
expr_stmt|;
name|copy_wr_to_rq
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|wqe
argument_list|,
name|len16
argument_list|)
expr_stmt|;
name|t4_rq_produce
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|len16
argument_list|)
expr_stmt|;
name|idx
operator|+=
name|DIV_ROUND_UP
argument_list|(
name|len16
operator|*
literal|16
argument_list|,
name|T4_EQ_ENTRY_SIZE
argument_list|)
expr_stmt|;
name|wr
operator|=
name|wr
operator|->
name|next
expr_stmt|;
name|num_wrs
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|t4_wq_db_enabled
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
name|t4_ring_rq_db
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
name|idx
argument_list|,
name|dev_is_t4
argument_list|(
name|qhp
operator|->
name|rhp
argument_list|)
argument_list|,
name|len16
argument_list|,
name|wqe
argument_list|)
expr_stmt|;
else|else
name|ring_kernel_db
argument_list|(
name|qhp
argument_list|,
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|qid
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|queue
index|[
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|size
index|]
operator|.
name|status
operator|.
name|host_wq_pidx
operator|=
expr|\
operator|(
name|qhp
operator|->
name|wq
operator|.
name|rq
operator|.
name|wq_pidx
operator|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_qp_state
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|)
block|{
name|struct
name|ibv_query_qp
name|cmd
decl_stmt|;
name|struct
name|ibv_qp_attr
name|attr
decl_stmt|;
name|struct
name|ibv_qp_init_attr
name|iattr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ibv_cmd_query_qp
argument_list|(
operator|&
name|qhp
operator|->
name|ibv_qp
argument_list|,
operator|&
name|attr
argument_list|,
name|IBV_QP_STATE
argument_list|,
operator|&
name|iattr
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
name|cmd
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|qhp
operator|->
name|ibv_qp
operator|.
name|state
operator|=
name|attr
operator|.
name|qp_state
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Assumes qhp lock is held.  */
end_comment

begin_function
name|void
name|c4iw_flush_qp
parameter_list|(
name|struct
name|c4iw_qp
modifier|*
name|qhp
parameter_list|)
block|{
name|struct
name|c4iw_cq
modifier|*
name|rchp
decl_stmt|,
modifier|*
name|schp
decl_stmt|;
name|int
name|count
decl_stmt|;
if|if
condition|(
name|qhp
operator|->
name|wq
operator|.
name|flushed
condition|)
return|return;
name|update_qp_state
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|rchp
operator|=
name|to_c4iw_cq
argument_list|(
name|qhp
operator|->
name|ibv_qp
operator|.
name|recv_cq
argument_list|)
expr_stmt|;
name|schp
operator|=
name|to_c4iw_cq
argument_list|(
name|qhp
operator|->
name|ibv_qp
operator|.
name|send_cq
argument_list|)
expr_stmt|;
name|PDBG
argument_list|(
literal|"%s qhp %p rchp %p schp %p\n"
argument_list|,
name|__func__
argument_list|,
name|qhp
argument_list|,
name|rchp
argument_list|,
name|schp
argument_list|)
expr_stmt|;
name|qhp
operator|->
name|wq
operator|.
name|flushed
operator|=
literal|1
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* locking heirarchy: cq lock first, then qp lock. */
name|pthread_spin_lock
argument_list|(
operator|&
name|rchp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|c4iw_flush_hw_cq
argument_list|(
name|rchp
argument_list|)
expr_stmt|;
name|c4iw_count_rcqes
argument_list|(
operator|&
name|rchp
operator|->
name|cq
argument_list|,
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|c4iw_flush_rq
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|,
operator|&
name|rchp
operator|->
name|cq
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|rchp
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* locking heirarchy: cq lock first, then qp lock. */
name|pthread_spin_lock
argument_list|(
operator|&
name|schp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|schp
operator|!=
name|rchp
condition|)
name|c4iw_flush_hw_cq
argument_list|(
name|schp
argument_list|)
expr_stmt|;
name|c4iw_flush_sq
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|schp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|c4iw_flush_qps
parameter_list|(
name|struct
name|c4iw_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|pthread_spin_lock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|max_qp
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|c4iw_qp
modifier|*
name|qhp
init|=
name|dev
operator|->
name|qpid2ptr
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|qhp
condition|)
block|{
if|if
condition|(
operator|!
name|qhp
operator|->
name|wq
operator|.
name|flushed
operator|&&
name|t4_wq_in_error
argument_list|(
operator|&
name|qhp
operator|->
name|wq
argument_list|)
condition|)
block|{
name|pthread_spin_lock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
name|c4iw_flush_qp
argument_list|(
name|qhp
argument_list|)
expr_stmt|;
name|pthread_spin_unlock
argument_list|(
operator|&
name|qhp
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|pthread_spin_unlock
argument_list|(
operator|&
name|dev
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006,2007 The Regents of the University of California.  * Copyright (c) 2004-2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2005 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * Produced at Lawrence Livermore National Laboratory.  * Written by Ira Weiny<weiny2@llnl.gov>.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/mad.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_log.h>
end_include

begin_include
include|#
directive|include
file|<vendor/osm_vendor_api.h>
end_include

begin_include
include|#
directive|include
file|<vendor/osm_vendor_sa_api.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_mad_pool.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_nodenamemap.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|"ibdiag_common.h"
end_include

begin_struct
struct|struct
name|query_cmd
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|alias
decl_stmt|;
name|ib_net16_t
name|query_type
decl_stmt|;
specifier|const
name|char
modifier|*
name|usage
decl_stmt|;
name|int
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_decl_stmt
name|char
modifier|*
name|argv0
init|=
literal|"saquery"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|node_name_map_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|nn_map_t
modifier|*
name|node_name_map
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ib_net64_t
name|smkey
init|=
name|OSM_DEFAULT_SA_KEY
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * Declare some globals because I don't want this to be too complex.  */
end_comment

begin_define
define|#
directive|define
name|MAX_PORTS
value|(8)
end_define

begin_define
define|#
directive|define
name|DEFAULT_SA_TIMEOUT_MS
value|(1000)
end_define

begin_decl_stmt
name|osmv_query_res_t
name|result
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|osm_log_t
name|log_osm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|osm_mad_pool_t
name|mad_pool
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|osm_vendor_t
modifier|*
name|vendor
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|osm_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|sa_timeout_ms
init|=
name|DEFAULT_SA_TIMEOUT_MS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|sa_hca_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|sa_port_num
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
block|{
name|ALL
block|,
name|LID_ONLY
block|,
name|UNIQUE_LID_ONLY
block|,
name|GUID_ONLY
block|,
name|ALL_DESC
block|,
name|NAME_OF_LID
block|,
name|NAME_OF_GUID
block|, }
name|node_print_desc
init|=
name|ALL
enum|;
end_enum

begin_decl_stmt
name|char
modifier|*
name|requested_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ib_net16_t
name|requested_lid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|requested_lid_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ib_net64_t
name|requested_guid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|requested_guid_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|format_buf
parameter_list|(
name|char
modifier|*
name|in
parameter_list|,
name|char
modifier|*
name|out
parameter_list|,
name|unsigned
name|size
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|-
literal|3
operator|&&
operator|*
name|in
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|out
operator|++
operator|=
operator|*
name|in
expr_stmt|;
if|if
condition|(
operator|*
name|in
operator|++
operator|==
literal|'\n'
operator|&&
operator|*
name|in
condition|)
block|{
operator|*
name|out
operator|++
operator|=
literal|'\t'
expr_stmt|;
operator|*
name|out
operator|++
operator|=
literal|'\t'
expr_stmt|;
block|}
block|}
operator|*
name|out
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Call back for the various record requests.  */
end_comment

begin_function
specifier|static
name|void
name|query_res_cb
parameter_list|(
name|osmv_query_res_t
modifier|*
name|res
parameter_list|)
block|{
name|result
operator|=
operator|*
name|res
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_node_desc
parameter_list|(
name|ib_node_record_t
modifier|*
name|node_record
parameter_list|)
block|{
name|ib_node_info_t
modifier|*
name|p_ni
init|=
operator|&
operator|(
name|node_record
operator|->
name|node_info
operator|)
decl_stmt|;
name|ib_node_desc_t
modifier|*
name|p_nd
init|=
operator|&
operator|(
name|node_record
operator|->
name|node_desc
operator|)
decl_stmt|;
if|if
condition|(
name|p_ni
operator|->
name|node_type
operator|==
name|IB_NODE_TYPE_CA
condition|)
block|{
name|printf
argument_list|(
literal|"%6d  \"%s\"\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|lid
argument_list|)
argument_list|,
name|clean_nodedesc
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_nd
operator|->
name|description
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_node_record
parameter_list|(
name|ib_node_record_t
modifier|*
name|node_record
parameter_list|)
block|{
name|ib_node_info_t
modifier|*
name|p_ni
init|=
name|NULL
decl_stmt|;
name|ib_node_desc_t
modifier|*
name|p_nd
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|p_ni
operator|=
operator|&
operator|(
name|node_record
operator|->
name|node_info
operator|)
expr_stmt|;
name|p_nd
operator|=
operator|&
operator|(
name|node_record
operator|->
name|node_desc
operator|)
expr_stmt|;
switch|switch
condition|(
name|node_print_desc
condition|)
block|{
case|case
name|LID_ONLY
case|:
case|case
name|UNIQUE_LID_ONLY
case|:
name|printf
argument_list|(
literal|"%d\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|lid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
case|case
name|GUID_ONLY
case|:
name|printf
argument_list|(
literal|"0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
case|case
name|NAME_OF_LID
case|:
case|case
name|NAME_OF_GUID
case|:
name|name
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|node_guid
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p_nd
operator|->
name|description
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return;
case|case
name|ALL
case|:
default|default:
break|break;
block|}
name|printf
argument_list|(
literal|"NodeRecord dump:\n"
literal|"\t\tlid.....................0x%X\n"
literal|"\t\treserved................0x%X\n"
literal|"\t\tbase_version............0x%X\n"
literal|"\t\tclass_version...........0x%X\n"
literal|"\t\tnode_type...............%s\n"
literal|"\t\tnum_ports...............0x%X\n"
literal|"\t\tsys_guid................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tnode_guid...............0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tport_guid...............0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tpartition_cap...........0x%X\n"
literal|"\t\tdevice_id...............0x%X\n"
literal|"\t\trevision................0x%X\n"
literal|"\t\tport_num................0x%X\n"
literal|"\t\tvendor_id...............0x%X\n"
literal|"\t\tNodeDescription.........%s\n"
literal|""
argument_list|,
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|resv
argument_list|)
argument_list|,
name|p_ni
operator|->
name|base_version
argument_list|,
name|p_ni
operator|->
name|class_version
argument_list|,
name|ib_get_node_type_str
argument_list|(
name|p_ni
operator|->
name|node_type
argument_list|)
argument_list|,
name|p_ni
operator|->
name|num_ports
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|sys_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|port_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_ni
operator|->
name|partition_cap
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_ni
operator|->
name|device_id
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_ni
operator|->
name|revision
argument_list|)
argument_list|,
name|ib_node_info_get_local_port_num
argument_list|(
name|p_ni
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_node_info_get_vendor_id
argument_list|(
name|p_ni
argument_list|)
argument_list|)
argument_list|,
name|clean_nodedesc
argument_list|(
operator|(
name|char
operator|*
operator|)
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_path_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|gid_str2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_path_rec_t
modifier|*
name|p_pr
init|=
name|data
decl_stmt|;
name|printf
argument_list|(
literal|"PathRecord dump:\n"
literal|"\t\tservice_id..............0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tdgid....................%s\n"
literal|"\t\tsgid....................%s\n"
literal|"\t\tdlid....................0x%X\n"
literal|"\t\tslid....................0x%X\n"
literal|"\t\thop_flow_raw............0x%X\n"
literal|"\t\ttclass..................0x%X\n"
literal|"\t\tnum_path_revers.........0x%X\n"
literal|"\t\tpkey....................0x%X\n"
literal|"\t\tqos_class...............0x%X\n"
literal|"\t\tsl......................0x%X\n"
literal|"\t\tmtu.....................0x%X\n"
literal|"\t\trate....................0x%X\n"
literal|"\t\tpkt_life................0x%X\n"
literal|"\t\tpreference..............0x%X\n"
literal|"\t\tresv2...................0x%X\n"
literal|"\t\tresv3...................0x%X\n"
literal|""
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_pr
operator|->
name|service_id
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_pr
operator|->
name|dgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_pr
operator|->
name|sgid
operator|.
name|raw
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pr
operator|->
name|dlid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pr
operator|->
name|slid
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_pr
operator|->
name|hop_flow_raw
argument_list|)
argument_list|,
name|p_pr
operator|->
name|tclass
argument_list|,
name|p_pr
operator|->
name|num_path
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pr
operator|->
name|pkey
argument_list|)
argument_list|,
name|ib_path_rec_qos_class
argument_list|(
name|p_pr
argument_list|)
argument_list|,
name|ib_path_rec_sl
argument_list|(
name|p_pr
argument_list|)
argument_list|,
name|p_pr
operator|->
name|mtu
argument_list|,
name|p_pr
operator|->
name|rate
argument_list|,
name|p_pr
operator|->
name|pkt_life
argument_list|,
name|p_pr
operator|->
name|preference
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|p_pr
operator|->
name|resv2
argument_list|,
operator|*
operator|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|p_pr
operator|->
name|resv2
operator|+
literal|2
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_class_port_info
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|gid_str2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_class_port_info_t
modifier|*
name|class_port_info
init|=
name|data
decl_stmt|;
name|printf
argument_list|(
literal|"SA ClassPortInfo:\n"
literal|"\t\tBase version.............%d\n"
literal|"\t\tClass version............%d\n"
literal|"\t\tCapability mask..........0x%04X\n"
literal|"\t\tCapability mask 2........0x%08X\n"
literal|"\t\tResponse time value......0x%02X\n"
literal|"\t\tRedirect GID.............%s\n"
literal|"\t\tRedirect TC/SL/FL........0x%08X\n"
literal|"\t\tRedirect LID.............0x%04X\n"
literal|"\t\tRedirect PKey............0x%04X\n"
literal|"\t\tRedirect QP..............0x%08X\n"
literal|"\t\tRedirect QKey............0x%08X\n"
literal|"\t\tTrap GID.................%s\n"
literal|"\t\tTrap TC/SL/FL............0x%08X\n"
literal|"\t\tTrap LID.................0x%04X\n"
literal|"\t\tTrap PKey................0x%04X\n"
literal|"\t\tTrap HL/QP...............0x%08X\n"
literal|"\t\tTrap QKey................0x%08X\n"
literal|""
argument_list|,
name|class_port_info
operator|->
name|base_ver
argument_list|,
name|class_port_info
operator|->
name|class_ver
argument_list|,
name|cl_ntoh16
argument_list|(
name|class_port_info
operator|->
name|cap_mask
argument_list|)
argument_list|,
name|ib_class_cap_mask2
argument_list|(
name|class_port_info
argument_list|)
argument_list|,
name|ib_class_resp_time_val
argument_list|(
name|class_port_info
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
operator|(
name|class_port_info
operator|->
name|redir_gid
operator|)
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|class_port_info
operator|->
name|redir_tc_sl_fl
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|class_port_info
operator|->
name|redir_lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|class_port_info
operator|->
name|redir_pkey
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|class_port_info
operator|->
name|redir_qp
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|class_port_info
operator|->
name|redir_qkey
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
operator|(
name|class_port_info
operator|->
name|trap_gid
operator|)
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|class_port_info
operator|->
name|trap_tc_sl_fl
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|class_port_info
operator|->
name|trap_lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|class_port_info
operator|->
name|trap_pkey
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|class_port_info
operator|->
name|trap_hop_qp
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|class_port_info
operator|->
name|trap_qkey
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_portinfo_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ib_portinfo_record_t
modifier|*
name|p_pir
init|=
name|data
decl_stmt|;
specifier|const
name|ib_port_info_t
modifier|*
specifier|const
name|p_pi
init|=
operator|&
name|p_pir
operator|->
name|port_info
decl_stmt|;
name|printf
argument_list|(
literal|"PortInfoRecord dump:\n"
literal|"\t\tEndPortLid..............0x%X\n"
literal|"\t\tPortNum.................0x%X\n"
literal|"\t\tbase_lid................0x%X\n"
literal|"\t\tmaster_sm_base_lid......0x%X\n"
literal|"\t\tcapability_mask.........0x%X\n"
literal|""
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pir
operator|->
name|lid
argument_list|)
argument_list|,
name|p_pir
operator|->
name|port_num
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pi
operator|->
name|base_lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pi
operator|->
name|master_sm_base_lid
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_pi
operator|->
name|capability_mask
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_portinfo_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|char
name|buf
index|[
literal|2048
index|]
decl_stmt|,
name|buf2
index|[
literal|4096
index|]
decl_stmt|;
name|ib_portinfo_record_t
modifier|*
name|pir
init|=
name|data
decl_stmt|;
name|ib_port_info_t
modifier|*
name|pi
init|=
operator|&
name|pir
operator|->
name|port_info
decl_stmt|;
name|mad_dump_portinfo
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|pi
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pi
argument_list|)
argument_list|)
expr_stmt|;
name|format_buf
argument_list|(
name|buf
argument_list|,
name|buf2
argument_list|,
sizeof|sizeof
argument_list|(
name|buf2
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PortInfoRecord dump:\n"
literal|"\tRID:\n"
literal|"\t\tEndPortLid..............%u\n"
literal|"\t\tPortNum.................0x%x\n"
literal|"\t\tReserved................0x%x\n"
literal|"\tPortInfo dump:\n\t\t%s"
argument_list|,
name|cl_ntoh16
argument_list|(
name|pir
operator|->
name|lid
argument_list|)
argument_list|,
name|pir
operator|->
name|port_num
argument_list|,
name|pir
operator|->
name|resv
argument_list|,
name|buf2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_multicast_group_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_member_rec_t
modifier|*
name|p_mcmr
init|=
name|data
decl_stmt|;
name|uint8_t
name|sl
decl_stmt|;
name|ib_member_get_sl_flow_hop
argument_list|(
name|p_mcmr
operator|->
name|sl_flow_hop
argument_list|,
operator|&
name|sl
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MCMemberRecord group dump:\n"
literal|"\t\tMGID....................%s\n"
literal|"\t\tMlid....................0x%X\n"
literal|"\t\tMtu.....................0x%X\n"
literal|"\t\tpkey....................0x%X\n"
literal|"\t\tRate....................0x%X\n"
literal|"\t\tSL......................0x%X\n"
literal|""
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mcmr
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mcmr
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_mcmr
operator|->
name|mtu
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mcmr
operator|->
name|pkey
argument_list|)
argument_list|,
name|p_mcmr
operator|->
name|rate
argument_list|,
name|sl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_multicast_member_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|gid_str2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_member_rec_t
modifier|*
name|p_mcmr
init|=
name|data
decl_stmt|;
name|uint16_t
name|mlid
init|=
name|cl_ntoh16
argument_list|(
name|p_mcmr
operator|->
name|mlid
argument_list|)
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|node_name
init|=
literal|"<unknown>"
decl_stmt|;
comment|/* go through the node records searching for a port guid which matches 	 * this port gid interface id. 	 * This gives us a node name to print, if available. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|result
operator|.
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|ib_node_record_t
modifier|*
name|nr
init|=
name|osmv_get_query_node_rec
argument_list|(
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|nr
operator|->
name|node_info
operator|.
name|port_guid
operator|==
name|p_mcmr
operator|->
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
condition|)
block|{
name|node_name
operator|=
name|clean_nodedesc
argument_list|(
operator|(
name|char
operator|*
operator|)
name|nr
operator|->
name|node_desc
operator|.
name|description
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|requested_name
condition|)
block|{
if|if
condition|(
name|strtol
argument_list|(
name|requested_name
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|==
name|mlid
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tPortGid.................%s (%s)\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mcmr
operator|->
name|port_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|node_name
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"MCMemberRecord member dump:\n"
literal|"\t\tMGID....................%s\n"
literal|"\t\tMlid....................0x%X\n"
literal|"\t\tPortGid.................%s\n"
literal|"\t\tScopeState..............0x%X\n"
literal|"\t\tProxyJoin...............0x%X\n"
literal|"\t\tNodeDescription.........%s\n"
literal|""
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mcmr
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mcmr
operator|->
name|mlid
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mcmr
operator|->
name|port_gid
operator|.
name|raw
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|p_mcmr
operator|->
name|scope_state
argument_list|,
name|p_mcmr
operator|->
name|proxy_join
argument_list|,
name|node_name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_service_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|buf_service_key
index|[
literal|35
index|]
decl_stmt|;
name|char
name|buf_service_name
index|[
literal|65
index|]
decl_stmt|;
name|ib_service_record_t
modifier|*
name|p_sr
init|=
name|data
decl_stmt|;
name|sprintf
argument_list|(
name|buf_service_key
argument_list|,
literal|"0x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x"
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|0
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|1
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|2
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|3
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|4
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|5
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|6
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|7
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|8
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|9
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|10
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|11
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|12
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|13
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|14
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|buf_service_name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p_sr
operator|->
name|service_name
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|buf_service_name
index|[
literal|64
index|]
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"ServiceRecord dump:\n"
literal|"\t\tServiceID...............0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tServiceGID..............%s\n"
literal|"\t\tServiceP_Key............0x%X\n"
literal|"\t\tServiceLease............0x%X\n"
literal|"\t\tServiceKey..............%s\n"
literal|"\t\tServiceName.............%s\n"
literal|"\t\tServiceData8.1..........0x%X\n"
literal|"\t\tServiceData8.2..........0x%X\n"
literal|"\t\tServiceData8.3..........0x%X\n"
literal|"\t\tServiceData8.4..........0x%X\n"
literal|"\t\tServiceData8.5..........0x%X\n"
literal|"\t\tServiceData8.6..........0x%X\n"
literal|"\t\tServiceData8.7..........0x%X\n"
literal|"\t\tServiceData8.8..........0x%X\n"
literal|"\t\tServiceData8.9..........0x%X\n"
literal|"\t\tServiceData8.10.........0x%X\n"
literal|"\t\tServiceData8.11.........0x%X\n"
literal|"\t\tServiceData8.12.........0x%X\n"
literal|"\t\tServiceData8.13.........0x%X\n"
literal|"\t\tServiceData8.14.........0x%X\n"
literal|"\t\tServiceData8.15.........0x%X\n"
literal|"\t\tServiceData8.16.........0x%X\n"
literal|"\t\tServiceData16.1.........0x%X\n"
literal|"\t\tServiceData16.2.........0x%X\n"
literal|"\t\tServiceData16.3.........0x%X\n"
literal|"\t\tServiceData16.4.........0x%X\n"
literal|"\t\tServiceData16.5.........0x%X\n"
literal|"\t\tServiceData16.6.........0x%X\n"
literal|"\t\tServiceData16.7.........0x%X\n"
literal|"\t\tServiceData16.8.........0x%X\n"
literal|"\t\tServiceData32.1.........0x%X\n"
literal|"\t\tServiceData32.2.........0x%X\n"
literal|"\t\tServiceData32.3.........0x%X\n"
literal|"\t\tServiceData32.4.........0x%X\n"
literal|"\t\tServiceData64.1.........0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tServiceData64.2.........0x%016"
name|PRIx64
literal|"\n"
literal|""
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_id
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_sr
operator|->
name|service_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_pkey
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_lease
argument_list|)
argument_list|,
name|buf_service_key
argument_list|,
name|buf_service_name
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|0
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|1
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|2
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|3
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|4
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|5
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|6
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|7
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|8
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|9
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|10
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|11
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|12
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|13
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|14
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|15
index|]
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|7
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_data64
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_data64
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_inform_info_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|gid_str2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_inform_info_record_t
modifier|*
name|p_iir
init|=
name|data
decl_stmt|;
name|uint32_t
name|qpn
decl_stmt|;
name|uint8_t
name|resp_time_val
decl_stmt|;
name|ib_inform_info_get_qpn_resp_time
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|qpn_resp_time_val
argument_list|,
operator|&
name|qpn
argument_list|,
operator|&
name|resp_time_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_iir
operator|->
name|inform_info
operator|.
name|is_generic
condition|)
block|{
name|printf
argument_list|(
literal|"InformInfoRecord dump:\n"
literal|"\t\tRID\n"
literal|"\t\tSubscriberGID...........%s\n"
literal|"\t\tSubscriberEnum..........0x%X\n"
literal|"\t\tInformInfo dump:\n"
literal|"\t\tgid.....................%s\n"
literal|"\t\tlid_range_begin.........0x%X\n"
literal|"\t\tlid_range_end...........0x%X\n"
literal|"\t\tis_generic..............0x%X\n"
literal|"\t\tsubscribe...............0x%X\n"
literal|"\t\ttrap_type...............0x%X\n"
literal|"\t\ttrap_num................%u\n"
literal|"\t\tqpn.....................0x%06X\n"
literal|"\t\tresp_time_val...........0x%X\n"
literal|"\t\tnode_type...............0x%06X\n"
literal|""
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_iir
operator|->
name|subscriber_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|subscriber_enum
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|gid
operator|.
name|raw
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_begin
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_end
argument_list|)
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|is_generic
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|subscribe
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|trap_type
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|qpn
argument_list|)
argument_list|,
name|resp_time_val
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_inform_info_get_prod_type
argument_list|(
operator|&
name|p_iir
operator|->
name|inform_info
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"InformInfoRecord dump:\n"
literal|"\t\tRID\n"
literal|"\t\tSubscriberGID...........%s\n"
literal|"\t\tSubscriberEnum..........0x%X\n"
literal|"\t\tInformInfo dump:\n"
literal|"\t\tgid.....................%s\n"
literal|"\t\tlid_range_begin.........0x%X\n"
literal|"\t\tlid_range_end...........0x%X\n"
literal|"\t\tis_generic..............0x%X\n"
literal|"\t\tsubscribe...............0x%X\n"
literal|"\t\ttrap_type...............0x%X\n"
literal|"\t\tdev_id..................0x%X\n"
literal|"\t\tqpn.....................0x%06X\n"
literal|"\t\tresp_time_val...........0x%X\n"
literal|"\t\tvendor_id...............0x%06X\n"
literal|""
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_iir
operator|->
name|subscriber_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|subscriber_enum
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|gid
operator|.
name|raw
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_begin
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_end
argument_list|)
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|is_generic
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|subscribe
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|trap_type
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|dev_id
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|qpn
argument_list|)
argument_list|,
name|resp_time_val
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_inform_info_get_prod_type
argument_list|(
operator|&
name|p_iir
operator|->
name|inform_info
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_link_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ib_link_record_t
modifier|*
name|lr
init|=
name|data
decl_stmt|;
name|printf
argument_list|(
literal|"LinkRecord dump:\n"
literal|"\t\tFromLID....................%u\n"
literal|"\t\tFromPort...................%u\n"
literal|"\t\tToPort.....................%u\n"
literal|"\t\tToLID......................%u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lr
operator|->
name|from_lid
argument_list|)
argument_list|,
name|lr
operator|->
name|from_port_num
argument_list|,
name|lr
operator|->
name|to_port_num
argument_list|,
name|cl_ntoh16
argument_list|(
name|lr
operator|->
name|to_lid
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_slvl_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ib_slvl_table_record_t
modifier|*
name|slvl
init|=
name|data
decl_stmt|;
name|ib_slvl_table_t
modifier|*
name|t
init|=
operator|&
name|slvl
operator|->
name|slvl_tbl
decl_stmt|;
name|printf
argument_list|(
literal|"SL2VLTableRecord dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tInPort.....................%u\n"
literal|"\t\tOutPort....................%u\n"
literal|"\t\tSL: 0| 1| 2| 3| 4| 5| 6| 7| 8| 9|10|11|12|13|14|15|\n"
literal|"\t\tVL:%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u"
literal|"|%2u|%2u|%2u|\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|slvl
operator|->
name|lid
argument_list|)
argument_list|,
name|slvl
operator|->
name|in_port_num
argument_list|,
name|slvl
operator|->
name|out_port_num
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|3
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|4
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|5
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|6
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|7
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|8
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|9
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|10
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|11
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|12
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|13
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|14
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|15
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_vlarb_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ib_vl_arb_table_record_t
modifier|*
name|vlarb
init|=
name|data
decl_stmt|;
name|ib_vl_arb_element_t
modifier|*
name|e
init|=
name|vlarb
operator|->
name|vl_arb_tbl
operator|.
name|vl_entry
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"VLArbTableRecord dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tPort.......................%u\n"
literal|"\t\tBlock......................%u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|vlarb
operator|->
name|lid
argument_list|)
argument_list|,
name|vlarb
operator|->
name|port_num
argument_list|,
name|vlarb
operator|->
name|block_num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|+=
literal|16
control|)
block|{
name|printf
argument_list|(
literal|"\t\tVL    :%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|"
literal|"%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|"
argument_list|,
name|e
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|2
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|3
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|4
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|5
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|6
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|7
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|8
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|9
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|10
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|11
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|12
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|13
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|14
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|15
index|]
operator|.
name|vl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t\tWeight:%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|"
literal|"%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|"
argument_list|,
name|e
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|2
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|3
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|4
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|5
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|6
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|7
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|8
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|9
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|10
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|11
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|12
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|13
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|14
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|15
index|]
operator|.
name|weight
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_pkey_tbl_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ib_pkey_table_record_t
modifier|*
name|pktr
init|=
name|data
decl_stmt|;
name|ib_net16_t
modifier|*
name|p
init|=
name|pktr
operator|->
name|pkey_tbl
operator|.
name|pkey_entry
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"PKeyTableRecord dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tPort.......................%u\n"
literal|"\t\tBlock......................%u\n"
literal|"\t\tPKey Table:\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|pktr
operator|->
name|lid
argument_list|)
argument_list|,
name|pktr
operator|->
name|port_num
argument_list|,
name|pktr
operator|->
name|block_num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|+=
literal|8
control|)
name|printf
argument_list|(
literal|"\t\t0x%04x 0x%04x 0x%04x 0x%04x"
literal|" 0x%04x 0x%04x 0x%04x 0x%04x\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|4
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|5
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|6
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_lft_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ib_lft_record_t
modifier|*
name|lftr
init|=
name|data
decl_stmt|;
name|unsigned
name|block
init|=
name|cl_ntoh16
argument_list|(
name|lftr
operator|->
name|block_num
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"LFT Record dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tBlock......................%u\n"
literal|"\t\tLFT:\n\t\tLID\tPort Number\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lftr
operator|->
name|lid
argument_list|)
argument_list|,
name|block
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"\t\t%u\t%u\n"
argument_list|,
name|block
operator|*
literal|64
operator|+
name|i
argument_list|,
name|lftr
operator|->
name|lft
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_mft_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ib_mft_record_t
modifier|*
name|mftr
init|=
name|data
decl_stmt|;
name|unsigned
name|position
init|=
name|cl_ntoh16
argument_list|(
name|mftr
operator|->
name|position_block_num
argument_list|)
operator|>>
literal|12
decl_stmt|;
name|unsigned
name|block
init|=
name|cl_ntoh16
argument_list|(
name|mftr
operator|->
name|position_block_num
argument_list|)
operator|&
name|IB_MCAST_BLOCK_ID_MASK_HO
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"MFT Record dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tPosition...................%u\n"
literal|"\t\tBlock......................%u\n"
literal|"\t\tMFT:\n\t\tMLID\tPort Mask\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|mftr
operator|->
name|lid
argument_list|)
argument_list|,
name|position
argument_list|,
name|block
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IB_MCAST_BLOCK_SIZE
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"\t\t0x%x\t0x%x\n"
argument_list|,
name|IB_LID_MCAST_START_HO
operator|+
name|block
operator|*
literal|64
operator|+
name|i
argument_list|,
name|cl_ntoh16
argument_list|(
name|mftr
operator|->
name|mft
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_results
parameter_list|(
name|osmv_query_res_t
modifier|*
name|r
parameter_list|,
name|void
function_decl|(
modifier|*
name|dump_func
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|r
operator|->
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|void
modifier|*
name|data
init|=
name|osmv_get_query_result
argument_list|(
name|r
operator|->
name|p_result_madw
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|dump_func
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|return_mad
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|mad_pool
argument_list|,
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * Get any record(s)  */
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|get_any_records
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|,
name|ib_net16_t
name|attr_id
parameter_list|,
name|ib_net32_t
name|attr_mod
parameter_list|,
name|ib_net64_t
name|comp_mask
parameter_list|,
name|void
modifier|*
name|attr
parameter_list|,
name|ib_net16_t
name|attr_offset
parameter_list|,
name|ib_net64_t
name|sm_key
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|attr_id
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|attr_offset
expr_stmt|;
name|user
operator|.
name|attr_mod
operator|=
name|attr_mod
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|comp_mask
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
name|attr
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|sa_timeout_ms
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
literal|1
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
name|sm_key
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|h
argument_list|,
operator|&
name|req
argument_list|)
operator|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Query SA failed: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|result
operator|.
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Query result returned: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|result
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|result
operator|.
name|status
return|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * Get all the records available for requested query type.  */
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|get_all_records
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|,
name|ib_net16_t
name|query_id
parameter_list|,
name|ib_net16_t
name|attr_offset
parameter_list|,
name|int
name|trusted
parameter_list|)
block|{
return|return
name|get_any_records
argument_list|(
name|h
argument_list|,
name|query_id
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|attr_offset
argument_list|,
name|trusted
condition|?
name|smkey
else|:
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * return the lid from the node descriptor (name) supplied  */
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|get_lid_from_name
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|ib_net16_t
modifier|*
name|lid
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|ib_node_record_t
modifier|*
name|node_record
init|=
name|NULL
decl_stmt|;
name|ib_node_info_t
modifier|*
name|p_ni
init|=
name|NULL
decl_stmt|;
name|ib_net16_t
name|attr_offset
init|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|node_record
argument_list|)
argument_list|)
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|status
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_NODE_RECORD
argument_list|,
name|attr_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|result
operator|.
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|node_record
operator|=
name|osmv_get_query_node_rec
argument_list|(
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|p_ni
operator|=
operator|&
operator|(
name|node_record
operator|->
name|node_info
operator|)
expr_stmt|;
if|if
condition|(
name|name
operator|&&
name|strncmp
argument_list|(
name|name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|,
sizeof|sizeof
argument_list|(
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|lid
operator|=
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|lid
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_net16_t
name|get_lid
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|ib_net16_t
name|rc_lid
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|name
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|isalpha
argument_list|(
name|name
index|[
literal|0
index|]
argument_list|)
condition|)
name|assert
argument_list|(
name|get_lid_from_name
argument_list|(
name|h
argument_list|,
name|name
argument_list|,
operator|&
name|rc_lid
argument_list|)
operator|==
name|IB_SUCCESS
argument_list|)
expr_stmt|;
else|else
name|rc_lid
operator|=
name|atoi
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc_lid
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to find lid for \"%s\"\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc_lid
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_lid_and_ports
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|int
modifier|*
name|lid
parameter_list|,
name|int
modifier|*
name|port1
parameter_list|,
name|int
modifier|*
name|port2
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|e
decl_stmt|;
if|if
condition|(
name|port1
condition|)
operator|*
name|port1
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|port2
condition|)
operator|*
name|port2
operator|=
operator|-
literal|1
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|lid
condition|)
operator|*
name|lid
operator|=
name|get_lid
argument_list|(
name|h
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return
literal|0
return|;
name|str
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|port1
condition|)
block|{
operator|*
name|port1
operator|=
name|strtoul
argument_list|(
name|str
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|str
condition|)
operator|*
name|port1
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p
condition|)
return|return
literal|0
return|;
name|str
operator|=
name|p
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|port2
condition|)
block|{
operator|*
name|port2
operator|=
name|strtoul
argument_list|(
name|str
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|str
condition|)
operator|*
name|port2
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Get the portinfo records available with IsSM or IsSMdisabled CapabilityMask bit on.  */
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|get_issm_records
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|,
name|ib_net32_t
name|capability_mask
parameter_list|)
block|{
name|ib_portinfo_record_t
name|attr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|.
name|port_info
operator|.
name|capability_mask
operator|=
name|capability_mask
expr_stmt|;
return|return
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_PORTINFO_RECORD
argument_list|,
name|cl_hton32
argument_list|(
literal|1
operator|<<
literal|31
argument_list|)
argument_list|,
name|IB_PIR_COMPMASK_CAPMASK
argument_list|,
operator|&
name|attr
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_portinfo_record_t
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|print_node_records
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|ib_node_record_t
modifier|*
name|node_record
init|=
name|NULL
decl_stmt|;
name|ib_net16_t
name|attr_offset
init|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|node_record
argument_list|)
argument_list|)
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|status
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_NODE_RECORD
argument_list|,
name|attr_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
if|if
condition|(
name|node_print_desc
operator|==
name|ALL_DESC
condition|)
block|{
name|printf
argument_list|(
literal|"   LID \"name\"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"================\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|result
operator|.
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|node_record
operator|=
name|osmv_get_query_node_rec
argument_list|(
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|node_print_desc
operator|==
name|ALL_DESC
condition|)
block|{
name|print_node_desc
argument_list|(
name|node_record
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_LID
condition|)
block|{
if|if
condition|(
name|requested_lid
operator|==
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|lid
argument_list|)
condition|)
block|{
name|print_node_record
argument_list|(
name|node_record
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_GUID
condition|)
block|{
name|ib_node_info_t
modifier|*
name|p_ni
init|=
operator|&
operator|(
name|node_record
operator|->
name|node_info
operator|)
decl_stmt|;
if|if
condition|(
name|requested_guid
operator|==
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|port_guid
argument_list|)
condition|)
block|{
name|print_node_record
argument_list|(
name|node_record
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|requested_name
operator|||
operator|(
name|strncmp
argument_list|(
name|requested_name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|,
sizeof|sizeof
argument_list|(
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|print_node_record
argument_list|(
name|node_record
argument_list|)
expr_stmt|;
if|if
condition|(
name|node_print_desc
operator|==
name|UNIQUE_LID_ONLY
condition|)
block|{
name|return_mad
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|get_print_path_rec_lid
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|,
name|ib_net16_t
name|src_lid
parameter_list|,
name|ib_net16_t
name|dst_lid
parameter_list|)
block|{
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_lid_pair_t
name|lid_pair
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|lid_pair
operator|.
name|src_lid
operator|=
name|cl_hton16
argument_list|(
name|src_lid
argument_list|)
expr_stmt|;
name|lid_pair
operator|.
name|dest_lid
operator|=
name|cl_hton16
argument_list|(
name|dst_lid
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_PATH_REC_BY_LIDS
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|sa_timeout_ms
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
literal|1
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|(
name|void
operator|*
operator|)
operator|&
name|lid_pair
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|h
argument_list|,
operator|&
name|req
argument_list|)
operator|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Query SA failed: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|.
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Query result returned: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|result
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|.
name|status
operator|)
return|;
block|}
name|status
operator|=
name|result
operator|.
name|status
expr_stmt|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_path_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|get_print_path_rec_gid
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|,
specifier|const
name|ib_gid_t
modifier|*
name|src_gid
parameter_list|,
specifier|const
name|ib_gid_t
modifier|*
name|dst_gid
parameter_list|)
block|{
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_gid_pair_t
name|gid_pair
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|gid_pair
operator|.
name|src_gid
operator|=
operator|*
name|src_gid
expr_stmt|;
name|gid_pair
operator|.
name|dest_gid
operator|=
operator|*
name|dst_gid
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_PATH_REC_BY_GIDS
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|sa_timeout_ms
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
literal|1
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|(
name|void
operator|*
operator|)
operator|&
name|gid_pair
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|h
argument_list|,
operator|&
name|req
argument_list|)
operator|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Query SA failed: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|.
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Query result returned: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|result
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|.
name|status
operator|)
return|;
block|}
name|status
operator|=
name|result
operator|.
name|status
expr_stmt|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_path_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|get_print_class_port_info
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|)
block|{
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_CLASS_PORT_INFO
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|sa_timeout_ms
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
literal|1
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|h
argument_list|,
operator|&
name|req
argument_list|)
operator|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Query SA failed: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
if|if
condition|(
name|result
operator|.
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Query result returned: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|result
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|.
name|status
operator|)
return|;
block|}
name|status
operator|=
name|result
operator|.
name|status
expr_stmt|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_class_port_info
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_path_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_net16_t
name|attr_offset
init|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_path_rec_t
argument_list|)
argument_list|)
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|status
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_PATH_RECORD
argument_list|,
name|attr_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_path_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|print_issm_records
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
comment|/* First, get IsSM records */
name|status
operator|=
name|get_issm_records
argument_list|(
name|h
argument_list|,
name|IB_PORT_CAP_IS_SM
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|printf
argument_list|(
literal|"IsSM ports\n"
argument_list|)
expr_stmt|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_portinfo_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
comment|/* Now, get IsSMdisabled records */
name|status
operator|=
name|get_issm_records
argument_list|(
name|h
argument_list|,
name|IB_PORT_CAP_SM_DISAB
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|printf
argument_list|(
literal|"\nIsSMdisabled ports\n"
argument_list|)
expr_stmt|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_portinfo_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|print_multicast_member_records
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|)
block|{
name|osmv_query_res_t
name|mc_group_result
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|status
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_MCMEMBER_RECORD
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_member_rec_t
argument_list|)
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|mc_group_result
operator|=
name|result
expr_stmt|;
name|status
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_NODE_RECORD
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_node_record_t
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|return_mc
goto|;
name|dump_results
argument_list|(
operator|&
name|mc_group_result
argument_list|,
name|dump_multicast_member_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
name|return_mc
label|:
comment|/* return_mad for the mc_group_result */
if|if
condition|(
name|mc_group_result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|mad_pool
argument_list|,
name|mc_group_result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|mc_group_result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|print_multicast_group_records
parameter_list|(
name|osm_bind_handle_t
name|h
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
name|status
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_MCMEMBER_RECORD
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_member_rec_t
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_multicast_group_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_class_port_info
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
return|return
name|get_print_class_port_info
argument_list|(
name|h
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_node_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
return|return
name|print_node_records
argument_list|(
name|h
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_portinfo_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_portinfo_record_t
name|pir
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|port
init|=
operator|-
literal|1
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|port
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pir
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pir
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lid
operator|>
literal|0
condition|)
block|{
name|pir
operator|.
name|lid
operator|=
name|cl_hton16
argument_list|(
name|lid
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_PIR_COMPMASK_LID
expr_stmt|;
block|}
if|if
condition|(
name|port
operator|>=
literal|0
condition|)
block|{
name|pir
operator|.
name|port_num
operator|=
name|cl_hton16
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_PIR_COMPMASK_PORTNUM
expr_stmt|;
block|}
name|status
operator|=
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_PORTINFO_RECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|pir
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|pir
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
name|status
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_one_portinfo_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_mcmember_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
return|return
name|print_multicast_member_records
argument_list|(
name|h
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_service_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_net16_t
name|attr_offset
init|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_service_record_t
argument_list|)
argument_list|)
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|status
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_SERVICE_RECORD
argument_list|,
name|attr_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_service_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_informinfo_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_net16_t
name|attr_offset
init|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_inform_info_record_t
argument_list|)
argument_list|)
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|status
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
argument_list|,
name|attr_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_inform_info_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_link_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_link_record_t
name|lr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|from_lid
init|=
literal|0
decl_stmt|,
name|to_lid
init|=
literal|0
decl_stmt|,
name|from_port
init|=
operator|-
literal|1
decl_stmt|,
name|to_port
init|=
operator|-
literal|1
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|from_lid
argument_list|,
operator|&
name|from_port
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|to_lid
argument_list|,
operator|&
name|to_port
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|lr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|lr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|from_lid
operator|>
literal|0
condition|)
block|{
name|lr
operator|.
name|from_lid
operator|=
name|cl_hton16
argument_list|(
name|from_lid
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_LR_COMPMASK_FROM_LID
expr_stmt|;
block|}
if|if
condition|(
name|from_port
operator|>=
literal|0
condition|)
block|{
name|lr
operator|.
name|from_port_num
operator|=
name|from_port
expr_stmt|;
name|comp_mask
operator||=
name|IB_LR_COMPMASK_FROM_PORT
expr_stmt|;
block|}
if|if
condition|(
name|to_lid
operator|>
literal|0
condition|)
block|{
name|lr
operator|.
name|to_lid
operator|=
name|cl_hton16
argument_list|(
name|to_lid
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_LR_COMPMASK_TO_LID
expr_stmt|;
block|}
if|if
condition|(
name|to_port
operator|>=
literal|0
condition|)
block|{
name|lr
operator|.
name|to_port_num
operator|=
name|to_port
expr_stmt|;
name|comp_mask
operator||=
name|IB_LR_COMPMASK_TO_PORT
expr_stmt|;
block|}
name|status
operator|=
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_LINK_RECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|lr
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|lr
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
name|status
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_one_link_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_sl2vl_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_slvl_table_record_t
name|slvl
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|in_port
init|=
operator|-
literal|1
decl_stmt|,
name|out_port
init|=
operator|-
literal|1
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|in_port
argument_list|,
operator|&
name|out_port
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|slvl
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|slvl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lid
operator|>
literal|0
condition|)
block|{
name|slvl
operator|.
name|lid
operator|=
name|cl_hton16
argument_list|(
name|lid
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_SLVL_COMPMASK_LID
expr_stmt|;
block|}
if|if
condition|(
name|in_port
operator|>=
literal|0
condition|)
block|{
name|slvl
operator|.
name|in_port_num
operator|=
name|in_port
expr_stmt|;
name|comp_mask
operator||=
name|IB_SLVL_COMPMASK_IN_PORT
expr_stmt|;
block|}
if|if
condition|(
name|out_port
operator|>=
literal|0
condition|)
block|{
name|slvl
operator|.
name|out_port_num
operator|=
name|out_port
expr_stmt|;
name|comp_mask
operator||=
name|IB_SLVL_COMPMASK_OUT_PORT
expr_stmt|;
block|}
name|status
operator|=
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_SLVL_RECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|slvl
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|slvl
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
name|status
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_one_slvl_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_vlarb_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_vl_arb_table_record_t
name|vlarb
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|port
init|=
operator|-
literal|1
decl_stmt|,
name|block
init|=
operator|-
literal|1
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|block
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|vlarb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|vlarb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lid
operator|>
literal|0
condition|)
block|{
name|vlarb
operator|.
name|lid
operator|=
name|cl_hton16
argument_list|(
name|lid
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_VLA_COMPMASK_LID
expr_stmt|;
block|}
if|if
condition|(
name|port
operator|>=
literal|0
condition|)
block|{
name|vlarb
operator|.
name|port_num
operator|=
name|port
expr_stmt|;
name|comp_mask
operator||=
name|IB_VLA_COMPMASK_OUT_PORT
expr_stmt|;
block|}
if|if
condition|(
name|block
operator|>=
literal|0
condition|)
block|{
name|vlarb
operator|.
name|block_num
operator|=
name|block
expr_stmt|;
name|comp_mask
operator||=
name|IB_VLA_COMPMASK_BLOCK
expr_stmt|;
block|}
name|status
operator|=
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_VLARB_RECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|vlarb
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|vlarb
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
name|status
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_one_vlarb_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_pkey_tbl_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_pkey_table_record_t
name|pktr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|port
init|=
operator|-
literal|1
decl_stmt|,
name|block
init|=
operator|-
literal|1
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|block
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pktr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pktr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lid
operator|>
literal|0
condition|)
block|{
name|pktr
operator|.
name|lid
operator|=
name|cl_hton16
argument_list|(
name|lid
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_PKEY_COMPMASK_LID
expr_stmt|;
block|}
if|if
condition|(
name|port
operator|>=
literal|0
condition|)
block|{
name|pktr
operator|.
name|port_num
operator|=
name|port
expr_stmt|;
name|comp_mask
operator||=
name|IB_PKEY_COMPMASK_PORT
expr_stmt|;
block|}
if|if
condition|(
name|block
operator|>=
literal|0
condition|)
block|{
name|pktr
operator|.
name|block_num
operator|=
name|block
expr_stmt|;
name|comp_mask
operator||=
name|IB_PKEY_COMPMASK_BLOCK
expr_stmt|;
block|}
name|status
operator|=
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_PKEY_TBL_RECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|pktr
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|pktr
argument_list|)
argument_list|)
argument_list|,
name|smkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
name|status
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_one_pkey_tbl_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_lft_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_lft_record_t
name|lftr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|block
init|=
operator|-
literal|1
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|block
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|lftr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|lftr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lid
operator|>
literal|0
condition|)
block|{
name|lftr
operator|.
name|lid
operator|=
name|cl_hton16
argument_list|(
name|lid
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_LFTR_COMPMASK_LID
expr_stmt|;
block|}
if|if
condition|(
name|block
operator|>=
literal|0
condition|)
block|{
name|lftr
operator|.
name|block_num
operator|=
name|cl_hton16
argument_list|(
name|block
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_LFTR_COMPMASK_BLOCK
expr_stmt|;
block|}
name|status
operator|=
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_LFT_RECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|lftr
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|lftr
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
name|status
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_one_lft_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_mft_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|osm_bind_handle_t
name|h
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_mft_record_t
name|mftr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|block
init|=
operator|-
literal|1
decl_stmt|,
name|position
init|=
operator|-
literal|1
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|position
argument_list|,
operator|&
name|block
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|mftr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mftr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lid
operator|>
literal|0
condition|)
block|{
name|mftr
operator|.
name|lid
operator|=
name|cl_hton16
argument_list|(
name|lid
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_MFTR_COMPMASK_LID
expr_stmt|;
block|}
if|if
condition|(
name|position
operator|>=
literal|0
condition|)
block|{
name|mftr
operator|.
name|position_block_num
operator|=
name|cl_hton16
argument_list|(
name|position
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_MFTR_COMPMASK_POSITION
expr_stmt|;
block|}
if|if
condition|(
name|block
operator|>=
literal|0
condition|)
block|{
name|mftr
operator|.
name|position_block_num
operator||=
name|cl_hton16
argument_list|(
name|block
operator|&
name|IB_MCAST_BLOCK_ID_MASK_HO
argument_list|)
expr_stmt|;
name|comp_mask
operator||=
name|IB_MFTR_COMPMASK_BLOCK
expr_stmt|;
block|}
name|status
operator|=
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_MAD_ATTR_MFT_RECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|mftr
argument_list|,
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|mftr
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
name|status
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_one_mft_record
argument_list|)
expr_stmt|;
name|return_mad
argument_list|()
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|osm_bind_handle_t
name|get_bind_handle
parameter_list|(
name|void
parameter_list|)
block|{
name|uint32_t
name|i
init|=
literal|0
decl_stmt|;
name|uint64_t
name|port_guid
init|=
operator|(
name|uint64_t
operator|)
operator|-
literal|1
decl_stmt|;
name|osm_bind_handle_t
name|h
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|ib_port_attr_t
name|attr_array
index|[
name|MAX_PORTS
index|]
decl_stmt|;
name|uint32_t
name|num_ports
init|=
name|MAX_PORTS
decl_stmt|;
name|uint32_t
name|ca_name_index
init|=
literal|0
decl_stmt|;
name|complib_init
argument_list|()
expr_stmt|;
name|osm_log_construct
argument_list|(
operator|&
name|log_osm
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|osm_log_init_v2
argument_list|(
operator|&
name|log_osm
argument_list|,
name|TRUE
argument_list|,
literal|0x0001
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|)
operator|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to init osm_log: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|osm_log_set_level
argument_list|(
operator|&
name|log_osm
argument_list|,
name|OSM_LOG_NONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|osm_debug
condition|)
name|osm_log_set_level
argument_list|(
operator|&
name|log_osm
argument_list|,
name|OSM_LOG_DEFAULT_LEVEL
argument_list|)
expr_stmt|;
name|vendor
operator|=
name|osm_vendor_new
argument_list|(
operator|&
name|log_osm
argument_list|,
name|sa_timeout_ms
argument_list|)
expr_stmt|;
name|osm_mad_pool_construct
argument_list|(
operator|&
name|mad_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|osm_mad_pool_init
argument_list|(
operator|&
name|mad_pool
argument_list|)
operator|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to init mad pool: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|=
name|osm_vendor_get_all_port_attr
argument_list|(
name|vendor
argument_list|,
name|attr_array
argument_list|,
operator|&
name|num_ports
argument_list|)
operator|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to get port attributes: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|1
operator|&&
name|cl_ntoh64
argument_list|(
name|attr_array
index|[
name|i
index|]
operator|.
name|port_guid
argument_list|)
operator|!=
operator|(
name|cl_ntoh64
argument_list|(
name|attr_array
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|port_guid
argument_list|)
operator|+
literal|1
operator|)
condition|)
name|ca_name_index
operator|++
expr_stmt|;
if|if
condition|(
name|sa_port_num
operator|&&
name|sa_port_num
operator|!=
name|attr_array
index|[
name|i
index|]
operator|.
name|port_num
condition|)
continue|continue;
if|if
condition|(
name|sa_hca_name
operator|&&
name|strcmp
argument_list|(
name|sa_hca_name
argument_list|,
name|vendor
operator|->
name|ca_names
index|[
name|ca_name_index
index|]
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|attr_array
index|[
name|i
index|]
operator|.
name|link_state
operator|==
name|IB_LINK_ACTIVE
condition|)
block|{
name|port_guid
operator|=
name|attr_array
index|[
name|i
index|]
operator|.
name|port_guid
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|port_guid
operator|==
operator|(
name|uint64_t
operator|)
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to find active port, check port status with \"ibstat\"\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|h
operator|=
name|osmv_bind_sa
argument_list|(
name|vendor
argument_list|,
operator|&
name|mad_pool
argument_list|,
name|port_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|OSM_BIND_INVALID_HANDLE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to bind to SA\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|h
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|clean_up
parameter_list|(
name|void
parameter_list|)
block|{
name|osm_mad_pool_destroy
argument_list|(
operator|&
name|mad_pool
argument_list|)
expr_stmt|;
name|osm_vendor_delete
argument_list|(
operator|&
name|vendor
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|query_cmd
name|query_cmds
index|[]
init|=
block|{
block|{
literal|"ClassPortInfo"
block|,
literal|"CPI"
block|,
name|IB_MAD_ATTR_CLASS_PORT_INFO
block|,
name|NULL
block|,
name|query_class_port_info
block|}
block|,
block|{
literal|"NodeRecord"
block|,
literal|"NR"
block|,
name|IB_MAD_ATTR_NODE_RECORD
block|,
name|NULL
block|,
name|query_node_records
block|}
block|,
block|{
literal|"PortInfoRecord"
block|,
literal|"PIR"
block|,
name|IB_MAD_ATTR_PORTINFO_RECORD
block|,
literal|"[[lid]/[port]]"
block|,
name|query_portinfo_records
block|}
block|,
block|{
literal|"SL2VLTableRecord"
block|,
literal|"SL2VL"
block|,
name|IB_MAD_ATTR_SLVL_RECORD
block|,
literal|"[[lid]/[in_port]/[out_port]]"
block|,
name|query_sl2vl_records
block|}
block|,
block|{
literal|"PKeyTableRecord"
block|,
literal|"PKTR"
block|,
name|IB_MAD_ATTR_PKEY_TBL_RECORD
block|,
literal|"[[lid]/[port]/[block]]"
block|,
name|query_pkey_tbl_records
block|}
block|,
block|{
literal|"VLArbitrationTableRecord"
block|,
literal|"VLAR"
block|,
name|IB_MAD_ATTR_VLARB_RECORD
block|,
literal|"[[lid]/[port]/[block]]"
block|,
name|query_vlarb_records
block|}
block|,
block|{
literal|"InformInfoRecord"
block|,
literal|"IIR"
block|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
block|,
name|NULL
block|,
name|query_informinfo_records
block|}
block|,
block|{
literal|"LinkRecord"
block|,
literal|"LR"
block|,
name|IB_MAD_ATTR_LINK_RECORD
block|,
literal|"[[from_lid]/[from_port]] [[to_lid]/[to_port]]"
block|,
name|query_link_records
block|}
block|,
block|{
literal|"ServiceRecord"
block|,
literal|"SR"
block|,
name|IB_MAD_ATTR_SERVICE_RECORD
block|,
name|NULL
block|,
name|query_service_records
block|}
block|,
block|{
literal|"PathRecord"
block|,
literal|"PR"
block|,
name|IB_MAD_ATTR_PATH_RECORD
block|,
name|NULL
block|,
name|query_path_records
block|}
block|,
block|{
literal|"MCMemberRecord"
block|,
literal|"MCMR"
block|,
name|IB_MAD_ATTR_MCMEMBER_RECORD
block|,
name|NULL
block|,
name|query_mcmember_records
block|}
block|,
block|{
literal|"LFTRecord"
block|,
literal|"LFTR"
block|,
name|IB_MAD_ATTR_LFT_RECORD
block|,
literal|"[[lid]/[block]]"
block|,
name|query_lft_records
block|}
block|,
block|{
literal|"MFTRecord"
block|,
literal|"MFTR"
block|,
name|IB_MAD_ATTR_MFT_RECORD
block|,
literal|"[[mlid]/[position]/[block]]"
block|,
name|query_mft_records
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|struct
name|query_cmd
modifier|*
name|find_query
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
decl_stmt|;
name|unsigned
name|len
init|=
name|strlen
argument_list|(
name|name
argument_list|)
decl_stmt|;
for|for
control|(
name|q
operator|=
name|query_cmds
init|;
name|q
operator|->
name|name
condition|;
name|q
operator|++
control|)
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
name|name
argument_list|,
name|q
operator|->
name|name
argument_list|,
name|len
argument_list|)
operator|||
operator|(
name|q
operator|->
name|alias
operator|&&
operator|!
name|strncasecmp
argument_list|(
name|name
argument_list|,
name|q
operator|->
name|alias
argument_list|,
name|len
argument_list|)
operator|)
condition|)
return|return
name|q
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|query_cmd
modifier|*
name|find_query_by_type
parameter_list|(
name|ib_net16_t
name|type
parameter_list|)
block|{
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
decl_stmt|;
for|for
control|(
name|q
operator|=
name|query_cmds
init|;
name|q
operator|->
name|name
condition|;
name|q
operator|++
control|)
if|if
condition|(
name|q
operator|->
name|query_type
operator|==
name|type
condition|)
return|return
name|q
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-h -d -p -N] [--list | -D] [-S -I -L -l -G"
literal|" -O -U -c -s -g -m --src-to-dst<src:dst> --sgid-to-dgid<src-dst> "
literal|"-C<ca_name> -P<ca_port> -t(imeout)<msec>] [query-name] [<name> |<lid> |<guid>]\n"
argument_list|,
name|argv0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   Queries node records by default\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -d enable debugging\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -p get PathRecord info\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -N get NodeRecord info\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   --list | -D the node desc of the CA's\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -S get ServiceRecord info\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -I get InformInfoRecord (subscription) info\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -L return the Lids of the name specified\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -l return the unique Lid of the name specified\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -G return the Guids of the name specified\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -O return name for the Lid specified\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -U return name for the Guid specified\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -c get the SA's class port info\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -s return the PortInfoRecords with isSM or "
literal|"isSMdisabled capability mask bit on\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -g get multicast group info\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -m get multicast member info\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"      (if multicast group specified, list member GIDs"
literal|" only for group specified\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"      specified, for example 'saquery -m 0xC000')\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -x get LinkRecord info\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   --src-to-dst get a PathRecord for<src:dst>\n"
literal|"                where src and dst are either node "
literal|"names or LIDs\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   --sgid-to-dgid get a PathRecord for<sgid-dgid>\n"
literal|"                where sgid and dgid are addresses in "
literal|"IPv6 format\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -C<ca_name> specify the SA query HCA\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -P<ca_port> specify the SA query port\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   --smkey<val> specify SM_Key value for the query."
literal|" If non-numeric value \n"
literal|"                 (like 'x') is specified then "
literal|"saquery will prompt for a value\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -t | --timeout<msec> specify the SA query "
literal|"response timeout (default %u msec)\n"
argument_list|,
name|DEFAULT_SA_TIMEOUT_MS
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   --node-name-map<node-name-map> specify a node name map\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n   Supported query names (and aliases):\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
name|query_cmds
init|;
name|q
operator|->
name|name
condition|;
name|q
operator|++
control|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"      %s (%s) %s\n"
argument_list|,
name|q
operator|->
name|name
argument_list|,
name|q
operator|->
name|alias
condition|?
name|q
operator|->
name|alias
else|:
literal|""
argument_list|,
name|q
operator|->
name|usage
condition|?
name|q
operator|->
name|usage
else|:
literal|""
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_enum
enum|enum
name|saquery_command
block|{
name|SAQUERY_CMD_QUERY
block|,
name|SAQUERY_CMD_NODE_RECORD
block|,
name|SAQUERY_CMD_PATH_RECORD
block|,
name|SAQUERY_CMD_CLASS_PORT_INFO
block|,
name|SAQUERY_CMD_ISSM
block|,
name|SAQUERY_CMD_MCGROUPS
block|,
name|SAQUERY_CMD_MCMEMBERS
block|, }
enum|;
end_enum

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ch
init|=
literal|0
decl_stmt|;
name|osm_bind_handle_t
name|h
decl_stmt|;
name|enum
name|saquery_command
name|command
init|=
name|SAQUERY_CMD_QUERY
decl_stmt|;
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|src
init|=
name|NULL
decl_stmt|,
modifier|*
name|dst
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|sgid
init|=
name|NULL
decl_stmt|,
modifier|*
name|dgid
init|=
name|NULL
decl_stmt|;
name|ib_net16_t
name|query_type
init|=
literal|0
decl_stmt|;
name|ib_net16_t
name|src_lid
decl_stmt|,
name|dst_lid
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
specifier|static
name|char
specifier|const
name|str_opts
index|[]
init|=
literal|"pVNDLlGOUcSIsgmxdhP:C:t:"
decl_stmt|;
specifier|static
specifier|const
name|struct
name|option
name|long_opts
index|[]
init|=
block|{
block|{
literal|"p"
block|,
literal|0
block|,
literal|0
block|,
literal|'p'
block|}
block|,
block|{
literal|"Version"
block|,
literal|0
block|,
literal|0
block|,
literal|'V'
block|}
block|,
block|{
literal|"N"
block|,
literal|0
block|,
literal|0
block|,
literal|'N'
block|}
block|,
block|{
literal|"L"
block|,
literal|0
block|,
literal|0
block|,
literal|'L'
block|}
block|,
block|{
literal|"l"
block|,
literal|0
block|,
literal|0
block|,
literal|'l'
block|}
block|,
block|{
literal|"G"
block|,
literal|0
block|,
literal|0
block|,
literal|'G'
block|}
block|,
block|{
literal|"O"
block|,
literal|0
block|,
literal|0
block|,
literal|'O'
block|}
block|,
block|{
literal|"U"
block|,
literal|0
block|,
literal|0
block|,
literal|'U'
block|}
block|,
block|{
literal|"s"
block|,
literal|0
block|,
literal|0
block|,
literal|'s'
block|}
block|,
block|{
literal|"g"
block|,
literal|0
block|,
literal|0
block|,
literal|'g'
block|}
block|,
block|{
literal|"m"
block|,
literal|0
block|,
literal|0
block|,
literal|'m'
block|}
block|,
block|{
literal|"x"
block|,
literal|0
block|,
literal|0
block|,
literal|'x'
block|}
block|,
block|{
literal|"d"
block|,
literal|0
block|,
literal|0
block|,
literal|'d'
block|}
block|,
block|{
literal|"c"
block|,
literal|0
block|,
literal|0
block|,
literal|'c'
block|}
block|,
block|{
literal|"S"
block|,
literal|0
block|,
literal|0
block|,
literal|'S'
block|}
block|,
block|{
literal|"I"
block|,
literal|0
block|,
literal|0
block|,
literal|'I'
block|}
block|,
block|{
literal|"P"
block|,
literal|1
block|,
literal|0
block|,
literal|'P'
block|}
block|,
block|{
literal|"C"
block|,
literal|1
block|,
literal|0
block|,
literal|'C'
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
literal|0
block|,
literal|'h'
block|}
block|,
block|{
literal|"list"
block|,
literal|0
block|,
literal|0
block|,
literal|'D'
block|}
block|,
block|{
literal|"src-to-dst"
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
literal|"sgid-to-dgid"
block|,
literal|1
block|,
literal|0
block|,
literal|2
block|}
block|,
block|{
literal|"timeout"
block|,
literal|1
block|,
literal|0
block|,
literal|'t'
block|}
block|,
block|{
literal|"node-name-map"
block|,
literal|1
block|,
literal|0
block|,
literal|3
block|}
block|,
block|{
literal|"smkey"
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|}
block|,
block|{}
block|}
decl_stmt|;
name|argv0
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|str_opts
argument_list|,
name|long_opts
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|1
case|:
block|{
name|char
modifier|*
name|opt
init|=
name|strdup
argument_list|(
name|optarg
argument_list|)
decl_stmt|;
name|char
modifier|*
name|ch
init|=
name|strchr
argument_list|(
name|opt
argument_list|,
literal|':'
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ch
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: --src-to-dst<node>:<node>\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
operator|*
name|ch
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|opt
condition|)
name|src
operator|=
name|strdup
argument_list|(
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ch
condition|)
name|dst
operator|=
name|strdup
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|command
operator|=
name|SAQUERY_CMD_PATH_RECORD
expr_stmt|;
break|break;
block|}
case|case
literal|2
case|:
block|{
name|char
modifier|*
name|opt
init|=
name|strdup
argument_list|(
name|optarg
argument_list|)
decl_stmt|;
name|char
modifier|*
name|tok1
init|=
name|strtok
argument_list|(
name|opt
argument_list|,
literal|"-"
argument_list|)
decl_stmt|;
name|char
modifier|*
name|tok2
init|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|"\0"
argument_list|)
decl_stmt|;
if|if
condition|(
name|tok1
operator|&&
name|tok2
condition|)
block|{
name|sgid
operator|=
name|strdup
argument_list|(
name|tok1
argument_list|)
expr_stmt|;
name|dgid
operator|=
name|strdup
argument_list|(
name|tok2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: --sgid-to-dgid<GID>-<GID>\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|free
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|command
operator|=
name|SAQUERY_CMD_PATH_RECORD
expr_stmt|;
break|break;
block|}
case|case
literal|3
case|:
name|node_name_map_file
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|optarg
argument_list|)
operator|&&
operator|!
operator|(
name|optarg
operator|=
name|getpass
argument_list|(
literal|"SM_Key: "
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cannot get SM_Key\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|smkey
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|command
operator|=
name|SAQUERY_CMD_PATH_RECORD
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s %s\n"
argument_list|,
name|argv0
argument_list|,
name|get_build_version
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
case|case
literal|'D'
case|:
name|node_print_desc
operator|=
name|ALL_DESC
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|command
operator|=
name|SAQUERY_CMD_CLASS_PORT_INFO
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|query_type
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|query_type
operator|=
name|IB_MAD_ATTR_INFORM_INFO_RECORD
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|command
operator|=
name|SAQUERY_CMD_NODE_RECORD
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|node_print_desc
operator|=
name|LID_ONLY
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|node_print_desc
operator|=
name|UNIQUE_LID_ONLY
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
name|node_print_desc
operator|=
name|GUID_ONLY
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
name|node_print_desc
operator|=
name|NAME_OF_LID
expr_stmt|;
break|break;
case|case
literal|'U'
case|:
name|node_print_desc
operator|=
name|NAME_OF_GUID
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|command
operator|=
name|SAQUERY_CMD_ISSM
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|command
operator|=
name|SAQUERY_CMD_MCGROUPS
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|command
operator|=
name|SAQUERY_CMD_MCMEMBERS
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|query_type
operator|=
name|IB_MAD_ATTR_LINK_RECORD
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|osm_debug
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|sa_hca_name
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|sa_port_num
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|sa_timeout_ms
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
operator|!
name|query_type
condition|)
block|{
if|if
condition|(
operator|!
name|argc
operator|||
operator|!
operator|(
name|q
operator|=
name|find_query
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
name|query_type
operator|=
name|IB_MAD_ATTR_NODE_RECORD
expr_stmt|;
else|else
block|{
name|query_type
operator|=
name|q
operator|->
name|query_type
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|argc
condition|)
block|{
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_LID
condition|)
block|{
name|requested_lid
operator|=
operator|(
name|ib_net16_t
operator|)
name|strtoul
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|requested_lid_flag
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_GUID
condition|)
block|{
name|requested_guid
operator|=
operator|(
name|ib_net64_t
operator|)
name|strtoul
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|requested_guid_flag
operator|++
expr_stmt|;
block|}
else|else
block|{
name|requested_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|node_print_desc
operator|==
name|LID_ONLY
operator|||
name|node_print_desc
operator|==
name|UNIQUE_LID_ONLY
operator|||
name|node_print_desc
operator|==
name|GUID_ONLY
operator|)
operator|&&
operator|!
name|requested_name
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: name not specified\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_LID
operator|&&
operator|!
name|requested_lid_flag
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: lid not specified\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_GUID
operator|&&
operator|!
name|requested_guid_flag
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: guid not specified\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
comment|/* Note: lid cannot be 0; see infiniband spec 4.1.3 */
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_LID
operator|&&
operator|!
name|requested_lid
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: lid invalid\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|h
operator|=
name|get_bind_handle
argument_list|()
expr_stmt|;
name|node_name_map
operator|=
name|open_node_name_map
argument_list|(
name|node_name_map_file
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SAQUERY_CMD_NODE_RECORD
case|:
name|status
operator|=
name|print_node_records
argument_list|(
name|h
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAQUERY_CMD_PATH_RECORD
case|:
if|if
condition|(
name|src
operator|&&
name|dst
condition|)
block|{
name|src_lid
operator|=
name|get_lid
argument_list|(
name|h
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|dst_lid
operator|=
name|get_lid
argument_list|(
name|h
argument_list|,
name|dst
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Path record for %s -> %s\n"
argument_list|,
name|src
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|src_lid
operator|==
literal|0
operator|||
name|dst_lid
operator|==
literal|0
condition|)
block|{
name|status
operator|=
name|IB_UNKNOWN_ERROR
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|get_print_path_rec_lid
argument_list|(
name|h
argument_list|,
name|src_lid
argument_list|,
name|dst_lid
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|sgid
operator|&&
name|dgid
condition|)
block|{
name|struct
name|in6_addr
name|src_addr
decl_stmt|,
name|dst_addr
decl_stmt|;
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|sgid
argument_list|,
operator|&
name|src_addr
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid src gid: %s\n"
argument_list|,
name|sgid
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|dgid
argument_list|,
operator|&
name|dst_addr
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid dst gid: %s\n"
argument_list|,
name|dgid
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|get_print_path_rec_gid
argument_list|(
name|h
argument_list|,
operator|(
name|ib_gid_t
operator|*
operator|)
operator|&
name|src_addr
operator|.
name|s6_addr
argument_list|,
operator|(
name|ib_gid_t
operator|*
operator|)
operator|&
name|dst_addr
operator|.
name|s6_addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|query_path_records
argument_list|(
name|q
argument_list|,
name|h
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SAQUERY_CMD_CLASS_PORT_INFO
case|:
name|status
operator|=
name|get_print_class_port_info
argument_list|(
name|h
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAQUERY_CMD_ISSM
case|:
name|status
operator|=
name|print_issm_records
argument_list|(
name|h
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAQUERY_CMD_MCGROUPS
case|:
name|status
operator|=
name|print_multicast_group_records
argument_list|(
name|h
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAQUERY_CMD_MCMEMBERS
case|:
name|status
operator|=
name|print_multicast_member_records
argument_list|(
name|h
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|(
operator|!
name|q
operator|&&
operator|!
operator|(
name|q
operator|=
name|find_query_by_type
argument_list|(
name|query_type
argument_list|)
operator|)
operator|)
operator|||
operator|!
name|q
operator|->
name|handler
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown query type %d\n"
argument_list|,
name|ntohs
argument_list|(
name|query_type
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_UNKNOWN_ERROR
expr_stmt|;
block|}
else|else
name|status
operator|=
name|q
operator|->
name|handler
argument_list|(
name|q
argument_list|,
name|h
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|src
condition|)
name|free
argument_list|(
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
condition|)
name|free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
name|clean_up
argument_list|()
expr_stmt|;
name|close_node_name_map
argument_list|(
name|node_name_map
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

end_unit


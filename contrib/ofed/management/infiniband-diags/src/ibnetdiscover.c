begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2008 Voltaire Inc.  All rights reserved.  * Copyright (c) 2007 Xsigo Systems Inc.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/common.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/umad.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/mad.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_nodenamemap.h>
end_include

begin_include
include|#
directive|include
file|"ibnetdiscover.h"
end_include

begin_include
include|#
directive|include
file|"grouping.h"
end_include

begin_include
include|#
directive|include
file|"ibdiag_common.h"
end_include

begin_decl_stmt
specifier|static
name|char
modifier|*
name|node_type_str
index|[]
init|=
block|{
literal|"???"
block|,
literal|"ca"
block|,
literal|"switch"
block|,
literal|"router"
block|,
literal|"iwarp rnic"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|linkwidth_str
index|[]
init|=
block|{
literal|"??"
block|,
literal|"1x"
block|,
literal|"4x"
block|,
literal|"??"
block|,
literal|"8x"
block|,
literal|"??"
block|,
literal|"??"
block|,
literal|"??"
block|,
literal|"12x"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|linkspeed_str
index|[]
init|=
block|{
literal|"???"
block|,
literal|"SDR"
block|,
literal|"DDR"
block|,
literal|"???"
block|,
literal|"QDR"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|timeout
init|=
literal|2000
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ms */
end_comment

begin_decl_stmt
specifier|static
name|int
name|dumplevel
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|verbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|f
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|argv0
init|=
literal|"ibnetdiscover"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|node_name_map_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|nn_map_t
modifier|*
name|node_name_map
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Node
modifier|*
name|nodesdist
index|[
name|MAXHOPS
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* last is Ca list */
end_comment

begin_decl_stmt
name|Node
modifier|*
name|mynode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|maxhops_discovered
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ChassisList
modifier|*
name|chassis
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|get_linkwidth_str
parameter_list|(
name|int
name|linkwidth
parameter_list|)
block|{
if|if
condition|(
name|linkwidth
operator|>
literal|8
condition|)
return|return
name|linkwidth_str
index|[
literal|0
index|]
return|;
else|else
return|return
name|linkwidth_str
index|[
name|linkwidth
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|get_linkspeed_str
parameter_list|(
name|int
name|linkspeed
parameter_list|)
block|{
if|if
condition|(
name|linkspeed
operator|>
literal|4
condition|)
return|return
name|linkspeed_str
index|[
literal|0
index|]
return|;
else|else
return|return
name|linkspeed_str
index|[
name|linkspeed
index|]
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|node_type_str2
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|)
block|{
switch|switch
condition|(
name|node
operator|->
name|type
condition|)
block|{
case|case
name|SWITCH_NODE
case|:
return|return
literal|"SW"
return|;
case|case
name|CA_NODE
case|:
return|return
literal|"CA"
return|;
case|case
name|ROUTER_NODE
case|:
return|return
literal|"RT"
return|;
block|}
return|return
literal|"??"
return|;
block|}
end_function

begin_function
name|void
name|decode_port_info
parameter_list|(
name|void
modifier|*
name|pi
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|)
block|{
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_LID_F
argument_list|,
operator|&
name|port
operator|->
name|lid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_LMC_F
argument_list|,
operator|&
name|port
operator|->
name|lmc
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_STATE_F
argument_list|,
operator|&
name|port
operator|->
name|state
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_PHYS_STATE_F
argument_list|,
operator|&
name|port
operator|->
name|physstate
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_LINK_WIDTH_ACTIVE_F
argument_list|,
operator|&
name|port
operator|->
name|linkwidth
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|,
operator|&
name|port
operator|->
name|linkspeed
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|get_port
parameter_list|(
name|Port
modifier|*
name|port
parameter_list|,
name|int
name|portnum
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|)
block|{
name|char
name|portinfo
index|[
literal|64
index|]
decl_stmt|;
name|void
modifier|*
name|pi
init|=
name|portinfo
decl_stmt|;
name|port
operator|->
name|portnum
operator|=
name|portnum
expr_stmt|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|pi
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
name|portnum
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|decode_port_info
argument_list|(
name|pi
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|"portid %s portnum %d: lid %d state %d physstate %d %s %s"
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|portnum
argument_list|,
name|port
operator|->
name|lid
argument_list|,
name|port
operator|->
name|state
argument_list|,
name|port
operator|->
name|physstate
argument_list|,
name|get_linkwidth_str
argument_list|(
name|port
operator|->
name|linkwidth
argument_list|)
argument_list|,
name|get_linkspeed_str
argument_list|(
name|port
operator|->
name|linkspeed
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Returns 0 if non switch node is found, 1 if switch is found, -1 if error.  */
end_comment

begin_function
name|int
name|get_node
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|)
block|{
name|char
name|portinfo
index|[
literal|64
index|]
decl_stmt|;
name|char
name|switchinfo
index|[
literal|64
index|]
decl_stmt|;
name|void
modifier|*
name|pi
init|=
name|portinfo
decl_stmt|,
modifier|*
name|ni
init|=
name|node
operator|->
name|nodeinfo
decl_stmt|,
modifier|*
name|nd
init|=
name|node
operator|->
name|nodedesc
decl_stmt|;
name|void
modifier|*
name|si
init|=
name|switchinfo
decl_stmt|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|ni
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_NODE_INFO
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_GUID_F
argument_list|,
operator|&
name|node
operator|->
name|nodeguid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_TYPE_F
argument_list|,
operator|&
name|node
operator|->
name|type
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_NPORTS_F
argument_list|,
operator|&
name|node
operator|->
name|numports
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_DEVID_F
argument_list|,
operator|&
name|node
operator|->
name|devid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|,
operator|&
name|node
operator|->
name|vendid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_SYSTEM_GUID_F
argument_list|,
operator|&
name|node
operator|->
name|sysimgguid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_PORT_GUID_F
argument_list|,
operator|&
name|node
operator|->
name|portguid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_LOCAL_PORT_F
argument_list|,
operator|&
name|node
operator|->
name|localport
argument_list|)
expr_stmt|;
name|port
operator|->
name|portnum
operator|=
name|node
operator|->
name|localport
expr_stmt|;
name|port
operator|->
name|portguid
operator|=
name|node
operator|->
name|portguid
expr_stmt|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|nd
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_NODE_DESC
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|pi
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|decode_port_info
argument_list|(
name|pi
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|type
operator|!=
name|SWITCH_NODE
condition|)
return|return
literal|0
return|;
name|node
operator|->
name|smalid
operator|=
name|port
operator|->
name|lid
expr_stmt|;
name|node
operator|->
name|smalmc
operator|=
name|port
operator|->
name|lmc
expr_stmt|;
comment|/* after we have the sma information find out the real PortInfo for this port */
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|pi
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
name|node
operator|->
name|localport
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|decode_port_info
argument_list|(
name|pi
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|si
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_SWITCH_INFO
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|)
condition|)
name|node
operator|->
name|smaenhsp0
operator|=
literal|0
expr_stmt|;
comment|/* assume base SP0 */
else|else
name|mad_decode_field
argument_list|(
name|si
argument_list|,
name|IB_SW_ENHANCED_PORT0_F
argument_list|,
operator|&
name|node
operator|->
name|smaenhsp0
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|"portid %s: got switch node %"
name|PRIx64
literal|" '%s'"
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|extend_dpath
parameter_list|(
name|ib_dr_path_t
modifier|*
name|path
parameter_list|,
name|int
name|nextport
parameter_list|)
block|{
if|if
condition|(
name|path
operator|->
name|cnt
operator|+
literal|2
operator|>=
sizeof|sizeof
argument_list|(
name|path
operator|->
name|p
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
operator|++
name|path
operator|->
name|cnt
expr_stmt|;
if|if
condition|(
name|path
operator|->
name|cnt
operator|>
name|maxhops_discovered
condition|)
name|maxhops_discovered
operator|=
name|path
operator|->
name|cnt
expr_stmt|;
name|path
operator|->
name|p
index|[
name|path
operator|->
name|cnt
index|]
operator|=
name|nextport
expr_stmt|;
return|return
name|path
operator|->
name|cnt
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_endnode
parameter_list|(
name|ib_portid_t
modifier|*
name|path
parameter_list|,
name|char
modifier|*
name|prompt
parameter_list|,
name|Node
modifier|*
name|node
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|)
block|{
if|if
condition|(
operator|!
name|dumplevel
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s -> %s %s {%016"
name|PRIx64
literal|"} portnum %d lid %d-%d\"%s\"\n"
argument_list|,
name|portid2str
argument_list|(
name|path
argument_list|)
argument_list|,
name|prompt
argument_list|,
operator|(
name|node
operator|->
name|type
operator|<=
name|IB_NODE_MAX
condition|?
name|node_type_str
index|[
name|node
operator|->
name|type
index|]
else|:
literal|"???"
operator|)
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|type
operator|==
name|SWITCH_NODE
condition|?
literal|0
else|:
name|port
operator|->
name|portnum
argument_list|,
name|port
operator|->
name|lid
argument_list|,
name|port
operator|->
name|lid
operator|+
operator|(
literal|1
operator|<<
name|port
operator|->
name|lmc
operator|)
operator|-
literal|1
argument_list|,
name|clean_nodedesc
argument_list|(
name|node
operator|->
name|nodedesc
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|HASHGUID
parameter_list|(
name|guid
parameter_list|)
value|((uint32_t)(((uint32_t)(guid) * 101) ^ ((uint32_t)((guid)>> 32) * 103)))
end_define

begin_define
define|#
directive|define
name|HTSZ
value|137
end_define

begin_decl_stmt
specifier|static
name|Node
modifier|*
name|nodestbl
index|[
name|HTSZ
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|Node
modifier|*
name|find_node
parameter_list|(
name|Node
modifier|*
name|new
parameter_list|)
block|{
name|int
name|hash
init|=
name|HASHGUID
argument_list|(
name|new
operator|->
name|nodeguid
argument_list|)
operator|%
name|HTSZ
decl_stmt|;
name|Node
modifier|*
name|node
decl_stmt|;
for|for
control|(
name|node
operator|=
name|nodestbl
index|[
name|hash
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|htnext
control|)
if|if
condition|(
name|node
operator|->
name|nodeguid
operator|==
name|new
operator|->
name|nodeguid
condition|)
return|return
name|node
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|Node
modifier|*
name|create_node
parameter_list|(
name|Node
modifier|*
name|temp
parameter_list|,
name|ib_portid_t
modifier|*
name|path
parameter_list|,
name|int
name|dist
parameter_list|)
block|{
name|Node
modifier|*
name|node
decl_stmt|;
name|int
name|hash
init|=
name|HASHGUID
argument_list|(
name|temp
operator|->
name|nodeguid
argument_list|)
operator|%
name|HTSZ
decl_stmt|;
name|node
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|node
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|node
condition|)
return|return
name|NULL
return|;
name|memcpy
argument_list|(
name|node
argument_list|,
name|temp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|->
name|dist
operator|=
name|dist
expr_stmt|;
name|node
operator|->
name|path
operator|=
operator|*
name|path
expr_stmt|;
name|node
operator|->
name|htnext
operator|=
name|nodestbl
index|[
name|hash
index|]
expr_stmt|;
name|nodestbl
index|[
name|hash
index|]
operator|=
name|node
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|type
operator|!=
name|SWITCH_NODE
condition|)
name|dist
operator|=
name|MAXHOPS
expr_stmt|;
comment|/* special Ca list */
name|node
operator|->
name|dnext
operator|=
name|nodesdist
index|[
name|dist
index|]
expr_stmt|;
name|nodesdist
index|[
name|dist
index|]
operator|=
name|node
expr_stmt|;
return|return
name|node
return|;
block|}
end_function

begin_function
specifier|static
name|Port
modifier|*
name|find_port
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|)
block|{
name|Port
modifier|*
name|old
decl_stmt|;
for|for
control|(
name|old
operator|=
name|node
operator|->
name|ports
init|;
name|old
condition|;
name|old
operator|=
name|old
operator|->
name|next
control|)
if|if
condition|(
name|old
operator|->
name|portnum
operator|==
name|port
operator|->
name|portnum
condition|)
return|return
name|old
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|Port
modifier|*
name|create_port
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|Port
modifier|*
name|temp
parameter_list|)
block|{
name|Port
modifier|*
name|port
decl_stmt|;
name|port
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
return|return
name|NULL
return|;
name|memcpy
argument_list|(
name|port
argument_list|,
name|temp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|port
operator|->
name|node
operator|=
name|node
expr_stmt|;
name|port
operator|->
name|next
operator|=
name|node
operator|->
name|ports
expr_stmt|;
name|node
operator|->
name|ports
operator|=
name|port
expr_stmt|;
return|return
name|port
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|link_ports
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|,
name|Node
modifier|*
name|remotenode
parameter_list|,
name|Port
modifier|*
name|remoteport
parameter_list|)
block|{
name|DEBUG
argument_list|(
literal|"linking: 0x%"
name|PRIx64
literal|" %p->%p:%u and 0x%"
name|PRIx64
literal|" %p->%p:%u"
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
argument_list|,
name|port
argument_list|,
name|port
operator|->
name|portnum
argument_list|,
name|remotenode
operator|->
name|nodeguid
argument_list|,
name|remotenode
argument_list|,
name|remoteport
argument_list|,
name|remoteport
operator|->
name|portnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
name|port
operator|->
name|remoteport
operator|->
name|remoteport
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|remoteport
operator|->
name|remoteport
condition|)
name|remoteport
operator|->
name|remoteport
operator|->
name|remoteport
operator|=
name|NULL
expr_stmt|;
name|port
operator|->
name|remoteport
operator|=
name|remoteport
expr_stmt|;
name|remoteport
operator|->
name|remoteport
operator|=
name|port
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_port
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|,
name|ib_portid_t
modifier|*
name|path
parameter_list|,
name|int
name|portnum
parameter_list|,
name|int
name|dist
parameter_list|)
block|{
name|Node
name|node_buf
decl_stmt|;
name|Port
name|port_buf
decl_stmt|;
name|Node
modifier|*
name|remotenode
decl_stmt|,
modifier|*
name|oldnode
decl_stmt|;
name|Port
modifier|*
name|remoteport
decl_stmt|,
modifier|*
name|oldport
decl_stmt|;
name|memset
argument_list|(
operator|&
name|node_buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|node_buf
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|port_buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|port_buf
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|"handle node %p port %p:%d dist %d"
argument_list|,
name|node
argument_list|,
name|port
argument_list|,
name|portnum
argument_list|,
name|dist
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|physstate
operator|!=
literal|5
condition|)
comment|/* LinkUp */
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|extend_dpath
argument_list|(
operator|&
name|path
operator|->
name|drpath
argument_list|,
name|portnum
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|get_node
argument_list|(
operator|&
name|node_buf
argument_list|,
operator|&
name|port_buf
argument_list|,
name|path
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"NodeInfo on %s failed, skipping port"
argument_list|,
name|portid2str
argument_list|(
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|path
operator|->
name|drpath
operator|.
name|cnt
operator|--
expr_stmt|;
comment|/* restore path */
return|return
operator|-
literal|1
return|;
block|}
name|oldnode
operator|=
name|find_node
argument_list|(
operator|&
name|node_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldnode
condition|)
name|remotenode
operator|=
name|oldnode
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|remotenode
operator|=
name|create_node
argument_list|(
operator|&
name|node_buf
argument_list|,
name|path
argument_list|,
name|dist
operator|+
literal|1
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"no memory"
argument_list|)
expr_stmt|;
name|oldport
operator|=
name|find_port
argument_list|(
name|remotenode
argument_list|,
operator|&
name|port_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldport
condition|)
block|{
name|remoteport
operator|=
name|oldport
expr_stmt|;
if|if
condition|(
name|node
operator|!=
name|remotenode
operator|||
name|port
operator|!=
name|remoteport
condition|)
name|IBWARN
argument_list|(
literal|"port moving..."
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|remoteport
operator|=
name|create_port
argument_list|(
name|remotenode
argument_list|,
operator|&
name|port_buf
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"no memory"
argument_list|)
expr_stmt|;
name|dump_endnode
argument_list|(
name|path
argument_list|,
name|oldnode
condition|?
literal|"known remote"
else|:
literal|"new remote"
argument_list|,
name|remotenode
argument_list|,
name|remoteport
argument_list|)
expr_stmt|;
name|link_ports
argument_list|(
name|node
argument_list|,
name|port
argument_list|,
name|remotenode
argument_list|,
name|remoteport
argument_list|)
expr_stmt|;
name|path
operator|->
name|drpath
operator|.
name|cnt
operator|--
expr_stmt|;
comment|/* restore path */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Return 1 if found, 0 if not, -1 on errors.  */
end_comment

begin_function
specifier|static
name|int
name|discover
parameter_list|(
name|ib_portid_t
modifier|*
name|from
parameter_list|)
block|{
name|Node
name|node_buf
decl_stmt|;
name|Port
name|port_buf
decl_stmt|;
name|Node
modifier|*
name|node
decl_stmt|;
name|Port
modifier|*
name|port
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|dist
init|=
literal|0
decl_stmt|;
name|ib_portid_t
modifier|*
name|path
decl_stmt|;
name|DEBUG
argument_list|(
literal|"from %s"
argument_list|,
name|portid2str
argument_list|(
name|from
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|node_buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|node_buf
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|port_buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|port_buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_node
argument_list|(
operator|&
name|node_buf
argument_list|,
operator|&
name|port_buf
argument_list|,
name|from
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't reach node %s"
argument_list|,
name|portid2str
argument_list|(
name|from
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|node
operator|=
name|create_node
argument_list|(
operator|&
name|node_buf
argument_list|,
name|from
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|node
condition|)
name|IBERROR
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
name|mynode
operator|=
name|node
expr_stmt|;
name|port
operator|=
name|create_port
argument_list|(
name|node
argument_list|,
operator|&
name|port_buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
name|IBERROR
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|type
operator|!=
name|SWITCH_NODE
operator|&&
name|handle_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|,
name|from
argument_list|,
name|node
operator|->
name|localport
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
for|for
control|(
name|dist
operator|=
literal|0
init|;
name|dist
operator|<
name|MAXHOPS
condition|;
name|dist
operator|++
control|)
block|{
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|dist
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
block|{
name|path
operator|=
operator|&
name|node
operator|->
name|path
expr_stmt|;
name|DEBUG
argument_list|(
literal|"dist %d node %p"
argument_list|,
name|dist
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|dump_endnode
argument_list|(
name|path
argument_list|,
literal|"processing"
argument_list|,
name|node
argument_list|,
name|port
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|node
operator|->
name|numports
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
name|node
operator|->
name|localport
condition|)
continue|continue;
if|if
condition|(
name|get_port
argument_list|(
operator|&
name|port_buf
argument_list|,
name|i
argument_list|,
name|path
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't reach node %s port %d"
argument_list|,
name|portid2str
argument_list|(
name|path
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|port
operator|=
name|find_port
argument_list|(
name|node
argument_list|,
operator|&
name|port_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
condition|)
continue|continue;
name|port
operator|=
name|create_port
argument_list|(
name|node
argument_list|,
operator|&
name|port_buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
name|IBERROR
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
comment|/* If switch, set port GUID to node GUID */
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|SWITCH_NODE
condition|)
name|port
operator|->
name|portguid
operator|=
name|node
operator|->
name|portguid
expr_stmt|;
name|handle_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|,
name|path
argument_list|,
name|i
argument_list|,
name|dist
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|node_name
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
switch|switch
condition|(
name|node
operator|->
name|type
condition|)
block|{
case|case
name|SWITCH_NODE
case|:
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"\"%s"
argument_list|,
literal|"S"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CA_NODE
case|:
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"\"%s"
argument_list|,
literal|"H"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ROUTER_NODE
case|:
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"\"%s"
argument_list|,
literal|"R"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"\"%s"
argument_list|,
literal|"?"
argument_list|)
expr_stmt|;
break|break;
block|}
name|sprintf
argument_list|(
name|buf
operator|+
literal|2
argument_list|,
literal|"-%016"
name|PRIx64
literal|"\""
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|void
name|list_node
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|node_type
decl_stmt|;
name|char
modifier|*
name|nodename
init|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|node
operator|->
name|type
condition|)
block|{
case|case
name|SWITCH_NODE
case|:
name|node_type
operator|=
literal|"Switch"
expr_stmt|;
break|break;
case|case
name|CA_NODE
case|:
name|node_type
operator|=
literal|"Ca"
expr_stmt|;
break|break;
case|case
name|ROUTER_NODE
case|:
name|node_type
operator|=
literal|"Router"
expr_stmt|;
break|break;
default|default:
name|node_type
operator|=
literal|"???"
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s\t : 0x%016"
name|PRIx64
literal|" ports %d devid 0x%x vendid 0x%x \"%s\"\n"
argument_list|,
name|node_type
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|numports
argument_list|,
name|node
operator|->
name|devid
argument_list|,
name|node
operator|->
name|vendid
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nodename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|out_ids
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|int
name|group
parameter_list|,
name|char
modifier|*
name|chname
parameter_list|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\nvendid=0x%x\ndevid=0x%x\n"
argument_list|,
name|node
operator|->
name|vendid
argument_list|,
name|node
operator|->
name|devid
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|sysimgguid
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"sysimgguid=0x%"
name|PRIx64
argument_list|,
name|node
operator|->
name|sysimgguid
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|&&
name|node
operator|->
name|chrecord
operator|&&
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t\t# Chassis %d"
argument_list|,
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|chname
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" (%s)"
argument_list|,
name|chname
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_xsigo_tca
argument_list|(
name|node
operator|->
name|nodeguid
argument_list|)
operator|&&
name|node
operator|->
name|ports
operator|->
name|remoteport
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" slot %d"
argument_list|,
name|node
operator|->
name|ports
operator|->
name|remoteport
operator|->
name|portnum
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint64_t
name|out_chassis
parameter_list|(
name|int
name|chassisnum
parameter_list|)
block|{
name|uint64_t
name|guid
decl_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\nChassis %d"
argument_list|,
name|chassisnum
argument_list|)
expr_stmt|;
name|guid
operator|=
name|get_chassis_guid
argument_list|(
name|chassisnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|guid
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" (guid 0x%"
name|PRIx64
literal|")"
argument_list|,
name|guid
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
return|return
name|guid
return|;
block|}
end_function

begin_function
name|void
name|out_switch
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|int
name|group
parameter_list|,
name|char
modifier|*
name|chname
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|char
modifier|*
name|nodename
init|=
name|NULL
decl_stmt|;
name|out_ids
argument_list|(
name|node
argument_list|,
name|group
argument_list|,
name|chname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"switchguid=0x%"
name|PRIx64
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"(%"
name|PRIx64
literal|")"
argument_list|,
name|node
operator|->
name|portguid
argument_list|)
expr_stmt|;
comment|/* Currently, only if Voltaire chassis */
if|if
condition|(
name|group
operator|&&
name|node
operator|->
name|chrecord
operator|&&
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
operator|&&
name|node
operator|->
name|vendid
operator|==
name|VTR_VENDOR_ID
condition|)
block|{
name|str
operator|=
name|get_chassis_type
argument_list|(
name|node
operator|->
name|chrecord
operator|->
name|chassistype
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s "
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
name|get_chassis_slot
argument_list|(
name|node
operator|->
name|chrecord
operator|->
name|chassisslot
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s "
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%d Chip %d"
argument_list|,
name|node
operator|->
name|chrecord
operator|->
name|slotnum
argument_list|,
name|node
operator|->
name|chrecord
operator|->
name|anafanum
argument_list|)
expr_stmt|;
block|}
name|nodename
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\nSwitch\t%d %s\t\t# \"%s\" %s port 0 lid %d lmc %d\n"
argument_list|,
name|node
operator|->
name|numports
argument_list|,
name|node_name
argument_list|(
name|node
argument_list|)
argument_list|,
name|nodename
argument_list|,
name|node
operator|->
name|smaenhsp0
condition|?
literal|"enhanced"
else|:
literal|"base"
argument_list|,
name|node
operator|->
name|smalid
argument_list|,
name|node
operator|->
name|smalmc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nodename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|out_ca
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|int
name|group
parameter_list|,
name|char
modifier|*
name|chname
parameter_list|)
block|{
name|char
modifier|*
name|node_type
decl_stmt|;
name|char
modifier|*
name|node_type2
decl_stmt|;
name|char
modifier|*
name|nodename
init|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
decl_stmt|;
name|out_ids
argument_list|(
name|node
argument_list|,
name|group
argument_list|,
name|chname
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|node
operator|->
name|type
condition|)
block|{
case|case
name|CA_NODE
case|:
name|node_type
operator|=
literal|"ca"
expr_stmt|;
name|node_type2
operator|=
literal|"Ca"
expr_stmt|;
break|break;
case|case
name|ROUTER_NODE
case|:
name|node_type
operator|=
literal|"rt"
expr_stmt|;
name|node_type2
operator|=
literal|"Rt"
expr_stmt|;
break|break;
default|default:
name|node_type
operator|=
literal|"???"
expr_stmt|;
name|node_type2
operator|=
literal|"???"
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%sguid=0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|node_type
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s\t%d %s\t\t# \"%s\""
argument_list|,
name|node_type2
argument_list|,
name|node
operator|->
name|numports
argument_list|,
name|node_name
argument_list|(
name|node
argument_list|)
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|&&
name|is_xsigo_hca
argument_list|(
name|node
operator|->
name|nodeguid
argument_list|)
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" (scp)"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nodename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|out_ext_port
parameter_list|(
name|Port
modifier|*
name|port
parameter_list|,
name|int
name|group
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|NULL
decl_stmt|;
comment|/* Currently, only if Voltaire chassis */
if|if
condition|(
name|group
operator|&&
name|port
operator|->
name|node
operator|->
name|chrecord
operator|&&
name|port
operator|->
name|node
operator|->
name|vendid
operator|==
name|VTR_VENDOR_ID
condition|)
name|str
operator|=
name|portmapstring
argument_list|(
name|port
argument_list|)
expr_stmt|;
return|return
operator|(
name|str
operator|)
return|;
block|}
end_function

begin_function
name|void
name|out_switch_port
parameter_list|(
name|Port
modifier|*
name|port
parameter_list|,
name|int
name|group
parameter_list|)
block|{
name|char
modifier|*
name|ext_port_str
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|rem_nodename
init|=
name|NULL
decl_stmt|;
name|DEBUG
argument_list|(
literal|"port %p:%d remoteport %p"
argument_list|,
name|port
argument_list|,
name|port
operator|->
name|portnum
argument_list|,
name|port
operator|->
name|remoteport
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"[%d]"
argument_list|,
name|port
operator|->
name|portnum
argument_list|)
expr_stmt|;
name|ext_port_str
operator|=
name|out_ext_port
argument_list|(
name|port
argument_list|,
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_port_str
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s"
argument_list|,
name|ext_port_str
argument_list|)
expr_stmt|;
name|rem_nodename
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|nodeguid
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
name|ext_port_str
operator|=
name|out_ext_port
argument_list|(
name|port
operator|->
name|remoteport
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t%s[%d]%s"
argument_list|,
name|node_name
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|node
argument_list|)
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|portnum
argument_list|,
name|ext_port_str
condition|?
name|ext_port_str
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|type
operator|!=
name|SWITCH_NODE
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"(%"
name|PRIx64
literal|") "
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|portguid
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t\t# \"%s\" lid %d %s%s"
argument_list|,
name|rem_nodename
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|type
operator|==
name|SWITCH_NODE
condition|?
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|smalid
else|:
name|port
operator|->
name|remoteport
operator|->
name|lid
argument_list|,
name|get_linkwidth_str
argument_list|(
name|port
operator|->
name|linkwidth
argument_list|)
argument_list|,
name|get_linkspeed_str
argument_list|(
name|port
operator|->
name|linkspeed
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_xsigo_tca
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|portguid
argument_list|)
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" slot %d"
argument_list|,
name|port
operator|->
name|portnum
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|is_xsigo_hca
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|portguid
argument_list|)
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" (scp)"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rem_nodename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|out_ca_port
parameter_list|(
name|Port
modifier|*
name|port
parameter_list|,
name|int
name|group
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|rem_nodename
init|=
name|NULL
decl_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"[%d]"
argument_list|,
name|port
operator|->
name|portnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|node
operator|->
name|type
operator|!=
name|SWITCH_NODE
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"(%"
name|PRIx64
literal|") "
argument_list|,
name|port
operator|->
name|portguid
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t%s[%d]"
argument_list|,
name|node_name
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|node
argument_list|)
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|portnum
argument_list|)
expr_stmt|;
name|str
operator|=
name|out_ext_port
argument_list|(
name|port
operator|->
name|remoteport
argument_list|,
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|type
operator|!=
name|SWITCH_NODE
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|" (%"
name|PRIx64
literal|") "
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|portguid
argument_list|)
expr_stmt|;
name|rem_nodename
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|nodeguid
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t\t# lid %d lmc %d \"%s\" lid %d %s%s\n"
argument_list|,
name|port
operator|->
name|lid
argument_list|,
name|port
operator|->
name|lmc
argument_list|,
name|rem_nodename
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|type
operator|==
name|SWITCH_NODE
condition|?
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|smalid
else|:
name|port
operator|->
name|remoteport
operator|->
name|lid
argument_list|,
name|get_linkwidth_str
argument_list|(
name|port
operator|->
name|linkwidth
argument_list|)
argument_list|,
name|get_linkspeed_str
argument_list|(
name|port
operator|->
name|linkspeed
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rem_nodename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|dump_topology
parameter_list|(
name|int
name|listtype
parameter_list|,
name|int
name|group
parameter_list|)
block|{
name|Node
modifier|*
name|node
decl_stmt|;
name|Port
modifier|*
name|port
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|,
name|dist
init|=
literal|0
decl_stmt|;
name|time_t
name|t
init|=
name|time
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|uint64_t
name|chguid
decl_stmt|;
name|char
modifier|*
name|chname
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|listtype
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"#\n# Topology file: generated on %s#\n"
argument_list|,
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"# Max of %d hops discovered\n"
argument_list|,
name|maxhops_discovered
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"# Initiated from node %016"
name|PRIx64
literal|" port %016"
name|PRIx64
literal|"\n"
argument_list|,
name|mynode
operator|->
name|nodeguid
argument_list|,
name|mynode
operator|->
name|portguid
argument_list|)
expr_stmt|;
block|}
comment|/* Make pass on switches */
if|if
condition|(
name|group
operator|&&
operator|!
name|listtype
condition|)
block|{
name|ChassisList
modifier|*
name|ch
init|=
name|NULL
decl_stmt|;
comment|/* Chassis based switches first */
for|for
control|(
name|ch
operator|=
name|chassis
init|;
name|ch
condition|;
name|ch
operator|=
name|ch
operator|->
name|next
control|)
block|{
name|int
name|n
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|ch
operator|->
name|chassisnum
condition|)
continue|continue;
name|chguid
operator|=
name|out_chassis
argument_list|(
name|ch
operator|->
name|chassisnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|chname
condition|)
name|free
argument_list|(
name|chname
argument_list|)
expr_stmt|;
name|chname
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|is_xsigo_guid
argument_list|(
name|chguid
argument_list|)
condition|)
block|{
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|MAXHOPS
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
block|{
if|if
condition|(
operator|!
name|node
operator|->
name|chrecord
operator|||
operator|!
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
condition|)
continue|continue;
if|if
condition|(
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
operator|!=
name|ch
operator|->
name|chassisnum
condition|)
continue|continue;
if|if
condition|(
name|is_xsigo_hca
argument_list|(
name|node
operator|->
name|nodeguid
argument_list|)
condition|)
block|{
name|chname
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"Hostname: %s\n"
argument_list|,
name|chname
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n# Spine Nodes"
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|1
init|;
name|n
operator|<=
operator|(
name|SPINES_MAX_NUM
operator|+
literal|1
operator|)
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|ch
operator|->
name|spinenode
index|[
name|n
index|]
condition|)
block|{
name|out_switch
argument_list|(
name|ch
operator|->
name|spinenode
index|[
name|n
index|]
argument_list|,
name|group
argument_list|,
name|chname
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
name|ch
operator|->
name|spinenode
index|[
name|n
index|]
operator|->
name|ports
init|;
name|port
condition|;
name|port
operator|=
name|port
operator|->
name|next
operator|,
name|i
operator|++
control|)
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
name|out_switch_port
argument_list|(
name|port
argument_list|,
name|group
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n# Line Nodes"
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|1
init|;
name|n
operator|<=
operator|(
name|LINES_MAX_NUM
operator|+
literal|1
operator|)
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|ch
operator|->
name|linenode
index|[
name|n
index|]
condition|)
block|{
name|out_switch
argument_list|(
name|ch
operator|->
name|linenode
index|[
name|n
index|]
argument_list|,
name|group
argument_list|,
name|chname
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
name|ch
operator|->
name|linenode
index|[
name|n
index|]
operator|->
name|ports
init|;
name|port
condition|;
name|port
operator|=
name|port
operator|->
name|next
operator|,
name|i
operator|++
control|)
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
name|out_switch_port
argument_list|(
name|port
argument_list|,
name|group
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n# Chassis Switches"
argument_list|)
expr_stmt|;
for|for
control|(
name|dist
operator|=
literal|0
init|;
name|dist
operator|<=
name|maxhops_discovered
condition|;
name|dist
operator|++
control|)
block|{
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|dist
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
block|{
comment|/* Non Voltaire chassis */
if|if
condition|(
name|node
operator|->
name|vendid
operator|==
name|VTR_VENDOR_ID
condition|)
continue|continue;
if|if
condition|(
operator|!
name|node
operator|->
name|chrecord
operator|||
operator|!
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
condition|)
continue|continue;
if|if
condition|(
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
operator|!=
name|ch
operator|->
name|chassisnum
condition|)
continue|continue;
name|out_switch
argument_list|(
name|node
argument_list|,
name|group
argument_list|,
name|chname
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
name|node
operator|->
name|ports
init|;
name|port
condition|;
name|port
operator|=
name|port
operator|->
name|next
operator|,
name|i
operator|++
control|)
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
name|out_switch_port
argument_list|(
name|port
argument_list|,
name|group
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n# Chassis CAs"
argument_list|)
expr_stmt|;
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|MAXHOPS
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
block|{
if|if
condition|(
operator|!
name|node
operator|->
name|chrecord
operator|||
operator|!
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
condition|)
continue|continue;
if|if
condition|(
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
operator|!=
name|ch
operator|->
name|chassisnum
condition|)
continue|continue;
name|out_ca
argument_list|(
name|node
argument_list|,
name|group
argument_list|,
name|chname
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
name|node
operator|->
name|ports
init|;
name|port
condition|;
name|port
operator|=
name|port
operator|->
name|next
operator|,
name|i
operator|++
control|)
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
name|out_ca_port
argument_list|(
name|port
argument_list|,
name|group
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
for|for
control|(
name|dist
operator|=
literal|0
init|;
name|dist
operator|<=
name|maxhops_discovered
condition|;
name|dist
operator|++
control|)
block|{
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|dist
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
block|{
name|DEBUG
argument_list|(
literal|"SWITCH: dist %d node %p"
argument_list|,
name|dist
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|listtype
condition|)
name|out_switch
argument_list|(
name|node
argument_list|,
name|group
argument_list|,
name|chname
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|listtype
operator|&
name|LIST_SWITCH_NODE
condition|)
name|list_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|port
operator|=
name|node
operator|->
name|ports
init|;
name|port
condition|;
name|port
operator|=
name|port
operator|->
name|next
operator|,
name|i
operator|++
control|)
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
name|out_switch_port
argument_list|(
name|port
argument_list|,
name|group
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|chname
condition|)
name|free
argument_list|(
name|chname
argument_list|)
expr_stmt|;
name|chname
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|group
operator|&&
operator|!
name|listtype
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\nNon-Chassis Nodes\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|dist
operator|=
literal|0
init|;
name|dist
operator|<=
name|maxhops_discovered
condition|;
name|dist
operator|++
control|)
block|{
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|dist
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
block|{
name|DEBUG
argument_list|(
literal|"SWITCH: dist %d node %p"
argument_list|,
name|dist
argument_list|,
name|node
argument_list|)
expr_stmt|;
comment|/* Now, skip chassis based switches */
if|if
condition|(
name|node
operator|->
name|chrecord
operator|&&
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
condition|)
continue|continue;
name|out_switch
argument_list|(
name|node
argument_list|,
name|group
argument_list|,
name|chname
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
name|node
operator|->
name|ports
init|;
name|port
condition|;
name|port
operator|=
name|port
operator|->
name|next
operator|,
name|i
operator|++
control|)
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
name|out_switch_port
argument_list|(
name|port
argument_list|,
name|group
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Make pass on CAs */
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|MAXHOPS
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
block|{
name|DEBUG
argument_list|(
literal|"CA: dist %d node %p"
argument_list|,
name|dist
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|listtype
condition|)
block|{
comment|/* Now, skip chassis based CAs */
if|if
condition|(
name|group
operator|&&
name|node
operator|->
name|chrecord
operator|&&
name|node
operator|->
name|chrecord
operator|->
name|chassisnum
condition|)
continue|continue;
name|out_ca
argument_list|(
name|node
argument_list|,
name|group
argument_list|,
name|chname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|listtype
operator|&
name|LIST_CA_NODE
operator|)
operator|&&
operator|(
name|node
operator|->
name|type
operator|==
name|CA_NODE
operator|)
operator|)
operator|||
operator|(
operator|(
name|listtype
operator|&
name|LIST_ROUTER_NODE
operator|)
operator|&&
operator|(
name|node
operator|->
name|type
operator|==
name|ROUTER_NODE
operator|)
operator|)
condition|)
name|list_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|port
operator|=
name|node
operator|->
name|ports
init|;
name|port
condition|;
name|port
operator|=
name|port
operator|->
name|next
operator|,
name|i
operator|++
control|)
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
name|out_ca_port
argument_list|(
name|port
argument_list|,
name|group
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|chname
condition|)
name|free
argument_list|(
name|chname
argument_list|)
expr_stmt|;
return|return
name|i
return|;
block|}
end_function

begin_function
name|void
name|dump_ports_report
parameter_list|()
block|{
name|int
name|b
decl_stmt|,
name|n
init|=
literal|0
decl_stmt|,
name|p
decl_stmt|;
name|Node
modifier|*
name|node
decl_stmt|;
name|Port
modifier|*
name|port
decl_stmt|;
comment|// If switch and LID == 0, search of other switch ports with
comment|// valid LID and assign it to all ports of that switch
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<=
name|MAXHOPS
condition|;
name|b
operator|++
control|)
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|b
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|SWITCH_NODE
condition|)
block|{
name|int
name|swlid
init|=
literal|0
decl_stmt|;
for|for
control|(
name|p
operator|=
literal|0
operator|,
name|port
operator|=
name|node
operator|->
name|ports
init|;
name|p
operator|<
name|node
operator|->
name|numports
operator|&&
name|port
operator|&&
operator|!
name|swlid
condition|;
name|port
operator|=
name|port
operator|->
name|next
control|)
if|if
condition|(
name|port
operator|->
name|lid
operator|!=
literal|0
condition|)
name|swlid
operator|=
name|port
operator|->
name|lid
expr_stmt|;
for|for
control|(
name|p
operator|=
literal|0
operator|,
name|port
operator|=
name|node
operator|->
name|ports
init|;
name|p
operator|<
name|node
operator|->
name|numports
operator|&&
name|port
condition|;
name|port
operator|=
name|port
operator|->
name|next
control|)
name|port
operator|->
name|lid
operator|=
name|swlid
expr_stmt|;
block|}
for|for
control|(
name|b
operator|=
literal|0
init|;
name|b
operator|<=
name|MAXHOPS
condition|;
name|b
operator|++
control|)
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|b
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
block|{
for|for
control|(
name|p
operator|=
literal|0
operator|,
name|port
operator|=
name|node
operator|->
name|ports
init|;
name|p
operator|<
name|node
operator|->
name|numports
operator|&&
name|port
condition|;
name|p
operator|++
operator|,
name|port
operator|=
name|port
operator|->
name|next
control|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%2s %5d %2d 0x%016"
name|PRIx64
literal|" %s %s"
argument_list|,
name|node_type_str2
argument_list|(
name|port
operator|->
name|node
argument_list|)
argument_list|,
name|port
operator|->
name|lid
argument_list|,
name|port
operator|->
name|portnum
argument_list|,
name|port
operator|->
name|portguid
argument_list|,
name|get_linkwidth_str
argument_list|(
name|port
operator|->
name|linkwidth
argument_list|)
argument_list|,
name|get_linkspeed_str
argument_list|(
name|port
operator|->
name|linkspeed
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|" - %2s %5d %2d 0x%016"
name|PRIx64
literal|" ( '%s' - '%s' )\n"
argument_list|,
name|node_type_str2
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|node
argument_list|)
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|lid
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|portnum
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|portguid
argument_list|,
name|port
operator|->
name|node
operator|->
name|nodedesc
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%36s'%s'\n"
argument_list|,
literal|""
argument_list|,
name|port
operator|->
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
block|}
name|n
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-d(ebug)] -e(rr_show) -v(erbose) -s(how) -l(ist) -g(rouping) -H(ca_list) -S(witch_list) -R(outer_list) -V(ersion) -C ca_name -P ca_port "
literal|"-t(imeout) timeout_ms --node-name-map node-name-map] -p(orts) [<topology-file>]\n"
argument_list|,
name|argv0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"       --node-name-map<node-name-map> specify a node name map file\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|mgmt_classes
index|[
literal|2
index|]
init|=
block|{
name|IB_SMI_CLASS
block|,
name|IB_SMI_DIRECT_CLASS
block|}
decl_stmt|;
name|ib_portid_t
name|my_portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|udebug
init|=
literal|0
decl_stmt|,
name|list
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|ca
init|=
literal|0
decl_stmt|;
name|int
name|ca_port
init|=
literal|0
decl_stmt|;
name|int
name|group
init|=
literal|0
decl_stmt|;
name|int
name|ports_report
init|=
literal|0
decl_stmt|;
specifier|static
name|char
specifier|const
name|str_opts
index|[]
init|=
literal|"C:P:t:devslgHSRpVhu"
decl_stmt|;
specifier|static
specifier|const
name|struct
name|option
name|long_opts
index|[]
init|=
block|{
block|{
literal|"C"
block|,
literal|1
block|,
literal|0
block|,
literal|'C'
block|}
block|,
block|{
literal|"P"
block|,
literal|1
block|,
literal|0
block|,
literal|'P'
block|}
block|,
block|{
literal|"debug"
block|,
literal|0
block|,
literal|0
block|,
literal|'d'
block|}
block|,
block|{
literal|"err_show"
block|,
literal|0
block|,
literal|0
block|,
literal|'e'
block|}
block|,
block|{
literal|"verbose"
block|,
literal|0
block|,
literal|0
block|,
literal|'v'
block|}
block|,
block|{
literal|"show"
block|,
literal|0
block|,
literal|0
block|,
literal|'s'
block|}
block|,
block|{
literal|"list"
block|,
literal|0
block|,
literal|0
block|,
literal|'l'
block|}
block|,
block|{
literal|"grouping"
block|,
literal|0
block|,
literal|0
block|,
literal|'g'
block|}
block|,
block|{
literal|"Hca_list"
block|,
literal|0
block|,
literal|0
block|,
literal|'H'
block|}
block|,
block|{
literal|"Switch_list"
block|,
literal|0
block|,
literal|0
block|,
literal|'S'
block|}
block|,
block|{
literal|"Router_list"
block|,
literal|0
block|,
literal|0
block|,
literal|'R'
block|}
block|,
block|{
literal|"timeout"
block|,
literal|1
block|,
literal|0
block|,
literal|'t'
block|}
block|,
block|{
literal|"node-name-map"
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
literal|"ports"
block|,
literal|0
block|,
literal|0
block|,
literal|'p'
block|}
block|,
block|{
literal|"Version"
block|,
literal|0
block|,
literal|0
block|,
literal|'V'
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
literal|0
block|,
literal|'h'
block|}
block|,
block|{
literal|"usage"
block|,
literal|0
block|,
literal|0
block|,
literal|'u'
block|}
block|,
block|{ }
block|}
decl_stmt|;
name|f
operator|=
name|stdout
expr_stmt|;
name|argv0
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|ch
init|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|str_opts
argument_list|,
name|long_opts
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|ch
operator|==
operator|-
literal|1
condition|)
break|break;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|1
case|:
name|node_name_map_file
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|ca
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|ca_port
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|ibdebug
operator|++
expr_stmt|;
name|madrpc_show_errors
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|umad_debug
argument_list|(
name|udebug
argument_list|)
expr_stmt|;
name|udebug
operator|++
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|timeout
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
name|dumplevel
operator|++
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|dumplevel
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|madrpc_show_errors
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|list
operator|=
name|LIST_CA_NODE
operator||
name|LIST_SWITCH_NODE
operator||
name|LIST_ROUTER_NODE
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|group
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|list
operator|=
name|LIST_SWITCH_NODE
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|list
operator|=
name|LIST_CA_NODE
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|list
operator|=
name|LIST_ROUTER_NODE
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s %s\n"
argument_list|,
name|argv0
argument_list|,
name|get_build_version
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
case|case
literal|'p'
case|:
name|ports_report
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|&&
operator|!
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"w"
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"can't open file %s for writing"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|madrpc_init
argument_list|(
name|ca
argument_list|,
name|ca_port
argument_list|,
name|mgmt_classes
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|node_name_map
operator|=
name|open_node_name_map
argument_list|(
name|node_name_map_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|discover
argument_list|(
operator|&
name|my_portid
argument_list|)
operator|<
literal|0
condition|)
name|IBERROR
argument_list|(
literal|"discover"
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
condition|)
name|chassis
operator|=
name|group_nodes
argument_list|()
expr_stmt|;
if|if
condition|(
name|ports_report
condition|)
name|dump_ports_report
argument_list|()
expr_stmt|;
else|else
name|dump_topology
argument_list|(
name|list
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|close_node_name_map
argument_list|(
name|node_name_map
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


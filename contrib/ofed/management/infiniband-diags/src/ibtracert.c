begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2008 Voltaire Inc.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/common.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/umad.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/mad.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_nodenamemap.h>
end_include

begin_include
include|#
directive|include
file|"ibdiag_common.h"
end_include

begin_define
define|#
directive|define
name|MAXHOPS
value|63
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|node_type_str
index|[]
init|=
block|{
literal|"???"
block|,
literal|"ca"
block|,
literal|"switch"
block|,
literal|"router"
block|,
literal|"iwarp rnic"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|timeout
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ms */
end_comment

begin_decl_stmt
specifier|static
name|int
name|verbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|force
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|FILE
modifier|*
name|f
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|argv0
init|=
literal|"ibtracert"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|node_name_map_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|nn_map_t
modifier|*
name|node_name_map
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|struct
name|Port
name|Port
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|Switch
name|Switch
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|Node
name|Node
typedef|;
end_typedef

begin_struct
struct|struct
name|Port
block|{
name|Port
modifier|*
name|next
decl_stmt|;
name|Port
modifier|*
name|remoteport
decl_stmt|;
name|uint64_t
name|portguid
decl_stmt|;
name|int
name|portnum
decl_stmt|;
name|int
name|lid
decl_stmt|;
name|int
name|lmc
decl_stmt|;
name|int
name|state
decl_stmt|;
name|int
name|physstate
decl_stmt|;
name|char
name|portinfo
index|[
literal|64
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|Switch
block|{
name|int
name|linearcap
decl_stmt|;
name|int
name|mccap
decl_stmt|;
name|int
name|linearFDBtop
decl_stmt|;
name|int
name|fdb_base
decl_stmt|;
name|int8_t
name|fdb
index|[
literal|64
index|]
decl_stmt|;
name|char
name|switchinfo
index|[
literal|64
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|Node
block|{
name|Node
modifier|*
name|htnext
decl_stmt|;
name|Node
modifier|*
name|dnext
decl_stmt|;
name|Port
modifier|*
name|ports
decl_stmt|;
name|ib_portid_t
name|path
decl_stmt|;
name|int
name|type
decl_stmt|;
name|int
name|dist
decl_stmt|;
name|int
name|numports
decl_stmt|;
name|int
name|upport
decl_stmt|;
name|Node
modifier|*
name|upnode
decl_stmt|;
name|uint64_t
name|nodeguid
decl_stmt|;
comment|/* also portguid */
name|char
name|nodedesc
index|[
literal|64
index|]
decl_stmt|;
name|char
name|nodeinfo
index|[
literal|64
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|Node
modifier|*
name|nodesdist
index|[
name|MAXHOPS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|target_portguid
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|get_node
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|)
block|{
name|void
modifier|*
name|pi
init|=
name|port
operator|->
name|portinfo
decl_stmt|,
modifier|*
name|ni
init|=
name|node
operator|->
name|nodeinfo
decl_stmt|,
modifier|*
name|nd
init|=
name|node
operator|->
name|nodedesc
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|e
decl_stmt|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|ni
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_NODE_INFO
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|nd
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_NODE_DESC
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|s
operator|=
name|nd
operator|,
name|e
operator|=
name|s
operator|+
literal|64
init|;
name|s
operator|<
name|e
condition|;
name|s
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|*
name|s
condition|)
break|break;
if|if
condition|(
operator|!
name|isprint
argument_list|(
operator|*
name|s
argument_list|)
condition|)
operator|*
name|s
operator|=
literal|' '
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|pi
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_GUID_F
argument_list|,
operator|&
name|node
operator|->
name|nodeguid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_TYPE_F
argument_list|,
operator|&
name|node
operator|->
name|type
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_NPORTS_F
argument_list|,
operator|&
name|node
operator|->
name|numports
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_PORT_GUID_F
argument_list|,
operator|&
name|port
operator|->
name|portguid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_LOCAL_PORT_F
argument_list|,
operator|&
name|port
operator|->
name|portnum
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_LID_F
argument_list|,
operator|&
name|port
operator|->
name|lid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_LMC_F
argument_list|,
operator|&
name|port
operator|->
name|lmc
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_STATE_F
argument_list|,
operator|&
name|port
operator|->
name|state
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|"portid %s: got node %"
name|PRIx64
literal|" '%s'"
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|switch_lookup
parameter_list|(
name|Switch
modifier|*
name|sw
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|int
name|lid
parameter_list|)
block|{
name|void
modifier|*
name|si
init|=
name|sw
operator|->
name|switchinfo
decl_stmt|,
modifier|*
name|fdb
init|=
name|sw
operator|->
name|fdb
decl_stmt|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|si
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_SWITCH_INFO
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|mad_decode_field
argument_list|(
name|si
argument_list|,
name|IB_SW_LINEAR_FDB_CAP_F
argument_list|,
operator|&
name|sw
operator|->
name|linearcap
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|si
argument_list|,
name|IB_SW_LINEAR_FDB_TOP_F
argument_list|,
operator|&
name|sw
operator|->
name|linearFDBtop
argument_list|)
expr_stmt|;
if|if
condition|(
name|lid
operator|>
name|sw
operator|->
name|linearcap
operator|&&
name|lid
operator|>
name|sw
operator|->
name|linearFDBtop
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|fdb
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_LINEARFORWTBL
argument_list|,
name|lid
operator|/
literal|64
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|DEBUG
argument_list|(
literal|"portid %s: forward lid %d to port %d"
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|lid
argument_list|,
name|sw
operator|->
name|fdb
index|[
name|lid
operator|%
literal|64
index|]
argument_list|)
expr_stmt|;
return|return
name|sw
operator|->
name|fdb
index|[
name|lid
operator|%
literal|64
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sameport
parameter_list|(
name|Port
modifier|*
name|a
parameter_list|,
name|Port
modifier|*
name|b
parameter_list|)
block|{
return|return
name|a
operator|->
name|portguid
operator|==
name|b
operator|->
name|portguid
operator|||
operator|(
name|force
operator|&&
name|a
operator|->
name|lid
operator|==
name|b
operator|->
name|lid
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|extend_dpath
parameter_list|(
name|ib_dr_path_t
modifier|*
name|path
parameter_list|,
name|int
name|nextport
parameter_list|)
block|{
if|if
condition|(
name|path
operator|->
name|cnt
operator|+
literal|2
operator|>=
sizeof|sizeof
argument_list|(
name|path
operator|->
name|p
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
operator|++
name|path
operator|->
name|cnt
expr_stmt|;
name|path
operator|->
name|p
index|[
name|path
operator|->
name|cnt
index|]
operator|=
name|nextport
expr_stmt|;
return|return
name|path
operator|->
name|cnt
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_endnode
parameter_list|(
name|int
name|dump
parameter_list|,
name|char
modifier|*
name|prompt
parameter_list|,
name|Node
modifier|*
name|node
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|)
block|{
name|char
modifier|*
name|nodename
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|dump
condition|)
return|return;
if|if
condition|(
name|dump
operator|==
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s {0x%016"
name|PRIx64
literal|"}[%d]\n"
argument_list|,
name|prompt
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|?
literal|0
else|:
name|port
operator|->
name|portnum
argument_list|)
expr_stmt|;
return|return;
block|}
name|nodename
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s %s {0x%016"
name|PRIx64
literal|"} portnum %d lid %u-%u \"%s\"\n"
argument_list|,
name|prompt
argument_list|,
operator|(
name|node
operator|->
name|type
operator|<=
name|IB_NODE_MAX
condition|?
name|node_type_str
index|[
name|node
operator|->
name|type
index|]
else|:
literal|"???"
operator|)
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|?
literal|0
else|:
name|port
operator|->
name|portnum
argument_list|,
name|port
operator|->
name|lid
argument_list|,
name|port
operator|->
name|lid
operator|+
operator|(
literal|1
operator|<<
name|port
operator|->
name|lmc
operator|)
operator|-
literal|1
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nodename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_route
parameter_list|(
name|int
name|dump
parameter_list|,
name|Node
modifier|*
name|node
parameter_list|,
name|int
name|outport
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|)
block|{
name|char
modifier|*
name|nodename
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|dump
operator|&&
operator|!
name|verbose
condition|)
return|return;
name|nodename
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump
operator|==
literal|1
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"[%d] -> {0x%016"
name|PRIx64
literal|"}[%d]\n"
argument_list|,
name|outport
argument_list|,
name|port
operator|->
name|portguid
argument_list|,
name|port
operator|->
name|portnum
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"[%d] -> %s port {0x%016"
name|PRIx64
literal|"}[%d] lid %u-%u \"%s\"\n"
argument_list|,
name|outport
argument_list|,
operator|(
name|node
operator|->
name|type
operator|<=
name|IB_NODE_MAX
condition|?
name|node_type_str
index|[
name|node
operator|->
name|type
index|]
else|:
literal|"???"
operator|)
argument_list|,
name|port
operator|->
name|portguid
argument_list|,
name|port
operator|->
name|portnum
argument_list|,
name|port
operator|->
name|lid
argument_list|,
name|port
operator|->
name|lid
operator|+
operator|(
literal|1
operator|<<
name|port
operator|->
name|lmc
operator|)
operator|-
literal|1
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nodename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|find_route
parameter_list|(
name|ib_portid_t
modifier|*
name|from
parameter_list|,
name|ib_portid_t
modifier|*
name|to
parameter_list|,
name|int
name|dump
parameter_list|)
block|{
name|Node
modifier|*
name|node
decl_stmt|,
name|fromnode
decl_stmt|,
name|tonode
decl_stmt|,
name|nextnode
decl_stmt|;
name|Port
modifier|*
name|port
decl_stmt|,
name|fromport
decl_stmt|,
name|toport
decl_stmt|,
name|nextport
decl_stmt|;
name|Switch
name|sw
decl_stmt|;
name|int
name|maxhops
init|=
name|MAXHOPS
decl_stmt|;
name|int
name|portnum
decl_stmt|,
name|outport
decl_stmt|;
name|DEBUG
argument_list|(
literal|"from %s"
argument_list|,
name|portid2str
argument_list|(
name|from
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_node
argument_list|(
operator|&
name|fromnode
argument_list|,
operator|&
name|fromport
argument_list|,
name|from
argument_list|)
operator|<
literal|0
operator|||
name|get_node
argument_list|(
operator|&
name|tonode
argument_list|,
operator|&
name|toport
argument_list|,
name|to
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't reach to/from ports"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|force
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|to
operator|->
name|lid
operator|>
literal|0
condition|)
name|toport
operator|.
name|lid
operator|=
name|to
operator|->
name|lid
expr_stmt|;
name|IBWARN
argument_list|(
literal|"Force: look for lid %d"
argument_list|,
name|to
operator|->
name|lid
argument_list|)
expr_stmt|;
block|}
name|node
operator|=
operator|&
name|fromnode
expr_stmt|;
name|port
operator|=
operator|&
name|fromport
expr_stmt|;
name|portnum
operator|=
name|port
operator|->
name|portnum
expr_stmt|;
name|dump_endnode
argument_list|(
name|dump
argument_list|,
literal|"From"
argument_list|,
name|node
argument_list|,
name|port
argument_list|)
expr_stmt|;
while|while
condition|(
name|maxhops
operator|--
condition|)
block|{
if|if
condition|(
name|port
operator|->
name|state
operator|!=
literal|4
condition|)
goto|goto
name|badport
goto|;
if|if
condition|(
name|sameport
argument_list|(
name|port
argument_list|,
operator|&
name|toport
argument_list|)
condition|)
break|break;
comment|/* found */
name|outport
operator|=
name|portnum
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
block|{
name|DEBUG
argument_list|(
literal|"switch node"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|outport
operator|=
name|switch_lookup
argument_list|(
operator|&
name|sw
argument_list|,
name|from
argument_list|,
name|to
operator|->
name|lid
argument_list|)
operator|)
operator|<
literal|0
operator|||
name|outport
operator|>
name|node
operator|->
name|numports
condition|)
goto|goto
name|badtbl
goto|;
if|if
condition|(
name|extend_dpath
argument_list|(
operator|&
name|from
operator|->
name|drpath
argument_list|,
name|outport
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|badpath
goto|;
if|if
condition|(
name|get_node
argument_list|(
operator|&
name|nextnode
argument_list|,
operator|&
name|nextport
argument_list|,
name|from
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't reach port at %s"
argument_list|,
name|portid2str
argument_list|(
name|from
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|outport
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|sameport
argument_list|(
operator|&
name|nextport
argument_list|,
operator|&
name|toport
argument_list|)
condition|)
goto|goto
name|badtbl
goto|;
else|else
break|break;
comment|/* found SMA port */
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_CA
operator|)
operator|||
operator|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_ROUTER
operator|)
condition|)
block|{
name|int
name|ca_src
init|=
literal|0
decl_stmt|;
name|DEBUG
argument_list|(
literal|"ca or router node"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sameport
argument_list|(
name|port
argument_list|,
operator|&
name|fromport
argument_list|)
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't continue: reached CA or router port %"
name|PRIx64
literal|", lid %d"
argument_list|,
name|port
operator|->
name|portguid
argument_list|,
name|port
operator|->
name|lid
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* we are at CA or router "from" - go one hop back to (hopefully) a switch */
if|if
condition|(
name|from
operator|->
name|drpath
operator|.
name|cnt
operator|>
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
literal|"ca or router node - return back 1 hop"
argument_list|)
expr_stmt|;
name|from
operator|->
name|drpath
operator|.
name|cnt
operator|--
expr_stmt|;
block|}
else|else
block|{
name|ca_src
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|portnum
operator|&&
name|extend_dpath
argument_list|(
operator|&
name|from
operator|->
name|drpath
argument_list|,
name|portnum
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|badpath
goto|;
block|}
if|if
condition|(
name|get_node
argument_list|(
operator|&
name|nextnode
argument_list|,
operator|&
name|nextport
argument_list|,
name|from
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't reach port at %s"
argument_list|,
name|portid2str
argument_list|(
name|from
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* fix port num to be seen from the CA or router side */
if|if
condition|(
operator|!
name|ca_src
condition|)
name|nextport
operator|.
name|portnum
operator|=
name|from
operator|->
name|drpath
operator|.
name|p
index|[
name|from
operator|->
name|drpath
operator|.
name|cnt
operator|+
literal|1
index|]
expr_stmt|;
block|}
name|port
operator|=
operator|&
name|nextport
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|state
operator|!=
literal|4
condition|)
goto|goto
name|badoutport
goto|;
name|node
operator|=
operator|&
name|nextnode
expr_stmt|;
name|portnum
operator|=
name|port
operator|->
name|portnum
expr_stmt|;
name|dump_route
argument_list|(
name|dump
argument_list|,
name|node
argument_list|,
name|outport
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|maxhops
operator|<=
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"no route found after %d hops"
argument_list|,
name|MAXHOPS
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dump_endnode
argument_list|(
name|dump
argument_list|,
literal|"To"
argument_list|,
name|node
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|badport
label|:
name|IBWARN
argument_list|(
literal|"Bad port state found: node \"%s\" port %d state %d"
argument_list|,
name|clean_nodedesc
argument_list|(
name|node
operator|->
name|nodedesc
argument_list|)
argument_list|,
name|portnum
argument_list|,
name|port
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
name|badoutport
label|:
name|IBWARN
argument_list|(
literal|"Bad out port state found: node \"%s\" outport %d state %d"
argument_list|,
name|clean_nodedesc
argument_list|(
name|node
operator|->
name|nodedesc
argument_list|)
argument_list|,
name|outport
argument_list|,
name|port
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
name|badtbl
label|:
name|IBWARN
argument_list|(
literal|"Bad forwarding table entry found at: node \"%s\" lid entry %d is %d (top %d)"
argument_list|,
name|clean_nodedesc
argument_list|(
name|node
operator|->
name|nodedesc
argument_list|)
argument_list|,
name|to
operator|->
name|lid
argument_list|,
name|outport
argument_list|,
name|sw
operator|.
name|linearFDBtop
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
name|badpath
label|:
name|IBWARN
argument_list|(
literal|"Direct path too long!"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/**************************  * MC span part  */
end_comment

begin_define
define|#
directive|define
name|HASHGUID
parameter_list|(
name|guid
parameter_list|)
value|((uint32_t)(((uint32_t)(guid) * 101) ^ ((uint32_t)((guid)>> 32) * 103)))
end_define

begin_define
define|#
directive|define
name|HTSZ
value|137
end_define

begin_function
specifier|static
name|int
name|insert_node
parameter_list|(
name|Node
modifier|*
name|new
parameter_list|)
block|{
specifier|static
name|Node
modifier|*
name|nodestbl
index|[
name|HTSZ
index|]
decl_stmt|;
name|int
name|hash
init|=
name|HASHGUID
argument_list|(
name|new
operator|->
name|nodeguid
argument_list|)
operator|%
name|HTSZ
decl_stmt|;
name|Node
modifier|*
name|node
decl_stmt|;
for|for
control|(
name|node
operator|=
name|nodestbl
index|[
name|hash
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|htnext
control|)
if|if
condition|(
name|node
operator|->
name|nodeguid
operator|==
name|new
operator|->
name|nodeguid
condition|)
block|{
name|DEBUG
argument_list|(
literal|"node %"
name|PRIx64
literal|" already exists"
argument_list|,
name|new
operator|->
name|nodeguid
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|new
operator|->
name|htnext
operator|=
name|nodestbl
index|[
name|hash
index|]
expr_stmt|;
name|nodestbl
index|[
name|hash
index|]
operator|=
name|new
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_port
parameter_list|(
name|Port
modifier|*
name|port
parameter_list|,
name|int
name|portnum
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|)
block|{
name|char
name|portinfo
index|[
literal|64
index|]
decl_stmt|;
name|void
modifier|*
name|pi
init|=
name|portinfo
decl_stmt|;
name|port
operator|->
name|portnum
operator|=
name|portnum
expr_stmt|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|pi
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
name|portnum
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_LID_F
argument_list|,
operator|&
name|port
operator|->
name|lid
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_LMC_F
argument_list|,
operator|&
name|port
operator|->
name|lmc
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_STATE_F
argument_list|,
operator|&
name|port
operator|->
name|state
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|IB_PORT_PHYS_STATE_F
argument_list|,
operator|&
name|port
operator|->
name|physstate
argument_list|)
expr_stmt|;
name|VERBOSE
argument_list|(
literal|"portid %s portnum %d: lid %d state %d physstate %d"
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|portnum
argument_list|,
name|port
operator|->
name|lid
argument_list|,
name|port
operator|->
name|state
argument_list|,
name|port
operator|->
name|physstate
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|link_port
parameter_list|(
name|Port
modifier|*
name|port
parameter_list|,
name|Node
modifier|*
name|node
parameter_list|)
block|{
name|port
operator|->
name|next
operator|=
name|node
operator|->
name|ports
expr_stmt|;
name|node
operator|->
name|ports
operator|=
name|port
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|new_node
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|Port
modifier|*
name|port
parameter_list|,
name|ib_portid_t
modifier|*
name|path
parameter_list|,
name|int
name|dist
parameter_list|)
block|{
if|if
condition|(
name|port
operator|->
name|portguid
operator|==
name|target_portguid
condition|)
block|{
name|node
operator|->
name|dist
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* tag as target */
name|link_port
argument_list|(
name|port
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|dump_endnode
argument_list|(
name|verbose
argument_list|,
literal|"found target"
argument_list|,
name|node
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
comment|/* found; */
block|}
comment|/* BFS search start with my self */
if|if
condition|(
name|insert_node
argument_list|(
name|node
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* known switch */
name|VERBOSE
argument_list|(
literal|"insert dist %d node %p port %d lid %d"
argument_list|,
name|dist
argument_list|,
name|node
argument_list|,
name|port
operator|->
name|portnum
argument_list|,
name|port
operator|->
name|lid
argument_list|)
expr_stmt|;
name|link_port
argument_list|(
name|port
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|node
operator|->
name|dist
operator|=
name|dist
expr_stmt|;
name|node
operator|->
name|path
operator|=
operator|*
name|path
expr_stmt|;
name|node
operator|->
name|dnext
operator|=
name|nodesdist
index|[
name|dist
index|]
expr_stmt|;
name|nodesdist
index|[
name|dist
index|]
operator|=
name|node
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|switch_mclookup
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|int
name|mlid
parameter_list|,
name|char
modifier|*
name|map
parameter_list|)
block|{
name|Switch
name|sw
decl_stmt|;
name|char
name|mdb
index|[
literal|64
index|]
decl_stmt|;
name|void
modifier|*
name|si
init|=
name|sw
operator|.
name|switchinfo
decl_stmt|;
name|uint16_t
modifier|*
name|msets
init|=
operator|(
name|uint16_t
operator|*
operator|)
name|mdb
decl_stmt|;
name|int
name|maxsets
decl_stmt|,
name|block
decl_stmt|,
name|i
decl_stmt|,
name|set
decl_stmt|;
name|memset
argument_list|(
name|map
argument_list|,
literal|0
argument_list|,
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|si
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_SWITCH_INFO
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|mlid
operator|-=
literal|0xc000
expr_stmt|;
name|mad_decode_field
argument_list|(
name|si
argument_list|,
name|IB_SW_MCAST_FDB_CAP_F
argument_list|,
operator|&
name|sw
operator|.
name|mccap
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlid
operator|>
name|sw
operator|.
name|mccap
condition|)
return|return
operator|-
literal|1
return|;
name|block
operator|=
name|mlid
operator|/
literal|32
expr_stmt|;
name|maxsets
operator|=
operator|(
name|node
operator|->
name|numports
operator|+
literal|15
operator|)
operator|/
literal|16
expr_stmt|;
comment|/* round up */
for|for
control|(
name|set
operator|=
literal|0
init|;
name|set
operator|<
name|maxsets
condition|;
name|set
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|smp_query
argument_list|(
name|mdb
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_MULTICASTFORWTBL
argument_list|,
name|block
operator||
operator|(
name|set
operator|<<
literal|28
operator|)
argument_list|,
name|timeout
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
operator|,
name|map
operator|++
control|)
block|{
name|uint16_t
name|mask
init|=
name|ntohs
argument_list|(
name|msets
index|[
name|mlid
operator|%
literal|32
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|mask
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
operator|*
name|map
operator|=
literal|1
expr_stmt|;
else|else
continue|continue;
name|VERBOSE
argument_list|(
literal|"Switch guid 0x%"
name|PRIx64
literal|": mlid 0x%x is forwarded to port %d"
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|mlid
operator|+
literal|0xc000
argument_list|,
name|i
operator|+
name|set
operator|*
literal|16
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Return 1 if found, 0 if not, -1 on errors.  */
end_comment

begin_function
specifier|static
name|Node
modifier|*
name|find_mcpath
parameter_list|(
name|ib_portid_t
modifier|*
name|from
parameter_list|,
name|int
name|mlid
parameter_list|)
block|{
name|Node
modifier|*
name|node
decl_stmt|,
modifier|*
name|remotenode
decl_stmt|;
name|Port
modifier|*
name|port
decl_stmt|,
modifier|*
name|remoteport
decl_stmt|;
name|char
name|map
index|[
literal|256
index|]
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
name|int
name|dist
init|=
literal|0
decl_stmt|,
name|leafport
init|=
literal|0
decl_stmt|;
name|ib_portid_t
modifier|*
name|path
decl_stmt|;
name|DEBUG
argument_list|(
literal|"from %s"
argument_list|,
name|portid2str
argument_list|(
name|from
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|node
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|Node
argument_list|)
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|port
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|Port
argument_list|)
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_node
argument_list|(
name|node
argument_list|,
name|port
argument_list|,
name|from
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't reach node %s"
argument_list|,
name|portid2str
argument_list|(
name|from
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|node
operator|->
name|upnode
operator|=
literal|0
expr_stmt|;
comment|/* root */
if|if
condition|(
operator|(
name|r
operator|=
name|new_node
argument_list|(
name|node
argument_list|,
name|port
argument_list|,
name|from
argument_list|,
literal|0
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|node
operator|->
name|type
operator|!=
name|IB_NODE_SWITCH
condition|)
block|{
name|IBWARN
argument_list|(
literal|"ibtracert from CA to CA is unsupported"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
comment|/* ibtracert from host to itself is unsupported */
block|}
if|if
condition|(
name|switch_mclookup
argument_list|(
name|node
argument_list|,
name|from
argument_list|,
name|mlid
argument_list|,
name|map
argument_list|)
operator|<
literal|0
operator|||
operator|!
name|map
index|[
literal|0
index|]
condition|)
return|return
literal|0
return|;
return|return
name|node
return|;
block|}
for|for
control|(
name|dist
operator|=
literal|0
init|;
name|dist
operator|<
name|MAXHOPS
condition|;
name|dist
operator|++
control|)
block|{
for|for
control|(
name|node
operator|=
name|nodesdist
index|[
name|dist
index|]
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|dnext
control|)
block|{
name|path
operator|=
operator|&
name|node
operator|->
name|path
expr_stmt|;
name|VERBOSE
argument_list|(
literal|"dist %d node %p"
argument_list|,
name|dist
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|dump_endnode
argument_list|(
name|verbose
argument_list|,
literal|"processing"
argument_list|,
name|node
argument_list|,
name|node
operator|->
name|ports
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|map
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|map
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|type
operator|!=
name|IB_NODE_SWITCH
condition|)
block|{
if|if
condition|(
name|dist
condition|)
continue|continue;
name|leafport
operator|=
name|path
operator|->
name|drpath
operator|.
name|p
index|[
name|path
operator|->
name|drpath
operator|.
name|cnt
index|]
expr_stmt|;
name|map
index|[
name|port
operator|->
name|portnum
index|]
operator|=
literal|1
expr_stmt|;
name|node
operator|->
name|upport
operator|=
literal|0
expr_stmt|;
comment|/* starting here */
name|DEBUG
argument_list|(
literal|"Starting from CA 0x%"
name|PRIx64
literal|" lid %d port %d (leafport %d)"
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|port
operator|->
name|lid
argument_list|,
name|port
operator|->
name|portnum
argument_list|,
name|leafport
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* switch */
comment|/* if starting from a leaf port fix up port (up port) */
if|if
condition|(
name|dist
operator|==
literal|1
operator|&&
name|leafport
condition|)
name|node
operator|->
name|upport
operator|=
name|leafport
expr_stmt|;
if|if
condition|(
name|switch_mclookup
argument_list|(
name|node
argument_list|,
name|path
argument_list|,
name|mlid
argument_list|,
name|map
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"skipping bad Switch 0x%"
name|PRIx64
literal|""
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|node
operator|->
name|numports
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|map
index|[
name|i
index|]
operator|||
name|i
operator|==
name|node
operator|->
name|upport
condition|)
continue|continue;
if|if
condition|(
name|dist
operator|==
literal|0
operator|&&
name|leafport
condition|)
block|{
if|if
condition|(
name|from
operator|->
name|drpath
operator|.
name|cnt
operator|>
literal|0
condition|)
name|path
operator|->
name|drpath
operator|.
name|cnt
operator|--
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|port
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|Port
argument_list|)
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_port
argument_list|(
name|port
argument_list|,
name|i
argument_list|,
name|path
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't reach node %s port %d"
argument_list|,
name|portid2str
argument_list|(
name|path
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|port
operator|->
name|physstate
operator|!=
literal|5
condition|)
block|{
comment|/* LinkUP */
name|free
argument_list|(
name|port
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|#
directive|if
literal|0
block|link_port(port, node);
endif|#
directive|endif
if|if
condition|(
name|extend_dpath
argument_list|(
operator|&
name|path
operator|->
name|drpath
argument_list|,
name|i
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|remotenode
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|Node
argument_list|)
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|remoteport
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|Port
argument_list|)
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"out of memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_node
argument_list|(
name|remotenode
argument_list|,
name|remoteport
argument_list|,
name|path
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"NodeInfo on %s port %d failed, skipping port"
argument_list|,
name|portid2str
argument_list|(
name|path
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|path
operator|->
name|drpath
operator|.
name|cnt
operator|--
expr_stmt|;
comment|/* restore path */
name|free
argument_list|(
name|remotenode
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|remoteport
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|remotenode
operator|->
name|upnode
operator|=
name|node
expr_stmt|;
name|remotenode
operator|->
name|upport
operator|=
name|remoteport
operator|->
name|portnum
expr_stmt|;
name|remoteport
operator|->
name|remoteport
operator|=
name|port
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|new_node
argument_list|(
name|remotenode
argument_list|,
name|remoteport
argument_list|,
name|path
argument_list|,
name|dist
operator|+
literal|1
argument_list|)
operator|)
operator|>
literal|0
condition|)
return|return
name|remotenode
return|;
if|if
condition|(
name|r
operator|==
literal|0
condition|)
name|dump_endnode
argument_list|(
name|verbose
argument_list|,
literal|"new remote"
argument_list|,
name|remotenode
argument_list|,
name|remoteport
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|remotenode
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
name|dump_endnode
argument_list|(
literal|2
argument_list|,
literal|"ERR: circle discovered at"
argument_list|,
name|remotenode
argument_list|,
name|remoteport
argument_list|)
expr_stmt|;
name|path
operator|->
name|drpath
operator|.
name|cnt
operator|--
expr_stmt|;
comment|/* restore path */
block|}
block|}
block|}
return|return
literal|0
return|;
comment|/* not found */
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|find_target_portguid
parameter_list|(
name|ib_portid_t
modifier|*
name|to
parameter_list|)
block|{
name|Node
name|tonode
decl_stmt|;
name|Port
name|toport
decl_stmt|;
if|if
condition|(
name|get_node
argument_list|(
operator|&
name|tonode
argument_list|,
operator|&
name|toport
argument_list|,
name|to
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't find to port\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|toport
operator|.
name|portguid
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_mcpath
parameter_list|(
name|Node
modifier|*
name|node
parameter_list|,
name|int
name|dumplevel
parameter_list|)
block|{
name|char
modifier|*
name|nodename
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|node
operator|->
name|upnode
condition|)
name|dump_mcpath
argument_list|(
name|node
operator|->
name|upnode
argument_list|,
name|dumplevel
argument_list|)
expr_stmt|;
name|nodename
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|node
operator|->
name|dist
condition|)
block|{
name|printf
argument_list|(
literal|"From %s 0x%"
name|PRIx64
literal|" port %d lid %u-%u \"%s\"\n"
argument_list|,
operator|(
name|node
operator|->
name|type
operator|<=
name|IB_NODE_MAX
condition|?
name|node_type_str
index|[
name|node
operator|->
name|type
index|]
else|:
literal|"???"
operator|)
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|ports
operator|->
name|portnum
argument_list|,
name|node
operator|->
name|ports
operator|->
name|lid
argument_list|,
name|node
operator|->
name|ports
operator|->
name|lid
operator|+
operator|(
literal|1
operator|<<
name|node
operator|->
name|ports
operator|->
name|lmc
operator|)
operator|-
literal|1
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
goto|goto
name|free_name
goto|;
block|}
if|if
condition|(
name|node
operator|->
name|dist
condition|)
block|{
if|if
condition|(
name|dumplevel
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|"[%d] -> %s {0x%016"
name|PRIx64
literal|"}[%d]\n"
argument_list|,
name|node
operator|->
name|ports
operator|->
name|remoteport
operator|->
name|portnum
argument_list|,
operator|(
name|node
operator|->
name|type
operator|<=
name|IB_NODE_MAX
condition|?
name|node_type_str
index|[
name|node
operator|->
name|type
index|]
else|:
literal|"???"
operator|)
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|upport
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"[%d] -> %s 0x%"
name|PRIx64
literal|"[%d] lid %u \"%s\"\n"
argument_list|,
name|node
operator|->
name|ports
operator|->
name|remoteport
operator|->
name|portnum
argument_list|,
operator|(
name|node
operator|->
name|type
operator|<=
name|IB_NODE_MAX
condition|?
name|node_type_str
index|[
name|node
operator|->
name|type
index|]
else|:
literal|"???"
operator|)
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|upport
argument_list|,
name|node
operator|->
name|ports
operator|->
name|lid
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|node
operator|->
name|dist
operator|<
literal|0
condition|)
comment|/* target node */
name|printf
argument_list|(
literal|"To %s 0x%"
name|PRIx64
literal|" port %d lid %u-%u \"%s\"\n"
argument_list|,
operator|(
name|node
operator|->
name|type
operator|<=
name|IB_NODE_MAX
condition|?
name|node_type_str
index|[
name|node
operator|->
name|type
index|]
else|:
literal|"???"
operator|)
argument_list|,
name|node
operator|->
name|nodeguid
argument_list|,
name|node
operator|->
name|ports
operator|->
name|portnum
argument_list|,
name|node
operator|->
name|ports
operator|->
name|lid
argument_list|,
name|node
operator|->
name|ports
operator|->
name|lid
operator|+
operator|(
literal|1
operator|<<
name|node
operator|->
name|ports
operator|->
name|lmc
operator|)
operator|-
literal|1
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|free_name
label|:
name|free
argument_list|(
name|nodename
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|resolve_lid
parameter_list|(
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
specifier|const
name|void
modifier|*
name|srcport
parameter_list|)
block|{
name|uint8_t
name|portinfo
index|[
literal|64
index|]
decl_stmt|;
name|uint16_t
name|lid
decl_stmt|;
if|if
condition|(
operator|!
name|smp_query_via
argument_list|(
name|portinfo
argument_list|,
name|portid
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|srcport
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|mad_decode_field
argument_list|(
name|portinfo
argument_list|,
name|IB_PORT_LID_F
argument_list|,
operator|&
name|lid
argument_list|)
expr_stmt|;
name|ib_portid_set
argument_list|(
name|portid
argument_list|,
name|lid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|char
modifier|*
name|basename
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|basename
operator|=
name|strrchr
argument_list|(
name|argv0
argument_list|,
literal|'/'
argument_list|)
operator|)
condition|)
name|basename
operator|=
name|argv0
expr_stmt|;
else|else
name|basename
operator|++
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-d(ebug) -v(erbose) -D(irect) -G(uids) -n(o_info) -C ca_name -P ca_port "
literal|"-s smlid -t(imeout) timeout_ms -m mlid --node-name-map node-name-map ]<src-addr><dest-addr>\n"
argument_list|,
name|basename
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n\tUnicast examples:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t%s 4 16\t\t\t# show path between lids 4 and 16\n"
argument_list|,
name|basename
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t%s -n 4 16\t\t# same, but using simple output format\n"
argument_list|,
name|basename
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t%s -G 0x8f1040396522d 0x002c9000100d051\t# use guid addresses\n"
argument_list|,
name|basename
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n\tMulticast example:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t%s -m 0xc000 4 16\t# show multicast path of mlid 0xc000 between lids 4 and 16\n"
argument_list|,
name|basename
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|mgmt_classes
index|[
literal|3
index|]
init|=
block|{
name|IB_SMI_CLASS
block|,
name|IB_SMI_DIRECT_CLASS
block|,
name|IB_SA_CLASS
block|}
decl_stmt|;
name|ib_portid_t
name|my_portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ib_portid_t
name|src_portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ib_portid_t
name|dest_portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ib_portid_t
modifier|*
name|sm_id
init|=
literal|0
decl_stmt|,
name|sm_portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|dumplevel
init|=
literal|2
decl_stmt|,
name|dest_type
init|=
name|IB_DEST_LID
decl_stmt|,
name|multicast
init|=
literal|0
decl_stmt|,
name|mlid
init|=
literal|0
decl_stmt|;
name|Node
modifier|*
name|endnode
decl_stmt|;
name|int
name|udebug
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|ca
init|=
literal|0
decl_stmt|;
name|int
name|ca_port
init|=
literal|0
decl_stmt|;
specifier|static
name|char
specifier|const
name|str_opts
index|[]
init|=
literal|"C:P:t:s:m:dvfDGnVhu"
decl_stmt|;
specifier|static
specifier|const
name|struct
name|option
name|long_opts
index|[]
init|=
block|{
block|{
literal|"C"
block|,
literal|1
block|,
literal|0
block|,
literal|'C'
block|}
block|,
block|{
literal|"P"
block|,
literal|1
block|,
literal|0
block|,
literal|'P'
block|}
block|,
block|{
literal|"debug"
block|,
literal|0
block|,
literal|0
block|,
literal|'d'
block|}
block|,
block|{
literal|"verbose"
block|,
literal|0
block|,
literal|0
block|,
literal|'v'
block|}
block|,
block|{
literal|"force"
block|,
literal|0
block|,
literal|0
block|,
literal|'f'
block|}
block|,
block|{
literal|"Direct"
block|,
literal|0
block|,
literal|0
block|,
literal|'D'
block|}
block|,
block|{
literal|"Guids"
block|,
literal|0
block|,
literal|0
block|,
literal|'G'
block|}
block|,
block|{
literal|"no_info"
block|,
literal|0
block|,
literal|0
block|,
literal|'n'
block|}
block|,
block|{
literal|"timeout"
block|,
literal|1
block|,
literal|0
block|,
literal|'t'
block|}
block|,
block|{
literal|"s"
block|,
literal|1
block|,
literal|0
block|,
literal|'s'
block|}
block|,
block|{
literal|"m"
block|,
literal|1
block|,
literal|0
block|,
literal|'m'
block|}
block|,
block|{
literal|"Version"
block|,
literal|0
block|,
literal|0
block|,
literal|'V'
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
literal|0
block|,
literal|'h'
block|}
block|,
block|{
literal|"usage"
block|,
literal|0
block|,
literal|0
block|,
literal|'u'
block|}
block|,
block|{
literal|"node-name-map"
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{ }
block|}
decl_stmt|;
name|argv0
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|f
operator|=
name|stdout
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|ch
init|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|str_opts
argument_list|,
name|long_opts
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|ch
operator|==
operator|-
literal|1
condition|)
break|break;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|1
case|:
name|node_name_map_file
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|ca
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|ca_port
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|ibdebug
operator|++
expr_stmt|;
name|madrpc_show_errors
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|umad_debug
argument_list|(
name|udebug
argument_list|)
expr_stmt|;
name|udebug
operator|++
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|dest_type
operator|=
name|IB_DEST_DRPATH
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
name|dest_type
operator|=
name|IB_DEST_GUID
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|multicast
operator|++
expr_stmt|;
name|mlid
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|force
operator|++
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|dumplevel
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
if|if
condition|(
name|ib_resolve_portid_str
argument_list|(
operator|&
name|sm_portid
argument_list|,
name|optarg
argument_list|,
name|IB_DEST_LID
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|IBERROR
argument_list|(
literal|"can't resolve SM destination port %s"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|sm_id
operator|=
operator|&
name|sm_portid
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|timeout
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|madrpc_set_timeout
argument_list|(
name|timeout
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|madrpc_show_errors
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s %s\n"
argument_list|,
name|argv0
argument_list|,
name|get_build_version
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|usage
argument_list|()
expr_stmt|;
name|madrpc_init
argument_list|(
name|ca
argument_list|,
name|ca_port
argument_list|,
name|mgmt_classes
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|node_name_map
operator|=
name|open_node_name_map
argument_list|(
name|node_name_map_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_resolve_portid_str
argument_list|(
operator|&
name|src_portid
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|dest_type
argument_list|,
name|sm_id
argument_list|)
operator|<
literal|0
condition|)
name|IBERROR
argument_list|(
literal|"can't resolve source port %s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_resolve_portid_str
argument_list|(
operator|&
name|dest_portid
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|dest_type
argument_list|,
name|sm_id
argument_list|)
operator|<
literal|0
condition|)
name|IBERROR
argument_list|(
literal|"can't resolve destination port %s"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|dest_type
operator|==
name|IB_DEST_DRPATH
condition|)
block|{
if|if
condition|(
name|resolve_lid
argument_list|(
operator|&
name|src_portid
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
name|IBERROR
argument_list|(
literal|"cannot resolve lid for port \'%s\'"
argument_list|,
name|portid2str
argument_list|(
operator|&
name|src_portid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolve_lid
argument_list|(
operator|&
name|dest_portid
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
name|IBERROR
argument_list|(
literal|"cannot resolve lid for port \'%s\'"
argument_list|,
name|portid2str
argument_list|(
operator|&
name|dest_portid
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dest_portid
operator|.
name|lid
operator|==
literal|0
operator|||
name|src_portid
operator|.
name|lid
operator|==
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"bad src/dest lid"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|dest_type
operator|!=
name|IB_DEST_DRPATH
condition|)
block|{
comment|/* first find a direct path to the src port */
if|if
condition|(
name|find_route
argument_list|(
operator|&
name|my_portid
argument_list|,
operator|&
name|src_portid
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|IBERROR
argument_list|(
literal|"can't find a route to the src port"
argument_list|)
expr_stmt|;
name|src_portid
operator|=
name|my_portid
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|multicast
condition|)
block|{
if|if
condition|(
name|find_route
argument_list|(
operator|&
name|src_portid
argument_list|,
operator|&
name|dest_portid
argument_list|,
name|dumplevel
argument_list|)
operator|<
literal|0
condition|)
name|IBERROR
argument_list|(
literal|"can't find a route from src to dest"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mlid
operator|<
literal|0xc000
condition|)
name|IBWARN
argument_list|(
literal|"invalid MLID; must be 0xc000 or larger"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|target_portguid
operator|=
name|find_target_portguid
argument_list|(
operator|&
name|dest_portid
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"can't reach target lid %d"
argument_list|,
name|dest_portid
operator|.
name|lid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|endnode
operator|=
name|find_mcpath
argument_list|(
operator|&
name|src_portid
argument_list|,
name|mlid
argument_list|)
operator|)
condition|)
name|IBERROR
argument_list|(
literal|"can't find a multicast route from src to dest"
argument_list|)
expr_stmt|;
comment|/* dump multicast path */
name|dump_mcpath
argument_list|(
name|endnode
argument_list|,
name|dumplevel
argument_list|)
expr_stmt|;
name|close_node_name_map
argument_list|(
name|node_name_map
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


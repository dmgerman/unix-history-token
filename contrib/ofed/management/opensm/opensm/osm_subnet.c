begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2008 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  * Copyright (c) 2008 Xsigo Systems Inc.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of osm_subn_t.  * This object represents an IBA subnet.  * This object is part of the opensm family of objects.  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_log.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_subnet.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_opensm.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_log.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_madw.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_port.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_switch.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_remote_sm.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_partition.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_node.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_multicast.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_inform.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_console.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_perfmgr.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_event_plugin.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_qos_policy.h>
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
name|null_str
index|[]
init|=
literal|"(null)"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osm_subn_construct
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
specifier|const
name|p_subn
parameter_list|)
block|{
name|memset
argument_list|(
name|p_subn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_subn
argument_list|)
argument_list|)
expr_stmt|;
name|cl_ptr_vector_construct
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|sw_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|node_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|port_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|sm_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_sr_list
argument_list|)
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|rtr_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|prtn_pkey_tbl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osm_subn_destroy
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
specifier|const
name|p_subn
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|osm_node_t
modifier|*
name|p_node
decl_stmt|,
modifier|*
name|p_next_node
decl_stmt|;
name|osm_port_t
modifier|*
name|p_port
decl_stmt|,
modifier|*
name|p_next_port
decl_stmt|;
name|osm_switch_t
modifier|*
name|p_sw
decl_stmt|,
modifier|*
name|p_next_sw
decl_stmt|;
name|osm_remote_sm_t
modifier|*
name|p_rsm
decl_stmt|,
modifier|*
name|p_next_rsm
decl_stmt|;
name|osm_prtn_t
modifier|*
name|p_prtn
decl_stmt|,
modifier|*
name|p_next_prtn
decl_stmt|;
name|osm_mgrp_t
modifier|*
name|p_mgrp
decl_stmt|;
name|osm_infr_t
modifier|*
name|p_infr
decl_stmt|,
modifier|*
name|p_next_infr
decl_stmt|;
comment|/* it might be a good idea to de-allocate all known objects */
name|p_next_node
operator|=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|node_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_node
operator|!=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|node_guid_tbl
argument_list|)
condition|)
block|{
name|p_node
operator|=
name|p_next_node
expr_stmt|;
name|p_next_node
operator|=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_node_delete
argument_list|(
operator|&
name|p_node
argument_list|)
expr_stmt|;
block|}
name|p_next_port
operator|=
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|port_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_port
operator|!=
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|port_guid_tbl
argument_list|)
condition|)
block|{
name|p_port
operator|=
name|p_next_port
expr_stmt|;
name|p_next_port
operator|=
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_port_delete
argument_list|(
operator|&
name|p_port
argument_list|)
expr_stmt|;
block|}
name|p_next_sw
operator|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sw_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_sw
operator|!=
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|sw_guid_tbl
argument_list|)
condition|)
block|{
name|p_sw
operator|=
name|p_next_sw
expr_stmt|;
name|p_next_sw
operator|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_sw
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_switch_delete
argument_list|(
operator|&
name|p_sw
argument_list|)
expr_stmt|;
block|}
name|p_next_rsm
operator|=
operator|(
name|osm_remote_sm_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sm_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_rsm
operator|!=
operator|(
name|osm_remote_sm_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|sm_guid_tbl
argument_list|)
condition|)
block|{
name|p_rsm
operator|=
name|p_next_rsm
expr_stmt|;
name|p_next_rsm
operator|=
operator|(
name|osm_remote_sm_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_rsm
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_rsm
argument_list|)
expr_stmt|;
block|}
name|p_next_prtn
operator|=
operator|(
name|osm_prtn_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|prtn_pkey_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_prtn
operator|!=
operator|(
name|osm_prtn_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|prtn_pkey_tbl
argument_list|)
condition|)
block|{
name|p_prtn
operator|=
name|p_next_prtn
expr_stmt|;
name|p_next_prtn
operator|=
operator|(
name|osm_prtn_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_prtn
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_prtn_delete
argument_list|(
operator|&
name|p_prtn
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|p_subn
operator|->
name|max_mcast_lid_ho
operator|-
name|IB_LID_MCAST_START_HO
condition|;
name|i
operator|++
control|)
block|{
name|p_mgrp
operator|=
name|p_subn
operator|->
name|mgroups
index|[
name|i
index|]
expr_stmt|;
name|p_subn
operator|->
name|mgroups
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|p_mgrp
condition|)
name|osm_mgrp_delete
argument_list|(
name|p_mgrp
argument_list|)
expr_stmt|;
block|}
name|p_next_infr
operator|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|cl_qlist_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_infr
operator|!=
operator|(
name|osm_infr_t
operator|*
operator|)
name|cl_qlist_end
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
condition|)
block|{
name|p_infr
operator|=
name|p_next_infr
expr_stmt|;
name|p_next_infr
operator|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|cl_qlist_next
argument_list|(
operator|&
name|p_infr
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|osm_infr_delete
argument_list|(
name|p_infr
argument_list|)
expr_stmt|;
block|}
name|cl_ptr_vector_destroy
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|)
expr_stmt|;
name|osm_qos_policy_destroy
argument_list|(
name|p_subn
operator|->
name|p_qos_policy
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|cl_is_qlist_empty
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
condition|)
block|{
name|cl_list_item_t
modifier|*
name|item
init|=
name|cl_qlist_remove_head
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
decl_stmt|;
name|free
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osm_subn_init
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
specifier|const
name|p_subn
parameter_list|,
name|IN
name|osm_opensm_t
modifier|*
specifier|const
name|p_osm
parameter_list|,
name|IN
specifier|const
name|osm_subn_opt_t
modifier|*
specifier|const
name|p_opt
parameter_list|)
block|{
name|cl_status_t
name|status
decl_stmt|;
name|p_subn
operator|->
name|p_osm
operator|=
name|p_osm
expr_stmt|;
name|status
operator|=
name|cl_ptr_vector_init
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|,
name|OSM_SUBNET_VECTOR_MIN_SIZE
argument_list|,
name|OSM_SUBNET_VECTOR_GROW_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|CL_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|status
operator|=
name|cl_ptr_vector_set_capacity
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|,
name|OSM_SUBNET_VECTOR_CAPACITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|CL_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
comment|/* 	   LID zero is not valid.  NULL out this entry for the 	   convenience of other code. 	 */
name|cl_ptr_vector_set
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|p_subn
operator|->
name|opt
operator|=
operator|*
name|p_opt
expr_stmt|;
name|p_subn
operator|->
name|max_ucast_lid_ho
operator|=
name|IB_LID_UCAST_END_HO
expr_stmt|;
name|p_subn
operator|->
name|max_mcast_lid_ho
operator|=
name|IB_LID_MCAST_END_HO
expr_stmt|;
name|p_subn
operator|->
name|min_ca_mtu
operator|=
name|IB_MAX_MTU
expr_stmt|;
name|p_subn
operator|->
name|min_ca_rate
operator|=
name|IB_MAX_RATE
expr_stmt|;
name|p_subn
operator|->
name|ignore_existing_lfts
operator|=
name|TRUE
expr_stmt|;
comment|/* we assume master by default - so we only need to set it true if STANDBY */
name|p_subn
operator|->
name|coming_out_of_standby
operator|=
name|FALSE
expr_stmt|;
return|return
operator|(
name|IB_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osm_get_gid_by_mad_addr
parameter_list|(
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
specifier|const
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
specifier|const
name|osm_mad_addr_t
modifier|*
name|p_mad_addr
parameter_list|,
name|OUT
name|ib_gid_t
modifier|*
name|p_gid
parameter_list|)
block|{
specifier|const
name|cl_ptr_vector_t
modifier|*
name|p_tbl
decl_stmt|;
specifier|const
name|osm_port_t
modifier|*
name|p_port
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|p_gid
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7505: "
literal|"Provided output GID is NULL\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|IB_INVALID_PARAMETER
operator|)
return|;
block|}
comment|/* Find the port gid of the request in the subnet */
name|p_tbl
operator|=
operator|&
name|p_subn
operator|->
name|port_lid_tbl
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|cl_ptr_vector_get_size
argument_list|(
name|p_tbl
argument_list|)
operator|<
literal|0x10000
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint16_t
operator|)
name|cl_ptr_vector_get_size
argument_list|(
name|p_tbl
argument_list|)
operator|>
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
condition|)
block|{
name|p_port
operator|=
name|cl_ptr_vector_get
argument_list|(
name|p_tbl
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_port
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Did not find any port with LID: %u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|IB_INVALID_PARAMETER
operator|)
return|;
block|}
name|p_gid
operator|->
name|unicast
operator|.
name|interface_id
operator|=
name|p_port
operator|->
name|p_physp
operator|->
name|port_guid
expr_stmt|;
name|p_gid
operator|->
name|unicast
operator|.
name|prefix
operator|=
name|p_subn
operator|->
name|opt
operator|.
name|subnet_prefix
expr_stmt|;
block|}
else|else
block|{
comment|/* The dest_lid is not in the subnet table - this is an error */
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7501: "
literal|"LID is out of range: %u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|IB_INVALID_PARAMETER
operator|)
return|;
block|}
return|return
operator|(
name|IB_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|osm_physp_t
modifier|*
name|osm_get_physp_by_mad_addr
parameter_list|(
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
specifier|const
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_mad_addr_t
modifier|*
name|p_mad_addr
parameter_list|)
block|{
specifier|const
name|cl_ptr_vector_t
modifier|*
name|p_port_lid_tbl
decl_stmt|;
name|osm_port_t
modifier|*
name|p_port
init|=
name|NULL
decl_stmt|;
name|osm_physp_t
modifier|*
name|p_physp
init|=
name|NULL
decl_stmt|;
comment|/* Find the port gid of the request in the subnet */
name|p_port_lid_tbl
operator|=
operator|&
name|p_subn
operator|->
name|port_lid_tbl
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|cl_ptr_vector_get_size
argument_list|(
name|p_port_lid_tbl
argument_list|)
operator|<
literal|0x10000
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint16_t
operator|)
name|cl_ptr_vector_get_size
argument_list|(
name|p_port_lid_tbl
argument_list|)
operator|>
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
condition|)
block|{
name|p_port
operator|=
name|cl_ptr_vector_get
argument_list|(
name|p_port_lid_tbl
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_port
operator|==
name|NULL
condition|)
block|{
comment|/* The port is not in the port_lid table - this is an error */
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7502: "
literal|"Cannot locate port object by lid: %u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_physp
operator|=
name|p_port
operator|->
name|p_physp
expr_stmt|;
block|}
else|else
block|{
comment|/* The dest_lid is not in the subnet table - this is an error */
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7503: "
literal|"Lid is out of range: %u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
return|return
name|p_physp
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|osm_port_t
modifier|*
name|osm_get_port_by_mad_addr
parameter_list|(
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
specifier|const
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_mad_addr_t
modifier|*
name|p_mad_addr
parameter_list|)
block|{
specifier|const
name|cl_ptr_vector_t
modifier|*
name|p_port_lid_tbl
decl_stmt|;
name|osm_port_t
modifier|*
name|p_port
init|=
name|NULL
decl_stmt|;
comment|/* Find the port gid of the request in the subnet */
name|p_port_lid_tbl
operator|=
operator|&
name|p_subn
operator|->
name|port_lid_tbl
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|cl_ptr_vector_get_size
argument_list|(
name|p_port_lid_tbl
argument_list|)
operator|<
literal|0x10000
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint16_t
operator|)
name|cl_ptr_vector_get_size
argument_list|(
name|p_port_lid_tbl
argument_list|)
operator|>
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
condition|)
block|{
name|p_port
operator|=
name|cl_ptr_vector_get
argument_list|(
name|p_port_lid_tbl
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* The dest_lid is not in the subnet table - this is an error */
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7504: "
literal|"Lid is out of range: %u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|p_port
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|osm_switch_t
modifier|*
name|osm_get_switch_by_guid
parameter_list|(
name|IN
specifier|const
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|uint64_t
name|guid
parameter_list|)
block|{
name|osm_switch_t
modifier|*
name|p_switch
decl_stmt|;
name|p_switch
operator|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|sw_guid_tbl
operator|)
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_switch
operator|==
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|sw_guid_tbl
operator|)
argument_list|)
condition|)
name|p_switch
operator|=
name|NULL
expr_stmt|;
return|return
name|p_switch
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|osm_node_t
modifier|*
name|osm_get_node_by_guid
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|p_subn
parameter_list|,
name|IN
name|uint64_t
name|guid
parameter_list|)
block|{
name|osm_node_t
modifier|*
name|p_node
decl_stmt|;
name|p_node
operator|=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|node_guid_tbl
operator|)
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_node
operator|==
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|node_guid_tbl
operator|)
argument_list|)
condition|)
name|p_node
operator|=
name|NULL
expr_stmt|;
return|return
name|p_node
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|osm_port_t
modifier|*
name|osm_get_port_by_guid
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|p_subn
parameter_list|,
name|IN
name|ib_net64_t
name|guid
parameter_list|)
block|{
name|osm_port_t
modifier|*
name|p_port
decl_stmt|;
name|p_port
operator|=
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|port_guid_tbl
operator|)
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_port
operator|==
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|port_guid_tbl
operator|)
argument_list|)
condition|)
name|p_port
operator|=
name|NULL
expr_stmt|;
return|return
name|p_port
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|subn_set_default_qos_options
parameter_list|(
name|IN
name|osm_qos_options_t
modifier|*
name|opt
parameter_list|)
block|{
name|opt
operator|->
name|max_vls
operator|=
name|OSM_DEFAULT_QOS_MAX_VLS
expr_stmt|;
name|opt
operator|->
name|high_limit
operator|=
name|OSM_DEFAULT_QOS_HIGH_LIMIT
expr_stmt|;
name|opt
operator|->
name|vlarb_high
operator|=
name|OSM_DEFAULT_QOS_VLARB_HIGH
expr_stmt|;
name|opt
operator|->
name|vlarb_low
operator|=
name|OSM_DEFAULT_QOS_VLARB_LOW
expr_stmt|;
name|opt
operator|->
name|sl2vl
operator|=
name|OSM_DEFAULT_QOS_SL2VL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_init_qos_options
parameter_list|(
name|IN
name|osm_qos_options_t
modifier|*
name|opt
parameter_list|)
block|{
name|opt
operator|->
name|max_vls
operator|=
literal|0
expr_stmt|;
name|opt
operator|->
name|high_limit
operator|=
operator|-
literal|1
expr_stmt|;
name|opt
operator|->
name|vlarb_high
operator|=
name|NULL
expr_stmt|;
name|opt
operator|->
name|vlarb_low
operator|=
name|NULL
expr_stmt|;
name|opt
operator|->
name|sl2vl
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osm_subn_set_default_opt
parameter_list|(
name|IN
name|osm_subn_opt_t
modifier|*
specifier|const
name|p_opt
parameter_list|)
block|{
name|memset
argument_list|(
name|p_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_subn_opt_t
argument_list|)
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|guid
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|m_key
operator|=
name|OSM_DEFAULT_M_KEY
expr_stmt|;
name|p_opt
operator|->
name|sm_key
operator|=
name|OSM_DEFAULT_SM_KEY
expr_stmt|;
name|p_opt
operator|->
name|sa_key
operator|=
name|OSM_DEFAULT_SA_KEY
expr_stmt|;
name|p_opt
operator|->
name|subnet_prefix
operator|=
name|IB_DEFAULT_SUBNET_PREFIX
expr_stmt|;
name|p_opt
operator|->
name|m_key_lease_period
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|sweep_interval
operator|=
name|OSM_DEFAULT_SWEEP_INTERVAL_SECS
expr_stmt|;
name|p_opt
operator|->
name|max_wire_smps
operator|=
name|OSM_DEFAULT_SMP_MAX_ON_WIRE
expr_stmt|;
name|p_opt
operator|->
name|console
operator|=
name|OSM_DEFAULT_CONSOLE
expr_stmt|;
name|p_opt
operator|->
name|console_port
operator|=
name|OSM_DEFAULT_CONSOLE_PORT
expr_stmt|;
name|p_opt
operator|->
name|transaction_timeout
operator|=
name|OSM_DEFAULT_TRANS_TIMEOUT_MILLISEC
expr_stmt|;
comment|/* by default we will consider waiting for 50x transaction timeout normal */
name|p_opt
operator|->
name|max_msg_fifo_timeout
operator|=
literal|50
operator|*
name|OSM_DEFAULT_TRANS_TIMEOUT_MILLISEC
expr_stmt|;
name|p_opt
operator|->
name|sm_priority
operator|=
name|OSM_DEFAULT_SM_PRIORITY
expr_stmt|;
name|p_opt
operator|->
name|lmc
operator|=
name|OSM_DEFAULT_LMC
expr_stmt|;
name|p_opt
operator|->
name|lmc_esp0
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|max_op_vls
operator|=
name|OSM_DEFAULT_MAX_OP_VLS
expr_stmt|;
name|p_opt
operator|->
name|force_link_speed
operator|=
literal|15
expr_stmt|;
name|p_opt
operator|->
name|reassign_lids
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|ignore_other_sm
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|single_thread
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|disable_multicast
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|force_log_flush
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|subnet_timeout
operator|=
name|OSM_DEFAULT_SUBNET_TIMEOUT
expr_stmt|;
name|p_opt
operator|->
name|packet_life_time
operator|=
name|OSM_DEFAULT_SWITCH_PACKET_LIFE
expr_stmt|;
name|p_opt
operator|->
name|vl_stall_count
operator|=
name|OSM_DEFAULT_VL_STALL_COUNT
expr_stmt|;
name|p_opt
operator|->
name|leaf_vl_stall_count
operator|=
name|OSM_DEFAULT_LEAF_VL_STALL_COUNT
expr_stmt|;
name|p_opt
operator|->
name|head_of_queue_lifetime
operator|=
name|OSM_DEFAULT_HEAD_OF_QUEUE_LIFE
expr_stmt|;
name|p_opt
operator|->
name|leaf_head_of_queue_lifetime
operator|=
name|OSM_DEFAULT_LEAF_HEAD_OF_QUEUE_LIFE
expr_stmt|;
name|p_opt
operator|->
name|local_phy_errors_threshold
operator|=
name|OSM_DEFAULT_ERROR_THRESHOLD
expr_stmt|;
name|p_opt
operator|->
name|overrun_errors_threshold
operator|=
name|OSM_DEFAULT_ERROR_THRESHOLD
expr_stmt|;
name|p_opt
operator|->
name|sminfo_polling_timeout
operator|=
name|OSM_SM_DEFAULT_POLLING_TIMEOUT_MILLISECS
expr_stmt|;
name|p_opt
operator|->
name|polling_retry_number
operator|=
name|OSM_SM_DEFAULT_POLLING_RETRY_NUMBER
expr_stmt|;
name|p_opt
operator|->
name|force_heavy_sweep
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|log_flags
operator|=
name|OSM_LOG_DEFAULT_LEVEL
expr_stmt|;
name|p_opt
operator|->
name|honor_guid2lid_file
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|daemon
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|sm_inactive
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|babbling_port_policy
operator|=
name|FALSE
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
name|p_opt
operator|->
name|perfmgr
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_redir
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_sweep_time_s
operator|=
name|OSM_PERFMGR_DEFAULT_SWEEP_TIME_S
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_max_outstanding_queries
operator|=
name|OSM_PERFMGR_DEFAULT_MAX_OUTSTANDING_QUERIES
expr_stmt|;
name|p_opt
operator|->
name|event_db_dump_file
operator|=
name|NULL
expr_stmt|;
comment|/* use default */
endif|#
directive|endif
comment|/* ENABLE_OSM_PERF_MGR */
name|p_opt
operator|->
name|event_plugin_name
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|node_name_map_name
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|dump_files_dir
operator|=
name|getenv
argument_list|(
literal|"OSM_TMP_DIR"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_opt
operator|->
name|dump_files_dir
operator|||
operator|!
operator|(
operator|*
name|p_opt
operator|->
name|dump_files_dir
operator|)
condition|)
name|p_opt
operator|->
name|dump_files_dir
operator|=
name|OSM_DEFAULT_TMP_DIR
expr_stmt|;
name|p_opt
operator|->
name|log_file
operator|=
name|OSM_DEFAULT_LOG_FILE
expr_stmt|;
name|p_opt
operator|->
name|log_max_size
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|partition_config_file
operator|=
name|OSM_DEFAULT_PARTITION_CONFIG_FILE
expr_stmt|;
name|p_opt
operator|->
name|no_partition_enforcement
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|qos
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|qos_policy_file
operator|=
name|OSM_DEFAULT_QOS_POLICY_FILE
expr_stmt|;
name|p_opt
operator|->
name|accum_log_file
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|port_prof_ignore_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|port_profile_switch_nodes
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|sweep_on_trap
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|use_ucast_cache
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|routing_engine_names
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|connect_roots
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|lid_matrix_dump_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|lfts_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|root_guid_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|cn_guid_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|ids_guid_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|guid_routing_order_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|sa_db_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|exit_on_fatal
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|enable_quirks
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|no_clients_rereg
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|prefix_routes_file
operator|=
name|OSM_DEFAULT_PREFIX_ROUTES_FILE
expr_stmt|;
name|p_opt
operator|->
name|consolidate_ipv6_snm_req
operator|=
name|FALSE
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_ca_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_sw0_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_swe_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_rtr_options
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|log_report
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|cl_log_event
argument_list|(
literal|"OpenSM"
argument_list|,
name|CL_LOG_INFO
argument_list|,
name|buf
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|log_config_value
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|unsigned
name|n
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|" Loading Cached Option:%s = "
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|n
operator|+=
name|vsnprintf
argument_list|(
name|buf
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|n
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|n
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|cl_log_event
argument_list|(
literal|"OpenSM"
argument_list|,
name|CL_LOG_INFO
argument_list|,
name|buf
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_unpack_net64
parameter_list|(
name|IN
name|char
modifier|*
name|p_req_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|uint64_t
modifier|*
name|p_val
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p_req_key
argument_list|,
name|p_key
argument_list|)
condition|)
block|{
name|uint64_t
name|val
init|=
name|strtoull
argument_list|(
name|p_val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|cl_hton64
argument_list|(
name|val
argument_list|)
operator|!=
operator|*
name|p_val
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"0x%016"
name|PRIx64
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val
operator|=
name|cl_ntoh64
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|opts_unpack_uint32
parameter_list|(
name|IN
name|char
modifier|*
name|p_req_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|uint32_t
modifier|*
name|p_val
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p_req_key
argument_list|,
name|p_key
argument_list|)
condition|)
block|{
name|uint32_t
name|val
init|=
name|strtoul
argument_list|(
name|p_val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%u"
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val
operator|=
name|val
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|opts_unpack_int32
parameter_list|(
name|IN
name|char
modifier|*
name|p_req_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|int32_t
modifier|*
name|p_val
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p_req_key
argument_list|,
name|p_key
argument_list|)
condition|)
block|{
name|int32_t
name|val
init|=
name|strtol
argument_list|(
name|p_val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%d"
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val
operator|=
name|val
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|opts_unpack_uint16
parameter_list|(
name|IN
name|char
modifier|*
name|p_req_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|uint16_t
modifier|*
name|p_val
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p_req_key
argument_list|,
name|p_key
argument_list|)
condition|)
block|{
name|uint16_t
name|val
init|=
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
name|p_val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%u"
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val
operator|=
name|val
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|opts_unpack_net16
parameter_list|(
name|IN
name|char
modifier|*
name|p_req_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|uint16_t
modifier|*
name|p_val
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p_req_key
argument_list|,
name|p_key
argument_list|)
condition|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|strtoul
argument_list|(
name|p_val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|val
operator|<
literal|0x10000
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl_hton32
argument_list|(
name|val
argument_list|)
operator|!=
operator|*
name|p_val
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"0x%04x"
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|val
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|opts_unpack_uint8
parameter_list|(
name|IN
name|char
modifier|*
name|p_req_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|uint8_t
modifier|*
name|p_val
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p_req_key
argument_list|,
name|p_key
argument_list|)
condition|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|strtoul
argument_list|(
name|p_val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|val
operator|<
literal|0x100
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%u"
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val
operator|=
operator|(
name|uint8_t
operator|)
name|val
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|opts_unpack_boolean
parameter_list|(
name|IN
name|char
modifier|*
name|p_req_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|boolean_t
modifier|*
name|p_val
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p_req_key
argument_list|,
name|p_key
argument_list|)
operator|&&
name|p_val_str
condition|)
block|{
name|boolean_t
name|val
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"TRUE"
argument_list|,
name|p_val_str
argument_list|)
condition|)
name|val
operator|=
name|FALSE
expr_stmt|;
else|else
name|val
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%s"
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
operator|*
name|p_val
operator|=
name|val
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|opts_unpack_charp
parameter_list|(
name|IN
name|char
modifier|*
name|p_req_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|char
modifier|*
modifier|*
name|p_val
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|p_req_key
argument_list|,
name|p_key
argument_list|)
operator|&&
name|p_val_str
condition|)
block|{
specifier|const
name|char
modifier|*
name|current_str
init|=
operator|*
name|p_val
condition|?
operator|*
name|p_val
else|:
name|null_str
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|p_val_str
argument_list|,
name|current_str
argument_list|)
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%s"
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
comment|/* special case the "(null)" string */
if|if
condition|(
name|strcmp
argument_list|(
name|null_str
argument_list|,
name|p_val_str
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|p_val
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* 				  Ignore the possible memory leak here; 				  the pointer may be to a static default. 				*/
operator|*
name|p_val
operator|=
name|strdup
argument_list|(
name|p_val_str
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|char
modifier|*
name|clean_val
parameter_list|(
name|char
modifier|*
name|val
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|val
decl_stmt|;
comment|/* clean leading spaces */
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
name|p
operator|++
expr_stmt|;
name|val
operator|=
name|p
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|val
condition|)
return|return
name|val
return|;
comment|/* clean trailing spaces */
name|p
operator|=
name|val
operator|+
name|strlen
argument_list|(
name|val
argument_list|)
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|p
operator|>
name|val
operator|&&
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
name|p
operator|--
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* clean quotas */
if|if
condition|(
operator|(
operator|*
name|val
operator|==
literal|'\"'
operator|&&
operator|*
name|p
operator|==
literal|'\"'
operator|)
operator|||
operator|(
operator|*
name|val
operator|==
literal|'\''
operator|&&
operator|*
name|p
operator|==
literal|'\''
operator|)
condition|)
block|{
name|val
operator|++
expr_stmt|;
name|p
operator|--
expr_stmt|;
block|}
return|return
name|val
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|subn_parse_qos_options
parameter_list|(
name|IN
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|osm_qos_options_t
modifier|*
name|opt
parameter_list|)
block|{
name|char
name|name
index|[
literal|256
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s_max_vls"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|opts_unpack_uint32
argument_list|(
name|name
argument_list|,
name|p_key
argument_list|,
name|p_val_str
argument_list|,
operator|&
name|opt
operator|->
name|max_vls
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s_high_limit"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|opts_unpack_int32
argument_list|(
name|name
argument_list|,
name|p_key
argument_list|,
name|p_val_str
argument_list|,
operator|&
name|opt
operator|->
name|high_limit
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s_vlarb_high"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
name|name
argument_list|,
name|p_key
argument_list|,
name|p_val_str
argument_list|,
operator|&
name|opt
operator|->
name|vlarb_high
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s_vlarb_low"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
name|name
argument_list|,
name|p_key
argument_list|,
name|p_val_str
argument_list|,
operator|&
name|opt
operator|->
name|vlarb_low
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s_sl2vl"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
name|name
argument_list|,
name|p_key
argument_list|,
name|p_val_str
argument_list|,
operator|&
name|opt
operator|->
name|sl2vl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|subn_dump_qos_options
parameter_list|(
name|FILE
modifier|*
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|set_name
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|osm_qos_options_t
modifier|*
name|opt
parameter_list|)
block|{
return|return
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"# %s\n"
literal|"%s_max_vls %u\n"
literal|"%s_high_limit %d\n"
literal|"%s_vlarb_high %s\n"
literal|"%s_vlarb_low %s\n"
literal|"%s_sl2vl %s\n"
argument_list|,
name|set_name
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|max_vls
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|high_limit
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|vlarb_high
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|vlarb_low
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|sl2vl
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|append_prefix_route
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
specifier|const
name|p_subn
parameter_list|,
name|uint64_t
name|prefix
parameter_list|,
name|uint64_t
name|guid
parameter_list|)
block|{
name|osm_prefix_route_t
modifier|*
name|route
decl_stmt|;
name|route
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|route
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|route
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
name|route
operator|->
name|prefix
operator|=
name|cl_hton64
argument_list|(
name|prefix
argument_list|)
expr_stmt|;
name|route
operator|->
name|guid
operator|=
name|cl_hton64
argument_list|(
name|guid
argument_list|)
expr_stmt|;
name|cl_qlist_insert_tail
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|,
operator|&
name|route
operator|->
name|list_item
argument_list|)
expr_stmt|;
return|return
name|IB_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|osm_parse_prefix_routes_file
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
specifier|const
name|p_subn
parameter_list|)
block|{
name|osm_log_t
modifier|*
name|log
init|=
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|log
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|!
name|cl_is_qlist_empty
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
condition|)
block|{
name|cl_list_item_t
modifier|*
name|item
init|=
name|cl_qlist_remove_head
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
decl_stmt|;
name|free
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
name|fp
operator|=
name|fopen
argument_list|(
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
return|return
name|IB_SUCCESS
return|;
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"fopen(%s) failed: %s"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|fp
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|p_prefix
decl_stmt|,
modifier|*
name|p_guid
decl_stmt|,
modifier|*
name|p_extra
decl_stmt|,
modifier|*
name|p_last
decl_stmt|,
modifier|*
name|p_end
decl_stmt|;
name|uint64_t
name|prefix
decl_stmt|,
name|guid
decl_stmt|;
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|errors
operator|>
literal|10
condition|)
break|break;
name|p_prefix
operator|=
name|strtok_r
argument_list|(
name|buf
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_prefix
condition|)
continue|continue;
comment|/* ignore blank lines */
if|if
condition|(
operator|*
name|p_prefix
operator|==
literal|'#'
condition|)
continue|continue;
comment|/* ignore comment lines */
name|p_guid
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_guid
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"%s:%d: missing GUID\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
name|p_extra
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_extra
operator|&&
operator|*
name|p_extra
operator|!=
literal|'#'
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"%s:%d: extra tokens ignored\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|p_prefix
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|prefix
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|prefix
operator|=
name|strtoull
argument_list|(
name|p_prefix
argument_list|,
operator|&
name|p_end
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p_end
operator|!=
literal|'\0'
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"%s:%d: illegal prefix: %s\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|line
argument_list|,
name|p_prefix
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|p_guid
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|guid
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|guid
operator|=
name|strtoull
argument_list|(
name|p_guid
argument_list|,
operator|&
name|p_end
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p_end
operator|!=
literal|'\0'
operator|&&
operator|*
name|p_end
operator|!=
literal|'#'
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"%s:%d: illegal GUID: %s\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|line
argument_list|,
name|p_guid
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|append_prefix_route
argument_list|(
name|p_subn
argument_list|,
name|prefix
argument_list|,
name|guid
argument_list|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|errors
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|errors
operator|==
literal|0
operator|)
condition|?
name|IB_SUCCESS
else|:
name|IB_ERROR
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|subn_verify_max_vls
parameter_list|(
name|unsigned
modifier|*
name|max_vls
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|unsigned
name|dflt
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
operator|*
name|max_vls
operator|)
operator|||
operator|*
name|max_vls
operator|>
literal|15
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option: %s_max_vls=%u: "
literal|"Using Default = %u\n"
argument_list|,
name|prefix
argument_list|,
operator|*
name|max_vls
argument_list|,
name|dflt
argument_list|)
expr_stmt|;
operator|*
name|max_vls
operator|=
name|dflt
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|subn_verify_high_limit
parameter_list|(
name|int
modifier|*
name|high_limit
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|int
name|dflt
parameter_list|)
block|{
if|if
condition|(
operator|*
name|high_limit
operator|<
literal|0
operator|||
operator|*
name|high_limit
operator|>
literal|255
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option: %s_high_limit=%d: "
literal|"Using Default: %d\n"
argument_list|,
name|prefix
argument_list|,
operator|*
name|high_limit
argument_list|,
name|dflt
argument_list|)
expr_stmt|;
operator|*
name|high_limit
operator|=
name|dflt
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|subn_verify_vlarb
parameter_list|(
name|char
modifier|*
modifier|*
name|vlarb
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
specifier|const
name|char
modifier|*
name|suffix
parameter_list|,
name|char
modifier|*
name|dflt
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|,
modifier|*
name|tok
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|*
name|vlarb
operator|==
name|NULL
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option: %s_vlarb_%s: "
literal|"Using Default\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|)
expr_stmt|;
operator|*
name|vlarb
operator|=
name|dflt
expr_stmt|;
return|return;
block|}
name|str
operator|=
name|strdup
argument_list|(
operator|*
name|vlarb
argument_list|)
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|str
argument_list|,
literal|",\n"
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
while|while
condition|(
name|tok
condition|)
block|{
name|char
modifier|*
name|vl_str
decl_stmt|,
modifier|*
name|weight_str
decl_stmt|;
name|vl_str
operator|=
name|tok
expr_stmt|;
name|weight_str
operator|=
name|strchr
argument_list|(
name|tok
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|weight_str
condition|)
block|{
name|long
name|vl
decl_stmt|,
name|weight
decl_stmt|;
operator|*
name|weight_str
operator|=
literal|'\0'
expr_stmt|;
name|weight_str
operator|++
expr_stmt|;
name|vl
operator|=
name|strtol
argument_list|(
name|vl_str
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:vl=%s"
literal|" improperly formatted\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|vl_str
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|vl
operator|<
literal|0
operator|||
name|vl
operator|>
literal|14
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:vl=%ld out of range\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|vl
argument_list|)
expr_stmt|;
name|weight
operator|=
name|strtol
argument_list|(
name|weight_str
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:weight=%s "
literal|"improperly formatted\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|weight_str
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|weight
operator|<
literal|0
operator|||
name|weight
operator|>
literal|255
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:weight=%ld "
literal|"out of range\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|weight
argument_list|)
expr_stmt|;
block|}
else|else
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:vl:weight=%s "
literal|"improperly formatted\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|tok
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|",\n"
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
literal|64
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_vlarb_%s:> 64 listed:"
literal|" excess vl:weight pairs will be dropped\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_verify_sl2vl
parameter_list|(
name|char
modifier|*
modifier|*
name|sl2vl
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|char
modifier|*
name|dflt
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|,
modifier|*
name|tok
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|*
name|sl2vl
operator|==
name|NULL
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option: %s_sl2vl: Using Default\n"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
operator|*
name|sl2vl
operator|=
name|dflt
expr_stmt|;
return|return;
block|}
name|str
operator|=
name|strdup
argument_list|(
operator|*
name|sl2vl
argument_list|)
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|str
argument_list|,
literal|",\n"
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
while|while
condition|(
name|tok
condition|)
block|{
name|long
name|vl
init|=
name|strtol
argument_list|(
name|tok
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|end
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_sl2vl:vl=%s "
literal|"improperly formatted\n"
argument_list|,
name|prefix
argument_list|,
name|tok
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|vl
operator|<
literal|0
operator|||
name|vl
operator|>
literal|15
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_sl2vl:vl=%ld "
literal|"out of range\n"
argument_list|,
name|prefix
argument_list|,
name|vl
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|",\n"
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|<
literal|16
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_sl2vl:< 16 VLs "
literal|"listed\n"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|16
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_sl2vl:> 16 listed: "
literal|"excess VLs will be dropped\n"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_verify_qos_set
parameter_list|(
name|osm_qos_options_t
modifier|*
name|set
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|osm_qos_options_t
modifier|*
name|dflt
parameter_list|)
block|{
name|subn_verify_max_vls
argument_list|(
operator|&
name|set
operator|->
name|max_vls
argument_list|,
name|prefix
argument_list|,
name|dflt
operator|->
name|max_vls
argument_list|)
expr_stmt|;
name|subn_verify_high_limit
argument_list|(
operator|&
name|set
operator|->
name|high_limit
argument_list|,
name|prefix
argument_list|,
name|dflt
operator|->
name|high_limit
argument_list|)
expr_stmt|;
name|subn_verify_vlarb
argument_list|(
operator|&
name|set
operator|->
name|vlarb_low
argument_list|,
name|prefix
argument_list|,
literal|"low"
argument_list|,
name|dflt
operator|->
name|vlarb_low
argument_list|)
expr_stmt|;
name|subn_verify_vlarb
argument_list|(
operator|&
name|set
operator|->
name|vlarb_high
argument_list|,
name|prefix
argument_list|,
literal|"high"
argument_list|,
name|dflt
operator|->
name|vlarb_high
argument_list|)
expr_stmt|;
name|subn_verify_sl2vl
argument_list|(
operator|&
name|set
operator|->
name|sl2vl
argument_list|,
name|prefix
argument_list|,
name|dflt
operator|->
name|sl2vl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|osm_subn_verify_config
parameter_list|(
name|IN
name|osm_subn_opt_t
modifier|*
specifier|const
name|p_opts
parameter_list|)
block|{
if|if
condition|(
name|p_opts
operator|->
name|lmc
operator|>
literal|7
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:lmc = %u:"
literal|"Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|lmc
argument_list|,
name|OSM_DEFAULT_LMC
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|lmc
operator|=
name|OSM_DEFAULT_LMC
expr_stmt|;
block|}
if|if
condition|(
literal|15
operator|<
name|p_opts
operator|->
name|sm_priority
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:sm_priority = %u:"
literal|"Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|sm_priority
argument_list|,
name|OSM_DEFAULT_SM_PRIORITY
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|sm_priority
operator|=
name|OSM_DEFAULT_SM_PRIORITY
expr_stmt|;
block|}
if|if
condition|(
operator|(
literal|15
operator|<
name|p_opts
operator|->
name|force_link_speed
operator|)
operator|||
operator|(
name|p_opts
operator|->
name|force_link_speed
operator|>
literal|7
operator|&&
name|p_opts
operator|->
name|force_link_speed
operator|<
literal|15
operator|)
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:force_link_speed = %u:"
literal|"Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|force_link_speed
argument_list|,
name|IB_PORT_LINK_SPEED_ENABLED_MASK
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|force_link_speed
operator|=
name|IB_PORT_LINK_SPEED_ENABLED_MASK
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_DISABLE_CONSOLE
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_LOCAL_CONSOLE
argument_list|)
ifdef|#
directive|ifdef
name|ENABLE_OSM_CONSOLE_SOCKET
operator|&&
name|strcmp
argument_list|(
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_LOOPBACK_CONSOLE
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_REMOTE_CONSOLE
argument_list|)
endif|#
directive|endif
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:console = %s"
literal|", Using Default:%s\n"
argument_list|,
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_DEFAULT_CONSOLE
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|console
operator|=
name|OSM_DEFAULT_CONSOLE
expr_stmt|;
block|}
if|if
condition|(
name|p_opts
operator|->
name|qos
condition|)
block|{
name|osm_qos_options_t
name|dflt
decl_stmt|;
comment|/* the default options in qos_options must be correct. 		 * every other one need not be, b/c those will default 		 * back to whatever is in qos_options. 		 */
name|subn_set_default_qos_options
argument_list|(
operator|&
name|dflt
argument_list|)
expr_stmt|;
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|,
literal|"qos"
argument_list|,
operator|&
name|dflt
argument_list|)
expr_stmt|;
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_ca_options
argument_list|,
literal|"qos_ca"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|)
expr_stmt|;
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_sw0_options
argument_list|,
literal|"qos_sw0"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|)
expr_stmt|;
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_swe_options
argument_list|,
literal|"qos_swe"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|)
expr_stmt|;
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_rtr_options
argument_list|,
literal|"qos_rtr"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
if|if
condition|(
name|p_opts
operator|->
name|perfmgr_sweep_time_s
operator|<
literal|1
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:perfmgr_sweep_time_s "
literal|"= %u Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|perfmgr_sweep_time_s
argument_list|,
name|OSM_PERFMGR_DEFAULT_SWEEP_TIME_S
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|perfmgr_sweep_time_s
operator|=
name|OSM_PERFMGR_DEFAULT_SWEEP_TIME_S
expr_stmt|;
block|}
if|if
condition|(
name|p_opts
operator|->
name|perfmgr_max_outstanding_queries
operator|<
literal|1
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:"
literal|"perfmgr_max_outstanding_queries = %u"
literal|" Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|perfmgr_max_outstanding_queries
argument_list|,
name|OSM_PERFMGR_DEFAULT_MAX_OUTSTANDING_QUERIES
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|perfmgr_max_outstanding_queries
operator|=
name|OSM_PERFMGR_DEFAULT_MAX_OUTSTANDING_QUERIES
expr_stmt|;
block|}
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|int
name|osm_subn_parse_conf_file
parameter_list|(
name|char
modifier|*
name|file_name
parameter_list|,
name|osm_subn_opt_t
modifier|*
specifier|const
name|p_opts
parameter_list|)
block|{
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|FILE
modifier|*
name|opts_file
decl_stmt|;
name|char
modifier|*
name|p_key
decl_stmt|,
modifier|*
name|p_val
decl_stmt|;
name|opts_file
operator|=
name|fopen
argument_list|(
name|file_name
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opts_file
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
return|return
literal|1
return|;
name|printf
argument_list|(
literal|"cannot open file \'%s\': %s\n"
argument_list|,
name|file_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|printf
argument_list|(
literal|" Reading Cached Option File: %s\n"
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
name|cl_log_event
argument_list|(
literal|"OpenSM"
argument_list|,
name|CL_LOG_INFO
argument_list|,
name|line
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|config_file
operator|=
name|file_name
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
literal|1023
argument_list|,
name|opts_file
argument_list|)
operator|!=
name|NULL
condition|)
block|{
comment|/* get the first token */
name|p_key
operator|=
name|strtok_r
argument_list|(
name|line
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_key
condition|)
continue|continue;
name|p_val
operator|=
name|clean_val
argument_list|(
name|p_val
argument_list|)
expr_stmt|;
name|opts_unpack_net64
argument_list|(
literal|"guid"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|guid
argument_list|)
expr_stmt|;
name|opts_unpack_net64
argument_list|(
literal|"m_key"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|m_key
argument_list|)
expr_stmt|;
name|opts_unpack_net64
argument_list|(
literal|"sm_key"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|sm_key
argument_list|)
expr_stmt|;
name|opts_unpack_net64
argument_list|(
literal|"sa_key"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|sa_key
argument_list|)
expr_stmt|;
name|opts_unpack_net64
argument_list|(
literal|"subnet_prefix"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|subnet_prefix
argument_list|)
expr_stmt|;
name|opts_unpack_net16
argument_list|(
literal|"m_key_lease_period"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|m_key_lease_period
argument_list|)
expr_stmt|;
name|opts_unpack_uint32
argument_list|(
literal|"sweep_interval"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|sweep_interval
argument_list|)
expr_stmt|;
name|opts_unpack_uint32
argument_list|(
literal|"max_wire_smps"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|max_wire_smps
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"console"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|console
argument_list|)
expr_stmt|;
name|opts_unpack_uint16
argument_list|(
literal|"console_port"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|console_port
argument_list|)
expr_stmt|;
name|opts_unpack_uint32
argument_list|(
literal|"transaction_timeout"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|transaction_timeout
argument_list|)
expr_stmt|;
name|opts_unpack_uint32
argument_list|(
literal|"max_msg_fifo_timeout"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|max_msg_fifo_timeout
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"sm_priority"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|sm_priority
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"lmc"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|lmc
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"lmc_esp0"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|lmc_esp0
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"max_op_vls"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|max_op_vls
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"force_link_speed"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|force_link_speed
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"reassign_lids"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|reassign_lids
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"ignore_other_sm"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|ignore_other_sm
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"single_thread"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|single_thread
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"disable_multicast"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|disable_multicast
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"force_log_flush"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|force_log_flush
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"subnet_timeout"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|subnet_timeout
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"packet_life_time"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|packet_life_time
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"vl_stall_count"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|vl_stall_count
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"leaf_vl_stall_count"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|leaf_vl_stall_count
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"head_of_queue_lifetime"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|head_of_queue_lifetime
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"leaf_head_of_queue_lifetime"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|leaf_head_of_queue_lifetime
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"local_phy_errors_threshold"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|local_phy_errors_threshold
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"overrun_errors_threshold"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|overrun_errors_threshold
argument_list|)
expr_stmt|;
name|opts_unpack_uint32
argument_list|(
literal|"sminfo_polling_timeout"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|sminfo_polling_timeout
argument_list|)
expr_stmt|;
name|opts_unpack_uint32
argument_list|(
literal|"polling_retry_number"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|polling_retry_number
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"force_heavy_sweep"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|force_heavy_sweep
argument_list|)
expr_stmt|;
name|opts_unpack_uint8
argument_list|(
literal|"log_flags"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|log_flags
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"port_prof_ignore_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|port_prof_ignore_file
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"port_profile_switch_nodes"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|port_profile_switch_nodes
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"sweep_on_trap"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|sweep_on_trap
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"routing_engine"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|routing_engine_names
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"connect_roots"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|connect_roots
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"use_ucast_cache"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|use_ucast_cache
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"log_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|log_file
argument_list|)
expr_stmt|;
name|opts_unpack_uint32
argument_list|(
literal|"log_max_size"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|p_opts
operator|->
name|log_max_size
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|log_max_size
operator|*=
literal|1024
operator|*
literal|1024
expr_stmt|;
comment|/* convert to MB */
name|opts_unpack_charp
argument_list|(
literal|"partition_config_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|partition_config_file
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"no_partition_enforcement"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|no_partition_enforcement
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"qos"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|qos
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"qos_policy_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_policy_file
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"accum_log_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|accum_log_file
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"dump_files_dir"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|dump_files_dir
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"lid_matrix_dump_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|lid_matrix_dump_file
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"lfts_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|lfts_file
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"root_guid_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|root_guid_file
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"cn_guid_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|cn_guid_file
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"ids_guid_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|ids_guid_file
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"guid_routing_order_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|guid_routing_order_file
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"sa_db_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|sa_db_file
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"exit_on_fatal"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|exit_on_fatal
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"honor_guid2lid_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|honor_guid2lid_file
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"daemon"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|daemon
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"sm_inactive"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|sm_inactive
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"babbling_port_policy"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|babbling_port_policy
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
name|opts_unpack_boolean
argument_list|(
literal|"perfmgr"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|perfmgr
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"perfmgr_redir"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|perfmgr_redir
argument_list|)
expr_stmt|;
name|opts_unpack_uint16
argument_list|(
literal|"perfmgr_sweep_time_s"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|perfmgr_sweep_time_s
argument_list|)
expr_stmt|;
name|opts_unpack_uint32
argument_list|(
literal|"perfmgr_max_outstanding_queries"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|perfmgr_max_outstanding_queries
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"event_db_dump_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|event_db_dump_file
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* ENABLE_OSM_PERF_MGR */
name|opts_unpack_charp
argument_list|(
literal|"event_plugin_name"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|event_plugin_name
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"node_name_map_name"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|node_name_map_name
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos_ca"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_ca_options
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos_sw0"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_sw0_options
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos_swe"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_swe_options
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos_rtr"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_rtr_options
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"enable_quirks"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|enable_quirks
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"no_clients_rereg"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|no_clients_rereg
argument_list|)
expr_stmt|;
name|opts_unpack_charp
argument_list|(
literal|"prefix_routes_file"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|prefix_routes_file
argument_list|)
expr_stmt|;
name|opts_unpack_boolean
argument_list|(
literal|"consolidate_ipv6_snm_req"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_opts
operator|->
name|consolidate_ipv6_snm_req
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|opts_file
argument_list|)
expr_stmt|;
name|osm_subn_verify_config
argument_list|(
name|p_opts
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|osm_subn_rescan_conf_files
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
specifier|const
name|p_subn
parameter_list|)
block|{
name|FILE
modifier|*
name|opts_file
decl_stmt|;
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|p_key
decl_stmt|,
modifier|*
name|p_val
decl_stmt|,
modifier|*
name|p_last
decl_stmt|;
if|if
condition|(
operator|!
name|p_subn
operator|->
name|opt
operator|.
name|config_file
condition|)
return|return
literal|0
return|;
name|opts_file
operator|=
name|fopen
argument_list|(
name|p_subn
operator|->
name|opt
operator|.
name|config_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opts_file
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
return|return
literal|1
return|;
name|OSM_LOG
argument_list|(
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"cannot open file \'%s\': %s\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|config_file
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|subn_init_qos_options
argument_list|(
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_ca_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_sw0_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_swe_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_rtr_options
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
literal|1023
argument_list|,
name|opts_file
argument_list|)
operator|!=
name|NULL
condition|)
block|{
comment|/* get the first token */
name|p_key
operator|=
name|strtok_r
argument_list|(
name|line
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_key
condition|)
block|{
name|p_val
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_options
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos_ca"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_ca_options
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos_sw0"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_sw0_options
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos_swe"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_swe_options
argument_list|)
expr_stmt|;
name|subn_parse_qos_options
argument_list|(
literal|"qos_rtr"
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
operator|&
name|p_subn
operator|->
name|opt
operator|.
name|qos_rtr_options
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|opts_file
argument_list|)
expr_stmt|;
name|osm_subn_verify_config
argument_list|(
operator|&
name|p_subn
operator|->
name|opt
argument_list|)
expr_stmt|;
name|osm_parse_prefix_routes_file
argument_list|(
name|p_subn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|int
name|osm_subn_output_conf
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|IN
name|osm_subn_opt_t
modifier|*
specifier|const
name|p_opts
parameter_list|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# DEVICE ATTRIBUTES OPTIONS\n#\n"
literal|"# The port GUID on which the OpenSM is running\n"
literal|"guid 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# M_Key value sent to all ports qualifying all Set(PortInfo)\n"
literal|"m_key 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# The lease period used for the M_Key on this subnet in [sec]\n"
literal|"m_key_lease_period %u\n\n"
literal|"# SM_Key value of the SM used for SM authentication\n"
literal|"sm_key 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# SM_Key value to qualify rcv SA queries as 'trusted'\n"
literal|"sa_key 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# Note that for both values above (sm_key and sa_key)\n"
literal|"# OpenSM version 3.2.1 and below used the default value '1'\n"
literal|"# in a host byte order, it is fixed now but you may need to\n"
literal|"# change the values to interoperate with old OpenSM running\n"
literal|"# on a little endian machine.\n\n"
literal|"# Subnet prefix used on this subnet\n"
literal|"subnet_prefix 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# The LMC value used on this subnet\n"
literal|"lmc %u\n\n"
literal|"# lmc_esp0 determines whether LMC value used on subnet is used for\n"
literal|"# enhanced switch port 0. If TRUE, LMC value for subnet is used for\n"
literal|"# ESP0. Otherwise, LMC value for ESP0s is 0.\n"
literal|"lmc_esp0 %s\n\n"
literal|"# The code of maximal time a packet can live in a switch\n"
literal|"# The actual time is 4.096usec * 2^<packet_life_time>\n"
literal|"# The value 0x14 disables this mechanism\n"
literal|"packet_life_time 0x%02x\n\n"
literal|"# The number of sequential packets dropped that cause the port\n"
literal|"# to enter the VLStalled state. The result of setting this value to\n"
literal|"# zero is undefined.\n"
literal|"vl_stall_count 0x%02x\n\n"
literal|"# The number of sequential packets dropped that cause the port\n"
literal|"# to enter the VLStalled state. This value is for switch ports\n"
literal|"# driving a CA or router port. The result of setting this value\n"
literal|"# to zero is undefined.\n"
literal|"leaf_vl_stall_count 0x%02x\n\n"
literal|"# The code of maximal time a packet can wait at the head of\n"
literal|"# transmission queue.\n"
literal|"# The actual time is 4.096usec * 2^<head_of_queue_lifetime>\n"
literal|"# The value 0x14 disables this mechanism\n"
literal|"head_of_queue_lifetime 0x%02x\n\n"
literal|"# The maximal time a packet can wait at the head of queue on\n"
literal|"# switch port connected to a CA or router port\n"
literal|"leaf_head_of_queue_lifetime 0x%02x\n\n"
literal|"# Limit the maximal operational VLs\n"
literal|"max_op_vls %u\n\n"
literal|"# Force PortInfo:LinkSpeedEnabled on switch ports\n"
literal|"# If 0, don't modify PortInfo:LinkSpeedEnabled on switch port\n"
literal|"# Otherwise, use value for PortInfo:LinkSpeedEnabled on switch port\n"
literal|"# Values are (IB Spec 1.2.1, 14.2.5.6 Table 146 \"PortInfo\")\n"
literal|"#    1: 2.5 Gbps\n"
literal|"#    3: 2.5 or 5.0 Gbps\n"
literal|"#    5: 2.5 or 10.0 Gbps\n"
literal|"#    7: 2.5 or 5.0 or 10.0 Gbps\n"
literal|"#    2,4,6,8-14 Reserved\n"
literal|"#    Default 15: set to PortInfo:LinkSpeedSupported\n"
literal|"force_link_speed %u\n\n"
literal|"# The subnet_timeout code that will be set for all the ports\n"
literal|"# The actual timeout is 4.096usec * 2^<subnet_timeout>\n"
literal|"subnet_timeout %u\n\n"
literal|"# Threshold of local phy errors for sending Trap 129\n"
literal|"local_phy_errors_threshold 0x%02x\n\n"
literal|"# Threshold of credit overrun errors for sending Trap 130\n"
literal|"overrun_errors_threshold 0x%02x\n\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|m_key
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|m_key_lease_period
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|sm_key
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|sa_key
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|subnet_prefix
argument_list|)
argument_list|,
name|p_opts
operator|->
name|lmc
argument_list|,
name|p_opts
operator|->
name|lmc_esp0
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|packet_life_time
argument_list|,
name|p_opts
operator|->
name|vl_stall_count
argument_list|,
name|p_opts
operator|->
name|leaf_vl_stall_count
argument_list|,
name|p_opts
operator|->
name|head_of_queue_lifetime
argument_list|,
name|p_opts
operator|->
name|leaf_head_of_queue_lifetime
argument_list|,
name|p_opts
operator|->
name|max_op_vls
argument_list|,
name|p_opts
operator|->
name|force_link_speed
argument_list|,
name|p_opts
operator|->
name|subnet_timeout
argument_list|,
name|p_opts
operator|->
name|local_phy_errors_threshold
argument_list|,
name|p_opts
operator|->
name|overrun_errors_threshold
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# PARTITIONING OPTIONS\n#\n"
literal|"# Partition configuration file to be used\n"
literal|"partition_config_file %s\n\n"
literal|"# Disable partition enforcement by switches\n"
literal|"no_partition_enforcement %s\n\n"
argument_list|,
name|p_opts
operator|->
name|partition_config_file
argument_list|,
name|p_opts
operator|->
name|no_partition_enforcement
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# SWEEP OPTIONS\n#\n"
literal|"# The number of seconds between subnet sweeps (0 disables it)\n"
literal|"sweep_interval %u\n\n"
literal|"# If TRUE cause all lids to be reassigned\n"
literal|"reassign_lids %s\n\n"
literal|"# If TRUE forces every sweep to be a heavy sweep\n"
literal|"force_heavy_sweep %s\n\n"
literal|"# If TRUE every trap will cause a heavy sweep.\n"
literal|"# NOTE: successive identical traps (>10) are suppressed\n"
literal|"sweep_on_trap %s\n\n"
argument_list|,
name|p_opts
operator|->
name|sweep_interval
argument_list|,
name|p_opts
operator|->
name|reassign_lids
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|force_heavy_sweep
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|sweep_on_trap
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# ROUTING OPTIONS\n#\n"
literal|"# If TRUE count switches as link subscriptions\n"
literal|"port_profile_switch_nodes %s\n\n"
argument_list|,
name|p_opts
operator|->
name|port_profile_switch_nodes
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Name of file with port guids to be ignored by port profiling\n"
literal|"port_prof_ignore_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|port_prof_ignore_file
condition|?
name|p_opts
operator|->
name|port_prof_ignore_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Routing engine\n"
literal|"# Multiple routing engines can be specified separated by\n"
literal|"# commas so that specific ordering of routing algorithms will\n"
literal|"# be tried if earlier routing engines fail.\n"
literal|"# Supported engines: minhop, updn, file, ftree, lash, dor\n"
literal|"routing_engine %s\n\n"
argument_list|,
name|p_opts
operator|->
name|routing_engine_names
condition|?
name|p_opts
operator|->
name|routing_engine_names
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Connect roots (use FALSE if unsure)\n"
literal|"connect_roots %s\n\n"
argument_list|,
name|p_opts
operator|->
name|connect_roots
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Use unicast routing cache (use FALSE if unsure)\n"
literal|"use_ucast_cache %s\n\n"
argument_list|,
name|p_opts
operator|->
name|use_ucast_cache
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Lid matrix dump file name\n"
literal|"lid_matrix_dump_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|lid_matrix_dump_file
condition|?
name|p_opts
operator|->
name|lid_matrix_dump_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# LFTs file name\nlfts_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|lfts_file
condition|?
name|p_opts
operator|->
name|lfts_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding the root node guids (for fat-tree or Up/Down)\n"
literal|"# One guid in each line\nroot_guid_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|root_guid_file
condition|?
name|p_opts
operator|->
name|root_guid_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding the fat-tree compute node guids\n"
literal|"# One guid in each line\ncn_guid_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|cn_guid_file
condition|?
name|p_opts
operator|->
name|cn_guid_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding the node ids which will be used by"
literal|" Up/Down algorithm instead\n# of GUIDs (one guid and"
literal|" id in each line)\nids_guid_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|ids_guid_file
condition|?
name|p_opts
operator|->
name|ids_guid_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding guid routing order guids (for MinHop and Up/Down)\n"
literal|"guid_routing_order_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|guid_routing_order_file
condition|?
name|p_opts
operator|->
name|guid_routing_order_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# SA database file name\nsa_db_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|sa_db_file
condition|?
name|p_opts
operator|->
name|sa_db_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# HANDOVER - MULTIPLE SMs OPTIONS\n#\n"
literal|"# SM priority used for deciding who is the master\n"
literal|"# Range goes from 0 (lowest priority) to 15 (highest).\n"
literal|"sm_priority %u\n\n"
literal|"# If TRUE other SMs on the subnet should be ignored\n"
literal|"ignore_other_sm %s\n\n"
literal|"# Timeout in [msec] between two polls of active master SM\n"
literal|"sminfo_polling_timeout %u\n\n"
literal|"# Number of failing polls of remote SM that declares it dead\n"
literal|"polling_retry_number %u\n\n"
literal|"# If TRUE honor the guid2lid file when coming out of standby\n"
literal|"# state, if such file exists and is valid\n"
literal|"honor_guid2lid_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|sm_priority
argument_list|,
name|p_opts
operator|->
name|ignore_other_sm
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|sminfo_polling_timeout
argument_list|,
name|p_opts
operator|->
name|polling_retry_number
argument_list|,
name|p_opts
operator|->
name|honor_guid2lid_file
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# TIMING AND THREADING OPTIONS\n#\n"
literal|"# Maximum number of SMPs sent in parallel\n"
literal|"max_wire_smps %u\n\n"
literal|"# The maximum time in [msec] allowed for a transaction to complete\n"
literal|"transaction_timeout %u\n\n"
literal|"# Maximal time in [msec] a message can stay in the incoming message queue.\n"
literal|"# If there is more than one message in the queue and the last message\n"
literal|"# stayed in the queue more than this value, any SA request will be\n"
literal|"# immediately returned with a BUSY status.\n"
literal|"max_msg_fifo_timeout %u\n\n"
literal|"# Use a single thread for handling SA queries\n"
literal|"single_thread %s\n\n"
argument_list|,
name|p_opts
operator|->
name|max_wire_smps
argument_list|,
name|p_opts
operator|->
name|transaction_timeout
argument_list|,
name|p_opts
operator|->
name|max_msg_fifo_timeout
argument_list|,
name|p_opts
operator|->
name|single_thread
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# MISC OPTIONS\n#\n"
literal|"# Daemon mode\n"
literal|"daemon %s\n\n"
literal|"# SM Inactive\n"
literal|"sm_inactive %s\n\n"
literal|"# Babbling Port Policy\n"
literal|"babbling_port_policy %s\n\n"
argument_list|,
name|p_opts
operator|->
name|daemon
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|sm_inactive
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|babbling_port_policy
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Performance Manager Options\n#\n"
literal|"# perfmgr enable\n"
literal|"perfmgr %s\n\n"
literal|"# perfmgr redirection enable\n"
literal|"perfmgr_redir %s\n\n"
literal|"# sweep time in seconds\n"
literal|"perfmgr_sweep_time_s %u\n\n"
literal|"# Max outstanding queries\n"
literal|"perfmgr_max_outstanding_queries %u\n\n"
argument_list|,
name|p_opts
operator|->
name|perfmgr
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|perfmgr_redir
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|perfmgr_sweep_time_s
argument_list|,
name|p_opts
operator|->
name|perfmgr_max_outstanding_queries
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Event DB Options\n#\n"
literal|"# Dump file to dump the events to\n"
literal|"event_db_dump_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|event_db_dump_file
condition|?
name|p_opts
operator|->
name|event_db_dump_file
else|:
name|null_str
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* ENABLE_OSM_PERF_MGR */
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Event Plugin Options\n#\n"
literal|"event_plugin_name %s\n\n"
argument_list|,
name|p_opts
operator|->
name|event_plugin_name
condition|?
name|p_opts
operator|->
name|event_plugin_name
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Node name map for mapping node's to more descriptive node descriptions\n"
literal|"# (man ibnetdiscover for more information)\n#\n"
literal|"node_name_map_name %s\n\n"
argument_list|,
name|p_opts
operator|->
name|node_name_map_name
condition|?
name|p_opts
operator|->
name|node_name_map_name
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# DEBUG FEATURES\n#\n"
literal|"# The log flags used\n"
literal|"log_flags 0x%02x\n\n"
literal|"# Force flush of the log file after each log message\n"
literal|"force_log_flush %s\n\n"
literal|"# Log file to be used\n"
literal|"log_file %s\n\n"
literal|"# Limit the size of the log file in MB. If overrun, log is restarted\n"
literal|"log_max_size %lu\n\n"
literal|"# If TRUE will accumulate the log over multiple OpenSM sessions\n"
literal|"accum_log_file %s\n\n"
literal|"# The directory to hold the file OpenSM dumps\n"
literal|"dump_files_dir %s\n\n"
literal|"# If TRUE enables new high risk options and hardware specific quirks\n"
literal|"enable_quirks %s\n\n"
literal|"# If TRUE disables client reregistration\n"
literal|"no_clients_rereg %s\n\n"
literal|"# If TRUE OpenSM should disable multicast support and\n"
literal|"# no multicast routing is performed if TRUE\n"
literal|"disable_multicast %s\n\n"
literal|"# If TRUE opensm will exit on fatal initialization issues\n"
literal|"exit_on_fatal %s\n\n"
literal|"# console [off|local"
ifdef|#
directive|ifdef
name|ENABLE_OSM_CONSOLE_SOCKET
literal|"|loopback|socket]\n"
else|#
directive|else
literal|"]\n"
endif|#
directive|endif
literal|"console %s\n\n"
literal|"# Telnet port for console (default %d)\n"
literal|"console_port %d\n\n"
argument_list|,
name|p_opts
operator|->
name|log_flags
argument_list|,
name|p_opts
operator|->
name|force_log_flush
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|log_file
argument_list|,
name|p_opts
operator|->
name|log_max_size
operator|/
literal|1024
operator|/
literal|1024
argument_list|,
name|p_opts
operator|->
name|accum_log_file
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|dump_files_dir
argument_list|,
name|p_opts
operator|->
name|enable_quirks
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|no_clients_rereg
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|disable_multicast
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|exit_on_fatal
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_DEFAULT_CONSOLE_PORT
argument_list|,
name|p_opts
operator|->
name|console_port
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# QoS OPTIONS\n#\n"
literal|"# Enable QoS setup\n"
literal|"qos %s\n\n"
literal|"# QoS policy file to be used\n"
literal|"qos_policy_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|qos
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|qos_policy_file
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS default options"
argument_list|,
literal|"qos"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS CA options"
argument_list|,
literal|"qos_ca"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_ca_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS Switch Port 0 options"
argument_list|,
literal|"qos_sw0"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_sw0_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS Switch external ports options"
argument_list|,
literal|"qos_swe"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_swe_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS Router ports options"
argument_list|,
literal|"qos_rtr"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_rtr_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Prefix routes file name\n"
literal|"prefix_routes_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|prefix_routes_file
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# IPv6 Solicited Node Multicast (SNM) Options\n#\n"
literal|"consolidate_ipv6_snm_req %s\n\n"
argument_list|,
name|p_opts
operator|->
name|consolidate_ipv6_snm_req
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
comment|/* optional string attributes ... */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|osm_subn_write_conf_file
parameter_list|(
name|char
modifier|*
name|file_name
parameter_list|,
name|IN
name|osm_subn_opt_t
modifier|*
specifier|const
name|p_opts
parameter_list|)
block|{
name|FILE
modifier|*
name|opts_file
decl_stmt|;
name|opts_file
operator|=
name|fopen
argument_list|(
name|file_name
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opts_file
condition|)
block|{
name|printf
argument_list|(
literal|"cannot open file \'%s\' for writing: %s\n"
argument_list|,
name|file_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|osm_subn_output_conf
argument_list|(
name|opts_file
argument_list|,
name|p_opts
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|fclose
argument_list|(
name|opts_file
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


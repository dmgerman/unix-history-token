begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2007 The Regents of the University of California.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
end_ifdef

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_perfmgr_db.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_perfmgr.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_opensm.h>
end_include

begin_comment
comment|/** =========================================================================  */
end_comment

begin_function
name|perfmgr_db_t
modifier|*
name|perfmgr_db_construct
parameter_list|(
name|osm_perfmgr_t
modifier|*
name|perfmgr
parameter_list|)
block|{
name|perfmgr_db_t
modifier|*
name|db
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|db
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|db
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|cl_qmap_init
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|)
expr_stmt|;
name|cl_plock_construct
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|cl_plock_init
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|db
operator|->
name|perfmgr
operator|=
name|perfmgr
expr_stmt|;
return|return
operator|(
operator|(
name|void
operator|*
operator|)
name|db
operator|)
return|;
block|}
end_function

begin_comment
comment|/** =========================================================================  */
end_comment

begin_function
name|void
name|perfmgr_db_destroy
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|)
block|{
if|if
condition|(
name|db
condition|)
block|{
name|cl_plock_destroy
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  * Internal call db->lock should be held when calling  **********************************************************************/
end_comment

begin_function
specifier|static
specifier|inline
name|_db_node_t
modifier|*
name|_get
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|rc
init|=
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|,
name|guid
argument_list|)
decl_stmt|;
specifier|const
name|cl_map_item_t
modifier|*
name|end
init|=
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|==
name|end
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
operator|(
name|_db_node_t
operator|*
operator|)
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|perfmgr_db_err_t
name|bad_node_port
parameter_list|(
name|_db_node_t
modifier|*
name|node
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
if|if
condition|(
operator|!
name|node
condition|)
return|return
operator|(
name|PERFMGR_EVENT_DB_GUIDNOTFOUND
operator|)
return|;
if|if
condition|(
name|port
operator|==
literal|0
operator|||
name|port
operator|>=
name|node
operator|->
name|num_ports
condition|)
return|return
operator|(
name|PERFMGR_EVENT_DB_PORTNOTFOUND
operator|)
return|;
return|return
operator|(
name|PERFMGR_EVENT_DB_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/** =========================================================================  */
end_comment

begin_function
specifier|static
name|_db_node_t
modifier|*
name|__malloc_node
parameter_list|(
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|num_ports
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|time_t
name|cur_time
init|=
literal|0
decl_stmt|;
name|_db_node_t
modifier|*
name|rc
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rc
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|rc
operator|->
name|ports
operator|=
name|calloc
argument_list|(
name|num_ports
argument_list|,
sizeof|sizeof
argument_list|(
name|_db_port_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
operator|->
name|ports
condition|)
goto|goto
name|free_rc
goto|;
name|rc
operator|->
name|num_ports
operator|=
name|num_ports
expr_stmt|;
name|rc
operator|->
name|node_guid
operator|=
name|guid
expr_stmt|;
name|cur_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|last_reset
operator|=
name|cur_time
expr_stmt|;
name|rc
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_previous
operator|.
name|time
operator|=
name|cur_time
expr_stmt|;
name|rc
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_previous
operator|.
name|time
operator|=
name|cur_time
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|rc
operator|->
name|node_name
argument_list|,
name|NODE_NAME_SIZE
argument_list|,
literal|"%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
name|free_rc
label|:
name|free
argument_list|(
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/** =========================================================================  */
end_comment

begin_function
specifier|static
name|void
name|__free_node
parameter_list|(
name|_db_node_t
modifier|*
name|node
parameter_list|)
block|{
if|if
condition|(
operator|!
name|node
condition|)
return|return;
if|if
condition|(
name|node
operator|->
name|ports
condition|)
name|free
argument_list|(
name|node
operator|->
name|ports
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* insert nodes to the database */
end_comment

begin_function
specifier|static
name|perfmgr_db_err_t
name|__insert
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|_db_node_t
modifier|*
name|node
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|rc
init|=
name|cl_qmap_insert
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|,
name|node
operator|->
name|node_guid
argument_list|,
operator|(
name|cl_map_item_t
operator|*
operator|)
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|void
operator|*
operator|)
name|rc
operator|!=
operator|(
name|void
operator|*
operator|)
name|node
condition|)
return|return
operator|(
name|PERFMGR_EVENT_DB_FAIL
operator|)
return|;
return|return
operator|(
name|PERFMGR_EVENT_DB_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_create_entry
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|num_ports
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|_get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
condition|)
block|{
name|_db_node_t
modifier|*
name|pc_node
init|=
name|__malloc_node
argument_list|(
name|guid
argument_list|,
name|num_ports
argument_list|,
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|pc_node
condition|)
block|{
name|rc
operator|=
name|PERFMGR_EVENT_DB_NOMEM
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|__insert
argument_list|(
name|db
argument_list|,
name|pc_node
argument_list|)
condition|)
block|{
name|__free_node
argument_list|(
name|pc_node
argument_list|)
expr_stmt|;
name|rc
operator|=
name|PERFMGR_EVENT_DB_FAIL
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Dump a reading vs the previous reading to stdout  **********************************************************************/
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|debug_dump_err_reading
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port_num
parameter_list|,
name|_db_port_t
modifier|*
name|port
parameter_list|,
name|perfmgr_db_err_reading_t
modifier|*
name|cur
parameter_list|)
block|{
name|osm_log_t
modifier|*
name|log
init|=
name|db
operator|->
name|perfmgr
operator|->
name|log
decl_stmt|;
if|if
condition|(
operator|!
name|osm_log_is_active
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
condition|)
return|return;
comment|/* optimize this a bit */
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"GUID 0x%"
name|PRIx64
literal|" Port %u:\n"
argument_list|,
name|guid
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"sym %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|symbol_err_cnt
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|symbol_err_cnt
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|symbol_err_cnt
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"ler %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|link_err_recover
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|link_err_recover
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|link_err_recover
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"ld %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|link_downed
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|link_downed
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|link_downed
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"re %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|rcv_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|rcv_err
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"rrp %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_rem_phys_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|rcv_rem_phys_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|rcv_rem_phys_err
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"rsr %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_switch_relay_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|rcv_switch_relay_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|rcv_switch_relay_err
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"xd %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|xmit_discards
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|xmit_discards
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|xmit_discards
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"xce %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|xmit_constraint_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|xmit_constraint_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|xmit_constraint_err
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"rce %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_constraint_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|rcv_constraint_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|rcv_constraint_err
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"li %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|link_integrity
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|link_integrity
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|link_integrity
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"bo %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|buffer_overrun
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|buffer_overrun
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|buffer_overrun
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"vld %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|vl15_dropped
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|vl15_dropped
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|vl15_dropped
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * perfmgr_db_err_reading_t functions  **********************************************************************/
end_comment

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_add_err_reading
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|perfmgr_db_err_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|_db_port_t
modifier|*
name|p_port
init|=
name|NULL
decl_stmt|;
name|_db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_reading_t
modifier|*
name|previous
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|osm_epi_pe_event_t
name|epi_pe_data
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|node
operator|=
name|_get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|p_port
operator|=
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|)
expr_stmt|;
name|previous
operator|=
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|err_previous
operator|)
expr_stmt|;
name|debug_dump_err_reading
argument_list|(
name|db
argument_list|,
name|guid
argument_list|,
name|port
argument_list|,
name|p_port
argument_list|,
name|reading
argument_list|)
expr_stmt|;
name|epi_pe_data
operator|.
name|time_diff_s
operator|=
operator|(
name|reading
operator|->
name|time
operator|-
name|previous
operator|->
name|time
operator|)
expr_stmt|;
name|osm_epi_create_port_id
argument_list|(
operator|&
operator|(
name|epi_pe_data
operator|.
name|port_id
operator|)
argument_list|,
name|guid
argument_list|,
name|port
argument_list|,
name|node
operator|->
name|node_name
argument_list|)
expr_stmt|;
comment|/* calculate changes from previous reading */
name|epi_pe_data
operator|.
name|symbol_err_cnt
operator|=
operator|(
name|reading
operator|->
name|symbol_err_cnt
operator|-
name|previous
operator|->
name|symbol_err_cnt
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|symbol_err_cnt
operator|+=
name|epi_pe_data
operator|.
name|symbol_err_cnt
expr_stmt|;
name|epi_pe_data
operator|.
name|link_err_recover
operator|=
operator|(
name|reading
operator|->
name|link_err_recover
operator|-
name|previous
operator|->
name|link_err_recover
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|link_err_recover
operator|+=
name|epi_pe_data
operator|.
name|link_err_recover
expr_stmt|;
name|epi_pe_data
operator|.
name|link_downed
operator|=
operator|(
name|reading
operator|->
name|link_downed
operator|-
name|previous
operator|->
name|link_downed
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|link_downed
operator|+=
name|epi_pe_data
operator|.
name|link_downed
expr_stmt|;
name|epi_pe_data
operator|.
name|rcv_err
operator|=
operator|(
name|reading
operator|->
name|rcv_err
operator|-
name|previous
operator|->
name|rcv_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|rcv_err
operator|+=
name|epi_pe_data
operator|.
name|rcv_err
expr_stmt|;
name|epi_pe_data
operator|.
name|rcv_rem_phys_err
operator|=
operator|(
name|reading
operator|->
name|rcv_rem_phys_err
operator|-
name|previous
operator|->
name|rcv_rem_phys_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|rcv_rem_phys_err
operator|+=
name|epi_pe_data
operator|.
name|rcv_rem_phys_err
expr_stmt|;
name|epi_pe_data
operator|.
name|rcv_switch_relay_err
operator|=
operator|(
name|reading
operator|->
name|rcv_switch_relay_err
operator|-
name|previous
operator|->
name|rcv_switch_relay_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|rcv_switch_relay_err
operator|+=
name|epi_pe_data
operator|.
name|rcv_switch_relay_err
expr_stmt|;
name|epi_pe_data
operator|.
name|xmit_discards
operator|=
operator|(
name|reading
operator|->
name|xmit_discards
operator|-
name|previous
operator|->
name|xmit_discards
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|xmit_discards
operator|+=
name|epi_pe_data
operator|.
name|xmit_discards
expr_stmt|;
name|epi_pe_data
operator|.
name|xmit_constraint_err
operator|=
operator|(
name|reading
operator|->
name|xmit_constraint_err
operator|-
name|previous
operator|->
name|xmit_constraint_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|xmit_constraint_err
operator|+=
name|epi_pe_data
operator|.
name|xmit_constraint_err
expr_stmt|;
name|epi_pe_data
operator|.
name|rcv_constraint_err
operator|=
operator|(
name|reading
operator|->
name|rcv_constraint_err
operator|-
name|previous
operator|->
name|rcv_constraint_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|rcv_constraint_err
operator|+=
name|epi_pe_data
operator|.
name|rcv_constraint_err
expr_stmt|;
name|epi_pe_data
operator|.
name|link_integrity
operator|=
operator|(
name|reading
operator|->
name|link_integrity
operator|-
name|previous
operator|->
name|link_integrity
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|link_integrity
operator|+=
name|epi_pe_data
operator|.
name|link_integrity
expr_stmt|;
name|epi_pe_data
operator|.
name|buffer_overrun
operator|=
operator|(
name|reading
operator|->
name|buffer_overrun
operator|-
name|previous
operator|->
name|buffer_overrun
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|buffer_overrun
operator|+=
name|epi_pe_data
operator|.
name|buffer_overrun
expr_stmt|;
name|epi_pe_data
operator|.
name|vl15_dropped
operator|=
operator|(
name|reading
operator|->
name|vl15_dropped
operator|-
name|previous
operator|->
name|vl15_dropped
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|vl15_dropped
operator|+=
name|epi_pe_data
operator|.
name|vl15_dropped
expr_stmt|;
name|p_port
operator|->
name|err_previous
operator|=
operator|*
name|reading
expr_stmt|;
name|osm_opensm_report_event
argument_list|(
name|db
operator|->
name|perfmgr
operator|->
name|osm
argument_list|,
name|OSM_EVENT_ID_PORT_ERRORS
argument_list|,
operator|&
name|epi_pe_data
argument_list|)
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_get_prev_err
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|perfmgr_db_err_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|_db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|node
operator|=
name|_get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
operator|*
name|reading
operator|=
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|err_previous
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_clear_prev_err
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|_db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_reading_t
modifier|*
name|previous
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|node
operator|=
name|_get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|previous
operator|=
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|err_previous
operator|)
expr_stmt|;
name|memset
argument_list|(
name|previous
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|previous
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|err_previous
operator|.
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|debug_dump_dc_reading
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port_num
parameter_list|,
name|_db_port_t
modifier|*
name|port
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|cur
parameter_list|)
block|{
name|osm_log_t
modifier|*
name|log
init|=
name|db
operator|->
name|perfmgr
operator|->
name|log
decl_stmt|;
if|if
condition|(
operator|!
name|osm_log_is_active
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
condition|)
return|return;
comment|/* optimize this a big */
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"xd %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|xmit_data
argument_list|,
name|port
operator|->
name|dc_previous
operator|.
name|xmit_data
argument_list|,
name|port
operator|->
name|dc_total
operator|.
name|xmit_data
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"rd %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_data
argument_list|,
name|port
operator|->
name|dc_previous
operator|.
name|rcv_data
argument_list|,
name|port
operator|->
name|dc_total
operator|.
name|rcv_data
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"xp %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|xmit_pkts
argument_list|,
name|port
operator|->
name|dc_previous
operator|.
name|xmit_pkts
argument_list|,
name|port
operator|->
name|dc_total
operator|.
name|xmit_pkts
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"rp %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_pkts
argument_list|,
name|port
operator|->
name|dc_previous
operator|.
name|rcv_pkts
argument_list|,
name|port
operator|->
name|dc_total
operator|.
name|rcv_pkts
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * perfmgr_db_data_cnt_reading_t functions  **********************************************************************/
end_comment

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_add_dc_reading
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|_db_port_t
modifier|*
name|p_port
init|=
name|NULL
decl_stmt|;
name|_db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|previous
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|osm_epi_dc_event_t
name|epi_dc_data
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|node
operator|=
name|_get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|p_port
operator|=
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|)
expr_stmt|;
name|previous
operator|=
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|dc_previous
operator|)
expr_stmt|;
name|debug_dump_dc_reading
argument_list|(
name|db
argument_list|,
name|guid
argument_list|,
name|port
argument_list|,
name|p_port
argument_list|,
name|reading
argument_list|)
expr_stmt|;
name|epi_dc_data
operator|.
name|time_diff_s
operator|=
operator|(
name|reading
operator|->
name|time
operator|-
name|previous
operator|->
name|time
operator|)
expr_stmt|;
name|osm_epi_create_port_id
argument_list|(
operator|&
operator|(
name|epi_dc_data
operator|.
name|port_id
operator|)
argument_list|,
name|guid
argument_list|,
name|port
argument_list|,
name|node
operator|->
name|node_name
argument_list|)
expr_stmt|;
comment|/* calculate changes from previous reading */
name|epi_dc_data
operator|.
name|xmit_data
operator|=
operator|(
name|reading
operator|->
name|xmit_data
operator|-
name|previous
operator|->
name|xmit_data
operator|)
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|xmit_data
operator|+=
name|epi_dc_data
operator|.
name|xmit_data
expr_stmt|;
name|epi_dc_data
operator|.
name|rcv_data
operator|=
operator|(
name|reading
operator|->
name|rcv_data
operator|-
name|previous
operator|->
name|rcv_data
operator|)
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|rcv_data
operator|+=
name|epi_dc_data
operator|.
name|rcv_data
expr_stmt|;
name|epi_dc_data
operator|.
name|xmit_pkts
operator|=
operator|(
name|reading
operator|->
name|xmit_pkts
operator|-
name|previous
operator|->
name|xmit_pkts
operator|)
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|xmit_pkts
operator|+=
name|epi_dc_data
operator|.
name|xmit_pkts
expr_stmt|;
name|epi_dc_data
operator|.
name|rcv_pkts
operator|=
operator|(
name|reading
operator|->
name|rcv_pkts
operator|-
name|previous
operator|->
name|rcv_pkts
operator|)
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|rcv_pkts
operator|+=
name|epi_dc_data
operator|.
name|rcv_pkts
expr_stmt|;
name|epi_dc_data
operator|.
name|unicast_xmit_pkts
operator|=
operator|(
name|reading
operator|->
name|unicast_xmit_pkts
operator|-
name|previous
operator|->
name|unicast_xmit_pkts
operator|)
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|unicast_xmit_pkts
operator|+=
name|epi_dc_data
operator|.
name|unicast_xmit_pkts
expr_stmt|;
name|epi_dc_data
operator|.
name|unicast_rcv_pkts
operator|=
operator|(
name|reading
operator|->
name|unicast_rcv_pkts
operator|-
name|previous
operator|->
name|unicast_rcv_pkts
operator|)
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|unicast_rcv_pkts
operator|+=
name|epi_dc_data
operator|.
name|unicast_rcv_pkts
expr_stmt|;
name|epi_dc_data
operator|.
name|multicast_xmit_pkts
operator|=
operator|(
name|reading
operator|->
name|multicast_xmit_pkts
operator|-
name|previous
operator|->
name|multicast_xmit_pkts
operator|)
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|multicast_xmit_pkts
operator|+=
name|epi_dc_data
operator|.
name|multicast_xmit_pkts
expr_stmt|;
name|epi_dc_data
operator|.
name|multicast_rcv_pkts
operator|=
operator|(
name|reading
operator|->
name|multicast_rcv_pkts
operator|-
name|previous
operator|->
name|multicast_rcv_pkts
operator|)
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|multicast_rcv_pkts
operator|+=
name|epi_dc_data
operator|.
name|multicast_rcv_pkts
expr_stmt|;
name|p_port
operator|->
name|dc_previous
operator|=
operator|*
name|reading
expr_stmt|;
name|osm_opensm_report_event
argument_list|(
name|db
operator|->
name|perfmgr
operator|->
name|osm
argument_list|,
name|OSM_EVENT_ID_PORT_DATA_COUNTERS
argument_list|,
operator|&
name|epi_dc_data
argument_list|)
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_get_prev_dc
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|_db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|node
operator|=
name|_get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
operator|*
name|reading
operator|=
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|dc_previous
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_clear_prev_dc
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|_db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|previous
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|node
operator|=
name|_get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|previous
operator|=
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|dc_previous
operator|)
expr_stmt|;
name|memset
argument_list|(
name|previous
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|previous
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|dc_previous
operator|.
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__clear_counters
parameter_list|(
name|cl_map_item_t
modifier|*
specifier|const
name|p_map_item
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|_db_node_t
modifier|*
name|node
init|=
operator|(
name|_db_node_t
operator|*
operator|)
name|p_map_item
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|time_t
name|ts
init|=
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|node
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|symbol_err_cnt
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_err_recover
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_downed
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_rem_phys_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_switch_relay_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_discards
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_constraint_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_constraint_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_integrity
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|buffer_overrun
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|vl15_dropped
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|time
operator|=
name|ts
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_data
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_data
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_xmit_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_rcv_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_xmit_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_rcv_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|time
operator|=
name|ts
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|last_reset
operator|=
name|ts
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  * Clear all the counters from the db  **********************************************************************/
end_comment

begin_function
name|void
name|perfmgr_db_clear_counters
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|)
block|{
name|cl_plock_excl_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|cl_qmap_apply_func
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|,
name|__clear_counters
argument_list|,
operator|(
name|void
operator|*
operator|)
name|db
argument_list|)
expr_stmt|;
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (db->db_impl->clear_counters) 		db->db_impl->clear_counters(db->db_data);
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**********************************************************************  * Output a tab delimited output of the port counters  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|__dump_node_mr
parameter_list|(
name|_db_node_t
modifier|*
name|node
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\nName\tGUID\tPort\tLast Reset\t"
literal|"%s\t%s\t"
literal|"%s\t%s\t%s\t%s\t%s\t%s\t%s\t"
literal|"%s\t%s\t%s\t%s\t%s\t%s\t%s\t"
literal|"%s\t%s\t%s\t%s\n"
argument_list|,
literal|"symbol_err_cnt"
argument_list|,
literal|"link_err_recover"
argument_list|,
literal|"link_downed"
argument_list|,
literal|"rcv_err"
argument_list|,
literal|"rcv_rem_phys_err"
argument_list|,
literal|"rcv_switch_relay_err"
argument_list|,
literal|"xmit_discards"
argument_list|,
literal|"xmit_constraint_err"
argument_list|,
literal|"rcv_constraint_err"
argument_list|,
literal|"link_int_err"
argument_list|,
literal|"buf_overrun_err"
argument_list|,
literal|"vl15_dropped"
argument_list|,
literal|"xmit_data"
argument_list|,
literal|"rcv_data"
argument_list|,
literal|"xmit_pkts"
argument_list|,
literal|"rcv_pkts"
argument_list|,
literal|"unicast_xmit_pkts"
argument_list|,
literal|"unicast_rcv_pkts"
argument_list|,
literal|"multicast_xmit_pkts"
argument_list|,
literal|"multicast_rcv_pkts"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|node
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|since
init|=
name|ctime
argument_list|(
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|last_reset
operator|)
argument_list|)
decl_stmt|;
name|since
index|[
name|strlen
argument_list|(
name|since
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* remove \n */
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s\t0x%"
name|PRIx64
literal|"\t%d\t%s\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|node
operator|->
name|node_name
argument_list|,
name|node
operator|->
name|node_guid
argument_list|,
name|i
argument_list|,
name|since
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|symbol_err_cnt
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_err_recover
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_downed
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_rem_phys_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_switch_relay_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_discards
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_constraint_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_constraint_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_integrity
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|buffer_overrun
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|vl15_dropped
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_data
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_data
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_xmit_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_rcv_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_xmit_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_rcv_pkts
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  * Output a human readable output of the port counters  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|__dump_node_hr
parameter_list|(
name|_db_node_t
modifier|*
name|node
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|node
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|since
init|=
name|ctime
argument_list|(
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|last_reset
operator|)
argument_list|)
decl_stmt|;
name|since
index|[
name|strlen
argument_list|(
name|since
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* remove \n */
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\"%s\" 0x%"
name|PRIx64
literal|" port %d (Since %s)\n"
literal|"     symbol_err_cnt       : %"
name|PRIu64
literal|"\n"
literal|"     link_err_recover     : %"
name|PRIu64
literal|"\n"
literal|"     link_downed          : %"
name|PRIu64
literal|"\n"
literal|"     rcv_err              : %"
name|PRIu64
literal|"\n"
literal|"     rcv_rem_phys_err     : %"
name|PRIu64
literal|"\n"
literal|"     rcv_switch_relay_err : %"
name|PRIu64
literal|"\n"
literal|"     xmit_discards        : %"
name|PRIu64
literal|"\n"
literal|"     xmit_constraint_err  : %"
name|PRIu64
literal|"\n"
literal|"     rcv_constraint_err   : %"
name|PRIu64
literal|"\n"
literal|"     link_integrity_err   : %"
name|PRIu64
literal|"\n"
literal|"     buf_overrun_err      : %"
name|PRIu64
literal|"\n"
literal|"     vl15_dropped         : %"
name|PRIu64
literal|"\n"
literal|"     xmit_data            : %"
name|PRIu64
literal|"\n"
literal|"     rcv_data             : %"
name|PRIu64
literal|"\n"
literal|"     xmit_pkts            : %"
name|PRIu64
literal|"\n"
literal|"     rcv_pkts             : %"
name|PRIu64
literal|"\n"
literal|"     unicast_xmit_pkts    : %"
name|PRIu64
literal|"\n"
literal|"     unicast_rcv_pkts     : %"
name|PRIu64
literal|"\n"
literal|"     multicast_xmit_pkts  : %"
name|PRIu64
literal|"\n"
literal|"     multicast_rcv_pkts   : %"
name|PRIu64
literal|"\n"
argument_list|,
name|node
operator|->
name|node_name
argument_list|,
name|node
operator|->
name|node_guid
argument_list|,
name|i
argument_list|,
name|since
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|symbol_err_cnt
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_err_recover
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_downed
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_rem_phys_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_switch_relay_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_discards
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_constraint_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_constraint_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_integrity
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|buffer_overrun
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|vl15_dropped
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_data
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_data
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_xmit_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_rcv_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_xmit_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_rcv_pkts
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Define a context for the __db_dump callback */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|perfmgr_db_dump_t
name|dump_type
decl_stmt|;
block|}
name|dump_context_t
typedef|;
end_typedef

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|__db_dump
parameter_list|(
name|cl_map_item_t
modifier|*
specifier|const
name|p_map_item
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|_db_node_t
modifier|*
name|node
init|=
operator|(
name|_db_node_t
operator|*
operator|)
name|p_map_item
decl_stmt|;
name|dump_context_t
modifier|*
name|c
init|=
operator|(
name|dump_context_t
operator|*
operator|)
name|context
decl_stmt|;
name|FILE
modifier|*
name|fp
init|=
name|c
operator|->
name|fp
decl_stmt|;
switch|switch
condition|(
name|c
operator|->
name|dump_type
condition|)
block|{
case|case
name|PERFMGR_EVENT_DB_DUMP_MR
case|:
name|__dump_node_mr
argument_list|(
name|node
argument_list|,
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PERFMGR_EVENT_DB_DUMP_HR
case|:
default|default:
name|__dump_node_hr
argument_list|(
name|node
argument_list|,
name|fp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  * print node data to fp  **********************************************************************/
end_comment

begin_function
name|void
name|perfmgr_db_print_by_name
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|char
modifier|*
name|nodename
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|item
init|=
name|NULL
decl_stmt|;
name|_db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
comment|/* find the node */
name|item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|)
condition|)
block|{
name|node
operator|=
operator|(
name|_db_node_t
operator|*
operator|)
name|item
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|node
operator|->
name|node_name
argument_list|,
name|nodename
argument_list|)
operator|==
literal|0
condition|)
block|{
name|__dump_node_hr
argument_list|(
name|node
argument_list|,
name|fp
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|item
operator|=
name|cl_qmap_next
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Node %s not found...\n"
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|done
label|:
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * print node data to fp  **********************************************************************/
end_comment

begin_function
name|void
name|perfmgr_db_print_by_guid
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|nodeguid
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|node
operator|=
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|,
name|nodeguid
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|)
condition|)
name|__dump_node_hr
argument_list|(
operator|(
name|_db_node_t
operator|*
operator|)
name|node
argument_list|,
name|fp
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Node %"
name|PRIx64
literal|" not found...\n"
argument_list|,
name|nodeguid
argument_list|)
expr_stmt|;
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * dump the data to the file "file"  **********************************************************************/
end_comment

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_dump
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|perfmgr_db_dump_t
name|dump_type
parameter_list|)
block|{
name|dump_context_t
name|context
decl_stmt|;
name|context
operator|.
name|fp
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"w+"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|context
operator|.
name|fp
condition|)
return|return
operator|(
name|PERFMGR_EVENT_DB_FAIL
operator|)
return|;
name|context
operator|.
name|dump_type
operator|=
name|dump_type
expr_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|cl_qmap_apply_func
argument_list|(
operator|&
operator|(
name|db
operator|->
name|pc_data
operator|)
argument_list|,
name|__db_dump
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|context
argument_list|)
expr_stmt|;
name|cl_plock_release
argument_list|(
operator|&
operator|(
name|db
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|context
operator|.
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|PERFMGR_EVENT_DB_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Fill in the various DB objects from their wire counter parts  **********************************************************************/
end_comment

begin_function
name|void
name|perfmgr_db_fill_err_read
parameter_list|(
name|ib_port_counters_t
modifier|*
name|wire_read
parameter_list|,
name|perfmgr_db_err_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|reading
operator|->
name|symbol_err_cnt
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|symbol_err_cnt
argument_list|)
expr_stmt|;
name|reading
operator|->
name|link_err_recover
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|link_err_recover
argument_list|)
expr_stmt|;
name|reading
operator|->
name|link_downed
operator|=
name|wire_read
operator|->
name|link_downed
expr_stmt|;
name|reading
operator|->
name|rcv_err
operator|=
name|wire_read
operator|->
name|rcv_err
expr_stmt|;
name|reading
operator|->
name|rcv_rem_phys_err
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|rcv_rem_phys_err
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_switch_relay_err
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|rcv_switch_relay_err
argument_list|)
expr_stmt|;
name|reading
operator|->
name|xmit_discards
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|xmit_discards
argument_list|)
expr_stmt|;
name|reading
operator|->
name|xmit_constraint_err
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|xmit_constraint_err
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_constraint_err
operator|=
name|wire_read
operator|->
name|rcv_constraint_err
expr_stmt|;
name|reading
operator|->
name|link_integrity
operator|=
name|PC_LINK_INT
argument_list|(
name|wire_read
operator|->
name|link_int_buffer_overrun
argument_list|)
expr_stmt|;
name|reading
operator|->
name|buffer_overrun
operator|=
name|PC_BUF_OVERRUN
argument_list|(
name|wire_read
operator|->
name|link_int_buffer_overrun
argument_list|)
expr_stmt|;
name|reading
operator|->
name|vl15_dropped
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|vl15_dropped
argument_list|)
expr_stmt|;
name|reading
operator|->
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|perfmgr_db_fill_data_cnt_read_pc
parameter_list|(
name|ib_port_counters_t
modifier|*
name|wire_read
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|reading
operator|->
name|xmit_data
operator|=
name|cl_ntoh32
argument_list|(
name|wire_read
operator|->
name|xmit_data
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_data
operator|=
name|cl_ntoh32
argument_list|(
name|wire_read
operator|->
name|rcv_data
argument_list|)
expr_stmt|;
name|reading
operator|->
name|xmit_pkts
operator|=
name|cl_ntoh32
argument_list|(
name|wire_read
operator|->
name|xmit_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_pkts
operator|=
name|cl_ntoh32
argument_list|(
name|wire_read
operator|->
name|rcv_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|unicast_xmit_pkts
operator|=
literal|0
expr_stmt|;
name|reading
operator|->
name|unicast_rcv_pkts
operator|=
literal|0
expr_stmt|;
name|reading
operator|->
name|multicast_xmit_pkts
operator|=
literal|0
expr_stmt|;
name|reading
operator|->
name|multicast_rcv_pkts
operator|=
literal|0
expr_stmt|;
name|reading
operator|->
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|perfmgr_db_fill_data_cnt_read_epc
parameter_list|(
name|ib_port_counters_ext_t
modifier|*
name|wire_read
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|reading
operator|->
name|xmit_data
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|xmit_data
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_data
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|rcv_data
argument_list|)
expr_stmt|;
name|reading
operator|->
name|xmit_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|xmit_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|rcv_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|unicast_xmit_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|unicast_xmit_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|unicast_rcv_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|unicast_rcv_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|multicast_xmit_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|multicast_xmit_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|multicast_rcv_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|multicast_rcv_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ENABLE_OSM_PERF_MGR */
end_comment

end_unit


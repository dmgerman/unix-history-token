begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2005 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of inform record functions.  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_helper.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_inform.h>
end_include

begin_include
include|#
directive|include
file|<vendor/osm_vendor_api.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_pkey.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_sa.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_typedef
typedef|typedef
struct|struct
name|osm_infr_match_ctxt
block|{
name|cl_list_t
modifier|*
name|p_remove_infr_list
decl_stmt|;
name|ib_mad_notice_attr_t
modifier|*
name|p_ntc
decl_stmt|;
block|}
name|osm_infr_match_ctxt_t
typedef|;
end_typedef

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osm_infr_delete
parameter_list|(
name|IN
name|osm_infr_t
modifier|*
specifier|const
name|p_infr
parameter_list|)
block|{
name|free
argument_list|(
name|p_infr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|osm_infr_t
modifier|*
name|osm_infr_new
parameter_list|(
name|IN
specifier|const
name|osm_infr_t
modifier|*
name|p_infr_rec
parameter_list|)
block|{
name|osm_infr_t
modifier|*
name|p_infr
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|p_infr_rec
argument_list|)
expr_stmt|;
name|p_infr
operator|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|osm_infr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_infr
condition|)
name|memcpy
argument_list|(
name|p_infr
argument_list|,
name|p_infr_rec
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_infr_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|p_infr
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|dump_all_informs
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|)
block|{
name|cl_list_item_t
modifier|*
name|p_list_item
decl_stmt|;
if|if
condition|(
operator|!
name|osm_log_is_active
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
condition|)
return|return;
name|p_list_item
operator|=
name|cl_qlist_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_list_item
operator|!=
name|cl_qlist_end
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
condition|)
block|{
name|osm_dump_inform_info
argument_list|(
name|p_log
argument_list|,
operator|&
operator|(
operator|(
name|osm_infr_t
operator|*
operator|)
name|p_list_item
operator|)
operator|->
name|inform_record
operator|.
name|inform_info
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
expr_stmt|;
name|p_list_item
operator|=
name|cl_qlist_next
argument_list|(
name|p_list_item
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  * Match an infr by the InformInfo and Address vector  **********************************************************************/
end_comment

begin_function
specifier|static
name|cl_status_t
name|__match_inf_rec
parameter_list|(
name|IN
specifier|const
name|cl_list_item_t
modifier|*
specifier|const
name|p_list_item
parameter_list|,
name|IN
name|void
modifier|*
name|context
parameter_list|)
block|{
name|osm_infr_t
modifier|*
name|p_infr_rec
init|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|context
decl_stmt|;
name|osm_infr_t
modifier|*
name|p_infr
init|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|p_list_item
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
init|=
name|p_infr_rec
operator|->
name|sa
operator|->
name|p_log
decl_stmt|;
name|cl_status_t
name|status
init|=
name|CL_NOT_FOUND
decl_stmt|;
name|ib_gid_t
name|all_zero_gid
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|p_infr
operator|->
name|report_addr
argument_list|,
operator|&
name|p_infr_rec
operator|->
name|report_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|p_infr_rec
operator|->
name|report_addr
argument_list|)
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by Address\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|memset
argument_list|(
operator|&
name|all_zero_gid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* if inform_info.gid is not zero, ignore lid range */
if|if
condition|(
operator|!
name|memcmp
argument_list|(
operator|&
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|gid
argument_list|,
operator|&
name|all_zero_gid
argument_list|,
sizeof|sizeof
argument_list|(
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|gid
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|gid
argument_list|,
operator|&
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|gid
argument_list|,
sizeof|sizeof
argument_list|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|gid
argument_list|)
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.gid\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|lid_range_begin
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|lid_range_begin
operator|)
operator|||
operator|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|lid_range_end
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|lid_range_end
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.LIDRange\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|trap_type
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|trap_type
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.TrapType\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|is_generic
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|is_generic
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.IsGeneric\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|is_generic
condition|)
block|{
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.Generic.TrapNumber\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|qpn_resp_time_val
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|qpn_resp_time_val
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.Generic.QPNRespTimeVal\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|node_type_msb
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|node_type_msb
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.Generic.NodeTypeMSB\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|node_type_lsb
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|node_type_lsb
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.Generic.NodeTypeLSB\n"
argument_list|)
expr_stmt|;
else|else
name|status
operator|=
name|CL_SUCCESS
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|dev_id
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|dev_id
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.Vendor.DeviceID\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|qpn_resp_time_val
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|qpn_resp_time_val
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.Vendor.QPNRespTimeVal\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|vendor_id_msb
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|vendor_id_msb
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.Vendor.VendorIdMSB\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|vendor_id_lsb
operator|!=
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|vendor_id_lsb
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Differ by InformInfo.Vendor.VendorIdLSB\n"
argument_list|)
expr_stmt|;
else|else
name|status
operator|=
name|CL_SUCCESS
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|osm_infr_t
modifier|*
name|osm_infr_get_by_rec
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
name|osm_infr_t
modifier|*
specifier|const
name|p_infr_rec
parameter_list|)
block|{
name|cl_list_item_t
modifier|*
name|p_list_item
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
name|dump_all_informs
argument_list|(
name|p_subn
argument_list|,
name|p_log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Looking for Inform Record\n"
argument_list|)
expr_stmt|;
name|osm_dump_inform_info
argument_list|(
name|p_log
argument_list|,
operator|&
operator|(
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|)
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"InformInfo list size %d\n"
argument_list|,
name|cl_qlist_count
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
argument_list|)
expr_stmt|;
name|p_list_item
operator|=
name|cl_qlist_find_from_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|,
name|__match_inf_rec
argument_list|,
name|p_infr_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_list_item
operator|==
name|cl_qlist_end
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
condition|)
name|p_list_item
operator|=
name|NULL
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
operator|(
name|osm_infr_t
operator|*
operator|)
name|p_list_item
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osm_infr_insert_to_db
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
name|osm_infr_t
modifier|*
name|p_infr
parameter_list|)
block|{
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Inserting new InformInfo Record into Database\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Dump before insertion (size %d)\n"
argument_list|,
name|cl_qlist_count
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
argument_list|)
expr_stmt|;
name|dump_all_informs
argument_list|(
name|p_subn
argument_list|,
name|p_log
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|osm_dump_inform_info(p_log,&(p_infr->inform_record.inform_info), 			     OSM_LOG_DEBUG);
endif|#
directive|endif
name|cl_qlist_insert_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|,
operator|&
name|p_infr
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Dump after insertion (size %d)\n"
argument_list|,
name|cl_qlist_count
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
argument_list|)
expr_stmt|;
name|dump_all_informs
argument_list|(
name|p_subn
argument_list|,
name|p_log
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osm_infr_remove_from_db
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
name|osm_infr_t
modifier|*
name|p_infr
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Removing InformInfo Subscribing GID:%s"
literal|" Enum:0x%X from Database\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_infr
operator|->
name|inform_record
operator|.
name|subscriber_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|p_infr
operator|->
name|inform_record
operator|.
name|subscriber_enum
argument_list|)
expr_stmt|;
name|osm_dump_inform_info
argument_list|(
name|p_log
argument_list|,
operator|&
operator|(
name|p_infr
operator|->
name|inform_record
operator|.
name|inform_info
operator|)
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
expr_stmt|;
name|cl_qlist_remove_item
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|,
operator|&
name|p_infr
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|osm_infr_delete
argument_list|(
name|p_infr
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Send a report:  * Given a target address to send to and the notice.  * We need to send SubnAdmReport  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|__osm_send_report
parameter_list|(
name|IN
name|osm_infr_t
modifier|*
name|p_infr_rec
parameter_list|,
comment|/* the informinfo */
name|IN
name|ib_mad_notice_attr_t
modifier|*
name|p_ntc
comment|/* notice to send */
parameter_list|)
block|{
name|osm_madw_t
modifier|*
name|p_report_madw
decl_stmt|;
name|ib_mad_notice_attr_t
modifier|*
name|p_report_ntc
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|ib_sa_mad_t
modifier|*
name|p_sa_mad
decl_stmt|;
specifier|static
name|atomic32_t
name|trap_fwd_trans_id
init|=
literal|0x02DAB000
decl_stmt|;
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
init|=
name|p_infr_rec
operator|->
name|sa
operator|->
name|p_log
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
comment|/* HACK: who switches or uses the src and dest GIDs in the grh_info ?? */
comment|/* it is better to use LIDs since the GIDs might not be there for SMI traps */
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Forwarding Notice Event from LID:%u"
literal|" to InformInfo LID: %u TID:0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_ntc
operator|->
name|issuer_lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_infr_rec
operator|->
name|report_addr
operator|.
name|dest_lid
argument_list|)
argument_list|,
name|trap_fwd_trans_id
argument_list|)
expr_stmt|;
comment|/* get the MAD to send */
name|p_report_madw
operator|=
name|osm_mad_pool_get
argument_list|(
name|p_infr_rec
operator|->
name|sa
operator|->
name|p_mad_pool
argument_list|,
name|p_infr_rec
operator|->
name|h_bind
argument_list|,
name|MAD_BLOCK_SIZE
argument_list|,
operator|&
operator|(
name|p_infr_rec
operator|->
name|report_addr
operator|)
argument_list|)
expr_stmt|;
name|p_report_madw
operator|->
name|resp_expected
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|p_report_madw
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0203"
literal|"osm_mad_pool_get failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* advance trap trans id (cant simply ++ on some systems inside ntoh) */
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_report_madw
argument_list|)
expr_stmt|;
name|ib_mad_init_new
argument_list|(
name|p_mad
argument_list|,
name|IB_MCLASS_SUBN_ADM
argument_list|,
literal|2
argument_list|,
name|IB_MAD_METHOD_REPORT
argument_list|,
name|cl_hton64
argument_list|(
operator|(
name|uint64_t
operator|)
name|cl_atomic_inc
argument_list|(
operator|&
name|trap_fwd_trans_id
argument_list|)
argument_list|)
argument_list|,
name|IB_MAD_ATTR_NOTICE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|p_sa_mad
operator|=
name|osm_madw_get_sa_mad_ptr
argument_list|(
name|p_report_madw
argument_list|)
expr_stmt|;
name|p_report_ntc
operator|=
operator|(
name|ib_mad_notice_attr_t
operator|*
operator|)
operator|&
operator|(
name|p_sa_mad
operator|->
name|data
operator|)
expr_stmt|;
comment|/* copy the notice */
operator|*
name|p_report_ntc
operator|=
operator|*
name|p_ntc
expr_stmt|;
comment|/* The TRUE is for: response is expected */
name|osm_sa_send
argument_list|(
name|p_infr_rec
operator|->
name|sa
argument_list|,
name|p_report_madw
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * This routine compares a given Notice and a ListItem of InformInfo type.  * PREREQUISITE:  * The Notice.GID should be pre-filled with the trap generator GID  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|__match_notice_to_inf_rec
parameter_list|(
name|IN
name|cl_list_item_t
modifier|*
specifier|const
name|p_list_item
parameter_list|,
name|IN
name|void
modifier|*
name|context
parameter_list|)
block|{
name|osm_infr_match_ctxt_t
modifier|*
name|p_infr_match
init|=
operator|(
name|osm_infr_match_ctxt_t
operator|*
operator|)
name|context
decl_stmt|;
name|ib_mad_notice_attr_t
modifier|*
name|p_ntc
init|=
name|p_infr_match
operator|->
name|p_ntc
decl_stmt|;
name|cl_list_t
modifier|*
name|p_infr_to_remove_list
init|=
name|p_infr_match
operator|->
name|p_remove_infr_list
decl_stmt|;
name|osm_infr_t
modifier|*
name|p_infr_rec
init|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|p_list_item
decl_stmt|;
name|ib_inform_info_t
modifier|*
name|p_ii
init|=
operator|&
operator|(
name|p_infr_rec
operator|->
name|inform_record
operator|.
name|inform_info
operator|)
decl_stmt|;
name|cl_status_t
name|status
init|=
name|CL_NOT_FOUND
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
init|=
name|p_infr_rec
operator|->
name|sa
operator|->
name|p_log
decl_stmt|;
name|osm_subn_t
modifier|*
name|p_subn
init|=
name|p_infr_rec
operator|->
name|sa
operator|->
name|p_subn
decl_stmt|;
name|ib_gid_t
name|source_gid
decl_stmt|;
name|osm_port_t
modifier|*
name|p_src_port
decl_stmt|;
name|osm_port_t
modifier|*
name|p_dest_port
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
comment|/* matching rules 	 * InformInfo   Notice 	 * GID          IssuerGID    if non zero must match the trap 	 * LIDRange     IssuerLID    apply only if GID=0 	 * IsGeneric    IsGeneric    is compulsory and must match the trap 	 * Type         Type         if not 0xFFFF must match 	 * TrapNumber   TrapNumber   if not 0xFFFF must match 	 * DeviceId     DeviceID     if not 0xFFFF must match 	 * QPN dont care 	 * ProducerType ProducerType match or 0xFFFFFF // EZ: actually my interpretation 	 * VendorID     VendorID     match or 0xFFFFFF 	 */
comment|/* GID          IssuerGID    if non zero must match the trap  */
if|if
condition|(
name|p_ii
operator|->
name|gid
operator|.
name|unicast
operator|.
name|prefix
operator|!=
literal|0
operator|||
name|p_ii
operator|->
name|gid
operator|.
name|unicast
operator|.
name|interface_id
operator|!=
literal|0
condition|)
block|{
comment|/* match by GID */
if|if
condition|(
name|memcmp
argument_list|(
operator|&
operator|(
name|p_ii
operator|->
name|gid
operator|)
argument_list|,
operator|&
operator|(
name|p_ntc
operator|->
name|issuer_gid
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Mismatch by GID\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
else|else
block|{
comment|/* LIDRange     IssuerLID    apply only if GID=0 */
comment|/* If lid_range_begin of the informInfo is 0xFFFF - then it should be ignored. */
if|if
condition|(
name|p_ii
operator|->
name|lid_range_begin
operator|!=
literal|0xFFFF
condition|)
block|{
comment|/* a real lid range is given - check it */
if|if
condition|(
operator|(
name|cl_hton16
argument_list|(
name|p_ii
operator|->
name|lid_range_begin
argument_list|)
operator|>
name|cl_hton16
argument_list|(
name|p_ntc
operator|->
name|issuer_lid
argument_list|)
operator|)
operator|||
operator|(
name|cl_hton16
argument_list|(
name|p_ntc
operator|->
name|issuer_lid
argument_list|)
operator|>
name|cl_hton16
argument_list|(
name|p_ii
operator|->
name|lid_range_end
argument_list|)
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Mismatch by LID Range. Needed: %u<= %u<= %u\n"
argument_list|,
name|cl_hton16
argument_list|(
name|p_ii
operator|->
name|lid_range_begin
argument_list|)
argument_list|,
name|cl_hton16
argument_list|(
name|p_ntc
operator|->
name|issuer_lid
argument_list|)
argument_list|,
name|cl_hton16
argument_list|(
name|p_ii
operator|->
name|lid_range_end
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
block|}
comment|/* IsGeneric    IsGeneric    is compulsory and must match the trap  */
if|if
condition|(
operator|(
name|p_ii
operator|->
name|is_generic
operator|&&
operator|!
name|ib_notice_is_generic
argument_list|(
name|p_ntc
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|p_ii
operator|->
name|is_generic
operator|&&
name|ib_notice_is_generic
argument_list|(
name|p_ntc
argument_list|)
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Mismatch by Generic/Vendor\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Type         Type         if not 0xFFFF must match */
if|if
condition|(
operator|(
name|p_ii
operator|->
name|trap_type
operator|!=
literal|0xFFFF
operator|)
operator|&&
operator|(
name|cl_ntoh16
argument_list|(
name|p_ii
operator|->
name|trap_type
argument_list|)
operator|!=
name|ib_notice_get_type
argument_list|(
name|p_ntc
argument_list|)
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Mismatch by Type\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* based on generic type */
if|if
condition|(
name|p_ii
operator|->
name|is_generic
condition|)
block|{
comment|/* TrapNumber   TrapNumber   if not 0xFFFF must match */
if|if
condition|(
operator|(
name|p_ii
operator|->
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
operator|!=
literal|0xFFFF
operator|)
operator|&&
operator|(
name|p_ii
operator|->
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
operator|!=
name|p_ntc
operator|->
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Mismatch by Trap Num\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* ProducerType ProducerType match or 0xFFFFFF  */
if|if
condition|(
operator|(
name|cl_ntoh32
argument_list|(
name|ib_inform_info_get_prod_type
argument_list|(
name|p_ii
argument_list|)
argument_list|)
operator|!=
literal|0xFFFFFF
operator|)
operator|&&
operator|(
name|ib_inform_info_get_prod_type
argument_list|(
name|p_ii
argument_list|)
operator|!=
name|ib_notice_get_prod_type
argument_list|(
name|p_ntc
argument_list|)
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Mismatch by Node Type: II=0x%06X (%s) Trap=0x%06X (%s)\n"
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_inform_info_get_prod_type
argument_list|(
name|p_ii
argument_list|)
argument_list|)
argument_list|,
name|ib_get_producer_type_str
argument_list|(
name|ib_inform_info_get_prod_type
argument_list|(
name|p_ii
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_notice_get_prod_type
argument_list|(
name|p_ntc
argument_list|)
argument_list|)
argument_list|,
name|ib_get_producer_type_str
argument_list|(
name|ib_notice_get_prod_type
argument_list|(
name|p_ntc
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
else|else
block|{
comment|/* DeviceId     DeviceID     if not 0xFFFF must match */
if|if
condition|(
operator|(
name|p_ii
operator|->
name|g_or_v
operator|.
name|vend
operator|.
name|dev_id
operator|!=
literal|0xFFFF
operator|)
operator|&&
operator|(
name|p_ii
operator|->
name|g_or_v
operator|.
name|vend
operator|.
name|dev_id
operator|!=
name|p_ntc
operator|->
name|g_or_v
operator|.
name|vend
operator|.
name|dev_id
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Mismatch by Dev Id\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* VendorID     VendorID     match or 0xFFFFFF  */
if|if
condition|(
operator|(
name|ib_inform_info_get_vend_id
argument_list|(
name|p_ii
argument_list|)
operator|!=
name|CL_HTON32
argument_list|(
literal|0xFFFFFF
argument_list|)
operator|)
operator|&&
operator|(
name|ib_inform_info_get_vend_id
argument_list|(
name|p_ii
argument_list|)
operator|!=
name|ib_notice_get_vend_id
argument_list|(
name|p_ntc
argument_list|)
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Mismatch by Vendor ID\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
comment|/* Check if there is a pkey match. o13-17.1.1 */
comment|/* Check if the issuer of the trap is the SM. If it is, then the gid 	   comparison should be done on the trap source (saved as the gid in the 	   data details field). 	   If the issuer gid is not the SM - then it is the guid of the trap 	   source */
if|if
condition|(
operator|(
name|cl_ntoh64
argument_list|(
name|p_ntc
operator|->
name|issuer_gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
operator|==
name|p_subn
operator|->
name|opt
operator|.
name|subnet_prefix
operator|)
operator|&&
operator|(
name|cl_ntoh64
argument_list|(
name|p_ntc
operator|->
name|issuer_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
operator|==
name|p_subn
operator|->
name|sm_port_guid
operator|)
condition|)
comment|/* The issuer is the SM then this is trap 64-67 - compare the gid 		   with the gid saved on the data details */
name|source_gid
operator|=
name|p_ntc
operator|->
name|data_details
operator|.
name|ntc_64_67
operator|.
name|gid
expr_stmt|;
else|else
name|source_gid
operator|=
name|p_ntc
operator|->
name|issuer_gid
expr_stmt|;
name|p_src_port
operator|=
name|osm_get_port_by_guid
argument_list|(
name|p_subn
argument_list|,
name|source_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_src_port
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Cannot find source port with GUID:0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|source_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_dest_port
operator|=
name|cl_ptr_vector_get
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_infr_rec
operator|->
name|report_addr
operator|.
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_dest_port
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Cannot find destination port with LID:%u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_infr_rec
operator|->
name|report_addr
operator|.
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|osm_port_share_pkey
argument_list|(
name|p_log
argument_list|,
name|p_src_port
argument_list|,
name|p_dest_port
argument_list|)
operator|==
name|FALSE
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Mismatch by Pkey\n"
argument_list|)
expr_stmt|;
comment|/* According to o13-17.1.2 - If this informInfo does not have 		   lid_range_begin of 0xFFFF, then this informInfo request 		   should be removed from database */
if|if
condition|(
name|p_ii
operator|->
name|lid_range_begin
operator|!=
literal|0xFFFF
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Pkey mismatch on lid_range_begin != 0xFFFF. "
literal|"Need to remove this informInfo from db\n"
argument_list|)
expr_stmt|;
comment|/* add the informInfo record to the remove_infr list */
name|cl_list_insert_tail
argument_list|(
name|p_infr_to_remove_list
argument_list|,
name|p_infr_rec
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
comment|/* send the report to the address provided in the inform record */
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"MATCH! Sending Report...\n"
argument_list|)
expr_stmt|;
name|__osm_send_report
argument_list|(
name|p_infr_rec
argument_list|,
name|p_ntc
argument_list|)
expr_stmt|;
name|status
operator|=
name|CL_SUCCESS
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Once a Trap was received by osm_trap_rcv, or a Trap sourced by  * the SM was sent (Traps 64-67), this routine is called with a copy of  * the notice data.  * Given a notice attribute - compare and see if it matches the InformInfo  * element and if it does - call the Report(Notice) for the  * target QP registered by the address stored in the InformInfo element  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osm_report_notice
parameter_list|(
name|IN
name|osm_log_t
modifier|*
specifier|const
name|p_log
parameter_list|,
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|ib_mad_notice_attr_t
modifier|*
name|p_ntc
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|osm_infr_match_ctxt_t
name|context
decl_stmt|;
name|cl_list_t
name|infr_to_remove_list
decl_stmt|;
name|osm_infr_t
modifier|*
name|p_infr_rec
decl_stmt|;
name|osm_infr_t
modifier|*
name|p_next_infr_rec
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
comment|/* 	 * we must make sure we are ready for this... 	 * note that the trap receivers might be initialized before 	 * the osm_infr_init call is performed. 	 */
if|if
condition|(
name|p_subn
operator|->
name|sa_infr_list
operator|.
name|state
operator|!=
name|CL_INITIALIZED
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Ignoring Notice Reports since Inform List is not initialized yet!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|IB_ERROR
operator|)
return|;
block|}
comment|/* an official Event information log */
if|if
condition|(
name|ib_notice_is_generic
argument_list|(
name|p_ntc
argument_list|)
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Reporting Generic Notice type:%u num:%u (%s)"
literal|" from LID:%u GID:%s\n"
argument_list|,
name|ib_notice_get_type
argument_list|(
name|p_ntc
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_ntc
operator|->
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
argument_list|)
argument_list|,
name|ib_get_trap_str
argument_list|(
name|p_ntc
operator|->
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_ntc
operator|->
name|issuer_lid
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_ntc
operator|->
name|issuer_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Reporting Vendor Notice type:%u vend:%u dev:%u"
literal|" from LID:%u GID:%s\n"
argument_list|,
name|ib_notice_get_type
argument_list|(
name|p_ntc
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_notice_get_vend_id
argument_list|(
name|p_ntc
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_ntc
operator|->
name|g_or_v
operator|.
name|vend
operator|.
name|dev_id
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_ntc
operator|->
name|issuer_lid
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_ntc
operator|->
name|issuer_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create a list that will hold all the infr records that should 	   be removed due to violation. o13-17.1.2 */
name|cl_list_construct
argument_list|(
operator|&
name|infr_to_remove_list
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|infr_to_remove_list
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_remove_infr_list
operator|=
operator|&
name|infr_to_remove_list
expr_stmt|;
name|context
operator|.
name|p_ntc
operator|=
name|p_ntc
expr_stmt|;
comment|/* go over all inform info available at the subnet */
comment|/* try match to the given notice and send if match */
name|cl_qlist_apply_func
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|sa_infr_list
operator|)
argument_list|,
name|__match_notice_to_inf_rec
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
comment|/* If we inserted items into the infr_to_remove_list - we need to 	   remove them */
name|p_infr_rec
operator|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|cl_list_remove_head
argument_list|(
operator|&
name|infr_to_remove_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_infr_rec
operator|!=
name|NULL
condition|)
block|{
name|p_next_infr_rec
operator|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|cl_list_remove_head
argument_list|(
operator|&
name|infr_to_remove_list
argument_list|)
expr_stmt|;
name|osm_infr_remove_from_db
argument_list|(
name|p_subn
argument_list|,
name|p_log
argument_list|,
name|p_infr_rec
argument_list|)
expr_stmt|;
name|p_infr_rec
operator|=
name|p_next_infr_rec
expr_stmt|;
block|}
name|cl_list_destroy
argument_list|(
operator|&
name|infr_to_remove_list
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
operator|(
name|IB_SUCCESS
operator|)
return|;
block|}
end_function

end_unit


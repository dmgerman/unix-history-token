begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2005 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of multicast functions.  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_multicast.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_mcm_port.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_mtree.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_inform.h>
end_include

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osm_mgrp_delete
parameter_list|(
name|IN
name|osm_mgrp_t
modifier|*
specifier|const
name|p_mgrp
parameter_list|)
block|{
name|osm_mcm_port_t
modifier|*
name|p_mcm_port
decl_stmt|;
name|osm_mcm_port_t
modifier|*
name|p_next_mcm_port
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|p_mgrp
argument_list|)
expr_stmt|;
name|p_next_mcm_port
operator|=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_mcm_port
operator|!=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|)
condition|)
block|{
name|p_mcm_port
operator|=
name|p_next_mcm_port
expr_stmt|;
name|p_next_mcm_port
operator|=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_mcm_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_mcm_port_delete
argument_list|(
name|p_mcm_port
argument_list|)
expr_stmt|;
block|}
comment|/* destroy the mtree_node structure */
name|osm_mtree_destroy
argument_list|(
name|p_mgrp
operator|->
name|p_root
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_mgrp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|osm_mgrp_t
modifier|*
name|osm_mgrp_new
parameter_list|(
name|IN
specifier|const
name|ib_net16_t
name|mlid
parameter_list|)
block|{
name|osm_mgrp_t
modifier|*
name|p_mgrp
decl_stmt|;
name|p_mgrp
operator|=
operator|(
name|osm_mgrp_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p_mgrp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_mgrp
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|p_mgrp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_mgrp
argument_list|)
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|)
expr_stmt|;
name|p_mgrp
operator|->
name|mlid
operator|=
name|mlid
expr_stmt|;
name|p_mgrp
operator|->
name|last_change_id
operator|=
literal|0
expr_stmt|;
name|p_mgrp
operator|->
name|last_tree_id
operator|=
literal|0
expr_stmt|;
name|p_mgrp
operator|->
name|to_be_deleted
operator|=
name|FALSE
expr_stmt|;
return|return
name|p_mgrp
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|mgrp_send_notice
parameter_list|(
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|osm_log_t
modifier|*
name|log
parameter_list|,
name|osm_mgrp_t
modifier|*
name|mgrp
parameter_list|,
name|unsigned
name|num
parameter_list|)
block|{
name|ib_mad_notice_attr_t
name|notice
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|notice
operator|.
name|generic_type
operator|=
literal|0x83
expr_stmt|;
comment|/* generic SubnMgt type */
name|ib_notice_set_prod_type_ho
argument_list|(
operator|&
name|notice
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* A Class Manager generator */
name|notice
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
operator|=
name|CL_HTON16
argument_list|(
name|num
argument_list|)
expr_stmt|;
comment|/* The sm_base_lid is saved in network order already. */
name|notice
operator|.
name|issuer_lid
operator|=
name|subn
operator|->
name|sm_base_lid
expr_stmt|;
comment|/* following o14-12.1.11 and table 120 p726 */
comment|/* we need to provide the MGID */
name|memcpy
argument_list|(
operator|&
name|notice
operator|.
name|data_details
operator|.
name|ntc_64_67
operator|.
name|gid
argument_list|,
operator|&
name|mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* According to page 653 - the issuer gid in this case of trap 	   is the SM gid, since the SM is the initiator of this trap. */
name|notice
operator|.
name|issuer_gid
operator|.
name|unicast
operator|.
name|prefix
operator|=
name|subn
operator|->
name|opt
operator|.
name|subnet_prefix
expr_stmt|;
name|notice
operator|.
name|issuer_gid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|subn
operator|->
name|sm_port_guid
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|osm_report_notice
argument_list|(
name|log
argument_list|,
name|subn
argument_list|,
operator|&
name|notice
argument_list|)
operator|)
condition|)
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7601: "
literal|"Error sending trap reports (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|osm_mcm_port_t
modifier|*
name|osm_mgrp_add_port
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|osm_log_t
modifier|*
name|log
parameter_list|,
name|IN
name|osm_mgrp_t
modifier|*
specifier|const
name|p_mgrp
parameter_list|,
name|IN
specifier|const
name|ib_gid_t
modifier|*
specifier|const
name|p_port_gid
parameter_list|,
name|IN
specifier|const
name|uint8_t
name|join_state
parameter_list|,
name|IN
name|boolean_t
name|proxy_join
parameter_list|)
block|{
name|ib_net64_t
name|port_guid
decl_stmt|;
name|osm_mcm_port_t
modifier|*
name|p_mcm_port
decl_stmt|;
name|cl_map_item_t
modifier|*
name|prev_item
decl_stmt|;
name|uint8_t
name|prev_join_state
init|=
literal|0
decl_stmt|;
name|uint8_t
name|prev_scope
decl_stmt|;
name|p_mcm_port
operator|=
name|osm_mcm_port_new
argument_list|(
name|p_port_gid
argument_list|,
name|join_state
argument_list|,
name|proxy_join
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_mcm_port
condition|)
return|return
name|NULL
return|;
name|port_guid
operator|=
name|p_port_gid
operator|->
name|unicast
operator|.
name|interface_id
expr_stmt|;
comment|/* 	   prev_item = cl_qmap_insert(...) 	   Pointer to the item in the map with the specified key.  If insertion 	   was successful, this is the pointer to the item.  If an item with the 	   specified key already exists in the map, the pointer to that item is 	   returned. 	 */
name|prev_item
operator|=
name|cl_qmap_insert
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|,
name|port_guid
argument_list|,
operator|&
name|p_mcm_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
comment|/* if already exists - revert the insertion and only update join state */
if|if
condition|(
name|prev_item
operator|!=
operator|&
name|p_mcm_port
operator|->
name|map_item
condition|)
block|{
name|osm_mcm_port_delete
argument_list|(
name|p_mcm_port
argument_list|)
expr_stmt|;
name|p_mcm_port
operator|=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|prev_item
expr_stmt|;
comment|/* 		   o15.0.1.11 		   Join state of the end port should be the or of the 		   previous setting with the current one 		 */
name|ib_member_get_scope_state
argument_list|(
name|p_mcm_port
operator|->
name|scope_state
argument_list|,
operator|&
name|prev_scope
argument_list|,
operator|&
name|prev_join_state
argument_list|)
expr_stmt|;
name|p_mcm_port
operator|->
name|scope_state
operator|=
name|ib_member_set_scope_state
argument_list|(
name|prev_scope
argument_list|,
name|prev_join_state
operator||
name|join_state
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* track the fact we modified the group ports */
name|p_mgrp
operator|->
name|last_change_id
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|)
operator|&&
operator|!
operator|(
name|prev_join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|)
operator|&&
operator|(
operator|++
name|p_mgrp
operator|->
name|full_members
operator|==
literal|1
operator|)
condition|)
block|{
name|mgrp_send_notice
argument_list|(
name|subn
argument_list|,
name|log
argument_list|,
name|p_mgrp
argument_list|,
literal|66
argument_list|)
expr_stmt|;
name|p_mgrp
operator|->
name|to_be_deleted
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|p_mcm_port
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|int
name|osm_mgrp_remove_port
parameter_list|(
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|osm_log_t
modifier|*
name|log
parameter_list|,
name|osm_mgrp_t
modifier|*
name|mgrp
parameter_list|,
name|osm_mcm_port_t
modifier|*
name|mcm
parameter_list|,
name|uint8_t
name|join_state
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|uint8_t
name|port_join_state
decl_stmt|;
name|uint8_t
name|new_join_state
decl_stmt|;
comment|/* 	 * according to the same o15-0.1.14 we get the stored 	 * JoinState and the request JoinState and they must be 	 * opposite to leave - otherwise just update it 	 */
name|port_join_state
operator|=
name|mcm
operator|->
name|scope_state
operator|&
literal|0x0F
expr_stmt|;
name|new_join_state
operator|=
name|port_join_state
operator|&
operator|~
name|join_state
expr_stmt|;
if|if
condition|(
name|new_join_state
condition|)
block|{
name|mcm
operator|->
name|scope_state
operator|=
name|new_join_state
operator||
operator|(
name|mcm
operator|->
name|scope_state
operator|&
literal|0xf0
operator|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"updating port 0x%"
name|PRIx64
literal|" JoinState 0x%x -> 0x%x\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|mcm
operator|->
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|port_join_state
argument_list|,
name|new_join_state
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|cl_qmap_remove_item
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_port_tbl
argument_list|,
operator|&
name|mcm
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"removing port 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|mcm
operator|->
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
name|osm_mcm_port_delete
argument_list|(
name|mcm
argument_list|)
expr_stmt|;
comment|/* track the fact we modified the group */
name|mgrp
operator|->
name|last_change_id
operator|++
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
block|}
comment|/* no more full members so the group will be deleted after re-route 	   but only if it is not a well known group */
if|if
condition|(
operator|(
name|port_join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|)
operator|&&
operator|!
operator|(
name|new_join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|)
operator|&&
operator|(
operator|--
name|mgrp
operator|->
name|full_members
operator|==
literal|0
operator|)
condition|)
block|{
name|mgrp_send_notice
argument_list|(
name|subn
argument_list|,
name|log
argument_list|,
name|mgrp
argument_list|,
literal|67
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mgrp
operator|->
name|well_known
condition|)
name|mgrp
operator|->
name|to_be_deleted
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|osm_mgrp_delete_port
parameter_list|(
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|osm_log_t
modifier|*
name|log
parameter_list|,
name|osm_mgrp_t
modifier|*
name|mgrp
parameter_list|,
name|ib_net64_t
name|port_guid
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|item
init|=
name|cl_qmap_get
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_port_tbl
argument_list|,
name|port_guid
argument_list|)
decl_stmt|;
if|if
condition|(
name|item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_port_tbl
argument_list|)
condition|)
name|osm_mgrp_remove_port
argument_list|(
name|subn
argument_list|,
name|log
argument_list|,
name|mgrp
argument_list|,
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|item
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|boolean_t
name|osm_mgrp_is_port_present
parameter_list|(
name|IN
specifier|const
name|osm_mgrp_t
modifier|*
specifier|const
name|p_mgrp
parameter_list|,
name|IN
specifier|const
name|ib_net64_t
name|port_guid
parameter_list|,
name|OUT
name|osm_mcm_port_t
modifier|*
modifier|*
specifier|const
name|pp_mcm_port
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|p_map_item
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|p_mgrp
argument_list|)
expr_stmt|;
name|p_map_item
operator|=
name|cl_qmap_get
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|,
name|port_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_map_item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|)
condition|)
block|{
if|if
condition|(
name|pp_mcm_port
condition|)
operator|*
name|pp_mcm_port
operator|=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|p_map_item
expr_stmt|;
return|return
name|TRUE
return|;
block|}
if|if
condition|(
name|pp_mcm_port
condition|)
operator|*
name|pp_mcm_port
operator|=
name|NULL
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|__osm_mgrp_apply_func_sub
parameter_list|(
specifier|const
name|osm_mgrp_t
modifier|*
specifier|const
name|p_mgrp
parameter_list|,
specifier|const
name|osm_mtree_node_t
modifier|*
specifier|const
name|p_mtn
parameter_list|,
name|osm_mgrp_func_t
name|p_func
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|uint8_t
name|i
init|=
literal|0
decl_stmt|;
name|uint8_t
name|max_children
decl_stmt|;
name|osm_mtree_node_t
modifier|*
name|p_child_mtn
decl_stmt|;
comment|/* Call the user, then recurse. */
name|p_func
argument_list|(
name|p_mgrp
argument_list|,
name|p_mtn
argument_list|,
name|context
argument_list|)
expr_stmt|;
name|max_children
operator|=
name|osm_mtree_node_get_max_children
argument_list|(
name|p_mtn
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_children
condition|;
name|i
operator|++
control|)
block|{
name|p_child_mtn
operator|=
name|osm_mtree_node_get_child
argument_list|(
name|p_mtn
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_child_mtn
condition|)
name|__osm_mgrp_apply_func_sub
argument_list|(
name|p_mgrp
argument_list|,
name|p_child_mtn
argument_list|,
name|p_func
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osm_mgrp_apply_func
parameter_list|(
specifier|const
name|osm_mgrp_t
modifier|*
specifier|const
name|p_mgrp
parameter_list|,
name|osm_mgrp_func_t
name|p_func
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|osm_mtree_node_t
modifier|*
name|p_mtn
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|p_mgrp
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_func
argument_list|)
expr_stmt|;
name|p_mtn
operator|=
name|p_mgrp
operator|->
name|p_root
expr_stmt|;
if|if
condition|(
name|p_mtn
condition|)
name|__osm_mgrp_apply_func_sub
argument_list|(
name|p_mgrp
argument_list|,
name|p_mtn
argument_list|,
name|p_func
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


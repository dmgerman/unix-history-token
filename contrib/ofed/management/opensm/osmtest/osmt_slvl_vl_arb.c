begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006-2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2005 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of SLtoVL and VL Arbitration testing flow..  *    Top level is osmt_run_slvl_and_vlarb_records_flow:  *     osmt_query_all_ports_vl_arb  *     osmt_query_all_ports_slvl_map  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__WIN__
end_ifndef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|"osmtest.h"
end_include

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_vl_arb_table
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|,
name|IN
specifier|const
name|ib_vl_arb_table_record_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|int
name|result
decl_stmt|,
name|i
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"VL_ARBITRATION_TABLE\n"
literal|"lid                     0x%X\n"
literal|"port_num                0x%X\n"
literal|"block                   0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_rec
operator|->
name|block_num
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"       "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"| %-2u "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"|\nVL:    "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"|0x%02X"
argument_list|,
name|p_rec
operator|->
name|vl_arb_tbl
operator|.
name|vl_entry
index|[
name|i
index|]
operator|.
name|vl
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"|\nWEIGHT:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"|0x%02X"
argument_list|,
name|p_rec
operator|->
name|vl_arb_tbl
operator|.
name|vl_entry
index|[
name|i
index|]
operator|.
name|weight
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"|\nEND\n\n"
argument_list|)
expr_stmt|;
comment|/*  Exit: */
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * GET A SINGLE PORT INFO BY NODE LID AND PORT NUMBER  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_query_vl_arb
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|uint8_t
specifier|const
name|port_num
parameter_list|,
name|IN
name|uint8_t
specifier|const
name|block_num
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_vl_arb_table_record_t
name|record
decl_stmt|,
modifier|*
name|p_rec
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Getting VL_Arbitration Table for port with LID 0x%X Num:0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|record
operator|.
name|port_num
operator|=
name|port_num
expr_stmt|;
name|record
operator|.
name|block_num
operator|=
name|block_num
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_VLARB_BY_LID_PORT_BLOCK
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0405: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0466: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
comment|/* ok it worked */
name|p_rec
operator|=
name|osmv_get_query_result
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fh
condition|)
block|{
name|osmtest_write_vl_arb_table
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|osmt_query_all_ports_vl_arb
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|CL_SUCCESS
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|port_t
modifier|*
name|p_src_port
decl_stmt|;
name|uint8_t
name|block
decl_stmt|,
name|anyErr
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Obtaining ALL Ports VL Arbitration Tables\n"
argument_list|)
expr_stmt|;
comment|/* 	 * Go over all ports that exist in the subnet 	 * get the relevant VLarbs 	 */
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|port_key_tbl
expr_stmt|;
name|p_src_port
operator|=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_src_port
operator|!=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
comment|/* HACK we use capability_mask to know diff a CA port from switch port */
if|if
condition|(
name|p_src_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|capability_mask
condition|)
block|{
comment|/* this is an hca port */
for|for
control|(
name|block
operator|=
literal|1
init|;
name|block
operator|<=
literal|4
condition|;
name|block
operator|++
control|)
block|{
comment|/*  NOTE to comply we must set port number to 0 and the SA should figure it out */
comment|/*  since it is a CA port */
name|status
operator|=
name|osmt_query_vl_arb
argument_list|(
name|p_osmt
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|,
literal|0
argument_list|,
name|block
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0467: "
literal|"Failed to get Lid:0x%X Port:0x%X (%s)\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|)
argument_list|,
literal|0
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|anyErr
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* this is a switch port */
for|for
control|(
name|block
operator|=
literal|1
init|;
name|block
operator|<=
literal|4
condition|;
name|block
operator|++
control|)
block|{
name|status
operator|=
name|osmt_query_vl_arb
argument_list|(
name|p_osmt
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|port_num
argument_list|,
name|block
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0468: "
literal|"Failed to get Lid:0x%X Port:0x%X (%s)\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|)
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|port_num
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|anyErr
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
name|p_src_port
operator|=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_src_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|anyErr
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************  SLtoVL *******************************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_slvl_map_table
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|,
name|IN
specifier|const
name|ib_slvl_table_record_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|int
name|result
decl_stmt|,
name|i
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"SLtoVL_MAP_TABLE\n"
literal|"lid                     0x%X\n"
literal|"in_port_num             0x%X\n"
literal|"out_port_num            0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|in_port_num
argument_list|,
name|p_rec
operator|->
name|out_port_num
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"SL:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"| %-2u  "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"|\nVL:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"| 0x%01X "
argument_list|,
name|ib_slvl_table_get
argument_list|(
operator|&
name|p_rec
operator|->
name|slvl_tbl
argument_list|,
operator|(
name|uint8_t
operator|)
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"|\nEND\n\n"
argument_list|)
expr_stmt|;
comment|/*  Exit: */
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * GET A SINGLE PORT INFO BY NODE LID AND PORT NUMBER  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_query_slvl_map
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|uint8_t
specifier|const
name|out_port_num
parameter_list|,
name|IN
name|uint8_t
specifier|const
name|in_port_num
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_slvl_table_record_t
name|record
decl_stmt|,
modifier|*
name|p_rec
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Getting SLtoVL Map Table for out-port with LID 0x%X Num:0x%X from In-Port:0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|,
name|out_port_num
argument_list|,
name|in_port_num
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|record
operator|.
name|in_port_num
operator|=
name|in_port_num
expr_stmt|;
name|record
operator|.
name|out_port_num
operator|=
name|out_port_num
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_SLVL_BY_LID_AND_PORTS
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0469: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0470: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
comment|/* ok it worked */
name|p_rec
operator|=
name|osmv_get_query_result
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fh
condition|)
block|{
name|osmtest_write_slvl_map_table
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|osmt_query_all_ports_slvl_map
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|CL_SUCCESS
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|port_t
modifier|*
name|p_src_port
decl_stmt|;
name|uint8_t
name|in_port
decl_stmt|,
name|anyErr
init|=
literal|0
decl_stmt|,
name|num_ports
decl_stmt|;
name|node_t
modifier|*
name|p_node
decl_stmt|;
specifier|const
name|cl_qmap_t
modifier|*
name|p_node_tbl
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Go over all ports that exist in the subnet 	 * get the relevant SLtoVLs 	 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Obtaining ALL Ports (to other ports) SLtoVL Maps\n"
argument_list|)
expr_stmt|;
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|port_key_tbl
expr_stmt|;
name|p_node_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
expr_stmt|;
name|p_src_port
operator|=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_src_port
operator|!=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
comment|/* HACK we use capability_mask to know diff a CA port from switch port */
if|if
condition|(
name|p_src_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|capability_mask
condition|)
block|{
comment|/* this is an hca port */
comment|/*  NOTE to comply we must set port number to 0 and the SA should figure it out */
comment|/*  since it is a CA port */
name|status
operator|=
name|osmt_query_slvl_map
argument_list|(
name|p_osmt
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0471: "
literal|"Failed to get Lid:0x%X In-Port:0x%X Out-Port:0x%X(%s)\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|anyErr
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* this is a switch port */
comment|/* get the node */
name|p_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
name|p_node_tbl
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_node
operator|==
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_node_tbl
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0472: "
literal|"Failed to get Node by Lid:0x%X\n"
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|num_ports
operator|=
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|num_ports
expr_stmt|;
for|for
control|(
name|in_port
operator|=
literal|1
init|;
name|in_port
operator|<=
name|num_ports
condition|;
name|in_port
operator|++
control|)
block|{
name|status
operator|=
name|osmt_query_slvl_map
argument_list|(
name|p_osmt
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|port_num
argument_list|,
name|in_port
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0473: "
literal|"Failed to get Lid:0x%X In-Port:0x%X Out-Port:0x%X (%s)\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_src_port
operator|->
name|rec
operator|.
name|lid
argument_list|)
argument_list|,
name|p_src_port
operator|->
name|rec
operator|.
name|port_num
argument_list|,
name|in_port
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|anyErr
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
name|p_src_port
operator|=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_src_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|anyErr
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Run a vl arbitration queries and sl2vl maps queries flow:  * Good flow:  * - for each physical port on the network - obtain the VL Arb  * - for each CA physical port obtain its SLtoVL Map  * - for each SW physical port (out) obtain the SLtoVL Map to each other port  * BAD flow:  * - Try get with multiple results  * - Try gettable  * - Try providing non existing port  */
end_comment

begin_function
name|ib_api_status_t
name|osmt_run_slvl_and_vlarb_records_flow
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
name|FILE
modifier|*
name|fh
decl_stmt|;
name|ib_net16_t
name|test_lid
decl_stmt|;
name|uint8_t
name|lmc
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|fh
operator|=
name|fopen
argument_list|(
literal|"qos.txt"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
comment|/* go over all ports in the subnet */
name|status
operator|=
name|osmt_query_all_ports_vl_arb
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmt_query_all_ports_slvl_map
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
goto|goto
name|Exit
goto|;
block|}
comment|/* If LMC> 0, test non base LID SA QoS Record requests */
name|status
operator|=
name|osmtest_get_local_port_lmc
argument_list|(
name|p_osmt
argument_list|,
name|p_osmt
operator|->
name|local_port
operator|.
name|lid
argument_list|,
operator|&
name|lmc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|lmc
operator|!=
literal|0
condition|)
block|{
name|test_lid
operator|=
name|cl_ntoh16
argument_list|(
name|p_osmt
operator|->
name|local_port
operator|.
name|lid
operator|+
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_query_vl_arb
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|status
operator|=
name|osmt_query_slvl_map
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|fclose
argument_list|(
name|fh
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

end_unit


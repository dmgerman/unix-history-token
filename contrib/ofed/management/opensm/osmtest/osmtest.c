begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006-2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2005 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/* TODO : Check why we dont free the cl_qmap_items we store when reading DB */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of osmtest_t.  *    This object represents the OSMTest Test object.  *  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__WIN__
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|warning
name|(
name|disable
name|:
name|4996
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__WIN__
end_ifdef

begin_include
include|#
directive|include
file|<complib/cl_timer.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|"osmtest.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|__WIN__
end_ifndef

begin_define
define|#
directive|define
name|strnicmp
value|strncasecmp
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|POOL_MIN_ITEMS
value|64
end_define

begin_define
define|#
directive|define
name|GUID_ARRAY_SIZE
value|64
end_define

begin_typedef
typedef|typedef
struct|struct
name|_osmtest_sm_info_rec
block|{
name|ib_net64_t
name|sm_guid
decl_stmt|;
name|ib_net16_t
name|lid
decl_stmt|;
name|uint8_t
name|priority
decl_stmt|;
name|uint8_t
name|sm_state
decl_stmt|;
block|}
name|osmtest_sm_info_rec_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_osmtest_inform_info
block|{
name|boolean_t
name|subscribe
decl_stmt|;
name|ib_net32_t
name|qpn
decl_stmt|;
name|ib_net16_t
name|trap
decl_stmt|;
block|}
name|osmtest_inform_info_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_osmtest_inform_info_rec
block|{
name|ib_gid_t
name|subscriber_gid
decl_stmt|;
name|ib_net16_t
name|subscriber_enum
decl_stmt|;
block|}
name|osmtest_inform_info_rec_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|_osmtest_token_val
block|{
name|OSMTEST_TOKEN_COMMENT
init|=
literal|0
block|,
name|OSMTEST_TOKEN_END
block|,
name|OSMTEST_TOKEN_DEFINE_NODE
block|,
name|OSMTEST_TOKEN_DEFINE_PORT
block|,
name|OSMTEST_TOKEN_DEFINE_PATH
block|,
name|OSMTEST_TOKEN_DEFINE_LINK
block|,
name|OSMTEST_TOKEN_LID
block|,
name|OSMTEST_TOKEN_BASE_VERSION
block|,
name|OSMTEST_TOKEN_CLASS_VERSION
block|,
name|OSMTEST_TOKEN_NODE_TYPE
block|,
name|OSMTEST_TOKEN_NUM_PORTS
block|,
name|OSMTEST_TOKEN_SYS_GUID
block|,
name|OSMTEST_TOKEN_NODE_GUID
block|,
name|OSMTEST_TOKEN_PORT_GUID
block|,
name|OSMTEST_TOKEN_PARTITION_CAP
block|,
name|OSMTEST_TOKEN_DEVICE_ID
block|,
name|OSMTEST_TOKEN_REVISION
block|,
name|OSMTEST_TOKEN_PORT_NUM
block|,
name|OSMTEST_TOKEN_VENDOR_ID
block|,
name|OSMTEST_TOKEN_DGID
block|,
name|OSMTEST_TOKEN_SGID
block|,
name|OSMTEST_TOKEN_DLID
block|,
name|OSMTEST_TOKEN_SLID
block|,
name|OSMTEST_TOKEN_HOP_FLOW_RAW
block|,
name|OSMTEST_TOKEN_TCLASS
block|,
name|OSMTEST_TOKEN_NUM_PATH
block|,
name|OSMTEST_TOKEN_PKEY
block|,
name|OSMTEST_TOKEN_SL
block|,
name|OSMTEST_TOKEN_RATE
block|,
name|OSMTEST_TOKEN_PKT_LIFE
block|,
name|OSMTEST_TOKEN_PREFERENCE
block|,
name|OSMTEST_TOKEN_MKEY
block|,
name|OSMTEST_TOKEN_SUBN_PREF
block|,
name|OSMTEST_TOKEN_BASE_LID
block|,
name|OSMTEST_TOKEN_SM_BASE_LID
block|,
name|OSMTEST_TOKEN_CAP_MASK
block|,
name|OSMTEST_TOKEN_DIAG_CODE
block|,
name|OSMTEST_TOKEN_MKEY_LEASE_PER
block|,
name|OSMTEST_TOKEN_LOC_PORT_NUM
block|,
name|OSMTEST_TOKEN_LINK_WID_EN
block|,
name|OSMTEST_TOKEN_LINK_WID_SUP
block|,
name|OSMTEST_TOKEN_LINK_WID_ACT
block|,
name|OSMTEST_TOKEN_LINK_SPEED_SUP
block|,
name|OSMTEST_TOKEN_PORT_STATE
block|,
name|OSMTEST_TOKEN_STATE_INFO2
block|,
name|OSMTEST_TOKEN_MKEY_PROT_BITS
block|,
name|OSMTEST_TOKEN_LMC
block|,
name|OSMTEST_TOKEN_LINK_SPEED
block|,
name|OSMTEST_TOKEN_MTU_SMSL
block|,
name|OSMTEST_TOKEN_VL_CAP
block|,
name|OSMTEST_TOKEN_VL_HIGH_LIMIT
block|,
name|OSMTEST_TOKEN_VL_ARB_HIGH_CAP
block|,
name|OSMTEST_TOKEN_VL_ARB_LOW_CAP
block|,
name|OSMTEST_TOKEN_MTU_CAP
block|,
name|OSMTEST_TOKEN_VL_STALL_LIFE
block|,
name|OSMTEST_TOKEN_VL_ENFORCE
block|,
name|OSMTEST_TOKEN_MKEY_VIOL
block|,
name|OSMTEST_TOKEN_PKEY_VIOL
block|,
name|OSMTEST_TOKEN_QKEY_VIOL
block|,
name|OSMTEST_TOKEN_GUID_CAP
block|,
name|OSMTEST_TOKEN_SUBN_TIMEOUT
block|,
name|OSMTEST_TOKEN_RESP_TIME_VAL
block|,
name|OSMTEST_TOKEN_ERR_THRESHOLD
block|,
name|OSMTEST_TOKEN_MTU
block|,
name|OSMTEST_TOKEN_FROMLID
block|,
name|OSMTEST_TOKEN_FROMPORTNUM
block|,
name|OSMTEST_TOKEN_TOPORTNUM
block|,
name|OSMTEST_TOKEN_TOLID
block|,
name|OSMTEST_TOKEN_UNKNOWN
block|}
name|osmtest_token_val_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_osmtest_token
block|{
name|osmtest_token_val_t
name|val
decl_stmt|;
name|size_t
name|str_size
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
block|}
name|osmtest_token_t
typedef|;
end_typedef

begin_decl_stmt
specifier|const
name|osmtest_token_t
name|token_array
index|[]
init|=
block|{
block|{
name|OSMTEST_TOKEN_COMMENT
block|,
literal|1
block|,
literal|"#"
block|}
block|,
block|{
name|OSMTEST_TOKEN_END
block|,
literal|3
block|,
literal|"END"
block|}
block|,
block|{
name|OSMTEST_TOKEN_DEFINE_NODE
block|,
literal|11
block|,
literal|"DEFINE_NODE"
block|}
block|,
block|{
name|OSMTEST_TOKEN_DEFINE_PORT
block|,
literal|11
block|,
literal|"DEFINE_PORT"
block|}
block|,
block|{
name|OSMTEST_TOKEN_DEFINE_PATH
block|,
literal|11
block|,
literal|"DEFINE_PATH"
block|}
block|,
block|{
name|OSMTEST_TOKEN_DEFINE_LINK
block|,
literal|11
block|,
literal|"DEFINE_LINK"
block|}
block|,
block|{
name|OSMTEST_TOKEN_LID
block|,
literal|3
block|,
literal|"LID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_BASE_VERSION
block|,
literal|12
block|,
literal|"BASE_VERSION"
block|}
block|,
block|{
name|OSMTEST_TOKEN_CLASS_VERSION
block|,
literal|13
block|,
literal|"CLASS_VERSION"
block|}
block|,
block|{
name|OSMTEST_TOKEN_NODE_TYPE
block|,
literal|9
block|,
literal|"NODE_TYPE"
block|}
block|,
block|{
name|OSMTEST_TOKEN_NUM_PORTS
block|,
literal|9
block|,
literal|"NUM_PORTS"
block|}
block|,
block|{
name|OSMTEST_TOKEN_SYS_GUID
block|,
literal|8
block|,
literal|"SYS_GUID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_NODE_GUID
block|,
literal|9
block|,
literal|"NODE_GUID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_PORT_GUID
block|,
literal|9
block|,
literal|"PORT_GUID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_PARTITION_CAP
block|,
literal|13
block|,
literal|"PARTITION_CAP"
block|}
block|,
block|{
name|OSMTEST_TOKEN_DEVICE_ID
block|,
literal|9
block|,
literal|"DEVICE_ID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_REVISION
block|,
literal|8
block|,
literal|"REVISION"
block|}
block|,
block|{
name|OSMTEST_TOKEN_PORT_NUM
block|,
literal|8
block|,
literal|"PORT_NUM"
block|}
block|,
block|{
name|OSMTEST_TOKEN_VENDOR_ID
block|,
literal|9
block|,
literal|"VENDOR_ID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_DGID
block|,
literal|4
block|,
literal|"DGID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_SGID
block|,
literal|4
block|,
literal|"SGID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_DLID
block|,
literal|4
block|,
literal|"DLID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_SLID
block|,
literal|4
block|,
literal|"SLID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_HOP_FLOW_RAW
block|,
literal|12
block|,
literal|"HOP_FLOW_RAW"
block|}
block|,
block|{
name|OSMTEST_TOKEN_TCLASS
block|,
literal|6
block|,
literal|"TCLASS"
block|}
block|,
block|{
name|OSMTEST_TOKEN_NUM_PATH
block|,
literal|8
block|,
literal|"NUM_PATH"
block|}
block|,
block|{
name|OSMTEST_TOKEN_PKEY
block|,
literal|4
block|,
literal|"PKEY"
block|}
block|,
block|{
name|OSMTEST_TOKEN_SL
block|,
literal|2
block|,
literal|"SL"
block|}
block|,
block|{
name|OSMTEST_TOKEN_RATE
block|,
literal|4
block|,
literal|"RATE"
block|}
block|,
block|{
name|OSMTEST_TOKEN_PKT_LIFE
block|,
literal|8
block|,
literal|"PKT_LIFE"
block|}
block|,
block|{
name|OSMTEST_TOKEN_PREFERENCE
block|,
literal|10
block|,
literal|"PREFERENCE"
block|}
block|,
block|{
name|OSMTEST_TOKEN_MKEY
block|,
literal|4
block|,
literal|"M_KEY"
block|}
block|,
block|{
name|OSMTEST_TOKEN_SUBN_PREF
block|,
literal|13
block|,
literal|"SUBNET_PREFIX"
block|}
block|,
block|{
name|OSMTEST_TOKEN_BASE_LID
block|,
literal|8
block|,
literal|"BASE_LID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_SM_BASE_LID
block|,
literal|18
block|,
literal|"MASTER_SM_BASE_LID"
block|}
block|,
block|{
name|OSMTEST_TOKEN_CAP_MASK
block|,
literal|15
block|,
literal|"CAPABILITY_MASK"
block|}
block|,
block|{
name|OSMTEST_TOKEN_DIAG_CODE
block|,
literal|9
block|,
literal|"DIAG_CODE"
block|}
block|,
block|{
name|OSMTEST_TOKEN_MKEY_LEASE_PER
block|,
literal|18
block|,
literal|"m_key_lease_period"
block|}
block|,
block|{
name|OSMTEST_TOKEN_LOC_PORT_NUM
block|,
literal|14
block|,
literal|"local_port_num"
block|}
block|,
block|{
name|OSMTEST_TOKEN_LINK_WID_EN
block|,
literal|18
block|,
literal|"link_width_enabled"
block|}
block|,
block|{
name|OSMTEST_TOKEN_LINK_WID_SUP
block|,
literal|20
block|,
literal|"link_width_supported"
block|}
block|,
block|{
name|OSMTEST_TOKEN_LINK_WID_ACT
block|,
literal|17
block|,
literal|"link_width_active"
block|}
block|,
block|{
name|OSMTEST_TOKEN_LINK_SPEED_SUP
block|,
literal|20
block|,
literal|"link_speed_supported"
block|}
block|,
block|{
name|OSMTEST_TOKEN_PORT_STATE
block|,
literal|10
block|,
literal|"port_state"
block|}
block|,
block|{
name|OSMTEST_TOKEN_STATE_INFO2
block|,
literal|10
block|,
literal|"state_info2"
block|}
block|,
block|{
name|OSMTEST_TOKEN_MKEY_PROT_BITS
block|,
literal|3
block|,
literal|"mpb"
block|}
block|,
block|{
name|OSMTEST_TOKEN_LMC
block|,
literal|3
block|,
literal|"lmc"
block|}
block|,
block|{
name|OSMTEST_TOKEN_LINK_SPEED
block|,
literal|10
block|,
literal|"link_speed"
block|}
block|,
block|{
name|OSMTEST_TOKEN_MTU_SMSL
block|,
literal|8
block|,
literal|"mtu_smsl"
block|}
block|,
block|{
name|OSMTEST_TOKEN_VL_CAP
block|,
literal|6
block|,
literal|"vl_cap"
block|}
block|,
block|{
name|OSMTEST_TOKEN_VL_HIGH_LIMIT
block|,
literal|13
block|,
literal|"vl_high_limit"
block|}
block|,
block|{
name|OSMTEST_TOKEN_VL_ARB_HIGH_CAP
block|,
literal|15
block|,
literal|"vl_arb_high_cap"
block|}
block|,
block|{
name|OSMTEST_TOKEN_VL_ARB_LOW_CAP
block|,
literal|14
block|,
literal|"vl_arb_low_cap"
block|}
block|,
block|{
name|OSMTEST_TOKEN_MTU_CAP
block|,
literal|7
block|,
literal|"mtu_cap"
block|}
block|,
block|{
name|OSMTEST_TOKEN_VL_STALL_LIFE
block|,
literal|13
block|,
literal|"vl_stall_life"
block|}
block|,
block|{
name|OSMTEST_TOKEN_VL_ENFORCE
block|,
literal|10
block|,
literal|"vl_enforce"
block|}
block|,
block|{
name|OSMTEST_TOKEN_MKEY_VIOL
block|,
literal|16
block|,
literal|"m_key_violations"
block|}
block|,
block|{
name|OSMTEST_TOKEN_PKEY_VIOL
block|,
literal|16
block|,
literal|"p_key_violations"
block|}
block|,
block|{
name|OSMTEST_TOKEN_QKEY_VIOL
block|,
literal|16
block|,
literal|"q_key_violations"
block|}
block|,
block|{
name|OSMTEST_TOKEN_GUID_CAP
block|,
literal|8
block|,
literal|"guid_cap"
block|}
block|,
block|{
name|OSMTEST_TOKEN_SUBN_TIMEOUT
block|,
literal|14
block|,
literal|"subnet_timeout"
block|}
block|,
block|{
name|OSMTEST_TOKEN_RESP_TIME_VAL
block|,
literal|15
block|,
literal|"resp_time_value"
block|}
block|,
block|{
name|OSMTEST_TOKEN_ERR_THRESHOLD
block|,
literal|15
block|,
literal|"error_threshold"
block|}
block|,
block|{
name|OSMTEST_TOKEN_MTU
block|,
literal|3
block|,
literal|"MTU"
block|}
block|,
comment|/*  must be after the other mtu... tokens. */
block|{
name|OSMTEST_TOKEN_FROMLID
block|,
literal|8
block|,
literal|"from_lid"
block|}
block|,
block|{
name|OSMTEST_TOKEN_FROMPORTNUM
block|,
literal|13
block|,
literal|"from_port_num"
block|}
block|,
block|{
name|OSMTEST_TOKEN_TOPORTNUM
block|,
literal|11
block|,
literal|"to_port_num"
block|}
block|,
block|{
name|OSMTEST_TOKEN_TOLID
block|,
literal|6
block|,
literal|"to_lid"
block|}
block|,
block|{
name|OSMTEST_TOKEN_UNKNOWN
block|,
literal|0
block|,
literal|""
block|}
comment|/* must be last entry */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|IB_MAD_STATUS_CLASS_MASK
value|(CL_HTON16(0xFF00))
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_busy
index|[]
init|=
literal|"IB_MAD_STATUS_BUSY"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_redirect
index|[]
init|=
literal|"IB_MAD_STATUS_REDIRECT"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_unsup_class_ver
index|[]
init|=
literal|"IB_MAD_STATUS_UNSUP_CLASS_VER"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_unsup_method
index|[]
init|=
literal|"IB_MAD_STATUS_UNSUP_METHOD"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_unsup_method_attr
index|[]
init|=
literal|"IB_MAD_STATUS_UNSUP_METHOD_ATTR"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_invalid_field
index|[]
init|=
literal|"IB_MAD_STATUS_INVALID_FIELD"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_no_resources
index|[]
init|=
literal|"IB_SA_MAD_STATUS_NO_RESOURCES"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_req_invalid
index|[]
init|=
literal|"IB_SA_MAD_STATUS_REQ_INVALID"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_no_records
index|[]
init|=
literal|"IB_SA_MAD_STATUS_NO_RECORDS"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_too_many_records
index|[]
init|=
literal|"IB_SA_MAD_STATUS_TOO_MANY_RECORDS"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_invalid_gid
index|[]
init|=
literal|"IB_SA_MAD_STATUS_INVALID_GID"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ib_mad_status_str_insuf_comps
index|[]
init|=
literal|"IB_SA_MAD_STATUS_INSUF_COMPS"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|generic_or_str
index|[]
init|=
literal|" | "
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|const
name|char
modifier|*
name|ib_get_mad_status_str
parameter_list|(
name|IN
specifier|const
name|ib_mad_t
modifier|*
specifier|const
name|p_mad
parameter_list|)
block|{
specifier|static
name|char
name|line
index|[
literal|512
index|]
decl_stmt|;
name|uint32_t
name|offset
init|=
literal|0
decl_stmt|;
name|ib_net16_t
name|status
decl_stmt|;
name|boolean_t
name|first
init|=
name|TRUE
decl_stmt|;
name|line
index|[
name|offset
index|]
operator|=
literal|'\0'
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
literal|"IB_SUCCESS"
argument_list|)
expr_stmt|;
return|return
operator|(
name|line
operator|)
return|;
block|}
if|if
condition|(
name|status
operator|&
name|IB_MAD_STATUS_BUSY
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_busy
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_busy
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|IB_MAD_STATUS_REDIRECT
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_redirect
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_redirect
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_INVALID_FIELD
operator|)
operator|==
name|IB_MAD_STATUS_UNSUP_CLASS_VER
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_unsup_class_ver
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_unsup_class_ver
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_INVALID_FIELD
operator|)
operator|==
name|IB_MAD_STATUS_UNSUP_METHOD
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_unsup_method
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_unsup_method
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_INVALID_FIELD
operator|)
operator|==
name|IB_MAD_STATUS_UNSUP_METHOD_ATTR
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_unsup_method_attr
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_unsup_method_attr
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_INVALID_FIELD
operator|)
operator|==
name|IB_MAD_STATUS_INVALID_FIELD
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_invalid_field
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_invalid_field
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_CLASS_MASK
operator|)
operator|==
name|IB_SA_MAD_STATUS_NO_RESOURCES
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_no_resources
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_no_resources
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_CLASS_MASK
operator|)
operator|==
name|IB_SA_MAD_STATUS_REQ_INVALID
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_req_invalid
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_req_invalid
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_CLASS_MASK
operator|)
operator|==
name|IB_SA_MAD_STATUS_NO_RECORDS
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_no_records
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_no_records
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_CLASS_MASK
operator|)
operator|==
name|IB_SA_MAD_STATUS_TOO_MANY_RECORDS
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_too_many_records
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_too_many_records
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_CLASS_MASK
operator|)
operator|==
name|IB_SA_MAD_STATUS_INVALID_GID
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_invalid_gid
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_invalid_gid
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|IB_MAD_STATUS_CLASS_MASK
operator|)
operator|==
name|IB_SA_MAD_STATUS_INSUF_COMPS
condition|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|generic_or_str
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|generic_or_str
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|first
operator|=
name|FALSE
expr_stmt|;
name|strcat
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|ib_mad_status_str_insuf_comps
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ib_mad_status_str_insuf_comps
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|line
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|subnet_construct
parameter_list|(
name|IN
name|subnet_t
modifier|*
specifier|const
name|p_subn
parameter_list|)
block|{
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|link_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|node_lid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|node_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|mgrp_mlid_tbl
argument_list|)
expr_stmt|;
comment|/* NO WAY TO HAVE UNIQUE PORT BY LID OR GUID */
comment|/* cl_qmap_init(&p_subn->port_lid_tbl ); */
comment|/* cl_qmap_init(&p_subn->port_guid_tbl ); */
comment|/* port key is a lid and num pair */
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|port_key_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|path_tbl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|cl_status_t
name|subnet_init
parameter_list|(
name|IN
name|subnet_t
modifier|*
specifier|const
name|p_subn
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|subnet_construct
argument_list|(
name|p_subn
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osmtest_construct
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|memset
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_osmt
argument_list|)
argument_list|)
expr_stmt|;
name|osm_log_construct
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|subnet_construct
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osmtest_destroy
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|p_item
decl_stmt|,
modifier|*
name|p_next_item
decl_stmt|;
comment|/* Currently there is a problem with IBAL exit flow - memory overrun, 	   so bypass vendor deletion - it will be cleaned by the Windows OS */
ifndef|#
directive|ifndef
name|__WIN__
if|if
condition|(
name|p_osmt
operator|->
name|p_vendor
condition|)
name|osm_vendor_delete
argument_list|(
operator|&
name|p_osmt
operator|->
name|p_vendor
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cl_qpool_destroy
argument_list|(
operator|&
name|p_osmt
operator|->
name|port_pool
argument_list|)
expr_stmt|;
name|cl_qpool_destroy
argument_list|(
operator|&
name|p_osmt
operator|->
name|node_pool
argument_list|)
expr_stmt|;
comment|/* destroy the qmap tables */
name|p_next_item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|link_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|link_tbl
argument_list|)
condition|)
block|{
name|p_item
operator|=
name|p_next_item
expr_stmt|;
name|p_next_item
operator|=
name|cl_qmap_next
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
block|}
name|p_next_item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|)
condition|)
block|{
name|p_item
operator|=
name|p_next_item
expr_stmt|;
name|p_next_item
operator|=
name|cl_qmap_next
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
block|}
name|p_next_item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_guid_tbl
argument_list|)
condition|)
block|{
name|p_item
operator|=
name|p_next_item
expr_stmt|;
name|p_next_item
operator|=
name|cl_qmap_next
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
block|}
name|p_next_item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
argument_list|)
condition|)
block|{
name|p_item
operator|=
name|p_next_item
expr_stmt|;
name|p_next_item
operator|=
name|cl_qmap_next
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
block|}
name|p_next_item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|path_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|path_tbl
argument_list|)
condition|)
block|{
name|p_item
operator|=
name|p_next_item
expr_stmt|;
name|p_next_item
operator|=
name|cl_qmap_next
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
block|}
name|p_next_item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|port_key_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|port_key_tbl
argument_list|)
condition|)
block|{
name|p_item
operator|=
name|p_next_item
expr_stmt|;
name|p_next_item
operator|=
name|cl_qmap_next
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
block|}
name|osm_log_destroy
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_init
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
specifier|const
name|osmtest_opt_t
modifier|*
specifier|const
name|p_opt
parameter_list|,
name|IN
specifier|const
name|osm_log_level_t
name|log_flags
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
comment|/* Can't use log macros here, since we're initializing the log. */
name|osmtest_construct
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
name|status
operator|=
name|osm_log_init_v2
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_opt
operator|->
name|force_log_flush
argument_list|,
literal|0x0001
argument_list|,
name|p_opt
operator|->
name|log_file
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
return|return
operator|(
name|status
operator|)
return|;
comment|/* but we do not want any extra stuff here */
name|osm_log_set_level
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|log_flags
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_FUNCS
argument_list|,
literal|"[\n"
argument_list|)
expr_stmt|;
name|p_osmt
operator|->
name|opt
operator|=
operator|*
name|p_opt
expr_stmt|;
name|status
operator|=
name|cl_qpool_init
argument_list|(
operator|&
name|p_osmt
operator|->
name|node_pool
argument_list|,
name|POOL_MIN_ITEMS
argument_list|,
literal|0
argument_list|,
name|POOL_MIN_ITEMS
argument_list|,
sizeof|sizeof
argument_list|(
name|node_t
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|status
operator|==
name|CL_SUCCESS
argument_list|)
expr_stmt|;
name|status
operator|=
name|cl_qpool_init
argument_list|(
operator|&
name|p_osmt
operator|->
name|port_pool
argument_list|,
name|POOL_MIN_ITEMS
argument_list|,
literal|0
argument_list|,
name|POOL_MIN_ITEMS
argument_list|,
sizeof|sizeof
argument_list|(
name|port_t
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|status
operator|==
name|CL_SUCCESS
argument_list|)
expr_stmt|;
name|p_osmt
operator|->
name|p_vendor
operator|=
name|osm_vendor_new
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_opt
operator|->
name|transaction_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_osmt
operator|->
name|p_vendor
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|IB_INSUFFICIENT_RESOURCES
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0001: "
literal|"Unable to allocate vendor object"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|osm_mad_pool_construct
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|)
expr_stmt|;
name|status
operator|=
name|osm_mad_pool_init
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|Exit
label|:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_FUNCS
argument_list|,
literal|"]\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osmtest_query_res_cb
parameter_list|(
name|IN
name|osmv_query_res_t
modifier|*
name|p_rec
parameter_list|)
block|{
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_ctxt
init|=
operator|(
name|osmtest_req_context_t
operator|*
operator|)
name|p_rec
operator|->
name|query_context
decl_stmt|;
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
init|=
name|p_ctxt
operator|->
name|p_osmt
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_ctxt
operator|->
name|result
operator|=
operator|*
name|p_rec
expr_stmt|;
if|if
condition|(
name|p_rec
operator|->
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0003: "
literal|"Error on query (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|p_rec
operator|->
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_all_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|attr_id
parameter_list|,
name|IN
name|size_t
specifier|const
name|attr_size
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Getting all %s records\n"
argument_list|,
name|ib_get_sa_attr_str
argument_list|(
name|attr_id
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all<attr_id> records in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|attr_id
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
name|attr_size
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0004: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0064: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_validate_sa_class_port_info
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_class_port_info_t
modifier|*
name|p_cpi
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|osmtest_req_context_t
modifier|*
name|p_context
init|=
operator|&
name|context
decl_stmt|;
name|ib_sa_mad_t
modifier|*
name|p_resp_sa_madp
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting ClassPortInfo\n"
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_CLASS_PORT_INFO
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0065: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0070: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
comment|/* ok we got it so please print it out */
name|p_resp_sa_madp
operator|=
operator|(
name|ib_sa_mad_t
operator|*
operator|)
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|p_cpi
operator|=
operator|(
name|ib_class_port_info_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
name|p_resp_sa_madp
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"\n-----------------------------\n"
literal|"SA Class Port Info:\n"
literal|" base_ver:%u\n"
literal|" class_ver:%u\n"
literal|" cap_mask:0x%X\n"
literal|" cap_mask2:0x%X\n"
literal|" resp_time_val:0x%X\n"
literal|"-----------------------------\n"
argument_list|,
name|p_cpi
operator|->
name|base_ver
argument_list|,
name|p_cpi
operator|->
name|class_ver
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_cpi
operator|->
name|cap_mask
argument_list|)
argument_list|,
name|ib_class_cap_mask2
argument_list|(
name|p_cpi
argument_list|)
argument_list|,
name|ib_class_resp_time_val
argument_list|(
name|p_cpi
argument_list|)
argument_list|)
expr_stmt|;
name|Exit
label|:
if|#
directive|if
literal|0
block|if (context.result.p_result_madw != NULL) { 		osm_mad_pool_put(&p_osmt->mad_pool, 				 context.result.p_result_madw); 		context.result.p_result_madw = NULL; 	}
endif|#
directive|endif
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_node_rec
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net64_t
specifier|const
name|node_guid
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_node_record_t
name|record
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting node record for 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|node_guid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|node_info
operator|.
name|node_guid
operator|=
name|node_guid
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_NR_COMPMASK_NODEGUID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_NODE_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0071: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0072: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Get a node record by node LID  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_node_rec_by_lid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_node_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting node record for LID 0x%02X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_NR_COMPMASK_LID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_NODE_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0073: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0074: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_get_path_rec_by_guid_pair
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net64_t
name|sguid
parameter_list|,
name|IN
name|ib_net64_t
name|dguid
parameter_list|,
name|IN
name|osmtest_req_context_t
modifier|*
name|p_context
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_guid_pair_t
name|guid_pair
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_context
argument_list|)
argument_list|)
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_PATH_REC_BY_PORT_GUIDS
expr_stmt|;
name|guid_pair
operator|.
name|dest_guid
operator|=
name|dguid
expr_stmt|;
name|guid_pair
operator|.
name|src_guid
operator|=
name|sguid
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|guid_pair
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Query for path from 0x%"
name|PRIx64
literal|" to 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|sguid
argument_list|,
name|dguid
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0063: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
operator|(
operator|*
name|p_context
operator|)
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0066: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
operator|(
operator|*
name|p_context
operator|)
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_get_path_rec_by_gid_pair
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_gid_t
name|sgid
parameter_list|,
name|IN
name|ib_gid_t
name|dgid
parameter_list|,
name|IN
name|osmtest_req_context_t
modifier|*
name|p_context
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_gid_pair_t
name|gid_pair
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_context
argument_list|)
argument_list|)
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_PATH_REC_BY_GIDS
expr_stmt|;
name|gid_pair
operator|.
name|dest_gid
operator|=
name|dgid
expr_stmt|;
name|gid_pair
operator|.
name|src_gid
operator|=
name|sgid
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|gid_pair
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Query for path from 0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|" to 0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|sgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|,
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|,
name|dgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|,
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 006A: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
operator|(
operator|*
name|p_context
operator|)
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 006B: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
operator|(
operator|*
name|p_context
operator|)
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|VENDOR_RMPP_SUPPORT
argument_list|)
operator|&&
name|defined
argument_list|(
name|DUAL_SIDED_RMPP
argument_list|)
end_if

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_get_multipath_rec
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|osmv_multipath_req_t
modifier|*
name|p_request
parameter_list|,
name|IN
name|osmtest_req_context_t
modifier|*
name|p_context
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_MULTIPATH_REC
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
name|p_request
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0068: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0069: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_port_rec
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_portinfo_record_t
name|record
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Getting PortInfoRecord for port with LID 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_PIR_COMPMASK_LID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_PORTINFO_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0075: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0076: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_port_rec_by_num
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|uint8_t
specifier|const
name|port_num
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_portinfo_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Getting PortInfoRecord for port with LID 0x%X Num:0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|record
operator|.
name|port_num
operator|=
name|port_num
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_PORT_REC_BY_LID_AND_NUM
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0077: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0078: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_stress_port_recs_large
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_recs
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_queries
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_portinfo_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all PortInfoRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_PORTINFO_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0006: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Populate the database with the received records. 	 */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
operator|*
name|p_num_recs
operator|+=
name|num_recs
expr_stmt|;
operator|++
operator|*
name|p_num_queries
expr_stmt|;
if|if
condition|(
name|osm_log_is_active
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %u records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_portinfo_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osm_dump_portinfo_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_stress_node_recs_large
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_recs
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_queries
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_node_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all NodeRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_NODE_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0007: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Populate the database with the received records. 	 */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
operator|*
name|p_num_recs
operator|+=
name|num_recs
expr_stmt|;
operator|++
operator|*
name|p_num_queries
expr_stmt|;
if|if
condition|(
name|osm_log_is_active
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %u records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_node_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osm_dump_node_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_stress_path_recs_large
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_recs
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_queries
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_path_rec_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all PathRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_PATH_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0008: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Populate the database with the received records. 	 */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
operator|*
name|p_num_recs
operator|+=
name|num_recs
expr_stmt|;
operator|++
operator|*
name|p_num_queries
expr_stmt|;
if|if
condition|(
name|osm_log_is_active
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %u records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_path_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osm_dump_path_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_stress_path_recs_by_guid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_recs
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_queries
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_path_rec_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|node_t
modifier|*
name|p_src_node
decl_stmt|,
modifier|*
name|p_dst_node
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_guid_tbl
expr_stmt|;
name|p_src_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
comment|/* 	 * Go over all nodes that exist in the subnet 	 * for each pair that are not switch nodes get the path record 	 */
while|while
condition|(
name|p_src_node
operator|!=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
name|p_dst_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_dst_node
operator|!=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
comment|/* 			 * Do a blocking query for CA to CA Path Record 			 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Source : guid = 0x%"
name|PRIx64
literal|" type = %d"
literal|"Target : guid = 0x%"
name|PRIx64
literal|" type = %d\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_src_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_guid
argument_list|)
argument_list|,
name|p_src_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_type
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_dst_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_guid
argument_list|)
argument_list|,
name|p_dst_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_src_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_CA
operator|&&
name|p_dst_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_CA
condition|)
block|{
name|status
operator|=
name|osmtest_get_path_rec_by_guid_pair
argument_list|(
name|p_osmt
argument_list|,
name|p_src_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_guid
argument_list|,
name|p_dst_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_guid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
comment|/* In a case of TIMEOUT you still can try sending but cant count, maybe its a temporary issue */
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0009: "
literal|"osmtest_get_path_rec_by_guid_pair failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_TIMEOUT
condition|)
goto|goto
name|Exit
goto|;
block|}
else|else
block|{
comment|/* we might have received several records */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
comment|/* 					 * Populate the database with the received records. 					 */
operator|*
name|p_num_recs
operator|+=
name|num_recs
expr_stmt|;
operator|++
operator|*
name|p_num_queries
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %u records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
comment|/* Dont waste time if not VERBOSE and above */
if|if
condition|(
name|p_osmt
operator|->
name|log
operator|.
name|level
operator|&
name|OSM_LOG_VERBOSE
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_path_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osm_dump_path_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
comment|/* next one please */
name|p_dst_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_dst_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|p_src_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_src_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_stress_port_recs_small
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_recs
parameter_list|,
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_num_queries
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_portinfo_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for our own PortInfoRecord in the subnet. 	 */
name|status
operator|=
name|osmtest_get_port_rec
argument_list|(
name|p_osmt
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_osmt
operator|->
name|local_port
operator|.
name|lid
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0010: "
literal|"osmtest_get_port_rec failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Populate the database with the received records. 	 */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
operator|*
name|p_num_recs
operator|+=
name|num_recs
expr_stmt|;
operator|++
operator|*
name|p_num_queries
expr_stmt|;
if|if
condition|(
name|osm_log_is_active
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %u records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_portinfo_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osm_dump_portinfo_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_local_port_lmc
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
name|lid
parameter_list|,
name|OUT
name|uint8_t
modifier|*
specifier|const
name|p_lmc
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_portinfo_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for our own PortInfoRecord in the subnet. 	 */
name|status
operator|=
name|osmtest_get_port_rec
argument_list|(
name|p_osmt
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 001A: "
literal|"osmtest_get_port_rec failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %u records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_portinfo_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osm_dump_portinfo_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_lmc
condition|)
block|{
operator|*
name|p_lmc
operator|=
name|ib_port_info_get_lmc
argument_list|(
operator|&
name|p_rec
operator|->
name|port_info
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"LMC %d\n"
argument_list|,
operator|*
name|p_lmc
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Use a wrong SM_Key in a simple port query and report success if  * failed.  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_wrong_sm_key_ignored
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_portinfo_record_t
name|record
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|osmtest_req_context_t
modifier|*
name|p_context
init|=
operator|&
name|context
decl_stmt|;
name|uint8_t
name|port_num
init|=
literal|1
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Trying PortInfoRecord for port with LID 0x%X Num:0x%X\n"
argument_list|,
name|p_osmt
operator|->
name|local_port
operator|.
name|sm_lid
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|p_osmt
operator|->
name|local_port
operator|.
name|sm_lid
expr_stmt|;
name|record
operator|.
name|port_num
operator|=
name|port_num
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_PORT_REC_BY_LID_AND_NUM
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|9999
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* since we use a wrong sm_key we should get a timeout */
if|if
condition|(
name|status
operator|!=
name|IB_TIMEOUT
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0011: "
literal|"Did not get a timeout but got (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
comment|/* assign some error value to status, since IB_SUCCESS is a bad rc */
name|status
operator|=
name|IB_ERROR
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
else|else
block|{
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
block|}
name|Exit
label|:
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_port_info
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|,
name|IN
specifier|const
name|ib_portinfo_record_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"DEFINE_PORT\n"
literal|"lid                     0x%X\n"
literal|"port_num                0x%X\n"
literal|"m_key                   0x%016"
name|PRIx64
literal|"\n"
literal|"subnet_prefix           0x%016"
name|PRIx64
literal|"\n"
literal|"base_lid                0x%X\n"
literal|"master_sm_base_lid      0x%X\n"
literal|"capability_mask         0x%X\n"
literal|"diag_code               0x%X\n"
literal|"m_key_lease_period      0x%X\n"
literal|"local_port_num          0x%X\n"
literal|"link_width_enabled      0x%X\n"
literal|"link_width_supported    0x%X\n"
literal|"link_width_active       0x%X\n"
literal|"link_speed_supported    0x%X\n"
literal|"port_state              %s\n"
literal|"state_info2             0x%X\n"
literal|"mpb                     0x%X\n"
literal|"lmc                     0x%X\n"
literal|"link_speed              0x%X\n"
literal|"mtu_smsl                0x%X\n"
literal|"vl_cap                  0x%X\n"
literal|"vl_high_limit           0x%X\n"
literal|"vl_arb_high_cap         0x%X\n"
literal|"vl_arb_low_cap          0x%X\n"
literal|"mtu_cap                 0x%X\n"
literal|"vl_stall_life           0x%X\n"
literal|"vl_enforce              0x%X\n"
literal|"m_key_violations        0x%X\n"
literal|"p_key_violations        0x%X\n"
literal|"q_key_violations        0x%X\n"
literal|"guid_cap                0x%X\n"
literal|"subnet_timeout          0x%X\n"
literal|"resp_time_value         0x%X\n"
literal|"error_threshold         0x%X\n"
literal|"END\n\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|m_key
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|subnet_prefix
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|base_lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|master_sm_base_lid
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|capability_mask
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|diag_code
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|m_key_lease_period
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|local_port_num
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|link_width_enabled
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|link_width_supported
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|link_width_active
argument_list|,
name|ib_port_info_get_link_speed_sup
argument_list|(
operator|&
name|p_rec
operator|->
name|port_info
argument_list|)
argument_list|,
name|ib_get_port_state_str
argument_list|(
name|ib_port_info_get_port_state
argument_list|(
operator|&
name|p_rec
operator|->
name|port_info
argument_list|)
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|state_info2
argument_list|,
name|ib_port_info_get_mpb
argument_list|(
operator|&
name|p_rec
operator|->
name|port_info
argument_list|)
argument_list|,
name|ib_port_info_get_lmc
argument_list|(
operator|&
name|p_rec
operator|->
name|port_info
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|link_speed
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|mtu_smsl
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_cap
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_high_limit
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_arb_high_cap
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_arb_low_cap
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|mtu_cap
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_stall_life
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_enforce
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|m_key_violations
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|p_key_violations
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|q_key_violations
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|guid_cap
argument_list|,
name|ib_port_info_get_timeout
argument_list|(
operator|&
name|p_rec
operator|->
name|port_info
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|resp_time_value
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|error_threshold
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0161: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_path_info
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|,
name|IN
specifier|const
name|ib_path_rec_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"DEFINE_PATH\n"
literal|"dgid                    0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|"\nsgid                    0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|"\ndlid                    0x%X\n"
literal|"slid                    0x%X\n"
literal|"# hop_flow_raw          0x%X\n"
literal|"# tclass                0x%X\n"
literal|"# num_path              0x%X\n"
literal|"pkey                    0x%X\n"
literal|"# sl                    0x%X\n"
literal|"# qos_class             0x%X\n"
literal|"# mtu                   0x%X\n"
literal|"# rate                  0x%X\n"
literal|"# pkt_life              0x%X\n"
literal|"# preference            0x%X\n"
literal|"END\n\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|dgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|sgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|dlid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|slid
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_rec
operator|->
name|hop_flow_raw
argument_list|)
argument_list|,
name|p_rec
operator|->
name|tclass
argument_list|,
name|p_rec
operator|->
name|num_path
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|pkey
argument_list|)
argument_list|,
name|ib_path_rec_sl
argument_list|(
name|p_rec
argument_list|)
argument_list|,
name|ib_path_rec_qos_class
argument_list|(
name|p_rec
argument_list|)
argument_list|,
name|p_rec
operator|->
name|mtu
argument_list|,
name|p_rec
operator|->
name|rate
argument_list|,
name|p_rec
operator|->
name|pkt_life
argument_list|,
name|p_rec
operator|->
name|preference
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0162: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_node_info
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|,
name|IN
specifier|const
name|ib_node_record_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|char
name|desc
index|[
name|IB_NODE_DESCRIPTION_SIZE
operator|+
literal|1
index|]
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|desc
argument_list|,
name|p_rec
operator|->
name|node_desc
operator|.
name|description
argument_list|,
name|IB_NODE_DESCRIPTION_SIZE
argument_list|)
expr_stmt|;
name|desc
index|[
name|IB_NODE_DESCRIPTION_SIZE
index|]
operator|=
literal|'\0'
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"DEFINE_NODE\n"
literal|"lid                     0x%X\n"
literal|"base_version            0x%X\n"
literal|"class_version           0x%X\n"
literal|"node_type               0x%X # (%s)\n"
literal|"num_ports               0x%X\n"
literal|"sys_guid                0x%016"
name|PRIx64
literal|"\n"
literal|"node_guid               0x%016"
name|PRIx64
literal|"\n"
literal|"port_guid               0x%016"
name|PRIx64
literal|"\n"
literal|"partition_cap           0x%X\n"
literal|"device_id               0x%X\n"
literal|"revision                0x%X\n"
literal|"# port_num              0x%X\n"
literal|"# vendor_id             0x%X\n"
literal|"# node_desc             %s\n"
literal|"END\n\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|node_info
operator|.
name|base_version
argument_list|,
name|p_rec
operator|->
name|node_info
operator|.
name|class_version
argument_list|,
name|p_rec
operator|->
name|node_info
operator|.
name|node_type
argument_list|,
name|ib_get_node_type_str
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_type
argument_list|)
argument_list|,
name|p_rec
operator|->
name|node_info
operator|.
name|num_ports
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|sys_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|port_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|partition_cap
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|device_id
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|revision
argument_list|)
argument_list|,
name|ib_node_info_get_local_port_num
argument_list|(
operator|&
name|p_rec
operator|->
name|node_info
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_node_info_get_vendor_id
argument_list|(
operator|&
name|p_rec
operator|->
name|node_info
argument_list|)
argument_list|)
argument_list|,
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0163: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_link
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|,
name|IN
specifier|const
name|ib_link_record_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"DEFINE_LINK\n"
literal|"from_lid                0x%X\n"
literal|"from_port_num           0x%X\n"
literal|"to_port_num             0x%X\n"
literal|"to_lid                  0x%X\n"
literal|"END\n\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|from_lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|from_port_num
argument_list|,
name|p_rec
operator|->
name|to_port_num
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|to_lid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0164: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_all_link_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_link_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|size_t
name|num_recs
decl_stmt|;
name|int
name|result
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all NodeRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_LINK_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0165: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Write the received records out to the file. 	 */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %zu records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"#\n"
literal|"# Link Records\n"
literal|"#\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0166: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
operator|(
name|ib_link_record_t
operator|*
operator|)
name|osmv_get_query_result
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osmtest_write_link
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_get_path_rec_by_lid_pair
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
name|slid
parameter_list|,
name|IN
name|ib_net16_t
name|dlid
parameter_list|,
name|IN
name|osmtest_req_context_t
modifier|*
name|p_context
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_lid_pair_t
name|lid_pair
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_context
argument_list|)
argument_list|)
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_PATH_REC_BY_LIDS
expr_stmt|;
name|lid_pair
operator|.
name|dest_lid
operator|=
name|dlid
expr_stmt|;
name|lid_pair
operator|.
name|src_lid
operator|=
name|slid
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|lid_pair
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Query for path from 0x%X to 0x%X\n"
argument_list|,
name|slid
argument_list|,
name|dlid
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0053: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
operator|(
operator|*
name|p_context
operator|)
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0067: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
operator|(
operator|*
name|p_context
operator|)
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|VENDOR_RMPP_SUPPORT
end_ifdef

begin_comment
comment|/**********************************************************************  * ASSUMES RMPP  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_all_node_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_node_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|size_t
name|num_recs
decl_stmt|;
name|int
name|result
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all NodeRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_NODE_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0022: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Write the received records out to the file. 	 */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %zu records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"#\n"
literal|"# Node Records\n"
literal|"#\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0023: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_node_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osmtest_write_node_info
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * ASSUMES RMPP  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_all_port_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_portinfo_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|size_t
name|num_recs
decl_stmt|;
name|int
name|result
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all NodeRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_PORTINFO_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0167: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Write the received records out to the file. 	 */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %zu records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"#\n"
literal|"# PortInfo Records\n"
literal|"#\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0024: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_portinfo_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osmtest_write_port_info
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * ASSUMES RMPP  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_all_path_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_path_rec_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|size_t
name|num_recs
decl_stmt|;
name|int
name|result
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all PathRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_PATH_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0025: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Write the received records out to the file. 	 */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %zu records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"#\n"
literal|"# Path Records\n"
literal|"#\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0026: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_path_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osmtest_write_path_info
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/*  * NON RMPP BASED QUERY FOR ALL NODES: BASED ON THE MAX LID GIVEN BY THE USER  */
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_all_node_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|node_t
modifier|*
name|p_node
decl_stmt|;
name|node_t
modifier|*
name|p_guid_node
decl_stmt|;
specifier|const
name|ib_node_record_t
modifier|*
name|p_rec
decl_stmt|;
name|cl_status_t
name|status
init|=
name|CL_SUCCESS
decl_stmt|;
name|int
name|result
decl_stmt|;
name|uint16_t
name|lid
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"#\n"
literal|"# Node Records\n"
literal|"#\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0027: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Go over all LIDs in the range 1 to max_lid and do a 	 * NodeRecord query by that lid. 	 */
for|for
control|(
name|lid
operator|=
literal|1
init|;
name|lid
operator|<=
name|p_osmt
operator|->
name|max_lid
condition|;
name|lid
operator|++
control|)
block|{
comment|/* prepare the query context */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_node_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
if|if
condition|(
name|status
operator|!=
name|IB_SA_MAD_STATUS_NO_RECORDS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"ERR 0028: "
literal|"failed to get node info for LID:0x%02X (%s)\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"WRN 0121: "
literal|"failed to get node info for LID:0x%02X (%s)\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* OK we got something */
name|p_rec
operator|=
name|osmv_get_query_node_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|osmtest_write_node_info
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
comment|/* create a subnet object */
name|p_node
operator|=
name|node_new
argument_list|()
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* copy the info to the subnet node object */
name|p_node
operator|->
name|rec
operator|=
operator|*
name|p_rec
expr_stmt|;
name|cl_qmap_insert
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|lid
argument_list|,
operator|&
name|p_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|p_guid_node
operator|=
name|node_new
argument_list|()
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_guid_node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|p_guid_node
operator|=
operator|*
name|p_node
expr_stmt|;
name|cl_qmap_insert
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_guid_tbl
argument_list|,
name|p_guid_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_guid
argument_list|,
operator|&
name|p_guid_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|Exit
label|:
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * GET ALL PORT RECORDS IN THE FABRIC -  * one by one by using the node info received  */
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_all_port_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_node_record_t
modifier|*
name|p_node_rec
decl_stmt|;
specifier|const
name|ib_portinfo_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint8_t
name|port_num
decl_stmt|;
name|cl_status_t
name|status
init|=
name|CL_SUCCESS
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|node_t
modifier|*
name|p_node
decl_stmt|;
name|port_t
modifier|*
name|p_port
decl_stmt|;
name|int
name|result
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* print header */
name|result
operator|=
name|fprintf
argument_list|(
name|fh
argument_list|,
literal|"#\n"
literal|"# PortInfo Records\n"
literal|"#\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0029: "
literal|"Write failed\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* use the pre-explored set of nodes */
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
expr_stmt|;
name|p_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
comment|/* 	 * Go over all LIDs in the range 1 to max_lid and do a 	 * NodeRecord query by that lid. 	 */
while|while
condition|(
name|p_node
operator|!=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
name|p_node_rec
operator|=
operator|&
operator|(
name|p_node
operator|->
name|rec
operator|)
expr_stmt|;
comment|/* go through all ports of the node: */
for|for
control|(
name|port_num
operator|=
literal|0
init|;
name|port_num
operator|<=
name|p_node_rec
operator|->
name|node_info
operator|.
name|num_ports
condition|;
name|port_num
operator|++
control|)
block|{
comment|/* prepare the query context */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_port_rec_by_num
argument_list|(
name|p_osmt
argument_list|,
name|p_node_rec
operator|->
name|lid
argument_list|,
name|port_num
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
if|if
condition|(
name|status
operator|!=
name|IB_SA_MAD_STATUS_NO_RECORDS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"WRN 0122: "
literal|"Error encountered getting port info for LID:0x%04X Num:0x%02X (%s)\n"
argument_list|,
name|p_node_rec
operator|->
name|lid
argument_list|,
name|port_num
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"WRN 0123: "
literal|"failed to get port info for LID:0x%04X Num:0x%02X (%s)\n"
argument_list|,
name|p_node_rec
operator|->
name|lid
argument_list|,
name|port_num
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* OK we got something */
name|p_rec
operator|=
name|osmv_get_query_portinfo_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|osmtest_write_port_info
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
comment|/* create a subnet object */
name|p_port
operator|=
name|port_new
argument_list|()
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_port
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* copy the info to the subnet node object */
name|p_port
operator|->
name|rec
operator|=
operator|*
name|p_rec
expr_stmt|;
name|cl_qmap_insert
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|port_key_tbl
argument_list|,
name|port_gen_id
argument_list|(
name|p_node_rec
operator|->
name|lid
argument_list|,
name|port_num
argument_list|)
argument_list|,
operator|&
name|p_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|p_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
comment|/* we must set the exist status to avoid abort of the over all algorith */
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * ASSUMES NO RMPP  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_write_all_path_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
name|fh
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_path_rec_t
modifier|*
name|p_rec
decl_stmt|;
name|cl_status_t
name|status
init|=
name|CL_SUCCESS
decl_stmt|;
name|int
name|num_recs
decl_stmt|,
name|i
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|node_t
modifier|*
name|p_src_node
decl_stmt|,
modifier|*
name|p_dst_node
decl_stmt|;
name|ib_api_status_t
name|got_status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Go over all nodes that exist in the subnet 	 * for each pair that are not switch nodes get the path record 	 */
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
expr_stmt|;
name|p_src_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_src_node
operator|!=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
comment|/* HACK we use capability_mask to know diff a CA node from switch node */
comment|/* if(p_src_node->rec.node_info.capability_mask  ) { */
name|p_dst_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_dst_node
operator|!=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
comment|/* HACK we use capability_mask to know diff a CA node from switch node */
comment|/* if (p_dst_node->rec.node_info.capability_mask) { */
comment|/* query for it: */
name|status
operator|=
name|osmtest_get_path_rec_by_lid_pair
argument_list|(
name|p_osmt
argument_list|,
name|p_src_node
operator|->
name|rec
operator|.
name|lid
argument_list|,
name|p_dst_node
operator|->
name|rec
operator|.
name|lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 012D: "
literal|"failed to get path info from LID:0x%X To LID:0x%X (%s)\n"
argument_list|,
name|p_src_node
operator|->
name|rec
operator|.
name|lid
argument_list|,
name|p_dst_node
operator|->
name|rec
operator|.
name|lid
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* remember the first error status */
name|got_status
operator|=
operator|(
name|got_status
operator|==
name|IB_SUCCESS
operator|)
condition|?
name|status
else|:
name|got_status
expr_stmt|;
block|}
else|else
block|{
comment|/* we might have received several records */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_path_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osmtest_write_path_info
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*  } */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* next one please */
name|p_dst_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_dst_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
comment|/* } */
name|p_src_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_src_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|got_status
operator|!=
name|IB_SUCCESS
condition|)
name|status
operator|=
name|got_status
expr_stmt|;
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_create_inventory_file
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|FILE
modifier|*
name|fh
decl_stmt|;
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|fh
operator|=
name|fopen
argument_list|(
name|p_osmt
operator|->
name|opt
operator|.
name|file_name
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fh
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0079: "
literal|"Unable to open inventory file (%s)\n"
argument_list|,
name|p_osmt
operator|->
name|opt
operator|.
name|file_name
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* HACK: the order is important: nodes ports paths */
name|status
operator|=
name|osmtest_write_all_node_recs
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|status
operator|=
name|osmtest_write_all_port_recs
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
operator|!
name|p_osmt
operator|->
name|opt
operator|.
name|ignore_path_records
condition|)
block|{
name|status
operator|=
name|osmtest_write_all_path_recs
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmtest_write_all_link_recs
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|fclose
argument_list|(
name|fh
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_stress_large_rmpp_pr
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint64_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|uint64_t
name|num_queries
init|=
literal|0
decl_stmt|;
name|uint32_t
name|delta_recs
decl_stmt|;
name|uint32_t
name|delta_queries
decl_stmt|;
name|uint32_t
name|print_freq
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|start_tv
decl_stmt|,
name|end_tv
decl_stmt|;
name|long
name|sec_diff
decl_stmt|,
name|usec_diff
decl_stmt|;
name|float
name|ratio
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|start_tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- Start time is : %09ld:%06ld [sec:usec]\n"
argument_list|,
name|start_tv
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|start_tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
while|while
condition|(
name|num_queries
operator|<
name|STRESS_LARGE_PR_RMPP_THR
condition|)
block|{
name|delta_recs
operator|=
literal|0
expr_stmt|;
name|delta_queries
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmtest_stress_path_recs_by_guid
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|delta_recs
argument_list|,
operator|&
name|delta_queries
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|num_recs
operator|+=
name|delta_recs
expr_stmt|;
name|num_queries
operator|+=
name|delta_queries
expr_stmt|;
name|print_freq
operator|+=
name|delta_recs
expr_stmt|;
if|if
condition|(
name|print_freq
operator|>
literal|10000
condition|)
block|{
name|gettimeofday
argument_list|(
operator|&
name|end_tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|end_tv
operator|.
name|tv_usec
operator|>
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
expr_stmt|;
name|usec_diff
operator|=
name|end_tv
operator|.
name|tv_usec
operator|-
name|start_tv
operator|.
name|tv_usec
expr_stmt|;
block|}
else|else
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
operator|-
literal|1
expr_stmt|;
name|usec_diff
operator|=
literal|1000000
operator|-
operator|(
name|start_tv
operator|.
name|tv_usec
operator|-
name|end_tv
operator|.
name|tv_usec
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"-I- End time is : %09ld:%06ld [sec:usec]\n"
argument_list|,
name|end_tv
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|end_tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- Querying %"
name|PRId64
literal|" Path Record queries CA to CA (rmpp)\n\ttook %04ld:%06ld [sec:usec]\n"
argument_list|,
name|num_queries
argument_list|,
name|sec_diff
argument_list|,
name|usec_diff
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_recs
operator|==
literal|0
condition|)
name|ratio
operator|=
literal|0
expr_stmt|;
else|else
name|ratio
operator|=
operator|(
operator|(
name|float
operator|)
name|num_queries
operator|/
operator|(
name|float
operator|)
name|num_recs
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- Queries to Record Ratio is %"
name|PRIu64
literal|" records, %"
name|PRIu64
literal|" queries : %.2f \n"
argument_list|,
name|num_recs
argument_list|,
name|num_queries
argument_list|,
name|ratio
argument_list|)
expr_stmt|;
name|print_freq
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|Exit
label|:
name|gettimeofday
argument_list|(
operator|&
name|end_tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- End time is : %09ld:%06ld [sec:usec]\n"
argument_list|,
name|end_tv
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|end_tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
if|if
condition|(
name|end_tv
operator|.
name|tv_usec
operator|>
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
expr_stmt|;
name|usec_diff
operator|=
name|end_tv
operator|.
name|tv_usec
operator|-
name|start_tv
operator|.
name|tv_usec
expr_stmt|;
block|}
else|else
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
operator|-
literal|1
expr_stmt|;
name|usec_diff
operator|=
literal|1000000
operator|-
operator|(
name|start_tv
operator|.
name|tv_usec
operator|-
name|end_tv
operator|.
name|tv_usec
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"-I- Querying %"
name|PRId64
literal|" Path Record queries (rmpp) took %04ld:%06ld [sec:usec]\n"
argument_list|,
name|num_queries
argument_list|,
name|sec_diff
argument_list|,
name|usec_diff
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_stress_large_rmpp
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint64_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|uint64_t
name|num_queries
init|=
literal|0
decl_stmt|;
name|uint32_t
name|delta_recs
decl_stmt|;
name|uint32_t
name|delta_queries
decl_stmt|;
name|uint32_t
name|print_freq
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|start_tv
decl_stmt|,
name|end_tv
decl_stmt|;
name|long
name|sec_diff
decl_stmt|,
name|usec_diff
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|start_tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- Start time is : %09ld:%06ld [sec:usec]\n"
argument_list|,
name|start_tv
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|start_tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
while|while
condition|(
name|num_queries
operator|<
name|STRESS_LARGE_RMPP_THR
condition|)
block|{
name|delta_recs
operator|=
literal|0
expr_stmt|;
name|delta_queries
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmtest_stress_node_recs_large
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|delta_recs
argument_list|,
operator|&
name|delta_queries
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|status
operator|=
name|osmtest_stress_path_recs_large
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|delta_recs
argument_list|,
operator|&
name|delta_queries
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|status
operator|=
name|osmtest_stress_port_recs_large
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|delta_recs
argument_list|,
operator|&
name|delta_queries
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|num_recs
operator|+=
name|delta_recs
expr_stmt|;
name|num_queries
operator|+=
name|delta_queries
expr_stmt|;
name|print_freq
operator|+=
name|delta_recs
expr_stmt|;
if|if
condition|(
name|print_freq
operator|>
literal|100000
condition|)
block|{
name|gettimeofday
argument_list|(
operator|&
name|end_tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|end_tv
operator|.
name|tv_usec
operator|>
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
expr_stmt|;
name|usec_diff
operator|=
name|end_tv
operator|.
name|tv_usec
operator|-
name|start_tv
operator|.
name|tv_usec
expr_stmt|;
block|}
else|else
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
operator|-
literal|1
expr_stmt|;
name|usec_diff
operator|=
literal|1000000
operator|-
operator|(
name|start_tv
operator|.
name|tv_usec
operator|-
name|end_tv
operator|.
name|tv_usec
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"-I- End time is : %09ld:%06ld [sec:usec]\n"
argument_list|,
name|end_tv
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|end_tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- Querying %"
name|PRId64
literal|" large mixed queries (rmpp) took %04ld:%06ld [sec:usec]\n"
argument_list|,
name|num_queries
argument_list|,
name|sec_diff
argument_list|,
name|usec_diff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%"
name|PRIu64
literal|" records, %"
name|PRIu64
literal|" queries\n"
argument_list|,
name|num_recs
argument_list|,
name|num_queries
argument_list|)
expr_stmt|;
name|print_freq
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|Exit
label|:
name|gettimeofday
argument_list|(
operator|&
name|end_tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- End time is : %09ld:%06ld [sec:usec]\n"
argument_list|,
name|end_tv
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|end_tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
if|if
condition|(
name|end_tv
operator|.
name|tv_usec
operator|>
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
expr_stmt|;
name|usec_diff
operator|=
name|end_tv
operator|.
name|tv_usec
operator|-
name|start_tv
operator|.
name|tv_usec
expr_stmt|;
block|}
else|else
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
operator|-
literal|1
expr_stmt|;
name|usec_diff
operator|=
literal|1000000
operator|-
operator|(
name|start_tv
operator|.
name|tv_usec
operator|-
name|end_tv
operator|.
name|tv_usec
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"-I- Querying %"
name|PRId64
literal|" large mixed queries (rmpp) took %04ld:%06ld [sec:usec]\n"
argument_list|,
name|num_queries
argument_list|,
name|sec_diff
argument_list|,
name|usec_diff
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_stress_small_rmpp
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint64_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|uint64_t
name|num_queries
init|=
literal|0
decl_stmt|;
name|uint32_t
name|delta_recs
decl_stmt|;
name|uint32_t
name|delta_queries
decl_stmt|;
name|uint32_t
name|print_freq
init|=
literal|0
decl_stmt|;
name|int
name|num_timeouts
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|start_tv
decl_stmt|,
name|end_tv
decl_stmt|;
name|long
name|sec_diff
decl_stmt|,
name|usec_diff
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|start_tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- Start time is : %09ld:%06ld [sec:usec]\n"
argument_list|,
name|start_tv
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|start_tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|num_queries
operator|<
name|STRESS_SMALL_RMPP_THR
operator|)
operator|&&
operator|(
name|num_timeouts
operator|<
literal|100
operator|)
condition|)
block|{
name|delta_recs
operator|=
literal|0
expr_stmt|;
name|delta_queries
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmtest_stress_port_recs_small
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|delta_recs
argument_list|,
operator|&
name|delta_queries
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|num_recs
operator|+=
name|delta_recs
expr_stmt|;
name|num_queries
operator|+=
name|delta_queries
expr_stmt|;
name|print_freq
operator|+=
name|delta_recs
expr_stmt|;
if|if
condition|(
name|print_freq
operator|>
literal|5000
condition|)
block|{
name|gettimeofday
argument_list|(
operator|&
name|end_tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%"
name|PRIu64
literal|" records, %"
name|PRIu64
literal|" queries\n"
argument_list|,
name|num_recs
argument_list|,
name|num_queries
argument_list|)
expr_stmt|;
if|if
condition|(
name|end_tv
operator|.
name|tv_usec
operator|>
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
expr_stmt|;
name|usec_diff
operator|=
name|end_tv
operator|.
name|tv_usec
operator|-
name|start_tv
operator|.
name|tv_usec
expr_stmt|;
block|}
else|else
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
operator|-
literal|1
expr_stmt|;
name|usec_diff
operator|=
literal|1000000
operator|-
operator|(
name|start_tv
operator|.
name|tv_usec
operator|-
name|end_tv
operator|.
name|tv_usec
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"-I- End time is : %09ld:%06ld [sec:usec]\n"
argument_list|,
name|end_tv
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|end_tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- Querying %"
name|PRId64
literal|" port_info queries (single mad) took %04ld:%06ld [sec:usec]\n"
argument_list|,
name|num_queries
argument_list|,
name|sec_diff
argument_list|,
name|usec_diff
argument_list|)
expr_stmt|;
name|print_freq
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|Exit
label|:
name|gettimeofday
argument_list|(
operator|&
name|end_tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-I- End time is : %09ld:%06ld [sec:usec]\n"
argument_list|,
name|end_tv
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|end_tv
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
if|if
condition|(
name|end_tv
operator|.
name|tv_usec
operator|>
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
expr_stmt|;
name|usec_diff
operator|=
name|end_tv
operator|.
name|tv_usec
operator|-
name|start_tv
operator|.
name|tv_usec
expr_stmt|;
block|}
else|else
block|{
name|sec_diff
operator|=
name|end_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
operator|-
literal|1
expr_stmt|;
name|usec_diff
operator|=
literal|1000000
operator|-
operator|(
name|start_tv
operator|.
name|tv_usec
operator|-
name|end_tv
operator|.
name|tv_usec
operator|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"-I- Querying %"
name|PRId64
literal|" port_info queries (single mad) took %04ld:%06ld [sec:usec]\n"
argument_list|,
name|num_queries
argument_list|,
name|sec_diff
argument_list|,
name|usec_diff
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_timeouts
operator|>
literal|50
condition|)
block|{
name|status
operator|=
name|IB_TIMEOUT
expr_stmt|;
block|}
comment|/* Exit: */
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|osmtest_prepare_db_generic
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|cl_qmap_t
modifier|*
specifier|const
name|p_tbl
parameter_list|)
block|{
name|generic_t
modifier|*
name|p_generic
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_generic
operator|=
operator|(
name|generic_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_generic
operator|!=
operator|(
name|generic_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
name|p_generic
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|p_generic
operator|=
operator|(
name|generic_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_generic
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|osmtest_prepare_db
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|osmtest_prepare_db_generic
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
argument_list|)
expr_stmt|;
name|osmtest_prepare_db_generic
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|path_tbl
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_check_missing_nodes
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
specifier|const
name|node_t
modifier|*
name|p_node
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
expr_stmt|;
name|p_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_node
operator|!=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
if|if
condition|(
name|p_node
operator|->
name|count
operator|==
literal|0
condition|)
block|{
comment|/* 			 * This node was not reported by the SA 			 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0080: "
literal|"Missing node 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
block|}
name|p_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_check_missing_ports
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
specifier|const
name|port_t
modifier|*
name|p_port
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|port_key_tbl
expr_stmt|;
name|p_port
operator|=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_port
operator|!=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
if|if
condition|(
name|p_port
operator|->
name|count
operator|==
literal|0
condition|)
block|{
comment|/* 			 * This port was not reported by the SA 			 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0081: "
literal|"Missing port LID:0x%X Num:0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|lid
argument_list|)
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_num
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
block|}
name|p_port
operator|=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_check_missing_paths
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
specifier|const
name|path_t
modifier|*
name|p_path
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|path_tbl
expr_stmt|;
name|p_path
operator|=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_path
operator|!=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
if|if
condition|(
name|p_path
operator|->
name|count
operator|==
literal|0
condition|)
block|{
comment|/* 			 * This path was not reported by the SA 			 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0051: "
literal|"SA did not return path SLID 0x%X to DLID 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|slid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|dlid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_path
operator|=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_path
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|inline
name|uint32_t
name|osmtest_path_rec_key_get
parameter_list|(
name|IN
specifier|const
name|ib_path_rec_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
return|return
operator|(
name|p_rec
operator|->
name|dlid
operator|<<
literal|16
operator||
name|p_rec
operator|->
name|slid
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|boolean_t
name|osmtest_path_rec_kay_is_valid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
specifier|const
name|path_t
modifier|*
specifier|const
name|p_path
parameter_list|)
block|{
if|if
condition|(
operator|(
name|p_path
operator|->
name|comp
operator|.
name|dlid
operator|==
literal|0
operator|)
operator|||
operator|(
name|p_path
operator|->
name|comp
operator|.
name|slid
operator|==
literal|0
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0168: "
literal|"SLID and DLID must be specified for defined paths\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_path_data
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|path_t
modifier|*
specifier|const
name|p_path
parameter_list|,
name|IN
specifier|const
name|ib_path_rec_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint8_t
name|lmc
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Checking path SLID 0x%X to DLID 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|slid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|dlid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_local_port_lmc
argument_list|(
name|p_osmt
argument_list|,
name|p_osmt
operator|->
name|local_port
operator|.
name|lid
argument_list|,
operator|&
name|lmc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* HACK: Assume uniform LMC across endports in the subnet */
comment|/* This is the only LMC mode which OpenSM currently supports */
comment|/* In absence of this assumption, validation of this is much more complicated */
if|if
condition|(
name|lmc
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Has this record already been returned? 		 */
if|if
condition|(
name|p_path
operator|->
name|count
operator|!=
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0056: "
literal|"Already received path SLID 0x%X to DLID 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|slid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|dlid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
else|else
block|{
comment|/* Also, this doesn't detect fewer than the correct number of paths being returned */
if|if
condition|(
name|p_path
operator|->
name|count
operator|>=
call|(
name|uint32_t
call|)
argument_list|(
literal|1
operator|<<
operator|(
literal|2
operator|*
name|lmc
operator|)
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0052: "
literal|"Already received path SLID 0x%X to DLID 0x%X count %d LMC %d\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|slid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|dlid
argument_list|)
argument_list|,
name|p_path
operator|->
name|count
argument_list|,
name|lmc
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
operator|++
name|p_path
operator|->
name|count
expr_stmt|;
comment|/* 	 * Check the fields the user wants checked. 	 */
if|if
condition|(
operator|(
name|p_path
operator|->
name|comp
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
operator|&
name|p_path
operator|->
name|rec
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
operator|)
operator|!=
operator|(
name|p_path
operator|->
name|comp
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
operator|&
name|p_rec
operator|->
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0169: "
literal|"DGID mismatch on path SLID 0x%X to DLID 0x%X\n"
literal|"\t\t\t\tExpected 0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|"\n"
literal|"\t\t\t\tReceived 0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|slid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|dlid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|dgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Check the fields the user wants checked. 	 */
if|if
condition|(
operator|(
name|p_path
operator|->
name|comp
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
operator|&
name|p_path
operator|->
name|rec
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
operator|)
operator|!=
operator|(
name|p_path
operator|->
name|comp
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
operator|&
name|p_rec
operator|->
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0057: "
literal|"SGID mismatch on path SLID 0x%X to DLID 0x%X\n"
literal|"\t\t\t\tExpected 0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|",\n"
literal|"\t\t\t\tReceived 0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|".\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|slid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|dlid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|sgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Compare the fields the user wishes to validate. 	 */
if|if
condition|(
operator|(
name|p_path
operator|->
name|comp
operator|.
name|pkey
operator|&
name|p_path
operator|->
name|rec
operator|.
name|pkey
operator|)
operator|!=
operator|(
name|p_path
operator|->
name|comp
operator|.
name|pkey
operator|&
name|p_rec
operator|->
name|pkey
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0012: "
literal|"PKEY mismatch on path SLID 0x%X to DLID 0x%X\n"
literal|"\t\t\t\tExpected 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|slid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|dlid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|pkey
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|pkey
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_node_data
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|node_t
modifier|*
specifier|const
name|p_node
parameter_list|,
name|IN
specifier|const
name|ib_node_record_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Checking node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Has this record already been returned? 	 */
if|if
condition|(
name|p_node
operator|->
name|count
operator|!=
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0013: "
literal|"Already received node 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|++
name|p_node
operator|->
name|count
expr_stmt|;
comment|/* 	 * Compare the fields the user wishes to validate. 	 */
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|lid
operator|&
name|p_node
operator|->
name|rec
operator|.
name|lid
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|lid
operator|&
name|p_rec
operator|->
name|lid
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0014: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected LID 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|lid
argument_list|,
name|p_rec
operator|->
name|lid
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|base_version
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|base_version
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|base_version
operator|&
name|p_rec
operator|->
name|node_info
operator|.
name|base_version
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0015: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected base_version 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|base_version
argument_list|,
name|p_rec
operator|->
name|node_info
operator|.
name|base_version
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|class_version
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|class_version
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|class_version
operator|&
name|p_rec
operator|->
name|node_info
operator|.
name|class_version
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0016: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected class_version 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|class_version
argument_list|,
name|p_rec
operator|->
name|node_info
operator|.
name|class_version
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|node_type
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_type
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|node_type
operator|&
name|p_rec
operator|->
name|node_info
operator|.
name|node_type
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0017: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected node_type 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_type
argument_list|,
name|p_rec
operator|->
name|node_info
operator|.
name|node_type
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|sys_guid
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|sys_guid
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|sys_guid
operator|&
name|p_rec
operator|->
name|node_info
operator|.
name|sys_guid
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0018: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected sys_guid 0x%016"
name|PRIx64
literal|", received 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|sys_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|sys_guid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|node_guid
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_guid
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|node_guid
operator|&
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0019: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected node_guid 0x%016"
name|PRIx64
literal|", received 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|port_guid
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_guid
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|port_guid
operator|&
name|p_rec
operator|->
name|node_info
operator|.
name|port_guid
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0031: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected port_guid 0x%016"
name|PRIx64
literal|", received 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|partition_cap
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|partition_cap
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|partition_cap
operator|&
name|p_rec
operator|->
name|node_info
operator|.
name|partition_cap
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0032: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected partition_cap 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|partition_cap
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|partition_cap
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|device_id
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|device_id
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|device_id
operator|&
name|p_rec
operator|->
name|node_info
operator|.
name|device_id
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0033: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected device_id 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|device_id
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|device_id
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|revision
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|revision
operator|)
operator|!=
operator|(
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|revision
operator|&
name|p_rec
operator|->
name|node_info
operator|.
name|revision
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0034: "
literal|"Field mismatch node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
literal|"\t\t\t\tExpected revision 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|revision
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|revision
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_node_rec
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
specifier|const
name|ib_node_record_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|node_t
modifier|*
name|p_node
decl_stmt|;
specifier|const
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Find proper node record in the database. 	 */
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
expr_stmt|;
name|p_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
name|p_tbl
argument_list|,
name|p_rec
operator|->
name|lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_node
operator|==
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0035: "
literal|"Unexpected node 0x%016"
name|PRIx64
literal|", LID 0x%X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmtest_validate_node_data
argument_list|(
name|p_osmt
argument_list|,
name|p_node
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_port_data
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|port_t
modifier|*
specifier|const
name|p_port
parameter_list|,
name|IN
specifier|const
name|ib_portinfo_record_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Checking port LID 0x%X, Num 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|)
expr_stmt|;
comment|/* 	 * Has this record already been returned? 	 */
if|if
condition|(
name|p_port
operator|->
name|count
operator|!=
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0036: "
literal|"Already received port LID 0x%X, Num 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|++
name|p_port
operator|->
name|count
expr_stmt|;
comment|/* 	 * Compare the fields the user wishes to validate. 	 */
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|lid
operator|&
name|p_port
operator|->
name|rec
operator|.
name|lid
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|lid
operator|&
name|p_rec
operator|->
name|lid
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0037: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected LID 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|lid
argument_list|,
name|p_rec
operator|->
name|lid
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_num
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_num
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_num
operator|&
name|p_rec
operator|->
name|port_num
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0038: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected port_num 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_num
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|m_key
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|m_key
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|m_key
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0039: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected m_key 0x%016"
name|PRIx64
literal|", received 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|m_key
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|subnet_prefix
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|subnet_prefix
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|subnet_prefix
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|subnet_prefix
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0040: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected subnet_prefix 0x%016"
name|PRIx64
literal|", received 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|subnet_prefix
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|subnet_prefix
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|base_lid
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|base_lid
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|base_lid
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|base_lid
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0041: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected base_lid 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|base_lid
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|base_lid
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|master_sm_base_lid
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|master_sm_base_lid
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|master_sm_base_lid
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|master_sm_base_lid
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0042: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected master_sm_base_lid 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|master_sm_base_lid
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|master_sm_base_lid
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|capability_mask
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|capability_mask
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|capability_mask
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|capability_mask
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0043: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected capability_mask 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|capability_mask
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|capability_mask
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|diag_code
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|diag_code
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|diag_code
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|diag_code
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0044: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected diag_code 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|diag_code
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|diag_code
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|m_key_lease_period
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key_lease_period
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|m_key_lease_period
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|m_key_lease_period
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0045: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected m_key_lease_period 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key_lease_period
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|m_key_lease_period
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|local_port_num
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|local_port_num
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|local_port_num
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|local_port_num
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0046: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected local_port_num 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|local_port_num
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|local_port_num
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_width_enabled
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_enabled
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_width_enabled
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|link_width_enabled
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0047: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected link_width_enabled 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_enabled
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|link_width_enabled
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_width_supported
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_supported
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_width_supported
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|link_width_supported
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0048: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected link_width_supported 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_supported
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|link_width_supported
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_width_active
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_active
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_width_active
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|link_width_active
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0049: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected link_width_active 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_active
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|link_width_active
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_speed
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_speed
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_speed
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|link_speed
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0054: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected link_speed 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_speed
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|link_speed
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|state_info1
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|state_info1
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|state_info1
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|state_info1
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0055: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected state_info1 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|state_info1
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|state_info1
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|state_info2
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|state_info2
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|state_info2
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|state_info2
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0058: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected state_info2 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|state_info2
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|state_info2
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mkey_lmc
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mkey_lmc
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mkey_lmc
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|mkey_lmc
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0059: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected mkey_lmc 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mkey_lmc
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|mkey_lmc
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_speed
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_speed
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_speed
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|link_speed
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0060: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected link_speed 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_speed
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|link_speed
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mtu_smsl
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mtu_smsl
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mtu_smsl
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|mtu_smsl
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0061: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected mtu_smsl 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mtu_smsl
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|mtu_smsl
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_cap
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_cap
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_cap
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|vl_cap
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0062: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected vl_cap 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_cap
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_cap
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_high_limit
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_high_limit
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_high_limit
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|vl_high_limit
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0082: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected vl_high_limit 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_high_limit
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_high_limit
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_arb_high_cap
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_arb_high_cap
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_arb_high_cap
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|vl_arb_high_cap
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0083: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected vl_arb_high_cap 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_arb_high_cap
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_arb_high_cap
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_arb_low_cap
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_arb_low_cap
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_arb_low_cap
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|vl_arb_low_cap
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0084: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected vl_arb_low_cap 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_arb_low_cap
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_arb_low_cap
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mtu_cap
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mtu_cap
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mtu_cap
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|mtu_cap
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0085: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected mtu_cap 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mtu_cap
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|mtu_cap
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|#
directive|if
literal|0
comment|/* this is a dynamic attribute */
block|if ((p_port->comp.port_info.vl_stall_life& p_port->rec.port_info. 	     vl_stall_life) != 	    (p_port->comp.port_info.vl_stall_life& p_rec->port_info. 	     vl_stall_life)) { 		OSM_LOG(&p_osmt->log, OSM_LOG_ERROR, "ERR 012F: " 			"Field mismatch port LID 0x%X Num:0x%X\n" 			"\t\t\t\tExpected vl_stall_life 0x%X, received 0x%X\n", 			cl_ntoh16(p_rec->lid), p_rec->port_num, 			p_port->rec.port_info.vl_stall_life, 			p_rec->port_info.vl_stall_life); 		status = IB_ERROR; 		goto Exit; 	}
endif|#
directive|endif
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_enforce
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_enforce
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_enforce
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|vl_enforce
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0086: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected vl_enforce 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_enforce
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|vl_enforce
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|m_key_violations
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key_violations
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|m_key_violations
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|m_key_violations
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0087: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected m_key_violations 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key_violations
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|m_key_violations
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|p_key_violations
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|p_key_violations
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|p_key_violations
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|p_key_violations
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0088: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected p_key_violations 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|p_key_violations
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|p_key_violations
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|q_key_violations
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|q_key_violations
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|q_key_violations
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|q_key_violations
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0089: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected q_key_violations 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|q_key_violations
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|port_info
operator|.
name|q_key_violations
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|guid_cap
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|guid_cap
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|guid_cap
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|guid_cap
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0090: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected guid_cap 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|guid_cap
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|guid_cap
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|subnet_timeout
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|subnet_timeout
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|subnet_timeout
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|subnet_timeout
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0091: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected subnet_timeout 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|ib_port_info_get_timeout
argument_list|(
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|)
argument_list|,
name|ib_port_info_get_timeout
argument_list|(
operator|&
name|p_rec
operator|->
name|port_info
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|resp_time_value
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|resp_time_value
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|resp_time_value
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|resp_time_value
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0092: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected resp_time_value 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|resp_time_value
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|resp_time_value
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|error_threshold
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|error_threshold
operator|)
operator|!=
operator|(
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|error_threshold
operator|&
name|p_rec
operator|->
name|port_info
operator|.
name|error_threshold
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0093: "
literal|"Field mismatch port LID 0x%X Num:0x%X\n"
literal|"\t\t\t\tExpected error_threshold 0x%X, received 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|error_threshold
argument_list|,
name|p_rec
operator|->
name|port_info
operator|.
name|error_threshold
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_port_rec
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
specifier|const
name|ib_portinfo_record_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|port_t
modifier|*
name|p_port
decl_stmt|;
specifier|const
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Find proper port record in the database. 	 * (we use by guid - since lid is not unique) 	 */
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|port_key_tbl
expr_stmt|;
name|p_port
operator|=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
name|p_tbl
argument_list|,
name|port_gen_id
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_port
operator|==
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0094: "
literal|"Unexpected port LID 0x%X, Num:0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|lid
argument_list|)
argument_list|,
name|p_rec
operator|->
name|port_num
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmtest_validate_port_data
argument_list|(
name|p_osmt
argument_list|,
name|p_port
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_path_rec
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
specifier|const
name|ib_path_rec_t
modifier|*
specifier|const
name|p_rec
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|path_t
modifier|*
name|p_path
decl_stmt|;
specifier|const
name|cl_qmap_t
modifier|*
name|p_tbl
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Find proper path record in the database. 	 */
name|p_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|path_tbl
expr_stmt|;
name|p_path
operator|=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
name|p_tbl
argument_list|,
name|osmtest_path_rec_key_get
argument_list|(
name|p_rec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_path
operator|==
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_tbl
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0095: "
literal|"Unexpected path SLID 0x%X to DLID 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|slid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|dlid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmtest_validate_path_data
argument_list|(
name|p_osmt
argument_list|,
name|p_path
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|VENDOR_RMPP_SUPPORT
end_ifdef

begin_decl_stmt
name|ib_net64_t
name|portguid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_all_node_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_node_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|size_t
name|num_recs
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all NodeRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_NODE_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0096: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %zu records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
comment|/* 	 * Compare the received records to the database. 	 */
name|osmtest_prepare_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_node_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_validate_node_rec
argument_list|(
name|p_osmt
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0097: "
literal|"osmtest_valid_node_rec failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|!
name|portguid
condition|)
name|portguid
operator|=
name|p_rec
operator|->
name|node_info
operator|.
name|port_guid
expr_stmt|;
block|}
name|status
operator|=
name|osmtest_check_missing_nodes
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0098: "
literal|"osmtest_check_missing_nodes failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_all_guidinfo_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_guidinfo_record_t
modifier|*
name|p_rec
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|size_t
name|num_recs
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all GuidInfoRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_GUIDINFO_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0099: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %zu records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
comment|/* No validation as yet */
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_all_path_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_path_rec_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|cl_status_t
name|status
decl_stmt|;
name|size_t
name|num_recs
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all PathRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_PATH_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 009A: "
literal|"osmtest_get_all_recs failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %zu records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
comment|/* 	 * Compare the received records to the database. 	 */
name|osmtest_prepare_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_path_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_validate_path_rec
argument_list|(
name|p_osmt
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0100: "
literal|"osmtest_validate_path_rec failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
name|status
operator|=
name|osmtest_check_missing_paths
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0101: "
literal|"osmtest_check_missing_paths failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Get link record by LID  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_link_rec_by_lid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|from_lid
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|to_lid
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_link_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting link record from LID 0x%02X to LID 0x%02X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|from_lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|to_lid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|from_lid
operator|=
name|from_lid
expr_stmt|;
name|record
operator|.
name|to_lid
operator|=
name|to_lid
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
if|if
condition|(
name|from_lid
condition|)
name|user
operator|.
name|comp_mask
operator||=
name|IB_LR_COMPMASK_FROM_LID
expr_stmt|;
if|if
condition|(
name|to_lid
condition|)
name|user
operator|.
name|comp_mask
operator||=
name|IB_LR_COMPMASK_TO_LID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_LINK_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 007A: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 007B: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"osmtest_get_link_rec_by_lid: "
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Get GUIDInfo record by LID  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_guidinfo_rec_by_lid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_guidinfo_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting GUIDInfo record for LID 0x%02X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_GIR_COMPMASK_LID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_GUIDINFO_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 007C: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 007D: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Get PKeyTable record by LID  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_pkeytbl_rec_by_lid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|ib_net64_t
specifier|const
name|sm_key
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_pkey_table_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting PKeyTable record for LID 0x%02X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_PKEY_COMPMASK_LID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_PKEY_TBL_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
name|sm_key
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 007E: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 007F: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Get SwitchInfo record by LID  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_sw_info_rec_by_lid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_switch_info_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting SwitchInfo record for LID 0x%02X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
if|if
condition|(
name|lid
condition|)
name|user
operator|.
name|comp_mask
operator|=
name|IB_SWIR_COMPMASK_LID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SWITCH_INFO_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 006C: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 006D: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Get LFT record by LID  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_lft_rec_by_lid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_lft_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting LFT record for LID 0x%02X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
if|if
condition|(
name|lid
condition|)
name|user
operator|.
name|comp_mask
operator|=
name|IB_LFTR_COMPMASK_LID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_LFT_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 008A: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 008B: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Get MFT record by LID  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_get_mft_rec_by_lid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_mft_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting MFT record for LID 0x%02X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
if|if
condition|(
name|lid
condition|)
name|user
operator|.
name|comp_mask
operator|=
name|IB_MFTR_COMPMASK_LID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_MFT_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 009B: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 009C: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_sminfo_record_request
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|uint8_t
name|method
parameter_list|,
name|IN
name|void
modifier|*
name|p_options
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_sminfo_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|osmtest_sm_info_rec_t
modifier|*
name|p_sm_info_opt
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for these records in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SMINFO_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|p_sm_info_opt
operator|=
name|p_options
expr_stmt|;
if|if
condition|(
name|p_sm_info_opt
operator|->
name|sm_guid
operator|!=
literal|0
condition|)
block|{
name|record
operator|.
name|sm_info
operator|.
name|guid
operator|=
name|p_sm_info_opt
operator|->
name|sm_guid
expr_stmt|;
name|user
operator|.
name|comp_mask
operator||=
name|IB_SMIR_COMPMASK_GUID
expr_stmt|;
block|}
if|if
condition|(
name|p_sm_info_opt
operator|->
name|lid
operator|!=
literal|0
condition|)
block|{
name|record
operator|.
name|lid
operator|=
name|p_sm_info_opt
operator|->
name|lid
expr_stmt|;
name|user
operator|.
name|comp_mask
operator||=
name|IB_SMIR_COMPMASK_LID
expr_stmt|;
block|}
if|if
condition|(
name|p_sm_info_opt
operator|->
name|priority
operator|!=
literal|0
condition|)
block|{
name|record
operator|.
name|sm_info
operator|.
name|pri_state
operator|=
operator|(
name|p_sm_info_opt
operator|->
name|priority
operator|&
literal|0x0F
operator|)
operator|<<
literal|4
expr_stmt|;
name|user
operator|.
name|comp_mask
operator||=
name|IB_SMIR_COMPMASK_PRIORITY
expr_stmt|;
block|}
if|if
condition|(
name|p_sm_info_opt
operator|->
name|sm_state
operator|!=
literal|0
condition|)
block|{
name|record
operator|.
name|sm_info
operator|.
name|pri_state
operator||=
name|p_sm_info_opt
operator|->
name|sm_state
operator|&
literal|0x0F
expr_stmt|;
name|user
operator|.
name|comp_mask
operator||=
name|IB_SMIR_COMPMASK_SMSTATE
expr_stmt|;
block|}
name|user
operator|.
name|method
operator|=
name|method
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 008C: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
if|if
condition|(
name|status
operator|!=
name|IB_INVALID_PARAMETER
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 008D: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_informinfo_request
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
name|attr_id
parameter_list|,
name|IN
name|uint8_t
name|method
parameter_list|,
name|IN
name|void
modifier|*
name|p_options
parameter_list|,
name|IN
name|OUT
name|osmtest_req_context_t
modifier|*
specifier|const
name|p_context
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_inform_info_t
name|rec
decl_stmt|;
name|ib_inform_info_record_t
name|record
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad
decl_stmt|;
name|osmtest_inform_info_t
modifier|*
name|p_inform_info_opt
decl_stmt|;
name|osmtest_inform_info_rec_t
modifier|*
name|p_inform_info_rec_opt
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for these records in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rec
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|p_context
operator|->
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|attr_id
expr_stmt|;
if|if
condition|(
name|attr_id
operator|==
name|IB_MAD_ATTR_INFORM_INFO_RECORD
condition|)
block|{
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|p_inform_info_rec_opt
operator|=
name|p_options
expr_stmt|;
if|if
condition|(
name|p_inform_info_rec_opt
operator|->
name|subscriber_gid
operator|.
name|unicast
operator|.
name|prefix
operator|!=
literal|0
operator|&&
name|p_inform_info_rec_opt
operator|->
name|subscriber_gid
operator|.
name|unicast
operator|.
name|interface_id
operator|!=
literal|0
condition|)
block|{
name|record
operator|.
name|subscriber_gid
operator|=
name|p_inform_info_rec_opt
operator|->
name|subscriber_gid
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_IIR_COMPMASK_SUBSCRIBERGID
expr_stmt|;
block|}
name|record
operator|.
name|subscriber_enum
operator|=
name|cl_hton16
argument_list|(
name|p_inform_info_rec_opt
operator|->
name|subscriber_enum
argument_list|)
expr_stmt|;
name|user
operator|.
name|comp_mask
operator||=
name|IB_IIR_COMPMASK_ENUM
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
block|}
else|else
block|{
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|rec
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* comp mask bits below are for InformInfoRecord rather than InformInfo */
comment|/* as currently no comp mask bits defined for InformInfo!!! */
name|user
operator|.
name|comp_mask
operator|=
name|IB_IIR_COMPMASK_SUBSCRIBE
expr_stmt|;
name|p_inform_info_opt
operator|=
name|p_options
expr_stmt|;
name|rec
operator|.
name|subscribe
operator|=
operator|(
name|uint8_t
operator|)
name|p_inform_info_opt
operator|->
name|subscribe
expr_stmt|;
if|if
condition|(
name|p_inform_info_opt
operator|->
name|qpn
condition|)
block|{
name|rec
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|qpn_resp_time_val
operator|=
name|cl_hton32
argument_list|(
name|p_inform_info_opt
operator|->
name|qpn
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|user
operator|.
name|comp_mask
operator||=
name|IB_IIR_COMPMASK_QPN
expr_stmt|;
block|}
if|if
condition|(
name|p_inform_info_opt
operator|->
name|trap
condition|)
block|{
name|rec
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
operator|=
name|cl_hton16
argument_list|(
name|p_inform_info_opt
operator|->
name|trap
argument_list|)
expr_stmt|;
name|user
operator|.
name|comp_mask
operator||=
name|IB_IIR_COMPMASK_TRAPNUMB
expr_stmt|;
block|}
name|user
operator|.
name|p_attr
operator|=
operator|&
name|rec
expr_stmt|;
block|}
name|user
operator|.
name|method
operator|=
name|method
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
name|p_context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 008E: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|p_context
operator|->
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
if|if
condition|(
name|status
operator|!=
name|IB_INVALID_PARAMETER
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 008F: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|p_mad
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_context
operator|->
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|p_mad
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_single_path_rec_lid_pair
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|path_t
modifier|*
specifier|const
name|p_path
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_path_rec_t
modifier|*
name|p_rec
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|size_t
name|num_recs
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_path_rec_by_lid_pair
argument_list|(
name|p_osmt
argument_list|,
name|p_path
operator|->
name|rec
operator|.
name|slid
argument_list|,
name|p_path
operator|->
name|rec
operator|.
name|dlid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0102: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
if|if
condition|(
name|num_recs
operator|!=
literal|1
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0103: "
literal|"Too many records. Expected 1, received %zu\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
block|}
else|else
block|{
name|p_rec
operator|=
name|osmv_get_query_path_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_validate_path_data
argument_list|(
name|p_osmt
argument_list|,
name|p_path
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0104: "
literal|"osmtest_validate_path_data failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_single_node_rec_lid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net16_t
specifier|const
name|lid
parameter_list|,
name|IN
name|node_t
modifier|*
specifier|const
name|p_node
parameter_list|)
block|{
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_node_record_t
name|record
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_node_record_t
modifier|*
name|p_rec
decl_stmt|;
name|int
name|num_recs
decl_stmt|,
name|i
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Getting NodeRecord for node with LID 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lid
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|record
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|record
argument_list|)
argument_list|)
expr_stmt|;
name|record
operator|.
name|lid
operator|=
name|lid
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_NR_COMPMASK_LID
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_NODE_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|cl_ntoh16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|record
argument_list|)
operator|>>
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|record
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0105: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0106: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %d nodes\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_node_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_validate_node_rec
argument_list|(
name|p_osmt
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0107: "
literal|"osmtest_validate_node_data failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_single_port_rec_lid
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|port_t
modifier|*
specifier|const
name|p_port
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_portinfo_record_t
modifier|*
name|p_rec
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|osmtest_get_port_rec_by_num
argument_list|(
name|p_osmt
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|lid
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_num
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0108: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* we should have got exactly one port */
name|p_rec
operator|=
name|osmv_get_query_portinfo_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_validate_port_rec
argument_list|(
name|p_osmt
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0109: "
literal|"osmtest_validate_port_data failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_single_path_rec_guid_pair
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
specifier|const
name|osmv_guid_pair_t
modifier|*
specifier|const
name|p_pair
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
specifier|const
name|ib_path_rec_t
modifier|*
name|p_rec
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|size_t
name|num_recs
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|boolean_t
name|got_error
init|=
name|FALSE
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"\n\t\t\t\tChecking src 0x%016"
name|PRIx64
literal|" to dest 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_pair
operator|->
name|src_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_pair
operator|->
name|dest_guid
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_PATH_REC_BY_PORT_GUIDS
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
name|p_pair
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0110: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0111: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"%zu records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_path_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* 		 * Make sure the GUID values are correct 		 */
if|if
condition|(
name|p_rec
operator|->
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
operator|!=
name|p_pair
operator|->
name|dest_guid
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0112: "
literal|"Destination GUID mismatch\n"
literal|"\t\t\t\texpected 0x%016"
name|PRIx64
literal|", received 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_pair
operator|->
name|dest_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|p_rec
operator|->
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
operator|!=
name|p_pair
operator|->
name|src_guid
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0113: "
literal|"Source GUID mismatch\n"
literal|"\t\t\t\texpected 0x%016"
name|PRIx64
literal|", received 0x%016"
name|PRIx64
literal|".\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_pair
operator|->
name|src_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
block|}
name|status
operator|=
name|osmtest_validate_path_rec
argument_list|(
name|p_osmt
argument_list|,
name|p_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0114: "
literal|"osmtest_validate_path_rec failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|got_error
operator|||
operator|(
name|status
operator|!=
name|IB_SUCCESS
operator|)
condition|)
block|{
name|osm_dump_path_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_single_path_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|path_t
modifier|*
name|p_path
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
specifier|const
name|cl_qmap_t
modifier|*
name|p_path_tbl
decl_stmt|;
comment|/* We skip node to node path record validation since it might contains    NONEXISTENT PATHS, i.e. when using UPDN */
name|osmv_guid_pair_t
name|guid_pair
decl_stmt|;
name|uint16_t
name|cnt
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Validating individual path record queries\n"
argument_list|)
expr_stmt|;
name|p_path_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|path_tbl
expr_stmt|;
name|osmtest_prepare_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
comment|/* 	 * Walk the list of all path records, and ask for each one 	 * specifically.  Make sure we get it. 	 */
name|cnt
operator|=
literal|0
expr_stmt|;
name|p_path
operator|=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_path_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_path
operator|!=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_path_tbl
argument_list|)
condition|)
block|{
name|status
operator|=
name|osmtest_validate_single_path_rec_lid_pair
argument_list|(
name|p_osmt
argument_list|,
name|p_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|cnt
operator|++
expr_stmt|;
name|p_path
operator|=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_path
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Total of %u path records validated using LID based query\n"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_check_missing_paths
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0115: "
literal|"osmtest_check_missing_paths failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Do the whole thing again with port GUID pairs. 	 * Note that multiple path records may be returned 	 * for each guid pair if LMC> 0. 	 */
name|osmtest_prepare_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|p_path
operator|=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_path_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_path
operator|!=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_path_tbl
argument_list|)
condition|)
block|{
name|guid_pair
operator|.
name|src_guid
operator|=
name|p_path
operator|->
name|rec
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
expr_stmt|;
name|guid_pair
operator|.
name|dest_guid
operator|=
name|p_path
operator|->
name|rec
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
expr_stmt|;
name|status
operator|=
name|osmtest_validate_single_path_rec_guid_pair
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|guid_pair
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|cnt
operator|++
expr_stmt|;
name|p_path
operator|=
operator|(
name|path_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_path
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Total of %u path records validated using GUID based query\n"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_check_missing_paths
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0116: "
literal|"osmtest_check_missing_paths failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_single_node_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|node_t
modifier|*
name|p_node
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
specifier|const
name|cl_qmap_t
modifier|*
name|p_node_lid_tbl
decl_stmt|;
name|uint16_t
name|cnt
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_node_lid_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
expr_stmt|;
name|osmtest_prepare_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Validating individual node record queries\n"
argument_list|)
expr_stmt|;
comment|/* 	 * Walk the list of all node records, and ask for each one 	 * specifically.  Make sure we get it. 	 */
name|p_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_node_lid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_node
operator|!=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_node_lid_tbl
argument_list|)
condition|)
block|{
name|status
operator|=
name|osmtest_validate_single_node_rec_lid
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|ib_net16_t
operator|)
name|cl_qmap_key
argument_list|(
operator|(
name|cl_map_item_t
operator|*
operator|)
name|p_node
argument_list|)
argument_list|,
name|p_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 011A: "
literal|"osmtest_validate_single_node_rec_lid (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|cnt
operator|++
expr_stmt|;
name|p_node
operator|=
operator|(
name|node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Total of %u node records validated\n"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_check_missing_nodes
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0117: "
literal|"osmtest_check_missing_nodes (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_single_port_recs
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|port_t
modifier|*
name|p_port
decl_stmt|;
name|cl_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
specifier|const
name|cl_qmap_t
modifier|*
name|p_port_key_tbl
decl_stmt|;
name|uint16_t
name|cnt
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_port_key_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|port_key_tbl
expr_stmt|;
name|osmtest_prepare_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Validating individual port record queries\n"
argument_list|)
expr_stmt|;
comment|/* 	 * Walk the list of all port records, and ask for each one 	 * specifically.  Make sure we get it. 	 */
name|p_port
operator|=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_port_key_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_port
operator|!=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_port_key_tbl
argument_list|)
condition|)
block|{
name|status
operator|=
name|osmtest_validate_single_port_rec_lid
argument_list|(
name|p_osmt
argument_list|,
name|p_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 011B: "
literal|"osmtest_validate_single_port_rec_lid (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|cnt
operator|++
expr_stmt|;
name|p_port
operator|=
operator|(
name|port_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Total of %u port records validated\n"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_check_missing_ports
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0118: "
literal|"osmtest_check_missing_paths failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_validate_against_db
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|ib_gid_t
name|portgid
decl_stmt|,
name|mgid
decl_stmt|;
name|osmtest_sm_info_rec_t
name|sm_info_rec_opt
decl_stmt|;
name|osmtest_inform_info_t
name|inform_info_opt
decl_stmt|;
name|osmtest_inform_info_rec_t
name|inform_info_rec_opt
decl_stmt|;
ifdef|#
directive|ifdef
name|VENDOR_RMPP_SUPPORT
name|ib_net64_t
name|sm_key
decl_stmt|;
name|ib_net16_t
name|test_lid
decl_stmt|;
name|uint8_t
name|lmc
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
ifdef|#
directive|ifdef
name|DUAL_SIDED_RMPP
name|osmv_multipath_req_t
name|request
decl_stmt|;
endif|#
directive|endif
name|uint8_t
name|i
decl_stmt|;
endif|#
directive|endif
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VENDOR_RMPP_SUPPORT
name|status
operator|=
name|osmtest_validate_all_node_recs
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
endif|#
directive|endif
name|status
operator|=
name|osmtest_validate_single_node_recs
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Exercise SA PathRecord multicast destination code */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|portgid
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
comment|/* Set IPoIB broadcast MGID */
name|mgid
operator|.
name|unicast
operator|.
name|prefix
operator|=
name|CL_HTON64
argument_list|(
literal|0xff12401bffff0000ULL
argument_list|)
expr_stmt|;
name|mgid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|CL_HTON64
argument_list|(
literal|0x00000000ffffffffULL
argument_list|)
expr_stmt|;
comment|/* Can't check status as don't know whether port is running IPoIB */
name|osmtest_get_path_rec_by_gid_pair
argument_list|(
name|p_osmt
argument_list|,
name|portgid
argument_list|,
name|mgid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
comment|/* Other link local unicast PathRecord */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|portgid
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|mgid
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|mgid
operator|.
name|raw
index|[
literal|7
index|]
operator|=
literal|0xff
expr_stmt|;
comment|/* not default GID prefix */
comment|/* Can't check status as don't know whether ??? */
name|osmtest_get_path_rec_by_gid_pair
argument_list|(
name|p_osmt
argument_list|,
name|portgid
argument_list|,
name|mgid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
comment|/* Off subnet (site local) unicast PathRecord */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|portgid
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|mgid
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|mgid
operator|.
name|raw
index|[
literal|1
index|]
operator|=
literal|0xc0
expr_stmt|;
comment|/* site local */
comment|/* Can't check status as don't know whether ??? */
name|osmtest_get_path_rec_by_gid_pair
argument_list|(
name|p_osmt
argument_list|,
name|portgid
argument_list|,
name|mgid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
comment|/* More than link local scope multicast PathRecord */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|portgid
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
comment|/* Set IPoIB broadcast MGID */
name|mgid
operator|.
name|unicast
operator|.
name|prefix
operator|=
name|CL_HTON64
argument_list|(
literal|0xff15401bffff0000ULL
argument_list|)
expr_stmt|;
comment|/* site local */
name|mgid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|CL_HTON64
argument_list|(
literal|0x00000000ffffffffULL
argument_list|)
expr_stmt|;
comment|/* Can't check status as don't know whether port is running IPoIB */
name|osmtest_get_path_rec_by_gid_pair
argument_list|(
name|p_osmt
argument_list|,
name|portgid
argument_list|,
name|mgid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VENDOR_RMPP_SUPPORT
argument_list|)
operator|&&
name|defined
argument_list|(
name|DUAL_SIDED_RMPP
argument_list|)
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|request
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|request
operator|.
name|comp_mask
operator|=
name|IB_MPR_COMPMASK_SGIDCOUNT
operator||
name|IB_MPR_COMPMASK_DGIDCOUNT
expr_stmt|;
name|request
operator|.
name|sgid_count
operator|=
literal|1
expr_stmt|;
name|request
operator|.
name|dgid_count
operator|=
literal|1
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|request
operator|.
name|gids
index|[
literal|0
index|]
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|request
operator|.
name|gids
index|[
literal|1
index|]
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_multipath_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|request
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|request
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_multipath_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|request
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Got error %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|request
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|request
operator|.
name|comp_mask
operator|=
name|IB_MPR_COMPMASK_SGIDCOUNT
expr_stmt|;
name|request
operator|.
name|sgid_count
operator|=
literal|1
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|request
operator|.
name|gids
index|[
literal|0
index|]
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_multipath_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|request
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Got error %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|request
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|request
operator|.
name|comp_mask
operator|=
name|IB_MPR_COMPMASK_SGIDCOUNT
operator||
name|IB_MPR_COMPMASK_DGIDCOUNT
expr_stmt|;
name|request
operator|.
name|sgid_count
operator|=
literal|1
expr_stmt|;
name|request
operator|.
name|dgid_count
operator|=
literal|1
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|request
operator|.
name|gids
index|[
literal|0
index|]
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
comment|/* Set IPoIB broadcast MGID as DGID */
name|request
operator|.
name|gids
index|[
literal|1
index|]
operator|.
name|unicast
operator|.
name|prefix
operator|=
name|CL_HTON64
argument_list|(
literal|0xff12401bffff0000ULL
argument_list|)
expr_stmt|;
name|request
operator|.
name|gids
index|[
literal|1
index|]
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|CL_HTON64
argument_list|(
literal|0x00000000ffffffffULL
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_multipath_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|request
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Got error %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|request
operator|.
name|comp_mask
operator|=
name|IB_MPR_COMPMASK_SGIDCOUNT
operator||
name|IB_MPR_COMPMASK_DGIDCOUNT
expr_stmt|;
name|request
operator|.
name|sgid_count
operator|=
literal|1
expr_stmt|;
name|request
operator|.
name|dgid_count
operator|=
literal|1
expr_stmt|;
comment|/* Set IPoIB broadcast MGID as SGID */
name|request
operator|.
name|gids
index|[
literal|0
index|]
operator|.
name|unicast
operator|.
name|prefix
operator|=
name|CL_HTON64
argument_list|(
literal|0xff12401bffff0000ULL
argument_list|)
expr_stmt|;
name|request
operator|.
name|gids
index|[
literal|0
index|]
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|CL_HTON64
argument_list|(
literal|0x00000000ffffffffULL
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|request
operator|.
name|gids
index|[
literal|1
index|]
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_multipath_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|request
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Got error %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|request
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|request
operator|.
name|comp_mask
operator|=
name|IB_MPR_COMPMASK_SGIDCOUNT
operator||
name|IB_MPR_COMPMASK_DGIDCOUNT
operator||
name|IB_MPR_COMPMASK_NUMBPATH
expr_stmt|;
name|request
operator|.
name|sgid_count
operator|=
literal|2
expr_stmt|;
name|request
operator|.
name|dgid_count
operator|=
literal|2
expr_stmt|;
name|request
operator|.
name|num_path
operator|=
literal|2
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|request
operator|.
name|gids
index|[
literal|0
index|]
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|request
operator|.
name|gids
index|[
literal|1
index|]
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|request
operator|.
name|gids
index|[
literal|2
index|]
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|request
operator|.
name|gids
index|[
literal|3
index|]
argument_list|,
name|portguid
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_multipath_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|request
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|VENDOR_RMPP_SUPPORT
comment|/* GUIDInfoRecords */
name|status
operator|=
name|osmtest_validate_all_guidinfo_recs
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* If LMC> 0, test non base LID SA PortInfoRecord request */
name|status
operator|=
name|osmtest_get_local_port_lmc
argument_list|(
name|p_osmt
argument_list|,
name|p_osmt
operator|->
name|local_port
operator|.
name|lid
argument_list|,
operator|&
name|lmc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|lmc
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|osmtest_get_local_port_lmc
argument_list|(
name|p_osmt
argument_list|,
name|p_osmt
operator|->
name|local_port
operator|.
name|lid
operator|+
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmtest_get_local_port_lmc
argument_list|(
name|p_osmt
argument_list|,
literal|0xffff
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|test_lid
operator|=
name|cl_ntoh16
argument_list|(
name|p_osmt
operator|->
name|local_port
operator|.
name|lid
argument_list|)
expr_stmt|;
comment|/* More GUIDInfo Record tests */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_guidinfo_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_guidinfo_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
literal|0xffff
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Some PKeyTable Record tests */
name|sm_key
operator|=
name|OSM_DEFAULT_SM_KEY
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_pkeytbl_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
name|sm_key
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_pkeytbl_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
literal|0
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Got error %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_pkeytbl_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
literal|0xffff
argument_list|,
name|sm_key
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* SwitchInfo Record tests */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_sw_info_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_sw_info_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* LFT Record tests */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_lft_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_lft_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* MFT Record tests */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_mft_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_mft_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Some LinkRecord tests */
comment|/* FromLID */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_link_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
literal|0
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* ToLID */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_link_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* FromLID& ToLID */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_link_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* NodeRecord test */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_node_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
literal|0xffff
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* SMInfoRecord tests */
name|memset
argument_list|(
operator|&
name|sm_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sm_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_sminfo_record_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|sm_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"IS EXPECTED ERROR ^^^^\n"
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|sm_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sm_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_sminfo_record_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|sm_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|memset
argument_list|(
operator|&
name|sm_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sm_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|sm_info_rec_opt
operator|.
name|lid
operator|=
name|test_lid
expr_stmt|;
comment|/* local LID */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_sminfo_record_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|sm_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|portguid
operator|!=
literal|0
condition|)
block|{
name|memset
argument_list|(
operator|&
name|sm_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sm_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|sm_info_rec_opt
operator|.
name|sm_guid
operator|=
name|portguid
expr_stmt|;
comment|/* local GUID */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_sminfo_record_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|sm_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
operator|&
name|sm_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sm_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|sm_info_rec_opt
operator|.
name|priority
operator|=
name|i
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_sminfo_record_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|sm_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
operator|&
name|sm_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sm_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|sm_info_rec_opt
operator|.
name|sm_state
operator|=
name|i
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_sminfo_record_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|sm_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
block|}
comment|/* InformInfoRecord tests */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfoRecord "
literal|"Sending a BAD - Set Unsubscribe request\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|inform_info_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|inform_info_opt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|inform_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|inform_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|inform_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"InformInfoRecord "
literal|"IS EXPECTED ERROR ^^^^\n"
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfoRecord "
literal|"Sending a Good - Empty GetTable request\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|inform_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* InformInfo tests */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo "
literal|"Sending a BAD - Empty Get request "
literal|"(should fail with NO_RECORDS)\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO
argument_list|,
name|IB_MAD_METHOD_GET
argument_list|,
operator|&
name|inform_info_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"InformInfo "
literal|"IS EXPECTED ERROR ^^^^\n"
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo "
literal|"Sending a BAD - Set Unsubscribe request\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|inform_info_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"InformInfo UnSubscribe "
literal|"IS EXPECTED ERROR ^^^^\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Now subscribe */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo "
literal|"Sending a Good - Set Subscribe request\n"
argument_list|)
expr_stmt|;
name|inform_info_opt
operator|.
name|subscribe
operator|=
name|TRUE
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|inform_info_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Now unsubscribe (QPN needs to be 1 to work) */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo "
literal|"Sending a Good - Set Unsubscribe request\n"
argument_list|)
expr_stmt|;
name|inform_info_opt
operator|.
name|subscribe
operator|=
name|FALSE
expr_stmt|;
name|inform_info_opt
operator|.
name|qpn
operator|=
literal|1
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|inform_info_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Now subscribe again */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo "
literal|"Sending a Good - Set Subscribe request\n"
argument_list|)
expr_stmt|;
name|inform_info_opt
operator|.
name|subscribe
operator|=
name|TRUE
expr_stmt|;
name|inform_info_opt
operator|.
name|qpn
operator|=
literal|1
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|inform_info_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Subscribe over existing subscription */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo "
literal|"Sending a Good - Set Subscribe (again) request\n"
argument_list|)
expr_stmt|;
name|inform_info_opt
operator|.
name|qpn
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|inform_info_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* More InformInfoRecord tests */
comment|/* RID lookup (with currently invalid enum) */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfoRecord "
literal|"Sending a Good - GetTable by GID\n"
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|inform_info_rec_opt
operator|.
name|subscriber_gid
argument_list|,
name|p_osmt
operator|->
name|local_port
operator|.
name|port_guid
argument_list|)
expr_stmt|;
name|inform_info_rec_opt
operator|.
name|subscriber_enum
operator|=
literal|1
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|inform_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Enum lookup */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfoRecord "
literal|"Sending a Good - GetTable (subscriber_enum == 0) request\n"
argument_list|)
expr_stmt|;
name|inform_info_rec_opt
operator|.
name|subscriber_enum
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|inform_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Get all InformInfoRecords */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfoRecord "
literal|"Sending a Good - GetTable (ALL records) request\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|inform_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|inform_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|inform_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Another subscription */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo "
literal|"Sending another Good - Set Subscribe (again) request\n"
argument_list|)
expr_stmt|;
name|inform_info_opt
operator|.
name|qpn
operator|=
literal|0
expr_stmt|;
name|inform_info_opt
operator|.
name|trap
operator|=
literal|0x1234
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|inform_info_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Get all InformInfoRecords again */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfoRecord "
literal|"Sending a Good - GetTable (ALL records) request\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|inform_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|inform_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|inform_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Cleanup subscriptions before further testing */
comment|/* Does order of deletion matter ? Test this !!! */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo "
literal|"Sending a Good - Set (cleanup) request\n"
argument_list|)
expr_stmt|;
name|inform_info_opt
operator|.
name|subscribe
operator|=
name|FALSE
expr_stmt|;
name|inform_info_opt
operator|.
name|qpn
operator|=
literal|1
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|inform_info_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Get all InformInfoRecords again */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfoRecord "
literal|"Sending a Good - GetTable (ALL records) request\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|inform_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|inform_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|inform_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo"
literal|"Sending a Good - Set (cleanup) request\n"
argument_list|)
expr_stmt|;
name|inform_info_opt
operator|.
name|subscribe
operator|=
name|FALSE
expr_stmt|;
name|inform_info_opt
operator|.
name|qpn
operator|=
literal|1
expr_stmt|;
name|inform_info_opt
operator|.
name|trap
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO
argument_list|,
name|IB_MAD_METHOD_SET
argument_list|,
operator|&
name|inform_info_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Get all InformInfoRecords a final time */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfoRecord "
literal|"Sending a Good - GetTable (ALL records) request\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|inform_info_rec_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|inform_info_rec_opt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_informinfo_request
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_INFORM_INFO_RECORD
argument_list|,
name|IB_MAD_METHOD_GETTABLE
argument_list|,
operator|&
name|inform_info_rec_opt
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|lmc
operator|!=
literal|0
condition|)
block|{
name|test_lid
operator|=
name|cl_ntoh16
argument_list|(
name|p_osmt
operator|->
name|local_port
operator|.
name|lid
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* Another GUIDInfo Record test */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_guidinfo_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Another PKeyTable Record test */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_pkeytbl_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
name|sm_key
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Another SwitchInfo Record test */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_sw_info_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Another LFT Record test */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_lft_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Another MFT Record test */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_mft_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* More LinkRecord tests */
comment|/* FromLID */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_link_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
literal|0
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* ToLID */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_link_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
comment|/* Another NodeRecord test */
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_node_rec_by_lid
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
block|}
comment|/* PathRecords */
if|if
condition|(
operator|!
name|p_osmt
operator|->
name|opt
operator|.
name|ignore_path_records
condition|)
block|{
name|status
operator|=
name|osmtest_validate_all_path_recs
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
name|lmc
operator|!=
literal|0
condition|)
block|{
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_path_rec_by_lid_pair
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
name|test_lid
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_path_rec_by_lid_pair
argument_list|(
name|p_osmt
argument_list|,
literal|0xffff
argument_list|,
literal|0xffff
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Got error %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_get_path_rec_by_lid_pair
argument_list|(
name|p_osmt
argument_list|,
name|test_lid
argument_list|,
literal|0xffff
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Got error %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
block|}
endif|#
directive|endif
name|status
operator|=
name|osmtest_validate_single_port_recs
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
if|if
condition|(
operator|!
name|p_osmt
operator|->
name|opt
operator|.
name|ignore_path_records
condition|)
block|{
name|status
operator|=
name|osmtest_validate_single_path_recs
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
specifier|const
name|osmtest_token_t
modifier|*
name|str_get_token
parameter_list|(
name|IN
name|char
modifier|*
specifier|const
name|p_str
parameter_list|)
block|{
specifier|const
name|osmtest_token_t
modifier|*
name|p_tok
decl_stmt|;
name|uint32_t
name|index
init|=
literal|0
decl_stmt|;
name|p_tok
operator|=
operator|&
name|token_array
index|[
name|index
index|]
expr_stmt|;
while|while
condition|(
name|p_tok
operator|->
name|val
operator|!=
name|OSMTEST_TOKEN_UNKNOWN
condition|)
block|{
if|if
condition|(
name|strnicmp
argument_list|(
name|p_str
argument_list|,
name|p_tok
operator|->
name|str
argument_list|,
name|p_tok
operator|->
name|str_size
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|p_tok
operator|)
return|;
name|p_tok
operator|=
operator|&
name|token_array
index|[
operator|++
name|index
index|]
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************    Returns true if not whitespace character encountered before EOL. **********************************************************************/
end_comment

begin_function
specifier|static
name|boolean_t
name|str_skip_white
parameter_list|(
name|IN
name|char
name|line
index|[]
parameter_list|,
name|IN
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_offset
parameter_list|)
block|{
while|while
condition|(
operator|(
operator|(
name|line
index|[
operator|*
name|p_offset
index|]
operator|==
literal|'\t'
operator|)
operator|||
operator|(
name|line
index|[
operator|*
name|p_offset
index|]
operator|==
literal|' '
operator|)
operator|)
operator|&&
operator|(
name|line
index|[
operator|*
name|p_offset
index|]
operator|!=
literal|'\n'
operator|)
operator|&&
operator|(
name|line
index|[
operator|*
name|p_offset
index|]
operator|!=
literal|'\0'
operator|)
condition|)
block|{
operator|++
operator|*
name|p_offset
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|line
index|[
operator|*
name|p_offset
index|]
operator|==
literal|'\n'
operator|)
operator|||
operator|(
name|line
index|[
operator|*
name|p_offset
index|]
operator|==
literal|'\0'
operator|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
else|else
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************    Returns true if not whitespace character encountered before EOL. **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|str_skip_token
parameter_list|(
name|IN
name|char
name|line
index|[]
parameter_list|,
name|IN
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_offset
parameter_list|)
block|{
while|while
condition|(
operator|(
name|line
index|[
operator|*
name|p_offset
index|]
operator|!=
literal|'\t'
operator|)
operator|&&
operator|(
name|line
index|[
operator|*
name|p_offset
index|]
operator|!=
literal|' '
operator|)
operator|&&
operator|(
name|line
index|[
operator|*
name|p_offset
index|]
operator|!=
literal|'\0'
operator|)
condition|)
block|{
operator|++
operator|*
name|p_offset
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_parse_node
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
specifier|const
name|fh
parameter_list|,
name|IN
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_line_num
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|char
name|line
index|[
name|OSMTEST_MAX_LINE_LEN
index|]
decl_stmt|;
name|boolean_t
name|done
init|=
name|FALSE
decl_stmt|;
name|node_t
modifier|*
name|p_node
decl_stmt|;
name|node_t
modifier|*
name|p_guid_node
decl_stmt|;
specifier|const
name|osmtest_token_t
modifier|*
name|p_tok
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_node
operator|=
name|node_new
argument_list|()
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Parse the inventory file and create the database. 	 */
while|while
condition|(
operator|!
name|done
condition|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|OSMTEST_MAX_LINE_LEN
argument_list|,
name|fh
argument_list|)
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * End of file in the middle of a definition. 			 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0119: "
literal|"Unexpected end of file\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|++
operator|*
name|p_line_num
expr_stmt|;
comment|/* 		 * Skip whitespace 		 */
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|str_skip_white
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
condition|)
continue|continue;
comment|/* whole line was whitespace */
name|p_tok
operator|=
name|str_get_token
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_tok
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0120: "
literal|"Ignoring line %u with unknown token: %s\n"
argument_list|,
operator|*
name|p_line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Found '%s' (line %u)\n"
argument_list|,
name|p_tok
operator|->
name|str
argument_list|,
operator|*
name|p_line_num
argument_list|)
expr_stmt|;
name|str_skip_token
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p_tok
operator|->
name|val
condition|)
block|{
case|case
name|OSMTEST_TOKEN_COMMENT
case|:
break|break;
case|case
name|OSMTEST_TOKEN_LID
case|:
name|p_node
operator|->
name|comp
operator|.
name|lid
operator|=
literal|0xFFFF
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|lid
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"lid = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|lid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_BASE_VERSION
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|base_version
operator|=
literal|0xFF
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|base_version
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"base_version = 0x%X\n"
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|base_version
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_CLASS_VERSION
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|class_version
operator|=
literal|0xFF
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|class_version
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"class_version = 0x%X\n"
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|class_version
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_NODE_TYPE
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|node_type
operator|=
literal|0xFF
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_type
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"node_type = 0x%X\n"
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_type
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_NUM_PORTS
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|num_ports
operator|=
literal|0xFF
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|num_ports
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"num_ports = 0x%X\n"
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|num_ports
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_SYS_GUID
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|sys_guid
operator|=
literal|0xFFFFFFFFFFFFFFFFULL
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|sys_guid
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"sys_guid = 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|sys_guid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_NODE_GUID
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|node_guid
operator|=
literal|0xFFFFFFFFFFFFFFFFULL
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_guid
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"node_guid = 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_PORT_GUID
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|port_guid
operator|=
literal|0xFFFFFFFFFFFFFFFFULL
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_guid
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"port_guid = 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_PARTITION_CAP
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|partition_cap
operator|=
literal|0xFFFF
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|partition_cap
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"partition_cap = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|partition_cap
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_DEVICE_ID
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|device_id
operator|=
literal|0xFFFF
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|device_id
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"device_id = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|device_id
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_REVISION
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|revision
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|revision
operator|=
name|cl_hton32
argument_list|(
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"revision = 0x%X\n"
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|revision
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_PORT_NUM
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|port_num_vendor_id
operator||=
name|IB_NODE_INFO_PORT_NUM_MASK
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_num_vendor_id
operator||=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"local_port_num = 0x%X\n"
argument_list|,
name|ib_node_info_get_local_port_num
argument_list|(
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_VENDOR_ID
case|:
name|p_node
operator|->
name|comp
operator|.
name|node_info
operator|.
name|port_num_vendor_id
operator||=
name|IB_NODE_INFO_VEND_ID_MASK
expr_stmt|;
name|p_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|port_num_vendor_id
operator||=
name|cl_hton32
argument_list|(
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"vendor_id = 0x%X\n"
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_node_info_get_vendor_id
argument_list|(
operator|&
name|p_node
operator|->
name|rec
operator|.
name|node_info
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_END
case|:
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0121: "
literal|"Ignoring line %u with unknown token: %s\n"
argument_list|,
operator|*
name|p_line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Make sure the user specified enough information, then 	 * add this object to the database. 	 */
if|if
condition|(
name|p_node
operator|->
name|comp
operator|.
name|lid
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0122: "
literal|"LID must be specified for defined nodes\n"
argument_list|)
expr_stmt|;
name|node_delete
argument_list|(
name|p_node
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|cl_qmap_insert
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_lid_tbl
argument_list|,
name|p_node
operator|->
name|rec
operator|.
name|lid
argument_list|,
operator|&
name|p_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|p_guid_node
operator|=
name|node_new
argument_list|()
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_node
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|p_guid_node
operator|=
operator|*
name|p_node
expr_stmt|;
name|cl_qmap_insert
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|node_guid_tbl
argument_list|,
name|p_guid_node
operator|->
name|rec
operator|.
name|node_info
operator|.
name|node_guid
argument_list|,
operator|&
name|p_guid_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_parse_port
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
specifier|const
name|fh
parameter_list|,
name|IN
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_line_num
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|char
name|line
index|[
name|OSMTEST_MAX_LINE_LEN
index|]
decl_stmt|;
name|boolean_t
name|done
init|=
name|FALSE
decl_stmt|;
name|port_t
modifier|*
name|p_port
decl_stmt|;
specifier|const
name|osmtest_token_t
modifier|*
name|p_tok
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_port
operator|=
name|port_new
argument_list|()
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_port
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Parse the inventory file and create the database. 	 */
while|while
condition|(
operator|!
name|done
condition|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|OSMTEST_MAX_LINE_LEN
argument_list|,
name|fh
argument_list|)
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * End of file in the middle of a definition. 			 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0123: "
literal|"Unexpected end of file\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|++
operator|*
name|p_line_num
expr_stmt|;
comment|/* 		 * Skip whitespace 		 */
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|str_skip_white
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
condition|)
continue|continue;
comment|/* whole line was whitespace */
name|p_tok
operator|=
name|str_get_token
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_tok
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0124: "
literal|"Ignoring line %u with unknown token: %s\n"
argument_list|,
operator|*
name|p_line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Found '%s' (line %u)\n"
argument_list|,
name|p_tok
operator|->
name|str
argument_list|,
operator|*
name|p_line_num
argument_list|)
expr_stmt|;
name|str_skip_token
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p_tok
operator|->
name|val
condition|)
block|{
case|case
name|OSMTEST_TOKEN_COMMENT
case|:
break|break;
case|case
name|OSMTEST_TOKEN_LID
case|:
name|p_port
operator|->
name|comp
operator|.
name|lid
operator|=
literal|0xFFFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|lid
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"lid = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|lid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_PORT_NUM
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_num
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_num
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"port_num = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_num
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_MKEY
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|m_key
operator|=
literal|0xFFFFFFFFFFFFFFFFULL
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"m_key = 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_SUBN_PREF
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|subnet_prefix
operator|=
literal|0xFFFFFFFFFFFFFFFFULL
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|subnet_prefix
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"subnet_prefix = 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|subnet_prefix
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_BASE_LID
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|base_lid
operator|=
literal|0xFFFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|base_lid
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"base_lid = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|base_lid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_SM_BASE_LID
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|master_sm_base_lid
operator|=
literal|0xFFFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|master_sm_base_lid
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"master_sm_base_lid = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|master_sm_base_lid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_CAP_MASK
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|capability_mask
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|capability_mask
operator|=
name|cl_hton32
argument_list|(
operator|(
name|uint32_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"capability_mask = 0x%X\n"
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|capability_mask
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_DIAG_CODE
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|diag_code
operator|=
literal|0xFFFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|diag_code
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"diag_code = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|diag_code
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_MKEY_LEASE_PER
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|m_key_lease_period
operator|=
literal|0xFFFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key_lease_period
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"m_key_lease_period = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key_lease_period
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_LOC_PORT_NUM
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|local_port_num
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|local_port_num
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"local_port_num = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|local_port_num
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_LINK_WID_EN
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_width_enabled
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_enabled
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"link_width_enabled = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_enabled
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_LINK_WID_SUP
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_width_supported
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_supported
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"link_width_supported = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_supported
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_LINK_WID_ACT
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_width_active
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_active
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"link_width_active = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_width_active
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_LINK_SPEED_SUP
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|state_info1
operator|=
literal|0xFF
expr_stmt|;
name|ib_port_info_set_link_speed_sup
argument_list|(
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"link_speed_supported = 0x%u\n"
argument_list|,
name|ib_port_info_get_link_speed_sup
argument_list|(
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_PORT_STATE
case|:
name|str_skip_white
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|state_info1
operator|=
literal|0xFF
expr_stmt|;
name|ib_port_info_set_port_state
argument_list|(
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|,
name|ib_get_port_state_from_str
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"port_state = 0x%u\n"
argument_list|,
name|ib_port_info_get_port_state
argument_list|(
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_STATE_INFO2
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|state_info2
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|state_info2
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"state_info2 = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|state_info2
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_MKEY_PROT_BITS
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mkey_lmc
operator|=
literal|0xFF
expr_stmt|;
name|ib_port_info_set_mpb
argument_list|(
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|,
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"mpb = 0x%u\n"
argument_list|,
name|ib_port_info_get_mpb
argument_list|(
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_LMC
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mkey_lmc
operator|=
literal|0xFF
expr_stmt|;
name|ib_port_info_set_lmc
argument_list|(
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|,
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"lmc = 0x%u\n"
argument_list|,
name|ib_port_info_get_lmc
argument_list|(
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_LINK_SPEED
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|link_speed
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_speed
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"link_speed = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|link_speed
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_MTU_SMSL
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mtu_smsl
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mtu_smsl
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"mtu_smsl = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mtu_smsl
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_VL_CAP
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_cap
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_cap
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"vl_cap = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_cap
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_VL_HIGH_LIMIT
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_high_limit
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_high_limit
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"vl_high_limit = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_high_limit
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_VL_ARB_HIGH_CAP
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_arb_high_cap
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_arb_high_cap
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"vl_arb_high_cap = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_arb_high_cap
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_VL_ARB_LOW_CAP
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_arb_low_cap
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_arb_low_cap
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"vl_arb_low_cap = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_arb_low_cap
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_MTU_CAP
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|mtu_cap
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mtu_cap
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"mtu_cap = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|mtu_cap
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_VL_STALL_LIFE
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_stall_life
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_stall_life
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"vl_stall_life = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_stall_life
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_VL_ENFORCE
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|vl_enforce
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_enforce
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"vl_enforce = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|vl_enforce
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_MKEY_VIOL
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|m_key_violations
operator|=
literal|0xFFFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key_violations
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"m_key_violations = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|m_key_violations
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_PKEY_VIOL
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|p_key_violations
operator|=
literal|0xFFFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|p_key_violations
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"p_key_violations = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|p_key_violations
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_QKEY_VIOL
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|q_key_violations
operator|=
literal|0xFFFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|q_key_violations
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"q_key_violations = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|q_key_violations
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_GUID_CAP
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|guid_cap
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|guid_cap
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"guid_cap = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|guid_cap
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_SUBN_TIMEOUT
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|subnet_timeout
operator|=
literal|0x1F
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|subnet_timeout
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"subnet_timeout = 0x%u\n"
argument_list|,
name|ib_port_info_get_timeout
argument_list|(
operator|&
name|p_port
operator|->
name|rec
operator|.
name|port_info
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_RESP_TIME_VAL
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|resp_time_value
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|resp_time_value
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"resp_time_value = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|resp_time_value
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_ERR_THRESHOLD
case|:
name|p_port
operator|->
name|comp
operator|.
name|port_info
operator|.
name|error_threshold
operator|=
literal|0xFF
expr_stmt|;
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|error_threshold
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"error_threshold = 0x%u\n"
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_info
operator|.
name|error_threshold
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_END
case|:
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0125: "
literal|"Ignoring line %u with unknown token: %s\n"
argument_list|,
operator|*
name|p_line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Make sure the user specified enough information, then 	 * add this object to the database. 	 */
if|if
condition|(
name|p_port
operator|->
name|comp
operator|.
name|lid
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0126: "
literal|"LID must be specified for defined ports\n"
argument_list|)
expr_stmt|;
name|port_delete
argument_list|(
name|p_port
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|cl_qmap_insert
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|port_key_tbl
argument_list|,
name|port_gen_id
argument_list|(
name|p_port
operator|->
name|rec
operator|.
name|lid
argument_list|,
name|p_port
operator|->
name|rec
operator|.
name|port_num
argument_list|)
argument_list|,
operator|&
name|p_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_parse_path
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
specifier|const
name|fh
parameter_list|,
name|IN
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_line_num
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|char
name|line
index|[
name|OSMTEST_MAX_LINE_LEN
index|]
decl_stmt|;
name|boolean_t
name|done
init|=
name|FALSE
decl_stmt|;
name|path_t
modifier|*
name|p_path
decl_stmt|;
specifier|const
name|osmtest_token_t
modifier|*
name|p_tok
decl_stmt|;
name|boolean_t
name|got_error
init|=
name|FALSE
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|p_path
operator|=
name|path_new
argument_list|()
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_path
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Parse the inventory file and create the database. 	 */
while|while
condition|(
operator|!
name|done
condition|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|OSMTEST_MAX_LINE_LEN
argument_list|,
name|fh
argument_list|)
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * End of file in the middle of a definition. 			 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0127: "
literal|"Unexpected end of file\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|++
operator|*
name|p_line_num
expr_stmt|;
comment|/* 		 * Skip whitespace 		 */
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|str_skip_white
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
condition|)
continue|continue;
comment|/* whole line was whitespace */
name|p_tok
operator|=
name|str_get_token
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_tok
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0128: "
literal|"Ignoring line %u with unknown token: %s\n"
argument_list|,
operator|*
name|p_line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
continue|continue;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Found '%s' (line %u)\n"
argument_list|,
name|p_tok
operator|->
name|str
argument_list|,
operator|*
name|p_line_num
argument_list|)
expr_stmt|;
name|str_skip_token
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p_tok
operator|->
name|val
condition|)
block|{
case|case
name|OSMTEST_TOKEN_COMMENT
case|:
break|break;
case|case
name|OSMTEST_TOKEN_DGID
case|:
name|p_path
operator|->
name|comp
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|prefix
operator|=
literal|0xFFFFFFFFFFFFFFFFULL
expr_stmt|;
name|p_path
operator|->
name|comp
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
literal|0xFFFFFFFFFFFFFFFFULL
expr_stmt|;
name|str_skip_white
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
name|p_path
operator|->
name|rec
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|prefix
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|str_skip_token
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
name|p_path
operator|->
name|rec
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"dgid = 0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|dgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_SGID
case|:
name|p_path
operator|->
name|comp
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|prefix
operator|=
literal|0xFFFFFFFFFFFFFFFFULL
expr_stmt|;
name|p_path
operator|->
name|comp
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
literal|0xFFFFFFFFFFFFFFFFULL
expr_stmt|;
name|str_skip_white
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
name|p_path
operator|->
name|rec
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|prefix
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|str_skip_token
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
name|p_path
operator|->
name|rec
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|cl_hton64
argument_list|(
name|strtoull
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"sgid = 0x%016"
name|PRIx64
literal|" 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|sgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_DLID
case|:
name|p_path
operator|->
name|comp
operator|.
name|dlid
operator|=
literal|0xFFFF
expr_stmt|;
name|p_path
operator|->
name|rec
operator|.
name|dlid
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"dlid = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|dlid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_SLID
case|:
name|p_path
operator|->
name|comp
operator|.
name|slid
operator|=
literal|0xFFFF
expr_stmt|;
name|p_path
operator|->
name|rec
operator|.
name|slid
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"slid = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|slid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_PKEY
case|:
name|p_path
operator|->
name|comp
operator|.
name|pkey
operator|=
literal|0xFFFF
expr_stmt|;
name|p_path
operator|->
name|rec
operator|.
name|pkey
operator|=
name|cl_hton16
argument_list|(
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"pkey = 0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_path
operator|->
name|rec
operator|.
name|pkey
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_END
case|:
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0129: "
literal|"Ignoring line %u with unknown token: %s\n"
argument_list|,
operator|*
name|p_line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|got_error
condition|)
block|{
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Make sure the user specified enough information, then 	 * add this object to the database. 	 */
if|if
condition|(
name|osmtest_path_rec_kay_is_valid
argument_list|(
name|p_osmt
argument_list|,
name|p_path
argument_list|)
operator|==
name|FALSE
condition|)
block|{
name|path_delete
argument_list|(
name|p_path
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|cl_qmap_insert
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|path_tbl
argument_list|,
name|osmtest_path_rec_key_get
argument_list|(
operator|&
name|p_path
operator|->
name|rec
argument_list|)
argument_list|,
operator|&
name|p_path
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_parse_link
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|FILE
modifier|*
specifier|const
name|fh
parameter_list|,
name|IN
name|OUT
name|uint32_t
modifier|*
specifier|const
name|p_line_num
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|char
name|line
index|[
name|OSMTEST_MAX_LINE_LEN
index|]
decl_stmt|;
name|boolean_t
name|done
init|=
name|FALSE
decl_stmt|;
specifier|const
name|osmtest_token_t
modifier|*
name|p_tok
decl_stmt|;
name|boolean_t
name|got_error
init|=
name|FALSE
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Parse the inventory file and create the database. 	 */
while|while
condition|(
operator|!
name|done
condition|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|OSMTEST_MAX_LINE_LEN
argument_list|,
name|fh
argument_list|)
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * End of file in the middle of a definition. 			 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 012A: "
literal|"Unexpected end of file\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|++
operator|*
name|p_line_num
expr_stmt|;
comment|/* 		 * Skip whitespace 		 */
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|str_skip_white
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
condition|)
continue|continue;
comment|/* whole line was whitespace */
name|p_tok
operator|=
name|str_get_token
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_tok
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 012B: "
literal|"Ignoring line %u with unknown token: %s\n"
argument_list|,
operator|*
name|p_line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
continue|continue;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Found '%s' (line %u)\n"
argument_list|,
name|p_tok
operator|->
name|str
argument_list|,
operator|*
name|p_line_num
argument_list|)
expr_stmt|;
name|str_skip_token
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p_tok
operator|->
name|val
condition|)
block|{
case|case
name|OSMTEST_TOKEN_FROMLID
case|:
case|case
name|OSMTEST_TOKEN_FROMPORTNUM
case|:
case|case
name|OSMTEST_TOKEN_TOPORTNUM
case|:
case|case
name|OSMTEST_TOKEN_TOLID
case|:
comment|/* For now */
break|break;
case|case
name|OSMTEST_TOKEN_END
case|:
name|done
operator|=
name|TRUE
expr_stmt|;
break|break;
default|default:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 012C: "
literal|"Ignoring line %u with unknown token: %s\n"
argument_list|,
operator|*
name|p_line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|got_error
condition|)
name|status
operator|=
name|IB_ERROR
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|osmtest_create_db
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|FILE
modifier|*
name|fh
decl_stmt|;
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|char
name|line
index|[
name|OSMTEST_MAX_LINE_LEN
index|]
decl_stmt|;
name|uint32_t
name|line_num
init|=
literal|0
decl_stmt|;
specifier|const
name|osmtest_token_t
modifier|*
name|p_tok
decl_stmt|;
name|boolean_t
name|got_error
init|=
name|FALSE
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|fh
operator|=
name|fopen
argument_list|(
name|p_osmt
operator|->
name|opt
operator|.
name|file_name
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fh
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0130: "
literal|"Unable to open inventory file (%s)\n"
argument_list|,
name|p_osmt
operator|->
name|opt
operator|.
name|file_name
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Parse the inventory file and create the database. 	 */
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
name|OSMTEST_MAX_LINE_LEN
argument_list|,
name|fh
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|line_num
operator|++
expr_stmt|;
comment|/* 		 * Skip whitespace 		 */
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|str_skip_white
argument_list|(
name|line
argument_list|,
operator|&
name|offset
argument_list|)
condition|)
continue|continue;
comment|/* whole line was whitespace */
name|p_tok
operator|=
name|str_get_token
argument_list|(
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_tok
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0131: "
literal|"Ignoring line %u: %s\n"
argument_list|,
name|line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
continue|continue;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Found '%s' (line %u)\n"
argument_list|,
name|p_tok
operator|->
name|str
argument_list|,
name|line_num
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p_tok
operator|->
name|val
condition|)
block|{
case|case
name|OSMTEST_TOKEN_COMMENT
case|:
break|break;
case|case
name|OSMTEST_TOKEN_DEFINE_NODE
case|:
name|status
operator|=
name|osmtest_parse_node
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
operator|&
name|line_num
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_DEFINE_PORT
case|:
name|status
operator|=
name|osmtest_parse_port
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
operator|&
name|line_num
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_DEFINE_PATH
case|:
name|status
operator|=
name|osmtest_parse_path
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
operator|&
name|line_num
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMTEST_TOKEN_DEFINE_LINK
case|:
name|status
operator|=
name|osmtest_parse_link
argument_list|(
name|p_osmt
argument_list|,
name|fh
argument_list|,
operator|&
name|line_num
argument_list|)
expr_stmt|;
break|break;
default|default:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0132: "
literal|"Ignoring line %u: %s\n"
argument_list|,
name|line_num
argument_list|,
operator|&
name|line
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|got_error
condition|)
name|status
operator|=
name|IB_ERROR
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0133: "
literal|"Bad status received during parsing (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fh
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
name|fclose
argument_list|(
name|fh
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************    Returns the index in the local port attribute array for the    user's selection. **********************************************************************/
end_comment

begin_function
specifier|static
name|uint32_t
name|osmtest_get_user_port
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
specifier|const
name|ib_port_attr_t
name|p_attr_array
index|[]
parameter_list|,
name|IN
name|uint32_t
specifier|const
name|num_ports
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|uint32_t
name|choice
init|=
literal|0
decl_stmt|;
name|boolean_t
name|done_flag
init|=
name|FALSE
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * User needs prompting for the local port GUID with which 	 * to bind. 	 */
while|while
condition|(
name|done_flag
operator|==
name|FALSE
condition|)
block|{
name|printf
argument_list|(
literal|"\nChoose a local port number with which to bind:\n\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
comment|/* 			 * Print the index + 1 since by convention, port numbers 			 * start with 1 on host channel adapters. 			 */
name|printf
argument_list|(
literal|"\t%u: GUID = 0x%8"
name|PRIx64
literal|", lid = 0x%04X, state = %s\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_attr_array
index|[
name|i
index|]
operator|.
name|port_guid
argument_list|)
argument_list|,
name|p_attr_array
index|[
name|i
index|]
operator|.
name|lid
argument_list|,
name|ib_get_port_state_str
argument_list|(
name|p_attr_array
index|[
name|i
index|]
operator|.
name|link_state
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\nEnter choice (1-%u): "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|scanf
argument_list|(
literal|"%u"
argument_list|,
operator|&
name|choice
argument_list|)
expr_stmt|;
if|if
condition|(
name|choice
operator|>
name|num_ports
condition|)
name|printf
argument_list|(
literal|"\nError: Lame choice!\n"
argument_list|)
expr_stmt|;
else|else
name|done_flag
operator|=
name|TRUE
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|choice
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_bind
parameter_list|(
name|IN
name|osmtest_t
modifier|*
name|p_osmt
parameter_list|,
name|IN
name|uint16_t
name|max_lid
parameter_list|,
name|IN
name|ib_net64_t
name|guid
name|OPTIONAL
parameter_list|)
block|{
name|uint32_t
name|port_index
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|uint32_t
name|num_ports
init|=
name|GUID_ARRAY_SIZE
decl_stmt|;
name|ib_port_attr_t
name|attr_array
index|[
name|GUID_ARRAY_SIZE
index|]
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Call the transport layer for a list of local port 	 * GUID values. 	 */
name|status
operator|=
name|osm_vendor_get_all_port_attr
argument_list|(
name|p_osmt
operator|->
name|p_vendor
argument_list|,
name|attr_array
argument_list|,
operator|&
name|num_ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0134: "
literal|"Failure getting local port attributes (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|guid
operator|==
literal|0
condition|)
block|{
comment|/* 		 * User needs prompting for the local port GUID with which 		 * to bind. 		 */
name|port_index
operator|=
name|osmtest_get_user_port
argument_list|(
name|p_osmt
argument_list|,
name|attr_array
argument_list|,
name|num_ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_ports
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0135: "
literal|"No local ports.  Unable to proceed\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|guid
operator|=
name|attr_array
index|[
name|port_index
index|]
operator|.
name|port_guid
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|port_index
operator|=
literal|0
init|;
name|port_index
operator|<
name|num_ports
condition|;
name|port_index
operator|++
control|)
block|{
if|if
condition|(
name|attr_array
index|[
name|port_index
index|]
operator|.
name|port_guid
operator|==
name|guid
condition|)
break|break;
block|}
if|if
condition|(
name|port_index
operator|==
name|num_ports
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0136: "
literal|"No local port with guid 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|guid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_NOT_FOUND
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
comment|/* 	 * Copy the port info for the selected port. 	 */
name|memcpy
argument_list|(
operator|&
name|p_osmt
operator|->
name|local_port
argument_list|,
operator|&
name|attr_array
index|[
name|port_index
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|p_osmt
operator|->
name|local_port
argument_list|)
argument_list|)
expr_stmt|;
comment|/* bind to the SA */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Using port with SM LID:0x%04X\n"
argument_list|,
name|p_osmt
operator|->
name|local_port
operator|.
name|sm_lid
argument_list|)
expr_stmt|;
name|p_osmt
operator|->
name|max_lid
operator|=
name|max_lid
expr_stmt|;
name|p_osmt
operator|->
name|h_bind
operator|=
name|osmv_bind_sa
argument_list|(
name|p_osmt
operator|->
name|p_vendor
argument_list|,
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_osmt
operator|->
name|h_bind
operator|==
name|OSM_BIND_INVALID_HANDLE
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0137: "
literal|"Unable to bind to SA\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmtest_run
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmtest_validate_sa_class_port_info
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0138: "
literal|"Could not obtain SA ClassPortInfo (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_CREATE_INVENTORY
condition|)
block|{
comment|/* 		 * Creating an inventory file with all nodes, ports and paths 		 */
name|status
operator|=
name|osmtest_create_inventory_file
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0139: "
literal|"Inventory file create failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_STRESS_SA
condition|)
block|{
comment|/* 			 * Stress SA - flood the SA with queries 			 */
switch|switch
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|stress
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
comment|/* small response SA query stress */
name|status
operator|=
name|osmtest_stress_small_rmpp
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0140: "
literal|"Small RMPP stress test failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
break|break;
case|case
literal|2
case|:
comment|/* large response SA query stress */
name|status
operator|=
name|osmtest_stress_large_rmpp
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0141: "
literal|"Large RMPP stress test failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
break|break;
case|case
literal|3
case|:
comment|/* large response Path Record SA query stress */
name|status
operator|=
name|osmtest_create_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0142: "
literal|"Database creation failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmtest_stress_large_rmpp_pr
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0143: "
literal|"Large RMPP stress test failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
break|break;
default|default:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0144: "
literal|"Unknown stress test value %u\n"
argument_list|,
name|p_osmt
operator|->
name|opt
operator|.
name|stress
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
comment|/* 			 * Run normal validation tests. 			 */
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_ALL
operator|||
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_VALIDATE_INVENTORY
condition|)
block|{
comment|/* 				 * Only validate the given inventory file 				 */
name|status
operator|=
name|osmtest_create_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0145: "
literal|"Database creation failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmtest_validate_against_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0146: "
literal|"SA validation database failure (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_ALL
condition|)
block|{
name|status
operator|=
name|osmtest_wrong_sm_key_ignored
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0147: "
literal|"Try wrong SM_Key failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_ALL
operator|||
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_SERVICE_REGISTRATION
condition|)
block|{
comment|/* 				 * run service registration, deregistration, and lease test 				 */
name|status
operator|=
name|osmt_run_service_records_flow
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0148: "
literal|"Service Flow failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_ALL
operator|||
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_EVENT_FORWARDING
condition|)
block|{
comment|/* 				 * Run event forwarding test 				 */
ifdef|#
directive|ifdef
name|OSM_VENDOR_INTF_MTL
name|status
operator|=
name|osmt_run_inform_info_flow
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0149: "
literal|"Inform Info Flow failed: (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
else|#
directive|else
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"The event forwarding flow "
literal|"is not implemented yet!\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
goto|goto
name|Exit
goto|;
endif|#
directive|endif
block|}
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_QOS
condition|)
block|{
comment|/* 				 * QoS info: dump VLArb and SLtoVL tables. 				 * Since it generates a huge file, we run it only 				 * if explicitly required to 				 */
name|status
operator|=
name|osmtest_create_db
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 014A: "
literal|"Database creation failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmt_run_slvl_and_vlarb_records_flow
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0150: "
literal|"Failed to get SLtoVL and VL Arbitration Tables (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_TRAP
condition|)
block|{
comment|/* 				 * Run trap 64/65 flow (this flow requires running of external tool) 				 */
ifdef|#
directive|ifdef
name|OSM_VENDOR_INTF_MTL
name|status
operator|=
name|osmt_run_trap64_65_flow
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0151: "
literal|"Trap 64/65 Flow failed: (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
else|#
directive|else
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"The event forwarding flow "
literal|"is not implemented yet!\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
goto|goto
name|Exit
goto|;
endif|#
directive|endif
block|}
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_ALL
operator|||
name|p_osmt
operator|->
name|opt
operator|.
name|flow
operator|==
name|OSMT_FLOW_MULTICAST
condition|)
block|{
comment|/* 				 * Multicast flow 				 */
name|status
operator|=
name|osmt_run_mcast_flow
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0152: "
literal|"Multicast Flow failed: (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"\n\n***************** ALL TESTS PASS *****************\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

end_unit


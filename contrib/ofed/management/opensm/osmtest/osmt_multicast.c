begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006-2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2005 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  * 	Implementation of Multicast Member testing flow..  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__WIN__
end_ifndef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_map.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_list.h>
end_include

begin_include
include|#
directive|include
file|"osmtest.h"
end_include

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|__osmt_print_all_multicast_records
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_member_rec_t
modifier|*
name|mcast_record
decl_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_MCMEMBER_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mcast_record
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
literal|1
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
comment|/* UnTrusted (SMKey of 0)  - get the multicast groups */
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
operator|||
name|context
operator|.
name|result
operator|.
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02B5: "
literal|"Failed getting the multicast groups records - %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|context
operator|.
name|result
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|osm_log
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"\n                    |------------------------------------------|"
literal|"\n                    |        Remaining Multicast Groups        |"
literal|"\n                    |------------------------------------------|\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|context
operator|.
name|result
operator|.
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|mcast_record
operator|=
name|osmv_get_query_mc_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osm_dump_mc_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|mcast_record
argument_list|,
name|OSM_LOG_INFO
argument_list|)
expr_stmt|;
block|}
comment|/* Trusted - now get the multicast group members */
name|req
operator|.
name|sm_key
operator|=
name|OSM_DEFAULT_SM_KEY
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
operator|||
name|context
operator|.
name|result
operator|.
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02B6: "
literal|"Failed getting the multicast group members records - %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|context
operator|.
name|result
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|osm_log
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"\n                    |--------------------------------------------------|"
literal|"\n                    |        Remaining Multicast Group Members        |"
literal|"\n                    |--------------------------------------------------|\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|context
operator|.
name|result
operator|.
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|mcast_record
operator|=
name|osmv_get_query_mc_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|osm_dump_mc_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|mcast_record
argument_list|,
name|OSM_LOG_INFO
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
specifier|static
name|cl_status_t
name|__match_mgids
parameter_list|(
name|IN
specifier|const
name|void
modifier|*
specifier|const
name|p_object
parameter_list|,
name|IN
name|void
modifier|*
name|context
parameter_list|)
block|{
name|ib_gid_t
modifier|*
name|p_mgid_context
init|=
operator|(
name|ib_gid_t
operator|*
operator|)
name|context
decl_stmt|;
name|ib_gid_t
modifier|*
name|p_mgid_list_item
init|=
operator|(
name|ib_gid_t
operator|*
operator|)
name|p_object
decl_stmt|;
name|int32_t
name|count
decl_stmt|;
name|count
operator|=
name|memcmp
argument_list|(
name|p_mgid_context
argument_list|,
name|p_mgid_list_item
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
return|return
name|CL_SUCCESS
return|;
else|else
return|return
name|CL_NOT_FOUND
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_query_mcast
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_member_rec_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|i
decl_stmt|,
name|num_recs
init|=
literal|0
decl_stmt|;
name|cl_list_t
name|mgids_list
decl_stmt|;
name|cl_list_t
modifier|*
name|p_mgids_list
decl_stmt|;
name|cl_list_iterator_t
name|p_mgids_res
decl_stmt|;
name|cl_status_t
name|cl_status
decl_stmt|;
name|cl_map_item_t
modifier|*
name|p_item
decl_stmt|,
modifier|*
name|p_next_item
decl_stmt|;
name|osmtest_mgrp_t
modifier|*
name|p_mgrp
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all Multicast Records in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_MCMEMBER_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_member_rec_t
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0203: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0264: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s.\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
comment|/* ok we have got something */
comment|/* First Delete the old MGID Table */
name|p_next_item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|)
condition|)
block|{
name|p_item
operator|=
name|p_next_item
expr_stmt|;
name|p_next_item
operator|=
name|cl_qmap_next
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
name|cl_qmap_remove_item
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|,
name|p_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
block|}
name|cl_list_construct
argument_list|(
operator|&
name|mgids_list
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|mgids_list
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|p_mgids_list
operator|=
operator|&
name|mgids_list
expr_stmt|;
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %u records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_result
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|p_mgids_res
operator|=
name|cl_list_find_from_head
argument_list|(
name|p_mgids_list
argument_list|,
name|__match_mgids
argument_list|,
operator|&
operator|(
name|p_rec
operator|->
name|mgid
operator|)
argument_list|)
expr_stmt|;
comment|/* If returns iterator other than end of list, same mgid exists already */
if|if
condition|(
name|p_mgids_res
operator|!=
name|cl_list_end
argument_list|(
name|p_mgids_list
argument_list|)
condition|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0265: "
literal|"MCG MGIDs are the same - invalid MGID : %s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|osm_dump_mc_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
name|cl_status
operator|=
name|cl_list_insert_head
argument_list|(
name|p_mgids_list
argument_list|,
operator|&
operator|(
name|p_rec
operator|->
name|mgid
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl_status
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0205: "
literal|"Could not add MGID to cl_list\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_mgrp
operator|=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p_mgrp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_mgrp
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0204: "
literal|"Could not allocate new MCG\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|memcpy
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcmember_rec
argument_list|,
name|p_rec
argument_list|,
sizeof|sizeof
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
argument_list|)
argument_list|)
expr_stmt|;
name|cl_qmap_insert
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_rec
operator|->
name|mlid
argument_list|)
argument_list|,
operator|&
name|p_mgrp
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_comment
comment|/* given a multicast request send and wait for response. */
end_comment

begin_function
name|ib_api_status_t
name|osmt_send_mcast_request
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|uint8_t
name|is_set
parameter_list|,
name|IN
name|ib_member_rec_t
modifier|*
name|p_mc_req
parameter_list|,
name|IN
name|uint64_t
name|comp_mask
parameter_list|,
name|OUT
name|ib_sa_mad_t
modifier|*
name|p_res
parameter_list|)
block|{
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_res
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_sa_mad_t
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
name|p_mc_req
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|comp_mask
expr_stmt|;
if|if
condition|(
name|is_set
operator|==
literal|1
condition|)
block|{
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_UD_MULTICAST_SET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_set
operator|==
literal|0
condition|)
block|{
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_UD_MULTICAST_DELETE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_set
operator|==
literal|0xee
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Set USER DEFINED QUERY\n"
argument_list|)
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|user
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_MCMEMBER_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_member_rec_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_set
operator|==
literal|0xff
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Set USER DEFINED QUERY\n"
argument_list|)
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|user
operator|.
name|method
operator|=
name|IB_MAD_METHOD_SET
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_MCMEMBER_RECORD
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_member_rec_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* TODO : Check the validity of all user fields in order to use 	   OSMV_QUERY_USER_DEFINED 	   p_user_query = ( osmv_user_query_t * ) p_query_req->p_query_input; 	   if (p_user_query->method) sa_mad_data.method = p_user_query->method; 	   sa_mad_data.attr_offset = p_user_query->attr_offset; 	   sa_mad_data.attr_id = p_user_query->attr_id; 	   sa_mad_data.comp_mask = p_user_query->comp_mask; 	   sa_mad_data.p_attr = p_user_query->p_attr; 	 */
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0206: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* ok it worked */
name|memcpy
argument_list|(
name|p_res
argument_list|,
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_sa_mad_t
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0224: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|Exit
label|:
comment|/* 	 * Return the IB query MAD to the pool as necessary. 	 */
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|void
name|osmt_init_mc_query_rec
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|OUT
name|ib_member_rec_t
modifier|*
name|p_mc_req
parameter_list|)
block|{
comment|/* use default values so we can change only what we want later */
name|memset
argument_list|(
name|p_mc_req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_member_rec_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* we leave the MGID to the user */
name|memcpy
argument_list|(
operator|&
name|p_mc_req
operator|->
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|,
operator|&
name|p_osmt
operator|->
name|local_port
operator|.
name|port_guid
argument_list|,
sizeof|sizeof
argument_list|(
name|p_osmt
operator|->
name|local_port
operator|.
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  use our own subnet prefix: */
name|p_mc_req
operator|->
name|port_gid
operator|.
name|unicast
operator|.
name|prefix
operator|=
name|CL_HTON64
argument_list|(
literal|0xFE80000000000000ULL
argument_list|)
expr_stmt|;
comment|/*  ib_net32_t  qkey; */
comment|/*  ib_net16_t  mlid; - we keep it zero for upper level to decide. */
comment|/*  uint8_t     mtu; - keep it zero means - anything you have please. */
comment|/*  uint8_t     tclass; can leave as zero for now (between subnets) */
comment|/*  ib_net16_t  pkey; leave as zero */
name|p_mc_req
operator|->
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_4X
expr_stmt|;
comment|/*  uint8_t     pkt_life; zero means greater than zero ... */
comment|/*  ib_net32_t  sl_flow_hop; keep it all zeros */
comment|/*  we want to use a link local scope: 0x02 */
name|p_mc_req
operator|->
name|scope_state
operator|=
name|ib_member_set_scope_state
argument_list|(
literal|0x02
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***********************************************************************  * UD Multicast testing flow:  * o15.0.1.3:  * - Request new MCG with not enough components in comp_mask :  *   ERR_INSUFFICIENT_COMPONENTS  * o15.0.1.8:  * - Request a join with irrelevant RATE and get a ERR_INVALID_REQ  * o15.0.1.4:  * - Create an MGID by asking for a join with MGID = 0  *   providing P_Key, Q_Key, SL, FlowLabel, Tclass.  * o15.0.1.5:  * - Check the returned MGID is valid. (p 804)  * o15.0.1.6:  * - Create a new MCG with valid requested MGID.  * - Try to create a new MCG with invalid MGID : get back ERR_REQ_INVALID  * - Try again with MGID prefix = 0xA01B (maybe 0x1BA0 little or big ?)  * - Try to create again the already created group: ERR_REQ_INVALID  * o15.0.1.7 - implicitlly checked during the prev steps.  * o15.0.1.9  * - Create MCG with Invalid JoinState.FullMember != 1 : get ERR_REQ_INVALID  * o15.0.1.10 - can't check on a single client .  * o15.0.1.11:  * - Try to join into a MGID that exists with JoinState=SendOnlyMember -  *   see that it updates JoinState. What is the routing change?  * - We can not check simple join since we have only one tester (for now)  * o15.0.1.12:  * - The last join should have a special treatment in the SA (sender only)  *   but what is it ?  * o15.0.1.13:  * - Try joining with wrong rate - ERR_REQ_INVALID  * o15.0.1.14:  * - Try partial delete - actually updating the join state. check it.  * - Register by InformInfo flow to receive trap 67 on MCG delete.  * - Try full delete (JoinState and should be 0)  * - Wait for trap 67.  * - Try joining (not full mem) again to see the group was deleted.  *   (should fail - o15.0.1.13)  * o15.0.1.15:  * - Try deletion of the IPoIB MCG and get: ERR_REQ_INVALID  * o15.0.1.16:  * - Try GetTable with PortGUID wildcarded and get back some groups.  ***********************************************************************/
end_comment

begin_comment
comment|/* The following macro can be used only within the osmt_run_mcast_flow() function */
end_comment

begin_define
define|#
directive|define
name|IS_IPOIB_MGID
parameter_list|(
name|p_mgid
parameter_list|)
define|\
value|( !memcmp(&osm_ipoib_good_mgid,    (p_mgid), sizeof(osm_ipoib_good_mgid)) || \              !memcmp(&osm_ts_ipoib_good_mgid, (p_mgid), sizeof(osm_ts_ipoib_good_mgid)) )
end_define

begin_function
name|ib_api_status_t
name|osmt_run_mcast_flow
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|gid_str2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|ib_member_rec_t
name|mc_req_rec
decl_stmt|;
name|ib_member_rec_t
modifier|*
name|p_mc_res
decl_stmt|;
name|ib_sa_mad_t
name|res_sa_mad
decl_stmt|;
name|uint64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|ib_net64_t
name|remote_port_guid
init|=
literal|0x0
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_mgrp_mlid_tbl
decl_stmt|;
name|osmtest_mgrp_t
modifier|*
name|p_mgrp
decl_stmt|;
name|ib_gid_t
name|special_mgid
decl_stmt|,
name|tmp_mgid
decl_stmt|,
name|proxy_mgid
decl_stmt|;
name|ib_net16_t
name|invalid_mlid
init|=
literal|0x0
decl_stmt|;
name|ib_net16_t
name|max_mlid
init|=
name|cl_hton16
argument_list|(
literal|0xFFFE
argument_list|)
decl_stmt|,
name|tmp_mlid
decl_stmt|;
name|boolean_t
name|ReachedMlidLimit
init|=
name|FALSE
decl_stmt|;
name|int
name|start_cnt
init|=
literal|0
decl_stmt|,
name|cnt
decl_stmt|,
name|middle_cnt
init|=
literal|0
decl_stmt|,
name|end_cnt
init|=
literal|0
decl_stmt|;
name|int
name|start_ipoib_cnt
init|=
literal|0
decl_stmt|,
name|end_ipoib_cnt
init|=
literal|0
decl_stmt|;
name|int
name|mcg_outside_test_cnt
init|=
literal|0
decl_stmt|,
name|fail_to_delete_mcg
init|=
literal|0
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_node_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|uint8_t
name|mtu_phys
init|=
literal|0
decl_stmt|,
name|rate_phys
init|=
literal|0
decl_stmt|;
name|cl_map_t
name|test_created_mlids
decl_stmt|;
comment|/* List of all mlids created in this test */
name|ib_member_rec_t
modifier|*
name|p_recvd_rec
decl_stmt|;
name|boolean_t
name|got_error
init|=
name|FALSE
decl_stmt|;
specifier|static
name|ib_gid_t
name|good_mgid
init|=
block|{
block|{
literal|0xFF
block|,
literal|0x12
block|,
literal|0xA0
block|,
literal|0x1C
block|,
literal|0xFE
block|,
literal|0x80
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x12
block|,
literal|0x34
block|,
literal|0x56
block|,
literal|0x78
block|}
block|}
decl_stmt|;
specifier|static
name|ib_gid_t
name|osm_ipoib_mgid
init|=
block|{
block|{
literal|0xff
block|,
comment|/* multicast field */
literal|0x12
block|,
comment|/* scope */
literal|0x40
block|,
literal|0x1b
block|,
comment|/* IPv4 signature */
literal|0xff
block|,
literal|0xff
block|,
comment|/* 16 bits of P_Key (to be filled in) */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* 48 bits of zeros */
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xee
block|,
comment|/* 32 bit IPv4 broadcast address */
block|}
block|, 	}
decl_stmt|;
specifier|static
name|ib_gid_t
name|osm_ts_ipoib_good_mgid
init|=
block|{
block|{
literal|0xff
block|,
comment|/* multicast field */
literal|0x12
block|,
comment|/* non-permanent bit,scope */
literal|0x40
block|,
literal|0x1b
block|,
comment|/* IPv4 signature */
literal|0xff
block|,
literal|0xff
block|,
comment|/* 16 bits of P_Key (to be filled in) */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* 48 bits of zeros */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x01
block|,
comment|/* 32 bit IPv4 broadcast address */
block|}
block|, 	}
decl_stmt|;
specifier|static
name|ib_gid_t
name|osm_ipoib_good_mgid
init|=
block|{
block|{
literal|0xff
block|,
comment|/* multicast field */
literal|0x12
block|,
comment|/* non-permanent bit,scope */
literal|0x40
block|,
literal|0x1b
block|,
comment|/* IPv4 signature */
literal|0xff
block|,
literal|0xff
block|,
comment|/* 16 bits of P_Key (to be filled in) */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* 48 bits of zeros */
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
comment|/* 32 bit IPv4 broadcast address */
block|}
block|, 	}
decl_stmt|;
specifier|static
name|ib_gid_t
name|osm_link_local_mgid
init|=
block|{
block|{
literal|0xFF
block|,
literal|0x02
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x01
block|}
block|, 	}
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"GetTable of all current MCGs...\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_query_mcast
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 2FF "
literal|"GetTable of all records has failed!\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Initialize the test_created_mgrps map */
name|cl_map_construct
argument_list|(
operator|&
name|test_created_mlids
argument_list|)
expr_stmt|;
name|cl_map_init
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
name|p_mgrp_mlid_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
expr_stmt|;
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
comment|/* Only when we are on single mode check flow - do the count comparison, otherwise skip */
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|mmode
operator|==
literal|1
operator|||
name|p_osmt
operator|->
name|opt
operator|.
name|mmode
operator|==
literal|3
condition|)
block|{
name|start_cnt
operator|=
name|cl_qmap_count
argument_list|(
name|p_mgrp_mlid_tbl
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"(start): "
literal|"Number of MC Records found in SA DB is %d\n"
argument_list|,
name|start_cnt
argument_list|)
expr_stmt|;
block|}
comment|/* This flow is being added due to bug discovered using SilverStorm stack - 	   The bug was initializing MCast with MTU& RATE min values that do 	   not match the subnet capability, even though that OpenSM 	   reponds with the correct value it does not store it in the MCG. 	   We want the check a join request to already existing group (ipoib) 	   without using MTU or RATE then getting response from OpenSM with 	   the correct values then join again with them and get IB_SUCCESS 	   all the way 	 */
comment|/* First validate IPoIB exist in the SA DB */
name|p_mgrp
operator|=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_mgrp_mlid_tbl
argument_list|)
expr_stmt|;
comment|/* scan all available multicast groups in the DB and fill in the table */
while|while
condition|(
name|p_mgrp
operator|!=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_mgrp_mlid_tbl
argument_list|)
condition|)
block|{
comment|/* search for ipoib mgid */
if|if
condition|(
name|IS_IPOIB_MGID
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
argument_list|)
condition|)
block|{
name|start_ipoib_cnt
operator|++
expr_stmt|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Non-IPoIB MC Groups exist: mgid=%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
name|mcg_outside_test_cnt
operator|++
expr_stmt|;
block|}
name|p_mgrp
operator|=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_mgrp
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Found %d non-IPoIB MC Groups\n"
argument_list|,
name|mcg_outside_test_cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|start_ipoib_cnt
condition|)
block|{
comment|/* o15-0.2.4 - Check a join request to already created MCG */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Found IPoIB MC Group, so we run SilverStorm Bug Flow...\n"
argument_list|)
expr_stmt|;
comment|/* Try to join first like IPoIB of SilverStorm */
name|memcpy
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
operator|&
name|osm_ipoib_good_mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0xff
argument_list|,
comment|/* User Defined query Set */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Joining an existing IPoIB multicast group\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Sent Join request with :\n\t\tport_gid=%s, mgid=%s\n"
literal|"\t\tjoin state= 0x%x, response is : %s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mc_req_rec
operator|.
name|port_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
operator|(
name|mc_req_rec
operator|.
name|scope_state
operator|&
literal|0x0F
operator|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02B3: "
literal|"Failed joining existing IPoIB MCGroup - got %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Check MTU& Rate Value and resend with SA suggested values */
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
comment|/* Prepare the mc_req_rec for the rest of the flow */
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
comment|/* 		   We simulate the same situation as in SilverStorm - a response with the 		   exact RATE& MTU as the SA responded with. Actually the query 		   has included some more fields but we know that problem was 		   genereated by the RATE 		 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Received attributes of MCG : \n\t\tMTU=0x%02X, RATE=0x%02X\n"
argument_list|,
name|p_mc_res
operator|->
name|mtu
argument_list|,
name|p_mc_res
operator|->
name|rate
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mtu
operator|=
name|p_mc_res
operator|->
name|mtu
expr_stmt|;
name|mc_req_rec
operator|.
name|rate
operator|=
name|p_mc_res
operator|->
name|rate
expr_stmt|;
comment|/* Set feasible mtu& rate that will allow check the 		   exact statement of OpenSM */
name|mtu_phys
operator|=
name|p_mc_res
operator|->
name|mtu
expr_stmt|;
name|rate_phys
operator|=
name|p_mc_res
operator|->
name|rate
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
operator|&
name|osm_ipoib_good_mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
operator||
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Sending attributes of MCG : \n\t\tMTU=0x%02X, RATE=0x%02X\n"
argument_list|,
name|mc_req_rec
operator|.
name|mtu
argument_list|,
name|mc_req_rec
operator|.
name|rate
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0xff
argument_list|,
comment|/* User Defined query */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Sent Join request using response values, response is : %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02EF: "
literal|"Query as Full Member of already existing "
literal|"ipoib group gid %s has failed\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* We do not want to leave the MCG since its IPoIB */
block|}
comment|/**************************************************************************/
comment|/* Check Get with invalid mlid */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Get with invalid mlid...\n"
argument_list|)
expr_stmt|;
comment|/* Request Get */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mlid
operator|=
name|invalid_mlid
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MLID
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0xee
argument_list|,
comment|/* User Defined query Get */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 2E0 "
literal|"SubnAdmGet with invalid mlid 0x%x succeeded\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|mc_req_rec
operator|.
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Prepare the mc_req_rec for the rest of the flow */
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
comment|/**************************************************************************/
comment|/* Check Get with invalid port guid */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Get with invalid port guid (0x0) but valid interface ID : 0x%"
name|PRIx64
literal|"...\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|mc_req_rec
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Get */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_net64_t
argument_list|)
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0xee
argument_list|,
comment|/* User Defined query Get */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 2E4 "
literal|"SubnAdmGet with invalid port guid succeeded\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Prepare the mc_req_rec for the rest of the flow */
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
comment|/**************************************************************************/
comment|/* o15.0.1.3:  */
comment|/* - Request Join with insufficient comp_mask */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with insufficient comp mask qkey& pkey (o15.0.1.3)...\n"
argument_list|)
expr_stmt|;
comment|/* no MGID */
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
comment|/* IB_MCR_COMPMASK_QKEY |  */
comment|/* IB_MCR_COMPMASK_PKEY | intentionaly missed to raise the error */
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
operator|(
call|(
name|ib_net16_t
call|)
argument_list|(
name|res_sa_mad
operator|.
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
operator|)
operator|!=
name|IB_SA_MAD_STATUS_INSUF_COMPS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02EE: "
literal|"Expectedd REMOTE ERROR IB_SA_MAD_STATUS_INSUF_COMPS got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with insufficient comp mask - sl (15.0.1.3)...\n"
argument_list|)
expr_stmt|;
comment|/* no MGID */
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
comment|/* IB_MCR_COMPMASK_SL |  */
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
operator|(
call|(
name|ib_net16_t
call|)
argument_list|(
name|res_sa_mad
operator|.
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
operator|)
operator|!=
name|IB_SA_MAD_STATUS_INSUF_COMPS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02ED: "
literal|"Expectedd REMOTE ERROR IB_SA_MAD_STATUS_INSUF_COMPS got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
comment|/* no MGID */
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|15
index|]
operator|=
literal|0x01
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with insufficient comp mask - flow label (o15.0.1.3)...\n"
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
comment|/* IB_MCR_COMPMASK_FLOW | intentionaly missed to raise the error */
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
operator|(
call|(
name|ib_net16_t
call|)
argument_list|(
name|res_sa_mad
operator|.
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
operator|)
operator|!=
name|IB_SA_MAD_STATUS_INSUF_COMPS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02EC: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_INSUF_COMPS got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with insufficient comp mask - tclass (o15.0.1.3)...\n"
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
comment|/* IB_MCR_COMPMASK_TCLASS |  Intentionally missed to raise an error */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
operator|(
call|(
name|ib_net16_t
call|)
argument_list|(
name|res_sa_mad
operator|.
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
operator|)
operator|!=
name|IB_SA_MAD_STATUS_INSUF_COMPS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02EA: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_INSUF_COMPS got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with insufficient comp mask - tclass qkey (o15.0.1.3)...\n"
argument_list|)
expr_stmt|;
comment|/* no MGID */
comment|/* memset(&mc_req_rec.mgid, 0, sizeof(ib_gid_t)); */
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
comment|/* IB_MCR_COMPMASK_QKEY | intentionaly missed to raise the error */
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
comment|/* IB_MCR_COMPMASK_TCLASS |  intentionaly missed to raise the error */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
operator|(
call|(
name|ib_net16_t
call|)
argument_list|(
name|res_sa_mad
operator|.
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
operator|)
operator|!=
name|IB_SA_MAD_STATUS_INSUF_COMPS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02E9: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_INSUF_COMPS got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* o15.0.1.8: */
comment|/* - Request join with irrelevant RATE : get a ERR_INSUFFICIENT_COMPONENTS */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with unrealistic rate (o15.0.1.8)...\n"
argument_list|)
expr_stmt|;
comment|/* impossible requested rate */
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_12X
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0207: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_REQ_INVALID got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Check Valid value which is unreasonable now */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with unrealistic rate 120GB (o15.0.1.8)...\n"
argument_list|)
expr_stmt|;
comment|/* impossible requested rate */
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_PATH_RECORD_RATE_120_GBS
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0208: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_REQ_INVALID got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Check Valid value which is unreasonable now */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with less than min rate 2.5GB (o15.0.1.8)...\n"
argument_list|)
expr_stmt|;
comment|/* impossible requested rate */
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_PATH_RECORD_RATE_2_5_GBS
operator||
name|IB_PATH_SELECTOR_LESS_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02AB: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_REQ_INVALID got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Checking above max value of MTU which is impossible */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with unrealistic mtu : \n\t\tmore than 4096 -"
literal|" max (o15.0.1.8)...\n"
argument_list|)
expr_stmt|;
comment|/* impossible requested mtu */
name|mc_req_rec
operator|.
name|mtu
operator|=
name|IB_MTU_LEN_4096
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02AC: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_REQ_INVALID got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Checking below min value of MTU which is impossible */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with unrealistic mtu : \n\t\tless than 256 -"
literal|" min (o15.0.1.8)...\n"
argument_list|)
expr_stmt|;
comment|/* impossible requested mtu */
name|mc_req_rec
operator|.
name|mtu
operator|=
name|IB_MTU_LEN_256
operator||
name|IB_PATH_SELECTOR_LESS_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02AD: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_REQ_INVALID got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with unrealistic mtu (o15.0.1.8)...\n"
argument_list|)
expr_stmt|;
comment|/* impossible requested mtu */
name|mc_req_rec
operator|.
name|mtu
operator|=
literal|0x6
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02AE: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_REQ_INVALID got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|#
directive|if
literal|0
comment|/* Currently PacketLifeTime isn't checked in opensm */
comment|/* Check PacketLifeTime as 0 */
block|OSM_LOG(&p_osmt->log, OSM_LOG_INFO, 		"Checking Create with unrealistic packet life value less than 0 (o15.0.1.8)...\n");
comment|/* impossible requested packet life */
block|mc_req_rec.pkt_life = 0 | IB_PATH_SELECTOR_LESS_THAN<< 6;  	comp_mask = IB_MCR_COMPMASK_GID | IB_MCR_COMPMASK_PORT_GID | IB_MCR_COMPMASK_QKEY | IB_MCR_COMPMASK_PKEY | IB_MCR_COMPMASK_SL | IB_MCR_COMPMASK_FLOW | IB_MCR_COMPMASK_JOIN_STATE | IB_MCR_COMPMASK_TCLASS |
comment|/* all above are required */
block|IB_MCR_COMPMASK_LIFE | IB_MCR_COMPMASK_LIFE_SEL;  	OSM_LOG(&p_osmt->log, OSM_LOG_ERROR, EXPECTING_ERRORS_START "\n"); 	status = osmt_send_mcast_request(p_osmt, 1,&mc_req_rec, comp_mask,&res_sa_mad); 	OSM_LOG(&p_osmt->log, OSM_LOG_ERROR, EXPECTING_ERRORS_END "\n");  	if (status != IB_REMOTE_ERROR || 	    res_sa_mad.status != IB_SA_MAD_STATUS_REQ_INVALID) { 		OSM_LOG(&p_osmt->log, OSM_LOG_ERROR, "ERR 02AF: " 			"Expected REMOTE ERROR IB_SA_MAD_STATUS_REQ_INVALID got:%s/%s\n", 			ib_get_err_str(status), 			ib_get_mad_status_str((ib_mad_t *) (&res_sa_mad))); 		status = IB_ERROR; 		goto Exit; 	}
endif|#
directive|endif
comment|/* o15.0.1.4:  */
comment|/* - Create an MGID by asking for a join with MGID = 0 */
comment|/*   providing P_Key, Q_Key, SL, FlowLabel, Tclass. */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Create given MGID=0 skip service level (o15.0.1.4)...\n"
argument_list|)
expr_stmt|;
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
comment|/* no MGID */
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
comment|/* IB_MCR_COMPMASK_SL | Intentionally missed */
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
operator|(
call|(
name|ib_net16_t
call|)
argument_list|(
name|res_sa_mad
operator|.
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
operator|)
operator|!=
name|IB_SA_MAD_STATUS_INSUF_COMPS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02A8: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_INSUF_COMPS got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Check that no same MCG in the SMDB */
name|status
operator|=
name|osmt_query_mcast
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02AA: "
literal|"Could not get all MC Records in subnet, got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Only when we are on single mode check flow - do the count comparison, otherwise skip */
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|mmode
operator|==
literal|1
operator|||
name|p_osmt
operator|->
name|opt
operator|.
name|mmode
operator|==
literal|3
condition|)
block|{
name|middle_cnt
operator|=
name|cl_qmap_count
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"(post false create): "
literal|"Number of MC Records found in SA DB is %d\n"
argument_list|,
name|middle_cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|middle_cnt
operator|!=
name|start_cnt
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Got different number of records stored in SA DB (before any creation)\n"
literal|"Instead of %d got %d\n"
argument_list|,
name|start_cnt
argument_list|,
name|middle_cnt
argument_list|)
expr_stmt|;
block|}
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Create given MGID=0 skip Qkey and Pkey (o15.0.1.4)...\n"
argument_list|)
expr_stmt|;
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
comment|/* no MGID */
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
comment|/* IB_MCR_COMPMASK_QKEY | */
comment|/* IB_MCR_COMPMASK_PKEY | Intentionally missed */
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
operator|(
call|(
name|ib_net16_t
call|)
argument_list|(
name|res_sa_mad
operator|.
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
operator|)
operator|!=
name|IB_SA_MAD_STATUS_INSUF_COMPS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02A7: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_INSUF_COMPS got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Bad Query o15.0.1.4 */
name|status
operator|=
name|osmt_query_mcast
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Create given MGID=0 skip TClass (o15.0.1.4)...\n"
argument_list|)
expr_stmt|;
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
comment|/* no MGID */
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
comment|/* IB_MCR_COMPMASK_TCLASS |  Intentionally missed */
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|||
operator|(
call|(
name|ib_net16_t
call|)
argument_list|(
name|res_sa_mad
operator|.
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
operator|)
operator|!=
name|IB_SA_MAD_STATUS_INSUF_COMPS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02A6: "
literal|"Expected REMOTE ERROR IB_SA_MAD_STATUS_INSUF_COMPS got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Create given MGID=0 valid Set several options :\n\t\t"
literal|"First above min RATE, Second less than max RATE\n\t\t"
literal|"Third above min MTU, Second less than max MTU\n\t\t"
literal|"Fifth exact MTU& RATE feasible, Sixth exact RATE feasible\n\t\t"
literal|"Seventh exact MTU feasible (o15.0.1.4)...\n"
argument_list|)
expr_stmt|;
comment|/* Good Flow - mgid is 0 while giving all required fields for join : P_Key, Q_Key, SL, FlowLabel, Tclass */
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_1X
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02A5: "
literal|"Failed to create MCG for MGID=0 with higher than minimum RATE - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* Good Flow - mgid is 0 while giving all required fields for join : P_Key, Q_Key, SL, FlowLabel, Tclass */
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_12X
operator||
name|IB_PATH_SELECTOR_LESS_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0211: "
literal|"Failed to create MCG for MGID=0 with less than highest RATE - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* Good Flow - mgid is 0 while giving all required fields for join : P_Key, Q_Key, SL, FlowLabel, Tclass */
name|mc_req_rec
operator|.
name|mtu
operator|=
name|IB_MTU_LEN_4096
operator||
name|IB_PATH_SELECTOR_LESS_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0238: "
literal|"Failed to create MCG for MGID=0 with less than highest MTU - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* Good Flow - mgid is 0 while giving all required fields for join : P_Key, Q_Key, SL, FlowLabel, Tclass */
name|mc_req_rec
operator|.
name|mtu
operator|=
name|IB_MTU_LEN_256
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0239: "
literal|"Failed to create MCG for MGID=0 with higher than lowest MTU - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* Good Flow - mgid is 0 while giving all required fields for join : P_Key, Q_Key, SL, FlowLabel, Tclass */
comment|/* Using Exact feasible MTU& RATE */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Using Exact feasible MTU& RATE: "
literal|"MTU = 0x%02X, RATE = 0x%02X\n"
argument_list|,
name|mtu_phys
argument_list|,
name|rate_phys
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mtu
operator|=
name|mtu_phys
expr_stmt|;
name|mc_req_rec
operator|.
name|rate
operator|=
name|rate_phys
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
operator||
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0240: "
literal|"Failed to create MCG for MGID=0 with exact MTU& RATE - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* Good Flow - mgid is 0 while giving all required fields for join : P_Key, Q_Key, SL, FlowLabel, Tclass */
comment|/* Using Exact feasible RATE */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Using Exact feasible RATE: 0x%02X\n"
argument_list|,
name|rate_phys
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|rate
operator|=
name|rate_phys
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0241: "
literal|"Failed to create MCG for MGID=0 with exact RATE - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* Good Flow - mgid is 0 while giving all required fields for join : P_Key, Q_Key, SL, FlowLabel, Tclass */
comment|/* Using Exact feasible MTU */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Using Exact feasible MTU: 0x%02X\n"
argument_list|,
name|mtu_phys
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mtu
operator|=
name|mtu_phys
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0242: "
literal|"Failed to create MCG for MGID=0 with exact MTU - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* o15.0.1.5: */
comment|/* - Check the returned MGID is valid. (p 804) */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Validating resulting MGID (o15.0.1.5)...\n"
argument_list|)
expr_stmt|;
comment|/* prefix 0xFF1 Scope 0xA01B */
comment|/* Since we did not directly specified SCOPE in comp mask 	   we should get the comp mask that is link-local scope */
if|if
condition|(
operator|(
name|p_mc_res
operator|->
name|mgid
operator|.
name|multicast
operator|.
name|header
index|[
literal|0
index|]
operator|!=
literal|0xFF
operator|)
operator|||
operator|(
name|p_mc_res
operator|->
name|mgid
operator|.
name|multicast
operator|.
name|header
index|[
literal|1
index|]
operator|!=
literal|0x12
operator|)
operator|||
operator|(
name|p_mc_res
operator|->
name|mgid
operator|.
name|multicast
operator|.
name|raw_group_id
index|[
literal|0
index|]
operator|!=
literal|0xA0
operator|)
operator|||
operator|(
name|p_mc_res
operator|->
name|mgid
operator|.
name|multicast
operator|.
name|raw_group_id
index|[
literal|1
index|]
operator|!=
literal|0x1B
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0209: "
literal|"Validating MGID failed. MGID:%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mc_res
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Good Flow - mgid is 0 while giving all required fields for join : P_Key, Q_Key, SL, FlowLabel, Tclass */
comment|/* Using feasible GREATER_THAN 0 packet lifitime */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Create given MGID=0 (o15.0.1.4)...\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_query_mcast
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
comment|/* no MGID */
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|pkt_life
operator|=
literal|0
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_LIFE
operator||
name|IB_MCR_COMPMASK_LIFE_SEL
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0210: "
literal|"Failed to create MCG for MGID=0 - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* o15.0.1.6: */
comment|/* - Create a new MCG with valid requested MGID. */
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Create given valid MGID=%s (o15.0.1.6)...\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Before creation, need to check that this group doesn't exist */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Verifying that MCGroup with this MGID doesn't exist by trying to Join it (o15.0.1.13)...\n"
argument_list|)
expr_stmt|;
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_NON_MEMBER
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
comment|/* join */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0301: "
literal|"Tried joining group that shouldn't have existed - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Set State to full member to allow group creation */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Now creating group with given valid MGID=%s (o15.0.1.6)...\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0211: "
literal|"Failed to create MCG for MGID=%s (o15.0.1.6) - got %s/%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|good_mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Validating resulting MGID (o15.0.1.6)...\n"
argument_list|)
expr_stmt|;
comment|/* prefix 0xFF1 Scope 0xA01B */
if|if
condition|(
operator|(
name|p_mc_res
operator|->
name|mgid
operator|.
name|multicast
operator|.
name|header
index|[
literal|0
index|]
operator|!=
literal|0xFF
operator|)
operator|||
operator|(
name|p_mc_res
operator|->
name|mgid
operator|.
name|multicast
operator|.
name|header
index|[
literal|1
index|]
operator|!=
literal|0x12
operator|)
operator|||
comment|/* HACK hardcoded scope = 0x02 */
operator|(
name|p_mc_res
operator|->
name|mgid
operator|.
name|multicast
operator|.
name|raw_group_id
index|[
literal|0
index|]
operator|!=
literal|0xA0
operator|)
operator|||
operator|(
name|p_mc_res
operator|->
name|mgid
operator|.
name|multicast
operator|.
name|raw_group_id
index|[
literal|1
index|]
operator|!=
literal|0x1C
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0212: "
literal|"Validating MGID failed. MGID:%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mc_res
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* - Try to create a new MCG with invalid MGID : get back ERR_REQ_INVALID */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking BAD MGID=0xFA..... (o15.0.1.6)...\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|0
index|]
operator|=
literal|0xFA
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0213: "
literal|"Failed to recognize MGID error for MGID=0xFA - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* - Try again with MGID prefix = 0xA01B (maybe 0x1BA0 little or big ?) */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking BAD MGID=0xFF12A01B..... with link-local scope (o15.0.1.6)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|0
index|]
operator|=
literal|0xFF
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|3
index|]
operator|=
literal|0x1B
expr_stmt|;
name|comp_mask
operator|=
name|comp_mask
operator||
name|IB_MCR_COMPMASK_SCOPE
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
name|mc_req_rec
operator|.
name|scope_state
operator|&
literal|0x2F
expr_stmt|;
comment|/* local scope */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0214: "
literal|"Failed to recognize MGID error for A01B with link-local bit (status %s) (rem status %s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Change the mgid prefix - get back ERR_REQ_INVALID */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking BAD MGID PREFIX=0xEF... (o15.0.1.6)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|0
index|]
operator|=
literal|0xEF
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0215: "
literal|"Failed to recognize MGID PREFIX error for MGID=0xEF - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Change the scope to reserved - get back VALID REQ */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking local scope with full member \n\t\tand valid mgid %s"
literal|"  ... (o15.0.1.6)...\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|1
index|]
operator|=
literal|0x1F
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0216: "
literal|"Failed to create MCG for MGID=%s - got %s/%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|good_mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* Change the flags to invalid value 0x2 - get back INVALID REQ */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking invalid flags=0xFF 22  ... (o15.0.1.6)...\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|1
index|]
operator|=
literal|0x22
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0217: "
literal|"Failed to recognize create with invalid flags value 0x2 - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Change the MGID to link local MGID  - get back VALID REQ */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking link local MGID 0xFF02:0:0:0:0:0:0:1 (o15.0.1.6)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|osm_link_local_mgid
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0218: "
literal|"Failed to create MCG for MGID=0xFF02:0:0:0:0:0:0:1 - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* o15.0.1.7 - implicitlly checked during the prev steps. */
comment|/* o15.0.1.8 - implicitlly checked during the prev steps. */
comment|/* o15.0.1.9 */
comment|/* - Create MCG with Invalid JoinState.FullMember != 1 : get ERR_REQ_INVALID */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking new MGID with invalid join state (o15.0.1.9)...\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|12
index|]
operator|=
literal|0xFF
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x22
expr_stmt|;
comment|/* link-local scope, non-member state */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0219: "
literal|"Failed to recognize create with JoinState != FullMember - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Lets try a valid join scope state */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking new MGID with valid join state (o15.0.1.9)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x23
expr_stmt|;
comment|/* link-local scope, non member and full member */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0220: "
literal|"Failed to create MCG with valid join state 0x3 - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* Lets try another invalid join scope state */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking new MGID with invalid join state (o15.0.1.9)...\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* We have created a new MCG so now we need different mgid when cresting group otherwise it will be counted as join request . */
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|12
index|]
operator|=
literal|0xFC
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x24
expr_stmt|;
comment|/* link-local scope, send only member */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0221: "
literal|"Failed to recognize create with JoinState != FullMember - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Lets try another valid join scope state */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking new MGID creation with valid join state (o15.0.2.3)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|12
index|]
operator|=
literal|0xFB
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|special_mgid
argument_list|,
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x2F
expr_stmt|;
comment|/* link-local scope, Full member with all other bits turned on */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0222: "
literal|"Failed to create MCG with valid join state 0xF - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
comment|/* o15.0.1.10 - can't check on a single client .-- obsolete - 	   checked by SilverStorm bug o15-0.2.4, never the less recheck */
comment|/* o15-0.2.4 - Check a join request to already created MCG */
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Check o15-0.2.4 statement...\n"
argument_list|)
expr_stmt|;
comment|/* Try to join */
name|memcpy
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
operator|&
name|p_mc_res
operator|->
name|mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Request Join */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_NON_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0x1
argument_list|,
comment|/* SubnAdmSet */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02CC: "
literal|"Failed to join MCG with valid req, returned status = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_mc_res
operator|->
name|scope_state
operator|&
literal|0x7
operator|)
operator|!=
literal|0x7
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02D0: "
literal|"Validating JoinState update failed. "
literal|"Expected 0x27 got 0x%02X\n"
argument_list|,
name|p_mc_res
operator|->
name|scope_state
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* o15.0.1.11: */
comment|/* - Try to join into a MGID that exists with JoinState=SendOnlyMember -  */
comment|/*   see that it updates JoinState. What is the routing change? */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Retry of existing MGID - See JoinState update (o15.0.1.11)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
comment|/* first, make sure  that the group exists */
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x21
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02CD: "
literal|"Failed to create/join as full member - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x22
expr_stmt|;
comment|/* link-local scope, non-member */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02D1: "
literal|"Failed to update existing MGID - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Validating Join State update with NonMember (o15.0.1.11)...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mc_res
operator|->
name|scope_state
operator|!=
literal|0x23
condition|)
block|{
comment|/* scope is LSB */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02CE: "
literal|"Validating JoinState update failed. Expected 0x23 got: 0x%02X\n"
argument_list|,
name|p_mc_res
operator|->
name|scope_state
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Try delete current join state then update it with another value  */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking JoinState update request should return 0x22 (o15.0.1.11)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_1X
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Partially delete JoinState (o15.0.1.14)...\n"
argument_list|)
expr_stmt|;
comment|/* link-local scope, both non-member bits, 	   so we should not be able to delete) */
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x26
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02CF: "
literal|"Expected to fail partially update JoinState, "
literal|"but got %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* link-local scope, NonMember bit, the FullMember bit should stay */
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x22
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02D3: "
literal|"Failed to partially update JoinState : %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mc_res
operator|->
name|scope_state
operator|!=
literal|0x21
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02D4: "
literal|"Failed to partially update JoinState : "
literal|"JoinState = 0x%02X, expected 0x%02X\n"
argument_list|,
name|p_mc_res
operator|->
name|scope_state
argument_list|,
literal|0x21
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* So far successfully delete state - Now change it */
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x24
expr_stmt|;
comment|/* link-local scope, send only  member */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C0: "
literal|"Failed to update existing MCG - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Validating Join State update with Send Only Member (o15.0.1.11)...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mc_res
operator|->
name|scope_state
operator|!=
literal|0x25
condition|)
block|{
comment|/* scope is MSB */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C1: "
literal|"Validating JoinState update failed. Expected 0x25 got: 0x%02X\n"
argument_list|,
name|p_mc_res
operator|->
name|scope_state
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Now try to update value of join state */
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x21
expr_stmt|;
comment|/* link-local scope, full member */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C2: "
literal|"Failed to update existing MGID - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Validating Join State update with Full Member\n\t\t"
literal|"to an existing 0x5 state MCG (o15.0.1.11)...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mc_res
operator|->
name|scope_state
operator|!=
literal|0x25
condition|)
block|{
comment|/* scope is LSB */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C3: "
literal|"Validating JoinState update failed. Expected 0x25 got: 0x%02X\n"
argument_list|,
name|p_mc_res
operator|->
name|scope_state
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Now try to update value of join state */
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x22
expr_stmt|;
comment|/* link-local scope,non member */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C4: "
literal|"Failed to update existing MGID - got %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Validating Join State update with Non Member\n\t\t"
literal|"to an existing 0x5 state MCG (o15.0.1.11)...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mc_res
operator|->
name|scope_state
operator|!=
literal|0x27
condition|)
block|{
comment|/* scope is LSB */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C5: "
literal|"Validating JoinState update failed. Expected 0x27 got: 0x%02X\n"
argument_list|,
name|p_mc_res
operator|->
name|scope_state
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"DEBUG - Current scope_state value : 0x%02X...\n"
argument_list|,
name|p_mc_res
operator|->
name|scope_state
argument_list|)
expr_stmt|;
comment|/* - We can not check simple join since we have only one tester (for now) */
comment|/* o15.0.1.12: Not Supported */
comment|/* - The SendOnlyNonMem join should have a special treatment in the 	   SA but what is it ? */
comment|/* o15.0.1.13: */
comment|/* - Try joining with rate that does not exist in any MCG - 	   ERR_REQ_INVALID */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking BAD RATE when connecting to existing MGID (o15.0.1.13)...\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_1X
operator||
name|IB_PATH_SELECTOR_LESS_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C6: "
literal|"Failed to catch BAD RATE joining an exiting MGID: %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Try MTU that does not exist in any MCG */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking BAD MTU (higher them max) when connecting to "
literal|"existing MGID (o15.0.1.13)...\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|osm_ipoib_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|mtu
operator|=
name|IB_MTU_LEN_4096
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C7: "
literal|"Failed to catch BAD RATE (higher them max) joining an exiting MGID: %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Try another MTU that does not exist in any MCG */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking BAD MTU (less than min) when connecting "
literal|"to existing MGID (o15.0.1.13)...\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|osm_ipoib_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|mtu
operator|=
name|IB_MTU_LEN_256
operator||
name|IB_PATH_SELECTOR_LESS_THAN
operator|<<
literal|6
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C8: "
literal|"Failed to catch BAD RATE (less them min) joining an exiting MGID: %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* o15.0.1.14: */
comment|/* - Try partial delete - actually updating the join state. check it. */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking partial JoinState delete request - removing NonMember (o15.0.1.14)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_1X
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_RATE_SEL
operator||
name|IB_MCR_COMPMASK_RATE
expr_stmt|;
comment|/* link-local scope, non member (so we should not be able to delete) */
comment|/* but the NonMember bit should be gone */
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x22
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02C9: "
literal|"Fail to partially update JoinState during delete: %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Validating Join State removal of Non Member bit (o15.0.1.14)...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mc_res
operator|->
name|scope_state
operator|!=
literal|0x25
condition|)
block|{
comment|/* scope is MSB - now only the full member& send only member have left */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02CA: "
literal|"Validating JoinState update failed. Expected 0x25 got: 0x%02X\n"
argument_list|,
name|p_mc_res
operator|->
name|scope_state
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Now use the same scope_state and delete all JoinState - leave multicast group since state is 0x0 */
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x25
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02CB: "
literal|"Failed to update JoinState during delete: %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Validating Join State update remove (o15.0.1.14)...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mc_res
operator|->
name|scope_state
operator|!=
literal|0x25
condition|)
block|{
comment|/* scope is MSB - now only 0x0 so port is removed from MCG */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02BF: "
literal|"Validating JoinState update failed. Expected 0x25 got: 0x%02X\n"
argument_list|,
name|p_mc_res
operator|->
name|scope_state
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* - Try joining (not full mem) again to see the group was deleted. (should fail) */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Delete by trying to Join deleted group (o15.0.1.13)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x22
expr_stmt|;
comment|/* use non member - so if no group fail */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
comment|/* join */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02BC: "
literal|"Succeeded Joining Deleted Group: %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* - Try deletion of the IPoIB MCG and get: ERR_REQ_INVALID */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking BAD Delete of Mgid membership (no prev join) (o15.0.1.15)...\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|osm_ipoib_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_1X
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x21
expr_stmt|;
comment|/* delete full member */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
comment|/* delete flag */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02BD: "
literal|"Failed to catch BAD delete from IPoIB: %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Prepare another MCG for the following tests : */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Create given MGID=%s\n\t\t(o15.0.1.4)...\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|osm_ipoib_mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|good_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
index|[
literal|12
index|]
operator|=
literal|0xAA
expr_stmt|;
name|mc_req_rec
operator|.
name|pkt_life
operator|=
literal|0
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x21
expr_stmt|;
comment|/* Full memeber */
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_LIFE
operator||
name|IB_MCR_COMPMASK_LIFE_SEL
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02BE: "
literal|"Failed to create MCG for %s - got %s/%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|good_mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* - Try delete with valid join state */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Full Delete of a group (o15.0.1.14)...\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x21
expr_stmt|;
comment|/* the FullMember is the current JoinState */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
goto|goto
name|Exit
goto|;
block|}
comment|/* o15.0.1.15: */
comment|/* - Try deletion of the IPoIB MCG and get: ERR_REQ_INVALID */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking BAD Delete of IPoIB membership (no prev join) (o15.0.1.15)...\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|osm_ipoib_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_1X
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x21
expr_stmt|;
comment|/* delete full member */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
comment|/* delete flag */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|!=
name|IB_REMOTE_ERROR
operator|)
operator|||
operator|(
name|res_sa_mad
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_REQ_INVALID
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0223: "
literal|"Failed to catch BAD delete from IPoIB: %s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/**************************************************************************/
comment|/* Checking join with invalid MTU */
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Join with unrealistic mtu : \n"
literal|"\t\tFirst create new MCG than try to join it \n"
literal|"\t\twith unrealistic MTU greater than 4096 (o15.0.1.8)...\n"
argument_list|)
expr_stmt|;
comment|/* First create new mgrp */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mtu
operator|=
name|IB_MTU_LEN_1024
operator||
name|IB_PATH_SELECTOR_EXACTLY
operator|<<
literal|6
expr_stmt|;
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02EB: "
literal|"Failed to create new mgrp\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|memcpy
argument_list|(
operator|&
name|tmp_mgid
argument_list|,
operator|&
name|p_mc_res
operator|->
name|mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
name|osm_dump_mc_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_mc_res
argument_list|,
name|OSM_LOG_INFO
argument_list|)
expr_stmt|;
comment|/* tmp_mtu = p_mc_res->mtu& 0x3F; */
comment|/* impossible requested mtu always greater than exist in MCG */
name|mc_req_rec
operator|.
name|mtu
operator|=
name|IB_MTU_LEN_4096
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
operator|&
name|tmp_mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_GID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_MTU
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02E4: "
literal|"Expected REMOTE ERROR got:%s/%s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* - Try GetTable with PortGUID wildcarded and get back some groups. */
name|status
operator|=
name|osmt_query_mcast
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
name|cnt
operator|=
name|cl_qmap_count
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"(Before checking Max MCG creation): "
literal|"Number of MC Records found in SA DB is %d\n"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
comment|/**************************************************************************/
comment|/* Checking join on behalf of remote port gid */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Proxy Join...\n"
argument_list|)
expr_stmt|;
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for all NodeRecords in the subnet. 	 */
name|status
operator|=
name|osmtest_get_all_recs
argument_list|(
name|p_osmt
argument_list|,
name|IB_MAD_ATTR_NODE_RECORD
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_rec
argument_list|)
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02E5: "
literal|"osmtest_get_all_recs failed on getting all node records(%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Populate the database with the received records. 	 */
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %u records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_node_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_rec
operator|->
name|node_info
operator|.
name|port_guid
operator|!=
name|p_osmt
operator|->
name|local_port
operator|.
name|port_guid
operator|&&
name|p_rec
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_CA
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"remote port_guid = 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|node_info
operator|.
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
name|remote_port_guid
operator|=
name|p_rec
operator|->
name|node_info
operator|.
name|port_guid
expr_stmt|;
name|i
operator|=
name|num_recs
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|remote_port_guid
operator|!=
literal|0x0
condition|)
block|{
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|remote_port_guid
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
expr_stmt|;
comment|/* all above are required */
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02B4: "
literal|"Could not join on behalf of remote port 0x%016"
name|PRIx64
literal|" remote status: %s\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|remote_port_guid
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|proxy_mgid
argument_list|,
operator|&
name|p_mc_res
operator|->
name|mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* First try a bad deletion then good one */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Trying deletion of remote port with local port guid\n"
argument_list|)
expr_stmt|;
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_START
literal|"\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
comment|/* delete flag */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
name|EXPECTING_ERRORS_END
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02A9: "
literal|"Successful deletion of remote port guid with local one MGID : "
literal|"%s, Got : %s/%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Trying deletion of remote port with the right port guid\n"
argument_list|)
expr_stmt|;
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|proxy_mgid
expr_stmt|;
name|mc_req_rec
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|remote_port_guid
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
comment|/* delete flag */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02B0: "
literal|"Failed to delete mgid with remote port guid MGID : "
literal|"%s, Got : %s/%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Could not check proxy join since could not found remote port, different from local port\n"
argument_list|)
expr_stmt|;
block|}
comment|/* prepare init for next check */
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
comment|/**************************************************************************/
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|mmode
operator|>
literal|2
condition|)
block|{
comment|/* Check invalid Join with max mlid which is more than the 		   Mellanox switches support 0xC000+0x1000 = 0xd000 */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Checking Creation of Maximum avaliable Groups (MulticastFDBCap)...\n"
argument_list|)
expr_stmt|;
name|tmp_mlid
operator|=
name|cl_ntoh16
argument_list|(
name|max_mlid
argument_list|)
operator|-
name|cnt
expr_stmt|;
while|while
condition|(
name|tmp_mlid
operator|>
literal|0
operator|&&
operator|!
name|ReachedMlidLimit
condition|)
block|{
name|uint16_t
name|cur_mlid
init|=
literal|0
decl_stmt|;
comment|/* Request Set */
name|ib_member_set_join_state
argument_list|(
operator|&
name|mc_req_rec
argument_list|,
name|IB_MC_REC_STATE_FULL_MEMBER
argument_list|)
expr_stmt|;
comment|/* Good Flow - mgid is 0 while giving all required fields for 			   join : P_Key, Q_Key, SL, FlowLabel, Tclass */
name|mc_req_rec
operator|.
name|rate
operator|=
name|IB_LINK_WIDTH_ACTIVE_1X
operator||
name|IB_PATH_SELECTOR_GREATER_THAN
operator|<<
literal|6
expr_stmt|;
name|mc_req_rec
operator|.
name|mlid
operator|=
name|max_mlid
expr_stmt|;
name|memset
argument_list|(
operator|&
name|mc_req_rec
operator|.
name|mgid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_QKEY
operator||
name|IB_MCR_COMPMASK_PKEY
operator||
name|IB_MCR_COMPMASK_SL
operator||
name|IB_MCR_COMPMASK_FLOW
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
operator||
name|IB_MCR_COMPMASK_TCLASS
operator||
comment|/* all above are required */
name|IB_MCR_COMPMASK_MLID
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|p_mc_res
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
if|if
condition|(
name|cur_mlid
operator|>
name|cl_ntoh16
argument_list|(
name|max_mlid
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 2E1 "
literal|"Successful Join with greater mlid than switches support (MulticastFDBCap) 0x%04X\n"
argument_list|,
name|cur_mlid
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
name|osm_dump_mc_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_mc_res
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
elseif|else
if|if
condition|(
operator|(
name|res_sa_mad
operator|.
name|status
operator|&
name|IB_SMP_STATUS_MASK
operator|)
operator|==
name|IB_SA_MAD_STATUS_NO_RESOURCES
condition|)
block|{
comment|/* You can quitly exit the loop since no available mlid in SA DB 					   i.e. reached the maximum valiad avalable mlid */
name|ReachedMlidLimit
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
name|cur_mlid
operator|=
name|cl_ntoh16
argument_list|(
name|p_mc_res
operator|->
name|mlid
argument_list|)
expr_stmt|;
comment|/* Save the mlid created in test_created_mlids map */
name|p_recvd_rec
operator|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|ib_sa_mad_get_payload_ptr
argument_list|(
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Created MGID:%s MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_recvd_rec
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_map_insert
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_recvd_rec
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_recvd_rec
argument_list|)
expr_stmt|;
block|}
name|tmp_mlid
operator|--
expr_stmt|;
block|}
block|}
comment|/* Prepare the mc_req_rec for the rest of the flow */
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
comment|/**************************************************************************/
comment|/* o15.0.1.16: */
comment|/* - Try GetTable with PortGUID wildcarded and get back some groups. */
name|status
operator|=
name|osmt_query_mcast
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02B1: "
literal|"Failed to query multicast groups: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|cnt
operator|=
name|cl_qmap_count
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"(Before Deletion of all MCG): "
literal|"Number of MC Records found in SA DB is %d\n"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
comment|/* Delete all MCG that are not of IPoIB */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Cleanup all MCG that are not IPoIB...\n"
argument_list|)
expr_stmt|;
name|p_mgrp_mlid_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
expr_stmt|;
name|p_mgrp
operator|=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_mgrp_mlid_tbl
argument_list|)
expr_stmt|;
comment|/* scan all available multicast groups in the DB and fill in the table */
while|while
condition|(
name|p_mgrp
operator|!=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_mgrp_mlid_tbl
argument_list|)
condition|)
block|{
comment|/* Only if different from IPoIB Mgid try to delete */
if|if
condition|(
operator|!
name|IS_IPOIB_MGID
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
argument_list|)
condition|)
block|{
name|osmt_init_mc_query_rec
argument_list|(
name|p_osmt
argument_list|,
operator|&
name|mc_req_rec
argument_list|)
expr_stmt|;
name|mc_req_rec
operator|.
name|mgid
operator|=
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
expr_stmt|;
comment|/* o15-0.1.4 - need to specify the oppsite state for a valid delete */
if|if
condition|(
operator|!
name|memcmp
argument_list|(
operator|&
name|special_mgid
argument_list|,
operator|&
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|special_mgid
argument_list|)
argument_list|)
condition|)
block|{
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x2F
expr_stmt|;
block|}
else|else
block|{
name|mc_req_rec
operator|.
name|scope_state
operator|=
literal|0x21
expr_stmt|;
block|}
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MGID
operator||
name|IB_MCR_COMPMASK_PORT_GID
operator||
name|IB_MCR_COMPMASK_JOIN_STATE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Sending request to delete MGID : %s"
literal|", scope_state : 0x%02X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mc_req_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|mc_req_rec
operator|.
name|scope_state
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_send_mcast_request
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
comment|/* delete flag */
operator|&
name|mc_req_rec
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|res_sa_mad
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02FF: Failed to delete MGID : %s"
literal|" ,\n\t\t it is not our MCG, Status : %s/%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|ib_get_mad_status_str
argument_list|(
operator|(
name|ib_mad_t
operator|*
operator|)
operator|(
operator|&
name|res_sa_mad
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|fail_to_delete_mcg
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|end_ipoib_cnt
operator|++
expr_stmt|;
block|}
name|p_mgrp
operator|=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_mgrp
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|osmt_query_mcast
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02B2 "
literal|"GetTable of all records has failed - got %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* If we are in single mode check flow - need to make sure all the multicast groups 	   that are left are not ones created during the flow. 	 */
if|if
condition|(
name|p_osmt
operator|->
name|opt
operator|.
name|mmode
operator|==
literal|1
operator|||
name|p_osmt
operator|->
name|opt
operator|.
name|mmode
operator|==
literal|3
condition|)
block|{
name|end_cnt
operator|=
name|cl_qmap_count
argument_list|(
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Status of MC Records in SA DB during the test flow:\n"
literal|"  Beginning of test\n"
literal|"       Unrelated to the test: %d\n"
literal|"       IPoIB MC Records     : %d\n"
literal|"       Total                : %d\n"
literal|"  End of test\n"
literal|"       Failed to delete     : %d\n"
literal|"       IPoIB MC Records     : %d\n"
literal|"       Total                : %d\n"
argument_list|,
name|mcg_outside_test_cnt
argument_list|,
comment|/* Non-IPoIB that existed at the beginning */
name|start_ipoib_cnt
argument_list|,
comment|/* IPoIB records */
name|start_cnt
argument_list|,
comment|/* Total: IPoIB and MC Records unrelated to the test */
name|fail_to_delete_mcg
argument_list|,
comment|/* Failed to delete at the end */
name|end_ipoib_cnt
argument_list|,
comment|/* IPoIB records */
name|end_cnt
argument_list|)
expr_stmt|;
comment|/* Total MC Records at the end */
comment|/* when we compare num of MCG we should consider an outside source which create other MCGs */
if|if
condition|(
operator|(
name|end_cnt
operator|-
name|fail_to_delete_mcg
operator|-
name|end_ipoib_cnt
operator|)
operator|!=
operator|(
name|start_cnt
operator|-
name|mcg_outside_test_cnt
operator|-
name|start_ipoib_cnt
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Got different number of non-IPoIB records stored in SA DB\n\t\t"
literal|"at Start got %d, at End got %d (IPoIB groups only)\n"
argument_list|,
operator|(
name|start_cnt
operator|-
name|mcg_outside_test_cnt
operator|-
name|start_ipoib_cnt
operator|)
argument_list|,
operator|(
name|end_cnt
operator|-
name|fail_to_delete_mcg
operator|-
name|end_ipoib_cnt
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_mgrp_mlid_tbl
operator|=
operator|&
name|p_osmt
operator|->
name|exp_subn
operator|.
name|mgrp_mlid_tbl
expr_stmt|;
name|p_mgrp
operator|=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_mgrp_mlid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_mgrp
operator|!=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_mgrp_mlid_tbl
argument_list|)
condition|)
block|{
name|uint16_t
name|mlid
init|=
operator|(
name|uint16_t
operator|)
name|cl_qmap_key
argument_list|(
operator|(
name|cl_map_item_t
operator|*
operator|)
name|p_mgrp
argument_list|)
decl_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Found MLID:0x%04X\n"
argument_list|,
name|mlid
argument_list|)
expr_stmt|;
comment|/* Check if the mlid is in the test_created_mlids. If TRUE, then we 			   didn't delete a MCgroup that was created in this flow. */
if|if
condition|(
name|cl_map_get
argument_list|(
operator|&
name|test_created_mlids
argument_list|,
name|mlid
argument_list|)
operator|!=
name|NULL
condition|)
block|{
comment|/* This means that we still have an mgrp that we created!! */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 02FE: "
literal|"Wasn't able to erase mgrp with MGID:%s"
literal|" MLID:0x%04X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|mlid
argument_list|)
expr_stmt|;
name|got_error
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Still exists %s MGID:%s\n"
argument_list|,
operator|(
name|IS_IPOIB_MGID
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
argument_list|)
operator|)
condition|?
literal|"IPoIB"
else|:
literal|"non-IPoIB"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|p_mgrp
operator|=
operator|(
name|osmtest_mgrp_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_mgrp
operator|->
name|map_item
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|got_error
condition|)
block|{
name|__osmt_print_all_multicast_records
argument_list|(
name|p_osmt
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
block|}
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire Inc.  All rights reserved.  * Copyright (c) 2014 Intel Corporation.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<sys/poll.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<dirent.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/umad.h>
end_include

begin_define
define|#
directive|define
name|IB_OPENIB_OUI
value|(0x001405)
end_define

begin_include
include|#
directive|include
file|"sysfs.h"
end_include

begin_typedef
typedef|typedef
struct|struct
name|ib_user_mad_reg_req
block|{
name|uint32_t
name|id
decl_stmt|;
name|uint32_t
name|method_mask
index|[
literal|4
index|]
decl_stmt|;
name|uint8_t
name|qpn
decl_stmt|;
name|uint8_t
name|mgmt_class
decl_stmt|;
name|uint8_t
name|mgmt_class_version
decl_stmt|;
name|uint8_t
name|oui
index|[
literal|3
index|]
decl_stmt|;
name|uint8_t
name|rmpp_version
decl_stmt|;
block|}
name|ib_user_mad_reg_req_t
typedef|;
end_typedef

begin_struct
struct|struct
name|ib_user_mad_reg_req2
block|{
name|uint32_t
name|id
decl_stmt|;
name|uint32_t
name|qpn
decl_stmt|;
name|uint8_t
name|mgmt_class
decl_stmt|;
name|uint8_t
name|mgmt_class_version
decl_stmt|;
name|uint16_t
name|res
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
name|uint64_t
name|method_mask
index|[
literal|2
index|]
decl_stmt|;
name|uint32_t
name|oui
decl_stmt|;
name|uint8_t
name|rmpp_version
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|3
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|IBWARN
parameter_list|(
name|fmt
parameter_list|,
name|args
modifier|...
parameter_list|)
value|fprintf(stderr, "ibwarn: [%d] %s: " fmt "\n", getpid(), __func__, ## args)
end_define

begin_define
define|#
directive|define
name|TRACE
value|if (umaddebug)	IBWARN
end_define

begin_define
define|#
directive|define
name|DEBUG
value|if (umaddebug)	IBWARN
end_define

begin_decl_stmt
specifier|static
name|int
name|umaddebug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|UMAD_DEV_FILE_SZ
value|256
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|def_ca_name
init|=
literal|"mthca0"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|def_ca_port
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|abi_version
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|new_user_mad_api
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*************************************  * Port  */
end_comment

begin_function
specifier|static
name|int
name|find_cached_ca
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
name|umad_ca_t
modifier|*
name|ca
parameter_list|)
block|{
return|return
literal|0
return|;
comment|/* caching not implemented yet */
block|}
end_function

begin_function
specifier|static
name|int
name|put_ca
parameter_list|(
name|umad_ca_t
modifier|*
name|ca
parameter_list|)
block|{
return|return
literal|0
return|;
comment|/* caching not implemented yet */
block|}
end_function

begin_function
specifier|static
name|int
name|release_port
parameter_list|(
name|umad_port_t
modifier|*
name|port
parameter_list|)
block|{
name|free
argument_list|(
name|port
operator|->
name|pkeys
argument_list|)
expr_stmt|;
name|port
operator|->
name|pkeys
operator|=
name|NULL
expr_stmt|;
name|port
operator|->
name|pkeys_size
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_for_digit_name
parameter_list|(
specifier|const
name|struct
name|dirent
modifier|*
name|dent
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|p
init|=
name|dent
operator|->
name|d_name
decl_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
name|isdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|)
name|p
operator|++
expr_stmt|;
return|return
operator|*
name|p
condition|?
literal|0
else|:
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_port
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
specifier|const
name|char
modifier|*
name|dir
parameter_list|,
name|int
name|portnum
parameter_list|,
name|umad_port_t
modifier|*
name|port
parameter_list|)
block|{
name|char
name|port_dir
index|[
literal|256
index|]
decl_stmt|;
name|union
name|umad_gid
name|gid
decl_stmt|;
name|struct
name|dirent
modifier|*
modifier|*
name|namelist
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|num_pkeys
init|=
literal|0
decl_stmt|;
name|uint32_t
name|capmask
decl_stmt|;
name|strncpy
argument_list|(
name|port
operator|->
name|ca_name
argument_list|,
name|ca_name
argument_list|,
sizeof|sizeof
name|port
operator|->
name|ca_name
operator|-
literal|1
argument_list|)
expr_stmt|;
name|port
operator|->
name|portnum
operator|=
name|portnum
expr_stmt|;
name|port
operator|->
name|pkeys
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|port_dir
argument_list|,
sizeof|sizeof
argument_list|(
name|port_dir
argument_list|)
argument_list|,
literal|"%s/%d"
argument_list|,
name|dir
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
sizeof|sizeof
argument_list|(
name|port_dir
argument_list|)
condition|)
goto|goto
name|clean
goto|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_LMC
argument_list|,
operator|&
name|port
operator|->
name|lmc
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|clean
goto|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_SMLID
argument_list|,
operator|&
name|port
operator|->
name|sm_lid
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|clean
goto|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_SMSL
argument_list|,
operator|&
name|port
operator|->
name|sm_sl
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|clean
goto|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_LID
argument_list|,
operator|&
name|port
operator|->
name|base_lid
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|clean
goto|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_STATE
argument_list|,
operator|&
name|port
operator|->
name|state
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|clean
goto|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_PHY_STATE
argument_list|,
operator|&
name|port
operator|->
name|phys_state
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|clean
goto|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_RATE
argument_list|,
operator|&
name|port
operator|->
name|rate
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|clean
goto|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_CAPMASK
argument_list|,
operator|&
name|capmask
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|clean
goto|;
if|if
condition|(
name|sys_read_string
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_LINK_LAYER
argument_list|,
name|port
operator|->
name|link_layer
argument_list|,
name|UMAD_CA_NAME_LEN
argument_list|)
operator|<
literal|0
condition|)
comment|/* assume IB by default */
name|sprintf
argument_list|(
name|port
operator|->
name|link_layer
argument_list|,
literal|"IB"
argument_list|)
expr_stmt|;
name|port
operator|->
name|capmask
operator|=
name|htobe32
argument_list|(
name|capmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|sys_read_gid
argument_list|(
name|port_dir
argument_list|,
name|SYS_PORT_GID
argument_list|,
operator|&
name|gid
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|clean
goto|;
name|port
operator|->
name|gid_prefix
operator|=
name|gid
operator|.
name|global
operator|.
name|subnet_prefix
expr_stmt|;
name|port
operator|->
name|port_guid
operator|=
name|gid
operator|.
name|global
operator|.
name|interface_id
expr_stmt|;
name|snprintf
argument_list|(
name|port_dir
operator|+
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|port_dir
argument_list|)
operator|-
name|len
argument_list|,
literal|"/pkeys"
argument_list|)
expr_stmt|;
name|num_pkeys
operator|=
name|sys_scandir
argument_list|(
name|port_dir
argument_list|,
operator|&
name|namelist
argument_list|,
name|check_for_digit_name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_pkeys
operator|<=
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"no pkeys found for %s:%u (at dir %s)..."
argument_list|,
name|port
operator|->
name|ca_name
argument_list|,
name|port
operator|->
name|portnum
argument_list|,
name|port_dir
argument_list|)
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
name|port
operator|->
name|pkeys
operator|=
name|calloc
argument_list|(
name|num_pkeys
argument_list|,
sizeof|sizeof
argument_list|(
name|port
operator|->
name|pkeys
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|->
name|pkeys
condition|)
block|{
name|IBWARN
argument_list|(
literal|"get_port: calloc failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_pkeys
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|idx
decl_stmt|,
name|val
decl_stmt|;
name|idx
operator|=
name|strtoul
argument_list|(
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sys_read_uint
argument_list|(
name|port_dir
argument_list|,
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|port
operator|->
name|pkeys
index|[
name|idx
index|]
operator|=
name|val
expr_stmt|;
name|free
argument_list|(
name|namelist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|port
operator|->
name|pkeys_size
operator|=
name|num_pkeys
expr_stmt|;
name|free
argument_list|(
name|namelist
argument_list|)
expr_stmt|;
name|namelist
operator|=
name|NULL
expr_stmt|;
name|port_dir
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* FIXME: handle gids */
return|return
literal|0
return|;
name|clean
label|:
if|if
condition|(
name|namelist
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_pkeys
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|namelist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|namelist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|port
operator|->
name|pkeys
condition|)
name|free
argument_list|(
name|port
operator|->
name|pkeys
argument_list|)
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|release_ca
parameter_list|(
name|umad_ca_t
modifier|*
name|ca
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|ca
operator|->
name|numports
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ca
operator|->
name|ports
index|[
name|i
index|]
condition|)
continue|continue;
name|release_port
argument_list|(
name|ca
operator|->
name|ports
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ca
operator|->
name|ports
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ca
operator|->
name|ports
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * if *port> 0, check ca[port] state. Otherwise set *port to  * the first port that is active, and if such is not found, to  * the first port that is link up and if none are linkup, then  * the first port that is not disabled.  Otherwise return -1.  */
end_comment

begin_function
specifier|static
name|int
name|resolve_ca_port
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
name|int
modifier|*
name|port
parameter_list|)
block|{
name|umad_ca_t
name|ca
decl_stmt|;
name|int
name|active
init|=
operator|-
literal|1
decl_stmt|,
name|up
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|TRACE
argument_list|(
literal|"checking ca '%s'"
argument_list|,
name|ca_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|umad_get_ca
argument_list|(
name|ca_name
argument_list|,
operator|&
name|ca
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|ca
operator|.
name|node_type
operator|==
literal|2
condition|)
block|{
operator|*
name|port
operator|=
literal|0
expr_stmt|;
comment|/* switch sma port 0 */
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|*
name|port
operator|>
literal|0
condition|)
block|{
comment|/* check only the port the user wants */
if|if
condition|(
operator|*
name|port
operator|>
name|ca
operator|.
name|numports
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|!
name|ca
operator|.
name|ports
index|[
operator|*
name|port
index|]
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|ca
operator|.
name|ports
index|[
operator|*
name|port
index|]
operator|->
name|link_layer
argument_list|,
literal|"InfiniBand"
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|ca
operator|.
name|ports
index|[
operator|*
name|port
index|]
operator|->
name|link_layer
argument_list|,
literal|"IB"
argument_list|)
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|ca
operator|.
name|ports
index|[
operator|*
name|port
index|]
operator|->
name|state
operator|==
literal|4
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|ca
operator|.
name|ports
index|[
operator|*
name|port
index|]
operator|->
name|phys_state
operator|!=
literal|3
condition|)
goto|goto
name|Exit
goto|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|ca
operator|.
name|numports
condition|;
name|i
operator|++
control|)
block|{
name|DEBUG
argument_list|(
literal|"checking port %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ca
operator|.
name|ports
index|[
name|i
index|]
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|ca
operator|.
name|ports
index|[
name|i
index|]
operator|->
name|link_layer
argument_list|,
literal|"InfiniBand"
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|ca
operator|.
name|ports
index|[
name|i
index|]
operator|->
name|link_layer
argument_list|,
literal|"IB"
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|up
operator|<
literal|0
operator|&&
name|ca
operator|.
name|ports
index|[
name|i
index|]
operator|->
name|phys_state
operator|==
literal|5
condition|)
name|up
operator|=
operator|*
name|port
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ca
operator|.
name|ports
index|[
name|i
index|]
operator|->
name|state
operator|==
literal|4
condition|)
block|{
name|active
operator|=
operator|*
name|port
operator|=
name|i
expr_stmt|;
name|DEBUG
argument_list|(
literal|"found active port %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|active
operator|==
operator|-
literal|1
operator|&&
name|up
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* no active or linkup port found */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|ca
operator|.
name|numports
condition|;
name|i
operator|++
control|)
block|{
name|DEBUG
argument_list|(
literal|"checking port %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ca
operator|.
name|ports
index|[
name|i
index|]
condition|)
continue|continue;
if|if
condition|(
name|ca
operator|.
name|ports
index|[
name|i
index|]
operator|->
name|phys_state
operator|!=
literal|3
condition|)
block|{
name|up
operator|=
operator|*
name|port
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|active
operator|>=
literal|0
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|up
operator|>=
literal|0
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|Exit
label|:
name|release_ca
argument_list|(
operator|&
name|ca
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|resolve_ca_name
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
name|int
modifier|*
name|best_port
parameter_list|)
block|{
specifier|static
name|char
name|names
index|[
name|UMAD_MAX_DEVICES
index|]
index|[
name|UMAD_CA_NAME_LEN
index|]
decl_stmt|;
name|int
name|phys_found
init|=
operator|-
literal|1
decl_stmt|,
name|port_found
init|=
literal|0
decl_stmt|,
name|port
decl_stmt|,
name|port_type
decl_stmt|;
name|int
name|caidx
decl_stmt|,
name|n
decl_stmt|;
if|if
condition|(
name|ca_name
operator|&&
operator|(
operator|!
name|best_port
operator|||
operator|*
name|best_port
operator|)
condition|)
return|return
name|ca_name
return|;
if|if
condition|(
name|ca_name
condition|)
block|{
if|if
condition|(
name|resolve_ca_port
argument_list|(
name|ca_name
argument_list|,
name|best_port
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
return|return
name|ca_name
return|;
block|}
comment|/* Get the list of CA names */
if|if
condition|(
operator|(
name|n
operator|=
name|umad_get_cas_names
argument_list|(
operator|(
name|void
operator|*
operator|)
name|names
argument_list|,
name|UMAD_MAX_DEVICES
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
comment|/* Find the first existing CA with an active port */
for|for
control|(
name|caidx
operator|=
literal|0
init|;
name|caidx
operator|<
name|n
condition|;
name|caidx
operator|++
control|)
block|{
name|TRACE
argument_list|(
literal|"checking ca '%s'"
argument_list|,
name|names
index|[
name|caidx
index|]
argument_list|)
expr_stmt|;
name|port
operator|=
name|best_port
condition|?
operator|*
name|best_port
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|port_type
operator|=
name|resolve_ca_port
argument_list|(
name|names
index|[
name|caidx
index|]
argument_list|,
operator|&
name|port
argument_list|)
operator|)
operator|<
literal|0
condition|)
continue|continue;
name|DEBUG
argument_list|(
literal|"found ca %s with port %d type %d"
argument_list|,
name|names
index|[
name|caidx
index|]
argument_list|,
name|port
argument_list|,
name|port_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_type
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|best_port
condition|)
operator|*
name|best_port
operator|=
name|port
expr_stmt|;
name|DEBUG
argument_list|(
literal|"found ca %s with active port %d"
argument_list|,
name|names
index|[
name|caidx
index|]
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
operator|(
name|char
operator|*
operator|)
operator|(
name|names
operator|+
name|caidx
operator|)
return|;
block|}
if|if
condition|(
name|phys_found
operator|==
operator|-
literal|1
condition|)
block|{
name|phys_found
operator|=
name|caidx
expr_stmt|;
name|port_found
operator|=
name|port
expr_stmt|;
block|}
block|}
name|DEBUG
argument_list|(
literal|"phys found %d on %s port %d"
argument_list|,
name|phys_found
argument_list|,
name|phys_found
operator|>=
literal|0
condition|?
name|names
index|[
name|phys_found
index|]
else|:
name|NULL
argument_list|,
name|port_found
argument_list|)
expr_stmt|;
if|if
condition|(
name|phys_found
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|best_port
condition|)
operator|*
name|best_port
operator|=
name|port_found
expr_stmt|;
return|return
name|names
index|[
name|phys_found
index|]
return|;
block|}
if|if
condition|(
name|best_port
condition|)
operator|*
name|best_port
operator|=
name|def_ca_port
expr_stmt|;
return|return
name|def_ca_name
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_ca
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
name|umad_ca_t
modifier|*
name|ca
parameter_list|)
block|{
name|char
name|dir_name
index|[
literal|256
index|]
decl_stmt|;
name|struct
name|dirent
modifier|*
modifier|*
name|namelist
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|int
name|portnum
decl_stmt|;
name|ca
operator|->
name|numports
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|ca
operator|->
name|ports
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|ca
operator|->
name|ports
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ca
operator|->
name|ca_name
argument_list|,
name|ca_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ca
operator|->
name|ca_name
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|dir_name
argument_list|,
sizeof|sizeof
argument_list|(
name|dir_name
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|SYS_INFINIBAND
argument_list|,
name|ca
operator|->
name|ca_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sys_read_uint
argument_list|(
name|dir_name
argument_list|,
name|SYS_NODE_TYPE
argument_list|,
operator|&
name|ca
operator|->
name|node_type
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|sys_read_string
argument_list|(
name|dir_name
argument_list|,
name|SYS_CA_FW_VERS
argument_list|,
name|ca
operator|->
name|fw_ver
argument_list|,
sizeof|sizeof
name|ca
operator|->
name|fw_ver
argument_list|)
operator|<
literal|0
condition|)
name|ca
operator|->
name|fw_ver
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|sys_read_string
argument_list|(
name|dir_name
argument_list|,
name|SYS_CA_HW_VERS
argument_list|,
name|ca
operator|->
name|hw_ver
argument_list|,
sizeof|sizeof
name|ca
operator|->
name|hw_ver
argument_list|)
operator|<
literal|0
condition|)
name|ca
operator|->
name|hw_ver
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sys_read_string
argument_list|(
name|dir_name
argument_list|,
name|SYS_CA_TYPE
argument_list|,
name|ca
operator|->
name|ca_type
argument_list|,
sizeof|sizeof
name|ca
operator|->
name|ca_type
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|ca
operator|->
name|ca_type
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sys_read_guid
argument_list|(
name|dir_name
argument_list|,
name|SYS_CA_NODE_GUID
argument_list|,
operator|&
name|ca
operator|->
name|node_guid
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
operator|(
name|r
operator|=
name|sys_read_guid
argument_list|(
name|dir_name
argument_list|,
name|SYS_CA_SYS_GUID
argument_list|,
operator|&
name|ca
operator|->
name|system_guid
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|snprintf
argument_list|(
name|dir_name
argument_list|,
sizeof|sizeof
argument_list|(
name|dir_name
argument_list|)
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|SYS_INFINIBAND
argument_list|,
name|ca
operator|->
name|ca_name
argument_list|,
name|SYS_CA_PORTS_DIR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sys_scandir
argument_list|(
name|dir_name
argument_list|,
operator|&
name|namelist
argument_list|,
name|NULL
argument_list|,
name|alphasort
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|ret
operator|=
name|errno
operator|<
literal|0
condition|?
name|errno
else|:
operator|-
name|EIO
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|r
condition|;
name|i
operator|++
control|)
block|{
name|portnum
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
literal|"."
argument_list|,
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
literal|".."
argument_list|,
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
literal|"0"
argument_list|,
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|)
operator|&&
operator|(
operator|(
name|portnum
operator|=
name|atoi
argument_list|(
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|)
operator|)
operator|<=
literal|0
operator|||
name|portnum
operator|>=
name|UMAD_CA_MAX_PORTS
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|ca
operator|->
name|ports
index|[
name|portnum
index|]
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ca
operator|->
name|ports
index|[
name|portnum
index|]
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
if|if
condition|(
name|get_port
argument_list|(
name|ca_name
argument_list|,
name|dir_name
argument_list|,
name|portnum
argument_list|,
name|ca
operator|->
name|ports
index|[
name|portnum
index|]
argument_list|)
operator|<
literal|0
condition|)
block|{
name|free
argument_list|(
name|ca
operator|->
name|ports
index|[
name|portnum
index|]
argument_list|)
expr_stmt|;
name|ca
operator|->
name|ports
index|[
name|portnum
index|]
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
if|if
condition|(
name|ca
operator|->
name|numports
operator|<
name|portnum
condition|)
name|ca
operator|->
name|numports
operator|=
name|portnum
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|r
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|namelist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|namelist
argument_list|)
expr_stmt|;
name|put_ca
argument_list|(
name|ca
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|clean
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|r
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|namelist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|namelist
argument_list|)
expr_stmt|;
name|error
label|:
name|release_ca
argument_list|(
name|ca
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|umad_id_to_dev
parameter_list|(
name|int
name|umad_id
parameter_list|,
name|char
modifier|*
name|dev
parameter_list|,
name|unsigned
modifier|*
name|port
parameter_list|)
block|{
name|char
name|path
index|[
literal|256
index|]
decl_stmt|;
name|int
name|r
decl_stmt|;
name|snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
name|SYS_INFINIBAND_MAD
literal|"/umad%d"
argument_list|,
name|umad_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sys_read_string
argument_list|(
name|path
argument_list|,
name|SYS_IB_MAD_DEV
argument_list|,
name|dev
argument_list|,
name|UMAD_CA_NAME_LEN
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
operator|(
name|r
operator|=
name|sys_read_uint
argument_list|(
name|path
argument_list|,
name|SYS_IB_MAD_PORT
argument_list|,
name|port
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dev_to_umad_id
parameter_list|(
specifier|const
name|char
modifier|*
name|dev
parameter_list|,
name|unsigned
name|port
parameter_list|)
block|{
name|char
name|umad_dev
index|[
name|UMAD_CA_NAME_LEN
index|]
decl_stmt|;
name|unsigned
name|umad_port
decl_stmt|;
name|int
name|id
decl_stmt|;
for|for
control|(
name|id
operator|=
literal|0
init|;
name|id
operator|<
name|UMAD_MAX_PORTS
condition|;
name|id
operator|++
control|)
block|{
if|if
condition|(
name|umad_id_to_dev
argument_list|(
name|id
argument_list|,
name|umad_dev
argument_list|,
operator|&
name|umad_port
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
name|strncmp
argument_list|(
name|dev
argument_list|,
name|umad_dev
argument_list|,
name|UMAD_CA_NAME_LEN
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|port
operator|!=
name|umad_port
condition|)
continue|continue;
name|DEBUG
argument_list|(
literal|"mapped %s %d to %d"
argument_list|,
name|dev
argument_list|,
name|port
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
name|id
return|;
block|}
return|return
operator|-
literal|1
return|;
comment|/* not found */
block|}
end_function

begin_comment
comment|/*******************************  * Public interface  */
end_comment

begin_function
name|int
name|umad_init
parameter_list|(
name|void
parameter_list|)
block|{
name|TRACE
argument_list|(
literal|"umad_init"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|IB_UMAD_ABI_DIR
argument_list|,
name|IB_UMAD_ABI_FILE
argument_list|,
operator|&
name|abi_version
argument_list|)
operator|<
literal|0
condition|)
block|{
name|IBWARN
argument_list|(
literal|"can't read ABI version from %s/%s (%m): is ib_umad module loaded?"
argument_list|,
name|IB_UMAD_ABI_DIR
argument_list|,
name|IB_UMAD_ABI_FILE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|abi_version
operator|<
name|IB_UMAD_ABI_VERSION
condition|)
block|{
name|IBWARN
argument_list|(
literal|"wrong ABI version: %s/%s is %d but library minimal ABI is %d"
argument_list|,
name|IB_UMAD_ABI_DIR
argument_list|,
name|IB_UMAD_ABI_FILE
argument_list|,
name|abi_version
argument_list|,
name|IB_UMAD_ABI_VERSION
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_done
parameter_list|(
name|void
parameter_list|)
block|{
name|TRACE
argument_list|(
literal|"umad_done"
argument_list|)
expr_stmt|;
comment|/* FIXME - verify that all ports are closed */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|is_ib_type
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|)
block|{
name|char
name|dir_name
index|[
literal|256
index|]
decl_stmt|;
name|unsigned
name|type
decl_stmt|;
name|snprintf
argument_list|(
name|dir_name
argument_list|,
sizeof|sizeof
argument_list|(
name|dir_name
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|SYS_INFINIBAND
argument_list|,
name|ca_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|sys_read_uint
argument_list|(
name|dir_name
argument_list|,
name|SYS_NODE_TYPE
argument_list|,
operator|&
name|type
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|type
operator|>=
literal|1
operator|&&
name|type
operator|<=
literal|3
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_get_cas_names
parameter_list|(
name|char
name|cas
index|[]
index|[
name|UMAD_CA_NAME_LEN
index|]
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|struct
name|dirent
modifier|*
modifier|*
name|namelist
decl_stmt|;
name|int
name|n
decl_stmt|,
name|i
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|;
name|TRACE
argument_list|(
literal|"max %d"
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|n
operator|=
name|sys_scandir
argument_list|(
name|SYS_INFINIBAND
argument_list|,
operator|&
name|namelist
argument_list|,
name|NULL
argument_list|,
name|alphasort
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|,
literal|"."
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|,
literal|".."
argument_list|)
condition|)
block|{
if|if
condition|(
name|j
operator|<
name|max
operator|&&
name|is_ib_type
argument_list|(
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|)
condition|)
name|strncpy
argument_list|(
name|cas
index|[
name|j
operator|++
index|]
argument_list|,
name|namelist
index|[
name|i
index|]
operator|->
name|d_name
argument_list|,
name|UMAD_CA_NAME_LEN
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|namelist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|DEBUG
argument_list|(
literal|"return %d cas"
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Is this still needed ? */
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cas
argument_list|,
name|def_ca_name
argument_list|,
name|UMAD_CA_NAME_LEN
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|"return 1 ca"
argument_list|)
expr_stmt|;
name|j
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|>=
literal|0
condition|)
name|free
argument_list|(
name|namelist
argument_list|)
expr_stmt|;
return|return
name|j
return|;
block|}
end_function

begin_function
name|int
name|umad_get_ca_portguids
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
name|__be64
modifier|*
name|portguids
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|umad_ca_t
name|ca
decl_stmt|;
name|int
name|ports
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|TRACE
argument_list|(
literal|"ca name %s max port guids %d"
argument_list|,
name|ca_name
argument_list|,
name|max
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ca_name
operator|=
name|resolve_ca_name
argument_list|(
name|ca_name
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
return|return
operator|-
name|ENODEV
return|;
if|if
condition|(
name|umad_get_ca
argument_list|(
name|ca_name
argument_list|,
operator|&
name|ca
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|portguids
condition|)
block|{
if|if
condition|(
name|ca
operator|.
name|numports
operator|+
literal|1
operator|>
name|max
condition|)
block|{
name|release_ca
argument_list|(
operator|&
name|ca
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|ca
operator|.
name|numports
condition|;
name|i
operator|++
control|)
name|portguids
index|[
name|ports
operator|++
index|]
operator|=
name|ca
operator|.
name|ports
index|[
name|i
index|]
condition|?
name|ca
operator|.
name|ports
index|[
name|i
index|]
operator|->
name|port_guid
else|:
name|htobe64
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|release_ca
argument_list|(
operator|&
name|ca
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|"%s: %d ports"
argument_list|,
name|ca_name
argument_list|,
name|ports
argument_list|)
expr_stmt|;
return|return
name|ports
return|;
block|}
end_function

begin_function
name|int
name|umad_get_issm_path
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
name|int
name|portnum
parameter_list|,
name|char
name|path
index|[]
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|int
name|umad_id
decl_stmt|;
name|TRACE
argument_list|(
literal|"ca %s port %d"
argument_list|,
name|ca_name
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ca_name
operator|=
name|resolve_ca_name
argument_list|(
name|ca_name
argument_list|,
operator|&
name|portnum
argument_list|)
operator|)
condition|)
return|return
operator|-
name|ENODEV
return|;
if|if
condition|(
operator|(
name|umad_id
operator|=
name|dev_to_umad_id
argument_list|(
name|ca_name
argument_list|,
name|portnum
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|snprintf
argument_list|(
name|path
argument_list|,
name|max
argument_list|,
literal|"%s/issm%u"
argument_list|,
name|UMAD_DEV_DIR
argument_list|,
name|umad_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_open_port
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
name|int
name|portnum
parameter_list|)
block|{
name|char
name|dev_file
index|[
name|UMAD_DEV_FILE_SZ
index|]
decl_stmt|;
name|int
name|umad_id
decl_stmt|,
name|fd
decl_stmt|;
name|TRACE
argument_list|(
literal|"ca %s port %d"
argument_list|,
name|ca_name
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ca_name
operator|=
name|resolve_ca_name
argument_list|(
name|ca_name
argument_list|,
operator|&
name|portnum
argument_list|)
operator|)
condition|)
return|return
operator|-
name|ENODEV
return|;
name|DEBUG
argument_list|(
literal|"opening %s port %d"
argument_list|,
name|ca_name
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|umad_id
operator|=
name|dev_to_umad_id
argument_list|(
name|ca_name
argument_list|,
name|portnum
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|snprintf
argument_list|(
name|dev_file
argument_list|,
sizeof|sizeof
argument_list|(
name|dev_file
argument_list|)
argument_list|,
literal|"%s/umad%d"
argument_list|,
name|UMAD_DEV_DIR
argument_list|,
name|umad_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|dev_file
argument_list|,
name|O_RDWR
operator||
name|O_NONBLOCK
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
literal|"open %s failed: %s"
argument_list|,
name|dev_file
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
if|if
condition|(
name|abi_version
operator|>
literal|5
operator|||
operator|!
name|ioctl
argument_list|(
name|fd
argument_list|,
name|IB_USER_MAD_ENABLE_PKEY
argument_list|,
name|NULL
argument_list|)
condition|)
name|new_user_mad_api
operator|=
literal|1
expr_stmt|;
else|else
name|new_user_mad_api
operator|=
literal|0
expr_stmt|;
name|DEBUG
argument_list|(
literal|"opened %s fd %d portid %d"
argument_list|,
name|dev_file
argument_list|,
name|fd
argument_list|,
name|umad_id
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
end_function

begin_function
name|int
name|umad_get_ca
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
name|umad_ca_t
modifier|*
name|ca
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|TRACE
argument_list|(
literal|"ca_name %s"
argument_list|,
name|ca_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ca_name
operator|=
name|resolve_ca_name
argument_list|(
name|ca_name
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
return|return
operator|-
name|ENODEV
return|;
if|if
condition|(
name|find_cached_ca
argument_list|(
name|ca_name
argument_list|,
name|ca
argument_list|)
operator|>
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|r
operator|=
name|get_ca
argument_list|(
name|ca_name
argument_list|,
name|ca
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|DEBUG
argument_list|(
literal|"opened %s"
argument_list|,
name|ca_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_release_ca
parameter_list|(
name|umad_ca_t
modifier|*
name|ca
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|TRACE
argument_list|(
literal|"ca_name %s"
argument_list|,
name|ca
operator|->
name|ca_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ca
condition|)
return|return
operator|-
name|ENODEV
return|;
if|if
condition|(
operator|(
name|r
operator|=
name|release_ca
argument_list|(
name|ca
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|DEBUG
argument_list|(
literal|"releasing %s"
argument_list|,
name|ca
operator|->
name|ca_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_get_port
parameter_list|(
specifier|const
name|char
modifier|*
name|ca_name
parameter_list|,
name|int
name|portnum
parameter_list|,
name|umad_port_t
modifier|*
name|port
parameter_list|)
block|{
name|char
name|dir_name
index|[
literal|256
index|]
decl_stmt|;
name|TRACE
argument_list|(
literal|"ca_name %s portnum %d"
argument_list|,
name|ca_name
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ca_name
operator|=
name|resolve_ca_name
argument_list|(
name|ca_name
argument_list|,
operator|&
name|portnum
argument_list|)
operator|)
condition|)
return|return
operator|-
name|ENODEV
return|;
name|snprintf
argument_list|(
name|dir_name
argument_list|,
sizeof|sizeof
argument_list|(
name|dir_name
argument_list|)
argument_list|,
literal|"%s/%s/%s"
argument_list|,
name|SYS_INFINIBAND
argument_list|,
name|ca_name
argument_list|,
name|SYS_CA_PORTS_DIR
argument_list|)
expr_stmt|;
return|return
name|get_port
argument_list|(
name|ca_name
argument_list|,
name|dir_name
argument_list|,
name|portnum
argument_list|,
name|port
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|umad_release_port
parameter_list|(
name|umad_port_t
modifier|*
name|port
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|TRACE
argument_list|(
literal|"port %s:%d"
argument_list|,
name|port
operator|->
name|ca_name
argument_list|,
name|port
operator|->
name|portnum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
return|return
operator|-
name|ENODEV
return|;
if|if
condition|(
operator|(
name|r
operator|=
name|release_port
argument_list|(
name|port
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|DEBUG
argument_list|(
literal|"releasing %s:%d"
argument_list|,
name|port
operator|->
name|ca_name
argument_list|,
name|port
operator|->
name|portnum
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_close_port
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|"closed fd %d"
argument_list|,
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|umad_get_mad
parameter_list|(
name|void
modifier|*
name|umad
parameter_list|)
block|{
return|return
name|new_user_mad_api
condition|?
operator|(
operator|(
expr|struct
name|ib_user_mad
operator|*
operator|)
name|umad
operator|)
operator|->
name|data
else|:
operator|(
name|void
operator|*
operator|)
operator|&
operator|(
operator|(
expr|struct
name|ib_user_mad
operator|*
operator|)
name|umad
operator|)
operator|->
name|addr
operator|.
name|pkey_index
return|;
block|}
end_function

begin_function
name|size_t
name|umad_size
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|new_user_mad_api
condition|?
sizeof|sizeof
argument_list|(
expr|struct
name|ib_user_mad
argument_list|)
else|:
sizeof|sizeof
argument_list|(
expr|struct
name|ib_user_mad
argument_list|)
operator|-
literal|8
return|;
block|}
end_function

begin_function
name|int
name|umad_set_grh
parameter_list|(
name|void
modifier|*
name|umad
parameter_list|,
name|void
modifier|*
name|mad_addr
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
name|struct
name|ib_mad_addr
modifier|*
name|addr
init|=
name|mad_addr
decl_stmt|;
if|if
condition|(
name|mad_addr
condition|)
block|{
name|mad
operator|->
name|addr
operator|.
name|grh_present
operator|=
literal|1
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|ib_gid
operator|=
name|addr
operator|->
name|ib_gid
expr_stmt|;
comment|/* The definition for umad_set_grh requires that the input be 		 * in host order */
name|mad
operator|->
name|addr
operator|.
name|flow_label
operator|=
name|htobe32
argument_list|(
operator|(
name|uint32_t
operator|)
name|addr
operator|->
name|flow_label
argument_list|)
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|hop_limit
operator|=
name|addr
operator|->
name|hop_limit
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|traffic_class
operator|=
name|addr
operator|->
name|traffic_class
expr_stmt|;
block|}
else|else
name|mad
operator|->
name|addr
operator|.
name|grh_present
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_set_pkey
parameter_list|(
name|void
modifier|*
name|umad
parameter_list|,
name|int
name|pkey_index
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
if|if
condition|(
name|new_user_mad_api
condition|)
name|mad
operator|->
name|addr
operator|.
name|pkey_index
operator|=
name|pkey_index
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_get_pkey
parameter_list|(
name|void
modifier|*
name|umad
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
if|if
condition|(
name|new_user_mad_api
condition|)
return|return
name|mad
operator|->
name|addr
operator|.
name|pkey_index
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_set_addr
parameter_list|(
name|void
modifier|*
name|umad
parameter_list|,
name|int
name|dlid
parameter_list|,
name|int
name|dqp
parameter_list|,
name|int
name|sl
parameter_list|,
name|int
name|qkey
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
name|TRACE
argument_list|(
literal|"umad %p dlid %u dqp %d sl %d, qkey %x"
argument_list|,
name|umad
argument_list|,
name|dlid
argument_list|,
name|dqp
argument_list|,
name|sl
argument_list|,
name|qkey
argument_list|)
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|qpn
operator|=
name|htobe32
argument_list|(
name|dqp
argument_list|)
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|lid
operator|=
name|htobe16
argument_list|(
name|dlid
argument_list|)
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|qkey
operator|=
name|htobe32
argument_list|(
name|qkey
argument_list|)
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|sl
operator|=
name|sl
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_set_addr_net
parameter_list|(
name|void
modifier|*
name|umad
parameter_list|,
name|__be16
name|dlid
parameter_list|,
name|__be32
name|dqp
parameter_list|,
name|int
name|sl
parameter_list|,
name|__be32
name|qkey
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
name|TRACE
argument_list|(
literal|"umad %p dlid %u dqp %d sl %d qkey %x"
argument_list|,
name|umad
argument_list|,
name|be16toh
argument_list|(
name|dlid
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|dqp
argument_list|)
argument_list|,
name|sl
argument_list|,
name|be32toh
argument_list|(
name|qkey
argument_list|)
argument_list|)
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|qpn
operator|=
name|dqp
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|lid
operator|=
name|dlid
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|qkey
operator|=
name|qkey
expr_stmt|;
name|mad
operator|->
name|addr
operator|.
name|sl
operator|=
name|sl
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|umad_send
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|agentid
parameter_list|,
name|void
modifier|*
name|umad
parameter_list|,
name|int
name|length
parameter_list|,
name|int
name|timeout_ms
parameter_list|,
name|int
name|retries
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
name|int
name|n
decl_stmt|;
name|TRACE
argument_list|(
literal|"fd %d agentid %d umad %p timeout %u"
argument_list|,
name|fd
argument_list|,
name|agentid
argument_list|,
name|umad
argument_list|,
name|timeout_ms
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|mad
operator|->
name|timeout_ms
operator|=
name|timeout_ms
expr_stmt|;
name|mad
operator|->
name|retries
operator|=
name|retries
expr_stmt|;
name|mad
operator|->
name|agent_id
operator|=
name|agentid
expr_stmt|;
if|if
condition|(
name|umaddebug
operator|>
literal|1
condition|)
name|umad_dump
argument_list|(
name|mad
argument_list|)
expr_stmt|;
name|n
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|mad
argument_list|,
name|length
operator|+
name|umad_size
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|length
operator|+
name|umad_size
argument_list|()
condition|)
return|return
literal|0
return|;
name|DEBUG
argument_list|(
literal|"write returned %d != sizeof umad %zu + length %d (%m)"
argument_list|,
name|n
argument_list|,
name|umad_size
argument_list|()
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|errno
condition|)
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dev_poll
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|timeout_ms
parameter_list|)
block|{
name|struct
name|pollfd
name|ufds
decl_stmt|;
name|int
name|n
decl_stmt|;
name|ufds
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
name|ufds
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|poll
argument_list|(
operator|&
name|ufds
argument_list|,
literal|1
argument_list|,
name|timeout_ms
argument_list|)
operator|)
operator|==
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
return|return
operator|-
name|ETIMEDOUT
return|;
return|return
operator|-
name|EIO
return|;
block|}
end_function

begin_function
name|int
name|umad_recv
parameter_list|(
name|int
name|fd
parameter_list|,
name|void
modifier|*
name|umad
parameter_list|,
name|int
modifier|*
name|length
parameter_list|,
name|int
name|timeout_ms
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
name|int
name|n
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|TRACE
argument_list|(
literal|"fd %d umad %p timeout %u"
argument_list|,
name|fd
argument_list|,
name|umad
argument_list|,
name|timeout_ms
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|umad
operator|||
operator|!
name|length
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|timeout_ms
operator|&&
operator|(
name|n
operator|=
name|dev_poll
argument_list|(
name|fd
argument_list|,
name|timeout_ms
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|errno
condition|)
name|errno
operator|=
operator|-
name|n
expr_stmt|;
return|return
name|n
return|;
block|}
name|n
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|umad
argument_list|,
name|umad_size
argument_list|()
operator|+
operator|*
name|length
argument_list|)
expr_stmt|;
name|VALGRIND_MAKE_MEM_DEFINED
argument_list|(
name|umad
argument_list|,
name|umad_size
argument_list|()
operator|+
operator|*
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|n
operator|<=
name|umad_size
argument_list|()
operator|+
operator|*
name|length
operator|)
condition|)
block|{
name|DEBUG
argument_list|(
literal|"mad received by agent %d length %d"
argument_list|,
name|mad
operator|->
name|agent_id
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|umad_size
argument_list|()
condition|)
operator|*
name|length
operator|=
name|n
operator|-
name|umad_size
argument_list|()
expr_stmt|;
else|else
operator|*
name|length
operator|=
literal|0
expr_stmt|;
return|return
name|mad
operator|->
name|agent_id
return|;
block|}
if|if
condition|(
name|n
operator|==
operator|-
name|EWOULDBLOCK
condition|)
block|{
if|if
condition|(
operator|!
name|errno
condition|)
name|errno
operator|=
name|EWOULDBLOCK
expr_stmt|;
return|return
name|n
return|;
block|}
name|DEBUG
argument_list|(
literal|"read returned %zu> sizeof umad %zu + length %d (%m)"
argument_list|,
name|mad
operator|->
name|length
operator|-
name|umad_size
argument_list|()
argument_list|,
name|umad_size
argument_list|()
argument_list|,
operator|*
name|length
argument_list|)
expr_stmt|;
operator|*
name|length
operator|=
name|mad
operator|->
name|length
operator|-
name|umad_size
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|errno
condition|)
name|errno
operator|=
name|EIO
expr_stmt|;
return|return
operator|-
name|errno
return|;
block|}
end_function

begin_function
name|int
name|umad_poll
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|timeout_ms
parameter_list|)
block|{
name|TRACE
argument_list|(
literal|"fd %d timeout %u"
argument_list|,
name|fd
argument_list|,
name|timeout_ms
argument_list|)
expr_stmt|;
return|return
name|dev_poll
argument_list|(
name|fd
argument_list|,
name|timeout_ms
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|umad_get_fd
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|TRACE
argument_list|(
literal|"fd %d"
argument_list|,
name|fd
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
end_function

begin_function
name|int
name|umad_register_oui
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|mgmt_class
parameter_list|,
name|uint8_t
name|rmpp_version
parameter_list|,
name|uint8_t
name|oui
index|[
literal|3
index|]
parameter_list|,
name|long
name|method_mask
index|[]
parameter_list|)
block|{
name|struct
name|ib_user_mad_reg_req
name|req
decl_stmt|;
name|TRACE
argument_list|(
literal|"fd %d mgmt_class %u rmpp_version %d oui 0x%x%x%x method_mask %p"
argument_list|,
name|fd
argument_list|,
name|mgmt_class
argument_list|,
operator|(
name|int
operator|)
name|rmpp_version
argument_list|,
operator|(
name|int
operator|)
name|oui
index|[
literal|0
index|]
argument_list|,
operator|(
name|int
operator|)
name|oui
index|[
literal|1
index|]
argument_list|,
operator|(
name|int
operator|)
name|oui
index|[
literal|2
index|]
argument_list|,
name|method_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgmt_class
operator|<
literal|0x30
operator|||
name|mgmt_class
operator|>
literal|0x4f
condition|)
block|{
name|DEBUG
argument_list|(
literal|"mgmt class %d not in vendor range 2"
argument_list|,
name|mgmt_class
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|req
operator|.
name|qpn
operator|=
literal|1
expr_stmt|;
name|req
operator|.
name|mgmt_class
operator|=
name|mgmt_class
expr_stmt|;
name|req
operator|.
name|mgmt_class_version
operator|=
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|req
operator|.
name|oui
argument_list|,
name|oui
argument_list|,
sizeof|sizeof
name|req
operator|.
name|oui
argument_list|)
expr_stmt|;
name|req
operator|.
name|rmpp_version
operator|=
name|rmpp_version
expr_stmt|;
if|if
condition|(
name|method_mask
condition|)
name|memcpy
argument_list|(
name|req
operator|.
name|method_mask
argument_list|,
name|method_mask
argument_list|,
sizeof|sizeof
name|req
operator|.
name|method_mask
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|req
operator|.
name|method_mask
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|req
operator|.
name|method_mask
argument_list|)
expr_stmt|;
name|VALGRIND_MAKE_MEM_DEFINED
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ioctl
argument_list|(
name|fd
argument_list|,
name|IB_USER_MAD_REGISTER_AGENT
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|req
argument_list|)
condition|)
block|{
name|DEBUG
argument_list|(
literal|"fd %d registered to use agent %d qp %d class 0x%x oui %p"
argument_list|,
name|fd
argument_list|,
name|req
operator|.
name|id
argument_list|,
name|req
operator|.
name|qpn
argument_list|,
name|req
operator|.
name|mgmt_class
argument_list|,
name|oui
argument_list|)
expr_stmt|;
return|return
name|req
operator|.
name|id
return|;
comment|/* return agentid */
block|}
name|DEBUG
argument_list|(
literal|"fd %d registering qp %d class 0x%x version %d oui %p failed: %m"
argument_list|,
name|fd
argument_list|,
name|req
operator|.
name|qpn
argument_list|,
name|req
operator|.
name|mgmt_class
argument_list|,
name|req
operator|.
name|mgmt_class_version
argument_list|,
name|oui
argument_list|)
expr_stmt|;
return|return
operator|-
name|EPERM
return|;
block|}
end_function

begin_function
name|int
name|umad_register
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|mgmt_class
parameter_list|,
name|int
name|mgmt_version
parameter_list|,
name|uint8_t
name|rmpp_version
parameter_list|,
name|long
name|method_mask
index|[]
parameter_list|)
block|{
name|struct
name|ib_user_mad_reg_req
name|req
decl_stmt|;
name|__be32
name|oui
init|=
name|htobe32
argument_list|(
name|IB_OPENIB_OUI
argument_list|)
decl_stmt|;
name|int
name|qp
decl_stmt|;
name|TRACE
argument_list|(
literal|"fd %d mgmt_class %u mgmt_version %u rmpp_version %d method_mask %p"
argument_list|,
name|fd
argument_list|,
name|mgmt_class
argument_list|,
name|mgmt_version
argument_list|,
name|rmpp_version
argument_list|,
name|method_mask
argument_list|)
expr_stmt|;
name|req
operator|.
name|qpn
operator|=
name|qp
operator|=
operator|(
name|mgmt_class
operator|==
literal|0x1
operator|||
name|mgmt_class
operator|==
literal|0x81
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|req
operator|.
name|mgmt_class
operator|=
name|mgmt_class
expr_stmt|;
name|req
operator|.
name|mgmt_class_version
operator|=
name|mgmt_version
expr_stmt|;
name|req
operator|.
name|rmpp_version
operator|=
name|rmpp_version
expr_stmt|;
if|if
condition|(
name|method_mask
condition|)
name|memcpy
argument_list|(
name|req
operator|.
name|method_mask
argument_list|,
name|method_mask
argument_list|,
sizeof|sizeof
name|req
operator|.
name|method_mask
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|req
operator|.
name|method_mask
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|req
operator|.
name|method_mask
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|req
operator|.
name|oui
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|oui
operator|+
literal|1
argument_list|,
sizeof|sizeof
name|req
operator|.
name|oui
argument_list|)
expr_stmt|;
name|VALGRIND_MAKE_MEM_DEFINED
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ioctl
argument_list|(
name|fd
argument_list|,
name|IB_USER_MAD_REGISTER_AGENT
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|req
argument_list|)
condition|)
block|{
name|DEBUG
argument_list|(
literal|"fd %d registered to use agent %d qp %d"
argument_list|,
name|fd
argument_list|,
name|req
operator|.
name|id
argument_list|,
name|qp
argument_list|)
expr_stmt|;
return|return
name|req
operator|.
name|id
return|;
comment|/* return agentid */
block|}
name|DEBUG
argument_list|(
literal|"fd %d registering qp %d class 0x%x version %d failed: %m"
argument_list|,
name|fd
argument_list|,
name|qp
argument_list|,
name|mgmt_class
argument_list|,
name|mgmt_version
argument_list|)
expr_stmt|;
return|return
operator|-
name|EPERM
return|;
block|}
end_function

begin_function
name|int
name|umad_register2
parameter_list|(
name|int
name|port_fd
parameter_list|,
name|struct
name|umad_reg_attr
modifier|*
name|attr
parameter_list|,
name|uint32_t
modifier|*
name|agent_id
parameter_list|)
block|{
name|struct
name|ib_user_mad_reg_req2
name|req
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
operator|!
name|attr
operator|||
operator|!
name|agent_id
condition|)
return|return
name|EINVAL
return|;
name|TRACE
argument_list|(
literal|"fd %d mgmt_class %u mgmt_class_version %u flags 0x%08x "
literal|"method_mask 0x%016"
name|PRIx64
literal|" %016"
name|PRIx64
literal|"oui 0x%06x rmpp_version %u "
argument_list|,
name|port_fd
argument_list|,
name|attr
operator|->
name|mgmt_class
argument_list|,
name|attr
operator|->
name|mgmt_class_version
argument_list|,
name|attr
operator|->
name|flags
argument_list|,
name|attr
operator|->
name|method_mask
index|[
literal|0
index|]
argument_list|,
name|attr
operator|->
name|method_mask
index|[
literal|1
index|]
argument_list|,
name|attr
operator|->
name|oui
argument_list|,
name|attr
operator|->
name|rmpp_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|mgmt_class
operator|>=
literal|0x30
operator|&&
name|attr
operator|->
name|mgmt_class
operator|<=
literal|0x4f
operator|&&
operator|(
operator|(
name|attr
operator|->
name|oui
operator|&
literal|0x00ffffff
operator|)
operator|==
literal|0
operator|||
operator|(
name|attr
operator|->
name|oui
operator|&
literal|0xff000000
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|DEBUG
argument_list|(
literal|"mgmt class %d is in vendor range 2 but oui (0x%08x) is invalid"
argument_list|,
name|attr
operator|->
name|mgmt_class
argument_list|,
name|attr
operator|->
name|oui
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|mgmt_class
operator|=
name|attr
operator|->
name|mgmt_class
expr_stmt|;
name|req
operator|.
name|mgmt_class_version
operator|=
name|attr
operator|->
name|mgmt_class_version
expr_stmt|;
name|req
operator|.
name|qpn
operator|=
operator|(
name|attr
operator|->
name|mgmt_class
operator|==
literal|0x1
operator|||
name|attr
operator|->
name|mgmt_class
operator|==
literal|0x81
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|attr
operator|->
name|flags
expr_stmt|;
name|memcpy
argument_list|(
name|req
operator|.
name|method_mask
argument_list|,
name|attr
operator|->
name|method_mask
argument_list|,
sizeof|sizeof
name|req
operator|.
name|method_mask
argument_list|)
expr_stmt|;
name|req
operator|.
name|oui
operator|=
name|attr
operator|->
name|oui
expr_stmt|;
name|req
operator|.
name|rmpp_version
operator|=
name|attr
operator|->
name|rmpp_version
expr_stmt|;
name|VALGRIND_MAKE_MEM_DEFINED
argument_list|(
operator|&
name|req
argument_list|,
sizeof|sizeof
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|ioctl
argument_list|(
name|port_fd
argument_list|,
name|IB_USER_MAD_REGISTER_AGENT2
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|req
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
literal|"fd %d registered to use agent %d qp %d class 0x%x oui 0x%06x"
argument_list|,
name|port_fd
argument_list|,
name|req
operator|.
name|id
argument_list|,
name|req
operator|.
name|qpn
argument_list|,
name|req
operator|.
name|mgmt_class
argument_list|,
name|attr
operator|->
name|oui
argument_list|)
expr_stmt|;
operator|*
name|agent_id
operator|=
name|req
operator|.
name|id
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|errno
operator|==
name|ENOTTY
operator|||
name|errno
operator|==
name|EINVAL
condition|)
block|{
name|TRACE
argument_list|(
literal|"no kernel support for registration flags"
argument_list|)
expr_stmt|;
name|req
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|flags
operator|==
literal|0
condition|)
block|{
name|struct
name|ib_user_mad_reg_req
name|req_v1
decl_stmt|;
name|TRACE
argument_list|(
literal|"attempting original register ioctl"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req_v1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req_v1
argument_list|)
argument_list|)
expr_stmt|;
name|req_v1
operator|.
name|mgmt_class
operator|=
name|req
operator|.
name|mgmt_class
expr_stmt|;
name|req_v1
operator|.
name|mgmt_class_version
operator|=
name|req
operator|.
name|mgmt_class_version
expr_stmt|;
name|req_v1
operator|.
name|qpn
operator|=
name|req
operator|.
name|qpn
expr_stmt|;
name|req_v1
operator|.
name|rmpp_version
operator|=
name|req
operator|.
name|rmpp_version
expr_stmt|;
name|req_v1
operator|.
name|oui
index|[
literal|0
index|]
operator|=
operator|(
name|req
operator|.
name|oui
operator|&
literal|0xff0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|req_v1
operator|.
name|oui
index|[
literal|1
index|]
operator|=
operator|(
name|req
operator|.
name|oui
operator|&
literal|0x00ff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|req_v1
operator|.
name|oui
index|[
literal|2
index|]
operator|=
name|req
operator|.
name|oui
operator|&
literal|0x0000ff
expr_stmt|;
name|memcpy
argument_list|(
name|req_v1
operator|.
name|method_mask
argument_list|,
name|req
operator|.
name|method_mask
argument_list|,
sizeof|sizeof
name|req_v1
operator|.
name|method_mask
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|ioctl
argument_list|(
name|port_fd
argument_list|,
name|IB_USER_MAD_REGISTER_AGENT
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|req_v1
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|DEBUG
argument_list|(
literal|"fd %d registered to use agent %d qp %d class 0x%x oui 0x%06x"
argument_list|,
name|port_fd
argument_list|,
name|req_v1
operator|.
name|id
argument_list|,
name|req_v1
operator|.
name|qpn
argument_list|,
name|req_v1
operator|.
name|mgmt_class
argument_list|,
name|attr
operator|->
name|oui
argument_list|)
expr_stmt|;
operator|*
name|agent_id
operator|=
name|req_v1
operator|.
name|id
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
name|rc
operator|=
name|errno
expr_stmt|;
name|attr
operator|->
name|flags
operator|=
name|req
operator|.
name|flags
expr_stmt|;
name|DEBUG
argument_list|(
literal|"fd %d registering qp %d class 0x%x version %d "
literal|"oui 0x%06x failed flags returned 0x%x : %m"
argument_list|,
name|port_fd
argument_list|,
name|req
operator|.
name|qpn
argument_list|,
name|req
operator|.
name|mgmt_class
argument_list|,
name|req
operator|.
name|mgmt_class_version
argument_list|,
name|attr
operator|->
name|oui
argument_list|,
name|req
operator|.
name|flags
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|umad_unregister
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|agentid
parameter_list|)
block|{
name|TRACE
argument_list|(
literal|"fd %d unregistering agent %d"
argument_list|,
name|fd
argument_list|,
name|agentid
argument_list|)
expr_stmt|;
return|return
name|ioctl
argument_list|(
name|fd
argument_list|,
name|IB_USER_MAD_UNREGISTER_AGENT
argument_list|,
operator|&
name|agentid
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|umad_status
parameter_list|(
name|void
modifier|*
name|umad
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
return|return
name|mad
operator|->
name|status
return|;
block|}
end_function

begin_function
name|ib_mad_addr_t
modifier|*
name|umad_get_mad_addr
parameter_list|(
name|void
modifier|*
name|umad
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
return|return
operator|&
name|mad
operator|->
name|addr
return|;
block|}
end_function

begin_function
name|int
name|umad_debug
parameter_list|(
name|int
name|level
parameter_list|)
block|{
if|if
condition|(
name|level
operator|>=
literal|0
condition|)
name|umaddebug
operator|=
name|level
expr_stmt|;
return|return
name|umaddebug
return|;
block|}
end_function

begin_function
name|void
name|umad_addr_dump
parameter_list|(
name|ib_mad_addr_t
modifier|*
name|addr
parameter_list|)
block|{
define|#
directive|define
name|HEX
parameter_list|(
name|x
parameter_list|)
value|((x)< 10 ? '0' + (x) : 'a' + ((x) -10))
name|char
name|gid_str
index|[
literal|64
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
name|addr
operator|->
name|gid
condition|;
name|i
operator|++
control|)
block|{
name|gid_str
index|[
name|i
operator|*
literal|2
index|]
operator|=
name|HEX
argument_list|(
name|addr
operator|->
name|gid
index|[
name|i
index|]
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|gid_str
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|HEX
argument_list|(
name|addr
operator|->
name|gid
index|[
name|i
index|]
operator|&
literal|0xf
argument_list|)
expr_stmt|;
block|}
name|gid_str
index|[
name|i
operator|*
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|IBWARN
argument_list|(
literal|"qpn %d qkey 0x%x lid %u sl %d\n"
literal|"grh_present %d gid_index %d hop_limit %d traffic_class %d flow_label 0x%x pkey_index 0x%x\n"
literal|"Gid 0x%s"
argument_list|,
name|be32toh
argument_list|(
name|addr
operator|->
name|qpn
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|addr
operator|->
name|qkey
argument_list|)
argument_list|,
name|be16toh
argument_list|(
name|addr
operator|->
name|lid
argument_list|)
argument_list|,
name|addr
operator|->
name|sl
argument_list|,
name|addr
operator|->
name|grh_present
argument_list|,
operator|(
name|int
operator|)
name|addr
operator|->
name|gid_index
argument_list|,
operator|(
name|int
operator|)
name|addr
operator|->
name|hop_limit
argument_list|,
operator|(
name|int
operator|)
name|addr
operator|->
name|traffic_class
argument_list|,
name|addr
operator|->
name|flow_label
argument_list|,
name|addr
operator|->
name|pkey_index
argument_list|,
name|gid_str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|umad_dump
parameter_list|(
name|void
modifier|*
name|umad
parameter_list|)
block|{
name|struct
name|ib_user_mad
modifier|*
name|mad
init|=
name|umad
decl_stmt|;
name|IBWARN
argument_list|(
literal|"agent id %d status %x timeout %d"
argument_list|,
name|mad
operator|->
name|agent_id
argument_list|,
name|mad
operator|->
name|status
argument_list|,
name|mad
operator|->
name|timeout_ms
argument_list|)
expr_stmt|;
name|umad_addr_dump
argument_list|(
operator|&
name|mad
operator|->
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


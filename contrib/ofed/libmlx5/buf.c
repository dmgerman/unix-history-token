begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2012 Mellanox Technologies, Inc.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/ipc.h>
end_include

begin_include
include|#
directive|include
file|<sys/shm.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"mlx5.h"
end_include

begin_include
include|#
directive|include
file|"bitmap.h"
end_include

begin_function
specifier|static
name|int
name|mlx5_bitmap_init
parameter_list|(
name|struct
name|mlx5_bitmap
modifier|*
name|bitmap
parameter_list|,
name|uint32_t
name|num
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
name|bitmap
operator|->
name|last
operator|=
literal|0
expr_stmt|;
name|bitmap
operator|->
name|top
operator|=
literal|0
expr_stmt|;
name|bitmap
operator|->
name|max
operator|=
name|num
expr_stmt|;
name|bitmap
operator|->
name|avail
operator|=
name|num
expr_stmt|;
name|bitmap
operator|->
name|mask
operator|=
name|mask
expr_stmt|;
name|bitmap
operator|->
name|avail
operator|=
name|bitmap
operator|->
name|max
expr_stmt|;
name|bitmap
operator|->
name|table
operator|=
name|calloc
argument_list|(
name|BITS_TO_LONGS
argument_list|(
name|bitmap
operator|->
name|max
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bitmap
operator|->
name|table
condition|)
return|return
operator|-
name|ENOMEM
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bitmap_free_range
parameter_list|(
name|struct
name|mlx5_bitmap
modifier|*
name|bitmap
parameter_list|,
name|uint32_t
name|obj
parameter_list|,
name|int
name|cnt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|obj
operator|&=
name|bitmap
operator|->
name|max
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
name|mlx5_clear_bit
argument_list|(
name|obj
operator|+
name|i
argument_list|,
name|bitmap
operator|->
name|table
argument_list|)
expr_stmt|;
name|bitmap
operator|->
name|last
operator|=
name|min
argument_list|(
name|bitmap
operator|->
name|last
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|bitmap
operator|->
name|top
operator|=
operator|(
name|bitmap
operator|->
name|top
operator|+
name|bitmap
operator|->
name|max
operator|)
operator|&
name|bitmap
operator|->
name|mask
expr_stmt|;
name|bitmap
operator|->
name|avail
operator|+=
name|cnt
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bitmap_empty
parameter_list|(
name|struct
name|mlx5_bitmap
modifier|*
name|bitmap
parameter_list|)
block|{
return|return
operator|(
name|bitmap
operator|->
name|avail
operator|==
name|bitmap
operator|->
name|max
operator|)
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bitmap_avail
parameter_list|(
name|struct
name|mlx5_bitmap
modifier|*
name|bitmap
parameter_list|)
block|{
return|return
name|bitmap
operator|->
name|avail
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_bitmap_cleanup
parameter_list|(
name|struct
name|mlx5_bitmap
modifier|*
name|bitmap
parameter_list|)
block|{
if|if
condition|(
name|bitmap
operator|->
name|table
condition|)
name|free
argument_list|(
name|bitmap
operator|->
name|table
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_huge_mem
parameter_list|(
name|struct
name|mlx5_hugetlb_mem
modifier|*
name|hmem
parameter_list|)
block|{
name|mlx5_bitmap_cleanup
argument_list|(
operator|&
name|hmem
operator|->
name|bitmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|shmdt
argument_list|(
name|hmem
operator|->
name|shmaddr
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|mlx5_dbg
argument_list|(
name|stderr
argument_list|,
name|MLX5_DBG_CONTIG
argument_list|,
literal|"%s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|shmctl
argument_list|(
name|hmem
operator|->
name|shmid
argument_list|,
name|IPC_RMID
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|hmem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_bitmap_alloc
parameter_list|(
name|struct
name|mlx5_bitmap
modifier|*
name|bitmap
parameter_list|)
block|{
name|uint32_t
name|obj
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|obj
operator|=
name|mlx5_find_first_zero_bit
argument_list|(
name|bitmap
operator|->
name|table
argument_list|,
name|bitmap
operator|->
name|max
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|<
name|bitmap
operator|->
name|max
condition|)
block|{
name|mlx5_set_bit
argument_list|(
name|obj
argument_list|,
name|bitmap
operator|->
name|table
argument_list|)
expr_stmt|;
name|bitmap
operator|->
name|last
operator|=
operator|(
name|obj
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|bitmap
operator|->
name|last
operator|==
name|bitmap
operator|->
name|max
condition|)
name|bitmap
operator|->
name|last
operator|=
literal|0
expr_stmt|;
name|obj
operator||=
name|bitmap
operator|->
name|top
expr_stmt|;
name|ret
operator|=
name|obj
expr_stmt|;
block|}
else|else
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
operator|-
literal|1
condition|)
operator|--
name|bitmap
operator|->
name|avail
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|find_aligned_range
parameter_list|(
name|unsigned
name|long
modifier|*
name|bitmap
parameter_list|,
name|uint32_t
name|start
parameter_list|,
name|uint32_t
name|nbits
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|alignment
parameter_list|)
block|{
name|uint32_t
name|end
decl_stmt|,
name|i
decl_stmt|;
name|again
label|:
name|start
operator|=
name|align
argument_list|(
name|start
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|start
operator|<
name|nbits
operator|)
operator|&&
name|mlx5_test_bit
argument_list|(
name|start
argument_list|,
name|bitmap
argument_list|)
condition|)
name|start
operator|+=
name|alignment
expr_stmt|;
if|if
condition|(
name|start
operator|>=
name|nbits
condition|)
return|return
operator|-
literal|1
return|;
name|end
operator|=
name|start
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|end
operator|>
name|nbits
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
name|start
operator|+
literal|1
init|;
name|i
operator|<
name|end
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mlx5_test_bit
argument_list|(
name|i
argument_list|,
name|bitmap
argument_list|)
condition|)
block|{
name|start
operator|=
name|i
operator|+
literal|1
expr_stmt|;
goto|goto
name|again
goto|;
block|}
block|}
return|return
name|start
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bitmap_alloc_range
parameter_list|(
name|struct
name|mlx5_bitmap
modifier|*
name|bitmap
parameter_list|,
name|int
name|cnt
parameter_list|,
name|int
name|align
parameter_list|)
block|{
name|uint32_t
name|obj
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|1
operator|&&
name|align
operator|==
literal|1
condition|)
return|return
name|mlx5_bitmap_alloc
argument_list|(
name|bitmap
argument_list|)
return|;
if|if
condition|(
name|cnt
operator|>
name|bitmap
operator|->
name|max
condition|)
return|return
operator|-
literal|1
return|;
name|obj
operator|=
name|find_aligned_range
argument_list|(
name|bitmap
operator|->
name|table
argument_list|,
name|bitmap
operator|->
name|last
argument_list|,
name|bitmap
operator|->
name|max
argument_list|,
name|cnt
argument_list|,
name|align
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|>=
name|bitmap
operator|->
name|max
condition|)
block|{
name|bitmap
operator|->
name|top
operator|=
operator|(
name|bitmap
operator|->
name|top
operator|+
name|bitmap
operator|->
name|max
operator|)
operator|&
name|bitmap
operator|->
name|mask
expr_stmt|;
name|obj
operator|=
name|find_aligned_range
argument_list|(
name|bitmap
operator|->
name|table
argument_list|,
literal|0
argument_list|,
name|bitmap
operator|->
name|max
argument_list|,
name|cnt
argument_list|,
name|align
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|obj
operator|<
name|bitmap
operator|->
name|max
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
name|mlx5_set_bit
argument_list|(
name|obj
operator|+
name|i
argument_list|,
name|bitmap
operator|->
name|table
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|==
name|bitmap
operator|->
name|last
condition|)
block|{
name|bitmap
operator|->
name|last
operator|=
operator|(
name|obj
operator|+
name|cnt
operator|)
expr_stmt|;
if|if
condition|(
name|bitmap
operator|->
name|last
operator|>=
name|bitmap
operator|->
name|max
condition|)
name|bitmap
operator|->
name|last
operator|=
literal|0
expr_stmt|;
block|}
name|obj
operator||=
name|bitmap
operator|->
name|top
expr_stmt|;
name|ret
operator|=
name|obj
expr_stmt|;
block|}
else|else
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
operator|-
literal|1
condition|)
name|bitmap
operator|->
name|avail
operator|-=
name|cnt
expr_stmt|;
return|return
name|obj
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx5_hugetlb_mem
modifier|*
name|alloc_huge_mem
parameter_list|(
name|size_t
name|size
parameter_list|)
block|{
name|struct
name|mlx5_hugetlb_mem
modifier|*
name|hmem
decl_stmt|;
name|size_t
name|shm_len
decl_stmt|;
name|hmem
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hmem
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hmem
condition|)
return|return
name|NULL
return|;
name|shm_len
operator|=
name|align
argument_list|(
name|size
argument_list|,
name|MLX5_SHM_LENGTH
argument_list|)
expr_stmt|;
name|hmem
operator|->
name|shmid
operator|=
name|shmget
argument_list|(
name|IPC_PRIVATE
argument_list|,
name|shm_len
argument_list|,
name|SHM_HUGETLB
operator||
name|SHM_R
operator||
name|SHM_W
argument_list|)
expr_stmt|;
if|if
condition|(
name|hmem
operator|->
name|shmid
operator|==
operator|-
literal|1
condition|)
block|{
name|mlx5_dbg
argument_list|(
name|stderr
argument_list|,
name|MLX5_DBG_CONTIG
argument_list|,
literal|"%s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
name|hmem
operator|->
name|shmaddr
operator|=
name|shmat
argument_list|(
name|hmem
operator|->
name|shmid
argument_list|,
name|MLX5_SHM_ADDR
argument_list|,
name|MLX5_SHMAT_FLAGS
argument_list|)
expr_stmt|;
if|if
condition|(
name|hmem
operator|->
name|shmaddr
operator|==
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
condition|)
block|{
name|mlx5_dbg
argument_list|(
name|stderr
argument_list|,
name|MLX5_DBG_CONTIG
argument_list|,
literal|"%s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out_rmid
goto|;
block|}
if|if
condition|(
name|mlx5_bitmap_init
argument_list|(
operator|&
name|hmem
operator|->
name|bitmap
argument_list|,
name|shm_len
operator|/
name|MLX5_Q_CHUNK_SIZE
argument_list|,
name|shm_len
operator|/
name|MLX5_Q_CHUNK_SIZE
operator|-
literal|1
argument_list|)
condition|)
block|{
name|mlx5_dbg
argument_list|(
name|stderr
argument_list|,
name|MLX5_DBG_CONTIG
argument_list|,
literal|"%s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out_shmdt
goto|;
block|}
comment|/* 	 * Marked to be destroyed when process detaches from shmget segment 	 */
name|shmctl
argument_list|(
name|hmem
operator|->
name|shmid
argument_list|,
name|IPC_RMID
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|hmem
return|;
name|out_shmdt
label|:
if|if
condition|(
name|shmdt
argument_list|(
name|hmem
operator|->
name|shmaddr
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|mlx5_dbg
argument_list|(
name|stderr
argument_list|,
name|MLX5_DBG_CONTIG
argument_list|,
literal|"%s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|out_rmid
label|:
name|shmctl
argument_list|(
name|hmem
operator|->
name|shmid
argument_list|,
name|IPC_RMID
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|out_free
label|:
name|free
argument_list|(
name|hmem
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|alloc_huge_buf
parameter_list|(
name|struct
name|mlx5_context
modifier|*
name|mctx
parameter_list|,
name|struct
name|mlx5_buf
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|,
name|int
name|page_size
parameter_list|)
block|{
name|int
name|found
init|=
literal|0
decl_stmt|;
name|int
name|nchunk
decl_stmt|;
name|struct
name|mlx5_hugetlb_mem
modifier|*
name|hmem
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|buf
operator|->
name|length
operator|=
name|align
argument_list|(
name|size
argument_list|,
name|MLX5_Q_CHUNK_SIZE
argument_list|)
expr_stmt|;
name|nchunk
operator|=
name|buf
operator|->
name|length
operator|/
name|MLX5_Q_CHUNK_SIZE
expr_stmt|;
name|mlx5_spin_lock
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|hmem
argument_list|,
argument|&mctx->hugetlb_list
argument_list|,
argument|entry
argument_list|)
block|{
if|if
condition|(
name|bitmap_avail
argument_list|(
operator|&
name|hmem
operator|->
name|bitmap
argument_list|)
condition|)
block|{
name|buf
operator|->
name|base
operator|=
name|bitmap_alloc_range
argument_list|(
operator|&
name|hmem
operator|->
name|bitmap
argument_list|,
name|nchunk
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|base
operator|!=
operator|-
literal|1
condition|)
block|{
name|buf
operator|->
name|hmem
operator|=
name|hmem
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
name|mlx5_spin_unlock
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|hmem
operator|=
name|alloc_huge_mem
argument_list|(
name|buf
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hmem
condition|)
return|return
operator|-
literal|1
return|;
name|buf
operator|->
name|base
operator|=
name|bitmap_alloc_range
argument_list|(
operator|&
name|hmem
operator|->
name|bitmap
argument_list|,
name|nchunk
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|base
operator|==
operator|-
literal|1
condition|)
block|{
name|free_huge_mem
argument_list|(
name|hmem
argument_list|)
expr_stmt|;
comment|/* TBD: remove after proven stability */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"BUG: huge allocation\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|buf
operator|->
name|hmem
operator|=
name|hmem
expr_stmt|;
name|mlx5_spin_lock
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitmap_avail
argument_list|(
operator|&
name|hmem
operator|->
name|bitmap
argument_list|)
condition|)
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_list
argument_list|,
name|hmem
argument_list|,
name|entry
argument_list|)
expr_stmt|;
else|else
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_list
argument_list|,
name|hmem
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|mlx5_spin_unlock
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
block|}
name|buf
operator|->
name|buf
operator|=
name|hmem
operator|->
name|shmaddr
operator|+
name|buf
operator|->
name|base
operator|*
name|MLX5_Q_CHUNK_SIZE
expr_stmt|;
name|ret
operator|=
name|ibv_dontfork_range
argument_list|(
name|buf
operator|->
name|buf
argument_list|,
name|buf
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mlx5_dbg
argument_list|(
name|stderr
argument_list|,
name|MLX5_DBG_CONTIG
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
goto|goto
name|out_fork
goto|;
block|}
name|buf
operator|->
name|type
operator|=
name|MLX5_ALLOC_TYPE_HUGE
expr_stmt|;
return|return
literal|0
return|;
name|out_fork
label|:
name|mlx5_spin_lock
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
name|bitmap_free_range
argument_list|(
operator|&
name|hmem
operator|->
name|bitmap
argument_list|,
name|buf
operator|->
name|base
argument_list|,
name|nchunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitmap_empty
argument_list|(
operator|&
name|hmem
operator|->
name|bitmap
argument_list|)
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_list
argument_list|,
name|hmem
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|mlx5_spin_unlock
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
name|free_huge_mem
argument_list|(
name|hmem
argument_list|)
expr_stmt|;
block|}
else|else
name|mlx5_spin_unlock
argument_list|(
operator|&
name|mctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_huge_buf
parameter_list|(
name|struct
name|mlx5_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|mlx5_buf
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|nchunk
decl_stmt|;
name|nchunk
operator|=
name|buf
operator|->
name|length
operator|/
name|MLX5_Q_CHUNK_SIZE
expr_stmt|;
name|mlx5_spin_lock
argument_list|(
operator|&
name|ctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
name|bitmap_free_range
argument_list|(
operator|&
name|buf
operator|->
name|hmem
operator|->
name|bitmap
argument_list|,
name|buf
operator|->
name|base
argument_list|,
name|nchunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitmap_empty
argument_list|(
operator|&
name|buf
operator|->
name|hmem
operator|->
name|bitmap
argument_list|)
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|ctx
operator|->
name|hugetlb_list
argument_list|,
name|buf
operator|->
name|hmem
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|mlx5_spin_unlock
argument_list|(
operator|&
name|ctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
name|free_huge_mem
argument_list|(
name|buf
operator|->
name|hmem
argument_list|)
expr_stmt|;
block|}
else|else
name|mlx5_spin_unlock
argument_list|(
operator|&
name|ctx
operator|->
name|hugetlb_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5_alloc_prefered_buf
parameter_list|(
name|struct
name|mlx5_context
modifier|*
name|mctx
parameter_list|,
name|struct
name|mlx5_buf
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|,
name|int
name|page_size
parameter_list|,
name|enum
name|mlx5_alloc_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|component
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
comment|/* 	 * Fallback mechanism priority: 	 *	huge pages 	 *	contig pages 	 *	default 	 */
if|if
condition|(
name|type
operator|==
name|MLX5_ALLOC_TYPE_HUGE
operator|||
name|type
operator|==
name|MLX5_ALLOC_TYPE_PREFER_HUGE
operator|||
name|type
operator|==
name|MLX5_ALLOC_TYPE_ALL
condition|)
block|{
name|ret
operator|=
name|alloc_huge_buf
argument_list|(
name|mctx
argument_list|,
name|buf
argument_list|,
name|size
argument_list|,
name|page_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|type
operator|==
name|MLX5_ALLOC_TYPE_HUGE
condition|)
return|return
operator|-
literal|1
return|;
name|mlx5_dbg
argument_list|(
name|stderr
argument_list|,
name|MLX5_DBG_CONTIG
argument_list|,
literal|"Huge mode allocation failed, fallback to %s mode\n"
argument_list|,
name|MLX5_ALLOC_TYPE_ALL
condition|?
literal|"contig"
else|:
literal|"default"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|==
name|MLX5_ALLOC_TYPE_CONTIG
operator|||
name|type
operator|==
name|MLX5_ALLOC_TYPE_PREFER_CONTIG
operator|||
name|type
operator|==
name|MLX5_ALLOC_TYPE_ALL
condition|)
block|{
name|ret
operator|=
name|mlx5_alloc_buf_contig
argument_list|(
name|mctx
argument_list|,
name|buf
argument_list|,
name|size
argument_list|,
name|page_size
argument_list|,
name|component
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|type
operator|==
name|MLX5_ALLOC_TYPE_CONTIG
condition|)
return|return
operator|-
literal|1
return|;
name|mlx5_dbg
argument_list|(
name|stderr
argument_list|,
name|MLX5_DBG_CONTIG
argument_list|,
literal|"Contig allocation failed, fallback to default mode\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|mlx5_alloc_buf
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
name|page_size
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mlx5_free_actual_buf
parameter_list|(
name|struct
name|mlx5_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|mlx5_buf
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|buf
operator|->
name|type
condition|)
block|{
case|case
name|MLX5_ALLOC_TYPE_ANON
case|:
name|mlx5_free_buf
argument_list|(
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5_ALLOC_TYPE_HUGE
case|:
name|free_huge_buf
argument_list|(
name|ctx
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5_ALLOC_TYPE_CONTIG
case|:
name|mlx5_free_buf_contig
argument_list|(
name|ctx
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad allocation type\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* This function computes log2(v) rounded up.    We don't want to have a dependency to libm which exposes ceil& log2 APIs.    Code was written based on public domain code: 	URL: http://graphics.stanford.edu/~seander/bithacks.html#IntegerLog. */
end_comment

begin_function
specifier|static
name|uint32_t
name|mlx5_get_block_order
parameter_list|(
name|uint32_t
name|v
parameter_list|)
block|{
specifier|static
specifier|const
name|uint32_t
name|bits_arr
index|[]
init|=
block|{
literal|0x2
block|,
literal|0xC
block|,
literal|0xF0
block|,
literal|0xFF00
block|,
literal|0xFFFF0000
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint32_t
name|shift_arr
index|[]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|4
block|,
literal|8
block|,
literal|16
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|input_val
init|=
name|v
decl_stmt|;
specifier|register
name|uint32_t
name|r
init|=
literal|0
decl_stmt|;
comment|/* result of log2(v) will go here */
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|v
operator|&
name|bits_arr
index|[
name|i
index|]
condition|)
block|{
name|v
operator|>>=
name|shift_arr
index|[
name|i
index|]
expr_stmt|;
name|r
operator||=
name|shift_arr
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
comment|/* Rounding up if required */
name|r
operator|+=
operator|!
operator|!
operator|(
name|input_val
operator|&
operator|(
operator|(
literal|1
operator|<<
name|r
operator|)
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|mlx5_get_alloc_type
parameter_list|(
specifier|const
name|char
modifier|*
name|component
parameter_list|,
name|enum
name|mlx5_alloc_type
modifier|*
name|alloc_type
parameter_list|,
name|enum
name|mlx5_alloc_type
name|default_type
parameter_list|)
block|{
name|char
modifier|*
name|env_value
decl_stmt|;
name|char
name|name
index|[
literal|128
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s_ALLOC_TYPE"
argument_list|,
name|component
argument_list|)
expr_stmt|;
operator|*
name|alloc_type
operator|=
name|default_type
expr_stmt|;
name|env_value
operator|=
name|getenv
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|env_value
condition|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|env_value
argument_list|,
literal|"ANON"
argument_list|)
condition|)
operator|*
name|alloc_type
operator|=
name|MLX5_ALLOC_TYPE_ANON
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|env_value
argument_list|,
literal|"HUGE"
argument_list|)
condition|)
operator|*
name|alloc_type
operator|=
name|MLX5_ALLOC_TYPE_HUGE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|env_value
argument_list|,
literal|"CONTIG"
argument_list|)
condition|)
operator|*
name|alloc_type
operator|=
name|MLX5_ALLOC_TYPE_CONTIG
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|env_value
argument_list|,
literal|"PREFER_CONTIG"
argument_list|)
condition|)
operator|*
name|alloc_type
operator|=
name|MLX5_ALLOC_TYPE_PREFER_CONTIG
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|env_value
argument_list|,
literal|"PREFER_HUGE"
argument_list|)
condition|)
operator|*
name|alloc_type
operator|=
name|MLX5_ALLOC_TYPE_PREFER_HUGE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|env_value
argument_list|,
literal|"ALL"
argument_list|)
condition|)
operator|*
name|alloc_type
operator|=
name|MLX5_ALLOC_TYPE_ALL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_alloc_get_env_info
parameter_list|(
name|int
modifier|*
name|max_block_log
parameter_list|,
name|int
modifier|*
name|min_block_log
parameter_list|,
specifier|const
name|char
modifier|*
name|component
parameter_list|)
block|{
name|char
modifier|*
name|env
decl_stmt|;
name|int
name|value
decl_stmt|;
name|char
name|name
index|[
literal|128
index|]
decl_stmt|;
comment|/* First set defaults */
operator|*
name|max_block_log
operator|=
name|MLX5_MAX_LOG2_CONTIG_BLOCK_SIZE
expr_stmt|;
operator|*
name|min_block_log
operator|=
name|MLX5_MIN_LOG2_CONTIG_BLOCK_SIZE
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s_MAX_LOG2_CONTIG_BSIZE"
argument_list|,
name|component
argument_list|)
expr_stmt|;
name|env
operator|=
name|getenv
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|env
condition|)
block|{
name|value
operator|=
name|atoi
argument_list|(
name|env
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|<=
name|MLX5_MAX_LOG2_CONTIG_BLOCK_SIZE
operator|&&
name|value
operator|>=
name|MLX5_MIN_LOG2_CONTIG_BLOCK_SIZE
condition|)
operator|*
name|max_block_log
operator|=
name|value
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid value %d for %s\n"
argument_list|,
name|value
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|name
argument_list|,
literal|"%s_MIN_LOG2_CONTIG_BSIZE"
argument_list|,
name|component
argument_list|)
expr_stmt|;
name|env
operator|=
name|getenv
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|env
condition|)
block|{
name|value
operator|=
name|atoi
argument_list|(
name|env
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|>=
name|MLX5_MIN_LOG2_CONTIG_BLOCK_SIZE
operator|&&
name|value
operator|<=
operator|*
name|max_block_log
condition|)
operator|*
name|min_block_log
operator|=
name|value
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid value %d for %s\n"
argument_list|,
name|value
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|mlx5_alloc_buf_contig
parameter_list|(
name|struct
name|mlx5_context
modifier|*
name|mctx
parameter_list|,
name|struct
name|mlx5_buf
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|,
name|int
name|page_size
parameter_list|,
specifier|const
name|char
modifier|*
name|component
parameter_list|)
block|{
name|void
modifier|*
name|addr
init|=
name|MAP_FAILED
decl_stmt|;
name|int
name|block_size_exp
decl_stmt|;
name|int
name|max_block_log
decl_stmt|;
name|int
name|min_block_log
decl_stmt|;
name|struct
name|ibv_context
modifier|*
name|context
init|=
operator|&
name|mctx
operator|->
name|ibv_ctx
decl_stmt|;
name|off_t
name|offset
decl_stmt|;
name|mlx5_alloc_get_env_info
argument_list|(
operator|&
name|max_block_log
argument_list|,
operator|&
name|min_block_log
argument_list|,
name|component
argument_list|)
expr_stmt|;
name|block_size_exp
operator|=
name|mlx5_get_block_order
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|block_size_exp
operator|>
name|max_block_log
condition|)
name|block_size_exp
operator|=
name|max_block_log
expr_stmt|;
do|do
block|{
name|offset
operator|=
literal|0
expr_stmt|;
name|set_command
argument_list|(
name|MLX5_MMAP_GET_CONTIGUOUS_PAGES_CMD
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
name|set_order
argument_list|(
name|block_size_exp
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
name|addr
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|PROT_WRITE
operator||
name|PROT_READ
argument_list|,
name|MAP_SHARED
argument_list|,
name|context
operator|->
name|cmd_fd
argument_list|,
name|page_size
operator|*
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|!=
name|MAP_FAILED
condition|)
break|break;
comment|/* 		 *  The kernel returns EINVAL if not supported 		 */
if|if
condition|(
name|errno
operator|==
name|EINVAL
condition|)
return|return
operator|-
literal|1
return|;
name|block_size_exp
operator|-=
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|block_size_exp
operator|>=
name|min_block_log
condition|)
do|;
name|mlx5_dbg
argument_list|(
name|mctx
operator|->
name|dbg_fp
argument_list|,
name|MLX5_DBG_CONTIG
argument_list|,
literal|"block order %d, addr %p\n"
argument_list|,
name|block_size_exp
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
name|MAP_FAILED
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|ibv_dontfork_range
argument_list|(
name|addr
argument_list|,
name|size
argument_list|)
condition|)
block|{
name|munmap
argument_list|(
name|addr
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|buf
operator|->
name|buf
operator|=
name|addr
expr_stmt|;
name|buf
operator|->
name|length
operator|=
name|size
expr_stmt|;
name|buf
operator|->
name|type
operator|=
name|MLX5_ALLOC_TYPE_CONTIG
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|mlx5_free_buf_contig
parameter_list|(
name|struct
name|mlx5_context
modifier|*
name|mctx
parameter_list|,
name|struct
name|mlx5_buf
modifier|*
name|buf
parameter_list|)
block|{
name|ibv_dofork_range
argument_list|(
name|buf
operator|->
name|buf
argument_list|,
name|buf
operator|->
name|length
argument_list|)
expr_stmt|;
name|munmap
argument_list|(
name|buf
operator|->
name|buf
argument_list|,
name|buf
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5_alloc_buf
parameter_list|(
name|struct
name|mlx5_buf
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|,
name|int
name|page_size
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|int
name|al_size
decl_stmt|;
name|al_size
operator|=
name|align
argument_list|(
name|size
argument_list|,
name|page_size
argument_list|)
expr_stmt|;
name|ret
operator|=
name|posix_memalign
argument_list|(
operator|&
name|buf
operator|->
name|buf
argument_list|,
name|page_size
argument_list|,
name|al_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|ibv_dontfork_range
argument_list|(
name|buf
operator|->
name|buf
argument_list|,
name|al_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|free
argument_list|(
name|buf
operator|->
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|buf
operator|->
name|length
operator|=
name|al_size
expr_stmt|;
name|buf
operator|->
name|type
operator|=
name|MLX5_ALLOC_TYPE_ANON
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|mlx5_free_buf
parameter_list|(
name|struct
name|mlx5_buf
modifier|*
name|buf
parameter_list|)
block|{
name|ibv_dofork_range
argument_list|(
name|buf
operator|->
name|buf
argument_list|,
name|buf
operator|->
name|length
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
operator|->
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire Inc.  All rights reserved.  * Copyright (c) 2007 Xsigo Systems Inc.  All rights reserved.  * Copyright (c) 2008 Lawrence Livermore National Lab.  All rights reserved.  * Copyright (c) 2010 HNR Consulting.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*========================================================*/
end_comment

begin_comment
comment|/*               FABRIC SCANNER SPECIFIC DATA             */
end_comment

begin_comment
comment|/*========================================================*/
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/mad.h>
end_include

begin_include
include|#
directive|include
file|"internal.h"
end_include

begin_include
include|#
directive|include
file|"chassis.h"
end_include

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ChassisTypeStr
index|[]
init|=
block|{
literal|""
block|,
literal|"ISR9288"
block|,
literal|"ISR9096"
block|,
literal|"ISR2012"
block|,
literal|"ISR2004"
block|,
literal|"ISR4700"
block|,
literal|"ISR4200"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ChassisSlotTypeStr
index|[]
init|=
block|{
literal|""
block|,
literal|"Line"
block|,
literal|"Spine"
block|,
literal|"SRBD"
block|}
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
name|chassis_scan
block|{
name|ibnd_chassis_t
modifier|*
name|first_chassis
decl_stmt|;
name|ibnd_chassis_t
modifier|*
name|current_chassis
decl_stmt|;
name|ibnd_chassis_t
modifier|*
name|last_chassis
decl_stmt|;
block|}
name|chassis_scan_t
typedef|;
end_typedef

begin_function
name|char
modifier|*
name|ibnd_get_chassis_type
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|int
name|chassis_type
decl_stmt|;
if|if
condition|(
operator|!
name|node
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"node parameter NULL\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|node
operator|->
name|chassis
condition|)
return|return
name|NULL
return|;
name|chassis_type
operator|=
name|mad_get_field
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|chassis_type
condition|)
block|{
case|case
name|VTR_VENDOR_ID
case|:
comment|/* Voltaire chassis */
block|{
if|if
condition|(
name|node
operator|->
name|ch_type
operator|==
name|UNRESOLVED_CT
operator|||
name|node
operator|->
name|ch_type
operator|>
name|ISR4200_CT
condition|)
return|return
name|NULL
return|;
return|return
name|ChassisTypeStr
index|[
name|node
operator|->
name|ch_type
index|]
return|;
block|}
case|case
name|MLX_VENDOR_ID
case|:
block|{
if|if
condition|(
name|node
operator|->
name|ch_type_str
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
return|return
name|NULL
return|;
return|return
name|node
operator|->
name|ch_type_str
return|;
block|}
default|default:
block|{
break|break;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|ibnd_get_chassis_slot_str
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|int
name|vendor_id
decl_stmt|;
if|if
condition|(
operator|!
name|node
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"node parameter NULL\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Currently, only if Voltaire or Mellanox chassis */
name|vendor_id
operator|=
name|mad_get_field
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|vendor_id
operator|!=
name|VTR_VENDOR_ID
operator|)
operator|&&
operator|(
name|vendor_id
operator|!=
name|MLX_VENDOR_ID
operator|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|node
operator|->
name|chassis
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|node
operator|->
name|ch_slot
operator|==
name|UNRESOLVED_CS
operator|||
name|node
operator|->
name|ch_slot
operator|>
name|SRBD_CS
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|str
condition|)
return|return
name|NULL
return|;
name|snprintf
argument_list|(
name|str
argument_list|,
name|size
argument_list|,
literal|"%s %d Chip %d"
argument_list|,
name|ChassisSlotTypeStr
index|[
name|node
operator|->
name|ch_slot
index|]
argument_list|,
name|node
operator|->
name|ch_slotnum
argument_list|,
name|node
operator|->
name|ch_anafanum
argument_list|)
expr_stmt|;
return|return
name|str
return|;
block|}
end_function

begin_function
specifier|static
name|ibnd_chassis_t
modifier|*
name|find_chassisnum
parameter_list|(
name|ibnd_fabric_t
modifier|*
name|fabric
parameter_list|,
name|unsigned
name|char
name|chassisnum
parameter_list|)
block|{
name|ibnd_chassis_t
modifier|*
name|current
decl_stmt|;
for|for
control|(
name|current
operator|=
name|fabric
operator|->
name|chassis
init|;
name|current
condition|;
name|current
operator|=
name|current
operator|->
name|next
control|)
if|if
condition|(
name|current
operator|->
name|chassisnum
operator|==
name|chassisnum
condition|)
return|return
name|current
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|topspin_chassisguid
parameter_list|(
name|uint64_t
name|guid
parameter_list|)
block|{
comment|/* Byte 3 in system image GUID is chassis type, and */
comment|/* Byte 4 is location ID (slot) so just mask off byte 4 */
return|return
name|guid
operator|&
literal|0xffffffff00ffffffULL
return|;
block|}
end_function

begin_function
name|int
name|ibnd_is_xsigo_guid
parameter_list|(
name|uint64_t
name|guid
parameter_list|)
block|{
if|if
condition|(
operator|(
name|guid
operator|&
literal|0xffffff0000000000ULL
operator|)
operator|==
literal|0x0013970000000000ULL
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_xsigo_leafone
parameter_list|(
name|uint64_t
name|guid
parameter_list|)
block|{
if|if
condition|(
operator|(
name|guid
operator|&
literal|0xffffffffff000000ULL
operator|)
operator|==
literal|0x0013970102000000ULL
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ibnd_is_xsigo_hca
parameter_list|(
name|uint64_t
name|guid
parameter_list|)
block|{
comment|/* NodeType 2 is HCA */
if|if
condition|(
operator|(
name|guid
operator|&
literal|0xffffffff00000000ULL
operator|)
operator|==
literal|0x0013970200000000ULL
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ibnd_is_xsigo_tca
parameter_list|(
name|uint64_t
name|guid
parameter_list|)
block|{
comment|/* NodeType 3 is TCA */
if|if
condition|(
operator|(
name|guid
operator|&
literal|0xffffffff00000000ULL
operator|)
operator|==
literal|0x0013970300000000ULL
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_xsigo_ca
parameter_list|(
name|uint64_t
name|guid
parameter_list|)
block|{
if|if
condition|(
name|ibnd_is_xsigo_hca
argument_list|(
name|guid
argument_list|)
operator|||
name|ibnd_is_xsigo_tca
argument_list|(
name|guid
argument_list|)
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_xsigo_switch
parameter_list|(
name|uint64_t
name|guid
parameter_list|)
block|{
if|if
condition|(
operator|(
name|guid
operator|&
literal|0xffffffff00000000ULL
operator|)
operator|==
literal|0x0013970100000000ULL
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|xsigo_chassisguid
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|uint64_t
name|sysimgguid
init|=
name|mad_get_field64
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_SYSTEM_GUID_F
argument_list|)
decl_stmt|;
name|uint64_t
name|remote_sysimgguid
decl_stmt|;
if|if
condition|(
operator|!
name|is_xsigo_ca
argument_list|(
name|sysimgguid
argument_list|)
condition|)
block|{
comment|/* Byte 3 is NodeType and byte 4 is PortType */
comment|/* If NodeType is 1 (switch), PortType is masked */
if|if
condition|(
name|is_xsigo_switch
argument_list|(
name|sysimgguid
argument_list|)
condition|)
return|return
name|sysimgguid
operator|&
literal|0xffffffff00ffffffULL
return|;
else|else
return|return
name|sysimgguid
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|node
operator|->
name|ports
operator|||
operator|!
name|node
operator|->
name|ports
index|[
literal|1
index|]
condition|)
return|return
literal|0
return|;
comment|/* Is there a peer port ? */
if|if
condition|(
operator|!
name|node
operator|->
name|ports
index|[
literal|1
index|]
operator|->
name|remoteport
condition|)
return|return
name|sysimgguid
return|;
comment|/* If peer port is Leaf 1, use its chassis GUID */
name|remote_sysimgguid
operator|=
name|mad_get_field64
argument_list|(
name|node
operator|->
name|ports
index|[
literal|1
index|]
operator|->
name|remoteport
operator|->
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_SYSTEM_GUID_F
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_xsigo_leafone
argument_list|(
name|remote_sysimgguid
argument_list|)
condition|)
return|return
name|remote_sysimgguid
operator|&
literal|0xffffffff00ffffffULL
return|;
else|else
return|return
name|sysimgguid
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|get_chassisguid
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|uint32_t
name|vendid
init|=
name|mad_get_field
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|)
decl_stmt|;
name|uint64_t
name|sysimgguid
init|=
name|mad_get_field64
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_SYSTEM_GUID_F
argument_list|)
decl_stmt|;
if|if
condition|(
name|vendid
operator|==
name|TS_VENDOR_ID
operator|||
name|vendid
operator|==
name|SS_VENDOR_ID
condition|)
return|return
name|topspin_chassisguid
argument_list|(
name|sysimgguid
argument_list|)
return|;
elseif|else
if|if
condition|(
name|vendid
operator|==
name|XS_VENDOR_ID
operator|||
name|ibnd_is_xsigo_guid
argument_list|(
name|sysimgguid
argument_list|)
condition|)
return|return
name|xsigo_chassisguid
argument_list|(
name|node
argument_list|)
return|;
else|else
return|return
name|sysimgguid
return|;
block|}
end_function

begin_function
specifier|static
name|ibnd_chassis_t
modifier|*
name|find_chassisguid
parameter_list|(
name|ibnd_fabric_t
modifier|*
name|fabric
parameter_list|,
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|ibnd_chassis_t
modifier|*
name|current
decl_stmt|;
name|uint64_t
name|chguid
decl_stmt|;
name|chguid
operator|=
name|get_chassisguid
argument_list|(
name|node
argument_list|)
expr_stmt|;
for|for
control|(
name|current
operator|=
name|fabric
operator|->
name|chassis
init|;
name|current
condition|;
name|current
operator|=
name|current
operator|->
name|next
control|)
if|if
condition|(
name|current
operator|->
name|chassisguid
operator|==
name|chguid
condition|)
return|return
name|current
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|uint64_t
name|ibnd_get_chassis_guid
parameter_list|(
name|ibnd_fabric_t
modifier|*
name|fabric
parameter_list|,
name|unsigned
name|char
name|chassisnum
parameter_list|)
block|{
name|ibnd_chassis_t
modifier|*
name|chassis
decl_stmt|;
if|if
condition|(
operator|!
name|fabric
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"fabric parameter NULL\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|chassis
operator|=
name|find_chassisnum
argument_list|(
name|fabric
argument_list|,
name|chassisnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|chassis
condition|)
return|return
name|chassis
operator|->
name|chassisguid
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_router
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_IB_FC_ROUTER
operator|||
name|devid
operator|==
name|VTR_DEVID_IB_IP_ROUTER
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_spine_9096
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SFB4
operator|||
name|devid
operator|==
name|VTR_DEVID_SFB4_DDR
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_spine_9288
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SFB12
operator|||
name|devid
operator|==
name|VTR_DEVID_SFB12_DDR
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_spine_2004
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SFB2004
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_spine_2012
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SFB2012
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_spine_4700
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SFB4700
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_spine_4700x2
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SFB4700X2
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_spine_4200
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SFB4200
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_spine
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
return|return
operator|(
name|is_spine_9096
argument_list|(
name|n
argument_list|)
operator|||
name|is_spine_9288
argument_list|(
name|n
argument_list|)
operator|||
name|is_spine_2004
argument_list|(
name|n
argument_list|)
operator|||
name|is_spine_2012
argument_list|(
name|n
argument_list|)
operator|||
name|is_spine_4700
argument_list|(
name|n
argument_list|)
operator|||
name|is_spine_4700x2
argument_list|(
name|n
argument_list|)
operator|||
name|is_spine_4200
argument_list|(
name|n
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_line_24
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SLB24
operator|||
name|devid
operator|==
name|VTR_DEVID_SLB24_DDR
operator|||
name|devid
operator|==
name|VTR_DEVID_SRB2004
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_line_8
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SLB8
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_line_2024
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SLB2024
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_line_4700
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
name|uint32_t
name|devid
init|=
name|mad_get_field
argument_list|(
name|n
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
decl_stmt|;
return|return
operator|(
name|devid
operator|==
name|VTR_DEVID_SLB4018
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_line
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
return|return
operator|(
name|is_line_24
argument_list|(
name|n
argument_list|)
operator|||
name|is_line_8
argument_list|(
name|n
argument_list|)
operator|||
name|is_line_2024
argument_list|(
name|n
argument_list|)
operator|||
name|is_line_4700
argument_list|(
name|n
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|is_chassis_switch
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|)
block|{
return|return
operator|(
name|is_spine
argument_list|(
name|n
argument_list|)
operator|||
name|is_line
argument_list|(
name|n
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* these structs help find Line (Anafa) slot number while using spine portnum */
end_comment

begin_decl_stmt
name|char
name|line_slot_2_sfb4
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|anafa_line_slot_2_sfb4
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|line_slot_2_sfb12
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|6
block|,
literal|6
block|,
literal|7
block|,
literal|7
block|,
literal|8
block|,
literal|8
block|,
literal|9
block|,
literal|9
block|,
literal|10
block|,
literal|10
block|,
literal|11
block|,
literal|11
block|,
literal|12
block|,
literal|12
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|anafa_line_slot_2_sfb12
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* LB slot = table[spine port] */
end_comment

begin_decl_stmt
name|char
name|line_slot_2_sfb18
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|6
block|,
literal|6
block|,
literal|7
block|,
literal|7
block|,
literal|8
block|,
literal|8
block|,
literal|9
block|,
literal|9
block|,
literal|10
block|,
literal|10
block|,
literal|11
block|,
literal|11
block|,
literal|12
block|,
literal|12
block|,
literal|13
block|,
literal|13
block|,
literal|14
block|,
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|16
block|,
literal|16
block|,
literal|17
block|,
literal|17
block|,
literal|18
block|,
literal|18
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* LB asic num = table[spine port] */
end_comment

begin_decl_stmt
name|char
name|anafa_line_slot_2_sfb18
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* LB slot = table[spine port] */
end_comment

begin_decl_stmt
name|char
name|line_slot_2_sfb18x2
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|,
literal|13
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* LB asic num = table[spine port] */
end_comment

begin_decl_stmt
name|char
name|anafa_line_slot_2_sfb18x2
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* LB slot = table[spine port] */
end_comment

begin_decl_stmt
name|char
name|line_slot_2_sfb4200
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|6
block|,
literal|6
block|,
literal|6
block|,
literal|6
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|,
literal|8
block|,
literal|8
block|,
literal|8
block|,
literal|8
block|,
literal|9
block|,
literal|9
block|,
literal|9
block|,
literal|9
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* LB asic num = table[spine port] */
end_comment

begin_decl_stmt
name|char
name|anafa_line_slot_2_sfb4200
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* IPR FCR modules connectivity while using sFB4 port as reference */
end_comment

begin_decl_stmt
name|char
name|ipr_slot_2_sfb4_port
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|3
block|,
literal|2
block|,
literal|1
block|,
literal|3
block|,
literal|2
block|,
literal|1
block|,
literal|3
block|,
literal|2
block|,
literal|1
block|,
literal|3
block|,
literal|2
block|,
literal|1
block|,
literal|3
block|,
literal|2
block|,
literal|1
block|,
literal|3
block|,
literal|2
block|,
literal|1
block|,
literal|3
block|,
literal|2
block|,
literal|1
block|,
literal|3
block|,
literal|2
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* these structs help find Spine (Anafa) slot number while using spine portnum */
end_comment

begin_decl_stmt
name|char
name|spine12_slot_2_slb
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|anafa_spine12_slot_2_slb
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|spine4_slot_2_slb
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|anafa_spine4_slot_2_slb
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* FB slot = table[line port] */
end_comment

begin_decl_stmt
name|char
name|spine18_slot_2_slb
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|6
block|,
literal|6
block|,
literal|7
block|,
literal|7
block|,
literal|8
block|,
literal|8
block|,
literal|9
block|,
literal|9
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* FB asic = table[line port] */
end_comment

begin_decl_stmt
name|char
name|anafa_spine18_slot_2_slb
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|anafa_spine18x2_slot_2_slb
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* FB slot = table[line port] */
end_comment

begin_decl_stmt
name|char
name|sfb4200_slot_2_slb
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* FB asic = table[line port] */
end_comment

begin_decl_stmt
name|char
name|anafa_sfb4200_slot_2_slb
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*	reference                     { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24 }; */
end_comment

begin_function
specifier|static
name|int
name|get_sfb_slot
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|,
name|ibnd_port_t
modifier|*
name|lineport
parameter_list|)
block|{
name|n
operator|->
name|ch_slot
operator|=
name|SPINE_CS
expr_stmt|;
if|if
condition|(
name|is_spine_9096
argument_list|(
name|n
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR9096_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|spine4_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_spine4_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_9288
argument_list|(
name|n
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR9288_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|spine12_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_spine12_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_2012
argument_list|(
name|n
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR2012_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|spine12_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_spine12_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_2004
argument_list|(
name|n
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR2004_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|spine4_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_spine4_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_4700
argument_list|(
name|n
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR4700_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|spine18_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_spine18_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_4700x2
argument_list|(
name|n
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR4700_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|spine18_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_spine18x2_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_4200
argument_list|(
name|n
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR4200_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|sfb4200_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_sfb4200_slot_2_slb
index|[
name|lineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
else|else
block|{
name|IBND_ERROR
argument_list|(
literal|"Unexpected node found: guid 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|n
operator|->
name|guid
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_router_slot
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|,
name|ibnd_port_t
modifier|*
name|spineport
parameter_list|)
block|{
name|uint64_t
name|guessnum
init|=
literal|0
decl_stmt|;
name|n
operator|->
name|ch_found
operator|=
literal|1
expr_stmt|;
name|n
operator|->
name|ch_slot
operator|=
name|SRBD_CS
expr_stmt|;
if|if
condition|(
name|is_spine_9096
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR9096_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb4
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|ipr_slot_2_sfb4_port
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_9288
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR9288_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb12
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
comment|/* this is a smart guess based on nodeguids order on sFB-12 module */
name|guessnum
operator|=
name|spineport
operator|->
name|node
operator|->
name|guid
operator|%
literal|4
expr_stmt|;
comment|/* module 1<--> remote anafa 3 */
comment|/* module 2<--> remote anafa 2 */
comment|/* module 3<--> remote anafa 1 */
name|n
operator|->
name|ch_anafanum
operator|=
operator|(
name|guessnum
operator|==
literal|3
condition|?
literal|1
else|:
operator|(
name|guessnum
operator|==
literal|1
condition|?
literal|3
else|:
literal|2
operator|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_2012
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR2012_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb12
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
comment|/* this is a smart guess based on nodeguids order on sFB-12 module */
name|guessnum
operator|=
name|spineport
operator|->
name|node
operator|->
name|guid
operator|%
literal|4
expr_stmt|;
comment|// module 1<--> remote anafa 3
comment|// module 2<--> remote anafa 2
comment|// module 3<--> remote anafa 1
name|n
operator|->
name|ch_anafanum
operator|=
operator|(
name|guessnum
operator|==
literal|3
condition|?
literal|1
else|:
operator|(
name|guessnum
operator|==
literal|1
condition|?
literal|3
else|:
literal|2
operator|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_2004
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR2004_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb4
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|ipr_slot_2_sfb4_port
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
else|else
block|{
name|IBND_ERROR
argument_list|(
literal|"Unexpected node found: guid 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|spineport
operator|->
name|node
operator|->
name|guid
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_slb_slot
parameter_list|(
name|ibnd_node_t
modifier|*
name|n
parameter_list|,
name|ibnd_port_t
modifier|*
name|spineport
parameter_list|)
block|{
name|n
operator|->
name|ch_slot
operator|=
name|LINE_CS
expr_stmt|;
if|if
condition|(
name|is_spine_9096
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR9096_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb4
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_line_slot_2_sfb4
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_9288
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR9288_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb12
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_line_slot_2_sfb12
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_2012
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR2012_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb12
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_line_slot_2_sfb12
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_2004
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR2004_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb4
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_line_slot_2_sfb4
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_4700
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR4700_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb18
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_line_slot_2_sfb18
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_4700x2
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR4700_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb18x2
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_line_slot_2_sfb18x2
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine_4200
argument_list|(
name|spineport
operator|->
name|node
argument_list|)
condition|)
block|{
name|n
operator|->
name|ch_type
operator|=
name|ISR4200_CT
expr_stmt|;
name|n
operator|->
name|ch_slotnum
operator|=
name|line_slot_2_sfb4200
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
name|n
operator|->
name|ch_anafanum
operator|=
name|anafa_line_slot_2_sfb4200
index|[
name|spineport
operator|->
name|portnum
index|]
expr_stmt|;
block|}
else|else
block|{
name|IBND_ERROR
argument_list|(
literal|"Unexpected node found: guid 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|spineport
operator|->
name|node
operator|->
name|guid
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* 	This function called for every Mellanox node in fabric */
end_comment

begin_function
specifier|static
name|int
name|fill_mellanox_chassis_record
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|int
name|p
init|=
literal|0
decl_stmt|;
name|ibnd_port_t
modifier|*
name|port
decl_stmt|;
name|char
name|node_desc
index|[
name|IB_SMP_DATA_SIZE
index|]
decl_stmt|;
name|char
modifier|*
name|system_name
decl_stmt|;
name|char
modifier|*
name|system_type
decl_stmt|;
name|char
modifier|*
name|system_slot_name
decl_stmt|;
name|char
modifier|*
name|node_index
decl_stmt|;
name|char
modifier|*
name|iter
decl_stmt|;
name|int
name|dev_id
decl_stmt|;
comment|/* 	The node description has the following format:  	'MF0;<system name>:<system type>/<system slot name>[:board type]/U<node index>'       - System slot name in our systems can be L[01-36] , S[01-18]      - Node index is always 1 (we don.t have boards with multiple IS4 chips).      - System name is taken from the currently configured host name.      -The board type is optional and we don.t set it currently  - A leaf or spine slot can currently hold a single type of board. 	 */
name|memcpy
argument_list|(
name|node_desc
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|,
name|IB_SMP_DATA_SIZE
argument_list|)
expr_stmt|;
name|IBND_DEBUG
argument_list|(
literal|"fill_mellanox_chassis_record: node_desc:%s \n"
argument_list|,
name|node_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|ch_found
condition|)
comment|/* somehow this node has already been passed */
return|return
literal|0
return|;
comment|/* All mellanox IS4 switches have the same vendor id*/
name|dev_id
operator|=
name|mad_get_field
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_id
operator|!=
name|MLX_DEVID_IS4
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|node_desc
index|[
literal|0
index|]
operator|!=
literal|'M'
operator|)
operator|||
operator|(
name|node_desc
index|[
literal|1
index|]
operator|!=
literal|'F'
operator|)
operator|||
operator|(
name|node_desc
index|[
literal|2
index|]
operator|!=
literal|'0'
operator|)
operator|||
operator|(
name|node_desc
index|[
literal|3
index|]
operator|!=
literal|';'
operator|)
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"fill_mellanox_chassis_record: Unsupported node description format:%s \n"
argument_list|,
name|node_desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* parse system name*/
name|system_name
operator|=
operator|&
name|node_desc
index|[
literal|4
index|]
expr_stmt|;
for|for
control|(
name|iter
operator|=
name|system_name
init|;
operator|(
operator|*
name|iter
operator|!=
literal|':'
operator|)
operator|&&
operator|(
operator|*
name|iter
operator|!=
literal|'\0'
operator|)
condition|;
name|iter
operator|++
control|)
empty_stmt|;
if|if
condition|(
operator|*
name|iter
operator|==
literal|'\0'
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"fill_mellanox_chassis_record: Unsupported node description format:%s - (get system_name failed) \n"
argument_list|,
name|node_desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|iter
operator|=
literal|'\0'
expr_stmt|;
name|iter
operator|++
expr_stmt|;
comment|/* parse system type*/
name|system_type
operator|=
name|iter
expr_stmt|;
for|for
control|(
init|;
operator|(
operator|*
name|iter
operator|!=
literal|'/'
operator|)
operator|&&
operator|(
operator|*
name|iter
operator|!=
literal|'\0'
operator|)
condition|;
name|iter
operator|++
control|)
empty_stmt|;
if|if
condition|(
operator|*
name|iter
operator|==
literal|'\0'
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"fill_mellanox_chassis_record: Unsupported node description format:%s - (get system_type failed) \n"
argument_list|,
name|node_desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|iter
operator|=
literal|'\0'
expr_stmt|;
name|iter
operator|++
expr_stmt|;
comment|/* parse system slot name*/
name|system_slot_name
operator|=
name|iter
expr_stmt|;
for|for
control|(
init|;
operator|(
operator|*
name|iter
operator|!=
literal|'/'
operator|)
operator|&&
operator|(
operator|*
name|iter
operator|!=
literal|':'
operator|)
operator|&&
operator|(
operator|*
name|iter
operator|!=
literal|'\0'
operator|)
condition|;
name|iter
operator|++
control|)
empty_stmt|;
if|if
condition|(
operator|*
name|iter
operator|==
literal|'\0'
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"fill_mellanox_chassis_record: Unsupported node description format:%s - (get system_slot_name failed) \n"
argument_list|,
name|node_desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|*
name|iter
operator|==
literal|':'
condition|)
block|{
operator|*
name|iter
operator|=
literal|'\0'
expr_stmt|;
name|iter
operator|++
expr_stmt|;
for|for
control|(
init|;
operator|(
operator|*
name|iter
operator|!=
literal|'/'
operator|)
operator|&&
operator|(
operator|*
name|iter
operator|!=
literal|'\0'
operator|)
condition|;
name|iter
operator|++
control|)
empty_stmt|;
if|if
condition|(
operator|*
name|iter
operator|==
literal|'\0'
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"fill_mellanox_chassis_record: Unsupported node description format:%s - (get board type failed) \n"
argument_list|,
name|node_desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
operator|*
name|iter
operator|=
literal|'\0'
expr_stmt|;
name|iter
operator|++
expr_stmt|;
name|node_index
operator|=
name|iter
expr_stmt|;
if|if
condition|(
name|node_index
index|[
literal|0
index|]
operator|!=
literal|'U'
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"fill_mellanox_chassis_record: Unsupported node description format:%s - (get node index) \n"
argument_list|,
name|node_desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* set Chip number (node index) */
name|node
operator|->
name|ch_anafanum
operator|=
operator|(
name|unsigned
name|char
operator|)
name|atoi
argument_list|(
operator|&
name|node_index
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|ch_anafanum
operator|!=
literal|1
condition|)
block|{
name|IBND_DEBUG
argument_list|(
literal|"Unexpected Chip number:%d \n"
argument_list|,
name|node
operator|->
name|ch_anafanum
argument_list|)
expr_stmt|;
block|}
comment|/* set Line Spine numbers */
if|if
condition|(
name|system_slot_name
index|[
literal|0
index|]
operator|==
literal|'L'
condition|)
name|node
operator|->
name|ch_slot
operator|=
name|LINE_CS
expr_stmt|;
elseif|else
if|if
condition|(
name|system_slot_name
index|[
literal|0
index|]
operator|==
literal|'S'
condition|)
name|node
operator|->
name|ch_slot
operator|=
name|SPINE_CS
expr_stmt|;
else|else
block|{
name|IBND_DEBUG
argument_list|(
literal|"fill_mellanox_chassis_record: Unsupported system_slot_name:%s \n"
argument_list|,
name|system_slot_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* The switch will be displayed under Line or Spine and not under Chassis switches */
name|node
operator|->
name|ch_found
operator|=
literal|1
expr_stmt|;
name|node
operator|->
name|ch_slotnum
operator|=
operator|(
name|unsigned
name|char
operator|)
name|atoi
argument_list|(
operator|&
name|system_slot_name
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|node
operator|->
name|ch_slot
operator|==
name|LINE_CS
operator|&&
operator|(
name|node
operator|->
name|ch_slotnum
operator|>
operator|(
name|LINES_MAX_NUM
operator|+
literal|1
operator|)
operator|)
operator|)
operator|||
operator|(
name|node
operator|->
name|ch_slot
operator|==
name|SPINE_CS
operator|&&
operator|(
name|node
operator|->
name|ch_slotnum
operator|>
operator|(
name|SPINES_MAX_NUM
operator|+
literal|1
operator|)
operator|)
operator|)
condition|)
block|{
name|IBND_ERROR
argument_list|(
literal|"fill_mellanox_chassis_record: invalid slot number:%d \n"
argument_list|,
name|node
operator|->
name|ch_slotnum
argument_list|)
expr_stmt|;
name|node
operator|->
name|ch_slotnum
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/*set ch_type_str*/
name|strncpy
argument_list|(
name|node
operator|->
name|ch_type_str
argument_list|,
name|system_type
argument_list|,
sizeof|sizeof
argument_list|(
name|node
operator|->
name|ch_type_str
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Line ports 1-18 are mapped to external ports 1-18*/
if|if
condition|(
name|node
operator|->
name|ch_slot
operator|==
name|LINE_CS
condition|)
block|{
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
operator|&&
name|p
operator|<=
literal|18
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
continue|continue;
name|port
operator|->
name|ext_portnum
operator|=
name|p
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|insert_mellanox_line_and_spine
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|ibnd_chassis_t
modifier|*
name|chassis
parameter_list|)
block|{
if|if
condition|(
name|node
operator|->
name|ch_slot
operator|==
name|LINE_CS
condition|)
block|{
if|if
condition|(
name|chassis
operator|->
name|linenode
index|[
name|node
operator|->
name|ch_slotnum
index|]
condition|)
return|return
literal|0
return|;
comment|/* already filled slot */
name|chassis
operator|->
name|linenode
index|[
name|node
operator|->
name|ch_slotnum
index|]
operator|=
name|node
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node
operator|->
name|ch_slot
operator|==
name|SPINE_CS
condition|)
block|{
if|if
condition|(
name|chassis
operator|->
name|spinenode
index|[
name|node
operator|->
name|ch_slotnum
index|]
condition|)
return|return
literal|0
return|;
comment|/* already filled slot */
name|chassis
operator|->
name|spinenode
index|[
name|node
operator|->
name|ch_slotnum
index|]
operator|=
name|node
expr_stmt|;
block|}
else|else
return|return
literal|0
return|;
name|node
operator|->
name|chassis
operator|=
name|chassis
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* forward declare this */
end_comment

begin_function_decl
specifier|static
name|void
name|voltaire_portmap
parameter_list|(
name|ibnd_port_t
modifier|*
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* 	This function called for every Voltaire node in fabric 	It could be optimized so, but time overhead is very small 	and its only diag.util */
end_comment

begin_function
specifier|static
name|int
name|fill_voltaire_chassis_record
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|int
name|p
init|=
literal|0
decl_stmt|;
name|ibnd_port_t
modifier|*
name|port
decl_stmt|;
name|ibnd_node_t
modifier|*
name|remnode
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|node
operator|->
name|ch_found
condition|)
comment|/* somehow this node has already been passed */
return|return
literal|0
return|;
name|node
operator|->
name|ch_found
operator|=
literal|1
expr_stmt|;
comment|/* node is router only in case of using unique lid */
comment|/* (which is lid of chassis router port) */
comment|/* in such case node->ports is actually a requested port... */
if|if
condition|(
name|is_router
argument_list|(
name|node
argument_list|)
condition|)
comment|/* find the remote node */
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
name|port
operator|&&
name|is_spine
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|node
argument_list|)
condition|)
name|get_router_slot
argument_list|(
name|node
argument_list|,
name|port
operator|->
name|remoteport
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_spine
argument_list|(
name|node
argument_list|)
condition|)
block|{
name|int
name|is_4700x2
init|=
name|is_spine_4700x2
argument_list|(
name|node
argument_list|)
decl_stmt|;
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|||
operator|!
name|port
operator|->
name|remoteport
condition|)
continue|continue;
comment|/* 			 * Skip ISR4700 double density fabric boards ports 19-36 			 * as they are chassis external ports 			 */
if|if
condition|(
name|is_4700x2
operator|&&
operator|(
name|port
operator|->
name|portnum
operator|>
literal|18
operator|)
condition|)
continue|continue;
name|remnode
operator|=
name|port
operator|->
name|remoteport
operator|->
name|node
expr_stmt|;
if|if
condition|(
name|remnode
operator|->
name|type
operator|!=
name|IB_NODE_SWITCH
condition|)
block|{
if|if
condition|(
operator|!
name|remnode
operator|->
name|ch_found
condition|)
name|get_router_slot
argument_list|(
name|remnode
argument_list|,
name|port
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|node
operator|->
name|ch_type
condition|)
comment|/* we assume here that remoteport belongs to line */
name|get_sfb_slot
argument_list|(
name|node
argument_list|,
name|port
operator|->
name|remoteport
argument_list|)
expr_stmt|;
comment|/* we could break here, but need to find if more routers connected */
block|}
block|}
elseif|else
if|if
condition|(
name|is_line
argument_list|(
name|node
argument_list|)
condition|)
block|{
name|int
name|is_4700_line
init|=
name|is_line_4700
argument_list|(
name|node
argument_list|)
decl_stmt|;
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|||
operator|!
name|port
operator|->
name|remoteport
condition|)
continue|continue;
if|if
condition|(
operator|(
name|is_4700_line
operator|&&
operator|(
name|port
operator|->
name|portnum
operator|>
literal|18
operator|)
operator|)
operator|||
operator|(
operator|!
name|is_4700_line
operator|&&
operator|(
name|port
operator|->
name|portnum
operator|>
literal|12
operator|)
operator|)
condition|)
continue|continue;
comment|/* we assume here that remoteport belongs to spine */
name|get_slb_slot
argument_list|(
name|node
argument_list|,
name|port
operator|->
name|remoteport
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* for each port of this node, map external ports */
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
continue|continue;
name|voltaire_portmap
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_line_index
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
if|if
condition|(
name|is_line_4700
argument_list|(
name|node
argument_list|)
condition|)
name|retval
operator|=
name|node
operator|->
name|ch_slotnum
expr_stmt|;
else|else
name|retval
operator|=
literal|3
operator|*
operator|(
name|node
operator|->
name|ch_slotnum
operator|-
literal|1
operator|)
operator|+
name|node
operator|->
name|ch_anafanum
expr_stmt|;
if|if
condition|(
name|retval
operator|>
name|LINES_MAX_NUM
operator|||
name|retval
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%s: retval = %d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|retval
argument_list|)
expr_stmt|;
name|IBND_ERROR
argument_list|(
literal|"Internal error\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_spine_index
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
if|if
condition|(
name|is_spine_9288
argument_list|(
name|node
argument_list|)
operator|||
name|is_spine_2012
argument_list|(
name|node
argument_list|)
condition|)
name|retval
operator|=
literal|3
operator|*
operator|(
name|node
operator|->
name|ch_slotnum
operator|-
literal|1
operator|)
operator|+
name|node
operator|->
name|ch_anafanum
expr_stmt|;
elseif|else
if|if
condition|(
name|is_spine_4700
argument_list|(
name|node
argument_list|)
operator|||
name|is_spine_4700x2
argument_list|(
name|node
argument_list|)
condition|)
name|retval
operator|=
literal|2
operator|*
operator|(
name|node
operator|->
name|ch_slotnum
operator|-
literal|1
operator|)
operator|+
name|node
operator|->
name|ch_anafanum
expr_stmt|;
else|else
name|retval
operator|=
name|node
operator|->
name|ch_slotnum
expr_stmt|;
if|if
condition|(
name|retval
operator|>
name|SPINES_MAX_NUM
operator|||
name|retval
operator|<
literal|1
condition|)
block|{
name|IBND_ERROR
argument_list|(
literal|"Internal error\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|insert_line_router
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|ibnd_chassis_t
modifier|*
name|chassis
parameter_list|)
block|{
name|int
name|i
init|=
name|get_line_index
argument_list|(
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
return|return
name|i
return|;
if|if
condition|(
name|chassis
operator|->
name|linenode
index|[
name|i
index|]
condition|)
return|return
literal|0
return|;
comment|/* already filled slot */
name|chassis
operator|->
name|linenode
index|[
name|i
index|]
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|chassis
operator|=
name|chassis
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|insert_spine
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|ibnd_chassis_t
modifier|*
name|chassis
parameter_list|)
block|{
name|int
name|i
init|=
name|get_spine_index
argument_list|(
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
return|return
name|i
return|;
if|if
condition|(
name|chassis
operator|->
name|spinenode
index|[
name|i
index|]
condition|)
return|return
literal|0
return|;
comment|/* already filled slot */
name|chassis
operator|->
name|spinenode
index|[
name|i
index|]
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|chassis
operator|=
name|chassis
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pass_on_lines_catch_spines
parameter_list|(
name|ibnd_chassis_t
modifier|*
name|chassis
parameter_list|)
block|{
name|ibnd_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|remnode
decl_stmt|;
name|ibnd_port_t
modifier|*
name|port
decl_stmt|;
name|int
name|i
decl_stmt|,
name|p
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|LINES_MAX_NUM
condition|;
name|i
operator|++
control|)
block|{
name|int
name|is_4700_line
decl_stmt|;
name|node
operator|=
name|chassis
operator|->
name|linenode
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|node
operator|&&
name|is_line
argument_list|(
name|node
argument_list|)
operator|)
condition|)
continue|continue;
comment|/* empty slot or router */
name|is_4700_line
operator|=
name|is_line_4700
argument_list|(
name|node
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|||
operator|!
name|port
operator|->
name|remoteport
condition|)
continue|continue;
if|if
condition|(
operator|(
name|is_4700_line
operator|&&
operator|(
name|port
operator|->
name|portnum
operator|>
literal|18
operator|)
operator|)
operator|||
operator|(
operator|!
name|is_4700_line
operator|&&
operator|(
name|port
operator|->
name|portnum
operator|>
literal|12
operator|)
operator|)
condition|)
continue|continue;
name|remnode
operator|=
name|port
operator|->
name|remoteport
operator|->
name|node
expr_stmt|;
if|if
condition|(
operator|!
name|remnode
operator|->
name|ch_found
condition|)
continue|continue;
comment|/* some error - spine not initialized ? FIXME */
if|if
condition|(
name|insert_spine
argument_list|(
name|remnode
argument_list|,
name|chassis
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pass_on_spines_catch_lines
parameter_list|(
name|ibnd_chassis_t
modifier|*
name|chassis
parameter_list|)
block|{
name|ibnd_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|remnode
decl_stmt|;
name|ibnd_port_t
modifier|*
name|port
decl_stmt|;
name|int
name|i
decl_stmt|,
name|p
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|SPINES_MAX_NUM
condition|;
name|i
operator|++
control|)
block|{
name|int
name|is_4700x2
decl_stmt|;
name|node
operator|=
name|chassis
operator|->
name|spinenode
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|node
condition|)
continue|continue;
comment|/* empty slot */
name|is_4700x2
operator|=
name|is_spine_4700x2
argument_list|(
name|node
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|||
operator|!
name|port
operator|->
name|remoteport
condition|)
continue|continue;
comment|/* 			 * ISR4700 double density fabric board ports 19-36 are 			 * chassis external ports, so skip them 			 */
if|if
condition|(
name|is_4700x2
operator|&&
operator|(
name|port
operator|->
name|portnum
operator|>
literal|18
operator|)
condition|)
continue|continue;
name|remnode
operator|=
name|port
operator|->
name|remoteport
operator|->
name|node
expr_stmt|;
if|if
condition|(
operator|!
name|remnode
operator|->
name|ch_found
condition|)
continue|continue;
comment|/* some error - line/router not initialized ? FIXME */
if|if
condition|(
name|insert_line_router
argument_list|(
name|remnode
argument_list|,
name|chassis
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* 	Stupid interpolation algorithm... 	But nothing to do - have to be compliant with VoltaireSM/NMS */
end_comment

begin_function
specifier|static
name|void
name|pass_on_spines_interpolate_chguid
parameter_list|(
name|ibnd_chassis_t
modifier|*
name|chassis
parameter_list|)
block|{
name|ibnd_node_t
modifier|*
name|node
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|SPINES_MAX_NUM
condition|;
name|i
operator|++
control|)
block|{
name|node
operator|=
name|chassis
operator|->
name|spinenode
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|node
condition|)
continue|continue;
comment|/* skip the empty slots */
comment|/* take first guid minus one to be consistent with SM */
name|chassis
operator|->
name|chassisguid
operator|=
name|node
operator|->
name|guid
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* 	This function fills chassis structure with all nodes 	in that chassis 	chassis structure = structure of one standalone chassis */
end_comment

begin_function
specifier|static
name|int
name|build_chassis
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|ibnd_chassis_t
modifier|*
name|chassis
parameter_list|)
block|{
name|int
name|p
init|=
literal|0
decl_stmt|;
name|ibnd_node_t
modifier|*
name|remnode
init|=
literal|0
decl_stmt|;
name|ibnd_port_t
modifier|*
name|port
init|=
literal|0
decl_stmt|;
comment|/* we get here with node = chassis_spine */
if|if
condition|(
name|insert_spine
argument_list|(
name|node
argument_list|,
name|chassis
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* loop: pass on all ports of node */
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|||
operator|!
name|port
operator|->
name|remoteport
condition|)
continue|continue;
comment|/* 		 * ISR4700 double density fabric board ports 19-36 are 		 * chassis external ports, so skip them 		 */
if|if
condition|(
name|is_spine_4700x2
argument_list|(
name|node
argument_list|)
operator|&&
operator|(
name|port
operator|->
name|portnum
operator|>
literal|18
operator|)
condition|)
continue|continue;
name|remnode
operator|=
name|port
operator|->
name|remoteport
operator|->
name|node
expr_stmt|;
if|if
condition|(
operator|!
name|remnode
operator|->
name|ch_found
condition|)
continue|continue;
comment|/* some error - line or router not initialized ? FIXME */
name|insert_line_router
argument_list|(
name|remnode
argument_list|,
name|chassis
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pass_on_lines_catch_spines
argument_list|(
name|chassis
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* this pass needed for to catch routers, since routers connected only */
comment|/* to spines in slot 1 or 4 and we could miss them first time */
if|if
condition|(
name|pass_on_spines_catch_lines
argument_list|(
name|chassis
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* additional 2 passes needed for to overcome a problem of pure "in-chassis" */
comment|/* connectivity - extra pass to ensure that all related chips/modules */
comment|/* inserted into the chassis */
if|if
condition|(
name|pass_on_lines_catch_spines
argument_list|(
name|chassis
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|pass_on_spines_catch_lines
argument_list|(
name|chassis
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pass_on_spines_interpolate_chguid
argument_list|(
name|chassis
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*========================================================*/
end_comment

begin_comment
comment|/*                INTERNAL TO EXTERNAL PORT MAPPING       */
end_comment

begin_comment
comment|/*========================================================*/
end_comment

begin_comment
comment|/* Description : On ISR9288/9096 external ports indexing               is not matching the internal ( anafa ) port               indexes. Use this MAP to translate the data you get from               the OpenIB diagnostics (smpquery, ibroute, ibtracert, etc.)  Module : sLB-24                 anafa 1             anafa 2 ext port | 13 14 15 16 17 18 | 19 20 21 22 23 24 int port | 22 23 24 18 17 16 | 22 23 24 18 17 16 ext port | 1  2  3  4  5  6  | 7  8  9  10 11 12 int port | 19 20 21 15 14 13 | 19 20 21 15 14 13 ------------------------------------------------  Module : sLB-8                 anafa 1             anafa 2 ext port | 13 14 15 16 17 18 | 19 20 21 22 23 24 int port | 24 23 22 18 17 16 | 24 23 22 18 17 16 ext port | 1  2  3  4  5  6  | 7  8  9  10 11 12 int port | 21 20 19 15 14 13 | 21 20 19 15 14 13  ----------->                 anafa 1             anafa 2 ext port | -  -  5  -  -  6  | -  -  7  -  -  8 int port | 24 23 22 18 17 16 | 24 23 22 18 17 16 ext port | -  -  1  -  -  2  | -  -  3  -  -  4 int port | 21 20 19 15 14 13 | 21 20 19 15 14 13 ------------------------------------------------  Module : sLB-2024  ext port | 13 14 15 16 17 18 19 20 21 22 23 24 A1 int port| 13 14 15 16 17 18 19 20 21 22 23 24 ext port | 1 2 3 4 5 6 7 8 9 10 11 12 A2 int port| 13 14 15 16 17 18 19 20 21 22 23 24 ---------------------------------------------------  Module : sLB-4018  int port | 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ext port |  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 ---------------------------------------------------  Module : sFB-4700X2    12X port -> 3 x 4X ports:  A1 int port | 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36    ext port |  7  7  7  8  8  8  9  9  9 10 10 10 11 11 11 12 12 12 A2 int port | 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36    ext port |  1  1  1  2  2  2  3  3  3  4  4  4  5  5  5  6  6  6  */
end_comment

begin_decl_stmt
name|int
name|int2ext_map_slb24
index|[
literal|2
index|]
index|[
literal|25
index|]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|6
block|,
literal|5
block|,
literal|4
block|,
literal|18
block|,
literal|17
block|,
literal|16
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|13
block|,
literal|14
block|,
literal|15
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|12
block|,
literal|11
block|,
literal|10
block|,
literal|24
block|,
literal|23
block|,
literal|22
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|int2ext_map_slb8
index|[
literal|2
index|]
index|[
literal|25
index|]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|6
block|,
literal|6
block|,
literal|6
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|8
block|,
literal|8
block|,
literal|8
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|int2ext_map_slb2024
index|[
literal|2
index|]
index|[
literal|25
index|]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|13
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|22
block|,
literal|23
block|,
literal|24
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|int2ext_map_slb4018
index|[
literal|37
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|,
literal|5
block|,
literal|6
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|,
literal|13
block|,
literal|14
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|18
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|int2ext_map_sfb4700x2
index|[
literal|2
index|]
index|[
literal|37
index|]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|,
literal|8
block|,
literal|8
block|,
literal|8
block|,
literal|9
block|,
literal|9
block|,
literal|9
block|,
literal|10
block|,
literal|10
block|,
literal|10
block|,
literal|11
block|,
literal|11
block|,
literal|11
block|,
literal|12
block|,
literal|12
block|,
literal|12
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|6
block|,
literal|6
block|,
literal|6
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*	reference			{ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24 }; */
end_comment

begin_comment
comment|/* map internal ports to external ports if appropriate */
end_comment

begin_function
specifier|static
name|void
name|voltaire_portmap
parameter_list|(
name|ibnd_port_t
modifier|*
name|port
parameter_list|)
block|{
name|int
name|portnum
init|=
name|port
operator|->
name|portnum
decl_stmt|;
name|int
name|chipnum
init|=
literal|0
decl_stmt|;
name|ibnd_node_t
modifier|*
name|node
init|=
name|port
operator|->
name|node
decl_stmt|;
name|int
name|is_4700_line
init|=
name|is_line_4700
argument_list|(
name|node
argument_list|)
decl_stmt|;
name|int
name|is_4700x2_spine
init|=
name|is_spine_4700x2
argument_list|(
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|node
operator|->
name|ch_found
operator|||
operator|(
operator|!
name|is_line
argument_list|(
name|node
argument_list|)
operator|&&
operator|!
name|is_4700x2_spine
operator|)
condition|)
block|{
name|port
operator|->
name|ext_portnum
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
operator|(
name|is_4700_line
operator|||
name|is_4700x2_spine
operator|)
operator|&&
operator|(
name|portnum
operator|<
literal|19
operator|||
name|portnum
operator|>
literal|36
operator|)
operator|)
operator|||
operator|(
operator|(
operator|!
name|is_4700_line
operator|&&
operator|!
name|is_4700x2_spine
operator|)
operator|&&
operator|(
name|portnum
operator|<
literal|13
operator|||
name|portnum
operator|>
literal|24
operator|)
operator|)
condition|)
block|{
name|port
operator|->
name|ext_portnum
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|port
operator|->
name|node
operator|->
name|ch_anafanum
operator|<
literal|1
operator|||
name|port
operator|->
name|node
operator|->
name|ch_anafanum
operator|>
literal|2
condition|)
block|{
name|port
operator|->
name|ext_portnum
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|chipnum
operator|=
name|port
operator|->
name|node
operator|->
name|ch_anafanum
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|is_line_24
argument_list|(
name|node
argument_list|)
condition|)
name|port
operator|->
name|ext_portnum
operator|=
name|int2ext_map_slb24
index|[
name|chipnum
index|]
index|[
name|portnum
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|is_line_2024
argument_list|(
name|node
argument_list|)
condition|)
name|port
operator|->
name|ext_portnum
operator|=
name|int2ext_map_slb2024
index|[
name|chipnum
index|]
index|[
name|portnum
index|]
expr_stmt|;
comment|/* sLB-4018: Only one asic per LB */
elseif|else
if|if
condition|(
name|is_4700_line
condition|)
name|port
operator|->
name|ext_portnum
operator|=
name|int2ext_map_slb4018
index|[
name|portnum
index|]
expr_stmt|;
comment|/* sFB-4700X2 4X port */
elseif|else
if|if
condition|(
name|is_4700x2_spine
condition|)
name|port
operator|->
name|ext_portnum
operator|=
name|int2ext_map_sfb4700x2
index|[
name|chipnum
index|]
index|[
name|portnum
index|]
expr_stmt|;
else|else
name|port
operator|->
name|ext_portnum
operator|=
name|int2ext_map_slb8
index|[
name|chipnum
index|]
index|[
name|portnum
index|]
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_chassis
parameter_list|(
name|chassis_scan_t
modifier|*
name|chassis_scan
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|chassis_scan
operator|->
name|current_chassis
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ibnd_chassis_t
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|IBND_ERROR
argument_list|(
literal|"OOM: failed to allocate chassis object\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|chassis_scan
operator|->
name|first_chassis
operator|==
name|NULL
condition|)
block|{
name|chassis_scan
operator|->
name|first_chassis
operator|=
name|chassis_scan
operator|->
name|current_chassis
expr_stmt|;
name|chassis_scan
operator|->
name|last_chassis
operator|=
name|chassis_scan
operator|->
name|current_chassis
expr_stmt|;
block|}
else|else
block|{
name|chassis_scan
operator|->
name|last_chassis
operator|->
name|next
operator|=
name|chassis_scan
operator|->
name|current_chassis
expr_stmt|;
name|chassis_scan
operator|->
name|last_chassis
operator|=
name|chassis_scan
operator|->
name|current_chassis
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_node_to_chassis
parameter_list|(
name|ibnd_chassis_t
modifier|*
name|chassis
parameter_list|,
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|node
operator|->
name|chassis
operator|=
name|chassis
expr_stmt|;
name|node
operator|->
name|next_chassis_node
operator|=
name|chassis
operator|->
name|nodes
expr_stmt|;
name|chassis
operator|->
name|nodes
operator|=
name|node
expr_stmt|;
block|}
end_function

begin_comment
comment|/* 	Main grouping function 	Algorithm: 	1. pass on every Voltaire node 	2. catch spine chip for every Voltaire node 		2.1 build/interpolate chassis around this chip 		2.2 go to 1. 	3. pass on non Voltaire nodes (SystemImageGUID based grouping) 	4. now group non Voltaire nodes by SystemImageGUID 	Returns: 	0 on success, -1 on failure */
end_comment

begin_function
name|int
name|group_nodes
parameter_list|(
name|ibnd_fabric_t
modifier|*
name|fabric
parameter_list|)
block|{
name|ibnd_node_t
modifier|*
name|node
decl_stmt|;
name|int
name|chassisnum
init|=
literal|0
decl_stmt|;
name|ibnd_chassis_t
modifier|*
name|chassis
decl_stmt|;
name|ibnd_chassis_t
modifier|*
name|ch
decl_stmt|,
modifier|*
name|ch_next
decl_stmt|;
name|chassis_scan_t
name|chassis_scan
decl_stmt|;
name|int
name|vendor_id
decl_stmt|;
name|chassis_scan
operator|.
name|first_chassis
operator|=
name|NULL
expr_stmt|;
name|chassis_scan
operator|.
name|current_chassis
operator|=
name|NULL
expr_stmt|;
name|chassis_scan
operator|.
name|last_chassis
operator|=
name|NULL
expr_stmt|;
comment|/* first pass on switches and build for every Voltaire node */
comment|/* an appropriate chassis record (slotnum and position) */
comment|/* according to internal connectivity */
comment|/* not very efficient but clear code so... */
for|for
control|(
name|node
operator|=
name|fabric
operator|->
name|switches
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|type_next
control|)
block|{
name|vendor_id
operator|=
name|mad_get_field
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|)
expr_stmt|;
if|if
condition|(
name|vendor_id
operator|==
name|VTR_VENDOR_ID
operator|&&
name|fill_voltaire_chassis_record
argument_list|(
name|node
argument_list|)
condition|)
goto|goto
name|cleanup
goto|;
elseif|else
if|if
condition|(
name|vendor_id
operator|==
name|MLX_VENDOR_ID
operator|&&
name|fill_mellanox_chassis_record
argument_list|(
name|node
argument_list|)
condition|)
goto|goto
name|cleanup
goto|;
block|}
comment|/* separate every Voltaire chassis from each other and build linked list of them */
comment|/* algorithm: catch spine and find all surrounding nodes */
for|for
control|(
name|node
operator|=
name|fabric
operator|->
name|switches
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|type_next
control|)
block|{
if|if
condition|(
name|mad_get_field
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|)
operator|!=
name|VTR_VENDOR_ID
condition|)
continue|continue;
if|if
condition|(
operator|!
name|node
operator|->
name|ch_found
operator|||
operator|(
name|node
operator|->
name|chassis
operator|&&
name|node
operator|->
name|chassis
operator|->
name|chassisnum
operator|)
operator|||
operator|!
name|is_spine
argument_list|(
name|node
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|add_chassis
argument_list|(
operator|&
name|chassis_scan
argument_list|)
condition|)
goto|goto
name|cleanup
goto|;
name|chassis_scan
operator|.
name|current_chassis
operator|->
name|chassisnum
operator|=
operator|++
name|chassisnum
expr_stmt|;
if|if
condition|(
name|build_chassis
argument_list|(
name|node
argument_list|,
name|chassis_scan
operator|.
name|current_chassis
argument_list|)
condition|)
goto|goto
name|cleanup
goto|;
block|}
comment|/* now make pass on nodes for chassis which are not Voltaire */
comment|/* grouped by common SystemImageGUID */
for|for
control|(
name|node
operator|=
name|fabric
operator|->
name|nodes
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|next
control|)
block|{
if|if
condition|(
name|mad_get_field
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|)
operator|==
name|VTR_VENDOR_ID
condition|)
continue|continue;
if|if
condition|(
name|mad_get_field64
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_SYSTEM_GUID_F
argument_list|)
condition|)
block|{
name|chassis
operator|=
name|find_chassisguid
argument_list|(
name|fabric
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|chassis
condition|)
name|chassis
operator|->
name|nodecount
operator|++
expr_stmt|;
else|else
block|{
comment|/* Possible new chassis */
if|if
condition|(
name|add_chassis
argument_list|(
operator|&
name|chassis_scan
argument_list|)
condition|)
goto|goto
name|cleanup
goto|;
name|chassis_scan
operator|.
name|current_chassis
operator|->
name|chassisguid
operator|=
name|get_chassisguid
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|chassis_scan
operator|.
name|current_chassis
operator|->
name|nodecount
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|fabric
operator|->
name|chassis
condition|)
name|fabric
operator|->
name|chassis
operator|=
name|chassis_scan
operator|.
name|first_chassis
expr_stmt|;
block|}
block|}
block|}
comment|/* now, make another pass to see which nodes are part of chassis */
comment|/* (defined as chassis->nodecount> 1) */
for|for
control|(
name|node
operator|=
name|fabric
operator|->
name|nodes
init|;
name|node
condition|;
name|node
operator|=
name|node
operator|->
name|next
control|)
block|{
name|vendor_id
operator|=
name|mad_get_field
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|)
expr_stmt|;
if|if
condition|(
name|vendor_id
operator|==
name|VTR_VENDOR_ID
condition|)
continue|continue;
if|if
condition|(
name|mad_get_field64
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_SYSTEM_GUID_F
argument_list|)
condition|)
block|{
name|chassis
operator|=
name|find_chassisguid
argument_list|(
name|fabric
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|chassis
operator|&&
name|chassis
operator|->
name|nodecount
operator|>
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|chassis
operator|->
name|chassisnum
condition|)
name|chassis
operator|->
name|chassisnum
operator|=
operator|++
name|chassisnum
expr_stmt|;
if|if
condition|(
operator|!
name|node
operator|->
name|ch_found
condition|)
block|{
name|node
operator|->
name|ch_found
operator|=
literal|1
expr_stmt|;
name|add_node_to_chassis
argument_list|(
name|chassis
argument_list|,
name|node
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vendor_id
operator|==
name|MLX_VENDOR_ID
condition|)
block|{
name|insert_mellanox_line_and_spine
argument_list|(
name|node
argument_list|,
name|chassis
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|fabric
operator|->
name|chassis
operator|=
name|chassis_scan
operator|.
name|first_chassis
expr_stmt|;
return|return
literal|0
return|;
name|cleanup
label|:
name|ch
operator|=
name|chassis_scan
operator|.
name|first_chassis
expr_stmt|;
while|while
condition|(
name|ch
condition|)
block|{
name|ch_next
operator|=
name|ch
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ch
operator|=
name|ch_next
expr_stmt|;
block|}
name|fabric
operator|->
name|chassis
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2008-2014 Intel Corporation.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/endian.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<sys/epoll.h>
end_include

begin_include
include|#
directive|include
file|<search.h>
end_include

begin_include
include|#
directive|include
file|<byteswap.h>
end_include

begin_include
include|#
directive|include
file|<util/compiler.h>
end_include

begin_include
include|#
directive|include
file|<rdma/rdma_cma.h>
end_include

begin_include
include|#
directive|include
file|<rdma/rdma_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/rsocket.h>
end_include

begin_include
include|#
directive|include
file|"cma.h"
end_include

begin_include
include|#
directive|include
file|"indexer.h"
end_include

begin_define
define|#
directive|define
name|RS_OLAP_START_SIZE
value|2048
end_define

begin_define
define|#
directive|define
name|RS_MAX_TRANSFER
value|65536
end_define

begin_define
define|#
directive|define
name|RS_SNDLOWAT
value|2048
end_define

begin_define
define|#
directive|define
name|RS_QP_MIN_SIZE
value|16
end_define

begin_define
define|#
directive|define
name|RS_QP_MAX_SIZE
value|0xFFFE
end_define

begin_define
define|#
directive|define
name|RS_QP_CTRL_SIZE
value|4
end_define

begin_comment
comment|/* must be power of 2 */
end_comment

begin_define
define|#
directive|define
name|RS_CONN_RETRIES
value|6
end_define

begin_define
define|#
directive|define
name|RS_SGL_SIZE
value|2
end_define

begin_decl_stmt
specifier|static
name|struct
name|index_map
name|idm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|pthread_mutex_t
name|mut
init|=
name|PTHREAD_MUTEX_INITIALIZER
decl_stmt|;
end_decl_stmt

begin_struct_decl
struct_decl|struct
name|rsocket
struct_decl|;
end_struct_decl

begin_enum
enum|enum
block|{
name|RS_SVC_NOOP
block|,
name|RS_SVC_ADD_DGRAM
block|,
name|RS_SVC_REM_DGRAM
block|,
name|RS_SVC_ADD_KEEPALIVE
block|,
name|RS_SVC_REM_KEEPALIVE
block|,
name|RS_SVC_MOD_KEEPALIVE
block|}
enum|;
end_enum

begin_struct
struct|struct
name|rs_svc_msg
block|{
name|uint32_t
name|cmd
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rs_svc
block|{
name|pthread_t
name|id
decl_stmt|;
name|int
name|sock
index|[
literal|2
index|]
decl_stmt|;
name|int
name|cnt
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|context_size
decl_stmt|;
name|void
modifier|*
function_decl|(
modifier|*
name|run
function_decl|)
parameter_list|(
name|void
modifier|*
name|svc
parameter_list|)
function_decl|;
name|struct
name|rsocket
modifier|*
modifier|*
name|rss
decl_stmt|;
name|void
modifier|*
name|contexts
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|pollfd
modifier|*
name|udp_svc_fds
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
modifier|*
name|udp_svc_run
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|rs_svc
name|udp_svc
init|=
block|{
operator|.
name|context_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|udp_svc_fds
argument_list|)
block|,
operator|.
name|run
operator|=
name|udp_svc_run
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
modifier|*
name|tcp_svc_timeouts
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
modifier|*
name|tcp_svc_run
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|rs_svc
name|tcp_svc
init|=
block|{
operator|.
name|context_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|tcp_svc_timeouts
argument_list|)
block|,
operator|.
name|run
operator|=
name|tcp_svc_run
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|def_iomap_size
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|def_inline
init|=
literal|64
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|def_sqsize
init|=
literal|384
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|def_rqsize
init|=
literal|384
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|def_mem
init|=
operator|(
literal|1
operator|<<
literal|17
operator|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|def_wmem
init|=
operator|(
literal|1
operator|<<
literal|17
operator|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|polling_time
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Immediate data format is determined by the upper bits  * bit 31: message type, 0 - data, 1 - control  * bit 30: buffers updated, 0 - target, 1 - direct-receive  * bit 29: more data, 0 - end of transfer, 1 - more data available  *  * for data transfers:  * bits [28:0]: bytes transferred  * for control messages:  * SGL, CTRL  * bits [28-0]: receive credits granted  * IOMAP_SGL  * bits [28-16]: reserved, bits [15-0]: index  */
end_comment

begin_enum
enum|enum
block|{
name|RS_OP_DATA
block|,
name|RS_OP_RSVD_DATA_MORE
block|,
name|RS_OP_WRITE
block|,
comment|/* opcode is not transmitted over the network */
name|RS_OP_RSVD_DRA_MORE
block|,
name|RS_OP_SGL
block|,
name|RS_OP_RSVD
block|,
name|RS_OP_IOMAP_SGL
block|,
name|RS_OP_CTRL
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|rs_msg_set
parameter_list|(
name|op
parameter_list|,
name|data
parameter_list|)
value|((op<< 29) | (uint32_t) (data))
end_define

begin_define
define|#
directive|define
name|rs_msg_op
parameter_list|(
name|imm_data
parameter_list|)
value|(imm_data>> 29)
end_define

begin_define
define|#
directive|define
name|rs_msg_data
parameter_list|(
name|imm_data
parameter_list|)
value|(imm_data& 0x1FFFFFFF)
end_define

begin_define
define|#
directive|define
name|RS_MSG_SIZE
value|sizeof(uint32_t)
end_define

begin_define
define|#
directive|define
name|RS_WR_ID_FLAG_RECV
value|(((uint64_t) 1)<< 63)
end_define

begin_define
define|#
directive|define
name|RS_WR_ID_FLAG_MSG_SEND
value|(((uint64_t) 1)<< 62)
end_define

begin_comment
comment|/* See RS_OPT_MSG_SEND */
end_comment

begin_define
define|#
directive|define
name|rs_send_wr_id
parameter_list|(
name|data
parameter_list|)
value|((uint64_t) data)
end_define

begin_define
define|#
directive|define
name|rs_recv_wr_id
parameter_list|(
name|data
parameter_list|)
value|(RS_WR_ID_FLAG_RECV | (uint64_t) data)
end_define

begin_define
define|#
directive|define
name|rs_wr_is_recv
parameter_list|(
name|wr_id
parameter_list|)
value|(wr_id& RS_WR_ID_FLAG_RECV)
end_define

begin_define
define|#
directive|define
name|rs_wr_is_msg_send
parameter_list|(
name|wr_id
parameter_list|)
value|(wr_id& RS_WR_ID_FLAG_MSG_SEND)
end_define

begin_define
define|#
directive|define
name|rs_wr_data
parameter_list|(
name|wr_id
parameter_list|)
value|((uint32_t) wr_id)
end_define

begin_enum
enum|enum
block|{
name|RS_CTRL_DISCONNECT
block|,
name|RS_CTRL_KEEPALIVE
block|,
name|RS_CTRL_SHUTDOWN
block|}
enum|;
end_enum

begin_struct
struct|struct
name|rs_msg
block|{
name|uint32_t
name|op
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
block|}
struct|;
end_struct

begin_struct_decl
struct_decl|struct
name|ds_qp
struct_decl|;
end_struct_decl

begin_struct
struct|struct
name|ds_rmsg
block|{
name|struct
name|ds_qp
modifier|*
name|qp
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|uint32_t
name|length
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ds_smsg
block|{
name|struct
name|ds_smsg
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rs_sge
block|{
name|uint64_t
name|addr
decl_stmt|;
name|uint32_t
name|key
decl_stmt|;
name|uint32_t
name|length
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rs_iomap
block|{
name|uint64_t
name|offset
decl_stmt|;
name|struct
name|rs_sge
name|sge
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rs_iomap_mr
block|{
name|uint64_t
name|offset
decl_stmt|;
name|struct
name|ibv_mr
modifier|*
name|mr
decl_stmt|;
name|dlist_entry
name|entry
decl_stmt|;
atomic|_Atomic
argument_list|(
name|int
argument_list|)
name|refcnt
decl_stmt|;
name|int
name|index
decl_stmt|;
comment|/* -1 if mapping is local and not in iomap_list */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|RS_MAX_CTRL_MSG
value|(sizeof(struct rs_sge))
end_define

begin_define
define|#
directive|define
name|rs_host_is_net
parameter_list|()
value|(__BYTE_ORDER == __BIG_ENDIAN)
end_define

begin_define
define|#
directive|define
name|RS_CONN_FLAG_NET
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|RS_CONN_FLAG_IOMAP
value|(1<< 1)
end_define

begin_struct
struct|struct
name|rs_conn_data
block|{
name|uint8_t
name|version
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|;
name|__be16
name|credits
decl_stmt|;
name|uint8_t
name|reserved
index|[
literal|3
index|]
decl_stmt|;
name|uint8_t
name|target_iomap_size
decl_stmt|;
name|struct
name|rs_sge
name|target_sgl
decl_stmt|;
name|struct
name|rs_sge
name|data_buf
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rs_conn_private_data
block|{
union|union
block|{
name|struct
name|rs_conn_data
name|conn_data
decl_stmt|;
struct|struct
block|{
name|struct
name|ib_connect_hdr
name|ib_hdr
decl_stmt|;
name|struct
name|rs_conn_data
name|conn_data
decl_stmt|;
block|}
name|af_ib
struct|;
block|}
union|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * rsocket states are ordered as passive, connecting, connected, disconnected.  */
end_comment

begin_enum
enum|enum
name|rs_state
block|{
name|rs_init
block|,
name|rs_bound
init|=
literal|0x0001
block|,
name|rs_listening
init|=
literal|0x0002
block|,
name|rs_opening
init|=
literal|0x0004
block|,
name|rs_resolving_addr
init|=
name|rs_opening
operator||
literal|0x0010
block|,
name|rs_resolving_route
init|=
name|rs_opening
operator||
literal|0x0020
block|,
name|rs_connecting
init|=
name|rs_opening
operator||
literal|0x0040
block|,
name|rs_accepting
init|=
name|rs_opening
operator||
literal|0x0080
block|,
name|rs_connected
init|=
literal|0x0100
block|,
name|rs_writable
init|=
literal|0x0200
block|,
name|rs_readable
init|=
literal|0x0400
block|,
name|rs_connect_rdwr
init|=
name|rs_connected
operator||
name|rs_readable
operator||
name|rs_writable
block|,
name|rs_connect_error
init|=
literal|0x0800
block|,
name|rs_disconnected
init|=
literal|0x1000
block|,
name|rs_error
init|=
literal|0x2000
block|, }
enum|;
end_enum

begin_define
define|#
directive|define
name|RS_OPT_SWAP_SGL
value|(1<< 0)
end_define

begin_comment
comment|/*  * iWarp does not support RDMA write with immediate data.  For iWarp, we  * transfer rsocket messages as inline sends.  */
end_comment

begin_define
define|#
directive|define
name|RS_OPT_MSG_SEND
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|RS_OPT_SVC_ACTIVE
value|(1<< 2)
end_define

begin_union
union|union
name|socket_addr
block|{
name|struct
name|sockaddr
name|sa
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
block|}
union|;
end_union

begin_struct
struct|struct
name|ds_header
block|{
name|uint8_t
name|version
decl_stmt|;
name|uint8_t
name|length
decl_stmt|;
name|__be16
name|port
decl_stmt|;
union|union
block|{
name|__be32
name|ipv4
decl_stmt|;
struct|struct
block|{
name|__be32
name|flowinfo
decl_stmt|;
name|uint8_t
name|addr
index|[
literal|16
index|]
decl_stmt|;
block|}
name|ipv6
struct|;
block|}
name|addr
union|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DS_IPV4_HDR_LEN
value|8
end_define

begin_define
define|#
directive|define
name|DS_IPV6_HDR_LEN
value|24
end_define

begin_struct
struct|struct
name|ds_dest
block|{
name|union
name|socket_addr
name|addr
decl_stmt|;
comment|/* must be first */
name|struct
name|ds_qp
modifier|*
name|qp
decl_stmt|;
name|struct
name|ibv_ah
modifier|*
name|ah
decl_stmt|;
name|uint32_t
name|qpn
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ds_qp
block|{
name|dlist_entry
name|list
decl_stmt|;
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|struct
name|rdma_cm_id
modifier|*
name|cm_id
decl_stmt|;
name|struct
name|ds_header
name|hdr
decl_stmt|;
name|struct
name|ds_dest
name|dest
decl_stmt|;
name|struct
name|ibv_mr
modifier|*
name|smr
decl_stmt|;
name|struct
name|ibv_mr
modifier|*
name|rmr
decl_stmt|;
name|uint8_t
modifier|*
name|rbuf
decl_stmt|;
name|int
name|cq_armed
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rsocket
block|{
name|int
name|type
decl_stmt|;
name|int
name|index
decl_stmt|;
name|fastlock_t
name|slock
decl_stmt|;
name|fastlock_t
name|rlock
decl_stmt|;
name|fastlock_t
name|cq_lock
decl_stmt|;
name|fastlock_t
name|cq_wait_lock
decl_stmt|;
name|fastlock_t
name|map_lock
decl_stmt|;
comment|/* acquire slock first if needed */
union|union
block|{
comment|/* data stream */
struct|struct
block|{
name|struct
name|rdma_cm_id
modifier|*
name|cm_id
decl_stmt|;
name|uint64_t
name|tcp_opts
decl_stmt|;
name|unsigned
name|int
name|keepalive_time
decl_stmt|;
name|unsigned
name|int
name|ctrl_seqno
decl_stmt|;
name|unsigned
name|int
name|ctrl_max_seqno
decl_stmt|;
name|uint16_t
name|sseq_no
decl_stmt|;
name|uint16_t
name|sseq_comp
decl_stmt|;
name|uint16_t
name|rseq_no
decl_stmt|;
name|uint16_t
name|rseq_comp
decl_stmt|;
name|int
name|remote_sge
decl_stmt|;
name|struct
name|rs_sge
name|remote_sgl
decl_stmt|;
name|struct
name|rs_sge
name|remote_iomap
decl_stmt|;
name|struct
name|ibv_mr
modifier|*
name|target_mr
decl_stmt|;
name|int
name|target_sge
decl_stmt|;
name|int
name|target_iomap_size
decl_stmt|;
name|void
modifier|*
name|target_buffer_list
decl_stmt|;
specifier|volatile
name|struct
name|rs_sge
modifier|*
name|target_sgl
decl_stmt|;
name|struct
name|rs_iomap
modifier|*
name|target_iomap
decl_stmt|;
name|int
name|rbuf_msg_index
decl_stmt|;
name|int
name|rbuf_bytes_avail
decl_stmt|;
name|int
name|rbuf_free_offset
decl_stmt|;
name|int
name|rbuf_offset
decl_stmt|;
name|struct
name|ibv_mr
modifier|*
name|rmr
decl_stmt|;
name|uint8_t
modifier|*
name|rbuf
decl_stmt|;
name|int
name|sbuf_bytes_avail
decl_stmt|;
name|struct
name|ibv_mr
modifier|*
name|smr
decl_stmt|;
name|struct
name|ibv_sge
name|ssgl
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
comment|/* datagram */
struct|struct
block|{
name|struct
name|ds_qp
modifier|*
name|qp_list
decl_stmt|;
name|void
modifier|*
name|dest_map
decl_stmt|;
name|struct
name|ds_dest
modifier|*
name|conn_dest
decl_stmt|;
name|int
name|udp_sock
decl_stmt|;
name|int
name|epfd
decl_stmt|;
name|int
name|rqe_avail
decl_stmt|;
name|struct
name|ds_smsg
modifier|*
name|smsg_free
decl_stmt|;
block|}
struct|;
block|}
union|;
name|int
name|opts
decl_stmt|;
name|int
name|fd_flags
decl_stmt|;
name|uint64_t
name|so_opts
decl_stmt|;
name|uint64_t
name|ipv6_opts
decl_stmt|;
name|void
modifier|*
name|optval
decl_stmt|;
name|size_t
name|optlen
decl_stmt|;
name|int
name|state
decl_stmt|;
name|int
name|cq_armed
decl_stmt|;
name|int
name|retries
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|sqe_avail
decl_stmt|;
name|uint32_t
name|sbuf_size
decl_stmt|;
name|uint16_t
name|sq_size
decl_stmt|;
name|uint16_t
name|sq_inline
decl_stmt|;
name|uint32_t
name|rbuf_size
decl_stmt|;
name|uint16_t
name|rq_size
decl_stmt|;
name|int
name|rmsg_head
decl_stmt|;
name|int
name|rmsg_tail
decl_stmt|;
union|union
block|{
name|struct
name|rs_msg
modifier|*
name|rmsg
decl_stmt|;
name|struct
name|ds_rmsg
modifier|*
name|dmsg
decl_stmt|;
block|}
union|;
name|uint8_t
modifier|*
name|sbuf
decl_stmt|;
name|struct
name|rs_iomap_mr
modifier|*
name|remote_iomappings
decl_stmt|;
name|dlist_entry
name|iomap_list
decl_stmt|;
name|dlist_entry
name|iomap_queue
decl_stmt|;
name|int
name|iomap_pending
decl_stmt|;
name|int
name|unack_cqe
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DS_UDP_TAG
value|0x55555555
end_define

begin_struct
struct|struct
name|ds_udp_header
block|{
name|__be32
name|tag
decl_stmt|;
name|uint8_t
name|version
decl_stmt|;
name|uint8_t
name|op
decl_stmt|;
name|uint8_t
name|length
decl_stmt|;
name|uint8_t
name|reserved
decl_stmt|;
name|__be32
name|qpn
decl_stmt|;
comment|/* lower 8-bits reserved */
union|union
block|{
name|__be32
name|ipv4
decl_stmt|;
name|uint8_t
name|ipv6
index|[
literal|16
index|]
decl_stmt|;
block|}
name|addr
union|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DS_UDP_IPV4_HDR_LEN
value|16
end_define

begin_define
define|#
directive|define
name|DS_UDP_IPV6_HDR_LEN
value|28
end_define

begin_define
define|#
directive|define
name|ds_next_qp
parameter_list|(
name|qp
parameter_list|)
value|container_of((qp)->list.next, struct ds_qp, list)
end_define

begin_function
specifier|static
name|void
name|write_all
parameter_list|(
name|int
name|fd
parameter_list|,
specifier|const
name|void
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
comment|// FIXME: if fd is a socket this really needs to handle EINTR and other conditions.
name|ssize_t
name|rc
init|=
name|write
argument_list|(
name|fd
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|rc
operator|==
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|read_all
parameter_list|(
name|int
name|fd
parameter_list|,
name|void
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
comment|// FIXME: if fd is a socket this really needs to handle EINTR and other conditions.
name|ssize_t
name|rc
init|=
name|read
argument_list|(
name|fd
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|rc
operator|==
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_insert_qp
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|ds_qp
modifier|*
name|qp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|rs
operator|->
name|qp_list
condition|)
name|dlist_init
argument_list|(
operator|&
name|qp
operator|->
name|list
argument_list|)
expr_stmt|;
else|else
name|dlist_insert_head
argument_list|(
operator|&
name|qp
operator|->
name|list
argument_list|,
operator|&
name|rs
operator|->
name|qp_list
operator|->
name|list
argument_list|)
expr_stmt|;
name|rs
operator|->
name|qp_list
operator|=
name|qp
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_remove_qp
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|ds_qp
modifier|*
name|qp
parameter_list|)
block|{
if|if
condition|(
name|qp
operator|->
name|list
operator|.
name|next
operator|!=
operator|&
name|qp
operator|->
name|list
condition|)
block|{
name|rs
operator|->
name|qp_list
operator|=
name|ds_next_qp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|dlist_remove
argument_list|(
operator|&
name|qp
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|qp_list
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rs_notify_svc
parameter_list|(
name|struct
name|rs_svc
modifier|*
name|svc
parameter_list|,
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|cmd
parameter_list|)
block|{
name|struct
name|rs_svc_msg
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|mut
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svc
operator|->
name|cnt
condition|)
block|{
name|ret
operator|=
name|socketpair
argument_list|(
name|AF_UNIX
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|,
name|svc
operator|->
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|unlock
goto|;
name|ret
operator|=
name|pthread_create
argument_list|(
operator|&
name|svc
operator|->
name|id
argument_list|,
name|NULL
argument_list|,
name|svc
operator|->
name|run
argument_list|,
name|svc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|closepair
goto|;
block|}
block|}
name|msg
operator|.
name|cmd
operator|=
name|cmd
expr_stmt|;
name|msg
operator|.
name|status
operator|=
name|EINVAL
expr_stmt|;
name|msg
operator|.
name|rs
operator|=
name|rs
expr_stmt|;
name|write_all
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|0
index|]
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
name|read_all
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|0
index|]
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_seterrno
argument_list|(
name|msg
operator|.
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|svc
operator|->
name|cnt
condition|)
goto|goto
name|unlock
goto|;
name|pthread_join
argument_list|(
name|svc
operator|->
name|id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|closepair
label|:
name|close
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|unlock
label|:
name|pthread_mutex_unlock
argument_list|(
operator|&
name|mut
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_compare_addr
parameter_list|(
specifier|const
name|void
modifier|*
name|dst1
parameter_list|,
specifier|const
name|void
modifier|*
name|dst2
parameter_list|)
block|{
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa1
decl_stmt|,
modifier|*
name|sa2
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|sa1
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr
operator|*
operator|)
name|dst1
expr_stmt|;
name|sa2
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr
operator|*
operator|)
name|dst2
expr_stmt|;
name|len
operator|=
operator|(
name|sa1
operator|->
name|sa_family
operator|==
name|AF_INET6
operator|&&
name|sa2
operator|->
name|sa_family
operator|==
name|AF_INET6
operator|)
condition|?
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
else|:
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
return|return
name|memcmp
argument_list|(
name|dst1
argument_list|,
name|dst2
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_value_to_scale
parameter_list|(
name|int
name|value
parameter_list|,
name|int
name|bits
parameter_list|)
block|{
return|return
name|value
operator|<=
operator|(
literal|1
operator|<<
operator|(
name|bits
operator|-
literal|1
operator|)
operator|)
condition|?
name|value
else|:
operator|(
literal|1
operator|<<
operator|(
name|bits
operator|-
literal|1
operator|)
operator|)
operator||
operator|(
name|value
operator|>>
name|bits
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_scale_to_value
parameter_list|(
name|int
name|value
parameter_list|,
name|int
name|bits
parameter_list|)
block|{
return|return
name|value
operator|<=
operator|(
literal|1
operator|<<
operator|(
name|bits
operator|-
literal|1
operator|)
operator|)
condition|?
name|value
else|:
operator|(
name|value
operator|&
operator|~
operator|(
literal|1
operator|<<
operator|(
name|bits
operator|-
literal|1
operator|)
operator|)
operator|)
operator|<<
name|bits
return|;
block|}
end_function

begin_comment
comment|/* gcc> ~5 will not allow (void)fscanf to suppress -Wunused-result, but this    will do it.  In this case ignoring the result is OK (but horribly    unfriendly to user) since the library has a sane default. */
end_comment

begin_define
define|#
directive|define
name|failable_fscanf
parameter_list|(
name|f
parameter_list|,
name|fmt
parameter_list|,
modifier|...
parameter_list|)
define|\
value|{                                                                      \ 		int rc = fscanf(f, fmt, __VA_ARGS__);                          \ 		(void) rc;                                                     \ 	}
end_define

begin_function
specifier|static
name|void
name|rs_configure
parameter_list|(
name|void
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
specifier|static
name|int
name|init
decl_stmt|;
if|if
condition|(
name|init
condition|)
return|return;
name|pthread_mutex_lock
argument_list|(
operator|&
name|mut
argument_list|)
expr_stmt|;
if|if
condition|(
name|init
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|ucma_init
argument_list|()
condition|)
goto|goto
name|out
goto|;
name|ucma_ib_init
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|RS_CONF_DIR
literal|"/polling_time"
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|failable_fscanf
argument_list|(
name|f
argument_list|,
literal|"%u"
argument_list|,
operator|&
name|polling_time
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|RS_CONF_DIR
literal|"/inline_default"
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|failable_fscanf
argument_list|(
name|f
argument_list|,
literal|"%hu"
argument_list|,
operator|&
name|def_inline
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|RS_CONF_DIR
literal|"/sqsize_default"
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|failable_fscanf
argument_list|(
name|f
argument_list|,
literal|"%hu"
argument_list|,
operator|&
name|def_sqsize
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|RS_CONF_DIR
literal|"/rqsize_default"
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|failable_fscanf
argument_list|(
name|f
argument_list|,
literal|"%hu"
argument_list|,
operator|&
name|def_rqsize
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|RS_CONF_DIR
literal|"/mem_default"
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|failable_fscanf
argument_list|(
name|f
argument_list|,
literal|"%u"
argument_list|,
operator|&
name|def_mem
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|def_mem
operator|<
literal|1
condition|)
name|def_mem
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|RS_CONF_DIR
literal|"/wmem_default"
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|failable_fscanf
argument_list|(
name|f
argument_list|,
literal|"%u"
argument_list|,
operator|&
name|def_wmem
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|def_wmem
operator|<
name|RS_SNDLOWAT
condition|)
name|def_wmem
operator|=
name|RS_SNDLOWAT
operator|<<
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|RS_CONF_DIR
literal|"/iomap_size"
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|failable_fscanf
argument_list|(
name|f
argument_list|,
literal|"%hu"
argument_list|,
operator|&
name|def_iomap_size
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* round to supported values */
name|def_iomap_size
operator|=
operator|(
name|uint8_t
operator|)
name|rs_value_to_scale
argument_list|(
operator|(
name|uint16_t
operator|)
name|rs_scale_to_value
argument_list|(
name|def_iomap_size
argument_list|,
literal|8
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
name|init
operator|=
literal|1
expr_stmt|;
name|out
label|:
name|pthread_mutex_unlock
argument_list|(
operator|&
name|mut
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_insert
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|pthread_mutex_lock
argument_list|(
operator|&
name|mut
argument_list|)
expr_stmt|;
name|rs
operator|->
name|index
operator|=
name|idm_set
argument_list|(
operator|&
name|idm
argument_list|,
name|index
argument_list|,
name|rs
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|mut
argument_list|)
expr_stmt|;
return|return
name|rs
operator|->
name|index
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_remove
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|pthread_mutex_lock
argument_list|(
operator|&
name|mut
argument_list|)
expr_stmt|;
name|idm_clear
argument_list|(
operator|&
name|idm
argument_list|,
name|rs
operator|->
name|index
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|mut
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* We only inherit from listening sockets */
end_comment

begin_function
specifier|static
name|struct
name|rsocket
modifier|*
name|rs_alloc
parameter_list|(
name|struct
name|rsocket
modifier|*
name|inherited_rs
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|rs
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|NULL
return|;
name|rs
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|rs
operator|->
name|index
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|rs
operator|->
name|udp_sock
operator|=
operator|-
literal|1
expr_stmt|;
name|rs
operator|->
name|epfd
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|inherited_rs
condition|)
block|{
name|rs
operator|->
name|sbuf_size
operator|=
name|inherited_rs
operator|->
name|sbuf_size
expr_stmt|;
name|rs
operator|->
name|rbuf_size
operator|=
name|inherited_rs
operator|->
name|rbuf_size
expr_stmt|;
name|rs
operator|->
name|sq_inline
operator|=
name|inherited_rs
operator|->
name|sq_inline
expr_stmt|;
name|rs
operator|->
name|sq_size
operator|=
name|inherited_rs
operator|->
name|sq_size
expr_stmt|;
name|rs
operator|->
name|rq_size
operator|=
name|inherited_rs
operator|->
name|rq_size
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|rs
operator|->
name|ctrl_max_seqno
operator|=
name|inherited_rs
operator|->
name|ctrl_max_seqno
expr_stmt|;
name|rs
operator|->
name|target_iomap_size
operator|=
name|inherited_rs
operator|->
name|target_iomap_size
expr_stmt|;
block|}
block|}
else|else
block|{
name|rs
operator|->
name|sbuf_size
operator|=
name|def_wmem
expr_stmt|;
name|rs
operator|->
name|rbuf_size
operator|=
name|def_mem
expr_stmt|;
name|rs
operator|->
name|sq_inline
operator|=
name|def_inline
expr_stmt|;
name|rs
operator|->
name|sq_size
operator|=
name|def_sqsize
expr_stmt|;
name|rs
operator|->
name|rq_size
operator|=
name|def_rqsize
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|rs
operator|->
name|ctrl_max_seqno
operator|=
name|RS_QP_CTRL_SIZE
expr_stmt|;
name|rs
operator|->
name|target_iomap_size
operator|=
name|def_iomap_size
expr_stmt|;
block|}
block|}
name|fastlock_init
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|fastlock_init
argument_list|(
operator|&
name|rs
operator|->
name|rlock
argument_list|)
expr_stmt|;
name|fastlock_init
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
name|fastlock_init
argument_list|(
operator|&
name|rs
operator|->
name|cq_wait_lock
argument_list|)
expr_stmt|;
name|fastlock_init
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
name|dlist_init
argument_list|(
operator|&
name|rs
operator|->
name|iomap_list
argument_list|)
expr_stmt|;
name|dlist_init
argument_list|(
operator|&
name|rs
operator|->
name|iomap_queue
argument_list|)
expr_stmt|;
return|return
name|rs
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_set_nonblocking
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|struct
name|ds_qp
modifier|*
name|qp
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq_channel
condition|)
name|ret
operator|=
name|fcntl
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq_channel
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|&&
name|rs
operator|->
name|state
operator|<
name|rs_connected
condition|)
name|ret
operator|=
name|fcntl
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|channel
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|fcntl
argument_list|(
name|rs
operator|->
name|epfd
argument_list|,
name|F_SETFL
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|&&
name|rs
operator|->
name|qp_list
condition|)
block|{
name|qp
operator|=
name|rs
operator|->
name|qp_list
expr_stmt|;
do|do
block|{
name|ret
operator|=
name|fcntl
argument_list|(
name|qp
operator|->
name|cm_id
operator|->
name|recv_cq_channel
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|qp
operator|=
name|ds_next_qp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|qp
operator|!=
name|rs
operator|->
name|qp_list
operator|&&
operator|!
name|ret
condition|)
do|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_set_qp_size
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|uint16_t
name|max_size
decl_stmt|;
name|max_size
operator|=
name|min
argument_list|(
name|ucma_max_qpsize
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
argument_list|,
name|RS_QP_MAX_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|sq_size
operator|>
name|max_size
condition|)
name|rs
operator|->
name|sq_size
operator|=
name|max_size
expr_stmt|;
elseif|else
if|if
condition|(
name|rs
operator|->
name|sq_size
operator|<
name|RS_QP_MIN_SIZE
condition|)
name|rs
operator|->
name|sq_size
operator|=
name|RS_QP_MIN_SIZE
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|rq_size
operator|>
name|max_size
condition|)
name|rs
operator|->
name|rq_size
operator|=
name|max_size
expr_stmt|;
elseif|else
if|if
condition|(
name|rs
operator|->
name|rq_size
operator|<
name|RS_QP_MIN_SIZE
condition|)
name|rs
operator|->
name|rq_size
operator|=
name|RS_QP_MIN_SIZE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_set_qp_size
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|uint16_t
name|max_size
decl_stmt|;
name|max_size
operator|=
name|min
argument_list|(
name|ucma_max_qpsize
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|RS_QP_MAX_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|sq_size
operator|>
name|max_size
condition|)
name|rs
operator|->
name|sq_size
operator|=
name|max_size
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|rq_size
operator|>
name|max_size
condition|)
name|rs
operator|->
name|rq_size
operator|=
name|max_size
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|rq_size
operator|>
operator|(
name|rs
operator|->
name|rbuf_size
operator|/
name|RS_SNDLOWAT
operator|)
condition|)
name|rs
operator|->
name|rq_size
operator|=
name|rs
operator|->
name|rbuf_size
operator|/
name|RS_SNDLOWAT
expr_stmt|;
else|else
name|rs
operator|->
name|rbuf_size
operator|=
name|rs
operator|->
name|rq_size
operator|*
name|RS_SNDLOWAT
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|sq_size
operator|>
operator|(
name|rs
operator|->
name|sbuf_size
operator|/
name|RS_SNDLOWAT
operator|)
condition|)
name|rs
operator|->
name|sq_size
operator|=
name|rs
operator|->
name|sbuf_size
operator|/
name|RS_SNDLOWAT
expr_stmt|;
else|else
name|rs
operator|->
name|sbuf_size
operator|=
name|rs
operator|->
name|sq_size
operator|*
name|RS_SNDLOWAT
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_init_bufs
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|uint32_t
name|total_rbuf_size
decl_stmt|,
name|total_sbuf_size
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|rs
operator|->
name|rmsg
operator|=
name|calloc
argument_list|(
name|rs
operator|->
name|rq_size
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rs
operator|->
name|rmsg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|rmsg
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|total_sbuf_size
operator|=
name|rs
operator|->
name|sbuf_size
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|sq_inline
operator|<
name|RS_MAX_CTRL_MSG
condition|)
name|total_sbuf_size
operator|+=
name|RS_MAX_CTRL_MSG
operator|*
name|RS_QP_CTRL_SIZE
expr_stmt|;
name|rs
operator|->
name|sbuf
operator|=
name|calloc
argument_list|(
name|total_sbuf_size
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|sbuf
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|rs
operator|->
name|smr
operator|=
name|rdma_reg_msgs
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|rs
operator|->
name|sbuf
argument_list|,
name|total_sbuf_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|smr
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|rs
operator|->
name|target_sgl
argument_list|)
operator|*
name|RS_SGL_SIZE
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|rs
operator|->
name|target_iomap
argument_list|)
operator|*
name|rs
operator|->
name|target_iomap_size
expr_stmt|;
name|rs
operator|->
name|target_buffer_list
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|target_buffer_list
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|rs
operator|->
name|target_mr
operator|=
name|rdma_reg_write
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|rs
operator|->
name|target_buffer_list
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|target_mr
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|rs
operator|->
name|target_buffer_list
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|rs
operator|->
name|target_sgl
operator|=
name|rs
operator|->
name|target_buffer_list
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|target_iomap_size
condition|)
name|rs
operator|->
name|target_iomap
operator|=
operator|(
expr|struct
name|rs_iomap
operator|*
operator|)
operator|(
name|rs
operator|->
name|target_sgl
operator|+
name|RS_SGL_SIZE
operator|)
expr_stmt|;
name|total_rbuf_size
operator|=
name|rs
operator|->
name|rbuf_size
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
condition|)
name|total_rbuf_size
operator|+=
name|rs
operator|->
name|rq_size
operator|*
name|RS_MSG_SIZE
expr_stmt|;
name|rs
operator|->
name|rbuf
operator|=
name|calloc
argument_list|(
name|total_rbuf_size
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|rbuf
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|rs
operator|->
name|rmr
operator|=
name|rdma_reg_write
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|rs
operator|->
name|rbuf
argument_list|,
name|total_rbuf_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|rmr
condition|)
return|return
operator|-
literal|1
return|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|sbuf
expr_stmt|;
name|rs
operator|->
name|sbuf_bytes_avail
operator|=
name|rs
operator|->
name|sbuf_size
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|lkey
operator|=
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|lkey
operator|=
name|rs
operator|->
name|smr
operator|->
name|lkey
expr_stmt|;
name|rs
operator|->
name|rbuf_free_offset
operator|=
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
expr_stmt|;
name|rs
operator|->
name|rbuf_bytes_avail
operator|=
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
expr_stmt|;
name|rs
operator|->
name|sqe_avail
operator|=
name|rs
operator|->
name|sq_size
operator|-
name|rs
operator|->
name|ctrl_max_seqno
expr_stmt|;
name|rs
operator|->
name|rseq_comp
operator|=
name|rs
operator|->
name|rq_size
operator|>>
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_init_bufs
parameter_list|(
name|struct
name|ds_qp
modifier|*
name|qp
parameter_list|)
block|{
name|qp
operator|->
name|rbuf
operator|=
name|calloc
argument_list|(
name|qp
operator|->
name|rs
operator|->
name|rbuf_size
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ibv_grh
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qp
operator|->
name|rbuf
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|qp
operator|->
name|smr
operator|=
name|rdma_reg_msgs
argument_list|(
name|qp
operator|->
name|cm_id
argument_list|,
name|qp
operator|->
name|rs
operator|->
name|sbuf
argument_list|,
name|qp
operator|->
name|rs
operator|->
name|sbuf_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qp
operator|->
name|smr
condition|)
return|return
operator|-
literal|1
return|;
name|qp
operator|->
name|rmr
operator|=
name|rdma_reg_msgs
argument_list|(
name|qp
operator|->
name|cm_id
argument_list|,
name|qp
operator|->
name|rbuf
argument_list|,
name|qp
operator|->
name|rs
operator|->
name|rbuf_size
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ibv_grh
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qp
operator|->
name|rmr
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * If a user is waiting on a datagram rsocket through poll or select, then  * we need the first completion to generate an event on the related epoll fd  * in order to signal the user.  We arm the CQ on creation for this purpose  */
end_comment

begin_function
specifier|static
name|int
name|rs_create_cq
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|rdma_cm_id
modifier|*
name|cm_id
parameter_list|)
block|{
name|cm_id
operator|->
name|recv_cq_channel
operator|=
name|ibv_create_comp_channel
argument_list|(
name|cm_id
operator|->
name|verbs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id
operator|->
name|recv_cq_channel
condition|)
return|return
operator|-
literal|1
return|;
name|cm_id
operator|->
name|recv_cq
operator|=
name|ibv_create_cq
argument_list|(
name|cm_id
operator|->
name|verbs
argument_list|,
name|rs
operator|->
name|sq_size
operator|+
name|rs
operator|->
name|rq_size
argument_list|,
name|cm_id
argument_list|,
name|cm_id
operator|->
name|recv_cq_channel
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cm_id
operator|->
name|recv_cq
condition|)
goto|goto
name|err1
goto|;
if|if
condition|(
name|rs
operator|->
name|fd_flags
operator|&
name|O_NONBLOCK
condition|)
block|{
if|if
condition|(
name|fcntl
argument_list|(
name|cm_id
operator|->
name|recv_cq_channel
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
condition|)
goto|goto
name|err2
goto|;
block|}
name|ibv_req_notify_cq
argument_list|(
name|cm_id
operator|->
name|recv_cq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cm_id
operator|->
name|send_cq_channel
operator|=
name|cm_id
operator|->
name|recv_cq_channel
expr_stmt|;
name|cm_id
operator|->
name|send_cq
operator|=
name|cm_id
operator|->
name|recv_cq
expr_stmt|;
return|return
literal|0
return|;
name|err2
label|:
name|ibv_destroy_cq
argument_list|(
name|cm_id
operator|->
name|recv_cq
argument_list|)
expr_stmt|;
name|cm_id
operator|->
name|recv_cq
operator|=
name|NULL
expr_stmt|;
name|err1
label|:
name|ibv_destroy_comp_channel
argument_list|(
name|cm_id
operator|->
name|recv_cq_channel
argument_list|)
expr_stmt|;
name|cm_id
operator|->
name|recv_cq_channel
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|rs_post_recv
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ibv_recv_wr
name|wr
decl_stmt|,
modifier|*
name|bad
decl_stmt|;
name|struct
name|ibv_sge
name|sge
decl_stmt|;
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
operator|)
condition|)
block|{
name|wr
operator|.
name|wr_id
operator|=
name|rs_recv_wr_id
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
name|NULL
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wr
operator|.
name|wr_id
operator|=
name|rs_recv_wr_id
argument_list|(
name|rs
operator|->
name|rbuf_msg_index
argument_list|)
expr_stmt|;
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|rbuf
operator|+
name|rs
operator|->
name|rbuf_size
operator|+
operator|(
name|rs
operator|->
name|rbuf_msg_index
operator|*
name|RS_MSG_SIZE
operator|)
expr_stmt|;
name|sge
operator|.
name|length
operator|=
name|RS_MSG_SIZE
expr_stmt|;
name|sge
operator|.
name|lkey
operator|=
name|rs
operator|->
name|rmr
operator|->
name|lkey
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
operator|&
name|sge
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|++
name|rs
operator|->
name|rbuf_msg_index
operator|==
name|rs
operator|->
name|rq_size
condition|)
name|rs
operator|->
name|rbuf_msg_index
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|rdma_seterrno
argument_list|(
name|ibv_post_recv
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|ds_post_recv
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|ds_qp
modifier|*
name|qp
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|struct
name|ibv_recv_wr
name|wr
decl_stmt|,
modifier|*
name|bad
decl_stmt|;
name|struct
name|ibv_sge
name|sge
index|[
literal|2
index|]
decl_stmt|;
name|sge
index|[
literal|0
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|qp
operator|->
name|rbuf
operator|+
name|rs
operator|->
name|rbuf_size
expr_stmt|;
name|sge
index|[
literal|0
index|]
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ibv_grh
argument_list|)
expr_stmt|;
name|sge
index|[
literal|0
index|]
operator|.
name|lkey
operator|=
name|qp
operator|->
name|rmr
operator|->
name|lkey
expr_stmt|;
name|sge
index|[
literal|1
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|qp
operator|->
name|rbuf
operator|+
name|offset
expr_stmt|;
name|sge
index|[
literal|1
index|]
operator|.
name|length
operator|=
name|RS_SNDLOWAT
expr_stmt|;
name|sge
index|[
literal|1
index|]
operator|.
name|lkey
operator|=
name|qp
operator|->
name|rmr
operator|->
name|lkey
expr_stmt|;
name|wr
operator|.
name|wr_id
operator|=
name|rs_recv_wr_id
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
name|sge
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
literal|2
expr_stmt|;
return|return
name|rdma_seterrno
argument_list|(
name|ibv_post_recv
argument_list|(
name|qp
operator|->
name|cm_id
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_create_ep
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ibv_qp_init_attr
name|qp_attr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|rs_set_qp_size
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|cm_id
operator|->
name|verbs
operator|->
name|device
operator|->
name|transport_type
operator|==
name|IBV_TRANSPORT_IWARP
condition|)
name|rs
operator|->
name|opts
operator||=
name|RS_OPT_MSG_SEND
expr_stmt|;
name|ret
operator|=
name|rs_create_cq
argument_list|(
name|rs
argument_list|,
name|rs
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|memset
argument_list|(
operator|&
name|qp_attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|qp_attr
argument_list|)
expr_stmt|;
name|qp_attr
operator|.
name|qp_context
operator|=
name|rs
expr_stmt|;
name|qp_attr
operator|.
name|send_cq
operator|=
name|rs
operator|->
name|cm_id
operator|->
name|send_cq
expr_stmt|;
name|qp_attr
operator|.
name|recv_cq
operator|=
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq
expr_stmt|;
name|qp_attr
operator|.
name|qp_type
operator|=
name|IBV_QPT_RC
expr_stmt|;
name|qp_attr
operator|.
name|sq_sig_all
operator|=
literal|1
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_send_wr
operator|=
name|rs
operator|->
name|sq_size
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_recv_wr
operator|=
name|rs
operator|->
name|rq_size
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_send_sge
operator|=
literal|2
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_recv_sge
operator|=
literal|1
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_inline_data
operator|=
name|rs
operator|->
name|sq_inline
expr_stmt|;
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|NULL
argument_list|,
operator|&
name|qp_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|rs
operator|->
name|sq_inline
operator|=
name|qp_attr
operator|.
name|cap
operator|.
name|max_inline_data
expr_stmt|;
if|if
condition|(
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
operator|)
operator|&&
operator|(
name|rs
operator|->
name|sq_inline
operator|<
name|RS_MSG_SIZE
operator|)
condition|)
return|return
name|ERR
argument_list|(
name|ENOTSUP
argument_list|)
return|;
name|ret
operator|=
name|rs_init_bufs
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|rq_size
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|rs_post_recv
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_release_iomap_mr
parameter_list|(
name|struct
name|rs_iomap_mr
modifier|*
name|iomr
parameter_list|)
block|{
if|if
condition|(
name|atomic_fetch_sub
argument_list|(
operator|&
name|iomr
operator|->
name|refcnt
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
return|return;
name|dlist_remove
argument_list|(
operator|&
name|iomr
operator|->
name|entry
argument_list|)
expr_stmt|;
name|ibv_dereg_mr
argument_list|(
name|iomr
operator|->
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|iomr
operator|->
name|index
operator|>=
literal|0
condition|)
name|iomr
operator|->
name|mr
operator|=
name|NULL
expr_stmt|;
else|else
name|free
argument_list|(
name|iomr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_free_iomappings
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|rs_iomap_mr
modifier|*
name|iomr
decl_stmt|;
while|while
condition|(
operator|!
name|dlist_empty
argument_list|(
operator|&
name|rs
operator|->
name|iomap_list
argument_list|)
condition|)
block|{
name|iomr
operator|=
name|container_of
argument_list|(
name|rs
operator|->
name|iomap_list
operator|.
name|next
argument_list|,
expr|struct
name|rs_iomap_mr
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|riounmap
argument_list|(
name|rs
operator|->
name|index
argument_list|,
name|iomr
operator|->
name|mr
operator|->
name|addr
argument_list|,
name|iomr
operator|->
name|mr
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|!
name|dlist_empty
argument_list|(
operator|&
name|rs
operator|->
name|iomap_queue
argument_list|)
condition|)
block|{
name|iomr
operator|=
name|container_of
argument_list|(
name|rs
operator|->
name|iomap_queue
operator|.
name|next
argument_list|,
expr|struct
name|rs_iomap_mr
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|riounmap
argument_list|(
name|rs
operator|->
name|index
argument_list|,
name|iomr
operator|->
name|mr
operator|->
name|addr
argument_list|,
name|iomr
operator|->
name|mr
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ds_free_qp
parameter_list|(
name|struct
name|ds_qp
modifier|*
name|qp
parameter_list|)
block|{
if|if
condition|(
name|qp
operator|->
name|smr
condition|)
name|rdma_dereg_mr
argument_list|(
name|qp
operator|->
name|smr
argument_list|)
expr_stmt|;
if|if
condition|(
name|qp
operator|->
name|rbuf
condition|)
block|{
if|if
condition|(
name|qp
operator|->
name|rmr
condition|)
name|rdma_dereg_mr
argument_list|(
name|qp
operator|->
name|rmr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|qp
operator|->
name|rbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|qp
operator|->
name|cm_id
condition|)
block|{
if|if
condition|(
name|qp
operator|->
name|cm_id
operator|->
name|qp
condition|)
block|{
name|tdelete
argument_list|(
operator|&
name|qp
operator|->
name|dest
operator|.
name|addr
argument_list|,
operator|&
name|qp
operator|->
name|rs
operator|->
name|dest_map
argument_list|,
name|ds_compare_addr
argument_list|)
expr_stmt|;
name|epoll_ctl
argument_list|(
name|qp
operator|->
name|rs
operator|->
name|epfd
argument_list|,
name|EPOLL_CTL_DEL
argument_list|,
name|qp
operator|->
name|cm_id
operator|->
name|recv_cq_channel
operator|->
name|fd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rdma_destroy_qp
argument_list|(
name|qp
operator|->
name|cm_id
argument_list|)
expr_stmt|;
block|}
name|rdma_destroy_id
argument_list|(
name|qp
operator|->
name|cm_id
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|qp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_free
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ds_qp
modifier|*
name|qp
decl_stmt|;
if|if
condition|(
name|rs
operator|->
name|udp_sock
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|rs
operator|->
name|udp_sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|index
operator|>=
literal|0
condition|)
name|rs_remove
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|dmsg
condition|)
name|free
argument_list|(
name|rs
operator|->
name|dmsg
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|qp
operator|=
name|rs
operator|->
name|qp_list
operator|)
condition|)
block|{
name|ds_remove_qp
argument_list|(
name|rs
argument_list|,
name|qp
argument_list|)
expr_stmt|;
name|ds_free_qp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rs
operator|->
name|epfd
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|rs
operator|->
name|epfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|sbuf
condition|)
name|free
argument_list|(
name|rs
operator|->
name|sbuf
argument_list|)
expr_stmt|;
name|tdestroy
argument_list|(
name|rs
operator|->
name|dest_map
argument_list|,
name|free
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|cq_wait_lock
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|rlock
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_free
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|ds_free
argument_list|(
name|rs
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rs
operator|->
name|rmsg
condition|)
name|free
argument_list|(
name|rs
operator|->
name|rmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|sbuf
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|smr
condition|)
name|rdma_dereg_mr
argument_list|(
name|rs
operator|->
name|smr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rs
operator|->
name|sbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rs
operator|->
name|rbuf
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|rmr
condition|)
name|rdma_dereg_mr
argument_list|(
name|rs
operator|->
name|rmr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rs
operator|->
name|rbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rs
operator|->
name|target_buffer_list
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|target_mr
condition|)
name|rdma_dereg_mr
argument_list|(
name|rs
operator|->
name|target_mr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rs
operator|->
name|target_buffer_list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rs
operator|->
name|cm_id
condition|)
block|{
name|rs_free_iomappings
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|cm_id
operator|->
name|qp
condition|)
block|{
name|ibv_ack_cq_events
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq
argument_list|,
name|rs
operator|->
name|unack_cqe
argument_list|)
expr_stmt|;
name|rdma_destroy_qp
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
expr_stmt|;
block|}
name|rdma_destroy_id
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rs
operator|->
name|index
operator|>=
literal|0
condition|)
name|rs_remove
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|cq_wait_lock
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|rlock
argument_list|)
expr_stmt|;
name|fastlock_destroy
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|rs_conn_data_offset
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
operator|(
name|rs
operator|->
name|cm_id
operator|->
name|route
operator|.
name|addr
operator|.
name|src_addr
operator|.
name|sa_family
operator|==
name|AF_IB
operator|)
condition|?
sizeof|sizeof
argument_list|(
expr|struct
name|ib_connect_hdr
argument_list|)
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_format_conn_data
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|rs_conn_data
modifier|*
name|conn
parameter_list|)
block|{
name|conn
operator|->
name|version
operator|=
literal|1
expr_stmt|;
name|conn
operator|->
name|flags
operator|=
name|RS_CONN_FLAG_IOMAP
operator||
operator|(
name|rs_host_is_net
argument_list|()
condition|?
name|RS_CONN_FLAG_NET
else|:
literal|0
operator|)
expr_stmt|;
name|conn
operator|->
name|credits
operator|=
name|htobe16
argument_list|(
name|rs
operator|->
name|rq_size
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|conn
operator|->
name|reserved
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|conn
operator|->
name|reserved
argument_list|)
expr_stmt|;
name|conn
operator|->
name|target_iomap_size
operator|=
operator|(
name|uint8_t
operator|)
name|rs_value_to_scale
argument_list|(
name|rs
operator|->
name|target_iomap_size
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|conn
operator|->
name|target_sgl
operator|.
name|addr
operator|=
operator|(
name|__force
name|uint64_t
operator|)
name|htobe64
argument_list|(
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|target_sgl
argument_list|)
expr_stmt|;
name|conn
operator|->
name|target_sgl
operator|.
name|length
operator|=
operator|(
name|__force
name|uint32_t
operator|)
name|htobe32
argument_list|(
name|RS_SGL_SIZE
argument_list|)
expr_stmt|;
name|conn
operator|->
name|target_sgl
operator|.
name|key
operator|=
operator|(
name|__force
name|uint32_t
operator|)
name|htobe32
argument_list|(
name|rs
operator|->
name|target_mr
operator|->
name|rkey
argument_list|)
expr_stmt|;
name|conn
operator|->
name|data_buf
operator|.
name|addr
operator|=
operator|(
name|__force
name|uint64_t
operator|)
name|htobe64
argument_list|(
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|rbuf
argument_list|)
expr_stmt|;
name|conn
operator|->
name|data_buf
operator|.
name|length
operator|=
operator|(
name|__force
name|uint32_t
operator|)
name|htobe32
argument_list|(
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|conn
operator|->
name|data_buf
operator|.
name|key
operator|=
operator|(
name|__force
name|uint32_t
operator|)
name|htobe32
argument_list|(
name|rs
operator|->
name|rmr
operator|->
name|rkey
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_save_conn_data
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|rs_conn_data
modifier|*
name|conn
parameter_list|)
block|{
name|rs
operator|->
name|remote_sgl
operator|.
name|addr
operator|=
name|be64toh
argument_list|(
operator|(
name|__force
name|__be64
operator|)
name|conn
operator|->
name|target_sgl
operator|.
name|addr
argument_list|)
expr_stmt|;
name|rs
operator|->
name|remote_sgl
operator|.
name|length
operator|=
name|be32toh
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|conn
operator|->
name|target_sgl
operator|.
name|length
argument_list|)
expr_stmt|;
name|rs
operator|->
name|remote_sgl
operator|.
name|key
operator|=
name|be32toh
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|conn
operator|->
name|target_sgl
operator|.
name|key
argument_list|)
expr_stmt|;
name|rs
operator|->
name|remote_sge
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|rs_host_is_net
argument_list|()
operator|&&
operator|!
operator|(
name|conn
operator|->
name|flags
operator|&
name|RS_CONN_FLAG_NET
operator|)
operator|)
operator|||
operator|(
operator|!
name|rs_host_is_net
argument_list|()
operator|&&
operator|(
name|conn
operator|->
name|flags
operator|&
name|RS_CONN_FLAG_NET
operator|)
operator|)
condition|)
name|rs
operator|->
name|opts
operator|=
name|RS_OPT_SWAP_SGL
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|flags
operator|&
name|RS_CONN_FLAG_IOMAP
condition|)
block|{
name|rs
operator|->
name|remote_iomap
operator|.
name|addr
operator|=
name|rs
operator|->
name|remote_sgl
operator|.
name|addr
operator|+
sizeof|sizeof
argument_list|(
name|rs
operator|->
name|remote_sgl
argument_list|)
operator|*
name|rs
operator|->
name|remote_sgl
operator|.
name|length
expr_stmt|;
name|rs
operator|->
name|remote_iomap
operator|.
name|length
operator|=
name|rs_scale_to_value
argument_list|(
name|conn
operator|->
name|target_iomap_size
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|rs
operator|->
name|remote_iomap
operator|.
name|key
operator|=
name|rs
operator|->
name|remote_sgl
operator|.
name|key
expr_stmt|;
block|}
name|rs
operator|->
name|target_sgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
name|be64toh
argument_list|(
operator|(
name|__force
name|__be64
operator|)
name|conn
operator|->
name|data_buf
operator|.
name|addr
argument_list|)
expr_stmt|;
name|rs
operator|->
name|target_sgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|be32toh
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|conn
operator|->
name|data_buf
operator|.
name|length
argument_list|)
expr_stmt|;
name|rs
operator|->
name|target_sgl
index|[
literal|0
index|]
operator|.
name|key
operator|=
name|be32toh
argument_list|(
operator|(
name|__force
name|__be32
operator|)
name|conn
operator|->
name|data_buf
operator|.
name|key
argument_list|)
expr_stmt|;
name|rs
operator|->
name|sseq_comp
operator|=
name|be16toh
argument_list|(
name|conn
operator|->
name|credits
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_init
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|domain
parameter_list|)
block|{
name|rs
operator|->
name|udp_sock
operator|=
name|socket
argument_list|(
name|domain
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|udp_sock
operator|<
literal|0
condition|)
return|return
name|rs
operator|->
name|udp_sock
return|;
name|rs
operator|->
name|epfd
operator|=
name|epoll_create
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|epfd
operator|<
literal|0
condition|)
return|return
name|rs
operator|->
name|epfd
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_init_ep
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ds_smsg
modifier|*
name|msg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|ds_set_qp_size
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|rs
operator|->
name|sbuf
operator|=
name|calloc
argument_list|(
name|rs
operator|->
name|sq_size
argument_list|,
name|RS_SNDLOWAT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|sbuf
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|rs
operator|->
name|dmsg
operator|=
name|calloc
argument_list|(
name|rs
operator|->
name|rq_size
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rs
operator|->
name|dmsg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|dmsg
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|rs
operator|->
name|sqe_avail
operator|=
name|rs
operator|->
name|sq_size
expr_stmt|;
name|rs
operator|->
name|rqe_avail
operator|=
name|rs
operator|->
name|rq_size
expr_stmt|;
name|rs
operator|->
name|smsg_free
operator|=
operator|(
expr|struct
name|ds_smsg
operator|*
operator|)
name|rs
operator|->
name|sbuf
expr_stmt|;
name|msg
operator|=
name|rs
operator|->
name|smsg_free
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|sq_size
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|msg
operator|->
name|next
operator|=
operator|(
name|void
operator|*
operator|)
name|msg
operator|+
name|RS_SNDLOWAT
expr_stmt|;
name|msg
operator|=
name|msg
operator|->
name|next
expr_stmt|;
block|}
name|msg
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|rs_notify_svc
argument_list|(
operator|&
name|udp_svc
argument_list|,
name|rs
argument_list|,
name|RS_SVC_ADD_DGRAM
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|rs
operator|->
name|state
operator|=
name|rs_readable
operator||
name|rs_writable
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rsocket
parameter_list|(
name|int
name|domain
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|protocol
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|index
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|domain
operator|!=
name|AF_INET
operator|&&
name|domain
operator|!=
name|AF_INET6
operator|&&
name|domain
operator|!=
name|AF_IB
operator|)
operator|||
operator|(
operator|(
name|type
operator|!=
name|SOCK_STREAM
operator|)
operator|&&
operator|(
name|type
operator|!=
name|SOCK_DGRAM
operator|)
operator|)
operator|||
operator|(
name|type
operator|==
name|SOCK_STREAM
operator|&&
name|protocol
operator|&&
name|protocol
operator|!=
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|type
operator|==
name|SOCK_DGRAM
operator|&&
name|protocol
operator|&&
name|protocol
operator|!=
name|IPPROTO_UDP
operator|)
condition|)
return|return
name|ERR
argument_list|(
name|ENOTSUP
argument_list|)
return|;
name|rs_configure
argument_list|()
expr_stmt|;
name|rs
operator|=
name|rs_alloc
argument_list|(
name|NULL
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
if|if
condition|(
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|ret
operator|=
name|rdma_create_id
argument_list|(
name|NULL
argument_list|,
operator|&
name|rs
operator|->
name|cm_id
argument_list|,
name|rs
argument_list|,
name|RDMA_PS_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|rs
operator|->
name|cm_id
operator|->
name|route
operator|.
name|addr
operator|.
name|src_addr
operator|.
name|sa_family
operator|=
name|domain
expr_stmt|;
name|index
operator|=
name|rs
operator|->
name|cm_id
operator|->
name|channel
operator|->
name|fd
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|ds_init
argument_list|(
name|rs
argument_list|,
name|domain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|index
operator|=
name|rs
operator|->
name|udp_sock
expr_stmt|;
block|}
name|ret
operator|=
name|rs_insert
argument_list|(
name|rs
argument_list|,
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
return|return
name|rs
operator|->
name|index
return|;
name|err
label|:
name|rs_free
argument_list|(
name|rs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|rbind
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|ret
operator|=
name|rdma_bind_addr
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|rs
operator|->
name|state
operator|=
name|rs_bound
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rs
operator|->
name|state
operator|==
name|rs_init
condition|)
block|{
name|ret
operator|=
name|ds_init_ep
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|bind
argument_list|(
name|rs
operator|->
name|udp_sock
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|rlisten
parameter_list|(
name|int
name|socket
parameter_list|,
name|int
name|backlog
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
if|if
condition|(
name|rs
operator|->
name|state
operator|!=
name|rs_listening
condition|)
block|{
name|ret
operator|=
name|rdma_listen
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|backlog
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|rs
operator|->
name|state
operator|=
name|rs_listening
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Nonblocking is usually not inherited between sockets, but we need to  * inherit it here to establish the connection only.  This is needed to  * prevent rdma_accept from blocking until the remote side finishes  * establishing the connection.  If we were to allow rdma_accept to block,  * then a single thread cannot establish a connection with itself, or  * two threads which try to connect to each other can deadlock trying to  * form a connection.  *  * Data transfers on the new socket remain blocking unless the user  * specifies otherwise through rfcntl.  */
end_comment

begin_function
name|int
name|raccept
parameter_list|(
name|int
name|socket
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
modifier|*
name|addrlen
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|,
modifier|*
name|new_rs
decl_stmt|;
name|struct
name|rdma_conn_param
name|param
decl_stmt|;
name|struct
name|rs_conn_data
modifier|*
name|creq
decl_stmt|,
name|cresp
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
name|new_rs
operator|=
name|rs_alloc
argument_list|(
name|rs
argument_list|,
name|rs
operator|->
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_rs
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|ret
operator|=
name|rdma_get_request
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
operator|&
name|new_rs
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|rs_insert
argument_list|(
name|new_rs
argument_list|,
name|new_rs
operator|->
name|cm_id
operator|->
name|channel
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
name|creq
operator|=
operator|(
expr|struct
name|rs_conn_data
operator|*
operator|)
operator|(
name|new_rs
operator|->
name|cm_id
operator|->
name|event
operator|->
name|param
operator|.
name|conn
operator|.
name|private_data
operator|+
name|rs_conn_data_offset
argument_list|(
name|rs
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|creq
operator|->
name|version
operator|!=
literal|1
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|ENOTSUP
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|rs
operator|->
name|fd_flags
operator|&
name|O_NONBLOCK
condition|)
name|fcntl
argument_list|(
name|new_rs
operator|->
name|cm_id
operator|->
name|channel
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rs_create_ep
argument_list|(
name|new_rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|rs_save_conn_data
argument_list|(
name|new_rs
argument_list|,
name|creq
argument_list|)
expr_stmt|;
name|param
operator|=
name|new_rs
operator|->
name|cm_id
operator|->
name|event
operator|->
name|param
operator|.
name|conn
expr_stmt|;
name|rs_format_conn_data
argument_list|(
name|new_rs
argument_list|,
operator|&
name|cresp
argument_list|)
expr_stmt|;
name|param
operator|.
name|private_data
operator|=
operator|&
name|cresp
expr_stmt|;
name|param
operator|.
name|private_data_len
operator|=
sizeof|sizeof
name|cresp
expr_stmt|;
name|ret
operator|=
name|rdma_accept
argument_list|(
name|new_rs
operator|->
name|cm_id
argument_list|,
operator|&
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|new_rs
operator|->
name|state
operator|=
name|rs_connect_rdwr
expr_stmt|;
elseif|else
if|if
condition|(
name|errno
operator|==
name|EAGAIN
operator|||
name|errno
operator|==
name|EWOULDBLOCK
condition|)
name|new_rs
operator|->
name|state
operator|=
name|rs_accepting
expr_stmt|;
else|else
goto|goto
name|err
goto|;
if|if
condition|(
name|addr
operator|&&
name|addrlen
condition|)
name|rgetpeername
argument_list|(
name|new_rs
operator|->
name|index
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
return|return
name|new_rs
operator|->
name|index
return|;
name|err
label|:
name|rs_free
argument_list|(
name|new_rs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_do_connect
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|rdma_conn_param
name|param
decl_stmt|;
name|struct
name|rs_conn_private_data
name|cdata
decl_stmt|;
name|struct
name|rs_conn_data
modifier|*
name|creq
decl_stmt|,
modifier|*
name|cresp
decl_stmt|;
name|int
name|to
decl_stmt|,
name|ret
decl_stmt|;
switch|switch
condition|(
name|rs
operator|->
name|state
condition|)
block|{
case|case
name|rs_init
case|:
case|case
name|rs_bound
case|:
name|resolve_addr
label|:
name|to
operator|=
literal|1000
operator|<<
name|rs
operator|->
name|retries
operator|++
expr_stmt|;
name|ret
operator|=
name|rdma_resolve_addr
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|NULL
argument_list|,
operator|&
name|rs
operator|->
name|cm_id
operator|->
name|route
operator|.
name|addr
operator|.
name|dst_addr
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
goto|goto
name|resolve_route
goto|;
if|if
condition|(
name|errno
operator|==
name|EAGAIN
operator|||
name|errno
operator|==
name|EWOULDBLOCK
condition|)
name|rs
operator|->
name|state
operator|=
name|rs_resolving_addr
expr_stmt|;
break|break;
case|case
name|rs_resolving_addr
case|:
name|ret
operator|=
name|ucma_complete
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ETIMEDOUT
operator|&&
name|rs
operator|->
name|retries
operator|<=
name|RS_CONN_RETRIES
condition|)
goto|goto
name|resolve_addr
goto|;
break|break;
block|}
name|rs
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|resolve_route
label|:
name|to
operator|=
literal|1000
operator|<<
name|rs
operator|->
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|optval
condition|)
block|{
name|ret
operator|=
name|rdma_set_option
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|RDMA_OPTION_IB
argument_list|,
name|RDMA_OPTION_IB_PATH
argument_list|,
name|rs
operator|->
name|optval
argument_list|,
name|rs
operator|->
name|optlen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rs
operator|->
name|optval
argument_list|)
expr_stmt|;
name|rs
operator|->
name|optval
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|rs
operator|->
name|state
operator|=
name|rs_resolving_route
expr_stmt|;
goto|goto
name|resolving_route
goto|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|rdma_resolve_route
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
goto|goto
name|do_connect
goto|;
block|}
if|if
condition|(
name|errno
operator|==
name|EAGAIN
operator|||
name|errno
operator|==
name|EWOULDBLOCK
condition|)
name|rs
operator|->
name|state
operator|=
name|rs_resolving_route
expr_stmt|;
break|break;
case|case
name|rs_resolving_route
case|:
name|resolving_route
label|:
name|ret
operator|=
name|ucma_complete
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ETIMEDOUT
operator|&&
name|rs
operator|->
name|retries
operator|<=
name|RS_CONN_RETRIES
condition|)
goto|goto
name|resolve_route
goto|;
break|break;
block|}
name|do_connect
label|:
name|ret
operator|=
name|rs_create_ep
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
name|memset
argument_list|(
operator|&
name|param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|param
argument_list|)
expr_stmt|;
name|creq
operator|=
operator|(
name|void
operator|*
operator|)
operator|&
name|cdata
operator|+
name|rs_conn_data_offset
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|rs_format_conn_data
argument_list|(
name|rs
argument_list|,
name|creq
argument_list|)
expr_stmt|;
name|param
operator|.
name|private_data
operator|=
operator|(
name|void
operator|*
operator|)
name|creq
operator|-
name|rs_conn_data_offset
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|param
operator|.
name|private_data_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|creq
argument_list|)
operator|+
name|rs_conn_data_offset
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|param
operator|.
name|flow_control
operator|=
literal|1
expr_stmt|;
name|param
operator|.
name|retry_count
operator|=
literal|7
expr_stmt|;
name|param
operator|.
name|rnr_retry_count
operator|=
literal|7
expr_stmt|;
comment|/* work-around: iWarp issues RDMA read during connection */
if|if
condition|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
condition|)
name|param
operator|.
name|initiator_depth
operator|=
literal|1
expr_stmt|;
name|rs
operator|->
name|retries
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|rdma_connect
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
operator|&
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
goto|goto
name|connected
goto|;
if|if
condition|(
name|errno
operator|==
name|EAGAIN
operator|||
name|errno
operator|==
name|EWOULDBLOCK
condition|)
name|rs
operator|->
name|state
operator|=
name|rs_connecting
expr_stmt|;
break|break;
case|case
name|rs_connecting
case|:
name|ret
operator|=
name|ucma_complete
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
name|connected
label|:
name|cresp
operator|=
operator|(
expr|struct
name|rs_conn_data
operator|*
operator|)
name|rs
operator|->
name|cm_id
operator|->
name|event
operator|->
name|param
operator|.
name|conn
operator|.
name|private_data
expr_stmt|;
if|if
condition|(
name|cresp
operator|->
name|version
operator|!=
literal|1
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|ENOTSUP
argument_list|)
expr_stmt|;
break|break;
block|}
name|rs_save_conn_data
argument_list|(
name|rs
argument_list|,
name|cresp
argument_list|)
expr_stmt|;
name|rs
operator|->
name|state
operator|=
name|rs_connect_rdwr
expr_stmt|;
break|break;
case|case
name|rs_accepting
case|:
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|fd_flags
operator|&
name|O_NONBLOCK
operator|)
condition|)
name|fcntl
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|channel
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ucma_complete
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
name|rs
operator|->
name|state
operator|=
name|rs_connect_rdwr
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|ERR
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EAGAIN
operator|||
name|errno
operator|==
name|EWOULDBLOCK
condition|)
block|{
name|errno
operator|=
name|EINPROGRESS
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|state
operator|=
name|rs_connect_error
expr_stmt|;
name|rs
operator|->
name|err
operator|=
name|errno
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_any_addr
parameter_list|(
specifier|const
name|union
name|socket_addr
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|->
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
return|return
operator|(
name|addr
operator|->
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|==
name|htobe32
argument_list|(
name|INADDR_ANY
argument_list|)
operator|||
name|addr
operator|->
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|==
name|htobe32
argument_list|(
name|INADDR_LOOPBACK
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
operator|!
name|memcmp
argument_list|(
operator|&
name|addr
operator|->
name|sin6
operator|.
name|sin6_addr
argument_list|,
operator|&
name|in6addr_any
argument_list|,
literal|16
argument_list|)
operator|||
operator|!
name|memcmp
argument_list|(
operator|&
name|addr
operator|->
name|sin6
operator|.
name|sin6_addr
argument_list|,
operator|&
name|in6addr_loopback
argument_list|,
literal|16
argument_list|)
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ds_get_src_addr
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|dest_addr
parameter_list|,
name|socklen_t
name|dest_len
parameter_list|,
name|union
name|socket_addr
modifier|*
name|src_addr
parameter_list|,
name|socklen_t
modifier|*
name|src_len
parameter_list|)
block|{
name|int
name|sock
decl_stmt|,
name|ret
decl_stmt|;
name|__be16
name|port
decl_stmt|;
operator|*
name|src_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|src_addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|getsockname
argument_list|(
name|rs
operator|->
name|udp_sock
argument_list|,
operator|&
name|src_addr
operator|->
name|sa
argument_list|,
name|src_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|||
operator|!
name|rs_any_addr
argument_list|(
name|src_addr
argument_list|)
condition|)
return|return
name|ret
return|;
name|port
operator|=
name|src_addr
operator|->
name|sin
operator|.
name|sin_port
expr_stmt|;
name|sock
operator|=
name|socket
argument_list|(
name|dest_addr
operator|->
name|sa_family
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sock
operator|<
literal|0
condition|)
return|return
name|sock
return|;
name|ret
operator|=
name|connect
argument_list|(
name|sock
argument_list|,
name|dest_addr
argument_list|,
name|dest_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
operator|*
name|src_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|src_addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|getsockname
argument_list|(
name|sock
argument_list|,
operator|&
name|src_addr
operator|->
name|sa
argument_list|,
name|src_len
argument_list|)
expr_stmt|;
name|src_addr
operator|->
name|sin
operator|.
name|sin_port
operator|=
name|port
expr_stmt|;
name|out
label|:
name|close
argument_list|(
name|sock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_format_hdr
parameter_list|(
name|struct
name|ds_header
modifier|*
name|hdr
parameter_list|,
name|union
name|socket_addr
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|->
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|hdr
operator|->
name|version
operator|=
literal|4
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|DS_IPV4_HDR_LEN
expr_stmt|;
name|hdr
operator|->
name|port
operator|=
name|addr
operator|->
name|sin
operator|.
name|sin_port
expr_stmt|;
name|hdr
operator|->
name|addr
operator|.
name|ipv4
operator|=
name|addr
operator|->
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
block|}
else|else
block|{
name|hdr
operator|->
name|version
operator|=
literal|6
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|DS_IPV6_HDR_LEN
expr_stmt|;
name|hdr
operator|->
name|port
operator|=
name|addr
operator|->
name|sin6
operator|.
name|sin6_port
expr_stmt|;
name|hdr
operator|->
name|addr
operator|.
name|ipv6
operator|.
name|flowinfo
operator|=
name|addr
operator|->
name|sin6
operator|.
name|sin6_flowinfo
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|hdr
operator|->
name|addr
operator|.
name|ipv6
operator|.
name|addr
argument_list|,
operator|&
name|addr
operator|->
name|sin6
operator|.
name|sin6_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ds_add_qp_dest
parameter_list|(
name|struct
name|ds_qp
modifier|*
name|qp
parameter_list|,
name|union
name|socket_addr
modifier|*
name|addr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|)
block|{
name|struct
name|ibv_port_attr
name|port_attr
decl_stmt|;
name|struct
name|ibv_ah_attr
name|attr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|qp
operator|->
name|dest
operator|.
name|addr
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
name|qp
operator|->
name|dest
operator|.
name|qp
operator|=
name|qp
expr_stmt|;
name|qp
operator|->
name|dest
operator|.
name|qpn
operator|=
name|qp
operator|->
name|cm_id
operator|->
name|qp
operator|->
name|qp_num
expr_stmt|;
name|ret
operator|=
name|ibv_query_port
argument_list|(
name|qp
operator|->
name|cm_id
operator|->
name|verbs
argument_list|,
name|qp
operator|->
name|cm_id
operator|->
name|port_num
argument_list|,
operator|&
name|port_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|memset
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|attr
argument_list|)
expr_stmt|;
name|attr
operator|.
name|dlid
operator|=
name|port_attr
operator|.
name|lid
expr_stmt|;
name|attr
operator|.
name|port_num
operator|=
name|qp
operator|->
name|cm_id
operator|->
name|port_num
expr_stmt|;
name|qp
operator|->
name|dest
operator|.
name|ah
operator|=
name|ibv_create_ah
argument_list|(
name|qp
operator|->
name|cm_id
operator|->
name|pd
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qp
operator|->
name|dest
operator|.
name|ah
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|tsearch
argument_list|(
operator|&
name|qp
operator|->
name|dest
operator|.
name|addr
argument_list|,
operator|&
name|qp
operator|->
name|rs
operator|->
name|dest_map
argument_list|,
name|ds_compare_addr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_create_qp
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|union
name|socket_addr
modifier|*
name|src_addr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|,
name|struct
name|ds_qp
modifier|*
modifier|*
name|new_qp
parameter_list|)
block|{
name|struct
name|ds_qp
modifier|*
name|qp
decl_stmt|;
name|struct
name|ibv_qp_init_attr
name|qp_attr
decl_stmt|;
name|struct
name|epoll_event
name|event
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|qp
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|qp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qp
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|qp
operator|->
name|rs
operator|=
name|rs
expr_stmt|;
name|ret
operator|=
name|rdma_create_id
argument_list|(
name|NULL
argument_list|,
operator|&
name|qp
operator|->
name|cm_id
argument_list|,
name|qp
argument_list|,
name|RDMA_PS_UDP
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|ds_format_hdr
argument_list|(
operator|&
name|qp
operator|->
name|hdr
argument_list|,
name|src_addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_bind_addr
argument_list|(
name|qp
operator|->
name|cm_id
argument_list|,
operator|&
name|src_addr
operator|->
name|sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|ds_init_bufs
argument_list|(
name|qp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|rs_create_cq
argument_list|(
name|rs
argument_list|,
name|qp
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|memset
argument_list|(
operator|&
name|qp_attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|qp_attr
argument_list|)
expr_stmt|;
name|qp_attr
operator|.
name|qp_context
operator|=
name|qp
expr_stmt|;
name|qp_attr
operator|.
name|send_cq
operator|=
name|qp
operator|->
name|cm_id
operator|->
name|send_cq
expr_stmt|;
name|qp_attr
operator|.
name|recv_cq
operator|=
name|qp
operator|->
name|cm_id
operator|->
name|recv_cq
expr_stmt|;
name|qp_attr
operator|.
name|qp_type
operator|=
name|IBV_QPT_UD
expr_stmt|;
name|qp_attr
operator|.
name|sq_sig_all
operator|=
literal|1
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_send_wr
operator|=
name|rs
operator|->
name|sq_size
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_recv_wr
operator|=
name|rs
operator|->
name|rq_size
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_send_sge
operator|=
literal|1
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_recv_sge
operator|=
literal|2
expr_stmt|;
name|qp_attr
operator|.
name|cap
operator|.
name|max_inline_data
operator|=
name|rs
operator|->
name|sq_inline
expr_stmt|;
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|qp
operator|->
name|cm_id
argument_list|,
name|NULL
argument_list|,
operator|&
name|qp_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|rs
operator|->
name|sq_inline
operator|=
name|qp_attr
operator|.
name|cap
operator|.
name|max_inline_data
expr_stmt|;
name|ret
operator|=
name|ds_add_qp_dest
argument_list|(
name|qp
argument_list|,
name|src_addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|event
operator|.
name|events
operator|=
name|EPOLLIN
expr_stmt|;
name|event
operator|.
name|data
operator|.
name|ptr
operator|=
name|qp
expr_stmt|;
name|ret
operator|=
name|epoll_ctl
argument_list|(
name|rs
operator|->
name|epfd
argument_list|,
name|EPOLL_CTL_ADD
argument_list|,
name|qp
operator|->
name|cm_id
operator|->
name|recv_cq_channel
operator|->
name|fd
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|rq_size
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|ds_post_recv
argument_list|(
name|rs
argument_list|,
name|qp
argument_list|,
name|i
operator|*
name|RS_SNDLOWAT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
block|}
name|ds_insert_qp
argument_list|(
name|rs
argument_list|,
name|qp
argument_list|)
expr_stmt|;
operator|*
name|new_qp
operator|=
name|qp
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
name|ds_free_qp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_get_qp
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|union
name|socket_addr
modifier|*
name|src_addr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|,
name|struct
name|ds_qp
modifier|*
modifier|*
name|qp
parameter_list|)
block|{
if|if
condition|(
name|rs
operator|->
name|qp_list
condition|)
block|{
operator|*
name|qp
operator|=
name|rs
operator|->
name|qp_list
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|!
name|ds_compare_addr
argument_list|(
name|rdma_get_local_addr
argument_list|(
operator|(
operator|*
name|qp
operator|)
operator|->
name|cm_id
argument_list|)
argument_list|,
name|src_addr
argument_list|)
condition|)
return|return
literal|0
return|;
operator|*
name|qp
operator|=
name|ds_next_qp
argument_list|(
operator|*
name|qp
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|*
name|qp
operator|!=
name|rs
operator|->
name|qp_list
condition|)
do|;
block|}
return|return
name|ds_create_qp
argument_list|(
name|rs
argument_list|,
name|src_addr
argument_list|,
name|addrlen
argument_list|,
name|qp
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_get_dest
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|,
name|struct
name|ds_dest
modifier|*
modifier|*
name|dest
parameter_list|)
block|{
name|union
name|socket_addr
name|src_addr
decl_stmt|;
name|socklen_t
name|src_len
decl_stmt|;
name|struct
name|ds_qp
modifier|*
name|qp
decl_stmt|;
name|struct
name|ds_dest
modifier|*
modifier|*
name|tdest
decl_stmt|,
modifier|*
name|new_dest
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
name|tdest
operator|=
name|tfind
argument_list|(
name|addr
argument_list|,
operator|&
name|rs
operator|->
name|dest_map
argument_list|,
name|ds_compare_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|tdest
condition|)
goto|goto
name|found
goto|;
name|ret
operator|=
name|ds_get_src_addr
argument_list|(
name|rs
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|,
operator|&
name|src_addr
argument_list|,
operator|&
name|src_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|ds_get_qp
argument_list|(
name|rs
argument_list|,
operator|&
name|src_addr
argument_list|,
name|src_len
argument_list|,
operator|&
name|qp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|tdest
operator|=
name|tfind
argument_list|(
name|addr
argument_list|,
operator|&
name|rs
operator|->
name|dest_map
argument_list|,
name|ds_compare_addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tdest
condition|)
block|{
name|new_dest
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|new_dest
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_dest
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memcpy
argument_list|(
operator|&
name|new_dest
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
name|new_dest
operator|->
name|qp
operator|=
name|qp
expr_stmt|;
name|tdest
operator|=
name|tsearch
argument_list|(
operator|&
name|new_dest
operator|->
name|addr
argument_list|,
operator|&
name|rs
operator|->
name|dest_map
argument_list|,
name|ds_compare_addr
argument_list|)
expr_stmt|;
block|}
name|found
label|:
operator|*
name|dest
operator|=
operator|*
name|tdest
expr_stmt|;
name|out
label|:
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|rconnect
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|rs
operator|->
name|cm_id
operator|->
name|route
operator|.
name|addr
operator|.
name|dst_addr
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rs_do_connect
argument_list|(
name|rs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rs
operator|->
name|state
operator|==
name|rs_init
condition|)
block|{
name|ret
operator|=
name|ds_init_ep
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|connect
argument_list|(
name|rs
operator|->
name|udp_sock
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|ret
operator|=
name|ds_get_dest
argument_list|(
name|rs
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|,
operator|&
name|rs
operator|->
name|conn_dest
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|rs_get_ctrl_buf
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
name|rs
operator|->
name|sbuf
operator|+
name|rs
operator|->
name|sbuf_size
operator|+
name|RS_MAX_CTRL_MSG
operator|*
operator|(
name|rs
operator|->
name|ctrl_seqno
operator|&
operator|(
name|RS_QP_CTRL_SIZE
operator|-
literal|1
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_post_msg
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|uint32_t
name|msg
parameter_list|)
block|{
name|struct
name|ibv_send_wr
name|wr
decl_stmt|,
modifier|*
name|bad
decl_stmt|;
name|struct
name|ibv_sge
name|sge
decl_stmt|;
name|wr
operator|.
name|wr_id
operator|=
name|rs_send_wr_id
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
operator|)
condition|)
block|{
name|wr
operator|.
name|sg_list
operator|=
name|NULL
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|opcode
operator|=
name|IBV_WR_RDMA_WRITE_WITH_IMM
expr_stmt|;
name|wr
operator|.
name|send_flags
operator|=
literal|0
expr_stmt|;
name|wr
operator|.
name|imm_data
operator|=
name|htobe32
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|msg
expr_stmt|;
name|sge
operator|.
name|lkey
operator|=
literal|0
expr_stmt|;
name|sge
operator|.
name|length
operator|=
sizeof|sizeof
name|msg
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
operator|&
name|sge
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
name|wr
operator|.
name|opcode
operator|=
name|IBV_WR_SEND
expr_stmt|;
name|wr
operator|.
name|send_flags
operator|=
name|IBV_SEND_INLINE
expr_stmt|;
block|}
return|return
name|rdma_seterrno
argument_list|(
name|ibv_post_send
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_post_write
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|ibv_sge
modifier|*
name|sgl
parameter_list|,
name|int
name|nsge
parameter_list|,
name|uint32_t
name|wr_data
parameter_list|,
name|int
name|flags
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint32_t
name|rkey
parameter_list|)
block|{
name|struct
name|ibv_send_wr
name|wr
decl_stmt|,
modifier|*
name|bad
decl_stmt|;
name|wr
operator|.
name|wr_id
operator|=
name|rs_send_wr_id
argument_list|(
name|wr_data
argument_list|)
expr_stmt|;
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
name|sgl
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
name|nsge
expr_stmt|;
name|wr
operator|.
name|opcode
operator|=
name|IBV_WR_RDMA_WRITE
expr_stmt|;
name|wr
operator|.
name|send_flags
operator|=
name|flags
expr_stmt|;
name|wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|addr
expr_stmt|;
name|wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|rkey
expr_stmt|;
return|return
name|rdma_seterrno
argument_list|(
name|ibv_post_send
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_post_write_msg
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|ibv_sge
modifier|*
name|sgl
parameter_list|,
name|int
name|nsge
parameter_list|,
name|uint32_t
name|msg
parameter_list|,
name|int
name|flags
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint32_t
name|rkey
parameter_list|)
block|{
name|struct
name|ibv_send_wr
name|wr
decl_stmt|,
modifier|*
name|bad
decl_stmt|;
name|struct
name|ibv_sge
name|sge
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
operator|)
condition|)
block|{
name|wr
operator|.
name|wr_id
operator|=
name|rs_send_wr_id
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
name|sgl
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
name|nsge
expr_stmt|;
name|wr
operator|.
name|opcode
operator|=
name|IBV_WR_RDMA_WRITE_WITH_IMM
expr_stmt|;
name|wr
operator|.
name|send_flags
operator|=
name|flags
expr_stmt|;
name|wr
operator|.
name|imm_data
operator|=
name|htobe32
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|addr
expr_stmt|;
name|wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|rkey
expr_stmt|;
return|return
name|rdma_seterrno
argument_list|(
name|ibv_post_send
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
name|ret
operator|=
name|rs_post_write
argument_list|(
name|rs
argument_list|,
name|sgl
argument_list|,
name|nsge
argument_list|,
name|msg
argument_list|,
name|flags
argument_list|,
name|addr
argument_list|,
name|rkey
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|wr
operator|.
name|wr_id
operator|=
name|rs_send_wr_id
argument_list|(
name|rs_msg_set
argument_list|(
name|rs_msg_op
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
operator||
name|RS_WR_ID_FLAG_MSG_SEND
expr_stmt|;
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|msg
expr_stmt|;
name|sge
operator|.
name|lkey
operator|=
literal|0
expr_stmt|;
name|sge
operator|.
name|length
operator|=
sizeof|sizeof
name|msg
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
operator|&
name|sge
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
name|wr
operator|.
name|opcode
operator|=
name|IBV_WR_SEND
expr_stmt|;
name|wr
operator|.
name|send_flags
operator|=
name|IBV_SEND_INLINE
expr_stmt|;
name|ret
operator|=
name|rdma_seterrno
argument_list|(
name|ibv_post_send
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ds_post_send
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|ibv_sge
modifier|*
name|sge
parameter_list|,
name|uint32_t
name|wr_data
parameter_list|)
block|{
name|struct
name|ibv_send_wr
name|wr
decl_stmt|,
modifier|*
name|bad
decl_stmt|;
name|wr
operator|.
name|wr_id
operator|=
name|rs_send_wr_id
argument_list|(
name|wr_data
argument_list|)
expr_stmt|;
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
name|sge
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
name|wr
operator|.
name|opcode
operator|=
name|IBV_WR_SEND
expr_stmt|;
name|wr
operator|.
name|send_flags
operator|=
operator|(
name|sge
operator|->
name|length
operator|<=
name|rs
operator|->
name|sq_inline
operator|)
condition|?
name|IBV_SEND_INLINE
else|:
literal|0
expr_stmt|;
name|wr
operator|.
name|wr
operator|.
name|ud
operator|.
name|ah
operator|=
name|rs
operator|->
name|conn_dest
operator|->
name|ah
expr_stmt|;
name|wr
operator|.
name|wr
operator|.
name|ud
operator|.
name|remote_qpn
operator|=
name|rs
operator|->
name|conn_dest
operator|->
name|qpn
expr_stmt|;
name|wr
operator|.
name|wr
operator|.
name|ud
operator|.
name|remote_qkey
operator|=
name|RDMA_UDP_QKEY
expr_stmt|;
return|return
name|rdma_seterrno
argument_list|(
name|ibv_post_send
argument_list|(
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|cm_id
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Update target SGE before sending data.  Otherwise the remote side may  * update the entry before we do.  */
end_comment

begin_function
specifier|static
name|int
name|rs_write_data
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|ibv_sge
modifier|*
name|sgl
parameter_list|,
name|int
name|nsge
parameter_list|,
name|uint32_t
name|length
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|uint64_t
name|addr
decl_stmt|;
name|uint32_t
name|rkey
decl_stmt|;
name|rs
operator|->
name|sseq_no
operator|++
expr_stmt|;
name|rs
operator|->
name|sqe_avail
operator|--
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
condition|)
name|rs
operator|->
name|sqe_avail
operator|--
expr_stmt|;
name|rs
operator|->
name|sbuf_bytes_avail
operator|-=
name|length
expr_stmt|;
name|addr
operator|=
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|addr
expr_stmt|;
name|rkey
operator|=
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|key
expr_stmt|;
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|addr
operator|+=
name|length
expr_stmt|;
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|length
operator|-=
name|length
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|length
condition|)
block|{
if|if
condition|(
operator|++
name|rs
operator|->
name|target_sge
operator|==
name|RS_SGL_SIZE
condition|)
name|rs
operator|->
name|target_sge
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|rs_post_write_msg
argument_list|(
name|rs
argument_list|,
name|sgl
argument_list|,
name|nsge
argument_list|,
name|rs_msg_set
argument_list|(
name|RS_OP_DATA
argument_list|,
name|length
argument_list|)
argument_list|,
name|flags
argument_list|,
name|addr
argument_list|,
name|rkey
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_write_direct
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|rs_iomap
modifier|*
name|iom
parameter_list|,
name|uint64_t
name|offset
parameter_list|,
name|struct
name|ibv_sge
modifier|*
name|sgl
parameter_list|,
name|int
name|nsge
parameter_list|,
name|uint32_t
name|length
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|uint64_t
name|addr
decl_stmt|;
name|rs
operator|->
name|sqe_avail
operator|--
expr_stmt|;
name|rs
operator|->
name|sbuf_bytes_avail
operator|-=
name|length
expr_stmt|;
name|addr
operator|=
name|iom
operator|->
name|sge
operator|.
name|addr
operator|+
name|offset
operator|-
name|iom
operator|->
name|offset
expr_stmt|;
return|return
name|rs_post_write
argument_list|(
name|rs
argument_list|,
name|sgl
argument_list|,
name|nsge
argument_list|,
name|rs_msg_set
argument_list|(
name|RS_OP_WRITE
argument_list|,
name|length
argument_list|)
argument_list|,
name|flags
argument_list|,
name|addr
argument_list|,
name|iom
operator|->
name|sge
operator|.
name|key
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_write_iomap
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|rs_iomap_mr
modifier|*
name|iomr
parameter_list|,
name|struct
name|ibv_sge
modifier|*
name|sgl
parameter_list|,
name|int
name|nsge
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|uint64_t
name|addr
decl_stmt|;
name|rs
operator|->
name|sseq_no
operator|++
expr_stmt|;
name|rs
operator|->
name|sqe_avail
operator|--
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
condition|)
name|rs
operator|->
name|sqe_avail
operator|--
expr_stmt|;
name|rs
operator|->
name|sbuf_bytes_avail
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|rs_iomap
argument_list|)
expr_stmt|;
name|addr
operator|=
name|rs
operator|->
name|remote_iomap
operator|.
name|addr
operator|+
name|iomr
operator|->
name|index
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rs_iomap
argument_list|)
expr_stmt|;
return|return
name|rs_post_write_msg
argument_list|(
name|rs
argument_list|,
name|sgl
argument_list|,
name|nsge
argument_list|,
name|rs_msg_set
argument_list|(
name|RS_OP_IOMAP_SGL
argument_list|,
name|iomr
operator|->
name|index
argument_list|)
argument_list|,
name|flags
argument_list|,
name|addr
argument_list|,
name|rs
operator|->
name|remote_iomap
operator|.
name|key
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|rs_sbuf_left
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
call|(
name|uint32_t
call|)
argument_list|(
operator|(
call|(
name|uint64_t
call|)
argument_list|(
name|uintptr_t
argument_list|)
operator|&
name|rs
operator|->
name|sbuf
index|[
name|rs
operator|->
name|sbuf_size
index|]
operator|)
operator|-
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_send_credits
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ibv_sge
name|ibsge
decl_stmt|;
name|struct
name|rs_sge
name|sge
decl_stmt|,
modifier|*
name|sge_buf
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|rs
operator|->
name|ctrl_seqno
operator|++
expr_stmt|;
name|rs
operator|->
name|rseq_comp
operator|=
name|rs
operator|->
name|rseq_no
operator|+
operator|(
name|rs
operator|->
name|rq_size
operator|>>
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|rbuf_bytes_avail
operator|>=
operator|(
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
condition|)
name|rs
operator|->
name|ctrl_seqno
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_SWAP_SGL
operator|)
condition|)
block|{
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|rs
operator|->
name|rbuf
index|[
name|rs
operator|->
name|rbuf_free_offset
index|]
expr_stmt|;
name|sge
operator|.
name|key
operator|=
name|rs
operator|->
name|rmr
operator|->
name|rkey
expr_stmt|;
name|sge
operator|.
name|length
operator|=
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sge
operator|.
name|addr
operator|=
name|bswap_64
argument_list|(
operator|(
name|uintptr_t
operator|)
operator|&
name|rs
operator|->
name|rbuf
index|[
name|rs
operator|->
name|rbuf_free_offset
index|]
argument_list|)
expr_stmt|;
name|sge
operator|.
name|key
operator|=
name|bswap_32
argument_list|(
name|rs
operator|->
name|rmr
operator|->
name|rkey
argument_list|)
expr_stmt|;
name|sge
operator|.
name|length
operator|=
name|bswap_32
argument_list|(
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rs
operator|->
name|sq_inline
operator|<
sizeof|sizeof
name|sge
condition|)
block|{
name|sge_buf
operator|=
name|rs_get_ctrl_buf
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sge_buf
argument_list|,
operator|&
name|sge
argument_list|,
sizeof|sizeof
name|sge
argument_list|)
expr_stmt|;
name|ibsge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|sge_buf
expr_stmt|;
name|ibsge
operator|.
name|lkey
operator|=
name|rs
operator|->
name|smr
operator|->
name|lkey
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ibsge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|sge
expr_stmt|;
name|ibsge
operator|.
name|lkey
operator|=
literal|0
expr_stmt|;
name|flags
operator|=
name|IBV_SEND_INLINE
expr_stmt|;
block|}
name|ibsge
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|sge
argument_list|)
expr_stmt|;
name|rs_post_write_msg
argument_list|(
name|rs
argument_list|,
operator|&
name|ibsge
argument_list|,
literal|1
argument_list|,
name|rs_msg_set
argument_list|(
name|RS_OP_SGL
argument_list|,
name|rs
operator|->
name|rseq_no
operator|+
name|rs
operator|->
name|rq_size
argument_list|)
argument_list|,
name|flags
argument_list|,
name|rs
operator|->
name|remote_sgl
operator|.
name|addr
operator|+
name|rs
operator|->
name|remote_sge
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rs_sge
argument_list|)
argument_list|,
name|rs
operator|->
name|remote_sgl
operator|.
name|key
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rbuf_bytes_avail
operator|-=
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
expr_stmt|;
name|rs
operator|->
name|rbuf_free_offset
operator|+=
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|rbuf_free_offset
operator|>=
name|rs
operator|->
name|rbuf_size
condition|)
name|rs
operator|->
name|rbuf_free_offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|++
name|rs
operator|->
name|remote_sge
operator|==
name|rs
operator|->
name|remote_sgl
operator|.
name|length
condition|)
name|rs
operator|->
name|remote_sge
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|rs_post_msg
argument_list|(
name|rs
argument_list|,
name|rs_msg_set
argument_list|(
name|RS_OP_SGL
argument_list|,
name|rs
operator|->
name|rseq_no
operator|+
name|rs
operator|->
name|rq_size
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|rs_ctrl_avail
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
name|rs
operator|->
name|ctrl_seqno
operator|!=
name|rs
operator|->
name|ctrl_max_seqno
return|;
block|}
end_function

begin_comment
comment|/* Protocols that do not support RDMA write with immediate may require 2 msgs */
end_comment

begin_function
specifier|static
specifier|inline
name|int
name|rs_2ctrl_avail
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
call|(
name|int
call|)
argument_list|(
operator|(
name|rs
operator|->
name|ctrl_seqno
operator|+
literal|1
operator|)
operator|-
name|rs
operator|->
name|ctrl_max_seqno
argument_list|)
operator|<
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_give_credits
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
operator|)
condition|)
block|{
return|return
operator|(
operator|(
name|rs
operator|->
name|rbuf_bytes_avail
operator|>=
operator|(
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
operator|)
operator|)
operator|||
operator|(
call|(
name|short
call|)
argument_list|(
operator|(
name|short
operator|)
name|rs
operator|->
name|rseq_no
operator|-
operator|(
name|short
operator|)
name|rs
operator|->
name|rseq_comp
argument_list|)
operator|>=
literal|0
operator|)
operator|)
operator|&&
name|rs_ctrl_avail
argument_list|(
name|rs
argument_list|)
operator|&&
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
operator|(
name|rs
operator|->
name|rbuf_bytes_avail
operator|>=
operator|(
name|rs
operator|->
name|rbuf_size
operator|>>
literal|1
operator|)
operator|)
operator|||
operator|(
call|(
name|short
call|)
argument_list|(
operator|(
name|short
operator|)
name|rs
operator|->
name|rseq_no
operator|-
operator|(
name|short
operator|)
name|rs
operator|->
name|rseq_comp
argument_list|)
operator|>=
literal|0
operator|)
operator|)
operator|&&
name|rs_2ctrl_avail
argument_list|(
name|rs
argument_list|)
operator|&&
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rs_update_credits
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
if|if
condition|(
name|rs_give_credits
argument_list|(
name|rs
argument_list|)
condition|)
name|rs_send_credits
argument_list|(
name|rs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_poll_cq
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ibv_wc
name|wc
decl_stmt|;
name|uint32_t
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|rcnt
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|ret
operator|=
name|ibv_poll_cq
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|rs_wr_is_recv
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
condition|)
block|{
if|if
condition|(
name|wc
operator|.
name|status
operator|!=
name|IBV_WC_SUCCESS
condition|)
continue|continue;
name|rcnt
operator|++
expr_stmt|;
if|if
condition|(
name|wc
operator|.
name|wc_flags
operator|&
name|IBV_WC_WITH_IMM
condition|)
block|{
name|msg
operator|=
name|be32toh
argument_list|(
name|wc
operator|.
name|imm_data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|msg
operator|=
operator|(
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|rs
operator|->
name|rbuf
operator|+
name|rs
operator|->
name|rbuf_size
operator|)
operator|)
index|[
name|rs_wr_data
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
index|]
expr_stmt|;
block|}
switch|switch
condition|(
name|rs_msg_op
argument_list|(
name|msg
argument_list|)
condition|)
block|{
case|case
name|RS_OP_SGL
case|:
name|rs
operator|->
name|sseq_comp
operator|=
operator|(
name|uint16_t
operator|)
name|rs_msg_data
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|RS_OP_IOMAP_SGL
case|:
comment|/* The iomap was updated, that's nice to know. */
break|break;
case|case
name|RS_OP_CTRL
case|:
if|if
condition|(
name|rs_msg_data
argument_list|(
name|msg
argument_list|)
operator|==
name|RS_CTRL_DISCONNECT
condition|)
block|{
name|rs
operator|->
name|state
operator|=
name|rs_disconnected
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|rs_msg_data
argument_list|(
name|msg
argument_list|)
operator|==
name|RS_CTRL_SHUTDOWN
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_writable
condition|)
block|{
name|rs
operator|->
name|state
operator|&=
operator|~
name|rs_readable
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|state
operator|=
name|rs_disconnected
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
break|break;
case|case
name|RS_OP_WRITE
case|:
comment|/* We really shouldn't be here. */
break|break;
default|default:
name|rs
operator|->
name|rmsg
index|[
name|rs
operator|->
name|rmsg_tail
index|]
operator|.
name|op
operator|=
name|rs_msg_op
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rmsg
index|[
name|rs
operator|->
name|rmsg_tail
index|]
operator|.
name|data
operator|=
name|rs_msg_data
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|rs
operator|->
name|rmsg_tail
operator|==
name|rs
operator|->
name|rq_size
operator|+
literal|1
condition|)
name|rs
operator|->
name|rmsg_tail
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|rs_msg_op
argument_list|(
name|rs_wr_data
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
argument_list|)
condition|)
block|{
case|case
name|RS_OP_SGL
case|:
name|rs
operator|->
name|ctrl_max_seqno
operator|++
expr_stmt|;
break|break;
case|case
name|RS_OP_CTRL
case|:
name|rs
operator|->
name|ctrl_max_seqno
operator|++
expr_stmt|;
if|if
condition|(
name|rs_msg_data
argument_list|(
name|rs_wr_data
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
argument_list|)
operator|==
name|RS_CTRL_DISCONNECT
condition|)
name|rs
operator|->
name|state
operator|=
name|rs_disconnected
expr_stmt|;
break|break;
case|case
name|RS_OP_IOMAP_SGL
case|:
name|rs
operator|->
name|sqe_avail
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|rs_wr_is_msg_send
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
condition|)
name|rs
operator|->
name|sbuf_bytes_avail
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|rs_iomap
argument_list|)
expr_stmt|;
break|break;
default|default:
name|rs
operator|->
name|sqe_avail
operator|++
expr_stmt|;
name|rs
operator|->
name|sbuf_bytes_avail
operator|+=
name|rs_msg_data
argument_list|(
name|rs_wr_data
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wc
operator|.
name|status
operator|!=
name|IBV_WC_SUCCESS
operator|&&
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
condition|)
block|{
name|rs
operator|->
name|state
operator|=
name|rs_error
expr_stmt|;
name|rs
operator|->
name|err
operator|=
name|EIO
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
condition|)
block|{
while|while
condition|(
operator|!
name|ret
operator|&&
name|rcnt
operator|--
condition|)
name|ret
operator|=
name|rs_post_recv
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|rs
operator|->
name|state
operator|=
name|rs_error
expr_stmt|;
name|rs
operator|->
name|err
operator|=
name|errno
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_get_cq_event
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ibv_cq
modifier|*
name|cq
decl_stmt|;
name|void
modifier|*
name|context
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|cq_armed
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|ibv_get_cq_event
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq_channel
argument_list|,
operator|&
name|cq
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
if|if
condition|(
operator|++
name|rs
operator|->
name|unack_cqe
operator|>=
name|rs
operator|->
name|sq_size
operator|+
name|rs
operator|->
name|rq_size
condition|)
block|{
name|ibv_ack_cq_events
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq
argument_list|,
name|rs
operator|->
name|unack_cqe
argument_list|)
expr_stmt|;
name|rs
operator|->
name|unack_cqe
operator|=
literal|0
expr_stmt|;
block|}
name|rs
operator|->
name|cq_armed
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|errno
operator|==
name|EAGAIN
operator|||
name|errno
operator|==
name|EINTR
operator|)
condition|)
block|{
name|rs
operator|->
name|state
operator|=
name|rs_error
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Although we serialize rsend and rrecv calls with respect to themselves,  * both calls may run simultaneously and need to poll the CQ for completions.  * We need to serialize access to the CQ, but rsend and rrecv need to  * allow each other to make forward progress.  *  * For example, rsend may need to wait for credits from the remote side,  * which could be stalled until the remote process calls rrecv.  This should  * not block rrecv from receiving data from the remote side however.  *  * We handle this by using two locks.  The cq_lock protects against polling  * the CQ and processing completions.  The cq_wait_lock serializes access to  * waiting on the CQ.  */
end_comment

begin_function
specifier|static
name|int
name|rs_process_cq
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|nonblock
parameter_list|,
name|int
function_decl|(
modifier|*
name|test
function_decl|)
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
do|do
block|{
name|rs_update_credits
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rs_poll_cq
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|test
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|ret
condition|)
block|{
break|break;
block|}
elseif|else
if|if
condition|(
name|nonblock
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|EWOULDBLOCK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|rs
operator|->
name|cq_armed
condition|)
block|{
name|ibv_req_notify_cq
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rs
operator|->
name|cq_armed
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rs_update_credits
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|cq_wait_lock
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rs_get_cq_event
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|cq_wait_lock
argument_list|)
expr_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|!
name|ret
condition|)
do|;
name|rs_update_credits
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_get_comp
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|nonblock
parameter_list|,
name|int
function_decl|(
modifier|*
name|test
function_decl|)
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
parameter_list|)
block|{
name|struct
name|timeval
name|s
decl_stmt|,
name|e
decl_stmt|;
name|uint32_t
name|poll_time
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
do|do
block|{
name|ret
operator|=
name|rs_process_cq
argument_list|(
name|rs
argument_list|,
literal|1
argument_list|,
name|test
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|||
name|nonblock
operator|||
name|errno
operator|!=
name|EWOULDBLOCK
condition|)
return|return
name|ret
return|;
if|if
condition|(
operator|!
name|poll_time
condition|)
name|gettimeofday
argument_list|(
operator|&
name|s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|poll_time
operator|=
operator|(
name|e
operator|.
name|tv_sec
operator|-
name|s
operator|.
name|tv_sec
operator|)
operator|*
literal|1000000
operator|+
operator|(
name|e
operator|.
name|tv_usec
operator|-
name|s
operator|.
name|tv_usec
operator|)
operator|+
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|poll_time
operator|<=
name|polling_time
condition|)
do|;
name|ret
operator|=
name|rs_process_cq
argument_list|(
name|rs
argument_list|,
literal|0
argument_list|,
name|test
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_valid_recv
parameter_list|(
name|struct
name|ds_qp
modifier|*
name|qp
parameter_list|,
name|struct
name|ibv_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|ds_header
modifier|*
name|hdr
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ds_header
operator|*
operator|)
operator|(
name|qp
operator|->
name|rbuf
operator|+
name|rs_wr_data
argument_list|(
name|wc
operator|->
name|wr_id
argument_list|)
operator|)
expr_stmt|;
return|return
operator|(
operator|(
name|wc
operator|->
name|byte_len
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|ibv_grh
argument_list|)
operator|+
name|DS_IPV4_HDR_LEN
operator|)
operator|&&
operator|(
operator|(
name|hdr
operator|->
name|version
operator|==
literal|4
operator|&&
name|hdr
operator|->
name|length
operator|==
name|DS_IPV4_HDR_LEN
operator|)
operator|||
operator|(
name|hdr
operator|->
name|version
operator|==
literal|6
operator|&&
name|hdr
operator|->
name|length
operator|==
name|DS_IPV6_HDR_LEN
operator|)
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Poll all CQs associated with a datagram rsocket.  We need to drop any  * received messages that we do not have room to store.  To limit drops,  * we only poll if we have room to store the receive or we need a send  * buffer.  To ensure fairness, we poll the CQs round robin, remembering  * where we left off.  */
end_comment

begin_function
specifier|static
name|void
name|ds_poll_cqs
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ds_qp
modifier|*
name|qp
decl_stmt|;
name|struct
name|ds_smsg
modifier|*
name|smsg
decl_stmt|;
name|struct
name|ds_rmsg
modifier|*
name|rmsg
decl_stmt|;
name|struct
name|ibv_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|cnt
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|qp
operator|=
name|rs
operator|->
name|qp_list
operator|)
condition|)
return|return;
do|do
block|{
name|cnt
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ret
operator|=
name|ibv_poll_cq
argument_list|(
name|qp
operator|->
name|cm_id
operator|->
name|recv_cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
block|{
name|qp
operator|=
name|ds_next_qp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|rs_wr_is_recv
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|rqe_avail
operator|&&
name|wc
operator|.
name|status
operator|==
name|IBV_WC_SUCCESS
operator|&&
name|ds_valid_recv
argument_list|(
name|qp
argument_list|,
operator|&
name|wc
argument_list|)
condition|)
block|{
name|rs
operator|->
name|rqe_avail
operator|--
expr_stmt|;
name|rmsg
operator|=
operator|&
name|rs
operator|->
name|dmsg
index|[
name|rs
operator|->
name|rmsg_tail
index|]
expr_stmt|;
name|rmsg
operator|->
name|qp
operator|=
name|qp
expr_stmt|;
name|rmsg
operator|->
name|offset
operator|=
name|rs_wr_data
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
expr_stmt|;
name|rmsg
operator|->
name|length
operator|=
name|wc
operator|.
name|byte_len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ibv_grh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|rs
operator|->
name|rmsg_tail
operator|==
name|rs
operator|->
name|rq_size
operator|+
literal|1
condition|)
name|rs
operator|->
name|rmsg_tail
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ds_post_recv
argument_list|(
name|rs
argument_list|,
name|qp
argument_list|,
name|rs_wr_data
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|smsg
operator|=
operator|(
expr|struct
name|ds_smsg
operator|*
operator|)
operator|(
name|rs
operator|->
name|sbuf
operator|+
name|rs_wr_data
argument_list|(
name|wc
operator|.
name|wr_id
argument_list|)
operator|)
expr_stmt|;
name|smsg
operator|->
name|next
operator|=
name|rs
operator|->
name|smsg_free
expr_stmt|;
name|rs
operator|->
name|smsg_free
operator|=
name|smsg
expr_stmt|;
name|rs
operator|->
name|sqe_avail
operator|++
expr_stmt|;
block|}
name|qp
operator|=
name|ds_next_qp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|rqe_avail
operator|&&
name|rs
operator|->
name|sqe_avail
condition|)
block|{
name|rs
operator|->
name|qp_list
operator|=
name|qp
expr_stmt|;
return|return;
block|}
name|cnt
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|qp
operator|!=
name|rs
operator|->
name|qp_list
condition|)
do|;
block|}
do|while
condition|(
name|cnt
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_req_notify_cqs
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|ds_qp
modifier|*
name|qp
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|qp
operator|=
name|rs
operator|->
name|qp_list
operator|)
condition|)
return|return;
do|do
block|{
if|if
condition|(
operator|!
name|qp
operator|->
name|cq_armed
condition|)
block|{
name|ibv_req_notify_cq
argument_list|(
name|qp
operator|->
name|cm_id
operator|->
name|recv_cq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|qp
operator|->
name|cq_armed
operator|=
literal|1
expr_stmt|;
block|}
name|qp
operator|=
name|ds_next_qp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|qp
operator|!=
name|rs
operator|->
name|qp_list
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_get_cq_event
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|struct
name|epoll_event
name|event
decl_stmt|;
name|struct
name|ds_qp
modifier|*
name|qp
decl_stmt|;
name|struct
name|ibv_cq
modifier|*
name|cq
decl_stmt|;
name|void
modifier|*
name|context
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|cq_armed
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|epoll_wait
argument_list|(
name|rs
operator|->
name|epfd
argument_list|,
operator|&
name|event
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
return|return
name|ret
return|;
name|qp
operator|=
name|event
operator|.
name|data
operator|.
name|ptr
expr_stmt|;
name|ret
operator|=
name|ibv_get_cq_event
argument_list|(
name|qp
operator|->
name|cm_id
operator|->
name|recv_cq_channel
argument_list|,
operator|&
name|cq
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|ibv_ack_cq_events
argument_list|(
name|qp
operator|->
name|cm_id
operator|->
name|recv_cq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|qp
operator|->
name|cq_armed
operator|=
literal|0
expr_stmt|;
name|rs
operator|->
name|cq_armed
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_process_cqs
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|nonblock
parameter_list|,
name|int
function_decl|(
modifier|*
name|test
function_decl|)
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
do|do
block|{
name|ds_poll_cqs
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|test
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|nonblock
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|EWOULDBLOCK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|rs
operator|->
name|cq_armed
condition|)
block|{
name|ds_req_notify_cqs
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|rs
operator|->
name|cq_armed
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|cq_wait_lock
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ds_get_cq_event
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|cq_wait_lock
argument_list|)
expr_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|!
name|ret
condition|)
do|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_get_comp
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|nonblock
parameter_list|,
name|int
function_decl|(
modifier|*
name|test
function_decl|)
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
parameter_list|)
block|{
name|struct
name|timeval
name|s
decl_stmt|,
name|e
decl_stmt|;
name|uint32_t
name|poll_time
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
do|do
block|{
name|ret
operator|=
name|ds_process_cqs
argument_list|(
name|rs
argument_list|,
literal|1
argument_list|,
name|test
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|||
name|nonblock
operator|||
name|errno
operator|!=
name|EWOULDBLOCK
condition|)
return|return
name|ret
return|;
if|if
condition|(
operator|!
name|poll_time
condition|)
name|gettimeofday
argument_list|(
operator|&
name|s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|poll_time
operator|=
operator|(
name|e
operator|.
name|tv_sec
operator|-
name|s
operator|.
name|tv_sec
operator|)
operator|*
literal|1000000
operator|+
operator|(
name|e
operator|.
name|tv_usec
operator|-
name|s
operator|.
name|tv_usec
operator|)
operator|+
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|poll_time
operator|<=
name|polling_time
condition|)
do|;
name|ret
operator|=
name|ds_process_cqs
argument_list|(
name|rs
argument_list|,
literal|0
argument_list|,
name|test
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_nonblocking
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
return|return
operator|(
name|rs
operator|->
name|fd_flags
operator|&
name|O_NONBLOCK
operator|)
operator|||
operator|(
name|flags
operator|&
name|MSG_DONTWAIT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_is_cq_armed
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
name|rs
operator|->
name|cq_armed
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_poll_all
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * We use hardware flow control to prevent over running the remote  * receive queue.  However, data transfers still require space in  * the remote rmsg queue, or we risk losing notification that data  * has been transfered.  *  * Be careful with race conditions in the check below.  The target SGL  * may be updated by a remote RDMA write.  */
end_comment

begin_function
specifier|static
name|int
name|rs_can_send
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_MSG_SEND
operator|)
condition|)
block|{
return|return
name|rs
operator|->
name|sqe_avail
operator|&&
operator|(
name|rs
operator|->
name|sbuf_bytes_avail
operator|>=
name|RS_SNDLOWAT
operator|)
operator|&&
operator|(
name|rs
operator|->
name|sseq_no
operator|!=
name|rs
operator|->
name|sseq_comp
operator|)
operator|&&
operator|(
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|length
operator|!=
literal|0
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|rs
operator|->
name|sqe_avail
operator|>=
literal|2
operator|)
operator|&&
operator|(
name|rs
operator|->
name|sbuf_bytes_avail
operator|>=
name|RS_SNDLOWAT
operator|)
operator|&&
operator|(
name|rs
operator|->
name|sseq_no
operator|!=
name|rs
operator|->
name|sseq_comp
operator|)
operator|&&
operator|(
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|length
operator|!=
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ds_can_send
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
name|rs
operator|->
name|sqe_avail
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_all_sends_done
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
name|rs
operator|->
name|sqe_avail
operator|==
name|rs
operator|->
name|sq_size
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_conn_can_send
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
name|rs_can_send
argument_list|(
name|rs
argument_list|)
operator|||
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_writable
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_conn_can_send_ctrl
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
name|rs_ctrl_avail
argument_list|(
name|rs
argument_list|)
operator|||
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_have_rdata
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
operator|(
name|rs
operator|->
name|rmsg_head
operator|!=
name|rs
operator|->
name|rmsg_tail
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_conn_have_rdata
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
name|rs_have_rdata
argument_list|(
name|rs
argument_list|)
operator|||
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_readable
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_conn_all_sends_done
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
return|return
operator|(
operator|(
operator|(
operator|(
name|int
operator|)
name|rs
operator|->
name|ctrl_max_seqno
operator|)
operator|-
operator|(
operator|(
name|int
operator|)
name|rs
operator|->
name|ctrl_seqno
operator|)
operator|)
operator|+
name|rs
operator|->
name|sqe_avail
operator|==
name|rs
operator|->
name|sq_size
operator|)
operator|||
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_set_src
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
modifier|*
name|addrlen
parameter_list|,
name|struct
name|ds_header
modifier|*
name|hdr
parameter_list|)
block|{
name|union
name|socket_addr
name|sa
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sa
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|version
operator|==
literal|4
condition|)
block|{
if|if
condition|(
operator|*
name|addrlen
operator|>
sizeof|sizeof
argument_list|(
name|sa
operator|.
name|sin
argument_list|)
condition|)
operator|*
name|addrlen
operator|=
sizeof|sizeof
argument_list|(
name|sa
operator|.
name|sin
argument_list|)
expr_stmt|;
name|sa
operator|.
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sa
operator|.
name|sin
operator|.
name|sin_port
operator|=
name|hdr
operator|->
name|port
expr_stmt|;
name|sa
operator|.
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|hdr
operator|->
name|addr
operator|.
name|ipv4
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|addrlen
operator|>
sizeof|sizeof
argument_list|(
name|sa
operator|.
name|sin6
argument_list|)
condition|)
operator|*
name|addrlen
operator|=
sizeof|sizeof
argument_list|(
name|sa
operator|.
name|sin6
argument_list|)
expr_stmt|;
name|sa
operator|.
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|sa
operator|.
name|sin6
operator|.
name|sin6_port
operator|=
name|hdr
operator|->
name|port
expr_stmt|;
name|sa
operator|.
name|sin6
operator|.
name|sin6_flowinfo
operator|=
name|hdr
operator|->
name|addr
operator|.
name|ipv6
operator|.
name|flowinfo
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sa
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|,
operator|&
name|hdr
operator|->
name|addr
operator|.
name|ipv6
operator|.
name|addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|addr
argument_list|,
operator|&
name|sa
argument_list|,
operator|*
name|addrlen
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|ds_recvfrom
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|src_addr
parameter_list|,
name|socklen_t
modifier|*
name|addrlen
parameter_list|)
block|{
name|struct
name|ds_rmsg
modifier|*
name|rmsg
decl_stmt|;
name|struct
name|ds_header
modifier|*
name|hdr
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_readable
operator|)
condition|)
return|return
name|ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
if|if
condition|(
operator|!
name|rs_have_rdata
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
name|ds_get_comp
argument_list|(
name|rs
argument_list|,
name|rs_nonblocking
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
argument_list|,
name|rs_have_rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|rmsg
operator|=
operator|&
name|rs
operator|->
name|dmsg
index|[
name|rs
operator|->
name|rmsg_head
index|]
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ds_header
operator|*
operator|)
operator|(
name|rmsg
operator|->
name|qp
operator|->
name|rbuf
operator|+
name|rmsg
operator|->
name|offset
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|rmsg
operator|->
name|length
operator|-
name|hdr
operator|->
name|length
condition|)
name|len
operator|=
name|rmsg
operator|->
name|length
operator|-
name|hdr
operator|->
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|(
name|void
operator|*
operator|)
name|hdr
operator|+
name|hdr
operator|->
name|length
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|addrlen
condition|)
name|ds_set_src
argument_list|(
name|src_addr
argument_list|,
name|addrlen
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|MSG_PEEK
operator|)
condition|)
block|{
name|ds_post_recv
argument_list|(
name|rs
argument_list|,
name|rmsg
operator|->
name|qp
argument_list|,
name|rmsg
operator|->
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|rs
operator|->
name|rmsg_head
operator|==
name|rs
operator|->
name|rq_size
operator|+
literal|1
condition|)
name|rs
operator|->
name|rmsg_head
operator|=
literal|0
expr_stmt|;
name|rs
operator|->
name|rqe_avail
operator|++
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|rs_peek
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|left
init|=
name|len
decl_stmt|;
name|uint32_t
name|end_size
decl_stmt|,
name|rsize
decl_stmt|;
name|int
name|rmsg_head
decl_stmt|,
name|rbuf_offset
decl_stmt|;
name|rmsg_head
operator|=
name|rs
operator|->
name|rmsg_head
expr_stmt|;
name|rbuf_offset
operator|=
name|rs
operator|->
name|rbuf_offset
expr_stmt|;
for|for
control|(
init|;
name|left
operator|&&
operator|(
name|rmsg_head
operator|!=
name|rs
operator|->
name|rmsg_tail
operator|)
condition|;
name|left
operator|-=
name|rsize
control|)
block|{
if|if
condition|(
name|left
operator|<
name|rs
operator|->
name|rmsg
index|[
name|rmsg_head
index|]
operator|.
name|data
condition|)
block|{
name|rsize
operator|=
name|left
expr_stmt|;
block|}
else|else
block|{
name|rsize
operator|=
name|rs
operator|->
name|rmsg
index|[
name|rmsg_head
index|]
operator|.
name|data
expr_stmt|;
if|if
condition|(
operator|++
name|rmsg_head
operator|==
name|rs
operator|->
name|rq_size
operator|+
literal|1
condition|)
name|rmsg_head
operator|=
literal|0
expr_stmt|;
block|}
name|end_size
operator|=
name|rs
operator|->
name|rbuf_size
operator|-
name|rbuf_offset
expr_stmt|;
if|if
condition|(
name|rsize
operator|>
name|end_size
condition|)
block|{
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|rs
operator|->
name|rbuf
index|[
name|rbuf_offset
index|]
argument_list|,
name|end_size
argument_list|)
expr_stmt|;
name|rbuf_offset
operator|=
literal|0
expr_stmt|;
name|buf
operator|+=
name|end_size
expr_stmt|;
name|rsize
operator|-=
name|end_size
expr_stmt|;
name|left
operator|-=
name|end_size
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|rs
operator|->
name|rbuf
index|[
name|rbuf_offset
index|]
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
name|rbuf_offset
operator|+=
name|rsize
expr_stmt|;
name|buf
operator|+=
name|rsize
expr_stmt|;
block|}
return|return
name|len
operator|-
name|left
return|;
block|}
end_function

begin_comment
comment|/*  * Continue to receive any queued data even if the remote side has disconnected.  */
end_comment

begin_function
name|ssize_t
name|rrecv
parameter_list|(
name|int
name|socket
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|size_t
name|left
init|=
name|len
decl_stmt|;
name|uint32_t
name|end_size
decl_stmt|,
name|rsize
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|rs
operator|=
name|idm_at
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|rlock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ds_recvfrom
argument_list|(
name|rs
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|rlock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_opening
condition|)
block|{
name|ret
operator|=
name|rs_do_connect
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINPROGRESS
condition|)
name|errno
operator|=
name|EAGAIN
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|rlock
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|!
name|rs_have_rdata
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
name|rs_get_comp
argument_list|(
name|rs
argument_list|,
name|rs_nonblocking
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
argument_list|,
name|rs_conn_have_rdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
if|if
condition|(
name|flags
operator|&
name|MSG_PEEK
condition|)
block|{
name|left
operator|=
name|len
operator|-
name|rs_peek
argument_list|(
name|rs
argument_list|,
name|buf
argument_list|,
name|left
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
init|;
name|left
operator|&&
name|rs_have_rdata
argument_list|(
name|rs
argument_list|)
condition|;
name|left
operator|-=
name|rsize
control|)
block|{
if|if
condition|(
name|left
operator|<
name|rs
operator|->
name|rmsg
index|[
name|rs
operator|->
name|rmsg_head
index|]
operator|.
name|data
condition|)
block|{
name|rsize
operator|=
name|left
expr_stmt|;
name|rs
operator|->
name|rmsg
index|[
name|rs
operator|->
name|rmsg_head
index|]
operator|.
name|data
operator|-=
name|left
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|rseq_no
operator|++
expr_stmt|;
name|rsize
operator|=
name|rs
operator|->
name|rmsg
index|[
name|rs
operator|->
name|rmsg_head
index|]
operator|.
name|data
expr_stmt|;
if|if
condition|(
operator|++
name|rs
operator|->
name|rmsg_head
operator|==
name|rs
operator|->
name|rq_size
operator|+
literal|1
condition|)
name|rs
operator|->
name|rmsg_head
operator|=
literal|0
expr_stmt|;
block|}
name|end_size
operator|=
name|rs
operator|->
name|rbuf_size
operator|-
name|rs
operator|->
name|rbuf_offset
expr_stmt|;
if|if
condition|(
name|rsize
operator|>
name|end_size
condition|)
block|{
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|rs
operator|->
name|rbuf
index|[
name|rs
operator|->
name|rbuf_offset
index|]
argument_list|,
name|end_size
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rbuf_offset
operator|=
literal|0
expr_stmt|;
name|buf
operator|+=
name|end_size
expr_stmt|;
name|rsize
operator|-=
name|end_size
expr_stmt|;
name|left
operator|-=
name|end_size
expr_stmt|;
name|rs
operator|->
name|rbuf_bytes_avail
operator|+=
name|end_size
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|rs
operator|->
name|rbuf
index|[
name|rs
operator|->
name|rbuf_offset
index|]
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
name|rs
operator|->
name|rbuf_offset
operator|+=
name|rsize
expr_stmt|;
name|buf
operator|+=
name|rsize
expr_stmt|;
name|rs
operator|->
name|rbuf_bytes_avail
operator|+=
name|rsize
expr_stmt|;
block|}
block|}
do|while
condition|(
name|left
operator|&&
operator|(
name|flags
operator|&
name|MSG_WAITALL
operator|)
operator|&&
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_readable
operator|)
condition|)
do|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|rlock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|&&
name|left
operator|==
name|len
operator|)
condition|?
name|ret
else|:
name|len
operator|-
name|left
return|;
block|}
end_function

begin_function
name|ssize_t
name|rrecvfrom
parameter_list|(
name|int
name|socket
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|src_addr
parameter_list|,
name|socklen_t
modifier|*
name|addrlen
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rs
operator|=
name|idm_at
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|rlock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ds_recvfrom
argument_list|(
name|rs
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|,
name|src_addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|rlock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|rrecv
argument_list|(
name|socket
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>
literal|0
operator|&&
name|src_addr
condition|)
name|rgetpeername
argument_list|(
name|socket
argument_list|,
name|src_addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Simple, straightforward implementation for now that only tries to fill  * in the first vector.  */
end_comment

begin_function
specifier|static
name|ssize_t
name|rrecvv
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
name|iovcnt
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
return|return
name|rrecv
argument_list|(
name|socket
argument_list|,
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
argument_list|,
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|rrecvmsg
parameter_list|(
name|int
name|socket
parameter_list|,
name|struct
name|msghdr
modifier|*
name|msg
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|->
name|msg_control
operator|&&
name|msg
operator|->
name|msg_controllen
condition|)
return|return
name|ERR
argument_list|(
name|ENOTSUP
argument_list|)
return|;
return|return
name|rrecvv
argument_list|(
name|socket
argument_list|,
name|msg
operator|->
name|msg_iov
argument_list|,
operator|(
name|int
operator|)
name|msg
operator|->
name|msg_iovlen
argument_list|,
name|msg
operator|->
name|msg_flags
argument_list|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|rread
parameter_list|(
name|int
name|socket
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
return|return
name|rrecv
argument_list|(
name|socket
argument_list|,
name|buf
argument_list|,
name|count
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|rreadv
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
name|iovcnt
parameter_list|)
block|{
return|return
name|rrecvv
argument_list|(
name|socket
argument_list|,
name|iov
argument_list|,
name|iovcnt
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_send_iomaps
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|rs_iomap_mr
modifier|*
name|iomr
decl_stmt|;
name|struct
name|ibv_sge
name|sge
decl_stmt|;
name|struct
name|rs_iomap
name|iom
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|dlist_empty
argument_list|(
operator|&
name|rs
operator|->
name|iomap_queue
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|rs_can_send
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
name|rs_get_comp
argument_list|(
name|rs
argument_list|,
name|rs_nonblocking
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
argument_list|,
name|rs_conn_can_send
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_writable
operator|)
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|ECONNRESET
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|iomr
operator|=
name|container_of
argument_list|(
name|rs
operator|->
name|iomap_queue
operator|.
name|next
argument_list|,
expr|struct
name|rs_iomap_mr
argument_list|,
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_SWAP_SGL
operator|)
condition|)
block|{
name|iom
operator|.
name|offset
operator|=
name|iomr
operator|->
name|offset
expr_stmt|;
name|iom
operator|.
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|iomr
operator|->
name|mr
operator|->
name|addr
expr_stmt|;
name|iom
operator|.
name|sge
operator|.
name|length
operator|=
name|iomr
operator|->
name|mr
operator|->
name|length
expr_stmt|;
name|iom
operator|.
name|sge
operator|.
name|key
operator|=
name|iomr
operator|->
name|mr
operator|->
name|rkey
expr_stmt|;
block|}
else|else
block|{
name|iom
operator|.
name|offset
operator|=
name|bswap_64
argument_list|(
name|iomr
operator|->
name|offset
argument_list|)
expr_stmt|;
name|iom
operator|.
name|sge
operator|.
name|addr
operator|=
name|bswap_64
argument_list|(
operator|(
name|uintptr_t
operator|)
name|iomr
operator|->
name|mr
operator|->
name|addr
argument_list|)
expr_stmt|;
name|iom
operator|.
name|sge
operator|.
name|length
operator|=
name|bswap_32
argument_list|(
name|iomr
operator|->
name|mr
operator|->
name|length
argument_list|)
expr_stmt|;
name|iom
operator|.
name|sge
operator|.
name|key
operator|=
name|bswap_32
argument_list|(
name|iomr
operator|->
name|mr
operator|->
name|rkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rs
operator|->
name|sq_inline
operator|>=
sizeof|sizeof
name|iom
condition|)
block|{
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|iom
expr_stmt|;
name|sge
operator|.
name|length
operator|=
sizeof|sizeof
name|iom
expr_stmt|;
name|sge
operator|.
name|lkey
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|rs_write_iomap
argument_list|(
name|rs
argument_list|,
name|iomr
argument_list|,
operator|&
name|sge
argument_list|,
literal|1
argument_list|,
name|IBV_SEND_INLINE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
operator|>=
sizeof|sizeof
name|iom
condition|)
block|{
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
argument_list|,
operator|&
name|iom
argument_list|,
sizeof|sizeof
name|iom
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
sizeof|sizeof
name|iom
expr_stmt|;
name|ret
operator|=
name|rs_write_iomap
argument_list|(
name|rs
argument_list|,
name|iomr
argument_list|,
name|rs
operator|->
name|ssgl
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
operator|>
sizeof|sizeof
name|iom
condition|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|+=
sizeof|sizeof
name|iom
expr_stmt|;
else|else
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|sbuf
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
argument_list|,
operator|&
name|iom
argument_list|,
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
operator|=
sizeof|sizeof
name|iom
operator|-
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|rs
operator|->
name|sbuf
argument_list|,
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|iom
operator|)
operator|+
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
argument_list|,
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rs_write_iomap
argument_list|(
name|rs
argument_list|,
name|iomr
argument_list|,
name|rs
operator|->
name|ssgl
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|sbuf
operator|+
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
expr_stmt|;
block|}
name|dlist_remove
argument_list|(
operator|&
name|iomr
operator|->
name|entry
argument_list|)
expr_stmt|;
name|dlist_insert_tail
argument_list|(
operator|&
name|iomr
operator|->
name|entry
argument_list|,
operator|&
name|rs
operator|->
name|iomap_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
name|rs
operator|->
name|iomap_pending
operator|=
operator|!
name|dlist_empty
argument_list|(
operator|&
name|rs
operator|->
name|iomap_queue
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|ds_sendv_udp
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
specifier|const
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
name|iovcnt
parameter_list|,
name|int
name|flags
parameter_list|,
name|uint8_t
name|op
parameter_list|)
block|{
name|struct
name|ds_udp_header
name|hdr
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|miov
index|[
literal|8
index|]
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
if|if
condition|(
name|iovcnt
operator|>
literal|8
condition|)
return|return
name|ERR
argument_list|(
name|ENOTSUP
argument_list|)
return|;
name|hdr
operator|.
name|tag
operator|=
name|htobe32
argument_list|(
name|DS_UDP_TAG
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|version
operator|=
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|hdr
operator|.
name|version
expr_stmt|;
name|hdr
operator|.
name|op
operator|=
name|op
expr_stmt|;
name|hdr
operator|.
name|reserved
operator|=
literal|0
expr_stmt|;
name|hdr
operator|.
name|qpn
operator|=
name|htobe32
argument_list|(
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|cm_id
operator|->
name|qp
operator|->
name|qp_num
operator|&
literal|0xFFFFFF
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|hdr
operator|.
name|version
operator|==
literal|4
condition|)
block|{
name|hdr
operator|.
name|length
operator|=
name|DS_UDP_IPV4_HDR_LEN
expr_stmt|;
name|hdr
operator|.
name|addr
operator|.
name|ipv4
operator|=
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|hdr
operator|.
name|addr
operator|.
name|ipv4
expr_stmt|;
block|}
else|else
block|{
name|hdr
operator|.
name|length
operator|=
name|DS_UDP_IPV6_HDR_LEN
expr_stmt|;
name|memcpy
argument_list|(
name|hdr
operator|.
name|addr
operator|.
name|ipv6
argument_list|,
operator|&
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|hdr
operator|.
name|addr
operator|.
name|ipv6
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
name|miov
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|&
name|hdr
expr_stmt|;
name|miov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|hdr
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|iov
operator|&&
name|iovcnt
condition|)
name|memcpy
argument_list|(
operator|&
name|miov
index|[
literal|1
index|]
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|iov
argument_list|)
operator|*
name|iovcnt
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|rs
operator|->
name|conn_dest
operator|->
name|addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|ucma_addrlen
argument_list|(
operator|&
name|rs
operator|->
name|conn_dest
operator|->
name|addr
operator|.
name|sa
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|miov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
name|iovcnt
operator|+
literal|1
expr_stmt|;
name|ret
operator|=
name|sendmsg
argument_list|(
name|rs
operator|->
name|udp_sock
argument_list|,
operator|&
name|msg
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
operator|>
literal|0
condition|?
name|ret
operator|-
name|hdr
operator|.
name|length
else|:
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|ds_send_udp
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|,
name|uint8_t
name|op
parameter_list|)
block|{
name|struct
name|iovec
name|iov
decl_stmt|;
if|if
condition|(
name|buf
operator|&&
name|len
condition|)
block|{
name|iov
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|buf
expr_stmt|;
name|iov
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
return|return
name|ds_sendv_udp
argument_list|(
name|rs
argument_list|,
operator|&
name|iov
argument_list|,
literal|1
argument_list|,
name|flags
argument_list|,
name|op
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|ds_sendv_udp
argument_list|(
name|rs
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|flags
argument_list|,
name|op
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|dsend
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|ds_smsg
modifier|*
name|msg
decl_stmt|;
name|struct
name|ibv_sge
name|sge
decl_stmt|;
name|uint64_t
name|offset
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|conn_dest
operator|->
name|ah
condition|)
return|return
name|ds_send_udp
argument_list|(
name|rs
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|,
name|RS_OP_DATA
argument_list|)
return|;
if|if
condition|(
operator|!
name|ds_can_send
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
name|ds_get_comp
argument_list|(
name|rs
argument_list|,
name|rs_nonblocking
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
argument_list|,
name|ds_can_send
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|msg
operator|=
name|rs
operator|->
name|smsg_free
expr_stmt|;
name|rs
operator|->
name|smsg_free
operator|=
name|msg
operator|->
name|next
expr_stmt|;
name|rs
operator|->
name|sqe_avail
operator|--
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|msg
argument_list|,
operator|&
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|hdr
argument_list|,
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|msg
operator|+
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|hdr
operator|.
name|length
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|msg
expr_stmt|;
name|sge
operator|.
name|length
operator|=
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|hdr
operator|.
name|length
operator|+
name|len
expr_stmt|;
name|sge
operator|.
name|lkey
operator|=
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|smr
operator|->
name|lkey
expr_stmt|;
name|offset
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|msg
operator|-
name|rs
operator|->
name|sbuf
expr_stmt|;
name|ret
operator|=
name|ds_post_send
argument_list|(
name|rs
argument_list|,
operator|&
name|sge
argument_list|,
name|offset
argument_list|)
expr_stmt|;
return|return
name|ret
condition|?
name|ret
else|:
name|len
return|;
block|}
end_function

begin_comment
comment|/*  * We overlap sending the data, by posting a small work request immediately,  * then increasing the size of the send on each iteration.  */
end_comment

begin_function
name|ssize_t
name|rsend
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|struct
name|ibv_sge
name|sge
decl_stmt|;
name|size_t
name|left
init|=
name|len
decl_stmt|;
name|uint32_t
name|xfer_size
decl_stmt|,
name|olen
init|=
name|RS_OLAP_START_SIZE
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|rs
operator|=
name|idm_at
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dsend
argument_list|(
name|rs
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_opening
condition|)
block|{
name|ret
operator|=
name|rs_do_connect
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINPROGRESS
condition|)
name|errno
operator|=
name|EAGAIN
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|iomap_pending
condition|)
block|{
name|ret
operator|=
name|rs_send_iomaps
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
for|for
control|(
init|;
name|left
condition|;
name|left
operator|-=
name|xfer_size
operator|,
name|buf
operator|+=
name|xfer_size
control|)
block|{
if|if
condition|(
operator|!
name|rs_can_send
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
name|rs_get_comp
argument_list|(
name|rs
argument_list|,
name|rs_nonblocking
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
argument_list|,
name|rs_conn_can_send
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_writable
operator|)
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|ECONNRESET
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|olen
operator|<
name|left
condition|)
block|{
name|xfer_size
operator|=
name|olen
expr_stmt|;
if|if
condition|(
name|olen
operator|<
name|RS_MAX_TRANSFER
condition|)
name|olen
operator|<<=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|xfer_size
operator|=
name|left
expr_stmt|;
block|}
if|if
condition|(
name|xfer_size
operator|>
name|rs
operator|->
name|sbuf_bytes_avail
condition|)
name|xfer_size
operator|=
name|rs
operator|->
name|sbuf_bytes_avail
expr_stmt|;
if|if
condition|(
name|xfer_size
operator|>
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|length
condition|)
name|xfer_size
operator|=
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|xfer_size
operator|<=
name|rs
operator|->
name|sq_inline
condition|)
block|{
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|buf
expr_stmt|;
name|sge
operator|.
name|length
operator|=
name|xfer_size
expr_stmt|;
name|sge
operator|.
name|lkey
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|rs_write_data
argument_list|(
name|rs
argument_list|,
operator|&
name|sge
argument_list|,
literal|1
argument_list|,
name|xfer_size
argument_list|,
name|IBV_SEND_INLINE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xfer_size
operator|<=
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
argument_list|,
name|buf
argument_list|,
name|xfer_size
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|xfer_size
expr_stmt|;
name|ret
operator|=
name|rs_write_data
argument_list|(
name|rs
argument_list|,
name|rs
operator|->
name|ssgl
argument_list|,
literal|1
argument_list|,
name|xfer_size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer_size
operator|<
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
condition|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|+=
name|xfer_size
expr_stmt|;
else|else
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|sbuf
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
argument_list|,
name|buf
argument_list|,
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
operator|=
name|xfer_size
operator|-
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|rs
operator|->
name|sbuf
argument_list|,
name|buf
operator|+
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
argument_list|,
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rs_write_data
argument_list|(
name|rs
argument_list|,
name|rs
operator|->
name|ssgl
argument_list|,
literal|2
argument_list|,
name|xfer_size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|sbuf
operator|+
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
break|break;
block|}
name|out
label|:
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|&&
name|left
operator|==
name|len
operator|)
condition|?
name|ret
else|:
name|len
operator|-
name|left
return|;
block|}
end_function

begin_function
name|ssize_t
name|rsendto
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|dest_addr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|rs
operator|=
name|idm_at
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
if|if
condition|(
name|dest_addr
operator|||
name|addrlen
condition|)
return|return
name|ERR
argument_list|(
name|EISCONN
argument_list|)
return|;
return|return
name|rsend
argument_list|(
name|socket
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
return|;
block|}
if|if
condition|(
name|rs
operator|->
name|state
operator|==
name|rs_init
condition|)
block|{
name|ret
operator|=
name|ds_init_ep
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|conn_dest
operator|||
name|ds_compare_addr
argument_list|(
name|dest_addr
argument_list|,
operator|&
name|rs
operator|->
name|conn_dest
operator|->
name|addr
argument_list|)
condition|)
block|{
name|ret
operator|=
name|ds_get_dest
argument_list|(
name|rs
argument_list|,
name|dest_addr
argument_list|,
name|addrlen
argument_list|,
operator|&
name|rs
operator|->
name|conn_dest
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|dsend
argument_list|(
name|rs
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|out
label|:
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_copy_iov
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|iovec
modifier|*
modifier|*
name|iov
parameter_list|,
name|size_t
modifier|*
name|offset
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
while|while
condition|(
name|len
condition|)
block|{
name|size
operator|=
operator|(
operator|*
name|iov
operator|)
operator|->
name|iov_len
operator|-
operator|*
name|offset
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|len
condition|)
block|{
name|memcpy
argument_list|(
name|dst
argument_list|,
operator|(
operator|*
name|iov
operator|)
operator|->
name|iov_base
operator|+
operator|*
name|offset
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|offset
operator|+=
name|len
expr_stmt|;
break|break;
block|}
name|memcpy
argument_list|(
name|dst
argument_list|,
operator|(
operator|*
name|iov
operator|)
operator|->
name|iov_base
operator|+
operator|*
name|offset
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|len
operator|-=
name|size
expr_stmt|;
name|dst
operator|+=
name|size
expr_stmt|;
operator|(
operator|*
name|iov
operator|)
operator|++
expr_stmt|;
operator|*
name|offset
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|rsendv
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
name|iovcnt
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
specifier|const
name|struct
name|iovec
modifier|*
name|cur_iov
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|,
name|offset
init|=
literal|0
decl_stmt|;
name|uint32_t
name|xfer_size
decl_stmt|,
name|olen
init|=
name|RS_OLAP_START_SIZE
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|rs
operator|=
name|idm_at
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_opening
condition|)
block|{
name|ret
operator|=
name|rs_do_connect
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINPROGRESS
condition|)
name|errno
operator|=
name|EAGAIN
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|cur_iov
operator|=
name|iov
expr_stmt|;
name|len
operator|=
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|iovcnt
condition|;
name|i
operator|++
control|)
name|len
operator|+=
name|iov
index|[
name|i
index|]
operator|.
name|iov_len
expr_stmt|;
name|left
operator|=
name|len
expr_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|iomap_pending
condition|)
block|{
name|ret
operator|=
name|rs_send_iomaps
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
for|for
control|(
init|;
name|left
condition|;
name|left
operator|-=
name|xfer_size
control|)
block|{
if|if
condition|(
operator|!
name|rs_can_send
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
name|rs_get_comp
argument_list|(
name|rs
argument_list|,
name|rs_nonblocking
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
argument_list|,
name|rs_conn_can_send
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_writable
operator|)
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|ECONNRESET
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|olen
operator|<
name|left
condition|)
block|{
name|xfer_size
operator|=
name|olen
expr_stmt|;
if|if
condition|(
name|olen
operator|<
name|RS_MAX_TRANSFER
condition|)
name|olen
operator|<<=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|xfer_size
operator|=
name|left
expr_stmt|;
block|}
if|if
condition|(
name|xfer_size
operator|>
name|rs
operator|->
name|sbuf_bytes_avail
condition|)
name|xfer_size
operator|=
name|rs
operator|->
name|sbuf_bytes_avail
expr_stmt|;
if|if
condition|(
name|xfer_size
operator|>
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|length
condition|)
name|xfer_size
operator|=
name|rs
operator|->
name|target_sgl
index|[
name|rs
operator|->
name|target_sge
index|]
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|xfer_size
operator|<=
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|rs_copy_iov
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
argument_list|,
operator|&
name|cur_iov
argument_list|,
operator|&
name|offset
argument_list|,
name|xfer_size
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|xfer_size
expr_stmt|;
name|ret
operator|=
name|rs_write_data
argument_list|(
name|rs
argument_list|,
name|rs
operator|->
name|ssgl
argument_list|,
literal|1
argument_list|,
name|xfer_size
argument_list|,
name|xfer_size
operator|<=
name|rs
operator|->
name|sq_inline
condition|?
name|IBV_SEND_INLINE
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer_size
operator|<
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
condition|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|+=
name|xfer_size
expr_stmt|;
else|else
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|sbuf
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|rs_copy_iov
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
argument_list|,
operator|&
name|cur_iov
argument_list|,
operator|&
name|offset
argument_list|,
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
operator|=
name|xfer_size
operator|-
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
expr_stmt|;
name|rs_copy_iov
argument_list|(
name|rs
operator|->
name|sbuf
argument_list|,
operator|&
name|cur_iov
argument_list|,
operator|&
name|offset
argument_list|,
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rs_write_data
argument_list|(
name|rs
argument_list|,
name|rs
operator|->
name|ssgl
argument_list|,
literal|2
argument_list|,
name|xfer_size
argument_list|,
name|xfer_size
operator|<=
name|rs
operator|->
name|sq_inline
condition|?
name|IBV_SEND_INLINE
else|:
literal|0
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|sbuf
operator|+
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
break|break;
block|}
name|out
label|:
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|&&
name|left
operator|==
name|len
operator|)
condition|?
name|ret
else|:
name|len
operator|-
name|left
return|;
block|}
end_function

begin_function
name|ssize_t
name|rsendmsg
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|struct
name|msghdr
modifier|*
name|msg
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|->
name|msg_control
operator|&&
name|msg
operator|->
name|msg_controllen
condition|)
return|return
name|ERR
argument_list|(
name|ENOTSUP
argument_list|)
return|;
return|return
name|rsendv
argument_list|(
name|socket
argument_list|,
name|msg
operator|->
name|msg_iov
argument_list|,
operator|(
name|int
operator|)
name|msg
operator|->
name|msg_iovlen
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|rwrite
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
return|return
name|rsend
argument_list|(
name|socket
argument_list|,
name|buf
argument_list|,
name|count
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|rwritev
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
name|iovcnt
parameter_list|)
block|{
return|return
name|rsendv
argument_list|(
name|socket
argument_list|,
name|iov
argument_list|,
name|iovcnt
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pollfd
modifier|*
name|rs_fds_alloc
parameter_list|(
name|nfds_t
name|nfds
parameter_list|)
block|{
specifier|static
name|__thread
expr|struct
name|pollfd
operator|*
name|rfds
expr_stmt|;
specifier|static
name|__thread
name|nfds_t
name|rnfds
decl_stmt|;
if|if
condition|(
name|nfds
operator|>
name|rnfds
condition|)
block|{
if|if
condition|(
name|rfds
condition|)
name|free
argument_list|(
name|rfds
argument_list|)
expr_stmt|;
name|rfds
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rfds
argument_list|)
operator|*
name|nfds
argument_list|)
expr_stmt|;
name|rnfds
operator|=
name|rfds
condition|?
name|nfds
else|:
literal|0
expr_stmt|;
block|}
return|return
name|rfds
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_poll_rs
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|events
parameter_list|,
name|int
name|nonblock
parameter_list|,
name|int
function_decl|(
modifier|*
name|test
function_decl|)
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
parameter_list|)
block|{
name|struct
name|pollfd
name|fds
decl_stmt|;
name|short
name|revents
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|check_cq
label|:
if|if
condition|(
operator|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
operator|)
operator|&&
operator|(
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
operator|||
operator|(
name|rs
operator|->
name|state
operator|==
name|rs_disconnected
operator|)
operator|||
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_error
operator|)
operator|)
condition|)
block|{
name|rs_process_cq
argument_list|(
name|rs
argument_list|,
name|nonblock
argument_list|,
name|test
argument_list|)
expr_stmt|;
name|revents
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|events
operator|&
name|POLLIN
operator|)
operator|&&
name|rs_conn_have_rdata
argument_list|(
name|rs
argument_list|)
condition|)
name|revents
operator||=
name|POLLIN
expr_stmt|;
if|if
condition|(
operator|(
name|events
operator|&
name|POLLOUT
operator|)
operator|&&
name|rs_can_send
argument_list|(
name|rs
argument_list|)
condition|)
name|revents
operator||=
name|POLLOUT
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|state
operator|==
name|rs_disconnected
condition|)
name|revents
operator||=
name|POLLHUP
expr_stmt|;
else|else
name|revents
operator||=
name|POLLERR
expr_stmt|;
block|}
return|return
name|revents
return|;
block|}
elseif|else
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|ds_process_cqs
argument_list|(
name|rs
argument_list|,
name|nonblock
argument_list|,
name|test
argument_list|)
expr_stmt|;
name|revents
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|events
operator|&
name|POLLIN
operator|)
operator|&&
name|rs_have_rdata
argument_list|(
name|rs
argument_list|)
condition|)
name|revents
operator||=
name|POLLIN
expr_stmt|;
if|if
condition|(
operator|(
name|events
operator|&
name|POLLOUT
operator|)
operator|&&
name|ds_can_send
argument_list|(
name|rs
argument_list|)
condition|)
name|revents
operator||=
name|POLLOUT
expr_stmt|;
return|return
name|revents
return|;
block|}
if|if
condition|(
name|rs
operator|->
name|state
operator|==
name|rs_listening
condition|)
block|{
name|fds
operator|.
name|fd
operator|=
name|rs
operator|->
name|cm_id
operator|->
name|channel
operator|->
name|fd
expr_stmt|;
name|fds
operator|.
name|events
operator|=
name|events
expr_stmt|;
name|fds
operator|.
name|revents
operator|=
literal|0
expr_stmt|;
name|poll
argument_list|(
operator|&
name|fds
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|fds
operator|.
name|revents
return|;
block|}
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_opening
condition|)
block|{
name|ret
operator|=
name|rs_do_connect
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
operator|(
name|errno
operator|==
name|EINPROGRESS
operator|)
condition|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|check_cq
goto|;
block|}
block|}
if|if
condition|(
name|rs
operator|->
name|state
operator|==
name|rs_connect_error
condition|)
block|{
name|revents
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|events
operator|&
name|POLLOUT
condition|)
name|revents
operator||=
name|POLLOUT
expr_stmt|;
if|if
condition|(
name|events
operator|&
name|POLLIN
condition|)
name|revents
operator||=
name|POLLIN
expr_stmt|;
name|revents
operator||=
name|POLLERR
expr_stmt|;
return|return
name|revents
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_poll_check
parameter_list|(
name|struct
name|pollfd
modifier|*
name|fds
parameter_list|,
name|nfds_t
name|nfds
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfds
condition|;
name|i
operator|++
control|)
block|{
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|fds
index|[
name|i
index|]
operator|.
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
condition|)
name|fds
index|[
name|i
index|]
operator|.
name|revents
operator|=
name|rs_poll_rs
argument_list|(
name|rs
argument_list|,
name|fds
index|[
name|i
index|]
operator|.
name|events
argument_list|,
literal|1
argument_list|,
name|rs_poll_all
argument_list|)
expr_stmt|;
else|else
name|poll
argument_list|(
operator|&
name|fds
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fds
index|[
name|i
index|]
operator|.
name|revents
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
return|return
name|cnt
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_poll_arm
parameter_list|(
name|struct
name|pollfd
modifier|*
name|rfds
parameter_list|,
name|struct
name|pollfd
modifier|*
name|fds
parameter_list|,
name|nfds_t
name|nfds
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfds
condition|;
name|i
operator|++
control|)
block|{
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|fds
index|[
name|i
index|]
operator|.
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
condition|)
block|{
name|fds
index|[
name|i
index|]
operator|.
name|revents
operator|=
name|rs_poll_rs
argument_list|(
name|rs
argument_list|,
name|fds
index|[
name|i
index|]
operator|.
name|events
argument_list|,
literal|0
argument_list|,
name|rs_is_cq_armed
argument_list|)
expr_stmt|;
if|if
condition|(
name|fds
index|[
name|i
index|]
operator|.
name|revents
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|state
operator|>=
name|rs_connected
condition|)
name|rfds
index|[
name|i
index|]
operator|.
name|fd
operator|=
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq_channel
operator|->
name|fd
expr_stmt|;
else|else
name|rfds
index|[
name|i
index|]
operator|.
name|fd
operator|=
name|rs
operator|->
name|cm_id
operator|->
name|channel
operator|->
name|fd
expr_stmt|;
block|}
else|else
block|{
name|rfds
index|[
name|i
index|]
operator|.
name|fd
operator|=
name|rs
operator|->
name|epfd
expr_stmt|;
block|}
name|rfds
index|[
name|i
index|]
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
block|}
else|else
block|{
name|rfds
index|[
name|i
index|]
operator|.
name|fd
operator|=
name|fds
index|[
name|i
index|]
operator|.
name|fd
expr_stmt|;
name|rfds
index|[
name|i
index|]
operator|.
name|events
operator|=
name|fds
index|[
name|i
index|]
operator|.
name|events
expr_stmt|;
block|}
name|rfds
index|[
name|i
index|]
operator|.
name|revents
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_poll_events
parameter_list|(
name|struct
name|pollfd
modifier|*
name|rfds
parameter_list|,
name|struct
name|pollfd
modifier|*
name|fds
parameter_list|,
name|nfds_t
name|nfds
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfds
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|rfds
index|[
name|i
index|]
operator|.
name|revents
condition|)
continue|continue;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|fds
index|[
name|i
index|]
operator|.
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
condition|)
block|{
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|cq_wait_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
name|rs_get_cq_event
argument_list|(
name|rs
argument_list|)
expr_stmt|;
else|else
name|ds_get_cq_event
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|cq_wait_lock
argument_list|)
expr_stmt|;
name|fds
index|[
name|i
index|]
operator|.
name|revents
operator|=
name|rs_poll_rs
argument_list|(
name|rs
argument_list|,
name|fds
index|[
name|i
index|]
operator|.
name|events
argument_list|,
literal|1
argument_list|,
name|rs_poll_all
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fds
index|[
name|i
index|]
operator|.
name|revents
operator|=
name|rfds
index|[
name|i
index|]
operator|.
name|revents
expr_stmt|;
block|}
if|if
condition|(
name|fds
index|[
name|i
index|]
operator|.
name|revents
condition|)
name|cnt
operator|++
expr_stmt|;
block|}
return|return
name|cnt
return|;
block|}
end_function

begin_comment
comment|/*  * We need to poll *all* fd's that the user specifies at least once.  * Note that we may receive events on an rsocket that may not be reported  * to the user (e.g. connection events or credit updates).  Process those  * events, then return to polling until we find ones of interest.  */
end_comment

begin_function
name|int
name|rpoll
parameter_list|(
name|struct
name|pollfd
modifier|*
name|fds
parameter_list|,
name|nfds_t
name|nfds
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|struct
name|timeval
name|s
decl_stmt|,
name|e
decl_stmt|;
name|struct
name|pollfd
modifier|*
name|rfds
decl_stmt|;
name|uint32_t
name|poll_time
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
do|do
block|{
name|ret
operator|=
name|rs_poll_check
argument_list|(
name|fds
argument_list|,
name|nfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|||
operator|!
name|timeout
condition|)
return|return
name|ret
return|;
if|if
condition|(
operator|!
name|poll_time
condition|)
name|gettimeofday
argument_list|(
operator|&
name|s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|poll_time
operator|=
operator|(
name|e
operator|.
name|tv_sec
operator|-
name|s
operator|.
name|tv_sec
operator|)
operator|*
literal|1000000
operator|+
operator|(
name|e
operator|.
name|tv_usec
operator|-
name|s
operator|.
name|tv_usec
operator|)
operator|+
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|poll_time
operator|<=
name|polling_time
condition|)
do|;
name|rfds
operator|=
name|rs_fds_alloc
argument_list|(
name|nfds
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rfds
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
do|do
block|{
name|ret
operator|=
name|rs_poll_arm
argument_list|(
name|rfds
argument_list|,
name|fds
argument_list|,
name|nfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
name|ret
operator|=
name|poll
argument_list|(
name|rfds
argument_list|,
name|nfds
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
break|break;
name|ret
operator|=
name|rs_poll_events
argument_list|(
name|rfds
argument_list|,
name|fds
argument_list|,
name|nfds
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|ret
condition|)
do|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pollfd
modifier|*
name|rs_select_to_poll
parameter_list|(
name|int
modifier|*
name|nfds
parameter_list|,
name|fd_set
modifier|*
name|readfds
parameter_list|,
name|fd_set
modifier|*
name|writefds
parameter_list|,
name|fd_set
modifier|*
name|exceptfds
parameter_list|)
block|{
name|struct
name|pollfd
modifier|*
name|fds
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|;
name|fds
operator|=
name|calloc
argument_list|(
operator|*
name|nfds
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fds
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fds
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|fd
operator|=
literal|0
init|;
name|fd
operator|<
operator|*
name|nfds
condition|;
name|fd
operator|++
control|)
block|{
if|if
condition|(
name|readfds
operator|&&
name|FD_ISSET
argument_list|(
name|fd
argument_list|,
name|readfds
argument_list|)
condition|)
block|{
name|fds
index|[
name|i
index|]
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
name|fds
index|[
name|i
index|]
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
block|}
if|if
condition|(
name|writefds
operator|&&
name|FD_ISSET
argument_list|(
name|fd
argument_list|,
name|writefds
argument_list|)
condition|)
block|{
name|fds
index|[
name|i
index|]
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
name|fds
index|[
name|i
index|]
operator|.
name|events
operator||=
name|POLLOUT
expr_stmt|;
block|}
if|if
condition|(
name|exceptfds
operator|&&
name|FD_ISSET
argument_list|(
name|fd
argument_list|,
name|exceptfds
argument_list|)
condition|)
name|fds
index|[
name|i
index|]
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
if|if
condition|(
name|fds
index|[
name|i
index|]
operator|.
name|fd
condition|)
name|i
operator|++
expr_stmt|;
block|}
operator|*
name|nfds
operator|=
name|i
expr_stmt|;
return|return
name|fds
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_poll_to_select
parameter_list|(
name|int
name|nfds
parameter_list|,
name|struct
name|pollfd
modifier|*
name|fds
parameter_list|,
name|fd_set
modifier|*
name|readfds
parameter_list|,
name|fd_set
modifier|*
name|writefds
parameter_list|,
name|fd_set
modifier|*
name|exceptfds
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfds
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|readfds
operator|&&
operator|(
name|fds
index|[
name|i
index|]
operator|.
name|revents
operator|&
operator|(
name|POLLIN
operator||
name|POLLHUP
operator|)
operator|)
condition|)
block|{
name|FD_SET
argument_list|(
name|fds
index|[
name|i
index|]
operator|.
name|fd
argument_list|,
name|readfds
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|writefds
operator|&&
operator|(
name|fds
index|[
name|i
index|]
operator|.
name|revents
operator|&
name|POLLOUT
operator|)
condition|)
block|{
name|FD_SET
argument_list|(
name|fds
index|[
name|i
index|]
operator|.
name|fd
argument_list|,
name|writefds
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|exceptfds
operator|&&
operator|(
name|fds
index|[
name|i
index|]
operator|.
name|revents
operator|&
operator|~
operator|(
name|POLLIN
operator||
name|POLLOUT
operator|)
operator|)
condition|)
block|{
name|FD_SET
argument_list|(
name|fds
index|[
name|i
index|]
operator|.
name|fd
argument_list|,
name|exceptfds
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
block|}
return|return
name|cnt
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_convert_timeout
parameter_list|(
name|struct
name|timeval
modifier|*
name|timeout
parameter_list|)
block|{
return|return
operator|!
name|timeout
condition|?
operator|-
literal|1
else|:
name|timeout
operator|->
name|tv_sec
operator|*
literal|1000
operator|+
name|timeout
operator|->
name|tv_usec
operator|/
literal|1000
return|;
block|}
end_function

begin_function
name|int
name|rselect
parameter_list|(
name|int
name|nfds
parameter_list|,
name|fd_set
modifier|*
name|readfds
parameter_list|,
name|fd_set
modifier|*
name|writefds
parameter_list|,
name|fd_set
modifier|*
name|exceptfds
parameter_list|,
name|struct
name|timeval
modifier|*
name|timeout
parameter_list|)
block|{
name|struct
name|pollfd
modifier|*
name|fds
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|fds
operator|=
name|rs_select_to_poll
argument_list|(
operator|&
name|nfds
argument_list|,
name|readfds
argument_list|,
name|writefds
argument_list|,
name|exceptfds
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fds
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|ret
operator|=
name|rpoll
argument_list|(
name|fds
argument_list|,
name|nfds
argument_list|,
name|rs_convert_timeout
argument_list|(
name|timeout
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|readfds
condition|)
name|FD_ZERO
argument_list|(
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|writefds
condition|)
name|FD_ZERO
argument_list|(
name|writefds
argument_list|)
expr_stmt|;
if|if
condition|(
name|exceptfds
condition|)
name|FD_ZERO
argument_list|(
name|exceptfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
name|ret
operator|=
name|rs_poll_to_select
argument_list|(
name|nfds
argument_list|,
name|fds
argument_list|,
name|readfds
argument_list|,
name|writefds
argument_list|,
name|exceptfds
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fds
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * For graceful disconnect, notify the remote side that we're  * disconnecting and wait until all outstanding sends complete, provided  * that the remote side has not sent a disconnect message.  */
end_comment

begin_function
name|int
name|rshutdown
parameter_list|(
name|int
name|socket
parameter_list|,
name|int
name|how
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|ctrl
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
if|if
condition|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_SVC_ACTIVE
condition|)
name|rs_notify_svc
argument_list|(
operator|&
name|tcp_svc
argument_list|,
name|rs
argument_list|,
name|RS_SVC_REM_KEEPALIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|fd_flags
operator|&
name|O_NONBLOCK
condition|)
name|rs_set_nonblocking
argument_list|(
name|rs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
condition|)
block|{
if|if
condition|(
name|how
operator|==
name|SHUT_RDWR
condition|)
block|{
name|ctrl
operator|=
name|RS_CTRL_DISCONNECT
expr_stmt|;
name|rs
operator|->
name|state
operator|&=
operator|~
operator|(
name|rs_readable
operator||
name|rs_writable
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|how
operator|==
name|SHUT_WR
condition|)
block|{
name|rs
operator|->
name|state
operator|&=
operator|~
name|rs_writable
expr_stmt|;
name|ctrl
operator|=
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_readable
operator|)
condition|?
name|RS_CTRL_SHUTDOWN
else|:
name|RS_CTRL_DISCONNECT
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|state
operator|&=
operator|~
name|rs_readable
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_writable
condition|)
goto|goto
name|out
goto|;
name|ctrl
operator|=
name|RS_CTRL_DISCONNECT
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rs_ctrl_avail
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
name|rs_process_cq
argument_list|(
name|rs
argument_list|,
literal|0
argument_list|,
name|rs_conn_can_send_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
operator|&&
name|rs_ctrl_avail
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|rs
operator|->
name|ctrl_seqno
operator|++
expr_stmt|;
name|ret
operator|=
name|rs_post_msg
argument_list|(
name|rs
argument_list|,
name|rs_msg_set
argument_list|(
name|RS_OP_CTRL
argument_list|,
name|ctrl
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
condition|)
name|rs_process_cq
argument_list|(
name|rs
argument_list|,
literal|0
argument_list|,
name|rs_conn_all_sends_done
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
operator|(
name|rs
operator|->
name|fd_flags
operator|&
name|O_NONBLOCK
operator|)
operator|&&
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
condition|)
name|rs_set_nonblocking
argument_list|(
name|rs
argument_list|,
name|rs
operator|->
name|fd_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_disconnected
condition|)
block|{
comment|/* Generate event by flushing receives to unblock rpoll */
name|ibv_req_notify_cq
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|recv_cq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ucma_shutdown
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_shutdown
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
if|if
condition|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_SVC_ACTIVE
condition|)
name|rs_notify_svc
argument_list|(
operator|&
name|udp_svc
argument_list|,
name|rs
argument_list|,
name|RS_SVC_REM_DGRAM
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|fd_flags
operator|&
name|O_NONBLOCK
condition|)
name|rs_set_nonblocking
argument_list|(
name|rs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rs
operator|->
name|state
operator|&=
operator|~
operator|(
name|rs_readable
operator||
name|rs_writable
operator|)
expr_stmt|;
name|ds_process_cqs
argument_list|(
name|rs
argument_list|,
literal|0
argument_list|,
name|ds_all_sends_done
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|fd_flags
operator|&
name|O_NONBLOCK
condition|)
name|rs_set_nonblocking
argument_list|(
name|rs
argument_list|,
name|rs
operator|->
name|fd_flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rclose
parameter_list|(
name|int
name|socket
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|EBADF
return|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
condition|)
name|rshutdown
argument_list|(
name|socket
argument_list|,
name|SHUT_RDWR
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_SVC_ACTIVE
condition|)
name|rs_notify_svc
argument_list|(
operator|&
name|tcp_svc
argument_list|,
name|rs
argument_list|,
name|RS_SVC_REM_KEEPALIVE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ds_shutdown
argument_list|(
name|rs
argument_list|)
expr_stmt|;
block|}
name|rs_free
argument_list|(
name|rs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_copy_addr
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|dst
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|src
parameter_list|,
name|socklen_t
modifier|*
name|len
parameter_list|)
block|{
name|socklen_t
name|size
decl_stmt|;
if|if
condition|(
name|src
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|size
operator|=
name|min_t
argument_list|(
name|socklen_t
argument_list|,
operator|*
name|len
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size
operator|=
name|min_t
argument_list|(
name|socklen_t
argument_list|,
operator|*
name|len
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rgetpeername
parameter_list|(
name|int
name|socket
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
modifier|*
name|addrlen
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|rs_copy_addr
argument_list|(
name|addr
argument_list|,
name|rdma_get_peer_addr
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
return|return
name|getpeername
argument_list|(
name|rs
operator|->
name|udp_sock
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|int
name|rgetsockname
parameter_list|(
name|int
name|socket
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
modifier|*
name|addrlen
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|rs_copy_addr
argument_list|(
name|addr
argument_list|,
name|rdma_get_local_addr
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|)
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
return|return
name|getsockname
argument_list|(
name|rs
operator|->
name|udp_sock
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rs_set_keepalive
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|on
operator|&&
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_SVC_ACTIVE
operator|)
operator|)
operator|||
operator|(
operator|!
name|on
operator|&&
operator|!
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_SVC_ACTIVE
operator|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|on
condition|)
block|{
if|if
condition|(
operator|!
name|rs
operator|->
name|keepalive_time
condition|)
block|{
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
literal|"/proc/sys/net/ipv4/tcp_keepalive_time"
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"%u"
argument_list|,
operator|&
name|rs
operator|->
name|keepalive_time
argument_list|)
operator|!=
literal|1
condition|)
name|rs
operator|->
name|keepalive_time
operator|=
literal|7200
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|keepalive_time
operator|=
literal|7200
expr_stmt|;
block|}
block|}
name|ret
operator|=
name|rs_notify_svc
argument_list|(
operator|&
name|tcp_svc
argument_list|,
name|rs
argument_list|,
name|RS_SVC_ADD_KEEPALIVE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|rs_notify_svc
argument_list|(
operator|&
name|tcp_svc
argument_list|,
name|rs
argument_list|,
name|RS_SVC_REM_KEEPALIVE
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|rsetsockopt
parameter_list|(
name|int
name|socket
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|optname
parameter_list|,
specifier|const
name|void
modifier|*
name|optval
parameter_list|,
name|socklen_t
name|optlen
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|opt_on
init|=
literal|0
decl_stmt|;
name|uint64_t
modifier|*
name|opts
init|=
name|NULL
decl_stmt|;
name|ret
operator|=
name|ERR
argument_list|(
name|ENOTSUP
argument_list|)
expr_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_DGRAM
operator|&&
name|level
operator|!=
name|SOL_RDMA
condition|)
block|{
name|ret
operator|=
name|setsockopt
argument_list|(
name|rs
operator|->
name|udp_sock
argument_list|,
name|level
argument_list|,
name|optname
argument_list|,
name|optval
argument_list|,
name|optlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
switch|switch
condition|(
name|level
condition|)
block|{
case|case
name|SOL_SOCKET
case|:
name|opts
operator|=
operator|&
name|rs
operator|->
name|so_opts
expr_stmt|;
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|SO_REUSEADDR
case|:
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|ret
operator|=
name|rdma_set_option
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|RDMA_OPTION_ID
argument_list|,
name|RDMA_OPTION_ID_REUSEADDR
argument_list|,
operator|(
name|void
operator|*
operator|)
name|optval
argument_list|,
name|optlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
operator|(
operator|(
name|errno
operator|==
name|ENOSYS
operator|)
operator|||
operator|(
operator|(
name|rs
operator|->
name|state
operator|!=
name|rs_init
operator|)
operator|&&
name|rs
operator|->
name|cm_id
operator|->
name|context
operator|&&
operator|(
name|rs
operator|->
name|cm_id
operator|->
name|verbs
operator|->
name|device
operator|->
name|transport_type
operator|==
name|IBV_TRANSPORT_IB
operator|)
operator|)
operator|)
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|opt_on
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|optval
expr_stmt|;
break|break;
case|case
name|SO_RCVBUF
case|:
if|if
condition|(
operator|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
operator|&&
operator|!
name|rs
operator|->
name|rbuf
operator|)
operator|||
operator|(
name|rs
operator|->
name|type
operator|==
name|SOCK_DGRAM
operator|&&
operator|!
name|rs
operator|->
name|qp_list
operator|)
condition|)
name|rs
operator|->
name|rbuf_size
operator|=
operator|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|optval
operator|)
operator|<<
literal|1
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SO_SNDBUF
case|:
if|if
condition|(
operator|!
name|rs
operator|->
name|sbuf
condition|)
name|rs
operator|->
name|sbuf_size
operator|=
operator|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|optval
operator|)
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|sbuf_size
operator|<
name|RS_SNDLOWAT
condition|)
name|rs
operator|->
name|sbuf_size
operator|=
name|RS_SNDLOWAT
operator|<<
literal|1
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SO_LINGER
case|:
comment|/* Invert value so default so_opt = 0 is on */
name|opt_on
operator|=
operator|!
operator|(
operator|(
expr|struct
name|linger
operator|*
operator|)
name|optval
operator|)
operator|->
name|l_onoff
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SO_KEEPALIVE
case|:
name|ret
operator|=
name|rs_set_keepalive
argument_list|(
name|rs
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|optval
argument_list|)
expr_stmt|;
name|opt_on
operator|=
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_SVC_ACTIVE
expr_stmt|;
break|break;
case|case
name|SO_OOBINLINE
case|:
name|opt_on
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|optval
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|IPPROTO_TCP
case|:
name|opts
operator|=
operator|&
name|rs
operator|->
name|tcp_opts
expr_stmt|;
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|TCP_KEEPCNT
case|:
case|case
name|TCP_KEEPINTVL
case|:
name|ret
operator|=
literal|0
expr_stmt|;
comment|/* N/A - we're using a reliable connection */
break|break;
case|case
name|TCP_KEEPIDLE
case|:
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|optval
operator|<=
literal|0
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
break|break;
block|}
name|rs
operator|->
name|keepalive_time
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|optval
expr_stmt|;
name|ret
operator|=
operator|(
name|rs
operator|->
name|opts
operator|&
name|RS_OPT_SVC_ACTIVE
operator|)
condition|?
name|rs_notify_svc
argument_list|(
operator|&
name|tcp_svc
argument_list|,
name|rs
argument_list|,
name|RS_SVC_MOD_KEEPALIVE
argument_list|)
else|:
literal|0
expr_stmt|;
break|break;
case|case
name|TCP_NODELAY
case|:
name|opt_on
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|optval
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|TCP_MAXSEG
case|:
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|IPPROTO_IPV6
case|:
name|opts
operator|=
operator|&
name|rs
operator|->
name|ipv6_opts
expr_stmt|;
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|IPV6_V6ONLY
case|:
if|if
condition|(
name|rs
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|ret
operator|=
name|rdma_set_option
argument_list|(
name|rs
operator|->
name|cm_id
argument_list|,
name|RDMA_OPTION_ID
argument_list|,
name|RDMA_OPTION_ID_AFONLY
argument_list|,
operator|(
name|void
operator|*
operator|)
name|optval
argument_list|,
name|optlen
argument_list|)
expr_stmt|;
block|}
name|opt_on
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|optval
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|SOL_RDMA
case|:
if|if
condition|(
name|rs
operator|->
name|state
operator|>=
name|rs_opening
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|RDMA_SQSIZE
case|:
name|rs
operator|->
name|sq_size
operator|=
name|min_t
argument_list|(
name|uint32_t
argument_list|,
operator|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|optval
operator|)
argument_list|,
name|RS_QP_MAX_SIZE
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|RDMA_RQSIZE
case|:
name|rs
operator|->
name|rq_size
operator|=
name|min_t
argument_list|(
name|uint32_t
argument_list|,
operator|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|optval
operator|)
argument_list|,
name|RS_QP_MAX_SIZE
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|RDMA_INLINE
case|:
name|rs
operator|->
name|sq_inline
operator|=
name|min_t
argument_list|(
name|uint32_t
argument_list|,
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|optval
argument_list|,
name|RS_QP_MAX_SIZE
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|RDMA_IOMAPSIZE
case|:
name|rs
operator|->
name|target_iomap_size
operator|=
operator|(
name|uint16_t
operator|)
name|rs_scale_to_value
argument_list|(
operator|(
name|uint8_t
operator|)
name|rs_value_to_scale
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|optval
argument_list|,
literal|8
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|RDMA_ROUTE
case|:
if|if
condition|(
operator|(
name|rs
operator|->
name|optval
operator|=
name|malloc
argument_list|(
name|optlen
argument_list|)
operator|)
condition|)
block|{
name|memcpy
argument_list|(
name|rs
operator|->
name|optval
argument_list|,
name|optval
argument_list|,
name|optlen
argument_list|)
expr_stmt|;
name|rs
operator|->
name|optlen
operator|=
name|optlen
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
break|break;
default|default:
break|break;
block|}
if|if
condition|(
operator|!
name|ret
operator|&&
name|opts
condition|)
block|{
if|if
condition|(
name|opt_on
condition|)
operator|*
name|opts
operator||=
operator|(
literal|1
operator|<<
name|optname
operator|)
expr_stmt|;
else|else
operator|*
name|opts
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|optname
operator|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rs_convert_sa_path
parameter_list|(
name|struct
name|ibv_sa_path_rec
modifier|*
name|sa_path
parameter_list|,
name|struct
name|ibv_path_data
modifier|*
name|path_data
parameter_list|)
block|{
name|uint32_t
name|fl_hop
decl_stmt|;
name|memset
argument_list|(
name|path_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|path_data
argument_list|)
argument_list|)
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|dgid
operator|=
name|sa_path
operator|->
name|dgid
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|sgid
operator|=
name|sa_path
operator|->
name|sgid
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|dlid
operator|=
name|sa_path
operator|->
name|dlid
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|slid
operator|=
name|sa_path
operator|->
name|slid
expr_stmt|;
name|fl_hop
operator|=
name|be32toh
argument_list|(
name|sa_path
operator|->
name|flow_label
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|flowlabel_hoplimit
operator|=
name|htobe32
argument_list|(
name|fl_hop
operator||
name|sa_path
operator|->
name|hop_limit
argument_list|)
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|tclass
operator|=
name|sa_path
operator|->
name|traffic_class
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|reversible_numpath
operator|=
name|sa_path
operator|->
name|reversible
operator|<<
literal|7
operator||
literal|1
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|pkey
operator|=
name|sa_path
operator|->
name|pkey
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|qosclass_sl
operator|=
name|htobe16
argument_list|(
name|sa_path
operator|->
name|sl
argument_list|)
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|mtu
operator|=
name|sa_path
operator|->
name|mtu
operator||
literal|2
operator|<<
literal|6
expr_stmt|;
comment|/* exactly */
name|path_data
operator|->
name|path
operator|.
name|rate
operator|=
name|sa_path
operator|->
name|rate
operator||
literal|2
operator|<<
literal|6
expr_stmt|;
name|path_data
operator|->
name|path
operator|.
name|packetlifetime
operator|=
name|sa_path
operator|->
name|packet_life_time
operator||
literal|2
operator|<<
literal|6
expr_stmt|;
name|path_data
operator|->
name|flags
operator|=
name|sa_path
operator|->
name|preference
expr_stmt|;
block|}
end_function

begin_function
name|int
name|rgetsockopt
parameter_list|(
name|int
name|socket
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|optname
parameter_list|,
name|void
modifier|*
name|optval
parameter_list|,
name|socklen_t
modifier|*
name|optlen
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|void
modifier|*
name|opt
decl_stmt|;
name|struct
name|ibv_sa_path_rec
modifier|*
name|path_rec
decl_stmt|;
name|struct
name|ibv_path_data
name|path_data
decl_stmt|;
name|socklen_t
name|len
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|num_paths
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
switch|switch
condition|(
name|level
condition|)
block|{
case|case
name|SOL_SOCKET
case|:
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|SO_REUSEADDR
case|:
case|case
name|SO_KEEPALIVE
case|:
case|case
name|SO_OOBINLINE
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
operator|!
operator|!
operator|(
name|rs
operator|->
name|so_opts
operator|&
operator|(
literal|1
operator|<<
name|optname
operator|)
operator|)
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|SO_RCVBUF
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
name|rs
operator|->
name|rbuf_size
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|SO_SNDBUF
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
name|rs
operator|->
name|sbuf_size
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|SO_LINGER
case|:
comment|/* Value is inverted so default so_opt = 0 is on */
operator|(
operator|(
expr|struct
name|linger
operator|*
operator|)
name|optval
operator|)
operator|->
name|l_onoff
operator|=
operator|!
operator|(
name|rs
operator|->
name|so_opts
operator|&
operator|(
literal|1
operator|<<
name|optname
operator|)
operator|)
expr_stmt|;
operator|(
operator|(
expr|struct
name|linger
operator|*
operator|)
name|optval
operator|)
operator|->
name|l_linger
operator|=
literal|0
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|linger
argument_list|)
expr_stmt|;
break|break;
case|case
name|SO_ERROR
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
name|rs
operator|->
name|err
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|rs
operator|->
name|err
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|ENOTSUP
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|IPPROTO_TCP
case|:
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|TCP_KEEPCNT
case|:
case|case
name|TCP_KEEPINTVL
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
literal|1
expr_stmt|;
comment|/* N/A */
break|break;
case|case
name|TCP_KEEPIDLE
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
operator|(
name|int
operator|)
name|rs
operator|->
name|keepalive_time
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|TCP_NODELAY
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
operator|!
operator|!
operator|(
name|rs
operator|->
name|tcp_opts
operator|&
operator|(
literal|1
operator|<<
name|optname
operator|)
operator|)
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|TCP_MAXSEG
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
operator|(
name|rs
operator|->
name|cm_id
operator|&&
name|rs
operator|->
name|cm_id
operator|->
name|route
operator|.
name|num_paths
operator|)
condition|?
literal|1
operator|<<
operator|(
literal|7
operator|+
name|rs
operator|->
name|cm_id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|mtu
operator|)
else|:
literal|2048
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|ENOTSUP
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|IPPROTO_IPV6
case|:
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|IPV6_V6ONLY
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
operator|!
operator|!
operator|(
name|rs
operator|->
name|ipv6_opts
operator|&
operator|(
literal|1
operator|<<
name|optname
operator|)
operator|)
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|ENOTSUP
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SOL_RDMA
case|:
switch|switch
condition|(
name|optname
condition|)
block|{
case|case
name|RDMA_SQSIZE
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
name|rs
operator|->
name|sq_size
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_RQSIZE
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
name|rs
operator|->
name|rq_size
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_INLINE
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
name|rs
operator|->
name|sq_inline
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_IOMAPSIZE
case|:
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|optval
operator|)
operator|=
name|rs
operator|->
name|target_iomap_size
expr_stmt|;
operator|*
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_ROUTE
case|:
if|if
condition|(
name|rs
operator|->
name|optval
condition|)
block|{
if|if
condition|(
operator|*
name|optlen
operator|<
name|rs
operator|->
name|optlen
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|rs
operator|->
name|optval
argument_list|,
name|optval
argument_list|,
name|rs
operator|->
name|optlen
argument_list|)
expr_stmt|;
operator|*
name|optlen
operator|=
name|rs
operator|->
name|optlen
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|*
name|optlen
operator|<
sizeof|sizeof
argument_list|(
name|path_data
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|opt
operator|=
name|optval
expr_stmt|;
name|path_rec
operator|=
name|rs
operator|->
name|cm_id
operator|->
name|route
operator|.
name|path_rec
expr_stmt|;
name|num_paths
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|len
operator|+
sizeof|sizeof
argument_list|(
name|path_data
argument_list|)
operator|<=
operator|*
name|optlen
operator|&&
name|num_paths
operator|<
name|rs
operator|->
name|cm_id
operator|->
name|route
operator|.
name|num_paths
condition|)
block|{
name|rs_convert_sa_path
argument_list|(
name|path_rec
argument_list|,
operator|&
name|path_data
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|opt
argument_list|,
operator|&
name|path_data
argument_list|,
sizeof|sizeof
argument_list|(
name|path_data
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|+=
sizeof|sizeof
argument_list|(
name|path_data
argument_list|)
expr_stmt|;
name|opt
operator|+=
sizeof|sizeof
argument_list|(
name|path_data
argument_list|)
expr_stmt|;
name|path_rec
operator|++
expr_stmt|;
name|num_paths
operator|++
expr_stmt|;
block|}
operator|*
name|optlen
operator|=
name|len
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|ret
operator|=
name|ENOTSUP
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|ret
operator|=
name|ENOTSUP
expr_stmt|;
break|break;
block|}
return|return
name|rdma_seterrno
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|rfcntl
parameter_list|(
name|int
name|socket
parameter_list|,
name|int
name|cmd
parameter_list|,
modifier|...
comment|/* arg */
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|int
name|param
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|rs
operator|=
name|idm_lookup
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
condition|)
return|return
name|ERR
argument_list|(
name|EBADF
argument_list|)
return|;
name|va_start
argument_list|(
name|args
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|F_GETFL
case|:
name|ret
operator|=
name|rs
operator|->
name|fd_flags
expr_stmt|;
break|break;
case|case
name|F_SETFL
case|:
name|param
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rs
operator|->
name|fd_flags
operator|&
name|O_NONBLOCK
operator|)
operator|!=
operator|(
name|param
operator|&
name|O_NONBLOCK
operator|)
condition|)
name|ret
operator|=
name|rs_set_nonblocking
argument_list|(
name|rs
argument_list|,
name|param
operator|&
name|O_NONBLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|rs
operator|->
name|fd_flags
operator|=
name|param
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|ERR
argument_list|(
name|ENOTSUP
argument_list|)
expr_stmt|;
break|break;
block|}
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|rs_iomap_mr
modifier|*
name|rs_get_iomap_mr
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|remote_iomappings
condition|)
block|{
name|rs
operator|->
name|remote_iomappings
operator|=
name|calloc
argument_list|(
name|rs
operator|->
name|remote_iomap
operator|.
name|length
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rs
operator|->
name|remote_iomappings
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|remote_iomappings
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|remote_iomap
operator|.
name|length
condition|;
name|i
operator|++
control|)
name|rs
operator|->
name|remote_iomappings
index|[
name|i
index|]
operator|.
name|index
operator|=
name|i
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|remote_iomap
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|rs
operator|->
name|remote_iomappings
index|[
name|i
index|]
operator|.
name|mr
condition|)
return|return
operator|&
name|rs
operator|->
name|remote_iomappings
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * If an offset is given, we map to it.  If offset is -1, then we map the  * offset to the address of buf.  We do not check for conflicts, which must  * be fixed at some point.  */
end_comment

begin_function
name|off_t
name|riomap
parameter_list|(
name|int
name|socket
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|prot
parameter_list|,
name|int
name|flags
parameter_list|,
name|off_t
name|offset
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|struct
name|rs_iomap_mr
modifier|*
name|iomr
decl_stmt|;
name|int
name|access
init|=
name|IBV_ACCESS_LOCAL_WRITE
decl_stmt|;
name|rs
operator|=
name|idm_at
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rs
operator|->
name|cm_id
operator|->
name|pd
operator|||
operator|(
name|prot
operator|&
operator|~
operator|(
name|PROT_WRITE
operator||
name|PROT_NONE
operator|)
operator|)
condition|)
return|return
name|ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|prot
operator|&
name|PROT_WRITE
condition|)
block|{
name|iomr
operator|=
name|rs_get_iomap_mr
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|access
operator||=
name|IBV_ACCESS_REMOTE_WRITE
expr_stmt|;
block|}
else|else
block|{
name|iomr
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|iomr
argument_list|)
argument_list|)
expr_stmt|;
name|iomr
operator|->
name|index
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|iomr
condition|)
block|{
name|offset
operator|=
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|iomr
operator|->
name|mr
operator|=
name|ibv_reg_mr
argument_list|(
name|rs
operator|->
name|cm_id
operator|->
name|pd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|access
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iomr
operator|->
name|mr
condition|)
block|{
if|if
condition|(
name|iomr
operator|->
name|index
operator|<
literal|0
condition|)
name|free
argument_list|(
name|iomr
argument_list|)
expr_stmt|;
name|offset
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|offset
operator|==
operator|-
literal|1
condition|)
name|offset
operator|=
operator|(
name|uintptr_t
operator|)
name|buf
expr_stmt|;
name|iomr
operator|->
name|offset
operator|=
name|offset
expr_stmt|;
name|atomic_store
argument_list|(
operator|&
name|iomr
operator|->
name|refcnt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iomr
operator|->
name|index
operator|>=
literal|0
condition|)
block|{
name|dlist_insert_tail
argument_list|(
operator|&
name|iomr
operator|->
name|entry
argument_list|,
operator|&
name|rs
operator|->
name|iomap_queue
argument_list|)
expr_stmt|;
name|rs
operator|->
name|iomap_pending
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|dlist_insert_tail
argument_list|(
operator|&
name|iomr
operator|->
name|entry
argument_list|,
operator|&
name|rs
operator|->
name|iomap_list
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
return|return
name|offset
return|;
block|}
end_function

begin_function
name|int
name|riounmap
parameter_list|(
name|int
name|socket
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|struct
name|rs_iomap_mr
modifier|*
name|iomr
decl_stmt|;
name|dlist_entry
modifier|*
name|entry
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|rs
operator|=
name|idm_at
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|entry
operator|=
name|rs
operator|->
name|iomap_list
operator|.
name|next
init|;
name|entry
operator|!=
operator|&
name|rs
operator|->
name|iomap_list
condition|;
name|entry
operator|=
name|entry
operator|->
name|next
control|)
block|{
name|iomr
operator|=
name|container_of
argument_list|(
name|entry
argument_list|,
expr|struct
name|rs_iomap_mr
argument_list|,
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|iomr
operator|->
name|mr
operator|->
name|addr
operator|==
name|buf
operator|&&
name|iomr
operator|->
name|mr
operator|->
name|length
operator|==
name|len
condition|)
block|{
name|rs_release_iomap_mr
argument_list|(
name|iomr
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
for|for
control|(
name|entry
operator|=
name|rs
operator|->
name|iomap_queue
operator|.
name|next
init|;
name|entry
operator|!=
operator|&
name|rs
operator|->
name|iomap_queue
condition|;
name|entry
operator|=
name|entry
operator|->
name|next
control|)
block|{
name|iomr
operator|=
name|container_of
argument_list|(
name|entry
argument_list|,
expr|struct
name|rs_iomap_mr
argument_list|,
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|iomr
operator|->
name|mr
operator|->
name|addr
operator|==
name|buf
operator|&&
name|iomr
operator|->
name|mr
operator|->
name|length
operator|==
name|len
condition|)
block|{
name|rs_release_iomap_mr
argument_list|(
name|iomr
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|ret
operator|=
name|ERR
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
name|out
label|:
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|map_lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|rs_iomap
modifier|*
name|rs_find_iomap
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|off_t
name|offset
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|target_iomap_size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|offset
operator|>=
name|rs
operator|->
name|target_iomap
index|[
name|i
index|]
operator|.
name|offset
operator|&&
name|offset
operator|<
name|rs
operator|->
name|target_iomap
index|[
name|i
index|]
operator|.
name|offset
operator|+
name|rs
operator|->
name|target_iomap
index|[
name|i
index|]
operator|.
name|sge
operator|.
name|length
condition|)
return|return
operator|&
name|rs
operator|->
name|target_iomap
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|size_t
name|riowrite
parameter_list|(
name|int
name|socket
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|,
name|off_t
name|offset
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
name|rs
decl_stmt|;
name|struct
name|rs_iomap
modifier|*
name|iom
init|=
name|NULL
decl_stmt|;
name|struct
name|ibv_sge
name|sge
decl_stmt|;
name|size_t
name|left
init|=
name|count
decl_stmt|;
name|uint32_t
name|xfer_size
decl_stmt|,
name|olen
init|=
name|RS_OLAP_START_SIZE
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|rs
operator|=
name|idm_at
argument_list|(
operator|&
name|idm
argument_list|,
name|socket
argument_list|)
expr_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|iomap_pending
condition|)
block|{
name|ret
operator|=
name|rs_send_iomaps
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
for|for
control|(
init|;
name|left
condition|;
name|left
operator|-=
name|xfer_size
operator|,
name|buf
operator|+=
name|xfer_size
operator|,
name|offset
operator|+=
name|xfer_size
control|)
block|{
if|if
condition|(
operator|!
name|iom
operator|||
name|offset
operator|>
name|iom
operator|->
name|offset
operator|+
name|iom
operator|->
name|sge
operator|.
name|length
condition|)
block|{
name|iom
operator|=
name|rs_find_iomap
argument_list|(
name|rs
argument_list|,
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iom
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|rs_can_send
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|ret
operator|=
name|rs_get_comp
argument_list|(
name|rs
argument_list|,
name|rs_nonblocking
argument_list|(
name|rs
argument_list|,
name|flags
argument_list|)
argument_list|,
name|rs_conn_can_send
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_writable
operator|)
condition|)
block|{
name|ret
operator|=
name|ERR
argument_list|(
name|ECONNRESET
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|olen
operator|<
name|left
condition|)
block|{
name|xfer_size
operator|=
name|olen
expr_stmt|;
if|if
condition|(
name|olen
operator|<
name|RS_MAX_TRANSFER
condition|)
name|olen
operator|<<=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|xfer_size
operator|=
name|left
expr_stmt|;
block|}
if|if
condition|(
name|xfer_size
operator|>
name|rs
operator|->
name|sbuf_bytes_avail
condition|)
name|xfer_size
operator|=
name|rs
operator|->
name|sbuf_bytes_avail
expr_stmt|;
if|if
condition|(
name|xfer_size
operator|>
name|iom
operator|->
name|offset
operator|+
name|iom
operator|->
name|sge
operator|.
name|length
operator|-
name|offset
condition|)
name|xfer_size
operator|=
name|iom
operator|->
name|offset
operator|+
name|iom
operator|->
name|sge
operator|.
name|length
operator|-
name|offset
expr_stmt|;
if|if
condition|(
name|xfer_size
operator|<=
name|rs
operator|->
name|sq_inline
condition|)
block|{
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|buf
expr_stmt|;
name|sge
operator|.
name|length
operator|=
name|xfer_size
expr_stmt|;
name|sge
operator|.
name|lkey
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|rs_write_direct
argument_list|(
name|rs
argument_list|,
name|iom
argument_list|,
name|offset
argument_list|,
operator|&
name|sge
argument_list|,
literal|1
argument_list|,
name|xfer_size
argument_list|,
name|IBV_SEND_INLINE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|xfer_size
operator|<=
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
argument_list|,
name|buf
argument_list|,
name|xfer_size
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|xfer_size
expr_stmt|;
name|ret
operator|=
name|rs_write_direct
argument_list|(
name|rs
argument_list|,
name|iom
argument_list|,
name|offset
argument_list|,
name|rs
operator|->
name|ssgl
argument_list|,
literal|1
argument_list|,
name|xfer_size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|xfer_size
operator|<
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
condition|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|+=
name|xfer_size
expr_stmt|;
else|else
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|sbuf
expr_stmt|;
block|}
else|else
block|{
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|rs_sbuf_left
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
argument_list|,
name|buf
argument_list|,
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
operator|=
name|xfer_size
operator|-
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|rs
operator|->
name|sbuf
argument_list|,
name|buf
operator|+
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|length
argument_list|,
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rs_write_direct
argument_list|(
name|rs
argument_list|,
name|iom
argument_list|,
name|offset
argument_list|,
name|rs
operator|->
name|ssgl
argument_list|,
literal|2
argument_list|,
name|xfer_size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rs
operator|->
name|ssgl
index|[
literal|0
index|]
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|rs
operator|->
name|sbuf
operator|+
name|rs
operator|->
name|ssgl
index|[
literal|1
index|]
operator|.
name|length
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
break|break;
block|}
name|out
label|:
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|&&
name|left
operator|==
name|count
operator|)
condition|?
name|ret
else|:
name|count
operator|-
name|left
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************  * Service Processing Threads  ****************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|rs_svc_grow_sets
parameter_list|(
name|struct
name|rs_svc
modifier|*
name|svc
parameter_list|,
name|int
name|grow_size
parameter_list|)
block|{
name|struct
name|rsocket
modifier|*
modifier|*
name|rss
decl_stmt|;
name|void
modifier|*
name|set
decl_stmt|,
modifier|*
name|contexts
decl_stmt|;
name|set
operator|=
name|calloc
argument_list|(
name|svc
operator|->
name|size
operator|+
name|grow_size
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rss
argument_list|)
operator|+
name|svc
operator|->
name|context_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|set
condition|)
return|return
name|ENOMEM
return|;
name|svc
operator|->
name|size
operator|+=
name|grow_size
expr_stmt|;
name|rss
operator|=
name|set
expr_stmt|;
name|contexts
operator|=
name|set
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|rss
argument_list|)
operator|*
name|svc
operator|->
name|size
expr_stmt|;
if|if
condition|(
name|svc
operator|->
name|cnt
condition|)
block|{
name|memcpy
argument_list|(
name|rss
argument_list|,
name|svc
operator|->
name|rss
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rss
argument_list|)
operator|*
operator|(
name|svc
operator|->
name|cnt
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|contexts
argument_list|,
name|svc
operator|->
name|contexts
argument_list|,
name|svc
operator|->
name|context_size
operator|*
operator|(
name|svc
operator|->
name|cnt
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|svc
operator|->
name|rss
argument_list|)
expr_stmt|;
name|svc
operator|->
name|rss
operator|=
name|rss
expr_stmt|;
name|svc
operator|->
name|contexts
operator|=
name|contexts
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Index 0 is reserved for the service's communication socket.  */
end_comment

begin_function
specifier|static
name|int
name|rs_svc_add_rs
parameter_list|(
name|struct
name|rs_svc
modifier|*
name|svc
parameter_list|,
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|svc
operator|->
name|cnt
operator|>=
name|svc
operator|->
name|size
operator|-
literal|1
condition|)
block|{
name|ret
operator|=
name|rs_svc_grow_sets
argument_list|(
name|svc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|svc
operator|->
name|rss
index|[
operator|++
name|svc
operator|->
name|cnt
index|]
operator|=
name|rs
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_svc_index
parameter_list|(
name|struct
name|rs_svc
modifier|*
name|svc
parameter_list|,
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|svc
operator|->
name|cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|svc
operator|->
name|rss
index|[
name|i
index|]
operator|==
name|rs
condition|)
return|return
name|i
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rs_svc_rm_rs
parameter_list|(
name|struct
name|rs_svc
modifier|*
name|svc
parameter_list|,
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|rs_svc_index
argument_list|(
name|svc
argument_list|,
name|rs
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|svc
operator|->
name|rss
index|[
name|i
index|]
operator|=
name|svc
operator|->
name|rss
index|[
name|svc
operator|->
name|cnt
index|]
expr_stmt|;
name|memcpy
argument_list|(
name|svc
operator|->
name|contexts
operator|+
name|i
operator|*
name|svc
operator|->
name|context_size
argument_list|,
name|svc
operator|->
name|contexts
operator|+
name|svc
operator|->
name|cnt
operator|*
name|svc
operator|->
name|context_size
argument_list|,
name|svc
operator|->
name|context_size
argument_list|)
expr_stmt|;
name|svc
operator|->
name|cnt
operator|--
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|EBADF
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|udp_svc_process_sock
parameter_list|(
name|struct
name|rs_svc
modifier|*
name|svc
parameter_list|)
block|{
name|struct
name|rs_svc_msg
name|msg
decl_stmt|;
name|read_all
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|1
index|]
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|msg
operator|.
name|cmd
condition|)
block|{
case|case
name|RS_SVC_ADD_DGRAM
case|:
name|msg
operator|.
name|status
operator|=
name|rs_svc_add_rs
argument_list|(
name|svc
argument_list|,
name|msg
operator|.
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|.
name|status
condition|)
block|{
name|msg
operator|.
name|rs
operator|->
name|opts
operator||=
name|RS_OPT_SVC_ACTIVE
expr_stmt|;
name|udp_svc_fds
operator|=
name|svc
operator|->
name|contexts
expr_stmt|;
name|udp_svc_fds
index|[
name|svc
operator|->
name|cnt
index|]
operator|.
name|fd
operator|=
name|msg
operator|.
name|rs
operator|->
name|udp_sock
expr_stmt|;
name|udp_svc_fds
index|[
name|svc
operator|->
name|cnt
index|]
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
name|udp_svc_fds
index|[
name|svc
operator|->
name|cnt
index|]
operator|.
name|revents
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|RS_SVC_REM_DGRAM
case|:
name|msg
operator|.
name|status
operator|=
name|rs_svc_rm_rs
argument_list|(
name|svc
argument_list|,
name|msg
operator|.
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|.
name|status
condition|)
name|msg
operator|.
name|rs
operator|->
name|opts
operator|&=
operator|~
name|RS_OPT_SVC_ACTIVE
expr_stmt|;
break|break;
case|case
name|RS_SVC_NOOP
case|:
name|msg
operator|.
name|status
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|write_all
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|1
index|]
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|udp_svc_sgid_index
parameter_list|(
name|struct
name|ds_dest
modifier|*
name|dest
parameter_list|,
name|union
name|ibv_gid
modifier|*
name|sgid
parameter_list|)
block|{
name|union
name|ibv_gid
name|gid
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|ibv_query_gid
argument_list|(
name|dest
operator|->
name|qp
operator|->
name|cm_id
operator|->
name|verbs
argument_list|,
name|dest
operator|->
name|qp
operator|->
name|cm_id
operator|->
name|port_num
argument_list|,
name|i
argument_list|,
operator|&
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|sgid
argument_list|,
operator|&
name|gid
argument_list|,
sizeof|sizeof
name|gid
argument_list|)
condition|)
return|return
name|i
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|udp_svc_path_bits
parameter_list|(
name|struct
name|ds_dest
modifier|*
name|dest
parameter_list|)
block|{
name|struct
name|ibv_port_attr
name|attr
decl_stmt|;
if|if
condition|(
operator|!
name|ibv_query_port
argument_list|(
name|dest
operator|->
name|qp
operator|->
name|cm_id
operator|->
name|verbs
argument_list|,
name|dest
operator|->
name|qp
operator|->
name|cm_id
operator|->
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
return|return
call|(
name|uint8_t
call|)
argument_list|(
operator|(
literal|1
operator|<<
name|attr
operator|.
name|lmc
operator|)
operator|-
literal|1
argument_list|)
return|;
return|return
literal|0x7f
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|udp_svc_create_ah
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|struct
name|ds_dest
modifier|*
name|dest
parameter_list|,
name|uint32_t
name|qpn
parameter_list|)
block|{
name|union
name|socket_addr
name|saddr
decl_stmt|;
name|struct
name|rdma_cm_id
modifier|*
name|id
decl_stmt|;
name|struct
name|ibv_ah_attr
name|attr
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|dest
operator|->
name|ah
condition|)
block|{
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|ibv_destroy_ah
argument_list|(
name|dest
operator|->
name|ah
argument_list|)
expr_stmt|;
name|dest
operator|->
name|ah
operator|=
name|NULL
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|rdma_create_id
argument_list|(
name|NULL
argument_list|,
operator|&
name|id
argument_list|,
name|NULL
argument_list|,
name|dest
operator|->
name|qp
operator|->
name|cm_id
operator|->
name|ps
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return;
name|memcpy
argument_list|(
operator|&
name|saddr
argument_list|,
name|rdma_get_local_addr
argument_list|(
name|dest
operator|->
name|qp
operator|->
name|cm_id
argument_list|)
argument_list|,
name|ucma_addrlen
argument_list|(
name|rdma_get_local_addr
argument_list|(
name|dest
operator|->
name|qp
operator|->
name|cm_id
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|saddr
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
name|saddr
operator|.
name|sin
operator|.
name|sin_port
operator|=
literal|0
expr_stmt|;
else|else
name|saddr
operator|.
name|sin6
operator|.
name|sin6_port
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|rdma_resolve_addr
argument_list|(
name|id
argument_list|,
operator|&
name|saddr
operator|.
name|sa
argument_list|,
operator|&
name|dest
operator|->
name|addr
operator|.
name|sa
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|rdma_resolve_route
argument_list|(
name|id
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|memset
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|hop_limit
operator|>
literal|1
condition|)
block|{
name|attr
operator|.
name|is_global
operator|=
literal|1
expr_stmt|;
name|attr
operator|.
name|grh
operator|.
name|dgid
operator|=
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|dgid
expr_stmt|;
name|attr
operator|.
name|grh
operator|.
name|flow_label
operator|=
name|be32toh
argument_list|(
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|flow_label
argument_list|)
expr_stmt|;
name|attr
operator|.
name|grh
operator|.
name|sgid_index
operator|=
name|udp_svc_sgid_index
argument_list|(
name|dest
argument_list|,
operator|&
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|sgid
argument_list|)
expr_stmt|;
name|attr
operator|.
name|grh
operator|.
name|hop_limit
operator|=
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|hop_limit
expr_stmt|;
name|attr
operator|.
name|grh
operator|.
name|traffic_class
operator|=
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|traffic_class
expr_stmt|;
block|}
name|attr
operator|.
name|dlid
operator|=
name|be16toh
argument_list|(
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|dlid
argument_list|)
expr_stmt|;
name|attr
operator|.
name|sl
operator|=
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|sl
expr_stmt|;
name|attr
operator|.
name|src_path_bits
operator|=
name|be16toh
argument_list|(
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|slid
argument_list|)
operator|&
name|udp_svc_path_bits
argument_list|(
name|dest
argument_list|)
expr_stmt|;
name|attr
operator|.
name|static_rate
operator|=
name|id
operator|->
name|route
operator|.
name|path_rec
operator|->
name|rate
expr_stmt|;
name|attr
operator|.
name|port_num
operator|=
name|id
operator|->
name|port_num
expr_stmt|;
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|dest
operator|->
name|qpn
operator|=
name|qpn
expr_stmt|;
name|dest
operator|->
name|ah
operator|=
name|ibv_create_ah
argument_list|(
name|dest
operator|->
name|qp
operator|->
name|cm_id
operator|->
name|pd
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|out
label|:
name|rdma_destroy_id
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|udp_svc_valid_udp_hdr
parameter_list|(
name|struct
name|ds_udp_header
modifier|*
name|udp_hdr
parameter_list|,
name|union
name|socket_addr
modifier|*
name|addr
parameter_list|)
block|{
return|return
operator|(
name|udp_hdr
operator|->
name|tag
operator|==
name|htobe32
argument_list|(
name|DS_UDP_TAG
argument_list|)
operator|)
operator|&&
operator|(
operator|(
name|udp_hdr
operator|->
name|version
operator|==
literal|4
operator|&&
name|addr
operator|->
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
operator|&&
name|udp_hdr
operator|->
name|length
operator|==
name|DS_UDP_IPV4_HDR_LEN
operator|)
operator|||
operator|(
name|udp_hdr
operator|->
name|version
operator|==
literal|6
operator|&&
name|addr
operator|->
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET6
operator|&&
name|udp_hdr
operator|->
name|length
operator|==
name|DS_UDP_IPV6_HDR_LEN
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|udp_svc_forward
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|union
name|socket_addr
modifier|*
name|src
parameter_list|)
block|{
name|struct
name|ds_header
name|hdr
decl_stmt|;
name|struct
name|ds_smsg
modifier|*
name|msg
decl_stmt|;
name|struct
name|ibv_sge
name|sge
decl_stmt|;
name|uint64_t
name|offset
decl_stmt|;
if|if
condition|(
operator|!
name|ds_can_send
argument_list|(
name|rs
argument_list|)
condition|)
block|{
if|if
condition|(
name|ds_get_comp
argument_list|(
name|rs
argument_list|,
literal|0
argument_list|,
name|ds_can_send
argument_list|)
condition|)
return|return;
block|}
name|msg
operator|=
name|rs
operator|->
name|smsg_free
expr_stmt|;
name|rs
operator|->
name|smsg_free
operator|=
name|msg
operator|->
name|next
expr_stmt|;
name|rs
operator|->
name|sqe_avail
operator|--
expr_stmt|;
name|ds_format_hdr
argument_list|(
operator|&
name|hdr
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|msg
argument_list|,
operator|&
name|hdr
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|msg
operator|+
name|hdr
operator|.
name|length
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sge
operator|.
name|addr
operator|=
operator|(
name|uintptr_t
operator|)
name|msg
expr_stmt|;
name|sge
operator|.
name|length
operator|=
name|hdr
operator|.
name|length
operator|+
name|len
expr_stmt|;
name|sge
operator|.
name|lkey
operator|=
name|rs
operator|->
name|conn_dest
operator|->
name|qp
operator|->
name|smr
operator|->
name|lkey
expr_stmt|;
name|offset
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|msg
operator|-
name|rs
operator|->
name|sbuf
expr_stmt|;
name|ds_post_send
argument_list|(
name|rs
argument_list|,
operator|&
name|sge
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|udp_svc_process_rs
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
specifier|static
name|uint8_t
name|buf
index|[
name|RS_SNDLOWAT
index|]
decl_stmt|;
name|struct
name|ds_dest
modifier|*
name|dest
decl_stmt|,
modifier|*
name|cur_dest
decl_stmt|;
name|struct
name|ds_udp_header
modifier|*
name|udp_hdr
decl_stmt|;
name|union
name|socket_addr
name|addr
decl_stmt|;
name|socklen_t
name|addrlen
init|=
sizeof|sizeof
name|addr
decl_stmt|;
name|int
name|len
decl_stmt|,
name|ret
decl_stmt|;
name|uint32_t
name|qpn
decl_stmt|;
name|ret
operator|=
name|recvfrom
argument_list|(
name|rs
operator|->
name|udp_sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|0
argument_list|,
operator|&
name|addr
operator|.
name|sa
argument_list|,
operator|&
name|addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
name|DS_UDP_IPV4_HDR_LEN
condition|)
return|return;
name|udp_hdr
operator|=
operator|(
expr|struct
name|ds_udp_header
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
operator|!
name|udp_svc_valid_udp_hdr
argument_list|(
name|udp_hdr
argument_list|,
operator|&
name|addr
argument_list|)
condition|)
return|return;
name|len
operator|=
name|ret
operator|-
name|udp_hdr
operator|->
name|length
expr_stmt|;
name|qpn
operator|=
name|be32toh
argument_list|(
name|udp_hdr
operator|->
name|qpn
argument_list|)
operator|&
literal|0xFFFFFF
expr_stmt|;
name|udp_hdr
operator|->
name|tag
operator|=
operator|(
name|__force
name|__be32
operator|)
name|be32toh
argument_list|(
name|udp_hdr
operator|->
name|tag
argument_list|)
expr_stmt|;
name|udp_hdr
operator|->
name|qpn
operator|=
operator|(
name|__force
name|__be32
operator|)
name|qpn
expr_stmt|;
name|ret
operator|=
name|ds_get_dest
argument_list|(
name|rs
argument_list|,
operator|&
name|addr
operator|.
name|sa
argument_list|,
name|addrlen
argument_list|,
operator|&
name|dest
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return;
if|if
condition|(
name|udp_hdr
operator|->
name|op
operator|==
name|RS_OP_DATA
condition|)
block|{
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|cur_dest
operator|=
name|rs
operator|->
name|conn_dest
expr_stmt|;
name|rs
operator|->
name|conn_dest
operator|=
name|dest
expr_stmt|;
name|ds_send_udp
argument_list|(
name|rs
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|RS_OP_CTRL
argument_list|)
expr_stmt|;
name|rs
operator|->
name|conn_dest
operator|=
name|cur_dest
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dest
operator|->
name|ah
operator|||
operator|(
name|dest
operator|->
name|qpn
operator|!=
name|qpn
operator|)
condition|)
name|udp_svc_create_ah
argument_list|(
name|rs
argument_list|,
name|dest
argument_list|,
name|qpn
argument_list|)
expr_stmt|;
comment|/* to do: handle when dest local ip address doesn't match udp ip */
if|if
condition|(
name|udp_hdr
operator|->
name|op
operator|==
name|RS_OP_DATA
condition|)
block|{
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
name|cur_dest
operator|=
name|rs
operator|->
name|conn_dest
expr_stmt|;
name|rs
operator|->
name|conn_dest
operator|=
operator|&
name|dest
operator|->
name|qp
operator|->
name|dest
expr_stmt|;
name|udp_svc_forward
argument_list|(
name|rs
argument_list|,
name|buf
operator|+
name|udp_hdr
operator|->
name|length
argument_list|,
name|len
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
name|rs
operator|->
name|conn_dest
operator|=
name|cur_dest
expr_stmt|;
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|slock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|udp_svc_run
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rs_svc
modifier|*
name|svc
init|=
name|arg
decl_stmt|;
name|struct
name|rs_svc_msg
name|msg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|ret
operator|=
name|rs_svc_grow_sets
argument_list|(
name|svc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|msg
operator|.
name|status
operator|=
name|ret
expr_stmt|;
name|write_all
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|1
index|]
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|ret
return|;
block|}
name|udp_svc_fds
operator|=
name|svc
operator|->
name|contexts
expr_stmt|;
name|udp_svc_fds
index|[
literal|0
index|]
operator|.
name|fd
operator|=
name|svc
operator|->
name|sock
index|[
literal|1
index|]
expr_stmt|;
name|udp_svc_fds
index|[
literal|0
index|]
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
do|do
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|svc
operator|->
name|cnt
condition|;
name|i
operator|++
control|)
name|udp_svc_fds
index|[
name|i
index|]
operator|.
name|revents
operator|=
literal|0
expr_stmt|;
name|poll
argument_list|(
name|udp_svc_fds
argument_list|,
name|svc
operator|->
name|cnt
operator|+
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|udp_svc_fds
index|[
literal|0
index|]
operator|.
name|revents
condition|)
name|udp_svc_process_sock
argument_list|(
name|svc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|svc
operator|->
name|cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|udp_svc_fds
index|[
name|i
index|]
operator|.
name|revents
condition|)
name|udp_svc_process_rs
argument_list|(
name|svc
operator|->
name|rss
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|svc
operator|->
name|cnt
operator|>=
literal|1
condition|)
do|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|rs_get_time
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|timeval
name|now
decl_stmt|;
name|memset
argument_list|(
operator|&
name|now
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|now
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint32_t
operator|)
name|now
operator|.
name|tv_sec
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tcp_svc_process_sock
parameter_list|(
name|struct
name|rs_svc
modifier|*
name|svc
parameter_list|)
block|{
name|struct
name|rs_svc_msg
name|msg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|read_all
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|1
index|]
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|msg
operator|.
name|cmd
condition|)
block|{
case|case
name|RS_SVC_ADD_KEEPALIVE
case|:
name|msg
operator|.
name|status
operator|=
name|rs_svc_add_rs
argument_list|(
name|svc
argument_list|,
name|msg
operator|.
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|.
name|status
condition|)
block|{
name|msg
operator|.
name|rs
operator|->
name|opts
operator||=
name|RS_OPT_SVC_ACTIVE
expr_stmt|;
name|tcp_svc_timeouts
operator|=
name|svc
operator|->
name|contexts
expr_stmt|;
name|tcp_svc_timeouts
index|[
name|svc
operator|->
name|cnt
index|]
operator|=
name|rs_get_time
argument_list|()
operator|+
name|msg
operator|.
name|rs
operator|->
name|keepalive_time
expr_stmt|;
block|}
break|break;
case|case
name|RS_SVC_REM_KEEPALIVE
case|:
name|msg
operator|.
name|status
operator|=
name|rs_svc_rm_rs
argument_list|(
name|svc
argument_list|,
name|msg
operator|.
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|.
name|status
condition|)
name|msg
operator|.
name|rs
operator|->
name|opts
operator|&=
operator|~
name|RS_OPT_SVC_ACTIVE
expr_stmt|;
break|break;
case|case
name|RS_SVC_MOD_KEEPALIVE
case|:
name|i
operator|=
name|rs_svc_index
argument_list|(
name|svc
argument_list|,
name|msg
operator|.
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
block|{
name|tcp_svc_timeouts
index|[
name|i
index|]
operator|=
name|rs_get_time
argument_list|()
operator|+
name|msg
operator|.
name|rs
operator|->
name|keepalive_time
expr_stmt|;
name|msg
operator|.
name|status
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|msg
operator|.
name|status
operator|=
name|EBADF
expr_stmt|;
block|}
break|break;
case|case
name|RS_SVC_NOOP
case|:
name|msg
operator|.
name|status
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|write_all
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|1
index|]
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send a 0 byte RDMA write with immediate as keep-alive message.  * This avoids the need for the receive side to do any acknowledgment.  */
end_comment

begin_function
specifier|static
name|void
name|tcp_svc_send_keepalive
parameter_list|(
name|struct
name|rsocket
modifier|*
name|rs
parameter_list|)
block|{
name|fastlock_acquire
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs_ctrl_avail
argument_list|(
name|rs
argument_list|)
operator|&&
operator|(
name|rs
operator|->
name|state
operator|&
name|rs_connected
operator|)
condition|)
block|{
name|rs
operator|->
name|ctrl_seqno
operator|++
expr_stmt|;
name|rs_post_write
argument_list|(
name|rs
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|rs_msg_set
argument_list|(
name|RS_OP_CTRL
argument_list|,
name|RS_CTRL_KEEPALIVE
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
name|uintptr_t
operator|)
name|NULL
argument_list|,
operator|(
name|uintptr_t
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
name|fastlock_release
argument_list|(
operator|&
name|rs
operator|->
name|cq_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|tcp_svc_run
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rs_svc
modifier|*
name|svc
init|=
name|arg
decl_stmt|;
name|struct
name|rs_svc_msg
name|msg
decl_stmt|;
name|struct
name|pollfd
name|fds
decl_stmt|;
name|uint32_t
name|now
decl_stmt|,
name|next_timeout
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|,
name|timeout
decl_stmt|;
name|ret
operator|=
name|rs_svc_grow_sets
argument_list|(
name|svc
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|msg
operator|.
name|status
operator|=
name|ret
expr_stmt|;
name|write_all
argument_list|(
name|svc
operator|->
name|sock
index|[
literal|1
index|]
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|ret
return|;
block|}
name|tcp_svc_timeouts
operator|=
name|svc
operator|->
name|contexts
expr_stmt|;
name|fds
operator|.
name|fd
operator|=
name|svc
operator|->
name|sock
index|[
literal|1
index|]
expr_stmt|;
name|fds
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
name|timeout
operator|=
operator|-
literal|1
expr_stmt|;
do|do
block|{
name|poll
argument_list|(
operator|&
name|fds
argument_list|,
literal|1
argument_list|,
name|timeout
operator|*
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|fds
operator|.
name|revents
condition|)
name|tcp_svc_process_sock
argument_list|(
name|svc
argument_list|)
expr_stmt|;
name|now
operator|=
name|rs_get_time
argument_list|()
expr_stmt|;
name|next_timeout
operator|=
operator|~
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|svc
operator|->
name|cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tcp_svc_timeouts
index|[
name|i
index|]
operator|<=
name|now
condition|)
block|{
name|tcp_svc_send_keepalive
argument_list|(
name|svc
operator|->
name|rss
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tcp_svc_timeouts
index|[
name|i
index|]
operator|=
name|now
operator|+
name|svc
operator|->
name|rss
index|[
name|i
index|]
operator|->
name|keepalive_time
expr_stmt|;
block|}
if|if
condition|(
name|tcp_svc_timeouts
index|[
name|i
index|]
operator|<
name|next_timeout
condition|)
name|next_timeout
operator|=
name|tcp_svc_timeouts
index|[
name|i
index|]
expr_stmt|;
block|}
name|timeout
operator|=
call|(
name|int
call|)
argument_list|(
name|next_timeout
operator|-
name|now
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|svc
operator|->
name|cnt
operator|>=
literal|1
condition|)
do|;
return|return
name|NULL
return|;
block|}
end_function

end_unit


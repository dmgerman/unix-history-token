begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013 Intel Corporation.  All rights reserved.  *  * This software is available to you under the OpenIB.org BSD license  * below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AWV  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<rdma/rdma_cma.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|rdma_addrinfo
name|hints
decl_stmt|,
modifier|*
name|rai
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|rdma_event_channel
modifier|*
name|channel
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|port
init|=
literal|"7471"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dst_addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|src_addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|timeout
init|=
literal|2000
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|retries
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|step
block|{
name|STEP_CREATE_ID
block|,
name|STEP_BIND
block|,
name|STEP_RESOLVE_ADDR
block|,
name|STEP_RESOLVE_ROUTE
block|,
name|STEP_CREATE_QP
block|,
name|STEP_CONNECT
block|,
name|STEP_DISCONNECT
block|,
name|STEP_DESTROY
block|,
name|STEP_CNT
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|step_str
index|[]
init|=
block|{
literal|"create id"
block|,
literal|"bind addr"
block|,
literal|"resolve addr"
block|,
literal|"resolve route"
block|,
literal|"create qp"
block|,
literal|"connect"
block|,
literal|"disconnect"
block|,
literal|"destroy"
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|node
block|{
name|struct
name|rdma_cm_id
modifier|*
name|id
decl_stmt|;
name|struct
name|timeval
name|times
index|[
name|STEP_CNT
index|]
index|[
literal|2
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|retries
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|list_head
block|{
name|struct
name|list_head
modifier|*
name|prev
decl_stmt|;
name|struct
name|list_head
modifier|*
name|next
decl_stmt|;
name|struct
name|rdma_cm_id
modifier|*
name|id
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|work_list
block|{
name|pthread_mutex_t
name|lock
decl_stmt|;
name|pthread_cond_t
name|cond
decl_stmt|;
name|struct
name|list_head
name|list
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|INIT_LIST
parameter_list|(
name|x
parameter_list|)
value|((x)->prev = (x)->next = (x))
end_define

begin_decl_stmt
specifier|static
name|struct
name|work_list
name|req_work
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|work_list
name|disc_work
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|node
modifier|*
name|nodes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|timeval
name|times
index|[
name|STEP_CNT
index|]
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|connections
init|=
literal|100
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|volatile
name|int
name|started
index|[
name|STEP_CNT
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|volatile
name|int
name|completed
index|[
name|STEP_CNT
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ibv_qp_init_attr
name|init_qp_attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|rdma_conn_param
name|conn_param
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|start_perf
parameter_list|(
name|n
parameter_list|,
name|s
parameter_list|)
value|gettimeofday(&((n)->times[s][0]), NULL)
end_define

begin_define
define|#
directive|define
name|end_perf
parameter_list|(
name|n
parameter_list|,
name|s
parameter_list|)
value|gettimeofday(&((n)->times[s][1]), NULL)
end_define

begin_define
define|#
directive|define
name|start_time
parameter_list|(
name|s
parameter_list|)
value|gettimeofday(&times[s][0], NULL)
end_define

begin_define
define|#
directive|define
name|end_time
parameter_list|(
name|s
parameter_list|)
value|gettimeofday(&times[s][1], NULL)
end_define

begin_function
specifier|static
specifier|inline
name|void
name|__list_delete
parameter_list|(
name|struct
name|list_head
modifier|*
name|list
parameter_list|)
block|{
name|struct
name|list_head
modifier|*
name|prev
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|prev
operator|=
name|list
operator|->
name|prev
expr_stmt|;
name|next
operator|=
name|list
operator|->
name|next
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|next
expr_stmt|;
name|next
operator|->
name|prev
operator|=
name|prev
expr_stmt|;
name|INIT_LIST
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|__list_empty
parameter_list|(
name|struct
name|work_list
modifier|*
name|list
parameter_list|)
block|{
return|return
name|list
operator|->
name|list
operator|.
name|next
operator|==
operator|&
name|list
operator|->
name|list
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|struct
name|list_head
modifier|*
name|__list_remove_head
parameter_list|(
name|struct
name|work_list
modifier|*
name|work_list
parameter_list|)
block|{
name|struct
name|list_head
modifier|*
name|list_item
decl_stmt|;
name|list_item
operator|=
name|work_list
operator|->
name|list
operator|.
name|next
expr_stmt|;
name|__list_delete
argument_list|(
name|list_item
argument_list|)
expr_stmt|;
return|return
name|list_item
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|list_add_tail
parameter_list|(
name|struct
name|work_list
modifier|*
name|work_list
parameter_list|,
name|struct
name|list_head
modifier|*
name|req
parameter_list|)
block|{
name|int
name|empty
decl_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|work_list
operator|->
name|lock
argument_list|)
expr_stmt|;
name|empty
operator|=
name|__list_empty
argument_list|(
name|work_list
argument_list|)
expr_stmt|;
name|req
operator|->
name|prev
operator|=
name|work_list
operator|->
name|list
operator|.
name|prev
expr_stmt|;
name|req
operator|->
name|next
operator|=
operator|&
name|work_list
operator|->
name|list
expr_stmt|;
name|req
operator|->
name|prev
operator|->
name|next
operator|=
name|work_list
operator|->
name|list
operator|.
name|prev
operator|=
name|req
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|work_list
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|empty
condition|)
name|pthread_cond_signal
argument_list|(
operator|&
name|work_list
operator|->
name|cond
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|zero_time
parameter_list|(
name|struct
name|timeval
modifier|*
name|t
parameter_list|)
block|{
return|return
operator|!
operator|(
name|t
operator|->
name|tv_sec
operator|||
name|t
operator|->
name|tv_usec
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|float
name|diff_us
parameter_list|(
name|struct
name|timeval
modifier|*
name|end
parameter_list|,
name|struct
name|timeval
modifier|*
name|start
parameter_list|)
block|{
return|return
operator|(
name|end
operator|->
name|tv_sec
operator|-
name|start
operator|->
name|tv_sec
operator|)
operator|*
literal|1000000.
operator|+
operator|(
name|end
operator|->
name|tv_usec
operator|-
name|start
operator|->
name|tv_usec
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_perf
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|c
decl_stmt|,
name|i
decl_stmt|;
name|float
name|us
decl_stmt|,
name|max
index|[
name|STEP_CNT
index|]
decl_stmt|,
name|min
index|[
name|STEP_CNT
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|STEP_CNT
condition|;
name|i
operator|++
control|)
block|{
name|max
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|min
index|[
name|i
index|]
operator|=
literal|999999999.
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|connections
condition|;
name|c
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|zero_time
argument_list|(
operator|&
name|nodes
index|[
name|c
index|]
operator|.
name|times
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
operator|&&
operator|!
name|zero_time
argument_list|(
operator|&
name|nodes
index|[
name|c
index|]
operator|.
name|times
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|us
operator|=
name|diff_us
argument_list|(
operator|&
name|nodes
index|[
name|c
index|]
operator|.
name|times
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|,
operator|&
name|nodes
index|[
name|c
index|]
operator|.
name|times
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|us
operator|>
name|max
index|[
name|i
index|]
condition|)
name|max
index|[
name|i
index|]
operator|=
name|us
expr_stmt|;
if|if
condition|(
name|us
operator|<
name|min
index|[
name|i
index|]
condition|)
name|min
index|[
name|i
index|]
operator|=
name|us
expr_stmt|;
block|}
block|}
block|}
name|printf
argument_list|(
literal|"step              total ms     max ms     min us  us / conn\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|STEP_CNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
name|STEP_BIND
operator|&&
operator|!
name|src_addr
condition|)
continue|continue;
name|us
operator|=
name|diff_us
argument_list|(
operator|&
name|times
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|,
operator|&
name|times
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-13s: %11.2f%11.2f%11.2f%11.2f\n"
argument_list|,
name|step_str
index|[
name|i
index|]
argument_list|,
name|us
operator|/
literal|1000.
argument_list|,
name|max
index|[
name|i
index|]
operator|/
literal|1000.
argument_list|,
name|min
index|[
name|i
index|]
argument_list|,
name|us
operator|/
name|connections
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|addr_handler
parameter_list|(
name|struct
name|node
modifier|*
name|n
parameter_list|)
block|{
name|end_perf
argument_list|(
name|n
argument_list|,
name|STEP_RESOLVE_ADDR
argument_list|)
expr_stmt|;
name|completed
index|[
name|STEP_RESOLVE_ADDR
index|]
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|route_handler
parameter_list|(
name|struct
name|node
modifier|*
name|n
parameter_list|)
block|{
name|end_perf
argument_list|(
name|n
argument_list|,
name|STEP_RESOLVE_ROUTE
argument_list|)
expr_stmt|;
name|completed
index|[
name|STEP_RESOLVE_ROUTE
index|]
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|conn_handler
parameter_list|(
name|struct
name|node
modifier|*
name|n
parameter_list|)
block|{
name|end_perf
argument_list|(
name|n
argument_list|,
name|STEP_CONNECT
argument_list|)
expr_stmt|;
name|completed
index|[
name|STEP_CONNECT
index|]
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|disc_handler
parameter_list|(
name|struct
name|node
modifier|*
name|n
parameter_list|)
block|{
name|end_perf
argument_list|(
name|n
argument_list|,
name|STEP_DISCONNECT
argument_list|)
expr_stmt|;
name|completed
index|[
name|STEP_DISCONNECT
index|]
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|__req_handler
parameter_list|(
name|struct
name|rdma_cm_id
modifier|*
name|id
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|id
argument_list|,
name|NULL
argument_list|,
operator|&
name|init_qp_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failure creating qp"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ret
operator|=
name|rdma_accept
argument_list|(
name|id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failure accepting"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
return|return;
name|err
label|:
name|printf
argument_list|(
literal|"failing connection request\n"
argument_list|)
expr_stmt|;
name|rdma_reject
argument_list|(
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|id
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|req_handler_thread
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|list_head
modifier|*
name|work
decl_stmt|;
do|do
block|{
name|pthread_mutex_lock
argument_list|(
operator|&
name|req_work
operator|.
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|__list_empty
argument_list|(
operator|&
name|req_work
argument_list|)
condition|)
name|pthread_cond_wait
argument_list|(
operator|&
name|req_work
operator|.
name|cond
argument_list|,
operator|&
name|req_work
operator|.
name|lock
argument_list|)
expr_stmt|;
name|work
operator|=
name|__list_remove_head
argument_list|(
operator|&
name|req_work
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|req_work
operator|.
name|lock
argument_list|)
expr_stmt|;
name|__req_handler
argument_list|(
name|work
operator|->
name|id
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|work
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|1
condition|)
do|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|disc_handler_thread
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|list_head
modifier|*
name|work
decl_stmt|;
do|do
block|{
name|pthread_mutex_lock
argument_list|(
operator|&
name|disc_work
operator|.
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|__list_empty
argument_list|(
operator|&
name|disc_work
argument_list|)
condition|)
name|pthread_cond_wait
argument_list|(
operator|&
name|disc_work
operator|.
name|cond
argument_list|,
operator|&
name|disc_work
operator|.
name|lock
argument_list|)
expr_stmt|;
name|work
operator|=
name|__list_remove_head
argument_list|(
operator|&
name|disc_work
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|disc_work
operator|.
name|lock
argument_list|)
expr_stmt|;
name|rdma_disconnect
argument_list|(
name|work
operator|->
name|id
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|work
operator|->
name|id
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|work
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|1
condition|)
do|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cma_handler
parameter_list|(
name|struct
name|rdma_cm_id
modifier|*
name|id
parameter_list|,
name|struct
name|rdma_cm_event
modifier|*
name|event
parameter_list|)
block|{
name|struct
name|node
modifier|*
name|n
init|=
name|id
operator|->
name|context
decl_stmt|;
name|struct
name|list_head
modifier|*
name|request
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|event
condition|)
block|{
case|case
name|RDMA_CM_EVENT_ADDR_RESOLVED
case|:
name|addr_handler
argument_list|(
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_ROUTE_RESOLVED
case|:
name|route_handler
argument_list|(
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_CONNECT_REQUEST
case|:
name|request
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|request
condition|)
block|{
name|perror
argument_list|(
literal|"out of memory accepting connect request"
argument_list|)
expr_stmt|;
name|rdma_reject
argument_list|(
name|id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|INIT_LIST
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|request
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|req_work
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RDMA_CM_EVENT_ESTABLISHED
case|:
if|if
condition|(
name|n
condition|)
name|conn_handler
argument_list|(
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_ADDR_ERROR
case|:
if|if
condition|(
name|n
operator|->
name|retries
operator|--
condition|)
block|{
if|if
condition|(
operator|!
name|rdma_resolve_addr
argument_list|(
name|n
operator|->
name|id
argument_list|,
name|rai
operator|->
name|ai_src_addr
argument_list|,
name|rai
operator|->
name|ai_dst_addr
argument_list|,
name|timeout
argument_list|)
condition|)
break|break;
block|}
name|printf
argument_list|(
literal|"RDMA_CM_EVENT_ADDR_ERROR, error: %d\n"
argument_list|,
name|event
operator|->
name|status
argument_list|)
expr_stmt|;
name|addr_handler
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|n
operator|->
name|error
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_ROUTE_ERROR
case|:
if|if
condition|(
name|n
operator|->
name|retries
operator|--
condition|)
block|{
if|if
condition|(
operator|!
name|rdma_resolve_route
argument_list|(
name|n
operator|->
name|id
argument_list|,
name|timeout
argument_list|)
condition|)
break|break;
block|}
name|printf
argument_list|(
literal|"RDMA_CM_EVENT_ROUTE_ERROR, error: %d\n"
argument_list|,
name|event
operator|->
name|status
argument_list|)
expr_stmt|;
name|route_handler
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|n
operator|->
name|error
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_CONNECT_ERROR
case|:
case|case
name|RDMA_CM_EVENT_UNREACHABLE
case|:
case|case
name|RDMA_CM_EVENT_REJECTED
case|:
name|printf
argument_list|(
literal|"event: %s, error: %d\n"
argument_list|,
name|rdma_event_str
argument_list|(
name|event
operator|->
name|event
argument_list|)
argument_list|,
name|event
operator|->
name|status
argument_list|)
expr_stmt|;
name|conn_handler
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|n
operator|->
name|error
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_DISCONNECTED
case|:
if|if
condition|(
operator|!
name|n
condition|)
block|{
name|request
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|request
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|request
condition|)
block|{
name|perror
argument_list|(
literal|"out of memory queueing disconnect request, handling synchronously"
argument_list|)
expr_stmt|;
name|rdma_disconnect
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|INIT_LIST
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|request
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|disc_work
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|disc_handler
argument_list|(
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_DEVICE_REMOVAL
case|:
comment|/* Cleanup will occur after test completes. */
break|break;
default|default:
break|break;
block|}
name|rdma_ack_cm_event
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|alloc_nodes
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|nodes
operator|=
name|calloc
argument_list|(
sizeof|sizeof
expr|*
name|nodes
argument_list|,
name|connections
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nodes
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|printf
argument_list|(
literal|"creating id\n"
argument_list|)
expr_stmt|;
name|start_time
argument_list|(
name|STEP_CREATE_ID
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|connections
condition|;
name|i
operator|++
control|)
block|{
name|start_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_CREATE_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst_addr
condition|)
block|{
name|ret
operator|=
name|rdma_create_id
argument_list|(
name|channel
argument_list|,
operator|&
name|nodes
index|[
name|i
index|]
operator|.
name|id
argument_list|,
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|hints
operator|.
name|ai_port_space
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
block|}
name|end_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_CREATE_ID
argument_list|)
expr_stmt|;
block|}
name|end_time
argument_list|(
name|STEP_CREATE_ID
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|rdma_destroy_id
argument_list|(
name|nodes
index|[
name|i
index|]
operator|.
name|id
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nodes
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cleanup_nodes
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"destroying id\n"
argument_list|)
expr_stmt|;
name|start_time
argument_list|(
name|STEP_DESTROY
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|connections
condition|;
name|i
operator|++
control|)
block|{
name|start_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_DESTROY
argument_list|)
expr_stmt|;
if|if
condition|(
name|nodes
index|[
name|i
index|]
operator|.
name|id
condition|)
name|rdma_destroy_id
argument_list|(
name|nodes
index|[
name|i
index|]
operator|.
name|id
argument_list|)
expr_stmt|;
name|end_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_DESTROY
argument_list|)
expr_stmt|;
block|}
name|end_time
argument_list|(
name|STEP_DESTROY
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|process_events
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rdma_cm_event
modifier|*
name|event
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|!
name|ret
condition|)
block|{
name|ret
operator|=
name|rdma_get_cm_event
argument_list|(
name|channel
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|cma_handler
argument_list|(
name|event
operator|->
name|id
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|perror
argument_list|(
literal|"failure in rdma_get_cm_event in process_server_events"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|errno
expr_stmt|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_server
parameter_list|(
name|void
parameter_list|)
block|{
name|pthread_t
name|req_thread
decl_stmt|,
name|disc_thread
decl_stmt|;
name|struct
name|rdma_cm_id
modifier|*
name|listen_id
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|req_work
operator|.
name|list
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|disc_work
operator|.
name|list
argument_list|)
expr_stmt|;
name|ret
operator|=
name|pthread_mutex_init
argument_list|(
operator|&
name|req_work
operator|.
name|lock
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"initializing mutex for req work"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|pthread_mutex_init
argument_list|(
operator|&
name|disc_work
operator|.
name|lock
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"initializing mutex for disc work"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|pthread_cond_init
argument_list|(
operator|&
name|req_work
operator|.
name|cond
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"initializing cond for req work"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|pthread_cond_init
argument_list|(
operator|&
name|disc_work
operator|.
name|cond
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"initializing cond for disc work"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|pthread_create
argument_list|(
operator|&
name|req_thread
argument_list|,
name|NULL
argument_list|,
name|req_handler_thread
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failed to create req handler thread"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|pthread_create
argument_list|(
operator|&
name|disc_thread
argument_list|,
name|NULL
argument_list|,
name|disc_handler_thread
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failed to create disconnect handler thread"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|rdma_create_id
argument_list|(
name|channel
argument_list|,
operator|&
name|listen_id
argument_list|,
name|NULL
argument_list|,
name|hints
operator|.
name|ai_port_space
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"listen request failed"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|get_rdma_addr
argument_list|(
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|port
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|rai
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"getrdmaaddr error: %s\n"
argument_list|,
name|gai_strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|rdma_bind_addr
argument_list|(
name|listen_id
argument_list|,
name|rai
operator|->
name|ai_src_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"bind address failed"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|rdma_listen
argument_list|(
name|listen_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failure trying to listen"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|process_events
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|out
label|:
name|rdma_destroy_id
argument_list|(
name|listen_id
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_client
parameter_list|(
name|void
parameter_list|)
block|{
name|pthread_t
name|event_thread
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|ret
operator|=
name|get_rdma_addr
argument_list|(
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|port
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|rai
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"getaddrinfo error: %s\n"
argument_list|,
name|gai_strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|conn_param
operator|.
name|responder_resources
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|initiator_depth
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|retry_count
operator|=
name|retries
expr_stmt|;
name|conn_param
operator|.
name|private_data
operator|=
name|rai
operator|->
name|ai_connect
expr_stmt|;
name|conn_param
operator|.
name|private_data_len
operator|=
name|rai
operator|->
name|ai_connect_len
expr_stmt|;
name|ret
operator|=
name|pthread_create
argument_list|(
operator|&
name|event_thread
argument_list|,
name|NULL
argument_list|,
name|process_events
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failure creating event thread"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|src_addr
condition|)
block|{
name|printf
argument_list|(
literal|"binding source address\n"
argument_list|)
expr_stmt|;
name|start_time
argument_list|(
name|STEP_BIND
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|connections
condition|;
name|i
operator|++
control|)
block|{
name|start_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_BIND
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_bind_addr
argument_list|(
name|nodes
index|[
name|i
index|]
operator|.
name|id
argument_list|,
name|rai
operator|->
name|ai_src_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failure bind addr"
argument_list|)
expr_stmt|;
name|nodes
index|[
name|i
index|]
operator|.
name|error
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|end_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_BIND
argument_list|)
expr_stmt|;
block|}
name|end_time
argument_list|(
name|STEP_BIND
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"resolving address\n"
argument_list|)
expr_stmt|;
name|start_time
argument_list|(
name|STEP_RESOLVE_ADDR
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|connections
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nodes
index|[
name|i
index|]
operator|.
name|error
condition|)
continue|continue;
name|nodes
index|[
name|i
index|]
operator|.
name|retries
operator|=
name|retries
expr_stmt|;
name|start_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_RESOLVE_ADDR
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_resolve_addr
argument_list|(
name|nodes
index|[
name|i
index|]
operator|.
name|id
argument_list|,
name|rai
operator|->
name|ai_src_addr
argument_list|,
name|rai
operator|->
name|ai_dst_addr
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failure getting addr"
argument_list|)
expr_stmt|;
name|nodes
index|[
name|i
index|]
operator|.
name|error
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|started
index|[
name|STEP_RESOLVE_ADDR
index|]
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|started
index|[
name|STEP_RESOLVE_ADDR
index|]
operator|!=
name|completed
index|[
name|STEP_RESOLVE_ADDR
index|]
condition|)
name|sched_yield
argument_list|()
expr_stmt|;
name|end_time
argument_list|(
name|STEP_RESOLVE_ADDR
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"resolving route\n"
argument_list|)
expr_stmt|;
name|start_time
argument_list|(
name|STEP_RESOLVE_ROUTE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|connections
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nodes
index|[
name|i
index|]
operator|.
name|error
condition|)
continue|continue;
name|nodes
index|[
name|i
index|]
operator|.
name|retries
operator|=
name|retries
expr_stmt|;
name|start_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_RESOLVE_ROUTE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_resolve_route
argument_list|(
name|nodes
index|[
name|i
index|]
operator|.
name|id
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failure resolving route"
argument_list|)
expr_stmt|;
name|nodes
index|[
name|i
index|]
operator|.
name|error
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|started
index|[
name|STEP_RESOLVE_ROUTE
index|]
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|started
index|[
name|STEP_RESOLVE_ROUTE
index|]
operator|!=
name|completed
index|[
name|STEP_RESOLVE_ROUTE
index|]
condition|)
name|sched_yield
argument_list|()
expr_stmt|;
name|end_time
argument_list|(
name|STEP_RESOLVE_ROUTE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"creating qp\n"
argument_list|)
expr_stmt|;
name|start_time
argument_list|(
name|STEP_CREATE_QP
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|connections
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nodes
index|[
name|i
index|]
operator|.
name|error
condition|)
continue|continue;
name|start_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_CREATE_QP
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|nodes
index|[
name|i
index|]
operator|.
name|id
argument_list|,
name|NULL
argument_list|,
operator|&
name|init_qp_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failure creating qp"
argument_list|)
expr_stmt|;
name|nodes
index|[
name|i
index|]
operator|.
name|error
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|end_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_CREATE_QP
argument_list|)
expr_stmt|;
block|}
name|end_time
argument_list|(
name|STEP_CREATE_QP
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"connecting\n"
argument_list|)
expr_stmt|;
name|start_time
argument_list|(
name|STEP_CONNECT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|connections
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nodes
index|[
name|i
index|]
operator|.
name|error
condition|)
continue|continue;
name|start_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_CONNECT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_connect
argument_list|(
name|nodes
index|[
name|i
index|]
operator|.
name|id
argument_list|,
operator|&
name|conn_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"failure rconnecting"
argument_list|)
expr_stmt|;
name|nodes
index|[
name|i
index|]
operator|.
name|error
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|started
index|[
name|STEP_CONNECT
index|]
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|started
index|[
name|STEP_CONNECT
index|]
operator|!=
name|completed
index|[
name|STEP_CONNECT
index|]
condition|)
name|sched_yield
argument_list|()
expr_stmt|;
name|end_time
argument_list|(
name|STEP_CONNECT
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"disconnecting\n"
argument_list|)
expr_stmt|;
name|start_time
argument_list|(
name|STEP_DISCONNECT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|connections
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nodes
index|[
name|i
index|]
operator|.
name|error
condition|)
continue|continue;
name|start_perf
argument_list|(
operator|&
name|nodes
index|[
name|i
index|]
argument_list|,
name|STEP_DISCONNECT
argument_list|)
expr_stmt|;
name|rdma_disconnect
argument_list|(
name|nodes
index|[
name|i
index|]
operator|.
name|id
argument_list|)
expr_stmt|;
name|started
index|[
name|STEP_DISCONNECT
index|]
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|started
index|[
name|STEP_DISCONNECT
index|]
operator|!=
name|completed
index|[
name|STEP_DISCONNECT
index|]
condition|)
name|sched_yield
argument_list|()
expr_stmt|;
name|end_time
argument_list|(
name|STEP_DISCONNECT
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|op
decl_stmt|,
name|ret
decl_stmt|;
name|hints
operator|.
name|ai_port_space
operator|=
name|RDMA_PS_TCP
expr_stmt|;
name|hints
operator|.
name|ai_qp_type
operator|=
name|IBV_QPT_RC
expr_stmt|;
while|while
condition|(
operator|(
name|op
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"s:b:c:p:r:t:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
literal|'s'
case|:
name|dst_addr
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|src_addr
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|connections
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|port
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|retries
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|timeout
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"usage: %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-s server_address]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-b bind_address]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-c connections]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-p port_number]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-r retries]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-t timeout_ms]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|init_qp_attr
operator|.
name|cap
operator|.
name|max_send_wr
operator|=
literal|1
expr_stmt|;
name|init_qp_attr
operator|.
name|cap
operator|.
name|max_recv_wr
operator|=
literal|1
expr_stmt|;
name|init_qp_attr
operator|.
name|cap
operator|.
name|max_send_sge
operator|=
literal|1
expr_stmt|;
name|init_qp_attr
operator|.
name|cap
operator|.
name|max_recv_sge
operator|=
literal|1
expr_stmt|;
name|init_qp_attr
operator|.
name|qp_type
operator|=
name|IBV_QPT_RC
expr_stmt|;
name|channel
operator|=
name|rdma_create_event_channel
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|channel
condition|)
block|{
name|printf
argument_list|(
literal|"failed to create event channel\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dst_addr
condition|)
block|{
name|alloc_nodes
argument_list|()
expr_stmt|;
name|ret
operator|=
name|run_client
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|hints
operator|.
name|ai_flags
operator||=
name|RAI_PASSIVE
expr_stmt|;
name|ret
operator|=
name|run_server
argument_list|()
expr_stmt|;
block|}
name|cleanup_nodes
argument_list|()
expr_stmt|;
name|rdma_destroy_event_channel
argument_list|(
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|rai
condition|)
name|rdma_freeaddrinfo
argument_list|(
name|rai
argument_list|)
expr_stmt|;
name|show_perf
argument_list|()
expr_stmt|;
name|free
argument_list|(
name|nodes
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


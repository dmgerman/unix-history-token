begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2005 Ammasso, Inc. All rights reserved.  * Copyright (c) 2006 Open Grid Computing, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<infiniband/endian.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<semaphore.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<libgen.h>
end_include

begin_include
include|#
directive|include
file|<rdma/rdma_cma.h>
end_include

begin_decl_stmt
specifier|static
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DEBUG_LOG
value|if (debug) printf
end_define

begin_comment
comment|/*  * rping "ping/pong" loop:  * 	client sends source rkey/addr/len  *	server receives source rkey/add/len  *	server rdma reads "ping" data from source  * 	server sends "go ahead" on rdma read completion  *	client sends sink rkey/addr/len  * 	server receives sink rkey/addr/len  * 	server rdma writes "pong" data to sink  * 	server sends "go ahead" on rdma write completion  *<repeat loop>  */
end_comment

begin_comment
comment|/*  * These states are used to signal events between the completion handler  * and the main client or server thread.  *  * Once CONNECTED, they cycle through RDMA_READ_ADV, RDMA_WRITE_ADV,   * and RDMA_WRITE_COMPLETE for each ping.  */
end_comment

begin_enum
enum|enum
name|test_state
block|{
name|IDLE
init|=
literal|1
block|,
name|CONNECT_REQUEST
block|,
name|ADDR_RESOLVED
block|,
name|ROUTE_RESOLVED
block|,
name|CONNECTED
block|,
name|RDMA_READ_ADV
block|,
name|RDMA_READ_COMPLETE
block|,
name|RDMA_WRITE_ADV
block|,
name|RDMA_WRITE_COMPLETE
block|,
name|DISCONNECTED
block|,
name|ERROR
block|}
enum|;
end_enum

begin_struct
struct|struct
name|rping_rdma_info
block|{
name|__be64
name|buf
decl_stmt|;
name|__be32
name|rkey
decl_stmt|;
name|__be32
name|size
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Default max buffer size for IO...  */
end_comment

begin_define
define|#
directive|define
name|RPING_BUFSIZE
value|64*1024
end_define

begin_define
define|#
directive|define
name|RPING_SQ_DEPTH
value|16
end_define

begin_comment
comment|/* Default string for print data and  * minimum buffer size  */
end_comment

begin_define
define|#
directive|define
name|_stringify
parameter_list|(
name|_x
parameter_list|)
value|# _x
end_define

begin_define
define|#
directive|define
name|stringify
parameter_list|(
name|_x
parameter_list|)
value|_stringify( _x )
end_define

begin_define
define|#
directive|define
name|RPING_MSG_FMT
value|"rdma-ping-%d: "
end_define

begin_define
define|#
directive|define
name|RPING_MIN_BUFSIZE
value|sizeof(stringify(INT_MAX)) + sizeof(RPING_MSG_FMT)
end_define

begin_comment
comment|/*  * Control block struct.  */
end_comment

begin_struct
struct|struct
name|rping_cb
block|{
name|int
name|server
decl_stmt|;
comment|/* 0 iff client */
name|pthread_t
name|cqthread
decl_stmt|;
name|pthread_t
name|persistent_server_thread
decl_stmt|;
name|struct
name|ibv_comp_channel
modifier|*
name|channel
decl_stmt|;
name|struct
name|ibv_cq
modifier|*
name|cq
decl_stmt|;
name|struct
name|ibv_pd
modifier|*
name|pd
decl_stmt|;
name|struct
name|ibv_qp
modifier|*
name|qp
decl_stmt|;
name|struct
name|ibv_recv_wr
name|rq_wr
decl_stmt|;
comment|/* recv work request record */
name|struct
name|ibv_sge
name|recv_sgl
decl_stmt|;
comment|/* recv single SGE */
name|struct
name|rping_rdma_info
name|recv_buf
decl_stmt|;
comment|/* malloc'd buffer */
name|struct
name|ibv_mr
modifier|*
name|recv_mr
decl_stmt|;
comment|/* MR associated with this buffer */
name|struct
name|ibv_send_wr
name|sq_wr
decl_stmt|;
comment|/* send work request record */
name|struct
name|ibv_sge
name|send_sgl
decl_stmt|;
name|struct
name|rping_rdma_info
name|send_buf
decl_stmt|;
comment|/* single send buf */
name|struct
name|ibv_mr
modifier|*
name|send_mr
decl_stmt|;
name|struct
name|ibv_send_wr
name|rdma_sq_wr
decl_stmt|;
comment|/* rdma work request record */
name|struct
name|ibv_sge
name|rdma_sgl
decl_stmt|;
comment|/* rdma single SGE */
name|char
modifier|*
name|rdma_buf
decl_stmt|;
comment|/* used as rdma sink */
name|struct
name|ibv_mr
modifier|*
name|rdma_mr
decl_stmt|;
name|uint32_t
name|remote_rkey
decl_stmt|;
comment|/* remote guys RKEY */
name|uint64_t
name|remote_addr
decl_stmt|;
comment|/* remote guys TO */
name|uint32_t
name|remote_len
decl_stmt|;
comment|/* remote guys LEN */
name|char
modifier|*
name|start_buf
decl_stmt|;
comment|/* rdma read src */
name|struct
name|ibv_mr
modifier|*
name|start_mr
decl_stmt|;
name|enum
name|test_state
name|state
decl_stmt|;
comment|/* used for cond/signalling */
name|sem_t
name|sem
decl_stmt|;
name|struct
name|sockaddr_storage
name|sin
decl_stmt|;
name|struct
name|sockaddr_storage
name|ssource
decl_stmt|;
name|__be16
name|port
decl_stmt|;
comment|/* dst port in NBO */
name|int
name|verbose
decl_stmt|;
comment|/* verbose logging */
name|int
name|count
decl_stmt|;
comment|/* ping count */
name|int
name|size
decl_stmt|;
comment|/* ping data size */
name|int
name|validate
decl_stmt|;
comment|/* validate ping data */
comment|/* CM stuff */
name|pthread_t
name|cmthread
decl_stmt|;
name|struct
name|rdma_event_channel
modifier|*
name|cm_channel
decl_stmt|;
name|struct
name|rdma_cm_id
modifier|*
name|cm_id
decl_stmt|;
comment|/* connection on client side,*/
comment|/* listener on service side. */
name|struct
name|rdma_cm_id
modifier|*
name|child_cm_id
decl_stmt|;
comment|/* connection on server side */
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|rping_cma_event_handler
parameter_list|(
name|struct
name|rdma_cm_id
modifier|*
name|cma_id
parameter_list|,
name|struct
name|rdma_cm_event
modifier|*
name|event
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|rping_cb
modifier|*
name|cb
init|=
name|cma_id
operator|->
name|context
decl_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"cma_event type %s cma_id %p (%s)\n"
argument_list|,
name|rdma_event_str
argument_list|(
name|event
operator|->
name|event
argument_list|)
argument_list|,
name|cma_id
argument_list|,
operator|(
name|cma_id
operator|==
name|cb
operator|->
name|cm_id
operator|)
condition|?
literal|"parent"
else|:
literal|"child"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|event
condition|)
block|{
case|case
name|RDMA_CM_EVENT_ADDR_RESOLVED
case|:
name|cb
operator|->
name|state
operator|=
name|ADDR_RESOLVED
expr_stmt|;
name|ret
operator|=
name|rdma_resolve_route
argument_list|(
name|cma_id
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
name|perror
argument_list|(
literal|"rdma_resolve_route"
argument_list|)
expr_stmt|;
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RDMA_CM_EVENT_ROUTE_RESOLVED
case|:
name|cb
operator|->
name|state
operator|=
name|ROUTE_RESOLVED
expr_stmt|;
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_CONNECT_REQUEST
case|:
name|cb
operator|->
name|state
operator|=
name|CONNECT_REQUEST
expr_stmt|;
name|cb
operator|->
name|child_cm_id
operator|=
name|cma_id
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"child cma %p\n"
argument_list|,
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_ESTABLISHED
case|:
name|DEBUG_LOG
argument_list|(
literal|"ESTABLISHED\n"
argument_list|)
expr_stmt|;
comment|/* 		 * Server will wake up when first RECV completes. 		 */
if|if
condition|(
operator|!
name|cb
operator|->
name|server
condition|)
block|{
name|cb
operator|->
name|state
operator|=
name|CONNECTED
expr_stmt|;
block|}
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_ADDR_ERROR
case|:
case|case
name|RDMA_CM_EVENT_ROUTE_ERROR
case|:
case|case
name|RDMA_CM_EVENT_CONNECT_ERROR
case|:
case|case
name|RDMA_CM_EVENT_UNREACHABLE
case|:
case|case
name|RDMA_CM_EVENT_REJECTED
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cma event %s, error %d\n"
argument_list|,
name|rdma_event_str
argument_list|(
name|event
operator|->
name|event
argument_list|)
argument_list|,
name|event
operator|->
name|status
argument_list|)
expr_stmt|;
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_DISCONNECTED
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s DISCONNECT EVENT...\n"
argument_list|,
name|cb
operator|->
name|server
condition|?
literal|"server"
else|:
literal|"client"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|DISCONNECTED
expr_stmt|;
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_DEVICE_REMOVAL
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cma detected device removal!!!!\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unhandled event: %s, ignoring\n"
argument_list|,
name|rdma_event_str
argument_list|(
name|event
operator|->
name|event
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|server_recv
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|,
name|struct
name|ibv_wc
modifier|*
name|wc
parameter_list|)
block|{
if|if
condition|(
name|wc
operator|->
name|byte_len
operator|!=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Received bogus data, size %d\n"
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cb
operator|->
name|remote_rkey
operator|=
name|be32toh
argument_list|(
name|cb
operator|->
name|recv_buf
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|cb
operator|->
name|remote_addr
operator|=
name|be64toh
argument_list|(
name|cb
operator|->
name|recv_buf
operator|.
name|buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|remote_len
operator|=
name|be32toh
argument_list|(
name|cb
operator|->
name|recv_buf
operator|.
name|size
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"Received rkey %x addr %"
name|PRIx64
literal|" len %d from peer\n"
argument_list|,
name|cb
operator|->
name|remote_rkey
argument_list|,
name|cb
operator|->
name|remote_addr
argument_list|,
name|cb
operator|->
name|remote_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|<=
name|CONNECTED
operator|||
name|cb
operator|->
name|state
operator|==
name|RDMA_WRITE_COMPLETE
condition|)
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
else|else
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_ADV
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|client_recv
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|,
name|struct
name|ibv_wc
modifier|*
name|wc
parameter_list|)
block|{
if|if
condition|(
name|wc
operator|->
name|byte_len
operator|!=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Received bogus data, size %d\n"
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|RDMA_READ_ADV
condition|)
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_ADV
expr_stmt|;
else|else
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_COMPLETE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_cq_event_handler
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ibv_wc
name|wc
decl_stmt|;
name|struct
name|ibv_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|flushed
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|ret
operator|=
name|ibv_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|)
operator|==
literal|1
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
if|if
condition|(
name|wc
operator|.
name|status
operator|==
name|IBV_WC_WR_FLUSH_ERR
condition|)
block|{
name|flushed
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cq completion failed status %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|error
goto|;
block|}
switch|switch
condition|(
name|wc
operator|.
name|opcode
condition|)
block|{
case|case
name|IBV_WC_SEND
case|:
name|DEBUG_LOG
argument_list|(
literal|"send completion\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IBV_WC_RDMA_WRITE
case|:
name|DEBUG_LOG
argument_list|(
literal|"rdma write completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_COMPLETE
expr_stmt|;
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|IBV_WC_RDMA_READ
case|:
name|DEBUG_LOG
argument_list|(
literal|"rdma read completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_COMPLETE
expr_stmt|;
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|IBV_WC_RECV
case|:
name|DEBUG_LOG
argument_list|(
literal|"recv completion\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cb
operator|->
name|server
condition|?
name|server_recv
argument_list|(
name|cb
argument_list|,
operator|&
name|wc
argument_list|)
else|:
name|client_recv
argument_list|(
name|cb
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"recv wc error: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
name|ibv_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"post recv error: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DEBUG_LOG
argument_list|(
literal|"unknown!!!!! completion\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"poll error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
return|return
name|flushed
return|;
name|error
label|:
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
name|sem_post
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_accept
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"accepting client connection request\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_accept
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rdma_accept"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for CONNECTED state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rping_setup_wr
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|cb
operator|->
name|recv_sgl
operator|.
name|addr
operator|=
operator|(
name|uint64_t
operator|)
operator|(
name|unsigned
name|long
operator|)
operator|&
name|cb
operator|->
name|recv_buf
expr_stmt|;
name|cb
operator|->
name|recv_sgl
operator|.
name|length
operator|=
sizeof|sizeof
name|cb
operator|->
name|recv_buf
expr_stmt|;
name|cb
operator|->
name|recv_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|recv_mr
operator|->
name|lkey
expr_stmt|;
name|cb
operator|->
name|rq_wr
operator|.
name|sg_list
operator|=
operator|&
name|cb
operator|->
name|recv_sgl
expr_stmt|;
name|cb
operator|->
name|rq_wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
name|cb
operator|->
name|send_sgl
operator|.
name|addr
operator|=
operator|(
name|uint64_t
operator|)
operator|(
name|unsigned
name|long
operator|)
operator|&
name|cb
operator|->
name|send_buf
expr_stmt|;
name|cb
operator|->
name|send_sgl
operator|.
name|length
operator|=
sizeof|sizeof
name|cb
operator|->
name|send_buf
expr_stmt|;
name|cb
operator|->
name|send_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|send_mr
operator|->
name|lkey
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|opcode
operator|=
name|IBV_WR_SEND
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|send_flags
operator|=
name|IBV_SEND_SIGNALED
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|sg_list
operator|=
operator|&
name|cb
operator|->
name|send_sgl
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
name|cb
operator|->
name|rdma_sgl
operator|.
name|addr
operator|=
operator|(
name|uint64_t
operator|)
operator|(
name|unsigned
name|long
operator|)
name|cb
operator|->
name|rdma_buf
expr_stmt|;
name|cb
operator|->
name|rdma_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|rdma_mr
operator|->
name|lkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|send_flags
operator|=
name|IBV_SEND_SIGNALED
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|=
operator|&
name|cb
operator|->
name|rdma_sgl
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_setup_buffers
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"rping_setup_buffers called on cb %p\n"
argument_list|,
name|cb
argument_list|)
expr_stmt|;
name|cb
operator|->
name|recv_mr
operator|=
name|ibv_reg_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|cb
operator|->
name|recv_buf
argument_list|,
sizeof|sizeof
name|cb
operator|->
name|recv_buf
argument_list|,
name|IBV_ACCESS_LOCAL_WRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|recv_mr
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"recv_buf reg_mr failed\n"
argument_list|)
expr_stmt|;
return|return
name|errno
return|;
block|}
name|cb
operator|->
name|send_mr
operator|=
name|ibv_reg_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|cb
operator|->
name|send_buf
argument_list|,
sizeof|sizeof
name|cb
operator|->
name|send_buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|send_mr
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"send_buf reg_mr failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|errno
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|cb
operator|->
name|rdma_buf
operator|=
name|malloc
argument_list|(
name|cb
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|rdma_buf
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rdma_buf malloc failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|cb
operator|->
name|rdma_mr
operator|=
name|ibv_reg_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|IBV_ACCESS_LOCAL_WRITE
operator||
name|IBV_ACCESS_REMOTE_READ
operator||
name|IBV_ACCESS_REMOTE_WRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|rdma_mr
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rdma_buf reg_mr failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|errno
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
if|if
condition|(
operator|!
name|cb
operator|->
name|server
condition|)
block|{
name|cb
operator|->
name|start_buf
operator|=
name|malloc
argument_list|(
name|cb
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|start_buf
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"start_buf malloc failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err4
goto|;
block|}
name|cb
operator|->
name|start_mr
operator|=
name|ibv_reg_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|IBV_ACCESS_LOCAL_WRITE
operator||
name|IBV_ACCESS_REMOTE_READ
operator||
name|IBV_ACCESS_REMOTE_WRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|start_mr
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"start_buf reg_mr failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|errno
expr_stmt|;
goto|goto
name|err5
goto|;
block|}
block|}
name|rping_setup_wr
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"allocated& registered buffers...\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err5
label|:
name|free
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|)
expr_stmt|;
name|err4
label|:
name|ibv_dereg_mr
argument_list|(
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
name|err3
label|:
name|free
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|)
expr_stmt|;
name|err2
label|:
name|ibv_dereg_mr
argument_list|(
name|cb
operator|->
name|send_mr
argument_list|)
expr_stmt|;
name|err1
label|:
name|ibv_dereg_mr
argument_list|(
name|cb
operator|->
name|recv_mr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rping_free_buffers
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|DEBUG_LOG
argument_list|(
literal|"rping_free_buffers called on cb %p\n"
argument_list|,
name|cb
argument_list|)
expr_stmt|;
name|ibv_dereg_mr
argument_list|(
name|cb
operator|->
name|recv_mr
argument_list|)
expr_stmt|;
name|ibv_dereg_mr
argument_list|(
name|cb
operator|->
name|send_mr
argument_list|)
expr_stmt|;
name|ibv_dereg_mr
argument_list|(
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|server
condition|)
block|{
name|ibv_dereg_mr
argument_list|(
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rping_create_qp
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ibv_qp_init_attr
name|init_attr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|init_attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_attr
argument_list|)
argument_list|)
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_send_wr
operator|=
name|RPING_SQ_DEPTH
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_recv_wr
operator|=
literal|2
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_recv_sge
operator|=
literal|1
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_send_sge
operator|=
literal|1
expr_stmt|;
name|init_attr
operator|.
name|qp_type
operator|=
name|IBV_QPT_RC
expr_stmt|;
name|init_attr
operator|.
name|send_cq
operator|=
name|cb
operator|->
name|cq
expr_stmt|;
name|init_attr
operator|.
name|recv_cq
operator|=
name|cb
operator|->
name|cq
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|server
condition|)
block|{
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|,
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|init_attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|cb
operator|->
name|qp
operator|=
name|cb
operator|->
name|child_cm_id
operator|->
name|qp
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|init_attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|cb
operator|->
name|qp
operator|=
name|cb
operator|->
name|cm_id
operator|->
name|qp
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rping_free_qp
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|ibv_destroy_qp
argument_list|(
name|cb
operator|->
name|qp
argument_list|)
expr_stmt|;
name|ibv_destroy_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
name|ibv_destroy_comp_channel
argument_list|(
name|cb
operator|->
name|channel
argument_list|)
expr_stmt|;
name|ibv_dealloc_pd
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_setup_qp
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|,
name|struct
name|rdma_cm_id
modifier|*
name|cm_id
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|cb
operator|->
name|pd
operator|=
name|ibv_alloc_pd
argument_list|(
name|cm_id
operator|->
name|verbs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|pd
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ibv_alloc_pd failed\n"
argument_list|)
expr_stmt|;
return|return
name|errno
return|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"created pd %p\n"
argument_list|,
name|cb
operator|->
name|pd
argument_list|)
expr_stmt|;
name|cb
operator|->
name|channel
operator|=
name|ibv_create_comp_channel
argument_list|(
name|cm_id
operator|->
name|verbs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|channel
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ibv_create_comp_channel failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|errno
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"created channel %p\n"
argument_list|,
name|cb
operator|->
name|channel
argument_list|)
expr_stmt|;
name|cb
operator|->
name|cq
operator|=
name|ibv_create_cq
argument_list|(
name|cm_id
operator|->
name|verbs
argument_list|,
name|RPING_SQ_DEPTH
operator|*
literal|2
argument_list|,
name|cb
argument_list|,
name|cb
operator|->
name|channel
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|cq
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ibv_create_cq failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|errno
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"created cq %p\n"
argument_list|,
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ibv_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ibv_create_cq failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|errno
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|ret
operator|=
name|rping_create_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rdma_create_qp"
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"created qp %p\n"
argument_list|,
name|cb
operator|->
name|qp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err3
label|:
name|ibv_destroy_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
name|err2
label|:
name|ibv_destroy_comp_channel
argument_list|(
name|cb
operator|->
name|channel
argument_list|)
expr_stmt|;
name|err1
label|:
name|ibv_dealloc_pd
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|cm_thread
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rping_cb
modifier|*
name|cb
init|=
name|arg
decl_stmt|;
name|struct
name|rdma_cm_event
modifier|*
name|event
decl_stmt|;
name|int
name|ret
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|ret
operator|=
name|rdma_get_cm_event
argument_list|(
name|cb
operator|->
name|cm_channel
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rdma_get_cm_event"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|rping_cma_event_handler
argument_list|(
name|event
operator|->
name|id
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|rdma_ack_cm_event
argument_list|(
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|exit
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|cq_thread
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rping_cb
modifier|*
name|cb
init|=
name|arg
decl_stmt|;
name|struct
name|ibv_cq
modifier|*
name|ev_cq
decl_stmt|;
name|void
modifier|*
name|ev_ctx
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"cq_thread started.\n"
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|pthread_testcancel
argument_list|()
expr_stmt|;
name|ret
operator|=
name|ibv_get_cq_event
argument_list|(
name|cb
operator|->
name|channel
argument_list|,
operator|&
name|ev_cq
argument_list|,
operator|&
name|ev_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to get cq event!\n"
argument_list|)
expr_stmt|;
name|pthread_exit
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ev_cq
operator|!=
name|cb
operator|->
name|cq
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown CQ!\n"
argument_list|)
expr_stmt|;
name|pthread_exit
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|ibv_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to set notify!\n"
argument_list|)
expr_stmt|;
name|pthread_exit
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|rping_cq_event_handler
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|ibv_ack_cq_events
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|pthread_exit
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rping_format_send
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|struct
name|ibv_mr
modifier|*
name|mr
parameter_list|)
block|{
name|struct
name|rping_rdma_info
modifier|*
name|info
init|=
operator|&
name|cb
operator|->
name|send_buf
decl_stmt|;
name|info
operator|->
name|buf
operator|=
name|htobe64
argument_list|(
operator|(
name|uint64_t
operator|)
operator|(
name|unsigned
name|long
operator|)
name|buf
argument_list|)
expr_stmt|;
name|info
operator|->
name|rkey
operator|=
name|htobe32
argument_list|(
name|mr
operator|->
name|rkey
argument_list|)
expr_stmt|;
name|info
operator|->
name|size
operator|=
name|htobe32
argument_list|(
name|cb
operator|->
name|size
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"RDMA addr %"
name|PRIx64
literal|" rkey %x len %d\n"
argument_list|,
name|be64toh
argument_list|(
name|info
operator|->
name|buf
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|info
operator|->
name|rkey
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|info
operator|->
name|size
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_test_server
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ibv_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* Wait for client's Start STAG/TO/Len */
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_READ_ADV
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for RDMA_READ_ADV state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server received sink adv\n"
argument_list|)
expr_stmt|;
comment|/* Issue RDMA Read. */
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|opcode
operator|=
name|IBV_WR_RDMA_READ
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|cb
operator|->
name|remote_len
expr_stmt|;
name|ret
operator|=
name|ibv_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server posted rdma read req \n"
argument_list|)
expr_stmt|;
comment|/* Wait for read completion */
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_READ_COMPLETE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for RDMA_READ_COMPLETE state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server received read complete\n"
argument_list|)
expr_stmt|;
comment|/* Display data in recv buf */
if|if
condition|(
name|cb
operator|->
name|verbose
condition|)
name|printf
argument_list|(
literal|"server ping data: %s\n"
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|)
expr_stmt|;
comment|/* Tell client to continue */
name|ret
operator|=
name|ibv_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server posted go ahead\n"
argument_list|)
expr_stmt|;
comment|/* Wait for client's RDMA STAG/TO/Len */
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_ADV
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for RDMA_WRITE_ADV state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server received sink adv\n"
argument_list|)
expr_stmt|;
comment|/* RDMA Write echo data */
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|opcode
operator|=
name|IBV_WR_RDMA_WRITE
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|strlen
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|)
operator|+
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"rdma write from lkey %x laddr %"
name|PRIx64
literal|" len %d\n"
argument_list|,
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|lkey
argument_list|,
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|addr
argument_list|,
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ibv_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Wait for completion */
name|ret
operator|=
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_COMPLETE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for RDMA_WRITE_COMPLETE state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server rdma write complete \n"
argument_list|)
expr_stmt|;
comment|/* Tell client to begin again */
name|ret
operator|=
name|ibv_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server posted go ahead\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|cb
operator|->
name|state
operator|==
name|DISCONNECTED
operator|)
condition|?
literal|0
else|:
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_bind_server
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|cb
operator|->
name|sin
operator|.
name|ss_family
operator|==
name|AF_INET
condition|)
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|cb
operator|->
name|sin
operator|)
operator|->
name|sin_port
operator|=
name|cb
operator|->
name|port
expr_stmt|;
else|else
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|cb
operator|->
name|sin
operator|)
operator|->
name|sin6_port
operator|=
name|cb
operator|->
name|port
expr_stmt|;
name|ret
operator|=
name|rdma_bind_addr
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cb
operator|->
name|sin
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rdma_bind_addr"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"rdma_bind_addr successful\n"
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"rdma_listen\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_listen
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rdma_listen"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|rping_cb
modifier|*
name|clone_cb
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|listening_cb
parameter_list|)
block|{
name|struct
name|rping_cb
modifier|*
name|cb
init|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|cb
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|cb
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|cb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|cb
argument_list|)
expr_stmt|;
operator|*
name|cb
operator|=
operator|*
name|listening_cb
expr_stmt|;
name|cb
operator|->
name|child_cm_id
operator|->
name|context
operator|=
name|cb
expr_stmt|;
return|return
name|cb
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_cb
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|free
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|rping_persistent_server_thread
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rping_cb
modifier|*
name|cb
init|=
name|arg
decl_stmt|;
name|struct
name|ibv_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|rping_setup_qp
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"setup_qp failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err0
goto|;
block|}
name|ret
operator|=
name|rping_setup_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rping_setup_buffers failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|ret
operator|=
name|ibv_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ibv_post_recv failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|pthread_create
argument_list|(
operator|&
name|cb
operator|->
name|cqthread
argument_list|,
name|NULL
argument_list|,
name|cq_thread
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"pthread_create"
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|rping_accept
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connect error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|rping_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|rdma_disconnect
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|pthread_join
argument_list|(
name|cb
operator|->
name|cqthread
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rping_free_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|rping_free_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|free_cb
argument_list|(
name|cb
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
name|err3
label|:
name|pthread_cancel
argument_list|(
name|cb
operator|->
name|cqthread
argument_list|)
expr_stmt|;
name|pthread_join
argument_list|(
name|cb
operator|->
name|cqthread
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|err2
label|:
name|rping_free_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|err1
label|:
name|rping_free_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|err0
label|:
name|free_cb
argument_list|(
name|cb
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_run_persistent_server
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|listening_cb
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|rping_cb
modifier|*
name|cb
decl_stmt|;
name|pthread_attr_t
name|attr
decl_stmt|;
name|ret
operator|=
name|rping_bind_server
argument_list|(
name|listening_cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* 	 * Set persistent server threads to DEATCHED state so 	 * they release all their resources when they exit. 	 */
name|ret
operator|=
name|pthread_attr_init
argument_list|(
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"pthread_attr_init"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|pthread_attr_setdetachstate
argument_list|(
operator|&
name|attr
argument_list|,
name|PTHREAD_CREATE_DETACHED
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"pthread_attr_setdetachstate"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|sem_wait
argument_list|(
operator|&
name|listening_cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|listening_cb
operator|->
name|state
operator|!=
name|CONNECT_REQUEST
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for CONNECT_REQUEST state %d\n"
argument_list|,
name|listening_cb
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cb
operator|=
name|clone_cb
argument_list|(
name|listening_cb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|pthread_create
argument_list|(
operator|&
name|cb
operator|->
name|persistent_server_thread
argument_list|,
operator|&
name|attr
argument_list|,
name|rping_persistent_server_thread
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"pthread_create"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_run_server
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ibv_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|rping_bind_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|CONNECT_REQUEST
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for CONNECT_REQUEST state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|rping_setup_qp
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"setup_qp failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|rping_setup_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rping_setup_buffers failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|ret
operator|=
name|ibv_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ibv_post_recv failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|pthread_create
argument_list|(
operator|&
name|cb
operator|->
name|cqthread
argument_list|,
name|NULL
argument_list|,
name|cq_thread
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"pthread_create"
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|rping_accept
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connect error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|rping_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rping server failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|err3
label|:
name|rdma_disconnect
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|pthread_join
argument_list|(
name|cb
operator|->
name|cqthread
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|err2
label|:
name|rping_free_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|err1
label|:
name|rping_free_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_test_client
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ping
decl_stmt|,
name|start
decl_stmt|,
name|cc
decl_stmt|,
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|ibv_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|unsigned
name|char
name|c
decl_stmt|;
name|start
operator|=
literal|65
expr_stmt|;
for|for
control|(
name|ping
operator|=
literal|0
init|;
operator|!
name|cb
operator|->
name|count
operator|||
name|ping
operator|<
name|cb
operator|->
name|count
condition|;
name|ping
operator|++
control|)
block|{
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
comment|/* Put some ascii text in the buffer. */
name|cc
operator|=
name|snprintf
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|RPING_MSG_FMT
argument_list|,
name|ping
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|cc
operator|,
name|c
operator|=
name|start
init|;
name|i
operator|<
name|cb
operator|->
name|size
condition|;
name|i
operator|++
control|)
block|{
name|cb
operator|->
name|start_buf
index|[
name|i
index|]
operator|=
name|c
expr_stmt|;
name|c
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|>
literal|122
condition|)
name|c
operator|=
literal|65
expr_stmt|;
block|}
name|start
operator|++
expr_stmt|;
if|if
condition|(
name|start
operator|>
literal|122
condition|)
name|start
operator|=
literal|65
expr_stmt|;
name|cb
operator|->
name|start_buf
index|[
name|cb
operator|->
name|size
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|rping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ibv_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Wait for server to ACK */
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_ADV
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for RDMA_WRITE_ADV state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|rping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|,
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ibv_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Wait for the server to say the RDMA Write is complete. */
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_COMPLETE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for RDMA_WRITE_COMPLETE state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cb
operator|->
name|validate
condition|)
if|if
condition|(
name|memcmp
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"data mismatch!\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cb
operator|->
name|verbose
condition|)
name|printf
argument_list|(
literal|"ping data: %s\n"
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|cb
operator|->
name|state
operator|==
name|DISCONNECTED
operator|)
condition|?
literal|0
else|:
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_connect_client
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|rdma_conn_param
name|conn_param
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|conn_param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|conn_param
argument_list|)
expr_stmt|;
name|conn_param
operator|.
name|responder_resources
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|initiator_depth
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|retry_count
operator|=
literal|7
expr_stmt|;
name|ret
operator|=
name|rdma_connect
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
operator|&
name|conn_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rdma_connect"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|CONNECTED
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"wait for CONNECTED state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"rmda_connect successful\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_bind_client
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|cb
operator|->
name|sin
operator|.
name|ss_family
operator|==
name|AF_INET
condition|)
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|cb
operator|->
name|sin
operator|)
operator|->
name|sin_port
operator|=
name|cb
operator|->
name|port
expr_stmt|;
else|else
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|cb
operator|->
name|sin
operator|)
operator|->
name|sin6_port
operator|=
name|cb
operator|->
name|port
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ssource
operator|.
name|ss_family
condition|)
name|ret
operator|=
name|rdma_resolve_addr
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cb
operator|->
name|ssource
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cb
operator|->
name|sin
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|rdma_resolve_addr
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
name|NULL
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cb
operator|->
name|sin
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rdma_resolve_addr"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|sem_wait
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|ROUTE_RESOLVED
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"waiting for addr/route resolution state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"rdma_resolve_addr - rdma_resolve_route successful\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rping_run_client
parameter_list|(
name|struct
name|rping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ibv_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|rping_bind_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|rping_setup_qp
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"setup_qp failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|rping_setup_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rping_setup_buffers failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|ret
operator|=
name|ibv_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ibv_post_recv failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|pthread_create
argument_list|(
operator|&
name|cb
operator|->
name|cqthread
argument_list|,
name|NULL
argument_list|,
name|cq_thread
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"pthread_create"
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|rping_connect_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"connect error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|ret
operator|=
name|rping_test_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"rping client failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err4
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|err4
label|:
name|rdma_disconnect
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|err3
label|:
name|pthread_join
argument_list|(
name|cb
operator|->
name|cqthread
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|err2
label|:
name|rping_free_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|err1
label|:
name|rping_free_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_addr
parameter_list|(
name|char
modifier|*
name|dst
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|addrinfo
modifier|*
name|res
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|getaddrinfo
argument_list|(
name|dst
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"getaddrinfo failed (%s) - invalid hostname or IP address\n"
argument_list|,
name|gai_strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|res
operator|->
name|ai_family
operator|==
name|PF_INET
condition|)
name|memcpy
argument_list|(
name|addr
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|->
name|ai_family
operator|==
name|PF_INET6
condition|)
name|memcpy
argument_list|(
name|addr
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s -s [-vVd] [-S size] [-C count] [-a addr] [-p port]\n"
argument_list|,
name|basename
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s -c [-vVd] [-S size] [-C count] [-I addr] -a addr [-p port]\n"
argument_list|,
name|basename
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-c\t\tclient side\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-I\t\tSource address to bind to for client.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-s\t\tserver side.  To bind to any address with IPv6 use -a ::0\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-v\t\tdisplay ping data to stdout\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-V\t\tvalidate ping data\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-d\t\tdebug printfs\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-S size \tping data size\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-C count\tping count times\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-a addr\t\taddress\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-p port\t\tport\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-P\t\tpersistent server mode allowing multiple connections\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|rping_cb
modifier|*
name|cb
decl_stmt|;
name|int
name|op
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|persistent_server
init|=
literal|0
decl_stmt|;
name|cb
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|memset
argument_list|(
name|cb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cb
argument_list|)
argument_list|)
expr_stmt|;
name|cb
operator|->
name|server
operator|=
operator|-
literal|1
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|IDLE
expr_stmt|;
name|cb
operator|->
name|size
operator|=
literal|64
expr_stmt|;
name|cb
operator|->
name|sin
operator|.
name|ss_family
operator|=
name|PF_INET
expr_stmt|;
name|cb
operator|->
name|port
operator|=
name|htobe16
argument_list|(
literal|7174
argument_list|)
expr_stmt|;
name|sem_init
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|opterr
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|op
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"a:I:Pp:C:S:t:scvVd"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
literal|'a'
case|:
name|ret
operator|=
name|get_addr
argument_list|(
name|optarg
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cb
operator|->
name|sin
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|ret
operator|=
name|get_addr
argument_list|(
name|optarg
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cb
operator|->
name|ssource
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|persistent_server
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|cb
operator|->
name|port
operator|=
name|htobe16
argument_list|(
name|atoi
argument_list|(
name|optarg
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"port %d\n"
argument_list|,
operator|(
name|int
operator|)
name|atoi
argument_list|(
name|optarg
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|cb
operator|->
name|server
operator|=
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"server\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|cb
operator|->
name|server
operator|=
literal|0
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"client\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|cb
operator|->
name|size
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|size
operator|<
name|RPING_MIN_BUFSIZE
operator|)
operator|||
operator|(
name|cb
operator|->
name|size
operator|>
operator|(
name|RPING_BUFSIZE
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid size %d "
literal|"(valid range is %zd to %d)\n"
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|RPING_MIN_BUFSIZE
argument_list|,
name|RPING_BUFSIZE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
name|DEBUG_LOG
argument_list|(
literal|"size %d\n"
argument_list|,
operator|(
name|int
operator|)
name|atoi
argument_list|(
name|optarg
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|cb
operator|->
name|count
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|count
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid count %d\n"
argument_list|,
name|cb
operator|->
name|count
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
name|DEBUG_LOG
argument_list|(
literal|"count %d\n"
argument_list|,
operator|(
name|int
operator|)
name|cb
operator|->
name|count
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|cb
operator|->
name|verbose
operator|++
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"verbose\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
name|cb
operator|->
name|validate
operator|++
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"validate data\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|debug
operator|++
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
literal|"rping"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|cb
operator|->
name|server
operator|==
operator|-
literal|1
condition|)
block|{
name|usage
argument_list|(
literal|"rping"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cb
operator|->
name|cm_channel
operator|=
name|rdma_create_event_channel
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|cm_channel
condition|)
block|{
name|perror
argument_list|(
literal|"rdma_create_event_channel"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|errno
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|rdma_create_id
argument_list|(
name|cb
operator|->
name|cm_channel
argument_list|,
operator|&
name|cb
operator|->
name|cm_id
argument_list|,
name|cb
argument_list|,
name|RDMA_PS_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rdma_create_id"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"created cm_id %p\n"
argument_list|,
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|ret
operator|=
name|pthread_create
argument_list|(
operator|&
name|cb
operator|->
name|cmthread
argument_list|,
name|NULL
argument_list|,
name|cm_thread
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"pthread_create"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
name|cb
operator|->
name|server
condition|)
block|{
if|if
condition|(
name|persistent_server
condition|)
name|ret
operator|=
name|rping_run_persistent_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|rping_run_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|rping_run_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"destroy cm_id %p\n"
argument_list|,
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|out2
label|:
name|rdma_destroy_event_channel
argument_list|(
name|cb
operator|->
name|cm_channel
argument_list|)
expr_stmt|;
name|out
label|:
name|free
argument_list|(
name|cb
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2011-2012 Intel Corporation.  All rights reserved.  * Copyright (c) 2014-2015 Mellanox Technologies LTD. All rights reserved.  *  * This software is available to you under the OpenIB.org BSD license  * below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AWV  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<rdma/rdma_cma.h>
end_include

begin_include
include|#
directive|include
file|<rdma/rsocket.h>
end_include

begin_include
include|#
directive|include
file|<util/compiler.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_struct
struct|struct
name|test_size_param
block|{
name|int
name|size
decl_stmt|;
name|int
name|option
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|test_size_param
name|test_size
index|[]
init|=
block|{
block|{
literal|1
operator|<<
literal|6
block|,
literal|0
block|}
block|,
block|{
literal|1
operator|<<
literal|7
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|6
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|8
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|8
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|7
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|9
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|9
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|8
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|10
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|10
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|9
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|11
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|11
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|10
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|12
block|,
literal|0
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|12
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|11
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|13
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|13
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|12
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|14
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|14
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|13
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|15
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|15
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|14
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|16
block|,
literal|0
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|16
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|15
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|17
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|17
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|16
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|18
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|18
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|17
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|19
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|19
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|18
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|20
block|,
literal|0
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|20
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|19
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|21
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|21
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|20
operator|)
block|,
literal|1
block|}
block|,
block|{
literal|1
operator|<<
literal|22
block|,
literal|1
block|}
block|,
block|{
operator|(
literal|1
operator|<<
literal|22
operator|)
operator|+
operator|(
literal|1
operator|<<
literal|21
operator|)
block|,
literal|1
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|TEST_CNT
value|(sizeof test_size / sizeof test_size[0])
end_define

begin_decl_stmt
specifier|static
name|int
name|rs
decl_stmt|,
name|lrs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|use_async
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|use_rgai
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|verify
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|flags
init|=
name|MSG_DONTWAIT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|poll_timeout
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|custom
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|use_fork
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|pid_t
name|fork_pid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|enum
name|rs_optimization
name|optimization
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|size_option
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|iterations
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|transfer_size
init|=
literal|1000
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|transfer_count
init|=
literal|1000
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|buffer_size
decl_stmt|,
name|inline_size
init|=
literal|64
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|test_name
index|[
literal|10
index|]
init|=
literal|"custom"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|port
init|=
literal|"7471"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|keepalive
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dst_addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|src_addr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|timeval
name|start
decl_stmt|,
name|end
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|rdma_addrinfo
name|rai_hints
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|addrinfo
name|ai_hints
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|show_perf
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|str
index|[
literal|32
index|]
decl_stmt|;
name|float
name|usec
decl_stmt|;
name|long
name|long
name|bytes
decl_stmt|;
name|usec
operator|=
operator|(
name|end
operator|.
name|tv_sec
operator|-
name|start
operator|.
name|tv_sec
operator|)
operator|*
literal|1000000
operator|+
operator|(
name|end
operator|.
name|tv_usec
operator|-
name|start
operator|.
name|tv_usec
operator|)
expr_stmt|;
name|bytes
operator|=
operator|(
name|long
name|long
operator|)
name|iterations
operator|*
name|transfer_count
operator|*
name|transfer_size
operator|*
literal|2
expr_stmt|;
comment|/* name size transfers iterations bytes seconds Gb/sec usec/xfer */
name|printf
argument_list|(
literal|"%-10s"
argument_list|,
name|test_name
argument_list|)
expr_stmt|;
name|size_str
argument_list|(
name|str
argument_list|,
sizeof|sizeof
name|str
argument_list|,
name|transfer_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-8s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|cnt_str
argument_list|(
name|str
argument_list|,
sizeof|sizeof
name|str
argument_list|,
name|transfer_count
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-8s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|cnt_str
argument_list|(
name|str
argument_list|,
sizeof|sizeof
name|str
argument_list|,
name|iterations
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-8s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|size_str
argument_list|(
name|str
argument_list|,
sizeof|sizeof
name|str
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-8s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8.2fs%10.2f%11.2f\n"
argument_list|,
name|usec
operator|/
literal|1000000.
argument_list|,
operator|(
name|bytes
operator|*
literal|8
operator|)
operator|/
operator|(
literal|1000.
operator|*
name|usec
operator|)
argument_list|,
operator|(
name|usec
operator|/
name|iterations
operator|)
operator|/
operator|(
name|transfer_count
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|init_latency_test
parameter_list|(
name|int
name|size
parameter_list|)
block|{
name|char
name|sstr
index|[
literal|5
index|]
decl_stmt|;
name|size_str
argument_list|(
name|sstr
argument_list|,
sizeof|sizeof
name|sstr
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|test_name
argument_list|,
sizeof|sizeof
name|test_name
argument_list|,
literal|"%s_lat"
argument_list|,
name|sstr
argument_list|)
expr_stmt|;
name|transfer_count
operator|=
literal|1
expr_stmt|;
name|transfer_size
operator|=
name|size
expr_stmt|;
name|iterations
operator|=
name|size_to_count
argument_list|(
name|transfer_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|init_bandwidth_test
parameter_list|(
name|int
name|size
parameter_list|)
block|{
name|char
name|sstr
index|[
literal|5
index|]
decl_stmt|;
name|size_str
argument_list|(
name|sstr
argument_list|,
sizeof|sizeof
name|sstr
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|test_name
argument_list|,
sizeof|sizeof
name|test_name
argument_list|,
literal|"%s_bw"
argument_list|,
name|sstr
argument_list|)
expr_stmt|;
name|iterations
operator|=
literal|1
expr_stmt|;
name|transfer_size
operator|=
name|size
expr_stmt|;
name|transfer_count
operator|=
name|size_to_count
argument_list|(
name|transfer_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_xfer
parameter_list|(
name|int
name|size
parameter_list|)
block|{
name|struct
name|pollfd
name|fds
decl_stmt|;
name|int
name|offset
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
name|verify
condition|)
name|format_buf
argument_list|(
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_async
condition|)
block|{
name|fds
operator|.
name|fd
operator|=
name|rs
expr_stmt|;
name|fds
operator|.
name|events
operator|=
name|POLLOUT
expr_stmt|;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
name|size
condition|;
control|)
block|{
if|if
condition|(
name|use_async
condition|)
block|{
name|ret
operator|=
name|do_poll
argument_list|(
operator|&
name|fds
argument_list|,
name|poll_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|rs_send
argument_list|(
name|rs
argument_list|,
name|buf
operator|+
name|offset
argument_list|,
name|size
operator|-
name|offset
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
block|{
name|offset
operator|+=
name|ret
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|errno
operator|!=
name|EWOULDBLOCK
operator|&&
name|errno
operator|!=
name|EAGAIN
condition|)
block|{
name|perror
argument_list|(
literal|"rsend"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|recv_xfer
parameter_list|(
name|int
name|size
parameter_list|)
block|{
name|struct
name|pollfd
name|fds
decl_stmt|;
name|int
name|offset
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
name|use_async
condition|)
block|{
name|fds
operator|.
name|fd
operator|=
name|rs
expr_stmt|;
name|fds
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
name|size
condition|;
control|)
block|{
if|if
condition|(
name|use_async
condition|)
block|{
name|ret
operator|=
name|do_poll
argument_list|(
operator|&
name|fds
argument_list|,
name|poll_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|rs_recv
argument_list|(
name|rs
argument_list|,
name|buf
operator|+
name|offset
argument_list|,
name|size
operator|-
name|offset
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
block|{
name|offset
operator|+=
name|ret
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|errno
operator|!=
name|EWOULDBLOCK
operator|&&
name|errno
operator|!=
name|EAGAIN
condition|)
block|{
name|perror
argument_list|(
literal|"rrecv"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
if|if
condition|(
name|verify
condition|)
block|{
name|ret
operator|=
name|verify_buf
argument_list|(
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sync_test
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|dst_addr
condition|?
name|send_xfer
argument_list|(
literal|16
argument_list|)
else|:
name|recv_xfer
argument_list|(
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|dst_addr
condition|?
name|recv_xfer
argument_list|(
literal|16
argument_list|)
else|:
name|send_xfer
argument_list|(
literal|16
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_test
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|,
name|t
decl_stmt|;
name|ret
operator|=
name|sync_test
argument_list|()
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|gettimeofday
argument_list|(
operator|&
name|start
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iterations
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|transfer_count
condition|;
name|t
operator|++
control|)
block|{
name|ret
operator|=
name|dst_addr
condition|?
name|send_xfer
argument_list|(
name|transfer_size
argument_list|)
else|:
name|recv_xfer
argument_list|(
name|transfer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|transfer_count
condition|;
name|t
operator|++
control|)
block|{
name|ret
operator|=
name|dst_addr
condition|?
name|recv_xfer
argument_list|(
name|transfer_size
argument_list|)
else|:
name|send_xfer
argument_list|(
name|transfer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
block|}
name|gettimeofday
argument_list|(
operator|&
name|end
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|show_perf
argument_list|()
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|out
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_keepalive
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|int
name|optval
decl_stmt|;
name|socklen_t
name|optlen
init|=
sizeof|sizeof
argument_list|(
name|optlen
argument_list|)
decl_stmt|;
name|optval
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|rs_setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_KEEPALIVE
argument_list|,
operator|&
name|optval
argument_list|,
name|optlen
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"rsetsockopt SO_KEEPALIVE"
argument_list|)
expr_stmt|;
return|return;
block|}
name|optval
operator|=
name|keepalive
expr_stmt|;
if|if
condition|(
name|rs_setsockopt
argument_list|(
name|fd
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|TCP_KEEPIDLE
argument_list|,
operator|&
name|optval
argument_list|,
name|optlen
argument_list|)
condition|)
name|perror
argument_list|(
literal|"rsetsockopt TCP_KEEPIDLE"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs_getsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_KEEPALIVE
argument_list|,
operator|&
name|optval
argument_list|,
operator|&
name|optlen
argument_list|)
operator|)
condition|)
name|printf
argument_list|(
literal|"Keepalive: %s\n"
argument_list|,
operator|(
name|optval
condition|?
literal|"ON"
else|:
literal|"OFF"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs_getsockopt
argument_list|(
name|fd
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|TCP_KEEPIDLE
argument_list|,
operator|&
name|optval
argument_list|,
operator|&
name|optlen
argument_list|)
operator|)
condition|)
name|printf
argument_list|(
literal|"  time: %i\n"
argument_list|,
name|optval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_options
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|int
name|val
decl_stmt|;
if|if
condition|(
name|buffer_size
condition|)
block|{
name|rs_setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|buffer_size
argument_list|,
sizeof|sizeof
name|buffer_size
argument_list|)
expr_stmt|;
name|rs_setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|buffer_size
argument_list|,
sizeof|sizeof
name|buffer_size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
literal|1
operator|<<
literal|19
expr_stmt|;
name|rs_setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SNDBUF
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|val
argument_list|,
sizeof|sizeof
name|val
argument_list|)
expr_stmt|;
name|rs_setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_RCVBUF
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|val
argument_list|,
sizeof|sizeof
name|val
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
literal|1
expr_stmt|;
name|rs_setsockopt
argument_list|(
name|fd
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|TCP_NODELAY
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|MSG_DONTWAIT
condition|)
name|rs_fcntl
argument_list|(
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_rs
condition|)
block|{
comment|/* Inline size based on experimental data */
if|if
condition|(
name|optimization
operator|==
name|opt_latency
condition|)
block|{
name|rs_setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_RDMA
argument_list|,
name|RDMA_INLINE
argument_list|,
operator|&
name|inline_size
argument_list|,
sizeof|sizeof
name|inline_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|optimization
operator|==
name|opt_bandwidth
condition|)
block|{
name|val
operator|=
literal|0
expr_stmt|;
name|rs_setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_RDMA
argument_list|,
name|RDMA_INLINE
argument_list|,
operator|&
name|val
argument_list|,
sizeof|sizeof
name|val
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|keepalive
condition|)
name|set_keepalive
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|server_listen
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|rdma_addrinfo
modifier|*
name|rai
init|=
name|NULL
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|;
name|int
name|val
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
name|use_rgai
condition|)
block|{
name|rai_hints
operator|.
name|ai_flags
operator||=
name|RAI_PASSIVE
expr_stmt|;
name|ret
operator|=
name|rdma_getaddrinfo
argument_list|(
name|src_addr
argument_list|,
name|port
argument_list|,
operator|&
name|rai_hints
argument_list|,
operator|&
name|rai
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ai_hints
operator|.
name|ai_flags
operator||=
name|AI_PASSIVE
expr_stmt|;
name|ret
operator|=
name|getaddrinfo
argument_list|(
name|src_addr
argument_list|,
name|port
argument_list|,
operator|&
name|ai_hints
argument_list|,
operator|&
name|ai
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"getaddrinfo: %s\n"
argument_list|,
name|gai_strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|lrs
operator|=
name|rai
condition|?
name|rs_socket
argument_list|(
name|rai
operator|->
name|ai_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
else|:
name|rs_socket
argument_list|(
name|ai
operator|->
name|ai_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|lrs
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"rsocket"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|lrs
expr_stmt|;
goto|goto
name|free
goto|;
block|}
name|val
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|rs_setsockopt
argument_list|(
name|lrs
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_REUSEADDR
argument_list|,
operator|&
name|val
argument_list|,
sizeof|sizeof
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rsetsockopt SO_REUSEADDR"
argument_list|)
expr_stmt|;
goto|goto
name|close
goto|;
block|}
name|ret
operator|=
name|rai
condition|?
name|rs_bind
argument_list|(
name|lrs
argument_list|,
name|rai
operator|->
name|ai_src_addr
argument_list|,
name|rai
operator|->
name|ai_src_len
argument_list|)
else|:
name|rs_bind
argument_list|(
name|lrs
argument_list|,
name|ai
operator|->
name|ai_addr
argument_list|,
name|ai
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rbind"
argument_list|)
expr_stmt|;
goto|goto
name|close
goto|;
block|}
name|ret
operator|=
name|rs_listen
argument_list|(
name|lrs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|perror
argument_list|(
literal|"rlisten"
argument_list|)
expr_stmt|;
name|close
label|:
if|if
condition|(
name|ret
condition|)
name|rs_close
argument_list|(
name|lrs
argument_list|)
expr_stmt|;
name|free
label|:
if|if
condition|(
name|rai
condition|)
name|rdma_freeaddrinfo
argument_list|(
name|rai
argument_list|)
expr_stmt|;
else|else
name|freeaddrinfo
argument_list|(
name|ai
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|server_connect
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pollfd
name|fds
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|set_options
argument_list|(
name|lrs
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
name|use_async
condition|)
block|{
name|fds
operator|.
name|fd
operator|=
name|lrs
expr_stmt|;
name|fds
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
name|ret
operator|=
name|do_poll
argument_list|(
operator|&
name|fds
argument_list|,
name|poll_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rpoll"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|rs
operator|=
name|rs_accept
argument_list|(
name|lrs
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|rs
operator|<
literal|0
operator|&&
operator|(
name|errno
operator|==
name|EAGAIN
operator|||
name|errno
operator|==
name|EWOULDBLOCK
operator|)
condition|)
do|;
if|if
condition|(
name|rs
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"raccept"
argument_list|)
expr_stmt|;
return|return
name|rs
return|;
block|}
if|if
condition|(
name|use_fork
condition|)
name|fork_pid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|fork_pid
condition|)
name|set_options
argument_list|(
name|rs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|client_connect
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|rdma_addrinfo
modifier|*
name|rai
init|=
name|NULL
decl_stmt|,
modifier|*
name|rai_src
init|=
name|NULL
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|,
modifier|*
name|ai_src
decl_stmt|;
name|struct
name|pollfd
name|fds
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|err
decl_stmt|;
name|socklen_t
name|len
decl_stmt|;
name|ret
operator|=
name|use_rgai
condition|?
name|rdma_getaddrinfo
argument_list|(
name|dst_addr
argument_list|,
name|port
argument_list|,
operator|&
name|rai_hints
argument_list|,
operator|&
name|rai
argument_list|)
else|:
name|getaddrinfo
argument_list|(
name|dst_addr
argument_list|,
name|port
argument_list|,
operator|&
name|ai_hints
argument_list|,
operator|&
name|ai
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"getaddrinfo: %s\n"
argument_list|,
name|gai_strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|src_addr
condition|)
block|{
if|if
condition|(
name|use_rgai
condition|)
block|{
name|rai_hints
operator|.
name|ai_flags
operator||=
name|RAI_PASSIVE
expr_stmt|;
name|ret
operator|=
name|rdma_getaddrinfo
argument_list|(
name|src_addr
argument_list|,
name|port
argument_list|,
operator|&
name|rai_hints
argument_list|,
operator|&
name|rai_src
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ai_hints
operator|.
name|ai_flags
operator||=
name|AI_PASSIVE
expr_stmt|;
name|ret
operator|=
name|getaddrinfo
argument_list|(
name|src_addr
argument_list|,
name|port
argument_list|,
operator|&
name|ai_hints
argument_list|,
operator|&
name|ai_src
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"getaddrinfo src_addr: %s\n"
argument_list|,
name|gai_strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|rs
operator|=
name|rai
condition|?
name|rs_socket
argument_list|(
name|rai
operator|->
name|ai_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
else|:
name|rs_socket
argument_list|(
name|ai
operator|->
name|ai_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"rsocket"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rs
expr_stmt|;
goto|goto
name|free
goto|;
block|}
name|set_options
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
name|src_addr
condition|)
block|{
name|ret
operator|=
name|rai
condition|?
name|rs_bind
argument_list|(
name|rs
argument_list|,
name|rai_src
operator|->
name|ai_src_addr
argument_list|,
name|rai_src
operator|->
name|ai_src_len
argument_list|)
else|:
name|rs_bind
argument_list|(
name|rs
argument_list|,
name|ai_src
operator|->
name|ai_addr
argument_list|,
name|ai_src
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rbind"
argument_list|)
expr_stmt|;
goto|goto
name|close
goto|;
block|}
block|}
if|if
condition|(
name|rai
operator|&&
name|rai
operator|->
name|ai_route
condition|)
block|{
name|ret
operator|=
name|rs_setsockopt
argument_list|(
name|rs
argument_list|,
name|SOL_RDMA
argument_list|,
name|RDMA_ROUTE
argument_list|,
name|rai
operator|->
name|ai_route
argument_list|,
name|rai
operator|->
name|ai_route_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rsetsockopt RDMA_ROUTE"
argument_list|)
expr_stmt|;
goto|goto
name|close
goto|;
block|}
block|}
name|ret
operator|=
name|rai
condition|?
name|rs_connect
argument_list|(
name|rs
argument_list|,
name|rai
operator|->
name|ai_dst_addr
argument_list|,
name|rai
operator|->
name|ai_dst_len
argument_list|)
else|:
name|rs_connect
argument_list|(
name|rs
argument_list|,
name|ai
operator|->
name|ai_addr
argument_list|,
name|ai
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
operator|(
name|errno
operator|!=
name|EINPROGRESS
operator|)
condition|)
block|{
name|perror
argument_list|(
literal|"rconnect"
argument_list|)
expr_stmt|;
goto|goto
name|close
goto|;
block|}
if|if
condition|(
name|ret
operator|&&
operator|(
name|errno
operator|==
name|EINPROGRESS
operator|)
condition|)
block|{
name|fds
operator|.
name|fd
operator|=
name|rs
expr_stmt|;
name|fds
operator|.
name|events
operator|=
name|POLLOUT
expr_stmt|;
name|ret
operator|=
name|do_poll
argument_list|(
operator|&
name|fds
argument_list|,
name|poll_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|perror
argument_list|(
literal|"rpoll"
argument_list|)
expr_stmt|;
goto|goto
name|close
goto|;
block|}
name|len
operator|=
sizeof|sizeof
name|err
expr_stmt|;
name|ret
operator|=
name|rs_getsockopt
argument_list|(
name|rs
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_ERROR
argument_list|,
operator|&
name|err
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|close
goto|;
if|if
condition|(
name|err
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|errno
operator|=
name|err
expr_stmt|;
name|perror
argument_list|(
literal|"async rconnect"
argument_list|)
expr_stmt|;
block|}
block|}
name|close
label|:
if|if
condition|(
name|ret
condition|)
name|rs_close
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|free
label|:
if|if
condition|(
name|rai
condition|)
name|rdma_freeaddrinfo
argument_list|(
name|rai
argument_list|)
expr_stmt|;
else|else
name|freeaddrinfo
argument_list|(
name|ai
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
operator|!
name|custom
condition|?
name|test_size
index|[
name|TEST_CNT
operator|-
literal|1
index|]
operator|.
name|size
else|:
name|transfer_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
name|perror
argument_list|(
literal|"malloc"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|dst_addr
condition|)
block|{
name|ret
operator|=
name|server_listen
argument_list|()
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|free
goto|;
block|}
name|printf
argument_list|(
literal|"%-10s%-8s%-8s%-8s%-8s%8s %10s%13s\n"
argument_list|,
literal|"name"
argument_list|,
literal|"bytes"
argument_list|,
literal|"xfers"
argument_list|,
literal|"iters"
argument_list|,
literal|"total"
argument_list|,
literal|"time"
argument_list|,
literal|"Gb/sec"
argument_list|,
literal|"usec/xfer"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|custom
condition|)
block|{
name|optimization
operator|=
name|opt_latency
expr_stmt|;
name|ret
operator|=
name|dst_addr
condition|?
name|client_connect
argument_list|()
else|:
name|server_connect
argument_list|()
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|free
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TEST_CNT
operator|&&
operator|!
name|fork_pid
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|test_size
index|[
name|i
index|]
operator|.
name|option
operator|>
name|size_option
condition|)
continue|continue;
name|init_latency_test
argument_list|(
name|test_size
index|[
name|i
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
name|run_test
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|fork_pid
condition|)
name|waitpid
argument_list|(
name|fork_pid
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|rs_shutdown
argument_list|(
name|rs
argument_list|,
name|SHUT_RDWR
argument_list|)
expr_stmt|;
name|rs_close
argument_list|(
name|rs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dst_addr
operator|&&
name|use_fork
operator|&&
operator|!
name|fork_pid
condition|)
goto|goto
name|free
goto|;
name|optimization
operator|=
name|opt_bandwidth
expr_stmt|;
name|ret
operator|=
name|dst_addr
condition|?
name|client_connect
argument_list|()
else|:
name|server_connect
argument_list|()
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|free
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TEST_CNT
operator|&&
operator|!
name|fork_pid
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|test_size
index|[
name|i
index|]
operator|.
name|option
operator|>
name|size_option
condition|)
continue|continue;
name|init_bandwidth_test
argument_list|(
name|test_size
index|[
name|i
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
name|run_test
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|dst_addr
condition|?
name|client_connect
argument_list|()
else|:
name|server_connect
argument_list|()
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|free
goto|;
if|if
condition|(
operator|!
name|fork_pid
condition|)
name|ret
operator|=
name|run_test
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|fork_pid
condition|)
name|waitpid
argument_list|(
name|fork_pid
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|rs_shutdown
argument_list|(
name|rs
argument_list|,
name|SHUT_RDWR
argument_list|)
expr_stmt|;
name|rs_close
argument_list|(
name|rs
argument_list|)
expr_stmt|;
name|free
label|:
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_test_opt
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|arg
argument_list|)
operator|==
literal|1
condition|)
block|{
switch|switch
condition|(
name|arg
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|'s'
case|:
name|use_rs
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|use_async
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|flags
operator|=
operator|(
name|flags
operator|&
operator|~
name|MSG_DONTWAIT
operator|)
operator||
name|MSG_WAITALL
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|use_fork
operator|=
literal|1
expr_stmt|;
name|use_rs
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|flags
operator||=
name|MSG_DONTWAIT
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|use_rgai
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verify
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"socket"
argument_list|,
name|arg
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|use_rs
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"async"
argument_list|,
name|arg
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|use_async
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"block"
argument_list|,
name|arg
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|flags
operator|=
operator|(
name|flags
operator|&
operator|~
name|MSG_DONTWAIT
operator|)
operator||
name|MSG_WAITALL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"nonblock"
argument_list|,
name|arg
argument_list|,
literal|8
argument_list|)
condition|)
block|{
name|flags
operator||=
name|MSG_DONTWAIT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"resolve"
argument_list|,
name|arg
argument_list|,
literal|7
argument_list|)
condition|)
block|{
name|use_rgai
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"verify"
argument_list|,
name|arg
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|verify
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"fork"
argument_list|,
name|arg
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|use_fork
operator|=
literal|1
expr_stmt|;
name|use_rs
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|op
decl_stmt|,
name|ret
decl_stmt|;
name|ai_hints
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
name|rai_hints
operator|.
name|ai_port_space
operator|=
name|RDMA_PS_TCP
expr_stmt|;
while|while
condition|(
operator|(
name|op
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"s:b:f:B:i:I:C:S:p:k:T:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
literal|'s'
case|:
name|dst_addr
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|src_addr
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"ip"
argument_list|,
name|optarg
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|ai_hints
operator|.
name|ai_flags
operator|=
name|AI_NUMERICHOST
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"gid"
argument_list|,
name|optarg
argument_list|,
literal|3
argument_list|)
condition|)
block|{
name|rai_hints
operator|.
name|ai_flags
operator|=
name|RAI_NUMERICHOST
operator||
name|RAI_FAMILY
expr_stmt|;
name|rai_hints
operator|.
name|ai_family
operator|=
name|AF_IB
expr_stmt|;
name|use_rgai
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: unknown address format\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'B'
case|:
name|buffer_size
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|inline_size
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|custom
operator|=
literal|1
expr_stmt|;
name|iterations
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|custom
operator|=
literal|1
expr_stmt|;
name|transfer_count
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
literal|"all"
argument_list|,
name|optarg
argument_list|,
literal|3
argument_list|)
condition|)
block|{
name|size_option
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|custom
operator|=
literal|1
expr_stmt|;
name|transfer_size
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'p'
case|:
name|port
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|keepalive
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
if|if
condition|(
operator|!
name|set_test_opt
argument_list|(
name|optarg
argument_list|)
condition|)
break|break;
comment|/* invalid option - fall through */
name|SWITCH_FALLTHROUGH
expr_stmt|;
default|default:
name|printf
argument_list|(
literal|"usage: %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-s server_address]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-b bind_address]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-f address_format]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t    name, ip, ipv6, or gid\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-B buffer_size]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-i inline_size]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-I iterations]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-C transfer_count]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-S transfer_size or all]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-p port_number]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-k keepalive_time]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t[-T test_option]\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t    s|sockets - use standard tcp/ip sockets\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t    a|async - asynchronous operation (use poll)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t    b|blocking - use blocking calls\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t    f|fork - fork server processing\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t    n|nonblocking - use nonblocking calls\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t    r|resolve - use rdma cm to resolve address\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t    v|verify - verify data\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|MSG_DONTWAIT
operator|)
condition|)
name|poll_timeout
operator|=
operator|-
literal|1
expr_stmt|;
name|ret
operator|=
name|run
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


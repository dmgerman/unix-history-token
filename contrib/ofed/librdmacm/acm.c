begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2010-2012 Intel Corporation.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"cma.h"
end_include

begin_include
include|#
directive|include
file|<rdma/rdma_cma.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/ib.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/sa.h>
end_include

begin_define
define|#
directive|define
name|ACM_VERSION
value|1
end_define

begin_define
define|#
directive|define
name|ACM_OP_RESOLVE
value|0x01
end_define

begin_define
define|#
directive|define
name|ACM_OP_ACK
value|0x80
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_SUCCESS
value|0
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_ENOMEM
value|1
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_EINVAL
value|2
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_ENODATA
value|3
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_ENOTCONN
value|5
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_ETIMEDOUT
value|6
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_ESRCADDR
value|7
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_ESRCTYPE
value|8
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_EDESTADDR
value|9
end_define

begin_define
define|#
directive|define
name|ACM_STATUS_EDESTTYPE
value|10
end_define

begin_define
define|#
directive|define
name|ACM_FLAGS_NODELAY
value|(1<<30)
end_define

begin_define
define|#
directive|define
name|ACM_MSG_HDR_LENGTH
value|16
end_define

begin_define
define|#
directive|define
name|ACM_MAX_ADDRESS
value|64
end_define

begin_define
define|#
directive|define
name|ACM_MSG_EP_LENGTH
value|72
end_define

begin_define
define|#
directive|define
name|ACM_MSG_DATA_LENGTH
value|(ACM_MSG_EP_LENGTH * 8)
end_define

begin_struct
struct|struct
name|acm_hdr
block|{
name|uint8_t
name|version
decl_stmt|;
name|uint8_t
name|opcode
decl_stmt|;
name|uint8_t
name|status
decl_stmt|;
name|uint8_t
name|data
index|[
literal|3
index|]
decl_stmt|;
name|uint16_t
name|length
decl_stmt|;
name|uint64_t
name|tid
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|ACM_EP_INFO_NAME
value|0x0001
end_define

begin_define
define|#
directive|define
name|ACM_EP_INFO_ADDRESS_IP
value|0x0002
end_define

begin_define
define|#
directive|define
name|ACM_EP_INFO_ADDRESS_IP6
value|0x0003
end_define

begin_define
define|#
directive|define
name|ACM_EP_INFO_PATH
value|0x0010
end_define

begin_union
union|union
name|acm_ep_info
block|{
name|uint8_t
name|addr
index|[
name|ACM_MAX_ADDRESS
index|]
decl_stmt|;
name|uint8_t
name|name
index|[
name|ACM_MAX_ADDRESS
index|]
decl_stmt|;
name|struct
name|ibv_path_record
name|path
decl_stmt|;
block|}
union|;
end_union

begin_define
define|#
directive|define
name|ACM_EP_FLAG_SOURCE
value|(1<<0)
end_define

begin_define
define|#
directive|define
name|ACM_EP_FLAG_DEST
value|(1<<1)
end_define

begin_struct
struct|struct
name|acm_ep_addr_data
block|{
name|uint32_t
name|flags
decl_stmt|;
name|uint16_t
name|type
decl_stmt|;
name|uint16_t
name|reserved
decl_stmt|;
name|union
name|acm_ep_info
name|info
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|acm_resolve_msg
block|{
name|struct
name|acm_hdr
name|hdr
decl_stmt|;
name|struct
name|acm_ep_addr_data
name|data
index|[
literal|0
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|acm_msg
block|{
name|struct
name|acm_hdr
name|hdr
decl_stmt|;
union|union
block|{
name|uint8_t
name|data
index|[
name|ACM_MSG_DATA_LENGTH
index|]
decl_stmt|;
name|struct
name|acm_ep_addr_data
name|resolve_data
index|[
literal|0
index|]
decl_stmt|;
block|}
union|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|pthread_mutex_t
name|acm_lock
init|=
name|PTHREAD_MUTEX_INITIALIZER
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sock
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|server_port
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ucma_set_server_port
parameter_list|(
name|void
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|IBACM_PORT_FILE
argument_list|,
literal|"r"
name|STREAM_CLOEXEC
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|fscanf
argument_list|(
name|f
argument_list|,
literal|"%"
name|SCNu16
argument_list|,
operator|&
name|server_port
argument_list|)
operator|!=
literal|1
condition|)
name|server_port
operator|=
literal|0
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
return|return
name|server_port
return|;
block|}
end_function

begin_function
name|void
name|ucma_ib_init
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
specifier|static
name|int
name|init
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|init
condition|)
return|return;
name|pthread_mutex_lock
argument_list|(
operator|&
name|acm_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|init
condition|)
goto|goto
name|unlock
goto|;
if|if
condition|(
operator|!
name|ucma_set_server_port
argument_list|()
condition|)
goto|goto
name|out
goto|;
name|sock
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
operator||
name|SOCK_CLOEXEC
argument_list|,
name|IPPROTO_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|sock
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|htobe32
argument_list|(
name|INADDR_LOOPBACK
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_port
operator|=
name|htobe16
argument_list|(
name|server_port
argument_list|)
expr_stmt|;
name|ret
operator|=
name|connect
argument_list|(
name|sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|close
argument_list|(
name|sock
argument_list|)
expr_stmt|;
name|sock
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|out
label|:
name|init
operator|=
literal|1
expr_stmt|;
name|unlock
label|:
name|pthread_mutex_unlock
argument_list|(
operator|&
name|acm_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ucma_ib_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|sock
operator|>=
literal|0
condition|)
block|{
name|shutdown
argument_list|(
name|sock
argument_list|,
name|SHUT_RDWR
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ucma_ib_set_addr
parameter_list|(
name|struct
name|rdma_addrinfo
modifier|*
name|ib_rai
parameter_list|,
name|struct
name|rdma_addrinfo
modifier|*
name|rai
parameter_list|)
block|{
name|struct
name|sockaddr_ib
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
name|struct
name|ibv_path_record
modifier|*
name|path
decl_stmt|;
name|src
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|src
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|src
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|dst
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dst
condition|)
block|{
name|free
argument_list|(
name|src
argument_list|)
expr_stmt|;
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|path
operator|=
operator|&
operator|(
operator|(
expr|struct
name|ibv_path_data
operator|*
operator|)
name|ib_rai
operator|->
name|ai_route
operator|)
operator|->
name|path
expr_stmt|;
name|src
operator|->
name|sib_family
operator|=
name|AF_IB
expr_stmt|;
name|src
operator|->
name|sib_pkey
operator|=
name|path
operator|->
name|pkey
expr_stmt|;
name|src
operator|->
name|sib_flowinfo
operator|=
name|htobe32
argument_list|(
name|be32toh
argument_list|(
name|path
operator|->
name|flowlabel_hoplimit
argument_list|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|src
operator|->
name|sib_addr
argument_list|,
operator|&
name|path
operator|->
name|sgid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ucma_set_sid
argument_list|(
name|ib_rai
operator|->
name|ai_port_space
argument_list|,
name|rai
operator|->
name|ai_src_addr
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sib_family
operator|=
name|AF_IB
expr_stmt|;
name|dst
operator|->
name|sib_pkey
operator|=
name|path
operator|->
name|pkey
expr_stmt|;
name|dst
operator|->
name|sib_flowinfo
operator|=
name|htobe32
argument_list|(
name|be32toh
argument_list|(
name|path
operator|->
name|flowlabel_hoplimit
argument_list|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|dst
operator|->
name|sib_addr
argument_list|,
operator|&
name|path
operator|->
name|dgid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ucma_set_sid
argument_list|(
name|ib_rai
operator|->
name|ai_port_space
argument_list|,
name|rai
operator|->
name|ai_dst_addr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
name|ib_rai
operator|->
name|ai_src_addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|src
expr_stmt|;
name|ib_rai
operator|->
name|ai_src_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|src
argument_list|)
expr_stmt|;
name|ib_rai
operator|->
name|ai_dst_addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|dst
expr_stmt|;
name|ib_rai
operator|->
name|ai_dst_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ucma_ib_set_connect
parameter_list|(
name|struct
name|rdma_addrinfo
modifier|*
name|ib_rai
parameter_list|,
name|struct
name|rdma_addrinfo
modifier|*
name|rai
parameter_list|)
block|{
name|struct
name|ib_connect_hdr
modifier|*
name|hdr
decl_stmt|;
if|if
condition|(
name|rai
operator|->
name|ai_family
operator|==
name|AF_IB
condition|)
return|return
literal|0
return|;
name|hdr
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hdr
condition|)
return|return
name|ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
if|if
condition|(
name|rai
operator|->
name|ai_family
operator|==
name|AF_INET
condition|)
block|{
name|hdr
operator|->
name|ip_version
operator|=
literal|4
operator|<<
literal|4
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|hdr
operator|->
name|cma_src_ip4
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|rai
operator|->
name|ai_src_addr
operator|)
operator|->
name|sin_addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|hdr
operator|->
name|cma_dst_ip4
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|rai
operator|->
name|ai_dst_addr
operator|)
operator|->
name|sin_addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hdr
operator|->
name|ip_version
operator|=
literal|6
operator|<<
literal|4
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|hdr
operator|->
name|cma_src_ip6
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|rai
operator|->
name|ai_src_addr
operator|)
operator|->
name|sin6_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|hdr
operator|->
name|cma_dst_ip6
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|rai
operator|->
name|ai_dst_addr
operator|)
operator|->
name|sin6_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
name|ib_rai
operator|->
name|ai_connect
operator|=
name|hdr
expr_stmt|;
name|ib_rai
operator|->
name|ai_connect_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ucma_resolve_af_ib
parameter_list|(
name|struct
name|rdma_addrinfo
modifier|*
modifier|*
name|rai
parameter_list|)
block|{
name|struct
name|rdma_addrinfo
modifier|*
name|ib_rai
decl_stmt|;
name|ib_rai
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ib_rai
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ib_rai
condition|)
return|return;
name|ib_rai
operator|->
name|ai_flags
operator|=
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_flags
expr_stmt|;
name|ib_rai
operator|->
name|ai_family
operator|=
name|AF_IB
expr_stmt|;
name|ib_rai
operator|->
name|ai_qp_type
operator|=
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_qp_type
expr_stmt|;
name|ib_rai
operator|->
name|ai_port_space
operator|=
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_port_space
expr_stmt|;
name|ib_rai
operator|->
name|ai_route
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_route_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ib_rai
operator|->
name|ai_route
condition|)
goto|goto
name|err
goto|;
name|memcpy
argument_list|(
name|ib_rai
operator|->
name|ai_route
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_route
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_route_len
argument_list|)
expr_stmt|;
name|ib_rai
operator|->
name|ai_route_len
operator|=
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_route_len
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_canonname
condition|)
block|{
name|ib_rai
operator|->
name|ai_src_canonname
operator|=
name|strdup
argument_list|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_canonname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ib_rai
operator|->
name|ai_src_canonname
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_canonname
condition|)
block|{
name|ib_rai
operator|->
name|ai_dst_canonname
operator|=
name|strdup
argument_list|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_canonname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ib_rai
operator|->
name|ai_dst_canonname
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|ucma_ib_set_connect
argument_list|(
name|ib_rai
argument_list|,
operator|*
name|rai
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|ucma_ib_set_addr
argument_list|(
name|ib_rai
argument_list|,
operator|*
name|rai
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|ib_rai
operator|->
name|ai_next
operator|=
operator|*
name|rai
expr_stmt|;
operator|*
name|rai
operator|=
name|ib_rai
expr_stmt|;
return|return;
name|err
label|:
name|rdma_freeaddrinfo
argument_list|(
name|ib_rai
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ucma_ib_save_resp
parameter_list|(
name|struct
name|rdma_addrinfo
modifier|*
name|rai
parameter_list|,
name|struct
name|acm_msg
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|acm_ep_addr_data
modifier|*
name|ep_data
decl_stmt|;
name|struct
name|ibv_path_data
modifier|*
name|path_data
init|=
name|NULL
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
decl_stmt|,
name|path_cnt
init|=
literal|0
decl_stmt|;
name|cnt
operator|=
operator|(
name|msg
operator|->
name|hdr
operator|.
name|length
operator|-
name|ACM_MSG_HDR_LENGTH
operator|)
operator|/
name|ACM_MSG_EP_LENGTH
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
name|ep_data
operator|=
operator|&
name|msg
operator|->
name|resolve_data
index|[
name|i
index|]
expr_stmt|;
switch|switch
condition|(
name|ep_data
operator|->
name|type
condition|)
block|{
case|case
name|ACM_EP_INFO_PATH
case|:
name|ep_data
operator|->
name|type
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|path_data
condition|)
name|path_data
operator|=
operator|(
expr|struct
name|ibv_path_data
operator|*
operator|)
name|ep_data
expr_stmt|;
name|path_cnt
operator|++
expr_stmt|;
break|break;
case|case
name|ACM_EP_INFO_ADDRESS_IP
case|:
if|if
condition|(
operator|!
operator|(
name|ep_data
operator|->
name|flags
operator|&
name|ACM_EP_FLAG_SOURCE
operator|)
operator|||
name|rai
operator|->
name|ai_src_len
condition|)
break|break;
name|sin
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sin
condition|)
break|break;
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin
operator|->
name|sin_addr
argument_list|,
operator|&
name|ep_data
operator|->
name|info
operator|.
name|addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rai
operator|->
name|ai_src_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
expr_stmt|;
name|rai
operator|->
name|ai_src_addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sin
expr_stmt|;
break|break;
case|case
name|ACM_EP_INFO_ADDRESS_IP6
case|:
if|if
condition|(
operator|!
operator|(
name|ep_data
operator|->
name|flags
operator|&
name|ACM_EP_FLAG_SOURCE
operator|)
operator|||
name|rai
operator|->
name|ai_src_len
condition|)
break|break;
name|sin6
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sin6
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sin6
condition|)
break|break;
name|sin6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|,
operator|&
name|ep_data
operator|->
name|info
operator|.
name|addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|rai
operator|->
name|ai_src_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sin6
argument_list|)
expr_stmt|;
name|rai
operator|->
name|ai_src_addr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sin6
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|rai
operator|->
name|ai_route
operator|=
name|calloc
argument_list|(
name|path_cnt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|path_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rai
operator|->
name|ai_route
condition|)
block|{
name|memcpy
argument_list|(
name|rai
operator|->
name|ai_route
argument_list|,
name|path_data
argument_list|,
name|path_cnt
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|path_data
argument_list|)
argument_list|)
expr_stmt|;
name|rai
operator|->
name|ai_route_len
operator|=
name|path_cnt
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|path_data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ucma_set_ep_addr
parameter_list|(
name|struct
name|acm_ep_addr_data
modifier|*
name|data
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|data
operator|->
name|type
operator|=
name|ACM_EP_INFO_ADDRESS_IP
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|info
operator|.
name|addr
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
operator|)
operator|->
name|sin_addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|data
operator|->
name|type
operator|=
name|ACM_EP_INFO_ADDRESS_IP6
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|info
operator|.
name|addr
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|addr
operator|)
operator|->
name|sin6_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ucma_inet_addr
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
name|len
parameter_list|)
block|{
return|return
name|len
operator|&&
name|addr
operator|&&
operator|(
name|addr
operator|->
name|sa_family
operator|==
name|AF_INET
operator|||
name|addr
operator|->
name|sa_family
operator|==
name|AF_INET6
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ucma_ib_addr
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
name|len
parameter_list|)
block|{
return|return
name|len
operator|&&
name|addr
operator|&&
operator|(
name|addr
operator|->
name|sa_family
operator|==
name|AF_IB
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ucma_ib_resolve
parameter_list|(
name|struct
name|rdma_addrinfo
modifier|*
modifier|*
name|rai
parameter_list|,
specifier|const
name|struct
name|rdma_addrinfo
modifier|*
name|hints
parameter_list|)
block|{
name|struct
name|acm_msg
name|msg
decl_stmt|;
name|struct
name|acm_ep_addr_data
modifier|*
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ucma_ib_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|sock
operator|<
literal|0
condition|)
return|return;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|version
operator|=
name|ACM_VERSION
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|opcode
operator|=
name|ACM_OP_RESOLVE
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|length
operator|=
name|ACM_MSG_HDR_LENGTH
expr_stmt|;
name|data
operator|=
operator|&
name|msg
operator|.
name|resolve_data
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|ucma_inet_addr
argument_list|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_addr
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_len
argument_list|)
condition|)
block|{
name|data
operator|->
name|flags
operator|=
name|ACM_EP_FLAG_SOURCE
expr_stmt|;
name|ucma_set_ep_addr
argument_list|(
name|data
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_addr
argument_list|)
expr_stmt|;
name|data
operator|++
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|length
operator|+=
name|ACM_MSG_EP_LENGTH
expr_stmt|;
block|}
if|if
condition|(
name|ucma_inet_addr
argument_list|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_addr
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_len
argument_list|)
condition|)
block|{
name|data
operator|->
name|flags
operator|=
name|ACM_EP_FLAG_DEST
expr_stmt|;
if|if
condition|(
name|hints
operator|->
name|ai_flags
operator|&
operator|(
name|RAI_NUMERICHOST
operator||
name|RAI_NOROUTE
operator|)
condition|)
name|data
operator|->
name|flags
operator||=
name|ACM_FLAGS_NODELAY
expr_stmt|;
name|ucma_set_ep_addr
argument_list|(
name|data
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_addr
argument_list|)
expr_stmt|;
name|data
operator|++
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|length
operator|+=
name|ACM_MSG_EP_LENGTH
expr_stmt|;
block|}
if|if
condition|(
name|hints
operator|->
name|ai_route_len
operator|||
name|ucma_ib_addr
argument_list|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_addr
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_len
argument_list|)
operator|||
name|ucma_ib_addr
argument_list|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_addr
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_len
argument_list|)
condition|)
block|{
name|struct
name|ibv_path_record
modifier|*
name|path
decl_stmt|;
if|if
condition|(
name|hints
operator|->
name|ai_route_len
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|ibv_path_record
argument_list|)
condition|)
name|path
operator|=
operator|(
expr|struct
name|ibv_path_record
operator|*
operator|)
name|hints
operator|->
name|ai_route
expr_stmt|;
elseif|else
if|if
condition|(
name|hints
operator|->
name|ai_route_len
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|ibv_path_data
argument_list|)
condition|)
name|path
operator|=
operator|&
operator|(
operator|(
expr|struct
name|ibv_path_data
operator|*
operator|)
name|hints
operator|->
name|ai_route
operator|)
operator|->
name|path
expr_stmt|;
else|else
name|path
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|path
condition|)
name|memcpy
argument_list|(
operator|&
name|data
operator|->
name|info
operator|.
name|path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ucma_ib_addr
argument_list|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_addr
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_len
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|data
operator|->
name|info
operator|.
name|path
operator|.
name|sgid
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_ib
operator|*
operator|)
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_src_addr
operator|)
operator|->
name|sib_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ucma_ib_addr
argument_list|(
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_addr
argument_list|,
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_len
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|data
operator|->
name|info
operator|.
name|path
operator|.
name|dgid
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_ib
operator|*
operator|)
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_dst_addr
operator|)
operator|->
name|sib_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|type
operator|=
name|ACM_EP_INFO_PATH
expr_stmt|;
name|data
operator|++
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|length
operator|+=
name|ACM_MSG_EP_LENGTH
expr_stmt|;
block|}
name|pthread_mutex_lock
argument_list|(
operator|&
name|acm_lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send
argument_list|(
name|sock
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
name|msg
operator|.
name|hdr
operator|.
name|length
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|msg
operator|.
name|hdr
operator|.
name|length
condition|)
block|{
name|pthread_mutex_unlock
argument_list|(
operator|&
name|acm_lock
argument_list|)
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|recv
argument_list|(
name|sock
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|acm_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
name|ACM_MSG_HDR_LENGTH
operator|||
name|ret
operator|!=
name|msg
operator|.
name|hdr
operator|.
name|length
operator|||
name|msg
operator|.
name|hdr
operator|.
name|status
condition|)
return|return;
name|ucma_ib_save_resp
argument_list|(
operator|*
name|rai
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|af_ib_support
operator|&&
operator|!
operator|(
name|hints
operator|->
name|ai_flags
operator|&
name|RAI_ROUTEONLY
operator|)
operator|&&
operator|(
operator|*
name|rai
operator|)
operator|->
name|ai_route_len
condition|)
name|ucma_resolve_af_ib
argument_list|(
name|rai
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


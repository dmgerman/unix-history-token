begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2005,2008 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  * Copyright (c) 2009,2010 HNR Consulting. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_timer.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_event.h>
end_include

begin_include
include|#
directive|include
file|<vendor/osm_vendor_api.h>
end_include

begin_include
include|#
directive|include
file|<vendor/osm_vendor_sa_api.h>
end_include

begin_comment
comment|/* this struct is the internal rep of the bind handle */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|_osmv_sa_bind_info
block|{
name|osm_bind_handle_t
name|h_bind
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
decl_stmt|;
name|osm_vendor_t
modifier|*
name|p_vendor
decl_stmt|;
name|osm_mad_pool_t
modifier|*
name|p_mad_pool
decl_stmt|;
name|uint64_t
name|port_guid
decl_stmt|;
name|cl_event_t
name|sync_event
decl_stmt|;
name|uint64_t
name|last_lids_update_sec
decl_stmt|;
name|uint16_t
name|lid
decl_stmt|;
name|uint16_t
name|sm_lid
decl_stmt|;
block|}
name|osmv_sa_bind_info_t
typedef|;
end_typedef

begin_comment
comment|/*   Call back on new mad received:    We basically only need to set the context of the query.   Or report an error.    A pointer to the actual context of the request (a copy of the oriignal   request structure) is attached as the p_madw->context.ni_context.node_guid */
end_comment

begin_function
specifier|static
name|void
name|__osmv_sa_mad_rcv_cb
parameter_list|(
name|IN
name|osm_madw_t
modifier|*
name|p_madw
parameter_list|,
name|IN
name|void
modifier|*
name|bind_context
parameter_list|,
name|IN
name|osm_madw_t
modifier|*
name|p_req_madw
parameter_list|)
block|{
name|osmv_sa_bind_info_t
modifier|*
name|p_bind
init|=
operator|(
name|osmv_sa_bind_info_t
operator|*
operator|)
name|bind_context
decl_stmt|;
name|osmv_query_req_t
modifier|*
name|p_query_req_copy
init|=
name|NULL
decl_stmt|;
name|osmv_query_res_t
name|query_res
decl_stmt|;
name|ib_sa_mad_t
modifier|*
name|p_sa_mad
decl_stmt|;
name|ib_net16_t
name|mad_status
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_bind
operator|->
name|p_log
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_req_madw
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_bind
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Ignoring a non-response mad\n"
argument_list|)
expr_stmt|;
name|osm_mad_pool_put
argument_list|(
name|p_bind
operator|->
name|p_mad_pool
argument_list|,
name|p_madw
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* obtain the sent context */
name|p_query_req_copy
operator|=
operator|(
name|osmv_query_req_t
operator|*
operator|)
operator|(
name|p_req_madw
operator|->
name|context
operator|.
name|arb_context
operator|.
name|context1
operator|)
expr_stmt|;
comment|/* provide the context of the original request in the result */
name|query_res
operator|.
name|query_context
operator|=
name|p_query_req_copy
operator|->
name|query_context
expr_stmt|;
comment|/* provide the resulting madw */
name|query_res
operator|.
name|p_result_madw
operator|=
name|p_madw
expr_stmt|;
comment|/* update the req fields */
name|p_sa_mad
operator|=
operator|(
name|ib_sa_mad_t
operator|*
operator|)
name|p_madw
operator|->
name|p_mad
expr_stmt|;
comment|/* if we got a remote error track it in the status */
name|mad_status
operator|=
call|(
name|ib_net16_t
call|)
argument_list|(
name|p_sa_mad
operator|->
name|status
operator|&
name|IB_SMP_STATUS_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|mad_status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_bind
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0501: "
literal|"Remote error:0x%04X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|mad_status
argument_list|)
argument_list|)
expr_stmt|;
name|query_res
operator|.
name|status
operator|=
name|IB_REMOTE_ERROR
expr_stmt|;
block|}
else|else
name|query_res
operator|.
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
comment|/* what if we have got back an empty mad ? */
if|if
condition|(
operator|!
name|p_madw
operator|->
name|mad_size
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_bind
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0502: "
literal|"Got an empty mad\n"
argument_list|)
expr_stmt|;
name|query_res
operator|.
name|status
operator|=
name|IB_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|IB_SUCCESS
operator|==
name|mad_status
condition|)
block|{
comment|/* if we are in not in a method response of an rmpp nature we must get only 1 */
comment|/* HACK: in the future we might need to be smarter for other methods... */
if|if
condition|(
name|p_sa_mad
operator|->
name|method
operator|!=
name|IB_MAD_METHOD_GETTABLE_RESP
condition|)
block|{
name|query_res
operator|.
name|result_cnt
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|VENDOR_RMPP_SUPPORT
if|if
condition|(
name|mad_status
operator|!=
name|IB_SUCCESS
condition|)
name|query_res
operator|.
name|result_cnt
operator|=
literal|0
expr_stmt|;
else|else
name|query_res
operator|.
name|result_cnt
operator|=
literal|1
expr_stmt|;
else|#
directive|else
comment|/* we used the offset value to calculate the number of 			   records in here */
if|if
condition|(
name|ib_get_attr_size
argument_list|(
name|p_sa_mad
operator|->
name|attr_offset
argument_list|)
operator|==
literal|0
condition|)
block|{
name|query_res
operator|.
name|result_cnt
operator|=
literal|0
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_bind
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Count = 0\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|query_res
operator|.
name|result_cnt
operator|=
operator|(
name|p_madw
operator|->
name|mad_size
operator|-
name|IB_SA_MAD_HDR_SIZE
operator|)
operator|/
name|ib_get_attr_size
argument_list|(
name|p_sa_mad
operator|->
name|attr_offset
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_bind
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Count = %u = %zu / %u (%zu)\n"
argument_list|,
name|query_res
operator|.
name|result_cnt
argument_list|,
name|p_madw
operator|->
name|mad_size
operator|-
name|IB_SA_MAD_HDR_SIZE
argument_list|,
name|ib_get_attr_size
argument_list|(
name|p_sa_mad
operator|->
name|attr_offset
argument_list|)
argument_list|,
operator|(
name|p_madw
operator|->
name|mad_size
operator|-
name|IB_SA_MAD_HDR_SIZE
operator|)
operator|%
name|ib_get_attr_size
argument_list|(
name|p_sa_mad
operator|->
name|attr_offset
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
name|query_res
operator|.
name|query_type
operator|=
name|p_query_req_copy
operator|->
name|query_type
expr_stmt|;
name|p_query_req_copy
operator|->
name|pfn_query_cb
argument_list|(
operator|&
name|query_res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_query_req_copy
operator|->
name|flags
operator|&
name|OSM_SA_FLAGS_SYNC
operator|)
operator|==
name|OSM_SA_FLAGS_SYNC
condition|)
name|cl_event_signal
argument_list|(
operator|&
name|p_bind
operator|->
name|sync_event
argument_list|)
expr_stmt|;
name|Exit
label|:
comment|/* free the copied query request if found */
if|if
condition|(
name|p_query_req_copy
condition|)
name|free
argument_list|(
name|p_query_req_copy
argument_list|)
expr_stmt|;
comment|/* put back the request madw */
if|if
condition|(
name|p_req_madw
condition|)
name|osm_mad_pool_put
argument_list|(
name|p_bind
operator|->
name|p_mad_pool
argument_list|,
name|p_req_madw
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_bind
operator|->
name|p_log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   Send Error Callback:    Only report the error and get rid of the mad wrapper */
end_comment

begin_function
specifier|static
name|void
name|__osmv_sa_mad_err_cb
parameter_list|(
name|IN
name|void
modifier|*
name|bind_context
parameter_list|,
name|IN
name|osm_madw_t
modifier|*
name|p_madw
parameter_list|)
block|{
name|osmv_sa_bind_info_t
modifier|*
name|p_bind
init|=
operator|(
name|osmv_sa_bind_info_t
operator|*
operator|)
name|bind_context
decl_stmt|;
name|osmv_query_req_t
modifier|*
name|p_query_req_copy
init|=
name|NULL
decl_stmt|;
name|osmv_query_res_t
name|query_res
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_bind
operator|->
name|p_log
argument_list|)
expr_stmt|;
comment|/* Obtain the sent context etc */
name|p_query_req_copy
operator|=
operator|(
name|osmv_query_req_t
operator|*
operator|)
operator|(
name|p_madw
operator|->
name|context
operator|.
name|arb_context
operator|.
name|context1
operator|)
expr_stmt|;
comment|/* provide the context of the original request in the result */
name|query_res
operator|.
name|query_context
operator|=
name|p_query_req_copy
operator|->
name|query_context
expr_stmt|;
name|query_res
operator|.
name|p_result_madw
operator|=
name|p_madw
expr_stmt|;
name|query_res
operator|.
name|status
operator|=
name|IB_TIMEOUT
expr_stmt|;
name|query_res
operator|.
name|result_cnt
operator|=
literal|0
expr_stmt|;
name|query_res
operator|.
name|p_result_madw
operator|->
name|status
operator|=
name|IB_TIMEOUT
expr_stmt|;
name|p_madw
operator|->
name|status
operator|=
name|IB_TIMEOUT
expr_stmt|;
name|query_res
operator|.
name|query_type
operator|=
name|p_query_req_copy
operator|->
name|query_type
expr_stmt|;
name|p_query_req_copy
operator|->
name|pfn_query_cb
argument_list|(
operator|&
name|query_res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_query_req_copy
operator|->
name|flags
operator|&
name|OSM_SA_FLAGS_SYNC
operator|)
operator|==
name|OSM_SA_FLAGS_SYNC
condition|)
name|cl_event_signal
argument_list|(
operator|&
name|p_bind
operator|->
name|sync_event
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_query_req_copy
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_bind
operator|->
name|p_log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  This routine needs to be invoked on every send - since the SM LID and Local  lid might change. To do that without any major perfoermance impact we cache  the results and time they were obtained. Refresh only twice a minute.  To avoid the need to use statics and risk a race - we require the refresh time  to be stored in the context of the results. Also this coveres cases were  we query for multiple guids.  *****************************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|__osmv_get_lid_and_sm_lid_by_port_guid
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|ib_net64_t
name|port_guid
parameter_list|,
name|IN
name|OUT
name|uint64_t
modifier|*
name|p_lids_update_time_sec
parameter_list|,
name|OUT
name|uint16_t
modifier|*
name|lid
parameter_list|,
name|OUT
name|uint16_t
modifier|*
name|sm_lid
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
name|ib_port_attr_t
modifier|*
name|p_attr_array
decl_stmt|;
name|uint32_t
name|num_ports
decl_stmt|;
name|uint32_t
name|port_num
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
comment|/* use prevous values if current time is close enough to previous query */
if|if
condition|(
name|cl_get_time_stamp_sec
argument_list|()
operator|<=
operator|*
name|p_lids_update_time_sec
operator|+
literal|30
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Using previously stored lid:0x%04x sm_lid:0x%04x\n"
argument_list|,
operator|*
name|lid
argument_list|,
operator|*
name|sm_lid
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* obtain the number of available ports */
name|num_ports
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osm_vendor_get_all_port_attr
argument_list|(
name|p_vend
argument_list|,
name|NULL
argument_list|,
operator|&
name|num_ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_INSUFFICIENT_MEMORY
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0503: "
literal|"Expected to get the IB_INSUFFICIENT_MEMORY but got: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|OSM_LOG
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Found total of %u ports. Looking for guid:0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|num_ports
argument_list|,
name|cl_ntoh64
argument_list|(
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* allocate the attributes */
name|p_attr_array
operator|=
operator|(
name|ib_port_attr_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_port_attr_t
argument_list|)
operator|*
name|num_ports
argument_list|)
expr_stmt|;
comment|/* obtain the attributes */
name|status
operator|=
name|osm_vendor_get_all_port_attr
argument_list|(
name|p_vend
argument_list|,
name|p_attr_array
argument_list|,
operator|&
name|num_ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0504: "
literal|"Failed to get port attributes (error: %s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_attr_array
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|IB_ERROR
expr_stmt|;
comment|/* find the port requested in the list */
for|for
control|(
name|port_num
operator|=
literal|0
init|;
operator|(
name|port_num
operator|<
name|num_ports
operator|)
operator|&&
operator|(
name|status
operator|==
name|IB_ERROR
operator|)
condition|;
name|port_num
operator|++
control|)
block|{
if|if
condition|(
name|p_attr_array
index|[
name|port_num
index|]
operator|.
name|port_guid
operator|==
name|port_guid
condition|)
block|{
operator|*
name|lid
operator|=
name|p_attr_array
index|[
name|port_num
index|]
operator|.
name|lid
expr_stmt|;
operator|*
name|sm_lid
operator|=
name|p_attr_array
index|[
name|port_num
index|]
operator|.
name|sm_lid
expr_stmt|;
operator|*
name|p_lids_update_time_sec
operator|=
name|cl_get_time_stamp_sec
argument_list|()
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Found guid:0x%016"
name|PRIx64
literal|" with idx:%d\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|port_guid
argument_list|)
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|p_attr_array
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|osm_bind_handle_t
name|osmv_bind_sa
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|osm_mad_pool_t
modifier|*
specifier|const
name|p_mad_pool
parameter_list|,
name|IN
name|ib_net64_t
name|port_guid
parameter_list|)
block|{
name|osm_bind_info_t
name|bind_info
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
init|=
name|p_vend
operator|->
name|p_log
decl_stmt|;
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmv_sa_bind_info_t
modifier|*
name|p_sa_bind_info
decl_stmt|;
name|cl_status_t
name|cl_status
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Binding to port 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
name|bind_info
operator|.
name|port_guid
operator|=
name|port_guid
expr_stmt|;
name|bind_info
operator|.
name|mad_class
operator|=
name|IB_MCLASS_SUBN_ADM
expr_stmt|;
name|bind_info
operator|.
name|class_version
operator|=
literal|2
expr_stmt|;
name|bind_info
operator|.
name|is_responder
operator|=
name|FALSE
expr_stmt|;
name|bind_info
operator|.
name|is_trap_processor
operator|=
name|FALSE
expr_stmt|;
name|bind_info
operator|.
name|is_report_processor
operator|=
name|FALSE
expr_stmt|;
name|bind_info
operator|.
name|send_q_size
operator|=
literal|256
expr_stmt|;
name|bind_info
operator|.
name|recv_q_size
operator|=
literal|256
expr_stmt|;
comment|/* allocate the new sa bind info */
name|p_sa_bind_info
operator|=
operator|(
name|osmv_sa_bind_info_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|osmv_sa_bind_info_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_sa_bind_info
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0505: "
literal|"Failed to allocate new bind structure\n"
argument_list|)
expr_stmt|;
name|p_sa_bind_info
operator|=
name|OSM_BIND_INVALID_HANDLE
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* store some important context */
name|p_sa_bind_info
operator|->
name|p_log
operator|=
name|p_log
expr_stmt|;
name|p_sa_bind_info
operator|->
name|port_guid
operator|=
name|port_guid
expr_stmt|;
name|p_sa_bind_info
operator|->
name|p_mad_pool
operator|=
name|p_mad_pool
expr_stmt|;
name|p_sa_bind_info
operator|->
name|p_vendor
operator|=
name|p_vend
expr_stmt|;
name|p_sa_bind_info
operator|->
name|last_lids_update_sec
operator|=
literal|0
expr_stmt|;
comment|/* Bind to the lower level */
name|p_sa_bind_info
operator|->
name|h_bind
operator|=
name|osm_vendor_bind
argument_list|(
name|p_vend
argument_list|,
operator|&
name|bind_info
argument_list|,
name|p_mad_pool
argument_list|,
name|__osmv_sa_mad_rcv_cb
argument_list|,
name|__osmv_sa_mad_err_cb
argument_list|,
name|p_sa_bind_info
argument_list|)
expr_stmt|;
comment|/* context provided to CBs */
if|if
condition|(
name|p_sa_bind_info
operator|->
name|h_bind
operator|==
name|OSM_BIND_INVALID_HANDLE
condition|)
block|{
name|free
argument_list|(
name|p_sa_bind_info
argument_list|)
expr_stmt|;
name|p_sa_bind_info
operator|=
name|OSM_BIND_INVALID_HANDLE
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0506: "
literal|"Failed to bind to vendor GSI\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* obtain the sm_lid from the vendor */
name|status
operator|=
name|__osmv_get_lid_and_sm_lid_by_port_guid
argument_list|(
name|p_vend
argument_list|,
name|port_guid
argument_list|,
operator|&
name|p_sa_bind_info
operator|->
name|last_lids_update_sec
argument_list|,
operator|&
name|p_sa_bind_info
operator|->
name|lid
argument_list|,
operator|&
name|p_sa_bind_info
operator|->
name|sm_lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|free
argument_list|(
name|p_sa_bind_info
argument_list|)
expr_stmt|;
name|p_sa_bind_info
operator|=
name|OSM_BIND_INVALID_HANDLE
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0507: "
literal|"Failed to obtain the SM lid\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* initialize the sync_event */
name|cl_event_construct
argument_list|(
operator|&
name|p_sa_bind_info
operator|->
name|sync_event
argument_list|)
expr_stmt|;
name|cl_status
operator|=
name|cl_event_init
argument_list|(
operator|&
name|p_sa_bind_info
operator|->
name|sync_event
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl_status
operator|!=
name|CL_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0508: "
literal|"cl_init_event failed: %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|cl_status
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_sa_bind_info
argument_list|)
expr_stmt|;
name|p_sa_bind_info
operator|=
name|OSM_BIND_INVALID_HANDLE
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
operator|(
name|p_sa_bind_info
operator|)
return|;
block|}
end_function

begin_comment
comment|/****t* OSM Vendor SA Client/osmv_sa_mad_data  * NAME  *    osmv_sa_mad_data  *  * DESCRIPTION  * Extra fields required to perform a mad query  *  This struct is passed to the actual send method  *  * SYNOPSIS  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|_osmv_sa_mad_data
block|{
comment|/* MAD data. */
name|uint8_t
name|method
decl_stmt|;
name|ib_net16_t
name|attr_id
decl_stmt|;
name|ib_net16_t
name|attr_offset
decl_stmt|;
name|ib_net32_t
name|attr_mod
decl_stmt|;
name|ib_net64_t
name|comp_mask
decl_stmt|;
name|void
modifier|*
name|p_attr
decl_stmt|;
block|}
name|osmv_sa_mad_data_t
typedef|;
end_typedef

begin_comment
comment|/*  * method  *    The method of the mad to be sent  *  *  attr_id  *     Attribute ID  *  *  attr_offset  *     Offset as defined by RMPP  *  *  attr_mod  *     Attribute modifier  *  *  comp_mask  *     The component mask of the query  *  *  p_attr  *     A pointer to the record of the attribute to be sent.  *  *****/
end_comment

begin_comment
comment|/* Send a MAD out on the GSI interface */
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|__osmv_send_sa_req
parameter_list|(
name|IN
name|osmv_sa_bind_info_t
modifier|*
name|p_bind
parameter_list|,
name|IN
specifier|const
name|osmv_sa_mad_data_t
modifier|*
specifier|const
name|p_sa_mad_data
parameter_list|,
name|IN
specifier|const
name|osmv_query_req_t
modifier|*
specifier|const
name|p_query_req
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
name|ib_mad_t
modifier|*
name|p_mad_hdr
decl_stmt|;
name|ib_sa_mad_t
modifier|*
name|p_sa_mad
decl_stmt|;
name|osm_madw_t
modifier|*
name|p_madw
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
init|=
name|p_bind
operator|->
name|p_log
decl_stmt|;
specifier|static
name|atomic32_t
name|trans_id
decl_stmt|;
name|boolean_t
name|sync
decl_stmt|;
name|osmv_query_req_t
modifier|*
name|p_query_req_copy
decl_stmt|;
name|uint32_t
name|sa_size
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
comment|/* 	   since the sm_lid might change we obtain it every send 	   (actually it is cached in the bind object and refreshed 	   every 30sec by this proc) 	 */
name|status
operator|=
name|__osmv_get_lid_and_sm_lid_by_port_guid
argument_list|(
name|p_bind
operator|->
name|p_vendor
argument_list|,
name|p_bind
operator|->
name|port_guid
argument_list|,
operator|&
name|p_bind
operator|->
name|last_lids_update_sec
argument_list|,
operator|&
name|p_bind
operator|->
name|lid
argument_list|,
operator|&
name|p_bind
operator|->
name|sm_lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0509: "
literal|"Failed to obtain the SM lid\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Get a MAD wrapper for the send */
name|p_madw
operator|=
name|osm_mad_pool_get
argument_list|(
name|p_bind
operator|->
name|p_mad_pool
argument_list|,
name|p_bind
operator|->
name|h_bind
argument_list|,
name|MAD_BLOCK_SIZE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_madw
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0510: "
literal|"Unable to acquire MAD\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_INSUFFICIENT_RESOURCES
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Initialize the Sent MAD: */
comment|/* Initialize the MAD buffer for the send operation. */
name|p_mad_hdr
operator|=
name|osm_madw_get_mad_ptr
argument_list|(
name|p_madw
argument_list|)
expr_stmt|;
name|p_sa_mad
operator|=
name|osm_madw_get_sa_mad_ptr
argument_list|(
name|p_madw
argument_list|)
expr_stmt|;
comment|/* Get a new transaction Id */
name|cl_atomic_inc
argument_list|(
operator|&
name|trans_id
argument_list|)
expr_stmt|;
comment|/* Cleanup the MAD from any residue */
name|memset
argument_list|(
name|p_sa_mad
argument_list|,
literal|0
argument_list|,
name|MAD_BLOCK_SIZE
argument_list|)
expr_stmt|;
comment|/* Initialize the standard MAD header. */
name|ib_mad_init_new
argument_list|(
name|p_mad_hdr
argument_list|,
comment|/* mad pointer */
name|IB_MCLASS_SUBN_ADM
argument_list|,
comment|/* class */
operator|(
name|uint8_t
operator|)
literal|2
argument_list|,
comment|/* version */
name|p_sa_mad_data
operator|->
name|method
argument_list|,
comment|/* method */
name|cl_hton64
argument_list|(
operator|(
name|uint64_t
operator|)
name|trans_id
argument_list|)
argument_list|,
comment|/* tid */
name|p_sa_mad_data
operator|->
name|attr_id
argument_list|,
comment|/* attr id */
name|p_sa_mad_data
operator|->
name|attr_mod
comment|/* attr mod */
argument_list|)
expr_stmt|;
comment|/* Set the query information. */
name|p_sa_mad
operator|->
name|sm_key
operator|=
name|p_query_req
operator|->
name|sm_key
expr_stmt|;
name|p_sa_mad
operator|->
name|attr_offset
operator|=
literal|0
expr_stmt|;
name|p_sa_mad
operator|->
name|comp_mask
operator|=
name|p_sa_mad_data
operator|->
name|comp_mask
expr_stmt|;
if|if
condition|(
name|p_sa_mad
operator|->
name|comp_mask
condition|)
block|{
name|p_sa_mad_data
operator|->
name|attr_offset
condition|?
operator|(
name|sa_size
operator|=
name|ib_get_attr_size
argument_list|(
name|p_sa_mad_data
operator|->
name|attr_offset
argument_list|)
operator|)
else|:
operator|(
name|sa_size
operator|=
name|IB_SA_DATA_SIZE
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_sa_mad
operator|->
name|data
argument_list|,
name|p_sa_mad_data
operator|->
name|p_attr
argument_list|,
name|sa_size
argument_list|)
expr_stmt|;
block|}
comment|/* 	   Provide the address to send to 	 */
comment|/* Patch to handle IBAL - host order , where it should take destination lid in network order */
ifdef|#
directive|ifdef
name|OSM_VENDOR_INTF_AL
name|p_madw
operator|->
name|mad_addr
operator|.
name|dest_lid
operator|=
name|p_bind
operator|->
name|sm_lid
expr_stmt|;
else|#
directive|else
name|p_madw
operator|->
name|mad_addr
operator|.
name|dest_lid
operator|=
name|cl_hton16
argument_list|(
name|p_bind
operator|->
name|sm_lid
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|p_madw
operator|->
name|mad_addr
operator|.
name|addr_type
operator|.
name|smi
operator|.
name|source_lid
operator|=
name|cl_hton16
argument_list|(
name|p_bind
operator|->
name|lid
argument_list|)
expr_stmt|;
name|p_madw
operator|->
name|mad_addr
operator|.
name|addr_type
operator|.
name|gsi
operator|.
name|remote_qp
operator|=
name|CL_HTON32
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|p_madw
operator|->
name|resp_expected
operator|=
name|TRUE
expr_stmt|;
name|p_madw
operator|->
name|fail_msg
operator|=
name|CL_DISP_MSGID_NONE
expr_stmt|;
comment|/* 	   Provide MAD context such that the call back will know what to do. 	   We have to keep the entire request structure so we know the CB. 	   Since we can not rely on the client to keep it around until 	   the response - we duplicate it and will later dispose it (in CB). 	   To store on the MADW we cast it into what opensm has: 	   p_madw->context.arb_context.context1 	 */
name|p_query_req_copy
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p_query_req_copy
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_query_req_copy
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 0511: "
literal|"Unable to acquire memory for query copy\n"
argument_list|)
expr_stmt|;
name|osm_mad_pool_put
argument_list|(
name|p_bind
operator|->
name|p_mad_pool
argument_list|,
name|p_madw
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_INSUFFICIENT_RESOURCES
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|*
name|p_query_req_copy
operator|=
operator|*
name|p_query_req
expr_stmt|;
name|p_madw
operator|->
name|context
operator|.
name|arb_context
operator|.
name|context1
operator|=
name|p_query_req_copy
expr_stmt|;
comment|/* we can support async as well as sync calls */
name|sync
operator|=
operator|(
operator|(
name|p_query_req
operator|->
name|flags
operator|&
name|OSM_SA_FLAGS_SYNC
operator|)
operator|==
name|OSM_SA_FLAGS_SYNC
operator|)
expr_stmt|;
comment|/* send the mad asynchronously */
name|status
operator|=
name|osm_vendor_send
argument_list|(
name|osm_madw_get_bind_handle
argument_list|(
name|p_madw
argument_list|)
argument_list|,
name|p_madw
argument_list|,
name|p_madw
operator|->
name|resp_expected
argument_list|)
expr_stmt|;
comment|/* if synchronous - wait on the event */
if|if
condition|(
name|sync
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Waiting for async event\n"
argument_list|)
expr_stmt|;
name|cl_event_wait_on
argument_list|(
operator|&
name|p_bind
operator|->
name|sync_event
argument_list|,
name|EVENT_NO_TIMEOUT
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|cl_event_reset
argument_list|(
operator|&
name|p_bind
operator|->
name|sync_event
argument_list|)
expr_stmt|;
name|status
operator|=
name|p_madw
operator|->
name|status
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*  * Query the SA based on the user's request.  */
end_comment

begin_function
name|ib_api_status_t
name|osmv_query_sa
parameter_list|(
name|IN
name|osm_bind_handle_t
name|h_bind
parameter_list|,
name|IN
specifier|const
name|osmv_query_req_t
modifier|*
specifier|const
name|p_query_req
parameter_list|)
block|{
union|union
block|{
name|ib_service_record_t
name|svc_rec
decl_stmt|;
name|ib_node_record_t
name|node_rec
decl_stmt|;
name|ib_portinfo_record_t
name|port_info
decl_stmt|;
name|ib_path_rec_t
name|path_rec
decl_stmt|;
ifdef|#
directive|ifdef
name|DUAL_SIDED_RMPP
name|ib_multipath_rec_t
name|multipath_rec
decl_stmt|;
endif|#
directive|endif
name|ib_class_port_info_t
name|class_port_info
decl_stmt|;
block|}
name|u
union|;
name|osmv_sa_mad_data_t
name|sa_mad_data
decl_stmt|;
name|osmv_sa_bind_info_t
modifier|*
name|p_bind
init|=
operator|(
name|osmv_sa_bind_info_t
operator|*
operator|)
name|h_bind
decl_stmt|;
name|osmv_user_query_t
modifier|*
name|p_user_query
decl_stmt|;
ifdef|#
directive|ifdef
name|DUAL_SIDED_RMPP
name|osmv_multipath_req_t
modifier|*
name|p_mpr_req
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
endif|#
directive|endif
name|osm_log_t
modifier|*
name|p_log
init|=
name|p_bind
operator|->
name|p_log
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
comment|/* Set the request information. */
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GETTABLE
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_mod
operator|=
literal|0
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_offset
operator|=
literal|0
expr_stmt|;
comment|/* Set the MAD attributes and component mask correctly. */
switch|switch
condition|(
name|p_query_req
operator|->
name|query_type
condition|)
block|{
case|case
name|OSMV_QUERY_USER_DEFINED
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 USER_DEFINED\n"
argument_list|)
expr_stmt|;
name|p_user_query
operator|=
operator|(
name|osmv_user_query_t
operator|*
operator|)
name|p_query_req
operator|->
name|p_query_input
expr_stmt|;
if|if
condition|(
name|p_user_query
operator|->
name|method
condition|)
name|sa_mad_data
operator|.
name|method
operator|=
name|p_user_query
operator|->
name|method
expr_stmt|;
ifdef|#
directive|ifdef
name|DUAL_SIDED_RMPP
if|if
condition|(
name|sa_mad_data
operator|.
name|method
operator|==
name|IB_MAD_METHOD_GETMULTI
operator|||
name|sa_mad_data
operator|.
name|method
operator|==
name|IB_MAD_METHOD_GETTRACETABLE
condition|)
name|sa_mad_data
operator|.
name|attr_offset
operator|=
name|p_user_query
operator|->
name|attr_offset
expr_stmt|;
endif|#
directive|endif
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|p_user_query
operator|->
name|attr_id
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_mod
operator|=
name|p_user_query
operator|->
name|attr_mod
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|p_user_query
operator|->
name|comp_mask
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
name|p_user_query
operator|->
name|p_attr
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_ALL_SVC_RECS
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 SVC_REC_BY_NAME\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
literal|0
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|svc_rec
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_SVC_REC_BY_NAME
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 SVC_REC_BY_NAME\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SNAME
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|svc_rec
expr_stmt|;
name|memcpy
argument_list|(
name|u
operator|.
name|svc_rec
operator|.
name|service_name
argument_list|,
name|p_query_req
operator|->
name|p_query_input
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_svc_name_t
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_SVC_REC_BY_ID
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 SVC_REC_BY_ID\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SID
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|svc_rec
expr_stmt|;
name|u
operator|.
name|svc_rec
operator|.
name|service_id
operator|=
operator|*
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
name|p_query_req
operator|->
name|p_query_input
operator|)
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_CLASS_PORT_INFO
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 CLASS_PORT_INFO\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_CLASS_PORT_INFO
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
literal|0
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|class_port_info
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_NODE_REC_BY_NODE_GUID
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 NODE_REC_BY_NODE_GUID\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_NODE_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|IB_NR_COMPMASK_NODEGUID
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|node_rec
expr_stmt|;
name|u
operator|.
name|node_rec
operator|.
name|node_info
operator|.
name|node_guid
operator|=
operator|*
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
name|p_query_req
operator|->
name|p_query_input
operator|)
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_PORT_REC_BY_LID
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 PORT_REC_BY_LID\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_PORTINFO_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|IB_PIR_COMPMASK_LID
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|port_info
expr_stmt|;
name|u
operator|.
name|port_info
operator|.
name|lid
operator|=
operator|*
operator|(
name|ib_net16_t
operator|*
operator|)
operator|(
name|p_query_req
operator|->
name|p_query_input
operator|)
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_PORT_REC_BY_LID_AND_NUM
case|:
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|p_user_query
operator|=
operator|(
name|osmv_user_query_t
operator|*
operator|)
name|p_query_req
operator|->
name|p_query_input
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 PORT_REC_BY_LID_AND_NUM\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_PORTINFO_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|IB_PIR_COMPMASK_LID
operator||
name|IB_PIR_COMPMASK_PORTNUM
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
name|p_user_query
operator|->
name|p_attr
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_VLARB_BY_LID_PORT_BLOCK
case|:
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|p_user_query
operator|=
operator|(
name|osmv_user_query_t
operator|*
operator|)
name|p_query_req
operator|->
name|p_query_input
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 OSMV_QUERY_VLARB_BY_LID_PORT_BLOCK\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_VLARB_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|IB_VLA_COMPMASK_LID
operator||
name|IB_VLA_COMPMASK_OUT_PORT
operator||
name|IB_VLA_COMPMASK_BLOCK
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
name|p_user_query
operator|->
name|p_attr
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_SLVL_BY_LID_AND_PORTS
case|:
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|p_user_query
operator|=
operator|(
name|osmv_user_query_t
operator|*
operator|)
name|p_query_req
operator|->
name|p_query_input
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 OSMV_QUERY_VLARB_BY_LID_PORT_BLOCK\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SLVL_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|IB_SLVL_COMPMASK_LID
operator||
name|IB_SLVL_COMPMASK_OUT_PORT
operator||
name|IB_SLVL_COMPMASK_IN_PORT
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
name|p_user_query
operator|->
name|p_attr
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_PATH_REC_BY_PORT_GUIDS
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 PATH_REC_BY_PORT_GUIDS\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|u
operator|.
name|path_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_path_rec_t
argument_list|)
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_PATH_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
operator|(
name|IB_PR_COMPMASK_DGID
operator||
name|IB_PR_COMPMASK_SGID
operator||
name|IB_PR_COMPMASK_NUMBPATH
operator|)
expr_stmt|;
name|u
operator|.
name|path_rec
operator|.
name|num_path
operator|=
literal|0x7f
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|path_rec
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|u
operator|.
name|path_rec
operator|.
name|dgid
argument_list|,
operator|(
operator|(
name|osmv_guid_pair_t
operator|*
operator|)
operator|(
name|p_query_req
operator|->
name|p_query_input
operator|)
operator|)
operator|->
name|dest_guid
argument_list|)
expr_stmt|;
name|ib_gid_set_default
argument_list|(
operator|&
name|u
operator|.
name|path_rec
operator|.
name|sgid
argument_list|,
operator|(
operator|(
name|osmv_guid_pair_t
operator|*
operator|)
operator|(
name|p_query_req
operator|->
name|p_query_input
operator|)
operator|)
operator|->
name|src_guid
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_PATH_REC_BY_GIDS
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 PATH_REC_BY_GIDS\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|u
operator|.
name|path_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_path_rec_t
argument_list|)
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_PATH_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
operator|(
name|IB_PR_COMPMASK_DGID
operator||
name|IB_PR_COMPMASK_SGID
operator||
name|IB_PR_COMPMASK_NUMBPATH
operator|)
expr_stmt|;
name|u
operator|.
name|path_rec
operator|.
name|num_path
operator|=
literal|0x7f
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|path_rec
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|u
operator|.
name|path_rec
operator|.
name|dgid
argument_list|,
operator|&
operator|(
operator|(
name|osmv_gid_pair_t
operator|*
operator|)
operator|(
name|p_query_req
operator|->
name|p_query_input
operator|)
operator|)
operator|->
name|dest_gid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|u
operator|.
name|path_rec
operator|.
name|sgid
argument_list|,
operator|&
operator|(
operator|(
name|osmv_gid_pair_t
operator|*
operator|)
operator|(
name|p_query_req
operator|->
name|p_query_input
operator|)
operator|)
operator|->
name|src_gid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_PATH_REC_BY_LIDS
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 PATH_REC_BY_LIDS\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|u
operator|.
name|path_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_path_rec_t
argument_list|)
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_PATH_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
operator|(
name|IB_PR_COMPMASK_DLID
operator||
name|IB_PR_COMPMASK_SLID
operator|)
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|path_rec
expr_stmt|;
name|u
operator|.
name|path_rec
operator|.
name|dlid
operator|=
operator|(
operator|(
name|osmv_lid_pair_t
operator|*
operator|)
operator|(
name|p_query_req
operator|->
name|p_query_input
operator|)
operator|)
operator|->
name|dest_lid
expr_stmt|;
name|u
operator|.
name|path_rec
operator|.
name|slid
operator|=
operator|(
operator|(
name|osmv_lid_pair_t
operator|*
operator|)
operator|(
name|p_query_req
operator|->
name|p_query_input
operator|)
operator|)
operator|->
name|src_lid
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_UD_MULTICAST_SET
case|:
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_SET
expr_stmt|;
name|p_user_query
operator|=
operator|(
name|osmv_user_query_t
operator|*
operator|)
name|p_query_req
operator|->
name|p_query_input
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 OSMV_QUERY_UD_MULTICAST_SET\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_MCMEMBER_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|p_user_query
operator|->
name|comp_mask
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
name|p_user_query
operator|->
name|p_attr
expr_stmt|;
break|break;
case|case
name|OSMV_QUERY_UD_MULTICAST_DELETE
case|:
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_DELETE
expr_stmt|;
name|p_user_query
operator|=
operator|(
name|osmv_user_query_t
operator|*
operator|)
name|p_query_req
operator|->
name|p_query_input
expr_stmt|;
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 OSMV_QUERY_UD_MULTICAST_DELETE\n"
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_MCMEMBER_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|p_user_query
operator|->
name|comp_mask
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
name|p_user_query
operator|->
name|p_attr
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|DUAL_SIDED_RMPP
case|case
name|OSMV_QUERY_MULTIPATH_REC
case|:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"DBG:001 MULTIPATH_REC\n"
argument_list|)
expr_stmt|;
comment|/* Validate sgid/dgid counts against SA client limit */
name|p_mpr_req
operator|=
operator|(
name|osmv_multipath_req_t
operator|*
operator|)
name|p_query_req
operator|->
name|p_query_input
expr_stmt|;
if|if
condition|(
name|p_mpr_req
operator|->
name|sgid_count
operator|+
name|p_mpr_req
operator|->
name|dgid_count
operator|>
name|IB_MULTIPATH_MAX_GIDS
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"DBG:001 MULTIPATH_REC "
literal|"SGID count %d DGID count %d max count %d\n"
argument_list|,
name|p_mpr_req
operator|->
name|sgid_count
argument_list|,
name|p_mpr_req
operator|->
name|dgid_count
argument_list|,
name|IB_MULTIPATH_MAX_GIDS
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
name|memset
argument_list|(
operator|&
name|u
operator|.
name|multipath_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_multipath_rec_t
argument_list|)
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GETMULTI
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_MULTIPATH_RECORD
expr_stmt|;
name|sa_mad_data
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_multipath_rec_t
argument_list|)
argument_list|)
expr_stmt|;
name|sa_mad_data
operator|.
name|p_attr
operator|=
operator|&
name|u
operator|.
name|multipath_rec
expr_stmt|;
name|sa_mad_data
operator|.
name|comp_mask
operator|=
name|p_mpr_req
operator|->
name|comp_mask
expr_stmt|;
name|u
operator|.
name|multipath_rec
operator|.
name|num_path
operator|=
name|p_mpr_req
operator|->
name|num_path
expr_stmt|;
if|if
condition|(
name|p_mpr_req
operator|->
name|reversible
condition|)
name|u
operator|.
name|multipath_rec
operator|.
name|num_path
operator||=
literal|0x80
expr_stmt|;
else|else
name|u
operator|.
name|multipath_rec
operator|.
name|num_path
operator|&=
operator|~
literal|0x80
expr_stmt|;
name|u
operator|.
name|multipath_rec
operator|.
name|pkey
operator|=
name|p_mpr_req
operator|->
name|pkey
expr_stmt|;
name|ib_multipath_rec_set_sl
argument_list|(
operator|&
name|u
operator|.
name|multipath_rec
argument_list|,
name|p_mpr_req
operator|->
name|sl
argument_list|)
expr_stmt|;
name|ib_multipath_rec_set_qos_class
argument_list|(
operator|&
name|u
operator|.
name|multipath_rec
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|u
operator|.
name|multipath_rec
operator|.
name|independence
operator|=
name|p_mpr_req
operator|->
name|independence
expr_stmt|;
name|u
operator|.
name|multipath_rec
operator|.
name|sgid_count
operator|=
name|p_mpr_req
operator|->
name|sgid_count
expr_stmt|;
name|u
operator|.
name|multipath_rec
operator|.
name|dgid_count
operator|=
name|p_mpr_req
operator|->
name|dgid_count
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_mpr_req
operator|->
name|sgid_count
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
name|u
operator|.
name|multipath_rec
operator|.
name|gids
index|[
name|j
index|]
operator|=
name|p_mpr_req
operator|->
name|gids
index|[
name|j
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_mpr_req
operator|->
name|dgid_count
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
name|u
operator|.
name|multipath_rec
operator|.
name|gids
index|[
name|j
index|]
operator|=
name|p_mpr_req
operator|->
name|gids
index|[
name|j
index|]
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"DBG:001 UNKNOWN\n"
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
name|status
operator|=
name|__osmv_send_sa_req
argument_list|(
name|h_bind
argument_list|,
operator|&
name|sa_mad_data
argument_list|,
name|p_query_req
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

end_unit


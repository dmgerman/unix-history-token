begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2005 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|OSM_VENDOR_INTF_SIM
argument_list|)
end_if

begin_undef
undef|#
directive|undef
name|IN
end_undef

begin_undef
undef|#
directive|undef
name|OUT
end_undef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<vendor/osm_vendor_api.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_log.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<dirent.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_comment
comment|/****************************************************************************** * * Provides the functionality for selecting an HCA Port and Obtaining it's guid. * This version is based on $IBMGTSIM_DIR/$IBMGTSIM_NODE file system. * This is a mimic of the OpenIB gen1 file system * ******************************************************************************/
end_comment

begin_function
name|char
modifier|*
name|__get_simulator_dir
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|ibmgtSimDir
init|=
name|NULL
decl_stmt|;
specifier|static
name|char
modifier|*
name|defaultIbmgtSimDir
init|=
literal|"/tmp/ibmgtsim"
decl_stmt|;
specifier|static
name|char
modifier|*
name|ibmgtSimNode
init|=
name|NULL
decl_stmt|;
specifier|static
name|char
name|dirName
index|[
literal|1024
index|]
decl_stmt|;
comment|/* we use the first pointer to know if we were here */
if|if
condition|(
name|ibmgtSimDir
operator|==
name|NULL
condition|)
block|{
comment|/* obtain the simulator directory */
name|ibmgtSimDir
operator|=
name|getenv
argument_list|(
literal|"IBMGTSIM_DIR"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibmgtSimDir
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"-W- Environment variable: IBMGTSIM_DIR does not exist.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    Please create one used by the simulator.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    Using /tmp/ibmgtsim as default.\n"
argument_list|)
expr_stmt|;
name|ibmgtSimDir
operator|=
name|defaultIbmgtSimDir
expr_stmt|;
block|}
comment|/* obtain the node name we simulate */
name|ibmgtSimNode
operator|=
name|getenv
argument_list|(
literal|"IBMGTSIM_NODE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibmgtSimNode
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"-W- Environment variable: IBMGTSIM_NODE does not exist.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    This variable should be the name of the node you wish to simulate.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    Using H-1 as default.\n"
argument_list|)
expr_stmt|;
name|ibmgtSimNode
operator|=
literal|"H-1"
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|dirName
argument_list|,
literal|"%s/%s"
argument_list|,
name|ibmgtSimDir
argument_list|,
name|ibmgtSimNode
argument_list|)
expr_stmt|;
block|}
return|return
name|dirName
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|_osm_ca_info
block|{
name|ib_net64_t
name|guid
decl_stmt|;
name|size_t
name|attr_size
decl_stmt|;
name|ib_ca_attr_t
modifier|*
name|p_attr
decl_stmt|;
block|}
name|osm_ca_info_t
typedef|;
end_typedef

begin_comment
comment|/**********************************************************************  * Returns a pointer to the port attribute of the specified port  * owned by this CA.  ************************************************************************/
end_comment

begin_function
specifier|static
name|ib_port_attr_t
modifier|*
name|__osm_ca_info_get_port_attr_ptr
parameter_list|(
name|IN
specifier|const
name|osm_ca_info_t
modifier|*
specifier|const
name|p_ca_info
parameter_list|,
name|IN
specifier|const
name|uint8_t
name|index
parameter_list|)
block|{
return|return
operator|(
operator|&
name|p_ca_info
operator|->
name|p_attr
operator|->
name|p_port_attr
index|[
name|index
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Obtain the number of local CAs by scanning /proc/infiniband/core  **********************************************************************/
end_comment

begin_function
name|int
name|__hca_sim_get_num_cas
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|num_cas
init|=
literal|0
decl_stmt|;
name|DIR
modifier|*
name|dp
decl_stmt|;
name|struct
name|dirent
modifier|*
name|ep
decl_stmt|;
name|dp
operator|=
name|opendir
argument_list|(
name|__get_simulator_dir
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
operator|(
name|ep
operator|=
name|readdir
argument_list|(
name|dp
argument_list|)
operator|)
condition|)
block|{
comment|/* CAs are directories with the format ca[1-9][0-9]* */
comment|/*  if ((ep->d_type == DT_DIR)&& !strncmp(ep->d_name, "ca", 2)) */
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ep
operator|->
name|d_name
argument_list|,
literal|"ca"
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|num_cas
operator|++
expr_stmt|;
block|}
block|}
name|closedir
argument_list|(
name|dp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"__hca_sim_get_num_cas: ERROR : ail to open dir %s\n"
argument_list|,
name|__get_simulator_dir
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|num_cas
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|num_cas
return|;
block|}
end_function

begin_comment
comment|/*   name:          InfiniHost0   provider:      tavor   node GUID:     0002:c900:0120:3470   ports:         2   vendor ID:     0x2c9   device ID:     0x5a44   HW revision:   0xa1   FW revision:   0x300020080 */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|_sim_ca_info
block|{
name|char
name|name
index|[
literal|32
index|]
decl_stmt|;
name|char
name|provider
index|[
literal|32
index|]
decl_stmt|;
name|uint64_t
name|guid
decl_stmt|;
name|uint8_t
name|num_ports
decl_stmt|;
name|uint32_t
name|vend_id
decl_stmt|;
name|uint16_t
name|dev_id
decl_stmt|;
name|uint16_t
name|rev_id
decl_stmt|;
name|uint64_t
name|fw_rev
decl_stmt|;
block|}
name|sim_ca_info_t
typedef|;
end_typedef

begin_comment
comment|/**********************************************************************  * Parse the CA Info file available in ibmgtSimDir/caN/info  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|__parse_ca_info_file
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|uint32_t
name|idx
parameter_list|,
name|OUT
name|sim_ca_info_t
modifier|*
name|sim_ca_info
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_ERROR
decl_stmt|;
name|int
name|info_file
decl_stmt|;
name|char
name|file_name
index|[
literal|256
index|]
decl_stmt|;
name|char
name|file_buffer
index|[
literal|3200
index|]
decl_stmt|;
name|char
modifier|*
name|p_ch
decl_stmt|;
name|int
name|g1
decl_stmt|,
name|g2
decl_stmt|,
name|g3
decl_stmt|,
name|g4
decl_stmt|;
name|int
name|num_ports
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"__parse_ca_info_file: "
literal|"Querying CA %d.\n"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
comment|/* we use the proc file system so we must be able to open the info file .. */
name|sprintf
argument_list|(
name|file_name
argument_list|,
literal|"%s/ca%d/info"
argument_list|,
name|__get_simulator_dir
argument_list|()
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|info_file
operator|=
name|open
argument_list|(
name|file_name
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info_file
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_ca_info_file: ERR 5105: "
literal|"Fail to open HCA:%d info file:(%s).\n"
argument_list|,
name|idx
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* read in the file */
name|len
operator|=
name|read
argument_list|(
name|info_file
argument_list|,
name|file_buffer
argument_list|,
literal|3200
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|info_file
argument_list|)
expr_stmt|;
name|file_buffer
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* 	   parse the file ... 	   name:          InfiniHost0 	   provider:      tavor 	   node GUID:     0002:c900:0120:3470 	   ports:         2 	   vendor ID:     0x2c9 	   device ID:     0x5a44 	   HW revision:   0xa1 	   FW revision:   0x300020080 	 */
if|if
condition|(
operator|!
operator|(
name|p_ch
operator|=
name|strstr
argument_list|(
name|file_buffer
argument_list|,
literal|"name:"
argument_list|)
operator|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_ca_info_file: ERR 5106: "
literal|"Fail to obtain HCA name. In info file:(%s).\n"
argument_list|,
name|file_buffer
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|p_ch
argument_list|,
literal|"name: %s"
argument_list|,
name|sim_ca_info
operator|->
name|name
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_ca_info_file: ERR 5107: "
literal|"Fail to parse name in info file:(%s).\n"
argument_list|,
name|p_ch
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* get the guid of the HCA */
if|if
condition|(
operator|!
operator|(
name|p_ch
operator|=
name|strstr
argument_list|(
name|file_buffer
argument_list|,
literal|"node GUID:"
argument_list|)
operator|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_ca_info_file: ERR 5108: "
literal|"Fail to obtain GUID in info file:(%s).\n"
argument_list|,
name|file_buffer
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|p_ch
argument_list|,
literal|"node GUID: %x:%x:%x:%x"
argument_list|,
operator|&
name|g1
argument_list|,
operator|&
name|g2
argument_list|,
operator|&
name|g3
argument_list|,
operator|&
name|g4
argument_list|)
operator|!=
literal|4
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_ca_info_file: ERR 5109: "
literal|"Fail to parse GUID in info file:(%s).\n"
argument_list|,
name|p_ch
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|sim_ca_info
operator|->
name|guid
operator|=
operator|(
name|uint64_t
operator|)
name|g1
operator|<<
literal|48
operator||
operator|(
name|uint64_t
operator|)
name|g1
operator|<<
literal|32
operator||
operator|(
name|uint64_t
operator|)
name|g1
operator|<<
literal|16
operator||
operator|(
name|uint64_t
operator|)
name|g3
expr_stmt|;
comment|/* obtain number of ports */
if|if
condition|(
operator|!
operator|(
name|p_ch
operator|=
name|strstr
argument_list|(
name|file_buffer
argument_list|,
literal|"ports:"
argument_list|)
operator|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_ca_info_file: ERR 5110: "
literal|"Fail to obtain number of ports in info file:(%s).\n"
argument_list|,
name|file_buffer
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|p_ch
argument_list|,
literal|"ports: %d"
argument_list|,
operator|&
name|num_ports
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_ca_info_file: ERR 5111: "
literal|"Fail to parse num ports in info file:(%s).\n"
argument_list|,
name|p_ch
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|sim_ca_info
operator|->
name|num_ports
operator|=
name|num_ports
expr_stmt|;
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"__parse_ca_info_file: "
literal|"CA1 = name:%s guid:0x%"
name|PRIx64
literal|" ports:%d\n"
argument_list|,
name|sim_ca_info
operator|->
name|name
argument_list|,
name|sim_ca_info
operator|->
name|guid
argument_list|,
name|sim_ca_info
operator|->
name|num_ports
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/*   state:         ACTIVE   LID:           0x0001   LMC:           0x0000   SM LID:        0x0001   SM SL:         0x0000   Capabilities:  IsSM   IsTrapSupported   IsAutomaticMigrationSupported   IsSLMappingSupported   IsLEDInfoSupported   IsSystemImageGUIDSupported   IsVendorClassSupported   IsCapabilityMaskNoticeSupported */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|_sim_port_info
block|{
name|uint8_t
name|state
decl_stmt|;
name|uint16_t
name|lid
decl_stmt|;
name|uint8_t
name|lmc
decl_stmt|;
name|uint16_t
name|sm_lid
decl_stmt|;
name|uint8_t
name|sm_sl
decl_stmt|;
block|}
name|sim_port_info_t
typedef|;
end_typedef

begin_comment
comment|/**********************************************************************  * Parse the Port Info file available in ibmgtSimDir/caN/portM/info  * Port num is 1..N  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|__parse_port_info_file
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|uint32_t
name|hca_idx
parameter_list|,
name|IN
name|uint8_t
name|port_num
parameter_list|,
name|OUT
name|sim_port_info_t
modifier|*
name|sim_port_info
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_ERROR
decl_stmt|;
name|int
name|info_file
decl_stmt|;
name|char
name|file_name
index|[
literal|256
index|]
decl_stmt|;
name|char
name|file_buffer
index|[
literal|3200
index|]
decl_stmt|;
name|char
name|state
index|[
literal|12
index|]
decl_stmt|;
name|char
modifier|*
name|p_ch
decl_stmt|;
name|int
name|lid
decl_stmt|,
name|sm_lid
decl_stmt|,
name|lmc
decl_stmt|,
name|sm_sl
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"__parse_port_info_file: "
literal|"Parsing Proc File System Port Info CA %d Port %d.\n"
argument_list|,
name|hca_idx
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
comment|/* we use the proc file system so we must be able to open the info file .. */
name|sprintf
argument_list|(
name|file_name
argument_list|,
literal|"%s/ca%d/port%d/info"
argument_list|,
name|__get_simulator_dir
argument_list|()
argument_list|,
name|hca_idx
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|info_file
operator|=
name|open
argument_list|(
name|file_name
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info_file
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5112: "
literal|"Fail to open HCA:%d Port:%d info file:(%s).\n"
argument_list|,
name|hca_idx
argument_list|,
name|port_num
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* read in the file */
name|len
operator|=
name|read
argument_list|(
name|info_file
argument_list|,
name|file_buffer
argument_list|,
literal|3200
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|info_file
argument_list|)
expr_stmt|;
name|file_buffer
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* 	   parse the file ... 	   state:         ACTIVE 	   LID:           0x0001 	   LMC:           0x0000 	   SM LID:        0x0001 	   SM SL:         0x0000 	   ... 	 */
if|if
condition|(
operator|!
operator|(
name|p_ch
operator|=
name|strstr
argument_list|(
name|file_buffer
argument_list|,
literal|"state:"
argument_list|)
operator|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5113: "
literal|"Fail to obtain port state. In info file:(%s).\n"
argument_list|,
name|file_buffer
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|p_ch
argument_list|,
literal|"state: %s"
argument_list|,
name|state
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5114: "
literal|"Fail to parse state from info file:(%s).\n"
argument_list|,
name|p_ch
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|state
argument_list|,
literal|"ACTIVE"
argument_list|)
condition|)
name|sim_port_info
operator|->
name|state
operator|=
name|IB_LINK_ACTIVE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|state
argument_list|,
literal|"DOWN"
argument_list|)
condition|)
name|sim_port_info
operator|->
name|state
operator|=
name|IB_LINK_DOWN
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|state
argument_list|,
literal|"INIT"
argument_list|)
condition|)
name|sim_port_info
operator|->
name|state
operator|=
name|IB_LINK_INIT
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|state
argument_list|,
literal|"ARMED"
argument_list|)
condition|)
name|sim_port_info
operator|->
name|state
operator|=
name|IB_LINK_ARMED
expr_stmt|;
else|else
name|sim_port_info
operator|->
name|state
operator|=
literal|0
expr_stmt|;
comment|/* get lid */
if|if
condition|(
operator|!
operator|(
name|p_ch
operator|=
name|strstr
argument_list|(
name|file_buffer
argument_list|,
literal|"LID:"
argument_list|)
operator|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5115: "
literal|"Fail to obtain port lid. In info file:(%s).\n"
argument_list|,
name|file_buffer
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|p_ch
argument_list|,
literal|"LID: %x"
argument_list|,
operator|&
name|lid
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5116: "
literal|"Fail to parse lid from info file:(%s).\n"
argument_list|,
name|p_ch
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|sim_port_info
operator|->
name|lid
operator|=
name|lid
expr_stmt|;
comment|/* get LMC */
if|if
condition|(
operator|!
operator|(
name|p_ch
operator|=
name|strstr
argument_list|(
name|file_buffer
argument_list|,
literal|"LMC:"
argument_list|)
operator|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5117: "
literal|"Fail to obtain port LMC. In info file:(%s).\n"
argument_list|,
name|file_buffer
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|p_ch
argument_list|,
literal|"LMC: %x"
argument_list|,
operator|&
name|lmc
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5118: "
literal|"Fail to parse LMC from info file:(%s).\n"
argument_list|,
name|p_ch
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|sim_port_info
operator|->
name|lmc
operator|=
name|lmc
expr_stmt|;
comment|/* get SM LID */
if|if
condition|(
operator|!
operator|(
name|p_ch
operator|=
name|strstr
argument_list|(
name|file_buffer
argument_list|,
literal|"SM LID:"
argument_list|)
operator|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5119: "
literal|"Fail to obtain port SM LID. In info file:(%s).\n"
argument_list|,
name|file_buffer
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|p_ch
argument_list|,
literal|"SM LID: %x"
argument_list|,
operator|&
name|sm_lid
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5120: "
literal|"Fail to parse SM LID from info file:(%s).\n"
argument_list|,
name|p_ch
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|sim_port_info
operator|->
name|sm_lid
operator|=
name|sm_lid
expr_stmt|;
comment|/* get SM LID */
if|if
condition|(
operator|!
operator|(
name|p_ch
operator|=
name|strstr
argument_list|(
name|file_buffer
argument_list|,
literal|"SM SL:"
argument_list|)
operator|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5121: "
literal|"Fail to obtain port SM SL. In info file:(%s).\n"
argument_list|,
name|file_buffer
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|p_ch
argument_list|,
literal|"SM SL: %x"
argument_list|,
operator|&
name|sm_sl
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__parse_port_info_file: ERR 5122: "
literal|"Fail to parse SM SL from info file:(%s).\n"
argument_list|,
name|p_ch
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|sim_port_info
operator|->
name|sm_sl
operator|=
name|sm_sl
expr_stmt|;
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"__parse_port_info_file:  "
literal|"Obtained Port:%d = state:%d, lid:0x%04X, lmc:%d, sm_lid:0x%04X, sm_sl:%d\n"
argument_list|,
name|port_num
argument_list|,
name|sim_port_info
operator|->
name|state
argument_list|,
name|sim_port_info
operator|->
name|lid
argument_list|,
name|sim_port_info
operator|->
name|lmc
argument_list|,
name|sim_port_info
operator|->
name|sm_lid
argument_list|,
name|sim_port_info
operator|->
name|sm_sl
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Parse the port guid_tbl file to obtain the port guid.  * File format is:  * [  0] fe80:0000:0000:0000:0002:c900:0120:3472  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|__get_port_guid_from_port_gid_tbl
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|uint32_t
name|hca_idx
parameter_list|,
name|IN
name|uint8_t
name|port_num
parameter_list|,
name|OUT
name|uint64_t
modifier|*
name|port_guid
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_ERROR
decl_stmt|;
name|int
name|info_file
decl_stmt|;
name|char
name|file_name
index|[
literal|256
index|]
decl_stmt|;
name|char
name|file_buffer
index|[
literal|3200
index|]
decl_stmt|;
name|char
modifier|*
name|p_ch
decl_stmt|;
name|int
name|g
index|[
literal|8
index|]
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"__get_port_guid_from_port_gid_tbl: "
literal|"Parsing Proc File System Port Guid Table CA %d Port %d.\n"
argument_list|,
name|hca_idx
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
comment|/* we use the proc file system so we must be able to open the info file .. */
name|sprintf
argument_list|(
name|file_name
argument_list|,
literal|"%s/ca%d/port%d/gid_table"
argument_list|,
name|__get_simulator_dir
argument_list|()
argument_list|,
name|hca_idx
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|info_file
operator|=
name|open
argument_list|(
name|file_name
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info_file
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__get_port_guid_from_port_gid_tbl: ERR 5123: "
literal|"Fail to open HCA:%d Port:%d gid_table file:(%s).\n"
argument_list|,
name|hca_idx
argument_list|,
name|port_num
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* read in the file */
name|len
operator|=
name|read
argument_list|(
name|info_file
argument_list|,
name|file_buffer
argument_list|,
literal|3200
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|info_file
argument_list|)
expr_stmt|;
name|file_buffer
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* 	   parse the file ... 	   [  0] fe80:0000:0000:0000:0002:c900:0120:3472 	   ... 	 */
if|if
condition|(
operator|!
operator|(
name|p_ch
operator|=
name|strstr
argument_list|(
name|file_buffer
argument_list|,
literal|"[  0]"
argument_list|)
operator|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__get_port_guid_from_port_gid_tbl: ERR 5124: "
literal|"Fail to obtain first gid index. In gid_table file:(%s).\n"
argument_list|,
name|file_buffer
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|p_ch
operator|+
literal|6
argument_list|,
literal|"%x:%x:%x:%x:%x:%x:%x:%x"
argument_list|,
operator|&
name|g
index|[
literal|7
index|]
argument_list|,
operator|&
name|g
index|[
literal|6
index|]
argument_list|,
operator|&
name|g
index|[
literal|5
index|]
argument_list|,
operator|&
name|g
index|[
literal|4
index|]
argument_list|,
operator|&
name|g
index|[
literal|3
index|]
argument_list|,
operator|&
name|g
index|[
literal|2
index|]
argument_list|,
operator|&
name|g
index|[
literal|1
index|]
argument_list|,
operator|&
name|g
index|[
literal|0
index|]
argument_list|)
operator|!=
literal|8
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__get_port_guid_from_port_gid_tbl: ERR 5125: "
literal|"Fail to parse gid from gid_table file:(%s).\n"
argument_list|,
name|p_ch
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|*
name|port_guid
operator|=
operator|(
name|uint64_t
operator|)
name|g
index|[
literal|3
index|]
operator|<<
literal|48
operator||
operator|(
name|uint64_t
operator|)
name|g
index|[
literal|2
index|]
operator|<<
literal|32
operator||
operator|(
name|uint64_t
operator|)
name|g
index|[
literal|1
index|]
operator|<<
literal|16
operator||
name|g
index|[
literal|0
index|]
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Initialize an Info Struct for the Given HCA by its index 1..N  **********************************************************************/
end_comment

begin_function
specifier|static
name|ib_api_status_t
name|__osm_ca_info_init
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|uint32_t
specifier|const
name|idx
parameter_list|,
name|OUT
name|osm_ca_info_t
modifier|*
specifier|const
name|p_ca_info
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_ERROR
decl_stmt|;
name|uint8_t
name|port_num
decl_stmt|;
name|uint64_t
name|port_guid
decl_stmt|;
name|sim_ca_info_t
name|sim_ca_info
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
comment|/* parse the CA info file */
if|if
condition|(
name|__parse_ca_info_file
argument_list|(
name|p_vend
argument_list|,
name|idx
argument_list|,
operator|&
name|sim_ca_info
argument_list|)
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|p_ca_info
operator|->
name|guid
operator|=
name|cl_hton64
argument_list|(
name|sim_ca_info
operator|.
name|guid
argument_list|)
expr_stmt|;
comment|/* set size of attributes and allocate them */
name|p_ca_info
operator|->
name|attr_size
operator|=
literal|1
expr_stmt|;
name|p_ca_info
operator|->
name|p_attr
operator|=
operator|(
name|ib_ca_attr_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_ca_attr_t
argument_list|)
argument_list|)
expr_stmt|;
name|p_ca_info
operator|->
name|p_attr
operator|->
name|ca_guid
operator|=
name|p_ca_info
operator|->
name|guid
expr_stmt|;
name|p_ca_info
operator|->
name|p_attr
operator|->
name|num_ports
operator|=
name|sim_ca_info
operator|.
name|num_ports
expr_stmt|;
comment|/* now obtain the attributes of the ports */
name|p_ca_info
operator|->
name|p_attr
operator|->
name|p_port_attr
operator|=
operator|(
name|ib_port_attr_t
operator|*
operator|)
name|malloc
argument_list|(
name|sim_ca_info
operator|.
name|num_ports
operator|*
sizeof|sizeof
argument_list|(
name|ib_port_attr_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* get all the ports info */
for|for
control|(
name|port_num
operator|=
literal|1
init|;
name|port_num
operator|<=
name|sim_ca_info
operator|.
name|num_ports
condition|;
name|port_num
operator|++
control|)
block|{
name|sim_port_info_t
name|sim_port_info
decl_stmt|;
comment|/* query the port attributes */
if|if
condition|(
name|__parse_port_info_file
argument_list|(
name|p_vend
argument_list|,
name|idx
argument_list|,
name|port_num
argument_list|,
operator|&
name|sim_port_info
argument_list|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__osm_ca_info_init: ERR 5126: "
literal|"Fail to get HCA:%d Port:%d Attributes.\n"
argument_list|,
name|idx
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* HACK: the lids should have been converted to network but the rest of the code 		   is wrong and provdes them as is (host order) - so we stick with it. */
name|p_ca_info
operator|->
name|p_attr
operator|->
name|p_port_attr
index|[
name|port_num
operator|-
literal|1
index|]
operator|.
name|lid
operator|=
name|sim_port_info
operator|.
name|lid
expr_stmt|;
name|p_ca_info
operator|->
name|p_attr
operator|->
name|p_port_attr
index|[
name|port_num
operator|-
literal|1
index|]
operator|.
name|link_state
operator|=
name|sim_port_info
operator|.
name|state
expr_stmt|;
name|p_ca_info
operator|->
name|p_attr
operator|->
name|p_port_attr
index|[
name|port_num
operator|-
literal|1
index|]
operator|.
name|sm_lid
operator|=
name|sim_port_info
operator|.
name|sm_lid
expr_stmt|;
comment|/* get the port guid */
if|if
condition|(
name|__get_port_guid_from_port_gid_tbl
argument_list|(
name|p_vend
argument_list|,
name|idx
argument_list|,
name|port_num
argument_list|,
operator|&
name|port_guid
argument_list|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"__osm_ca_info_init: ERR 5127: "
literal|"Fail to get HCA:%d Port:%d Guid.\n"
argument_list|,
name|idx
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_ca_info
operator|->
name|p_attr
operator|->
name|p_port_attr
index|[
name|port_num
operator|-
literal|1
index|]
operator|.
name|port_guid
operator|=
name|cl_hton64
argument_list|(
name|port_guid
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|void
name|osm_ca_info_destroy
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|osm_ca_info_t
modifier|*
specifier|const
name|p_ca_info
parameter_list|,
name|IN
name|uint8_t
name|num_ca
parameter_list|)
block|{
name|osm_ca_info_t
modifier|*
name|p_ca
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_ca
condition|;
name|i
operator|++
control|)
block|{
name|p_ca
operator|=
operator|&
name|p_ca_info
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|NULL
operator|!=
name|p_ca
operator|->
name|p_attr
condition|)
block|{
if|if
condition|(
literal|0
operator|!=
name|p_ca
operator|->
name|p_attr
operator|->
name|num_ports
condition|)
block|{
name|free
argument_list|(
name|p_ca
operator|->
name|p_attr
operator|->
name|p_port_attr
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|p_ca
operator|->
name|p_attr
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|p_ca_info
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Fill in the array of port_attr with all available ports on ALL the  * avilable CAs on this machine.  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osm_vendor_get_all_port_attr
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|ib_port_attr_t
modifier|*
specifier|const
name|p_attr_array
parameter_list|,
name|IN
name|uint32_t
modifier|*
specifier|const
name|p_num_ports
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|uint32_t
name|caIdx
decl_stmt|;
name|uint32_t
name|ca_count
init|=
literal|0
decl_stmt|;
name|uint32_t
name|port_count
init|=
literal|0
decl_stmt|;
name|uint8_t
name|port_num
decl_stmt|;
name|uint32_t
name|total_ports
init|=
literal|0
decl_stmt|;
name|osm_ca_info_t
modifier|*
name|p_ca_infos
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|attr_array_sz
init|=
operator|*
name|p_num_ports
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_vend
argument_list|)
expr_stmt|;
comment|/* determine the number of CA's */
name|ca_count
operator|=
name|__hca_sim_get_num_cas
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ca_count
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"osm_vendor_get_all_port_attr: ERR 5128: "
literal|"Fail to get Any CA Ids.\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Allocate an array big enough to hold the ca info objects */
name|p_ca_infos
operator|=
name|malloc
argument_list|(
name|ca_count
operator|*
sizeof|sizeof
argument_list|(
name|osm_ca_info_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_ca_infos
operator|==
name|NULL
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"osm_vendor_get_all_port_attr: ERR 5129: "
literal|"Unable to allocate CA information array.\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|memset
argument_list|(
name|p_ca_infos
argument_list|,
literal|0
argument_list|,
name|ca_count
operator|*
sizeof|sizeof
argument_list|(
name|osm_ca_info_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * For each CA, retrieve the CA info attributes 	 */
for|for
control|(
name|caIdx
operator|=
literal|1
init|;
name|caIdx
operator|<=
name|ca_count
condition|;
name|caIdx
operator|++
control|)
block|{
name|status
operator|=
name|__osm_ca_info_init
argument_list|(
name|p_vend
argument_list|,
name|caIdx
argument_list|,
operator|&
name|p_ca_infos
index|[
name|caIdx
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"osm_vendor_get_all_port_attr: ERR 5130: "
literal|"Unable to initialize CA Info object (%s).\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|total_ports
operator|+=
name|p_ca_infos
index|[
name|caIdx
operator|-
literal|1
index|]
operator|.
name|p_attr
operator|->
name|num_ports
expr_stmt|;
block|}
operator|*
name|p_num_ports
operator|=
name|total_ports
expr_stmt|;
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"osm_vendor_get_all_port_attr: total ports:%u \n"
argument_list|,
name|total_ports
argument_list|)
expr_stmt|;
comment|/* 	 * If the user supplied enough storage, return the port guids, 	 * otherwise, return the appropriate error. 	 */
if|if
condition|(
name|attr_array_sz
operator|>=
name|total_ports
condition|)
block|{
for|for
control|(
name|caIdx
operator|=
literal|1
init|;
name|caIdx
operator|<=
name|ca_count
condition|;
name|caIdx
operator|++
control|)
block|{
name|uint32_t
name|num_ports
decl_stmt|;
name|num_ports
operator|=
name|p_ca_infos
index|[
name|caIdx
operator|-
literal|1
index|]
operator|.
name|p_attr
operator|->
name|num_ports
expr_stmt|;
for|for
control|(
name|port_num
operator|=
literal|0
init|;
name|port_num
operator|<
name|num_ports
condition|;
name|port_num
operator|++
control|)
block|{
name|p_attr_array
index|[
name|port_count
index|]
operator|=
operator|*
name|__osm_ca_info_get_port_attr_ptr
argument_list|(
operator|&
name|p_ca_infos
index|[
name|caIdx
operator|-
literal|1
index|]
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|port_count
operator|++
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|status
operator|=
name|IB_INSUFFICIENT_MEMORY
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
name|Exit
label|:
if|if
condition|(
name|p_ca_infos
condition|)
block|{
name|osm_ca_info_destroy
argument_list|(
name|p_vend
argument_list|,
name|p_ca_infos
argument_list|,
name|ca_count
argument_list|)
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Given the vendor obj and a port guid  * return the ca id and port number that have that guid  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osm_vendor_get_guid_ca_and_port
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|ib_net64_t
specifier|const
name|guid
parameter_list|,
name|OUT
name|uint32_t
modifier|*
name|p_hca_hndl
parameter_list|,
name|OUT
name|char
modifier|*
name|p_hca_id
parameter_list|,
name|OUT
name|uint8_t
modifier|*
name|p_hca_idx
parameter_list|,
name|OUT
name|uint32_t
modifier|*
name|p_port_num
parameter_list|)
block|{
name|uint32_t
name|caIdx
decl_stmt|;
name|uint32_t
name|ca_count
init|=
literal|0
decl_stmt|;
name|uint8_t
name|port_num
decl_stmt|;
name|ib_api_status_t
name|status
init|=
name|IB_ERROR
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_vend
argument_list|)
expr_stmt|;
comment|/* determine the number of CA's */
name|ca_count
operator|=
name|__hca_sim_get_num_cas
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ca_count
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"osm_vendor_get_guid_ca_and_port: ERR 5131: "
literal|"Fail to get Any CA Ids.\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * For each CA, retrieve the CA info attributes 	 */
for|for
control|(
name|caIdx
operator|=
literal|1
init|;
name|caIdx
operator|<=
name|ca_count
condition|;
name|caIdx
operator|++
control|)
block|{
name|sim_ca_info_t
name|sim_ca_info
decl_stmt|;
if|if
condition|(
name|__parse_ca_info_file
argument_list|(
name|p_vend
argument_list|,
name|caIdx
argument_list|,
operator|&
name|sim_ca_info
argument_list|)
operator|==
name|IB_SUCCESS
condition|)
block|{
comment|/* get all the ports info */
for|for
control|(
name|port_num
operator|=
literal|1
init|;
name|port_num
operator|<=
name|sim_ca_info
operator|.
name|num_ports
condition|;
name|port_num
operator|++
control|)
block|{
name|uint64_t
name|port_guid
decl_stmt|;
if|if
condition|(
operator|!
name|__get_port_guid_from_port_gid_tbl
argument_list|(
name|p_vend
argument_list|,
name|caIdx
argument_list|,
name|port_num
argument_list|,
operator|&
name|port_guid
argument_list|)
condition|)
block|{
if|if
condition|(
name|cl_hton64
argument_list|(
name|port_guid
argument_list|)
operator|==
name|guid
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"osm_vendor_get_guid_ca_and_port: "
literal|"Found Matching guid on HCA:%d Port:%d.\n"
argument_list|,
name|caIdx
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|p_hca_id
argument_list|,
name|sim_ca_info
operator|.
name|name
argument_list|)
expr_stmt|;
operator|*
name|p_port_num
operator|=
name|port_num
expr_stmt|;
operator|*
name|p_hca_idx
operator|=
name|caIdx
operator|-
literal|1
expr_stmt|;
operator|*
name|p_hca_hndl
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
block|}
block|}
block|}
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"osm_vendor_get_guid_ca_and_port: ERR 5132: "
literal|"Fail to find HCA and Port for Port Guid 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|guid
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_INVALID_GUID
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Given the vendor obj HCA ID and Port Num  * update the given port guid if found. Return 0 on success.  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osm_vendor_get_guid_by_ca_and_port
parameter_list|(
name|IN
name|osm_vendor_t
modifier|*
specifier|const
name|p_vend
parameter_list|,
name|IN
name|char
modifier|*
name|hca_id
parameter_list|,
name|IN
name|uint32_t
name|port_num
parameter_list|,
name|OUT
name|uint64_t
modifier|*
name|p_port_guid
parameter_list|)
block|{
name|uint32_t
name|caIdx
decl_stmt|;
name|uint32_t
name|ca_count
init|=
literal|0
decl_stmt|;
name|ib_api_status_t
name|status
init|=
name|IB_ERROR
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_vend
argument_list|)
expr_stmt|;
comment|/* determine the number of CA's */
name|ca_count
operator|=
name|__hca_sim_get_num_cas
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ca_count
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"osm_vendor_get_guid_by_ca_and_port: ERR 5133: "
literal|"Fail to get Any CA Ids.\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * For each CA, retrieve the CA info attributes 	 */
for|for
control|(
name|caIdx
operator|=
literal|1
init|;
name|caIdx
operator|<=
name|ca_count
condition|;
name|caIdx
operator|++
control|)
block|{
name|sim_ca_info_t
name|sim_ca_info
decl_stmt|;
if|if
condition|(
name|__parse_ca_info_file
argument_list|(
name|p_vend
argument_list|,
name|caIdx
argument_list|,
operator|&
name|sim_ca_info
argument_list|)
operator|==
name|IB_SUCCESS
condition|)
block|{
comment|/* if not identical by id - go to next one */
if|if
condition|(
name|strcmp
argument_list|(
name|sim_ca_info
operator|.
name|name
argument_list|,
name|hca_id
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|port_num
operator|<
literal|1
operator|)
operator|||
operator|(
name|port_num
operator|>
name|sim_ca_info
operator|.
name|num_ports
operator|)
condition|)
block|{
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|__get_port_guid_from_port_gid_tbl
argument_list|(
name|p_vend
argument_list|,
name|caIdx
argument_list|,
name|port_num
argument_list|,
name|p_port_guid
argument_list|)
condition|)
block|{
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"osm_vendor_get_guid_by_ca_and_port: "
literal|"Found Matching guid on HCA:%d Port:%d.\n"
argument_list|,
name|caIdx
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
block|}
name|osm_log
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"osm_vendor_get_guid_by_ca_and_port: ERR 5134: "
literal|"Fail to find HCA:%s\n"
argument_list|,
name|hca_id
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_INVALID_GUID
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_vend
operator|->
name|p_log
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


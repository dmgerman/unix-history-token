begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009 Sun Microsystems, Inc. All rights reserved.  * Copyright (c) 2004-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2015 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Various OpenSM dumpers  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<iba/ib_types.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_qmap.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_file_ids.h>
end_include

begin_define
define|#
directive|define
name|FILE_ID
value|OSM_FILE_DUMP_C
end_define

begin_include
include|#
directive|include
file|<opensm/osm_opensm.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_log.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_node.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_switch.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_helper.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_msgdef.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_opensm.h>
end_include

begin_function
specifier|static
name|void
name|dump_ucast_path_distribution
parameter_list|(
name|cl_map_item_t
modifier|*
name|item
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|osm_node_t
modifier|*
name|p_node
decl_stmt|;
name|osm_node_t
modifier|*
name|p_remote_node
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|uint8_t
name|num_ports
decl_stmt|;
name|uint32_t
name|num_paths
decl_stmt|;
name|ib_net64_t
name|remote_guid_ho
decl_stmt|;
name|osm_switch_t
modifier|*
name|p_sw
init|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|item
decl_stmt|;
name|p_node
operator|=
name|p_sw
operator|->
name|p_node
expr_stmt|;
name|num_ports
operator|=
name|p_sw
operator|->
name|num_ports
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"dump_ucast_path_distribution: Switch 0x%"
name|PRIx64
literal|"\n"
literal|"Port : Path Count Through Port"
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_node_get_node_guid
argument_list|(
name|p_node
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|num_paths
operator|=
name|osm_switch_path_count_get
argument_list|(
name|p_sw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\n %03u : %u"
argument_list|,
name|i
argument_list|,
name|num_paths
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" (switch management port)"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|p_remote_node
operator|=
name|osm_node_get_remote_node
argument_list|(
name|p_node
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_remote_node
operator|==
name|NULL
condition|)
continue|continue;
name|remote_guid_ho
operator|=
name|cl_ntoh64
argument_list|(
name|osm_node_get_node_guid
argument_list|(
name|p_remote_node
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|osm_node_get_type
argument_list|(
name|p_remote_node
argument_list|)
condition|)
block|{
case|case
name|IB_NODE_TYPE_SWITCH
case|:
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" (link to switch"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_NODE_TYPE_ROUTER
case|:
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" (link to router"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_NODE_TYPE_CA
case|:
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" (link to CA"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" (link to unknown node type"
argument_list|)
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" 0x%"
name|PRIx64
literal|")"
argument_list|,
name|remote_guid_ho
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_ucast_routes
parameter_list|(
name|cl_map_item_t
modifier|*
name|item
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
specifier|const
name|osm_node_t
modifier|*
name|p_node
decl_stmt|;
name|osm_port_t
modifier|*
name|p_port
decl_stmt|;
name|uint8_t
name|port_num
decl_stmt|;
name|uint8_t
name|num_hops
decl_stmt|;
name|uint8_t
name|best_hops
decl_stmt|;
name|uint8_t
name|best_port
decl_stmt|;
name|uint16_t
name|max_lid_ho
decl_stmt|;
name|uint16_t
name|lid_ho
decl_stmt|,
name|base_lid
decl_stmt|;
name|boolean_t
name|direct_route_exists
init|=
name|FALSE
decl_stmt|;
name|boolean_t
name|dor
decl_stmt|;
name|osm_switch_t
modifier|*
name|p_sw
init|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|item
decl_stmt|;
name|osm_opensm_t
modifier|*
name|p_osm
init|=
name|cxt
decl_stmt|;
name|p_node
operator|=
name|p_sw
operator|->
name|p_node
expr_stmt|;
name|max_lid_ho
operator|=
name|p_sw
operator|->
name|max_lid_ho
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"dump_ucast_routes: "
literal|"Switch 0x%016"
name|PRIx64
literal|"\nLID    : Port : Hops : Optimal\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_node_get_node_guid
argument_list|(
name|p_node
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|dor
operator|=
operator|(
name|p_osm
operator|->
name|routing_engine_used
operator|&&
name|p_osm
operator|->
name|routing_engine_used
operator|->
name|type
operator|==
name|OSM_ROUTING_ENGINE_TYPE_DOR
operator|)
expr_stmt|;
for|for
control|(
name|lid_ho
operator|=
literal|1
init|;
name|lid_ho
operator|<=
name|max_lid_ho
condition|;
name|lid_ho
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"0x%04X : "
argument_list|,
name|lid_ho
argument_list|)
expr_stmt|;
name|p_port
operator|=
name|osm_get_port_by_lid_ho
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
name|lid_ho
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_port
condition|)
block|{
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"UNREACHABLE\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|port_num
operator|=
name|osm_switch_get_port_by_lid
argument_list|(
name|p_sw
argument_list|,
name|lid_ho
argument_list|,
name|OSM_NEW_LFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_num
operator|==
name|OSM_NO_PATH
condition|)
block|{
comment|/* 			   This may occur if there are 'holes' in the existing 			   LID assignments.  Running SM with --reassign_lids 			   will reassign and compress the LID range.  The 			   subnet should work fine either way. 			 */
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"UNREACHABLE\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		   Switches can lie about which port routes a given 		   lid due to a recent reconfiguration of the subnet. 		   Therefore, ensure that the hop count is better than 		   OSM_NO_PATH. 		 */
if|if
condition|(
name|p_port
operator|->
name|p_node
operator|->
name|sw
condition|)
block|{
comment|/* Target LID is switch. 			   Get its base lid and check hop count for this base LID only. */
name|base_lid
operator|=
name|osm_node_get_base_lid
argument_list|(
name|p_port
operator|->
name|p_node
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|base_lid
operator|=
name|cl_ntoh16
argument_list|(
name|base_lid
argument_list|)
expr_stmt|;
name|num_hops
operator|=
name|osm_switch_get_hop_count
argument_list|(
name|p_sw
argument_list|,
name|base_lid
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Target LID is not switch (CA or router). 			   Check if we have route to this target from current switch. */
name|num_hops
operator|=
name|osm_switch_get_hop_count
argument_list|(
name|p_sw
argument_list|,
name|lid_ho
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_hops
operator|!=
name|OSM_NO_PATH
condition|)
block|{
name|direct_route_exists
operator|=
name|TRUE
expr_stmt|;
name|base_lid
operator|=
name|lid_ho
expr_stmt|;
block|}
else|else
block|{
name|osm_physp_t
modifier|*
name|p_physp
init|=
name|p_port
operator|->
name|p_physp
decl_stmt|;
if|if
condition|(
operator|!
name|p_physp
operator|||
operator|!
name|p_physp
operator|->
name|p_remote_physp
operator|||
operator|!
name|p_physp
operator|->
name|p_remote_physp
operator|->
name|p_node
operator|->
name|sw
condition|)
name|num_hops
operator|=
name|OSM_NO_PATH
expr_stmt|;
else|else
block|{
name|base_lid
operator|=
name|osm_node_get_base_lid
argument_list|(
name|p_physp
operator|->
name|p_remote_physp
operator|->
name|p_node
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|base_lid
operator|=
name|cl_ntoh16
argument_list|(
name|base_lid
argument_list|)
expr_stmt|;
name|num_hops
operator|=
name|p_physp
operator|->
name|p_remote_physp
operator|->
name|p_node
operator|->
name|sw
operator|==
name|p_sw
condition|?
literal|0
else|:
name|osm_switch_get_hop_count
argument_list|(
name|p_sw
argument_list|,
name|base_lid
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|num_hops
operator|==
name|OSM_NO_PATH
condition|)
block|{
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%03u  : HOPS UNKNOWN\n"
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|best_hops
operator|=
name|osm_switch_get_least_hops
argument_list|(
name|p_sw
argument_list|,
name|base_lid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_port
operator|->
name|p_node
operator|->
name|sw
operator|&&
operator|!
name|direct_route_exists
condition|)
block|{
name|best_hops
operator|++
expr_stmt|;
name|num_hops
operator|++
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%03u  : %02u   : "
argument_list|,
name|port_num
argument_list|,
name|num_hops
argument_list|)
expr_stmt|;
if|if
condition|(
name|best_hops
operator|==
name|num_hops
condition|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* No LMC Optimization */
name|best_port
operator|=
name|osm_switch_recommend_path
argument_list|(
name|p_sw
argument_list|,
name|p_port
argument_list|,
name|lid_ho
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|dor
argument_list|,
name|p_osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|port_shifting
argument_list|,
name|p_osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|scatter_ports
argument_list|,
name|OSM_NEW_LFT
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"No %u hop path possible via port %u!"
argument_list|,
name|best_hops
argument_list|,
name|best_port
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_mcast_routes
parameter_list|(
name|cl_map_item_t
modifier|*
name|item
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|osm_switch_t
modifier|*
name|p_sw
init|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|item
decl_stmt|;
name|osm_mcast_tbl_t
modifier|*
name|p_tbl
decl_stmt|;
name|int16_t
name|mlid_ho
init|=
literal|0
decl_stmt|;
name|int16_t
name|mlid_start_ho
decl_stmt|;
name|uint8_t
name|position
init|=
literal|0
decl_stmt|;
name|int16_t
name|block_num
init|=
literal|0
decl_stmt|;
name|boolean_t
name|first_mlid
decl_stmt|;
name|boolean_t
name|first_port
decl_stmt|;
specifier|const
name|osm_node_t
modifier|*
name|p_node
decl_stmt|;
name|uint16_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|uint16_t
name|mask_entry
decl_stmt|;
name|char
name|sw_hdr
index|[
literal|256
index|]
decl_stmt|;
name|char
name|mlid_hdr
index|[
literal|32
index|]
decl_stmt|;
name|p_node
operator|=
name|p_sw
operator|->
name|p_node
expr_stmt|;
name|p_tbl
operator|=
name|osm_switch_get_mcast_tbl_ptr
argument_list|(
name|p_sw
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|sw_hdr
argument_list|,
literal|"\nSwitch 0x%016"
name|PRIx64
literal|"\nLID    : Out Port(s)\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_node_get_node_guid
argument_list|(
name|p_node
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|first_mlid
operator|=
name|TRUE
expr_stmt|;
while|while
condition|(
name|block_num
operator|<=
name|p_tbl
operator|->
name|max_block_in_use
condition|)
block|{
name|mlid_start_ho
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|block_num
operator|*
name|IB_MCAST_BLOCK_SIZE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IB_MCAST_BLOCK_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|mlid_ho
operator|=
name|mlid_start_ho
operator|+
name|i
expr_stmt|;
name|position
operator|=
literal|0
expr_stmt|;
name|first_port
operator|=
name|TRUE
expr_stmt|;
name|sprintf
argument_list|(
name|mlid_hdr
argument_list|,
literal|"0x%04X :"
argument_list|,
name|mlid_ho
operator|+
name|IB_LID_MCAST_START_HO
argument_list|)
expr_stmt|;
while|while
condition|(
name|position
operator|<=
name|p_tbl
operator|->
name|max_position
condition|)
block|{
name|mask_entry
operator|=
name|cl_ntoh16
argument_list|(
operator|(
operator|*
name|p_tbl
operator|->
name|p_mask_tbl
operator|)
index|[
name|mlid_ho
index|]
index|[
name|position
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask_entry
operator|==
literal|0
condition|)
block|{
name|position
operator|++
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|(
literal|1
operator|<<
name|j
operator|)
operator|&
name|mask_entry
condition|)
block|{
if|if
condition|(
name|first_mlid
condition|)
block|{
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%s"
argument_list|,
name|sw_hdr
argument_list|)
expr_stmt|;
name|first_mlid
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|first_port
condition|)
block|{
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%s"
argument_list|,
name|mlid_hdr
argument_list|)
expr_stmt|;
name|first_port
operator|=
name|FALSE
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" 0x%03X "
argument_list|,
name|j
operator|+
operator|(
name|position
operator|*
literal|16
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|position
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|first_port
operator|==
name|FALSE
condition|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|block_num
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_lid_matrix
parameter_list|(
name|cl_map_item_t
modifier|*
name|item
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|osm_switch_t
modifier|*
name|p_sw
init|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|item
decl_stmt|;
name|osm_opensm_t
modifier|*
name|p_osm
init|=
name|cxt
decl_stmt|;
name|osm_node_t
modifier|*
name|p_node
init|=
name|p_sw
operator|->
name|p_node
decl_stmt|;
name|unsigned
name|max_lid
init|=
name|p_sw
operator|->
name|max_lid_ho
decl_stmt|;
name|unsigned
name|max_port
init|=
name|p_sw
operator|->
name|num_ports
decl_stmt|;
name|uint16_t
name|lid
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"Switch: guid 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_node_get_node_guid
argument_list|(
name|p_node
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|lid
operator|=
literal|1
init|;
name|lid
operator|<=
name|max_lid
condition|;
name|lid
operator|++
control|)
block|{
name|osm_port_t
modifier|*
name|p_port
decl_stmt|;
if|if
condition|(
name|osm_switch_get_least_hops
argument_list|(
name|p_sw
argument_list|,
name|lid
argument_list|)
operator|==
name|OSM_NO_PATH
condition|)
continue|continue;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"0x%04x:"
argument_list|,
name|lid
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|max_port
condition|;
name|port
operator|++
control|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" %02x"
argument_list|,
name|osm_switch_get_hop_count
argument_list|(
name|p_sw
argument_list|,
name|lid
argument_list|,
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|p_port
operator|=
name|osm_get_port_by_lid_ho
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
name|lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_port
condition|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" # portguid 0x%016"
name|PRIx64
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_port_get_guid
argument_list|(
name|p_port
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_ucast_lfts
parameter_list|(
name|cl_map_item_t
modifier|*
name|item
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|osm_switch_t
modifier|*
name|p_sw
init|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|item
decl_stmt|;
name|osm_opensm_t
modifier|*
name|p_osm
init|=
name|cxt
decl_stmt|;
name|osm_node_t
modifier|*
name|p_node
init|=
name|p_sw
operator|->
name|p_node
decl_stmt|;
name|unsigned
name|max_lid
init|=
name|p_sw
operator|->
name|max_lid_ho
decl_stmt|;
name|unsigned
name|max_port
init|=
name|p_sw
operator|->
name|num_ports
decl_stmt|;
name|uint16_t
name|lid
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"Unicast lids [0-%u] of switch Lid %u guid 0x%016"
name|PRIx64
literal|" (\'%s\'):\n"
argument_list|,
name|max_lid
argument_list|,
name|cl_ntoh16
argument_list|(
name|osm_node_get_base_lid
argument_list|(
name|p_node
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_node_get_node_guid
argument_list|(
name|p_node
argument_list|)
argument_list|)
argument_list|,
name|p_node
operator|->
name|print_desc
argument_list|)
expr_stmt|;
for|for
control|(
name|lid
operator|=
literal|0
init|;
name|lid
operator|<=
name|max_lid
condition|;
name|lid
operator|++
control|)
block|{
name|osm_port_t
modifier|*
name|p_port
decl_stmt|;
name|port
operator|=
name|osm_switch_get_port_by_lid
argument_list|(
name|p_sw
argument_list|,
name|lid
argument_list|,
name|OSM_NEW_LFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|>=
name|max_port
condition|)
continue|continue;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"0x%04x %03u # "
argument_list|,
name|lid
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|p_port
operator|=
name|osm_get_port_by_lid_ho
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
name|lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_port
condition|)
block|{
name|p_node
operator|=
name|p_port
operator|->
name|p_node
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%s portguid 0x%016"
name|PRIx64
literal|": \'%s\'"
argument_list|,
name|ib_get_node_type_str
argument_list|(
name|osm_node_get_type
argument_list|(
name|p_node
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_port_get_guid
argument_list|(
name|p_port
argument_list|)
argument_list|)
argument_list|,
name|p_node
operator|->
name|print_desc
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"unknown node and type"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%u lids dumped\n"
argument_list|,
name|max_lid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_topology_node
parameter_list|(
name|cl_map_item_t
modifier|*
name|item
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|osm_node_t
modifier|*
name|p_node
init|=
operator|(
name|osm_node_t
operator|*
operator|)
name|item
decl_stmt|;
name|uint32_t
name|cPort
decl_stmt|;
name|osm_node_t
modifier|*
name|p_nbnode
decl_stmt|;
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|,
modifier|*
name|p_default_physp
decl_stmt|,
modifier|*
name|p_rphysp
decl_stmt|;
name|uint8_t
name|link_speed_act
decl_stmt|;
specifier|const
name|char
modifier|*
name|link_speed_act_str
decl_stmt|,
modifier|*
name|link_width_act_str
decl_stmt|;
if|if
condition|(
operator|!
name|p_node
operator|->
name|node_info
operator|.
name|num_ports
condition|)
return|return;
for|for
control|(
name|cPort
operator|=
literal|1
init|;
name|cPort
operator|<
name|osm_node_get_num_physp
argument_list|(
name|p_node
argument_list|)
condition|;
name|cPort
operator|++
control|)
block|{
name|uint8_t
name|port_state
decl_stmt|;
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|cPort
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_physp
condition|)
continue|continue;
name|p_rphysp
operator|=
name|p_physp
operator|->
name|p_remote_physp
expr_stmt|;
if|if
condition|(
operator|!
name|p_rphysp
condition|)
continue|continue;
name|CL_ASSERT
argument_list|(
name|cPort
operator|==
name|p_physp
operator|->
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_node
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_SWITCH
condition|)
name|p_default_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|p_default_physp
operator|=
name|p_physp
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"{ %s%s Ports:%02X SystemGUID:%016"
name|PRIx64
literal|" NodeGUID:%016"
name|PRIx64
literal|" PortGUID:%016"
name|PRIx64
literal|" VenID:%06X DevID:%04X Rev:%08X {%s} LID:%04X PN:%02X } "
argument_list|,
name|p_node
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_SWITCH
condition|?
literal|"SW"
else|:
name|p_node
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_CA
condition|?
literal|"CA"
else|:
name|p_node
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_ROUTER
condition|?
literal|"Rt"
else|:
literal|"**"
argument_list|,
name|p_default_physp
operator|->
name|port_info
operator|.
name|base_lid
operator|==
name|p_default_physp
operator|->
name|port_info
operator|.
name|master_sm_base_lid
condition|?
literal|"-SM"
else|:
literal|""
argument_list|,
name|p_node
operator|->
name|node_info
operator|.
name|num_ports
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|node_info
operator|.
name|sys_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_node
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_physp
operator|->
name|port_guid
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_node_info_get_vendor_id
argument_list|(
operator|&
name|p_node
operator|->
name|node_info
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_node
operator|->
name|node_info
operator|.
name|device_id
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_node
operator|->
name|node_info
operator|.
name|revision
argument_list|)
argument_list|,
name|p_node
operator|->
name|print_desc
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_default_physp
operator|->
name|port_info
operator|.
name|base_lid
argument_list|)
argument_list|,
name|cPort
argument_list|)
expr_stmt|;
name|p_nbnode
operator|=
name|p_rphysp
operator|->
name|p_node
expr_stmt|;
if|if
condition|(
name|p_nbnode
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_SWITCH
condition|)
name|p_default_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_nbnode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|p_default_physp
operator|=
name|p_rphysp
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"{ %s%s Ports:%02X SystemGUID:%016"
name|PRIx64
literal|" NodeGUID:%016"
name|PRIx64
literal|" PortGUID:%016"
name|PRIx64
literal|" VenID:%08X DevID:%04X Rev:%08X {%s} LID:%04X PN:%02X } "
argument_list|,
name|p_nbnode
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_SWITCH
condition|?
literal|"SW"
else|:
name|p_nbnode
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_CA
condition|?
literal|"CA"
else|:
name|p_nbnode
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_ROUTER
condition|?
literal|"Rt"
else|:
literal|"**"
argument_list|,
name|p_default_physp
operator|->
name|port_info
operator|.
name|base_lid
operator|==
name|p_default_physp
operator|->
name|port_info
operator|.
name|master_sm_base_lid
condition|?
literal|"-SM"
else|:
literal|""
argument_list|,
name|p_nbnode
operator|->
name|node_info
operator|.
name|num_ports
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_nbnode
operator|->
name|node_info
operator|.
name|sys_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_nbnode
operator|->
name|node_info
operator|.
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rphysp
operator|->
name|port_guid
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_node_info_get_vendor_id
argument_list|(
operator|&
name|p_nbnode
operator|->
name|node_info
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_nbnode
operator|->
name|node_info
operator|.
name|device_id
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_nbnode
operator|->
name|node_info
operator|.
name|revision
argument_list|)
argument_list|,
name|p_nbnode
operator|->
name|print_desc
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_default_physp
operator|->
name|port_info
operator|.
name|base_lid
argument_list|)
argument_list|,
name|p_rphysp
operator|->
name|port_num
argument_list|)
expr_stmt|;
name|port_state
operator|=
name|ib_port_info_get_port_state
argument_list|(
operator|&
name|p_physp
operator|->
name|port_info
argument_list|)
expr_stmt|;
name|link_speed_act
operator|=
name|ib_port_info_get_link_speed_active
argument_list|(
operator|&
name|p_physp
operator|->
name|port_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|link_speed_act
operator|==
name|IB_LINK_SPEED_ACTIVE_2_5
condition|)
name|link_speed_act_str
operator|=
literal|"2.5"
expr_stmt|;
elseif|else
if|if
condition|(
name|link_speed_act
operator|==
name|IB_LINK_SPEED_ACTIVE_5
condition|)
name|link_speed_act_str
operator|=
literal|"5"
expr_stmt|;
elseif|else
if|if
condition|(
name|link_speed_act
operator|==
name|IB_LINK_SPEED_ACTIVE_10
condition|)
name|link_speed_act_str
operator|=
literal|"10"
expr_stmt|;
else|else
name|link_speed_act_str
operator|=
literal|"??"
expr_stmt|;
if|if
condition|(
name|p_physp
operator|->
name|ext_port_info
operator|.
name|link_speed_active
operator|&
name|FDR10
condition|)
name|link_speed_act_str
operator|=
literal|"FDR10"
expr_stmt|;
if|if
condition|(
name|p_default_physp
operator|->
name|port_info
operator|.
name|capability_mask
operator|&
name|IB_PORT_CAP_HAS_EXT_SPEEDS
condition|)
block|{
name|link_speed_act
operator|=
name|ib_port_info_get_link_speed_ext_active
argument_list|(
operator|&
name|p_physp
operator|->
name|port_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|link_speed_act
operator|==
name|IB_LINK_SPEED_EXT_ACTIVE_14
condition|)
name|link_speed_act_str
operator|=
literal|"14"
expr_stmt|;
elseif|else
if|if
condition|(
name|link_speed_act
operator|==
name|IB_LINK_SPEED_EXT_ACTIVE_25
condition|)
name|link_speed_act_str
operator|=
literal|"25"
expr_stmt|;
elseif|else
if|if
condition|(
name|link_speed_act
operator|!=
name|IB_LINK_SPEED_EXT_ACTIVE_NONE
condition|)
name|link_speed_act_str
operator|=
literal|"??"
expr_stmt|;
block|}
if|if
condition|(
name|p_physp
operator|->
name|port_info
operator|.
name|link_width_active
operator|==
literal|1
condition|)
name|link_width_act_str
operator|=
literal|"1x"
expr_stmt|;
elseif|else
if|if
condition|(
name|p_physp
operator|->
name|port_info
operator|.
name|link_width_active
operator|==
literal|2
condition|)
name|link_width_act_str
operator|=
literal|"4x"
expr_stmt|;
elseif|else
if|if
condition|(
name|p_physp
operator|->
name|port_info
operator|.
name|link_width_active
operator|==
literal|4
condition|)
name|link_width_act_str
operator|=
literal|"8x"
expr_stmt|;
elseif|else
if|if
condition|(
name|p_physp
operator|->
name|port_info
operator|.
name|link_width_active
operator|==
literal|8
condition|)
name|link_width_act_str
operator|=
literal|"12x"
expr_stmt|;
else|else
name|link_width_act_str
operator|=
literal|"??"
expr_stmt|;
if|if
condition|(
name|p_default_physp
operator|->
name|port_info
operator|.
name|capability_mask2
operator|&
name|IB_PORT_CAP2_IS_LINK_WIDTH_2X_SUPPORTED
condition|)
block|{
if|if
condition|(
name|p_physp
operator|->
name|port_info
operator|.
name|link_width_active
operator|==
literal|16
condition|)
name|link_width_act_str
operator|=
literal|"2x"
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"PHY=%s LOG=%s SPD=%s\n"
argument_list|,
name|link_width_act_str
argument_list|,
name|port_state
operator|==
name|IB_LINK_ACTIVE
condition|?
literal|"ACT"
else|:
name|port_state
operator|==
name|IB_LINK_ARMED
condition|?
literal|"ARM"
else|:
name|port_state
operator|==
name|IB_LINK_INIT
condition|?
literal|"INI"
else|:
literal|"DWN"
argument_list|,
name|link_speed_act_str
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_sl2vl_tbl
parameter_list|(
name|cl_map_item_t
modifier|*
name|item
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|osm_port_t
modifier|*
name|p_port
init|=
operator|(
name|osm_port_t
operator|*
operator|)
name|item
decl_stmt|;
name|osm_node_t
modifier|*
name|p_node
init|=
name|p_port
operator|->
name|p_node
decl_stmt|;
name|uint32_t
name|in_port
decl_stmt|,
name|out_port
decl_stmt|,
name|num_ports
init|=
name|p_node
operator|->
name|node_info
operator|.
name|num_ports
decl_stmt|;
name|ib_net16_t
name|base_lid
init|=
name|osm_port_get_base_lid
argument_list|(
name|p_port
argument_list|)
decl_stmt|;
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|;
name|ib_slvl_table_t
modifier|*
name|p_tbl
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|header_line
init|=
literal|"#in out : 0  1  2  3  4  5  6  7  8  9  10 11 12 13 14 15"
decl_stmt|;
specifier|const
name|char
modifier|*
name|separator_line
init|=
literal|"#--------------------------------------------------------"
decl_stmt|;
if|if
condition|(
operator|!
name|num_ports
condition|)
return|return;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%s 0x%016"
name|PRIx64
literal|", base LID %d, "
literal|"\"%s\"\n%s\n%s\n"
argument_list|,
name|ib_get_node_type_str
argument_list|(
name|p_node
operator|->
name|node_info
operator|.
name|node_type
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_port
operator|->
name|guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|base_lid
argument_list|)
argument_list|,
name|p_node
operator|->
name|print_desc
argument_list|,
name|header_line
argument_list|,
name|separator_line
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_node
operator|->
name|node_info
operator|.
name|node_type
operator|==
name|IB_NODE_TYPE_SWITCH
condition|)
block|{
for|for
control|(
name|out_port
operator|=
literal|0
init|;
name|out_port
operator|<=
name|num_ports
condition|;
name|out_port
operator|++
control|)
block|{
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|out_port
argument_list|)
expr_stmt|;
comment|/* no need to print SL2VL table for port that is down */
if|if
condition|(
operator|!
name|p_physp
operator|||
operator|!
name|p_physp
operator|->
name|p_remote_physp
condition|)
continue|continue;
for|for
control|(
name|in_port
operator|=
literal|0
init|;
name|in_port
operator|<=
name|num_ports
condition|;
name|in_port
operator|++
control|)
block|{
name|p_tbl
operator|=
name|osm_physp_get_slvl_tbl
argument_list|(
name|p_physp
argument_list|,
name|in_port
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|n
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|n
operator|+=
name|sprintf
argument_list|(
name|buf
operator|+
name|n
argument_list|,
literal|" %-2d"
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|p_tbl
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%-3d %-3d :%s\n"
argument_list|,
name|in_port
argument_list|,
name|out_port
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|p_physp
operator|=
name|p_port
operator|->
name|p_physp
expr_stmt|;
name|p_tbl
operator|=
name|osm_physp_get_slvl_tbl
argument_list|(
name|p_physp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|n
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|n
operator|+=
name|sprintf
argument_list|(
name|buf
operator|+
name|n
argument_list|,
literal|" %-2d"
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|p_tbl
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%-3d %-3d :%s\n"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%s\n\n"
argument_list|,
name|separator_line
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_node_report
parameter_list|(
name|cl_map_item_t
modifier|*
name|item
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|osm_node_t
modifier|*
name|p_node
init|=
operator|(
name|osm_node_t
operator|*
operator|)
name|item
decl_stmt|;
name|osm_opensm_t
modifier|*
name|osm
init|=
name|cxt
decl_stmt|;
specifier|const
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|,
modifier|*
name|p_remote_physp
decl_stmt|;
specifier|const
name|ib_port_info_t
modifier|*
name|p_pi
decl_stmt|;
name|uint8_t
name|port_num
decl_stmt|;
name|uint32_t
name|num_ports
decl_stmt|;
name|uint8_t
name|node_type
decl_stmt|;
name|node_type
operator|=
name|osm_node_get_type
argument_list|(
name|p_node
argument_list|)
expr_stmt|;
name|num_ports
operator|=
name|osm_node_get_num_physp
argument_list|(
name|p_node
argument_list|)
expr_stmt|;
name|port_num
operator|=
name|node_type
operator|==
name|IB_NODE_TYPE_SWITCH
condition|?
literal|0
else|:
literal|1
expr_stmt|;
for|for
control|(
init|;
name|port_num
operator|<
name|num_ports
condition|;
name|port_num
operator|++
control|)
block|{
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_physp
condition|)
continue|continue;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"%-11s : %s : %02X :"
argument_list|,
name|osm_get_manufacturer_str
argument_list|(
name|cl_ntoh64
argument_list|(
name|osm_node_get_node_guid
argument_list|(
name|p_node
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|osm_get_node_type_str_fixed_width
argument_list|(
name|node_type
argument_list|)
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|p_pi
operator|=
operator|&
name|p_physp
operator|->
name|port_info
expr_stmt|;
comment|/* 		 * Port state is not defined for base switch port 0 		 */
if|if
condition|(
name|port_num
operator|==
literal|0
operator|&&
name|ib_switch_info_is_enhanced_port0
argument_list|(
operator|&
name|p_node
operator|->
name|sw
operator|->
name|switch_info
argument_list|)
operator|==
name|FALSE
condition|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"     :"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" %s :"
argument_list|,
name|osm_get_port_state_str_fixed_width
argument_list|(
name|ib_port_info_get_port_state
argument_list|(
name|p_pi
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * LID values are only meaningful in select cases. 		 */
if|if
condition|(
name|ib_port_info_get_port_state
argument_list|(
name|p_pi
argument_list|)
operator|!=
name|IB_LINK_DOWN
operator|&&
operator|(
operator|(
name|node_type
operator|==
name|IB_NODE_TYPE_SWITCH
operator|&&
name|port_num
operator|==
literal|0
operator|)
operator|||
name|node_type
operator|!=
name|IB_NODE_TYPE_SWITCH
operator|)
condition|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" %04X :  %01X  :"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pi
operator|->
name|base_lid
argument_list|)
argument_list|,
name|ib_port_info_get_lmc
argument_list|(
name|p_pi
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"      :     :"
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_num
operator|==
literal|0
operator|&&
name|ib_switch_info_is_enhanced_port0
argument_list|(
operator|&
name|p_node
operator|->
name|sw
operator|->
name|switch_info
argument_list|)
operator|==
name|FALSE
condition|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"      :     :      "
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" %s : %s : %s "
argument_list|,
name|osm_get_mtu_str
argument_list|(
name|ib_port_info_get_neighbor_mtu
argument_list|(
name|p_pi
argument_list|)
argument_list|)
argument_list|,
name|osm_get_lwa_str
argument_list|(
name|p_pi
operator|->
name|link_width_active
argument_list|)
argument_list|,
name|osm_get_lsa_str
argument_list|(
name|ib_port_info_get_link_speed_active
argument_list|(
name|p_pi
argument_list|)
argument_list|,
name|ib_port_info_get_link_speed_ext_active
argument_list|(
name|p_pi
argument_list|)
argument_list|,
name|ib_port_info_get_port_state
argument_list|(
name|p_pi
argument_list|)
argument_list|,
name|p_physp
operator|->
name|ext_port_info
operator|.
name|link_speed_active
operator|&
name|FDR10
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|osm_physp_get_port_guid
argument_list|(
name|p_physp
argument_list|)
operator|==
name|osm
operator|->
name|subn
operator|.
name|sm_port_guid
condition|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"* %016"
name|PRIx64
literal|" *"
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_physp_get_port_guid
argument_list|(
name|p_physp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|file
argument_list|,
literal|": %016"
name|PRIx64
literal|" :"
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_physp_get_port_guid
argument_list|(
name|p_physp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_num
operator|&&
operator|(
name|ib_port_info_get_port_state
argument_list|(
name|p_pi
argument_list|)
operator|!=
name|IB_LINK_DOWN
operator|)
condition|)
block|{
name|p_remote_physp
operator|=
name|osm_physp_get_remote
argument_list|(
name|p_physp
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_remote_physp
condition|)
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" %016"
name|PRIx64
literal|" (%02X)"
argument_list|,
name|cl_ntoh64
argument_list|(
name|osm_physp_get_port_guid
argument_list|(
name|p_remote_physp
argument_list|)
argument_list|)
argument_list|,
name|osm_physp_get_port_num
argument_list|(
name|p_remote_physp
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|file
argument_list|,
literal|" UNKNOWN"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"------------------------------------------------------"
literal|"------------------------------------------------\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|dump_context
block|{
name|osm_opensm_t
modifier|*
name|p_osm
decl_stmt|;
name|FILE
modifier|*
name|file
decl_stmt|;
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|cl_map_item_t
modifier|*
parameter_list|,
name|FILE
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
name|void
modifier|*
name|cxt
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|dump_item
parameter_list|(
name|cl_map_item_t
modifier|*
name|item
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
operator|(
operator|(
expr|struct
name|dump_context
operator|*
operator|)
name|cxt
operator|)
operator|->
name|func
argument_list|(
name|item
argument_list|,
operator|(
operator|(
expr|struct
name|dump_context
operator|*
operator|)
name|cxt
operator|)
operator|->
name|file
argument_list|,
operator|(
operator|(
expr|struct
name|dump_context
operator|*
operator|)
name|cxt
operator|)
operator|->
name|cxt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_qmap
parameter_list|(
name|FILE
modifier|*
name|file
parameter_list|,
name|cl_qmap_t
modifier|*
name|map
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|cl_map_item_t
modifier|*
parameter_list|,
name|FILE
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|struct
name|dump_context
name|dump_context
decl_stmt|;
name|dump_context
operator|.
name|file
operator|=
name|file
expr_stmt|;
name|dump_context
operator|.
name|func
operator|=
name|func
expr_stmt|;
name|dump_context
operator|.
name|cxt
operator|=
name|cxt
expr_stmt|;
name|cl_qmap_apply_func
argument_list|(
name|map
argument_list|,
name|dump_item
argument_list|,
operator|&
name|dump_context
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_dump_qmap_to_file
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
specifier|const
name|char
modifier|*
name|file_name
parameter_list|,
name|cl_qmap_t
modifier|*
name|map
parameter_list|,
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|cl_map_item_t
modifier|*
parameter_list|,
name|FILE
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|char
name|path
index|[
literal|1024
index|]
decl_stmt|;
name|FILE
modifier|*
name|file
decl_stmt|;
name|snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|p_osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|dump_files_dir
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
name|file
operator|=
name|fopen
argument_list|(
name|path
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|file
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"cannot create file \'%s\': %s\n"
argument_list|,
name|path
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|dump_qmap
argument_list|(
name|file
argument_list|,
name|map
argument_list|,
name|func
argument_list|,
name|cxt
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_report
parameter_list|(
name|osm_opensm_t
modifier|*
name|osm
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|)
block|{
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\n==================================================="
literal|"====================================================\n"
literal|"Vendor      : Ty : #  : Sta : LID  : LMC : MTU  : LWA :"
literal|" LSA  : Port GUID        : Neighbor Port (Port #)\n"
argument_list|)
expr_stmt|;
name|dump_qmap
argument_list|(
name|stdout
argument_list|,
operator|&
name|osm
operator|->
name|subn
operator|.
name|node_guid_tbl
argument_list|,
name|print_node_report
argument_list|,
name|osm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_dump_mcast_routes
parameter_list|(
name|osm_opensm_t
modifier|*
name|osm
parameter_list|)
block|{
if|if
condition|(
name|OSM_LOG_IS_ACTIVE_V2
argument_list|(
operator|&
name|osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ROUTING
argument_list|)
condition|)
comment|/* multicast routes */
name|osm_dump_qmap_to_file
argument_list|(
name|osm
argument_list|,
literal|"opensm.mcfdbs"
argument_list|,
operator|&
name|osm
operator|->
name|subn
operator|.
name|sw_guid_tbl
argument_list|,
name|dump_mcast_routes
argument_list|,
name|osm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_dump_all
parameter_list|(
name|osm_opensm_t
modifier|*
name|osm
parameter_list|)
block|{
if|if
condition|(
name|OSM_LOG_IS_ACTIVE_V2
argument_list|(
operator|&
name|osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ROUTING
argument_list|)
condition|)
block|{
comment|/* unicast routes */
name|osm_dump_qmap_to_file
argument_list|(
name|osm
argument_list|,
literal|"opensm-lid-matrix.dump"
argument_list|,
operator|&
name|osm
operator|->
name|subn
operator|.
name|sw_guid_tbl
argument_list|,
name|dump_lid_matrix
argument_list|,
name|osm
argument_list|)
expr_stmt|;
name|osm_dump_qmap_to_file
argument_list|(
name|osm
argument_list|,
literal|"opensm-lfts.dump"
argument_list|,
operator|&
name|osm
operator|->
name|subn
operator|.
name|sw_guid_tbl
argument_list|,
name|dump_ucast_lfts
argument_list|,
name|osm
argument_list|)
expr_stmt|;
if|if
condition|(
name|OSM_LOG_IS_ACTIVE_V2
argument_list|(
operator|&
name|osm
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
condition|)
name|dump_qmap
argument_list|(
name|stdout
argument_list|,
operator|&
name|osm
operator|->
name|subn
operator|.
name|sw_guid_tbl
argument_list|,
name|dump_ucast_path_distribution
argument_list|,
name|osm
argument_list|)
expr_stmt|;
comment|/* An attempt to get osm_switch_recommend_path to report the 		   same routes that a sweep would assign. */
if|if
condition|(
name|osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|scatter_ports
condition|)
name|srandom
argument_list|(
name|osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|scatter_ports
argument_list|)
expr_stmt|;
name|osm_dump_qmap_to_file
argument_list|(
name|osm
argument_list|,
literal|"opensm.fdbs"
argument_list|,
operator|&
name|osm
operator|->
name|subn
operator|.
name|sw_guid_tbl
argument_list|,
name|dump_ucast_routes
argument_list|,
name|osm
argument_list|)
expr_stmt|;
comment|/* multicast routes */
name|osm_dump_qmap_to_file
argument_list|(
name|osm
argument_list|,
literal|"opensm.mcfdbs"
argument_list|,
operator|&
name|osm
operator|->
name|subn
operator|.
name|sw_guid_tbl
argument_list|,
name|dump_mcast_routes
argument_list|,
name|osm
argument_list|)
expr_stmt|;
comment|/* SL2VL tables */
if|if
condition|(
name|osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|qos
operator|||
operator|(
name|osm
operator|->
name|routing_engine_used
operator|&&
name|osm
operator|->
name|routing_engine_used
operator|->
name|update_sl2vl
operator|)
condition|)
name|osm_dump_qmap_to_file
argument_list|(
name|osm
argument_list|,
literal|"opensm-sl2vl.dump"
argument_list|,
operator|&
name|osm
operator|->
name|subn
operator|.
name|port_guid_tbl
argument_list|,
name|dump_sl2vl_tbl
argument_list|,
name|osm
argument_list|)
expr_stmt|;
block|}
name|osm_dump_qmap_to_file
argument_list|(
name|osm
argument_list|,
literal|"opensm-subnet.lst"
argument_list|,
operator|&
name|osm
operator|->
name|subn
operator|.
name|node_guid_tbl
argument_list|,
name|dump_topology_node
argument_list|,
name|osm
argument_list|)
expr_stmt|;
if|if
condition|(
name|OSM_LOG_IS_ACTIVE_V2
argument_list|(
operator|&
name|osm
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
condition|)
name|print_report
argument_list|(
name|osm
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


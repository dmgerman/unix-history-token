begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2014 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  * Copyright (c) 2008 Xsigo Systems Inc.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of osm_sa_t.  * This object represents the Subnet Administration object.  * This object is part of the opensm family of objects.  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_qmap.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_passivelock.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|<iba/ib_types.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_file_ids.h>
end_include

begin_define
define|#
directive|define
name|FILE_ID
value|OSM_FILE_SA_C
end_define

begin_include
include|#
directive|include
file|<opensm/osm_sa.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_madw.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_log.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_subnet.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_mad_pool.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_msgdef.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_opensm.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_multicast.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_inform.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_service.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_guid.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_helper.h>
end_include

begin_include
include|#
directive|include
file|<vendor/osm_vendor_api.h>
end_include

begin_define
define|#
directive|define
name|OSM_SA_INITIAL_TID_VALUE
value|0xabc
end_define

begin_function_decl
specifier|extern
name|void
name|osm_cpi_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_gir_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_infr_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_infir_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_lftr_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_lr_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_mcmr_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_mftr_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_mpr_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_nr_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_pr_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_pkey_rec_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_pir_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_sr_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_slvl_rec_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_smir_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_sir_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_vlarb_rec_rcv_process
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|,
name|IN
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|osm_sr_rcv_lease_cb
parameter_list|(
name|IN
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|osm_sa_construct
parameter_list|(
name|IN
name|osm_sa_t
modifier|*
name|p_sa
parameter_list|)
block|{
name|memset
argument_list|(
name|p_sa
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_sa
argument_list|)
argument_list|)
expr_stmt|;
name|p_sa
operator|->
name|state
operator|=
name|OSM_SA_STATE_INIT
expr_stmt|;
name|p_sa
operator|->
name|sa_trans_id
operator|=
name|OSM_SA_INITIAL_TID_VALUE
expr_stmt|;
name|cl_timer_construct
argument_list|(
operator|&
name|p_sa
operator|->
name|sr_timer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_sa_shutdown
parameter_list|(
name|IN
name|osm_sa_t
modifier|*
name|p_sa
parameter_list|)
block|{
name|OSM_LOG_ENTER
argument_list|(
name|p_sa
operator|->
name|p_log
argument_list|)
expr_stmt|;
name|cl_timer_stop
argument_list|(
operator|&
name|p_sa
operator|->
name|sr_timer
argument_list|)
expr_stmt|;
comment|/* unbind from the mad service */
name|osm_sa_mad_ctrl_unbind
argument_list|(
operator|&
name|p_sa
operator|->
name|mad_ctrl
argument_list|)
expr_stmt|;
comment|/* remove any registered dispatcher message */
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|nr_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|pir_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|gir_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|lr_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|pr_disp_h
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VENDOR_RMPP_SUPPORT
argument_list|)
operator|&&
name|defined
argument_list|(
name|DUAL_SIDED_RMPP
argument_list|)
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|mpr_disp_h
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|smir_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|mcmr_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|sr_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|infr_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|infir_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|vlarb_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|slvl_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|pkey_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|lft_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|sir_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|mft_disp_h
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|p_set_disp
condition|)
block|{
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|mcmr_set_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|infr_set_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|sr_set_disp_h
argument_list|)
expr_stmt|;
name|cl_disp_unregister
argument_list|(
name|p_sa
operator|->
name|gir_set_disp_h
argument_list|)
expr_stmt|;
block|}
name|osm_sa_mad_ctrl_destroy
argument_list|(
operator|&
name|p_sa
operator|->
name|mad_ctrl
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_sa
operator|->
name|p_log
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_sa_destroy
parameter_list|(
name|IN
name|osm_sa_t
modifier|*
name|p_sa
parameter_list|)
block|{
name|OSM_LOG_ENTER
argument_list|(
name|p_sa
operator|->
name|p_log
argument_list|)
expr_stmt|;
name|p_sa
operator|->
name|state
operator|=
name|OSM_SA_STATE_INIT
expr_stmt|;
name|cl_timer_destroy
argument_list|(
operator|&
name|p_sa
operator|->
name|sr_timer
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_sa
operator|->
name|p_log
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ib_api_status_t
name|osm_sa_init
parameter_list|(
name|IN
name|osm_sm_t
modifier|*
name|p_sm
parameter_list|,
name|IN
name|osm_sa_t
modifier|*
name|p_sa
parameter_list|,
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_vendor_t
modifier|*
name|p_vendor
parameter_list|,
name|IN
name|osm_mad_pool_t
modifier|*
name|p_mad_pool
parameter_list|,
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
name|osm_stats_t
modifier|*
name|p_stats
parameter_list|,
name|IN
name|cl_dispatcher_t
modifier|*
name|p_disp
parameter_list|,
name|IN
name|cl_dispatcher_t
modifier|*
name|p_set_disp
parameter_list|,
name|IN
name|cl_plock_t
modifier|*
name|p_lock
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
name|p_sa
operator|->
name|sm
operator|=
name|p_sm
expr_stmt|;
name|p_sa
operator|->
name|p_subn
operator|=
name|p_subn
expr_stmt|;
name|p_sa
operator|->
name|p_vendor
operator|=
name|p_vendor
expr_stmt|;
name|p_sa
operator|->
name|p_mad_pool
operator|=
name|p_mad_pool
expr_stmt|;
name|p_sa
operator|->
name|p_log
operator|=
name|p_log
expr_stmt|;
name|p_sa
operator|->
name|p_disp
operator|=
name|p_disp
expr_stmt|;
name|p_sa
operator|->
name|p_set_disp
operator|=
name|p_set_disp
expr_stmt|;
name|p_sa
operator|->
name|p_lock
operator|=
name|p_lock
expr_stmt|;
name|p_sa
operator|->
name|state
operator|=
name|OSM_SA_STATE_READY
expr_stmt|;
name|status
operator|=
name|osm_sa_mad_ctrl_init
argument_list|(
operator|&
name|p_sa
operator|->
name|mad_ctrl
argument_list|,
name|p_sa
argument_list|,
name|p_sa
operator|->
name|p_mad_pool
argument_list|,
name|p_sa
operator|->
name|p_vendor
argument_list|,
name|p_subn
argument_list|,
name|p_log
argument_list|,
name|p_stats
argument_list|,
name|p_disp
argument_list|,
name|p_set_disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|status
operator|=
name|cl_timer_init
argument_list|(
operator|&
name|p_sa
operator|->
name|sr_timer
argument_list|,
name|osm_sr_rcv_lease_cb
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|status
operator|=
name|IB_INSUFFICIENT_RESOURCES
expr_stmt|;
name|p_sa
operator|->
name|cpi_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_CLASS_PORT_INFO
argument_list|,
name|osm_cpi_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|cpi_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|nr_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_NODE_RECORD
argument_list|,
name|osm_nr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|nr_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|pir_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_PORTINFO_RECORD
argument_list|,
name|osm_pir_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|pir_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|gir_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_GUIDINFO_RECORD
argument_list|,
name|osm_gir_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|gir_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|lr_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_LINK_RECORD
argument_list|,
name|osm_lr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|lr_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|pr_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_PATH_RECORD
argument_list|,
name|osm_pr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|pr_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
if|#
directive|if
name|defined
argument_list|(
name|VENDOR_RMPP_SUPPORT
argument_list|)
operator|&&
name|defined
argument_list|(
name|DUAL_SIDED_RMPP
argument_list|)
name|p_sa
operator|->
name|mpr_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_MULTIPATH_RECORD
argument_list|,
name|osm_mpr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|mpr_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
endif|#
directive|endif
name|p_sa
operator|->
name|smir_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_SMINFO_RECORD
argument_list|,
name|osm_smir_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|smir_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|mcmr_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_MCMEMBER_RECORD
argument_list|,
name|osm_mcmr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|mcmr_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|sr_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_SERVICE_RECORD
argument_list|,
name|osm_sr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|sr_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|infr_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_INFORM_INFO
argument_list|,
name|osm_infr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|infr_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|infir_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_INFORM_INFO_RECORD
argument_list|,
name|osm_infir_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|infir_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|vlarb_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_VL_ARB_RECORD
argument_list|,
name|osm_vlarb_rec_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|vlarb_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|slvl_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_SLVL_TBL_RECORD
argument_list|,
name|osm_slvl_rec_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|slvl_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|pkey_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_PKEY_TBL_RECORD
argument_list|,
name|osm_pkey_rec_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|pkey_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|lft_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_LFT_RECORD
argument_list|,
name|osm_lftr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|lft_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|sir_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_SWITCH_INFO_RECORD
argument_list|,
name|osm_sir_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|sir_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|mft_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_disp
argument_list|,
name|OSM_MSG_MAD_MFT_RECORD
argument_list|,
name|osm_mftr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|mft_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
comment|/* 	 * When p_set_disp is defined, it means that we use different dispatcher 	 * for SA Set requests, and we need to register handlers for it. 	 */
if|if
condition|(
name|p_set_disp
condition|)
block|{
name|p_sa
operator|->
name|gir_set_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_set_disp
argument_list|,
name|OSM_MSG_MAD_GUIDINFO_RECORD
argument_list|,
name|osm_gir_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|gir_set_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|mcmr_set_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_set_disp
argument_list|,
name|OSM_MSG_MAD_MCMEMBER_RECORD
argument_list|,
name|osm_mcmr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|mcmr_set_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|sr_set_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_set_disp
argument_list|,
name|OSM_MSG_MAD_SERVICE_RECORD
argument_list|,
name|osm_sr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|sr_set_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
name|p_sa
operator|->
name|infr_set_disp_h
operator|=
name|cl_disp_register
argument_list|(
name|p_set_disp
argument_list|,
name|OSM_MSG_MAD_INFORM_INFO
argument_list|,
name|osm_infr_rcv_process
argument_list|,
name|p_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sa
operator|->
name|infr_set_disp_h
operator|==
name|CL_DISP_INVALID_HANDLE
condition|)
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|ib_api_status_t
name|osm_sa_bind
parameter_list|(
name|IN
name|osm_sa_t
modifier|*
name|p_sa
parameter_list|,
name|IN
name|ib_net64_t
name|port_guid
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_sa
operator|->
name|p_log
argument_list|)
expr_stmt|;
name|status
operator|=
name|osm_sa_mad_ctrl_bind
argument_list|(
operator|&
name|p_sa
operator|->
name|mad_ctrl
argument_list|,
name|port_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_sa
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C03: "
literal|"SA MAD Controller bind failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_sa
operator|->
name|p_log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|ib_api_status_t
name|osm_sa_send
parameter_list|(
name|osm_sa_t
modifier|*
name|sa
parameter_list|,
name|IN
name|osm_madw_t
modifier|*
name|p_madw
parameter_list|,
name|IN
name|boolean_t
name|resp_expected
parameter_list|)
block|{
name|ib_api_status_t
name|status
decl_stmt|;
name|cl_atomic_inc
argument_list|(
operator|&
name|sa
operator|->
name|p_subn
operator|->
name|p_osm
operator|->
name|stats
operator|.
name|sa_mads_sent
argument_list|)
expr_stmt|;
name|status
operator|=
name|osm_vendor_send
argument_list|(
name|p_madw
operator|->
name|h_bind
argument_list|,
name|p_madw
argument_list|,
name|resp_expected
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|cl_atomic_dec
argument_list|(
operator|&
name|sa
operator|->
name|p_subn
operator|->
name|p_osm
operator|->
name|stats
operator|.
name|sa_mads_sent
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C04: "
literal|"osm_vendor_send failed, status = %s\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|void
name|osm_sa_send_error
parameter_list|(
name|IN
name|osm_sa_t
modifier|*
name|sa
parameter_list|,
name|IN
specifier|const
name|osm_madw_t
modifier|*
name|p_madw
parameter_list|,
name|IN
name|ib_net16_t
name|sa_status
parameter_list|)
block|{
name|osm_madw_t
modifier|*
name|p_resp_madw
decl_stmt|;
name|ib_sa_mad_t
modifier|*
name|p_resp_sa_mad
decl_stmt|;
name|ib_sa_mad_t
modifier|*
name|p_sa_mad
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|sa
operator|->
name|p_log
argument_list|)
expr_stmt|;
comment|/* avoid races - if we are exiting - exit */
if|if
condition|(
name|osm_exit_flag
condition|)
block|{
name|OSM_LOG
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Ignoring requested send after exit\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_resp_madw
operator|=
name|osm_mad_pool_get
argument_list|(
name|sa
operator|->
name|p_mad_pool
argument_list|,
name|p_madw
operator|->
name|h_bind
argument_list|,
name|MAD_BLOCK_SIZE
argument_list|,
operator|&
name|p_madw
operator|->
name|mad_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_resp_madw
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C07: "
literal|"Unable to acquire response MAD\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_resp_sa_mad
operator|=
name|osm_madw_get_sa_mad_ptr
argument_list|(
name|p_resp_madw
argument_list|)
expr_stmt|;
name|p_sa_mad
operator|=
name|osm_madw_get_sa_mad_ptr
argument_list|(
name|p_madw
argument_list|)
expr_stmt|;
comment|/*  Copy the MAD header back into the response mad */
operator|*
name|p_resp_sa_mad
operator|=
operator|*
name|p_sa_mad
expr_stmt|;
name|p_resp_sa_mad
operator|->
name|status
operator|=
name|sa_status
expr_stmt|;
if|if
condition|(
name|p_resp_sa_mad
operator|->
name|method
operator|==
name|IB_MAD_METHOD_SET
condition|)
name|p_resp_sa_mad
operator|->
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
elseif|else
if|if
condition|(
name|p_resp_sa_mad
operator|->
name|method
operator|==
name|IB_MAD_METHOD_GETTABLE
condition|)
name|p_resp_sa_mad
operator|->
name|attr_offset
operator|=
literal|0
expr_stmt|;
name|p_resp_sa_mad
operator|->
name|method
operator||=
name|IB_MAD_METHOD_RESP_MASK
expr_stmt|;
comment|/* 	 * C15-0.1.5 - always return SM_Key = 0 (table 185 p 884) 	 */
name|p_resp_sa_mad
operator|->
name|sm_key
operator|=
literal|0
expr_stmt|;
comment|/* 	 * o15-0.2.7 - The PathRecord Attribute ID shall be used in 	 * the response (to a SubnAdmGetMulti(MultiPathRecord) 	 */
if|if
condition|(
name|p_resp_sa_mad
operator|->
name|attr_id
operator|==
name|IB_MAD_ATTR_MULTIPATH_RECORD
condition|)
name|p_resp_sa_mad
operator|->
name|attr_id
operator|=
name|IB_MAD_ATTR_PATH_RECORD
expr_stmt|;
if|if
condition|(
name|OSM_LOG_IS_ACTIVE_V2
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|OSM_LOG_FRAMES
argument_list|)
condition|)
name|osm_dump_sa_mad_v2
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|p_resp_sa_mad
argument_list|,
name|FILE_ID
argument_list|,
name|OSM_LOG_FRAMES
argument_list|)
expr_stmt|;
name|osm_sa_send
argument_list|(
name|sa
argument_list|,
name|p_resp_madw
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|sa
operator|->
name|p_log
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_sa_respond
parameter_list|(
name|osm_sa_t
modifier|*
name|sa
parameter_list|,
name|osm_madw_t
modifier|*
name|madw
parameter_list|,
name|size_t
name|attr_size
parameter_list|,
name|cl_qlist_t
modifier|*
name|list
parameter_list|)
block|{
name|cl_list_item_t
modifier|*
name|item
decl_stmt|;
name|osm_madw_t
modifier|*
name|resp_madw
decl_stmt|;
name|ib_sa_mad_t
modifier|*
name|sa_mad
decl_stmt|,
modifier|*
name|resp_sa_mad
decl_stmt|;
name|unsigned
name|num_rec
decl_stmt|,
name|i
decl_stmt|;
ifndef|#
directive|ifndef
name|VENDOR_RMPP_SUPPORT
name|unsigned
name|trim_num_rec
decl_stmt|;
endif|#
directive|endif
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|sa_mad
operator|=
name|osm_madw_get_sa_mad_ptr
argument_list|(
name|madw
argument_list|)
expr_stmt|;
name|num_rec
operator|=
name|cl_qlist_count
argument_list|(
name|list
argument_list|)
expr_stmt|;
comment|/* 	 * C15-0.1.30: 	 * If we do a SubnAdmGet and got more than one record it is an error! 	 */
if|if
condition|(
name|sa_mad
operator|->
name|method
operator|==
name|IB_MAD_METHOD_GET
operator|&&
name|num_rec
operator|>
literal|1
condition|)
block|{
name|OSM_LOG
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C05: "
literal|"Got %u records for SubnAdmGet(%s) comp_mask 0x%016"
name|PRIx64
literal|"from requester LID %u\n"
argument_list|,
name|num_rec
argument_list|,
name|ib_get_sa_attr_str
argument_list|(
name|sa_mad
operator|->
name|attr_id
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|sa_mad
operator|->
name|comp_mask
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|madw
operator|->
name|mad_addr
operator|.
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
name|osm_sa_send_error
argument_list|(
name|sa
argument_list|,
name|madw
argument_list|,
name|IB_SA_MAD_STATUS_TOO_MANY_RECORDS
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
ifndef|#
directive|ifndef
name|VENDOR_RMPP_SUPPORT
name|trim_num_rec
operator|=
operator|(
name|MAD_BLOCK_SIZE
operator|-
name|IB_SA_MAD_HDR_SIZE
operator|)
operator|/
name|attr_size
expr_stmt|;
if|if
condition|(
name|trim_num_rec
operator|<
name|num_rec
condition|)
block|{
name|OSM_LOG
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Number of records:%u trimmed to:%u to fit in one MAD\n"
argument_list|,
name|num_rec
argument_list|,
name|trim_num_rec
argument_list|)
expr_stmt|;
name|num_rec
operator|=
name|trim_num_rec
expr_stmt|;
block|}
endif|#
directive|endif
name|OSM_LOG
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Returning %u records\n"
argument_list|,
name|num_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa_mad
operator|->
name|method
operator|==
name|IB_MAD_METHOD_GET
operator|&&
name|num_rec
operator|==
literal|0
condition|)
block|{
name|osm_sa_send_error
argument_list|(
name|sa
argument_list|,
name|madw
argument_list|,
name|IB_SA_MAD_STATUS_NO_RECORDS
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* 	 * Get a MAD to reply. Address of Mad is in the received mad_wrapper 	 */
name|resp_madw
operator|=
name|osm_mad_pool_get
argument_list|(
name|sa
operator|->
name|p_mad_pool
argument_list|,
name|madw
operator|->
name|h_bind
argument_list|,
name|num_rec
operator|*
name|attr_size
operator|+
name|IB_SA_MAD_HDR_SIZE
argument_list|,
operator|&
name|madw
operator|->
name|mad_addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp_madw
condition|)
block|{
name|OSM_LOG
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C06: "
literal|"osm_mad_pool_get failed\n"
argument_list|)
expr_stmt|;
name|osm_sa_send_error
argument_list|(
name|sa
argument_list|,
name|madw
argument_list|,
name|IB_SA_MAD_STATUS_NO_RESOURCES
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|resp_sa_mad
operator|=
name|osm_madw_get_sa_mad_ptr
argument_list|(
name|resp_madw
argument_list|)
expr_stmt|;
comment|/* 	   Copy the MAD header back into the response mad. 	   Set the 'R' bit and the payload length, 	   Then copy all records from the list into the response payload. 	 */
name|memcpy
argument_list|(
name|resp_sa_mad
argument_list|,
name|sa_mad
argument_list|,
name|IB_SA_MAD_HDR_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp_sa_mad
operator|->
name|method
operator|==
name|IB_MAD_METHOD_SET
condition|)
name|resp_sa_mad
operator|->
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|resp_sa_mad
operator|->
name|method
operator||=
name|IB_MAD_METHOD_RESP_MASK
expr_stmt|;
comment|/* C15-0.1.5 - always return SM_Key = 0 (table 185 p 884) */
name|resp_sa_mad
operator|->
name|sm_key
operator|=
literal|0
expr_stmt|;
comment|/* Fill in the offset (paylen will be done by the rmpp SAR) */
name|resp_sa_mad
operator|->
name|attr_offset
operator|=
name|num_rec
condition|?
name|ib_get_attr_offset
argument_list|(
name|attr_size
argument_list|)
else|:
literal|0
expr_stmt|;
name|p
operator|=
name|ib_sa_mad_get_payload_ptr
argument_list|(
name|resp_sa_mad
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|VENDOR_RMPP_SUPPORT
comment|/* we support only one packet RMPP - so we will set the first and 	   last flags for gettable */
if|if
condition|(
name|resp_sa_mad
operator|->
name|method
operator|==
name|IB_MAD_METHOD_GETTABLE_RESP
condition|)
block|{
name|resp_sa_mad
operator|->
name|rmpp_type
operator|=
name|IB_RMPP_TYPE_DATA
expr_stmt|;
name|resp_sa_mad
operator|->
name|rmpp_flags
operator|=
name|IB_RMPP_FLAG_FIRST
operator||
name|IB_RMPP_FLAG_LAST
operator||
name|IB_RMPP_FLAG_ACTIVE
expr_stmt|;
block|}
else|#
directive|else
comment|/* forcefully define the packet as RMPP one */
if|if
condition|(
name|resp_sa_mad
operator|->
name|method
operator|==
name|IB_MAD_METHOD_GETTABLE_RESP
condition|)
name|resp_sa_mad
operator|->
name|rmpp_flags
operator|=
name|IB_RMPP_FLAG_ACTIVE
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_rec
condition|;
name|i
operator|++
control|)
block|{
name|item
operator|=
name|cl_qlist_remove_head
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p
argument_list|,
operator|(
operator|(
name|osm_sa_item_t
operator|*
operator|)
name|item
operator|)
operator|->
name|resp
operator|.
name|data
argument_list|,
name|attr_size
argument_list|)
expr_stmt|;
name|p
operator|+=
name|attr_size
expr_stmt|;
name|free
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
name|osm_dump_sa_mad_v2
argument_list|(
name|sa
operator|->
name|p_log
argument_list|,
name|resp_sa_mad
argument_list|,
name|FILE_ID
argument_list|,
name|OSM_LOG_FRAMES
argument_list|)
expr_stmt|;
name|osm_sa_send
argument_list|(
name|sa
argument_list|,
name|resp_madw
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|Exit
label|:
comment|/* need to set the mem free ... */
name|item
operator|=
name|cl_qlist_remove_head
argument_list|(
name|list
argument_list|)
expr_stmt|;
while|while
condition|(
name|item
operator|!=
name|cl_qlist_end
argument_list|(
name|list
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|item
operator|=
name|cl_qlist_remove_head
argument_list|(
name|list
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  *  SA DB Dumper  *  */
end_comment

begin_struct
struct|struct
name|opensm_dump_context
block|{
name|osm_opensm_t
modifier|*
name|p_osm
decl_stmt|;
name|FILE
modifier|*
name|file
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|opensm_dump_to_file
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
specifier|const
name|char
modifier|*
name|file_name
parameter_list|,
name|void
function_decl|(
modifier|*
name|dump_func
function_decl|)
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|)
parameter_list|)
block|{
name|char
name|path
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|path_tmp
index|[
literal|1032
index|]
decl_stmt|;
name|FILE
modifier|*
name|file
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|status
init|=
literal|0
decl_stmt|;
name|snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|p_osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|dump_files_dir
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|path_tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|path_tmp
argument_list|)
argument_list|,
literal|"%s.tmp"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|file
operator|=
name|fopen
argument_list|(
name|path_tmp
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|file
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C01: "
literal|"cannot open file \'%s\': %s\n"
argument_list|,
name|path_tmp
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|chmod
argument_list|(
name|path_tmp
argument_list|,
name|S_IRUSR
operator||
name|S_IWUSR
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C0C: "
literal|"cannot change access permissions of file "
literal|"\'%s\' : %s\n"
argument_list|,
name|path_tmp
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dump_func
argument_list|(
name|p_osm
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|fsync_high_avail_files
condition|)
block|{
if|if
condition|(
name|fflush
argument_list|(
name|file
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fd
operator|=
name|fileno
argument_list|(
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|fsync
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C08: fsync() failed (%s) for %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|path_tmp
argument_list|)
expr_stmt|;
block|}
else|else
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C09: "
literal|"fileno() failed for %s\n"
argument_list|,
name|path_tmp
argument_list|)
expr_stmt|;
block|}
else|else
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C0A: "
literal|"fflush() failed (%s) for %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|path_tmp
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|status
operator|=
name|rename
argument_list|(
name|path_tmp
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4C0B: "
literal|"Failed to rename file:%s (err:%s)\n"
argument_list|,
name|path_tmp
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mcast_mgr_dump_one_port
parameter_list|(
name|cl_map_item_t
modifier|*
name|p_map_item
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|FILE
modifier|*
name|file
init|=
operator|(
operator|(
expr|struct
name|opensm_dump_context
operator|*
operator|)
name|cxt
operator|)
operator|->
name|file
decl_stmt|;
name|osm_mcm_alias_guid_t
modifier|*
name|p_mcm_alias_guid
init|=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|p_map_item
decl_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"mcm_port: "
literal|"port_gid=0x%016"
name|PRIx64
literal|":0x%016"
name|PRIx64
literal|" "
literal|"scope_state=0x%02x proxy_join=0x%x"
literal|"\n\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mcm_alias_guid
operator|->
name|port_gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mcm_alias_guid
operator|->
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|p_mcm_alias_guid
operator|->
name|scope_state
argument_list|,
name|p_mcm_alias_guid
operator|->
name|proxy_join
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sa_dump_one_mgrp
parameter_list|(
name|osm_mgrp_t
modifier|*
name|p_mgrp
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|struct
name|opensm_dump_context
name|dump_context
decl_stmt|;
name|osm_opensm_t
modifier|*
name|p_osm
init|=
operator|(
operator|(
expr|struct
name|opensm_dump_context
operator|*
operator|)
name|cxt
operator|)
operator|->
name|p_osm
decl_stmt|;
name|FILE
modifier|*
name|file
init|=
operator|(
operator|(
expr|struct
name|opensm_dump_context
operator|*
operator|)
name|cxt
operator|)
operator|->
name|file
decl_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"MC Group 0x%04x %s:"
literal|" mgid=0x%016"
name|PRIx64
literal|":0x%016"
name|PRIx64
literal|" port_gid=0x%016"
name|PRIx64
literal|":0x%016"
name|PRIx64
literal|" qkey=0x%08x mlid=0x%04x mtu=0x%02x tclass=0x%02x"
literal|" pkey=0x%04x rate=0x%02x pkt_life=0x%02x sl_flow_hop=0x%08x"
literal|" scope_state=0x%02x proxy_join=0x%x"
literal|"\n\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mgrp
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_mgrp
operator|->
name|well_known
condition|?
literal|" (well known)"
else|:
literal|""
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|qkey
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mlid
argument_list|)
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mtu
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|tclass
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|pkey
argument_list|)
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|rate
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|pkt_life
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|sl_flow_hop
argument_list|)
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|scope_state
argument_list|,
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|proxy_join
argument_list|)
expr_stmt|;
name|dump_context
operator|.
name|p_osm
operator|=
name|p_osm
expr_stmt|;
name|dump_context
operator|.
name|file
operator|=
name|file
expr_stmt|;
name|cl_qmap_apply_func
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|,
name|mcast_mgr_dump_one_port
argument_list|,
operator|&
name|dump_context
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sa_dump_one_inform
parameter_list|(
name|cl_list_item_t
modifier|*
name|p_list_item
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|FILE
modifier|*
name|file
init|=
operator|(
operator|(
expr|struct
name|opensm_dump_context
operator|*
operator|)
name|cxt
operator|)
operator|->
name|file
decl_stmt|;
name|osm_infr_t
modifier|*
name|p_infr
init|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|p_list_item
decl_stmt|;
name|ib_inform_info_record_t
modifier|*
name|p_iir
init|=
operator|&
name|p_infr
operator|->
name|inform_record
decl_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"InformInfo Record:"
literal|" subscriber_gid=0x%016"
name|PRIx64
literal|":0x%016"
name|PRIx64
literal|" subscriber_enum=0x%x"
literal|" InformInfo:"
literal|" gid=0x%016"
name|PRIx64
literal|":0x%016"
name|PRIx64
literal|" lid_range_begin=0x%x"
literal|" lid_range_end=0x%x"
literal|" is_generic=0x%x"
literal|" subscribe=0x%x"
literal|" trap_type=0x%x"
literal|" trap_num=0x%x"
literal|" qpn_resp_time_val=0x%x"
literal|" node_type=0x%06x"
literal|" rep_addr: lid=0x%04x path_bits=0x%02x static_rate=0x%02x"
literal|" remote_qp=0x%08x remote_qkey=0x%08x pkey_ix=0x%04x sl=0x%02x"
literal|"\n\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_iir
operator|->
name|subscriber_gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_iir
operator|->
name|subscriber_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|subscriber_enum
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_begin
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_end
argument_list|)
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|is_generic
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|subscribe
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|trap_type
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|qpn_resp_time_val
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_inform_info_get_prod_type
argument_list|(
operator|&
name|p_iir
operator|->
name|inform_info
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_infr
operator|->
name|report_addr
operator|.
name|dest_lid
argument_list|)
argument_list|,
name|p_infr
operator|->
name|report_addr
operator|.
name|path_bits
argument_list|,
name|p_infr
operator|->
name|report_addr
operator|.
name|static_rate
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_infr
operator|->
name|report_addr
operator|.
name|addr_type
operator|.
name|gsi
operator|.
name|remote_qp
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_infr
operator|->
name|report_addr
operator|.
name|addr_type
operator|.
name|gsi
operator|.
name|remote_qkey
argument_list|)
argument_list|,
name|p_infr
operator|->
name|report_addr
operator|.
name|addr_type
operator|.
name|gsi
operator|.
name|pkey_ix
argument_list|,
name|p_infr
operator|->
name|report_addr
operator|.
name|addr_type
operator|.
name|gsi
operator|.
name|service_level
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sa_dump_one_service
parameter_list|(
name|cl_list_item_t
modifier|*
name|p_list_item
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|FILE
modifier|*
name|file
init|=
operator|(
operator|(
expr|struct
name|opensm_dump_context
operator|*
operator|)
name|cxt
operator|)
operator|->
name|file
decl_stmt|;
name|osm_svcr_t
modifier|*
name|p_svcr
init|=
operator|(
name|osm_svcr_t
operator|*
operator|)
name|p_list_item
decl_stmt|;
name|ib_service_record_t
modifier|*
name|p_sr
init|=
operator|&
name|p_svcr
operator|->
name|service_record
decl_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"Service Record: id=0x%016"
name|PRIx64
literal|" gid=0x%016"
name|PRIx64
literal|":0x%016"
name|PRIx64
literal|" pkey=0x%x"
literal|" lease=0x%x"
literal|" key=0x%02x%02x%02x%02x%02x%02x%02x%02x"
literal|":0x%02x%02x%02x%02x%02x%02x%02x%02x"
literal|" name=\'%s\'"
literal|" data8=0x%02x%02x%02x%02x%02x%02x%02x%02x"
literal|":0x%02x%02x%02x%02x%02x%02x%02x%02x"
literal|" data16=0x%04x%04x%04x%04x:0x%04x%04x%04x%04x"
literal|" data32=0x%08x%08x:0x%08x%08x"
literal|" data64=0x%016"
name|PRIx64
literal|":0x%016"
name|PRIx64
literal|" modified_time=0x%x lease_period=0x%x\n\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_id
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_pkey
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_lease
argument_list|)
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|0
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|1
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|2
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|3
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|4
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|5
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|6
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|7
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|8
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|9
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|10
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|11
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|12
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|13
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|14
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|15
index|]
argument_list|,
name|p_sr
operator|->
name|service_name
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|0
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|1
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|2
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|3
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|4
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|5
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|6
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|7
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|8
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|9
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|10
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|11
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|12
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|13
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|14
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|15
index|]
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|7
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_data64
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_data64
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|p_svcr
operator|->
name|modified_time
argument_list|,
name|p_svcr
operator|->
name|lease_period
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sa_dump_one_port_guidinfo
parameter_list|(
name|cl_map_item_t
modifier|*
name|p_map_item
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|)
block|{
name|FILE
modifier|*
name|file
init|=
operator|(
operator|(
expr|struct
name|opensm_dump_context
operator|*
operator|)
name|cxt
operator|)
operator|->
name|file
decl_stmt|;
name|osm_port_t
modifier|*
name|p_port
init|=
operator|(
name|osm_port_t
operator|*
operator|)
name|p_map_item
decl_stmt|;
name|uint32_t
name|max_block
decl_stmt|;
name|int
name|block_num
decl_stmt|;
if|if
condition|(
operator|!
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
condition|)
return|return;
name|max_block
operator|=
operator|(
name|p_port
operator|->
name|p_physp
operator|->
name|port_info
operator|.
name|guid_cap
operator|+
name|GUID_TABLE_MAX_ENTRIES
operator|-
literal|1
operator|)
operator|/
name|GUID_TABLE_MAX_ENTRIES
expr_stmt|;
for|for
control|(
name|block_num
operator|=
literal|0
init|;
name|block_num
operator|<
name|max_block
condition|;
name|block_num
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"GUIDInfo Record:"
literal|" base_guid=0x%016"
name|PRIx64
literal|" lid=0x%04x block_num=0x%x"
literal|" guid0=0x%016"
name|PRIx64
literal|" guid1=0x%016"
name|PRIx64
literal|" guid2=0x%016"
name|PRIx64
literal|" guid3=0x%016"
name|PRIx64
literal|" guid4=0x%016"
name|PRIx64
literal|" guid5=0x%016"
name|PRIx64
literal|" guid6=0x%016"
name|PRIx64
literal|" guid7=0x%016"
name|PRIx64
literal|"\n\n"
argument_list|,
name|cl_ntoh64
argument_list|(
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|osm_port_get_base_lid
argument_list|(
name|p_port
argument_list|)
argument_list|)
argument_list|,
name|block_num
argument_list|,
name|cl_ntoh64
argument_list|(
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
literal|4
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
literal|5
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
literal|6
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sa_dump_all_sa
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|)
block|{
name|struct
name|opensm_dump_context
name|dump_context
decl_stmt|;
name|osm_mgrp_t
modifier|*
name|p_mgrp
decl_stmt|;
name|dump_context
operator|.
name|p_osm
operator|=
name|p_osm
expr_stmt|;
name|dump_context
operator|.
name|file
operator|=
name|file
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Dump guidinfo\n"
argument_list|)
expr_stmt|;
name|cl_qmap_apply_func
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
operator|.
name|port_guid_tbl
argument_list|,
name|sa_dump_one_port_guidinfo
argument_list|,
operator|&
name|dump_context
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Dump multicast\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|p_mgrp
operator|=
operator|(
name|osm_mgrp_t
operator|*
operator|)
name|cl_fmap_head
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
operator|.
name|mgrp_mgid_tbl
argument_list|)
init|;
name|p_mgrp
operator|!=
operator|(
name|osm_mgrp_t
operator|*
operator|)
name|cl_fmap_end
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
operator|.
name|mgrp_mgid_tbl
argument_list|)
condition|;
name|p_mgrp
operator|=
operator|(
name|osm_mgrp_t
operator|*
operator|)
name|cl_fmap_next
argument_list|(
operator|&
name|p_mgrp
operator|->
name|map_item
argument_list|)
control|)
name|sa_dump_one_mgrp
argument_list|(
name|p_mgrp
argument_list|,
operator|&
name|dump_context
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Dump inform\n"
argument_list|)
expr_stmt|;
name|cl_qlist_apply_func
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
operator|.
name|sa_infr_list
argument_list|,
name|sa_dump_one_inform
argument_list|,
operator|&
name|dump_context
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Dump services\n"
argument_list|)
expr_stmt|;
name|cl_qlist_apply_func
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
operator|.
name|sa_sr_list
argument_list|,
name|sa_dump_one_service
argument_list|,
operator|&
name|dump_context
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|osm_sa_db_file_dump
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|)
block|{
name|int
name|res
init|=
literal|1
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_osm
operator|->
name|sa
operator|.
name|dirty
condition|)
block|{
name|res
operator|=
name|opensm_dump_to_file
argument_list|(
name|p_osm
argument_list|,
literal|"opensm-sa.dump"
argument_list|,
name|sa_dump_all_sa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
name|p_osm
operator|->
name|sa
operator|.
name|dirty
operator|=
name|FALSE
expr_stmt|;
block|}
name|cl_plock_release
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  *  SA DB Loader  */
end_comment

begin_function
specifier|static
name|osm_mgrp_t
modifier|*
name|load_mcgroup
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
name|ib_net16_t
name|mlid
parameter_list|,
name|ib_member_rec_t
modifier|*
name|p_mcm_rec
parameter_list|)
block|{
name|ib_net64_t
name|comp_mask
decl_stmt|;
name|osm_mgrp_t
modifier|*
name|p_mgrp
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
name|p_mgrp
operator|=
name|osm_get_mgrp_by_mgid
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
operator|&
name|p_mcm_rec
operator|->
name|mgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mgrp
condition|)
block|{
if|if
condition|(
name|p_mgrp
operator|->
name|mlid
operator|==
name|mlid
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"mgrp %04x is already here."
argument_list|,
name|cl_ntoh16
argument_list|(
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|_out
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"mlid %04x is already used by another MC group. Will "
literal|"request clients reregistration.\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
name|p_mgrp
operator|=
name|NULL
expr_stmt|;
goto|goto
name|_out
goto|;
block|}
name|comp_mask
operator|=
name|IB_MCR_COMPMASK_MTU
operator||
name|IB_MCR_COMPMASK_MTU_SEL
operator||
name|IB_MCR_COMPMASK_RATE
operator||
name|IB_MCR_COMPMASK_RATE_SEL
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p_mgrp
operator|=
name|osm_mcmr_rcv_find_or_create_new_mgrp
argument_list|(
operator|&
name|p_osm
operator|->
name|sa
argument_list|,
name|comp_mask
argument_list|,
name|p_mcm_rec
argument_list|)
operator|)
operator|||
name|p_mgrp
operator|->
name|mlid
operator|!=
name|mlid
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"cannot create MC group with mlid 0x%04x and mgid "
literal|"0x%016"
name|PRIx64
literal|":0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|mlid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mcm_rec
operator|->
name|mgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mcm_rec
operator|->
name|mgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
name|p_mgrp
operator|=
name|NULL
expr_stmt|;
block|}
name|_out
label|:
name|cl_plock_release
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|p_mgrp
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|load_svcr
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
name|ib_service_record_t
modifier|*
name|sr
parameter_list|,
name|uint32_t
name|modified_time
parameter_list|,
name|uint32_t
name|lease_period
parameter_list|)
block|{
name|osm_svcr_t
modifier|*
name|p_svcr
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|osm_svcr_get_by_rid
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|sr
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"ServiceRecord already exists\n"
argument_list|)
expr_stmt|;
goto|goto
name|_out
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|p_svcr
operator|=
name|osm_svcr_new
argument_list|(
name|sr
argument_list|)
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"cannot allocate new service struct\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|_out
goto|;
block|}
name|p_svcr
operator|->
name|modified_time
operator|=
name|modified_time
expr_stmt|;
name|p_svcr
operator|->
name|lease_period
operator|=
name|lease_period
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"adding ServiceRecord...\n"
argument_list|)
expr_stmt|;
name|osm_svcr_insert_to_db
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|p_svcr
argument_list|)
expr_stmt|;
if|if
condition|(
name|lease_period
operator|!=
literal|0xffffffff
condition|)
name|cl_timer_trim
argument_list|(
operator|&
name|p_osm
operator|->
name|sa
operator|.
name|sr_timer
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
name|_out
label|:
name|cl_plock_release
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|load_infr
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
name|ib_inform_info_record_t
modifier|*
name|iir
parameter_list|,
name|osm_mad_addr_t
modifier|*
name|addr
parameter_list|)
block|{
name|osm_infr_t
name|infr
decl_stmt|,
modifier|*
name|p_infr
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|infr
operator|.
name|h_bind
operator|=
name|p_osm
operator|->
name|sa
operator|.
name|mad_ctrl
operator|.
name|h_bind
expr_stmt|;
name|infr
operator|.
name|sa
operator|=
operator|&
name|p_osm
operator|->
name|sa
expr_stmt|;
comment|/* other possible way to restore mad_addr partially is 	   to extract qpn from InformInfo and to find lid by gid */
name|infr
operator|.
name|report_addr
operator|=
operator|*
name|addr
expr_stmt|;
name|infr
operator|.
name|inform_record
operator|=
operator|*
name|iir
expr_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|osm_infr_get_by_rec
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
operator|&
name|p_osm
operator|->
name|log
argument_list|,
operator|&
name|infr
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"InformInfo Record already exists\n"
argument_list|)
expr_stmt|;
goto|goto
name|_out
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|p_infr
operator|=
name|osm_infr_new
argument_list|(
operator|&
name|infr
argument_list|)
operator|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"cannot allocate new infr struct\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|_out
goto|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"adding InformInfo Record...\n"
argument_list|)
expr_stmt|;
name|osm_infr_insert_to_db
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|p_infr
argument_list|)
expr_stmt|;
name|_out
label|:
name|cl_plock_release
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|load_guidinfo
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
name|ib_net64_t
name|base_guid
parameter_list|,
name|ib_guidinfo_record_t
modifier|*
name|gir
parameter_list|)
block|{
name|osm_port_t
modifier|*
name|p_port
decl_stmt|;
name|uint32_t
name|max_block
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|osm_alias_guid_t
modifier|*
name|p_alias_guid
decl_stmt|,
modifier|*
name|p_alias_guid_check
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
name|p_port
operator|=
name|osm_get_port_by_guid
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
name|base_guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_port
condition|)
goto|goto
name|_out
goto|;
if|if
condition|(
operator|!
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
condition|)
block|{
name|max_block
operator|=
operator|(
name|p_port
operator|->
name|p_physp
operator|->
name|port_info
operator|.
name|guid_cap
operator|+
name|GUID_TABLE_MAX_ENTRIES
operator|-
literal|1
operator|)
operator|/
name|GUID_TABLE_MAX_ENTRIES
expr_stmt|;
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|=
name|calloc
argument_list|(
name|max_block
operator|*
name|GUID_TABLE_MAX_ENTRIES
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_net64_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"cannot allocate GUID table for port "
literal|"GUID 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_port
operator|->
name|p_physp
operator|->
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|_out
goto|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|GUID_TABLE_MAX_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
name|i
index|]
condition|)
continue|continue;
comment|/* skip block 0 index 0 */
if|if
condition|(
name|gir
operator|->
name|block_num
operator|==
literal|0
operator|&&
name|i
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|gir
operator|->
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
name|i
operator|>
name|p_port
operator|->
name|p_physp
operator|->
name|port_info
operator|.
name|guid_cap
condition|)
break|break;
name|p_alias_guid
operator|=
name|osm_alias_guid_new
argument_list|(
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
name|i
index|]
argument_list|,
name|p_port
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_alias_guid
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Alias guid %d memory allocation failed"
literal|" for port GUID 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|gir
operator|->
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
name|i
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_port
operator|->
name|p_physp
operator|->
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|_out
goto|;
block|}
name|p_alias_guid_check
operator|=
operator|(
name|osm_alias_guid_t
operator|*
operator|)
name|cl_qmap_insert
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
operator|.
name|alias_port_guid_tbl
argument_list|,
name|p_alias_guid
operator|->
name|alias_guid
argument_list|,
operator|&
name|p_alias_guid
operator|->
name|map_item
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_alias_guid_check
operator|!=
name|p_alias_guid
condition|)
block|{
comment|/* alias GUID is a duplicate */
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Duplicate alias port GUID 0x%"
name|PRIx64
literal|" index %d base port GUID 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_alias_guid
operator|->
name|alias_guid
argument_list|)
argument_list|,
name|gir
operator|->
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
operator|+
name|i
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_alias_guid
operator|->
name|p_base_port
operator|->
name|guid
argument_list|)
argument_list|)
expr_stmt|;
name|osm_alias_guid_delete
argument_list|(
operator|&
name|p_alias_guid
argument_list|)
expr_stmt|;
goto|goto
name|_out
goto|;
block|}
block|}
name|memcpy
argument_list|(
operator|&
operator|(
operator|*
name|p_port
operator|->
name|p_physp
operator|->
name|p_guids
operator|)
index|[
name|gir
operator|->
name|block_num
operator|*
name|GUID_TABLE_MAX_ENTRIES
index|]
argument_list|,
operator|&
name|gir
operator|->
name|guid_info
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_guid_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|osm_queue_guidinfo
argument_list|(
operator|&
name|p_osm
operator|->
name|sa
argument_list|,
name|p_port
argument_list|,
name|gir
operator|->
name|block_num
argument_list|)
expr_stmt|;
name|_out
label|:
name|cl_plock_release
argument_list|(
operator|&
name|p_osm
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_define
define|#
directive|define
name|UNPACK_FUNC
parameter_list|(
name|name
parameter_list|,
name|x
parameter_list|)
define|\
value|static int unpack_##name##x(char *p, uint##x##_t *val_ptr) \ { \ 	char *q; \ 	unsigned long long num; \ 	num = strtoull(p,&q, 16); \ 	if (num> ~((uint##x##_t)0x0) \ 	    || q == p || (!isspace(*q)&& *q != ':')) { \ 		*val_ptr = 0; \ 		return -1; \ 	} \ 	*val_ptr = cl_hton##x((uint##x##_t)num); \ 	return (int)(q - p); \ }
end_define

begin_define
define|#
directive|define
name|cl_hton8
parameter_list|(
name|x
parameter_list|)
value|(x)
end_define

begin_expr_stmt
name|UNPACK_FUNC
argument_list|(
name|net
argument_list|,
literal|8
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|UNPACK_FUNC
argument_list|(
name|net
argument_list|,
literal|16
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|UNPACK_FUNC
argument_list|(
name|net
argument_list|,
literal|32
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|UNPACK_FUNC
argument_list|(
name|net
argument_list|,
literal|64
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|unpack_string
parameter_list|(
name|char
modifier|*
name|p
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|unsigned
name|len
parameter_list|)
block|{
name|char
modifier|*
name|q
init|=
name|p
decl_stmt|;
name|char
name|delim
init|=
literal|' '
decl_stmt|;
if|if
condition|(
operator|*
name|q
operator|==
literal|'\''
operator|||
operator|*
name|q
operator|==
literal|'\"'
condition|)
name|delim
operator|=
operator|*
name|q
operator|++
expr_stmt|;
while|while
condition|(
operator|--
name|len
operator|&&
operator|*
name|q
operator|&&
operator|*
name|q
operator|!=
name|delim
condition|)
operator|*
name|buf
operator|++
operator|=
operator|*
name|q
operator|++
expr_stmt|;
operator|*
name|buf
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|q
operator|==
name|delim
operator|&&
name|delim
operator|!=
literal|' '
condition|)
name|q
operator|++
expr_stmt|;
return|return
call|(
name|int
call|)
argument_list|(
name|q
operator|-
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|unpack_string64
parameter_list|(
name|char
modifier|*
name|p
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|unpack_string
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
literal|64
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|PARSE_AHEAD
parameter_list|(
name|p
parameter_list|,
name|x
parameter_list|,
name|name
parameter_list|,
name|val_ptr
parameter_list|)
value|{ int _ret; \ 	p = strstr(p, name); \ 	if (!p) { \ 		OSM_LOG(&p_osm->log, OSM_LOG_ERROR, \ 			"PARSE ERROR: %s:%u: cannot find \"%s\" string\n", \ 			file_name, lineno, (name)); \ 		ret = -2; \ 		goto _error; \ 	} \ 	p += strlen(name); \ 	_ret = unpack_##x(p, (val_ptr)); \ 	if (_ret< 0) { \ 		OSM_LOG(&p_osm->log, OSM_LOG_ERROR, \ 			"PARSE ERROR: %s:%u: cannot parse "#x" value " \ 			"after \"%s\"\n", file_name, lineno, (name)); \ 		ret = _ret; \ 		goto _error; \ 	} \ 	p += _ret; \ }
end_define

begin_function
specifier|static
name|void
name|sa_db_file_load_handle_mgrp
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
name|osm_mgrp_t
modifier|*
name|p_mgrp
parameter_list|)
block|{
comment|/* decide whether to delete the mgrp object or not */
if|if
condition|(
name|p_mgrp
operator|->
name|full_members
operator|==
literal|0
operator|&&
operator|!
name|p_mgrp
operator|->
name|well_known
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Closing MC group 0x%016"
name|PRIx64
literal|":0x%016"
name|PRIx64
literal|" - no full members were added to not well known "
literal|"group\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|)
expr_stmt|;
name|osm_mgrp_cleanup
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
name|p_mgrp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|osm_sa_db_file_load
parameter_list|(
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|)
block|{
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|file_name
decl_stmt|;
name|FILE
modifier|*
name|file
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|osm_mgrp_t
modifier|*
name|p_next_mgrp
init|=
name|NULL
decl_stmt|;
name|osm_mgrp_t
modifier|*
name|p_prev_mgrp
init|=
name|NULL
decl_stmt|;
name|unsigned
name|rereg_clients
init|=
literal|0
decl_stmt|;
name|unsigned
name|lineno
decl_stmt|;
if|if
condition|(
operator|!
name|p_osm
operator|->
name|subn
operator|.
name|first_time_master_sweep
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Not first sweep - skip SA DB restore\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|file_name
operator|=
name|p_osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|sa_db_file
expr_stmt|;
if|if
condition|(
operator|!
name|file_name
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"sa db file name is not specified. Skip restore\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|file
operator|=
name|fopen
argument_list|(
name|file_name
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|file
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
operator||
name|OSM_LOG_SYS
argument_list|,
literal|"ERR 4C02: "
literal|"Can't open sa db file \'%s\'. Skip restoring\n"
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Restoring SA DB from file \'%s\'\n"
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
name|lineno
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
operator|-
literal|1
argument_list|,
name|file
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|uint8_t
name|val
decl_stmt|;
name|lineno
operator|++
expr_stmt|;
name|p
operator|=
name|line
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'#'
condition|)
continue|continue;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"MC Group"
argument_list|,
literal|8
argument_list|)
condition|)
block|{
name|ib_member_rec_t
name|mcm_rec
decl_stmt|;
name|ib_net16_t
name|mlid
decl_stmt|;
name|p_next_mgrp
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|mcm_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mcm_rec
argument_list|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" 0x"
argument_list|,
operator|&
name|mlid
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" mgid=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|mgid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|mgid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" port_gid=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net32
argument_list|,
literal|" qkey=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|qkey
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" mlid=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|mlid
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" mtu=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|mtu
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" tclass=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|tclass
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" pkey=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|pkey
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" rate=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|rate
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" pkt_life=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|pkt_life
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net32
argument_list|,
literal|" sl_flow_hop=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|sl_flow_hop
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" scope_state=0x"
argument_list|,
operator|&
name|mcm_rec
operator|.
name|scope_state
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" proxy_join=0x"
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|mcm_rec
operator|.
name|proxy_join
operator|=
name|val
expr_stmt|;
name|p_next_mgrp
operator|=
name|load_mcgroup
argument_list|(
name|p_osm
argument_list|,
name|mlid
argument_list|,
operator|&
name|mcm_rec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_next_mgrp
condition|)
name|rereg_clients
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cl_ntoh16
argument_list|(
name|mlid
argument_list|)
operator|>
name|p_osm
operator|->
name|sm
operator|.
name|mlids_init_max
condition|)
name|p_osm
operator|->
name|sm
operator|.
name|mlids_init_max
operator|=
name|cl_ntoh16
argument_list|(
name|mlid
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_next_mgrp
operator|&&
operator|!
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"mcm_port"
argument_list|,
literal|8
argument_list|)
condition|)
block|{
name|ib_member_rec_t
name|mcmr
decl_stmt|;
name|ib_net64_t
name|guid
decl_stmt|;
name|osm_port_t
modifier|*
name|port
decl_stmt|;
name|boolean_t
name|proxy
decl_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" port_gid=0x"
argument_list|,
operator|&
name|mcmr
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|&
name|mcmr
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" scope_state=0x"
argument_list|,
operator|&
name|mcmr
operator|.
name|scope_state
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" proxy_join=0x"
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|proxy
operator|=
name|val
expr_stmt|;
name|guid
operator|=
name|mcmr
operator|.
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
expr_stmt|;
name|port
operator|=
name|osm_get_port_by_alias_guid
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|&&
name|cl_qmap_get
argument_list|(
operator|&
name|p_next_mgrp
operator|->
name|mcm_port_tbl
argument_list|,
name|guid
argument_list|)
operator|==
name|cl_qmap_end
argument_list|(
operator|&
name|p_next_mgrp
operator|->
name|mcm_port_tbl
argument_list|)
operator|&&
operator|!
name|osm_mgrp_add_port
argument_list|(
operator|&
name|p_osm
operator|->
name|subn
argument_list|,
operator|&
name|p_osm
operator|->
name|log
argument_list|,
name|p_next_mgrp
argument_list|,
name|port
argument_list|,
operator|&
name|mcmr
argument_list|,
name|proxy
argument_list|)
condition|)
name|rereg_clients
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"Service Record:"
argument_list|,
literal|15
argument_list|)
condition|)
block|{
name|ib_service_record_t
name|s_rec
decl_stmt|;
name|uint32_t
name|modified_time
decl_stmt|,
name|lease_period
decl_stmt|;
name|p_next_mgrp
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|s_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|s_rec
argument_list|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" id=0x"
argument_list|,
operator|&
name|s_rec
operator|.
name|service_id
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" gid=0x"
argument_list|,
operator|&
name|s_rec
operator|.
name|service_gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|&
name|s_rec
operator|.
name|service_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" pkey=0x"
argument_list|,
operator|&
name|s_rec
operator|.
name|service_pkey
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net32
argument_list|,
literal|" lease=0x"
argument_list|,
operator|&
name|s_rec
operator|.
name|service_lease
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" key=0x"
argument_list|,
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
operator|&
name|s_rec
operator|.
name|service_key
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
operator|&
name|s_rec
operator|.
name|service_key
index|[
literal|8
index|]
operator|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|string64
argument_list|,
literal|" name="
argument_list|,
name|s_rec
operator|.
name|service_name
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" data8=0x"
argument_list|,
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
operator|&
name|s_rec
operator|.
name|service_data8
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
operator|&
name|s_rec
operator|.
name|service_data8
index|[
literal|8
index|]
operator|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" data16=0x"
argument_list|,
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
operator|&
name|s_rec
operator|.
name|service_data16
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
operator|&
name|s_rec
operator|.
name|service_data16
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" data32=0x"
argument_list|,
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
operator|&
name|s_rec
operator|.
name|service_data32
index|[
literal|0
index|]
operator|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|(
name|ib_net64_t
operator|*
operator|)
operator|(
operator|&
name|s_rec
operator|.
name|service_data32
index|[
literal|2
index|]
operator|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" data64=0x"
argument_list|,
operator|&
name|s_rec
operator|.
name|service_data64
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|&
name|s_rec
operator|.
name|service_data64
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net32
argument_list|,
literal|" modified_time=0x"
argument_list|,
operator|&
name|modified_time
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net32
argument_list|,
literal|" lease_period=0x"
argument_list|,
operator|&
name|lease_period
argument_list|)
expr_stmt|;
if|if
condition|(
name|load_svcr
argument_list|(
name|p_osm
argument_list|,
operator|&
name|s_rec
argument_list|,
name|cl_ntoh32
argument_list|(
name|modified_time
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|lease_period
argument_list|)
argument_list|)
condition|)
name|rereg_clients
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"InformInfo Record:"
argument_list|,
literal|18
argument_list|)
condition|)
block|{
name|ib_inform_info_record_t
name|i_rec
decl_stmt|;
name|osm_mad_addr_t
name|rep_addr
decl_stmt|;
name|ib_net16_t
name|val16
decl_stmt|;
name|p_next_mgrp
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|i_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|i_rec
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|rep_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rep_addr
argument_list|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" subscriber_gid=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|subscriber_gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|subscriber_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" subscriber_enum=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|subscriber_enum
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" gid=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|gid
operator|.
name|unicast
operator|.
name|prefix
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|":0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" lid_range_begin=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|lid_range_begin
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" lid_range_end=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|lid_range_end
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" is_generic=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|is_generic
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" subscribe=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|subscribe
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" trap_type=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|trap_type
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" trap_num=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net32
argument_list|,
literal|" qpn_resp_time_val=0x"
argument_list|,
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|qpn_resp_time_val
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net32
argument_list|,
literal|" node_type=0x"
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|i_rec
operator|.
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|reserved2
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" rep_addr: lid=0x"
argument_list|,
operator|&
name|rep_addr
operator|.
name|dest_lid
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" path_bits=0x"
argument_list|,
operator|&
name|rep_addr
operator|.
name|path_bits
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" static_rate=0x"
argument_list|,
operator|&
name|rep_addr
operator|.
name|static_rate
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net32
argument_list|,
literal|" remote_qp=0x"
argument_list|,
operator|&
name|rep_addr
operator|.
name|addr_type
operator|.
name|gsi
operator|.
name|remote_qp
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net32
argument_list|,
literal|" remote_qkey=0x"
argument_list|,
operator|&
name|rep_addr
operator|.
name|addr_type
operator|.
name|gsi
operator|.
name|remote_qkey
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" pkey_ix=0x"
argument_list|,
operator|&
name|val16
argument_list|)
expr_stmt|;
name|rep_addr
operator|.
name|addr_type
operator|.
name|gsi
operator|.
name|pkey_ix
operator|=
name|cl_ntoh16
argument_list|(
name|val16
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" sl=0x"
argument_list|,
operator|&
name|rep_addr
operator|.
name|addr_type
operator|.
name|gsi
operator|.
name|service_level
argument_list|)
expr_stmt|;
if|if
condition|(
name|load_infr
argument_list|(
name|p_osm
argument_list|,
operator|&
name|i_rec
argument_list|,
operator|&
name|rep_addr
argument_list|)
condition|)
name|rereg_clients
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|p
argument_list|,
literal|"GUIDInfo Record:"
argument_list|,
literal|16
argument_list|)
condition|)
block|{
name|ib_guidinfo_record_t
name|gi_rec
decl_stmt|;
name|ib_net64_t
name|base_guid
decl_stmt|;
name|p_next_mgrp
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|gi_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gi_rec
argument_list|)
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" base_guid=0x"
argument_list|,
operator|&
name|base_guid
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net16
argument_list|,
literal|" lid=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|lid
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net8
argument_list|,
literal|" block_num=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|block_num
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" guid0=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|guid_info
operator|.
name|guid
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" guid1=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|guid_info
operator|.
name|guid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" guid2=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|guid_info
operator|.
name|guid
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" guid3=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|guid_info
operator|.
name|guid
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" guid4=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|guid_info
operator|.
name|guid
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" guid5=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|guid_info
operator|.
name|guid
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" guid6=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|guid_info
operator|.
name|guid
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|PARSE_AHEAD
argument_list|(
name|p
argument_list|,
name|net64
argument_list|,
literal|" guid7=0x"
argument_list|,
operator|&
name|gi_rec
operator|.
name|guid_info
operator|.
name|guid
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|load_guidinfo
argument_list|(
name|p_osm
argument_list|,
name|base_guid
argument_list|,
operator|&
name|gi_rec
argument_list|)
condition|)
name|rereg_clients
operator|=
literal|1
expr_stmt|;
block|}
comment|/* 		 * p_next_mgrp points to the multicast group now being parsed. 		 * p_prev_mgrp points to the last multicast group we parsed. 		 * We decide whether to keep or delete each multicast group 		 * only when we finish parsing it's member records. if the 		 * group has full members, or it is a "well known group" we 		 * keep it. 		 */
if|if
condition|(
name|p_prev_mgrp
operator|!=
name|p_next_mgrp
condition|)
block|{
if|if
condition|(
name|p_prev_mgrp
condition|)
name|sa_db_file_load_handle_mgrp
argument_list|(
name|p_osm
argument_list|,
name|p_prev_mgrp
argument_list|)
expr_stmt|;
name|p_prev_mgrp
operator|=
name|p_next_mgrp
expr_stmt|;
block|}
block|}
if|if
condition|(
name|p_next_mgrp
condition|)
name|sa_db_file_load_handle_mgrp
argument_list|(
name|p_osm
argument_list|,
name|p_prev_mgrp
argument_list|)
expr_stmt|;
comment|/* 	 * If loading succeeded, do whatever 'no_clients_rereg' says. 	 * If loading failed at some point, turn off the 'no_clients_rereg' 	 * option (turn on re-registration requests). 	 */
if|if
condition|(
name|rereg_clients
condition|)
name|p_osm
operator|->
name|subn
operator|.
name|opt
operator|.
name|no_clients_rereg
operator|=
name|FALSE
expr_stmt|;
comment|/* We've just finished loading SA DB file - clear the "dirty" flag */
name|p_osm
operator|->
name|sa
operator|.
name|dirty
operator|=
name|FALSE
expr_stmt|;
name|_error
label|:
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


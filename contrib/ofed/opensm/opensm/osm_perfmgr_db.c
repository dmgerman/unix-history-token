begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2008-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2007 The Regents of the University of California.  * Copyright (c) 2009 HNR Consulting. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
end_ifdef

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_file_ids.h>
end_include

begin_define
define|#
directive|define
name|FILE_ID
value|OSM_FILE_PERFMGR_DB_C
end_define

begin_include
include|#
directive|include
file|<opensm/osm_perfmgr_db.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_perfmgr.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_opensm.h>
end_include

begin_function_decl
specifier|static
name|void
name|free_node
parameter_list|(
name|db_node_t
modifier|*
name|node
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/** =========================================================================  */
end_comment

begin_function
name|perfmgr_db_t
modifier|*
name|perfmgr_db_construct
parameter_list|(
name|osm_perfmgr_t
modifier|*
name|perfmgr
parameter_list|)
block|{
name|perfmgr_db_t
modifier|*
name|db
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|db
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|db
condition|)
return|return
name|NULL
return|;
name|cl_qmap_init
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
expr_stmt|;
name|cl_plock_construct
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cl_plock_init
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|db
operator|->
name|perfmgr
operator|=
name|perfmgr
expr_stmt|;
return|return
name|db
return|;
block|}
end_function

begin_comment
comment|/** =========================================================================  */
end_comment

begin_function
name|void
name|perfmgr_db_destroy
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|item
decl_stmt|,
modifier|*
name|next_item
decl_stmt|;
if|if
condition|(
name|db
condition|)
block|{
name|item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
expr_stmt|;
while|while
condition|(
name|item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
condition|)
block|{
name|next_item
operator|=
name|cl_qmap_next
argument_list|(
name|item
argument_list|)
expr_stmt|;
name|free_node
argument_list|(
operator|(
name|db_node_t
operator|*
operator|)
name|item
argument_list|)
expr_stmt|;
name|item
operator|=
name|next_item
expr_stmt|;
block|}
name|cl_plock_destroy
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  * Internal call db->lock should be held when calling  **********************************************************************/
end_comment

begin_function
specifier|static
specifier|inline
name|db_node_t
modifier|*
name|get
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|rc
init|=
name|cl_qmap_get
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|,
name|guid
argument_list|)
decl_stmt|;
specifier|const
name|cl_map_item_t
modifier|*
name|end
init|=
name|cl_qmap_end
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|==
name|end
condition|)
return|return
name|NULL
return|;
return|return
operator|(
name|db_node_t
operator|*
operator|)
name|rc
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|perfmgr_db_err_t
name|bad_node_port
parameter_list|(
name|db_node_t
modifier|*
name|node
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
if|if
condition|(
operator|!
name|node
condition|)
return|return
name|PERFMGR_EVENT_DB_GUIDNOTFOUND
return|;
if|if
condition|(
name|port
operator|>=
name|node
operator|->
name|num_ports
operator|||
operator|(
operator|!
name|node
operator|->
name|esp0
operator|&&
name|port
operator|==
literal|0
operator|)
condition|)
return|return
name|PERFMGR_EVENT_DB_PORTNOTFOUND
return|;
return|return
name|PERFMGR_EVENT_DB_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|mark_port_valid
parameter_list|(
name|db_node_t
modifier|*
name|node
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|valid
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_comment
comment|/** =========================================================================  */
end_comment

begin_function
specifier|static
name|db_node_t
modifier|*
name|malloc_node
parameter_list|(
name|uint64_t
name|guid
parameter_list|,
name|boolean_t
name|esp0
parameter_list|,
name|uint8_t
name|num_ports
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|time_t
name|cur_time
init|=
literal|0
decl_stmt|;
name|db_node_t
modifier|*
name|rc
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rc
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
return|return
name|NULL
return|;
name|rc
operator|->
name|ports
operator|=
name|calloc
argument_list|(
name|num_ports
argument_list|,
sizeof|sizeof
argument_list|(
name|db_port_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
operator|->
name|ports
condition|)
goto|goto
name|free_rc
goto|;
name|rc
operator|->
name|num_ports
operator|=
name|num_ports
expr_stmt|;
name|rc
operator|->
name|node_guid
operator|=
name|guid
expr_stmt|;
name|rc
operator|->
name|esp0
operator|=
name|esp0
expr_stmt|;
name|cur_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|last_reset
operator|=
name|cur_time
expr_stmt|;
name|rc
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_previous
operator|.
name|time
operator|=
name|cur_time
expr_stmt|;
name|rc
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_previous
operator|.
name|time
operator|=
name|cur_time
expr_stmt|;
name|rc
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|valid
operator|=
name|FALSE
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|rc
operator|->
name|node_name
argument_list|,
sizeof|sizeof
argument_list|(
name|rc
operator|->
name|node_name
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|rc
operator|->
name|active
operator|=
name|FALSE
expr_stmt|;
return|return
name|rc
return|;
name|free_rc
label|:
name|free
argument_list|(
name|rc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/** =========================================================================  */
end_comment

begin_function
specifier|static
name|void
name|free_node
parameter_list|(
name|db_node_t
modifier|*
name|node
parameter_list|)
block|{
if|if
condition|(
operator|!
name|node
condition|)
return|return;
if|if
condition|(
name|node
operator|->
name|ports
condition|)
name|free
argument_list|(
name|node
operator|->
name|ports
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* insert nodes to the database */
end_comment

begin_function
specifier|static
name|perfmgr_db_err_t
name|insert
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|db_node_t
modifier|*
name|node
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|rc
init|=
name|cl_qmap_insert
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|,
name|node
operator|->
name|node_guid
argument_list|,
operator|(
name|cl_map_item_t
operator|*
operator|)
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|void
operator|*
operator|)
name|rc
operator|!=
operator|(
name|void
operator|*
operator|)
name|node
condition|)
return|return
name|PERFMGR_EVENT_DB_FAIL
return|;
return|return
name|PERFMGR_EVENT_DB_SUCCESS
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_create_entry
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|boolean_t
name|esp0
parameter_list|,
name|uint8_t
name|num_ports
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
condition|)
block|{
name|db_node_t
modifier|*
name|pc_node
init|=
name|malloc_node
argument_list|(
name|guid
argument_list|,
name|esp0
argument_list|,
name|num_ports
argument_list|,
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|pc_node
condition|)
block|{
name|rc
operator|=
name|PERFMGR_EVENT_DB_NOMEM
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
if|if
condition|(
name|insert
argument_list|(
name|db
argument_list|,
name|pc_node
argument_list|)
condition|)
block|{
name|free_node
argument_list|(
name|pc_node
argument_list|)
expr_stmt|;
name|rc
operator|=
name|PERFMGR_EVENT_DB_FAIL
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_update_name
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|node_guid
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|=
name|get
argument_list|(
name|db
argument_list|,
name|node_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
name|snprintf
argument_list|(
name|node
operator|->
name|node_name
argument_list|,
sizeof|sizeof
argument_list|(
name|node
operator|->
name|node_name
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|PERFMGR_EVENT_DB_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_delete_entry
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|rc
init|=
name|cl_qmap_remove
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|,
name|guid
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|==
name|cl_qmap_end
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
condition|)
return|return
operator|(
name|PERFMGR_EVENT_DB_GUIDNOTFOUND
operator|)
return|;
name|db_node_t
modifier|*
name|pc_node
init|=
operator|(
name|db_node_t
operator|*
operator|)
name|rc
decl_stmt|;
name|free_node
argument_list|(
name|pc_node
argument_list|)
expr_stmt|;
return|return
operator|(
name|PERFMGR_EVENT_DB_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_delete_inactive
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|unsigned
modifier|*
name|cnt
parameter_list|)
block|{
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|num
init|=
literal|0
decl_stmt|;
name|uint64_t
modifier|*
name|guid_list
init|=
name|NULL
decl_stmt|;
name|cl_map_item_t
modifier|*
name|p_map_item
init|=
name|cl_qmap_head
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
decl_stmt|;
if|if
condition|(
name|p_map_item
operator|==
name|cl_qmap_end
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
condition|)
block|{
name|rc
operator|=
name|PERFMGR_EVENT_DB_SUCCESS
expr_stmt|;
goto|goto
name|Done
goto|;
block|}
while|while
condition|(
name|p_map_item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
condition|)
block|{
name|db_node_t
modifier|*
name|n
init|=
operator|(
name|db_node_t
operator|*
operator|)
name|p_map_item
decl_stmt|;
if|if
condition|(
name|n
operator|->
name|active
operator|==
name|FALSE
condition|)
block|{
name|guid_list
operator|=
name|realloc
argument_list|(
name|guid_list
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|guid_list
argument_list|)
operator|*
operator|(
name|num
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|guid_list
condition|)
block|{
name|num
operator|=
literal|0
expr_stmt|;
name|rc
operator|=
name|PERFMGR_EVENT_DB_NOMEM
expr_stmt|;
goto|goto
name|Done
goto|;
block|}
name|guid_list
index|[
name|num
index|]
operator|=
name|n
operator|->
name|node_guid
expr_stmt|;
name|num
operator|++
expr_stmt|;
block|}
name|p_map_item
operator|=
name|cl_qmap_next
argument_list|(
name|p_map_item
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
name|perfmgr_db_delete_entry
argument_list|(
name|db
argument_list|,
name|guid_list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|guid_list
argument_list|)
expr_stmt|;
name|Done
label|:
if|if
condition|(
name|cnt
condition|)
operator|*
name|cnt
operator|=
name|num
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_mark_active
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|boolean_t
name|active
parameter_list|)
block|{
name|db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|=
name|get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
name|node
operator|->
name|active
operator|=
name|active
expr_stmt|;
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|PERFMGR_EVENT_DB_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Dump a reading vs the previous reading to stdout  **********************************************************************/
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|debug_dump_err_reading
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port_num
parameter_list|,
name|db_port_t
modifier|*
name|port
parameter_list|,
name|perfmgr_db_err_reading_t
modifier|*
name|cur
parameter_list|)
block|{
name|osm_log_t
modifier|*
name|log
init|=
name|db
operator|->
name|perfmgr
operator|->
name|log
decl_stmt|;
if|if
condition|(
operator|!
name|OSM_LOG_IS_ACTIVE_V2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
condition|)
return|return;
comment|/* optimize this a bit */
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"GUID 0x%"
name|PRIx64
literal|" Port %u:\n"
argument_list|,
name|guid
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"sym %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|symbol_err_cnt
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|symbol_err_cnt
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|symbol_err_cnt
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"ler %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|link_err_recover
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|link_err_recover
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|link_err_recover
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"ld %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|link_downed
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|link_downed
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|link_downed
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"re %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|rcv_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|rcv_err
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"rrp %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_rem_phys_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|rcv_rem_phys_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|rcv_rem_phys_err
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"rsr %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_switch_relay_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|rcv_switch_relay_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|rcv_switch_relay_err
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"xd %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|xmit_discards
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|xmit_discards
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|xmit_discards
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"xce %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|xmit_constraint_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|xmit_constraint_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|xmit_constraint_err
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"rce %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_constraint_err
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|rcv_constraint_err
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|rcv_constraint_err
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"li %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|link_integrity
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|link_integrity
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|link_integrity
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"bo %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|buffer_overrun
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|buffer_overrun
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|buffer_overrun
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"vld %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|vl15_dropped
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|vl15_dropped
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|vl15_dropped
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"xw %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|xmit_wait
argument_list|,
name|port
operator|->
name|err_previous
operator|.
name|xmit_wait
argument_list|,
name|port
operator|->
name|err_total
operator|.
name|xmit_wait
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * perfmgr_db_err_reading_t functions  **********************************************************************/
end_comment

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_add_err_reading
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|perfmgr_db_err_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|db_port_t
modifier|*
name|p_port
init|=
name|NULL
decl_stmt|;
name|db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_reading_t
modifier|*
name|previous
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|osm_epi_pe_event_t
name|epi_pe_data
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|=
name|get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|mark_port_valid
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|p_port
operator|=
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|)
expr_stmt|;
name|previous
operator|=
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|err_previous
operator|)
expr_stmt|;
name|debug_dump_err_reading
argument_list|(
name|db
argument_list|,
name|guid
argument_list|,
name|port
argument_list|,
name|p_port
argument_list|,
name|reading
argument_list|)
expr_stmt|;
name|epi_pe_data
operator|.
name|time_diff_s
operator|=
operator|(
name|reading
operator|->
name|time
operator|-
name|previous
operator|->
name|time
operator|)
expr_stmt|;
name|osm_epi_create_port_id
argument_list|(
operator|&
name|epi_pe_data
operator|.
name|port_id
argument_list|,
name|guid
argument_list|,
name|port
argument_list|,
name|node
operator|->
name|node_name
argument_list|)
expr_stmt|;
comment|/* calculate changes from previous reading */
name|epi_pe_data
operator|.
name|symbol_err_cnt
operator|=
operator|(
name|reading
operator|->
name|symbol_err_cnt
operator|-
name|previous
operator|->
name|symbol_err_cnt
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|symbol_err_cnt
operator|+=
name|epi_pe_data
operator|.
name|symbol_err_cnt
expr_stmt|;
name|epi_pe_data
operator|.
name|link_err_recover
operator|=
operator|(
name|reading
operator|->
name|link_err_recover
operator|-
name|previous
operator|->
name|link_err_recover
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|link_err_recover
operator|+=
name|epi_pe_data
operator|.
name|link_err_recover
expr_stmt|;
name|epi_pe_data
operator|.
name|link_downed
operator|=
operator|(
name|reading
operator|->
name|link_downed
operator|-
name|previous
operator|->
name|link_downed
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|link_downed
operator|+=
name|epi_pe_data
operator|.
name|link_downed
expr_stmt|;
name|epi_pe_data
operator|.
name|rcv_err
operator|=
operator|(
name|reading
operator|->
name|rcv_err
operator|-
name|previous
operator|->
name|rcv_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|rcv_err
operator|+=
name|epi_pe_data
operator|.
name|rcv_err
expr_stmt|;
name|epi_pe_data
operator|.
name|rcv_rem_phys_err
operator|=
operator|(
name|reading
operator|->
name|rcv_rem_phys_err
operator|-
name|previous
operator|->
name|rcv_rem_phys_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|rcv_rem_phys_err
operator|+=
name|epi_pe_data
operator|.
name|rcv_rem_phys_err
expr_stmt|;
name|epi_pe_data
operator|.
name|rcv_switch_relay_err
operator|=
operator|(
name|reading
operator|->
name|rcv_switch_relay_err
operator|-
name|previous
operator|->
name|rcv_switch_relay_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|rcv_switch_relay_err
operator|+=
name|epi_pe_data
operator|.
name|rcv_switch_relay_err
expr_stmt|;
name|epi_pe_data
operator|.
name|xmit_discards
operator|=
operator|(
name|reading
operator|->
name|xmit_discards
operator|-
name|previous
operator|->
name|xmit_discards
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|xmit_discards
operator|+=
name|epi_pe_data
operator|.
name|xmit_discards
expr_stmt|;
name|epi_pe_data
operator|.
name|xmit_constraint_err
operator|=
operator|(
name|reading
operator|->
name|xmit_constraint_err
operator|-
name|previous
operator|->
name|xmit_constraint_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|xmit_constraint_err
operator|+=
name|epi_pe_data
operator|.
name|xmit_constraint_err
expr_stmt|;
name|epi_pe_data
operator|.
name|rcv_constraint_err
operator|=
operator|(
name|reading
operator|->
name|rcv_constraint_err
operator|-
name|previous
operator|->
name|rcv_constraint_err
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|rcv_constraint_err
operator|+=
name|epi_pe_data
operator|.
name|rcv_constraint_err
expr_stmt|;
name|epi_pe_data
operator|.
name|link_integrity
operator|=
operator|(
name|reading
operator|->
name|link_integrity
operator|-
name|previous
operator|->
name|link_integrity
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|link_integrity
operator|+=
name|epi_pe_data
operator|.
name|link_integrity
expr_stmt|;
name|epi_pe_data
operator|.
name|buffer_overrun
operator|=
operator|(
name|reading
operator|->
name|buffer_overrun
operator|-
name|previous
operator|->
name|buffer_overrun
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|buffer_overrun
operator|+=
name|epi_pe_data
operator|.
name|buffer_overrun
expr_stmt|;
name|epi_pe_data
operator|.
name|vl15_dropped
operator|=
operator|(
name|reading
operator|->
name|vl15_dropped
operator|-
name|previous
operator|->
name|vl15_dropped
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|vl15_dropped
operator|+=
name|epi_pe_data
operator|.
name|vl15_dropped
expr_stmt|;
name|epi_pe_data
operator|.
name|xmit_wait
operator|=
operator|(
name|reading
operator|->
name|xmit_wait
operator|-
name|previous
operator|->
name|xmit_wait
operator|)
expr_stmt|;
name|p_port
operator|->
name|err_total
operator|.
name|xmit_wait
operator|+=
name|epi_pe_data
operator|.
name|xmit_wait
expr_stmt|;
name|p_port
operator|->
name|err_previous
operator|=
operator|*
name|reading
expr_stmt|;
comment|/* mark the time this total was updated */
name|p_port
operator|->
name|err_total
operator|.
name|time
operator|=
name|reading
operator|->
name|time
expr_stmt|;
name|osm_opensm_report_event
argument_list|(
name|db
operator|->
name|perfmgr
operator|->
name|osm
argument_list|,
name|OSM_EVENT_ID_PORT_ERRORS
argument_list|,
operator|&
name|epi_pe_data
argument_list|)
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_get_prev_err
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|perfmgr_db_err_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|=
name|get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
operator|*
name|reading
operator|=
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|err_previous
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_clear_prev_err
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_reading_t
modifier|*
name|previous
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|=
name|get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|previous
operator|=
operator|&
operator|(
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|err_previous
operator|)
expr_stmt|;
name|memset
argument_list|(
name|previous
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|previous
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|err_previous
operator|.
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|debug_dump_dc_reading
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port_num
parameter_list|,
name|db_port_t
modifier|*
name|port
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|cur
parameter_list|)
block|{
name|osm_log_t
modifier|*
name|log
init|=
name|db
operator|->
name|perfmgr
operator|->
name|log
decl_stmt|;
if|if
condition|(
operator|!
name|OSM_LOG_IS_ACTIVE_V2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
condition|)
return|return;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"xd %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|xmit_data
argument_list|,
name|port
operator|->
name|dc_previous
operator|.
name|xmit_data
argument_list|,
name|port
operator|->
name|dc_total
operator|.
name|xmit_data
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"rd %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_data
argument_list|,
name|port
operator|->
name|dc_previous
operator|.
name|rcv_data
argument_list|,
name|port
operator|->
name|dc_total
operator|.
name|rcv_data
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"xp %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|xmit_pkts
argument_list|,
name|port
operator|->
name|dc_previous
operator|.
name|xmit_pkts
argument_list|,
name|port
operator|->
name|dc_total
operator|.
name|xmit_pkts
argument_list|)
expr_stmt|;
name|osm_log_v2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
name|FILE_ID
argument_list|,
literal|"rp %"
name|PRIu64
literal|"<-- %"
name|PRIu64
literal|" (%"
name|PRIu64
literal|")\n"
argument_list|,
name|cur
operator|->
name|rcv_pkts
argument_list|,
name|port
operator|->
name|dc_previous
operator|.
name|rcv_pkts
argument_list|,
name|port
operator|->
name|dc_total
operator|.
name|rcv_pkts
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * perfmgr_db_data_cnt_reading_t functions  **********************************************************************/
end_comment

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_add_dc_reading
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|reading
parameter_list|,
name|int
name|ietf_sup
parameter_list|)
block|{
name|db_port_t
modifier|*
name|p_port
init|=
name|NULL
decl_stmt|;
name|db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|previous
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|osm_epi_dc_event_t
name|epi_dc_data
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|=
name|get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|mark_port_valid
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|p_port
operator|=
operator|&
name|node
operator|->
name|ports
index|[
name|port
index|]
expr_stmt|;
name|previous
operator|=
operator|&
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|dc_previous
expr_stmt|;
name|debug_dump_dc_reading
argument_list|(
name|db
argument_list|,
name|guid
argument_list|,
name|port
argument_list|,
name|p_port
argument_list|,
name|reading
argument_list|)
expr_stmt|;
name|epi_dc_data
operator|.
name|time_diff_s
operator|=
name|reading
operator|->
name|time
operator|-
name|previous
operator|->
name|time
expr_stmt|;
name|osm_epi_create_port_id
argument_list|(
operator|&
name|epi_dc_data
operator|.
name|port_id
argument_list|,
name|guid
argument_list|,
name|port
argument_list|,
name|node
operator|->
name|node_name
argument_list|)
expr_stmt|;
comment|/* calculate changes from previous reading */
name|epi_dc_data
operator|.
name|xmit_data
operator|=
name|reading
operator|->
name|xmit_data
operator|-
name|previous
operator|->
name|xmit_data
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|xmit_data
operator|+=
name|epi_dc_data
operator|.
name|xmit_data
expr_stmt|;
name|epi_dc_data
operator|.
name|rcv_data
operator|=
name|reading
operator|->
name|rcv_data
operator|-
name|previous
operator|->
name|rcv_data
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|rcv_data
operator|+=
name|epi_dc_data
operator|.
name|rcv_data
expr_stmt|;
name|epi_dc_data
operator|.
name|xmit_pkts
operator|=
name|reading
operator|->
name|xmit_pkts
operator|-
name|previous
operator|->
name|xmit_pkts
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|xmit_pkts
operator|+=
name|epi_dc_data
operator|.
name|xmit_pkts
expr_stmt|;
name|epi_dc_data
operator|.
name|rcv_pkts
operator|=
name|reading
operator|->
name|rcv_pkts
operator|-
name|previous
operator|->
name|rcv_pkts
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|rcv_pkts
operator|+=
name|epi_dc_data
operator|.
name|rcv_pkts
expr_stmt|;
if|if
condition|(
name|ietf_sup
condition|)
block|{
name|epi_dc_data
operator|.
name|unicast_xmit_pkts
operator|=
name|reading
operator|->
name|unicast_xmit_pkts
operator|-
name|previous
operator|->
name|unicast_xmit_pkts
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|unicast_xmit_pkts
operator|+=
name|epi_dc_data
operator|.
name|unicast_xmit_pkts
expr_stmt|;
name|epi_dc_data
operator|.
name|unicast_rcv_pkts
operator|=
name|reading
operator|->
name|unicast_rcv_pkts
operator|-
name|previous
operator|->
name|unicast_rcv_pkts
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|unicast_rcv_pkts
operator|+=
name|epi_dc_data
operator|.
name|unicast_rcv_pkts
expr_stmt|;
name|epi_dc_data
operator|.
name|multicast_xmit_pkts
operator|=
name|reading
operator|->
name|multicast_xmit_pkts
operator|-
name|previous
operator|->
name|multicast_xmit_pkts
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|multicast_xmit_pkts
operator|+=
name|epi_dc_data
operator|.
name|multicast_xmit_pkts
expr_stmt|;
name|epi_dc_data
operator|.
name|multicast_rcv_pkts
operator|=
name|reading
operator|->
name|multicast_rcv_pkts
operator|-
name|previous
operator|->
name|multicast_rcv_pkts
expr_stmt|;
name|p_port
operator|->
name|dc_total
operator|.
name|multicast_rcv_pkts
operator|+=
name|epi_dc_data
operator|.
name|multicast_rcv_pkts
expr_stmt|;
block|}
name|p_port
operator|->
name|dc_previous
operator|=
operator|*
name|reading
expr_stmt|;
comment|/* mark the time this total was updated */
name|p_port
operator|->
name|dc_total
operator|.
name|time
operator|=
name|reading
operator|->
name|time
expr_stmt|;
name|osm_opensm_report_event
argument_list|(
name|db
operator|->
name|perfmgr
operator|->
name|osm
argument_list|,
name|OSM_EVENT_ID_PORT_DATA_COUNTERS
argument_list|,
operator|&
name|epi_dc_data
argument_list|)
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_get_prev_dc
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|=
name|get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
operator|*
name|reading
operator|=
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|dc_previous
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_clear_prev_dc
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|guid
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|db_node_t
modifier|*
name|node
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|previous
init|=
name|NULL
decl_stmt|;
name|perfmgr_db_err_t
name|rc
init|=
name|PERFMGR_EVENT_DB_SUCCESS
decl_stmt|;
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|=
name|get
argument_list|(
name|db
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|bad_node_port
argument_list|(
name|node
argument_list|,
name|port
argument_list|)
operator|)
operator|!=
name|PERFMGR_EVENT_DB_SUCCESS
condition|)
goto|goto
name|Exit
goto|;
name|previous
operator|=
operator|&
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|dc_previous
expr_stmt|;
name|memset
argument_list|(
name|previous
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|previous
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|dc_previous
operator|.
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|Exit
label|:
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|clear_counters
parameter_list|(
name|cl_map_item_t
modifier|*
specifier|const
name|p_map_item
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|db_node_t
modifier|*
name|node
init|=
operator|(
name|db_node_t
operator|*
operator|)
name|p_map_item
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|time_t
name|ts
init|=
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|node
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|symbol_err_cnt
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_err_recover
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_downed
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_rem_phys_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_switch_relay_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_discards
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_constraint_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_constraint_err
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_integrity
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|buffer_overrun
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|vl15_dropped
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_wait
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|time
operator|=
name|ts
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_data
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_data
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_xmit_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_rcv_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_xmit_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_rcv_pkts
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|time
operator|=
name|ts
expr_stmt|;
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|last_reset
operator|=
name|ts
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  * Clear all the counters from the db  **********************************************************************/
end_comment

begin_function
name|void
name|perfmgr_db_clear_counters
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|)
block|{
name|cl_plock_excl_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cl_qmap_apply_func
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|,
name|clear_counters
argument_list|,
operator|(
name|void
operator|*
operator|)
name|db
argument_list|)
expr_stmt|;
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (db->db_impl->clear_counters) 		db->db_impl->clear_counters(db->db_data);
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**********************************************************************  * Output a tab delimited output of the port counters  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|dump_node_mr
parameter_list|(
name|db_node_t
modifier|*
name|node
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\nName\tGUID\tActive\tPort\tLast Reset\t"
literal|"Last Error Update\tLast Data Update\t"
literal|"%s\t%s\t"
literal|"%s\t%s\t%s\t%s\t%s\t%s\t%s\t"
literal|"%s\t%s\t%s\t%s\t%s\t%s\t%s\t"
literal|"%s\t%s\t%s\t%s\t%s\n"
argument_list|,
literal|"symbol_err_cnt"
argument_list|,
literal|"link_err_recover"
argument_list|,
literal|"link_downed"
argument_list|,
literal|"rcv_err"
argument_list|,
literal|"rcv_rem_phys_err"
argument_list|,
literal|"rcv_switch_relay_err"
argument_list|,
literal|"xmit_discards"
argument_list|,
literal|"xmit_constraint_err"
argument_list|,
literal|"rcv_constraint_err"
argument_list|,
literal|"link_int_err"
argument_list|,
literal|"buf_overrun_err"
argument_list|,
literal|"vl15_dropped"
argument_list|,
literal|"xmit_wait"
argument_list|,
literal|"xmit_data"
argument_list|,
literal|"rcv_data"
argument_list|,
literal|"xmit_pkts"
argument_list|,
literal|"rcv_pkts"
argument_list|,
literal|"unicast_xmit_pkts"
argument_list|,
literal|"unicast_rcv_pkts"
argument_list|,
literal|"multicast_xmit_pkts"
argument_list|,
literal|"multicast_rcv_pkts"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
operator|(
name|node
operator|->
name|esp0
operator|)
condition|?
literal|0
else|:
literal|1
init|;
name|i
operator|<
name|node
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|char
name|lr
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|last_reset
init|=
name|ctime_r
argument_list|(
operator|&
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|last_reset
argument_list|,
name|lr
argument_list|)
decl_stmt|;
name|char
name|leu
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|last_err_update
init|=
name|ctime_r
argument_list|(
operator|&
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|time
argument_list|,
name|leu
argument_list|)
decl_stmt|;
name|char
name|ldu
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|last_data_update
init|=
name|ctime_r
argument_list|(
operator|&
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|time
argument_list|,
name|ldu
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|valid
condition|)
continue|continue;
name|last_reset
index|[
name|strlen
argument_list|(
name|last_reset
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* remove \n */
name|last_err_update
index|[
name|strlen
argument_list|(
name|last_err_update
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* remove \n */
name|last_data_update
index|[
name|strlen
argument_list|(
name|last_data_update
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* remove \n */
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s\t0x%"
name|PRIx64
literal|"\t%s\t%d\t%s\t%s\t%s\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t"
literal|"%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\t%"
name|PRIu64
literal|"\n"
argument_list|,
name|node
operator|->
name|node_name
argument_list|,
name|node
operator|->
name|node_guid
argument_list|,
name|node
operator|->
name|active
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|i
argument_list|,
name|last_reset
argument_list|,
name|last_err_update
argument_list|,
name|last_data_update
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|symbol_err_cnt
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_err_recover
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_downed
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_rem_phys_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_switch_relay_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_discards
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_constraint_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|rcv_constraint_err
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|link_integrity
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|buffer_overrun
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|vl15_dropped
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|xmit_wait
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_data
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_data
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_xmit_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_rcv_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_xmit_pkts
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_rcv_pkts
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_hr_dc
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|uint64_t
name|val64
parameter_list|,
name|int
name|data
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|unit
init|=
literal|""
decl_stmt|;
name|uint64_t
name|tmp
init|=
name|val64
decl_stmt|;
name|float
name|val
init|=
literal|0.0
decl_stmt|;
name|int
name|ui
init|=
literal|0
decl_stmt|;
name|uint64_t
name|div
init|=
literal|1
decl_stmt|;
name|tmp
operator|/=
literal|1024
expr_stmt|;
while|while
condition|(
name|tmp
condition|)
block|{
name|ui
operator|++
expr_stmt|;
name|tmp
operator|/=
literal|1024
expr_stmt|;
name|div
operator|*=
literal|1024
expr_stmt|;
block|}
name|val
operator|=
call|(
name|float
call|)
argument_list|(
name|val64
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|val
operator|*=
literal|4
expr_stmt|;
if|if
condition|(
name|val
operator|/
name|div
operator|>
literal|1024
condition|)
block|{
name|ui
operator|++
expr_stmt|;
name|div
operator|*=
literal|1024
expr_stmt|;
block|}
block|}
name|val
operator|/=
name|div
expr_stmt|;
switch|switch
condition|(
name|ui
condition|)
block|{
case|case
literal|1
case|:
name|unit
operator|=
literal|"K"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|unit
operator|=
literal|"M"
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|unit
operator|=
literal|"G"
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|unit
operator|=
literal|"T"
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|unit
operator|=
literal|"P"
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|unit
operator|=
literal|"E"
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" (%5.3f%s%s)\n"
argument_list|,
name|val
argument_list|,
name|unit
argument_list|,
name|data
condition|?
literal|"B"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Output a human readable output of the port counters  **********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|dump_node_hr
parameter_list|(
name|db_node_t
modifier|*
name|node
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|char
modifier|*
name|port
parameter_list|,
name|int
name|err_only
parameter_list|)
block|{
name|int
name|i
init|=
operator|(
name|node
operator|->
name|esp0
operator|)
condition|?
literal|0
else|:
literal|1
decl_stmt|;
name|int
name|num_ports
init|=
name|node
operator|->
name|num_ports
decl_stmt|;
if|if
condition|(
name|port
condition|)
block|{
name|char
modifier|*
name|end
init|=
name|NULL
decl_stmt|;
name|int
name|p
init|=
name|strtoul
argument_list|(
name|port
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|port
operator|+
name|strlen
argument_list|(
name|port
argument_list|)
operator|==
name|end
operator|&&
name|p
operator|>=
name|i
operator|&&
name|p
operator|<
name|num_ports
condition|)
block|{
name|i
operator|=
name|p
expr_stmt|;
name|num_ports
operator|=
name|p
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Warning: \"%s\" is not a valid port\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
comment|/* set above */
init|;
name|i
operator|<
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|char
name|lr
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|last_reset
init|=
name|ctime_r
argument_list|(
operator|&
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|last_reset
argument_list|,
name|lr
argument_list|)
decl_stmt|;
name|char
name|leu
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|last_err_update
init|=
name|ctime_r
argument_list|(
operator|&
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
operator|.
name|time
argument_list|,
name|leu
argument_list|)
decl_stmt|;
name|char
name|ldu
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|last_data_update
init|=
name|ctime_r
argument_list|(
operator|&
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|time
argument_list|,
name|ldu
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|valid
condition|)
continue|continue;
name|last_reset
index|[
name|strlen
argument_list|(
name|last_reset
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* remove \n */
name|last_err_update
index|[
name|strlen
argument_list|(
name|last_err_update
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* remove \n */
name|last_data_update
index|[
name|strlen
argument_list|(
name|last_data_update
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* remove \n */
name|perfmgr_db_err_reading_t
modifier|*
name|err
init|=
operator|&
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|err_total
decl_stmt|;
if|if
condition|(
name|err_only
operator|&&
name|err
operator|->
name|symbol_err_cnt
operator|==
literal|0
operator|&&
name|err
operator|->
name|link_err_recover
operator|==
literal|0
operator|&&
name|err
operator|->
name|link_downed
operator|==
literal|0
operator|&&
name|err
operator|->
name|rcv_err
operator|==
literal|0
operator|&&
name|err
operator|->
name|rcv_rem_phys_err
operator|==
literal|0
operator|&&
name|err
operator|->
name|rcv_switch_relay_err
operator|==
literal|0
operator|&&
name|err
operator|->
name|xmit_discards
operator|==
literal|0
operator|&&
name|err
operator|->
name|xmit_constraint_err
operator|==
literal|0
operator|&&
name|err
operator|->
name|rcv_constraint_err
operator|==
literal|0
operator|&&
name|err
operator|->
name|link_integrity
operator|==
literal|0
operator|&&
name|err
operator|->
name|buffer_overrun
operator|==
literal|0
operator|&&
name|err
operator|->
name|vl15_dropped
operator|==
literal|0
operator|&&
name|err
operator|->
name|xmit_wait
operator|==
literal|0
condition|)
continue|continue;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\"%s\" 0x%"
name|PRIx64
literal|" active %s port %d\n"
literal|"     Last Reset           : %s\n"
literal|"     Last Error Update    : %s\n"
argument_list|,
name|node
operator|->
name|node_name
argument_list|,
name|node
operator|->
name|node_guid
argument_list|,
name|node
operator|->
name|active
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|i
argument_list|,
name|last_reset
argument_list|,
name|last_err_update
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|symbol_err_cnt
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     symbol_err_cnt       : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|symbol_err_cnt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|link_err_recover
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     link_err_recover     : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|link_err_recover
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|link_downed
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     link_downed          : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|link_downed
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|rcv_err
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     rcv_err              : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|rcv_err
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|rcv_rem_phys_err
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     rcv_rem_phys_err     : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|rcv_rem_phys_err
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|rcv_switch_relay_err
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     rcv_switch_relay_err : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|rcv_switch_relay_err
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|xmit_discards
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     xmit_discards        : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|xmit_discards
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|xmit_constraint_err
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     xmit_constraint_err  : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|xmit_constraint_err
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|rcv_constraint_err
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     rcv_constraint_err   : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|rcv_constraint_err
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|link_integrity
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     link_integrity_err   : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|link_integrity
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|buffer_overrun
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     buf_overrun_err      : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|buffer_overrun
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|vl15_dropped
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     vl15_dropped         : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|vl15_dropped
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_only
operator|||
name|err
operator|->
name|xmit_wait
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     xmit_wait            : %"
name|PRIu64
literal|"\n"
argument_list|,
name|err
operator|->
name|xmit_wait
argument_list|)
expr_stmt|;
if|if
condition|(
name|err_only
condition|)
continue|continue;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     Last Data Update     : %s\n"
argument_list|,
name|last_data_update
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     xmit_data            : %"
name|PRIu64
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_data
argument_list|)
expr_stmt|;
name|dump_hr_dc
argument_list|(
name|fp
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     rcv_data             : %"
name|PRIu64
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_data
argument_list|)
expr_stmt|;
name|dump_hr_dc
argument_list|(
name|fp
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     xmit_pkts            : %"
name|PRIu64
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_pkts
argument_list|)
expr_stmt|;
name|dump_hr_dc
argument_list|(
name|fp
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|xmit_pkts
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     rcv_pkts             : %"
name|PRIu64
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_pkts
argument_list|)
expr_stmt|;
name|dump_hr_dc
argument_list|(
name|fp
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|rcv_pkts
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     unicast_xmit_pkts    : %"
name|PRIu64
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_xmit_pkts
argument_list|)
expr_stmt|;
name|dump_hr_dc
argument_list|(
name|fp
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_xmit_pkts
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     unicast_rcv_pkts     : %"
name|PRIu64
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_rcv_pkts
argument_list|)
expr_stmt|;
name|dump_hr_dc
argument_list|(
name|fp
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|unicast_rcv_pkts
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     multicast_xmit_pkts  : %"
name|PRIu64
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_xmit_pkts
argument_list|)
expr_stmt|;
name|dump_hr_dc
argument_list|(
name|fp
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_xmit_pkts
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"     multicast_rcv_pkts   : %"
name|PRIu64
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_rcv_pkts
argument_list|)
expr_stmt|;
name|dump_hr_dc
argument_list|(
name|fp
argument_list|,
name|node
operator|->
name|ports
index|[
name|i
index|]
operator|.
name|dc_total
operator|.
name|multicast_rcv_pkts
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Define a context for the __db_dump callback */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|perfmgr_db_dump_t
name|dump_type
decl_stmt|;
block|}
name|dump_context_t
typedef|;
end_typedef

begin_function
specifier|static
name|void
name|db_dump
parameter_list|(
name|cl_map_item_t
modifier|*
specifier|const
name|p_map_item
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|db_node_t
modifier|*
name|node
init|=
operator|(
name|db_node_t
operator|*
operator|)
name|p_map_item
decl_stmt|;
name|dump_context_t
modifier|*
name|c
init|=
operator|(
name|dump_context_t
operator|*
operator|)
name|context
decl_stmt|;
name|FILE
modifier|*
name|fp
init|=
name|c
operator|->
name|fp
decl_stmt|;
switch|switch
condition|(
name|c
operator|->
name|dump_type
condition|)
block|{
case|case
name|PERFMGR_EVENT_DB_DUMP_MR
case|:
name|dump_node_mr
argument_list|(
name|node
argument_list|,
name|fp
argument_list|)
expr_stmt|;
break|break;
case|case
name|PERFMGR_EVENT_DB_DUMP_HR
case|:
default|default:
name|dump_node_hr
argument_list|(
name|node
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************  * print all node data to fp  **********************************************************************/
end_comment

begin_function
name|void
name|perfmgr_db_print_all
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
name|err_only
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|item
decl_stmt|;
name|db_node_t
modifier|*
name|node
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
expr_stmt|;
while|while
condition|(
name|item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
condition|)
block|{
name|node
operator|=
operator|(
name|db_node_t
operator|*
operator|)
name|item
expr_stmt|;
name|dump_node_hr
argument_list|(
name|node
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
name|err_only
argument_list|)
expr_stmt|;
name|item
operator|=
name|cl_qmap_next
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * print node data to fp  **********************************************************************/
end_comment

begin_function
name|void
name|perfmgr_db_print_by_name
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|char
modifier|*
name|nodename
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|char
modifier|*
name|port
parameter_list|,
name|int
name|err_only
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|item
decl_stmt|;
name|db_node_t
modifier|*
name|node
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* find the node */
name|item
operator|=
name|cl_qmap_head
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
expr_stmt|;
while|while
condition|(
name|item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
condition|)
block|{
name|node
operator|=
operator|(
name|db_node_t
operator|*
operator|)
name|item
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|node
operator|->
name|node_name
argument_list|,
name|nodename
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dump_node_hr
argument_list|(
name|node
argument_list|,
name|fp
argument_list|,
name|port
argument_list|,
name|err_only
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|item
operator|=
name|cl_qmap_next
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Node %s not found...\n"
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|done
label|:
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * print node data to fp  **********************************************************************/
end_comment

begin_function
name|void
name|perfmgr_db_print_by_guid
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|uint64_t
name|nodeguid
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|char
modifier|*
name|port
parameter_list|,
name|int
name|err_only
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|node
decl_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|node
operator|=
name|cl_qmap_get
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|,
name|nodeguid
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|)
condition|)
name|dump_node_hr
argument_list|(
operator|(
name|db_node_t
operator|*
operator|)
name|node
argument_list|,
name|fp
argument_list|,
name|port
argument_list|,
name|err_only
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Node 0x%"
name|PRIx64
literal|" not found...\n"
argument_list|,
name|nodeguid
argument_list|)
expr_stmt|;
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * dump the data to the file "file"  **********************************************************************/
end_comment

begin_function
name|perfmgr_db_err_t
name|perfmgr_db_dump
parameter_list|(
name|perfmgr_db_t
modifier|*
name|db
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|perfmgr_db_dump_t
name|dump_type
parameter_list|)
block|{
name|dump_context_t
name|context
decl_stmt|;
name|context
operator|.
name|fp
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"w+"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|context
operator|.
name|fp
condition|)
return|return
name|PERFMGR_EVENT_DB_FAIL
return|;
name|context
operator|.
name|dump_type
operator|=
name|dump_type
expr_stmt|;
name|cl_plock_acquire
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|cl_qmap_apply_func
argument_list|(
operator|&
name|db
operator|->
name|pc_data
argument_list|,
name|db_dump
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|context
argument_list|)
expr_stmt|;
name|cl_plock_release
argument_list|(
operator|&
name|db
operator|->
name|lock
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|context
operator|.
name|fp
argument_list|)
expr_stmt|;
return|return
name|PERFMGR_EVENT_DB_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  * Fill in the various DB objects from their wire counter parts  **********************************************************************/
end_comment

begin_function
name|void
name|perfmgr_db_fill_err_read
parameter_list|(
name|ib_port_counters_t
modifier|*
name|wire_read
parameter_list|,
name|perfmgr_db_err_reading_t
modifier|*
name|reading
parameter_list|,
name|boolean_t
name|xmit_wait_sup
parameter_list|)
block|{
name|reading
operator|->
name|symbol_err_cnt
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|symbol_err_cnt
argument_list|)
expr_stmt|;
name|reading
operator|->
name|link_err_recover
operator|=
name|wire_read
operator|->
name|link_err_recover
expr_stmt|;
name|reading
operator|->
name|link_downed
operator|=
name|wire_read
operator|->
name|link_downed
expr_stmt|;
name|reading
operator|->
name|rcv_err
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|rcv_err
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_rem_phys_err
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|rcv_rem_phys_err
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_switch_relay_err
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|rcv_switch_relay_err
argument_list|)
expr_stmt|;
name|reading
operator|->
name|xmit_discards
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|xmit_discards
argument_list|)
expr_stmt|;
name|reading
operator|->
name|xmit_constraint_err
operator|=
name|wire_read
operator|->
name|xmit_constraint_err
expr_stmt|;
name|reading
operator|->
name|rcv_constraint_err
operator|=
name|wire_read
operator|->
name|rcv_constraint_err
expr_stmt|;
name|reading
operator|->
name|link_integrity
operator|=
name|PC_LINK_INT
argument_list|(
name|wire_read
operator|->
name|link_int_buffer_overrun
argument_list|)
expr_stmt|;
name|reading
operator|->
name|buffer_overrun
operator|=
name|PC_BUF_OVERRUN
argument_list|(
name|wire_read
operator|->
name|link_int_buffer_overrun
argument_list|)
expr_stmt|;
name|reading
operator|->
name|vl15_dropped
operator|=
name|cl_ntoh16
argument_list|(
name|wire_read
operator|->
name|vl15_dropped
argument_list|)
expr_stmt|;
if|if
condition|(
name|xmit_wait_sup
condition|)
name|reading
operator|->
name|xmit_wait
operator|=
name|cl_ntoh32
argument_list|(
name|wire_read
operator|->
name|xmit_wait
argument_list|)
expr_stmt|;
else|else
name|reading
operator|->
name|xmit_wait
operator|=
literal|0
expr_stmt|;
name|reading
operator|->
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|perfmgr_db_fill_data_cnt_read_pc
parameter_list|(
name|ib_port_counters_t
modifier|*
name|wire_read
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|reading
parameter_list|)
block|{
name|reading
operator|->
name|xmit_data
operator|=
name|cl_ntoh32
argument_list|(
name|wire_read
operator|->
name|xmit_data
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_data
operator|=
name|cl_ntoh32
argument_list|(
name|wire_read
operator|->
name|rcv_data
argument_list|)
expr_stmt|;
name|reading
operator|->
name|xmit_pkts
operator|=
name|cl_ntoh32
argument_list|(
name|wire_read
operator|->
name|xmit_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_pkts
operator|=
name|cl_ntoh32
argument_list|(
name|wire_read
operator|->
name|rcv_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|unicast_xmit_pkts
operator|=
literal|0
expr_stmt|;
name|reading
operator|->
name|unicast_rcv_pkts
operator|=
literal|0
expr_stmt|;
name|reading
operator|->
name|multicast_xmit_pkts
operator|=
literal|0
expr_stmt|;
name|reading
operator|->
name|multicast_rcv_pkts
operator|=
literal|0
expr_stmt|;
name|reading
operator|->
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|perfmgr_db_fill_data_cnt_read_pce
parameter_list|(
name|ib_port_counters_ext_t
modifier|*
name|wire_read
parameter_list|,
name|perfmgr_db_data_cnt_reading_t
modifier|*
name|reading
parameter_list|,
name|int
name|ietf_sup
parameter_list|)
block|{
name|reading
operator|->
name|xmit_data
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|xmit_data
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_data
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|rcv_data
argument_list|)
expr_stmt|;
name|reading
operator|->
name|xmit_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|xmit_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|rcv_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|rcv_pkts
argument_list|)
expr_stmt|;
if|if
condition|(
name|ietf_sup
condition|)
block|{
name|reading
operator|->
name|unicast_xmit_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|unicast_xmit_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|unicast_rcv_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|unicast_rcv_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|multicast_xmit_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|multicast_xmit_pkts
argument_list|)
expr_stmt|;
name|reading
operator|->
name|multicast_rcv_pkts
operator|=
name|cl_ntoh64
argument_list|(
name|wire_read
operator|->
name|multicast_rcv_pkts
argument_list|)
expr_stmt|;
block|}
name|reading
operator|->
name|time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ENABLE_OSM_PERF_MGR */
end_comment

end_unit


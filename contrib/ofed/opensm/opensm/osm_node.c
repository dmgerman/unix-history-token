begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2015 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of osm_node_t.  * This object represents an Infiniband Node.  * This object is part of the opensm family of objects.  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<iba/ib_types.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_file_ids.h>
end_include

begin_define
define|#
directive|define
name|FILE_ID
value|OSM_FILE_NODE_C
end_define

begin_include
include|#
directive|include
file|<opensm/osm_node.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_madw.h>
end_include

begin_function
name|void
name|osm_node_init_physp
parameter_list|(
name|IN
name|osm_node_t
modifier|*
name|p_node
parameter_list|,
name|uint8_t
name|port_num
parameter_list|,
name|IN
specifier|const
name|osm_madw_t
modifier|*
name|p_madw
parameter_list|)
block|{
name|ib_net64_t
name|port_guid
decl_stmt|;
name|ib_smp_t
modifier|*
name|p_smp
decl_stmt|;
name|ib_node_info_t
modifier|*
name|p_ni
decl_stmt|;
name|p_smp
operator|=
name|osm_madw_get_smp_ptr
argument_list|(
name|p_madw
argument_list|)
expr_stmt|;
name|p_ni
operator|=
name|ib_smp_get_payload_ptr
argument_list|(
name|p_smp
argument_list|)
expr_stmt|;
name|port_guid
operator|=
name|p_ni
operator|->
name|port_guid
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|port_num
operator|<
name|p_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
name|osm_physp_init
argument_list|(
operator|&
name|p_node
operator|->
name|physp_table
index|[
name|port_num
index|]
argument_list|,
name|port_guid
argument_list|,
name|port_num
argument_list|,
name|p_node
argument_list|,
name|osm_madw_get_bind_handle
argument_list|(
name|p_madw
argument_list|)
argument_list|,
name|p_smp
operator|->
name|hop_count
argument_list|,
name|p_smp
operator|->
name|initial_path
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|osm_node_t
modifier|*
name|osm_node_new
parameter_list|(
name|IN
specifier|const
name|osm_madw_t
modifier|*
name|p_madw
parameter_list|)
block|{
name|osm_node_t
modifier|*
name|p_node
decl_stmt|;
name|ib_smp_t
modifier|*
name|p_smp
decl_stmt|;
name|ib_node_info_t
modifier|*
name|p_ni
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|p_smp
operator|=
name|osm_madw_get_smp_ptr
argument_list|(
name|p_madw
argument_list|)
expr_stmt|;
name|p_ni
operator|=
name|ib_smp_get_payload_ptr
argument_list|(
name|p_smp
argument_list|)
expr_stmt|;
comment|/* 	   The node object already contains one physical port object. 	   Therefore, subtract 1 from the number of physical ports 	   used by the switch.  This is not done for CA's since they 	   need to occupy 1 more physp than they physically have since 	   we still reserve room for a "port 0". 	 */
name|size
operator|=
name|p_ni
operator|->
name|num_ports
expr_stmt|;
name|p_node
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p_node
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|osm_physp_t
argument_list|)
operator|*
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_node
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|p_node
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_node
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|osm_physp_t
argument_list|)
operator|*
name|size
argument_list|)
expr_stmt|;
name|p_node
operator|->
name|node_info
operator|=
operator|*
name|p_ni
expr_stmt|;
name|p_node
operator|->
name|physp_tbl_size
operator|=
name|size
operator|+
literal|1
expr_stmt|;
name|p_node
operator|->
name|physp_discovered
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
name|p_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_node
operator|->
name|physp_discovered
condition|)
block|{
name|free
argument_list|(
name|p_node
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_node
operator|->
name|physp_discovered
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
name|p_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
comment|/* 	   Construct Physical Port objects owned by this Node. 	   Then, initialize the Physical Port through with we 	   discovered this port. 	   For switches, all ports have the same GUID. 	   For CAs and routers, each port has a different GUID, so we only 	   know the GUID for the port that responded to our 	   Get(NodeInfo). 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_node
operator|->
name|physp_tbl_size
condition|;
name|i
operator|++
control|)
name|osm_physp_construct
argument_list|(
operator|&
name|p_node
operator|->
name|physp_table
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_ni
operator|->
name|node_type
operator|==
name|IB_NODE_TYPE_SWITCH
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|p_ni
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
name|osm_node_init_physp
argument_list|(
name|p_node
argument_list|,
name|i
argument_list|,
name|p_madw
argument_list|)
expr_stmt|;
else|else
name|osm_node_init_physp
argument_list|(
name|p_node
argument_list|,
name|ib_node_info_get_local_port_num
argument_list|(
name|p_ni
argument_list|)
argument_list|,
name|p_madw
argument_list|)
expr_stmt|;
name|p_node
operator|->
name|print_desc
operator|=
name|strdup
argument_list|(
name|OSM_NODE_DESC_UNKNOWN
argument_list|)
expr_stmt|;
return|return
name|p_node
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|node_destroy
parameter_list|(
name|IN
name|osm_node_t
modifier|*
name|p_node
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
comment|/* 	   Cleanup all physports 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_node
operator|->
name|physp_tbl_size
condition|;
name|i
operator|++
control|)
name|osm_physp_destroy
argument_list|(
operator|&
name|p_node
operator|->
name|physp_table
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* cleanup printable node_desc field */
if|if
condition|(
name|p_node
operator|->
name|print_desc
condition|)
name|free
argument_list|(
name|p_node
operator|->
name|print_desc
argument_list|)
expr_stmt|;
comment|/* cleanup physp_discovered array */
name|free
argument_list|(
name|p_node
operator|->
name|physp_discovered
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_node_delete
parameter_list|(
name|IN
name|OUT
name|osm_node_t
modifier|*
modifier|*
name|p_node
parameter_list|)
block|{
name|CL_ASSERT
argument_list|(
name|p_node
operator|&&
operator|*
name|p_node
argument_list|)
expr_stmt|;
name|node_destroy
argument_list|(
operator|*
name|p_node
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|p_node
argument_list|)
expr_stmt|;
operator|*
name|p_node
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_node_link
parameter_list|(
name|IN
name|osm_node_t
modifier|*
name|p_node
parameter_list|,
name|IN
name|uint8_t
name|port_num
parameter_list|,
name|IN
name|osm_node_t
modifier|*
name|p_remote_node
parameter_list|,
name|IN
name|uint8_t
name|remote_port_num
parameter_list|)
block|{
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|;
name|osm_physp_t
modifier|*
name|p_remote_physp
decl_stmt|;
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|p_remote_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_remote_node
argument_list|,
name|remote_port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_physp
operator|->
name|p_remote_physp
condition|)
name|p_physp
operator|->
name|p_remote_physp
operator|->
name|p_remote_physp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|p_remote_physp
operator|->
name|p_remote_physp
condition|)
name|p_remote_physp
operator|->
name|p_remote_physp
operator|->
name|p_remote_physp
operator|=
name|NULL
expr_stmt|;
name|osm_physp_link
argument_list|(
name|p_physp
argument_list|,
name|p_remote_physp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_node_unlink
parameter_list|(
name|IN
name|osm_node_t
modifier|*
name|p_node
parameter_list|,
name|IN
name|uint8_t
name|port_num
parameter_list|,
name|IN
name|osm_node_t
modifier|*
name|p_remote_node
parameter_list|,
name|IN
name|uint8_t
name|remote_port_num
parameter_list|)
block|{
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|;
name|osm_physp_t
modifier|*
name|p_remote_physp
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|port_num
operator|<
name|p_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|remote_port_num
operator|<
name|p_remote_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|osm_node_link_exists
argument_list|(
name|p_node
argument_list|,
name|port_num
argument_list|,
name|p_remote_node
argument_list|,
name|remote_port_num
argument_list|)
condition|)
block|{
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|p_remote_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_remote_node
argument_list|,
name|remote_port_num
argument_list|)
expr_stmt|;
name|osm_physp_unlink
argument_list|(
name|p_physp
argument_list|,
name|p_remote_physp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|boolean_t
name|osm_node_link_exists
parameter_list|(
name|IN
name|osm_node_t
modifier|*
name|p_node
parameter_list|,
name|IN
name|uint8_t
name|port_num
parameter_list|,
name|IN
name|osm_node_t
modifier|*
name|p_remote_node
parameter_list|,
name|IN
name|uint8_t
name|remote_port_num
parameter_list|)
block|{
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|;
name|osm_physp_t
modifier|*
name|p_remote_physp
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|port_num
operator|<
name|p_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|remote_port_num
operator|<
name|p_remote_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|p_remote_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_remote_node
argument_list|,
name|remote_port_num
argument_list|)
expr_stmt|;
return|return
name|osm_physp_link_exists
argument_list|(
name|p_physp
argument_list|,
name|p_remote_physp
argument_list|)
return|;
block|}
end_function

begin_function
name|boolean_t
name|osm_node_link_has_valid_ports
parameter_list|(
name|IN
name|osm_node_t
modifier|*
name|p_node
parameter_list|,
name|IN
name|uint8_t
name|port_num
parameter_list|,
name|IN
name|osm_node_t
modifier|*
name|p_remote_node
parameter_list|,
name|IN
name|uint8_t
name|remote_port_num
parameter_list|)
block|{
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|;
name|osm_physp_t
modifier|*
name|p_remote_physp
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|port_num
operator|<
name|p_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|remote_port_num
operator|<
name|p_remote_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|p_remote_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_remote_node
argument_list|,
name|remote_port_num
argument_list|)
expr_stmt|;
return|return
operator|(
name|p_physp
operator|&&
name|p_remote_physp
operator|)
return|;
block|}
end_function

begin_function
name|boolean_t
name|osm_node_has_any_link
parameter_list|(
name|IN
name|osm_node_t
modifier|*
name|p_node
parameter_list|,
name|IN
name|uint8_t
name|port_num
parameter_list|)
block|{
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|port_num
operator|<
name|p_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
return|return
name|osm_physp_has_any_link
argument_list|(
name|p_physp
argument_list|)
return|;
block|}
end_function

begin_function
name|osm_node_t
modifier|*
name|osm_node_get_remote_node
parameter_list|(
name|IN
name|osm_node_t
modifier|*
name|p_node
parameter_list|,
name|IN
name|uint8_t
name|port_num
parameter_list|,
name|OUT
name|uint8_t
modifier|*
name|p_remote_port_num
parameter_list|)
block|{
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|;
name|osm_physp_t
modifier|*
name|p_remote_physp
decl_stmt|;
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_physp
operator|||
operator|!
name|osm_physp_has_any_link
argument_list|(
name|p_physp
argument_list|)
condition|)
return|return
name|NULL
return|;
name|p_remote_physp
operator|=
name|osm_physp_get_remote
argument_list|(
name|p_physp
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_remote_port_num
condition|)
operator|*
name|p_remote_port_num
operator|=
name|osm_physp_get_port_num
argument_list|(
name|p_remote_physp
argument_list|)
expr_stmt|;
return|return
name|osm_physp_get_node_ptr
argument_list|(
name|p_remote_physp
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  The lock must be held before calling this function. **********************************************************************/
end_comment

begin_function
name|ib_net16_t
name|osm_node_get_remote_base_lid
parameter_list|(
name|IN
name|osm_node_t
modifier|*
name|p_node
parameter_list|,
name|IN
name|uint32_t
name|port_num
parameter_list|)
block|{
name|osm_physp_t
modifier|*
name|p_physp
decl_stmt|;
name|osm_physp_t
modifier|*
name|p_remote_physp
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|port_num
operator|<
name|p_node
operator|->
name|physp_tbl_size
argument_list|)
expr_stmt|;
name|p_physp
operator|=
name|osm_node_get_physp_ptr
argument_list|(
name|p_node
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_physp
condition|)
block|{
name|p_remote_physp
operator|=
name|osm_physp_get_remote
argument_list|(
name|p_physp
argument_list|)
expr_stmt|;
return|return
name|osm_physp_get_base_lid
argument_list|(
name|p_remote_physp
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


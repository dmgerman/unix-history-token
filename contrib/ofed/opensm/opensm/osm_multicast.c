begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2015 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  * Copyright (c) 2013 Oracle and/or its affiliates. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of multicast functions.  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_file_ids.h>
end_include

begin_define
define|#
directive|define
name|FILE_ID
value|OSM_FILE_MULTICAST_C
end_define

begin_include
include|#
directive|include
file|<opensm/osm_multicast.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_mcm_port.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_mtree.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_inform.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_opensm.h>
end_include

begin_function
specifier|static
name|osm_mgrp_box_t
modifier|*
name|mgrp_box_new
parameter_list|(
name|uint16_t
name|mlid
parameter_list|)
block|{
name|osm_mgrp_box_t
modifier|*
name|mbox
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mbox
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|mbox
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|mbox
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mbox
argument_list|)
argument_list|)
expr_stmt|;
name|mbox
operator|->
name|mlid
operator|=
name|mlid
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|mbox
operator|->
name|mgrp_list
argument_list|)
expr_stmt|;
return|return
name|mbox
return|;
block|}
end_function

begin_function
name|void
name|mgrp_box_delete
parameter_list|(
name|osm_mgrp_box_t
modifier|*
name|mbox
parameter_list|)
block|{
name|osm_mtree_destroy
argument_list|(
name|mbox
operator|->
name|root
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|mbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mgrp_delete
parameter_list|(
name|IN
name|osm_mgrp_t
modifier|*
name|p_mgrp
parameter_list|)
block|{
name|osm_mcm_alias_guid_t
modifier|*
name|p_mcm_alias_guid
decl_stmt|,
modifier|*
name|p_next_mcm_alias_guid
decl_stmt|;
name|osm_mcm_port_t
modifier|*
name|p_mcm_port
decl_stmt|,
modifier|*
name|p_next_mcm_port
decl_stmt|;
name|CL_ASSERT
argument_list|(
name|p_mgrp
argument_list|)
expr_stmt|;
name|p_next_mcm_alias_guid
operator|=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_mcm_alias_guid
operator|!=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|)
condition|)
block|{
name|p_mcm_alias_guid
operator|=
name|p_next_mcm_alias_guid
expr_stmt|;
name|p_next_mcm_alias_guid
operator|=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_mcm_alias_guid
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_mcm_alias_guid_delete
argument_list|(
operator|&
name|p_mcm_alias_guid
argument_list|)
expr_stmt|;
block|}
name|p_next_mcm_port
operator|=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_mcm_port
operator|!=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|)
condition|)
block|{
name|p_mcm_port
operator|=
name|p_next_mcm_port
expr_stmt|;
name|p_next_mcm_port
operator|=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_mcm_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_mcm_port_delete
argument_list|(
name|p_mcm_port
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|p_mgrp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_mgrp_box_delete
parameter_list|(
name|osm_mgrp_box_t
modifier|*
name|mbox
parameter_list|)
block|{
name|osm_mgrp_t
modifier|*
name|mgrp
decl_stmt|;
while|while
condition|(
name|cl_qlist_count
argument_list|(
operator|&
name|mbox
operator|->
name|mgrp_list
argument_list|)
condition|)
block|{
name|mgrp
operator|=
name|cl_item_obj
argument_list|(
name|cl_qlist_remove_head
argument_list|(
operator|&
name|mbox
operator|->
name|mgrp_list
argument_list|)
argument_list|,
name|mgrp
argument_list|,
name|list_item
argument_list|)
expr_stmt|;
name|mgrp_delete
argument_list|(
name|mgrp
argument_list|)
expr_stmt|;
block|}
name|mgrp_box_delete
argument_list|(
name|mbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|osm_mgrp_t
modifier|*
name|osm_mgrp_new
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|IN
name|ib_net16_t
name|mlid
parameter_list|,
name|IN
name|ib_member_rec_t
modifier|*
name|mcmr
parameter_list|)
block|{
name|osm_mgrp_t
modifier|*
name|p_mgrp
decl_stmt|;
name|osm_mgrp_box_t
modifier|*
name|mbox
decl_stmt|;
name|p_mgrp
operator|=
operator|(
name|osm_mgrp_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p_mgrp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_mgrp
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|p_mgrp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_mgrp
argument_list|)
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|)
expr_stmt|;
name|p_mgrp
operator|->
name|mlid
operator|=
name|mlid
expr_stmt|;
name|p_mgrp
operator|->
name|mcmember_rec
operator|=
operator|*
name|mcmr
expr_stmt|;
name|mbox
operator|=
name|osm_get_mbox_by_mlid
argument_list|(
name|subn
argument_list|,
name|p_mgrp
operator|->
name|mlid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mbox
operator|&&
operator|!
operator|(
name|mbox
operator|=
name|mgrp_box_new
argument_list|(
name|cl_ntoh16
argument_list|(
name|p_mgrp
operator|->
name|mlid
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|free
argument_list|(
name|p_mgrp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cl_qlist_insert_tail
argument_list|(
operator|&
name|mbox
operator|->
name|mgrp_list
argument_list|,
operator|&
name|p_mgrp
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|subn
operator|->
name|mboxes
index|[
name|mbox
operator|->
name|mlid
operator|-
name|IB_LID_MCAST_START_HO
index|]
operator|=
name|mbox
expr_stmt|;
name|cl_fmap_insert
argument_list|(
operator|&
name|subn
operator|->
name|mgrp_mgid_tbl
argument_list|,
operator|&
name|p_mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
argument_list|,
operator|&
name|p_mgrp
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|subn
operator|->
name|p_osm
operator|->
name|sa
operator|.
name|dirty
operator|=
name|TRUE
expr_stmt|;
return|return
name|p_mgrp
return|;
block|}
end_function

begin_function
name|void
name|osm_mgrp_cleanup
parameter_list|(
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|osm_mgrp_t
modifier|*
name|mgrp
parameter_list|)
block|{
name|osm_mgrp_box_t
modifier|*
name|mbox
decl_stmt|;
name|osm_mcm_alias_guid_t
modifier|*
name|mcm_alias_guid
decl_stmt|;
name|osm_mcm_port_t
modifier|*
name|mcm_port
decl_stmt|;
if|if
condition|(
name|mgrp
operator|->
name|full_members
condition|)
return|return;
while|while
condition|(
name|cl_qmap_count
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|)
condition|)
block|{
name|mcm_alias_guid
operator|=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_remove_item
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|,
operator|&
name|mcm_alias_guid
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_mcm_alias_guid_delete
argument_list|(
operator|&
name|mcm_alias_guid
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|cl_qmap_count
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_port_tbl
argument_list|)
condition|)
block|{
name|mcm_port
operator|=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_port_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_remove_item
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_port_tbl
argument_list|,
operator|&
name|mcm_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|cl_qlist_remove_item
argument_list|(
operator|&
name|mcm_port
operator|->
name|port
operator|->
name|mcm_list
argument_list|,
operator|&
name|mcm_port
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|osm_mcm_port_delete
argument_list|(
name|mcm_port
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mgrp
operator|->
name|well_known
condition|)
return|return;
name|cl_fmap_remove_item
argument_list|(
operator|&
name|subn
operator|->
name|mgrp_mgid_tbl
argument_list|,
operator|&
name|mgrp
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|mbox
operator|=
name|osm_get_mbox_by_mlid
argument_list|(
name|subn
argument_list|,
name|mgrp
operator|->
name|mlid
argument_list|)
expr_stmt|;
name|cl_qlist_remove_item
argument_list|(
operator|&
name|mbox
operator|->
name|mgrp_list
argument_list|,
operator|&
name|mgrp
operator|->
name|list_item
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl_is_qlist_empty
argument_list|(
operator|&
name|mbox
operator|->
name|mgrp_list
argument_list|)
condition|)
block|{
name|subn
operator|->
name|mboxes
index|[
name|cl_ntoh16
argument_list|(
name|mgrp
operator|->
name|mlid
argument_list|)
operator|-
name|IB_LID_MCAST_START_HO
index|]
operator|=
name|NULL
expr_stmt|;
name|mgrp_box_delete
argument_list|(
name|mbox
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|mgrp
argument_list|)
expr_stmt|;
name|subn
operator|->
name|p_osm
operator|->
name|sa
operator|.
name|dirty
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mgrp_send_notice
parameter_list|(
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|osm_log_t
modifier|*
name|log
parameter_list|,
name|osm_mgrp_t
modifier|*
name|mgrp
parameter_list|,
name|unsigned
name|num
parameter_list|)
block|{
name|ib_mad_notice_attr_t
name|notice
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|notice
operator|.
name|generic_type
operator|=
literal|0x80
operator||
name|IB_NOTICE_TYPE_SUBN_MGMT
expr_stmt|;
comment|/* is generic subn mgt type */
name|ib_notice_set_prod_type_ho
argument_list|(
operator|&
name|notice
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* A Class Manager generator */
name|notice
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
operator|=
name|CL_HTON16
argument_list|(
name|num
argument_list|)
expr_stmt|;
comment|/* The sm_base_lid is saved in network order already. */
name|notice
operator|.
name|issuer_lid
operator|=
name|subn
operator|->
name|sm_base_lid
expr_stmt|;
comment|/* following o14-12.1.11 and table 120 p726 */
comment|/* we need to provide the MGID */
name|memcpy
argument_list|(
operator|&
name|notice
operator|.
name|data_details
operator|.
name|ntc_64_67
operator|.
name|gid
argument_list|,
operator|&
name|mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* According to page 653 - the issuer gid in this case of trap 	   is the SM gid, since the SM is the initiator of this trap. */
name|notice
operator|.
name|issuer_gid
operator|.
name|unicast
operator|.
name|prefix
operator|=
name|subn
operator|->
name|opt
operator|.
name|subnet_prefix
expr_stmt|;
name|notice
operator|.
name|issuer_gid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|subn
operator|->
name|sm_port_guid
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|osm_report_notice
argument_list|(
name|log
argument_list|,
name|subn
argument_list|,
operator|&
name|notice
argument_list|)
operator|)
condition|)
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7601: "
literal|"Error sending trap reports (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|is_qmap_empty_for_port
parameter_list|(
name|IN
specifier|const
name|cl_qmap_t
modifier|*
specifier|const
name|p_map
parameter_list|,
name|IN
specifier|const
name|osm_port_t
modifier|*
name|port
parameter_list|)
block|{
name|size_t
name|count
init|=
literal|0
decl_stmt|;
name|cl_map_item_t
modifier|*
name|item
decl_stmt|;
name|osm_mcm_alias_guid_t
modifier|*
name|mcm_alias_guid
decl_stmt|;
for|for
control|(
name|item
operator|=
name|cl_qmap_head
argument_list|(
name|p_map
argument_list|)
init|;
name|item
operator|!=
name|cl_qmap_end
argument_list|(
name|p_map
argument_list|)
condition|;
name|item
operator|=
name|cl_qmap_next
argument_list|(
name|item
argument_list|)
control|)
block|{
name|mcm_alias_guid
operator|=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|item
expr_stmt|;
if|if
condition|(
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|->
name|port
operator|==
name|port
condition|)
block|{
name|count
operator|++
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|count
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|is_qmap_empty_for_mcm_port
parameter_list|(
name|IN
specifier|const
name|cl_qmap_t
modifier|*
specifier|const
name|p_map
parameter_list|,
name|IN
specifier|const
name|osm_mcm_port_t
modifier|*
name|mcm_port
parameter_list|)
block|{
name|size_t
name|count
init|=
literal|0
decl_stmt|;
name|cl_map_item_t
modifier|*
name|item
decl_stmt|;
name|osm_mcm_alias_guid_t
modifier|*
name|mcm_alias_guid
decl_stmt|;
for|for
control|(
name|item
operator|=
name|cl_qmap_head
argument_list|(
name|p_map
argument_list|)
init|;
name|item
operator|!=
name|cl_qmap_end
argument_list|(
name|p_map
argument_list|)
condition|;
name|item
operator|=
name|cl_qmap_next
argument_list|(
name|item
argument_list|)
control|)
block|{
name|mcm_alias_guid
operator|=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|item
expr_stmt|;
if|if
condition|(
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|==
name|mcm_port
condition|)
block|{
name|count
operator|++
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|count
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|osm_mcm_alias_guid_t
modifier|*
name|insert_alias_guid
parameter_list|(
name|IN
name|osm_mgrp_t
modifier|*
name|mgrp
parameter_list|,
name|IN
name|osm_mcm_alias_guid_t
modifier|*
name|p_mcm_alias_guid
parameter_list|)
block|{
name|osm_mcm_alias_guid_t
modifier|*
name|p_mcm_alias_guid_check
decl_stmt|;
comment|/* insert into mcm alias guid table */
name|p_mcm_alias_guid_check
operator|=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|cl_qmap_insert
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|,
name|p_mcm_alias_guid
operator|->
name|alias_guid
argument_list|,
operator|&
name|p_mcm_alias_guid
operator|->
name|map_item
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mcm_alias_guid_check
operator|!=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
operator|&
name|p_mcm_alias_guid
operator|->
name|map_item
condition|)
block|{
comment|/* alias GUID is a duplicate */
name|osm_mcm_alias_guid_delete
argument_list|(
operator|&
name|p_mcm_alias_guid
argument_list|)
expr_stmt|;
return|return
name|p_mcm_alias_guid_check
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|osm_mcm_port_t
modifier|*
name|osm_mgrp_add_port
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|osm_log_t
modifier|*
name|log
parameter_list|,
name|IN
name|osm_mgrp_t
modifier|*
name|mgrp
parameter_list|,
name|osm_port_t
modifier|*
name|port
parameter_list|,
name|IN
name|ib_member_rec_t
modifier|*
name|mcmr
parameter_list|,
name|IN
name|boolean_t
name|proxy
parameter_list|)
block|{
name|osm_mcm_port_t
modifier|*
name|mcm_port
decl_stmt|;
name|osm_mcm_alias_guid_t
modifier|*
name|p_mcm_alias_guid
decl_stmt|,
modifier|*
name|p_mcm_alias_guid_check
decl_stmt|;
name|cl_map_item_t
modifier|*
name|prev_item
decl_stmt|;
name|uint8_t
name|prev_join_state
init|=
literal|0
decl_stmt|,
name|join_state
init|=
name|mcmr
operator|->
name|scope_state
decl_stmt|;
name|uint8_t
name|prev_scope
decl_stmt|;
if|if
condition|(
name|OSM_LOG_IS_ACTIVE_V2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
condition|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"GUID 0x%016"
name|PRIx64
literal|" Port 0x%016"
name|PRIx64
literal|" joining "
literal|"MC group %s (mlid 0x%x)\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|mcmr
operator|->
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|port
operator|->
name|guid
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
argument_list|(
name|gid_str
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|mgrp
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|mcm_port
operator|=
name|osm_mcm_port_new
argument_list|(
name|port
argument_list|,
name|mgrp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mcm_port
condition|)
return|return
name|NULL
return|;
name|p_mcm_alias_guid
operator|=
name|osm_mcm_alias_guid_new
argument_list|(
name|mcm_port
argument_list|,
name|mcmr
argument_list|,
name|proxy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_mcm_alias_guid
condition|)
block|{
name|osm_mcm_port_delete
argument_list|(
name|mcm_port
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	   prev_item = cl_qmap_insert(...) 	   Pointer to the item in the map with the specified key.  If insertion 	   was successful, this is the pointer to the item.  If an item with the 	   specified key already exists in the map, the pointer to that item is 	   returned. 	 */
name|prev_item
operator|=
name|cl_qmap_insert
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_port_tbl
argument_list|,
name|port
operator|->
name|guid
argument_list|,
operator|&
name|mcm_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev_item
operator|!=
operator|&
name|mcm_port
operator|->
name|map_item
condition|)
block|{
comment|/* mcm port already exists */
name|osm_mcm_port_delete
argument_list|(
name|mcm_port
argument_list|)
expr_stmt|;
name|mcm_port
operator|=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|prev_item
expr_stmt|;
name|p_mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|=
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|prev_item
expr_stmt|;
name|p_mcm_alias_guid_check
operator|=
name|insert_alias_guid
argument_list|(
name|mgrp
argument_list|,
name|p_mcm_alias_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_mcm_alias_guid_check
condition|)
block|{
comment|/* alias GUID already exists */
name|p_mcm_alias_guid
operator|=
name|p_mcm_alias_guid_check
expr_stmt|;
name|ib_member_get_scope_state
argument_list|(
name|p_mcm_alias_guid
operator|->
name|scope_state
argument_list|,
operator|&
name|prev_scope
argument_list|,
operator|&
name|prev_join_state
argument_list|)
expr_stmt|;
name|p_mcm_alias_guid
operator|->
name|scope_state
operator|=
name|ib_member_set_scope_state
argument_list|(
name|prev_scope
argument_list|,
name|prev_join_state
operator||
name|join_state
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|insert_alias_guid
argument_list|(
name|mgrp
argument_list|,
name|p_mcm_alias_guid
argument_list|)
expr_stmt|;
name|cl_qlist_insert_tail
argument_list|(
operator|&
name|port
operator|->
name|mcm_list
argument_list|,
operator|&
name|mcm_port
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|osm_sm_reroute_mlid
argument_list|(
operator|&
name|subn
operator|->
name|p_osm
operator|->
name|sm
argument_list|,
name|mgrp
operator|->
name|mlid
argument_list|)
expr_stmt|;
block|}
comment|/* o15.0.1.11: copy the join state */
name|mcmr
operator|->
name|scope_state
operator|=
name|p_mcm_alias_guid
operator|->
name|scope_state
expr_stmt|;
if|if
condition|(
operator|(
name|join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|)
operator|&&
operator|!
operator|(
name|prev_join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|)
operator|&&
operator|++
name|mgrp
operator|->
name|full_members
operator|==
literal|1
condition|)
name|mgrp_send_notice
argument_list|(
name|subn
argument_list|,
name|log
argument_list|,
name|mgrp
argument_list|,
name|SM_MGID_CREATED_TRAP
argument_list|)
expr_stmt|;
comment|/* 66 */
name|subn
operator|->
name|p_osm
operator|->
name|sa
operator|.
name|dirty
operator|=
name|TRUE
expr_stmt|;
return|return
name|mcm_port
return|;
block|}
end_function

begin_function
name|boolean_t
name|osm_mgrp_remove_port
parameter_list|(
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|osm_log_t
modifier|*
name|log
parameter_list|,
name|osm_mgrp_t
modifier|*
name|mgrp
parameter_list|,
name|osm_mcm_alias_guid_t
modifier|*
name|mcm_alias_guid
parameter_list|,
name|ib_member_rec_t
modifier|*
name|mcmr
parameter_list|)
block|{
name|uint8_t
name|join_state
init|=
name|mcmr
operator|->
name|scope_state
operator|&
literal|0xf
decl_stmt|;
name|uint8_t
name|port_join_state
decl_stmt|,
name|new_join_state
decl_stmt|;
name|boolean_t
name|mgrp_deleted
init|=
name|FALSE
decl_stmt|;
comment|/* 	 * according to the same o15-0.1.14 we get the stored 	 * JoinState and the request JoinState and they must be 	 * opposite to leave - otherwise just update it 	 */
name|port_join_state
operator|=
name|mcm_alias_guid
operator|->
name|scope_state
operator|&
literal|0x0F
expr_stmt|;
name|new_join_state
operator|=
name|port_join_state
operator|&
operator|~
name|join_state
expr_stmt|;
if|if
condition|(
name|OSM_LOG_IS_ACTIVE_V2
argument_list|(
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
condition|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"GUID 0x%"
name|PRIx64
literal|" Port 0x%"
name|PRIx64
literal|" leaving MC group %s (mlid 0x%x)\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|mcm_alias_guid
operator|->
name|alias_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|->
name|port
operator|->
name|guid
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mgrp
operator|->
name|mcmember_rec
operator|.
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
argument_list|(
name|gid_str
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|mgrp
operator|->
name|mlid
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|new_join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|||
operator|(
name|new_join_state
operator|&&
operator|(
name|mgrp
operator|->
name|full_members
operator|>
operator|(
name|port_join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
operator|)
condition|)
block|{
name|mcm_alias_guid
operator|->
name|scope_state
operator|=
name|new_join_state
operator||
operator|(
name|mcm_alias_guid
operator|->
name|scope_state
operator|&
literal|0xf0
operator|)
expr_stmt|;
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"updating GUID 0x%"
name|PRIx64
literal|" port 0x%"
name|PRIx64
literal|" JoinState 0x%x -> 0x%x\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|mcm_alias_guid
operator|->
name|alias_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|->
name|port
operator|->
name|guid
argument_list|)
argument_list|,
name|port_join_state
argument_list|,
name|new_join_state
argument_list|)
expr_stmt|;
name|mcmr
operator|->
name|scope_state
operator|=
name|mcm_alias_guid
operator|->
name|scope_state
expr_stmt|;
block|}
else|else
block|{
name|mcmr
operator|->
name|scope_state
operator|=
name|mcm_alias_guid
operator|->
name|scope_state
operator|&
literal|0xf0
expr_stmt|;
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"removing alias GUID 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|mcm_alias_guid
operator|->
name|alias_guid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_qmap_remove_item
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|,
operator|&
name|mcm_alias_guid
operator|->
name|map_item
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_qmap_empty_for_port
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|,
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|->
name|port
argument_list|)
condition|)
block|{
comment|/* last alias in mcast group for this port */
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"removing port 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|->
name|port
operator|->
name|guid
argument_list|)
argument_list|)
expr_stmt|;
name|cl_qmap_remove_item
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_port_tbl
argument_list|,
operator|&
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|cl_qlist_remove_item
argument_list|(
operator|&
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|->
name|port
operator|->
name|mcm_list
argument_list|,
operator|&
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|->
name|list_item
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_qmap_empty_for_mcm_port
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|,
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
argument_list|)
condition|)
comment|/* last alias in mcast group for this mcm port */
name|osm_mcm_port_delete
argument_list|(
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
argument_list|)
expr_stmt|;
name|osm_sm_reroute_mlid
argument_list|(
operator|&
name|subn
operator|->
name|p_osm
operator|->
name|sm
argument_list|,
name|mgrp
operator|->
name|mlid
argument_list|)
expr_stmt|;
block|}
name|osm_mcm_alias_guid_delete
argument_list|(
operator|&
name|mcm_alias_guid
argument_list|)
expr_stmt|;
block|}
comment|/* no more full members so the group will be deleted after re-route 	   but only if it is not a well known group */
if|if
condition|(
operator|(
name|port_join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|)
operator|&&
operator|!
operator|(
name|new_join_state
operator|&
name|IB_JOIN_STATE_FULL
operator|)
operator|&&
operator|--
name|mgrp
operator|->
name|full_members
operator|==
literal|0
condition|)
block|{
name|mgrp_send_notice
argument_list|(
name|subn
argument_list|,
name|log
argument_list|,
name|mgrp
argument_list|,
name|SM_MGID_DESTROYED_TRAP
argument_list|)
expr_stmt|;
comment|/* 67 */
name|osm_mgrp_cleanup
argument_list|(
name|subn
argument_list|,
name|mgrp
argument_list|)
expr_stmt|;
name|mgrp_deleted
operator|=
name|TRUE
expr_stmt|;
block|}
name|subn
operator|->
name|p_osm
operator|->
name|sa
operator|.
name|dirty
operator|=
name|TRUE
expr_stmt|;
return|return
operator|(
name|mgrp_deleted
operator|)
return|;
block|}
end_function

begin_function
name|void
name|osm_mgrp_delete_port
parameter_list|(
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|osm_log_t
modifier|*
name|log
parameter_list|,
name|osm_mgrp_t
modifier|*
name|mgrp
parameter_list|,
name|osm_port_t
modifier|*
name|port
parameter_list|)
block|{
name|osm_mcm_alias_guid_t
modifier|*
name|mcm_alias_guid
decl_stmt|,
modifier|*
name|next_mcm_alias_guid
decl_stmt|;
name|ib_member_rec_t
name|mcmrec
decl_stmt|;
name|boolean_t
name|mgrp_deleted
init|=
name|FALSE
decl_stmt|;
name|next_mcm_alias_guid
operator|=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|next_mcm_alias_guid
operator|!=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|)
operator|&&
operator|!
name|mgrp_deleted
condition|)
block|{
name|mcm_alias_guid
operator|=
name|next_mcm_alias_guid
expr_stmt|;
name|next_mcm_alias_guid
operator|=
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|next_mcm_alias_guid
operator|->
name|map_item
argument_list|)
expr_stmt|;
if|if
condition|(
name|mcm_alias_guid
operator|->
name|p_base_mcm_port
operator|->
name|port
operator|==
name|port
condition|)
block|{
name|mcmrec
operator|.
name|scope_state
operator|=
literal|0xf
expr_stmt|;
name|mgrp_deleted
operator|=
name|osm_mgrp_remove_port
argument_list|(
name|subn
argument_list|,
name|log
argument_list|,
name|mgrp
argument_list|,
name|mcm_alias_guid
argument_list|,
operator|&
name|mcmrec
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|osm_mcm_port_t
modifier|*
name|osm_mgrp_get_mcm_port
parameter_list|(
name|IN
specifier|const
name|osm_mgrp_t
modifier|*
name|p_mgrp
parameter_list|,
name|IN
name|ib_net64_t
name|port_guid
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|item
init|=
name|cl_qmap_get
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|,
name|port_guid
argument_list|)
decl_stmt|;
if|if
condition|(
name|item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_port_tbl
argument_list|)
condition|)
return|return
operator|(
name|osm_mcm_port_t
operator|*
operator|)
name|item
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|osm_mcm_alias_guid_t
modifier|*
name|osm_mgrp_get_mcm_alias_guid
parameter_list|(
name|IN
specifier|const
name|osm_mgrp_t
modifier|*
name|p_mgrp
parameter_list|,
name|IN
name|ib_net64_t
name|port_guid
parameter_list|)
block|{
name|cl_map_item_t
modifier|*
name|item
init|=
name|cl_qmap_get
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|,
name|port_guid
argument_list|)
decl_stmt|;
if|if
condition|(
name|item
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_mgrp
operator|->
name|mcm_alias_port_tbl
argument_list|)
condition|)
return|return
operator|(
name|osm_mcm_alias_guid_t
operator|*
operator|)
name|item
return|;
return|return
name|NULL
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2011 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  * Copyright (c) 2008 Xsigo Systems Inc.  All rights reserved.  * Copyright (c) 2009 System Fabric Works, Inc. All rights reserved.  * Copyright (c) 2009 HNR Consulting. All rights reserved.  * Copyright (c) 2009-2015 ZIH, TU Dresden, Federal Republic of Germany. All rights reserved.  * Copyright (c) 2013 Oracle and/or its affiliates. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of osm_subn_t.  * This object represents an IBA subnet.  * This object is part of the opensm family of objects.  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_log.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_file_ids.h>
end_include

begin_define
define|#
directive|define
name|FILE_ID
value|OSM_FILE_SUBNET_C
end_define

begin_include
include|#
directive|include
file|<opensm/osm_subnet.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_opensm.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_log.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_madw.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_port.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_switch.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_remote_sm.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_partition.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_node.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_guid.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_multicast.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_inform.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_console.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_perfmgr.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_congestion_control.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_event_plugin.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_qos_policy.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_service.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_db.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_db_pack.h>
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
name|null_str
index|[]
init|=
literal|"(null)"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|OPT_OFFSET
parameter_list|(
name|opt
parameter_list|)
value|offsetof(osm_subn_opt_t, opt)
end_define

begin_define
define|#
directive|define
name|ARR_SIZE
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a)/sizeof((a)[0]))
end_define

begin_typedef
typedef|typedef
struct|struct
name|opt_rec
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|unsigned
name|long
name|opt_offset
decl_stmt|;
name|void
function_decl|(
modifier|*
name|parse_fn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|char
modifier|*
name|p_key
parameter_list|,
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_val1
parameter_list|,
name|void
modifier|*
name|p_val2
parameter_list|,
name|void
function_decl|(
modifier|*
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|setup_fn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|void
modifier|*
name|p_val
parameter_list|)
function_decl|;
name|int
name|can_update
decl_stmt|;
block|}
name|opt_rec_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|module_name_str
index|[]
init|=
block|{
literal|"main.c"
block|,
literal|"osm_console.c"
block|,
literal|"osm_console_io.c"
block|,
literal|"osm_db_files.c"
block|,
literal|"osm_db_pack.c"
block|,
literal|"osm_drop_mgr.c"
block|,
literal|"osm_dump.c"
block|,
literal|"osm_event_plugin.c"
block|,
literal|"osm_guid_info_rcv.c"
block|,
literal|"osm_guid_mgr.c"
block|,
literal|"osm_helper.c"
block|,
literal|"osm_inform.c"
block|,
literal|"osm_lid_mgr.c"
block|,
literal|"osm_lin_fwd_rcv.c"
block|,
literal|"osm_link_mgr.c"
block|,
literal|"osm_log.c"
block|,
literal|"osm_mad_pool.c"
block|,
literal|"osm_mcast_fwd_rcv.c"
block|,
literal|"osm_mcast_mgr.c"
block|,
literal|"osm_mcast_tbl.c"
block|,
literal|"osm_mcm_port.c"
block|,
literal|"osm_mesh.c"
block|,
literal|"osm_mlnx_ext_port_info_rcv.c"
block|,
literal|"osm_mtree.c"
block|,
literal|"osm_multicast.c"
block|,
literal|"osm_node.c"
block|,
literal|"osm_node_desc_rcv.c"
block|,
literal|"osm_node_info_rcv.c"
block|,
literal|"osm_opensm.c"
block|,
literal|"osm_perfmgr.c"
block|,
literal|"osm_perfmgr_db.c"
block|,
literal|"osm_pkey.c"
block|,
literal|"osm_pkey_mgr.c"
block|,
literal|"osm_pkey_rcv.c"
block|,
literal|"osm_port.c"
block|,
literal|"osm_port_info_rcv.c"
block|,
literal|"osm_prtn.c"
block|,
literal|"osm_prtn_config.c"
block|,
literal|"osm_qos.c"
block|,
literal|"osm_qos_parser_l.c"
block|,
literal|"osm_qos_parser_y.c"
block|,
literal|"osm_qos_policy.c"
block|,
literal|"osm_remote_sm.c"
block|,
literal|"osm_req.c"
block|,
literal|"osm_resp.c"
block|,
literal|"osm_router.c"
block|,
literal|"osm_sa.c"
block|,
literal|"osm_sa_class_port_info.c"
block|,
literal|"osm_sa_guidinfo_record.c"
block|,
literal|"osm_sa_informinfo.c"
block|,
literal|"osm_sa_lft_record.c"
block|,
literal|"osm_sa_link_record.c"
block|,
literal|"osm_sa_mad_ctrl.c"
block|,
literal|"osm_sa_mcmember_record.c"
block|,
literal|"osm_sa_mft_record.c"
block|,
literal|"osm_sa_multipath_record.c"
block|,
literal|"osm_sa_node_record.c"
block|,
literal|"osm_sa_path_record.c"
block|,
literal|"osm_sa_pkey_record.c"
block|,
literal|"osm_sa_portinfo_record.c"
block|,
literal|"osm_sa_service_record.c"
block|,
literal|"osm_sa_slvl_record.c"
block|,
literal|"osm_sa_sminfo_record.c"
block|,
literal|"osm_sa_sw_info_record.c"
block|,
literal|"osm_sa_vlarb_record.c"
block|,
literal|"osm_service.c"
block|,
literal|"osm_slvl_map_rcv.c"
block|,
literal|"osm_sm.c"
block|,
literal|"osm_sminfo_rcv.c"
block|,
literal|"osm_sm_mad_ctrl.c"
block|,
literal|"osm_sm_state_mgr.c"
block|,
literal|"osm_state_mgr.c"
block|,
literal|"osm_subnet.c"
block|,
literal|"osm_sw_info_rcv.c"
block|,
literal|"osm_switch.c"
block|,
literal|"osm_torus.c"
block|,
literal|"osm_trap_rcv.c"
block|,
literal|"osm_ucast_cache.c"
block|,
literal|"osm_ucast_dnup.c"
block|,
literal|"osm_ucast_file.c"
block|,
literal|"osm_ucast_ftree.c"
block|,
literal|"osm_ucast_lash.c"
block|,
literal|"osm_ucast_mgr.c"
block|,
literal|"osm_ucast_updn.c"
block|,
literal|"osm_vendor_ibumad.c"
block|,
literal|"osm_vl15intf.c"
block|,
literal|"osm_vl_arb_rcv.c"
block|,
literal|"st.c"
block|,
literal|"osm_ucast_dfsssp.c"
block|,
literal|"osm_congestion_control.c"
block|,
comment|/* Add new module names here ... */
comment|/* FILE_ID define in those modules must be identical to index here */
comment|/* last FILE_ID is currently 89 */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MOD_NAME_STR_UNKNOWN_VAL
value|(ARR_SIZE(module_name_str))
end_define

begin_function
specifier|static
name|int
name|find_module_name
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|uint8_t
modifier|*
name|file_id
parameter_list|)
block|{
name|uint8_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MOD_NAME_STR_UNKNOWN_VAL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|module_name_str
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|file_id
condition|)
operator|*
name|file_id
operator|=
name|i
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|log_report
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|cl_log_event
argument_list|(
literal|"OpenSM"
argument_list|,
name|CL_LOG_INFO
argument_list|,
name|buf
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|log_config_value
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|unsigned
name|n
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|n
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|" Loading Cached Option:%s = "
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|n
operator|+=
name|vsnprintf
argument_list|(
name|buf
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|n
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|2
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|2
expr_stmt|;
name|snprintf
argument_list|(
name|buf
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|n
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|cl_log_event
argument_list|(
literal|"OpenSM"
argument_list|,
name|CL_LOG_INFO
argument_list|,
name|buf
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_setup_log_flags
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|void
modifier|*
name|p_val
parameter_list|)
block|{
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|.
name|level
operator|=
operator|*
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_val
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_setup_force_log_flush
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|void
modifier|*
name|p_val
parameter_list|)
block|{
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|.
name|flush
operator|=
operator|*
operator|(
operator|(
name|boolean_t
operator|*
operator|)
name|p_val
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_setup_accum_log_file
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|void
modifier|*
name|p_val
parameter_list|)
block|{
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|.
name|accum_log_file
operator|=
operator|*
operator|(
operator|(
name|boolean_t
operator|*
operator|)
name|p_val
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_setup_log_max_size
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|void
modifier|*
name|p_val
parameter_list|)
block|{
name|uint32_t
name|log_max_size
init|=
operator|*
operator|(
operator|(
name|uint32_t
operator|*
operator|)
name|p_val
operator|)
decl_stmt|;
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|.
name|max_size
operator|=
operator|(
name|unsigned
name|long
operator|)
name|log_max_size
operator|<<
literal|20
expr_stmt|;
comment|/* convert from MB to bytes */
block|}
end_function

begin_function
specifier|static
name|void
name|opts_setup_sminfo_polling_timeout
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|void
modifier|*
name|p_val
parameter_list|)
block|{
name|osm_sm_t
modifier|*
name|p_sm
init|=
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|sm
decl_stmt|;
name|uint32_t
name|sminfo_polling_timeout
init|=
operator|*
operator|(
operator|(
name|uint32_t
operator|*
operator|)
name|p_val
operator|)
decl_stmt|;
name|cl_timer_stop
argument_list|(
operator|&
name|p_sm
operator|->
name|polling_timer
argument_list|)
expr_stmt|;
name|cl_timer_start
argument_list|(
operator|&
name|p_sm
operator|->
name|polling_timer
argument_list|,
name|sminfo_polling_timeout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_setup_sm_priority
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|void
modifier|*
name|p_val
parameter_list|)
block|{
name|osm_sm_t
modifier|*
name|p_sm
init|=
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|sm
decl_stmt|;
name|uint8_t
name|sm_priority
init|=
operator|*
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_val
operator|)
decl_stmt|;
name|osm_set_sm_priority
argument_list|(
name|p_sm
argument_list|,
name|sm_priority
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|opts_strtoul
parameter_list|(
name|uint32_t
modifier|*
name|val
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|uint32_t
name|max_value
parameter_list|)
block|{
name|char
modifier|*
name|endptr
decl_stmt|;
name|unsigned
name|long
name|int
name|tmp_val
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|tmp_val
operator|=
name|strtoul
argument_list|(
name|p_val_str
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|val
operator|=
name|tmp_val
expr_stmt|;
if|if
condition|(
operator|*
name|p_val_str
operator|==
literal|'\0'
operator|||
operator|*
name|endptr
operator|!=
literal|'\0'
condition|)
block|{
name|log_report
argument_list|(
literal|"-E- Parsing error in field %s, expected "
literal|"numeric input received: %s\n"
argument_list|,
name|p_key
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tmp_val
operator|>
name|max_value
operator|||
operator|(
operator|(
name|tmp_val
operator|==
name|ULONG_MAX
operator|)
operator|&&
name|errno
operator|==
name|ERANGE
operator|)
condition|)
block|{
name|log_report
argument_list|(
literal|"-E- Parsing error in field %s, value out of range\n"
argument_list|,
name|p_key
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|opts_strtoull
parameter_list|(
name|uint64_t
modifier|*
name|val
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|uint64_t
name|max_value
parameter_list|)
block|{
name|char
modifier|*
name|endptr
decl_stmt|;
name|unsigned
name|long
name|long
name|int
name|tmp_val
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|tmp_val
operator|=
name|strtoull
argument_list|(
name|p_val_str
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|val
operator|=
name|tmp_val
expr_stmt|;
if|if
condition|(
operator|*
name|p_val_str
operator|==
literal|'\0'
operator|||
operator|*
name|endptr
operator|!=
literal|'\0'
condition|)
block|{
name|log_report
argument_list|(
literal|"-E- Parsing error in field %s, expected "
literal|"numeric input received: %s\n"
argument_list|,
name|p_key
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tmp_val
operator|>
name|max_value
operator|||
operator|(
name|tmp_val
operator|==
name|ULLONG_MAX
operator|&&
name|errno
operator|==
name|ERANGE
operator|)
condition|)
block|{
name|log_report
argument_list|(
literal|"-E- Parsing error in field %s, value out of range\n"
argument_list|,
name|p_key
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_net64
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|uint64_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|uint64_t
name|val
decl_stmt|;
if|if
condition|(
name|opts_strtoull
argument_list|(
operator|&
name|val
argument_list|,
name|p_val_str
argument_list|,
name|p_key
argument_list|,
name|UINT64_MAX
argument_list|)
condition|)
return|return;
if|if
condition|(
name|cl_hton64
argument_list|(
name|val
argument_list|)
operator|!=
operator|*
name|p_val1
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"0x%016"
name|PRIx64
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val1
operator|=
operator|*
name|p_val2
operator|=
name|cl_ntoh64
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_uint32
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|uint32_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
name|opts_strtoul
argument_list|(
operator|&
name|val
argument_list|,
name|p_val_str
argument_list|,
name|p_key
argument_list|,
name|UINT32_MAX
argument_list|)
condition|)
return|return;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val1
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%u"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val1
operator|=
operator|*
name|p_val2
operator|=
name|val
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_net32
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|uint32_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
name|opts_strtoul
argument_list|(
operator|&
name|val
argument_list|,
name|p_val_str
argument_list|,
name|p_key
argument_list|,
name|UINT32_MAX
argument_list|)
condition|)
return|return;
if|if
condition|(
name|cl_hton32
argument_list|(
name|val
argument_list|)
operator|!=
operator|*
name|p_val1
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%u"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val1
operator|=
operator|*
name|p_val2
operator|=
name|cl_hton32
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_int32
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|int32_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|int32_t
name|val
init|=
name|strtol
argument_list|(
name|p_val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val1
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%d"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val1
operator|=
operator|*
name|p_val2
operator|=
name|val
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_uint16
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|uint16_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|uint32_t
name|tmp_val
decl_stmt|;
if|if
condition|(
name|opts_strtoul
argument_list|(
operator|&
name|tmp_val
argument_list|,
name|p_val_str
argument_list|,
name|p_key
argument_list|,
name|UINT16_MAX
argument_list|)
condition|)
return|return;
name|uint16_t
name|val
init|=
operator|(
name|uint16_t
operator|)
name|tmp_val
decl_stmt|;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val1
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%u"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val1
operator|=
operator|*
name|p_val2
operator|=
name|val
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_net16
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|uint16_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|uint32_t
name|tmp_val
decl_stmt|;
if|if
condition|(
name|opts_strtoul
argument_list|(
operator|&
name|tmp_val
argument_list|,
name|p_val_str
argument_list|,
name|p_key
argument_list|,
name|UINT16_MAX
argument_list|)
condition|)
return|return;
name|uint16_t
name|val
init|=
operator|(
name|uint16_t
operator|)
name|tmp_val
decl_stmt|;
if|if
condition|(
name|cl_hton16
argument_list|(
name|val
argument_list|)
operator|!=
operator|*
name|p_val1
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"0x%04x"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val1
operator|=
operator|*
name|p_val2
operator|=
name|cl_hton16
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_uint8
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|uint8_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|uint32_t
name|tmp_val
decl_stmt|;
if|if
condition|(
name|opts_strtoul
argument_list|(
operator|&
name|tmp_val
argument_list|,
name|p_val_str
argument_list|,
name|p_key
argument_list|,
name|UINT8_MAX
argument_list|)
condition|)
return|return;
name|uint8_t
name|val
init|=
operator|(
name|uint8_t
operator|)
name|tmp_val
decl_stmt|;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val1
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%u"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val1
operator|=
operator|*
name|p_val2
operator|=
name|val
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_boolean
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|boolean_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|boolean_t
name|val
decl_stmt|;
if|if
condition|(
operator|!
name|p_val_str
condition|)
return|return;
if|if
condition|(
name|strcmp
argument_list|(
literal|"TRUE"
argument_list|,
name|p_val_str
argument_list|)
condition|)
name|val
operator|=
name|FALSE
expr_stmt|;
else|else
name|val
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|val
operator|!=
operator|*
name|p_val1
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%s"
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
operator|*
name|p_val1
operator|=
operator|*
name|p_val2
operator|=
name|val
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_charp
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
specifier|const
name|char
modifier|*
name|current_str
init|=
operator|*
name|p_val1
condition|?
operator|*
name|p_val1
else|:
name|null_str
decl_stmt|;
if|if
condition|(
name|p_val_str
operator|&&
name|strcmp
argument_list|(
name|p_val_str
argument_list|,
name|current_str
argument_list|)
condition|)
block|{
name|char
modifier|*
name|new
decl_stmt|;
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%s"
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
comment|/* special case the "(null)" string */
name|new
operator|=
name|strcmp
argument_list|(
name|null_str
argument_list|,
name|p_val_str
argument_list|)
condition|?
name|strdup
argument_list|(
name|p_val_str
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p_val1
operator|&&
operator|*
name|p_val1
operator|!=
operator|*
name|p_val2
condition|)
name|free
argument_list|(
operator|*
name|p_val1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p_val2
condition|)
name|free
argument_list|(
operator|*
name|p_val2
argument_list|)
expr_stmt|;
operator|*
name|p_val1
operator|=
operator|*
name|p_val2
operator|=
name|new
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_256bit
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|uint8_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|uint8_t
name|val
index|[
name|IB_CC_PORT_MASK_DATA_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|char
name|tmpbuf
index|[
literal|3
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint8_t
name|tmpint
decl_stmt|;
name|int
name|numdigits
init|=
literal|0
decl_stmt|;
name|int
name|startindex
decl_stmt|;
name|char
modifier|*
name|strptr
init|=
name|p_val_str
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* parse like it's hypothetically a 256 bit integer code 	 * 	 * store "big endian" 	 */
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|strptr
argument_list|,
literal|"0x"
argument_list|,
literal|2
argument_list|)
operator|||
operator|!
name|strncmp
argument_list|(
name|strptr
argument_list|,
literal|"0X"
argument_list|,
literal|2
argument_list|)
condition|)
name|strptr
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|ptr
operator|=
name|strptr
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
name|log_report
argument_list|(
literal|"invalid hex digit in bitmask\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|numdigits
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|numdigits
condition|)
block|{
name|log_report
argument_list|(
literal|"invalid length bitmask\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* max of 2 hex chars per byte */
if|if
condition|(
name|numdigits
operator|>
name|IB_CC_PORT_MASK_DATA_SIZE
operator|*
literal|2
condition|)
name|numdigits
operator|=
name|IB_CC_PORT_MASK_DATA_SIZE
operator|*
literal|2
expr_stmt|;
name|startindex
operator|=
name|IB_CC_PORT_MASK_DATA_SIZE
operator|-
operator|(
operator|(
name|numdigits
operator|-
literal|1
operator|)
operator|/
literal|2
operator|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|numdigits
operator|%
literal|2
condition|)
block|{
name|memcpy
argument_list|(
name|tmpbuf
argument_list|,
name|strptr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|strptr
operator|+=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|tmpbuf
argument_list|,
name|strptr
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|strptr
operator|+=
literal|2
expr_stmt|;
block|}
name|tmpint
operator|=
name|strtoul
argument_list|(
name|tmpbuf
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|val
index|[
name|startindex
index|]
operator|=
name|tmpint
expr_stmt|;
for|for
control|(
name|i
operator|=
operator|(
name|startindex
operator|+
literal|1
operator|)
init|;
name|i
operator|<
name|IB_CC_PORT_MASK_DATA_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|memcpy
argument_list|(
name|tmpbuf
argument_list|,
name|strptr
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|strptr
operator|+=
literal|2
expr_stmt|;
name|tmpint
operator|=
name|strtoul
argument_list|(
name|tmpbuf
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|val
index|[
name|i
index|]
operator|=
name|tmpint
expr_stmt|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|val
argument_list|,
name|p_val1
argument_list|,
name|IB_CC_PORT_MASK_DATA_SIZE
argument_list|)
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%s"
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_val1
argument_list|,
name|val
argument_list|,
name|IB_CC_PORT_MASK_DATA_SIZE
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_val2
argument_list|,
name|val
argument_list|,
name|IB_CC_PORT_MASK_DATA_SIZE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_cct_entry
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|osm_cct_entry_t
modifier|*
name|p_cct1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_cct2
init|=
name|p_v2
decl_stmt|;
name|osm_cct_entry_t
name|cct
decl_stmt|;
name|char
name|buf
index|[
literal|512
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|strncpy
argument_list|(
name|buf
argument_list|,
name|p_val_str
argument_list|,
literal|511
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ptr
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|':'
argument_list|)
operator|)
condition|)
block|{
name|log_report
argument_list|(
literal|"invalid CCT entry\n"
argument_list|)
expr_stmt|;
return|return;
block|}
operator|*
name|ptr
operator|=
literal|'\0'
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|cct
operator|.
name|shift
operator|=
name|strtoul
argument_list|(
name|buf
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cct
operator|.
name|multiplier
operator|=
name|strtoul
argument_list|(
name|ptr
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cct
operator|.
name|shift
operator|!=
name|p_cct1
operator|->
name|shift
operator|||
name|cct
operator|.
name|multiplier
operator|!=
name|p_cct1
operator|->
name|multiplier
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%s"
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|cct
argument_list|)
expr_stmt|;
name|p_cct1
operator|->
name|shift
operator|=
name|p_cct2
operator|->
name|shift
operator|=
name|cct
operator|.
name|shift
expr_stmt|;
name|p_cct1
operator|->
name|multiplier
operator|=
name|p_cct2
operator|->
name|multiplier
operator|=
name|cct
operator|.
name|multiplier
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_cc_cct
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|osm_cct_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
specifier|const
name|char
modifier|*
name|current_str
init|=
name|p_val1
operator|->
name|input_str
condition|?
name|p_val1
operator|->
name|input_str
else|:
name|null_str
decl_stmt|;
if|if
condition|(
name|p_val_str
operator|&&
name|strcmp
argument_list|(
name|p_val_str
argument_list|,
name|current_str
argument_list|)
condition|)
block|{
name|osm_cct_t
name|newcct
decl_stmt|;
name|char
modifier|*
name|new
decl_stmt|;
name|unsigned
name|int
name|len
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|lasts
decl_stmt|;
name|char
modifier|*
name|tok
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
comment|/* special case the "(null)" string */
name|new
operator|=
name|strcmp
argument_list|(
name|null_str
argument_list|,
name|p_val_str
argument_list|)
condition|?
name|strdup
argument_list|(
name|p_val_str
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|new
condition|)
block|{
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%s"
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_val1
operator|->
name|entries
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
name|p_val1
operator|->
name|entries
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_val2
operator|->
name|entries
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
name|p_val2
operator|->
name|entries
argument_list|)
argument_list|)
expr_stmt|;
name|p_val1
operator|->
name|entries_len
operator|=
name|p_val2
operator|->
name|entries_len
operator|=
literal|0
expr_stmt|;
name|p_val1
operator|->
name|input_str
operator|=
name|p_val2
operator|->
name|input_str
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
name|memset
argument_list|(
operator|&
name|newcct
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
name|newcct
argument_list|)
argument_list|)
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|new
argument_list|,
literal|","
argument_list|,
operator|&
name|lasts
argument_list|)
expr_stmt|;
while|while
condition|(
name|tok
operator|&&
name|len
operator|<
name|OSM_CCT_ENTRY_MAX
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ptr
operator|=
name|strchr
argument_list|(
name|tok
argument_list|,
literal|':'
argument_list|)
operator|)
condition|)
block|{
name|log_report
argument_list|(
literal|"invalid CCT entry\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|new
argument_list|)
expr_stmt|;
return|return;
block|}
operator|*
name|ptr
operator|=
literal|'\0'
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|newcct
operator|.
name|entries
index|[
name|len
index|]
operator|.
name|shift
operator|=
name|strtoul
argument_list|(
name|tok
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|newcct
operator|.
name|entries
index|[
name|len
index|]
operator|.
name|multiplier
operator|=
name|strtoul
argument_list|(
name|ptr
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|len
operator|++
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|","
argument_list|,
operator|&
name|lasts
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|new
argument_list|)
expr_stmt|;
name|newcct
operator|.
name|entries_len
operator|=
name|len
expr_stmt|;
name|newcct
operator|.
name|input_str
operator|=
name|strdup
argument_list|(
name|p_val_str
argument_list|)
expr_stmt|;
name|log_config_value
argument_list|(
name|p_key
argument_list|,
literal|"%s"
argument_list|,
name|p_val_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfn
condition|)
name|pfn
argument_list|(
name|p_subn
argument_list|,
operator|&
name|newcct
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_val1
operator|->
name|input_str
operator|&&
name|p_val1
operator|->
name|input_str
operator|!=
name|p_val2
operator|->
name|input_str
condition|)
name|free
argument_list|(
name|p_val1
operator|->
name|input_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_val2
operator|->
name|input_str
condition|)
name|free
argument_list|(
name|p_val2
operator|->
name|input_str
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_val1
operator|->
name|entries
argument_list|,
name|newcct
operator|.
name|entries
argument_list|,
sizeof|sizeof
argument_list|(
name|newcct
operator|.
name|entries
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_val2
operator|->
name|entries
argument_list|,
name|newcct
operator|.
name|entries
argument_list|,
sizeof|sizeof
argument_list|(
name|newcct
operator|.
name|entries
argument_list|)
argument_list|)
expr_stmt|;
name|p_val1
operator|->
name|entries_len
operator|=
name|p_val2
operator|->
name|entries_len
operator|=
name|newcct
operator|.
name|entries_len
expr_stmt|;
name|p_val1
operator|->
name|input_str
operator|=
name|p_val2
operator|->
name|input_str
operator|=
name|newcct
operator|.
name|input_str
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|parse_ca_cong_common
parameter_list|(
name|char
modifier|*
name|p_val_str
parameter_list|,
name|uint8_t
modifier|*
name|sl
parameter_list|,
name|unsigned
name|int
modifier|*
name|val_offset
parameter_list|)
block|{
name|char
modifier|*
name|new
decl_stmt|,
modifier|*
name|lasts
decl_stmt|,
modifier|*
name|sl_str
decl_stmt|,
modifier|*
name|val_str
decl_stmt|;
name|uint8_t
name|sltmp
decl_stmt|;
name|new
operator|=
name|strcmp
argument_list|(
name|null_str
argument_list|,
name|p_val_str
argument_list|)
condition|?
name|strdup
argument_list|(
name|p_val_str
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|new
condition|)
return|return
operator|-
literal|1
return|;
name|sl_str
operator|=
name|strtok_r
argument_list|(
name|new
argument_list|,
literal|" \t"
argument_list|,
operator|&
name|lasts
argument_list|)
expr_stmt|;
name|val_str
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|" \t"
argument_list|,
operator|&
name|lasts
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|val_str
condition|)
block|{
name|log_report
argument_list|(
literal|"value must be specified in addition to SL\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|new
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sltmp
operator|=
name|strtoul
argument_list|(
name|sl_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sltmp
operator|>=
name|IB_CA_CONG_ENTRY_DATA_SIZE
condition|)
block|{
name|log_report
argument_list|(
literal|"invalid SL specified\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|new
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|sl
operator|=
name|sltmp
expr_stmt|;
operator|*
name|val_offset
operator|=
call|(
name|unsigned
name|int
call|)
argument_list|(
name|val_str
operator|-
name|new
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|new
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_ccti_timer
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|osm_cacongestion_entry_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|unsigned
name|int
name|val_offset
init|=
literal|0
decl_stmt|;
name|uint8_t
name|sl
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|parse_ca_cong_common
argument_list|(
name|p_val_str
argument_list|,
operator|&
name|sl
argument_list|,
operator|&
name|val_offset
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|opts_parse_net16
argument_list|(
name|p_subn
argument_list|,
name|p_key
argument_list|,
name|p_val_str
operator|+
name|val_offset
argument_list|,
operator|&
name|p_val1
index|[
name|sl
index|]
operator|.
name|ccti_timer
argument_list|,
operator|&
name|p_val2
index|[
name|sl
index|]
operator|.
name|ccti_timer
argument_list|,
name|pfn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_ccti_increase
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|osm_cacongestion_entry_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|unsigned
name|int
name|val_offset
init|=
literal|0
decl_stmt|;
name|uint8_t
name|sl
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|parse_ca_cong_common
argument_list|(
name|p_val_str
argument_list|,
operator|&
name|sl
argument_list|,
operator|&
name|val_offset
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|opts_parse_uint8
argument_list|(
name|p_subn
argument_list|,
name|p_key
argument_list|,
name|p_val_str
operator|+
name|val_offset
argument_list|,
operator|&
name|p_val1
index|[
name|sl
index|]
operator|.
name|ccti_increase
argument_list|,
operator|&
name|p_val2
index|[
name|sl
index|]
operator|.
name|ccti_increase
argument_list|,
name|pfn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_trigger_threshold
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|osm_cacongestion_entry_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|unsigned
name|int
name|val_offset
init|=
literal|0
decl_stmt|;
name|uint8_t
name|sl
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|parse_ca_cong_common
argument_list|(
name|p_val_str
argument_list|,
operator|&
name|sl
argument_list|,
operator|&
name|val_offset
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|opts_parse_uint8
argument_list|(
name|p_subn
argument_list|,
name|p_key
argument_list|,
name|p_val_str
operator|+
name|val_offset
argument_list|,
operator|&
name|p_val1
index|[
name|sl
index|]
operator|.
name|trigger_threshold
argument_list|,
operator|&
name|p_val2
index|[
name|sl
index|]
operator|.
name|trigger_threshold
argument_list|,
name|pfn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|opts_parse_ccti_min
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|char
modifier|*
name|p_key
parameter_list|,
name|IN
name|char
modifier|*
name|p_val_str
parameter_list|,
name|void
modifier|*
name|p_v1
parameter_list|,
name|void
modifier|*
name|p_v2
parameter_list|,
name|void
function_decl|(
modifier|*
name|pfn
function_decl|)
parameter_list|(
name|osm_subn_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|osm_cacongestion_entry_t
modifier|*
name|p_val1
init|=
name|p_v1
decl_stmt|,
modifier|*
name|p_val2
init|=
name|p_v2
decl_stmt|;
name|unsigned
name|int
name|val_offset
init|=
literal|0
decl_stmt|;
name|uint8_t
name|sl
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|parse_ca_cong_common
argument_list|(
name|p_val_str
argument_list|,
operator|&
name|sl
argument_list|,
operator|&
name|val_offset
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|opts_parse_uint8
argument_list|(
name|p_subn
argument_list|,
name|p_key
argument_list|,
name|p_val_str
operator|+
name|val_offset
argument_list|,
operator|&
name|p_val1
index|[
name|sl
index|]
operator|.
name|ccti_min
argument_list|,
operator|&
name|p_val2
index|[
name|sl
index|]
operator|.
name|ccti_min
argument_list|,
name|pfn
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|opt_rec_t
name|opt_tbl
index|[]
init|=
block|{
block|{
literal|"guid"
block|,
name|OPT_OFFSET
argument_list|(
name|guid
argument_list|)
block|,
name|opts_parse_net64
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"m_key"
block|,
name|OPT_OFFSET
argument_list|(
name|m_key
argument_list|)
block|,
name|opts_parse_net64
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"sm_key"
block|,
name|OPT_OFFSET
argument_list|(
name|sm_key
argument_list|)
block|,
name|opts_parse_net64
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"sa_key"
block|,
name|OPT_OFFSET
argument_list|(
name|sa_key
argument_list|)
block|,
name|opts_parse_net64
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"subnet_prefix"
block|,
name|OPT_OFFSET
argument_list|(
name|subnet_prefix
argument_list|)
block|,
name|opts_parse_net64
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"m_key_lease_period"
block|,
name|OPT_OFFSET
argument_list|(
name|m_key_lease_period
argument_list|)
block|,
name|opts_parse_net16
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"m_key_protection_level"
block|,
name|OPT_OFFSET
argument_list|(
name|m_key_protect_bits
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"m_key_lookup"
block|,
name|OPT_OFFSET
argument_list|(
name|m_key_lookup
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"sweep_interval"
block|,
name|OPT_OFFSET
argument_list|(
name|sweep_interval
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"max_wire_smps"
block|,
name|OPT_OFFSET
argument_list|(
name|max_wire_smps
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"max_wire_smps2"
block|,
name|OPT_OFFSET
argument_list|(
name|max_wire_smps2
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"max_smps_timeout"
block|,
name|OPT_OFFSET
argument_list|(
name|max_smps_timeout
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"console"
block|,
name|OPT_OFFSET
argument_list|(
name|console
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"console_port"
block|,
name|OPT_OFFSET
argument_list|(
name|console_port
argument_list|)
block|,
name|opts_parse_uint16
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"transaction_timeout"
block|,
name|OPT_OFFSET
argument_list|(
name|transaction_timeout
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"transaction_retries"
block|,
name|OPT_OFFSET
argument_list|(
name|transaction_retries
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"max_msg_fifo_timeout"
block|,
name|OPT_OFFSET
argument_list|(
name|max_msg_fifo_timeout
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"sm_priority"
block|,
name|OPT_OFFSET
argument_list|(
name|sm_priority
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|opts_setup_sm_priority
block|,
literal|1
block|}
block|,
block|{
literal|"lmc"
block|,
name|OPT_OFFSET
argument_list|(
name|lmc
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"lmc_esp0"
block|,
name|OPT_OFFSET
argument_list|(
name|lmc_esp0
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"max_op_vls"
block|,
name|OPT_OFFSET
argument_list|(
name|max_op_vls
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"force_link_speed"
block|,
name|OPT_OFFSET
argument_list|(
name|force_link_speed
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"force_link_speed_ext"
block|,
name|OPT_OFFSET
argument_list|(
name|force_link_speed_ext
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"fdr10"
block|,
name|OPT_OFFSET
argument_list|(
name|fdr10
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"reassign_lids"
block|,
name|OPT_OFFSET
argument_list|(
name|reassign_lids
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"ignore_other_sm"
block|,
name|OPT_OFFSET
argument_list|(
name|ignore_other_sm
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"single_thread"
block|,
name|OPT_OFFSET
argument_list|(
name|single_thread
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"disable_multicast"
block|,
name|OPT_OFFSET
argument_list|(
name|disable_multicast
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"subnet_timeout"
block|,
name|OPT_OFFSET
argument_list|(
name|subnet_timeout
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"packet_life_time"
block|,
name|OPT_OFFSET
argument_list|(
name|packet_life_time
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"vl_stall_count"
block|,
name|OPT_OFFSET
argument_list|(
name|vl_stall_count
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"leaf_vl_stall_count"
block|,
name|OPT_OFFSET
argument_list|(
name|leaf_vl_stall_count
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"head_of_queue_lifetime"
block|,
name|OPT_OFFSET
argument_list|(
name|head_of_queue_lifetime
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"leaf_head_of_queue_lifetime"
block|,
name|OPT_OFFSET
argument_list|(
name|leaf_head_of_queue_lifetime
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"local_phy_errors_threshold"
block|,
name|OPT_OFFSET
argument_list|(
name|local_phy_errors_threshold
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"overrun_errors_threshold"
block|,
name|OPT_OFFSET
argument_list|(
name|overrun_errors_threshold
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"use_mfttop"
block|,
name|OPT_OFFSET
argument_list|(
name|use_mfttop
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"sminfo_polling_timeout"
block|,
name|OPT_OFFSET
argument_list|(
name|sminfo_polling_timeout
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|opts_setup_sminfo_polling_timeout
block|,
literal|1
block|}
block|,
block|{
literal|"polling_retry_number"
block|,
name|OPT_OFFSET
argument_list|(
name|polling_retry_number
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"force_heavy_sweep"
block|,
name|OPT_OFFSET
argument_list|(
name|force_heavy_sweep
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"port_prof_ignore_file"
block|,
name|OPT_OFFSET
argument_list|(
name|port_prof_ignore_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"hop_weights_file"
block|,
name|OPT_OFFSET
argument_list|(
name|hop_weights_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"dimn_ports_file"
block|,
name|OPT_OFFSET
argument_list|(
name|port_search_ordering_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"port_search_ordering_file"
block|,
name|OPT_OFFSET
argument_list|(
name|port_search_ordering_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"port_profile_switch_nodes"
block|,
name|OPT_OFFSET
argument_list|(
name|port_profile_switch_nodes
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"sweep_on_trap"
block|,
name|OPT_OFFSET
argument_list|(
name|sweep_on_trap
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"routing_engine"
block|,
name|OPT_OFFSET
argument_list|(
name|routing_engine_names
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"connect_roots"
block|,
name|OPT_OFFSET
argument_list|(
name|connect_roots
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"use_ucast_cache"
block|,
name|OPT_OFFSET
argument_list|(
name|use_ucast_cache
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"log_file"
block|,
name|OPT_OFFSET
argument_list|(
name|log_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"log_max_size"
block|,
name|OPT_OFFSET
argument_list|(
name|log_max_size
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|opts_setup_log_max_size
block|,
literal|1
block|}
block|,
block|{
literal|"log_flags"
block|,
name|OPT_OFFSET
argument_list|(
name|log_flags
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|opts_setup_log_flags
block|,
literal|1
block|}
block|,
block|{
literal|"force_log_flush"
block|,
name|OPT_OFFSET
argument_list|(
name|force_log_flush
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|opts_setup_force_log_flush
block|,
literal|1
block|}
block|,
block|{
literal|"accum_log_file"
block|,
name|OPT_OFFSET
argument_list|(
name|accum_log_file
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|opts_setup_accum_log_file
block|,
literal|1
block|}
block|,
block|{
literal|"partition_config_file"
block|,
name|OPT_OFFSET
argument_list|(
name|partition_config_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"no_partition_enforcement"
block|,
name|OPT_OFFSET
argument_list|(
name|no_partition_enforcement
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"part_enforce"
block|,
name|OPT_OFFSET
argument_list|(
name|part_enforce
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"allow_both_pkeys"
block|,
name|OPT_OFFSET
argument_list|(
name|allow_both_pkeys
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"sm_assigned_guid"
block|,
name|OPT_OFFSET
argument_list|(
name|sm_assigned_guid
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos"
block|,
name|OPT_OFFSET
argument_list|(
name|qos
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_policy_file"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_policy_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"suppress_sl2vl_mad_status_errors"
block|,
name|OPT_OFFSET
argument_list|(
name|suppress_sl2vl_mad_status_errors
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"dump_files_dir"
block|,
name|OPT_OFFSET
argument_list|(
name|dump_files_dir
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"lid_matrix_dump_file"
block|,
name|OPT_OFFSET
argument_list|(
name|lid_matrix_dump_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"lfts_file"
block|,
name|OPT_OFFSET
argument_list|(
name|lfts_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"root_guid_file"
block|,
name|OPT_OFFSET
argument_list|(
name|root_guid_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"cn_guid_file"
block|,
name|OPT_OFFSET
argument_list|(
name|cn_guid_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"io_guid_file"
block|,
name|OPT_OFFSET
argument_list|(
name|io_guid_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"port_shifting"
block|,
name|OPT_OFFSET
argument_list|(
name|port_shifting
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"scatter_ports"
block|,
name|OPT_OFFSET
argument_list|(
name|scatter_ports
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"max_reverse_hops"
block|,
name|OPT_OFFSET
argument_list|(
name|max_reverse_hops
argument_list|)
block|,
name|opts_parse_uint16
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"ids_guid_file"
block|,
name|OPT_OFFSET
argument_list|(
name|ids_guid_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"guid_routing_order_file"
block|,
name|OPT_OFFSET
argument_list|(
name|guid_routing_order_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"guid_routing_order_no_scatter"
block|,
name|OPT_OFFSET
argument_list|(
name|guid_routing_order_no_scatter
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"sa_db_file"
block|,
name|OPT_OFFSET
argument_list|(
name|sa_db_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"sa_db_dump"
block|,
name|OPT_OFFSET
argument_list|(
name|sa_db_dump
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"torus_config"
block|,
name|OPT_OFFSET
argument_list|(
name|torus_conf_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"do_mesh_analysis"
block|,
name|OPT_OFFSET
argument_list|(
name|do_mesh_analysis
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"exit_on_fatal"
block|,
name|OPT_OFFSET
argument_list|(
name|exit_on_fatal
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"honor_guid2lid_file"
block|,
name|OPT_OFFSET
argument_list|(
name|honor_guid2lid_file
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"daemon"
block|,
name|OPT_OFFSET
argument_list|(
name|daemon
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"sm_inactive"
block|,
name|OPT_OFFSET
argument_list|(
name|sm_inactive
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"babbling_port_policy"
block|,
name|OPT_OFFSET
argument_list|(
name|babbling_port_policy
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"drop_event_subscriptions"
block|,
name|OPT_OFFSET
argument_list|(
name|drop_event_subscriptions
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"ipoib_mcgroup_creation_validation"
block|,
name|OPT_OFFSET
argument_list|(
name|ipoib_mcgroup_creation_validation
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"mcgroup_join_validation"
block|,
name|OPT_OFFSET
argument_list|(
name|mcgroup_join_validation
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"use_optimized_slvl"
block|,
name|OPT_OFFSET
argument_list|(
name|use_optimized_slvl
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"fsync_high_avail_files"
block|,
name|OPT_OFFSET
argument_list|(
name|fsync_high_avail_files
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
block|{
literal|"perfmgr"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"perfmgr_redir"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr_redir
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"perfmgr_sweep_time_s"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr_sweep_time_s
argument_list|)
block|,
name|opts_parse_uint16
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"perfmgr_max_outstanding_queries"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr_max_outstanding_queries
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"perfmgr_ignore_cas"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr_ignore_cas
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"event_db_dump_file"
block|,
name|OPT_OFFSET
argument_list|(
name|event_db_dump_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"perfmgr_rm_nodes"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr_rm_nodes
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"perfmgr_log_errors"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr_log_errors
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"perfmgr_query_cpi"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr_query_cpi
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"perfmgr_xmit_wait_log"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr_xmit_wait_log
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"perfmgr_xmit_wait_threshold"
block|,
name|OPT_OFFSET
argument_list|(
name|perfmgr_xmit_wait_threshold
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|0
block|}
block|,
endif|#
directive|endif
comment|/* ENABLE_OSM_PERF_MGR */
block|{
literal|"event_plugin_name"
block|,
name|OPT_OFFSET
argument_list|(
name|event_plugin_name
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"event_plugin_options"
block|,
name|OPT_OFFSET
argument_list|(
name|event_plugin_options
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"node_name_map_name"
block|,
name|OPT_OFFSET
argument_list|(
name|node_name_map_name
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"qos_max_vls"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_options
operator|.
name|max_vls
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_high_limit"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_options
operator|.
name|high_limit
argument_list|)
block|,
name|opts_parse_int32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_vlarb_high"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_options
operator|.
name|vlarb_high
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_vlarb_low"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_options
operator|.
name|vlarb_low
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_sl2vl"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_options
operator|.
name|sl2vl
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_ca_max_vls"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_ca_options
operator|.
name|max_vls
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_ca_high_limit"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_ca_options
operator|.
name|high_limit
argument_list|)
block|,
name|opts_parse_int32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_ca_vlarb_high"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_ca_options
operator|.
name|vlarb_high
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_ca_vlarb_low"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_ca_options
operator|.
name|vlarb_low
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_ca_sl2vl"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_ca_options
operator|.
name|sl2vl
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_sw0_max_vls"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_sw0_options
operator|.
name|max_vls
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_sw0_high_limit"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_sw0_options
operator|.
name|high_limit
argument_list|)
block|,
name|opts_parse_int32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_sw0_vlarb_high"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_sw0_options
operator|.
name|vlarb_high
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_sw0_vlarb_low"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_sw0_options
operator|.
name|vlarb_low
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_sw0_sl2vl"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_sw0_options
operator|.
name|sl2vl
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_swe_max_vls"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_swe_options
operator|.
name|max_vls
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_swe_high_limit"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_swe_options
operator|.
name|high_limit
argument_list|)
block|,
name|opts_parse_int32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_swe_vlarb_high"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_swe_options
operator|.
name|vlarb_high
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_swe_vlarb_low"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_swe_options
operator|.
name|vlarb_low
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_swe_sl2vl"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_swe_options
operator|.
name|sl2vl
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_rtr_max_vls"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_rtr_options
operator|.
name|max_vls
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_rtr_high_limit"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_rtr_options
operator|.
name|high_limit
argument_list|)
block|,
name|opts_parse_int32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_rtr_vlarb_high"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_rtr_options
operator|.
name|vlarb_high
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_rtr_vlarb_low"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_rtr_options
operator|.
name|vlarb_low
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"qos_rtr_sl2vl"
block|,
name|OPT_OFFSET
argument_list|(
name|qos_rtr_options
operator|.
name|sl2vl
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"congestion_control"
block|,
name|OPT_OFFSET
argument_list|(
name|congestion_control
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_key"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_key
argument_list|)
block|,
name|opts_parse_net64
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"cc_max_outstanding_mads"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_max_outstanding_mads
argument_list|)
block|,
name|opts_parse_uint32
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"cc_sw_cong_setting_control_map"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_sw_cong_setting_control_map
argument_list|)
block|,
name|opts_parse_net32
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_sw_cong_setting_victim_mask"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_sw_cong_setting_victim_mask
argument_list|)
block|,
name|opts_parse_256bit
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_sw_cong_setting_credit_mask"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_sw_cong_setting_credit_mask
argument_list|)
block|,
name|opts_parse_256bit
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_sw_cong_setting_threshold"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_sw_cong_setting_threshold
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_sw_cong_setting_packet_size"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_sw_cong_setting_packet_size
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_sw_cong_setting_credit_starvation_threshold"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_sw_cong_setting_credit_starvation_threshold
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_sw_cong_setting_credit_starvation_return_delay"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_sw_cong_setting_credit_starvation_return_delay
argument_list|)
block|,
name|opts_parse_cct_entry
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_sw_cong_setting_marking_rate"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_sw_cong_setting_marking_rate
argument_list|)
block|,
name|opts_parse_net16
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_ca_cong_setting_port_control"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_ca_cong_setting_port_control
argument_list|)
block|,
name|opts_parse_net16
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_ca_cong_setting_control_map"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_ca_cong_setting_control_map
argument_list|)
block|,
name|opts_parse_net16
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_ca_cong_setting_ccti_timer"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_ca_cong_entries
argument_list|)
block|,
name|opts_parse_ccti_timer
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_ca_cong_setting_ccti_increase"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_ca_cong_entries
argument_list|)
block|,
name|opts_parse_ccti_increase
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_ca_cong_setting_trigger_threshold"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_ca_cong_entries
argument_list|)
block|,
name|opts_parse_trigger_threshold
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_ca_cong_setting_ccti_min"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_ca_cong_entries
argument_list|)
block|,
name|opts_parse_ccti_min
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"cc_cct"
block|,
name|OPT_OFFSET
argument_list|(
name|cc_cct
argument_list|)
block|,
name|opts_parse_cc_cct
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"enable_quirks"
block|,
name|OPT_OFFSET
argument_list|(
name|enable_quirks
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"no_clients_rereg"
block|,
name|OPT_OFFSET
argument_list|(
name|no_clients_rereg
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"prefix_routes_file"
block|,
name|OPT_OFFSET
argument_list|(
name|prefix_routes_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"consolidate_ipv6_snm_req"
block|,
name|OPT_OFFSET
argument_list|(
name|consolidate_ipv6_snm_req
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"lash_start_vl"
block|,
name|OPT_OFFSET
argument_list|(
name|lash_start_vl
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"sm_sl"
block|,
name|OPT_OFFSET
argument_list|(
name|sm_sl
argument_list|)
block|,
name|opts_parse_uint8
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"log_prefix"
block|,
name|OPT_OFFSET
argument_list|(
name|log_prefix
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|"per_module_logging_file"
block|,
name|OPT_OFFSET
argument_list|(
name|per_module_logging_file
argument_list|)
block|,
name|opts_parse_charp
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"quasi_ftree_indexing"
block|,
name|OPT_OFFSET
argument_list|(
name|quasi_ftree_indexing
argument_list|)
block|,
name|opts_parse_boolean
block|,
name|NULL
block|,
literal|1
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|compar_mgids
parameter_list|(
specifier|const
name|void
modifier|*
name|m1
parameter_list|,
specifier|const
name|void
modifier|*
name|m2
parameter_list|)
block|{
return|return
name|memcmp
argument_list|(
name|m1
argument_list|,
name|m2
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_gid_t
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_validate_g2m
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|)
block|{
name|cl_qlist_t
name|guids
decl_stmt|;
name|osm_db_guid_elem_t
modifier|*
name|p_item
decl_stmt|;
name|uint64_t
name|mkey
decl_stmt|;
name|boolean_t
name|valid_entry
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|)
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|guids
argument_list|)
expr_stmt|;
if|if
condition|(
name|osm_db_guid2mkey_guids
argument_list|(
name|p_subn
operator|->
name|p_g2m
argument_list|,
operator|&
name|guids
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7506: "
literal|"could not get mkey guid list\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
while|while
condition|(
operator|(
name|p_item
operator|=
operator|(
name|osm_db_guid_elem_t
operator|*
operator|)
name|cl_qlist_remove_head
argument_list|(
operator|&
name|guids
argument_list|)
operator|)
operator|!=
operator|(
name|osm_db_guid_elem_t
operator|*
operator|)
name|cl_qlist_end
argument_list|(
operator|&
name|guids
argument_list|)
condition|)
block|{
name|valid_entry
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|p_item
operator|->
name|guid
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7507: found invalid zero guid"
argument_list|)
expr_stmt|;
name|valid_entry
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|osm_db_guid2mkey_get
argument_list|(
name|p_subn
operator|->
name|p_g2m
argument_list|,
name|p_item
operator|->
name|guid
argument_list|,
operator|&
name|mkey
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7508: could not get mkey for guid:0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|p_item
operator|->
name|guid
argument_list|)
expr_stmt|;
name|valid_entry
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|valid_entry
operator|==
name|FALSE
condition|)
block|{
if|if
condition|(
name|osm_db_guid2mkey_delete
argument_list|(
name|p_subn
operator|->
name|p_g2m
argument_list|,
name|p_item
operator|->
name|guid
argument_list|)
condition|)
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7509: failed to delete entry for "
literal|"guid:0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|p_item
operator|->
name|guid
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_validate_neighbor
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|)
block|{
name|cl_qlist_t
name|entries
decl_stmt|;
name|osm_db_neighbor_elem_t
modifier|*
name|p_item
decl_stmt|;
name|boolean_t
name|valid_entry
decl_stmt|;
name|uint64_t
name|guid
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|)
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|osm_db_neighbor_guids
argument_list|(
name|p_subn
operator|->
name|p_neighbor
argument_list|,
operator|&
name|entries
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7512: "
literal|"could not get neighbor entry list\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
while|while
condition|(
operator|(
name|p_item
operator|=
operator|(
name|osm_db_neighbor_elem_t
operator|*
operator|)
name|cl_qlist_remove_head
argument_list|(
operator|&
name|entries
argument_list|)
operator|)
operator|!=
operator|(
name|osm_db_neighbor_elem_t
operator|*
operator|)
name|cl_qlist_end
argument_list|(
operator|&
name|entries
argument_list|)
condition|)
block|{
name|valid_entry
operator|=
name|TRUE
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"Validating neighbor for guid:0x%016"
name|PRIx64
literal|", port %d\n"
argument_list|,
name|p_item
operator|->
name|guid
argument_list|,
name|p_item
operator|->
name|portnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_item
operator|->
name|guid
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7513: found invalid zero guid\n"
argument_list|)
expr_stmt|;
name|valid_entry
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_item
operator|->
name|portnum
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7514: found invalid zero port for "
literal|"guid: 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|p_item
operator|->
name|guid
argument_list|)
expr_stmt|;
name|valid_entry
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|osm_db_neighbor_get
argument_list|(
name|p_subn
operator|->
name|p_neighbor
argument_list|,
name|p_item
operator|->
name|guid
argument_list|,
name|p_item
operator|->
name|portnum
argument_list|,
operator|&
name|guid
argument_list|,
operator|&
name|port
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7515: could not find neighbor for "
literal|"guid: 0x%016"
name|PRIx64
literal|", port %d\n"
argument_list|,
name|p_item
operator|->
name|guid
argument_list|,
name|p_item
operator|->
name|portnum
argument_list|)
expr_stmt|;
name|valid_entry
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|guid
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7516: found invalid neighbor "
literal|"zero guid for guid: 0x%016"
name|PRIx64
literal|", port %d\n"
argument_list|,
name|p_item
operator|->
name|guid
argument_list|,
name|p_item
operator|->
name|portnum
argument_list|)
expr_stmt|;
name|valid_entry
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|port
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7517: found invalid neighbor "
literal|"zero port for guid: 0x%016"
name|PRIx64
literal|", port %d\n"
argument_list|,
name|p_item
operator|->
name|guid
argument_list|,
name|p_item
operator|->
name|portnum
argument_list|)
expr_stmt|;
name|valid_entry
operator|=
name|FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|osm_db_neighbor_get
argument_list|(
name|p_subn
operator|->
name|p_neighbor
argument_list|,
name|guid
argument_list|,
name|port
argument_list|,
operator|&
name|guid
argument_list|,
operator|&
name|port
argument_list|)
operator|||
name|guid
operator|!=
name|p_item
operator|->
name|guid
operator|||
name|port
operator|!=
name|p_item
operator|->
name|portnum
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7518: neighbor does not point "
literal|"back at us (guid: 0x%016"
name|PRIx64
literal|", port %d)\n"
argument_list|,
name|p_item
operator|->
name|guid
argument_list|,
name|p_item
operator|->
name|portnum
argument_list|)
expr_stmt|;
name|valid_entry
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|valid_entry
operator|==
name|FALSE
condition|)
block|{
if|if
condition|(
name|osm_db_neighbor_delete
argument_list|(
name|p_subn
operator|->
name|p_neighbor
argument_list|,
name|p_item
operator|->
name|guid
argument_list|,
name|p_item
operator|->
name|portnum
argument_list|)
condition|)
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7519: failed to delete entry for "
literal|"guid:0x%016"
name|PRIx64
literal|" port:%u\n"
argument_list|,
name|p_item
operator|->
name|guid
argument_list|,
name|p_item
operator|->
name|portnum
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|p_item
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|p_osm
operator|->
name|log
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_subn_construct
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|)
block|{
name|memset
argument_list|(
name|p_subn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_subn
argument_list|)
argument_list|)
expr_stmt|;
name|cl_ptr_vector_construct
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|sw_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|node_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|port_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|alias_port_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|assigned_guids_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|sm_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_sr_list
argument_list|)
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|p_subn
operator|->
name|alias_guid_list
argument_list|)
expr_stmt|;
name|cl_qlist_init
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|rtr_guid_tbl
argument_list|)
expr_stmt|;
name|cl_qmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|prtn_pkey_tbl
argument_list|)
expr_stmt|;
name|cl_fmap_init
argument_list|(
operator|&
name|p_subn
operator|->
name|mgrp_mgid_tbl
argument_list|,
name|compar_mgids
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_destroy_qos_options
parameter_list|(
name|osm_qos_options_t
modifier|*
name|opt
parameter_list|)
block|{
name|free
argument_list|(
name|opt
operator|->
name|vlarb_high
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|opt
operator|->
name|vlarb_low
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|opt
operator|->
name|sl2vl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_opt_destroy
parameter_list|(
name|IN
name|osm_subn_opt_t
modifier|*
name|p_opt
parameter_list|)
block|{
name|free
argument_list|(
name|p_opt
operator|->
name|console
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|port_prof_ignore_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|hop_weights_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|port_search_ordering_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|routing_engine_names
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|log_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|partition_config_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|qos_policy_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|dump_files_dir
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|part_enforce
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|lid_matrix_dump_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|lfts_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|root_guid_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|cn_guid_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|io_guid_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|ids_guid_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|guid_routing_order_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|sa_db_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|torus_conf_file
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
name|free
argument_list|(
name|p_opt
operator|->
name|event_db_dump_file
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* ENABLE_OSM_PERF_MGR */
name|free
argument_list|(
name|p_opt
operator|->
name|event_plugin_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|event_plugin_options
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|node_name_map_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|prefix_routes_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|log_prefix
argument_list|)
expr_stmt|;
name|subn_destroy_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_options
argument_list|)
expr_stmt|;
name|subn_destroy_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_ca_options
argument_list|)
expr_stmt|;
name|subn_destroy_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_sw0_options
argument_list|)
expr_stmt|;
name|subn_destroy_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_swe_options
argument_list|)
expr_stmt|;
name|subn_destroy_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_rtr_options
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opt
operator|->
name|cc_cct
operator|.
name|input_str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_subn_destroy
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|osm_node_t
modifier|*
name|p_node
decl_stmt|,
modifier|*
name|p_next_node
decl_stmt|;
name|osm_assigned_guids_t
modifier|*
name|p_assigned_guids
decl_stmt|,
modifier|*
name|p_next_assigned_guids
decl_stmt|;
name|osm_alias_guid_t
modifier|*
name|p_alias_guid
decl_stmt|,
modifier|*
name|p_next_alias_guid
decl_stmt|;
name|osm_port_t
modifier|*
name|p_port
decl_stmt|,
modifier|*
name|p_next_port
decl_stmt|;
name|osm_switch_t
modifier|*
name|p_sw
decl_stmt|,
modifier|*
name|p_next_sw
decl_stmt|;
name|osm_remote_sm_t
modifier|*
name|p_rsm
decl_stmt|,
modifier|*
name|p_next_rsm
decl_stmt|;
name|osm_prtn_t
modifier|*
name|p_prtn
decl_stmt|,
modifier|*
name|p_next_prtn
decl_stmt|;
name|osm_infr_t
modifier|*
name|p_infr
decl_stmt|,
modifier|*
name|p_next_infr
decl_stmt|;
name|osm_svcr_t
modifier|*
name|p_svcr
decl_stmt|,
modifier|*
name|p_next_svcr
decl_stmt|;
comment|/* it might be a good idea to de-allocate all known objects */
name|p_next_node
operator|=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|node_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_node
operator|!=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|node_guid_tbl
argument_list|)
condition|)
block|{
name|p_node
operator|=
name|p_next_node
expr_stmt|;
name|p_next_node
operator|=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_node
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_node_delete
argument_list|(
operator|&
name|p_node
argument_list|)
expr_stmt|;
block|}
name|p_next_assigned_guids
operator|=
operator|(
name|osm_assigned_guids_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|assigned_guids_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_assigned_guids
operator|!=
operator|(
name|osm_assigned_guids_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|assigned_guids_tbl
argument_list|)
condition|)
block|{
name|p_assigned_guids
operator|=
name|p_next_assigned_guids
expr_stmt|;
name|p_next_assigned_guids
operator|=
operator|(
name|osm_assigned_guids_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_assigned_guids
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_assigned_guids_delete
argument_list|(
operator|&
name|p_assigned_guids
argument_list|)
expr_stmt|;
block|}
name|p_next_alias_guid
operator|=
operator|(
name|osm_alias_guid_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|alias_port_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_alias_guid
operator|!=
operator|(
name|osm_alias_guid_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|alias_port_guid_tbl
argument_list|)
condition|)
block|{
name|p_alias_guid
operator|=
name|p_next_alias_guid
expr_stmt|;
name|p_next_alias_guid
operator|=
operator|(
name|osm_alias_guid_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_alias_guid
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_alias_guid_delete
argument_list|(
operator|&
name|p_alias_guid
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|cl_qlist_count
argument_list|(
operator|&
name|p_subn
operator|->
name|alias_guid_list
argument_list|)
condition|)
name|osm_guid_work_obj_delete
argument_list|(
operator|(
name|osm_guidinfo_work_obj_t
operator|*
operator|)
name|cl_qlist_remove_head
argument_list|(
operator|&
name|p_subn
operator|->
name|alias_guid_list
argument_list|)
argument_list|)
expr_stmt|;
name|p_next_port
operator|=
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|port_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_port
operator|!=
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|port_guid_tbl
argument_list|)
condition|)
block|{
name|p_port
operator|=
name|p_next_port
expr_stmt|;
name|p_next_port
operator|=
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_port_delete
argument_list|(
operator|&
name|p_port
argument_list|)
expr_stmt|;
block|}
name|p_next_sw
operator|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sw_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_sw
operator|!=
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|sw_guid_tbl
argument_list|)
condition|)
block|{
name|p_sw
operator|=
name|p_next_sw
expr_stmt|;
name|p_next_sw
operator|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_sw
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_switch_delete
argument_list|(
operator|&
name|p_sw
argument_list|)
expr_stmt|;
block|}
name|p_next_rsm
operator|=
operator|(
name|osm_remote_sm_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sm_guid_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_rsm
operator|!=
operator|(
name|osm_remote_sm_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|sm_guid_tbl
argument_list|)
condition|)
block|{
name|p_rsm
operator|=
name|p_next_rsm
expr_stmt|;
name|p_next_rsm
operator|=
operator|(
name|osm_remote_sm_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_rsm
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_rsm
argument_list|)
expr_stmt|;
block|}
name|p_next_prtn
operator|=
operator|(
name|osm_prtn_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p_subn
operator|->
name|prtn_pkey_tbl
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_prtn
operator|!=
operator|(
name|osm_prtn_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_subn
operator|->
name|prtn_pkey_tbl
argument_list|)
condition|)
block|{
name|p_prtn
operator|=
name|p_next_prtn
expr_stmt|;
name|p_next_prtn
operator|=
operator|(
name|osm_prtn_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_prtn
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|osm_prtn_delete
argument_list|(
name|p_subn
argument_list|,
operator|&
name|p_prtn
argument_list|)
expr_stmt|;
block|}
name|cl_fmap_remove_all
argument_list|(
operator|&
name|p_subn
operator|->
name|mgrp_mgid_tbl
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|p_subn
operator|->
name|max_mcast_lid_ho
operator|-
name|IB_LID_MCAST_START_HO
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p_subn
operator|->
name|mboxes
index|[
name|i
index|]
condition|)
name|osm_mgrp_box_delete
argument_list|(
name|p_subn
operator|->
name|mboxes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|p_next_infr
operator|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|cl_qlist_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_infr
operator|!=
operator|(
name|osm_infr_t
operator|*
operator|)
name|cl_qlist_end
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_infr_list
argument_list|)
condition|)
block|{
name|p_infr
operator|=
name|p_next_infr
expr_stmt|;
name|p_next_infr
operator|=
operator|(
name|osm_infr_t
operator|*
operator|)
name|cl_qlist_next
argument_list|(
operator|&
name|p_infr
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|osm_infr_delete
argument_list|(
name|p_infr
argument_list|)
expr_stmt|;
block|}
name|p_next_svcr
operator|=
operator|(
name|osm_svcr_t
operator|*
operator|)
name|cl_qlist_head
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_sr_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_next_svcr
operator|!=
operator|(
name|osm_svcr_t
operator|*
operator|)
name|cl_qlist_end
argument_list|(
operator|&
name|p_subn
operator|->
name|sa_sr_list
argument_list|)
condition|)
block|{
name|p_svcr
operator|=
name|p_next_svcr
expr_stmt|;
name|p_next_svcr
operator|=
operator|(
name|osm_svcr_t
operator|*
operator|)
name|cl_qlist_next
argument_list|(
operator|&
name|p_svcr
operator|->
name|list_item
argument_list|)
expr_stmt|;
name|osm_svcr_delete
argument_list|(
name|p_svcr
argument_list|)
expr_stmt|;
block|}
name|cl_ptr_vector_destroy
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|)
expr_stmt|;
name|osm_qos_policy_destroy
argument_list|(
name|p_subn
operator|->
name|p_qos_policy
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|cl_is_qlist_empty
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
condition|)
block|{
name|cl_list_item_t
modifier|*
name|item
init|=
name|cl_qlist_remove_head
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
decl_stmt|;
name|free
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
name|subn_opt_destroy
argument_list|(
operator|&
name|p_subn
operator|->
name|opt
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_subn
operator|->
name|opt
operator|.
name|file_opts
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ib_api_status_t
name|osm_subn_init
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_opensm_t
modifier|*
name|p_osm
parameter_list|,
name|IN
specifier|const
name|osm_subn_opt_t
modifier|*
name|p_opt
parameter_list|)
block|{
name|cl_status_t
name|status
decl_stmt|;
name|p_subn
operator|->
name|p_osm
operator|=
name|p_osm
expr_stmt|;
name|status
operator|=
name|cl_ptr_vector_init
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|,
name|OSM_SUBNET_VECTOR_MIN_SIZE
argument_list|,
name|OSM_SUBNET_VECTOR_GROW_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|CL_SUCCESS
condition|)
return|return
name|status
return|;
name|status
operator|=
name|cl_ptr_vector_set_capacity
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|,
name|OSM_SUBNET_VECTOR_CAPACITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|CL_SUCCESS
condition|)
return|return
name|status
return|;
comment|/* 	   LID zero is not valid.  NULL out this entry for the 	   convenience of other code. 	 */
name|cl_ptr_vector_set
argument_list|(
operator|&
name|p_subn
operator|->
name|port_lid_tbl
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|p_subn
operator|->
name|opt
operator|=
operator|*
name|p_opt
expr_stmt|;
name|p_subn
operator|->
name|max_ucast_lid_ho
operator|=
name|IB_LID_UCAST_END_HO
expr_stmt|;
name|p_subn
operator|->
name|max_mcast_lid_ho
operator|=
name|IB_LID_MCAST_END_HO
expr_stmt|;
name|p_subn
operator|->
name|min_ca_mtu
operator|=
name|IB_MAX_MTU
expr_stmt|;
name|p_subn
operator|->
name|min_ca_rate
operator|=
name|IB_PATH_RECORD_RATE_300_GBS
expr_stmt|;
name|p_subn
operator|->
name|min_data_vls
operator|=
name|IB_MAX_NUM_VLS
operator|-
literal|1
expr_stmt|;
name|p_subn
operator|->
name|min_sw_data_vls
operator|=
name|IB_MAX_NUM_VLS
operator|-
literal|1
expr_stmt|;
name|p_subn
operator|->
name|ignore_existing_lfts
operator|=
name|TRUE
expr_stmt|;
comment|/* we assume master by default - so we only need to set it true if STANDBY */
name|p_subn
operator|->
name|coming_out_of_standby
operator|=
name|FALSE
expr_stmt|;
name|p_subn
operator|->
name|sweeping_enabled
operator|=
name|TRUE
expr_stmt|;
name|p_subn
operator|->
name|last_sm_port_state
operator|=
literal|1
expr_stmt|;
comment|/* Initialize the guid2mkey database */
name|p_subn
operator|->
name|p_g2m
operator|=
name|osm_db_domain_init
argument_list|(
operator|&
operator|(
name|p_osm
operator|->
name|db
operator|)
argument_list|,
literal|"guid2mkey"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_subn
operator|->
name|p_g2m
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7510: "
literal|"Error initializing Guid-to-MKey persistent database\n"
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
if|if
condition|(
name|osm_db_restore
argument_list|(
name|p_subn
operator|->
name|p_g2m
argument_list|)
condition|)
block|{
ifndef|#
directive|ifndef
name|__WIN__
comment|/* 		 * When Windows is BSODing, it might corrupt files that 		 * were previously opened for writing, even if the files 		 * are closed, so we might see corrupted guid2mkey file. 		 */
if|if
condition|(
name|p_subn
operator|->
name|opt
operator|.
name|exit_on_fatal
condition|)
block|{
name|osm_log
argument_list|(
operator|&
operator|(
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_SYS
argument_list|,
literal|"FATAL: Error restoring Guid-to-Mkey "
literal|"persistent database\n"
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
else|else
endif|#
directive|endif
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7511: Error restoring Guid-to-Mkey "
literal|"persistent database\n"
argument_list|)
expr_stmt|;
block|}
name|subn_validate_g2m
argument_list|(
name|p_subn
argument_list|)
expr_stmt|;
comment|/* Initialize the neighbor database */
name|p_subn
operator|->
name|p_neighbor
operator|=
name|osm_db_domain_init
argument_list|(
operator|&
operator|(
name|p_osm
operator|->
name|db
operator|)
argument_list|,
literal|"neighbors"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_subn
operator|->
name|p_neighbor
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7520: Error "
literal|"initializing neighbor link persistent database\n"
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
if|if
condition|(
name|osm_db_restore
argument_list|(
name|p_subn
operator|->
name|p_neighbor
argument_list|)
condition|)
block|{
ifndef|#
directive|ifndef
name|__WIN__
comment|/* 		 * When Windows is BSODing, it might corrupt files that 		 * were previously opened for writing, even if the files 		 * are closed, so we might see corrupted neighbors file. 		 */
if|if
condition|(
name|p_subn
operator|->
name|opt
operator|.
name|exit_on_fatal
condition|)
block|{
name|osm_log
argument_list|(
operator|&
operator|(
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_SYS
argument_list|,
literal|"FATAL: Error restoring neighbor link "
literal|"persistent database\n"
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
else|else
endif|#
directive|endif
name|OSM_LOG
argument_list|(
operator|&
operator|(
name|p_osm
operator|->
name|log
operator|)
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7521: Error restoring neighbor link "
literal|"persistent database\n"
argument_list|)
expr_stmt|;
block|}
name|subn_validate_neighbor
argument_list|(
name|p_subn
argument_list|)
expr_stmt|;
return|return
name|IB_SUCCESS
return|;
block|}
end_function

begin_function
name|osm_port_t
modifier|*
name|osm_get_port_by_mad_addr
parameter_list|(
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
specifier|const
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_mad_addr_t
modifier|*
name|p_mad_addr
parameter_list|)
block|{
name|osm_port_t
modifier|*
name|port
init|=
name|osm_get_port_by_lid
argument_list|(
name|p_subn
argument_list|,
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7504: "
literal|"Lid is out of range: %u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mad_addr
operator|->
name|dest_lid
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|port
return|;
block|}
end_function

begin_function
name|ib_api_status_t
name|osm_get_gid_by_mad_addr
parameter_list|(
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
specifier|const
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_mad_addr_t
modifier|*
name|p_mad_addr
parameter_list|,
name|OUT
name|ib_gid_t
modifier|*
name|p_gid
parameter_list|)
block|{
specifier|const
name|osm_port_t
modifier|*
name|p_port
decl_stmt|;
if|if
condition|(
name|p_gid
operator|==
name|NULL
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 7505: "
literal|"Provided output GID is NULL\n"
argument_list|)
expr_stmt|;
return|return
name|IB_INVALID_PARAMETER
return|;
block|}
name|p_port
operator|=
name|osm_get_port_by_mad_addr
argument_list|(
name|p_log
argument_list|,
name|p_subn
argument_list|,
name|p_mad_addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_port
condition|)
return|return
name|IB_INVALID_PARAMETER
return|;
name|p_gid
operator|->
name|unicast
operator|.
name|interface_id
operator|=
name|p_port
operator|->
name|p_physp
operator|->
name|port_guid
expr_stmt|;
name|p_gid
operator|->
name|unicast
operator|.
name|prefix
operator|=
name|p_subn
operator|->
name|opt
operator|.
name|subnet_prefix
expr_stmt|;
return|return
name|IB_SUCCESS
return|;
block|}
end_function

begin_function
name|osm_physp_t
modifier|*
name|osm_get_physp_by_mad_addr
parameter_list|(
name|IN
name|osm_log_t
modifier|*
name|p_log
parameter_list|,
name|IN
specifier|const
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|osm_mad_addr_t
modifier|*
name|p_mad_addr
parameter_list|)
block|{
name|osm_port_t
modifier|*
name|p_port
decl_stmt|;
name|p_port
operator|=
name|osm_get_port_by_mad_addr
argument_list|(
name|p_log
argument_list|,
name|p_subn
argument_list|,
name|p_mad_addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_port
condition|)
return|return
name|NULL
return|;
return|return
name|p_port
operator|->
name|p_physp
return|;
block|}
end_function

begin_function
name|osm_switch_t
modifier|*
name|osm_get_switch_by_guid
parameter_list|(
name|IN
specifier|const
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|IN
name|ib_net64_t
name|guid
parameter_list|)
block|{
name|osm_switch_t
modifier|*
name|p_switch
decl_stmt|;
name|p_switch
operator|=
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|sw_guid_tbl
operator|)
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_switch
operator|==
operator|(
name|osm_switch_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|sw_guid_tbl
operator|)
argument_list|)
condition|)
name|p_switch
operator|=
name|NULL
expr_stmt|;
return|return
name|p_switch
return|;
block|}
end_function

begin_function
name|osm_node_t
modifier|*
name|osm_get_node_by_guid
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|p_subn
parameter_list|,
name|IN
name|ib_net64_t
name|guid
parameter_list|)
block|{
name|osm_node_t
modifier|*
name|p_node
decl_stmt|;
name|p_node
operator|=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|node_guid_tbl
operator|)
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_node
operator|==
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|node_guid_tbl
operator|)
argument_list|)
condition|)
name|p_node
operator|=
name|NULL
expr_stmt|;
return|return
name|p_node
return|;
block|}
end_function

begin_function
name|osm_port_t
modifier|*
name|osm_get_port_by_guid
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|p_subn
parameter_list|,
name|IN
name|ib_net64_t
name|guid
parameter_list|)
block|{
name|osm_port_t
modifier|*
name|p_port
decl_stmt|;
name|p_port
operator|=
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|port_guid_tbl
operator|)
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_port
operator|==
operator|(
name|osm_port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|port_guid_tbl
operator|)
argument_list|)
condition|)
name|p_port
operator|=
name|NULL
expr_stmt|;
return|return
name|p_port
return|;
block|}
end_function

begin_function
name|osm_alias_guid_t
modifier|*
name|osm_get_alias_guid_by_guid
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|p_subn
parameter_list|,
name|IN
name|ib_net64_t
name|guid
parameter_list|)
block|{
name|osm_alias_guid_t
modifier|*
name|p_alias_guid
decl_stmt|;
name|p_alias_guid
operator|=
operator|(
name|osm_alias_guid_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|alias_port_guid_tbl
operator|)
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_alias_guid
operator|==
operator|(
name|osm_alias_guid_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|alias_port_guid_tbl
operator|)
argument_list|)
condition|)
return|return
name|NULL
return|;
return|return
name|p_alias_guid
return|;
block|}
end_function

begin_function
name|osm_port_t
modifier|*
name|osm_get_port_by_alias_guid
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|p_subn
parameter_list|,
name|IN
name|ib_net64_t
name|guid
parameter_list|)
block|{
name|osm_alias_guid_t
modifier|*
name|p_alias_guid
decl_stmt|;
name|p_alias_guid
operator|=
name|osm_get_alias_guid_by_guid
argument_list|(
name|p_subn
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_alias_guid
condition|)
return|return
name|NULL
return|;
return|return
name|p_alias_guid
operator|->
name|p_base_port
return|;
block|}
end_function

begin_function
name|osm_assigned_guids_t
modifier|*
name|osm_assigned_guids_new
parameter_list|(
name|IN
specifier|const
name|ib_net64_t
name|port_guid
parameter_list|,
name|IN
specifier|const
name|uint32_t
name|num_guids
parameter_list|)
block|{
name|osm_assigned_guids_t
modifier|*
name|p_assigned_guids
decl_stmt|;
name|p_assigned_guids
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_assigned_guids
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ib_net64_t
argument_list|)
operator|*
operator|(
name|num_guids
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_assigned_guids
condition|)
name|p_assigned_guids
operator|->
name|port_guid
operator|=
name|port_guid
expr_stmt|;
return|return
name|p_assigned_guids
return|;
block|}
end_function

begin_function
name|void
name|osm_assigned_guids_delete
parameter_list|(
name|IN
name|OUT
name|osm_assigned_guids_t
modifier|*
modifier|*
name|pp_assigned_guids
parameter_list|)
block|{
name|free
argument_list|(
operator|*
name|pp_assigned_guids
argument_list|)
expr_stmt|;
operator|*
name|pp_assigned_guids
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|osm_assigned_guids_t
modifier|*
name|osm_get_assigned_guids_by_guid
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|p_subn
parameter_list|,
name|IN
name|ib_net64_t
name|port_guid
parameter_list|)
block|{
name|osm_assigned_guids_t
modifier|*
name|p_assigned_guids
decl_stmt|;
name|p_assigned_guids
operator|=
operator|(
name|osm_assigned_guids_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|assigned_guids_tbl
operator|)
argument_list|,
name|port_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_assigned_guids
operator|==
operator|(
name|osm_assigned_guids_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
operator|(
name|p_subn
operator|->
name|assigned_guids_tbl
operator|)
argument_list|)
condition|)
return|return
name|NULL
return|;
return|return
name|p_assigned_guids
return|;
block|}
end_function

begin_function
name|osm_port_t
modifier|*
name|osm_get_port_by_lid_ho
parameter_list|(
name|IN
name|osm_subn_t
specifier|const
modifier|*
name|subn
parameter_list|,
name|IN
name|uint16_t
name|lid
parameter_list|)
block|{
if|if
condition|(
name|lid
operator|<
name|cl_ptr_vector_get_size
argument_list|(
operator|&
name|subn
operator|->
name|port_lid_tbl
argument_list|)
condition|)
return|return
name|cl_ptr_vector_get
argument_list|(
operator|&
name|subn
operator|->
name|port_lid_tbl
argument_list|,
name|lid
argument_list|)
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|osm_mgrp_t
modifier|*
name|osm_get_mgrp_by_mgid
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|subn
parameter_list|,
name|IN
name|ib_gid_t
modifier|*
name|mgid
parameter_list|)
block|{
name|osm_mgrp_t
modifier|*
name|mgrp
decl_stmt|;
name|mgrp
operator|=
operator|(
name|osm_mgrp_t
operator|*
operator|)
name|cl_fmap_get
argument_list|(
operator|&
name|subn
operator|->
name|mgrp_mgid_tbl
argument_list|,
name|mgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgrp
operator|!=
operator|(
name|osm_mgrp_t
operator|*
operator|)
name|cl_fmap_end
argument_list|(
operator|&
name|subn
operator|->
name|mgrp_mgid_tbl
argument_list|)
condition|)
return|return
name|mgrp
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|is_mlnx_ext_port_info_supported
parameter_list|(
name|ib_net32_t
name|vendid
parameter_list|,
name|ib_net16_t
name|devid
parameter_list|)
block|{
name|uint32_t
name|vendid_ho
decl_stmt|;
name|uint16_t
name|devid_ho
decl_stmt|;
name|devid_ho
operator|=
name|cl_ntoh16
argument_list|(
name|devid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|devid_ho
operator|>=
literal|0xc738
operator|&&
name|devid_ho
operator|<=
literal|0xc73b
operator|)
operator|||
name|devid_ho
operator|==
literal|0xcb20
operator|||
name|devid_ho
operator|==
literal|0xcf08
operator|||
name|devid
operator|==
literal|0x1b02
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|devid_ho
operator|>=
literal|0x1003
operator|&&
name|devid_ho
operator|<=
literal|0x1017
condition|)
return|return
literal|1
return|;
name|vendid_ho
operator|=
name|cl_ntoh32
argument_list|(
name|vendid
argument_list|)
expr_stmt|;
if|if
condition|(
name|vendid_ho
operator|==
literal|0x119f
condition|)
block|{
comment|/* Bull Switch-X */
if|if
condition|(
name|devid_ho
operator|==
literal|0x1b02
operator|||
name|devid_ho
operator|==
literal|0x1b50
condition|)
return|return
literal|1
return|;
comment|/* Bull Switch-IB/IB2 */
if|if
condition|(
name|devid_ho
operator|==
literal|0x1ba0
operator|||
operator|(
name|devid_ho
operator|>=
literal|0x1bd0
operator|&&
name|devid_ho
operator|<=
literal|0x1bd5
operator|)
condition|)
return|return
literal|1
return|;
comment|/* Bull Connect-X3 */
if|if
condition|(
name|devid_ho
operator|==
literal|0x1b33
operator|||
name|devid_ho
operator|==
literal|0x1b73
operator|||
name|devid_ho
operator|==
literal|0x1b40
operator|||
name|devid_ho
operator|==
literal|0x1b41
operator|||
name|devid_ho
operator|==
literal|0x1b60
operator|||
name|devid_ho
operator|==
literal|0x1b61
condition|)
return|return
literal|1
return|;
comment|/* Bull Connect-IB */
if|if
condition|(
name|devid_ho
operator|==
literal|0x1b83
operator|||
name|devid_ho
operator|==
literal|0x1b93
operator|||
name|devid_ho
operator|==
literal|0x1b94
condition|)
return|return
literal|1
return|;
comment|/* Bull Connect-X4 */
if|if
condition|(
name|devid_ho
operator|==
literal|0x1bb4
operator|||
name|devid_ho
operator|==
literal|0x1bb5
operator|||
name|devid_ho
operator|==
literal|0x1bc4
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_init_qos_options
parameter_list|(
name|osm_qos_options_t
modifier|*
name|opt
parameter_list|,
name|osm_qos_options_t
modifier|*
name|f
parameter_list|)
block|{
name|opt
operator|->
name|max_vls
operator|=
literal|0
expr_stmt|;
name|opt
operator|->
name|high_limit
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|vlarb_high
condition|)
name|free
argument_list|(
name|opt
operator|->
name|vlarb_high
argument_list|)
expr_stmt|;
name|opt
operator|->
name|vlarb_high
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|vlarb_low
condition|)
name|free
argument_list|(
name|opt
operator|->
name|vlarb_low
argument_list|)
expr_stmt|;
name|opt
operator|->
name|vlarb_low
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|sl2vl
condition|)
name|free
argument_list|(
name|opt
operator|->
name|sl2vl
argument_list|)
expr_stmt|;
name|opt
operator|->
name|sl2vl
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|f
condition|)
name|memcpy
argument_list|(
name|f
argument_list|,
name|opt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|f
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|osm_subn_set_default_opt
parameter_list|(
name|IN
name|osm_subn_opt_t
modifier|*
name|p_opt
parameter_list|)
block|{
name|memset
argument_list|(
name|p_opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_subn_opt_t
argument_list|)
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|guid
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|m_key
operator|=
name|OSM_DEFAULT_M_KEY
expr_stmt|;
name|p_opt
operator|->
name|sm_key
operator|=
name|OSM_DEFAULT_SM_KEY
expr_stmt|;
name|p_opt
operator|->
name|sa_key
operator|=
name|OSM_DEFAULT_SA_KEY
expr_stmt|;
name|p_opt
operator|->
name|subnet_prefix
operator|=
name|IB_DEFAULT_SUBNET_PREFIX
expr_stmt|;
name|p_opt
operator|->
name|m_key_lease_period
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|m_key_protect_bits
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|m_key_lookup
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|sweep_interval
operator|=
name|OSM_DEFAULT_SWEEP_INTERVAL_SECS
expr_stmt|;
name|p_opt
operator|->
name|max_wire_smps
operator|=
name|OSM_DEFAULT_SMP_MAX_ON_WIRE
expr_stmt|;
name|p_opt
operator|->
name|max_wire_smps2
operator|=
name|p_opt
operator|->
name|max_wire_smps
expr_stmt|;
name|p_opt
operator|->
name|console
operator|=
name|strdup
argument_list|(
name|OSM_DEFAULT_CONSOLE
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|console_port
operator|=
name|OSM_DEFAULT_CONSOLE_PORT
expr_stmt|;
name|p_opt
operator|->
name|transaction_timeout
operator|=
name|OSM_DEFAULT_TRANS_TIMEOUT_MILLISEC
expr_stmt|;
name|p_opt
operator|->
name|transaction_retries
operator|=
name|OSM_DEFAULT_RETRY_COUNT
expr_stmt|;
name|p_opt
operator|->
name|max_smps_timeout
operator|=
literal|1000
operator|*
name|p_opt
operator|->
name|transaction_timeout
operator|*
name|p_opt
operator|->
name|transaction_retries
expr_stmt|;
comment|/* by default we will consider waiting for 50x transaction timeout normal */
name|p_opt
operator|->
name|max_msg_fifo_timeout
operator|=
literal|50
operator|*
name|OSM_DEFAULT_TRANS_TIMEOUT_MILLISEC
expr_stmt|;
name|p_opt
operator|->
name|sm_priority
operator|=
name|OSM_DEFAULT_SM_PRIORITY
expr_stmt|;
name|p_opt
operator|->
name|lmc
operator|=
name|OSM_DEFAULT_LMC
expr_stmt|;
name|p_opt
operator|->
name|lmc_esp0
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|max_op_vls
operator|=
name|OSM_DEFAULT_MAX_OP_VLS
expr_stmt|;
name|p_opt
operator|->
name|force_link_speed
operator|=
literal|15
expr_stmt|;
name|p_opt
operator|->
name|force_link_speed_ext
operator|=
literal|31
expr_stmt|;
name|p_opt
operator|->
name|fdr10
operator|=
literal|1
expr_stmt|;
name|p_opt
operator|->
name|reassign_lids
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|ignore_other_sm
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|single_thread
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|disable_multicast
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|force_log_flush
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|subnet_timeout
operator|=
name|OSM_DEFAULT_SUBNET_TIMEOUT
expr_stmt|;
name|p_opt
operator|->
name|packet_life_time
operator|=
name|OSM_DEFAULT_SWITCH_PACKET_LIFE
expr_stmt|;
name|p_opt
operator|->
name|vl_stall_count
operator|=
name|OSM_DEFAULT_VL_STALL_COUNT
expr_stmt|;
name|p_opt
operator|->
name|leaf_vl_stall_count
operator|=
name|OSM_DEFAULT_LEAF_VL_STALL_COUNT
expr_stmt|;
name|p_opt
operator|->
name|head_of_queue_lifetime
operator|=
name|OSM_DEFAULT_HEAD_OF_QUEUE_LIFE
expr_stmt|;
name|p_opt
operator|->
name|leaf_head_of_queue_lifetime
operator|=
name|OSM_DEFAULT_LEAF_HEAD_OF_QUEUE_LIFE
expr_stmt|;
name|p_opt
operator|->
name|local_phy_errors_threshold
operator|=
name|OSM_DEFAULT_ERROR_THRESHOLD
expr_stmt|;
name|p_opt
operator|->
name|overrun_errors_threshold
operator|=
name|OSM_DEFAULT_ERROR_THRESHOLD
expr_stmt|;
name|p_opt
operator|->
name|use_mfttop
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|sminfo_polling_timeout
operator|=
name|OSM_SM_DEFAULT_POLLING_TIMEOUT_MILLISECS
expr_stmt|;
name|p_opt
operator|->
name|polling_retry_number
operator|=
name|OSM_SM_DEFAULT_POLLING_RETRY_NUMBER
expr_stmt|;
name|p_opt
operator|->
name|force_heavy_sweep
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|log_flags
operator|=
name|OSM_LOG_DEFAULT_LEVEL
expr_stmt|;
name|p_opt
operator|->
name|honor_guid2lid_file
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|daemon
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|sm_inactive
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|babbling_port_policy
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|drop_event_subscriptions
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|ipoib_mcgroup_creation_validation
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|mcgroup_join_validation
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|use_optimized_slvl
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|fsync_high_avail_files
operator|=
name|TRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
name|p_opt
operator|->
name|perfmgr
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_redir
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_sweep_time_s
operator|=
name|OSM_PERFMGR_DEFAULT_SWEEP_TIME_S
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_max_outstanding_queries
operator|=
name|OSM_PERFMGR_DEFAULT_MAX_OUTSTANDING_QUERIES
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_ignore_cas
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|event_db_dump_file
operator|=
name|NULL
expr_stmt|;
comment|/* use default */
name|p_opt
operator|->
name|perfmgr_rm_nodes
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_log_errors
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_query_cpi
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_xmit_wait_log
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|perfmgr_xmit_wait_threshold
operator|=
name|OSM_PERFMGR_DEFAULT_XMIT_WAIT_THRESHOLD
expr_stmt|;
endif|#
directive|endif
comment|/* ENABLE_OSM_PERF_MGR */
name|p_opt
operator|->
name|event_plugin_name
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|event_plugin_options
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|node_name_map_name
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|dump_files_dir
operator|=
name|getenv
argument_list|(
literal|"OSM_TMP_DIR"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_opt
operator|->
name|dump_files_dir
operator|||
operator|!
operator|(
operator|*
name|p_opt
operator|->
name|dump_files_dir
operator|)
condition|)
name|p_opt
operator|->
name|dump_files_dir
operator|=
name|strdup
argument_list|(
name|OSM_DEFAULT_TMP_DIR
argument_list|)
expr_stmt|;
else|else
name|p_opt
operator|->
name|dump_files_dir
operator|=
name|strdup
argument_list|(
name|p_opt
operator|->
name|dump_files_dir
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|log_file
operator|=
name|strdup
argument_list|(
name|OSM_DEFAULT_LOG_FILE
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|log_max_size
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|partition_config_file
operator|=
name|strdup
argument_list|(
name|OSM_DEFAULT_PARTITION_CONFIG_FILE
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|no_partition_enforcement
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|part_enforce
operator|=
name|strdup
argument_list|(
name|OSM_PARTITION_ENFORCE_BOTH
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|allow_both_pkeys
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|sm_assigned_guid
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|qos
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|qos_policy_file
operator|=
name|strdup
argument_list|(
name|OSM_DEFAULT_QOS_POLICY_FILE
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|suppress_sl2vl_mad_status_errors
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|accum_log_file
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|port_prof_ignore_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|hop_weights_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|port_search_ordering_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|port_profile_switch_nodes
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|sweep_on_trap
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|use_ucast_cache
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|routing_engine_names
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|connect_roots
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|lid_matrix_dump_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|lfts_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|root_guid_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|cn_guid_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|io_guid_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|port_shifting
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|scatter_ports
operator|=
name|OSM_DEFAULT_SCATTER_PORTS
expr_stmt|;
name|p_opt
operator|->
name|max_reverse_hops
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|ids_guid_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|guid_routing_order_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|guid_routing_order_no_scatter
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|sa_db_file
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|sa_db_dump
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|torus_conf_file
operator|=
name|strdup
argument_list|(
name|OSM_DEFAULT_TORUS_CONF_FILE
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|do_mesh_analysis
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|exit_on_fatal
operator|=
name|TRUE
expr_stmt|;
name|p_opt
operator|->
name|congestion_control
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|cc_key
operator|=
name|OSM_DEFAULT_CC_KEY
expr_stmt|;
name|p_opt
operator|->
name|cc_max_outstanding_mads
operator|=
name|OSM_CC_DEFAULT_MAX_OUTSTANDING_QUERIES
expr_stmt|;
name|p_opt
operator|->
name|enable_quirks
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|no_clients_rereg
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|prefix_routes_file
operator|=
name|strdup
argument_list|(
name|OSM_DEFAULT_PREFIX_ROUTES_FILE
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|consolidate_ipv6_snm_req
operator|=
name|FALSE
expr_stmt|;
name|p_opt
operator|->
name|lash_start_vl
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|sm_sl
operator|=
name|OSM_DEFAULT_SL
expr_stmt|;
name|p_opt
operator|->
name|log_prefix
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|per_module_logging_file
operator|=
name|strdup
argument_list|(
name|OSM_DEFAULT_PER_MOD_LOGGING_CONF_FILE
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_options
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_ca_options
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_sw0_options
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_swe_options
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opt
operator|->
name|qos_rtr_options
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|p_opt
operator|->
name|cc_cct
operator|.
name|entries_len
operator|=
literal|0
expr_stmt|;
name|p_opt
operator|->
name|cc_cct
operator|.
name|input_str
operator|=
name|NULL
expr_stmt|;
name|p_opt
operator|->
name|quasi_ftree_indexing
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|clean_val
parameter_list|(
name|char
modifier|*
name|val
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|val
decl_stmt|;
comment|/* clean leading spaces */
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
name|p
operator|++
expr_stmt|;
name|val
operator|=
name|p
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|val
condition|)
return|return
name|val
return|;
comment|/* clean trailing spaces */
name|p
operator|=
name|val
operator|+
name|strlen
argument_list|(
name|val
argument_list|)
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|p
operator|>
name|val
operator|&&
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
name|p
operator|--
expr_stmt|;
name|p
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* clean quotas */
if|if
condition|(
operator|(
operator|*
name|val
operator|==
literal|'\"'
operator|&&
operator|*
name|p
operator|==
literal|'\"'
operator|)
operator|||
operator|(
operator|*
name|val
operator|==
literal|'\''
operator|&&
operator|*
name|p
operator|==
literal|'\''
operator|)
condition|)
block|{
name|val
operator|++
expr_stmt|;
operator|*
name|p
operator|--
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|subn_dump_qos_options
parameter_list|(
name|FILE
modifier|*
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|set_name
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|osm_qos_options_t
modifier|*
name|opt
parameter_list|)
block|{
return|return
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"# %s\n"
literal|"%s_max_vls %u\n"
literal|"%s_high_limit %d\n"
literal|"%s_vlarb_high %s\n"
literal|"%s_vlarb_low %s\n"
literal|"%s_sl2vl %s\n"
argument_list|,
name|set_name
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|max_vls
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|high_limit
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|vlarb_high
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|vlarb_low
argument_list|,
name|prefix
argument_list|,
name|opt
operator|->
name|sl2vl
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|append_prefix_route
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|uint64_t
name|prefix
parameter_list|,
name|uint64_t
name|guid
parameter_list|)
block|{
name|osm_prefix_route_t
modifier|*
name|route
decl_stmt|;
name|route
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|route
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|route
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
name|route
operator|->
name|prefix
operator|=
name|cl_hton64
argument_list|(
name|prefix
argument_list|)
expr_stmt|;
name|route
operator|->
name|guid
operator|=
name|cl_hton64
argument_list|(
name|guid
argument_list|)
expr_stmt|;
name|cl_qlist_insert_tail
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|,
operator|&
name|route
operator|->
name|list_item
argument_list|)
expr_stmt|;
return|return
name|IB_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|parse_prefix_routes_file
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|)
block|{
name|osm_log_t
modifier|*
name|log
init|=
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|log
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|!
name|cl_is_qlist_empty
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
condition|)
block|{
name|cl_list_item_t
modifier|*
name|item
init|=
name|cl_qlist_remove_head
argument_list|(
operator|&
name|p_subn
operator|->
name|prefix_routes_list
argument_list|)
decl_stmt|;
name|free
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
name|fp
operator|=
name|fopen
argument_list|(
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
return|return
name|IB_SUCCESS
return|;
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"fopen(%s) failed: %s"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|fp
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|p_prefix
decl_stmt|,
modifier|*
name|p_guid
decl_stmt|,
modifier|*
name|p_extra
decl_stmt|,
modifier|*
name|p_last
decl_stmt|,
modifier|*
name|p_end
decl_stmt|;
name|uint64_t
name|prefix
decl_stmt|,
name|guid
decl_stmt|;
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|errors
operator|>
literal|10
condition|)
break|break;
name|p_prefix
operator|=
name|strtok_r
argument_list|(
name|buf
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_prefix
condition|)
continue|continue;
comment|/* ignore blank lines */
if|if
condition|(
operator|*
name|p_prefix
operator|==
literal|'#'
condition|)
continue|continue;
comment|/* ignore comment lines */
name|p_guid
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_guid
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"%s:%d: missing GUID\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
name|p_extra
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_extra
operator|&&
operator|*
name|p_extra
operator|!=
literal|'#'
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"%s:%d: extra tokens ignored\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|p_prefix
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|prefix
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|prefix
operator|=
name|strtoull
argument_list|(
name|p_prefix
argument_list|,
operator|&
name|p_end
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p_end
operator|!=
literal|'\0'
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"%s:%d: illegal prefix: %s\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|line
argument_list|,
name|p_prefix
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|p_guid
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|guid
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|guid
operator|=
name|strtoull
argument_list|(
name|p_guid
argument_list|,
operator|&
name|p_end
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p_end
operator|!=
literal|'\0'
operator|&&
operator|*
name|p_end
operator|!=
literal|'#'
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"%s:%d: illegal GUID: %s\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|prefix_routes_file
argument_list|,
name|line
argument_list|,
name|p_guid
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|append_prefix_route
argument_list|(
name|p_subn
argument_list|,
name|prefix
argument_list|,
name|guid
argument_list|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|errors
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|errors
operator|==
literal|0
operator|)
condition|?
name|IB_SUCCESS
else|:
name|IB_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|insert_per_module_debug
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
name|char
modifier|*
name|mod_name
parameter_list|,
name|osm_log_level_t
name|level
parameter_list|)
block|{
name|uint8_t
name|index
decl_stmt|;
if|if
condition|(
name|find_module_name
argument_list|(
name|mod_name
argument_list|,
operator|&
name|index
argument_list|)
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Module name %s not found\n"
argument_list|,
name|mod_name
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
name|osm_set_log_per_module
argument_list|(
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|log
argument_list|,
name|index
argument_list|,
name|level
argument_list|)
expr_stmt|;
return|return
name|IB_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|ib_api_status_t
name|parse_per_mod_logging_file
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|)
block|{
name|osm_log_t
modifier|*
name|log
init|=
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|log
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
name|osm_reset_log_per_module
argument_list|(
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_subn
operator|->
name|opt
operator|.
name|per_module_logging_file
operator|==
name|NULL
condition|)
return|return
name|IB_SUCCESS
return|;
name|fp
operator|=
name|fopen
argument_list|(
name|p_subn
operator|->
name|opt
operator|.
name|per_module_logging_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
return|return
name|IB_SUCCESS
return|;
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"fopen(%s) failed: %s"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|per_module_logging_file
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|IB_ERROR
return|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|fp
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|p_mod_name
decl_stmt|,
modifier|*
name|p_level
decl_stmt|,
modifier|*
name|p_extra
decl_stmt|,
modifier|*
name|p_last
decl_stmt|;
name|osm_log_level_t
name|level
decl_stmt|;
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|errors
operator|>
literal|10
condition|)
break|break;
name|p_mod_name
operator|=
name|strtok_r
argument_list|(
name|buf
argument_list|,
literal|" =,\t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_mod_name
condition|)
continue|continue;
comment|/* ignore blank lines */
if|if
condition|(
operator|*
name|p_mod_name
operator|==
literal|'#'
condition|)
continue|continue;
comment|/* ignore comment lines */
name|p_level
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_level
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"%s:%d: missing log level\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|per_module_logging_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
name|p_extra
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_extra
operator|&&
operator|*
name|p_extra
operator|!=
literal|'#'
condition|)
block|{
name|OSM_LOG
argument_list|(
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"%s:%d: extra tokens ignored\n"
argument_list|,
name|p_subn
operator|->
name|opt
operator|.
name|per_module_logging_file
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
name|level
operator|=
name|strtoul
argument_list|(
name|p_level
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|insert_per_module_debug
argument_list|(
name|p_subn
argument_list|,
name|p_mod_name
argument_list|,
name|level
argument_list|)
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|errors
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|errors
operator|==
literal|0
operator|)
condition|?
name|IB_SUCCESS
else|:
name|IB_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_verify_max_vls
parameter_list|(
name|unsigned
modifier|*
name|max_vls
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|*
name|max_vls
operator|||
operator|*
name|max_vls
operator|>
literal|15
condition|)
block|{
if|if
condition|(
operator|*
name|max_vls
condition|)
name|log_report
argument_list|(
literal|" Invalid Cached Option: %s_max_vls=%u: "
literal|"Using Default = %u\n"
argument_list|,
name|prefix
argument_list|,
operator|*
name|max_vls
argument_list|,
name|OSM_DEFAULT_QOS_MAX_VLS
argument_list|)
expr_stmt|;
operator|*
name|max_vls
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|subn_verify_high_limit
parameter_list|(
name|int
modifier|*
name|high_limit
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
if|if
condition|(
operator|*
name|high_limit
operator|<
literal|0
operator|||
operator|*
name|high_limit
operator|>
literal|255
condition|)
block|{
if|if
condition|(
operator|*
name|high_limit
operator|>
literal|255
condition|)
name|log_report
argument_list|(
literal|" Invalid Cached Option: %s_high_limit=%d: "
literal|"Using Default: %d\n"
argument_list|,
name|prefix
argument_list|,
operator|*
name|high_limit
argument_list|,
name|OSM_DEFAULT_QOS_HIGH_LIMIT
argument_list|)
expr_stmt|;
operator|*
name|high_limit
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|subn_verify_vlarb
parameter_list|(
name|char
modifier|*
modifier|*
name|vlarb
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
specifier|const
name|char
modifier|*
name|suffix
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|,
modifier|*
name|tok
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|*
name|vlarb
operator|==
name|NULL
condition|)
return|return;
name|str
operator|=
name|strdup
argument_list|(
operator|*
name|vlarb
argument_list|)
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|str
argument_list|,
literal|",\n"
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
while|while
condition|(
name|tok
condition|)
block|{
name|char
modifier|*
name|vl_str
decl_stmt|,
modifier|*
name|weight_str
decl_stmt|;
name|vl_str
operator|=
name|tok
expr_stmt|;
name|weight_str
operator|=
name|strchr
argument_list|(
name|tok
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|weight_str
condition|)
block|{
name|long
name|vl
decl_stmt|,
name|weight
decl_stmt|;
operator|*
name|weight_str
operator|=
literal|'\0'
expr_stmt|;
name|weight_str
operator|++
expr_stmt|;
name|vl
operator|=
name|strtol
argument_list|(
name|vl_str
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:vl=%s"
literal|" improperly formatted\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|vl_str
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|vl
operator|<
literal|0
operator|||
name|vl
operator|>
literal|14
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:vl=%ld out of range\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|vl
argument_list|)
expr_stmt|;
name|weight
operator|=
name|strtol
argument_list|(
name|weight_str
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:weight=%s "
literal|"improperly formatted\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|weight_str
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|weight
operator|<
literal|0
operator|||
name|weight
operator|>
literal|255
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:weight=%ld "
literal|"out of range\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|weight
argument_list|)
expr_stmt|;
block|}
else|else
name|log_report
argument_list|(
literal|" Warning: Cached Option "
literal|"%s_vlarb_%s:vl:weight=%s "
literal|"improperly formatted\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|,
name|tok
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|",\n"
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
literal|64
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_vlarb_%s:> 64 listed:"
literal|" excess vl:weight pairs will be dropped\n"
argument_list|,
name|prefix
argument_list|,
name|suffix
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_verify_sl2vl
parameter_list|(
name|char
modifier|*
modifier|*
name|sl2vl
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|,
modifier|*
name|tok
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|*
name|sl2vl
operator|==
name|NULL
condition|)
return|return;
name|str
operator|=
name|strdup
argument_list|(
operator|*
name|sl2vl
argument_list|)
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|str
argument_list|,
literal|",\n"
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
while|while
condition|(
name|tok
condition|)
block|{
name|long
name|vl
init|=
name|strtol
argument_list|(
name|tok
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|end
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_sl2vl:vl=%s "
literal|"improperly formatted\n"
argument_list|,
name|prefix
argument_list|,
name|tok
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|vl
operator|<
literal|0
operator|||
name|vl
operator|>
literal|15
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_sl2vl:vl=%ld "
literal|"out of range\n"
argument_list|,
name|prefix
argument_list|,
name|vl
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|",\n"
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|<
literal|16
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_sl2vl:< 16 VLs "
literal|"listed\n"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|count
operator|>
literal|16
condition|)
name|log_report
argument_list|(
literal|" Warning: Cached Option %s_sl2vl:> 16 listed: "
literal|"excess VLs will be dropped\n"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|subn_verify_qos_set
parameter_list|(
name|osm_qos_options_t
modifier|*
name|set
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|subn_verify_max_vls
argument_list|(
operator|&
name|set
operator|->
name|max_vls
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|subn_verify_high_limit
argument_list|(
operator|&
name|set
operator|->
name|high_limit
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|subn_verify_vlarb
argument_list|(
operator|&
name|set
operator|->
name|vlarb_low
argument_list|,
name|prefix
argument_list|,
literal|"low"
argument_list|)
expr_stmt|;
name|subn_verify_vlarb
argument_list|(
operator|&
name|set
operator|->
name|vlarb_high
argument_list|,
name|prefix
argument_list|,
literal|"high"
argument_list|)
expr_stmt|;
name|subn_verify_sl2vl
argument_list|(
operator|&
name|set
operator|->
name|sl2vl
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|osm_subn_verify_config
parameter_list|(
name|IN
name|osm_subn_opt_t
modifier|*
name|p_opts
parameter_list|)
block|{
if|if
condition|(
name|p_opts
operator|->
name|lmc
operator|>
literal|7
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:lmc = %u:"
literal|"Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|lmc
argument_list|,
name|OSM_DEFAULT_LMC
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|lmc
operator|=
name|OSM_DEFAULT_LMC
expr_stmt|;
block|}
if|if
condition|(
literal|15
operator|<
name|p_opts
operator|->
name|sm_priority
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:sm_priority = %u:"
literal|"Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|sm_priority
argument_list|,
name|OSM_DEFAULT_SM_PRIORITY
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|sm_priority
operator|=
name|OSM_DEFAULT_SM_PRIORITY
expr_stmt|;
block|}
if|if
condition|(
operator|(
literal|15
operator|<
name|p_opts
operator|->
name|force_link_speed
operator|)
operator|||
operator|(
name|p_opts
operator|->
name|force_link_speed
operator|>
literal|7
operator|&&
name|p_opts
operator|->
name|force_link_speed
operator|<
literal|15
operator|)
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:force_link_speed = %u:"
literal|"Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|force_link_speed
argument_list|,
name|IB_PORT_LINK_SPEED_ENABLED_MASK
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|force_link_speed
operator|=
name|IB_PORT_LINK_SPEED_ENABLED_MASK
expr_stmt|;
block|}
if|if
condition|(
operator|(
literal|31
operator|<
name|p_opts
operator|->
name|force_link_speed_ext
operator|)
operator|||
operator|(
name|p_opts
operator|->
name|force_link_speed_ext
operator|>
literal|3
operator|&&
name|p_opts
operator|->
name|force_link_speed_ext
operator|<
literal|30
operator|)
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:force_link_speed_ext = %u:"
literal|"Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|force_link_speed_ext
argument_list|,
literal|31
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|force_link_speed_ext
operator|=
literal|31
expr_stmt|;
block|}
if|if
condition|(
literal|2
operator|<
name|p_opts
operator|->
name|fdr10
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:fdr10 = %u:"
literal|"Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|fdr10
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|fdr10
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|p_opts
operator|->
name|max_wire_smps
operator|==
literal|0
condition|)
name|p_opts
operator|->
name|max_wire_smps
operator|=
literal|0x7FFFFFFF
expr_stmt|;
elseif|else
if|if
condition|(
name|p_opts
operator|->
name|max_wire_smps
operator|>
literal|0x7FFFFFFF
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value: max_wire_smps = %u,"
literal|" Using Default: %u\n"
argument_list|,
name|p_opts
operator|->
name|max_wire_smps
argument_list|,
name|OSM_DEFAULT_SMP_MAX_ON_WIRE
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|max_wire_smps
operator|=
name|OSM_DEFAULT_SMP_MAX_ON_WIRE
expr_stmt|;
block|}
if|if
condition|(
name|p_opts
operator|->
name|max_wire_smps2
operator|>
literal|0x7FFFFFFF
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value: max_wire_smps2 = %u,"
literal|" Using Default: %u"
argument_list|,
name|p_opts
operator|->
name|max_wire_smps2
argument_list|,
name|p_opts
operator|->
name|max_wire_smps
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|max_wire_smps2
operator|=
name|p_opts
operator|->
name|max_wire_smps
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_DISABLE_CONSOLE
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_LOCAL_CONSOLE
argument_list|)
ifdef|#
directive|ifdef
name|ENABLE_OSM_CONSOLE_LOOPBACK
operator|&&
name|strcmp
argument_list|(
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_LOOPBACK_CONSOLE
argument_list|)
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ENABLE_OSM_CONSOLE_SOCKET
operator|&&
name|strcmp
argument_list|(
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_REMOTE_CONSOLE
argument_list|)
endif|#
directive|endif
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:console = %s"
literal|", Using Default:%s\n"
argument_list|,
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_DEFAULT_CONSOLE
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_opts
operator|->
name|console
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|console
operator|=
name|strdup
argument_list|(
name|OSM_DEFAULT_CONSOLE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_opts
operator|->
name|no_partition_enforcement
operator|==
name|TRUE
condition|)
block|{
name|strcpy
argument_list|(
name|p_opts
operator|->
name|part_enforce
argument_list|,
name|OSM_PARTITION_ENFORCE_OFF
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|part_enforce_enum
operator|=
name|OSM_PARTITION_ENFORCE_TYPE_OFF
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|p_opts
operator|->
name|part_enforce
argument_list|,
name|OSM_PARTITION_ENFORCE_BOTH
argument_list|)
operator|==
literal|0
condition|)
name|p_opts
operator|->
name|part_enforce_enum
operator|=
name|OSM_PARTITION_ENFORCE_TYPE_BOTH
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p_opts
operator|->
name|part_enforce
argument_list|,
name|OSM_PARTITION_ENFORCE_IN
argument_list|)
operator|==
literal|0
condition|)
name|p_opts
operator|->
name|part_enforce_enum
operator|=
name|OSM_PARTITION_ENFORCE_TYPE_IN
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p_opts
operator|->
name|part_enforce
argument_list|,
name|OSM_PARTITION_ENFORCE_OUT
argument_list|)
operator|==
literal|0
condition|)
name|p_opts
operator|->
name|part_enforce_enum
operator|=
name|OSM_PARTITION_ENFORCE_TYPE_OUT
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|p_opts
operator|->
name|part_enforce
argument_list|,
name|OSM_PARTITION_ENFORCE_OFF
argument_list|)
operator|==
literal|0
condition|)
name|p_opts
operator|->
name|part_enforce_enum
operator|=
name|OSM_PARTITION_ENFORCE_TYPE_OFF
expr_stmt|;
else|else
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:part_enforce = %s"
literal|", Using Default:%s\n"
argument_list|,
name|p_opts
operator|->
name|part_enforce
argument_list|,
name|OSM_PARTITION_ENFORCE_BOTH
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|p_opts
operator|->
name|part_enforce
argument_list|,
name|OSM_PARTITION_ENFORCE_BOTH
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|part_enforce_enum
operator|=
name|OSM_PARTITION_ENFORCE_TYPE_BOTH
expr_stmt|;
block|}
block|}
if|if
condition|(
name|p_opts
operator|->
name|qos
condition|)
block|{
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|,
literal|"qos"
argument_list|)
expr_stmt|;
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_ca_options
argument_list|,
literal|"qos_ca"
argument_list|)
expr_stmt|;
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_sw0_options
argument_list|,
literal|"qos_sw0"
argument_list|)
expr_stmt|;
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_swe_options
argument_list|,
literal|"qos_swe"
argument_list|)
expr_stmt|;
name|subn_verify_qos_set
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_rtr_options
argument_list|,
literal|"qos_rtr"
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
if|if
condition|(
name|p_opts
operator|->
name|perfmgr_sweep_time_s
operator|<
literal|1
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:perfmgr_sweep_time_s "
literal|"= %u Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|perfmgr_sweep_time_s
argument_list|,
name|OSM_PERFMGR_DEFAULT_SWEEP_TIME_S
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|perfmgr_sweep_time_s
operator|=
name|OSM_PERFMGR_DEFAULT_SWEEP_TIME_S
expr_stmt|;
block|}
if|if
condition|(
name|p_opts
operator|->
name|perfmgr_max_outstanding_queries
operator|<
literal|1
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:"
literal|"perfmgr_max_outstanding_queries = %u"
literal|" Using Default:%u\n"
argument_list|,
name|p_opts
operator|->
name|perfmgr_max_outstanding_queries
argument_list|,
name|OSM_PERFMGR_DEFAULT_MAX_OUTSTANDING_QUERIES
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|perfmgr_max_outstanding_queries
operator|=
name|OSM_PERFMGR_DEFAULT_MAX_OUTSTANDING_QUERIES
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|p_opts
operator|->
name|m_key_protect_bits
operator|>
literal|3
condition|)
block|{
name|log_report
argument_list|(
literal|" Invalid Cached Option Value:"
literal|"m_key_protection_level = %u Setting to %u "
literal|"instead\n"
argument_list|,
name|p_opts
operator|->
name|m_key_protect_bits
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|m_key_protect_bits
operator|=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|p_opts
operator|->
name|m_key_protect_bits
operator|&&
name|p_opts
operator|->
name|m_key_lease_period
condition|)
block|{
if|if
condition|(
operator|!
name|p_opts
operator|->
name|sweep_interval
condition|)
block|{
name|log_report
argument_list|(
literal|" Sweep disabled with protected mkey "
literal|"leases in effect; re-enabling sweeping "
literal|"with interval %u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|m_key_lease_period
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|sweep_interval
operator|=
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|m_key_lease_period
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|p_opts
operator|->
name|sweep_interval
operator|>=
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|m_key_lease_period
argument_list|)
condition|)
block|{
name|log_report
argument_list|(
literal|" Sweep interval %u>= mkey lease period "
literal|"%u. Setting lease period to %u\n"
argument_list|,
name|p_opts
operator|->
name|sweep_interval
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|m_key_lease_period
argument_list|)
argument_list|,
name|p_opts
operator|->
name|sweep_interval
operator|+
literal|1
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|m_key_lease_period
operator|=
name|cl_hton16
argument_list|(
name|p_opts
operator|->
name|sweep_interval
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|osm_subn_parse_conf_file
parameter_list|(
specifier|const
name|char
modifier|*
name|file_name
parameter_list|,
name|osm_subn_opt_t
modifier|*
name|p_opts
parameter_list|)
block|{
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|FILE
modifier|*
name|opts_file
decl_stmt|;
name|char
modifier|*
name|p_key
decl_stmt|,
modifier|*
name|p_val
decl_stmt|,
modifier|*
name|pound_sign
decl_stmt|;
specifier|const
name|opt_rec_t
modifier|*
name|r
decl_stmt|;
name|void
modifier|*
name|p_field1
decl_stmt|,
modifier|*
name|p_field2
decl_stmt|;
name|int
name|token_matched
decl_stmt|;
name|opts_file
operator|=
name|fopen
argument_list|(
name|file_name
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opts_file
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
return|return
literal|1
return|;
name|printf
argument_list|(
literal|"cannot open file \'%s\': %s\n"
argument_list|,
name|file_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|printf
argument_list|(
literal|" Reading Cached Option File: %s\n"
argument_list|,
name|file_name
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|config_file
operator|=
name|file_name
expr_stmt|;
if|if
condition|(
operator|!
name|p_opts
operator|->
name|file_opts
operator|&&
operator|!
operator|(
name|p_opts
operator|->
name|file_opts
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p_opts
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|fclose
argument_list|(
name|opts_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|p_opts
operator|->
name|file_opts
argument_list|,
name|p_opts
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_opts
argument_list|)
argument_list|)
expr_stmt|;
name|p_opts
operator|->
name|file_opts
operator|->
name|file_opts
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
literal|1023
argument_list|,
name|opts_file
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|pound_sign
operator|=
name|strchr
argument_list|(
name|line
argument_list|,
literal|'#'
argument_list|)
expr_stmt|;
name|token_matched
operator|=
literal|0
expr_stmt|;
comment|/* Truncate any comments. */
if|if
condition|(
name|pound_sign
condition|)
operator|*
name|pound_sign
operator|=
literal|'\0'
expr_stmt|;
comment|/* get the first token */
name|p_key
operator|=
name|strtok_r
argument_list|(
name|line
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_key
condition|)
continue|continue;
name|p_val
operator|=
name|clean_val
argument_list|(
name|p_val
argument_list|)
expr_stmt|;
for|for
control|(
name|r
operator|=
name|opt_tbl
init|;
name|r
operator|->
name|name
condition|;
name|r
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|r
operator|->
name|name
argument_list|,
name|p_key
argument_list|)
condition|)
continue|continue;
name|token_matched
operator|=
literal|1
expr_stmt|;
name|p_field1
operator|=
operator|(
name|void
operator|*
operator|)
name|p_opts
operator|->
name|file_opts
operator|+
name|r
operator|->
name|opt_offset
expr_stmt|;
name|p_field2
operator|=
operator|(
name|void
operator|*
operator|)
name|p_opts
operator|+
name|r
operator|->
name|opt_offset
expr_stmt|;
comment|/* don't call setup function first time */
name|r
operator|->
name|parse_fn
argument_list|(
name|NULL
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
name|p_field1
argument_list|,
name|p_field2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|token_matched
condition|)
name|log_report
argument_list|(
literal|" Unrecognized token: \"%s\"\n"
argument_list|,
name|p_key
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|opts_file
argument_list|)
expr_stmt|;
name|osm_subn_verify_config
argument_list|(
name|p_opts
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|osm_subn_rescan_conf_files
parameter_list|(
name|IN
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|)
block|{
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|osm_subn_opt_t
modifier|*
name|p_opts
init|=
operator|&
name|p_subn
operator|->
name|opt
decl_stmt|;
specifier|const
name|opt_rec_t
modifier|*
name|r
decl_stmt|;
name|FILE
modifier|*
name|opts_file
decl_stmt|;
name|char
modifier|*
name|p_key
decl_stmt|,
modifier|*
name|p_val
decl_stmt|,
modifier|*
name|pound_sign
decl_stmt|;
name|void
modifier|*
name|p_field1
decl_stmt|,
modifier|*
name|p_field2
decl_stmt|;
name|int
name|token_matched
decl_stmt|;
if|if
condition|(
operator|!
name|p_opts
operator|->
name|config_file
condition|)
return|return
literal|0
return|;
name|opts_file
operator|=
name|fopen
argument_list|(
name|p_opts
operator|->
name|config_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opts_file
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
return|return
literal|1
return|;
name|OSM_LOG
argument_list|(
operator|&
name|p_subn
operator|->
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"cannot open file \'%s\': %s\n"
argument_list|,
name|p_opts
operator|->
name|config_file
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|,
operator|&
name|p_opts
operator|->
name|file_opts
operator|->
name|qos_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_ca_options
argument_list|,
operator|&
name|p_opts
operator|->
name|file_opts
operator|->
name|qos_ca_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_sw0_options
argument_list|,
operator|&
name|p_opts
operator|->
name|file_opts
operator|->
name|qos_sw0_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_swe_options
argument_list|,
operator|&
name|p_opts
operator|->
name|file_opts
operator|->
name|qos_swe_options
argument_list|)
expr_stmt|;
name|subn_init_qos_options
argument_list|(
operator|&
name|p_opts
operator|->
name|qos_rtr_options
argument_list|,
operator|&
name|p_opts
operator|->
name|file_opts
operator|->
name|qos_rtr_options
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
literal|1023
argument_list|,
name|opts_file
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|pound_sign
operator|=
name|strchr
argument_list|(
name|line
argument_list|,
literal|'#'
argument_list|)
expr_stmt|;
name|token_matched
operator|=
literal|0
expr_stmt|;
comment|/* Truncate any comments. */
if|if
condition|(
name|pound_sign
condition|)
operator|*
name|pound_sign
operator|=
literal|'\0'
expr_stmt|;
comment|/* get the first token */
name|p_key
operator|=
name|strtok_r
argument_list|(
name|line
argument_list|,
literal|" \t\n"
argument_list|,
operator|&
name|p_val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_key
condition|)
continue|continue;
name|p_val
operator|=
name|clean_val
argument_list|(
name|p_val
argument_list|)
expr_stmt|;
for|for
control|(
name|r
operator|=
name|opt_tbl
init|;
name|r
operator|->
name|name
condition|;
name|r
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|r
operator|->
name|name
argument_list|,
name|p_key
argument_list|)
condition|)
continue|continue;
name|token_matched
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|r
operator|->
name|can_update
condition|)
continue|continue;
name|p_field1
operator|=
operator|(
name|void
operator|*
operator|)
name|p_opts
operator|->
name|file_opts
operator|+
name|r
operator|->
name|opt_offset
expr_stmt|;
name|p_field2
operator|=
operator|(
name|void
operator|*
operator|)
name|p_opts
operator|+
name|r
operator|->
name|opt_offset
expr_stmt|;
name|r
operator|->
name|parse_fn
argument_list|(
name|p_subn
argument_list|,
name|p_key
argument_list|,
name|p_val
argument_list|,
name|p_field1
argument_list|,
name|p_field2
argument_list|,
name|r
operator|->
name|setup_fn
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|token_matched
condition|)
name|log_report
argument_list|(
literal|" Unrecognized token: \"%s\"\n"
argument_list|,
name|p_key
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|opts_file
argument_list|)
expr_stmt|;
name|osm_subn_verify_config
argument_list|(
name|p_opts
argument_list|)
expr_stmt|;
name|parse_prefix_routes_file
argument_list|(
name|p_subn
argument_list|)
expr_stmt|;
name|parse_per_mod_logging_file
argument_list|(
name|p_subn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|osm_subn_output_conf
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|IN
name|osm_subn_opt_t
modifier|*
name|p_opts
parameter_list|)
block|{
name|int
name|cacongoutputcount
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# DEVICE ATTRIBUTES OPTIONS\n#\n"
literal|"# The port GUID on which the OpenSM is running\n"
literal|"guid 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# M_Key value sent to all ports qualifying all Set(PortInfo)\n"
literal|"m_key 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# The lease period used for the M_Key on this subnet in [sec]\n"
literal|"m_key_lease_period %u\n\n"
literal|"# The protection level used for the M_Key on this subnet\n"
literal|"m_key_protection_level %u\n\n"
literal|"# If TRUE, SM tries to determine the m_key of unknown ports from guid2mkey file\n"
literal|"# If FALSE, SM won't try to determine the m_key of unknown ports.\n"
literal|"# Preconfigured m_key will be used instead\n"
literal|"m_key_lookup %s\n\n"
literal|"# SM_Key value of the SM used for SM authentication\n"
literal|"sm_key 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# SM_Key value to qualify rcv SA queries as 'trusted'\n"
literal|"sa_key 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# Note that for both values above (sm_key and sa_key)\n"
literal|"# OpenSM version 3.2.1 and below used the default value '1'\n"
literal|"# in a host byte order, it is fixed now but you may need to\n"
literal|"# change the values to interoperate with old OpenSM running\n"
literal|"# on a little endian machine.\n\n"
literal|"# Subnet prefix used on this subnet\n"
literal|"subnet_prefix 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# The LMC value used on this subnet\n"
literal|"lmc %u\n\n"
literal|"# lmc_esp0 determines whether LMC value used on subnet is used for\n"
literal|"# enhanced switch port 0. If TRUE, LMC value for subnet is used for\n"
literal|"# ESP0. Otherwise, LMC value for ESP0s is 0.\n"
literal|"lmc_esp0 %s\n\n"
literal|"# sm_sl determines SMSL used for SM/SA communication\n"
literal|"sm_sl %u\n\n"
literal|"# The code of maximal time a packet can live in a switch\n"
literal|"# The actual time is 4.096usec * 2^<packet_life_time>\n"
literal|"# The value 0x14 disables this mechanism\n"
literal|"packet_life_time 0x%02x\n\n"
literal|"# The number of sequential packets dropped that cause the port\n"
literal|"# to enter the VLStalled state. The result of setting this value to\n"
literal|"# zero is undefined.\n"
literal|"vl_stall_count 0x%02x\n\n"
literal|"# The number of sequential packets dropped that cause the port\n"
literal|"# to enter the VLStalled state. This value is for switch ports\n"
literal|"# driving a CA or router port. The result of setting this value\n"
literal|"# to zero is undefined.\n"
literal|"leaf_vl_stall_count 0x%02x\n\n"
literal|"# The code of maximal time a packet can wait at the head of\n"
literal|"# transmission queue.\n"
literal|"# The actual time is 4.096usec * 2^<head_of_queue_lifetime>\n"
literal|"# The value 0x14 disables this mechanism\n"
literal|"head_of_queue_lifetime 0x%02x\n\n"
literal|"# The maximal time a packet can wait at the head of queue on\n"
literal|"# switch port connected to a CA or router port\n"
literal|"leaf_head_of_queue_lifetime 0x%02x\n\n"
literal|"# Limit the maximal operational VLs\n"
literal|"max_op_vls %u\n\n"
literal|"# Force PortInfo:LinkSpeedEnabled on switch ports\n"
literal|"# If 0, don't modify PortInfo:LinkSpeedEnabled on switch port\n"
literal|"# Otherwise, use value for PortInfo:LinkSpeedEnabled on switch port\n"
literal|"# Values are (IB Spec 1.2.1, 14.2.5.6 Table 146 \"PortInfo\")\n"
literal|"#    1: 2.5 Gbps\n"
literal|"#    3: 2.5 or 5.0 Gbps\n"
literal|"#    5: 2.5 or 10.0 Gbps\n"
literal|"#    7: 2.5 or 5.0 or 10.0 Gbps\n"
literal|"#    2,4,6,8-14 Reserved\n"
literal|"#    Default 15: set to PortInfo:LinkSpeedSupported\n"
literal|"force_link_speed %u\n\n"
literal|"# Force PortInfo:LinkSpeedExtEnabled on ports\n"
literal|"# If 0, don't modify PortInfo:LinkSpeedExtEnabled on port\n"
literal|"# Otherwise, use value for PortInfo:LinkSpeedExtEnabled on port\n"
literal|"# Values are (MgtWG RefID #4722)\n"
literal|"#    1: 14.0625 Gbps\n"
literal|"#    2: 25.78125 Gbps\n"
literal|"#    3: 14.0625 Gbps or 25.78125 Gbps\n"
literal|"#    30: Disable extended link speeds\n"
literal|"#    Default 31: set to PortInfo:LinkSpeedExtSupported\n"
literal|"force_link_speed_ext %u\n\n"
literal|"# FDR10 on ports on devices that support FDR10\n"
literal|"# Values are:\n"
literal|"#    0: don't use fdr10 (no MLNX ExtendedPortInfo MADs)\n"
literal|"#    Default 1: enable fdr10 when supported\n"
literal|"#    2: disable fdr10 when supported\n"
literal|"fdr10 %u\n\n"
literal|"# The subnet_timeout code that will be set for all the ports\n"
literal|"# The actual timeout is 4.096usec * 2^<subnet_timeout>\n"
literal|"subnet_timeout %u\n\n"
literal|"# Threshold of local phy errors for sending Trap 129\n"
literal|"local_phy_errors_threshold 0x%02x\n\n"
literal|"# Threshold of credit overrun errors for sending Trap 130\n"
literal|"overrun_errors_threshold 0x%02x\n\n"
literal|"# Use SwitchInfo:MulticastFDBTop if advertised in PortInfo:CapabilityMask\n"
literal|"use_mfttop %s\n\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|m_key
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|m_key_lease_period
argument_list|)
argument_list|,
name|p_opts
operator|->
name|m_key_protect_bits
argument_list|,
name|p_opts
operator|->
name|m_key_lookup
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|sm_key
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|sa_key
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|subnet_prefix
argument_list|)
argument_list|,
name|p_opts
operator|->
name|lmc
argument_list|,
name|p_opts
operator|->
name|lmc_esp0
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|sm_sl
argument_list|,
name|p_opts
operator|->
name|packet_life_time
argument_list|,
name|p_opts
operator|->
name|vl_stall_count
argument_list|,
name|p_opts
operator|->
name|leaf_vl_stall_count
argument_list|,
name|p_opts
operator|->
name|head_of_queue_lifetime
argument_list|,
name|p_opts
operator|->
name|leaf_head_of_queue_lifetime
argument_list|,
name|p_opts
operator|->
name|max_op_vls
argument_list|,
name|p_opts
operator|->
name|force_link_speed
argument_list|,
name|p_opts
operator|->
name|force_link_speed_ext
argument_list|,
name|p_opts
operator|->
name|fdr10
argument_list|,
name|p_opts
operator|->
name|subnet_timeout
argument_list|,
name|p_opts
operator|->
name|local_phy_errors_threshold
argument_list|,
name|p_opts
operator|->
name|overrun_errors_threshold
argument_list|,
name|p_opts
operator|->
name|use_mfttop
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# PARTITIONING OPTIONS\n#\n"
literal|"# Partition configuration file to be used\n"
literal|"partition_config_file %s\n\n"
literal|"# Disable partition enforcement by switches (DEPRECATED)\n"
literal|"# This option is DEPRECATED. Please use part_enforce instead\n"
literal|"no_partition_enforcement %s\n\n"
literal|"# Partition enforcement type (for switches)\n"
literal|"# Values are both, out, in and off\n"
literal|"# Default is both (outbound and inbound enforcement)\n"
literal|"part_enforce %s\n\n"
literal|"# Allow both full and limited membership on the same partition\n"
literal|"allow_both_pkeys %s\n\n"
literal|"# SM assigned GUID byte where GUID is formed from OpenFabrics OUI\n"
literal|"# followed by 40 bits xy 00 ab cd ef where xy is the SM assigned GUID byte\n"
literal|"# and ab cd ef is an SM autogenerated 24 bits\n"
literal|"# SM assigned GUID byte should be configured as subnet unique\n"
literal|"sm_assigned_guid 0x%02x\n\n"
argument_list|,
name|p_opts
operator|->
name|partition_config_file
argument_list|,
name|p_opts
operator|->
name|no_partition_enforcement
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|part_enforce
argument_list|,
name|p_opts
operator|->
name|allow_both_pkeys
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|sm_assigned_guid
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# SWEEP OPTIONS\n#\n"
literal|"# The number of seconds between subnet sweeps (0 disables it)\n"
literal|"sweep_interval %u\n\n"
literal|"# If TRUE cause all lids to be reassigned\n"
literal|"reassign_lids %s\n\n"
literal|"# If TRUE forces every sweep to be a heavy sweep\n"
literal|"force_heavy_sweep %s\n\n"
literal|"# If TRUE every trap 128 and 144 will cause a heavy sweep.\n"
literal|"# NOTE: successive identical traps (>10) are suppressed\n"
literal|"sweep_on_trap %s\n\n"
argument_list|,
name|p_opts
operator|->
name|sweep_interval
argument_list|,
name|p_opts
operator|->
name|reassign_lids
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|force_heavy_sweep
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|sweep_on_trap
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# ROUTING OPTIONS\n#\n"
literal|"# If TRUE count switches as link subscriptions\n"
literal|"port_profile_switch_nodes %s\n\n"
argument_list|,
name|p_opts
operator|->
name|port_profile_switch_nodes
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Name of file with port guids to be ignored by port profiling\n"
literal|"port_prof_ignore_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|port_prof_ignore_file
condition|?
name|p_opts
operator|->
name|port_prof_ignore_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding routing weighting factors per output port\n"
literal|"hop_weights_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|hop_weights_file
condition|?
name|p_opts
operator|->
name|hop_weights_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding non-default port order per switch for routing\n"
literal|"port_search_ordering_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|port_search_ordering_file
condition|?
name|p_opts
operator|->
name|port_search_ordering_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Routing engine\n"
literal|"# Multiple routing engines can be specified separated by\n"
literal|"# commas so that specific ordering of routing algorithms will\n"
literal|"# be tried if earlier routing engines fail.\n"
literal|"# Supported engines: minhop, updn, dnup, file, ftree, lash,\n"
literal|"#    dor, torus-2QoS, dfsssp, sssp\n"
literal|"routing_engine %s\n\n"
argument_list|,
name|p_opts
operator|->
name|routing_engine_names
condition|?
name|p_opts
operator|->
name|routing_engine_names
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Connect roots (use FALSE if unsure)\n"
literal|"connect_roots %s\n\n"
argument_list|,
name|p_opts
operator|->
name|connect_roots
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Use unicast routing cache (use FALSE if unsure)\n"
literal|"use_ucast_cache %s\n\n"
argument_list|,
name|p_opts
operator|->
name|use_ucast_cache
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Lid matrix dump file name\n"
literal|"lid_matrix_dump_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|lid_matrix_dump_file
condition|?
name|p_opts
operator|->
name|lid_matrix_dump_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# LFTs file name\nlfts_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|lfts_file
condition|?
name|p_opts
operator|->
name|lfts_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding the root node guids (for fat-tree or Up/Down)\n"
literal|"# One guid in each line\nroot_guid_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|root_guid_file
condition|?
name|p_opts
operator|->
name|root_guid_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding the fat-tree compute node guids\n"
literal|"# One guid in each line\ncn_guid_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|cn_guid_file
condition|?
name|p_opts
operator|->
name|cn_guid_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding the fat-tree I/O node guids\n"
literal|"# One guid in each line.\n"
literal|"# If only io_guid file is provided, the rest of nodes\n"
literal|"# are considered as compute nodes.\n"
literal|"io_guid_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|io_guid_file
condition|?
name|p_opts
operator|->
name|io_guid_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# If TRUE enables alternative indexing policy for ftree routing\n"
literal|"# in quasi-ftree topologies that can improve shift-pattern support.\n"
literal|"# The switch indexing starts from root switch and leaf switches\n"
literal|"# are termination points of BFS algorithm\n"
literal|"# If FALSE, the indexing starts from leaf switch (default)\n"
literal|"quasi_ftree_indexing %s\n\n"
argument_list|,
name|p_opts
operator|->
name|quasi_ftree_indexing
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Number of reverse hops allowed for I/O nodes\n"
literal|"# Used for connectivity between I/O nodes connected to Top Switches\nmax_reverse_hops %d\n\n"
argument_list|,
name|p_opts
operator|->
name|max_reverse_hops
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding the node ids which will be used by"
literal|" Up/Down algorithm instead\n# of GUIDs (one guid and"
literal|" id in each line)\nids_guid_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|ids_guid_file
condition|?
name|p_opts
operator|->
name|ids_guid_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# The file holding guid routing order guids (for MinHop and Up/Down)\n"
literal|"guid_routing_order_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|guid_routing_order_file
condition|?
name|p_opts
operator|->
name|guid_routing_order_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Do mesh topology analysis (for LASH algorithm)\n"
literal|"do_mesh_analysis %s\n\n"
argument_list|,
name|p_opts
operator|->
name|do_mesh_analysis
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Starting VL for LASH algorithm\n"
literal|"lash_start_vl %u\n\n"
argument_list|,
name|p_opts
operator|->
name|lash_start_vl
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Port Shifting (use FALSE if unsure)\n"
literal|"port_shifting %s\n\n"
argument_list|,
name|p_opts
operator|->
name|port_shifting
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Assign ports in a random order instead of round-robin\n"
literal|"# If zero disable (default), otherwise use the value as a random seed\n"
literal|"scatter_ports %d\n\n"
argument_list|,
name|p_opts
operator|->
name|scatter_ports
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Don't use scatter for ports defined in\n"
literal|"# guid_routing_order file\n"
literal|"guid_routing_order_no_scatter %s\n\n"
argument_list|,
name|p_opts
operator|->
name|guid_routing_order_no_scatter
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# SA database file name\nsa_db_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|sa_db_file
condition|?
name|p_opts
operator|->
name|sa_db_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# If TRUE causes OpenSM to dump SA database at the end of\n"
literal|"# every light sweep, regardless of the verbosity level\n"
literal|"sa_db_dump %s\n\n"
argument_list|,
name|p_opts
operator|->
name|sa_db_dump
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Torus-2QoS configuration file name\ntorus_config %s\n\n"
argument_list|,
name|p_opts
operator|->
name|torus_conf_file
condition|?
name|p_opts
operator|->
name|torus_conf_file
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# HANDOVER - MULTIPLE SMs OPTIONS\n#\n"
literal|"# SM priority used for deciding who is the master\n"
literal|"# Range goes from 0 (lowest priority) to 15 (highest).\n"
literal|"sm_priority %u\n\n"
literal|"# If TRUE other SMs on the subnet should be ignored\n"
literal|"ignore_other_sm %s\n\n"
literal|"# Timeout in [msec] between two polls of active master SM\n"
literal|"sminfo_polling_timeout %u\n\n"
literal|"# Number of failing polls of remote SM that declares it dead\n"
literal|"polling_retry_number %u\n\n"
literal|"# If TRUE honor the guid2lid file when coming out of standby\n"
literal|"# state, if such file exists and is valid\n"
literal|"honor_guid2lid_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|sm_priority
argument_list|,
name|p_opts
operator|->
name|ignore_other_sm
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|sminfo_polling_timeout
argument_list|,
name|p_opts
operator|->
name|polling_retry_number
argument_list|,
name|p_opts
operator|->
name|honor_guid2lid_file
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# TIMING AND THREADING OPTIONS\n#\n"
literal|"# Maximum number of SMPs sent in parallel\n"
literal|"max_wire_smps %u\n\n"
literal|"# Maximum number of timeout based SMPs allowed to be outstanding\n"
literal|"# A value less than or equal to max_wire_smps disables this mechanism\n"
literal|"max_wire_smps2 %u\n\n"
literal|"# The timeout in [usec] used for sending SMPs above max_wire_smps limit\n"
literal|"# and below max_wire_smps2 limit\n"
literal|"max_smps_timeout %u\n\n"
literal|"# The maximum time in [msec] allowed for a transaction to complete\n"
literal|"transaction_timeout %u\n\n"
literal|"# The maximum number of retries allowed for a transaction to complete\n"
literal|"transaction_retries %u\n\n"
literal|"# Maximal time in [msec] a message can stay in the incoming message queue.\n"
literal|"# If there is more than one message in the queue and the last message\n"
literal|"# stayed in the queue more than this value, any SA request will be\n"
literal|"# immediately be dropped but BUSY status is not currently returned.\n"
literal|"max_msg_fifo_timeout %u\n\n"
literal|"# Use a single thread for handling SA queries\n"
literal|"single_thread %s\n\n"
argument_list|,
name|p_opts
operator|->
name|max_wire_smps
argument_list|,
name|p_opts
operator|->
name|max_wire_smps2
argument_list|,
name|p_opts
operator|->
name|max_smps_timeout
argument_list|,
name|p_opts
operator|->
name|transaction_timeout
argument_list|,
name|p_opts
operator|->
name|transaction_retries
argument_list|,
name|p_opts
operator|->
name|max_msg_fifo_timeout
argument_list|,
name|p_opts
operator|->
name|single_thread
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# MISC OPTIONS\n#\n"
literal|"# Daemon mode\n"
literal|"daemon %s\n\n"
literal|"# SM Inactive\n"
literal|"sm_inactive %s\n\n"
literal|"# Babbling Port Policy\n"
literal|"babbling_port_policy %s\n\n"
literal|"# Drop event subscriptions (InformInfo and ServiceRecord) on port removal and SM coming out of STANDBY\n"
literal|"drop_event_subscriptions %s\n\n"
literal|"# Validate IPoIB non-broadcast group creation parameters against\n"
literal|"# broadcast group parameters per IETF RFC 4391 (default TRUE)\n"
literal|"ipoib_mcgroup_creation_validation %s\n\n"
literal|"# Validate multicast join parameters against multicast group\n"
literal|"# parameters when MC group already exists\n"
literal|"mcgroup_join_validation %s\n\n"
literal|"# Use Optimized SLtoVLMapping programming if supported by device\n"
literal|"use_optimized_slvl %s\n\n"
literal|"# Sync in memory files used for high availability with storage\n"
literal|"fsync_high_avail_files %s\n\n"
argument_list|,
name|p_opts
operator|->
name|daemon
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|sm_inactive
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|babbling_port_policy
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|drop_event_subscriptions
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|ipoib_mcgroup_creation_validation
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|mcgroup_join_validation
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|use_optimized_slvl
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|fsync_high_avail_files
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ENABLE_OSM_PERF_MGR
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Performance Manager Options\n#\n"
literal|"# perfmgr enable\n"
literal|"# PerfMgr is enabled if TRUE and disabled if FALSE (default FALSE)\n"
literal|"perfmgr %s\n\n"
literal|"# redirection enable\n"
literal|"# Redirection supported if TRUE and not supported if FALSE (default TRUE)\n"
literal|"perfmgr_redir %s\n\n"
literal|"# sweep time in seconds (default %u seconds)\n"
literal|"perfmgr_sweep_time_s %u\n\n"
literal|"# Max outstanding queries (default %u)\n"
literal|"perfmgr_max_outstanding_queries %u\n\n"
literal|"# Ignore CAs on sweep (default FALSE)\n"
literal|"perfmgr_ignore_cas %s\n\n"
literal|"# Remove missing nodes from DB (default TRUE)\n"
literal|"perfmgr_rm_nodes %s\n\n"
literal|"# Log error counters to opensm.log (default TRUE)\n"
literal|"perfmgr_log_errors %s\n\n"
literal|"# Query PerfMgt Get(ClassPortInfo) for extended capabilities\n"
literal|"# Extended capabilities include 64 bit extended counters\n"
literal|"# and transmit wait support (default TRUE)\n"
literal|"perfmgr_query_cpi %s\n\n"
literal|"# Log xmit_wait errors (default FALSE)\n"
literal|"perfmgr_xmit_wait_log %s\n\n"
literal|"# If logging xmit_wait's; set threshold (default %u)\n"
literal|"perfmgr_xmit_wait_threshold %u\n\n"
argument_list|,
name|p_opts
operator|->
name|perfmgr
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|perfmgr_redir
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|OSM_PERFMGR_DEFAULT_SWEEP_TIME_S
argument_list|,
name|p_opts
operator|->
name|perfmgr_sweep_time_s
argument_list|,
name|OSM_PERFMGR_DEFAULT_MAX_OUTSTANDING_QUERIES
argument_list|,
name|p_opts
operator|->
name|perfmgr_max_outstanding_queries
argument_list|,
name|p_opts
operator|->
name|perfmgr_ignore_cas
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|perfmgr_rm_nodes
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|perfmgr_log_errors
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|perfmgr_query_cpi
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|perfmgr_xmit_wait_log
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|OSM_PERFMGR_DEFAULT_XMIT_WAIT_THRESHOLD
argument_list|,
name|p_opts
operator|->
name|perfmgr_xmit_wait_threshold
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Event DB Options\n#\n"
literal|"# Dump file to dump the events to\n"
literal|"event_db_dump_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|event_db_dump_file
condition|?
name|p_opts
operator|->
name|event_db_dump_file
else|:
name|null_str
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* ENABLE_OSM_PERF_MGR */
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Event Plugin Options\n#\n"
literal|"# Event plugin name(s)\n"
literal|"event_plugin_name %s\n\n"
literal|"# Options string that would be passed to the plugin(s)\n"
literal|"event_plugin_options %s\n\n"
argument_list|,
name|p_opts
operator|->
name|event_plugin_name
condition|?
name|p_opts
operator|->
name|event_plugin_name
else|:
name|null_str
argument_list|,
name|p_opts
operator|->
name|event_plugin_options
condition|?
name|p_opts
operator|->
name|event_plugin_options
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Node name map for mapping node's to more descriptive node descriptions\n"
literal|"# (man ibnetdiscover for more information)\n#\n"
literal|"node_name_map_name %s\n\n"
argument_list|,
name|p_opts
operator|->
name|node_name_map_name
condition|?
name|p_opts
operator|->
name|node_name_map_name
else|:
name|null_str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# DEBUG FEATURES\n#\n"
literal|"# The log flags used\n"
literal|"log_flags 0x%02x\n\n"
literal|"# Force flush of the log file after each log message\n"
literal|"force_log_flush %s\n\n"
literal|"# Log file to be used\n"
literal|"log_file %s\n\n"
literal|"# Limit the size of the log file in MB. If overrun, log is restarted\n"
literal|"log_max_size %u\n\n"
literal|"# If TRUE will accumulate the log over multiple OpenSM sessions\n"
literal|"accum_log_file %s\n\n"
literal|"# Per module logging configuration file\n"
literal|"# Each line in config file contains<module_name><separator><log_flags>\n"
literal|"# where module_name is file name including .c\n"
literal|"# separator is either = , space, or tab\n"
literal|"# log_flags is the same flags as used in the coarse/overall logging\n"
literal|"per_module_logging_file %s\n\n"
literal|"# The directory to hold the file OpenSM dumps\n"
literal|"dump_files_dir %s\n\n"
literal|"# If TRUE enables new high risk options and hardware specific quirks\n"
literal|"enable_quirks %s\n\n"
literal|"# If TRUE disables client reregistration\n"
literal|"no_clients_rereg %s\n\n"
literal|"# If TRUE OpenSM should disable multicast support and\n"
literal|"# no multicast routing is performed if TRUE\n"
literal|"disable_multicast %s\n\n"
literal|"# If TRUE opensm will exit on fatal initialization issues\n"
literal|"exit_on_fatal %s\n\n"
literal|"# console [off|local"
ifdef|#
directive|ifdef
name|ENABLE_OSM_CONSOLE_LOOPBACK
literal|"|loopback"
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ENABLE_OSM_CONSOLE_SOCKET
literal|"|socket]\n"
else|#
directive|else
literal|"]\n"
endif|#
directive|endif
literal|"console %s\n\n"
literal|"# Telnet port for console (default %d)\n"
literal|"console_port %d\n\n"
argument_list|,
name|p_opts
operator|->
name|log_flags
argument_list|,
name|p_opts
operator|->
name|force_log_flush
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|log_file
argument_list|,
name|p_opts
operator|->
name|log_max_size
argument_list|,
name|p_opts
operator|->
name|accum_log_file
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|per_module_logging_file
condition|?
name|p_opts
operator|->
name|per_module_logging_file
else|:
name|null_str
argument_list|,
name|p_opts
operator|->
name|dump_files_dir
argument_list|,
name|p_opts
operator|->
name|enable_quirks
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|no_clients_rereg
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|disable_multicast
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|exit_on_fatal
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|console
argument_list|,
name|OSM_DEFAULT_CONSOLE_PORT
argument_list|,
name|p_opts
operator|->
name|console_port
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# QoS OPTIONS\n#\n"
literal|"# Enable QoS setup\n"
literal|"qos %s\n\n"
literal|"# QoS policy file to be used\n"
literal|"qos_policy_file %s\n"
literal|"# Supress QoS MAD status errors\n"
literal|"suppress_sl2vl_mad_status_errors %s\n\n"
argument_list|,
name|p_opts
operator|->
name|qos
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|p_opts
operator|->
name|qos_policy_file
argument_list|,
name|p_opts
operator|->
name|suppress_sl2vl_mad_status_errors
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS default options"
argument_list|,
literal|"qos"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS CA options"
argument_list|,
literal|"qos_ca"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_ca_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS Switch Port 0 options"
argument_list|,
literal|"qos_sw0"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_sw0_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS Switch external ports options"
argument_list|,
literal|"qos_swe"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_swe_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|subn_dump_qos_options
argument_list|(
name|out
argument_list|,
literal|"QoS Router ports options"
argument_list|,
literal|"qos_rtr"
argument_list|,
operator|&
name|p_opts
operator|->
name|qos_rtr_options
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Congestion Control OPTIONS (EXPERIMENTAL)\n#\n\n"
literal|"# Enable Congestion Control Configuration\n"
literal|"congestion_control %s\n\n"
literal|"# CCKey to use when configuring congestion control\n"
literal|"# note that this does not configure a new CCkey, only the CCkey to use\n"
literal|"cc_key 0x%016"
name|PRIx64
literal|"\n\n"
literal|"# Congestion Control Max outstanding MAD\n"
literal|"cc_max_outstanding_mads %u\n\n"
argument_list|,
name|p_opts
operator|->
name|congestion_control
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_opts
operator|->
name|cc_key
argument_list|)
argument_list|,
name|p_opts
operator|->
name|cc_max_outstanding_mads
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Congestion Control SwitchCongestionSetting options\n#\n"
literal|"# Control Map - bitmask indicating which of the following are to be used\n"
literal|"# bit 0 - victim mask\n"
literal|"# bit 1 - credit mask\n"
literal|"# bit 2 - threshold + packet size\n"
literal|"# bit 3 - credit starvation threshold + return delay valid\n"
literal|"# bit 4 - marking rate valid\n"
literal|"cc_sw_cong_setting_control_map 0x%X\n\n"
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_opts
operator|->
name|cc_sw_cong_setting_control_map
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Victim Mask - 256 bit mask representing switch ports, mark packets with FECN\n"
literal|"# whether they are the source or victim of congestion\n"
literal|"# bit 0 - port 0 (enhanced port)\n"
literal|"# bit 1 - port 1\n"
literal|"# ...\n"
literal|"# bit 254 - port 254\n"
literal|"# bit 255 - reserved\n"
literal|"cc_sw_cong_setting_victim_mask 0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IB_CC_PORT_MASK_DATA_SIZE
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%02X"
argument_list|,
name|p_opts
operator|->
name|cc_sw_cong_setting_victim_mask
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Credit Mask - 256 bit mask representing switch ports to apply credit starvation\n"
literal|"# bit 0 - port 0 (enhanced port)\n"
literal|"# bit 1 - port 1\n"
literal|"# ...\n"
literal|"# bit 254 - port 254\n"
literal|"# bit 255 - reserved\n"
literal|"cc_sw_cong_setting_credit_mask 0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IB_CC_PORT_MASK_DATA_SIZE
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%02X"
argument_list|,
name|p_opts
operator|->
name|cc_sw_cong_setting_credit_mask
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Threshold - value indicating aggressiveness of congestion marking\n"
literal|"# 0x0 - none, 0x1 - loose, ..., 0xF - aggressive\n"
literal|"cc_sw_cong_setting_threshold 0x%02X\n\n"
literal|"# Packet Size - any packet less than this size will not be marked with a FECN\n"
literal|"# units are in credits\n"
literal|"cc_sw_cong_setting_packet_size %u\n\n"
literal|"# Credit Starvation Threshold - value indicating aggressiveness of credit starvation\n"
literal|"# 0x0 - none, 0x1 - loose, ..., 0xF - aggressive\n"
literal|"cc_sw_cong_setting_credit_starvation_threshold 0x%02X\n\n"
literal|"# Credit Starvation Return Delay - in CCT entry shift:multiplier format, see IB spec\n"
literal|"cc_sw_cong_setting_credit_starvation_return_delay %u:%u\n\n"
literal|"# Marking Rate - mean number of packets between markings\n"
literal|"cc_sw_cong_setting_marking_rate %u\n\n"
argument_list|,
name|p_opts
operator|->
name|cc_sw_cong_setting_threshold
argument_list|,
name|p_opts
operator|->
name|cc_sw_cong_setting_packet_size
argument_list|,
name|p_opts
operator|->
name|cc_sw_cong_setting_credit_starvation_threshold
argument_list|,
name|p_opts
operator|->
name|cc_sw_cong_setting_credit_starvation_return_delay
operator|.
name|shift
argument_list|,
name|p_opts
operator|->
name|cc_sw_cong_setting_credit_starvation_return_delay
operator|.
name|multiplier
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|cc_sw_cong_setting_marking_rate
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Congestion Control CA Congestion Setting options\n#\n"
literal|"# Port Control\n"
literal|"# bit 0 = 0, QP based congestion control\n"
literal|"# bit 0 = 1, SL/port based congestion control\n"
literal|"cc_ca_cong_setting_port_control 0x%04X\n\n"
literal|"# Control Map - 16 bit bitmask indicating which SLs should be configured\n"
literal|"cc_ca_cong_setting_control_map 0x%04X\n\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|cc_ca_cong_setting_port_control
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|cc_ca_cong_setting_control_map
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# CA Congestion Setting Entries\n#\n"
literal|"# Each of congestion control settings below configures the CA Congestion\n"
literal|"# Settings for an individual SL.  The SL must be specified before the value.\n"
literal|"# These options may be specified multiple times to configure different values\n"
literal|"# for different SLs.\n"
literal|"#\n"
literal|"# ccti timer - when expires decrements 1 from the CCTI\n"
literal|"# ccti increase - number to be added to the table index on receipt of a BECN\n"
literal|"# trigger threshold - when the ccti is equal to this, an event is logged\n"
literal|"# ccti min - the minimum value for the ccti.  This imposes a minimum rate\n"
literal|"#            on the injection rate\n\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IB_CA_CONG_ENTRY_DATA_SIZE
condition|;
name|i
operator|++
control|)
block|{
comment|/* Don't output unless one of the settings has been set, there's no need 		 * to output 16 chunks of this with all defaults of 0 */
if|if
condition|(
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
name|i
index|]
operator|.
name|ccti_timer
operator|||
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
name|i
index|]
operator|.
name|ccti_increase
operator|||
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
name|i
index|]
operator|.
name|trigger_threshold
operator|||
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
name|i
index|]
operator|.
name|ccti_min
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# SL = %u\n"
literal|"cc_ca_cong_setting_ccti_timer %u %u\n"
literal|"cc_ca_cong_setting_ccti_increase %u %u\n"
literal|"cc_ca_cong_setting_trigger_threshold %u %u\n"
literal|"cc_ca_cong_setting_ccti_min %u %u\n\n"
argument_list|,
name|i
argument_list|,
name|i
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
name|i
index|]
operator|.
name|ccti_timer
argument_list|)
argument_list|,
name|i
argument_list|,
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
name|i
index|]
operator|.
name|ccti_increase
argument_list|,
name|i
argument_list|,
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
name|i
index|]
operator|.
name|trigger_threshold
argument_list|,
name|i
argument_list|,
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
name|i
index|]
operator|.
name|ccti_min
argument_list|)
expr_stmt|;
name|cacongoutputcount
operator|++
expr_stmt|;
block|}
block|}
comment|/* If by chance all the CA Cong Settings are default, output at least 1 chunk          * for illustration */
if|if
condition|(
operator|!
name|cacongoutputcount
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# SL = 0\n"
literal|"cc_ca_cong_setting_ccti_timer 0 %u\n"
literal|"cc_ca_cong_setting_ccti_increase 0 %u\n"
literal|"cc_ca_cong_setting_trigger_threshold 0 %u\n"
literal|"cc_ca_cong_setting_ccti_min 0 %u\n\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
literal|0
index|]
operator|.
name|ccti_timer
argument_list|)
argument_list|,
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
literal|0
index|]
operator|.
name|ccti_increase
argument_list|,
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
literal|0
index|]
operator|.
name|trigger_threshold
argument_list|,
name|p_opts
operator|->
name|cc_ca_cong_entries
index|[
literal|0
index|]
operator|.
name|ccti_min
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# Congestion Control Table\n#\n"
literal|"# Comma separated list of CCT entries representing CCT.\n"
literal|"# Format is shift:multipler,shift_multiplier,shift:multiplier,...\n"
literal|"cc_cct "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_opts
operator|->
name|cc_cct
operator|.
name|entries_len
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s\n"
argument_list|,
name|null_str
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%u:%u"
argument_list|,
name|p_opts
operator|->
name|cc_cct
operator|.
name|entries
index|[
literal|0
index|]
operator|.
name|shift
argument_list|,
name|p_opts
operator|->
name|cc_cct
operator|.
name|entries
index|[
literal|0
index|]
operator|.
name|multiplier
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|p_opts
operator|->
name|cc_cct
operator|.
name|entries_len
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|",%u:%u"
argument_list|,
name|p_opts
operator|->
name|cc_cct
operator|.
name|entries
index|[
name|i
index|]
operator|.
name|shift
argument_list|,
name|p_opts
operator|->
name|cc_cct
operator|.
name|entries
index|[
name|i
index|]
operator|.
name|multiplier
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Prefix routes file name\n"
literal|"prefix_routes_file %s\n\n"
argument_list|,
name|p_opts
operator|->
name|prefix_routes_file
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"#\n# IPv6 Solicited Node Multicast (SNM) Options\n#\n"
literal|"consolidate_ipv6_snm_req %s\n\n"
argument_list|,
name|p_opts
operator|->
name|consolidate_ipv6_snm_req
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"# Log prefix\nlog_prefix %s\n\n"
argument_list|,
name|p_opts
operator|->
name|log_prefix
argument_list|)
expr_stmt|;
comment|/* optional string attributes ... */
block|}
end_function

begin_function
name|int
name|osm_subn_write_conf_file
parameter_list|(
name|char
modifier|*
name|file_name
parameter_list|,
name|IN
name|osm_subn_opt_t
modifier|*
name|p_opts
parameter_list|)
block|{
name|FILE
modifier|*
name|opts_file
decl_stmt|;
name|opts_file
operator|=
name|fopen
argument_list|(
name|file_name
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opts_file
condition|)
block|{
name|printf
argument_list|(
literal|"cannot open file \'%s\' for writing: %s\n"
argument_list|,
name|file_name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|osm_subn_output_conf
argument_list|(
name|opts_file
argument_list|,
name|p_opts
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|opts_file
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2012 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  * Copyright (c) 2008 Xsigo Systems Inc.  All rights reserved.  * Copyright (c) 2009 HNR Consulting.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    OSM QoS Policy functions.  *  * Author:  *    Yevgeny Kliteynik, Mellanox  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_file_ids.h>
end_include

begin_define
define|#
directive|define
name|FILE_ID
value|OSM_FILE_QOS_POLICY_C
end_define

begin_include
include|#
directive|include
file|<opensm/osm_log.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_node.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_port.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_partition.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_opensm.h>
end_include

begin_include
include|#
directive|include
file|<opensm/osm_qos_policy.h>
end_include

begin_decl_stmt
specifier|extern
name|osm_qos_level_t
name|__default_simple_qos_level
decl_stmt|;
end_decl_stmt

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|void
name|__build_nodebyname_hash
parameter_list|(
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|)
block|{
name|osm_node_t
modifier|*
name|p_node
decl_stmt|;
name|cl_qmap_t
modifier|*
name|p_node_guid_tbl
init|=
operator|&
name|p_qos_policy
operator|->
name|p_subn
operator|->
name|node_guid_tbl
decl_stmt|;
name|p_qos_policy
operator|->
name|p_node_hash
operator|=
name|st_init_strtable
argument_list|()
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_qos_policy
operator|->
name|p_node_hash
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_node_guid_tbl
operator|||
operator|!
name|cl_qmap_count
argument_list|(
name|p_node_guid_tbl
argument_list|)
condition|)
return|return;
for|for
control|(
name|p_node
operator|=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
name|p_node_guid_tbl
argument_list|)
init|;
name|p_node
operator|!=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
name|p_node_guid_tbl
argument_list|)
condition|;
name|p_node
operator|=
operator|(
name|osm_node_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_node
operator|->
name|map_item
argument_list|)
control|)
block|{
if|if
condition|(
operator|!
name|st_lookup
argument_list|(
name|p_qos_policy
operator|->
name|p_node_hash
argument_list|,
operator|(
name|st_data_t
operator|)
name|p_node
operator|->
name|print_desc
argument_list|,
name|NULL
argument_list|)
condition|)
name|st_insert
argument_list|(
name|p_qos_policy
operator|->
name|p_node_hash
argument_list|,
operator|(
name|st_data_t
operator|)
name|p_node
operator|->
name|print_desc
argument_list|,
operator|(
name|st_data_t
operator|)
name|p_node
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|boolean_t
name|__is_num_in_range_arr
parameter_list|(
name|uint64_t
modifier|*
modifier|*
name|range_arr
parameter_list|,
name|unsigned
name|range_arr_len
parameter_list|,
name|uint64_t
name|num
parameter_list|)
block|{
name|unsigned
name|ind_1
init|=
literal|0
decl_stmt|;
name|unsigned
name|ind_2
init|=
name|range_arr_len
operator|-
literal|1
decl_stmt|;
name|unsigned
name|ind_mid
decl_stmt|;
if|if
condition|(
operator|!
name|range_arr
operator|||
operator|!
name|range_arr_len
condition|)
return|return
name|FALSE
return|;
while|while
condition|(
name|ind_1
operator|<=
name|ind_2
condition|)
block|{
if|if
condition|(
name|num
operator|<
name|range_arr
index|[
name|ind_1
index|]
index|[
literal|0
index|]
operator|||
name|num
operator|>
name|range_arr
index|[
name|ind_2
index|]
index|[
literal|1
index|]
condition|)
return|return
name|FALSE
return|;
elseif|else
if|if
condition|(
name|num
operator|<=
name|range_arr
index|[
name|ind_1
index|]
index|[
literal|1
index|]
operator|||
name|num
operator|>=
name|range_arr
index|[
name|ind_2
index|]
index|[
literal|0
index|]
condition|)
return|return
name|TRUE
return|;
name|ind_mid
operator|=
name|ind_1
operator|+
operator|(
name|ind_2
operator|-
name|ind_1
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|num
operator|<
name|range_arr
index|[
name|ind_mid
index|]
index|[
literal|0
index|]
condition|)
name|ind_2
operator|=
name|ind_mid
expr_stmt|;
elseif|else
if|if
condition|(
name|num
operator|>
name|range_arr
index|[
name|ind_mid
index|]
index|[
literal|1
index|]
condition|)
name|ind_1
operator|=
name|ind_mid
expr_stmt|;
else|else
return|return
name|TRUE
return|;
name|ind_1
operator|++
expr_stmt|;
name|ind_2
operator|--
expr_stmt|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|void
name|__free_single_element
parameter_list|(
name|void
modifier|*
name|p_element
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
if|if
condition|(
name|p_element
condition|)
name|free
argument_list|(
name|p_element
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|osm_qos_port_t
modifier|*
name|osm_qos_policy_port_create
parameter_list|(
name|osm_physp_t
modifier|*
name|p_physp
parameter_list|)
block|{
name|osm_qos_port_t
modifier|*
name|p
init|=
operator|(
name|osm_qos_port_t
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_qos_port_t
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
condition|)
name|p
operator|->
name|p_physp
operator|=
name|p_physp
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|osm_qos_port_group_t
modifier|*
name|osm_qos_policy_port_group_create
parameter_list|()
block|{
name|osm_qos_port_group_t
modifier|*
name|p
init|=
operator|(
name|osm_qos_port_group_t
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_qos_port_group_t
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
condition|)
name|cl_qmap_init
argument_list|(
operator|&
name|p
operator|->
name|port_map
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|void
name|osm_qos_policy_port_group_destroy
parameter_list|(
name|osm_qos_port_group_t
modifier|*
name|p
parameter_list|)
block|{
name|osm_qos_port_t
modifier|*
name|p_port
decl_stmt|;
name|osm_qos_port_t
modifier|*
name|p_old_port
decl_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return;
if|if
condition|(
name|p
operator|->
name|name
condition|)
name|free
argument_list|(
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|use
condition|)
name|free
argument_list|(
name|p
operator|->
name|use
argument_list|)
expr_stmt|;
name|p_port
operator|=
operator|(
name|osm_qos_port_t
operator|*
operator|)
name|cl_qmap_head
argument_list|(
operator|&
name|p
operator|->
name|port_map
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_port
operator|!=
operator|(
name|osm_qos_port_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p
operator|->
name|port_map
argument_list|)
condition|)
block|{
name|p_old_port
operator|=
name|p_port
expr_stmt|;
name|p_port
operator|=
operator|(
name|osm_qos_port_t
operator|*
operator|)
name|cl_qmap_next
argument_list|(
operator|&
name|p_port
operator|->
name|map_item
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_old_port
argument_list|)
expr_stmt|;
block|}
name|cl_qmap_remove_all
argument_list|(
operator|&
name|p
operator|->
name|port_map
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|osm_qos_vlarb_scope_t
modifier|*
name|osm_qos_policy_vlarb_scope_create
parameter_list|()
block|{
name|osm_qos_vlarb_scope_t
modifier|*
name|p
init|=
operator|(
name|osm_qos_vlarb_scope_t
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_qos_vlarb_scope_t
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|group_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|across_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|vlarb_high_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|vlarb_low_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|void
name|osm_qos_policy_vlarb_scope_destroy
parameter_list|(
name|osm_qos_vlarb_scope_t
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|p
condition|)
return|return;
name|cl_list_apply_func
argument_list|(
operator|&
name|p
operator|->
name|group_list
argument_list|,
name|__free_single_element
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cl_list_apply_func
argument_list|(
operator|&
name|p
operator|->
name|across_list
argument_list|,
name|__free_single_element
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cl_list_apply_func
argument_list|(
operator|&
name|p
operator|->
name|vlarb_high_list
argument_list|,
name|__free_single_element
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cl_list_apply_func
argument_list|(
operator|&
name|p
operator|->
name|vlarb_low_list
argument_list|,
name|__free_single_element
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|group_list
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|across_list
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|vlarb_high_list
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|vlarb_low_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|group_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|across_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|vlarb_high_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|vlarb_low_list
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|osm_qos_sl2vl_scope_t
modifier|*
name|osm_qos_policy_sl2vl_scope_create
parameter_list|()
block|{
name|osm_qos_sl2vl_scope_t
modifier|*
name|p
init|=
operator|(
name|osm_qos_sl2vl_scope_t
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_qos_sl2vl_scope_t
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|group_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|across_from_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|across_to_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|void
name|osm_qos_policy_sl2vl_scope_destroy
parameter_list|(
name|osm_qos_sl2vl_scope_t
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|p
condition|)
return|return;
name|cl_list_apply_func
argument_list|(
operator|&
name|p
operator|->
name|group_list
argument_list|,
name|__free_single_element
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cl_list_apply_func
argument_list|(
operator|&
name|p
operator|->
name|across_from_list
argument_list|,
name|__free_single_element
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cl_list_apply_func
argument_list|(
operator|&
name|p
operator|->
name|across_to_list
argument_list|,
name|__free_single_element
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|group_list
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|across_from_list
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|across_to_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|group_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|across_from_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|across_to_list
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|osm_qos_level_t
modifier|*
name|osm_qos_policy_qos_level_create
parameter_list|()
block|{
name|osm_qos_level_t
modifier|*
name|p
init|=
operator|(
name|osm_qos_level_t
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_qos_level_t
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|void
name|osm_qos_policy_qos_level_destroy
parameter_list|(
name|osm_qos_level_t
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return;
name|free
argument_list|(
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|use
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|path_bits_range_len
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|p
operator|->
name|path_bits_range_arr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|path_bits_range_arr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|pkey_range_len
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
operator|(
name|p
operator|->
name|pkey_range_arr
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|pkey_range_arr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|boolean_t
name|osm_qos_level_has_pkey
parameter_list|(
name|IN
specifier|const
name|osm_qos_level_t
modifier|*
name|p_qos_level
parameter_list|,
name|IN
name|ib_net16_t
name|pkey
parameter_list|)
block|{
if|if
condition|(
operator|!
name|p_qos_level
operator|||
operator|!
name|p_qos_level
operator|->
name|pkey_range_len
condition|)
return|return
name|FALSE
return|;
return|return
name|__is_num_in_range_arr
argument_list|(
name|p_qos_level
operator|->
name|pkey_range_arr
argument_list|,
name|p_qos_level
operator|->
name|pkey_range_len
argument_list|,
name|cl_ntoh16
argument_list|(
name|ib_pkey_get_base
argument_list|(
name|pkey
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|ib_net16_t
name|osm_qos_level_get_shared_pkey
parameter_list|(
name|IN
specifier|const
name|osm_qos_level_t
modifier|*
name|p_qos_level
parameter_list|,
name|IN
specifier|const
name|osm_physp_t
modifier|*
name|p_src_physp
parameter_list|,
name|IN
specifier|const
name|osm_physp_t
modifier|*
name|p_dest_physp
parameter_list|,
name|IN
specifier|const
name|boolean_t
name|allow_both_pkeys
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|uint16_t
name|pkey_ho
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|p_qos_level
operator|||
operator|!
name|p_qos_level
operator|->
name|pkey_range_len
condition|)
return|return
literal|0
return|;
comment|/* 	 * ToDo: This approach is not optimal. 	 *       Think how to find shared pkey that also exists 	 *       in QoS level in less runtime. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_qos_level
operator|->
name|pkey_range_len
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|pkey_ho
operator|=
name|p_qos_level
operator|->
name|pkey_range_arr
index|[
name|i
index|]
index|[
literal|0
index|]
init|;
name|pkey_ho
operator|<=
name|p_qos_level
operator|->
name|pkey_range_arr
index|[
name|i
index|]
index|[
literal|1
index|]
condition|;
name|pkey_ho
operator|++
control|)
block|{
if|if
condition|(
name|osm_physp_share_this_pkey
argument_list|(
name|p_src_physp
argument_list|,
name|p_dest_physp
argument_list|,
name|cl_hton16
argument_list|(
name|pkey_ho
argument_list|)
argument_list|,
name|allow_both_pkeys
argument_list|)
condition|)
return|return
name|cl_hton16
argument_list|(
name|pkey_ho
argument_list|)
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|osm_qos_match_rule_t
modifier|*
name|osm_qos_policy_match_rule_create
parameter_list|()
block|{
name|osm_qos_match_rule_t
modifier|*
name|p
init|=
operator|(
name|osm_qos_match_rule_t
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_qos_match_rule_t
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|source_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|source_group_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|destination_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p
operator|->
name|destination_group_list
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
return|return
name|p
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|void
name|osm_qos_policy_match_rule_destroy
parameter_list|(
name|osm_qos_match_rule_t
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return;
if|if
condition|(
name|p
operator|->
name|qos_level_name
condition|)
name|free
argument_list|(
name|p
operator|->
name|qos_level_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|use
condition|)
name|free
argument_list|(
name|p
operator|->
name|use
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|service_id_range_arr
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|service_id_range_len
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|p
operator|->
name|service_id_range_arr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|service_id_range_arr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|qos_class_range_arr
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|qos_class_range_len
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|p
operator|->
name|qos_class_range_arr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|qos_class_range_arr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|pkey_range_arr
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|pkey_range_len
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|p
operator|->
name|pkey_range_arr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|pkey_range_arr
argument_list|)
expr_stmt|;
block|}
name|cl_list_apply_func
argument_list|(
operator|&
name|p
operator|->
name|source_list
argument_list|,
name|__free_single_element
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|source_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|source_list
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|source_group_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|source_group_list
argument_list|)
expr_stmt|;
name|cl_list_apply_func
argument_list|(
operator|&
name|p
operator|->
name|destination_list
argument_list|,
name|__free_single_element
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|destination_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|destination_list
argument_list|)
expr_stmt|;
name|cl_list_remove_all
argument_list|(
operator|&
name|p
operator|->
name|destination_group_list
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p
operator|->
name|destination_group_list
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|osm_qos_policy_t
modifier|*
name|osm_qos_policy_create
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|)
block|{
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
init|=
operator|(
name|osm_qos_policy_t
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|osm_qos_policy_t
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|p_qos_policy
condition|)
return|return
name|NULL
return|;
name|cl_list_construct
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|port_groups
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|port_groups
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_construct
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|vlarb_tables
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|vlarb_tables
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_construct
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|sl2vl_tables
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|sl2vl_tables
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_construct
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_levels
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_levels
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|cl_list_construct
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
expr_stmt|;
name|cl_list_init
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|p_qos_policy
operator|->
name|p_subn
operator|=
name|p_subn
expr_stmt|;
name|__build_nodebyname_hash
argument_list|(
name|p_qos_policy
argument_list|)
expr_stmt|;
return|return
name|p_qos_policy
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|void
name|osm_qos_policy_destroy
parameter_list|(
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|)
block|{
name|cl_list_iterator_t
name|list_iterator
decl_stmt|;
name|osm_qos_port_group_t
modifier|*
name|p_port_group
init|=
name|NULL
decl_stmt|;
name|osm_qos_vlarb_scope_t
modifier|*
name|p_vlarb_scope
init|=
name|NULL
decl_stmt|;
name|osm_qos_sl2vl_scope_t
modifier|*
name|p_sl2vl_scope
init|=
name|NULL
decl_stmt|;
name|osm_qos_level_t
modifier|*
name|p_qos_level
init|=
name|NULL
decl_stmt|;
name|osm_qos_match_rule_t
modifier|*
name|p_qos_match_rule
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|p_qos_policy
condition|)
return|return;
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|port_groups
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|port_groups
argument_list|)
condition|)
block|{
name|p_port_group
operator|=
operator|(
name|osm_qos_port_group_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_port_group
condition|)
name|osm_qos_policy_port_group_destroy
argument_list|(
name|p_port_group
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
name|cl_list_remove_all
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|port_groups
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|port_groups
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|vlarb_tables
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|vlarb_tables
argument_list|)
condition|)
block|{
name|p_vlarb_scope
operator|=
operator|(
name|osm_qos_vlarb_scope_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_vlarb_scope
condition|)
name|osm_qos_policy_vlarb_scope_destroy
argument_list|(
name|p_vlarb_scope
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
name|cl_list_remove_all
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|vlarb_tables
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|vlarb_tables
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|sl2vl_tables
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|sl2vl_tables
argument_list|)
condition|)
block|{
name|p_sl2vl_scope
operator|=
operator|(
name|osm_qos_sl2vl_scope_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_sl2vl_scope
condition|)
name|osm_qos_policy_sl2vl_scope_destroy
argument_list|(
name|p_sl2vl_scope
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
name|cl_list_remove_all
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|sl2vl_tables
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|sl2vl_tables
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_levels
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_levels
argument_list|)
condition|)
block|{
name|p_qos_level
operator|=
operator|(
name|osm_qos_level_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_qos_level
condition|)
name|osm_qos_policy_qos_level_destroy
argument_list|(
name|p_qos_level
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
name|cl_list_remove_all
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_levels
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_levels
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
condition|)
block|{
name|p_qos_match_rule
operator|=
operator|(
name|osm_qos_match_rule_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_qos_match_rule
condition|)
name|osm_qos_policy_match_rule_destroy
argument_list|(
name|p_qos_match_rule
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
name|cl_list_remove_all
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
expr_stmt|;
name|cl_list_destroy
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_qos_policy
operator|->
name|p_node_hash
condition|)
name|st_free_table
argument_list|(
name|p_qos_policy
operator|->
name|p_node_hash
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_qos_policy
argument_list|)
expr_stmt|;
name|p_qos_policy
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|boolean_t
name|__qos_policy_is_port_in_group
parameter_list|(
name|osm_subn_t
modifier|*
name|p_subn
parameter_list|,
specifier|const
name|osm_physp_t
modifier|*
name|p_physp
parameter_list|,
name|osm_qos_port_group_t
modifier|*
name|p_port_group
parameter_list|)
block|{
name|osm_node_t
modifier|*
name|p_node
init|=
name|osm_physp_get_node_ptr
argument_list|(
name|p_physp
argument_list|)
decl_stmt|;
name|ib_net64_t
name|port_guid
init|=
name|osm_physp_get_port_guid
argument_list|(
name|p_physp
argument_list|)
decl_stmt|;
name|uint64_t
name|port_guid_ho
init|=
name|cl_ntoh64
argument_list|(
name|port_guid
argument_list|)
decl_stmt|;
comment|/* check whether this port's type matches any of group's types */
if|if
condition|(
name|p_port_group
operator|->
name|node_types
operator|&
operator|(
operator|(
operator|(
name|uint8_t
operator|)
literal|1
operator|)
operator|<<
name|osm_node_get_type
argument_list|(
name|p_node
argument_list|)
operator|)
condition|)
return|return
name|TRUE
return|;
comment|/* check whether this port's guid is in group's port map */
if|if
condition|(
name|cl_qmap_get
argument_list|(
operator|&
name|p_port_group
operator|->
name|port_map
argument_list|,
name|port_guid_ho
argument_list|)
operator|!=
name|cl_qmap_end
argument_list|(
operator|&
name|p_port_group
operator|->
name|port_map
argument_list|)
condition|)
return|return
name|TRUE
return|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/* __qos_policy_is_port_in_group() */
end_comment

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|boolean_t
name|__qos_policy_is_port_in_group_list
parameter_list|(
specifier|const
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|,
specifier|const
name|osm_physp_t
modifier|*
name|p_physp
parameter_list|,
name|cl_list_t
modifier|*
name|p_port_group_list
parameter_list|)
block|{
name|osm_qos_port_group_t
modifier|*
name|p_port_group
decl_stmt|;
name|cl_list_iterator_t
name|list_iterator
decl_stmt|;
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
name|p_port_group_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
name|p_port_group_list
argument_list|)
condition|)
block|{
name|p_port_group
operator|=
operator|(
name|osm_qos_port_group_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_port_group
condition|)
block|{
if|if
condition|(
name|__qos_policy_is_port_in_group
argument_list|(
name|p_qos_policy
operator|->
name|p_subn
argument_list|,
name|p_physp
argument_list|,
name|p_port_group
argument_list|)
condition|)
return|return
name|TRUE
return|;
block|}
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|osm_qos_match_rule_t
modifier|*
name|__qos_policy_get_match_rule_by_params
parameter_list|(
specifier|const
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|,
name|uint64_t
name|service_id
parameter_list|,
name|uint16_t
name|qos_class
parameter_list|,
name|uint16_t
name|pkey
parameter_list|,
specifier|const
name|osm_physp_t
modifier|*
name|p_src_physp
parameter_list|,
specifier|const
name|osm_physp_t
modifier|*
name|p_dest_physp
parameter_list|,
name|ib_net64_t
name|comp_mask
parameter_list|)
block|{
name|osm_qos_match_rule_t
modifier|*
name|p_qos_match_rule
init|=
name|NULL
decl_stmt|;
name|cl_list_iterator_t
name|list_iterator
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
init|=
operator|&
name|p_qos_policy
operator|->
name|p_subn
operator|->
name|p_osm
operator|->
name|log
decl_stmt|;
name|boolean_t
name|matched_by_sguid
init|=
name|FALSE
decl_stmt|,
name|matched_by_dguid
init|=
name|FALSE
decl_stmt|,
name|matched_by_sordguid
init|=
name|FALSE
decl_stmt|,
name|matched_by_class
init|=
name|FALSE
decl_stmt|,
name|matched_by_sid
init|=
name|FALSE
decl_stmt|,
name|matched_by_pkey
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|!
name|cl_list_count
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
condition|)
return|return
name|NULL
return|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
comment|/* Go over all QoS match rules and find the one that matches the request */
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
condition|)
block|{
name|p_qos_match_rule
operator|=
operator|(
name|osm_qos_match_rule_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_qos_match_rule
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* If a match rule has Source groups and no Destination groups, 		 * PR request source has to be in this list */
if|if
condition|(
name|cl_list_count
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|source_group_list
argument_list|)
operator|&&
operator|!
name|cl_list_count
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|destination_group_list
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|__qos_policy_is_port_in_group_list
argument_list|(
name|p_qos_policy
argument_list|,
name|p_src_physp
argument_list|,
operator|&
name|p_qos_match_rule
operator|->
name|source_group_list
argument_list|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|matched_by_sguid
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* If a match rule has Destination groups and no Source groups, 		 * PR request dest. has to be in this list */
if|if
condition|(
name|cl_list_count
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|destination_group_list
argument_list|)
operator|&&
operator|!
name|cl_list_count
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|source_group_list
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|__qos_policy_is_port_in_group_list
argument_list|(
name|p_qos_policy
argument_list|,
name|p_dest_physp
argument_list|,
operator|&
name|p_qos_match_rule
operator|->
name|destination_group_list
argument_list|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|matched_by_dguid
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* If a match rule has both Source and Destination groups, 		 * PR request source or dest. must be in respective list 		 */
if|if
condition|(
name|cl_list_count
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|source_group_list
argument_list|)
operator|&&
name|cl_list_count
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|destination_group_list
argument_list|)
condition|)
block|{
if|if
condition|(
name|__qos_policy_is_port_in_group_list
argument_list|(
name|p_qos_policy
argument_list|,
name|p_src_physp
argument_list|,
operator|&
name|p_qos_match_rule
operator|->
name|source_group_list
argument_list|)
operator|&&
name|__qos_policy_is_port_in_group_list
argument_list|(
name|p_qos_policy
argument_list|,
name|p_dest_physp
argument_list|,
operator|&
name|p_qos_match_rule
operator|->
name|destination_group_list
argument_list|)
condition|)
name|matched_by_sordguid
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
comment|/* If a match rule has QoS classes, PR request HAS 		   to have a matching QoS class to match the rule */
if|if
condition|(
name|p_qos_match_rule
operator|->
name|qos_class_range_len
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|comp_mask
operator|&
name|IB_PR_COMPMASK_QOS_CLASS
operator|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|__is_num_in_range_arr
argument_list|(
name|p_qos_match_rule
operator|->
name|qos_class_range_arr
argument_list|,
name|p_qos_match_rule
operator|->
name|qos_class_range_len
argument_list|,
name|qos_class
argument_list|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|matched_by_class
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* If a match rule has Service IDs, PR request HAS 		   to have a matching Service ID to match the rule */
if|if
condition|(
name|p_qos_match_rule
operator|->
name|service_id_range_len
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|comp_mask
operator|&
name|IB_PR_COMPMASK_SERVICEID_MSB
operator|)
operator|||
operator|!
operator|(
name|comp_mask
operator|&
name|IB_PR_COMPMASK_SERVICEID_LSB
operator|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|__is_num_in_range_arr
argument_list|(
name|p_qos_match_rule
operator|->
name|service_id_range_arr
argument_list|,
name|p_qos_match_rule
operator|->
name|service_id_range_len
argument_list|,
name|service_id
argument_list|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|matched_by_sid
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* If a match rule has PKeys, PR request HAS 		   to have a matching PKey to match the rule */
if|if
condition|(
name|p_qos_match_rule
operator|->
name|pkey_range_len
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|comp_mask
operator|&
name|IB_PR_COMPMASK_PKEY
operator|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|__is_num_in_range_arr
argument_list|(
name|p_qos_match_rule
operator|->
name|pkey_range_arr
argument_list|,
name|p_qos_match_rule
operator|->
name|pkey_range_len
argument_list|,
name|pkey
operator|&
literal|0x7FFF
argument_list|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|matched_by_pkey
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* if we got here, then this match-rule matched this PR request */
break|break;
block|}
if|if
condition|(
name|list_iterator
operator|==
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
condition|)
name|p_qos_match_rule
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|p_qos_match_rule
condition|)
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"request matched rule (%s) by:%s%s%s%s%s%s\n"
argument_list|,
operator|(
name|p_qos_match_rule
operator|->
name|use
operator|)
condition|?
name|p_qos_match_rule
operator|->
name|use
else|:
literal|"no description"
argument_list|,
operator|(
name|matched_by_sguid
operator|)
condition|?
literal|" SGUID"
else|:
literal|""
argument_list|,
operator|(
name|matched_by_dguid
operator|)
condition|?
literal|" DGUID"
else|:
literal|""
argument_list|,
operator|(
name|matched_by_sordguid
operator|)
condition|?
literal|"SorDGUID"
else|:
literal|""
argument_list|,
operator|(
name|matched_by_class
operator|)
condition|?
literal|" QoS_Class"
else|:
literal|""
argument_list|,
operator|(
name|matched_by_sid
operator|)
condition|?
literal|" ServiceID"
else|:
literal|""
argument_list|,
operator|(
name|matched_by_pkey
operator|)
condition|?
literal|" PKey"
else|:
literal|""
argument_list|)
expr_stmt|;
else|else
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_DEBUG
argument_list|,
literal|"request not matched any rule\n"
argument_list|)
expr_stmt|;
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
name|p_qos_match_rule
return|;
block|}
end_function

begin_comment
comment|/* __qos_policy_get_match_rule_by_params() */
end_comment

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|osm_qos_level_t
modifier|*
name|__qos_policy_get_qos_level_by_name
parameter_list|(
specifier|const
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|osm_qos_level_t
modifier|*
name|p_qos_level
init|=
name|NULL
decl_stmt|;
name|cl_list_iterator_t
name|list_iterator
decl_stmt|;
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_levels
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_levels
argument_list|)
condition|)
block|{
name|p_qos_level
operator|=
operator|(
name|osm_qos_level_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_qos_level
condition|)
continue|continue;
comment|/* names are case INsensitive */
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
name|p_qos_level
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|p_qos_level
return|;
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|osm_qos_port_group_t
modifier|*
name|__qos_policy_get_port_group_by_name
parameter_list|(
specifier|const
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|,
specifier|const
name|char
modifier|*
specifier|const
name|name
parameter_list|)
block|{
name|osm_qos_port_group_t
modifier|*
name|p_port_group
init|=
name|NULL
decl_stmt|;
name|cl_list_iterator_t
name|list_iterator
decl_stmt|;
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|port_groups
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|port_groups
argument_list|)
condition|)
block|{
name|p_port_group
operator|=
operator|(
name|osm_qos_port_group_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_port_group
condition|)
continue|continue;
comment|/* names are case INsensitive */
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
name|p_port_group
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|p_port_group
return|;
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|void
name|__qos_policy_validate_pkey
parameter_list|(
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|,
name|osm_qos_match_rule_t
modifier|*
name|p_qos_match_rule
parameter_list|,
name|osm_prtn_t
modifier|*
name|p_prtn
parameter_list|)
block|{
if|if
condition|(
operator|!
name|p_qos_policy
operator|||
operator|!
name|p_qos_match_rule
operator|||
operator|!
name|p_prtn
condition|)
return|return;
if|if
condition|(
operator|!
name|p_qos_match_rule
operator|->
name|p_qos_level
operator|->
name|sl_set
operator|||
name|p_prtn
operator|->
name|sl
operator|==
name|p_qos_match_rule
operator|->
name|p_qos_level
operator|->
name|sl
condition|)
return|return;
name|OSM_LOG
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|p_subn
operator|->
name|p_osm
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"QoS Level SL (%u) for Pkey 0x%04X in match rule "
literal|"differs from  partition SL (%u)\n"
argument_list|,
name|p_qos_match_rule
operator|->
name|p_qos_level
operator|->
name|sl
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_prtn
operator|->
name|pkey
argument_list|)
argument_list|,
name|p_prtn
operator|->
name|sl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|int
name|osm_qos_policy_validate
parameter_list|(
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|,
name|osm_log_t
modifier|*
name|p_log
parameter_list|)
block|{
name|cl_list_iterator_t
name|match_rules_list_iterator
decl_stmt|;
name|cl_list_iterator_t
name|list_iterator
decl_stmt|;
name|osm_qos_port_group_t
modifier|*
name|p_port_group
init|=
name|NULL
decl_stmt|;
name|osm_qos_match_rule_t
modifier|*
name|p_qos_match_rule
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|res
init|=
literal|0
decl_stmt|;
name|uint64_t
name|pkey_64
decl_stmt|;
name|ib_net16_t
name|pkey
decl_stmt|;
name|osm_prtn_t
modifier|*
name|p_prtn
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
comment|/* set default qos level */
name|p_qos_policy
operator|->
name|p_default_qos_level
operator|=
name|__qos_policy_get_qos_level_by_name
argument_list|(
name|p_qos_policy
argument_list|,
name|OSM_QOS_POLICY_DEFAULT_LEVEL_NAME
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_qos_policy
operator|->
name|p_default_qos_level
condition|)
block|{
comment|/* There's no default QoS level in the usual qos-level section. 		   Check whether the 'simple' default QoS level that can be 		   defined in the qos-ulp section exists */
if|if
condition|(
name|__default_simple_qos_level
operator|.
name|sl_set
condition|)
block|{
name|p_qos_policy
operator|->
name|p_default_qos_level
operator|=
operator|&
name|__default_simple_qos_level
expr_stmt|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR AC10: "
literal|"Default qos-level (%s) not defined.\n"
argument_list|,
name|OSM_QOS_POLICY_DEFAULT_LEVEL_NAME
argument_list|)
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
comment|/* scan all the match rules, and fill the lists of pointers to 	   relevant qos levels and port groups to speed up PR matching */
name|i
operator|=
literal|1
expr_stmt|;
name|match_rules_list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
expr_stmt|;
while|while
condition|(
name|match_rules_list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|qos_match_rules
argument_list|)
condition|)
block|{
name|p_qos_match_rule
operator|=
operator|(
name|osm_qos_match_rule_t
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|match_rules_list_iterator
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|p_qos_match_rule
argument_list|)
expr_stmt|;
comment|/* find the matching qos-level for each match-rule */
if|if
condition|(
operator|!
name|p_qos_match_rule
operator|->
name|p_qos_level
condition|)
name|p_qos_match_rule
operator|->
name|p_qos_level
operator|=
name|__qos_policy_get_qos_level_by_name
argument_list|(
name|p_qos_policy
argument_list|,
name|p_qos_match_rule
operator|->
name|qos_level_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_qos_match_rule
operator|->
name|p_qos_level
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR AC11: "
literal|"qos-match-rule num %u: qos-level '%s' not found\n"
argument_list|,
name|i
argument_list|,
name|p_qos_match_rule
operator|->
name|qos_level_name
argument_list|)
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* find the matching port-group for element of source_list */
if|if
condition|(
name|cl_list_count
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|source_list
argument_list|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|source_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|source_list
argument_list|)
condition|)
block|{
name|str
operator|=
operator|(
name|char
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|p_port_group
operator|=
name|__qos_policy_get_port_group_by_name
argument_list|(
name|p_qos_policy
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_port_group
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR AC12: "
literal|"qos-match-rule num %u: source port-group '%s' not found\n"
argument_list|,
name|i
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|cl_list_insert_tail
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|source_group_list
argument_list|,
name|p_port_group
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* find the matching port-group for element of destination_list */
if|if
condition|(
name|cl_list_count
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|destination_list
argument_list|)
condition|)
block|{
name|list_iterator
operator|=
name|cl_list_head
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|destination_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|list_iterator
operator|!=
name|cl_list_end
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|destination_list
argument_list|)
condition|)
block|{
name|str
operator|=
operator|(
name|char
operator|*
operator|)
name|cl_list_obj
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
name|CL_ASSERT
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|p_port_group
operator|=
name|__qos_policy_get_port_group_by_name
argument_list|(
name|p_qos_policy
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_port_group
condition|)
block|{
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR AC13: "
literal|"qos-match-rule num %u: destination port-group '%s' not found\n"
argument_list|,
name|i
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|cl_list_insert_tail
argument_list|(
operator|&
name|p_qos_match_rule
operator|->
name|destination_group_list
argument_list|,
name|p_port_group
argument_list|)
expr_stmt|;
name|list_iterator
operator|=
name|cl_list_next
argument_list|(
name|list_iterator
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 		 * Scan all the pkeys in matching rule, and if the 		 * partition for these pkeys exists, set the SL 		 * according to the QoS Level. 		 * Warn if there's mismatch between QoS level SL 		 * and Partition SL. 		 */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|p_qos_match_rule
operator|->
name|pkey_range_len
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|pkey_64
operator|=
name|p_qos_match_rule
operator|->
name|pkey_range_arr
index|[
name|j
index|]
index|[
literal|0
index|]
init|;
name|pkey_64
operator|<=
name|p_qos_match_rule
operator|->
name|pkey_range_arr
index|[
name|j
index|]
index|[
literal|1
index|]
condition|;
name|pkey_64
operator|++
control|)
block|{
name|pkey
operator|=
name|cl_hton16
argument_list|(
call|(
name|uint16_t
call|)
argument_list|(
name|pkey_64
operator|&
literal|0x7fff
argument_list|)
argument_list|)
expr_stmt|;
name|p_prtn
operator|=
operator|(
name|osm_prtn_t
operator|*
operator|)
name|cl_qmap_get
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|p_subn
operator|->
name|prtn_pkey_tbl
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_prtn
operator|==
operator|(
name|osm_prtn_t
operator|*
operator|)
name|cl_qmap_end
argument_list|(
operator|&
name|p_qos_policy
operator|->
name|p_subn
operator|->
name|prtn_pkey_tbl
argument_list|)
condition|)
comment|/* partition for this pkey not found */
name|OSM_LOG
argument_list|(
name|p_log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR AC14: "
literal|"pkey 0x%04X in match rule - "
literal|"partition doesn't exist\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|pkey
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|__qos_policy_validate_pkey
argument_list|(
name|p_qos_policy
argument_list|,
name|p_qos_match_rule
argument_list|,
name|p_prtn
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* done with the current match-rule */
name|match_rules_list_iterator
operator|=
name|cl_list_next
argument_list|(
name|match_rules_list_iterator
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/* osm_qos_policy_validate() */
end_comment

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
specifier|static
name|osm_qos_level_t
modifier|*
name|__qos_policy_get_qos_level_by_params
parameter_list|(
name|IN
specifier|const
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|,
name|IN
specifier|const
name|osm_physp_t
modifier|*
name|p_src_physp
parameter_list|,
name|IN
specifier|const
name|osm_physp_t
modifier|*
name|p_dest_physp
parameter_list|,
name|IN
name|uint64_t
name|service_id
parameter_list|,
name|IN
name|uint16_t
name|qos_class
parameter_list|,
name|IN
name|uint16_t
name|pkey
parameter_list|,
name|IN
name|ib_net64_t
name|comp_mask
parameter_list|)
block|{
name|osm_qos_match_rule_t
modifier|*
name|p_qos_match_rule
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|p_qos_policy
condition|)
return|return
name|NULL
return|;
name|p_qos_match_rule
operator|=
name|__qos_policy_get_match_rule_by_params
argument_list|(
name|p_qos_policy
argument_list|,
name|service_id
argument_list|,
name|qos_class
argument_list|,
name|pkey
argument_list|,
name|p_src_physp
argument_list|,
name|p_dest_physp
argument_list|,
name|comp_mask
argument_list|)
expr_stmt|;
return|return
name|p_qos_match_rule
condition|?
name|p_qos_match_rule
operator|->
name|p_qos_level
else|:
name|p_qos_policy
operator|->
name|p_default_qos_level
return|;
block|}
end_function

begin_comment
comment|/* __qos_policy_get_qos_level_by_params() */
end_comment

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|osm_qos_level_t
modifier|*
name|osm_qos_policy_get_qos_level_by_pr
parameter_list|(
name|IN
specifier|const
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|,
name|IN
specifier|const
name|ib_path_rec_t
modifier|*
name|p_pr
parameter_list|,
name|IN
specifier|const
name|osm_physp_t
modifier|*
name|p_src_physp
parameter_list|,
name|IN
specifier|const
name|osm_physp_t
modifier|*
name|p_dest_physp
parameter_list|,
name|IN
name|ib_net64_t
name|comp_mask
parameter_list|)
block|{
return|return
name|__qos_policy_get_qos_level_by_params
argument_list|(
name|p_qos_policy
argument_list|,
name|p_src_physp
argument_list|,
name|p_dest_physp
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_pr
operator|->
name|service_id
argument_list|)
argument_list|,
name|ib_path_rec_qos_class
argument_list|(
name|p_pr
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pr
operator|->
name|pkey
argument_list|)
argument_list|,
name|comp_mask
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

begin_function
name|osm_qos_level_t
modifier|*
name|osm_qos_policy_get_qos_level_by_mpr
parameter_list|(
name|IN
specifier|const
name|osm_qos_policy_t
modifier|*
name|p_qos_policy
parameter_list|,
name|IN
specifier|const
name|ib_multipath_rec_t
modifier|*
name|p_mpr
parameter_list|,
name|IN
specifier|const
name|osm_physp_t
modifier|*
name|p_src_physp
parameter_list|,
name|IN
specifier|const
name|osm_physp_t
modifier|*
name|p_dest_physp
parameter_list|,
name|IN
name|ib_net64_t
name|comp_mask
parameter_list|)
block|{
name|ib_net64_t
name|pr_comp_mask
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|p_qos_policy
condition|)
return|return
name|NULL
return|;
comment|/* 	 * Converting MultiPathRecord compmask to the PathRecord 	 * compmask. Note that only relevant bits are set. 	 */
name|pr_comp_mask
operator|=
operator|(
operator|(
name|comp_mask
operator|&
name|IB_MPR_COMPMASK_QOS_CLASS
operator|)
condition|?
name|IB_PR_COMPMASK_QOS_CLASS
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|comp_mask
operator|&
name|IB_MPR_COMPMASK_PKEY
operator|)
condition|?
name|IB_PR_COMPMASK_PKEY
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|comp_mask
operator|&
name|IB_MPR_COMPMASK_SERVICEID_MSB
operator|)
condition|?
name|IB_PR_COMPMASK_SERVICEID_MSB
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|comp_mask
operator|&
name|IB_MPR_COMPMASK_SERVICEID_LSB
operator|)
condition|?
name|IB_PR_COMPMASK_SERVICEID_LSB
else|:
literal|0
operator|)
expr_stmt|;
return|return
name|__qos_policy_get_qos_level_by_params
argument_list|(
name|p_qos_policy
argument_list|,
name|p_src_physp
argument_list|,
name|p_dest_physp
argument_list|,
name|cl_ntoh64
argument_list|(
name|ib_multipath_rec_service_id
argument_list|(
name|p_mpr
argument_list|)
argument_list|)
argument_list|,
name|ib_multipath_rec_qos_class
argument_list|(
name|p_mpr
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mpr
operator|->
name|pkey
argument_list|)
argument_list|,
name|pr_comp_mask
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/***************************************************  ***************************************************/
end_comment

end_unit


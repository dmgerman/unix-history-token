begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2010 Lawrence Livermore National Lab.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/mad.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/ibnetdisc.h>
end_include

begin_include
include|#
directive|include
file|"ibdiag_common.h"
end_include

begin_decl_stmt
name|uint64_t
name|switchguid_before
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|switchguid_after
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|switchguid_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|caguid_before
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|caguid_after
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|caguid_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|sysimgguid_before
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|sysimgguid_after
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|sysimgguid_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|portguid_nodeguid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|portguid_before
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|portguid_after
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|portguid_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|guids
block|{
name|uint64_t
name|searchguid
decl_stmt|;
name|int
name|searchguid_found
decl_stmt|;
name|uint64_t
name|before
decl_stmt|;
name|uint64_t
name|after
decl_stmt|;
name|int
name|found
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|parse_beforeafter
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|,
name|uint64_t
modifier|*
name|before
parameter_list|,
name|uint64_t
modifier|*
name|after
parameter_list|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|before_str
decl_stmt|;
name|char
modifier|*
name|after_str
decl_stmt|;
name|ptr
operator|=
name|strchr
argument_list|(
name|optarg
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptr
operator|||
operator|!
operator|(
operator|*
operator|(
name|ptr
operator|+
literal|1
operator|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid input '%s'\n"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|ptr
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|before_str
operator|=
name|arg
expr_stmt|;
name|after_str
operator|=
name|ptr
operator|+
literal|1
expr_stmt|;
operator|(
operator|*
name|before
operator|)
operator|=
name|strtoull
argument_list|(
name|before_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|*
name|after
operator|)
operator|=
name|strtoull
argument_list|(
name|after_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_guidbeforeafter
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|,
name|uint64_t
modifier|*
name|guid
parameter_list|,
name|uint64_t
modifier|*
name|before
parameter_list|,
name|uint64_t
modifier|*
name|after
parameter_list|)
block|{
name|char
modifier|*
name|ptr1
decl_stmt|;
name|char
modifier|*
name|ptr2
decl_stmt|;
name|char
modifier|*
name|guid_str
decl_stmt|;
name|char
modifier|*
name|before_str
decl_stmt|;
name|char
modifier|*
name|after_str
decl_stmt|;
name|ptr1
operator|=
name|strchr
argument_list|(
name|optarg
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptr1
operator|||
operator|!
operator|(
operator|*
operator|(
name|ptr1
operator|+
literal|1
operator|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid input '%s'\n"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|guid_str
operator|=
name|arg
expr_stmt|;
name|before_str
operator|=
name|ptr1
operator|+
literal|1
expr_stmt|;
name|ptr2
operator|=
name|strchr
argument_list|(
name|before_str
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptr2
operator|||
operator|!
operator|(
operator|*
operator|(
name|ptr2
operator|+
literal|1
operator|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid input '%s'\n"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|ptr1
operator|)
operator|=
literal|'\0'
expr_stmt|;
operator|(
operator|*
name|ptr2
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|after_str
operator|=
name|ptr2
operator|+
literal|1
expr_stmt|;
operator|(
operator|*
name|guid
operator|)
operator|=
name|strtoull
argument_list|(
name|guid_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|*
name|before
operator|)
operator|=
name|strtoull
argument_list|(
name|before_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|*
name|after
operator|)
operator|=
name|strtoull
argument_list|(
name|after_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_opt
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|ch
parameter_list|,
name|char
modifier|*
name|optarg
parameter_list|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|parse_beforeafter
argument_list|(
name|optarg
argument_list|,
operator|&
name|switchguid_before
argument_list|,
operator|&
name|switchguid_after
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|switchguid_flag
operator|++
expr_stmt|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|parse_beforeafter
argument_list|(
name|optarg
argument_list|,
operator|&
name|caguid_before
argument_list|,
operator|&
name|caguid_after
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|caguid_flag
operator|++
expr_stmt|;
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|parse_beforeafter
argument_list|(
name|optarg
argument_list|,
operator|&
name|sysimgguid_before
argument_list|,
operator|&
name|sysimgguid_after
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|sysimgguid_flag
operator|++
expr_stmt|;
break|break;
case|case
literal|4
case|:
if|if
condition|(
name|parse_guidbeforeafter
argument_list|(
name|optarg
argument_list|,
operator|&
name|portguid_nodeguid
argument_list|,
operator|&
name|portguid_before
argument_list|,
operator|&
name|portguid_after
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|portguid_flag
operator|++
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_switchportguids
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|)
block|{
name|ibnd_port_t
modifier|*
name|port
decl_stmt|;
name|int
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
literal|0
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
name|port
condition|)
name|port
operator|->
name|guid
operator|=
name|node
operator|->
name|guid
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|replace_node_guid
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|guids
modifier|*
name|guids
decl_stmt|;
name|guids
operator|=
operator|(
expr|struct
name|guids
operator|*
operator|)
name|user_data
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|guid
operator|==
name|guids
operator|->
name|before
condition|)
block|{
name|node
operator|->
name|guid
operator|=
name|guids
operator|->
name|after
expr_stmt|;
comment|/* port guids are identical to switch guids on 		 * switches, so update port guids too 		 */
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
name|update_switchportguids
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|guids
operator|->
name|found
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|replace_sysimgguid
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|guids
modifier|*
name|guids
decl_stmt|;
name|uint64_t
name|sysimgguid
decl_stmt|;
name|guids
operator|=
operator|(
expr|struct
name|guids
operator|*
operator|)
name|user_data
expr_stmt|;
name|sysimgguid
operator|=
name|mad_get_field64
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_SYSTEM_GUID_F
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysimgguid
operator|==
name|guids
operator|->
name|before
condition|)
block|{
name|mad_set_field64
argument_list|(
name|node
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_NODE_SYSTEM_GUID_F
argument_list|,
name|guids
operator|->
name|after
argument_list|)
expr_stmt|;
name|guids
operator|->
name|found
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|replace_portguid
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|guids
modifier|*
name|guids
decl_stmt|;
name|guids
operator|=
operator|(
expr|struct
name|guids
operator|*
operator|)
name|user_data
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|guid
operator|!=
name|guids
operator|->
name|searchguid
condition|)
return|return;
name|guids
operator|->
name|searchguid_found
operator|++
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
block|{
comment|/* port guids are identical to switch guids on 		 * switches, so update switch guid too 		 */
if|if
condition|(
name|node
operator|->
name|guid
operator|==
name|guids
operator|->
name|before
condition|)
block|{
name|node
operator|->
name|guid
operator|=
name|guids
operator|->
name|after
expr_stmt|;
name|update_switchportguids
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|guids
operator|->
name|found
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|ibnd_port_t
modifier|*
name|port
decl_stmt|;
name|int
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
name|port
operator|=
name|node
operator|->
name|ports
index|[
name|p
index|]
expr_stmt|;
if|if
condition|(
name|port
operator|&&
name|port
operator|->
name|guid
operator|==
name|guids
operator|->
name|before
condition|)
block|{
name|port
operator|->
name|guid
operator|=
name|guids
operator|->
name|after
expr_stmt|;
name|guids
operator|->
name|found
operator|++
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|ibnd_fabric_t
modifier|*
name|fabric
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|orig_cache_file
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|new_cache_file
init|=
name|NULL
decl_stmt|;
name|struct
name|guids
name|guids
decl_stmt|;
specifier|const
name|struct
name|ibdiag_opt
name|opts
index|[]
init|=
block|{
block|{
literal|"switchguid"
block|,
literal|1
block|,
literal|1
block|,
literal|"BEFOREGUID:AFTERGUID"
block|,
literal|"Specify before and after switchguid to edit"
block|}
block|,
block|{
literal|"caguid"
block|,
literal|2
block|,
literal|1
block|,
literal|"BEFOREGUID:AFTERGUID"
block|,
literal|"Specify before and after caguid to edit"
block|}
block|,
block|{
literal|"sysimgguid"
block|,
literal|3
block|,
literal|1
block|,
literal|"BEFOREGUID:AFTERGUID"
block|,
literal|"Specify before and after sysimgguid to edit"
block|}
block|,
block|{
literal|"portguid"
block|,
literal|4
block|,
literal|1
block|,
literal|"NODEGUID:BEFOREGUID:AFTERGUID"
block|,
literal|"Specify before and after port guid to edit"
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
name|char
modifier|*
name|usage_args
init|=
literal|"<orig.cache><new.cache>"
decl_stmt|;
name|ibdiag_process_opts
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|NULL
argument_list|,
literal|"CDdeGKLPstvy"
argument_list|,
name|opts
argument_list|,
name|process_opt
argument_list|,
name|usage_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
name|orig_cache_file
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|new_cache_file
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|orig_cache_file
condition|)
name|IBEXIT
argument_list|(
literal|"original cache file not specified"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_cache_file
condition|)
name|IBEXIT
argument_list|(
literal|"new cache file not specified"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fabric
operator|=
name|ibnd_load_fabric
argument_list|(
name|orig_cache_file
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|IBEXIT
argument_list|(
literal|"loading original cached fabric failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|switchguid_flag
condition|)
block|{
name|guids
operator|.
name|before
operator|=
name|switchguid_before
expr_stmt|;
name|guids
operator|.
name|after
operator|=
name|switchguid_after
expr_stmt|;
name|guids
operator|.
name|found
operator|=
literal|0
expr_stmt|;
name|ibnd_iter_nodes_type
argument_list|(
name|fabric
argument_list|,
name|replace_node_guid
argument_list|,
name|IB_NODE_SWITCH
argument_list|,
operator|&
name|guids
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|guids
operator|.
name|found
condition|)
name|IBEXIT
argument_list|(
literal|"switchguid = %"
name|PRIx64
literal|" not found"
argument_list|,
name|switchguid_before
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|caguid_flag
condition|)
block|{
name|guids
operator|.
name|before
operator|=
name|caguid_before
expr_stmt|;
name|guids
operator|.
name|after
operator|=
name|caguid_after
expr_stmt|;
name|guids
operator|.
name|found
operator|=
literal|0
expr_stmt|;
name|ibnd_iter_nodes_type
argument_list|(
name|fabric
argument_list|,
name|replace_node_guid
argument_list|,
name|IB_NODE_CA
argument_list|,
operator|&
name|guids
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|guids
operator|.
name|found
condition|)
name|IBEXIT
argument_list|(
literal|"caguid = %"
name|PRIx64
literal|" not found"
argument_list|,
name|caguid_before
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sysimgguid_flag
condition|)
block|{
name|guids
operator|.
name|before
operator|=
name|sysimgguid_before
expr_stmt|;
name|guids
operator|.
name|after
operator|=
name|sysimgguid_after
expr_stmt|;
name|guids
operator|.
name|found
operator|=
literal|0
expr_stmt|;
name|ibnd_iter_nodes
argument_list|(
name|fabric
argument_list|,
name|replace_sysimgguid
argument_list|,
operator|&
name|guids
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|guids
operator|.
name|found
condition|)
name|IBEXIT
argument_list|(
literal|"sysimgguid = %"
name|PRIx64
literal|" not found"
argument_list|,
name|sysimgguid_before
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|portguid_flag
condition|)
block|{
name|guids
operator|.
name|searchguid
operator|=
name|portguid_nodeguid
expr_stmt|;
name|guids
operator|.
name|searchguid_found
operator|=
literal|0
expr_stmt|;
name|guids
operator|.
name|before
operator|=
name|portguid_before
expr_stmt|;
name|guids
operator|.
name|after
operator|=
name|portguid_after
expr_stmt|;
name|guids
operator|.
name|found
operator|=
literal|0
expr_stmt|;
name|ibnd_iter_nodes
argument_list|(
name|fabric
argument_list|,
name|replace_portguid
argument_list|,
operator|&
name|guids
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|guids
operator|.
name|searchguid_found
condition|)
name|IBEXIT
argument_list|(
literal|"nodeguid = %"
name|PRIx64
literal|" not found"
argument_list|,
name|portguid_nodeguid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|guids
operator|.
name|found
condition|)
name|IBEXIT
argument_list|(
literal|"portguid = %"
name|PRIx64
literal|" not found"
argument_list|,
name|portguid_before
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ibnd_cache_fabric
argument_list|(
name|fabric
argument_list|,
name|new_cache_file
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|IBEXIT
argument_list|(
literal|"caching new cache data failed"
argument_list|)
expr_stmt|;
name|ibnd_destroy_fabric
argument_list|(
name|fabric
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


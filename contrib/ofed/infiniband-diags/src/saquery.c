begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006,2007 The Regents of the University of California.  * Copyright (c) 2004-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2013 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2013 Intel Corporation. All rights reserved.  * Copyright (c) 2009 HNR Consulting. All rights reserved.  *  * Produced at Lawrence Livermore National Laboratory.  * Written by Ira Weiny<weiny2@llnl.gov>.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/umad.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/mad.h>
end_include

begin_include
include|#
directive|include
file|<iba/ib_types.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_nodenamemap.h>
end_include

begin_include
include|#
directive|include
file|"ibdiag_common.h"
end_include

begin_include
include|#
directive|include
file|"ibdiag_sa.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|IB_PR_COMPMASK_SERVICEID
end_ifndef

begin_define
define|#
directive|define
name|IB_PR_COMPMASK_SERVICEID
value|(IB_PR_COMPMASK_SERVICEID_MSB | \ 				  IB_PR_COMPMASK_SERVICEID_LSB)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|UMAD_SA_CAP_MASK2_IS_MCAST_TOP_SUP
value|(1<< 3)
end_define

begin_struct
struct|struct
name|query_params
block|{
name|uint64_t
name|service_id
decl_stmt|;
name|ib_gid_t
name|sgid
decl_stmt|,
name|dgid
decl_stmt|,
name|gid
decl_stmt|,
name|mgid
decl_stmt|;
name|uint16_t
name|slid
decl_stmt|,
name|dlid
decl_stmt|,
name|mlid
decl_stmt|;
name|uint32_t
name|flow_label
decl_stmt|;
name|int
name|hop_limit
decl_stmt|;
name|uint8_t
name|tclass
decl_stmt|;
name|int
name|reversible
decl_stmt|,
name|numb_path
decl_stmt|;
name|uint16_t
name|pkey
decl_stmt|;
name|int
name|qos_class
decl_stmt|,
name|sl
decl_stmt|;
name|uint8_t
name|mtu
decl_stmt|,
name|rate
decl_stmt|,
name|pkt_life
decl_stmt|;
name|uint32_t
name|qkey
decl_stmt|;
name|uint8_t
name|scope
decl_stmt|;
name|uint8_t
name|join_state
decl_stmt|;
name|int
name|proxy_join
decl_stmt|;
name|ib_class_port_info_t
name|cpi
decl_stmt|;
name|uint8_t
name|with_grh
decl_stmt|;
name|ibmad_gid_t
name|sa_dgid
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|query_cmd
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|alias
decl_stmt|;
name|uint16_t
name|query_type
decl_stmt|;
specifier|const
name|char
modifier|*
name|usage
decl_stmt|;
name|int
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|char
modifier|*
name|node_name_map_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|nn_map_t
modifier|*
name|node_name_map
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * Declare some globals because I don't want this to be too complex.  */
end_comment

begin_define
define|#
directive|define
name|MAX_PORTS
value|(8)
end_define

begin_define
define|#
directive|define
name|DEFAULT_SA_TIMEOUT_MS
value|(1000)
end_define

begin_enum
enum|enum
block|{
name|ALL
block|,
name|LID_ONLY
block|,
name|UNIQUE_LID_ONLY
block|,
name|GUID_ONLY
block|,
name|ALL_DESC
block|,
name|NAME_OF_LID
block|,
name|NAME_OF_GUID
block|, }
name|node_print_desc
init|=
name|ALL
enum|;
end_enum

begin_decl_stmt
name|char
modifier|*
name|requested_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint16_t
name|requested_lid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|requested_lid_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|requested_guid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|requested_guid_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|unsigned
name|valid_gid
parameter_list|(
name|ib_gid_t
modifier|*
name|gid
parameter_list|)
block|{
name|ib_gid_t
name|zero_gid
decl_stmt|;
name|memset
argument_list|(
operator|&
name|zero_gid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|zero_gid
argument_list|)
expr_stmt|;
return|return
name|memcmp
argument_list|(
operator|&
name|zero_gid
argument_list|,
name|gid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|gid
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_node_desc
parameter_list|(
name|ib_node_record_t
modifier|*
name|node_record
parameter_list|)
block|{
name|ib_node_info_t
modifier|*
name|p_ni
init|=
operator|&
operator|(
name|node_record
operator|->
name|node_info
operator|)
decl_stmt|;
name|ib_node_desc_t
modifier|*
name|p_nd
init|=
operator|&
operator|(
name|node_record
operator|->
name|node_desc
operator|)
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|p_ni
operator|->
name|node_type
operator|==
name|IB_NODE_TYPE_CA
condition|)
block|{
name|name
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|node_record
operator|->
name|node_info
operator|.
name|node_guid
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p_nd
operator|->
name|description
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%6d  \"%s\"\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|lid
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_node_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_node_record_t
modifier|*
name|nr
init|=
name|data
decl_stmt|;
name|ib_node_info_t
modifier|*
name|ni
init|=
operator|&
name|nr
operator|->
name|node_info
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|cl_ntoh64
argument_list|(
name|ni
operator|->
name|node_guid
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|nr
operator|->
name|node_desc
operator|.
name|description
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"NodeRecord dump:\n"
literal|"\t\tlid.....................%u\n"
literal|"\t\treserved................0x%X\n"
literal|"\t\tbase_version............0x%X\n"
literal|"\t\tclass_version...........0x%X\n"
literal|"\t\tnode_type...............%s\n"
literal|"\t\tnum_ports...............%u\n"
literal|"\t\tsys_guid................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tnode_guid...............0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tport_guid...............0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tpartition_cap...........0x%X\n"
literal|"\t\tdevice_id...............0x%X\n"
literal|"\t\trevision................0x%X\n"
literal|"\t\tport_num................%u\n"
literal|"\t\tvendor_id...............0x%X\n"
literal|"\t\tNodeDescription.........%s\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|nr
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|nr
operator|->
name|resv
argument_list|)
argument_list|,
name|ni
operator|->
name|base_version
argument_list|,
name|ni
operator|->
name|class_version
argument_list|,
name|ib_get_node_type_str
argument_list|(
name|ni
operator|->
name|node_type
argument_list|)
argument_list|,
name|ni
operator|->
name|num_ports
argument_list|,
name|cl_ntoh64
argument_list|(
name|ni
operator|->
name|sys_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|ni
operator|->
name|node_guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|ni
operator|->
name|port_guid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|ni
operator|->
name|partition_cap
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|ni
operator|->
name|device_id
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|ni
operator|->
name|revision
argument_list|)
argument_list|,
name|ib_node_info_get_local_port_num
argument_list|(
name|ni
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_node_info_get_vendor_id
argument_list|(
name|ni
argument_list|)
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_node_record
parameter_list|(
name|ib_node_record_t
modifier|*
name|node_record
parameter_list|)
block|{
name|ib_node_info_t
modifier|*
name|p_ni
init|=
operator|&
name|node_record
operator|->
name|node_info
decl_stmt|;
name|ib_node_desc_t
modifier|*
name|p_nd
init|=
operator|&
name|node_record
operator|->
name|node_desc
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
switch|switch
condition|(
name|node_print_desc
condition|)
block|{
case|case
name|LID_ONLY
case|:
case|case
name|UNIQUE_LID_ONLY
case|:
name|printf
argument_list|(
literal|"%u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|lid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
case|case
name|GUID_ONLY
case|:
name|printf
argument_list|(
literal|"0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|port_guid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
case|case
name|NAME_OF_LID
case|:
case|case
name|NAME_OF_GUID
case|:
name|name
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|node_guid
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p_nd
operator|->
name|description
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return;
case|case
name|ALL
case|:
default|default:
break|break;
block|}
name|dump_node_record
argument_list|(
name|node_record
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_path_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|gid_str2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_path_rec_t
modifier|*
name|p_pr
init|=
name|data
decl_stmt|;
name|printf
argument_list|(
literal|"PathRecord dump:\n"
literal|"\t\tservice_id..............0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tdgid....................%s\n"
literal|"\t\tsgid....................%s\n"
literal|"\t\tdlid....................%u\n"
literal|"\t\tslid....................%u\n"
literal|"\t\thop_flow_raw............0x%X\n"
literal|"\t\ttclass..................0x%X\n"
literal|"\t\tnum_path_revers.........0x%X\n"
literal|"\t\tpkey....................0x%X\n"
literal|"\t\tqos_class...............0x%X\n"
literal|"\t\tsl......................0x%X\n"
literal|"\t\tmtu.....................0x%X\n"
literal|"\t\trate....................0x%X\n"
literal|"\t\tpkt_life................0x%X\n"
literal|"\t\tpreference..............0x%X\n"
literal|"\t\tresv2...................0x%02X%02X%02X%02X%02X%02X\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_pr
operator|->
name|service_id
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_pr
operator|->
name|dgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_pr
operator|->
name|sgid
operator|.
name|raw
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pr
operator|->
name|dlid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pr
operator|->
name|slid
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_pr
operator|->
name|hop_flow_raw
argument_list|)
argument_list|,
name|p_pr
operator|->
name|tclass
argument_list|,
name|p_pr
operator|->
name|num_path
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pr
operator|->
name|pkey
argument_list|)
argument_list|,
name|ib_path_rec_qos_class
argument_list|(
name|p_pr
argument_list|)
argument_list|,
name|ib_path_rec_sl
argument_list|(
name|p_pr
argument_list|)
argument_list|,
name|p_pr
operator|->
name|mtu
argument_list|,
name|p_pr
operator|->
name|rate
argument_list|,
name|p_pr
operator|->
name|pkt_life
argument_list|,
name|p_pr
operator|->
name|preference
argument_list|,
name|p_pr
operator|->
name|resv2
index|[
literal|0
index|]
argument_list|,
name|p_pr
operator|->
name|resv2
index|[
literal|1
index|]
argument_list|,
name|p_pr
operator|->
name|resv2
index|[
literal|2
index|]
argument_list|,
name|p_pr
operator|->
name|resv2
index|[
literal|3
index|]
argument_list|,
name|p_pr
operator|->
name|resv2
index|[
literal|4
index|]
argument_list|,
name|p_pr
operator|->
name|resv2
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_class_port_info
parameter_list|(
name|ib_class_port_info_t
modifier|*
name|cpi
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|gid_str2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"SA ClassPortInfo:\n"
literal|"\t\tBase version.............%d\n"
literal|"\t\tClass version............%d\n"
literal|"\t\tCapability mask..........0x%04X\n"
literal|"\t\tCapability mask 2........0x%08X\n"
literal|"\t\tResponse time value......0x%02X\n"
literal|"\t\tRedirect GID.............%s\n"
literal|"\t\tRedirect TC/SL/FL........0x%08X\n"
literal|"\t\tRedirect LID.............%u\n"
literal|"\t\tRedirect PKey............0x%04X\n"
literal|"\t\tRedirect QP..............0x%08X\n"
literal|"\t\tRedirect QKey............0x%08X\n"
literal|"\t\tTrap GID.................%s\n"
literal|"\t\tTrap TC/SL/FL............0x%08X\n"
literal|"\t\tTrap LID.................%u\n"
literal|"\t\tTrap PKey................0x%04X\n"
literal|"\t\tTrap HL/QP...............0x%08X\n"
literal|"\t\tTrap QKey................0x%08X\n"
argument_list|,
name|cpi
operator|->
name|base_ver
argument_list|,
name|cpi
operator|->
name|class_ver
argument_list|,
name|cl_ntoh16
argument_list|(
name|cpi
operator|->
name|cap_mask
argument_list|)
argument_list|,
name|ib_class_cap_mask2
argument_list|(
name|cpi
argument_list|)
argument_list|,
name|ib_class_resp_time_val
argument_list|(
name|cpi
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
operator|(
name|cpi
operator|->
name|redir_gid
operator|)
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|cpi
operator|->
name|redir_tc_sl_fl
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|cpi
operator|->
name|redir_lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|cpi
operator|->
name|redir_pkey
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|cpi
operator|->
name|redir_qp
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|cpi
operator|->
name|redir_qkey
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
operator|&
operator|(
name|cpi
operator|->
name|trap_gid
operator|)
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|cpi
operator|->
name|trap_tc_sl_fl
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|cpi
operator|->
name|trap_lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|cpi
operator|->
name|trap_pkey
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|cpi
operator|->
name|trap_hop_qp
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|cpi
operator|->
name|trap_qkey
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_portinfo_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_portinfo_record_t
modifier|*
name|p_pir
init|=
name|data
decl_stmt|;
specifier|const
name|ib_port_info_t
modifier|*
specifier|const
name|p_pi
init|=
operator|&
name|p_pir
operator|->
name|port_info
decl_stmt|;
name|printf
argument_list|(
literal|"PortInfoRecord dump:\n"
literal|"\t\tEndPortLid..............%u\n"
literal|"\t\tPortNum.................%u\n"
literal|"\t\tbase_lid................%u\n"
literal|"\t\tmaster_sm_base_lid......%u\n"
literal|"\t\tcapability_mask.........0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pir
operator|->
name|lid
argument_list|)
argument_list|,
name|p_pir
operator|->
name|port_num
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pi
operator|->
name|base_lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_pi
operator|->
name|master_sm_base_lid
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_pi
operator|->
name|capability_mask
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_portinfo_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_portinfo_record_t
modifier|*
name|pir
init|=
name|data
decl_stmt|;
name|ib_port_info_t
modifier|*
name|pi
init|=
operator|&
name|pir
operator|->
name|port_info
decl_stmt|;
name|printf
argument_list|(
literal|"PortInfoRecord dump:\n"
literal|"\tRID\n"
literal|"\t\tEndPortLid..............%u\n"
literal|"\t\tPortNum.................%u\n"
literal|"\t\tOptions.................0x%x\n"
literal|"\tPortInfo dump:\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|pir
operator|->
name|lid
argument_list|)
argument_list|,
name|pir
operator|->
name|port_num
argument_list|,
name|pir
operator|->
name|options
argument_list|)
expr_stmt|;
name|dump_portinfo
argument_list|(
name|pi
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_mcmember_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|mgid
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|,
name|gid
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_member_rec_t
modifier|*
name|mr
init|=
name|data
decl_stmt|;
name|uint32_t
name|flow
decl_stmt|;
name|uint8_t
name|sl
decl_stmt|,
name|hop
decl_stmt|,
name|scope
decl_stmt|,
name|join
decl_stmt|;
name|ib_member_get_sl_flow_hop
argument_list|(
name|mr
operator|->
name|sl_flow_hop
argument_list|,
operator|&
name|sl
argument_list|,
operator|&
name|flow
argument_list|,
operator|&
name|hop
argument_list|)
expr_stmt|;
name|ib_member_get_scope_state
argument_list|(
name|mr
operator|->
name|scope_state
argument_list|,
operator|&
name|scope
argument_list|,
operator|&
name|join
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MCMember Record dump:\n"
literal|"\t\tMGID....................%s\n"
literal|"\t\tPortGid.................%s\n"
literal|"\t\tqkey....................0x%x\n"
literal|"\t\tmlid....................0x%x\n"
literal|"\t\tmtu.....................0x%x\n"
literal|"\t\tTClass..................0x%x\n"
literal|"\t\tpkey....................0x%x\n"
literal|"\t\trate....................0x%x\n"
literal|"\t\tpkt_life................0x%x\n"
literal|"\t\tSL......................0x%x\n"
literal|"\t\tFlowLabel...............0x%x\n"
literal|"\t\tHopLimit................0x%x\n"
literal|"\t\tScope...................0x%x\n"
literal|"\t\tJoinState...............0x%x\n"
literal|"\t\tProxyJoin...............0x%x\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mr
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|mgid
argument_list|,
sizeof|sizeof
argument_list|(
name|mgid
argument_list|)
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|mr
operator|->
name|port_gid
operator|.
name|raw
argument_list|,
name|gid
argument_list|,
sizeof|sizeof
argument_list|(
name|gid
argument_list|)
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|mr
operator|->
name|qkey
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|mr
operator|->
name|mlid
argument_list|)
argument_list|,
name|mr
operator|->
name|mtu
argument_list|,
name|mr
operator|->
name|tclass
argument_list|,
name|cl_ntoh16
argument_list|(
name|mr
operator|->
name|pkey
argument_list|)
argument_list|,
name|mr
operator|->
name|rate
argument_list|,
name|mr
operator|->
name|pkt_life
argument_list|,
name|sl
argument_list|,
name|flow
argument_list|,
name|hop
argument_list|,
name|scope
argument_list|,
name|join
argument_list|,
name|mr
operator|->
name|proxy_join
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_multicast_group_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_member_rec_t
modifier|*
name|p_mcmr
init|=
name|data
decl_stmt|;
name|uint8_t
name|sl
decl_stmt|;
name|ib_member_get_sl_flow_hop
argument_list|(
name|p_mcmr
operator|->
name|sl_flow_hop
argument_list|,
operator|&
name|sl
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MCMemberRecord group dump:\n"
literal|"\t\tMGID....................%s\n"
literal|"\t\tMlid....................0x%X\n"
literal|"\t\tMtu.....................0x%X\n"
literal|"\t\tpkey....................0x%X\n"
literal|"\t\tRate....................0x%X\n"
literal|"\t\tSL......................0x%X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mcmr
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mcmr
operator|->
name|mlid
argument_list|)
argument_list|,
name|p_mcmr
operator|->
name|mtu
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mcmr
operator|->
name|pkey
argument_list|)
argument_list|,
name|p_mcmr
operator|->
name|rate
argument_list|,
name|sl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_multicast_member_record
parameter_list|(
name|ib_member_rec_t
modifier|*
name|p_mcmr
parameter_list|,
name|struct
name|sa_query_result
modifier|*
name|nr_result
parameter_list|,
name|struct
name|query_params
modifier|*
name|params
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|gid_str2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|uint16_t
name|mlid
init|=
name|cl_ntoh16
argument_list|(
name|p_mcmr
operator|->
name|mlid
argument_list|)
decl_stmt|;
name|unsigned
name|i
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|node_name
init|=
name|strdup
argument_list|(
literal|"<unknown>"
argument_list|)
decl_stmt|;
comment|/* go through the node records searching for a port guid which matches 	 * this port gid interface id. 	 * This gives us a node name to print, if available. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr_result
operator|->
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|ib_node_record_t
modifier|*
name|nr
init|=
name|sa_get_query_rec
argument_list|(
name|nr_result
operator|->
name|p_result_madw
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|nr
operator|->
name|node_info
operator|.
name|port_guid
operator|==
name|p_mcmr
operator|->
name|port_gid
operator|.
name|unicast
operator|.
name|interface_id
condition|)
block|{
if|if
condition|(
name|node_name
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|node_name
argument_list|)
expr_stmt|;
name|node_name
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|nr
operator|->
name|node_info
operator|.
name|node_guid
argument_list|,
operator|(
name|char
operator|*
operator|)
name|nr
operator|->
name|node_desc
operator|.
name|description
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|requested_name
condition|)
block|{
if|if
condition|(
name|strtol
argument_list|(
name|requested_name
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|==
name|mlid
condition|)
name|printf
argument_list|(
literal|"\t\tPortGid.................%s (%s)\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mcmr
operator|->
name|port_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|node_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"MCMemberRecord member dump:\n"
literal|"\t\tMGID....................%s\n"
literal|"\t\tMlid....................0x%X\n"
literal|"\t\tPortGid.................%s\n"
literal|"\t\tScopeState..............0x%X\n"
literal|"\t\tProxyJoin...............0x%X\n"
literal|"\t\tNodeDescription.........%s\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mcmr
operator|->
name|mgid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_mcmr
operator|->
name|mlid
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_mcmr
operator|->
name|port_gid
operator|.
name|raw
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|p_mcmr
operator|->
name|scope_state
argument_list|,
name|p_mcmr
operator|->
name|proxy_join
argument_list|,
name|node_name
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|node_name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_service_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|gid
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|buf_service_key
index|[
literal|35
index|]
decl_stmt|;
name|char
name|buf_service_name
index|[
literal|65
index|]
decl_stmt|;
name|ib_service_record_t
modifier|*
name|p_sr
init|=
name|data
decl_stmt|;
name|sprintf
argument_list|(
name|buf_service_key
argument_list|,
literal|"0x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x"
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|0
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|1
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|2
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|3
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|4
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|5
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|6
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|7
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|8
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|9
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|10
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|11
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|12
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|13
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|14
index|]
argument_list|,
name|p_sr
operator|->
name|service_key
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|buf_service_name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p_sr
operator|->
name|service_name
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|buf_service_name
index|[
literal|64
index|]
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"ServiceRecord dump:\n"
literal|"\t\tServiceID...............0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tServiceGID..............%s\n"
literal|"\t\tServiceP_Key............0x%X\n"
literal|"\t\tServiceLease............0x%X\n"
literal|"\t\tServiceKey..............%s\n"
literal|"\t\tServiceName.............%s\n"
literal|"\t\tServiceData8.1..........0x%X\n"
literal|"\t\tServiceData8.2..........0x%X\n"
literal|"\t\tServiceData8.3..........0x%X\n"
literal|"\t\tServiceData8.4..........0x%X\n"
literal|"\t\tServiceData8.5..........0x%X\n"
literal|"\t\tServiceData8.6..........0x%X\n"
literal|"\t\tServiceData8.7..........0x%X\n"
literal|"\t\tServiceData8.8..........0x%X\n"
literal|"\t\tServiceData8.9..........0x%X\n"
literal|"\t\tServiceData8.10.........0x%X\n"
literal|"\t\tServiceData8.11.........0x%X\n"
literal|"\t\tServiceData8.12.........0x%X\n"
literal|"\t\tServiceData8.13.........0x%X\n"
literal|"\t\tServiceData8.14.........0x%X\n"
literal|"\t\tServiceData8.15.........0x%X\n"
literal|"\t\tServiceData8.16.........0x%X\n"
literal|"\t\tServiceData16.1.........0x%X\n"
literal|"\t\tServiceData16.2.........0x%X\n"
literal|"\t\tServiceData16.3.........0x%X\n"
literal|"\t\tServiceData16.4.........0x%X\n"
literal|"\t\tServiceData16.5.........0x%X\n"
literal|"\t\tServiceData16.6.........0x%X\n"
literal|"\t\tServiceData16.7.........0x%X\n"
literal|"\t\tServiceData16.8.........0x%X\n"
literal|"\t\tServiceData32.1.........0x%X\n"
literal|"\t\tServiceData32.2.........0x%X\n"
literal|"\t\tServiceData32.3.........0x%X\n"
literal|"\t\tServiceData32.4.........0x%X\n"
literal|"\t\tServiceData64.1.........0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tServiceData64.2.........0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_id
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_sr
operator|->
name|service_gid
operator|.
name|raw
argument_list|,
name|gid
argument_list|,
sizeof|sizeof
name|gid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_pkey
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_lease
argument_list|)
argument_list|,
operator|(
name|show_keys
condition|?
name|buf_service_key
else|:
name|NOT_DISPLAYED_STR
operator|)
argument_list|,
name|buf_service_name
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|0
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|1
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|2
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|3
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|4
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|5
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|6
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|7
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|8
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|9
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|10
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|11
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|12
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|13
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|14
index|]
argument_list|,
name|p_sr
operator|->
name|service_data8
index|[
literal|15
index|]
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sr
operator|->
name|service_data16
index|[
literal|7
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_sr
operator|->
name|service_data32
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_data64
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_sr
operator|->
name|service_data64
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_sm_info_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_sminfo_record_t
modifier|*
name|p_smr
init|=
name|data
decl_stmt|;
specifier|const
name|ib_sm_info_t
modifier|*
specifier|const
name|p_smi
init|=
operator|&
name|p_smr
operator|->
name|sm_info
decl_stmt|;
name|uint8_t
name|priority
decl_stmt|,
name|state
decl_stmt|;
name|priority
operator|=
name|ib_sminfo_get_priority
argument_list|(
name|p_smi
argument_list|)
expr_stmt|;
name|state
operator|=
name|ib_sminfo_get_state
argument_list|(
name|p_smi
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"SMInfoRecord dump:\n"
literal|"\t\tRID\n"
literal|"\t\tLID...................%u\n"
literal|"\t\tSMInfo dump:\n"
literal|"\t\tGUID..................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tSM_Key................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tActCount..............%u\n"
literal|"\t\tPriority..............%u\n"
literal|"\t\tSMState...............%u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_smr
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_smr
operator|->
name|sm_info
operator|.
name|guid
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_smr
operator|->
name|sm_info
operator|.
name|sm_key
argument_list|)
argument_list|,
name|cl_ntoh32
argument_list|(
name|p_smr
operator|->
name|sm_info
operator|.
name|act_count
argument_list|)
argument_list|,
name|priority
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_switch_info_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_switch_info_record_t
modifier|*
name|p_sir
init|=
name|data
decl_stmt|;
name|uint32_t
name|sa_cap_mask2
init|=
name|ib_class_cap_mask2
argument_list|(
operator|&
name|p
operator|->
name|cpi
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"SwitchInfoRecord dump:\n"
literal|"\t\tRID\n"
literal|"\t\tLID.....................................%u\n"
literal|"\t\tSwitchInfo dump:\n"
literal|"\t\tLinearFDBCap............................0x%X\n"
literal|"\t\tRandomFDBCap............................0x%X\n"
literal|"\t\tMulticastFDBCap.........................0x%X\n"
literal|"\t\tLinearFDBTop............................0x%X\n"
literal|"\t\tDefaultPort.............................%u\n"
literal|"\t\tDefaultMulticastPrimaryPort.............%u\n"
literal|"\t\tDefaultMulticastNotPrimaryPort..........%u\n"
literal|"\t\tLifeTimeValue/PortStateChange/OpSL2VL...0x%X\n"
literal|"\t\tLIDsPerPort.............................0x%X\n"
literal|"\t\tPartitionEnforcementCap.................0x%X\n"
literal|"\t\tflags...................................0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sir
operator|->
name|lid
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sir
operator|->
name|switch_info
operator|.
name|lin_cap
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sir
operator|->
name|switch_info
operator|.
name|rand_cap
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sir
operator|->
name|switch_info
operator|.
name|mcast_cap
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sir
operator|->
name|switch_info
operator|.
name|lin_top
argument_list|)
argument_list|,
name|p_sir
operator|->
name|switch_info
operator|.
name|def_port
argument_list|,
name|p_sir
operator|->
name|switch_info
operator|.
name|def_mcast_pri_port
argument_list|,
name|p_sir
operator|->
name|switch_info
operator|.
name|def_mcast_not_port
argument_list|,
name|p_sir
operator|->
name|switch_info
operator|.
name|life_state
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sir
operator|->
name|switch_info
operator|.
name|lids_per_port
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sir
operator|->
name|switch_info
operator|.
name|enforce_cap
argument_list|)
argument_list|,
name|p_sir
operator|->
name|switch_info
operator|.
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa_cap_mask2
operator|&
name|UMAD_SA_CAP_MASK2_IS_MCAST_TOP_SUP
condition|)
name|printf
argument_list|(
literal|"\t\tMulticastFDBTop.........................0x%X\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_sir
operator|->
name|switch_info
operator|.
name|mcast_top
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_inform_info_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|gid_str
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|char
name|gid_str2
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|ib_inform_info_record_t
modifier|*
name|p_iir
init|=
name|data
decl_stmt|;
name|uint32_t
name|qpn
decl_stmt|;
name|uint8_t
name|resp_time_val
decl_stmt|;
name|ib_inform_info_get_qpn_resp_time
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|qpn_resp_time_val
argument_list|,
operator|&
name|qpn
argument_list|,
operator|&
name|resp_time_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_iir
operator|->
name|inform_info
operator|.
name|is_generic
condition|)
block|{
name|printf
argument_list|(
literal|"InformInfoRecord dump:\n"
literal|"\t\tRID\n"
literal|"\t\tSubscriberGID...........%s\n"
literal|"\t\tSubscriberEnum..........0x%X\n"
literal|"\t\tInformInfo dump:\n"
literal|"\t\tgid.....................%s\n"
literal|"\t\tlid_range_begin.........%u\n"
literal|"\t\tlid_range_end...........%u\n"
literal|"\t\tis_generic..............0x%X\n"
literal|"\t\tsubscribe...............0x%X\n"
literal|"\t\ttrap_type...............0x%X\n"
literal|"\t\ttrap_num................%u\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_iir
operator|->
name|subscriber_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|subscriber_enum
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|gid
operator|.
name|raw
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_begin
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_end
argument_list|)
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|is_generic
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|subscribe
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|trap_type
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|g_or_v
operator|.
name|generic
operator|.
name|trap_num
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|show_keys
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tqpn.....................0x%06X\n"
argument_list|,
name|cl_ntoh32
argument_list|(
name|qpn
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\t\tqpn....................."
name|NOT_DISPLAYED_STR
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\t\tresp_time_val...........0x%X\n"
literal|"\t\tnode_type...............0x%06X\n"
argument_list|,
name|resp_time_val
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_inform_info_get_prod_type
argument_list|(
operator|&
name|p_iir
operator|->
name|inform_info
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"InformInfoRecord dump:\n"
literal|"\t\tRID\n"
literal|"\t\tSubscriberGID...........%s\n"
literal|"\t\tSubscriberEnum..........0x%X\n"
literal|"\t\tInformInfo dump:\n"
literal|"\t\tgid.....................%s\n"
literal|"\t\tlid_range_begin.........%u\n"
literal|"\t\tlid_range_end...........%u\n"
literal|"\t\tis_generic..............0x%X\n"
literal|"\t\tsubscribe...............0x%X\n"
literal|"\t\ttrap_type...............0x%X\n"
literal|"\t\tdev_id..................0x%X\n"
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_iir
operator|->
name|subscriber_gid
operator|.
name|raw
argument_list|,
name|gid_str
argument_list|,
sizeof|sizeof
name|gid_str
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|subscriber_enum
argument_list|)
argument_list|,
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|gid
operator|.
name|raw
argument_list|,
name|gid_str2
argument_list|,
sizeof|sizeof
name|gid_str2
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_begin
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|lid_range_end
argument_list|)
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|is_generic
argument_list|,
name|p_iir
operator|->
name|inform_info
operator|.
name|subscribe
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|trap_type
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p_iir
operator|->
name|inform_info
operator|.
name|g_or_v
operator|.
name|vend
operator|.
name|dev_id
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|show_keys
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tqpn.....................0x%06X\n"
argument_list|,
name|cl_ntoh32
argument_list|(
name|qpn
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\t\tqpn....................."
name|NOT_DISPLAYED_STR
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\t\tresp_time_val...........0x%X\n"
literal|"\t\tvendor_id...............0x%06X\n"
argument_list|,
name|resp_time_val
argument_list|,
name|cl_ntoh32
argument_list|(
name|ib_inform_info_get_prod_type
argument_list|(
operator|&
name|p_iir
operator|->
name|inform_info
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_link_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_link_record_t
modifier|*
name|lr
init|=
name|data
decl_stmt|;
name|printf
argument_list|(
literal|"LinkRecord dump:\n"
literal|"\t\tFromLID....................%u\n"
literal|"\t\tFromPort...................%u\n"
literal|"\t\tToPort.....................%u\n"
literal|"\t\tToLID......................%u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lr
operator|->
name|from_lid
argument_list|)
argument_list|,
name|lr
operator|->
name|from_port_num
argument_list|,
name|lr
operator|->
name|to_port_num
argument_list|,
name|cl_ntoh16
argument_list|(
name|lr
operator|->
name|to_lid
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_slvl_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_slvl_table_record_t
modifier|*
name|slvl
init|=
name|data
decl_stmt|;
name|ib_slvl_table_t
modifier|*
name|t
init|=
operator|&
name|slvl
operator|->
name|slvl_tbl
decl_stmt|;
name|printf
argument_list|(
literal|"SL2VLTableRecord dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tInPort.....................%u\n"
literal|"\t\tOutPort....................%u\n"
literal|"\t\tSL: 0| 1| 2| 3| 4| 5| 6| 7| 8| 9|10|11|12|13|14|15|\n"
literal|"\t\tVL:%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u"
literal|"|%2u|%2u|%2u|\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|slvl
operator|->
name|lid
argument_list|)
argument_list|,
name|slvl
operator|->
name|in_port_num
argument_list|,
name|slvl
operator|->
name|out_port_num
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|3
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|4
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|5
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|6
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|7
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|8
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|9
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|10
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|11
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|12
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|13
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|14
argument_list|)
argument_list|,
name|ib_slvl_table_get
argument_list|(
name|t
argument_list|,
literal|15
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_vlarb_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_vl_arb_table_record_t
modifier|*
name|vlarb
init|=
name|data
decl_stmt|;
name|ib_vl_arb_element_t
modifier|*
name|e
init|=
name|vlarb
operator|->
name|vl_arb_tbl
operator|.
name|vl_entry
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"VLArbTableRecord dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tPort.......................%u\n"
literal|"\t\tBlock......................%u\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|vlarb
operator|->
name|lid
argument_list|)
argument_list|,
name|vlarb
operator|->
name|port_num
argument_list|,
name|vlarb
operator|->
name|block_num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|+=
literal|16
control|)
name|printf
argument_list|(
literal|"\t\tVL    :%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|"
literal|"%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|\n"
literal|"\t\tWeight:%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|"
literal|"%2u|%2u|%2u|%2u|%2u|%2u|%2u|%2u|\n"
argument_list|,
name|e
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|2
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|3
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|4
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|5
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|6
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|7
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|8
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|9
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|10
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|11
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|12
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|13
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|14
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|15
index|]
operator|.
name|vl
argument_list|,
name|e
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|2
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|3
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|4
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|5
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|6
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|7
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|8
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|9
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|10
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|11
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|12
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|13
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|14
index|]
operator|.
name|weight
argument_list|,
name|e
index|[
name|i
operator|+
literal|15
index|]
operator|.
name|weight
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_pkey_tbl_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|params
parameter_list|)
block|{
name|ib_pkey_table_record_t
modifier|*
name|pktr
init|=
name|data
decl_stmt|;
name|ib_net16_t
modifier|*
name|p
init|=
name|pktr
operator|->
name|pkey_tbl
operator|.
name|pkey_entry
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"PKeyTableRecord dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tPort.......................%u\n"
literal|"\t\tBlock......................%u\n"
literal|"\t\tPKey Table:\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|pktr
operator|->
name|lid
argument_list|)
argument_list|,
name|pktr
operator|->
name|port_num
argument_list|,
name|pktr
operator|->
name|block_num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|+=
literal|8
control|)
name|printf
argument_list|(
literal|"\t\t0x%04x 0x%04x 0x%04x 0x%04x"
literal|" 0x%04x 0x%04x 0x%04x 0x%04x\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|4
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|5
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|6
index|]
argument_list|)
argument_list|,
name|cl_ntoh16
argument_list|(
name|p
index|[
name|i
operator|+
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_lft_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_lft_record_t
modifier|*
name|lftr
init|=
name|data
decl_stmt|;
name|unsigned
name|block
init|=
name|cl_ntoh16
argument_list|(
name|lftr
operator|->
name|block_num
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"LFT Record dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tBlock......................%u\n"
literal|"\t\tLFT:\n\t\tLID\tPort Number\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|lftr
operator|->
name|lid
argument_list|)
argument_list|,
name|block
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"\t\t%u\t%u\n"
argument_list|,
name|block
operator|*
literal|64
operator|+
name|i
argument_list|,
name|lftr
operator|->
name|lft
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_guidinfo_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_guidinfo_record_t
modifier|*
name|gir
init|=
name|data
decl_stmt|;
name|printf
argument_list|(
literal|"GUIDInfo Record dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tBlock......................%u\n"
literal|"\t\tGUID 0.....................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tGUID 1.....................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tGUID 2.....................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tGUID 3.....................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tGUID 4.....................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tGUID 5.....................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tGUID 6.....................0x%016"
name|PRIx64
literal|"\n"
literal|"\t\tGUID 7.....................0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|gir
operator|->
name|lid
argument_list|)
argument_list|,
name|gir
operator|->
name|block_num
argument_list|,
name|cl_ntoh64
argument_list|(
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|cl_ntoh64
argument_list|(
name|gir
operator|->
name|guid_info
operator|.
name|guid
index|[
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_one_mft_record
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|ib_mft_record_t
modifier|*
name|mftr
init|=
name|data
decl_stmt|;
name|unsigned
name|position
init|=
name|cl_ntoh16
argument_list|(
name|mftr
operator|->
name|position_block_num
argument_list|)
operator|>>
literal|12
decl_stmt|;
name|unsigned
name|block
init|=
name|cl_ntoh16
argument_list|(
name|mftr
operator|->
name|position_block_num
argument_list|)
operator|&
name|IB_MCAST_BLOCK_ID_MASK_HO
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unsigned
name|offset
decl_stmt|;
name|printf
argument_list|(
literal|"MFT Record dump:\n"
literal|"\t\tLID........................%u\n"
literal|"\t\tPosition...................%u\n"
literal|"\t\tBlock......................%u\n"
literal|"\t\tMFT:\n\t\tMLID\tPort Mask\n"
argument_list|,
name|cl_ntoh16
argument_list|(
name|mftr
operator|->
name|lid
argument_list|)
argument_list|,
name|position
argument_list|,
name|block
argument_list|)
expr_stmt|;
name|offset
operator|=
name|IB_LID_MCAST_START_HO
operator|+
name|block
operator|*
literal|32
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IB_MCAST_BLOCK_SIZE
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"\t\t0x%04x\t0x%04x\n"
argument_list|,
name|offset
operator|+
name|i
argument_list|,
name|cl_ntoh16
argument_list|(
name|mftr
operator|->
name|mft
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_results
parameter_list|(
name|struct
name|sa_query_result
modifier|*
name|r
parameter_list|,
name|void
function_decl|(
modifier|*
name|dump_func
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|struct
name|query_params
modifier|*
parameter_list|)
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|r
operator|->
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|void
modifier|*
name|data
init|=
name|sa_get_query_rec
argument_list|(
name|r
operator|->
name|p_result_madw
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|dump_func
argument_list|(
name|data
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * Get any record(s)  */
end_comment

begin_function
specifier|static
name|int
name|get_any_records
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|uint16_t
name|attr_id
parameter_list|,
name|uint32_t
name|attr_mod
parameter_list|,
name|ib_net64_t
name|comp_mask
parameter_list|,
name|void
modifier|*
name|attr
parameter_list|,
name|size_t
name|attr_size
parameter_list|,
name|struct
name|sa_query_result
modifier|*
name|result
parameter_list|)
block|{
name|int
name|ret
init|=
name|sa_query
argument_list|(
name|h
argument_list|,
name|IB_MAD_METHOD_GET_TABLE
argument_list|,
name|attr_id
argument_list|,
name|attr_mod
argument_list|,
name|cl_ntoh64
argument_list|(
name|comp_mask
argument_list|)
argument_list|,
name|ibd_sakey
argument_list|,
name|attr
argument_list|,
name|attr_size
argument_list|,
name|result
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Query SA failed: %s\n"
argument_list|,
name|strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|result
operator|->
name|status
operator|!=
name|IB_SA_MAD_STATUS_SUCCESS
condition|)
block|{
name|sa_report_err
argument_list|(
name|result
operator|->
name|status
argument_list|)
expr_stmt|;
return|return
name|EIO
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_and_dump_any_records
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|uint16_t
name|attr_id
parameter_list|,
name|uint32_t
name|attr_mod
parameter_list|,
name|ib_net64_t
name|comp_mask
parameter_list|,
name|void
modifier|*
name|attr
parameter_list|,
name|size_t
name|attr_size
parameter_list|,
name|void
function_decl|(
modifier|*
name|dump_func
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|struct
name|query_params
modifier|*
parameter_list|)
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|sa_query_result
name|result
decl_stmt|;
name|int
name|ret
init|=
name|get_any_records
argument_list|(
name|h
argument_list|,
name|attr_id
argument_list|,
name|attr_mod
argument_list|,
name|comp_mask
argument_list|,
name|attr
argument_list|,
name|attr_size
argument_list|,
operator|&
name|result
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_func
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Get all the records available for requested query type.  */
end_comment

begin_function
specifier|static
name|int
name|get_all_records
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|uint16_t
name|attr_id
parameter_list|,
name|struct
name|sa_query_result
modifier|*
name|result
parameter_list|)
block|{
return|return
name|get_any_records
argument_list|(
name|h
argument_list|,
name|attr_id
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|result
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_and_dump_all_records
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|uint16_t
name|attr_id
parameter_list|,
name|void
function_decl|(
modifier|*
name|dump_func
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|sa_query_result
name|result
decl_stmt|;
name|int
name|ret
init|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|attr_id
argument_list|,
operator|&
name|result
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_func
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * return the lid from the node descriptor (name) supplied  */
end_comment

begin_function
specifier|static
name|int
name|get_lid_from_name
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|uint16_t
modifier|*
name|lid
parameter_list|)
block|{
name|ib_node_record_t
modifier|*
name|node_record
init|=
name|NULL
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|sa_query_result
name|result
decl_stmt|;
name|ret
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_NODERECORD
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|EHOSTDOWN
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|result
operator|.
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|node_record
operator|=
name|sa_get_query_rec
argument_list|(
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|&&
name|strncmp
argument_list|(
name|name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|,
sizeof|sizeof
argument_list|(
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|lid
operator|=
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|lid
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|get_lid
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint16_t
name|rc_lid
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|name
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|isalpha
argument_list|(
name|name
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|rc
operator|=
name|get_lid_from_name
argument_list|(
name|h
argument_list|,
name|name
argument_list|,
operator|&
name|rc_lid
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to find lid for \"%s\": %s\n"
argument_list|,
name|name
argument_list|,
name|strerror
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|long
name|val
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|strtol
argument_list|(
name|name
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
operator|||
name|val
operator|<=
literal|0
operator|||
name|val
operator|>
name|UINT16_MAX
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid lid specified: \"%s\"\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|rc_lid
operator|=
operator|(
name|uint16_t
operator|)
name|val
expr_stmt|;
block|}
return|return
name|rc_lid
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_iir_subscriber_gid
parameter_list|(
name|char
modifier|*
name|str
parameter_list|,
name|ib_inform_info_record_t
modifier|*
name|ir
parameter_list|)
block|{
name|int
name|rc
init|=
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|str
argument_list|,
operator|&
operator|(
name|ir
operator|->
name|subscriber_gid
operator|.
name|raw
operator|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|<
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid SubscriberGID specified: \"%s\"\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_lid_and_ports
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|int
modifier|*
name|lid
parameter_list|,
name|int
modifier|*
name|port1
parameter_list|,
name|int
modifier|*
name|port2
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|e
decl_stmt|;
if|if
condition|(
name|port1
condition|)
operator|*
name|port1
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|port2
condition|)
operator|*
name|port2
operator|=
operator|-
literal|1
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|lid
condition|)
operator|*
name|lid
operator|=
name|get_lid
argument_list|(
name|h
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return
literal|0
return|;
name|str
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|port1
condition|)
block|{
operator|*
name|port1
operator|=
name|strtoul
argument_list|(
name|str
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|str
condition|)
operator|*
name|port1
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p
condition|)
return|return
literal|0
return|;
name|str
operator|=
name|p
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|port2
condition|)
block|{
operator|*
name|port2
operator|=
name|strtoul
argument_list|(
name|str
argument_list|,
operator|&
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|str
condition|)
operator|*
name|port2
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Get the portinfo records available with IsSM or IsSMdisabled CapabilityMask bit on.  */
end_comment

begin_function
specifier|static
name|int
name|get_issm_records
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|ib_net32_t
name|capability_mask
parameter_list|,
name|struct
name|sa_query_result
modifier|*
name|result
parameter_list|)
block|{
name|ib_portinfo_record_t
name|attr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|.
name|port_info
operator|.
name|capability_mask
operator|=
name|capability_mask
expr_stmt|;
return|return
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_PORTINFORECORD
argument_list|,
literal|1
operator|<<
literal|31
argument_list|,
name|IB_PIR_COMPMASK_CAPMASK
argument_list|,
operator|&
name|attr
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
argument_list|)
argument_list|,
name|result
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_node_records
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|sa_query_result
name|result
decl_stmt|;
name|ret
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_NODERECORD
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|node_print_desc
operator|==
name|ALL_DESC
condition|)
block|{
name|printf
argument_list|(
literal|"   LID \"name\"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"================\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|result
operator|.
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|ib_node_record_t
modifier|*
name|node_record
decl_stmt|;
name|node_record
operator|=
name|sa_get_query_rec
argument_list|(
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|node_print_desc
operator|==
name|ALL_DESC
condition|)
block|{
name|print_node_desc
argument_list|(
name|node_record
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_LID
condition|)
block|{
if|if
condition|(
name|requested_lid
operator|==
name|cl_ntoh16
argument_list|(
name|node_record
operator|->
name|lid
argument_list|)
condition|)
name|print_node_record
argument_list|(
name|node_record
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_GUID
condition|)
block|{
name|ib_node_info_t
modifier|*
name|p_ni
init|=
operator|&
operator|(
name|node_record
operator|->
name|node_info
operator|)
decl_stmt|;
if|if
condition|(
name|requested_guid
operator|==
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|port_guid
argument_list|)
condition|)
name|print_node_record
argument_list|(
name|node_record
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ib_node_info_t
modifier|*
name|p_ni
init|=
operator|&
operator|(
name|node_record
operator|->
name|node_info
operator|)
decl_stmt|;
name|ib_node_desc_t
modifier|*
name|p_nd
init|=
operator|&
operator|(
name|node_record
operator|->
name|node_desc
operator|)
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|name
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_ni
operator|->
name|node_guid
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p_nd
operator|->
name|description
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|requested_name
operator|||
operator|(
name|strncmp
argument_list|(
name|requested_name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|,
sizeof|sizeof
argument_list|(
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strncmp
argument_list|(
name|requested_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|node_record
operator|->
name|node_desc
operator|.
name|description
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|print_node_record
argument_list|(
name|node_record
argument_list|)
expr_stmt|;
if|if
condition|(
name|node_print_desc
operator|==
name|UNIQUE_LID_ONLY
condition|)
block|{
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sm_pr_query
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|ibmad_gid_t
modifier|*
name|gid
parameter_list|,
name|int
name|srclid
parameter_list|,
name|int
name|destlid
parameter_list|)
block|{
name|ib_path_rec_t
name|pr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|struct
name|sa_query_result
name|result
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ib_path_rec_t
modifier|*
name|p_pr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|srclid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|pr
operator|.
name|slid
argument_list|,
name|PR
argument_list|,
name|SLID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|destlid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|pr
operator|.
name|dlid
argument_list|,
name|PR
argument_list|,
name|DLID
argument_list|)
expr_stmt|;
name|ret
operator|=
name|get_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_PATHRECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|pr
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
argument_list|)
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|p_pr
operator|=
name|sa_get_query_rec
argument_list|(
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|gid
argument_list|,
operator|&
name|p_pr
operator|->
name|dgid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_path_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_path_rec_t
name|pr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|uint32_t
name|flow
init|=
literal|0
decl_stmt|;
name|uint16_t
name|qos_class
init|=
literal|0
decl_stmt|;
name|uint8_t
name|reversible
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|service_id
argument_list|,
literal|64
argument_list|,
literal|0
argument_list|,
name|pr
operator|.
name|service_id
argument_list|,
name|PR
argument_list|,
name|SERVICEID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_GID
argument_list|(
name|p
operator|->
name|sgid
argument_list|,
name|pr
operator|.
name|sgid
argument_list|,
name|PR
argument_list|,
name|SGID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_GID
argument_list|(
name|p
operator|->
name|dgid
argument_list|,
name|pr
operator|.
name|dgid
argument_list|,
name|PR
argument_list|,
name|DGID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|slid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|pr
operator|.
name|slid
argument_list|,
name|PR
argument_list|,
name|SLID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|dlid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|pr
operator|.
name|dlid
argument_list|,
name|PR
argument_list|,
name|DLID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|hop_limit
argument_list|,
literal|32
argument_list|,
operator|-
literal|1
argument_list|,
name|pr
operator|.
name|hop_flow_raw
argument_list|,
name|PR
argument_list|,
name|HOPLIMIT
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
operator|(
name|p
operator|->
name|flow_label
operator|<<
literal|8
operator|)
argument_list|,
literal|32
argument_list|,
literal|0
argument_list|,
name|flow
argument_list|,
name|PR
argument_list|,
name|FLOWLABEL
argument_list|)
expr_stmt|;
name|pr
operator|.
name|hop_flow_raw
operator|=
operator|(
name|pr
operator|.
name|hop_flow_raw
operator|&
name|cl_hton32
argument_list|(
operator|~
literal|0x0FFFFF00
argument_list|)
operator|)
operator||
name|flow
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|tclass
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
name|pr
operator|.
name|tclass
argument_list|,
name|PR
argument_list|,
name|TCLASS
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|reversible
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|reversible
argument_list|,
name|PR
argument_list|,
name|REVERSIBLE
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|numb_path
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|pr
operator|.
name|num_path
argument_list|,
name|PR
argument_list|,
name|NUMBPATH
argument_list|)
expr_stmt|;
name|pr
operator|.
name|num_path
operator||=
name|reversible
operator|<<
literal|7
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|pkey
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|pr
operator|.
name|pkey
argument_list|,
name|PR
argument_list|,
name|PKEY
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|sl
argument_list|,
literal|16
argument_list|,
operator|-
literal|1
argument_list|,
name|pr
operator|.
name|qos_class_sl
argument_list|,
name|PR
argument_list|,
name|SL
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
operator|(
name|p
operator|->
name|qos_class
operator|<<
literal|4
operator|)
argument_list|,
literal|16
argument_list|,
operator|-
literal|1
argument_list|,
name|qos_class
argument_list|,
name|PR
argument_list|,
name|QOS_CLASS
argument_list|)
expr_stmt|;
name|pr
operator|.
name|qos_class_sl
operator|=
operator|(
name|pr
operator|.
name|qos_class_sl
operator|&
name|CL_HTON16
argument_list|(
name|IB_PATH_REC_SL_MASK
argument_list|)
operator|)
operator||
name|qos_class
expr_stmt|;
name|CHECK_AND_SET_VAL_AND_SEL
argument_list|(
name|p
operator|->
name|mtu
argument_list|,
name|pr
operator|.
name|mtu
argument_list|,
name|PR
argument_list|,
name|MTU
argument_list|,
name|SELEC
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL_AND_SEL
argument_list|(
name|p
operator|->
name|rate
argument_list|,
name|pr
operator|.
name|rate
argument_list|,
name|PR
argument_list|,
name|RATE
argument_list|,
name|SELEC
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL_AND_SEL
argument_list|(
name|p
operator|->
name|pkt_life
argument_list|,
name|pr
operator|.
name|pkt_life
argument_list|,
name|PR
argument_list|,
name|PKTLIFETIME
argument_list|,
name|SELEC
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_PATHRECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|pr
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
argument_list|)
argument_list|,
name|dump_path_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_issm_records
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|sa_query_result
name|result
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
comment|/* First, get IsSM records */
name|ret
operator|=
name|get_issm_records
argument_list|(
name|h
argument_list|,
name|IB_PORT_CAP_IS_SM
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|printf
argument_list|(
literal|"IsSM ports\n"
argument_list|)
expr_stmt|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_portinfo_record
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
comment|/* Now, get IsSMdisabled records */
name|ret
operator|=
name|get_issm_records
argument_list|(
name|h
argument_list|,
name|IB_PORT_CAP_SM_DISAB
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|printf
argument_list|(
literal|"\nIsSMdisabled ports\n"
argument_list|)
expr_stmt|;
name|dump_results
argument_list|(
operator|&
name|result
argument_list|,
name|dump_portinfo_record
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_multicast_member_records
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|sa_query_result
name|mc_group_result
decl_stmt|;
name|struct
name|sa_query_result
name|nr_result
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|ret
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_MCRECORD
argument_list|,
operator|&
name|mc_group_result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|get_all_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_NODERECORD
argument_list|,
operator|&
name|nr_result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|return_mc
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mc_group_result
operator|.
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|ib_member_rec_t
modifier|*
name|rec
init|=
operator|(
name|ib_member_rec_t
operator|*
operator|)
name|sa_get_query_rec
argument_list|(
name|mc_group_result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|dump_multicast_member_record
argument_list|(
name|rec
argument_list|,
operator|&
name|nr_result
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
name|sa_free_result_mad
argument_list|(
operator|&
name|nr_result
argument_list|)
expr_stmt|;
name|return_mc
label|:
name|sa_free_result_mad
argument_list|(
operator|&
name|mc_group_result
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_multicast_group_records
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|)
block|{
return|return
name|get_and_dump_all_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_MCRECORD
argument_list|,
name|dump_multicast_group_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_class_port_info
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|dump_class_port_info
argument_list|(
operator|&
name|p
operator|->
name|cpi
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_node_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_node_record_t
name|nr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|nr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|nr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|nr
operator|.
name|lid
argument_list|,
name|NR
argument_list|,
name|LID
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_NODERECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|nr
argument_list|,
sizeof|sizeof
argument_list|(
name|nr
argument_list|)
argument_list|,
name|dump_node_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_portinfo_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_portinfo_record_t
name|pir
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|port
init|=
operator|-
literal|1
decl_stmt|,
name|options
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|options
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pir
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pir
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|pir
operator|.
name|lid
argument_list|,
name|PIR
argument_list|,
name|LID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|port
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|pir
operator|.
name|port_num
argument_list|,
name|PIR
argument_list|,
name|PORTNUM
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|options
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|pir
operator|.
name|options
argument_list|,
name|PIR
argument_list|,
name|OPTIONS
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_PORTINFORECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|pir
argument_list|,
sizeof|sizeof
argument_list|(
name|pir
argument_list|)
argument_list|,
name|dump_one_portinfo_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_mcmember_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_member_rec_t
name|mr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|uint32_t
name|flow
init|=
literal|0
decl_stmt|;
name|uint8_t
name|sl
init|=
literal|0
decl_stmt|,
name|hop
init|=
literal|0
decl_stmt|,
name|scope
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|mr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_GID
argument_list|(
name|p
operator|->
name|mgid
argument_list|,
name|mr
operator|.
name|mgid
argument_list|,
name|MCR
argument_list|,
name|MGID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_GID
argument_list|(
name|p
operator|->
name|gid
argument_list|,
name|mr
operator|.
name|port_gid
argument_list|,
name|MCR
argument_list|,
name|PORT_GID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|mlid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|mr
operator|.
name|mlid
argument_list|,
name|MCR
argument_list|,
name|MLID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|qkey
argument_list|,
literal|32
argument_list|,
literal|0
argument_list|,
name|mr
operator|.
name|qkey
argument_list|,
name|MCR
argument_list|,
name|QKEY
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL_AND_SEL
argument_list|(
name|p
operator|->
name|mtu
argument_list|,
name|mr
operator|.
name|mtu
argument_list|,
name|MCR
argument_list|,
name|MTU
argument_list|,
name|_SEL
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL_AND_SEL
argument_list|(
name|p
operator|->
name|rate
argument_list|,
name|mr
operator|.
name|rate
argument_list|,
name|MCR
argument_list|,
name|RATE
argument_list|,
name|_SEL
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL_AND_SEL
argument_list|(
name|p
operator|->
name|pkt_life
argument_list|,
name|mr
operator|.
name|pkt_life
argument_list|,
name|MCR
argument_list|,
name|LIFE
argument_list|,
name|_SEL
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|tclass
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
name|mr
operator|.
name|tclass
argument_list|,
name|MCR
argument_list|,
name|TCLASS
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|pkey
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|mr
operator|.
name|pkey
argument_list|,
name|MCR
argument_list|,
name|PKEY
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|sl
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|sl
argument_list|,
name|MCR
argument_list|,
name|SL
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|flow_label
argument_list|,
literal|32
argument_list|,
literal|0
argument_list|,
name|flow
argument_list|,
name|MCR
argument_list|,
name|FLOW
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|hop_limit
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
name|hop
argument_list|,
name|MCR
argument_list|,
name|HOP
argument_list|)
expr_stmt|;
comment|/* pass flow in host order as expected by function */
name|mr
operator|.
name|sl_flow_hop
operator|=
name|ib_member_set_sl_flow_hop
argument_list|(
name|sl
argument_list|,
name|cl_ntoh32
argument_list|(
name|flow
argument_list|)
argument_list|,
name|hop
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|scope
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
name|scope
argument_list|,
name|MCR
argument_list|,
name|SCOPE
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|join_state
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
name|mr
operator|.
name|scope_state
argument_list|,
name|MCR
argument_list|,
name|JOIN_STATE
argument_list|)
expr_stmt|;
name|mr
operator|.
name|scope_state
operator||=
name|scope
operator|<<
literal|4
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|p
operator|->
name|proxy_join
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|mr
operator|.
name|proxy_join
argument_list|,
name|MCR
argument_list|,
name|PROXY
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_MCRECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|mr
argument_list|,
sizeof|sizeof
argument_list|(
name|mr
argument_list|)
argument_list|,
name|dump_one_mcmember_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_service_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
return|return
name|get_and_dump_all_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_SERVICERECORD
argument_list|,
name|dump_service_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_sm_info_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_sminfo_record_t
name|smir
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|smir
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smir
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|smir
operator|.
name|lid
argument_list|,
name|SMIR
argument_list|,
name|LID
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_SMINFORECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|smir
argument_list|,
sizeof|sizeof
argument_list|(
name|smir
argument_list|)
argument_list|,
name|dump_sm_info_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_switchinfo_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_switch_info_record_t
name|swir
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|swir
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|swir
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|swir
operator|.
name|lid
argument_list|,
name|SWIR
argument_list|,
name|LID
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_SWITCHINFORECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|swir
argument_list|,
sizeof|sizeof
argument_list|(
name|swir
argument_list|)
argument_list|,
name|dump_switch_info_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_inform_info_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|ib_inform_info_record_t
name|ir
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ir
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ir
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|comp_mask
operator|=
name|IB_IIR_COMPMASK_SUBSCRIBERGID
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|parse_iir_subscriber_gid
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|ir
argument_list|)
operator|)
operator|<
literal|1
condition|)
return|return
name|rc
return|;
block|}
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_INFORMINFORECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|ir
argument_list|,
sizeof|sizeof
argument_list|(
name|ir
argument_list|)
argument_list|,
name|dump_inform_info_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_link_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_link_record_t
name|lr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|from_lid
init|=
literal|0
decl_stmt|,
name|to_lid
init|=
literal|0
decl_stmt|,
name|from_port
init|=
operator|-
literal|1
decl_stmt|,
name|to_port
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|from_lid
argument_list|,
operator|&
name|from_port
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
operator|&
name|to_lid
argument_list|,
operator|&
name|to_port
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|lr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|lr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|from_lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|lr
operator|.
name|from_lid
argument_list|,
name|LR
argument_list|,
name|FROM_LID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|from_port
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|lr
operator|.
name|from_port_num
argument_list|,
name|LR
argument_list|,
name|FROM_PORT
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|to_lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|lr
operator|.
name|to_lid
argument_list|,
name|LR
argument_list|,
name|TO_LID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|to_port
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|lr
operator|.
name|to_port_num
argument_list|,
name|LR
argument_list|,
name|TO_PORT
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_LINKRECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|lr
argument_list|,
sizeof|sizeof
argument_list|(
name|lr
argument_list|)
argument_list|,
name|dump_one_link_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_sl2vl_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_slvl_table_record_t
name|slvl
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|in_port
init|=
operator|-
literal|1
decl_stmt|,
name|out_port
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|in_port
argument_list|,
operator|&
name|out_port
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|slvl
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|slvl
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|slvl
operator|.
name|lid
argument_list|,
name|SLVL
argument_list|,
name|LID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|in_port
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|slvl
operator|.
name|in_port_num
argument_list|,
name|SLVL
argument_list|,
name|IN_PORT
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|out_port
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|slvl
operator|.
name|out_port_num
argument_list|,
name|SLVL
argument_list|,
name|OUT_PORT
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_SL2VLTABLERECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|slvl
argument_list|,
sizeof|sizeof
argument_list|(
name|slvl
argument_list|)
argument_list|,
name|dump_one_slvl_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_vlarb_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_vl_arb_table_record_t
name|vlarb
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|port
init|=
operator|-
literal|1
decl_stmt|,
name|block
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|block
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|vlarb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|vlarb
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|vlarb
operator|.
name|lid
argument_list|,
name|VLA
argument_list|,
name|LID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|port
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|vlarb
operator|.
name|port_num
argument_list|,
name|VLA
argument_list|,
name|OUT_PORT
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|block
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|vlarb
operator|.
name|block_num
argument_list|,
name|VLA
argument_list|,
name|BLOCK
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_VLARBTABLERECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|vlarb
argument_list|,
sizeof|sizeof
argument_list|(
name|vlarb
argument_list|)
argument_list|,
name|dump_one_vlarb_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_pkey_tbl_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_pkey_table_record_t
name|pktr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|port
init|=
operator|-
literal|1
decl_stmt|,
name|block
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|block
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pktr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pktr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|pktr
operator|.
name|lid
argument_list|,
name|PKEY
argument_list|,
name|LID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|port
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|pktr
operator|.
name|port_num
argument_list|,
name|PKEY
argument_list|,
name|PORT
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|block
argument_list|,
literal|16
argument_list|,
operator|-
literal|1
argument_list|,
name|pktr
operator|.
name|block_num
argument_list|,
name|PKEY
argument_list|,
name|BLOCK
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_PKEYTABLERECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|pktr
argument_list|,
sizeof|sizeof
argument_list|(
name|pktr
argument_list|)
argument_list|,
name|dump_one_pkey_tbl_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_lft_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_lft_record_t
name|lftr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|block
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|block
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|lftr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|lftr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|lftr
operator|.
name|lid
argument_list|,
name|LFTR
argument_list|,
name|LID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|block
argument_list|,
literal|16
argument_list|,
operator|-
literal|1
argument_list|,
name|lftr
operator|.
name|block_num
argument_list|,
name|LFTR
argument_list|,
name|BLOCK
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_LFTRECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|lftr
argument_list|,
sizeof|sizeof
argument_list|(
name|lftr
argument_list|)
argument_list|,
name|dump_one_lft_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_guidinfo_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_guidinfo_record_t
name|gir
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|block
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|block
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|gir
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gir
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|gir
operator|.
name|lid
argument_list|,
name|GIR
argument_list|,
name|LID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|block
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|gir
operator|.
name|block_num
argument_list|,
name|GIR
argument_list|,
name|BLOCKNUM
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_GUIDINFORECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|gir
argument_list|,
sizeof|sizeof
argument_list|(
name|gir
argument_list|)
argument_list|,
name|dump_one_guidinfo_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_mft_records
parameter_list|(
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
parameter_list|,
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|p
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ib_mft_record_t
name|mftr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|int
name|lid
init|=
literal|0
decl_stmt|,
name|block
init|=
operator|-
literal|1
decl_stmt|,
name|position
init|=
operator|-
literal|1
decl_stmt|;
name|uint16_t
name|pos
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|parse_lid_and_ports
argument_list|(
name|h
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|lid
argument_list|,
operator|&
name|position
argument_list|,
operator|&
name|block
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|mftr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mftr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|lid
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|mftr
operator|.
name|lid
argument_list|,
name|MFTR
argument_list|,
name|LID
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|block
argument_list|,
literal|16
argument_list|,
operator|-
literal|1
argument_list|,
name|mftr
operator|.
name|position_block_num
argument_list|,
name|MFTR
argument_list|,
name|BLOCK
argument_list|)
expr_stmt|;
name|mftr
operator|.
name|position_block_num
operator|&=
name|cl_hton16
argument_list|(
name|IB_MCAST_BLOCK_ID_MASK_HO
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_VAL
argument_list|(
name|position
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|pos
argument_list|,
name|MFTR
argument_list|,
name|POSITION
argument_list|)
expr_stmt|;
name|mftr
operator|.
name|position_block_num
operator||=
name|cl_hton16
argument_list|(
name|pos
operator|<<
literal|12
argument_list|)
expr_stmt|;
return|return
name|get_and_dump_any_records
argument_list|(
name|h
argument_list|,
name|IB_SA_ATTR_MFTRECORD
argument_list|,
literal|0
argument_list|,
name|comp_mask
argument_list|,
operator|&
name|mftr
argument_list|,
sizeof|sizeof
argument_list|(
name|mftr
argument_list|)
argument_list|,
name|dump_one_mft_record
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_sa_cpi
parameter_list|(
name|struct
name|sa_handle
modifier|*
name|h
parameter_list|,
name|struct
name|query_params
modifier|*
name|query_params
parameter_list|)
block|{
name|ib_class_port_info_t
modifier|*
name|cpi
decl_stmt|;
name|struct
name|sa_query_result
name|result
decl_stmt|;
name|int
name|ret
init|=
name|sa_query
argument_list|(
name|h
argument_list|,
name|IB_MAD_METHOD_GET
argument_list|,
name|CLASS_PORT_INFO
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|ibd_sakey
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|result
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Query SA failed: %s\n"
argument_list|,
name|strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|result
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_SUCCESS
condition|)
block|{
name|sa_report_err
argument_list|(
name|result
operator|.
name|status
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|cpi
operator|=
name|sa_get_query_rec
argument_list|(
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|query_params
operator|->
name|cpi
argument_list|,
name|cpi
argument_list|,
sizeof|sizeof
argument_list|(
name|query_params
operator|->
name|cpi
argument_list|)
argument_list|)
expr_stmt|;
name|Exit
label|:
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|query_cmd
name|query_cmds
index|[]
init|=
block|{
block|{
literal|"ClassPortInfo"
block|,
literal|"CPI"
block|,
name|CLASS_PORT_INFO
block|,
name|NULL
block|,
name|query_class_port_info
block|}
block|,
block|{
literal|"NodeRecord"
block|,
literal|"NR"
block|,
name|IB_SA_ATTR_NODERECORD
block|,
literal|"[lid]"
block|,
name|query_node_records
block|}
block|,
block|{
literal|"PortInfoRecord"
block|,
literal|"PIR"
block|,
name|IB_SA_ATTR_PORTINFORECORD
block|,
literal|"[[lid]/[port]/[options]]"
block|,
name|query_portinfo_records
block|}
block|,
block|{
literal|"SL2VLTableRecord"
block|,
literal|"SL2VL"
block|,
name|IB_SA_ATTR_SL2VLTABLERECORD
block|,
literal|"[[lid]/[in_port]/[out_port]]"
block|,
name|query_sl2vl_records
block|}
block|,
block|{
literal|"PKeyTableRecord"
block|,
literal|"PKTR"
block|,
name|IB_SA_ATTR_PKEYTABLERECORD
block|,
literal|"[[lid]/[port]/[block]]"
block|,
name|query_pkey_tbl_records
block|}
block|,
block|{
literal|"VLArbitrationTableRecord"
block|,
literal|"VLAR"
block|,
name|IB_SA_ATTR_VLARBTABLERECORD
block|,
literal|"[[lid]/[port]/[block]]"
block|,
name|query_vlarb_records
block|}
block|,
block|{
literal|"InformInfoRecord"
block|,
literal|"IIR"
block|,
name|IB_SA_ATTR_INFORMINFORECORD
block|,
literal|"[subscriber_gid]"
block|,
name|query_inform_info_records
block|}
block|,
block|{
literal|"LinkRecord"
block|,
literal|"LR"
block|,
name|IB_SA_ATTR_LINKRECORD
block|,
literal|"[[from_lid]/[from_port]] [[to_lid]/[to_port]]"
block|,
name|query_link_records
block|}
block|,
block|{
literal|"ServiceRecord"
block|,
literal|"SR"
block|,
name|IB_SA_ATTR_SERVICERECORD
block|,
name|NULL
block|,
name|query_service_records
block|}
block|,
block|{
literal|"PathRecord"
block|,
literal|"PR"
block|,
name|IB_SA_ATTR_PATHRECORD
block|,
name|NULL
block|,
name|query_path_records
block|}
block|,
block|{
literal|"MCMemberRecord"
block|,
literal|"MCMR"
block|,
name|IB_SA_ATTR_MCRECORD
block|,
name|NULL
block|,
name|query_mcmember_records
block|}
block|,
block|{
literal|"LFTRecord"
block|,
literal|"LFTR"
block|,
name|IB_SA_ATTR_LFTRECORD
block|,
literal|"[[lid]/[block]]"
block|,
name|query_lft_records
block|}
block|,
block|{
literal|"MFTRecord"
block|,
literal|"MFTR"
block|,
name|IB_SA_ATTR_MFTRECORD
block|,
literal|"[[mlid]/[position]/[block]]"
block|,
name|query_mft_records
block|}
block|,
block|{
literal|"GUIDInfoRecord"
block|,
literal|"GIR"
block|,
name|IB_SA_ATTR_GUIDINFORECORD
block|,
literal|"[[lid]/[block]]"
block|,
name|query_guidinfo_records
block|}
block|,
block|{
literal|"SwitchInfoRecord"
block|,
literal|"SWIR"
block|,
name|IB_SA_ATTR_SWITCHINFORECORD
block|,
literal|"[lid]"
block|,
name|query_switchinfo_records
block|}
block|,
block|{
literal|"SMInfoRecord"
block|,
literal|"SMIR"
block|,
name|IB_SA_ATTR_SMINFORECORD
block|,
literal|"[lid]"
block|,
name|query_sm_info_records
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|struct
name|query_cmd
modifier|*
name|find_query
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
decl_stmt|;
for|for
control|(
name|q
operator|=
name|query_cmds
init|;
name|q
operator|->
name|name
condition|;
name|q
operator|++
control|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|name
argument_list|,
name|q
operator|->
name|name
argument_list|)
operator|||
operator|(
name|q
operator|->
name|alias
operator|&&
operator|!
name|strcasecmp
argument_list|(
name|name
argument_list|,
name|q
operator|->
name|alias
argument_list|)
operator|)
condition|)
return|return
name|q
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|query_cmd
modifier|*
name|find_query_by_type
parameter_list|(
name|uint16_t
name|type
parameter_list|)
block|{
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
decl_stmt|;
for|for
control|(
name|q
operator|=
name|query_cmds
init|;
name|q
operator|->
name|name
condition|;
name|q
operator|++
control|)
if|if
condition|(
name|q
operator|->
name|query_type
operator|==
name|type
condition|)
return|return
name|q
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_enum
enum|enum
name|saquery_command
block|{
name|SAQUERY_CMD_QUERY
block|,
name|SAQUERY_CMD_NODE_RECORD
block|,
name|SAQUERY_CMD_CLASS_PORT_INFO
block|,
name|SAQUERY_CMD_ISSM
block|,
name|SAQUERY_CMD_MCGROUPS
block|,
name|SAQUERY_CMD_MCMEMBERS
block|, }
enum|;
end_enum

begin_decl_stmt
specifier|static
name|enum
name|saquery_command
name|command
init|=
name|SAQUERY_CMD_QUERY
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|query_type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|src_lid
decl_stmt|,
modifier|*
name|dst_lid
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|process_opt
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|ch
parameter_list|,
name|char
modifier|*
name|optarg
parameter_list|)
block|{
name|struct
name|query_params
modifier|*
name|p
init|=
name|context
decl_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|1
case|:
block|{
name|src_lid
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
name|dst_lid
operator|=
name|strchr
argument_list|(
name|src_lid
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dst_lid
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
operator|*
name|dst_lid
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
name|p
operator|->
name|numb_path
operator|=
literal|0x7f
expr_stmt|;
name|query_type
operator|=
name|IB_SA_ATTR_PATHRECORD
expr_stmt|;
break|break;
case|case
literal|2
case|:
block|{
name|char
modifier|*
name|src_addr
init|=
name|strdup
argument_list|(
name|optarg
argument_list|)
decl_stmt|;
name|char
modifier|*
name|dst_addr
init|=
name|strchr
argument_list|(
name|src_addr
argument_list|,
literal|'-'
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|dst_addr
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
operator|*
name|dst_addr
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|src_addr
argument_list|,
operator|&
name|p
operator|->
name|sgid
argument_list|)
operator|<=
literal|0
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|dst_addr
argument_list|,
operator|&
name|p
operator|->
name|dgid
argument_list|)
operator|<=
literal|0
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
name|free
argument_list|(
name|src_addr
argument_list|)
expr_stmt|;
block|}
name|p
operator|->
name|numb_path
operator|=
literal|0x7f
expr_stmt|;
name|query_type
operator|=
name|IB_SA_ATTR_PATHRECORD
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|node_name_map_file
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|optarg
argument_list|)
operator|&&
operator|!
operator|(
name|optarg
operator|=
name|getpass
argument_list|(
literal|"SM_Key: "
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cannot get SM_Key\n"
argument_list|)
expr_stmt|;
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
block|}
name|ibd_sakey
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|query_type
operator|=
name|IB_SA_ATTR_PATHRECORD
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|node_print_desc
operator|=
name|ALL_DESC
expr_stmt|;
name|command
operator|=
name|SAQUERY_CMD_NODE_RECORD
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|command
operator|=
name|SAQUERY_CMD_CLASS_PORT_INFO
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|query_type
operator|=
name|IB_SA_ATTR_SERVICERECORD
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|query_type
operator|=
name|IB_SA_ATTR_INFORMINFORECORD
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|command
operator|=
name|SAQUERY_CMD_NODE_RECORD
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|node_print_desc
operator|=
name|LID_ONLY
expr_stmt|;
name|command
operator|=
name|SAQUERY_CMD_NODE_RECORD
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|node_print_desc
operator|=
name|UNIQUE_LID_ONLY
expr_stmt|;
name|command
operator|=
name|SAQUERY_CMD_NODE_RECORD
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
name|node_print_desc
operator|=
name|GUID_ONLY
expr_stmt|;
name|command
operator|=
name|SAQUERY_CMD_NODE_RECORD
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
name|node_print_desc
operator|=
name|NAME_OF_LID
expr_stmt|;
name|command
operator|=
name|SAQUERY_CMD_NODE_RECORD
expr_stmt|;
break|break;
case|case
literal|'U'
case|:
name|node_print_desc
operator|=
name|NAME_OF_GUID
expr_stmt|;
name|command
operator|=
name|SAQUERY_CMD_NODE_RECORD
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|command
operator|=
name|SAQUERY_CMD_ISSM
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|command
operator|=
name|SAQUERY_CMD_MCGROUPS
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|command
operator|=
name|SAQUERY_CMD_MCMEMBERS
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|query_type
operator|=
name|IB_SA_ATTR_LINKRECORD
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|p
operator|->
name|slid
operator|=
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|p
operator|->
name|dlid
operator|=
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|p
operator|->
name|mlid
operator|=
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|14
case|:
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|optarg
argument_list|,
operator|&
name|p
operator|->
name|sgid
argument_list|)
operator|<=
literal|0
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|15
case|:
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|optarg
argument_list|,
operator|&
name|p
operator|->
name|dgid
argument_list|)
operator|<=
literal|0
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|16
case|:
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|optarg
argument_list|,
operator|&
name|p
operator|->
name|gid
argument_list|)
operator|<=
literal|0
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|17
case|:
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|optarg
argument_list|,
operator|&
name|p
operator|->
name|mgid
argument_list|)
operator|<=
literal|0
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|p
operator|->
name|reversible
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|p
operator|->
name|numb_path
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|18
case|:
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|optarg
argument_list|)
operator|&&
operator|!
operator|(
name|optarg
operator|=
name|getpass
argument_list|(
literal|"P_Key: "
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cannot get P_Key\n"
argument_list|)
expr_stmt|;
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
block|}
name|p
operator|->
name|pkey
operator|=
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Q'
case|:
name|p
operator|->
name|qos_class
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|19
case|:
name|p
operator|->
name|sl
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
name|p
operator|->
name|mtu
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|p
operator|->
name|rate
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|20
case|:
name|p
operator|->
name|pkt_life
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|optarg
argument_list|)
operator|&&
operator|!
operator|(
name|optarg
operator|=
name|getpass
argument_list|(
literal|"Q_Key: "
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cannot get Q_Key\n"
argument_list|)
expr_stmt|;
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
block|}
name|p
operator|->
name|qkey
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|p
operator|->
name|tclass
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
name|p
operator|->
name|flow_label
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|p
operator|->
name|hop_limit
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|21
case|:
name|p
operator|->
name|scope
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'J'
case|:
name|p
operator|->
name|join_state
operator|=
operator|(
name|uint8_t
operator|)
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
name|p
operator|->
name|proxy_join
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|22
case|:
name|p
operator|->
name|service_id
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|23
case|:
name|p
operator|->
name|with_grh
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|24
case|:
name|p
operator|->
name|with_grh
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|optarg
argument_list|,
operator|&
name|p
operator|->
name|sa_dgid
argument_list|)
operator|<=
literal|0
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|ib_portid_t
name|portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|port
init|=
literal|0
decl_stmt|;
name|int
name|sa_cpi_required
init|=
literal|0
decl_stmt|;
name|char
name|usage_args
index|[
literal|1024
index|]
decl_stmt|;
name|struct
name|sa_handle
modifier|*
name|h
decl_stmt|;
name|struct
name|query_params
name|params
decl_stmt|;
specifier|const
name|struct
name|query_cmd
modifier|*
name|q
decl_stmt|;
name|int
name|status
decl_stmt|;
name|int
name|n
decl_stmt|;
specifier|const
name|struct
name|ibdiag_opt
name|opts
index|[]
init|=
block|{
block|{
literal|"p"
block|,
literal|'p'
block|,
literal|0
block|,
name|NULL
block|,
literal|"get PathRecord info"
block|}
block|,
block|{
literal|"N"
block|,
literal|'N'
block|,
literal|0
block|,
name|NULL
block|,
literal|"get NodeRecord info"
block|}
block|,
block|{
literal|"L"
block|,
literal|'L'
block|,
literal|0
block|,
name|NULL
block|,
literal|"return the Lids of the name specified"
block|}
block|,
block|{
literal|"l"
block|,
literal|'l'
block|,
literal|0
block|,
name|NULL
block|,
literal|"return the unique Lid of the name specified"
block|}
block|,
block|{
literal|"G"
block|,
literal|'G'
block|,
literal|0
block|,
name|NULL
block|,
literal|"return the Guids of the name specified"
block|}
block|,
block|{
literal|"O"
block|,
literal|'O'
block|,
literal|0
block|,
name|NULL
block|,
literal|"return name for the Lid specified"
block|}
block|,
block|{
literal|"U"
block|,
literal|'U'
block|,
literal|0
block|,
name|NULL
block|,
literal|"return name for the Guid specified"
block|}
block|,
block|{
literal|"s"
block|,
literal|'s'
block|,
literal|0
block|,
name|NULL
block|,
literal|"return the PortInfoRecords with isSM or"
literal|" isSMdisabled capability mask bit on"
block|}
block|,
block|{
literal|"g"
block|,
literal|'g'
block|,
literal|0
block|,
name|NULL
block|,
literal|"get multicast group info"
block|}
block|,
block|{
literal|"m"
block|,
literal|'m'
block|,
literal|0
block|,
name|NULL
block|,
literal|"get multicast member info (if multicast"
literal|" group specified, list member GIDs only for group specified,"
literal|" for example 'saquery -m 0xC000')"
block|}
block|,
block|{
literal|"x"
block|,
literal|'x'
block|,
literal|0
block|,
name|NULL
block|,
literal|"get LinkRecord info"
block|}
block|,
block|{
literal|"c"
block|,
literal|'c'
block|,
literal|0
block|,
name|NULL
block|,
literal|"get the SA's class port info"
block|}
block|,
block|{
literal|"S"
block|,
literal|'S'
block|,
literal|0
block|,
name|NULL
block|,
literal|"get ServiceRecord info"
block|}
block|,
block|{
literal|"I"
block|,
literal|'I'
block|,
literal|0
block|,
name|NULL
block|,
literal|"get InformInfoRecord (subscription) info"
block|}
block|,
block|{
literal|"list"
block|,
literal|'D'
block|,
literal|0
block|,
name|NULL
block|,
literal|"the node desc of the CA's"
block|}
block|,
block|{
literal|"with-grh"
block|,
literal|23
block|,
literal|0
block|,
name|NULL
block|,
literal|"add GRH to path record query"
block|}
block|,
block|{
literal|"sa-dgid"
block|,
literal|24
block|,
literal|1
block|,
literal|"<gid>"
block|,
literal|"Set destination GID (in IPv6 format) in the GRH"
block|}
block|,
block|{
literal|"src-to-dst"
block|,
literal|1
block|,
literal|1
block|,
literal|"<src:dst>"
block|,
literal|"get a PathRecord for"
literal|"<src:dst> where src and dst are either node names or LIDs"
block|}
block|,
block|{
literal|"sgid-to-dgid"
block|,
literal|2
block|,
literal|1
block|,
literal|"<sgid-dgid>"
block|,
literal|"get a PathRecord for"
literal|"<sgid-dgid> where sgid and dgid are addresses in IPv6 format"
block|}
block|,
block|{
literal|"node-name-map"
block|,
literal|3
block|,
literal|1
block|,
literal|"<file>"
block|,
literal|"specify a node name map file"
block|}
block|,
block|{
literal|"smkey"
block|,
literal|4
block|,
literal|1
block|,
literal|"<val>"
block|,
literal|"SA SM_Key value for the query."
literal|" If non-numeric value (like 'x') is specified then"
literal|" saquery will prompt for a value. "
literal|" Default (when not specified here or in ibdiag.conf) is to "
literal|" use SM_Key == 0 (or \"untrusted\")"
block|}
block|,
block|{
literal|"slid"
block|,
literal|5
block|,
literal|1
block|,
literal|"<lid>"
block|,
literal|"Source LID (PathRecord)"
block|}
block|,
block|{
literal|"dlid"
block|,
literal|6
block|,
literal|1
block|,
literal|"<lid>"
block|,
literal|"Destination LID (PathRecord)"
block|}
block|,
block|{
literal|"mlid"
block|,
literal|7
block|,
literal|1
block|,
literal|"<lid>"
block|,
literal|"Multicast LID (MCMemberRecord)"
block|}
block|,
block|{
literal|"sgid"
block|,
literal|14
block|,
literal|1
block|,
literal|"<gid>"
block|,
literal|"Source GID (IPv6 format) (PathRecord)"
block|}
block|,
block|{
literal|"dgid"
block|,
literal|15
block|,
literal|1
block|,
literal|"<gid>"
block|,
literal|"Destination GID (IPv6 format) (PathRecord)"
block|}
block|,
block|{
literal|"gid"
block|,
literal|16
block|,
literal|1
block|,
literal|"<gid>"
block|,
literal|"Port GID (MCMemberRecord)"
block|}
block|,
block|{
literal|"mgid"
block|,
literal|17
block|,
literal|1
block|,
literal|"<gid>"
block|,
literal|"Multicast GID (MCMemberRecord)"
block|}
block|,
block|{
literal|"reversible"
block|,
literal|'r'
block|,
literal|1
block|,
name|NULL
block|,
literal|"Reversible path (PathRecord)"
block|}
block|,
block|{
literal|"numb_path"
block|,
literal|'n'
block|,
literal|1
block|,
name|NULL
block|,
literal|"Number of paths (PathRecord)"
block|}
block|,
block|{
literal|"pkey"
block|,
literal|18
block|,
literal|1
block|,
name|NULL
block|,
literal|"P_Key (PathRecord, MCMemberRecord)."
literal|" If non-numeric value (like 'x') is specified then"
literal|" saquery will prompt for a value"
block|}
block|,
block|{
literal|"qos_class"
block|,
literal|'Q'
block|,
literal|1
block|,
name|NULL
block|,
literal|"QoS Class (PathRecord)"
block|}
block|,
block|{
literal|"sl"
block|,
literal|19
block|,
literal|1
block|,
name|NULL
block|,
literal|"Service level (PathRecord, MCMemberRecord)"
block|}
block|,
block|{
literal|"mtu"
block|,
literal|'M'
block|,
literal|1
block|,
name|NULL
block|,
literal|"MTU and selector (PathRecord, MCMemberRecord)"
block|}
block|,
block|{
literal|"rate"
block|,
literal|'R'
block|,
literal|1
block|,
name|NULL
block|,
literal|"Rate and selector (PathRecord, MCMemberRecord)"
block|}
block|,
block|{
literal|"pkt_lifetime"
block|,
literal|20
block|,
literal|1
block|,
name|NULL
block|,
literal|"Packet lifetime and selector (PathRecord, MCMemberRecord)"
block|}
block|,
block|{
literal|"qkey"
block|,
literal|'q'
block|,
literal|1
block|,
name|NULL
block|,
literal|"Q_Key (MCMemberRecord)."
literal|" If non-numeric value (like 'x') is specified then"
literal|" saquery will prompt for a value"
block|}
block|,
block|{
literal|"tclass"
block|,
literal|'T'
block|,
literal|1
block|,
name|NULL
block|,
literal|"Traffic Class (PathRecord, MCMemberRecord)"
block|}
block|,
block|{
literal|"flow_label"
block|,
literal|'F'
block|,
literal|1
block|,
name|NULL
block|,
literal|"Flow Label (PathRecord, MCMemberRecord)"
block|}
block|,
block|{
literal|"hop_limit"
block|,
literal|'H'
block|,
literal|1
block|,
name|NULL
block|,
literal|"Hop limit (PathRecord, MCMemberRecord)"
block|}
block|,
block|{
literal|"scope"
block|,
literal|21
block|,
literal|1
block|,
name|NULL
block|,
literal|"Scope (MCMemberRecord)"
block|}
block|,
block|{
literal|"join_state"
block|,
literal|'J'
block|,
literal|1
block|,
name|NULL
block|,
literal|"Join state (MCMemberRecord)"
block|}
block|,
block|{
literal|"proxy_join"
block|,
literal|'X'
block|,
literal|1
block|,
name|NULL
block|,
literal|"Proxy join (MCMemberRecord)"
block|}
block|,
block|{
literal|"service_id"
block|,
literal|22
block|,
literal|1
block|,
name|NULL
block|,
literal|"ServiceID (PathRecord)"
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|params
argument_list|)
expr_stmt|;
name|params
operator|.
name|hop_limit
operator|=
literal|0
expr_stmt|;
name|params
operator|.
name|reversible
operator|=
operator|-
literal|1
expr_stmt|;
name|params
operator|.
name|numb_path
operator|=
operator|-
literal|1
expr_stmt|;
name|params
operator|.
name|qos_class
operator|=
operator|-
literal|1
expr_stmt|;
name|params
operator|.
name|sl
operator|=
operator|-
literal|1
expr_stmt|;
name|params
operator|.
name|proxy_join
operator|=
operator|-
literal|1
expr_stmt|;
name|n
operator|=
name|sprintf
argument_list|(
name|usage_args
argument_list|,
literal|"[query-name] [<name> |<lid> |<guid>]\n"
literal|"\nSupported query names (and aliases):\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
name|query_cmds
init|;
name|q
operator|->
name|name
condition|;
name|q
operator|++
control|)
block|{
name|n
operator|+=
name|snprintf
argument_list|(
name|usage_args
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|usage_args
argument_list|)
operator|-
name|n
argument_list|,
literal|"  %s (%s) %s\n"
argument_list|,
name|q
operator|->
name|name
argument_list|,
name|q
operator|->
name|alias
condition|?
name|q
operator|->
name|alias
else|:
literal|""
argument_list|,
name|q
operator|->
name|usage
condition|?
name|q
operator|->
name|usage
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
sizeof|sizeof
argument_list|(
name|usage_args
argument_list|)
condition|)
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|usage_args
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|usage_args
argument_list|)
operator|-
name|n
argument_list|,
literal|"\n  Queries node records by default."
argument_list|)
expr_stmt|;
name|q
operator|=
name|NULL
expr_stmt|;
name|ibd_timeout
operator|=
name|DEFAULT_SA_TIMEOUT_MS
expr_stmt|;
name|ibdiag_process_opts
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|params
argument_list|,
literal|"DGLsy"
argument_list|,
name|opts
argument_list|,
name|process_opt
argument_list|,
name|usage_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
operator|!
name|query_type
operator|&&
name|command
operator|==
name|SAQUERY_CMD_QUERY
condition|)
block|{
if|if
condition|(
operator|!
name|argc
operator|||
operator|!
operator|(
name|q
operator|=
name|find_query
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
operator|)
condition|)
name|query_type
operator|=
name|IB_SA_ATTR_NODERECORD
expr_stmt|;
else|else
block|{
name|query_type
operator|=
name|q
operator|->
name|query_type
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|argc
condition|)
block|{
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_LID
condition|)
block|{
name|requested_lid
operator|=
operator|(
name|uint16_t
operator|)
name|strtoul
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|requested_lid_flag
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_GUID
condition|)
block|{
name|requested_guid
operator|=
name|strtoul
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|requested_guid_flag
operator|++
expr_stmt|;
block|}
else|else
name|requested_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|node_print_desc
operator|==
name|LID_ONLY
operator|||
name|node_print_desc
operator|==
name|UNIQUE_LID_ONLY
operator|||
name|node_print_desc
operator|==
name|GUID_ONLY
operator|)
operator|&&
operator|!
name|requested_name
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: name not specified\n"
argument_list|)
expr_stmt|;
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_LID
operator|&&
operator|!
name|requested_lid_flag
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: lid not specified\n"
argument_list|)
expr_stmt|;
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_GUID
operator|&&
operator|!
name|requested_guid_flag
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: guid not specified\n"
argument_list|)
expr_stmt|;
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
block|}
comment|/* Note: lid cannot be 0; see infiniband spec 4.1.3 */
if|if
condition|(
name|node_print_desc
operator|==
name|NAME_OF_LID
operator|&&
operator|!
name|requested_lid
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: lid invalid\n"
argument_list|)
expr_stmt|;
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|umad_init
argument_list|()
condition|)
name|IBEXIT
argument_list|(
literal|"Failed to initialized umad library"
argument_list|)
expr_stmt|;
name|h
operator|=
name|sa_get_handle
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|h
condition|)
name|IBPANIC
argument_list|(
literal|"Failed to bind to the SA"
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|with_grh
condition|)
block|{
name|ibmad_gid_t
name|gid
init|=
block|{
literal|0
block|}
decl_stmt|;
comment|/* 		 * If GRH destination GID is not specified, try to get it by 		 * querying the SA. 		 */
if|if
condition|(
operator|!
name|memcmp
argument_list|(
operator|&
name|gid
argument_list|,
operator|&
name|params
operator|.
name|sa_dgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ibmad_gid_t
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|=
name|resolve_self
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
operator|&
name|portid
argument_list|,
operator|&
name|port
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"can't resolve self port %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|(
name|status
operator|=
name|sm_pr_query
argument_list|(
name|h
argument_list|,
operator|&
name|gid
argument_list|,
name|portid
operator|.
name|lid
argument_list|,
name|h
operator|->
name|dport
operator|.
name|lid
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to query SA:PathRecord\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
else|else
name|memcpy
argument_list|(
operator|&
name|gid
argument_list|,
operator|&
name|params
operator|.
name|sa_dgid
argument_list|,
sizeof|sizeof
argument_list|(
name|ibmad_gid_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|sa_set_handle
argument_list|(
name|h
argument_list|,
literal|1
argument_list|,
operator|&
name|gid
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to set GRH\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
name|node_name_map
operator|=
name|open_node_name_map
argument_list|(
name|node_name_map_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|src_lid
operator|&&
operator|*
name|src_lid
condition|)
name|params
operator|.
name|slid
operator|=
name|get_lid
argument_list|(
name|h
argument_list|,
name|src_lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst_lid
operator|&&
operator|*
name|dst_lid
condition|)
name|params
operator|.
name|dlid
operator|=
name|get_lid
argument_list|(
name|h
argument_list|,
name|dst_lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
operator|==
name|SAQUERY_CMD_CLASS_PORT_INFO
operator|||
name|query_type
operator|==
name|CLASS_PORT_INFO
operator|||
name|query_type
operator|==
name|IB_SA_ATTR_SWITCHINFORECORD
condition|)
name|sa_cpi_required
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sa_cpi_required
operator|&&
operator|(
name|status
operator|=
name|query_sa_cpi
argument_list|(
name|h
argument_list|,
operator|&
name|params
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to query SA:ClassPortInfo\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SAQUERY_CMD_NODE_RECORD
case|:
name|status
operator|=
name|print_node_records
argument_list|(
name|h
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAQUERY_CMD_CLASS_PORT_INFO
case|:
name|dump_class_port_info
argument_list|(
operator|&
name|params
operator|.
name|cpi
argument_list|)
expr_stmt|;
name|status
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SAQUERY_CMD_ISSM
case|:
name|status
operator|=
name|print_issm_records
argument_list|(
name|h
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAQUERY_CMD_MCGROUPS
case|:
name|status
operator|=
name|print_multicast_group_records
argument_list|(
name|h
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
break|break;
case|case
name|SAQUERY_CMD_MCMEMBERS
case|:
name|status
operator|=
name|print_multicast_member_records
argument_list|(
name|h
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|(
operator|!
name|q
operator|&&
operator|!
operator|(
name|q
operator|=
name|find_query_by_type
argument_list|(
name|query_type
argument_list|)
operator|)
operator|)
operator|||
operator|!
name|q
operator|->
name|handler
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown query type %d\n"
argument_list|,
name|ntohs
argument_list|(
name|query_type
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
name|status
operator|=
name|q
operator|->
name|handler
argument_list|(
name|q
argument_list|,
name|h
argument_list|,
operator|&
name|params
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
break|break;
block|}
name|error
label|:
if|if
condition|(
name|src_lid
condition|)
name|free
argument_list|(
name|src_lid
argument_list|)
expr_stmt|;
name|sa_free_handle
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|umad_done
argument_list|()
expr_stmt|;
name|close_node_name_map
argument_list|(
name|node_name_map
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

end_unit


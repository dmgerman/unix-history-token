begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire Inc.  All rights reserved.  * Copyright (c) 2007 Xsigo Systems Inc.  All rights reserved.  * Copyright (c) 2008 Lawrence Livermore National Lab.  All rights reserved.  * Copyright (c) 2009 HNR Consulting.  All rights reserved.  * Copyright (c) 2010,2011 Mellanox Technologies LTD.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_nodenamemap.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/ibnetdisc.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/mad.h>
end_include

begin_include
include|#
directive|include
file|"ibdiag_common.h"
end_include

begin_include
include|#
directive|include
file|"ibdiag_sa.h"
end_include

begin_decl_stmt
name|struct
name|ibmad_port
modifier|*
name|ibmad_port
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|node_name_map_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|nn_map_t
modifier|*
name|node_name_map
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|load_cache_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|lid2sl_table
index|[
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
literal|1024
operator|*
literal|48
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|obtain_sl
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|data_counters
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|data_counters_only
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|port_config
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|port_guid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|port_guid_str
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SUP_MAX
value|64
end_define

begin_decl_stmt
name|int
name|sup_total
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|enum
name|MAD_FIELDS
name|suppressed_fields
index|[
name|SUP_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|dr_path
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint8_t
name|node_type_to_print
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|clear_errors
init|=
literal|0
decl_stmt|,
name|clear_counts
init|=
literal|0
decl_stmt|,
name|details
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PRINT_SWITCH
value|0x1
end_define

begin_define
define|#
directive|define
name|PRINT_CA
value|0x2
end_define

begin_define
define|#
directive|define
name|PRINT_ROUTER
value|0x4
end_define

begin_define
define|#
directive|define
name|PRINT_ALL
value|0xFF
end_define

begin_comment
comment|/* all nodes default flag */
end_comment

begin_define
define|#
directive|define
name|DEFAULT_HALF_WORLD_PR_TIMEOUT
value|(3000)
end_define

begin_struct
struct|struct
block|{
name|int
name|nodes_checked
decl_stmt|;
name|int
name|bad_nodes
decl_stmt|;
name|int
name|ports_checked
decl_stmt|;
name|int
name|bad_ports
decl_stmt|;
name|int
name|pma_query_failures
decl_stmt|;
block|}
name|summary
init|=
block|{
literal|0
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DEF_THRES_FILE
value|IBDIAG_CONFIG_PATH"/error_thresholds"
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|threshold_file
init|=
name|DEF_THRES_FILE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* define a "packet" with threshold values in it */
end_comment

begin_decl_stmt
name|uint8_t
name|thresholds
index|[
literal|1204
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|threshold_str
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|unsigned
name|valid_gid
parameter_list|(
name|ib_gid_t
modifier|*
name|gid
parameter_list|)
block|{
name|ib_gid_t
name|zero_gid
decl_stmt|;
name|memset
argument_list|(
operator|&
name|zero_gid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|zero_gid
argument_list|)
expr_stmt|;
return|return
name|memcmp
argument_list|(
operator|&
name|zero_gid
argument_list|,
name|gid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|gid
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_thres
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|int
name|f
decl_stmt|;
name|int
name|n
decl_stmt|;
name|char
name|tmp
index|[
literal|256
index|]
decl_stmt|;
for|for
control|(
name|f
operator|=
name|IB_PC_FIRST_F
init|;
name|f
operator|<=
name|IB_PC_LAST_F
condition|;
name|f
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|mad_field_name
argument_list|(
name|f
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mad_encode_field
argument_list|(
name|thresholds
argument_list|,
name|f
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|tmp
argument_list|,
literal|255
argument_list|,
literal|"[%s = %u]"
argument_list|,
name|name
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|threshold_str
operator|=
name|realloc
argument_list|(
name|threshold_str
argument_list|,
name|strlen
argument_list|(
name|threshold_str
argument_list|)
operator|+
name|strlen
argument_list|(
name|tmp
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|threshold_str
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to allocate memory: "
literal|"%s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|n
operator|=
name|strlen
argument_list|(
name|threshold_str
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|threshold_str
operator|+
name|n
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_thresholds
parameter_list|(
name|char
modifier|*
name|threshold_file
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|val
init|=
literal|0
decl_stmt|;
name|FILE
modifier|*
name|thresf
init|=
name|fopen
argument_list|(
name|threshold_file
argument_list|,
literal|"r"
argument_list|)
decl_stmt|;
name|char
modifier|*
name|p_prefix
decl_stmt|,
modifier|*
name|p_last
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|val_str
decl_stmt|;
name|char
name|str
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|thresf
condition|)
return|return;
name|snprintf
argument_list|(
name|str
argument_list|,
literal|63
argument_list|,
literal|"Thresholds: "
argument_list|)
expr_stmt|;
name|threshold_str
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|str
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|threshold_str
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to allocate memory: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|threshold_str
argument_list|,
name|str
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|thresf
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|p_prefix
operator|=
name|strtok_r
argument_list|(
name|buf
argument_list|,
literal|"\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_prefix
condition|)
continue|continue;
comment|/* ignore blank lines */
if|if
condition|(
operator|*
name|p_prefix
operator|==
literal|'#'
condition|)
continue|continue;
comment|/* ignore comment lines */
name|name
operator|=
name|strtok_r
argument_list|(
name|p_prefix
argument_list|,
literal|"="
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
name|val_str
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|"\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
name|val
operator|=
name|strtoul
argument_list|(
name|val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_thres
argument_list|(
name|name
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|thresf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|exceeds_threshold
parameter_list|(
name|int
name|field
parameter_list|,
name|unsigned
name|val
parameter_list|)
block|{
name|uint32_t
name|thres
init|=
literal|0
decl_stmt|;
name|mad_decode_field
argument_list|(
name|thresholds
argument_list|,
name|field
argument_list|,
operator|&
name|thres
argument_list|)
expr_stmt|;
return|return
operator|(
name|val
operator|>
name|thres
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_port_config
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|int
name|portnum
parameter_list|)
block|{
name|char
name|width
index|[
literal|64
index|]
decl_stmt|,
name|speed
index|[
literal|64
index|]
decl_stmt|,
name|state
index|[
literal|64
index|]
decl_stmt|,
name|physstate
index|[
literal|64
index|]
decl_stmt|;
name|char
name|remote_str
index|[
literal|256
index|]
decl_stmt|;
name|char
name|link_str
index|[
literal|256
index|]
decl_stmt|;
name|char
name|width_msg
index|[
literal|256
index|]
decl_stmt|;
name|char
name|speed_msg
index|[
literal|256
index|]
decl_stmt|;
name|char
name|ext_port_str
index|[
literal|256
index|]
decl_stmt|;
name|int
name|iwidth
decl_stmt|,
name|ispeed
decl_stmt|,
name|fdr10
decl_stmt|,
name|espeed
decl_stmt|,
name|istate
decl_stmt|,
name|iphystate
decl_stmt|,
name|cap_mask
decl_stmt|;
name|uint8_t
modifier|*
name|info
decl_stmt|;
name|ibnd_port_t
modifier|*
name|port
init|=
name|node
operator|->
name|ports
index|[
name|portnum
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|port
condition|)
return|return;
name|iwidth
operator|=
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_WIDTH_ACTIVE_F
argument_list|)
expr_stmt|;
name|ispeed
operator|=
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|)
expr_stmt|;
name|fdr10
operator|=
name|mad_get_field
argument_list|(
name|port
operator|->
name|ext_info
argument_list|,
literal|0
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_ACTIVE_F
argument_list|)
operator|&
name|FDR10
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
name|info
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|port
operator|->
name|node
operator|->
name|ports
index|[
literal|0
index|]
operator|->
name|info
expr_stmt|;
else|else
name|info
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|port
operator|->
name|info
expr_stmt|;
name|cap_mask
operator|=
name|mad_get_field
argument_list|(
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_CAPMASK_F
argument_list|)
expr_stmt|;
if|if
condition|(
name|cap_mask
operator|&
name|CL_NTOH32
argument_list|(
name|IB_PORT_CAP_HAS_EXT_SPEEDS
argument_list|)
condition|)
name|espeed
operator|=
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_ACTIVE_F
argument_list|)
expr_stmt|;
else|else
name|espeed
operator|=
literal|0
expr_stmt|;
name|istate
operator|=
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_STATE_F
argument_list|)
expr_stmt|;
name|iphystate
operator|=
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_PHYS_STATE_F
argument_list|)
expr_stmt|;
name|remote_str
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|link_str
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|width_msg
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|speed_msg
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* C14-24.2.1 states that a down port allows for invalid data to be 	 * returned for all PortInfo components except PortState and 	 * PortPhysicalState */
if|if
condition|(
name|istate
operator|!=
name|IB_LINK_DOWN
condition|)
block|{
if|if
condition|(
operator|!
name|espeed
condition|)
block|{
if|if
condition|(
name|fdr10
condition|)
name|sprintf
argument_list|(
name|speed
argument_list|,
literal|"10.0 Gbps (FDR10)"
argument_list|)
expr_stmt|;
else|else
name|mad_dump_val
argument_list|(
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|,
name|speed
argument_list|,
literal|64
argument_list|,
operator|&
name|ispeed
argument_list|)
expr_stmt|;
block|}
else|else
name|mad_dump_val
argument_list|(
name|IB_PORT_LINK_SPEED_EXT_ACTIVE_F
argument_list|,
name|speed
argument_list|,
literal|64
argument_list|,
operator|&
name|espeed
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|link_str
argument_list|,
literal|256
argument_list|,
literal|"(%3s %18s %6s/%8s)"
argument_list|,
name|mad_dump_val
argument_list|(
name|IB_PORT_LINK_WIDTH_ACTIVE_F
argument_list|,
name|width
argument_list|,
literal|64
argument_list|,
operator|&
name|iwidth
argument_list|)
argument_list|,
name|speed
argument_list|,
name|mad_dump_val
argument_list|(
name|IB_PORT_STATE_F
argument_list|,
name|state
argument_list|,
literal|64
argument_list|,
operator|&
name|istate
argument_list|)
argument_list|,
name|mad_dump_val
argument_list|(
name|IB_PORT_PHYS_STATE_F
argument_list|,
name|physstate
argument_list|,
literal|64
argument_list|,
operator|&
name|iphystate
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|link_str
argument_list|,
literal|256
argument_list|,
literal|"(              %6s/%8s)"
argument_list|,
name|mad_dump_val
argument_list|(
name|IB_PORT_STATE_F
argument_list|,
name|state
argument_list|,
literal|64
argument_list|,
operator|&
name|istate
argument_list|)
argument_list|,
name|mad_dump_val
argument_list|(
name|IB_PORT_PHYS_STATE_F
argument_list|,
name|physstate
argument_list|,
literal|64
argument_list|,
operator|&
name|iphystate
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|port
operator|->
name|remoteport
condition|)
block|{
name|char
modifier|*
name|rem_node_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|port
operator|->
name|remoteport
operator|->
name|ext_portnum
condition|)
name|snprintf
argument_list|(
name|ext_port_str
argument_list|,
literal|256
argument_list|,
literal|"%d"
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|ext_portnum
argument_list|)
expr_stmt|;
else|else
name|ext_port_str
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|get_max_msg
argument_list|(
name|width_msg
argument_list|,
name|speed_msg
argument_list|,
literal|256
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|rem_node_name
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|guid
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|remote_str
argument_list|,
literal|256
argument_list|,
literal|"0x%016"
name|PRIx64
literal|" %6d %4d[%2s] \"%s\" (%s %s)\n"
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|guid
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|base_lid
condition|?
name|port
operator|->
name|remoteport
operator|->
name|base_lid
else|:
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|smalid
argument_list|,
name|port
operator|->
name|remoteport
operator|->
name|portnum
argument_list|,
name|ext_port_str
argument_list|,
name|rem_node_name
argument_list|,
name|width_msg
argument_list|,
name|speed_msg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rem_node_name
argument_list|)
expr_stmt|;
block|}
else|else
name|snprintf
argument_list|(
name|remote_str
argument_list|,
literal|256
argument_list|,
literal|"           [  ] \"\" ( )\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|ext_portnum
condition|)
name|snprintf
argument_list|(
name|ext_port_str
argument_list|,
literal|256
argument_list|,
literal|"%d"
argument_list|,
name|port
operator|->
name|ext_portnum
argument_list|)
expr_stmt|;
else|else
name|ext_port_str
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
name|printf
argument_list|(
literal|"       Link info: %6d"
argument_list|,
name|node
operator|->
name|smalid
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"       Link info: %6d"
argument_list|,
name|port
operator|->
name|base_lid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4d[%2s] ==%s==>  %s"
argument_list|,
name|port
operator|->
name|portnum
argument_list|,
name|ext_port_str
argument_list|,
name|link_str
argument_list|,
name|remote_str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|suppress
parameter_list|(
name|enum
name|MAD_FIELDS
name|field
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sup_total
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|field
operator|==
name|suppressed_fields
index|[
name|i
index|]
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|report_suppressed
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|printf
argument_list|(
literal|"## Suppressed:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sup_total
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|mad_field_name
argument_list|(
name|suppressed_fields
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_summary
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\n## Summary: %d nodes checked, %d bad nodes found\n"
argument_list|,
name|summary
operator|.
name|nodes_checked
argument_list|,
name|summary
operator|.
name|bad_nodes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"##          %d ports checked, %d ports have errors beyond threshold\n"
argument_list|,
name|summary
operator|.
name|ports_checked
argument_list|,
name|summary
operator|.
name|bad_ports
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"## %s\n"
argument_list|,
name|threshold_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|summary
operator|.
name|pma_query_failures
condition|)
name|printf
argument_list|(
literal|"##          %d PMA query failures\n"
argument_list|,
name|summary
operator|.
name|pma_query_failures
argument_list|)
expr_stmt|;
name|report_suppressed
argument_list|()
expr_stmt|;
return|return
operator|(
name|summary
operator|.
name|bad_ports
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|insert_lid2sl_table
parameter_list|(
name|struct
name|sa_query_result
modifier|*
name|r
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|r
operator|->
name|result_cnt
condition|;
name|i
operator|++
control|)
block|{
name|ib_path_rec_t
modifier|*
name|p_pr
init|=
operator|(
name|ib_path_rec_t
operator|*
operator|)
name|sa_get_query_rec
argument_list|(
name|r
operator|->
name|p_result_madw
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|lid2sl_table
index|[
name|cl_ntoh16
argument_list|(
name|p_pr
operator|->
name|dlid
argument_list|)
index|]
operator|=
name|ib_path_rec_sl
argument_list|(
name|p_pr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|path_record_query
parameter_list|(
name|ib_gid_t
name|sgid
parameter_list|,
name|uint64_t
name|dguid
parameter_list|)
block|{
name|ib_path_rec_t
name|pr
decl_stmt|;
name|ib_net64_t
name|comp_mask
init|=
literal|0
decl_stmt|;
name|uint8_t
name|reversible
init|=
literal|0
decl_stmt|;
name|struct
name|sa_handle
modifier|*
name|h
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|h
operator|=
name|sa_get_handle
argument_list|()
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|ibd_timeout
operator|=
name|DEFAULT_HALF_WORLD_PR_TIMEOUT
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_GID
argument_list|(
name|sgid
argument_list|,
name|pr
operator|.
name|sgid
argument_list|,
name|PR
argument_list|,
name|SGID
argument_list|)
expr_stmt|;
if|if
condition|(
name|dguid
condition|)
block|{
name|mad_encode_field
argument_list|(
name|sgid
operator|.
name|raw
argument_list|,
name|IB_GID_GUID_F
argument_list|,
operator|&
name|dguid
argument_list|)
expr_stmt|;
name|CHECK_AND_SET_GID
argument_list|(
name|sgid
argument_list|,
name|pr
operator|.
name|dgid
argument_list|,
name|PR
argument_list|,
name|DGID
argument_list|)
expr_stmt|;
block|}
name|CHECK_AND_SET_VAL
argument_list|(
literal|1
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|pr
operator|.
name|num_path
argument_list|,
name|PR
argument_list|,
name|NUMBPATH
argument_list|)
expr_stmt|;
comment|/*to get only one PathRecord for each source and destination pair*/
name|CHECK_AND_SET_VAL
argument_list|(
literal|1
argument_list|,
literal|8
argument_list|,
operator|-
literal|1
argument_list|,
name|reversible
argument_list|,
name|PR
argument_list|,
name|REVERSIBLE
argument_list|)
expr_stmt|;
comment|/*for a reversible path*/
name|pr
operator|.
name|num_path
operator||=
name|reversible
operator|<<
literal|7
expr_stmt|;
name|struct
name|sa_query_result
name|result
decl_stmt|;
name|int
name|ret
init|=
name|sa_query
argument_list|(
name|h
argument_list|,
name|IB_MAD_METHOD_GET_TABLE
argument_list|,
operator|(
name|uint16_t
operator|)
name|IB_SA_ATTR_PATHRECORD
argument_list|,
literal|0
argument_list|,
name|cl_ntoh64
argument_list|(
name|comp_mask
argument_list|)
argument_list|,
name|ibd_sakey
argument_list|,
operator|&
name|pr
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
argument_list|)
argument_list|,
operator|&
name|result
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|sa_free_handle
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Query SA failed: %s; sa call path_query failed\n"
argument_list|,
name|strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|result
operator|.
name|status
operator|!=
name|IB_SA_MAD_STATUS_SUCCESS
condition|)
block|{
name|sa_report_err
argument_list|(
name|result
operator|.
name|status
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|insert_lid2sl_table
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
name|Exit
label|:
name|sa_free_handle
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|sa_free_result_mad
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_and_dump
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|char
modifier|*
name|node_name
parameter_list|,
name|int
name|portnum
parameter_list|,
specifier|const
name|char
modifier|*
name|attr_name
parameter_list|,
name|uint16_t
name|attr_id
parameter_list|,
name|int
name|start_field
parameter_list|,
name|int
name|end_field
parameter_list|)
block|{
name|uint8_t
name|pc
index|[
literal|1024
index|]
decl_stmt|;
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|memset
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pma_query_via
argument_list|(
name|pc
argument_list|,
name|portid
argument_list|,
name|portnum
argument_list|,
name|ibd_timeout
argument_list|,
name|attr_id
argument_list|,
name|ibmad_port
argument_list|)
condition|)
block|{
name|IBWARN
argument_list|(
literal|"%s query failed on %s, %s port %d"
argument_list|,
name|attr_name
argument_list|,
name|node_name
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|summary
operator|.
name|pma_query_failures
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|n
operator|=
literal|0
operator|,
name|i
operator|=
name|start_field
init|;
name|i
operator|<
name|end_field
condition|;
name|i
operator|++
control|)
block|{
name|mad_decode_field
argument_list|(
name|pc
argument_list|,
name|i
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
name|n
operator|+=
name|snprintf
argument_list|(
name|buf
operator|+
name|n
argument_list|,
name|size
operator|-
name|n
argument_list|,
literal|" [%s == %u]"
argument_list|,
name|mad_field_name
argument_list|(
name|i
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
return|return
name|n
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_results
parameter_list|(
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|char
modifier|*
name|node_name
parameter_list|,
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|uint8_t
modifier|*
name|pc
parameter_list|,
name|int
name|portnum
parameter_list|,
name|int
modifier|*
name|header_printed
parameter_list|,
name|uint8_t
modifier|*
name|pce
parameter_list|,
name|uint16_t
name|cap_mask
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|str
init|=
name|buf
decl_stmt|;
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
operator|,
name|i
operator|=
name|IB_PC_ERR_SYM_F
init|;
name|i
operator|<=
name|IB_PC_VL15_DROPPED_F
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|suppress
argument_list|(
name|i
argument_list|)
condition|)
continue|continue;
comment|/* this is not a counter, skip it */
if|if
condition|(
name|i
operator|==
name|IB_PC_COUNTER_SELECT2_F
condition|)
continue|continue;
name|mad_decode_field
argument_list|(
name|pc
argument_list|,
name|i
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|exceeds_threshold
argument_list|(
name|i
argument_list|,
name|val
argument_list|)
condition|)
block|{
name|n
operator|+=
name|snprintf
argument_list|(
name|str
operator|+
name|n
argument_list|,
literal|1024
operator|-
name|n
argument_list|,
literal|" [%s == %u]"
argument_list|,
name|mad_field_name
argument_list|(
name|i
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* If there are PortXmitDiscards, get details (if supported) */
if|if
condition|(
name|i
operator|==
name|IB_PC_XMT_DISCARDS_F
operator|&&
name|details
condition|)
block|{
name|n
operator|+=
name|query_and_dump
argument_list|(
name|str
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|n
argument_list|,
name|portid
argument_list|,
name|node_name
argument_list|,
name|portnum
argument_list|,
literal|"PortXmitDiscardDetails"
argument_list|,
name|IB_GSI_PORT_XMIT_DISCARD_DETAILS
argument_list|,
name|IB_PC_RCV_LOCAL_PHY_ERR_F
argument_list|,
name|IB_PC_RCV_ERR_LAST_F
argument_list|)
expr_stmt|;
comment|/* If there are PortRcvErrors, get details (if supported) */
block|}
elseif|else
if|if
condition|(
name|i
operator|==
name|IB_PC_ERR_RCV_F
operator|&&
name|details
condition|)
block|{
name|n
operator|+=
name|query_and_dump
argument_list|(
name|str
operator|+
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|n
argument_list|,
name|portid
argument_list|,
name|node_name
argument_list|,
name|portnum
argument_list|,
literal|"PortRcvErrorDetails"
argument_list|,
name|IB_GSI_PORT_RCV_ERROR_DETAILS
argument_list|,
name|IB_PC_XMT_INACT_DISC_F
argument_list|,
name|IB_PC_XMT_DISC_LAST_F
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|suppress
argument_list|(
name|IB_PC_XMT_WAIT_F
argument_list|)
condition|)
block|{
name|mad_decode_field
argument_list|(
name|pc
argument_list|,
name|IB_PC_XMT_WAIT_F
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|exceeds_threshold
argument_list|(
name|IB_PC_XMT_WAIT_F
argument_list|,
name|val
argument_list|)
condition|)
name|n
operator|+=
name|snprintf
argument_list|(
name|str
operator|+
name|n
argument_list|,
literal|1024
operator|-
name|n
argument_list|,
literal|" [%s == %u]"
argument_list|,
name|mad_field_name
argument_list|(
name|IB_PC_XMT_WAIT_F
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* if we found errors. */
if|if
condition|(
name|n
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|data_counters
condition|)
block|{
name|uint8_t
modifier|*
name|pkt
init|=
name|pc
decl_stmt|;
name|int
name|start_field
init|=
name|IB_PC_XMT_BYTES_F
decl_stmt|;
name|int
name|end_field
init|=
name|IB_PC_RCV_PKTS_F
decl_stmt|;
if|if
condition|(
name|pce
condition|)
block|{
name|pkt
operator|=
name|pce
expr_stmt|;
name|start_field
operator|=
name|IB_PC_EXT_XMT_BYTES_F
expr_stmt|;
if|if
condition|(
name|cap_mask
operator|&
name|IB_PM_EXT_WIDTH_SUPPORTED
condition|)
name|end_field
operator|=
name|IB_PC_EXT_RCV_MPKTS_F
expr_stmt|;
else|else
name|end_field
operator|=
name|IB_PC_EXT_RCV_PKTS_F
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|start_field
init|;
name|i
operator|<=
name|end_field
condition|;
name|i
operator|++
control|)
block|{
name|uint64_t
name|val64
init|=
literal|0
decl_stmt|;
name|float
name|val
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|unit
init|=
literal|""
decl_stmt|;
name|mad_decode_field
argument_list|(
name|pkt
argument_list|,
name|i
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|val64
argument_list|)
expr_stmt|;
if|if
condition|(
name|val64
condition|)
block|{
name|int
name|data
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|i
operator|==
name|IB_PC_EXT_XMT_BYTES_F
operator|||
name|i
operator|==
name|IB_PC_EXT_RCV_BYTES_F
operator|||
name|i
operator|==
name|IB_PC_XMT_BYTES_F
operator|||
name|i
operator|==
name|IB_PC_RCV_BYTES_F
condition|)
name|data
operator|=
literal|1
expr_stmt|;
name|unit
operator|=
name|conv_cnt_human_readable
argument_list|(
name|val64
argument_list|,
operator|&
name|val
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|n
operator|+=
name|snprintf
argument_list|(
name|str
operator|+
name|n
argument_list|,
literal|1024
operator|-
name|n
argument_list|,
literal|" [%s == %"
name|PRIu64
literal|" (%5.3f%s)]"
argument_list|,
name|mad_field_name
argument_list|(
name|i
argument_list|)
argument_list|,
name|val64
argument_list|,
name|val
argument_list|,
name|unit
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
operator|*
name|header_printed
condition|)
block|{
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
name|printf
argument_list|(
literal|"Errors for 0x%"
name|PRIx64
literal|" \"%s\"\n"
argument_list|,
name|node
operator|->
name|ports
index|[
literal|0
index|]
operator|->
name|guid
argument_list|,
name|node_name
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Errors for \"%s\"\n"
argument_list|,
name|node_name
argument_list|)
expr_stmt|;
operator|*
name|header_printed
operator|=
literal|1
expr_stmt|;
name|summary
operator|.
name|bad_nodes
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|portnum
operator|==
literal|0xFF
condition|)
block|{
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
name|printf
argument_list|(
literal|"   GUID 0x%"
name|PRIx64
literal|" port ALL:%s\n"
argument_list|,
name|node
operator|->
name|ports
index|[
literal|0
index|]
operator|->
name|guid
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"   GUID 0x%"
name|PRIx64
literal|" port %d:%s\n"
argument_list|,
name|node
operator|->
name|ports
index|[
name|portnum
index|]
operator|->
name|guid
argument_list|,
name|portnum
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_config
condition|)
name|print_port_config
argument_list|(
name|node
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|summary
operator|.
name|bad_ports
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|n
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|query_cap_mask
parameter_list|(
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|char
modifier|*
name|node_name
parameter_list|,
name|int
name|portnum
parameter_list|,
name|uint16_t
modifier|*
name|cap_mask
parameter_list|)
block|{
name|uint8_t
name|pc
index|[
literal|1024
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint16_t
name|rc_cap_mask
decl_stmt|;
name|portid
operator|->
name|sl
operator|=
name|lid2sl_table
index|[
name|portid
operator|->
name|lid
index|]
expr_stmt|;
comment|/* PerfMgt ClassPortInfo is a required attribute */
if|if
condition|(
operator|!
name|pma_query_via
argument_list|(
name|pc
argument_list|,
name|portid
argument_list|,
name|portnum
argument_list|,
name|ibd_timeout
argument_list|,
name|CLASS_PORT_INFO
argument_list|,
name|ibmad_port
argument_list|)
condition|)
block|{
name|IBWARN
argument_list|(
literal|"classportinfo query failed on %s, %s port %d"
argument_list|,
name|node_name
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|summary
operator|.
name|pma_query_failures
operator|++
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* ClassPortInfo should be supported as part of libibmad */
name|memcpy
argument_list|(
operator|&
name|rc_cap_mask
argument_list|,
name|pc
operator|+
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|rc_cap_mask
argument_list|)
argument_list|)
expr_stmt|;
comment|/* CapabilityMask */
operator|*
name|cap_mask
operator|=
name|rc_cap_mask
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_data_cnts
parameter_list|(
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|uint16_t
name|cap_mask
parameter_list|,
name|char
modifier|*
name|node_name
parameter_list|,
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|int
name|portnum
parameter_list|,
name|int
modifier|*
name|header_printed
parameter_list|)
block|{
name|uint8_t
name|pc
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|start_field
init|=
name|IB_PC_XMT_BYTES_F
decl_stmt|;
name|int
name|end_field
init|=
name|IB_PC_RCV_PKTS_F
decl_stmt|;
name|memset
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|portid
operator|->
name|sl
operator|=
name|lid2sl_table
index|[
name|portid
operator|->
name|lid
index|]
expr_stmt|;
if|if
condition|(
name|cap_mask
operator|&
operator|(
name|IB_PM_EXT_WIDTH_SUPPORTED
operator||
name|IB_PM_EXT_WIDTH_NOIETF_SUP
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|pma_query_via
argument_list|(
name|pc
argument_list|,
name|portid
argument_list|,
name|portnum
argument_list|,
name|ibd_timeout
argument_list|,
name|IB_GSI_PORT_COUNTERS_EXT
argument_list|,
name|ibmad_port
argument_list|)
condition|)
block|{
name|IBWARN
argument_list|(
literal|"IB_GSI_PORT_COUNTERS_EXT query failed on %s, %s port %d"
argument_list|,
name|node_name
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|summary
operator|.
name|pma_query_failures
operator|++
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|start_field
operator|=
name|IB_PC_EXT_XMT_BYTES_F
expr_stmt|;
if|if
condition|(
name|cap_mask
operator|&
name|IB_PM_EXT_WIDTH_SUPPORTED
condition|)
name|end_field
operator|=
name|IB_PC_EXT_RCV_MPKTS_F
expr_stmt|;
else|else
name|end_field
operator|=
name|IB_PC_EXT_RCV_PKTS_F
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|pma_query_via
argument_list|(
name|pc
argument_list|,
name|portid
argument_list|,
name|portnum
argument_list|,
name|ibd_timeout
argument_list|,
name|IB_GSI_PORT_COUNTERS
argument_list|,
name|ibmad_port
argument_list|)
condition|)
block|{
name|IBWARN
argument_list|(
literal|"IB_GSI_PORT_COUNTERS query failed on %s, %s port %d"
argument_list|,
name|node_name
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|summary
operator|.
name|pma_query_failures
operator|++
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|start_field
operator|=
name|IB_PC_XMT_BYTES_F
expr_stmt|;
name|end_field
operator|=
name|IB_PC_RCV_PKTS_F
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|header_printed
condition|)
block|{
name|printf
argument_list|(
literal|"Data Counters for 0x%"
name|PRIx64
literal|" \"%s\"\n"
argument_list|,
name|node
operator|->
name|guid
argument_list|,
name|node_name
argument_list|)
expr_stmt|;
operator|*
name|header_printed
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|portnum
operator|==
literal|0xFF
condition|)
name|printf
argument_list|(
literal|"   GUID 0x%"
name|PRIx64
literal|" port ALL:"
argument_list|,
name|node
operator|->
name|guid
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"   GUID 0x%"
name|PRIx64
literal|" port %d:"
argument_list|,
name|node
operator|->
name|guid
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start_field
init|;
name|i
operator|<=
name|end_field
condition|;
name|i
operator|++
control|)
block|{
name|uint64_t
name|val64
init|=
literal|0
decl_stmt|;
name|float
name|val
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|unit
init|=
literal|""
decl_stmt|;
name|int
name|data
init|=
literal|0
decl_stmt|;
name|mad_decode_field
argument_list|(
name|pc
argument_list|,
name|i
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|val64
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|IB_PC_EXT_XMT_BYTES_F
operator|||
name|i
operator|==
name|IB_PC_EXT_RCV_BYTES_F
operator|||
name|i
operator|==
name|IB_PC_XMT_BYTES_F
operator|||
name|i
operator|==
name|IB_PC_RCV_BYTES_F
condition|)
name|data
operator|=
literal|1
expr_stmt|;
name|unit
operator|=
name|conv_cnt_human_readable
argument_list|(
name|val64
argument_list|,
operator|&
name|val
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" [%s == %"
name|PRIu64
literal|" (%5.3f%s)]"
argument_list|,
name|mad_field_name
argument_list|(
name|i
argument_list|)
argument_list|,
name|val64
argument_list|,
name|val
argument_list|,
name|unit
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|portnum
operator|!=
literal|0xFF
operator|&&
name|port_config
condition|)
name|print_port_config
argument_list|(
name|node
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_errors
parameter_list|(
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|uint16_t
name|cap_mask
parameter_list|,
name|char
modifier|*
name|node_name
parameter_list|,
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|int
name|portnum
parameter_list|,
name|int
modifier|*
name|header_printed
parameter_list|)
block|{
name|uint8_t
name|pc
index|[
literal|1024
index|]
decl_stmt|;
name|uint8_t
name|pce
index|[
literal|1024
index|]
decl_stmt|;
name|uint8_t
modifier|*
name|pc_ext
init|=
name|NULL
decl_stmt|;
name|memset
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|pce
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|portid
operator|->
name|sl
operator|=
name|lid2sl_table
index|[
name|portid
operator|->
name|lid
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|pma_query_via
argument_list|(
name|pc
argument_list|,
name|portid
argument_list|,
name|portnum
argument_list|,
name|ibd_timeout
argument_list|,
name|IB_GSI_PORT_COUNTERS
argument_list|,
name|ibmad_port
argument_list|)
condition|)
block|{
name|IBWARN
argument_list|(
literal|"IB_GSI_PORT_COUNTERS query failed on %s, %s port %d"
argument_list|,
name|node_name
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|summary
operator|.
name|pma_query_failures
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|cap_mask
operator|&
operator|(
name|IB_PM_EXT_WIDTH_SUPPORTED
operator||
name|IB_PM_EXT_WIDTH_NOIETF_SUP
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|pma_query_via
argument_list|(
name|pce
argument_list|,
name|portid
argument_list|,
name|portnum
argument_list|,
name|ibd_timeout
argument_list|,
name|IB_GSI_PORT_COUNTERS_EXT
argument_list|,
name|ibmad_port
argument_list|)
condition|)
block|{
name|IBWARN
argument_list|(
literal|"IB_GSI_PORT_COUNTERS_EXT query failed on %s, %s port %d"
argument_list|,
name|node_name
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|summary
operator|.
name|pma_query_failures
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|pc_ext
operator|=
name|pce
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|cap_mask
operator|&
name|IB_PM_PC_XMIT_WAIT_SUP
operator|)
condition|)
block|{
comment|/* if PortCounters:PortXmitWait not supported clear this counter */
name|uint32_t
name|foo
init|=
literal|0
decl_stmt|;
name|mad_encode_field
argument_list|(
name|pc
argument_list|,
name|IB_PC_XMT_WAIT_F
argument_list|,
operator|&
name|foo
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|print_results
argument_list|(
name|portid
argument_list|,
name|node_name
argument_list|,
name|node
argument_list|,
name|pc
argument_list|,
name|portnum
argument_list|,
name|header_printed
argument_list|,
name|pc_ext
argument_list|,
name|cap_mask
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
modifier|*
name|reset_pc_ext
parameter_list|(
name|void
modifier|*
name|rcvbuf
parameter_list|,
name|ib_portid_t
modifier|*
name|dest
parameter_list|,
name|int
name|port
parameter_list|,
name|unsigned
name|mask
parameter_list|,
name|unsigned
name|timeout
parameter_list|,
specifier|const
name|struct
name|ibmad_port
modifier|*
name|srcport
parameter_list|)
block|{
name|ib_rpc_t
name|rpc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|lid
init|=
name|dest
operator|->
name|lid
decl_stmt|;
name|DEBUG
argument_list|(
literal|"lid %u port %d mask 0x%x"
argument_list|,
name|lid
argument_list|,
name|port
argument_list|,
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|lid
operator|==
operator|-
literal|1
condition|)
block|{
name|IBWARN
argument_list|(
literal|"only lid routed is supported"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|mask
condition|)
name|mask
operator|=
operator|~
literal|0
expr_stmt|;
name|rpc
operator|.
name|mgtclass
operator|=
name|IB_PERFORMANCE_CLASS
expr_stmt|;
name|rpc
operator|.
name|method
operator|=
name|IB_MAD_METHOD_SET
expr_stmt|;
name|rpc
operator|.
name|attr
operator|.
name|id
operator|=
name|IB_GSI_PORT_COUNTERS_EXT
expr_stmt|;
name|memset
argument_list|(
name|rcvbuf
argument_list|,
literal|0
argument_list|,
name|IB_MAD_SIZE
argument_list|)
expr_stmt|;
comment|/* Same for attribute IDs */
name|mad_set_field
argument_list|(
name|rcvbuf
argument_list|,
literal|0
argument_list|,
name|IB_PC_EXT_PORT_SELECT_F
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|mad_set_field
argument_list|(
name|rcvbuf
argument_list|,
literal|0
argument_list|,
name|IB_PC_EXT_COUNTER_SELECT_F
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|rpc
operator|.
name|attr
operator|.
name|mod
operator|=
literal|0
expr_stmt|;
name|rpc
operator|.
name|timeout
operator|=
name|timeout
expr_stmt|;
name|rpc
operator|.
name|datasz
operator|=
name|IB_PC_DATA_SZ
expr_stmt|;
name|rpc
operator|.
name|dataoffs
operator|=
name|IB_PC_DATA_OFFS
expr_stmt|;
if|if
condition|(
operator|!
name|dest
operator|->
name|qp
condition|)
name|dest
operator|->
name|qp
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|dest
operator|->
name|qkey
condition|)
name|dest
operator|->
name|qkey
operator|=
name|IB_DEFAULT_QP1_QKEY
expr_stmt|;
return|return
name|mad_rpc
argument_list|(
name|srcport
argument_list|,
operator|&
name|rpc
argument_list|,
name|dest
argument_list|,
name|rcvbuf
argument_list|,
name|rcvbuf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|clear_port
parameter_list|(
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|uint16_t
name|cap_mask
parameter_list|,
name|char
modifier|*
name|node_name
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|uint8_t
name|pc
index|[
literal|1024
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
comment|/* bits defined in Table 228 PortCounters CounterSelect and 	 * CounterSelect2 	 */
name|uint32_t
name|mask
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|clear_errors
condition|)
block|{
name|mask
operator||=
literal|0xFFF
expr_stmt|;
if|if
condition|(
name|cap_mask
operator|&
name|IB_PM_PC_XMIT_WAIT_SUP
condition|)
name|mask
operator||=
literal|0x10000
expr_stmt|;
block|}
if|if
condition|(
name|clear_counts
condition|)
name|mask
operator||=
literal|0xF000
expr_stmt|;
if|if
condition|(
name|mask
condition|)
if|if
condition|(
operator|!
name|performance_reset_via
argument_list|(
name|pc
argument_list|,
name|portid
argument_list|,
name|port
argument_list|,
name|mask
argument_list|,
name|ibd_timeout
argument_list|,
name|IB_GSI_PORT_COUNTERS
argument_list|,
name|ibmad_port
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to reset errors %s port %d\n"
argument_list|,
name|node_name
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|clear_errors
operator|&&
name|details
condition|)
block|{
name|memset
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|performance_reset_via
argument_list|(
name|pc
argument_list|,
name|portid
argument_list|,
name|port
argument_list|,
literal|0xf
argument_list|,
name|ibd_timeout
argument_list|,
name|IB_GSI_PORT_XMIT_DISCARD_DETAILS
argument_list|,
name|ibmad_port
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|pc
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|performance_reset_via
argument_list|(
name|pc
argument_list|,
name|portid
argument_list|,
name|port
argument_list|,
literal|0x3f
argument_list|,
name|ibd_timeout
argument_list|,
name|IB_GSI_PORT_RCV_ERROR_DETAILS
argument_list|,
name|ibmad_port
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|clear_counts
operator|&&
operator|(
name|cap_mask
operator|&
operator|(
name|IB_PM_EXT_WIDTH_SUPPORTED
operator||
name|IB_PM_EXT_WIDTH_NOIETF_SUP
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|cap_mask
operator|&
name|IB_PM_EXT_WIDTH_SUPPORTED
condition|)
name|mask
operator|=
literal|0xFF
expr_stmt|;
else|else
name|mask
operator|=
literal|0x0F
expr_stmt|;
if|if
condition|(
operator|!
name|reset_pc_ext
argument_list|(
name|pc
argument_list|,
name|portid
argument_list|,
name|port
argument_list|,
name|mask
argument_list|,
name|ibd_timeout
argument_list|,
name|ibmad_port
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to reset extended data counters %s, "
literal|"%s port %d\n"
argument_list|,
name|node_name
argument_list|,
name|portid2str
argument_list|(
name|portid
argument_list|)
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|print_node
parameter_list|(
name|ibnd_node_t
modifier|*
name|node
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|int
name|header_printed
init|=
literal|0
decl_stmt|;
name|int
name|p
init|=
literal|0
decl_stmt|;
name|int
name|startport
init|=
literal|1
decl_stmt|;
name|int
name|type
init|=
literal|0
decl_stmt|;
name|int
name|all_port_sup
init|=
literal|0
decl_stmt|;
name|ib_portid_t
name|portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint16_t
name|cap_mask
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|node_name
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|node
operator|->
name|type
condition|)
block|{
case|case
name|IB_NODE_SWITCH
case|:
name|type
operator|=
name|PRINT_SWITCH
expr_stmt|;
break|break;
case|case
name|IB_NODE_CA
case|:
name|type
operator|=
name|PRINT_CA
expr_stmt|;
break|break;
case|case
name|IB_NODE_ROUTER
case|:
name|type
operator|=
name|PRINT_ROUTER
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|type
operator|&
name|node_type_to_print
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
operator|&&
name|node
operator|->
name|smaenhsp0
condition|)
name|startport
operator|=
literal|0
expr_stmt|;
name|node_name
operator|=
name|remap_node_name
argument_list|(
name|node_name_map
argument_list|,
name|node
operator|->
name|guid
argument_list|,
name|node
operator|->
name|nodedesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
block|{
name|ib_portid_set
argument_list|(
operator|&
name|portid
argument_list|,
name|node
operator|->
name|smalid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|p
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|p
operator|=
literal|1
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|node
operator|->
name|ports
index|[
name|p
index|]
condition|)
block|{
name|ib_portid_set
argument_list|(
operator|&
name|portid
argument_list|,
name|node
operator|->
name|ports
index|[
name|p
index|]
operator|->
name|base_lid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|query_cap_mask
argument_list|(
operator|&
name|portid
argument_list|,
name|node_name
argument_list|,
name|p
argument_list|,
operator|&
name|cap_mask
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|cap_mask
operator|&
name|IB_PM_ALL_PORT_SELECT
operator|)
condition|)
name|all_port_sup
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|data_counters_only
condition|)
block|{
for|for
control|(
name|p
operator|=
name|startport
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|node
operator|->
name|ports
index|[
name|p
index|]
condition|)
block|{
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
name|ib_portid_set
argument_list|(
operator|&
name|portid
argument_list|,
name|node
operator|->
name|smalid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|ib_portid_set
argument_list|(
operator|&
name|portid
argument_list|,
name|node
operator|->
name|ports
index|[
name|p
index|]
operator|->
name|base_lid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|print_data_cnts
argument_list|(
operator|&
name|portid
argument_list|,
name|cap_mask
argument_list|,
name|node_name
argument_list|,
name|node
argument_list|,
name|p
argument_list|,
operator|&
name|header_printed
argument_list|)
expr_stmt|;
name|summary
operator|.
name|ports_checked
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|all_port_sup
condition|)
name|clear_port
argument_list|(
operator|&
name|portid
argument_list|,
name|cap_mask
argument_list|,
name|node_name
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|all_port_sup
condition|)
if|if
condition|(
operator|!
name|print_errors
argument_list|(
operator|&
name|portid
argument_list|,
name|cap_mask
argument_list|,
name|node_name
argument_list|,
name|node
argument_list|,
literal|0xFF
argument_list|,
operator|&
name|header_printed
argument_list|)
condition|)
block|{
name|summary
operator|.
name|ports_checked
operator|+=
name|node
operator|->
name|numports
expr_stmt|;
goto|goto
name|clear
goto|;
block|}
for|for
control|(
name|p
operator|=
name|startport
init|;
name|p
operator|<=
name|node
operator|->
name|numports
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|node
operator|->
name|ports
index|[
name|p
index|]
condition|)
block|{
if|if
condition|(
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
name|ib_portid_set
argument_list|(
operator|&
name|portid
argument_list|,
name|node
operator|->
name|smalid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|ib_portid_set
argument_list|(
operator|&
name|portid
argument_list|,
name|node
operator|->
name|ports
index|[
name|p
index|]
operator|->
name|base_lid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|print_errors
argument_list|(
operator|&
name|portid
argument_list|,
name|cap_mask
argument_list|,
name|node_name
argument_list|,
name|node
argument_list|,
name|p
argument_list|,
operator|&
name|header_printed
argument_list|)
expr_stmt|;
name|summary
operator|.
name|ports_checked
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|all_port_sup
condition|)
name|clear_port
argument_list|(
operator|&
name|portid
argument_list|,
name|cap_mask
argument_list|,
name|node_name
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|clear
label|:
name|summary
operator|.
name|nodes_checked
operator|++
expr_stmt|;
if|if
condition|(
name|all_port_sup
condition|)
name|clear_port
argument_list|(
operator|&
name|portid
argument_list|,
name|cap_mask
argument_list|,
name|node_name
argument_list|,
literal|0xFF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|node_name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_suppressed
parameter_list|(
name|enum
name|MAD_FIELDS
name|field
parameter_list|)
block|{
if|if
condition|(
name|sup_total
operator|>=
name|SUP_MAX
condition|)
block|{
name|IBWARN
argument_list|(
literal|"Maximum (%d) fields have been suppressed; skipping %s"
argument_list|,
name|sup_total
argument_list|,
name|mad_field_name
argument_list|(
name|field
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|suppressed_fields
index|[
name|sup_total
operator|++
index|]
operator|=
name|field
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|calculate_suppressed_fields
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
name|enum
name|MAD_FIELDS
name|f
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|,
modifier|*
name|lasts
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|tmp
init|=
name|strdup
argument_list|(
name|str
argument_list|)
decl_stmt|;
name|val
operator|=
name|strtok_r
argument_list|(
name|tmp
argument_list|,
literal|","
argument_list|,
operator|&
name|lasts
argument_list|)
expr_stmt|;
while|while
condition|(
name|val
condition|)
block|{
for|for
control|(
name|f
operator|=
name|IB_PC_FIRST_F
init|;
name|f
operator|<=
name|IB_PC_LAST_F
condition|;
name|f
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|val
argument_list|,
name|mad_field_name
argument_list|(
name|f
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|add_suppressed
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|val
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|","
argument_list|,
operator|&
name|lasts
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_opt
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|ch
parameter_list|,
name|char
modifier|*
name|optarg
parameter_list|)
block|{
name|struct
name|ibnd_config
modifier|*
name|cfg
init|=
name|context
decl_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'s'
case|:
name|calculate_suppressed_fields
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* Right now this is the only "common" error */
name|add_suppressed
argument_list|(
name|IB_PC_ERR_SWITCH_REL_F
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|node_name_map_file
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|data_counters
operator|++
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|node_type_to_print
operator||=
name|PRINT_SWITCH
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|node_type_to_print
operator||=
name|PRINT_CA
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|node_type_to_print
operator||=
name|PRINT_ROUTER
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|details
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|load_cache_file
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|threshold_file
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|data_counters_only
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|10
case|:
name|obtain_sl
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
case|case
literal|'S'
case|:
name|port_guid_str
operator|=
name|optarg
expr_stmt|;
name|port_guid
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|dr_path
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|port_config
operator|++
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
comment|/* nop */
break|break;
case|case
literal|'k'
case|:
name|clear_errors
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
name|clear_counts
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|cfg
operator|->
name|max_smps
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|ibnd_config
name|config
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|resolved
init|=
operator|-
literal|1
decl_stmt|;
name|ib_portid_t
name|portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ib_portid_t
name|self_portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|ibnd_fabric_t
modifier|*
name|fabric
init|=
name|NULL
decl_stmt|;
name|ib_gid_t
name|self_gid
decl_stmt|;
name|int
name|port
init|=
literal|0
decl_stmt|;
name|int
name|mgmt_classes
index|[
literal|4
index|]
init|=
block|{
name|IB_SMI_CLASS
block|,
name|IB_SMI_DIRECT_CLASS
block|,
name|IB_SA_CLASS
block|,
name|IB_PERFORMANCE_CLASS
block|}
decl_stmt|;
specifier|const
name|struct
name|ibdiag_opt
name|opts
index|[]
init|=
block|{
block|{
literal|"suppress"
block|,
literal|'s'
block|,
literal|1
block|,
literal|"<err1,err2,...>"
block|,
literal|"suppress errors listed"
block|}
block|,
block|{
literal|"suppress-common"
block|,
literal|'c'
block|,
literal|0
block|,
name|NULL
block|,
literal|"suppress some of the common counters"
block|}
block|,
block|{
literal|"node-name-map"
block|,
literal|1
block|,
literal|1
block|,
literal|"<file>"
block|,
literal|"node name map file"
block|}
block|,
block|{
literal|"port-guid"
block|,
literal|'G'
block|,
literal|1
block|,
literal|"<port_guid>"
block|,
literal|"report the node containing the port specified by<port_guid>"
block|}
block|,
block|{
literal|""
block|,
literal|'S'
block|,
literal|1
block|,
literal|"<port_guid>"
block|,
literal|"Same as \"-G\" for backward compatibility"
block|}
block|,
block|{
literal|"Direct"
block|,
literal|'D'
block|,
literal|1
block|,
literal|"<dr_path>"
block|,
literal|"report the node containing the port specified by<dr_path>"
block|}
block|,
block|{
literal|"skip-sl"
block|,
literal|10
block|,
literal|0
block|,
name|NULL
block|,
literal|"don't obtain SL to all destinations"
block|}
block|,
block|{
literal|"report-port"
block|,
literal|'r'
block|,
literal|0
block|,
name|NULL
block|,
literal|"report port link information"
block|}
block|,
block|{
literal|"threshold-file"
block|,
literal|8
block|,
literal|1
block|,
name|NULL
block|,
literal|"specify an alternate threshold file, default: "
name|DEF_THRES_FILE
block|}
block|,
block|{
literal|"GNDN"
block|,
literal|'R'
block|,
literal|0
block|,
name|NULL
block|,
literal|"(This option is obsolete and does nothing)"
block|}
block|,
block|{
literal|"data"
block|,
literal|2
block|,
literal|0
block|,
name|NULL
block|,
literal|"include data counters for ports with errors"
block|}
block|,
block|{
literal|"switch"
block|,
literal|3
block|,
literal|0
block|,
name|NULL
block|,
literal|"print data for switches only"
block|}
block|,
block|{
literal|"ca"
block|,
literal|4
block|,
literal|0
block|,
name|NULL
block|,
literal|"print data for CA's only"
block|}
block|,
block|{
literal|"router"
block|,
literal|5
block|,
literal|0
block|,
name|NULL
block|,
literal|"print data for routers only"
block|}
block|,
block|{
literal|"details"
block|,
literal|6
block|,
literal|0
block|,
name|NULL
block|,
literal|"include transmit discard details"
block|}
block|,
block|{
literal|"counters"
block|,
literal|9
block|,
literal|0
block|,
name|NULL
block|,
literal|"print data counters only"
block|}
block|,
block|{
literal|"clear-errors"
block|,
literal|'k'
block|,
literal|0
block|,
name|NULL
block|,
literal|"Clear error counters after read"
block|}
block|,
block|{
literal|"clear-counts"
block|,
literal|'K'
block|,
literal|0
block|,
name|NULL
block|,
literal|"Clear data counters after read"
block|}
block|,
block|{
literal|"load-cache"
block|,
literal|7
block|,
literal|1
block|,
literal|"<file>"
block|,
literal|"filename of ibnetdiscover cache to load"
block|}
block|,
block|{
literal|"outstanding_smps"
block|,
literal|'o'
block|,
literal|1
block|,
name|NULL
block|,
literal|"specify the number of outstanding SMP's which should be "
literal|"issued during the scan"
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
name|char
name|usage_args
index|[]
init|=
literal|""
decl_stmt|;
name|memset
argument_list|(
name|suppressed_fields
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|suppressed_fields
argument_list|)
expr_stmt|;
name|ibdiag_process_opts
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|config
argument_list|,
literal|"cDGKLnRrSs"
argument_list|,
name|opts
argument_list|,
name|process_opt
argument_list|,
name|usage_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
operator|!
name|node_type_to_print
condition|)
name|node_type_to_print
operator|=
name|PRINT_ALL
expr_stmt|;
name|ibmad_port
operator|=
name|mad_rpc_open_port
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
name|mgmt_classes
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ibmad_port
condition|)
name|IBEXIT
argument_list|(
literal|"Failed to open port; %s:%d\n"
argument_list|,
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|)
expr_stmt|;
name|smp_mkey_set
argument_list|(
name|ibmad_port
argument_list|,
name|ibd_mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibd_timeout
condition|)
block|{
name|mad_rpc_set_timeout
argument_list|(
name|ibmad_port
argument_list|,
name|ibd_timeout
argument_list|)
expr_stmt|;
name|config
operator|.
name|timeout_ms
operator|=
name|ibd_timeout
expr_stmt|;
block|}
name|config
operator|.
name|flags
operator|=
name|ibd_ibnetdisc_flags
expr_stmt|;
name|config
operator|.
name|mkey
operator|=
name|ibd_mkey
expr_stmt|;
if|if
condition|(
name|dr_path
operator|&&
name|load_cache_file
condition|)
block|{
name|mad_rpc_close_port
argument_list|(
name|ibmad_port
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot specify cache and direct route path\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|resolve_self
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
operator|&
name|self_portid
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|self_gid
operator|.
name|raw
argument_list|)
operator|<
literal|0
condition|)
block|{
name|mad_rpc_close_port
argument_list|(
name|ibmad_port
argument_list|)
expr_stmt|;
name|IBEXIT
argument_list|(
literal|"can't resolve self port %s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
name|node_name_map
operator|=
name|open_node_name_map
argument_list|(
name|node_name_map_file
argument_list|)
expr_stmt|;
comment|/* limit the scan the fabric around the target */
if|if
condition|(
name|dr_path
condition|)
block|{
if|if
condition|(
operator|(
name|resolved
operator|=
name|resolve_portid_str
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
operator|&
name|portid
argument_list|,
name|dr_path
argument_list|,
name|IB_DEST_DRPATH
argument_list|,
name|NULL
argument_list|,
name|ibmad_port
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|IBWARN
argument_list|(
literal|"Failed to resolve %s; attempting full scan"
argument_list|,
name|dr_path
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|port_guid_str
condition|)
block|{
if|if
condition|(
operator|(
name|resolved
operator|=
name|resolve_portid_str
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
operator|&
name|portid
argument_list|,
name|port_guid_str
argument_list|,
name|IB_DEST_GUID
argument_list|,
name|ibd_sm_id
argument_list|,
name|ibmad_port
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|IBWARN
argument_list|(
literal|"Failed to resolve %s; attempting full scan"
argument_list|,
name|port_guid_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|obtain_sl
condition|)
name|lid2sl_table
index|[
name|portid
operator|.
name|lid
index|]
operator|=
name|portid
operator|.
name|sl
expr_stmt|;
block|}
name|mad_rpc_close_port
argument_list|(
name|ibmad_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|load_cache_file
condition|)
block|{
if|if
condition|(
operator|(
name|fabric
operator|=
name|ibnd_load_fabric
argument_list|(
name|load_cache_file
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"loading cached fabric failed\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|close_port
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|resolved
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|config
operator|.
name|max_hops
condition|)
name|config
operator|.
name|max_hops
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fabric
operator|=
name|ibnd_discover_fabric
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
operator|&
name|portid
argument_list|,
operator|&
name|config
argument_list|)
operator|)
condition|)
name|IBWARN
argument_list|(
literal|"Single node discover failed;"
literal|" attempting full scan"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fabric
operator|&&
operator|!
operator|(
name|fabric
operator|=
name|ibnd_discover_fabric
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
name|NULL
argument_list|,
operator|&
name|config
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"discover failed\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|close_port
goto|;
block|}
block|}
name|set_thresholds
argument_list|(
name|threshold_file
argument_list|)
expr_stmt|;
comment|/* reopen the global ibmad_port */
name|ibmad_port
operator|=
name|mad_rpc_open_port
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
name|mgmt_classes
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ibmad_port
condition|)
block|{
name|ibnd_destroy_fabric
argument_list|(
name|fabric
argument_list|)
expr_stmt|;
name|close_node_name_map
argument_list|(
name|node_name_map
argument_list|)
expr_stmt|;
name|IBEXIT
argument_list|(
literal|"Failed to reopen port: %s:%d\n"
argument_list|,
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|)
expr_stmt|;
block|}
name|smp_mkey_set
argument_list|(
name|ibmad_port
argument_list|,
name|ibd_mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibd_timeout
condition|)
name|mad_rpc_set_timeout
argument_list|(
name|ibmad_port
argument_list|,
name|ibd_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_guid_str
condition|)
block|{
name|ibnd_port_t
modifier|*
name|port
init|=
name|ibnd_find_port_guid
argument_list|(
name|fabric
argument_list|,
name|port_guid
argument_list|)
decl_stmt|;
if|if
condition|(
name|port
condition|)
name|print_node
argument_list|(
name|port
operator|->
name|node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to find node: %s\n"
argument_list|,
name|port_guid_str
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dr_path
condition|)
block|{
name|ibnd_port_t
modifier|*
name|port
decl_stmt|;
name|uint8_t
name|ni
index|[
name|IB_SMP_DATA_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|smp_query_via
argument_list|(
name|ni
argument_list|,
operator|&
name|portid
argument_list|,
name|IB_ATTR_NODE_INFO
argument_list|,
literal|0
argument_list|,
name|ibd_timeout
argument_list|,
name|ibmad_port
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to query local Node Info\n"
argument_list|)
expr_stmt|;
goto|goto
name|destroy_fabric
goto|;
block|}
name|mad_decode_field
argument_list|(
name|ni
argument_list|,
name|IB_NODE_PORT_GUID_F
argument_list|,
operator|&
operator|(
name|port_guid
operator|)
argument_list|)
expr_stmt|;
name|port
operator|=
name|ibnd_find_port_guid
argument_list|(
name|fabric
argument_list|,
name|port_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
condition|)
block|{
if|if
condition|(
name|obtain_sl
condition|)
if|if
condition|(
name|path_record_query
argument_list|(
name|self_gid
argument_list|,
name|port
operator|->
name|guid
argument_list|)
condition|)
goto|goto
name|destroy_fabric
goto|;
name|print_node
argument_list|(
name|port
operator|->
name|node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to find node: %s\n"
argument_list|,
name|dr_path
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|obtain_sl
condition|)
if|if
condition|(
name|path_record_query
argument_list|(
name|self_gid
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|destroy_fabric
goto|;
name|ibnd_iter_nodes
argument_list|(
name|fabric
argument_list|,
name|print_node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|print_summary
argument_list|()
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|rc
operator|=
literal|1
expr_stmt|;
name|destroy_fabric
label|:
name|mad_rpc_close_port
argument_list|(
name|ibmad_port
argument_list|)
expr_stmt|;
name|ibnd_destroy_fabric
argument_list|(
name|fabric
argument_list|)
expr_stmt|;
name|close_port
label|:
name|close_node_name_map
argument_list|(
name|node_name_map
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


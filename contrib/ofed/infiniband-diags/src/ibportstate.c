begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004-2009 Voltaire Inc.  All rights reserved.  * Copyright (c) 2010,2011 Mellanox Technologies LTD.  All rights reserved.  * Copyright (c) 2011,2016 Oracle and/or its affiliates. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/umad.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/mad.h>
end_include

begin_include
include|#
directive|include
file|"ibdiag_common.h"
end_include

begin_enum
enum|enum
name|port_ops
block|{
name|QUERY
block|,
name|ENABLE
block|,
name|RESET
block|,
name|DISABLE
block|,
name|SPEED
block|,
name|ESPEED
block|,
name|FDR10SPEED
block|,
name|WIDTH
block|,
name|DOWN
block|,
name|ARM
block|,
name|ACTIVE
block|,
name|VLS
block|,
name|MTU
block|,
name|LID
block|,
name|SMLID
block|,
name|LMC
block|,
name|MKEY
block|,
name|MKEYLEASE
block|,
name|MKEYPROT
block|,
name|ON
block|,
name|OFF
block|}
enum|;
end_enum

begin_decl_stmt
name|struct
name|ibmad_port
modifier|*
name|srcport
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|speed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* no state change */
end_comment

begin_decl_stmt
name|uint64_t
name|espeed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* no state change */
end_comment

begin_decl_stmt
name|uint64_t
name|fdr10
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* no state change */
end_comment

begin_decl_stmt
name|uint64_t
name|width
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* no state change */
end_comment

begin_decl_stmt
name|uint64_t
name|lid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|smlid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|lmc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|mtu
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|vls
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* no state change */
end_comment

begin_decl_stmt
name|uint64_t
name|mkey
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|mkeylease
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|mkeyprot
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|uint64_t
modifier|*
name|val
decl_stmt|;
name|int
name|set
decl_stmt|;
block|}
name|port_args
index|[]
init|=
block|{
block|{
literal|"query"
block|,
name|NULL
block|,
literal|0
block|}
block|,
comment|/* QUERY */
block|{
literal|"enable"
block|,
name|NULL
block|,
literal|0
block|}
block|,
comment|/* ENABLE */
block|{
literal|"reset"
block|,
name|NULL
block|,
literal|0
block|}
block|,
comment|/* RESET */
block|{
literal|"disable"
block|,
name|NULL
block|,
literal|0
block|}
block|,
comment|/* DISABLE */
block|{
literal|"speed"
block|,
operator|&
name|speed
block|,
literal|0
block|}
block|,
comment|/* SPEED */
block|{
literal|"espeed"
block|,
operator|&
name|espeed
block|,
literal|0
block|}
block|,
comment|/* EXTENDED SPEED */
block|{
literal|"fdr10"
block|,
operator|&
name|fdr10
block|,
literal|0
block|}
block|,
comment|/* FDR10 SPEED */
block|{
literal|"width"
block|,
operator|&
name|width
block|,
literal|0
block|}
block|,
comment|/* WIDTH */
block|{
literal|"down"
block|,
name|NULL
block|,
literal|0
block|}
block|,
comment|/* DOWN */
block|{
literal|"arm"
block|,
name|NULL
block|,
literal|0
block|}
block|,
comment|/* ARM */
block|{
literal|"active"
block|,
name|NULL
block|,
literal|0
block|}
block|,
comment|/* ACTIVE */
block|{
literal|"vls"
block|,
operator|&
name|vls
block|,
literal|0
block|}
block|,
comment|/* VLS */
block|{
literal|"mtu"
block|,
operator|&
name|mtu
block|,
literal|0
block|}
block|,
comment|/* MTU */
block|{
literal|"lid"
block|,
operator|&
name|lid
block|,
literal|0
block|}
block|,
comment|/* LID */
block|{
literal|"smlid"
block|,
operator|&
name|smlid
block|,
literal|0
block|}
block|,
comment|/* SMLID */
block|{
literal|"lmc"
block|,
operator|&
name|lmc
block|,
literal|0
block|}
block|,
comment|/* LMC */
block|{
literal|"mkey"
block|,
operator|&
name|mkey
block|,
literal|0
block|}
block|,
comment|/* MKEY */
block|{
literal|"mkeylease"
block|,
operator|&
name|mkeylease
block|,
literal|0
block|}
block|,
comment|/* MKEY LEASE */
block|{
literal|"mkeyprot"
block|,
operator|&
name|mkeyprot
block|,
literal|0
block|}
block|,
comment|/* MKEY PROTECT BITS */
block|{
literal|"on"
block|,
name|NULL
block|,
literal|0
block|}
block|,
comment|/* ON */
block|{
literal|"off"
block|,
name|NULL
block|,
literal|0
block|}
block|,
comment|/* OFF */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|NPORT_ARGS
value|(sizeof(port_args) / sizeof(port_args[0]))
end_define

begin_comment
comment|/*******************************************/
end_comment

begin_comment
comment|/*  * Return 1 if node is a switch, else zero.  */
end_comment

begin_function
specifier|static
name|int
name|get_node_info
parameter_list|(
name|ib_portid_t
modifier|*
name|dest
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
name|int
name|node_type
decl_stmt|;
if|if
condition|(
operator|!
name|smp_query_via
argument_list|(
name|data
argument_list|,
name|dest
argument_list|,
name|IB_ATTR_NODE_INFO
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|srcport
argument_list|)
condition|)
name|IBEXIT
argument_list|(
literal|"smp query nodeinfo failed"
argument_list|)
expr_stmt|;
name|node_type
operator|=
name|mad_get_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_NODE_TYPE_F
argument_list|)
expr_stmt|;
if|if
condition|(
name|node_type
operator|==
name|IB_NODE_SWITCH
condition|)
comment|/* Switch NodeType ? */
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_port_info
parameter_list|(
name|ib_portid_t
modifier|*
name|dest
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|int
name|portnum
parameter_list|,
name|int
name|is_switch
parameter_list|)
block|{
name|uint8_t
name|smp
index|[
name|IB_SMP_DATA_SIZE
index|]
decl_stmt|;
name|uint8_t
modifier|*
name|info
decl_stmt|;
name|int
name|cap_mask
decl_stmt|;
if|if
condition|(
name|is_switch
condition|)
block|{
if|if
condition|(
operator|!
name|smp_query_via
argument_list|(
name|smp
argument_list|,
name|dest
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|srcport
argument_list|)
condition|)
name|IBEXIT
argument_list|(
literal|"smp query port 0 portinfo failed"
argument_list|)
expr_stmt|;
name|info
operator|=
name|smp
expr_stmt|;
block|}
else|else
name|info
operator|=
name|data
expr_stmt|;
if|if
condition|(
operator|!
name|smp_query_via
argument_list|(
name|data
argument_list|,
name|dest
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
name|portnum
argument_list|,
literal|0
argument_list|,
name|srcport
argument_list|)
condition|)
name|IBEXIT
argument_list|(
literal|"smp query portinfo failed"
argument_list|)
expr_stmt|;
name|cap_mask
operator|=
name|mad_get_field
argument_list|(
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_CAPMASK_F
argument_list|)
expr_stmt|;
return|return
operator|(
name|cap_mask
operator|&
name|CL_NTOH32
argument_list|(
name|IB_PORT_CAP_HAS_EXT_SPEEDS
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_port_info
parameter_list|(
name|ib_portid_t
modifier|*
name|dest
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|int
name|portnum
parameter_list|,
name|int
name|espeed_cap
parameter_list|,
name|int
name|is_switch
parameter_list|)
block|{
name|char
name|buf
index|[
literal|2300
index|]
decl_stmt|;
name|char
name|val
index|[
literal|64
index|]
decl_stmt|;
name|mad_dump_portstates
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|data
argument_list|,
sizeof|sizeof
expr|*
name|data
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LID_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LID_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_SMLID_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_SMLID_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LMC_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LMC_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_WIDTH_SUPPORTED_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LINK_WIDTH_SUPPORTED_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_WIDTH_ENABLED_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LINK_WIDTH_ENABLED_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_WIDTH_ACTIVE_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LINK_WIDTH_ACTIVE_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_SUPPORTED_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LINK_SPEED_SUPPORTED_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_ENABLED_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LINK_SPEED_ENABLED_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|espeed_cap
condition|)
block|{
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_SUPPORTED_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LINK_SPEED_EXT_SUPPORTED_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_ENABLED_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LINK_SPEED_EXT_ENABLED_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_ACTIVE_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_LINK_SPEED_EXT_ACTIVE_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|is_switch
operator|||
name|portnum
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|show_keys
condition|)
block|{
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_MKEY_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_MKEY_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
name|snprint_field
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|IB_PORT_MKEY_F
argument_list|,
literal|32
argument_list|,
name|NOT_DISPLAYED_STR
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_MKEY_LEASE_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_MKEY_LEASE_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_MKEY_PROT_BITS_F
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|mad_dump_field
argument_list|(
name|IB_PORT_MKEY_PROT_BITS_F
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
sizeof|sizeof
name|buf
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"# Port info: %s port %d\n%s"
argument_list|,
name|portid2str
argument_list|(
name|dest
argument_list|)
argument_list|,
name|portnum
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_port_info
parameter_list|(
name|ib_portid_t
modifier|*
name|dest
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|int
name|portnum
parameter_list|,
name|int
name|espeed_cap
parameter_list|,
name|int
name|is_switch
parameter_list|)
block|{
name|unsigned
name|mod
decl_stmt|;
name|mod
operator|=
name|portnum
expr_stmt|;
if|if
condition|(
name|espeed_cap
condition|)
name|mod
operator||=
literal|1
operator|<<
literal|31
expr_stmt|;
if|if
condition|(
operator|!
name|smp_set_via
argument_list|(
name|data
argument_list|,
name|dest
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
name|mod
argument_list|,
literal|0
argument_list|,
name|srcport
argument_list|)
condition|)
name|IBEXIT
argument_list|(
literal|"smp set portinfo failed"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nAfter PortInfo set:\n"
argument_list|)
expr_stmt|;
name|show_port_info
argument_list|(
name|dest
argument_list|,
name|data
argument_list|,
name|portnum
argument_list|,
name|espeed_cap
argument_list|,
name|is_switch
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_mlnx_ext_port_info
parameter_list|(
name|ib_portid_t
modifier|*
name|dest
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|int
name|portnum
parameter_list|)
block|{
if|if
condition|(
operator|!
name|smp_query_via
argument_list|(
name|data
argument_list|,
name|dest
argument_list|,
name|IB_ATTR_MLNX_EXT_PORT_INFO
argument_list|,
name|portnum
argument_list|,
literal|0
argument_list|,
name|srcport
argument_list|)
condition|)
name|IBEXIT
argument_list|(
literal|"smp query ext portinfo failed"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_mlnx_ext_port_info
parameter_list|(
name|ib_portid_t
modifier|*
name|dest
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|int
name|portnum
parameter_list|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|mad_dump_mlnx_ext_port_info
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|data
argument_list|,
name|IB_SMP_DATA_SIZE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"# MLNX ext Port info: %s port %d\n%s"
argument_list|,
name|portid2str
argument_list|(
name|dest
argument_list|)
argument_list|,
name|portnum
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_mlnx_ext_port_info
parameter_list|(
name|ib_portid_t
modifier|*
name|dest
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|int
name|portnum
parameter_list|)
block|{
if|if
condition|(
operator|!
name|smp_set_via
argument_list|(
name|data
argument_list|,
name|dest
argument_list|,
name|IB_ATTR_MLNX_EXT_PORT_INFO
argument_list|,
name|portnum
argument_list|,
literal|0
argument_list|,
name|srcport
argument_list|)
condition|)
name|IBEXIT
argument_list|(
literal|"smp set MLNX ext portinfo failed"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nAfter MLNXExtendedPortInfo set:\n"
argument_list|)
expr_stmt|;
name|show_mlnx_ext_port_info
argument_list|(
name|dest
argument_list|,
name|data
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_link_width
parameter_list|(
name|int
name|lwe
parameter_list|,
name|int
name|lws
parameter_list|)
block|{
if|if
condition|(
name|lwe
operator|==
literal|255
condition|)
return|return
name|lws
return|;
else|else
return|return
name|lwe
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_link_speed
parameter_list|(
name|int
name|lse
parameter_list|,
name|int
name|lss
parameter_list|)
block|{
if|if
condition|(
name|lse
operator|==
literal|15
condition|)
return|return
name|lss
return|;
else|else
return|return
name|lse
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_link_speed_ext
parameter_list|(
name|int
name|lsee
parameter_list|,
name|int
name|lses
parameter_list|)
block|{
if|if
condition|(
name|lsee
operator|==
literal|31
condition|)
return|return
name|lses
return|;
else|else
return|return
name|lsee
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|validate_width
parameter_list|(
name|int
name|width
parameter_list|,
name|int
name|peerwidth
parameter_list|,
name|int
name|lwa
parameter_list|)
block|{
if|if
condition|(
operator|(
name|width
operator|&
name|peerwidth
operator|&
literal|0x8
operator|)
condition|)
block|{
if|if
condition|(
name|lwa
operator|!=
literal|8
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active width %d rather than 8 (12x)"
argument_list|,
name|lwa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|width
operator|&
name|peerwidth
operator|&
literal|0x4
operator|)
condition|)
block|{
if|if
condition|(
name|lwa
operator|!=
literal|4
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active width %d rather than 4 (8x)"
argument_list|,
name|lwa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|width
operator|&
name|peerwidth
operator|&
literal|0x2
operator|)
condition|)
block|{
if|if
condition|(
name|lwa
operator|!=
literal|2
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active width %d rather than 2 (4x)"
argument_list|,
name|lwa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|width
operator|&
name|peerwidth
operator|&
literal|0x10
operator|)
condition|)
block|{
if|if
condition|(
name|lwa
operator|!=
literal|16
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active width %d rather than 16 (2x)"
argument_list|,
name|lwa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|width
operator|&
name|peerwidth
operator|&
literal|0x1
operator|)
condition|)
block|{
if|if
condition|(
name|lwa
operator|!=
literal|1
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active width %d rather than 1 (1x)"
argument_list|,
name|lwa
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|validate_speed
parameter_list|(
name|int
name|speed
parameter_list|,
name|int
name|peerspeed
parameter_list|,
name|int
name|lsa
parameter_list|)
block|{
if|if
condition|(
operator|(
name|speed
operator|&
name|peerspeed
operator|&
literal|0x4
operator|)
condition|)
block|{
if|if
condition|(
name|lsa
operator|!=
literal|4
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active speed %d rather than 4 (10.0 Gbps)"
argument_list|,
name|lsa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|speed
operator|&
name|peerspeed
operator|&
literal|0x2
operator|)
condition|)
block|{
if|if
condition|(
name|lsa
operator|!=
literal|2
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active speed %d rather than 2 (5.0 Gbps)"
argument_list|,
name|lsa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|speed
operator|&
name|peerspeed
operator|&
literal|0x1
operator|)
condition|)
block|{
if|if
condition|(
name|lsa
operator|!=
literal|1
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active speed %d rather than 1 (2.5 Gbps)"
argument_list|,
name|lsa
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|validate_extended_speed
parameter_list|(
name|int
name|espeed
parameter_list|,
name|int
name|peerespeed
parameter_list|,
name|int
name|lsea
parameter_list|)
block|{
if|if
condition|(
operator|(
name|espeed
operator|&
name|peerespeed
operator|&
literal|0x2
operator|)
condition|)
block|{
if|if
condition|(
name|lsea
operator|!=
literal|2
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active extended speed %d rather than 2 (25.78125 Gbps)"
argument_list|,
name|lsea
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|espeed
operator|&
name|peerespeed
operator|&
literal|0x1
operator|)
condition|)
block|{
if|if
condition|(
name|lsea
operator|!=
literal|1
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active extended speed %d rather than 1 (14.0625 Gbps)"
argument_list|,
name|lsea
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|mgmt_classes
index|[
literal|3
index|]
init|=
block|{
name|IB_SMI_CLASS
block|,
name|IB_SMI_DIRECT_CLASS
block|,
name|IB_SA_CLASS
block|}
decl_stmt|;
name|ib_portid_t
name|portid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|port_op
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|is_switch
decl_stmt|,
name|is_peer_switch
decl_stmt|,
name|espeed_cap
decl_stmt|,
name|peer_espeed_cap
decl_stmt|;
name|int
name|state
decl_stmt|,
name|physstate
decl_stmt|,
name|lwe
decl_stmt|,
name|lws
decl_stmt|,
name|lwa
decl_stmt|,
name|lse
decl_stmt|,
name|lss
decl_stmt|,
name|lsa
decl_stmt|,
name|lsee
decl_stmt|,
name|lses
decl_stmt|,
name|lsea
decl_stmt|,
name|fdr10s
decl_stmt|,
name|fdr10e
decl_stmt|,
name|fdr10a
decl_stmt|;
name|int
name|peerlocalportnum
decl_stmt|,
name|peerlwe
decl_stmt|,
name|peerlws
decl_stmt|,
name|peerlwa
decl_stmt|,
name|peerlse
decl_stmt|,
name|peerlss
decl_stmt|,
name|peerlsa
decl_stmt|,
name|peerlsee
decl_stmt|,
name|peerlses
decl_stmt|,
name|peerlsea
decl_stmt|,
name|peerfdr10s
decl_stmt|,
name|peerfdr10e
decl_stmt|,
name|peerfdr10a
decl_stmt|;
name|int
name|peerwidth
decl_stmt|,
name|peerspeed
decl_stmt|,
name|peerespeed
decl_stmt|;
name|uint8_t
name|data
index|[
name|IB_SMP_DATA_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint8_t
name|data2
index|[
name|IB_SMP_DATA_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ib_portid_t
name|peerportid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|portnum
init|=
literal|0
decl_stmt|;
name|ib_portid_t
name|selfportid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|selfport
init|=
literal|0
decl_stmt|;
name|int
name|changed
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|vendorid
decl_stmt|,
name|rem_vendorid
decl_stmt|;
name|uint16_t
name|devid
decl_stmt|,
name|rem_devid
decl_stmt|;
name|uint64_t
name|val
decl_stmt|;
name|char
modifier|*
name|endp
decl_stmt|;
name|char
name|usage_args
index|[]
init|=
literal|"<dest dr_path|lid|guid><portnum> [<op>]\n"
literal|"\nSupported ops: enable, disable, on, off, reset, speed, espeed, fdr10,\n"
literal|"\twidth, query, down, arm, active, vls, mtu, lid, smlid, lmc,\n"
literal|"\tmkey, mkeylease, mkeyprot\n"
decl_stmt|;
specifier|const
name|char
modifier|*
name|usage_examples
index|[]
init|=
block|{
literal|"3 1 disable\t\t\t# by lid"
block|,
literal|"-G 0x2C9000100D051 1 enable\t# by guid"
block|,
literal|"-D 0 1\t\t\t# (query) by direct route"
block|,
literal|"3 1 reset\t\t\t# by lid"
block|,
literal|"3 1 speed 1\t\t\t# by lid"
block|,
literal|"3 1 width 1\t\t\t# by lid"
block|,
literal|"-D 0 1 lid 0x1234 arm\t\t# by direct route"
block|,
name|NULL
block|}
decl_stmt|;
name|ibdiag_process_opts
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|usage_args
argument_list|,
name|usage_examples
argument_list|)
expr_stmt|;
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
name|srcport
operator|=
name|mad_rpc_open_port
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
name|mgmt_classes
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|srcport
condition|)
name|IBEXIT
argument_list|(
literal|"Failed to open '%s' port '%d'"
argument_list|,
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|)
expr_stmt|;
name|smp_mkey_set
argument_list|(
name|srcport
argument_list|,
name|ibd_mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolve_portid_str
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
operator|&
name|portid
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|ibd_dest_type
argument_list|,
name|ibd_sm_id
argument_list|,
name|srcport
argument_list|)
operator|<
literal|0
condition|)
name|IBEXIT
argument_list|(
literal|"can't resolve destination port %s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
name|portnum
operator|=
name|strtol
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NPORT_ARGS
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|port_args
index|[
name|j
index|]
operator|.
name|name
argument_list|)
condition|)
continue|continue;
name|port_args
index|[
name|j
index|]
operator|.
name|set
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|port_args
index|[
name|j
index|]
operator|.
name|val
condition|)
block|{
if|if
condition|(
name|port_op
operator|>=
literal|0
condition|)
name|IBEXIT
argument_list|(
literal|"%s only one of: "
argument_list|,
literal|"query, enable, disable, "
literal|"reset, down, arm, active, "
literal|"can be specified"
argument_list|,
name|port_args
index|[
name|j
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|port_op
operator|=
name|j
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|++
name|i
operator|>=
name|argc
condition|)
name|IBEXIT
argument_list|(
literal|"%s requires an additional parameter"
argument_list|,
name|port_args
index|[
name|j
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|val
operator|=
name|strtoull
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|j
condition|)
block|{
case|case
name|SPEED
case|:
if|if
condition|(
name|val
operator|>
literal|15
condition|)
name|IBEXIT
argument_list|(
literal|"invalid speed value %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESPEED
case|:
if|if
condition|(
name|val
operator|>
literal|31
condition|)
name|IBEXIT
argument_list|(
literal|"invalid extended speed value %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|FDR10SPEED
case|:
if|if
condition|(
name|val
operator|>
literal|1
condition|)
name|IBEXIT
argument_list|(
literal|"invalid fdr10 speed value %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|WIDTH
case|:
if|if
condition|(
operator|(
name|val
operator|>
literal|31
operator|&&
name|val
operator|!=
literal|255
operator|)
condition|)
name|IBEXIT
argument_list|(
literal|"invalid width value %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|VLS
case|:
if|if
condition|(
name|val
operator|==
literal|0
operator|||
name|val
operator|>
literal|5
condition|)
name|IBEXIT
argument_list|(
literal|"invalid vls value %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|MTU
case|:
if|if
condition|(
name|val
operator|==
literal|0
operator|||
name|val
operator|>
literal|5
condition|)
name|IBEXIT
argument_list|(
literal|"invalid mtu value %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|LID
case|:
if|if
condition|(
name|val
operator|==
literal|0
operator|||
name|val
operator|>=
literal|0xC000
condition|)
name|IBEXIT
argument_list|(
literal|"invalid lid value 0x%lx"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|SMLID
case|:
if|if
condition|(
name|val
operator|==
literal|0
operator|||
name|val
operator|>=
literal|0xC000
condition|)
name|IBEXIT
argument_list|(
literal|"invalid smlid value 0x%lx"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|LMC
case|:
if|if
condition|(
name|val
operator|>
literal|7
condition|)
name|IBEXIT
argument_list|(
literal|"invalid lmc value %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|MKEY
case|:
name|errno
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|strtoull
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|||
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|strtoull
argument_list|(
name|getpass
argument_list|(
literal|"New M_Key: "
argument_list|)
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|||
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|IBEXIT
argument_list|(
literal|"Bad new M_Key\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* All 64-bit values are legal */
break|break;
case|case
name|MKEYLEASE
case|:
if|if
condition|(
name|val
operator|>
literal|0xFFFF
condition|)
name|IBEXIT
argument_list|(
literal|"invalid mkey lease time %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|MKEYPROT
case|:
if|if
condition|(
name|val
operator|>
literal|3
condition|)
name|IBEXIT
argument_list|(
literal|"invalid mkey protection bit setting %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
operator|*
name|port_args
index|[
name|j
index|]
operator|.
name|val
operator|=
name|val
expr_stmt|;
name|changed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|j
operator|==
name|NPORT_ARGS
condition|)
name|IBEXIT
argument_list|(
literal|"invalid operation: %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|port_op
operator|<
literal|0
condition|)
name|port_op
operator|=
name|QUERY
expr_stmt|;
name|is_switch
operator|=
name|get_node_info
argument_list|(
operator|&
name|portid
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|vendorid
operator|=
operator|(
name|uint32_t
operator|)
name|mad_get_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|)
expr_stmt|;
name|devid
operator|=
operator|(
name|uint16_t
operator|)
name|mad_get_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|port_args
index|[
name|MKEY
index|]
operator|.
name|set
operator|||
name|port_args
index|[
name|MKEYLEASE
index|]
operator|.
name|set
operator|||
name|port_args
index|[
name|MKEYPROT
index|]
operator|.
name|set
operator|)
operator|&&
name|is_switch
operator|&&
name|portnum
operator|!=
literal|0
condition|)
name|IBEXIT
argument_list|(
literal|"Can't set M_Key fields on switch port != 0"
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_op
operator|!=
name|QUERY
operator|||
name|changed
condition|)
name|printf
argument_list|(
literal|"Initial %s PortInfo:\n"
argument_list|,
name|is_switch
condition|?
literal|"Switch"
else|:
literal|"CA/RT"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s PortInfo:\n"
argument_list|,
name|is_switch
condition|?
literal|"Switch"
else|:
literal|"CA/RT"
argument_list|)
expr_stmt|;
name|espeed_cap
operator|=
name|get_port_info
argument_list|(
operator|&
name|portid
argument_list|,
name|data
argument_list|,
name|portnum
argument_list|,
name|is_switch
argument_list|)
expr_stmt|;
name|show_port_info
argument_list|(
operator|&
name|portid
argument_list|,
name|data
argument_list|,
name|portnum
argument_list|,
name|espeed_cap
argument_list|,
name|is_switch
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_mlnx_ext_port_info_supported
argument_list|(
name|vendorid
argument_list|,
name|devid
argument_list|)
condition|)
block|{
name|get_mlnx_ext_port_info
argument_list|(
operator|&
name|portid
argument_list|,
name|data2
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|show_mlnx_ext_port_info
argument_list|(
operator|&
name|portid
argument_list|,
name|data2
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|port_op
operator|!=
name|QUERY
operator|||
name|changed
condition|)
block|{
comment|/* 		 * If we aren't setting the LID and the LID is the default, 		 * the SMA command will fail due to an invalid LID. 		 * Set it to something unlikely but valid. 		 */
name|physstate
operator|=
name|mad_get_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_PHYS_STATE_F
argument_list|)
expr_stmt|;
name|val
operator|=
name|mad_get_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LID_F
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port_args
index|[
name|LID
index|]
operator|.
name|set
operator|&&
operator|(
operator|!
name|val
operator|||
name|val
operator|==
literal|0xFFFF
operator|)
condition|)
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LID_F
argument_list|,
literal|0x1234
argument_list|)
expr_stmt|;
name|val
operator|=
name|mad_get_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_SMLID_F
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port_args
index|[
name|SMLID
index|]
operator|.
name|set
operator|&&
operator|(
operator|!
name|val
operator|||
name|val
operator|==
literal|0xFFFF
operator|)
condition|)
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_SMLID_F
argument_list|,
literal|0x1234
argument_list|)
expr_stmt|;
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_STATE_F
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOP */
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_PHYS_STATE_F
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* NOP */
switch|switch
condition|(
name|port_op
condition|)
block|{
case|case
name|ON
case|:
comment|/* Enable only if state is Disable */
if|if
condition|(
name|physstate
operator|!=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"Port is already in enable state\n"
argument_list|)
expr_stmt|;
goto|goto
name|close_port
goto|;
block|}
case|case
name|ENABLE
case|:
case|case
name|RESET
case|:
comment|/* Polling */
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_PHYS_STATE_F
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
name|OFF
case|:
case|case
name|DISABLE
case|:
name|printf
argument_list|(
literal|"Disable may be irreversible\n"
argument_list|)
expr_stmt|;
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_PHYS_STATE_F
argument_list|,
literal|3
argument_list|)
expr_stmt|;
break|break;
case|case
name|DOWN
case|:
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_STATE_F
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|ARM
case|:
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_STATE_F
argument_list|,
literal|3
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACTIVE
case|:
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_STATE_F
argument_list|,
literal|4
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* always set enabled speeds/width - defaults to NOP */
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_ENABLED_F
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_ENABLED_F
argument_list|,
name|espeed
argument_list|)
expr_stmt|;
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_WIDTH_ENABLED_F
argument_list|,
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_args
index|[
name|VLS
index|]
operator|.
name|set
condition|)
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_OPER_VLS_F
argument_list|,
name|vls
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_args
index|[
name|MTU
index|]
operator|.
name|set
condition|)
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_NEIGHBOR_MTU_F
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_args
index|[
name|LID
index|]
operator|.
name|set
condition|)
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LID_F
argument_list|,
name|lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_args
index|[
name|SMLID
index|]
operator|.
name|set
condition|)
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_SMLID_F
argument_list|,
name|smlid
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_args
index|[
name|LMC
index|]
operator|.
name|set
condition|)
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LMC_F
argument_list|,
name|lmc
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_args
index|[
name|FDR10SPEED
index|]
operator|.
name|set
condition|)
block|{
name|mad_set_field
argument_list|(
name|data2
argument_list|,
literal|0
argument_list|,
name|IB_MLNX_EXT_PORT_STATE_CHG_ENABLE_F
argument_list|,
name|FDR10
argument_list|)
expr_stmt|;
name|mad_set_field
argument_list|(
name|data2
argument_list|,
literal|0
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_ENABLED_F
argument_list|,
name|fdr10
argument_list|)
expr_stmt|;
name|set_mlnx_ext_port_info
argument_list|(
operator|&
name|portid
argument_list|,
name|data2
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|port_args
index|[
name|MKEY
index|]
operator|.
name|set
condition|)
name|mad_set_field64
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_MKEY_F
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_args
index|[
name|MKEYLEASE
index|]
operator|.
name|set
condition|)
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_MKEY_LEASE_F
argument_list|,
name|mkeylease
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_args
index|[
name|MKEYPROT
index|]
operator|.
name|set
condition|)
name|mad_set_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_PORT_MKEY_PROT_BITS_F
argument_list|,
name|mkeyprot
argument_list|)
expr_stmt|;
name|set_port_info
argument_list|(
operator|&
name|portid
argument_list|,
name|data
argument_list|,
name|portnum
argument_list|,
name|espeed_cap
argument_list|,
name|is_switch
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_switch
operator|&&
name|portnum
condition|)
block|{
comment|/* Now, make sure PortState is Active */
comment|/* Or is PortPhysicalState LinkUp sufficient ? */
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_STATE_F
argument_list|,
operator|&
name|state
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_PHYS_STATE_F
argument_list|,
operator|&
name|physstate
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
literal|4
condition|)
block|{
comment|/* Active */
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_WIDTH_ENABLED_F
argument_list|,
operator|&
name|lwe
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_WIDTH_SUPPORTED_F
argument_list|,
operator|&
name|lws
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_WIDTH_ACTIVE_F
argument_list|,
operator|&
name|lwa
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_SUPPORTED_F
argument_list|,
operator|&
name|lss
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|,
operator|&
name|lsa
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_ENABLED_F
argument_list|,
operator|&
name|lse
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data2
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_SUPPORTED_F
argument_list|,
operator|&
name|fdr10s
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data2
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_ENABLED_F
argument_list|,
operator|&
name|fdr10e
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data2
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_ACTIVE_F
argument_list|,
operator|&
name|fdr10a
argument_list|)
expr_stmt|;
if|if
condition|(
name|espeed_cap
condition|)
block|{
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_SUPPORTED_F
argument_list|,
operator|&
name|lses
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_ACTIVE_F
argument_list|,
operator|&
name|lsea
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_ENABLED_F
argument_list|,
operator|&
name|lsee
argument_list|)
expr_stmt|;
block|}
comment|/* Setup portid for peer port */
name|memcpy
argument_list|(
operator|&
name|peerportid
argument_list|,
operator|&
name|portid
argument_list|,
sizeof|sizeof
argument_list|(
name|peerportid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|portid
operator|.
name|lid
operator|==
literal|0
condition|)
block|{
name|peerportid
operator|.
name|drpath
operator|.
name|cnt
operator|++
expr_stmt|;
if|if
condition|(
name|peerportid
operator|.
name|drpath
operator|.
name|cnt
operator|==
name|IB_SUBNET_PATH_HOPS_MAX
condition|)
block|{
name|IBEXIT
argument_list|(
literal|"Too many hops"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|peerportid
operator|.
name|drpath
operator|.
name|cnt
operator|=
literal|1
expr_stmt|;
comment|/* Set DrSLID to local lid */
if|if
condition|(
name|resolve_self
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
operator|&
name|selfportid
argument_list|,
operator|&
name|selfport
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|IBEXIT
argument_list|(
literal|"could not resolve self"
argument_list|)
expr_stmt|;
name|peerportid
operator|.
name|drpath
operator|.
name|drslid
operator|=
operator|(
name|uint16_t
operator|)
name|selfportid
operator|.
name|lid
expr_stmt|;
name|peerportid
operator|.
name|drpath
operator|.
name|drdlid
operator|=
literal|0xffff
expr_stmt|;
block|}
name|peerportid
operator|.
name|drpath
operator|.
name|p
index|[
name|peerportid
operator|.
name|drpath
operator|.
name|cnt
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|portnum
expr_stmt|;
comment|/* Get peer port NodeInfo to obtain peer port number */
name|is_peer_switch
operator|=
name|get_node_info
argument_list|(
operator|&
name|peerportid
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|rem_vendorid
operator|=
operator|(
name|uint32_t
operator|)
name|mad_get_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_NODE_VENDORID_F
argument_list|)
expr_stmt|;
name|rem_devid
operator|=
operator|(
name|uint16_t
operator|)
name|mad_get_field
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|IB_NODE_DEVID_F
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_NODE_LOCAL_PORT_F
argument_list|,
operator|&
name|peerlocalportnum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Peer PortInfo:\n"
argument_list|)
expr_stmt|;
comment|/* Get peer port characteristics */
name|peer_espeed_cap
operator|=
name|get_port_info
argument_list|(
operator|&
name|peerportid
argument_list|,
name|data
argument_list|,
name|peerlocalportnum
argument_list|,
name|is_peer_switch
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_mlnx_ext_port_info_supported
argument_list|(
name|rem_vendorid
argument_list|,
name|rem_devid
argument_list|)
condition|)
name|get_mlnx_ext_port_info
argument_list|(
operator|&
name|peerportid
argument_list|,
name|data2
argument_list|,
name|peerlocalportnum
argument_list|)
expr_stmt|;
name|show_port_info
argument_list|(
operator|&
name|peerportid
argument_list|,
name|data
argument_list|,
name|peerlocalportnum
argument_list|,
name|peer_espeed_cap
argument_list|,
name|is_peer_switch
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_mlnx_ext_port_info_supported
argument_list|(
name|rem_vendorid
argument_list|,
name|rem_devid
argument_list|)
condition|)
name|show_mlnx_ext_port_info
argument_list|(
operator|&
name|peerportid
argument_list|,
name|data2
argument_list|,
name|peerlocalportnum
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_WIDTH_ENABLED_F
argument_list|,
operator|&
name|peerlwe
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_WIDTH_SUPPORTED_F
argument_list|,
operator|&
name|peerlws
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_WIDTH_ACTIVE_F
argument_list|,
operator|&
name|peerlwa
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_SUPPORTED_F
argument_list|,
operator|&
name|peerlss
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|,
operator|&
name|peerlsa
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_ENABLED_F
argument_list|,
operator|&
name|peerlse
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data2
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_SUPPORTED_F
argument_list|,
operator|&
name|peerfdr10s
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data2
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_ENABLED_F
argument_list|,
operator|&
name|peerfdr10e
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data2
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_ACTIVE_F
argument_list|,
operator|&
name|peerfdr10a
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer_espeed_cap
condition|)
block|{
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_SUPPORTED_F
argument_list|,
operator|&
name|peerlses
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_ACTIVE_F
argument_list|,
operator|&
name|peerlsea
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_ENABLED_F
argument_list|,
operator|&
name|peerlsee
argument_list|)
expr_stmt|;
block|}
comment|/* Now validate peer port characteristics */
comment|/* Examine Link Width */
name|width
operator|=
name|get_link_width
argument_list|(
name|lwe
argument_list|,
name|lws
argument_list|)
expr_stmt|;
name|peerwidth
operator|=
name|get_link_width
argument_list|(
name|peerlwe
argument_list|,
name|peerlws
argument_list|)
expr_stmt|;
name|validate_width
argument_list|(
name|width
argument_list|,
name|peerwidth
argument_list|,
name|lwa
argument_list|)
expr_stmt|;
comment|/* Examine Link Speeds */
name|speed
operator|=
name|get_link_speed
argument_list|(
name|lse
argument_list|,
name|lss
argument_list|)
expr_stmt|;
name|peerspeed
operator|=
name|get_link_speed
argument_list|(
name|peerlse
argument_list|,
name|peerlss
argument_list|)
expr_stmt|;
name|validate_speed
argument_list|(
name|speed
argument_list|,
name|peerspeed
argument_list|,
name|lsa
argument_list|)
expr_stmt|;
if|if
condition|(
name|espeed_cap
operator|&&
name|peer_espeed_cap
condition|)
block|{
name|espeed
operator|=
name|get_link_speed_ext
argument_list|(
name|lsee
argument_list|,
name|lses
argument_list|)
expr_stmt|;
name|peerespeed
operator|=
name|get_link_speed_ext
argument_list|(
name|peerlsee
argument_list|,
name|peerlses
argument_list|)
expr_stmt|;
name|validate_extended_speed
argument_list|(
name|espeed
argument_list|,
name|peerespeed
argument_list|,
name|lsea
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|fdr10e
operator|&
name|FDR10
operator|&&
name|peerfdr10e
operator|&
name|FDR10
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fdr10a
operator|&
name|FDR10
operator|)
condition|)
name|IBWARN
argument_list|(
literal|"Peer ports operating at active speed %d rather than FDR10"
argument_list|,
name|lsa
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|close_port
label|:
name|mad_rpc_close_port
argument_list|(
name|srcport
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


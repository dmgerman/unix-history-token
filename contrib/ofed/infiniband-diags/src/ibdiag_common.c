begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006-2007 The Regents of the University of California.  * Copyright (c) 2004-2009 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2010 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  * Copyright (c) 2009 HNR Consulting. All rights reserved.  * Copyright (c) 2011 Lawrence Livermore National Security. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/**  * Define common functions which can be included in the various C based diags.  */
end_comment

begin_define
define|#
directive|define
name|_GNU_SOURCE
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/umad.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/mad.h>
end_include

begin_include
include|#
directive|include
file|<ibdiag_common.h>
end_include

begin_include
include|#
directive|include
file|<ibdiag_version.h>
end_include

begin_decl_stmt
name|int
name|ibverbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|enum
name|MAD_DEST
name|ibd_dest_type
init|=
name|IB_DEST_LID
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ib_portid_t
modifier|*
name|ibd_sm_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ib_portid_t
name|sm_portid
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* general config options */
end_comment

begin_define
define|#
directive|define
name|IBDIAG_CONFIG_GENERAL
value|IBDIAG_CONFIG_PATH"/ibdiag.conf"
end_define

begin_decl_stmt
name|char
modifier|*
name|ibd_ca
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ibd_ca_port
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ibd_timeout
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint32_t
name|ibd_ibnetdisc_flags
init|=
name|IBND_CONFIG_MLX_EPI
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|ibd_mkey
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|ibd_sakey
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|show_keys
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|ibd_nd_format
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|prog_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|prog_args
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
modifier|*
name|prog_examples
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|option
modifier|*
name|long_opts
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ibdiag_opt
modifier|*
name|opts_map
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_build_version
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|"BUILD VERSION: "
name|IBDIAG_VERSION
literal|" Build date: "
name|__DATE__
literal|" "
name|__TIME__
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pretty_print
parameter_list|(
name|int
name|start
parameter_list|,
name|int
name|width
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|len
init|=
name|width
operator|-
name|start
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|e
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|str
argument_list|)
condition|)
name|str
operator|++
expr_stmt|;
name|p
operator|=
name|str
expr_stmt|;
do|do
block|{
name|e
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|e
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|p
operator|&&
name|p
operator|-
name|str
operator|<
name|len
condition|)
do|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|e
operator|-
name|str
operator|==
literal|1
condition|)
name|e
operator|=
name|p
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%.*s\n%*s"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|e
operator|-
name|str
argument_list|)
argument_list|,
name|str
argument_list|,
name|start
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|str
operator|=
name|e
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|val_str_true
parameter_list|(
specifier|const
name|char
modifier|*
name|val_str
parameter_list|)
block|{
return|return
operator|(
operator|(
name|strncmp
argument_list|(
name|val_str
argument_list|,
literal|"TRUE"
argument_list|,
name|strlen
argument_list|(
literal|"TRUE"
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strncmp
argument_list|(
name|val_str
argument_list|,
literal|"true"
argument_list|,
name|strlen
argument_list|(
literal|"true"
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|read_ibdiag_config
parameter_list|(
specifier|const
name|char
modifier|*
name|file
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|FILE
modifier|*
name|config_fd
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|p_prefix
decl_stmt|,
modifier|*
name|p_last
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|val_str
decl_stmt|;
name|struct
name|stat
name|statbuf
decl_stmt|;
comment|/* silently ignore missing config file */
if|if
condition|(
name|stat
argument_list|(
name|file
argument_list|,
operator|&
name|statbuf
argument_list|)
condition|)
return|return;
name|config_fd
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|config_fd
condition|)
return|return;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|config_fd
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|p_prefix
operator|=
name|strtok_r
argument_list|(
name|buf
argument_list|,
literal|"\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_prefix
condition|)
continue|continue;
comment|/* ignore blank lines */
if|if
condition|(
operator|*
name|p_prefix
operator|==
literal|'#'
condition|)
continue|continue;
comment|/* ignore comment lines */
name|name
operator|=
name|strtok_r
argument_list|(
name|p_prefix
argument_list|,
literal|"="
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
name|val_str
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|"\n"
argument_list|,
operator|&
name|p_last
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"CA"
argument_list|,
name|strlen
argument_list|(
literal|"CA"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|ibd_ca
argument_list|)
expr_stmt|;
name|ibd_ca
operator|=
name|strdup
argument_list|(
name|val_str
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"Port"
argument_list|,
name|strlen
argument_list|(
literal|"Port"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ibd_ca_port
operator|=
name|strtoul
argument_list|(
name|val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"timeout"
argument_list|,
name|strlen
argument_list|(
literal|"timeout"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ibd_timeout
operator|=
name|strtoul
argument_list|(
name|val_str
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"MLX_EPI"
argument_list|,
name|strlen
argument_list|(
literal|"MLX_EPI"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|val_str_true
argument_list|(
name|val_str
argument_list|)
condition|)
block|{
name|ibd_ibnetdisc_flags
operator||=
name|IBND_CONFIG_MLX_EPI
expr_stmt|;
block|}
else|else
block|{
name|ibd_ibnetdisc_flags
operator|&=
operator|~
name|IBND_CONFIG_MLX_EPI
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"m_key"
argument_list|,
name|strlen
argument_list|(
literal|"m_key"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ibd_mkey
operator|=
name|strtoull
argument_list|(
name|val_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"sa_key"
argument_list|,
name|strlen
argument_list|(
literal|"sa_key"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ibd_sakey
operator|=
name|strtoull
argument_list|(
name|val_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"nd_format"
argument_list|,
name|strlen
argument_list|(
literal|"nd_format"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ibd_nd_format
operator|=
name|strdup
argument_list|(
name|val_str
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|config_fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ibdiag_show_usage
parameter_list|()
block|{
name|struct
name|option
modifier|*
name|o
init|=
name|long_opts
decl_stmt|;
name|int
name|n
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nUsage: %s [options] %s\n\n"
argument_list|,
name|prog_name
argument_list|,
name|prog_args
condition|?
name|prog_args
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|long_opts
index|[
literal|0
index|]
operator|.
name|name
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Options:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|o
operator|=
name|long_opts
init|;
name|o
operator|->
name|name
condition|;
name|o
operator|++
control|)
block|{
specifier|const
name|struct
name|ibdiag_opt
modifier|*
name|io
init|=
name|opts_map
index|[
name|o
operator|->
name|val
index|]
decl_stmt|;
name|n
operator|=
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  --%s"
argument_list|,
name|io
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|isprint
argument_list|(
name|io
operator|->
name|letter
argument_list|)
condition|)
name|n
operator|+=
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|", -%c"
argument_list|,
name|io
operator|->
name|letter
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|has_arg
condition|)
name|n
operator|+=
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" %s"
argument_list|,
name|io
operator|->
name|arg_tmpl
condition|?
name|io
operator|->
name|arg_tmpl
else|:
literal|"<val>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|description
operator|&&
operator|*
name|io
operator|->
name|description
condition|)
block|{
name|n
operator|+=
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%*s  "
argument_list|,
literal|24
operator|-
name|n
operator|>
literal|0
condition|?
literal|24
operator|-
name|n
else|:
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|pretty_print
argument_list|(
name|n
argument_list|,
literal|74
argument_list|,
name|io
operator|->
name|description
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|prog_examples
condition|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|p
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nExamples:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|prog_examples
init|;
operator|*
name|p
operator|&&
operator|*
operator|*
name|p
condition|;
name|p
operator|++
control|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %s %s\n"
argument_list|,
name|prog_name
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_opt
parameter_list|(
name|int
name|ch
parameter_list|,
name|char
modifier|*
name|optarg
parameter_list|)
block|{
name|char
modifier|*
name|endp
decl_stmt|;
name|long
name|val
decl_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'z'
case|:
name|read_ibdiag_config
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s %s\n"
argument_list|,
name|prog_name
argument_list|,
name|get_build_version
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
literal|'e'
case|:
name|madrpc_show_errors
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|ibverbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|ibdebug
operator|++
expr_stmt|;
name|madrpc_show_errors
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|umad_debug
argument_list|(
name|ibdebug
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|ibd_ca
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|ibd_ca_port
operator|=
name|strtoul
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibd_ca_port
operator|<
literal|0
condition|)
name|IBEXIT
argument_list|(
literal|"cannot resolve CA port %d"
argument_list|,
name|ibd_ca_port
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|ibd_dest_type
operator|=
name|IB_DEST_DRPATH
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|ibd_dest_type
operator|=
name|IB_DEST_LID
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
name|ibd_dest_type
operator|=
name|IB_DEST_GUID
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|errno
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|||
operator|(
name|endp
operator|&&
operator|*
name|endp
operator|!=
literal|'\0'
operator|)
operator|||
name|val
operator|<=
literal|0
operator|||
name|val
operator|>
name|INT_MAX
condition|)
name|IBEXIT
argument_list|(
literal|"Invalid timeout \"%s\".  Timeout requires a "
literal|"positive integer value< %d."
argument_list|,
name|optarg
argument_list|,
name|INT_MAX
argument_list|)
expr_stmt|;
else|else
block|{
name|madrpc_set_timeout
argument_list|(
operator|(
name|int
operator|)
name|val
argument_list|)
expr_stmt|;
name|ibd_timeout
operator|=
operator|(
name|int
operator|)
name|val
expr_stmt|;
block|}
break|break;
case|case
literal|'s'
case|:
comment|/* srcport is not required when resolving via IB_DEST_LID */
if|if
condition|(
name|resolve_portid_str
argument_list|(
name|ibd_ca
argument_list|,
name|ibd_ca_port
argument_list|,
operator|&
name|sm_portid
argument_list|,
name|optarg
argument_list|,
name|IB_DEST_LID
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
name|IBEXIT
argument_list|(
literal|"cannot resolve SM destination port %s"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|ibd_sm_id
operator|=
operator|&
name|sm_portid
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
name|show_keys
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'y'
case|:
name|errno
operator|=
literal|0
expr_stmt|;
name|ibd_mkey
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|||
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
name|ibd_mkey
operator|=
name|strtoull
argument_list|(
name|getpass
argument_list|(
literal|"M_Key: "
argument_list|)
argument_list|,
operator|&
name|endp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|||
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|IBEXIT
argument_list|(
literal|"Bad M_Key"
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ibdiag_opt
name|common_opts
index|[]
init|=
block|{
block|{
literal|"config"
block|,
literal|'z'
block|,
literal|1
block|,
literal|"<config>"
block|,
literal|"use config file, default: "
name|IBDIAG_CONFIG_GENERAL
block|}
block|,
block|{
literal|"Ca"
block|,
literal|'C'
block|,
literal|1
block|,
literal|"<ca>"
block|,
literal|"Ca name to use"
block|}
block|,
block|{
literal|"Port"
block|,
literal|'P'
block|,
literal|1
block|,
literal|"<port>"
block|,
literal|"Ca port number to use"
block|}
block|,
block|{
literal|"Direct"
block|,
literal|'D'
block|,
literal|0
block|,
name|NULL
block|,
literal|"use Direct address argument"
block|}
block|,
block|{
literal|"Lid"
block|,
literal|'L'
block|,
literal|0
block|,
name|NULL
block|,
literal|"use LID address argument"
block|}
block|,
block|{
literal|"Guid"
block|,
literal|'G'
block|,
literal|0
block|,
name|NULL
block|,
literal|"use GUID address argument"
block|}
block|,
block|{
literal|"timeout"
block|,
literal|'t'
block|,
literal|1
block|,
literal|"<ms>"
block|,
literal|"timeout in ms"
block|}
block|,
block|{
literal|"sm_port"
block|,
literal|'s'
block|,
literal|1
block|,
literal|"<lid>"
block|,
literal|"SM port lid"
block|}
block|,
block|{
literal|"show_keys"
block|,
literal|'K'
block|,
literal|0
block|,
name|NULL
block|,
literal|"display security keys in output"
block|}
block|,
block|{
literal|"m_key"
block|,
literal|'y'
block|,
literal|1
block|,
literal|"<key>"
block|,
literal|"M_Key to use in request"
block|}
block|,
block|{
literal|"errors"
block|,
literal|'e'
block|,
literal|0
block|,
name|NULL
block|,
literal|"show send and receive errors"
block|}
block|,
block|{
literal|"verbose"
block|,
literal|'v'
block|,
literal|0
block|,
name|NULL
block|,
literal|"increase verbosity level"
block|}
block|,
block|{
literal|"debug"
block|,
literal|'d'
block|,
literal|0
block|,
name|NULL
block|,
literal|"raise debug level"
block|}
block|,
block|{
literal|"help"
block|,
literal|'h'
block|,
literal|0
block|,
name|NULL
block|,
literal|"help message"
block|}
block|,
block|{
literal|"version"
block|,
literal|'V'
block|,
literal|0
block|,
name|NULL
block|,
literal|"show version"
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|make_opt
parameter_list|(
name|struct
name|option
modifier|*
name|l
parameter_list|,
specifier|const
name|struct
name|ibdiag_opt
modifier|*
name|o
parameter_list|,
specifier|const
name|struct
name|ibdiag_opt
modifier|*
name|map
index|[]
parameter_list|)
block|{
name|l
operator|->
name|name
operator|=
name|o
operator|->
name|name
expr_stmt|;
name|l
operator|->
name|has_arg
operator|=
name|o
operator|->
name|has_arg
expr_stmt|;
name|l
operator|->
name|flag
operator|=
name|NULL
expr_stmt|;
name|l
operator|->
name|val
operator|=
name|o
operator|->
name|letter
expr_stmt|;
if|if
condition|(
operator|!
name|map
index|[
name|l
operator|->
name|val
index|]
condition|)
name|map
index|[
name|l
operator|->
name|val
index|]
operator|=
name|o
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|option
modifier|*
name|make_long_opts
parameter_list|(
specifier|const
name|char
modifier|*
name|exclude_str
parameter_list|,
specifier|const
name|struct
name|ibdiag_opt
modifier|*
name|custom_opts
parameter_list|,
specifier|const
name|struct
name|ibdiag_opt
modifier|*
name|map
index|[]
parameter_list|)
block|{
name|struct
name|option
modifier|*
name|long_opts
decl_stmt|,
modifier|*
name|l
decl_stmt|;
specifier|const
name|struct
name|ibdiag_opt
modifier|*
name|o
decl_stmt|;
name|unsigned
name|n
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|custom_opts
condition|)
for|for
control|(
name|o
operator|=
name|custom_opts
init|;
name|o
operator|->
name|name
condition|;
name|o
operator|++
control|)
name|n
operator|++
expr_stmt|;
name|long_opts
operator|=
name|malloc
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|common_opts
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|common_opts
index|[
literal|0
index|]
argument_list|)
operator|+
name|n
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|long_opts
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|long_opts
condition|)
return|return
name|NULL
return|;
name|l
operator|=
name|long_opts
expr_stmt|;
if|if
condition|(
name|custom_opts
condition|)
for|for
control|(
name|o
operator|=
name|custom_opts
init|;
name|o
operator|->
name|name
condition|;
name|o
operator|++
control|)
name|make_opt
argument_list|(
name|l
operator|++
argument_list|,
name|o
argument_list|,
name|map
argument_list|)
expr_stmt|;
for|for
control|(
name|o
operator|=
name|common_opts
init|;
name|o
operator|->
name|name
condition|;
name|o
operator|++
control|)
block|{
if|if
condition|(
name|exclude_str
operator|&&
name|strchr
argument_list|(
name|exclude_str
argument_list|,
name|o
operator|->
name|letter
argument_list|)
condition|)
continue|continue;
name|make_opt
argument_list|(
name|l
operator|++
argument_list|,
name|o
argument_list|,
name|map
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|l
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|l
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|long_opts
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|make_str_opts
parameter_list|(
specifier|const
name|struct
name|option
modifier|*
name|o
parameter_list|,
name|char
modifier|*
name|p
parameter_list|,
name|unsigned
name|size
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|n
init|=
literal|0
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|o
operator|->
name|name
operator|&&
name|n
operator|+
literal|2
operator|+
name|o
operator|->
name|has_arg
operator|<
name|size
condition|;
name|o
operator|++
control|)
block|{
name|p
index|[
name|n
operator|++
index|]
operator|=
operator|(
name|char
operator|)
name|o
operator|->
name|val
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|unsigned
operator|)
name|o
operator|->
name|has_arg
condition|;
name|i
operator|++
control|)
name|p
index|[
name|n
operator|++
index|]
operator|=
literal|':'
expr_stmt|;
block|}
name|p
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ibdiag_process_opts
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
specifier|const
name|argv
index|[]
parameter_list|,
name|void
modifier|*
name|cxt
parameter_list|,
specifier|const
name|char
modifier|*
name|exclude_common_str
parameter_list|,
specifier|const
name|struct
name|ibdiag_opt
name|custom_opts
index|[]
parameter_list|,
name|int
function_decl|(
modifier|*
name|custom_handler
function_decl|)
parameter_list|(
name|void
modifier|*
name|cxt
parameter_list|,
name|int
name|val
parameter_list|,
name|char
modifier|*
name|optarg
parameter_list|)
parameter_list|,
specifier|const
name|char
modifier|*
name|usage_args
parameter_list|,
specifier|const
name|char
modifier|*
name|usage_examples
index|[]
parameter_list|)
block|{
name|char
name|str_opts
index|[
literal|1024
index|]
decl_stmt|;
specifier|const
name|struct
name|ibdiag_opt
modifier|*
name|o
decl_stmt|;
name|prog_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|prog_args
operator|=
name|usage_args
expr_stmt|;
name|prog_examples
operator|=
name|usage_examples
expr_stmt|;
if|if
condition|(
name|long_opts
condition|)
name|free
argument_list|(
name|long_opts
argument_list|)
expr_stmt|;
name|long_opts
operator|=
name|make_long_opts
argument_list|(
name|exclude_common_str
argument_list|,
name|custom_opts
argument_list|,
name|opts_map
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|long_opts
condition|)
return|return
operator|-
literal|1
return|;
name|read_ibdiag_config
argument_list|(
name|IBDIAG_CONFIG_GENERAL
argument_list|)
expr_stmt|;
name|make_str_opts
argument_list|(
name|long_opts
argument_list|,
name|str_opts
argument_list|,
sizeof|sizeof
argument_list|(
name|str_opts
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|ch
init|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|str_opts
argument_list|,
name|long_opts
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|ch
operator|==
operator|-
literal|1
condition|)
break|break;
name|o
operator|=
name|opts_map
index|[
name|ch
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|o
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|custom_handler
condition|)
block|{
if|if
condition|(
name|custom_handler
argument_list|(
name|cxt
argument_list|,
name|ch
argument_list|,
name|optarg
argument_list|)
operator|&&
name|process_opt
argument_list|(
name|ch
argument_list|,
name|optarg
argument_list|)
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|process_opt
argument_list|(
name|ch
argument_list|,
name|optarg
argument_list|)
condition|)
name|ibdiag_show_usage
argument_list|()
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ibexit
parameter_list|(
specifier|const
name|char
modifier|*
name|fn
parameter_list|,
name|char
modifier|*
name|msg
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
name|va_list
name|va
decl_stmt|;
name|int
name|n
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|n
operator|=
name|vsprintf
argument_list|(
name|buf
argument_list|,
name|msg
argument_list|,
name|va
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
name|buf
index|[
name|n
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ibdebug
condition|)
name|printf
argument_list|(
literal|"%s: iberror: [pid %d] %s: failed: %s\n"
argument_list|,
name|prog_name
condition|?
name|prog_name
else|:
literal|""
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|fn
argument_list|,
name|buf
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s: iberror: failed: %s\n"
argument_list|,
name|prog_name
condition|?
name|prog_name
else|:
literal|""
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|conv_cnt_human_readable
parameter_list|(
name|uint64_t
name|val64
parameter_list|,
name|float
modifier|*
name|val
parameter_list|,
name|int
name|data
parameter_list|)
block|{
name|uint64_t
name|tmp
init|=
name|val64
decl_stmt|;
name|int
name|ui
init|=
literal|0
decl_stmt|;
name|int
name|div
init|=
literal|1
decl_stmt|;
name|tmp
operator|/=
literal|1024
expr_stmt|;
while|while
condition|(
name|tmp
condition|)
block|{
name|ui
operator|++
expr_stmt|;
name|tmp
operator|/=
literal|1024
expr_stmt|;
name|div
operator|*=
literal|1024
expr_stmt|;
block|}
operator|*
name|val
operator|=
call|(
name|float
call|)
argument_list|(
name|val64
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
block|{
operator|*
name|val
operator|*=
literal|4
expr_stmt|;
if|if
condition|(
operator|*
name|val
operator|/
name|div
operator|>
literal|1024
condition|)
block|{
name|ui
operator|++
expr_stmt|;
name|div
operator|*=
literal|1024
expr_stmt|;
block|}
block|}
operator|*
name|val
operator|/=
name|div
expr_stmt|;
if|if
condition|(
name|data
condition|)
block|{
switch|switch
condition|(
name|ui
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
literal|"B"
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
literal|"KB"
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
literal|"MB"
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
literal|"GB"
operator|)
return|;
case|case
literal|4
case|:
return|return
operator|(
literal|"TB"
operator|)
return|;
case|case
literal|5
case|:
return|return
operator|(
literal|"PB"
operator|)
return|;
case|case
literal|6
case|:
return|return
operator|(
literal|"EB"
operator|)
return|;
default|default:
return|return
operator|(
literal|""
operator|)
return|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|ui
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
literal|""
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
literal|"K"
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
literal|"M"
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
literal|"G"
operator|)
return|;
case|case
literal|4
case|:
return|return
operator|(
literal|"T"
operator|)
return|;
case|case
literal|5
case|:
return|return
operator|(
literal|"P"
operator|)
return|;
case|case
literal|6
case|:
return|return
operator|(
literal|"E"
operator|)
return|;
default|default:
return|return
operator|(
literal|""
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|""
operator|)
return|;
block|}
end_function

begin_function
name|int
name|is_port_info_extended_supported
parameter_list|(
name|ib_portid_t
modifier|*
name|dest
parameter_list|,
name|int
name|port
parameter_list|,
name|struct
name|ibmad_port
modifier|*
name|srcport
parameter_list|)
block|{
name|uint8_t
name|data
index|[
name|IB_SMP_DATA_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint32_t
name|cap_mask
decl_stmt|;
name|uint16_t
name|cap_mask2
decl_stmt|;
if|if
condition|(
operator|!
name|smp_query_via
argument_list|(
name|data
argument_list|,
name|dest
argument_list|,
name|IB_ATTR_PORT_INFO
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|srcport
argument_list|)
condition|)
name|IBEXIT
argument_list|(
literal|"port info query failed"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_CAPMASK_F
argument_list|,
operator|&
name|cap_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|cap_mask
operator|&
name|CL_NTOH32
argument_list|(
name|IB_PORT_CAP_HAS_CAP_MASK2
argument_list|)
condition|)
block|{
name|mad_decode_field
argument_list|(
name|data
argument_list|,
name|IB_PORT_CAPMASK2_F
argument_list|,
operator|&
name|cap_mask2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cap_mask2
operator|&
name|CL_NTOH16
argument_list|(
name|IB_PORT_CAP2_IS_PORT_INFO_EXT_SUPPORTED
argument_list|)
operator|)
condition|)
block|{
name|IBWARN
argument_list|(
literal|"port info capability mask2 = 0x%x doesn't"
literal|" indicate PortInfoExtended support"
argument_list|,
name|cap_mask2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
block|{
name|IBWARN
argument_list|(
literal|"port info capability mask2 not supported"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|is_mlnx_ext_port_info_supported
parameter_list|(
name|uint32_t
name|vendorid
parameter_list|,
name|uint16_t
name|devid
parameter_list|)
block|{
if|if
condition|(
name|ibd_ibnetdisc_flags
operator|&
name|IBND_CONFIG_MLX_EPI
condition|)
block|{
if|if
condition|(
operator|(
name|devid
operator|>=
literal|0xc738
operator|&&
name|devid
operator|<=
literal|0xc73b
operator|)
operator|||
name|devid
operator|==
literal|0xcb20
operator|||
name|devid
operator|==
literal|0xcf08
operator|||
operator|(
operator|(
name|vendorid
operator|==
literal|0x119f
operator|)
operator|&&
comment|/* Bull SwitchX */
operator|(
name|devid
operator|==
literal|0x1b02
operator|||
name|devid
operator|==
literal|0x1b50
operator|||
comment|/* Bull SwitchIB and SwitchIB2 */
name|devid
operator|==
literal|0x1ba0
operator|||
operator|(
name|devid
operator|>=
literal|0x1bd0
operator|&&
name|devid
operator|<=
literal|0x1bd5
operator|)
operator|)
operator|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|(
name|devid
operator|>=
literal|0x1003
operator|&&
name|devid
operator|<=
literal|0x1017
operator|)
operator|||
operator|(
operator|(
name|vendorid
operator|==
literal|0x119f
operator|)
operator|&&
comment|/* Bull ConnectX3 */
operator|(
name|devid
operator|==
literal|0x1b33
operator|||
name|devid
operator|==
literal|0x1b73
operator|||
name|devid
operator|==
literal|0x1b40
operator|||
name|devid
operator|==
literal|0x1b41
operator|||
name|devid
operator|==
literal|0x1b60
operator|||
name|devid
operator|==
literal|0x1b61
operator|||
comment|/* Bull ConnectIB */
name|devid
operator|==
literal|0x1b83
operator|||
name|devid
operator|==
literal|0x1b93
operator|||
name|devid
operator|==
literal|0x1b94
operator|||
comment|/* Bull ConnectX4 */
name|devid
operator|==
literal|0x1bb4
operator|||
name|devid
operator|==
literal|0x1bb5
operator|||
name|devid
operator|==
literal|0x1bc4
operator|)
operator|)
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** =========================================================================  * Resolve the SM portid using the umad layer rather than using  * ib_resolve_smlid_via which requires a PortInfo query on the local port.  */
end_comment

begin_function
name|int
name|resolve_sm_portid
parameter_list|(
name|char
modifier|*
name|ca_name
parameter_list|,
name|uint8_t
name|portnum
parameter_list|,
name|ib_portid_t
modifier|*
name|sm_id
parameter_list|)
block|{
name|umad_port_t
name|port
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
operator|!
name|sm_id
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|(
name|rc
operator|=
name|umad_get_port
argument_list|(
name|ca_name
argument_list|,
name|portnum
argument_list|,
operator|&
name|port
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|rc
return|;
name|memset
argument_list|(
name|sm_id
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sm_id
argument_list|)
argument_list|)
expr_stmt|;
name|sm_id
operator|->
name|lid
operator|=
name|port
operator|.
name|sm_lid
expr_stmt|;
name|sm_id
operator|->
name|sl
operator|=
name|port
operator|.
name|sm_sl
expr_stmt|;
name|umad_release_port
argument_list|(
operator|&
name|port
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** =========================================================================  * Resolve local CA characteristics using the umad layer rather than using  * ib_resolve_self_via which requires SMP queries on the local port.  */
end_comment

begin_function
name|int
name|resolve_self
parameter_list|(
name|char
modifier|*
name|ca_name
parameter_list|,
name|uint8_t
name|ca_port
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|int
modifier|*
name|portnum
parameter_list|,
name|ibmad_gid_t
modifier|*
name|gid
parameter_list|)
block|{
name|umad_port_t
name|port
decl_stmt|;
name|uint64_t
name|prefix
decl_stmt|,
name|guid
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|portid
operator|||
name|portnum
operator|||
name|gid
operator|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|(
name|rc
operator|=
name|umad_get_port
argument_list|(
name|ca_name
argument_list|,
name|ca_port
argument_list|,
operator|&
name|port
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|rc
return|;
if|if
condition|(
name|portid
condition|)
block|{
name|memset
argument_list|(
name|portid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|portid
argument_list|)
argument_list|)
expr_stmt|;
name|portid
operator|->
name|lid
operator|=
name|port
operator|.
name|base_lid
expr_stmt|;
name|portid
operator|->
name|sl
operator|=
name|port
operator|.
name|sm_sl
expr_stmt|;
block|}
if|if
condition|(
name|portnum
condition|)
operator|*
name|portnum
operator|=
name|port
operator|.
name|portnum
expr_stmt|;
if|if
condition|(
name|gid
condition|)
block|{
name|memset
argument_list|(
name|gid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|gid
argument_list|)
argument_list|)
expr_stmt|;
name|prefix
operator|=
name|cl_ntoh64
argument_list|(
name|port
operator|.
name|gid_prefix
argument_list|)
expr_stmt|;
name|guid
operator|=
name|cl_ntoh64
argument_list|(
name|port
operator|.
name|port_guid
argument_list|)
expr_stmt|;
name|mad_encode_field
argument_list|(
operator|*
name|gid
argument_list|,
name|IB_GID_PREFIX_F
argument_list|,
operator|&
name|prefix
argument_list|)
expr_stmt|;
name|mad_encode_field
argument_list|(
operator|*
name|gid
argument_list|,
name|IB_GID_GUID_F
argument_list|,
operator|&
name|guid
argument_list|)
expr_stmt|;
block|}
name|umad_release_port
argument_list|(
operator|&
name|port
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|resolve_gid
parameter_list|(
name|char
modifier|*
name|ca_name
parameter_list|,
name|uint8_t
name|ca_port
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|ibmad_gid_t
name|gid
parameter_list|,
name|ib_portid_t
modifier|*
name|sm_id
parameter_list|,
specifier|const
name|struct
name|ibmad_port
modifier|*
name|srcport
parameter_list|)
block|{
name|ib_portid_t
name|sm_portid
decl_stmt|;
name|char
name|buf
index|[
name|IB_SA_DATA_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|sm_id
condition|)
block|{
name|sm_id
operator|=
operator|&
name|sm_portid
expr_stmt|;
if|if
condition|(
name|resolve_sm_portid
argument_list|(
name|ca_name
argument_list|,
name|ca_port
argument_list|,
name|sm_id
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|portid
operator|->
name|lid
operator|=
name|ib_path_query_via
argument_list|(
name|srcport
argument_list|,
name|gid
argument_list|,
name|gid
argument_list|,
name|sm_id
argument_list|,
name|buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|resolve_guid
parameter_list|(
name|char
modifier|*
name|ca_name
parameter_list|,
name|uint8_t
name|ca_port
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|uint64_t
modifier|*
name|guid
parameter_list|,
name|ib_portid_t
modifier|*
name|sm_id
parameter_list|,
specifier|const
name|struct
name|ibmad_port
modifier|*
name|srcport
parameter_list|)
block|{
name|ib_portid_t
name|sm_portid
decl_stmt|;
name|uint8_t
name|buf
index|[
name|IB_SA_DATA_SIZE
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|uint64_t
name|prefix
decl_stmt|;
name|ibmad_gid_t
name|selfgid
decl_stmt|;
if|if
condition|(
operator|!
name|sm_id
condition|)
block|{
name|sm_id
operator|=
operator|&
name|sm_portid
expr_stmt|;
if|if
condition|(
name|resolve_sm_portid
argument_list|(
name|ca_name
argument_list|,
name|ca_port
argument_list|,
name|sm_id
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|resolve_self
argument_list|(
name|ca_name
argument_list|,
name|ca_port
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|selfgid
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
operator|&
name|prefix
argument_list|,
name|portid
operator|->
name|gid
argument_list|,
sizeof|sizeof
argument_list|(
name|prefix
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|prefix
condition|)
name|mad_set_field64
argument_list|(
name|portid
operator|->
name|gid
argument_list|,
literal|0
argument_list|,
name|IB_GID_PREFIX_F
argument_list|,
name|IB_DEFAULT_SUBN_PREFIX
argument_list|)
expr_stmt|;
if|if
condition|(
name|guid
condition|)
name|mad_set_field64
argument_list|(
name|portid
operator|->
name|gid
argument_list|,
literal|0
argument_list|,
name|IB_GID_GUID_F
argument_list|,
operator|*
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|portid
operator|->
name|lid
operator|=
name|ib_path_query_via
argument_list|(
name|srcport
argument_list|,
name|selfgid
argument_list|,
name|portid
operator|->
name|gid
argument_list|,
name|sm_id
argument_list|,
name|buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|mad_decode_field
argument_list|(
name|buf
argument_list|,
name|IB_SA_PR_SL_F
argument_list|,
operator|&
name|portid
operator|->
name|sl
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Callers of this function should ensure their ibmad_port has been opened with  * IB_SA_CLASS as this function may require the SA to resolve addresses.  */
end_comment

begin_function
name|int
name|resolve_portid_str
parameter_list|(
name|char
modifier|*
name|ca_name
parameter_list|,
name|uint8_t
name|ca_port
parameter_list|,
name|ib_portid_t
modifier|*
name|portid
parameter_list|,
name|char
modifier|*
name|addr_str
parameter_list|,
name|enum
name|MAD_DEST
name|dest_type
parameter_list|,
name|ib_portid_t
modifier|*
name|sm_id
parameter_list|,
specifier|const
name|struct
name|ibmad_port
modifier|*
name|srcport
parameter_list|)
block|{
name|ibmad_gid_t
name|gid
decl_stmt|;
name|uint64_t
name|guid
decl_stmt|;
name|int
name|lid
decl_stmt|;
name|char
modifier|*
name|routepath
decl_stmt|;
name|ib_portid_t
name|selfportid
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|selfport
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
name|portid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
expr|*
name|portid
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dest_type
condition|)
block|{
case|case
name|IB_DEST_LID
case|:
name|lid
operator|=
name|strtol
argument_list|(
name|addr_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IB_LID_VALID
argument_list|(
name|lid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ib_portid_set
argument_list|(
name|portid
argument_list|,
name|lid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
case|case
name|IB_DEST_DRPATH
case|:
if|if
condition|(
name|str2drpath
argument_list|(
operator|&
name|portid
operator|->
name|drpath
argument_list|,
name|addr_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
case|case
name|IB_DEST_GUID
case|:
if|if
condition|(
operator|!
operator|(
name|guid
operator|=
name|strtoull
argument_list|(
name|addr_str
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* keep guid in portid? */
return|return
name|resolve_guid
argument_list|(
name|ca_name
argument_list|,
name|ca_port
argument_list|,
name|portid
argument_list|,
operator|&
name|guid
argument_list|,
name|sm_id
argument_list|,
name|srcport
argument_list|)
return|;
case|case
name|IB_DEST_DRSLID
case|:
name|lid
operator|=
name|strtol
argument_list|(
name|addr_str
argument_list|,
operator|&
name|routepath
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|routepath
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|IB_LID_VALID
argument_list|(
name|lid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|ib_portid_set
argument_list|(
name|portid
argument_list|,
name|lid
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* handle DR parsing and set DrSLID to local lid */
if|if
condition|(
name|resolve_self
argument_list|(
name|ca_name
argument_list|,
name|ca_port
argument_list|,
operator|&
name|selfportid
argument_list|,
operator|&
name|selfport
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|str2drpath
argument_list|(
operator|&
name|portid
operator|->
name|drpath
argument_list|,
name|routepath
argument_list|,
name|selfportid
operator|.
name|lid
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
case|case
name|IB_DEST_GID
case|:
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|addr_str
argument_list|,
operator|&
name|gid
argument_list|)
operator|<=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|resolve_gid
argument_list|(
name|ca_name
argument_list|,
name|ca_port
argument_list|,
name|portid
argument_list|,
name|gid
argument_list|,
name|sm_id
argument_list|,
name|srcport
argument_list|)
return|;
default|default:
name|IBWARN
argument_list|(
literal|"bad dest_type %d"
argument_list|,
name|dest_type
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|get_max_width
parameter_list|(
name|unsigned
name|int
name|num
parameter_list|)
block|{
name|unsigned
name|r
init|=
literal|0
decl_stmt|;
comment|/* 1x */
if|if
condition|(
name|num
operator|&
literal|8
condition|)
name|r
operator|=
literal|3
expr_stmt|;
comment|/* 12x */
else|else
block|{
if|if
condition|(
name|num
operator|&
literal|4
condition|)
name|r
operator|=
literal|2
expr_stmt|;
comment|/* 8x */
elseif|else
if|if
condition|(
name|num
operator|&
literal|2
condition|)
name|r
operator|=
literal|1
expr_stmt|;
comment|/* 4x */
elseif|else
if|if
condition|(
name|num
operator|&
literal|0x10
condition|)
name|r
operator|=
literal|4
expr_stmt|;
comment|/* 2x */
block|}
return|return
operator|(
literal|1
operator|<<
name|r
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|get_max
parameter_list|(
name|unsigned
name|int
name|num
parameter_list|)
block|{
name|unsigned
name|r
init|=
literal|0
decl_stmt|;
comment|// r will be lg(num)
while|while
condition|(
name|num
operator|>>=
literal|1
condition|)
comment|// unroll for more speed...
name|r
operator|++
expr_stmt|;
return|return
operator|(
literal|1
operator|<<
name|r
operator|)
return|;
block|}
end_function

begin_function
name|void
name|get_max_msg
parameter_list|(
name|char
modifier|*
name|width_msg
parameter_list|,
name|char
modifier|*
name|speed_msg
parameter_list|,
name|int
name|msg_size
parameter_list|,
name|ibnd_port_t
modifier|*
name|port
parameter_list|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|uint32_t
name|max_speed
init|=
literal|0
decl_stmt|;
name|uint32_t
name|cap_mask
decl_stmt|,
name|rem_cap_mask
decl_stmt|,
name|fdr10
decl_stmt|;
name|uint8_t
modifier|*
name|info
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|max_width
init|=
name|get_max_width
argument_list|(
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_WIDTH_SUPPORTED_F
argument_list|)
operator|&
name|mad_get_field
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_WIDTH_SUPPORTED_F
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|max_width
operator|&
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_WIDTH_ACTIVE_F
argument_list|)
operator|)
operator|==
literal|0
condition|)
comment|// we are not at the max supported width
comment|// print what we could be at.
name|snprintf
argument_list|(
name|width_msg
argument_list|,
name|msg_size
argument_list|,
literal|"Could be %s"
argument_list|,
name|mad_dump_val
argument_list|(
name|IB_PORT_LINK_WIDTH_ACTIVE_F
argument_list|,
name|buf
argument_list|,
literal|64
argument_list|,
operator|&
name|max_width
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
block|{
if|if
condition|(
name|port
operator|->
name|node
operator|->
name|ports
index|[
literal|0
index|]
condition|)
name|info
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|port
operator|->
name|node
operator|->
name|ports
index|[
literal|0
index|]
operator|->
name|info
expr_stmt|;
block|}
else|else
name|info
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|port
operator|->
name|info
expr_stmt|;
if|if
condition|(
name|info
condition|)
name|cap_mask
operator|=
name|mad_get_field
argument_list|(
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_CAPMASK_F
argument_list|)
expr_stmt|;
else|else
name|cap_mask
operator|=
literal|0
expr_stmt|;
name|info
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|type
operator|==
name|IB_NODE_SWITCH
condition|)
block|{
if|if
condition|(
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|ports
index|[
literal|0
index|]
condition|)
name|info
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|port
operator|->
name|remoteport
operator|->
name|node
operator|->
name|ports
index|[
literal|0
index|]
operator|->
name|info
expr_stmt|;
block|}
else|else
name|info
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|port
operator|->
name|remoteport
operator|->
name|info
expr_stmt|;
if|if
condition|(
name|info
condition|)
name|rem_cap_mask
operator|=
name|mad_get_field
argument_list|(
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_CAPMASK_F
argument_list|)
expr_stmt|;
else|else
name|rem_cap_mask
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cap_mask
operator|&
name|CL_NTOH32
argument_list|(
name|IB_PORT_CAP_HAS_EXT_SPEEDS
argument_list|)
operator|&&
name|rem_cap_mask
operator|&
name|CL_NTOH32
argument_list|(
name|IB_PORT_CAP_HAS_EXT_SPEEDS
argument_list|)
condition|)
goto|goto
name|check_ext_speed
goto|;
name|check_fdr10_supp
label|:
name|fdr10
operator|=
operator|(
name|mad_get_field
argument_list|(
name|port
operator|->
name|ext_info
argument_list|,
literal|0
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_SUPPORTED_F
argument_list|)
operator|&
name|FDR10
operator|)
operator|&&
operator|(
name|mad_get_field
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|ext_info
argument_list|,
literal|0
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_SUPPORTED_F
argument_list|)
operator|&
name|FDR10
operator|)
expr_stmt|;
if|if
condition|(
name|fdr10
condition|)
goto|goto
name|check_fdr10_active
goto|;
name|max_speed
operator|=
name|get_max
argument_list|(
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_SUPPORTED_F
argument_list|)
operator|&
name|mad_get_field
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_SUPPORTED_F
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|max_speed
operator|&
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|)
operator|)
operator|==
literal|0
condition|)
comment|// we are not at the max supported speed
comment|// print what we could be at.
name|snprintf
argument_list|(
name|speed_msg
argument_list|,
name|msg_size
argument_list|,
literal|"Could be %s"
argument_list|,
name|mad_dump_val
argument_list|(
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|,
name|buf
argument_list|,
literal|64
argument_list|,
operator|&
name|max_speed
argument_list|)
argument_list|)
expr_stmt|;
return|return;
name|check_ext_speed
label|:
if|if
condition|(
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_SUPPORTED_F
argument_list|)
operator|==
literal|0
operator|||
name|mad_get_field
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_SUPPORTED_F
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|check_fdr10_supp
goto|;
name|max_speed
operator|=
name|get_max
argument_list|(
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_SUPPORTED_F
argument_list|)
operator|&
name|mad_get_field
argument_list|(
name|port
operator|->
name|remoteport
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_SUPPORTED_F
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|max_speed
operator|&
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_EXT_ACTIVE_F
argument_list|)
operator|)
operator|==
literal|0
condition|)
comment|// we are not at the max supported extended speed
comment|// print what we could be at.
name|snprintf
argument_list|(
name|speed_msg
argument_list|,
name|msg_size
argument_list|,
literal|"Could be %s"
argument_list|,
name|mad_dump_val
argument_list|(
name|IB_PORT_LINK_SPEED_EXT_ACTIVE_F
argument_list|,
name|buf
argument_list|,
literal|64
argument_list|,
operator|&
name|max_speed
argument_list|)
argument_list|)
expr_stmt|;
return|return;
name|check_fdr10_active
label|:
if|if
condition|(
operator|(
name|mad_get_field
argument_list|(
name|port
operator|->
name|ext_info
argument_list|,
literal|0
argument_list|,
name|IB_MLNX_EXT_PORT_LINK_SPEED_ACTIVE_F
argument_list|)
operator|&
name|FDR10
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Special case QDR to try to avoid confusion with FDR10 */
if|if
condition|(
name|mad_get_field
argument_list|(
name|port
operator|->
name|info
argument_list|,
literal|0
argument_list|,
name|IB_PORT_LINK_SPEED_ACTIVE_F
argument_list|)
operator|==
literal|4
condition|)
comment|/* QDR (10.0 Gbps) */
name|snprintf
argument_list|(
name|speed_msg
argument_list|,
name|msg_size
argument_list|,
literal|"Could be FDR10 (Found link at QDR but expected speed is FDR10)"
argument_list|)
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|speed_msg
argument_list|,
name|msg_size
argument_list|,
literal|"Could be FDR10"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|vsnprint_field
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|n
parameter_list|,
name|enum
name|MAD_FIELDS
name|f
parameter_list|,
name|int
name|spacing
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
name|va_list
name|va_args
parameter_list|)
block|{
name|int
name|len
decl_stmt|,
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|mad_field_name
argument_list|(
name|f
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|+
literal|2
operator|>
name|n
operator|||
name|spacing
operator|+
literal|1
operator|>
name|n
condition|)
return|return
literal|0
return|;
name|strncpy
argument_list|(
name|buf
argument_list|,
name|mad_field_name
argument_list|(
name|f
argument_list|)
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|':'
expr_stmt|;
for|for
control|(
name|i
operator|=
name|len
operator|+
literal|1
init|;
name|i
operator|<
name|spacing
operator|+
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|buf
index|[
name|i
index|]
operator|=
literal|'.'
expr_stmt|;
block|}
name|ret
operator|=
name|vsnprintf
argument_list|(
operator|&
name|buf
index|[
name|spacing
operator|+
literal|1
index|]
argument_list|,
name|n
operator|-
name|spacing
argument_list|,
name|format
argument_list|,
name|va_args
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
name|n
operator|-
name|spacing
condition|)
name|buf
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|ret
operator|+
name|spacing
return|;
block|}
end_function

begin_function
name|int
name|snprint_field
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|n
parameter_list|,
name|enum
name|MAD_FIELDS
name|f
parameter_list|,
name|int
name|spacing
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|val
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|va_start
argument_list|(
name|val
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|ret
operator|=
name|vsnprint_field
argument_list|(
name|buf
argument_list|,
name|n
argument_list|,
name|f
argument_list|,
name|spacing
argument_list|,
name|format
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|dump_portinfo
parameter_list|(
name|void
modifier|*
name|pi
parameter_list|,
name|int
name|tabs
parameter_list|)
block|{
name|int
name|field
decl_stmt|,
name|i
decl_stmt|;
name|char
name|val
index|[
literal|64
index|]
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
for|for
control|(
name|field
operator|=
name|IB_PORT_FIRST_F
init|;
name|field
operator|<
name|IB_PORT_LAST_F
condition|;
name|field
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tabs
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|field
operator|==
name|IB_PORT_MKEY_F
operator|&&
name|show_keys
operator|==
literal|0
condition|)
block|{
name|snprint_field
argument_list|(
name|buf
argument_list|,
literal|1024
argument_list|,
name|field
argument_list|,
literal|32
argument_list|,
name|NOT_DISPLAYED_STR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|field
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mad_dump_field
argument_list|(
name|field
argument_list|,
name|buf
argument_list|,
literal|1024
argument_list|,
name|val
argument_list|)
condition|)
return|return;
block|}
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|field
operator|=
name|IB_PORT_CAPMASK2_F
init|;
name|field
operator|<
name|IB_PORT_LINK_SPEED_EXT_LAST_F
condition|;
name|field
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tabs
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|mad_decode_field
argument_list|(
name|pi
argument_list|,
name|field
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mad_dump_field
argument_list|(
name|field
argument_list|,
name|buf
argument_list|,
literal|1024
argument_list|,
name|val
argument_list|)
condition|)
return|return;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|op_fn_t
modifier|*
name|match_op
parameter_list|(
specifier|const
name|match_rec_t
name|match_tbl
index|[]
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|match_rec_t
modifier|*
name|r
decl_stmt|;
for|for
control|(
name|r
operator|=
name|match_tbl
init|;
name|r
operator|->
name|name
condition|;
name|r
operator|++
control|)
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|r
operator|->
name|name
argument_list|,
name|name
argument_list|)
operator|||
operator|(
name|r
operator|->
name|alias
operator|&&
operator|!
name|strcasecmp
argument_list|(
name|r
operator|->
name|alias
argument_list|,
name|name
argument_list|)
operator|)
condition|)
return|return
name|r
operator|->
name|fn
return|;
return|return
name|NULL
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_CTL_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_preamble.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal_includes.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/assert.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/ctl.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/extent_dss.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/extent_mmap.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/mutex.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/nstime.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/size_classes.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/util.h"
end_include

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_comment
comment|/*  * ctl_mtx protects the following:  * - ctl_stats->*  */
end_comment

begin_decl_stmt
specifier|static
name|malloc_mutex_t
name|ctl_mtx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|ctl_initialized
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ctl_stats_t
modifier|*
name|ctl_stats
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ctl_arenas_t
modifier|*
name|ctl_arenas
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Helpers for named and indexed nodes. */
end_comment

begin_function
specifier|static
specifier|const
name|ctl_named_node_t
modifier|*
name|ctl_named_node
parameter_list|(
specifier|const
name|ctl_node_t
modifier|*
name|node
parameter_list|)
block|{
return|return
operator|(
operator|(
name|node
operator|->
name|named
operator|)
condition|?
operator|(
specifier|const
name|ctl_named_node_t
operator|*
operator|)
name|node
else|:
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|ctl_named_node_t
modifier|*
name|ctl_named_children
parameter_list|(
specifier|const
name|ctl_named_node_t
modifier|*
name|node
parameter_list|,
name|size_t
name|index
parameter_list|)
block|{
specifier|const
name|ctl_named_node_t
modifier|*
name|children
init|=
name|ctl_named_node
argument_list|(
name|node
operator|->
name|children
argument_list|)
decl_stmt|;
return|return
operator|(
name|children
condition|?
operator|&
name|children
index|[
name|index
index|]
else|:
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|ctl_indexed_node_t
modifier|*
name|ctl_indexed_node
parameter_list|(
specifier|const
name|ctl_node_t
modifier|*
name|node
parameter_list|)
block|{
return|return
operator|(
operator|!
name|node
operator|->
name|named
condition|?
operator|(
specifier|const
name|ctl_indexed_node_t
operator|*
operator|)
name|node
else|:
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Function prototypes for non-inline static functions. */
end_comment

begin_define
define|#
directive|define
name|CTL_PROTO
parameter_list|(
name|n
parameter_list|)
define|\
value|static int	n##_ctl(tsd_t *tsd, const size_t *mib, size_t miblen,	\     void *oldp, size_t *oldlenp, void *newp, size_t newlen);
end_define

begin_define
define|#
directive|define
name|INDEX_PROTO
parameter_list|(
name|n
parameter_list|)
define|\
value|static const ctl_named_node_t	*n##_index(tsdn_t *tsdn,		\     const size_t *mib, size_t miblen, size_t i);
end_define

begin_macro
name|CTL_PROTO
argument_list|(
argument|version
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|epoch
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|background_thread
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|thread_tcache_enabled
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|thread_tcache_flush
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|thread_prof_name
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|thread_prof_active
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|thread_arena
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|thread_allocated
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|thread_allocatedp
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|thread_deallocated
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|thread_deallocatedp
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_cache_oblivious
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_debug
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_fill
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_lazy_lock
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_malloc_conf
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_prof
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_prof_libgcc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_prof_libunwind
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_stats
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_thp
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_utrace
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|config_xmalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_abort
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_abort_conf
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_retain
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_dss
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_narenas
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_percpu_arena
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_background_thread
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_dirty_decay_ms
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_muzzy_decay_ms
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_stats_print
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_stats_print_opts
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_junk
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_zero
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_utrace
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_xmalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_tcache
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_lg_tcache_max
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_prof
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_prof_prefix
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_prof_active
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_prof_thread_active_init
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_lg_prof_sample
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_lg_prof_interval
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_prof_gdump
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_prof_final
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_prof_leak
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|opt_prof_accum
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|tcache_create
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|tcache_flush
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|tcache_destroy
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arena_i_initialized
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arena_i_decay
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arena_i_purge
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arena_i_reset
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arena_i_destroy
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arena_i_dss
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arena_i_dirty_decay_ms
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arena_i_muzzy_decay_ms
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arena_i_extent_hooks
argument_list|)
end_macro

begin_macro
name|INDEX_PROTO
argument_list|(
argument|arena_i
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_bin_i_size
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_bin_i_nregs
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_bin_i_slab_size
argument_list|)
end_macro

begin_macro
name|INDEX_PROTO
argument_list|(
argument|arenas_bin_i
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_lextent_i_size
argument_list|)
end_macro

begin_macro
name|INDEX_PROTO
argument_list|(
argument|arenas_lextent_i
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_narenas
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_dirty_decay_ms
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_muzzy_decay_ms
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_quantum
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_page
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_tcache_max
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_nbins
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_nhbins
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_nlextents
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|arenas_create
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|prof_thread_active_init
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|prof_active
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|prof_dump
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|prof_gdump
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|prof_reset
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|prof_interval
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|lg_prof_sample
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_small_allocated
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_small_nmalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_small_ndalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_small_nrequests
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_large_allocated
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_large_nmalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_large_ndalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_large_nrequests
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_bins_j_nmalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_bins_j_ndalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_bins_j_nrequests
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_bins_j_curregs
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_bins_j_nfills
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_bins_j_nflushes
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_bins_j_nslabs
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_bins_j_nreslabs
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_bins_j_curslabs
argument_list|)
end_macro

begin_macro
name|INDEX_PROTO
argument_list|(
argument|stats_arenas_i_bins_j
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_lextents_j_nmalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_lextents_j_ndalloc
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_lextents_j_nrequests
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_lextents_j_curlextents
argument_list|)
end_macro

begin_macro
name|INDEX_PROTO
argument_list|(
argument|stats_arenas_i_lextents_j
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_nthreads
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_uptime
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_dss
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_dirty_decay_ms
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_muzzy_decay_ms
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_pactive
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_pdirty
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_pmuzzy
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_mapped
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_retained
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_dirty_npurge
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_dirty_nmadvise
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_dirty_purged
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_muzzy_npurge
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_muzzy_nmadvise
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_muzzy_purged
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_base
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_internal
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_tcache_bytes
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_arenas_i_resident
argument_list|)
end_macro

begin_macro
name|INDEX_PROTO
argument_list|(
argument|stats_arenas_i
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_allocated
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_active
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_background_thread_num_threads
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_background_thread_num_runs
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_background_thread_run_interval
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_metadata
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_resident
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_mapped
argument_list|)
end_macro

begin_macro
name|CTL_PROTO
argument_list|(
argument|stats_retained
argument_list|)
end_macro

begin_define
define|#
directive|define
name|MUTEX_STATS_CTL_PROTO_GEN
parameter_list|(
name|n
parameter_list|)
define|\
value|CTL_PROTO(stats_##n##_num_ops)						\ CTL_PROTO(stats_##n##_num_wait)						\ CTL_PROTO(stats_##n##_num_spin_acq)					\ CTL_PROTO(stats_##n##_num_owner_switch)					\ CTL_PROTO(stats_##n##_total_wait_time)					\ CTL_PROTO(stats_##n##_max_wait_time)					\ CTL_PROTO(stats_##n##_max_num_thds)
end_define

begin_comment
comment|/* Global mutexes. */
end_comment

begin_define
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|MUTEX_STATS_CTL_PROTO_GEN(mutexes_##mtx)
end_define

begin_decl_stmt
name|MUTEX_PROF_GLOBAL_MUTEXES
undef|#
directive|undef
name|OP
comment|/* Per arena mutexes. */
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|MUTEX_STATS_CTL_PROTO_GEN(arenas_i_mutexes_##mtx)
name|MUTEX_PROF_ARENA_MUTEXES
undef|#
directive|undef
name|OP
comment|/* Arena bin mutexes. */
name|MUTEX_STATS_CTL_PROTO_GEN
argument_list|(
name|arenas_i_bins_j_mutex
argument_list|)
undef|#
directive|undef
name|MUTEX_STATS_CTL_PROTO_GEN
name|CTL_PROTO
argument_list|(
name|stats_mutexes_reset
argument_list|)
comment|/******************************************************************************/
comment|/* mallctl tree. */
define|#
directive|define
name|NAME
parameter_list|(
name|n
parameter_list|)
value|{true},	n
define|#
directive|define
name|CHILD
parameter_list|(
name|t
parameter_list|,
name|c
parameter_list|)
define|\
value|sizeof(c##_node) / sizeof(ctl_##t##_node_t),			\ 	(ctl_node_t *)c##_node,						\ 	NULL
define|#
directive|define
name|CTL
parameter_list|(
name|c
parameter_list|)
value|0, NULL, c##_ctl
comment|/*  * Only handles internal indexed nodes, since there are currently no external  * ones.  */
define|#
directive|define
name|INDEX
parameter_list|(
name|i
parameter_list|)
value|{false},	i##_index
decl|static const
name|ctl_named_node_t
name|thread_tcache_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"enabled"
argument_list|)
block|,
name|CTL
argument_list|(
argument|thread_tcache_enabled
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"flush"
argument_list|)
block|,
name|CTL
argument_list|(
argument|thread_tcache_flush
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|thread_prof_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"name"
argument_list|)
block|,
name|CTL
argument_list|(
argument|thread_prof_name
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"active"
argument_list|)
block|,
name|CTL
argument_list|(
argument|thread_prof_active
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|thread_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"arena"
argument_list|)
block|,
name|CTL
argument_list|(
argument|thread_arena
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"allocated"
argument_list|)
block|,
name|CTL
argument_list|(
argument|thread_allocated
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"allocatedp"
argument_list|)
block|,
name|CTL
argument_list|(
argument|thread_allocatedp
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"deallocated"
argument_list|)
block|,
name|CTL
argument_list|(
argument|thread_deallocated
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"deallocatedp"
argument_list|)
block|,
name|CTL
argument_list|(
argument|thread_deallocatedp
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"tcache"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|thread_tcache
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|thread_prof
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|config_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"cache_oblivious"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_cache_oblivious
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"debug"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_debug
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"fill"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_fill
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"lazy_lock"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_lazy_lock
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"malloc_conf"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_malloc_conf
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_prof
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof_libgcc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_prof_libgcc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof_libunwind"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_prof_libunwind
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"stats"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_stats
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"thp"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_thp
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"utrace"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_utrace
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"xmalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|config_xmalloc
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|opt_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"abort"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_abort
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"abort_conf"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_abort_conf
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"retain"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_retain
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dss"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_dss
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"narenas"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_narenas
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"percpu_arena"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_percpu_arena
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"background_thread"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_background_thread
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dirty_decay_ms"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_dirty_decay_ms
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"muzzy_decay_ms"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_muzzy_decay_ms
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"stats_print"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_stats_print
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"stats_print_opts"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_stats_print_opts
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"junk"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_junk
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"zero"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_zero
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"utrace"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_utrace
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"xmalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_xmalloc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"tcache"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_tcache
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"lg_tcache_max"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_lg_tcache_max
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_prof
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof_prefix"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_prof_prefix
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof_active"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_prof_active
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof_thread_active_init"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_prof_thread_active_init
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"lg_prof_sample"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_lg_prof_sample
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"lg_prof_interval"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_lg_prof_interval
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof_gdump"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_prof_gdump
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof_final"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_prof_final
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof_leak"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_prof_leak
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof_accum"
argument_list|)
block|,
name|CTL
argument_list|(
argument|opt_prof_accum
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|tcache_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"create"
argument_list|)
block|,
name|CTL
argument_list|(
argument|tcache_create
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"flush"
argument_list|)
block|,
name|CTL
argument_list|(
argument|tcache_flush
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"destroy"
argument_list|)
block|,
name|CTL
argument_list|(
argument|tcache_destroy
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|arena_i_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"initialized"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arena_i_initialized
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"decay"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arena_i_decay
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"purge"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arena_i_purge
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"reset"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arena_i_reset
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"destroy"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arena_i_destroy
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dss"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arena_i_dss
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dirty_decay_ms"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arena_i_dirty_decay_ms
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"muzzy_decay_ms"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arena_i_muzzy_decay_ms
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"extent_hooks"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arena_i_extent_hooks
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|super_arena_i_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|""
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|arena_i
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_indexed_node_t
name|arena_node
index|[]
init|=
block|{
block|{
name|INDEX
argument_list|(
argument|arena_i
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|arenas_bin_i_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"size"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_bin_i_size
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nregs"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_bin_i_nregs
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"slab_size"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_bin_i_slab_size
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|super_arenas_bin_i_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|""
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|arenas_bin_i
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_indexed_node_t
name|arenas_bin_node
index|[]
init|=
block|{
block|{
name|INDEX
argument_list|(
argument|arenas_bin_i
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|arenas_lextent_i_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"size"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_lextent_i_size
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|super_arenas_lextent_i_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|""
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|arenas_lextent_i
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_indexed_node_t
name|arenas_lextent_node
index|[]
init|=
block|{
block|{
name|INDEX
argument_list|(
argument|arenas_lextent_i
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|arenas_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"narenas"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_narenas
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dirty_decay_ms"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_dirty_decay_ms
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"muzzy_decay_ms"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_muzzy_decay_ms
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"quantum"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_quantum
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"page"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_page
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"tcache_max"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_tcache_max
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nbins"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_nbins
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nhbins"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_nhbins
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"bin"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|indexed
argument_list|,
argument|arenas_bin
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nlextents"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_nlextents
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"lextent"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|indexed
argument_list|,
argument|arenas_lextent
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"create"
argument_list|)
block|,
name|CTL
argument_list|(
argument|arenas_create
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|prof_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"thread_active_init"
argument_list|)
block|,
name|CTL
argument_list|(
argument|prof_thread_active_init
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"active"
argument_list|)
block|,
name|CTL
argument_list|(
argument|prof_active
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dump"
argument_list|)
block|,
name|CTL
argument_list|(
argument|prof_dump
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"gdump"
argument_list|)
block|,
name|CTL
argument_list|(
argument|prof_gdump
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"reset"
argument_list|)
block|,
name|CTL
argument_list|(
argument|prof_reset
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"interval"
argument_list|)
block|,
name|CTL
argument_list|(
argument|prof_interval
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"lg_sample"
argument_list|)
block|,
name|CTL
argument_list|(
argument|lg_prof_sample
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|stats_arenas_i_small_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"allocated"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_small_allocated
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nmalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_small_nmalloc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"ndalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_small_ndalloc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nrequests"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_small_nrequests
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|stats_arenas_i_large_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"allocated"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_large_allocated
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nmalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_large_nmalloc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"ndalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_large_ndalloc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nrequests"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_large_nrequests
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MUTEX_PROF_DATA_NODE
parameter_list|(
name|prefix
parameter_list|)
define|\
value|static const ctl_named_node_t stats_##prefix##_node[] = {		\ 	{NAME("num_ops"),						\ 	 CTL(stats_##prefix##_num_ops)},				\ 	{NAME("num_wait"),						\ 	 CTL(stats_##prefix##_num_wait)},				\ 	{NAME("num_spin_acq"),						\ 	 CTL(stats_##prefix##_num_spin_acq)},				\ 	{NAME("num_owner_switch"),					\ 	 CTL(stats_##prefix##_num_owner_switch)},			\ 	{NAME("total_wait_time"),					\ 	 CTL(stats_##prefix##_total_wait_time)},			\ 	{NAME("max_wait_time"),						\ 	 CTL(stats_##prefix##_max_wait_time)},				\ 	{NAME("max_num_thds"),						\ 	 CTL(stats_##prefix##_max_num_thds)}				\
comment|/* Note that # of current waiting thread not provided. */
value|\ };
end_define

begin_macro
name|MUTEX_PROF_DATA_NODE
argument_list|(
argument|arenas_i_bins_j_mutex
argument_list|)
end_macro

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|stats_arenas_i_bins_j_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"nmalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_bins_j_nmalloc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"ndalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_bins_j_ndalloc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nrequests"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_bins_j_nrequests
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"curregs"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_bins_j_curregs
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nfills"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_bins_j_nfills
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nflushes"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_bins_j_nflushes
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nslabs"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_bins_j_nslabs
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nreslabs"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_bins_j_nreslabs
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"curslabs"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_bins_j_curslabs
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"mutex"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats_arenas_i_bins_j_mutex
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|super_stats_arenas_i_bins_j_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|""
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats_arenas_i_bins_j
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_indexed_node_t
name|stats_arenas_i_bins_node
index|[]
init|=
block|{
block|{
name|INDEX
argument_list|(
argument|stats_arenas_i_bins_j
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|stats_arenas_i_lextents_j_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"nmalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_lextents_j_nmalloc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"ndalloc"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_lextents_j_ndalloc
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"nrequests"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_lextents_j_nrequests
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"curlextents"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_lextents_j_curlextents
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|super_stats_arenas_i_lextents_j_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|""
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats_arenas_i_lextents_j
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_indexed_node_t
name|stats_arenas_i_lextents_node
index|[]
init|=
block|{
block|{
name|INDEX
argument_list|(
argument|stats_arenas_i_lextents_j
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|MUTEX_PROF_DATA_NODE(arenas_i_mutexes_##mtx)
end_define

begin_decl_stmt
name|MUTEX_PROF_ARENA_MUTEXES
undef|#
directive|undef
name|OP
specifier|static
specifier|const
name|ctl_named_node_t
name|stats_arenas_i_mutexes_node
index|[]
init|=
block|{
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|{NAME(#mtx), CHILD(named, stats_arenas_i_mutexes_##mtx)},
name|MUTEX_PROF_ARENA_MUTEXES
undef|#
directive|undef
name|OP
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|stats_arenas_i_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"nthreads"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_nthreads
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"uptime"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_uptime
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dss"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_dss
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dirty_decay_ms"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_dirty_decay_ms
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"muzzy_decay_ms"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_muzzy_decay_ms
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"pactive"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_pactive
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"pdirty"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_pdirty
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"pmuzzy"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_pmuzzy
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"mapped"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_mapped
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"retained"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_retained
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dirty_npurge"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_dirty_npurge
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dirty_nmadvise"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_dirty_nmadvise
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"dirty_purged"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_dirty_purged
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"muzzy_npurge"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_muzzy_npurge
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"muzzy_nmadvise"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_muzzy_nmadvise
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"muzzy_purged"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_muzzy_purged
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"base"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_base
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"internal"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_internal
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"tcache_bytes"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_tcache_bytes
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"resident"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_arenas_i_resident
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"small"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats_arenas_i_small
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"large"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats_arenas_i_large
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"bins"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|indexed
argument_list|,
argument|stats_arenas_i_bins
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"lextents"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|indexed
argument_list|,
argument|stats_arenas_i_lextents
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"mutexes"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats_arenas_i_mutexes
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|super_stats_arenas_i_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|""
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats_arenas_i
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_indexed_node_t
name|stats_arenas_node
index|[]
init|=
block|{
block|{
name|INDEX
argument_list|(
argument|stats_arenas_i
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|stats_background_thread_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"num_threads"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_background_thread_num_threads
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"num_runs"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_background_thread_num_runs
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"run_interval"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_background_thread_run_interval
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|MUTEX_PROF_DATA_NODE(mutexes_##mtx)
end_define

begin_decl_stmt
name|MUTEX_PROF_GLOBAL_MUTEXES
undef|#
directive|undef
name|OP
specifier|static
specifier|const
name|ctl_named_node_t
name|stats_mutexes_node
index|[]
init|=
block|{
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|{NAME(#mtx), CHILD(named, stats_mutexes_##mtx)},
name|MUTEX_PROF_GLOBAL_MUTEXES
undef|#
directive|undef
name|OP
block|{
name|NAME
argument_list|(
literal|"reset"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_mutexes_reset
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|MUTEX_PROF_DATA_NODE
end_undef

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|stats_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"allocated"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_allocated
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"active"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_active
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"metadata"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_metadata
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"resident"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_resident
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"mapped"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_mapped
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"retained"
argument_list|)
block|,
name|CTL
argument_list|(
argument|stats_retained
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"background_thread"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats_background_thread
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"mutexes"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats_mutexes
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"arenas"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|indexed
argument_list|,
argument|stats_arenas
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|root_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|"version"
argument_list|)
block|,
name|CTL
argument_list|(
argument|version
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"epoch"
argument_list|)
block|,
name|CTL
argument_list|(
argument|epoch
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"background_thread"
argument_list|)
block|,
name|CTL
argument_list|(
argument|background_thread
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"thread"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|thread
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"config"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|config
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"opt"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|opt
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"tcache"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|tcache
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"arena"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|indexed
argument_list|,
argument|arena
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"arenas"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|arenas
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"prof"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|prof
argument_list|)
block|}
block|,
block|{
name|NAME
argument_list|(
literal|"stats"
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|stats
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|ctl_named_node_t
name|super_root_node
index|[]
init|=
block|{
block|{
name|NAME
argument_list|(
literal|""
argument_list|)
block|,
name|CHILD
argument_list|(
argument|named
argument_list|,
argument|root
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|NAME
end_undef

begin_undef
undef|#
directive|undef
name|CHILD
end_undef

begin_undef
undef|#
directive|undef
name|CTL
end_undef

begin_undef
undef|#
directive|undef
name|INDEX
end_undef

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*  * Sets *dst + *src non-atomically.  This is safe, since everything is  * synchronized by the ctl mutex.  */
end_comment

begin_function
specifier|static
name|void
name|accum_arena_stats_u64
parameter_list|(
name|arena_stats_u64_t
modifier|*
name|dst
parameter_list|,
name|arena_stats_u64_t
modifier|*
name|src
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|JEMALLOC_ATOMIC_U64
name|uint64_t
name|cur_dst
init|=
name|atomic_load_u64
argument_list|(
name|dst
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
decl_stmt|;
name|uint64_t
name|cur_src
init|=
name|atomic_load_u64
argument_list|(
name|src
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
decl_stmt|;
name|atomic_store_u64
argument_list|(
name|dst
argument_list|,
name|cur_dst
operator|+
name|cur_src
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
else|#
directive|else
operator|*
name|dst
operator|+=
operator|*
name|src
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Likewise: with ctl mutex synchronization, reading is simple. */
end_comment

begin_function
specifier|static
name|uint64_t
name|arena_stats_read_u64
parameter_list|(
name|arena_stats_u64_t
modifier|*
name|p
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|JEMALLOC_ATOMIC_U64
return|return
name|atomic_load_u64
argument_list|(
name|p
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
return|;
else|#
directive|else
return|return
operator|*
name|p
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|accum_atomic_zu
parameter_list|(
name|atomic_zu_t
modifier|*
name|dst
parameter_list|,
name|atomic_zu_t
modifier|*
name|src
parameter_list|)
block|{
name|size_t
name|cur_dst
init|=
name|atomic_load_zu
argument_list|(
name|dst
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
decl_stmt|;
name|size_t
name|cur_src
init|=
name|atomic_load_zu
argument_list|(
name|src
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
decl_stmt|;
name|atomic_store_zu
argument_list|(
name|dst
argument_list|,
name|cur_dst
operator|+
name|cur_src
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|unsigned
name|arenas_i2a_impl
parameter_list|(
name|size_t
name|i
parameter_list|,
name|bool
name|compat
parameter_list|,
name|bool
name|validate
parameter_list|)
block|{
name|unsigned
name|a
decl_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|MALLCTL_ARENAS_ALL
case|:
name|a
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|MALLCTL_ARENAS_DESTROYED
case|:
name|a
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|compat
operator|&&
name|i
operator|==
name|ctl_arenas
operator|->
name|narenas
condition|)
block|{
comment|/* 			 * Provide deprecated backward compatibility for 			 * accessing the merged stats at index narenas rather 			 * than via MALLCTL_ARENAS_ALL.  This is scheduled for 			 * removal in 6.0.0. 			 */
name|a
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|validate
operator|&&
name|i
operator|>=
name|ctl_arenas
operator|->
name|narenas
condition|)
block|{
name|a
operator|=
name|UINT_MAX
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * This function should never be called for an index 			 * more than one past the range of indices that have 			 * initialized ctl data. 			 */
name|assert
argument_list|(
name|i
operator|<
name|ctl_arenas
operator|->
name|narenas
operator|||
operator|(
operator|!
name|validate
operator|&&
name|i
operator|==
name|ctl_arenas
operator|->
name|narenas
operator|)
argument_list|)
expr_stmt|;
name|a
operator|=
operator|(
name|unsigned
operator|)
name|i
operator|+
literal|2
expr_stmt|;
block|}
break|break;
block|}
return|return
name|a
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|arenas_i2a
parameter_list|(
name|size_t
name|i
parameter_list|)
block|{
return|return
name|arenas_i2a_impl
argument_list|(
name|i
argument_list|,
name|true
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ctl_arena_t
modifier|*
name|arenas_i_impl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|size_t
name|i
parameter_list|,
name|bool
name|compat
parameter_list|,
name|bool
name|init
parameter_list|)
block|{
name|ctl_arena_t
modifier|*
name|ret
decl_stmt|;
name|assert
argument_list|(
operator|!
name|compat
operator|||
operator|!
name|init
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ctl_arenas
operator|->
name|arenas
index|[
name|arenas_i2a_impl
argument_list|(
name|i
argument_list|,
name|compat
argument_list|,
name|false
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|init
operator|&&
name|ret
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|config_stats
condition|)
block|{
struct|struct
name|container_s
block|{
name|ctl_arena_t
name|ctl_arena
decl_stmt|;
name|ctl_arena_stats_t
name|astats
decl_stmt|;
block|}
struct|;
name|struct
name|container_s
modifier|*
name|cont
init|=
operator|(
expr|struct
name|container_s
operator|*
operator|)
name|base_alloc
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|b0get
argument_list|()
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|container_s
argument_list|)
argument_list|,
name|QUANTUM
argument_list|)
decl_stmt|;
if|if
condition|(
name|cont
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ret
operator|=
operator|&
name|cont
operator|->
name|ctl_arena
expr_stmt|;
name|ret
operator|->
name|astats
operator|=
operator|&
name|cont
operator|->
name|astats
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
operator|(
name|ctl_arena_t
operator|*
operator|)
name|base_alloc
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|b0get
argument_list|()
argument_list|,
sizeof|sizeof
argument_list|(
name|ctl_arena_t
argument_list|)
argument_list|,
name|QUANTUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
block|}
name|ret
operator|->
name|arena_ind
operator|=
operator|(
name|unsigned
operator|)
name|i
expr_stmt|;
name|ctl_arenas
operator|->
name|arenas
index|[
name|arenas_i2a_impl
argument_list|(
name|i
argument_list|,
name|compat
argument_list|,
name|false
argument_list|)
index|]
operator|=
name|ret
expr_stmt|;
block|}
name|assert
argument_list|(
name|ret
operator|==
name|NULL
operator|||
name|arenas_i2a
argument_list|(
name|ret
operator|->
name|arena_ind
argument_list|)
operator|==
name|arenas_i2a
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ctl_arena_t
modifier|*
name|arenas_i
parameter_list|(
name|size_t
name|i
parameter_list|)
block|{
name|ctl_arena_t
modifier|*
name|ret
init|=
name|arenas_i_impl
argument_list|(
name|tsd_fetch
argument_list|()
argument_list|,
name|i
argument_list|,
name|true
argument_list|,
name|false
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|ret
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_arena_clear
parameter_list|(
name|ctl_arena_t
modifier|*
name|ctl_arena
parameter_list|)
block|{
name|ctl_arena
operator|->
name|nthreads
operator|=
literal|0
expr_stmt|;
name|ctl_arena
operator|->
name|dss
operator|=
name|dss_prec_names
index|[
name|dss_prec_limit
index|]
expr_stmt|;
name|ctl_arena
operator|->
name|dirty_decay_ms
operator|=
operator|-
literal|1
expr_stmt|;
name|ctl_arena
operator|->
name|muzzy_decay_ms
operator|=
operator|-
literal|1
expr_stmt|;
name|ctl_arena
operator|->
name|pactive
operator|=
literal|0
expr_stmt|;
name|ctl_arena
operator|->
name|pdirty
operator|=
literal|0
expr_stmt|;
name|ctl_arena
operator|->
name|pmuzzy
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|config_stats
condition|)
block|{
name|memset
argument_list|(
operator|&
name|ctl_arena
operator|->
name|astats
operator|->
name|astats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|arena_stats_t
argument_list|)
argument_list|)
expr_stmt|;
name|ctl_arena
operator|->
name|astats
operator|->
name|allocated_small
operator|=
literal|0
expr_stmt|;
name|ctl_arena
operator|->
name|astats
operator|->
name|nmalloc_small
operator|=
literal|0
expr_stmt|;
name|ctl_arena
operator|->
name|astats
operator|->
name|ndalloc_small
operator|=
literal|0
expr_stmt|;
name|ctl_arena
operator|->
name|astats
operator|->
name|nrequests_small
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|ctl_arena
operator|->
name|astats
operator|->
name|bstats
argument_list|,
literal|0
argument_list|,
name|NBINS
operator|*
sizeof|sizeof
argument_list|(
name|malloc_bin_stats_t
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ctl_arena
operator|->
name|astats
operator|->
name|lstats
argument_list|,
literal|0
argument_list|,
operator|(
name|NSIZES
operator|-
name|NBINS
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|malloc_large_stats_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_arena_stats_amerge
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|ctl_arena_t
modifier|*
name|ctl_arena
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
if|if
condition|(
name|config_stats
condition|)
block|{
name|arena_stats_merge
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|ctl_arena
operator|->
name|nthreads
argument_list|,
operator|&
name|ctl_arena
operator|->
name|dss
argument_list|,
operator|&
name|ctl_arena
operator|->
name|dirty_decay_ms
argument_list|,
operator|&
name|ctl_arena
operator|->
name|muzzy_decay_ms
argument_list|,
operator|&
name|ctl_arena
operator|->
name|pactive
argument_list|,
operator|&
name|ctl_arena
operator|->
name|pdirty
argument_list|,
operator|&
name|ctl_arena
operator|->
name|pmuzzy
argument_list|,
operator|&
name|ctl_arena
operator|->
name|astats
operator|->
name|astats
argument_list|,
name|ctl_arena
operator|->
name|astats
operator|->
name|bstats
argument_list|,
name|ctl_arena
operator|->
name|astats
operator|->
name|lstats
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBINS
condition|;
name|i
operator|++
control|)
block|{
name|ctl_arena
operator|->
name|astats
operator|->
name|allocated_small
operator|+=
name|ctl_arena
operator|->
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|curregs
operator|*
name|sz_index2size
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|ctl_arena
operator|->
name|astats
operator|->
name|nmalloc_small
operator|+=
name|ctl_arena
operator|->
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nmalloc
expr_stmt|;
name|ctl_arena
operator|->
name|astats
operator|->
name|ndalloc_small
operator|+=
name|ctl_arena
operator|->
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|ndalloc
expr_stmt|;
name|ctl_arena
operator|->
name|astats
operator|->
name|nrequests_small
operator|+=
name|ctl_arena
operator|->
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nrequests
expr_stmt|;
block|}
block|}
else|else
block|{
name|arena_basic_stats_merge
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|ctl_arena
operator|->
name|nthreads
argument_list|,
operator|&
name|ctl_arena
operator|->
name|dss
argument_list|,
operator|&
name|ctl_arena
operator|->
name|dirty_decay_ms
argument_list|,
operator|&
name|ctl_arena
operator|->
name|muzzy_decay_ms
argument_list|,
operator|&
name|ctl_arena
operator|->
name|pactive
argument_list|,
operator|&
name|ctl_arena
operator|->
name|pdirty
argument_list|,
operator|&
name|ctl_arena
operator|->
name|pmuzzy
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_arena_stats_sdmerge
parameter_list|(
name|ctl_arena_t
modifier|*
name|ctl_sdarena
parameter_list|,
name|ctl_arena_t
modifier|*
name|ctl_arena
parameter_list|,
name|bool
name|destroyed
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|destroyed
condition|)
block|{
name|ctl_sdarena
operator|->
name|nthreads
operator|+=
name|ctl_arena
operator|->
name|nthreads
expr_stmt|;
name|ctl_sdarena
operator|->
name|pactive
operator|+=
name|ctl_arena
operator|->
name|pactive
expr_stmt|;
name|ctl_sdarena
operator|->
name|pdirty
operator|+=
name|ctl_arena
operator|->
name|pdirty
expr_stmt|;
name|ctl_sdarena
operator|->
name|pmuzzy
operator|+=
name|ctl_arena
operator|->
name|pmuzzy
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|ctl_arena
operator|->
name|nthreads
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ctl_arena
operator|->
name|pactive
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ctl_arena
operator|->
name|pdirty
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ctl_arena
operator|->
name|pmuzzy
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config_stats
condition|)
block|{
name|ctl_arena_stats_t
modifier|*
name|sdstats
init|=
name|ctl_sdarena
operator|->
name|astats
decl_stmt|;
name|ctl_arena_stats_t
modifier|*
name|astats
init|=
name|ctl_arena
operator|->
name|astats
decl_stmt|;
if|if
condition|(
operator|!
name|destroyed
condition|)
block|{
name|accum_atomic_zu
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|mapped
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|mapped
argument_list|)
expr_stmt|;
name|accum_atomic_zu
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|retained
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|retained
argument_list|)
expr_stmt|;
block|}
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|decay_dirty
operator|.
name|npurge
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|decay_dirty
operator|.
name|npurge
argument_list|)
expr_stmt|;
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|decay_dirty
operator|.
name|nmadvise
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|decay_dirty
operator|.
name|nmadvise
argument_list|)
expr_stmt|;
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|decay_dirty
operator|.
name|purged
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|decay_dirty
operator|.
name|purged
argument_list|)
expr_stmt|;
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|decay_muzzy
operator|.
name|npurge
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|decay_muzzy
operator|.
name|npurge
argument_list|)
expr_stmt|;
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|decay_muzzy
operator|.
name|nmadvise
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|decay_muzzy
operator|.
name|nmadvise
argument_list|)
expr_stmt|;
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|decay_muzzy
operator|.
name|purged
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|decay_muzzy
operator|.
name|purged
argument_list|)
expr_stmt|;
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|malloc_mutex_prof_merge(				\&(sdstats->astats.mutex_prof_data[			\ 		        arena_prof_mutex_##mtx]),			\&(astats->astats.mutex_prof_data[			\ 		        arena_prof_mutex_##mtx]));
name|MUTEX_PROF_ARENA_MUTEXES
undef|#
directive|undef
name|OP
if|if
condition|(
operator|!
name|destroyed
condition|)
block|{
name|accum_atomic_zu
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|base
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|base
argument_list|)
expr_stmt|;
name|accum_atomic_zu
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|internal
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|internal
argument_list|)
expr_stmt|;
name|accum_atomic_zu
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|resident
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|resident
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|atomic_load_zu
argument_list|(
operator|&
name|astats
operator|->
name|astats
operator|.
name|internal
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|destroyed
condition|)
block|{
name|sdstats
operator|->
name|allocated_small
operator|+=
name|astats
operator|->
name|allocated_small
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|astats
operator|->
name|allocated_small
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|sdstats
operator|->
name|nmalloc_small
operator|+=
name|astats
operator|->
name|nmalloc_small
expr_stmt|;
name|sdstats
operator|->
name|ndalloc_small
operator|+=
name|astats
operator|->
name|ndalloc_small
expr_stmt|;
name|sdstats
operator|->
name|nrequests_small
operator|+=
name|astats
operator|->
name|nrequests_small
expr_stmt|;
if|if
condition|(
operator|!
name|destroyed
condition|)
block|{
name|accum_atomic_zu
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|allocated_large
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|allocated_large
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|atomic_load_zu
argument_list|(
operator|&
name|astats
operator|->
name|astats
operator|.
name|allocated_large
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|nmalloc_large
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|nmalloc_large
argument_list|)
expr_stmt|;
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|ndalloc_large
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|ndalloc_large
argument_list|)
expr_stmt|;
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|nrequests_large
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|nrequests_large
argument_list|)
expr_stmt|;
name|accum_atomic_zu
argument_list|(
operator|&
name|sdstats
operator|->
name|astats
operator|.
name|tcache_bytes
argument_list|,
operator|&
name|astats
operator|->
name|astats
operator|.
name|tcache_bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl_arena
operator|->
name|arena_ind
operator|==
literal|0
condition|)
block|{
name|sdstats
operator|->
name|astats
operator|.
name|uptime
operator|=
name|astats
operator|->
name|astats
operator|.
name|uptime
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBINS
condition|;
name|i
operator|++
control|)
block|{
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nmalloc
operator|+=
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nmalloc
expr_stmt|;
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|ndalloc
operator|+=
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|ndalloc
expr_stmt|;
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nrequests
operator|+=
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nrequests
expr_stmt|;
if|if
condition|(
operator|!
name|destroyed
condition|)
block|{
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|curregs
operator|+=
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|curregs
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|curregs
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nfills
operator|+=
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nfills
expr_stmt|;
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nflushes
operator|+=
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nflushes
expr_stmt|;
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nslabs
operator|+=
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|nslabs
expr_stmt|;
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|reslabs
operator|+=
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|reslabs
expr_stmt|;
if|if
condition|(
operator|!
name|destroyed
condition|)
block|{
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|curslabs
operator|+=
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|curslabs
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|curslabs
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|malloc_mutex_prof_merge
argument_list|(
operator|&
name|sdstats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|mutex_data
argument_list|,
operator|&
name|astats
operator|->
name|bstats
index|[
name|i
index|]
operator|.
name|mutex_data
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NSIZES
operator|-
name|NBINS
condition|;
name|i
operator|++
control|)
block|{
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|lstats
index|[
name|i
index|]
operator|.
name|nmalloc
argument_list|,
operator|&
name|astats
operator|->
name|lstats
index|[
name|i
index|]
operator|.
name|nmalloc
argument_list|)
expr_stmt|;
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|lstats
index|[
name|i
index|]
operator|.
name|ndalloc
argument_list|,
operator|&
name|astats
operator|->
name|lstats
index|[
name|i
index|]
operator|.
name|ndalloc
argument_list|)
expr_stmt|;
name|accum_arena_stats_u64
argument_list|(
operator|&
name|sdstats
operator|->
name|lstats
index|[
name|i
index|]
operator|.
name|nrequests
argument_list|,
operator|&
name|astats
operator|->
name|lstats
index|[
name|i
index|]
operator|.
name|nrequests
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|destroyed
condition|)
block|{
name|sdstats
operator|->
name|lstats
index|[
name|i
index|]
operator|.
name|curlextents
operator|+=
name|astats
operator|->
name|lstats
index|[
name|i
index|]
operator|.
name|curlextents
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|astats
operator|->
name|lstats
index|[
name|i
index|]
operator|.
name|curlextents
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_arena_refresh
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|ctl_arena_t
modifier|*
name|ctl_sdarena
parameter_list|,
name|unsigned
name|i
parameter_list|,
name|bool
name|destroyed
parameter_list|)
block|{
name|ctl_arena_t
modifier|*
name|ctl_arena
init|=
name|arenas_i
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|ctl_arena_clear
argument_list|(
name|ctl_arena
argument_list|)
expr_stmt|;
name|ctl_arena_stats_amerge
argument_list|(
name|tsdn
argument_list|,
name|ctl_arena
argument_list|,
name|arena
argument_list|)
expr_stmt|;
comment|/* Merge into sum stats as well. */
name|ctl_arena_stats_sdmerge
argument_list|(
name|ctl_sdarena
argument_list|,
name|ctl_arena
argument_list|,
name|destroyed
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|ctl_arena_init
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|)
block|{
name|unsigned
name|arena_ind
decl_stmt|;
name|ctl_arena_t
modifier|*
name|ctl_arena
decl_stmt|;
if|if
condition|(
operator|(
name|ctl_arena
operator|=
name|ql_last
argument_list|(
operator|&
name|ctl_arenas
operator|->
name|destroyed
argument_list|,
name|destroyed_link
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ql_remove
argument_list|(
operator|&
name|ctl_arenas
operator|->
name|destroyed
argument_list|,
name|ctl_arena
argument_list|,
name|destroyed_link
argument_list|)
expr_stmt|;
name|arena_ind
operator|=
name|ctl_arena
operator|->
name|arena_ind
expr_stmt|;
block|}
else|else
block|{
name|arena_ind
operator|=
name|ctl_arenas
operator|->
name|narenas
expr_stmt|;
block|}
comment|/* Trigger stats allocation. */
if|if
condition|(
name|arenas_i_impl
argument_list|(
name|tsd
argument_list|,
name|arena_ind
argument_list|,
name|false
argument_list|,
name|true
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|UINT_MAX
return|;
block|}
comment|/* Initialize new arena. */
if|if
condition|(
name|arena_init
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena_ind
argument_list|,
name|extent_hooks
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|UINT_MAX
return|;
block|}
if|if
condition|(
name|arena_ind
operator|==
name|ctl_arenas
operator|->
name|narenas
condition|)
block|{
name|ctl_arenas
operator|->
name|narenas
operator|++
expr_stmt|;
block|}
return|return
name|arena_ind
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_background_thread_stats_read
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|)
block|{
name|background_thread_stats_t
modifier|*
name|stats
init|=
operator|&
name|ctl_stats
operator|->
name|background_thread
decl_stmt|;
if|if
condition|(
operator|!
name|have_background_thread
operator|||
name|background_thread_stats_read
argument_list|(
name|tsdn
argument_list|,
name|stats
argument_list|)
condition|)
block|{
name|memset
argument_list|(
name|stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|background_thread_stats_t
argument_list|)
argument_list|)
expr_stmt|;
name|nstime_init
argument_list|(
operator|&
name|stats
operator|->
name|run_interval
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_refresh
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|ctl_arena_t
modifier|*
name|ctl_sarena
init|=
name|arenas_i
argument_list|(
name|MALLCTL_ARENAS_ALL
argument_list|)
decl_stmt|;
name|VARIABLE_ARRAY
argument_list|(
name|arena_t
operator|*
argument_list|,
name|tarenas
argument_list|,
name|ctl_arenas
operator|->
name|narenas
argument_list|)
expr_stmt|;
comment|/* 	 * Clear sum stats, since they will be merged into by 	 * ctl_arena_refresh(). 	 */
name|ctl_arena_clear
argument_list|(
name|ctl_sarena
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctl_arenas
operator|->
name|narenas
condition|;
name|i
operator|++
control|)
block|{
name|tarenas
index|[
name|i
index|]
operator|=
name|arena_get
argument_list|(
name|tsdn
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctl_arenas
operator|->
name|narenas
condition|;
name|i
operator|++
control|)
block|{
name|ctl_arena_t
modifier|*
name|ctl_arena
init|=
name|arenas_i
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|bool
name|initialized
init|=
operator|(
name|tarenas
index|[
name|i
index|]
operator|!=
name|NULL
operator|)
decl_stmt|;
name|ctl_arena
operator|->
name|initialized
operator|=
name|initialized
expr_stmt|;
if|if
condition|(
name|initialized
condition|)
block|{
name|ctl_arena_refresh
argument_list|(
name|tsdn
argument_list|,
name|tarenas
index|[
name|i
index|]
argument_list|,
name|ctl_sarena
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|config_stats
condition|)
block|{
name|ctl_stats
operator|->
name|allocated
operator|=
name|ctl_sarena
operator|->
name|astats
operator|->
name|allocated_small
operator|+
name|atomic_load_zu
argument_list|(
operator|&
name|ctl_sarena
operator|->
name|astats
operator|->
name|astats
operator|.
name|allocated_large
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
name|ctl_stats
operator|->
name|active
operator|=
operator|(
name|ctl_sarena
operator|->
name|pactive
operator|<<
name|LG_PAGE
operator|)
expr_stmt|;
name|ctl_stats
operator|->
name|metadata
operator|=
name|atomic_load_zu
argument_list|(
operator|&
name|ctl_sarena
operator|->
name|astats
operator|->
name|astats
operator|.
name|base
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
operator|+
name|atomic_load_zu
argument_list|(
operator|&
name|ctl_sarena
operator|->
name|astats
operator|->
name|astats
operator|.
name|internal
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
name|ctl_stats
operator|->
name|resident
operator|=
name|atomic_load_zu
argument_list|(
operator|&
name|ctl_sarena
operator|->
name|astats
operator|->
name|astats
operator|.
name|resident
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
name|ctl_stats
operator|->
name|mapped
operator|=
name|atomic_load_zu
argument_list|(
operator|&
name|ctl_sarena
operator|->
name|astats
operator|->
name|astats
operator|.
name|mapped
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
name|ctl_stats
operator|->
name|retained
operator|=
name|atomic_load_zu
argument_list|(
operator|&
name|ctl_sarena
operator|->
name|astats
operator|->
name|astats
operator|.
name|retained
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
name|ctl_background_thread_stats_read
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
define|#
directive|define
name|READ_GLOBAL_MUTEX_PROF_DATA
parameter_list|(
name|i
parameter_list|,
name|mtx
parameter_list|)
define|\
value|malloc_mutex_lock(tsdn,&mtx);					\     malloc_mutex_prof_read(tsdn,&ctl_stats->mutex_prof_data[i],&mtx);	\     malloc_mutex_unlock(tsdn,&mtx);
if|if
condition|(
name|config_prof
operator|&&
name|opt_prof
condition|)
block|{
name|READ_GLOBAL_MUTEX_PROF_DATA
argument_list|(
name|global_prof_mutex_prof
argument_list|,
name|bt2gctx_mtx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|have_background_thread
condition|)
block|{
name|READ_GLOBAL_MUTEX_PROF_DATA
argument_list|(
name|global_prof_mutex_background_thread
argument_list|,
name|background_thread_lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memset
argument_list|(
operator|&
name|ctl_stats
operator|->
name|mutex_prof_data
index|[
name|global_prof_mutex_background_thread
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mutex_prof_data_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* We own ctl mutex already. */
name|malloc_mutex_prof_read
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_stats
operator|->
name|mutex_prof_data
index|[
name|global_prof_mutex_ctl
index|]
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|READ_GLOBAL_MUTEX_PROF_DATA
block|}
name|ctl_arenas
operator|->
name|epoch
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ctl_init
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|)
block|{
name|bool
name|ret
decl_stmt|;
name|tsdn_t
modifier|*
name|tsdn
init|=
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctl_initialized
condition|)
block|{
name|ctl_arena_t
modifier|*
name|ctl_sarena
decl_stmt|,
modifier|*
name|ctl_darena
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
comment|/* 		 * Allocate demand-zeroed space for pointers to the full 		 * range of supported arena indices. 		 */
if|if
condition|(
name|ctl_arenas
operator|==
name|NULL
condition|)
block|{
name|ctl_arenas
operator|=
operator|(
name|ctl_arenas_t
operator|*
operator|)
name|base_alloc
argument_list|(
name|tsdn
argument_list|,
name|b0get
argument_list|()
argument_list|,
sizeof|sizeof
argument_list|(
name|ctl_arenas_t
argument_list|)
argument_list|,
name|QUANTUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl_arenas
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|true
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
if|if
condition|(
name|config_stats
operator|&&
name|ctl_stats
operator|==
name|NULL
condition|)
block|{
name|ctl_stats
operator|=
operator|(
name|ctl_stats_t
operator|*
operator|)
name|base_alloc
argument_list|(
name|tsdn
argument_list|,
name|b0get
argument_list|()
argument_list|,
sizeof|sizeof
argument_list|(
name|ctl_stats_t
argument_list|)
argument_list|,
name|QUANTUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl_stats
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|true
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
comment|/* 		 * Allocate space for the current full range of arenas 		 * here rather than doing it lazily elsewhere, in order 		 * to limit when OOM-caused errors can occur. 		 */
if|if
condition|(
operator|(
name|ctl_sarena
operator|=
name|arenas_i_impl
argument_list|(
name|tsd
argument_list|,
name|MALLCTL_ARENAS_ALL
argument_list|,
name|false
argument_list|,
name|true
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|true
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|ctl_sarena
operator|->
name|initialized
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|(
name|ctl_darena
operator|=
name|arenas_i_impl
argument_list|(
name|tsd
argument_list|,
name|MALLCTL_ARENAS_DESTROYED
argument_list|,
name|false
argument_list|,
name|true
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|true
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|ctl_arena_clear
argument_list|(
name|ctl_darena
argument_list|)
expr_stmt|;
comment|/* 		 * Don't toggle ctl_darena to initialized until an arena is 		 * actually destroyed, so that arena.<i>.initialized can be used 		 * to query whether the stats are relevant. 		 */
name|ctl_arenas
operator|->
name|narenas
operator|=
name|narenas_total_get
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctl_arenas
operator|->
name|narenas
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|arenas_i_impl
argument_list|(
name|tsd
argument_list|,
name|i
argument_list|,
name|false
argument_list|,
name|true
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|true
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
name|ql_new
argument_list|(
operator|&
name|ctl_arenas
operator|->
name|destroyed
argument_list|)
expr_stmt|;
name|ctl_refresh
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
name|ctl_initialized
operator|=
name|true
expr_stmt|;
block|}
name|ret
operator|=
name|false
expr_stmt|;
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_lookup
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|ctl_node_t
specifier|const
modifier|*
modifier|*
name|nodesp
parameter_list|,
name|size_t
modifier|*
name|mibp
parameter_list|,
name|size_t
modifier|*
name|depthp
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|elm
decl_stmt|,
modifier|*
name|tdot
decl_stmt|,
modifier|*
name|dot
decl_stmt|;
name|size_t
name|elen
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|const
name|ctl_named_node_t
modifier|*
name|node
decl_stmt|;
name|elm
operator|=
name|name
expr_stmt|;
comment|/* Equivalent to strchrnul(). */
name|dot
operator|=
operator|(
operator|(
name|tdot
operator|=
name|strchr
argument_list|(
name|elm
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|!=
name|NULL
operator|)
condition|?
name|tdot
else|:
name|strchr
argument_list|(
name|elm
argument_list|,
literal|'\0'
argument_list|)
expr_stmt|;
name|elen
operator|=
call|(
name|size_t
call|)
argument_list|(
operator|(
name|uintptr_t
operator|)
name|dot
operator|-
operator|(
name|uintptr_t
operator|)
name|elm
argument_list|)
expr_stmt|;
if|if
condition|(
name|elen
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|node
operator|=
name|super_root_node
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|depthp
condition|;
name|i
operator|++
control|)
block|{
name|assert
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|node
operator|->
name|nchildren
operator|>
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl_named_node
argument_list|(
name|node
operator|->
name|children
argument_list|)
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|ctl_named_node_t
modifier|*
name|pnode
init|=
name|node
decl_stmt|;
comment|/* Children are named. */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|node
operator|->
name|nchildren
condition|;
name|j
operator|++
control|)
block|{
specifier|const
name|ctl_named_node_t
modifier|*
name|child
init|=
name|ctl_named_children
argument_list|(
name|node
argument_list|,
name|j
argument_list|)
decl_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|child
operator|->
name|name
argument_list|)
operator|==
name|elen
operator|&&
name|strncmp
argument_list|(
name|elm
argument_list|,
name|child
operator|->
name|name
argument_list|,
name|elen
argument_list|)
operator|==
literal|0
condition|)
block|{
name|node
operator|=
name|child
expr_stmt|;
if|if
condition|(
name|nodesp
operator|!=
name|NULL
condition|)
block|{
name|nodesp
index|[
name|i
index|]
operator|=
operator|(
specifier|const
name|ctl_node_t
operator|*
operator|)
name|node
expr_stmt|;
block|}
name|mibp
index|[
name|i
index|]
operator|=
name|j
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|node
operator|==
name|pnode
condition|)
block|{
name|ret
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
else|else
block|{
name|uintmax_t
name|index
decl_stmt|;
specifier|const
name|ctl_indexed_node_t
modifier|*
name|inode
decl_stmt|;
comment|/* Children are indexed. */
name|index
operator|=
name|malloc_strtoumax
argument_list|(
name|elm
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|==
name|UINTMAX_MAX
operator|||
name|index
operator|>
name|SIZE_T_MAX
condition|)
block|{
name|ret
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|inode
operator|=
name|ctl_indexed_node
argument_list|(
name|node
operator|->
name|children
argument_list|)
expr_stmt|;
name|node
operator|=
name|inode
operator|->
name|index
argument_list|(
name|tsdn
argument_list|,
name|mibp
argument_list|,
operator|*
name|depthp
argument_list|,
operator|(
name|size_t
operator|)
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
if|if
condition|(
name|nodesp
operator|!=
name|NULL
condition|)
block|{
name|nodesp
index|[
name|i
index|]
operator|=
operator|(
specifier|const
name|ctl_node_t
operator|*
operator|)
name|node
expr_stmt|;
block|}
name|mibp
index|[
name|i
index|]
operator|=
operator|(
name|size_t
operator|)
name|index
expr_stmt|;
block|}
if|if
condition|(
name|node
operator|->
name|ctl
operator|!=
name|NULL
condition|)
block|{
comment|/* Terminal node. */
if|if
condition|(
operator|*
name|dot
operator|!=
literal|'\0'
condition|)
block|{
comment|/* 				 * The name contains more elements than are 				 * in this path through the tree. 				 */
name|ret
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
comment|/* Complete lookup successful. */
operator|*
name|depthp
operator|=
name|i
operator|+
literal|1
expr_stmt|;
break|break;
block|}
comment|/* Update elm. */
if|if
condition|(
operator|*
name|dot
operator|==
literal|'\0'
condition|)
block|{
comment|/* No more elements. */
name|ret
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|elm
operator|=
operator|&
name|dot
index|[
literal|1
index|]
expr_stmt|;
name|dot
operator|=
operator|(
operator|(
name|tdot
operator|=
name|strchr
argument_list|(
name|elm
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|!=
name|NULL
operator|)
condition|?
name|tdot
else|:
name|strchr
argument_list|(
name|elm
argument_list|,
literal|'\0'
argument_list|)
expr_stmt|;
name|elen
operator|=
call|(
name|size_t
call|)
argument_list|(
operator|(
name|uintptr_t
operator|)
name|dot
operator|-
operator|(
name|uintptr_t
operator|)
name|elm
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ctl_byname
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|size_t
name|depth
decl_stmt|;
name|ctl_node_t
specifier|const
modifier|*
name|nodes
index|[
name|CTL_MAX_DEPTH
index|]
decl_stmt|;
name|size_t
name|mib
index|[
name|CTL_MAX_DEPTH
index|]
decl_stmt|;
specifier|const
name|ctl_named_node_t
modifier|*
name|node
decl_stmt|;
if|if
condition|(
operator|!
name|ctl_initialized
operator|&&
name|ctl_init
argument_list|(
name|tsd
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|depth
operator|=
name|CTL_MAX_DEPTH
expr_stmt|;
name|ret
operator|=
name|ctl_lookup
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|name
argument_list|,
name|nodes
argument_list|,
name|mib
argument_list|,
operator|&
name|depth
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
goto|goto
name|label_return
goto|;
block|}
name|node
operator|=
name|ctl_named_node
argument_list|(
name|nodes
index|[
name|depth
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|!=
name|NULL
operator|&&
name|node
operator|->
name|ctl
condition|)
block|{
name|ret
operator|=
name|node
operator|->
name|ctl
argument_list|(
name|tsd
argument_list|,
name|mib
argument_list|,
name|depth
argument_list|,
name|oldp
argument_list|,
name|oldlenp
argument_list|,
name|newp
argument_list|,
name|newlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* The name refers to a partial path through the ctl tree. */
name|ret
operator|=
name|ENOENT
expr_stmt|;
block|}
name|label_return
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ctl_nametomib
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|size_t
modifier|*
name|mibp
parameter_list|,
name|size_t
modifier|*
name|miblenp
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|ctl_initialized
operator|&&
name|ctl_init
argument_list|(
name|tsd
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|ret
operator|=
name|ctl_lookup
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|,
name|mibp
argument_list|,
name|miblenp
argument_list|)
expr_stmt|;
name|label_return
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ctl_bymib
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
specifier|const
name|ctl_named_node_t
modifier|*
name|node
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|ctl_initialized
operator|&&
name|ctl_init
argument_list|(
name|tsd
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
comment|/* Iterate down the tree. */
name|node
operator|=
name|super_root_node
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|miblen
condition|;
name|i
operator|++
control|)
block|{
name|assert
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|node
operator|->
name|nchildren
operator|>
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl_named_node
argument_list|(
name|node
operator|->
name|children
argument_list|)
operator|!=
name|NULL
condition|)
block|{
comment|/* Children are named. */
if|if
condition|(
name|node
operator|->
name|nchildren
operator|<=
name|mib
index|[
name|i
index|]
condition|)
block|{
name|ret
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|node
operator|=
name|ctl_named_children
argument_list|(
name|node
argument_list|,
name|mib
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|ctl_indexed_node_t
modifier|*
name|inode
decl_stmt|;
comment|/* Indexed element. */
name|inode
operator|=
name|ctl_indexed_node
argument_list|(
name|node
operator|->
name|children
argument_list|)
expr_stmt|;
name|node
operator|=
name|inode
operator|->
name|index
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|mib
argument_list|,
name|miblen
argument_list|,
name|mib
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
block|}
comment|/* Call the ctl function. */
if|if
condition|(
name|node
operator|&&
name|node
operator|->
name|ctl
condition|)
block|{
name|ret
operator|=
name|node
operator|->
name|ctl
argument_list|(
name|tsd
argument_list|,
name|mib
argument_list|,
name|miblen
argument_list|,
name|oldp
argument_list|,
name|oldlenp
argument_list|,
name|newp
argument_list|,
name|newlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Partial MIB. */
name|ret
operator|=
name|ENOENT
expr_stmt|;
block|}
name|label_return
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|bool
name|ctl_boot
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|malloc_mutex_init
argument_list|(
operator|&
name|ctl_mtx
argument_list|,
literal|"ctl"
argument_list|,
name|WITNESS_RANK_CTL
argument_list|,
name|malloc_mutex_rank_exclusive
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
name|ctl_initialized
operator|=
name|false
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
name|void
name|ctl_prefork
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|)
block|{
name|malloc_mutex_prefork
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ctl_postfork_parent
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|)
block|{
name|malloc_mutex_postfork_parent
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ctl_postfork_child
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|)
block|{
name|malloc_mutex_postfork_child
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* *_ctl() functions. */
end_comment

begin_define
define|#
directive|define
name|READONLY
parameter_list|()
value|do {						\ 	if (newp != NULL || newlen != 0) {				\ 		ret = EPERM;						\ 		goto label_return;					\ 	}								\ } while (0)
end_define

begin_define
define|#
directive|define
name|WRITEONLY
parameter_list|()
value|do {						\ 	if (oldp != NULL || oldlenp != NULL) {				\ 		ret = EPERM;						\ 		goto label_return;					\ 	}								\ } while (0)
end_define

begin_define
define|#
directive|define
name|READ_XOR_WRITE
parameter_list|()
value|do {					\ 	if ((oldp != NULL&& oldlenp != NULL)&& (newp != NULL ||	\ 	    newlen != 0)) {						\ 		ret = EPERM;						\ 		goto label_return;					\ 	}								\ } while (0)
end_define

begin_define
define|#
directive|define
name|READ
parameter_list|(
name|v
parameter_list|,
name|t
parameter_list|)
value|do {						\ 	if (oldp != NULL&& oldlenp != NULL) {				\ 		if (*oldlenp != sizeof(t)) {				\ 			size_t	copylen = (sizeof(t)<= *oldlenp)	\ 			    ? sizeof(t) : *oldlenp;			\ 			memcpy(oldp, (void *)&(v), copylen);		\ 			ret = EINVAL;					\ 			goto label_return;				\ 		}							\ 		*(t *)oldp = (v);					\ 	}								\ } while (0)
end_define

begin_define
define|#
directive|define
name|WRITE
parameter_list|(
name|v
parameter_list|,
name|t
parameter_list|)
value|do {						\ 	if (newp != NULL) {						\ 		if (newlen != sizeof(t)) {				\ 			ret = EINVAL;					\ 			goto label_return;				\ 		}							\ 		(v) = *(t *)newp;					\ 	}								\ } while (0)
end_define

begin_define
define|#
directive|define
name|MIB_UNSIGNED
parameter_list|(
name|v
parameter_list|,
name|i
parameter_list|)
value|do {						\ 	if (mib[i]> UINT_MAX) {					\ 		ret = EFAULT;						\ 		goto label_return;					\ 	}								\ 	v = (unsigned)mib[i];						\ } while (0)
end_define

begin_comment
comment|/*  * There's a lot of code duplication in the following macros due to limitations  * in how nested cpp macros are expanded.  */
end_comment

begin_define
define|#
directive|define
name|CTL_RO_CLGEN
parameter_list|(
name|c
parameter_list|,
name|l
parameter_list|,
name|n
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
define|\
value|static int								\ n##_ctl(tsd_t *tsd, const size_t *mib, size_t miblen, void *oldp,	\     size_t *oldlenp, void *newp, size_t newlen) {			\ 	int ret;							\ 	t oldval;							\ 									\ 	if (!(c)) {							\ 		return ENOENT;						\ 	}								\ 	if (l) {							\ 		malloc_mutex_lock(tsd_tsdn(tsd),&ctl_mtx);		\ 	}								\ 	READONLY();							\ 	oldval = (v);							\ 	READ(oldval, t);						\ 									\ 	ret = 0;							\ label_return:								\ 	if (l) {							\ 		malloc_mutex_unlock(tsd_tsdn(tsd),&ctl_mtx);		\ 	}								\ 	return ret;							\ }
end_define

begin_define
define|#
directive|define
name|CTL_RO_CGEN
parameter_list|(
name|c
parameter_list|,
name|n
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
define|\
value|static int								\ n##_ctl(tsd_t *tsd, const size_t *mib, size_t miblen, void *oldp,	\     size_t *oldlenp, void *newp, size_t newlen) {			\ 	int ret;							\ 	t oldval;							\ 									\ 	if (!(c)) {							\ 		return ENOENT;						\ 	}								\ 	malloc_mutex_lock(tsd_tsdn(tsd),&ctl_mtx);			\ 	READONLY();							\ 	oldval = (v);							\ 	READ(oldval, t);						\ 									\ 	ret = 0;							\ label_return:								\ 	malloc_mutex_unlock(tsd_tsdn(tsd),&ctl_mtx);			\ 	return ret;							\ }
end_define

begin_define
define|#
directive|define
name|CTL_RO_GEN
parameter_list|(
name|n
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
define|\
value|static int								\ n##_ctl(tsd_t *tsd, const size_t *mib, size_t miblen, void *oldp,	\     size_t *oldlenp, void *newp, size_t newlen) {			\ 	int ret;							\ 	t oldval;							\ 									\ 	malloc_mutex_lock(tsd_tsdn(tsd),&ctl_mtx);			\ 	READONLY();							\ 	oldval = (v);							\ 	READ(oldval, t);						\ 									\ 	ret = 0;							\ label_return:								\ 	malloc_mutex_unlock(tsd_tsdn(tsd),&ctl_mtx);			\ 	return ret;							\ }
end_define

begin_comment
comment|/*  * ctl_mtx is not acquired, under the assumption that no pertinent data will  * mutate during the call.  */
end_comment

begin_define
define|#
directive|define
name|CTL_RO_NL_CGEN
parameter_list|(
name|c
parameter_list|,
name|n
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
define|\
value|static int								\ n##_ctl(tsd_t *tsd, const size_t *mib, size_t miblen, void *oldp,	\     size_t *oldlenp, void *newp, size_t newlen) {			\ 	int ret;							\ 	t oldval;							\ 									\ 	if (!(c)) {							\ 		return ENOENT;						\ 	}								\ 	READONLY();							\ 	oldval = (v);							\ 	READ(oldval, t);						\ 									\ 	ret = 0;							\ label_return:								\ 	return ret;							\ }
end_define

begin_define
define|#
directive|define
name|CTL_RO_NL_GEN
parameter_list|(
name|n
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
define|\
value|static int								\ n##_ctl(tsd_t *tsd, const size_t *mib, size_t miblen, void *oldp,	\     size_t *oldlenp, void *newp, size_t newlen) {			\ 	int ret;							\ 	t oldval;							\ 									\ 	READONLY();							\ 	oldval = (v);							\ 	READ(oldval, t);						\ 									\ 	ret = 0;							\ label_return:								\ 	return ret;							\ }
end_define

begin_define
define|#
directive|define
name|CTL_TSD_RO_NL_CGEN
parameter_list|(
name|c
parameter_list|,
name|n
parameter_list|,
name|m
parameter_list|,
name|t
parameter_list|)
define|\
value|static int								\ n##_ctl(tsd_t *tsd, const size_t *mib, size_t miblen, void *oldp,	\     size_t *oldlenp, void *newp, size_t newlen) {			\ 	int ret;							\ 	t oldval;							\ 									\ 	if (!(c)) {							\ 		return ENOENT;						\ 	}								\ 	READONLY();							\ 	oldval = (m(tsd));						\ 	READ(oldval, t);						\ 									\ 	ret = 0;							\ label_return:								\ 	return ret;							\ }
end_define

begin_define
define|#
directive|define
name|CTL_RO_CONFIG_GEN
parameter_list|(
name|n
parameter_list|,
name|t
parameter_list|)
define|\
value|static int								\ n##_ctl(tsd_t *tsd, const size_t *mib, size_t miblen, void *oldp,	\     size_t *oldlenp, void *newp, size_t newlen) {			\ 	int ret;							\ 	t oldval;							\ 									\ 	READONLY();							\ 	oldval = n;							\ 	READ(oldval, t);						\ 									\ 	ret = 0;							\ label_return:								\ 	return ret;							\ }
end_define

begin_comment
comment|/******************************************************************************/
end_comment

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|version
argument_list|,
argument|JEMALLOC_VERSION
argument_list|,
argument|const char *
argument_list|)
end_macro

begin_function
specifier|static
name|int
name|epoch_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|UNUSED
name|uint64_t
name|newval
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
name|WRITE
argument_list|(
name|newval
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
name|ctl_refresh
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|READ
argument_list|(
name|ctl_arenas
operator|->
name|epoch
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|background_thread_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|bool
name|oldval
decl_stmt|;
if|if
condition|(
operator|!
name|have_background_thread
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
name|background_thread_ctl_init
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|background_thread_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|newp
operator|==
name|NULL
condition|)
block|{
name|oldval
operator|=
name|background_thread_enabled
argument_list|()
expr_stmt|;
name|READ
argument_list|(
name|oldval
argument_list|,
name|bool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|newlen
operator|!=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|oldval
operator|=
name|background_thread_enabled
argument_list|()
expr_stmt|;
name|READ
argument_list|(
name|oldval
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|bool
name|newval
init|=
operator|*
operator|(
name|bool
operator|*
operator|)
name|newp
decl_stmt|;
if|if
condition|(
name|newval
operator|==
name|oldval
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|background_thread_enabled_set
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|newval
argument_list|)
expr_stmt|;
if|if
condition|(
name|newval
condition|)
block|{
if|if
condition|(
operator|!
name|can_enable_background_thread
condition|)
block|{
name|malloc_printf
argument_list|(
literal|"<jemalloc>: Error in dlsym("
literal|"RTLD_NEXT, \"pthread_create\"). Cannot "
literal|"enable background_thread\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
if|if
condition|(
name|background_threads_enable
argument_list|(
name|tsd
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|background_threads_disable
argument_list|(
name|tsd
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|background_thread_lock
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_cache_oblivious
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_debug
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_fill
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_lazy_lock
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_malloc_conf
argument_list|,
argument|const char *
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_prof
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_prof_libgcc
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_prof_libunwind
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_stats
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_thp
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_utrace
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_CONFIG_GEN
argument_list|(
argument|config_xmalloc
argument_list|,
argument|bool
argument_list|)
end_macro

begin_comment
comment|/******************************************************************************/
end_comment

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_abort
argument_list|,
argument|opt_abort
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_abort_conf
argument_list|,
argument|opt_abort_conf
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_retain
argument_list|,
argument|opt_retain
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_dss
argument_list|,
argument|opt_dss
argument_list|,
argument|const char *
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_narenas
argument_list|,
argument|opt_narenas
argument_list|,
argument|unsigned
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_percpu_arena
argument_list|,
argument|percpu_arena_mode_names[opt_percpu_arena]
argument_list|,
argument|const char *
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_background_thread
argument_list|,
argument|opt_background_thread
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_dirty_decay_ms
argument_list|,
argument|opt_dirty_decay_ms
argument_list|,
argument|ssize_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_muzzy_decay_ms
argument_list|,
argument|opt_muzzy_decay_ms
argument_list|,
argument|ssize_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_stats_print
argument_list|,
argument|opt_stats_print
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_stats_print_opts
argument_list|,
argument|opt_stats_print_opts
argument_list|,
argument|const char *
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_fill
argument_list|,
argument|opt_junk
argument_list|,
argument|opt_junk
argument_list|,
argument|const char *
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_fill
argument_list|,
argument|opt_zero
argument_list|,
argument|opt_zero
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_utrace
argument_list|,
argument|opt_utrace
argument_list|,
argument|opt_utrace
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_xmalloc
argument_list|,
argument|opt_xmalloc
argument_list|,
argument|opt_xmalloc
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_tcache
argument_list|,
argument|opt_tcache
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|opt_lg_tcache_max
argument_list|,
argument|opt_lg_tcache_max
argument_list|,
argument|ssize_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_prof
argument_list|,
argument|opt_prof
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_prof_prefix
argument_list|,
argument|opt_prof_prefix
argument_list|,
argument|const char *
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_prof_active
argument_list|,
argument|opt_prof_active
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_prof_thread_active_init
argument_list|,
argument|opt_prof_thread_active_init
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_lg_prof_sample
argument_list|,
argument|opt_lg_prof_sample
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_prof_accum
argument_list|,
argument|opt_prof_accum
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_lg_prof_interval
argument_list|,
argument|opt_lg_prof_interval
argument_list|,
argument|ssize_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_prof_gdump
argument_list|,
argument|opt_prof_gdump
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_prof_final
argument_list|,
argument|opt_prof_final
argument_list|,
argument|bool
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|opt_prof_leak
argument_list|,
argument|opt_prof_leak
argument_list|,
argument|bool
argument_list|)
end_macro

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|thread_arena_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|arena_t
modifier|*
name|oldarena
decl_stmt|;
name|unsigned
name|newind
decl_stmt|,
name|oldind
decl_stmt|;
name|oldarena
operator|=
name|arena_choose
argument_list|(
name|tsd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldarena
operator|==
name|NULL
condition|)
block|{
return|return
name|EAGAIN
return|;
block|}
name|newind
operator|=
name|oldind
operator|=
name|arena_ind_get
argument_list|(
name|oldarena
argument_list|)
expr_stmt|;
name|WRITE
argument_list|(
name|newind
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|READ
argument_list|(
name|oldind
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|newind
operator|!=
name|oldind
condition|)
block|{
name|arena_t
modifier|*
name|newarena
decl_stmt|;
if|if
condition|(
name|newind
operator|>=
name|narenas_total_get
argument_list|()
condition|)
block|{
comment|/* New arena index is out of range. */
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
if|if
condition|(
name|have_percpu_arena
operator|&&
name|PERCPU_ARENA_ENABLED
argument_list|(
name|opt_percpu_arena
argument_list|)
condition|)
block|{
if|if
condition|(
name|newind
operator|<
name|percpu_arena_ind_limit
argument_list|(
name|opt_percpu_arena
argument_list|)
condition|)
block|{
comment|/* 				 * If perCPU arena is enabled, thread_arena 				 * control is not allowed for the auto arena 				 * range. 				 */
name|ret
operator|=
name|EPERM
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
comment|/* Initialize arena if necessary. */
name|newarena
operator|=
name|arena_get
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|newind
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|newarena
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
comment|/* Set new arena/tcache associations. */
name|arena_migrate
argument_list|(
name|tsd
argument_list|,
name|oldind
argument_list|,
name|newind
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcache_available
argument_list|(
name|tsd
argument_list|)
condition|)
block|{
name|tcache_arena_reassociate
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|tsd_tcachep_get
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|newarena
argument_list|)
expr_stmt|;
block|}
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_macro
name|CTL_TSD_RO_NL_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|thread_allocated
argument_list|,
argument|tsd_thread_allocated_get
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_TSD_RO_NL_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|thread_allocatedp
argument_list|,
argument|tsd_thread_allocatedp_get
argument_list|,
argument|uint64_t *
argument_list|)
end_macro

begin_macro
name|CTL_TSD_RO_NL_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|thread_deallocated
argument_list|,
argument|tsd_thread_deallocated_get
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_TSD_RO_NL_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|thread_deallocatedp
argument_list|,
argument|tsd_thread_deallocatedp_get
argument_list|,
argument|uint64_t *
argument_list|)
end_macro

begin_function
specifier|static
name|int
name|thread_tcache_enabled_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|bool
name|oldval
decl_stmt|;
name|oldval
operator|=
name|tcache_enabled_get
argument_list|(
name|tsd
argument_list|)
expr_stmt|;
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|newlen
operator|!=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|tcache_enabled_set
argument_list|(
name|tsd
argument_list|,
operator|*
operator|(
name|bool
operator|*
operator|)
name|newp
argument_list|)
expr_stmt|;
block|}
name|READ
argument_list|(
name|oldval
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|thread_tcache_flush_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|tcache_available
argument_list|(
name|tsd
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|READONLY
argument_list|()
expr_stmt|;
name|WRITEONLY
argument_list|()
expr_stmt|;
name|tcache_flush
argument_list|(
name|tsd
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|thread_prof_name_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|config_prof
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
name|READ_XOR_WRITE
argument_list|()
expr_stmt|;
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|newlen
operator|!=
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
if|if
condition|(
operator|(
name|ret
operator|=
name|prof_thread_name_set
argument_list|(
name|tsd
argument_list|,
operator|*
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|newp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|label_return
goto|;
block|}
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|oldname
init|=
name|prof_thread_name_get
argument_list|(
name|tsd
argument_list|)
decl_stmt|;
name|READ
argument_list|(
name|oldname
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|thread_prof_active_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|bool
name|oldval
decl_stmt|;
if|if
condition|(
operator|!
name|config_prof
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
name|oldval
operator|=
name|prof_thread_active_get
argument_list|(
name|tsd
argument_list|)
expr_stmt|;
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|newlen
operator|!=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
if|if
condition|(
name|prof_thread_active_set
argument_list|(
name|tsd
argument_list|,
operator|*
operator|(
name|bool
operator|*
operator|)
name|newp
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
name|READ
argument_list|(
name|oldval
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|tcache_create_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|tcache_ind
decl_stmt|;
name|READONLY
argument_list|()
expr_stmt|;
if|if
condition|(
name|tcaches_create
argument_list|(
name|tsd
argument_list|,
operator|&
name|tcache_ind
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|READ
argument_list|(
name|tcache_ind
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tcache_flush_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|tcache_ind
decl_stmt|;
name|WRITEONLY
argument_list|()
expr_stmt|;
name|tcache_ind
operator|=
name|UINT_MAX
expr_stmt|;
name|WRITE
argument_list|(
name|tcache_ind
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcache_ind
operator|==
name|UINT_MAX
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|tcaches_flush
argument_list|(
name|tsd
argument_list|,
name|tcache_ind
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tcache_destroy_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|tcache_ind
decl_stmt|;
name|WRITEONLY
argument_list|()
expr_stmt|;
name|tcache_ind
operator|=
name|UINT_MAX
expr_stmt|;
name|WRITE
argument_list|(
name|tcache_ind
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcache_ind
operator|==
name|UINT_MAX
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|tcaches_destroy
argument_list|(
name|tsd
argument_list|,
name|tcache_ind
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|arena_i_initialized_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|tsdn_t
modifier|*
name|tsdn
init|=
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
decl_stmt|;
name|unsigned
name|arena_ind
decl_stmt|;
name|bool
name|initialized
decl_stmt|;
name|READONLY
argument_list|()
expr_stmt|;
name|MIB_UNSIGNED
argument_list|(
name|arena_ind
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
name|initialized
operator|=
name|arenas_i
argument_list|(
name|arena_ind
argument_list|)
operator|->
name|initialized
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
name|READ
argument_list|(
name|initialized
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|arena_i_decay
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|,
name|bool
name|all
parameter_list|)
block|{
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
block|{
name|unsigned
name|narenas
init|=
name|ctl_arenas
operator|->
name|narenas
decl_stmt|;
comment|/* 		 * Access via index narenas is deprecated, and scheduled for 		 * removal in 6.0.0. 		 */
if|if
condition|(
name|arena_ind
operator|==
name|MALLCTL_ARENAS_ALL
operator|||
name|arena_ind
operator|==
name|narenas
condition|)
block|{
name|unsigned
name|i
decl_stmt|;
name|VARIABLE_ARRAY
argument_list|(
name|arena_t
operator|*
argument_list|,
name|tarenas
argument_list|,
name|narenas
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|narenas
condition|;
name|i
operator|++
control|)
block|{
name|tarenas
index|[
name|i
index|]
operator|=
name|arena_get
argument_list|(
name|tsdn
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * No further need to hold ctl_mtx, since narenas and 			 * tarenas contain everything needed below. 			 */
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|narenas
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tarenas
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|arena_decay
argument_list|(
name|tsdn
argument_list|,
name|tarenas
index|[
name|i
index|]
argument_list|,
name|false
argument_list|,
name|all
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|arena_t
modifier|*
name|tarena
decl_stmt|;
name|assert
argument_list|(
name|arena_ind
operator|<
name|narenas
argument_list|)
expr_stmt|;
name|tarena
operator|=
name|arena_get
argument_list|(
name|tsdn
argument_list|,
name|arena_ind
argument_list|,
name|false
argument_list|)
expr_stmt|;
comment|/* No further need to hold ctl_mtx. */
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|tarena
operator|!=
name|NULL
condition|)
block|{
name|arena_decay
argument_list|(
name|tsdn
argument_list|,
name|tarena
argument_list|,
name|false
argument_list|,
name|all
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_decay_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|arena_ind
decl_stmt|;
name|READONLY
argument_list|()
expr_stmt|;
name|WRITEONLY
argument_list|()
expr_stmt|;
name|MIB_UNSIGNED
argument_list|(
name|arena_ind
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|arena_i_decay
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena_ind
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_purge_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|arena_ind
decl_stmt|;
name|READONLY
argument_list|()
expr_stmt|;
name|WRITEONLY
argument_list|()
expr_stmt|;
name|MIB_UNSIGNED
argument_list|(
name|arena_ind
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|arena_i_decay
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena_ind
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_reset_destroy_helper
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|,
name|unsigned
modifier|*
name|arena_ind
parameter_list|,
name|arena_t
modifier|*
modifier|*
name|arena
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|READONLY
argument_list|()
expr_stmt|;
name|WRITEONLY
argument_list|()
expr_stmt|;
name|MIB_UNSIGNED
argument_list|(
operator|*
name|arena_ind
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|arena
operator|=
name|arena_get
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|*
name|arena_ind
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|arena
operator|==
name|NULL
operator|||
name|arena_is_auto
argument_list|(
operator|*
name|arena
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|arena_reset_prepare_background_thread
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
comment|/* Temporarily disable the background thread during arena reset. */
if|if
condition|(
name|have_background_thread
condition|)
block|{
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|background_thread_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|background_thread_enabled
argument_list|()
condition|)
block|{
name|unsigned
name|ind
init|=
name|arena_ind
operator|%
name|ncpus
decl_stmt|;
name|background_thread_info_t
modifier|*
name|info
init|=
operator|&
name|background_thread_info
index|[
name|ind
index|]
decl_stmt|;
name|assert
argument_list|(
name|info
operator|->
name|state
operator|==
name|background_thread_started
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|info
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|info
operator|->
name|state
operator|=
name|background_thread_paused
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|info
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|arena_reset_finish_background_thread
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
if|if
condition|(
name|have_background_thread
condition|)
block|{
if|if
condition|(
name|background_thread_enabled
argument_list|()
condition|)
block|{
name|unsigned
name|ind
init|=
name|arena_ind
operator|%
name|ncpus
decl_stmt|;
name|background_thread_info_t
modifier|*
name|info
init|=
operator|&
name|background_thread_info
index|[
name|ind
index|]
decl_stmt|;
name|assert
argument_list|(
name|info
operator|->
name|state
operator|==
name|background_thread_paused
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|info
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|info
operator|->
name|state
operator|=
name|background_thread_started
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|info
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|background_thread_lock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_reset_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|arena_ind
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|ret
operator|=
name|arena_i_reset_destroy_helper
argument_list|(
name|tsd
argument_list|,
name|mib
argument_list|,
name|miblen
argument_list|,
name|oldp
argument_list|,
name|oldlenp
argument_list|,
name|newp
argument_list|,
name|newlen
argument_list|,
operator|&
name|arena_ind
argument_list|,
operator|&
name|arena
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
return|return
name|ret
return|;
block|}
name|arena_reset_prepare_background_thread
argument_list|(
name|tsd
argument_list|,
name|arena_ind
argument_list|)
expr_stmt|;
name|arena_reset
argument_list|(
name|tsd
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|arena_reset_finish_background_thread
argument_list|(
name|tsd
argument_list|,
name|arena_ind
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_destroy_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|arena_ind
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|ctl_arena_t
modifier|*
name|ctl_darena
decl_stmt|,
modifier|*
name|ctl_arena
decl_stmt|;
name|ret
operator|=
name|arena_i_reset_destroy_helper
argument_list|(
name|tsd
argument_list|,
name|mib
argument_list|,
name|miblen
argument_list|,
name|oldp
argument_list|,
name|oldlenp
argument_list|,
name|newp
argument_list|,
name|newlen
argument_list|,
operator|&
name|arena_ind
argument_list|,
operator|&
name|arena
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
goto|goto
name|label_return
goto|;
block|}
if|if
condition|(
name|arena_nthreads_get
argument_list|(
name|arena
argument_list|,
name|false
argument_list|)
operator|!=
literal|0
operator|||
name|arena_nthreads_get
argument_list|(
name|arena
argument_list|,
name|true
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|arena_reset_prepare_background_thread
argument_list|(
name|tsd
argument_list|,
name|arena_ind
argument_list|)
expr_stmt|;
comment|/* Merge stats after resetting and purging arena. */
name|arena_reset
argument_list|(
name|tsd
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|arena_decay
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena
argument_list|,
name|false
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ctl_darena
operator|=
name|arenas_i
argument_list|(
name|MALLCTL_ARENAS_DESTROYED
argument_list|)
expr_stmt|;
name|ctl_darena
operator|->
name|initialized
operator|=
name|true
expr_stmt|;
name|ctl_arena_refresh
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena
argument_list|,
name|ctl_darena
argument_list|,
name|arena_ind
argument_list|,
name|true
argument_list|)
expr_stmt|;
comment|/* Destroy arena. */
name|arena_destroy
argument_list|(
name|tsd
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|ctl_arena
operator|=
name|arenas_i
argument_list|(
name|arena_ind
argument_list|)
expr_stmt|;
name|ctl_arena
operator|->
name|initialized
operator|=
name|false
expr_stmt|;
comment|/* Record arena index for later recycling via arenas.create. */
name|ql_elm_new
argument_list|(
name|ctl_arena
argument_list|,
name|destroyed_link
argument_list|)
expr_stmt|;
name|ql_tail_insert
argument_list|(
operator|&
name|ctl_arenas
operator|->
name|destroyed
argument_list|,
name|ctl_arena
argument_list|,
name|destroyed_link
argument_list|)
expr_stmt|;
name|arena_reset_finish_background_thread
argument_list|(
name|tsd
argument_list|,
name|arena_ind
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ret
operator|==
literal|0
argument_list|)
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_dss_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|dss
init|=
name|NULL
decl_stmt|;
name|unsigned
name|arena_ind
decl_stmt|;
name|dss_prec_t
name|dss_prec_old
init|=
name|dss_prec_limit
decl_stmt|;
name|dss_prec_t
name|dss_prec
init|=
name|dss_prec_limit
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
name|WRITE
argument_list|(
name|dss
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
name|MIB_UNSIGNED
argument_list|(
name|arena_ind
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dss
operator|!=
name|NULL
condition|)
block|{
name|int
name|i
decl_stmt|;
name|bool
name|match
init|=
name|false
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dss_prec_limit
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|dss_prec_names
index|[
name|i
index|]
argument_list|,
name|dss
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dss_prec
operator|=
name|i
expr_stmt|;
name|match
operator|=
name|true
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|match
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
comment|/* 	 * Access via index narenas is deprecated, and scheduled for removal in 	 * 6.0.0. 	 */
if|if
condition|(
name|arena_ind
operator|==
name|MALLCTL_ARENAS_ALL
operator|||
name|arena_ind
operator|==
name|ctl_arenas
operator|->
name|narenas
condition|)
block|{
if|if
condition|(
name|dss_prec
operator|!=
name|dss_prec_limit
operator|&&
name|extent_dss_prec_set
argument_list|(
name|dss_prec
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|dss_prec_old
operator|=
name|extent_dss_prec_get
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|arena_t
modifier|*
name|arena
init|=
name|arena_get
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena_ind
argument_list|,
name|false
argument_list|)
decl_stmt|;
if|if
condition|(
name|arena
operator|==
name|NULL
operator|||
operator|(
name|dss_prec
operator|!=
name|dss_prec_limit
operator|&&
name|arena_dss_prec_set
argument_list|(
name|arena
argument_list|,
name|dss_prec
argument_list|)
operator|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|dss_prec_old
operator|=
name|arena_dss_prec_get
argument_list|(
name|arena
argument_list|)
expr_stmt|;
block|}
name|dss
operator|=
name|dss_prec_names
index|[
name|dss_prec_old
index|]
expr_stmt|;
name|READ
argument_list|(
name|dss
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_decay_ms_ctl_impl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|,
name|bool
name|dirty
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|arena_ind
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|MIB_UNSIGNED
argument_list|(
name|arena_ind
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|arena
operator|=
name|arena_get
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena_ind
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|arena
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
if|if
condition|(
name|oldp
operator|!=
name|NULL
operator|&&
name|oldlenp
operator|!=
name|NULL
condition|)
block|{
name|size_t
name|oldval
init|=
name|dirty
condition|?
name|arena_dirty_decay_ms_get
argument_list|(
name|arena
argument_list|)
else|:
name|arena_muzzy_decay_ms_get
argument_list|(
name|arena
argument_list|)
decl_stmt|;
name|READ
argument_list|(
name|oldval
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|newlen
operator|!=
sizeof|sizeof
argument_list|(
name|ssize_t
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
if|if
condition|(
name|dirty
condition|?
name|arena_dirty_decay_ms_set
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena
argument_list|,
operator|*
operator|(
name|ssize_t
operator|*
operator|)
name|newp
argument_list|)
else|:
name|arena_muzzy_decay_ms_set
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena
argument_list|,
operator|*
operator|(
name|ssize_t
operator|*
operator|)
name|newp
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_dirty_decay_ms_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
return|return
name|arena_i_decay_ms_ctl_impl
argument_list|(
name|tsd
argument_list|,
name|mib
argument_list|,
name|miblen
argument_list|,
name|oldp
argument_list|,
name|oldlenp
argument_list|,
name|newp
argument_list|,
name|newlen
argument_list|,
name|true
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_muzzy_decay_ms_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
return|return
name|arena_i_decay_ms_ctl_impl
argument_list|(
name|tsd
argument_list|,
name|mib
argument_list|,
name|miblen
argument_list|,
name|oldp
argument_list|,
name|oldlenp
argument_list|,
name|newp
argument_list|,
name|newlen
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arena_i_extent_hooks_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|arena_ind
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
name|MIB_UNSIGNED
argument_list|(
name|arena_ind
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|arena_ind
operator|<
name|narenas_total_get
argument_list|()
operator|&&
operator|(
name|arena
operator|=
name|arena_get
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena_ind
argument_list|,
name|false
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
name|extent_hooks_t
modifier|*
name|old_extent_hooks
decl_stmt|;
name|extent_hooks_t
modifier|*
name|new_extent_hooks
name|JEMALLOC_CC_SILENCE_INIT
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
name|WRITE
argument_list|(
name|new_extent_hooks
argument_list|,
name|extent_hooks_t
operator|*
argument_list|)
expr_stmt|;
name|old_extent_hooks
operator|=
name|extent_hooks_set
argument_list|(
name|tsd
argument_list|,
name|arena
argument_list|,
name|new_extent_hooks
argument_list|)
expr_stmt|;
name|READ
argument_list|(
name|old_extent_hooks
argument_list|,
name|extent_hooks_t
operator|*
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|extent_hooks_t
modifier|*
name|old_extent_hooks
init|=
name|extent_hooks_get
argument_list|(
name|arena
argument_list|)
decl_stmt|;
name|READ
argument_list|(
name|old_extent_hooks
argument_list|,
name|extent_hooks_t
operator|*
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|ctl_named_node_t
modifier|*
name|arena_i_index
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|size_t
name|i
parameter_list|)
block|{
specifier|const
name|ctl_named_node_t
modifier|*
name|ret
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|MALLCTL_ARENAS_ALL
case|:
case|case
name|MALLCTL_ARENAS_DESTROYED
case|:
break|break;
default|default:
if|if
condition|(
name|i
operator|>
name|ctl_arenas
operator|->
name|narenas
condition|)
block|{
name|ret
operator|=
name|NULL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
break|break;
block|}
name|ret
operator|=
name|super_arena_i_node
expr_stmt|;
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|arenas_narenas_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|narenas
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
name|READONLY
argument_list|()
expr_stmt|;
if|if
condition|(
operator|*
name|oldlenp
operator|!=
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|narenas
operator|=
name|ctl_arenas
operator|->
name|narenas
expr_stmt|;
name|READ
argument_list|(
name|narenas
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arenas_decay_ms_ctl_impl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|,
name|bool
name|dirty
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|oldp
operator|!=
name|NULL
operator|&&
name|oldlenp
operator|!=
name|NULL
condition|)
block|{
name|size_t
name|oldval
init|=
operator|(
name|dirty
condition|?
name|arena_dirty_decay_ms_default_get
argument_list|()
else|:
name|arena_muzzy_decay_ms_default_get
argument_list|()
operator|)
decl_stmt|;
name|READ
argument_list|(
name|oldval
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|newlen
operator|!=
sizeof|sizeof
argument_list|(
name|ssize_t
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
if|if
condition|(
name|dirty
condition|?
name|arena_dirty_decay_ms_default_set
argument_list|(
operator|*
operator|(
name|ssize_t
operator|*
operator|)
name|newp
argument_list|)
else|:
name|arena_muzzy_decay_ms_default_set
argument_list|(
operator|*
operator|(
name|ssize_t
operator|*
operator|)
name|newp
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arenas_dirty_decay_ms_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
return|return
name|arenas_decay_ms_ctl_impl
argument_list|(
name|tsd
argument_list|,
name|mib
argument_list|,
name|miblen
argument_list|,
name|oldp
argument_list|,
name|oldlenp
argument_list|,
name|newp
argument_list|,
name|newlen
argument_list|,
name|true
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arenas_muzzy_decay_ms_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
return|return
name|arenas_decay_ms_ctl_impl
argument_list|(
name|tsd
argument_list|,
name|mib
argument_list|,
name|miblen
argument_list|,
name|oldp
argument_list|,
name|oldlenp
argument_list|,
name|newp
argument_list|,
name|newlen
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_quantum
argument_list|,
argument|QUANTUM
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_page
argument_list|,
argument|PAGE
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_tcache_max
argument_list|,
argument|tcache_maxclass
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_nbins
argument_list|,
argument|NBINS
argument_list|,
argument|unsigned
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_nhbins
argument_list|,
argument|nhbins
argument_list|,
argument|unsigned
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_bin_i_size
argument_list|,
argument|arena_bin_info[mib[
literal|2
argument|]].reg_size
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_bin_i_nregs
argument_list|,
argument|arena_bin_info[mib[
literal|2
argument|]].nregs
argument_list|,
argument|uint32_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_bin_i_slab_size
argument_list|,
argument|arena_bin_info[mib[
literal|2
argument|]].slab_size
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_function
specifier|static
specifier|const
name|ctl_named_node_t
modifier|*
name|arenas_bin_i_index
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|size_t
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|>
name|NBINS
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|super_arenas_bin_i_node
return|;
block|}
end_function

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_nlextents
argument_list|,
argument|NSIZES - NBINS
argument_list|,
argument|unsigned
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_GEN
argument_list|(
argument|arenas_lextent_i_size
argument_list|,
argument|sz_index2size(NBINS+(szind_t)mib[
literal|2
argument|])
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_function
specifier|static
specifier|const
name|ctl_named_node_t
modifier|*
name|arenas_lextent_i_index
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|size_t
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|>
name|NSIZES
operator|-
name|NBINS
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|super_arenas_lextent_i_node
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|arenas_create_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|extent_hooks_t
modifier|*
name|extent_hooks
decl_stmt|;
name|unsigned
name|arena_ind
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
name|extent_hooks
operator|=
operator|(
name|extent_hooks_t
operator|*
operator|)
operator|&
name|extent_hooks_default
expr_stmt|;
name|WRITE
argument_list|(
name|extent_hooks
argument_list|,
name|extent_hooks_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|arena_ind
operator|=
name|ctl_arena_init
argument_list|(
name|tsd
argument_list|,
name|extent_hooks
argument_list|)
operator|)
operator|==
name|UINT_MAX
condition|)
block|{
name|ret
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|READ
argument_list|(
name|arena_ind
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|prof_thread_active_init_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|bool
name|oldval
decl_stmt|;
if|if
condition|(
operator|!
name|config_prof
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|newlen
operator|!=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|oldval
operator|=
name|prof_thread_active_init_set
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|*
operator|(
name|bool
operator|*
operator|)
name|newp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|oldval
operator|=
name|prof_thread_active_init_get
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|READ
argument_list|(
name|oldval
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|prof_active_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|bool
name|oldval
decl_stmt|;
if|if
condition|(
operator|!
name|config_prof
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|newlen
operator|!=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|oldval
operator|=
name|prof_active_set
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|*
operator|(
name|bool
operator|*
operator|)
name|newp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|oldval
operator|=
name|prof_active_get
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|READ
argument_list|(
name|oldval
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|prof_dump_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|config_prof
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
name|WRITEONLY
argument_list|()
expr_stmt|;
name|WRITE
argument_list|(
name|filename
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|prof_mdump
argument_list|(
name|tsd
argument_list|,
name|filename
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|prof_gdump_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|bool
name|oldval
decl_stmt|;
if|if
condition|(
operator|!
name|config_prof
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
if|if
condition|(
name|newp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|newlen
operator|!=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|oldval
operator|=
name|prof_gdump_set
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|*
operator|(
name|bool
operator|*
operator|)
name|newp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|oldval
operator|=
name|prof_gdump_get
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|READ
argument_list|(
name|oldval
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|prof_reset_ctl
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|void
modifier|*
name|oldp
parameter_list|,
name|size_t
modifier|*
name|oldlenp
parameter_list|,
name|void
modifier|*
name|newp
parameter_list|,
name|size_t
name|newlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|size_t
name|lg_sample
init|=
name|lg_prof_sample
decl_stmt|;
if|if
condition|(
operator|!
name|config_prof
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
name|WRITEONLY
argument_list|()
expr_stmt|;
name|WRITE
argument_list|(
name|lg_sample
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|lg_sample
operator|>=
operator|(
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|<<
literal|3
operator|)
condition|)
block|{
name|lg_sample
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|<<
literal|3
operator|)
operator|-
literal|1
expr_stmt|;
block|}
name|prof_reset
argument_list|(
name|tsd
argument_list|,
name|lg_sample
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|label_return
label|:
return|return
name|ret
return|;
block|}
end_function

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|prof_interval
argument_list|,
argument|prof_interval
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_NL_CGEN
argument_list|(
argument|config_prof
argument_list|,
argument|lg_prof_sample
argument_list|,
argument|lg_prof_sample
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_comment
comment|/******************************************************************************/
end_comment

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_allocated
argument_list|,
argument|ctl_stats->allocated
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_active
argument_list|,
argument|ctl_stats->active
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_metadata
argument_list|,
argument|ctl_stats->metadata
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_resident
argument_list|,
argument|ctl_stats->resident
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_mapped
argument_list|,
argument|ctl_stats->mapped
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_retained
argument_list|,
argument|ctl_stats->retained
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_background_thread_num_threads
argument_list|,
argument|ctl_stats->background_thread.num_threads
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_background_thread_num_runs
argument_list|,
argument|ctl_stats->background_thread.num_runs
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_background_thread_run_interval
argument_list|,
argument|nstime_ns(&ctl_stats->background_thread.run_interval)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_GEN
argument_list|(
argument|stats_arenas_i_dss
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->dss
argument_list|,
argument|const char *
argument_list|)
end_macro

begin_macro
name|CTL_RO_GEN
argument_list|(
argument|stats_arenas_i_dirty_decay_ms
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->dirty_decay_ms
argument_list|,
argument|ssize_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_GEN
argument_list|(
argument|stats_arenas_i_muzzy_decay_ms
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->muzzy_decay_ms
argument_list|,
argument|ssize_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_GEN
argument_list|(
argument|stats_arenas_i_nthreads
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->nthreads
argument_list|,
argument|unsigned
argument_list|)
end_macro

begin_macro
name|CTL_RO_GEN
argument_list|(
argument|stats_arenas_i_uptime
argument_list|,
argument|nstime_ns(&arenas_i(mib[
literal|2
argument|])->astats->astats.uptime)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_GEN
argument_list|(
argument|stats_arenas_i_pactive
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->pactive
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_GEN
argument_list|(
argument|stats_arenas_i_pdirty
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->pdirty
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_GEN
argument_list|(
argument|stats_arenas_i_pmuzzy
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->pmuzzy
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_mapped
argument_list|,
argument|atomic_load_zu(&arenas_i(mib[
literal|2
argument|])->astats->astats.mapped, ATOMIC_RELAXED)
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_retained
argument_list|,
argument|atomic_load_zu(&arenas_i(mib[
literal|2
argument|])->astats->astats.retained, ATOMIC_RELAXED)
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_dirty_npurge
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->astats.decay_dirty.npurge)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_dirty_nmadvise
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->astats.decay_dirty.nmadvise)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_dirty_purged
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->astats.decay_dirty.purged)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_muzzy_npurge
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->astats.decay_muzzy.npurge)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_muzzy_nmadvise
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->astats.decay_muzzy.nmadvise)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_muzzy_purged
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->astats.decay_muzzy.purged)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_base
argument_list|,
argument|atomic_load_zu(&arenas_i(mib[
literal|2
argument|])->astats->astats.base, ATOMIC_RELAXED)
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_internal
argument_list|,
argument|atomic_load_zu(&arenas_i(mib[
literal|2
argument|])->astats->astats.internal, ATOMIC_RELAXED)
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_tcache_bytes
argument_list|,
argument|atomic_load_zu(&arenas_i(mib[
literal|2
argument|])->astats->astats.tcache_bytes,     ATOMIC_RELAXED)
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_resident
argument_list|,
argument|atomic_load_zu(&arenas_i(mib[
literal|2
argument|])->astats->astats.resident, ATOMIC_RELAXED)
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_small_allocated
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->allocated_small
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_small_nmalloc
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->nmalloc_small
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_small_ndalloc
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->ndalloc_small
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_small_nrequests
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->nrequests_small
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_large_allocated
argument_list|,
argument|atomic_load_zu(&arenas_i(mib[
literal|2
argument|])->astats->astats.allocated_large,     ATOMIC_RELAXED)
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_large_nmalloc
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->astats.nmalloc_large)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_large_ndalloc
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->astats.ndalloc_large)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_large_nrequests
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->astats.nmalloc_large)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_comment
comment|/* Intentional. */
end_comment

begin_comment
comment|/* Lock profiling related APIs below. */
end_comment

begin_define
define|#
directive|define
name|RO_MUTEX_CTL_GEN
parameter_list|(
name|n
parameter_list|,
name|l
parameter_list|)
define|\
value|CTL_RO_CGEN(config_stats, stats_##n##_num_ops,				\     l.n_lock_ops, uint64_t)						\ CTL_RO_CGEN(config_stats, stats_##n##_num_wait,				\     l.n_wait_times, uint64_t)						\ CTL_RO_CGEN(config_stats, stats_##n##_num_spin_acq,			\     l.n_spin_acquired, uint64_t)					\ CTL_RO_CGEN(config_stats, stats_##n##_num_owner_switch,			\     l.n_owner_switches, uint64_t) 					\ CTL_RO_CGEN(config_stats, stats_##n##_total_wait_time,			\     nstime_ns(&l.tot_wait_time), uint64_t)				\ CTL_RO_CGEN(config_stats, stats_##n##_max_wait_time,			\     nstime_ns(&l.max_wait_time), uint64_t)				\ CTL_RO_CGEN(config_stats, stats_##n##_max_num_thds,			\     l.max_n_thds, uint32_t)
end_define

begin_comment
comment|/* Global mutexes. */
end_comment

begin_define
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
define|\
value|RO_MUTEX_CTL_GEN(mutexes_##mtx,					\         ctl_stats->mutex_prof_data[global_prof_mutex_##mtx])
end_define

begin_decl_stmt
name|MUTEX_PROF_GLOBAL_MUTEXES
undef|#
directive|undef
name|OP
comment|/* Per arena mutexes */
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|RO_MUTEX_CTL_GEN(arenas_i_mutexes_##mtx,		\     arenas_i(mib[2])->astats->astats.mutex_prof_data[arena_prof_mutex_##mtx])
name|MUTEX_PROF_ARENA_MUTEXES
undef|#
directive|undef
name|OP
comment|/* tcache bin mutex */
name|RO_MUTEX_CTL_GEN
argument_list|(
name|arenas_i_bins_j_mutex
argument_list|,
name|arenas_i
argument_list|(
name|mib
index|[
literal|2
index|]
argument_list|)
operator|->
name|astats
operator|->
name|bstats
index|[
name|mib
index|[
literal|4
index|]
index|]
operator|.
name|mutex_data
argument_list|)
undef|#
directive|undef
name|RO_MUTEX_CTL_GEN
comment|/* Resets all mutex stats, including global, arena and bin mutexes. */
decl|static
name|int
name|stats_mutexes_reset_ctl
argument_list|(
name|tsd_t
operator|*
name|tsd
argument_list|,
specifier|const
name|size_t
operator|*
name|mib
argument_list|,
name|size_t
name|miblen
argument_list|,
name|void
operator|*
name|oldp
argument_list|,
name|size_t
operator|*
name|oldlenp
argument_list|,
name|void
operator|*
name|newp
argument_list|,
name|size_t
name|newlen
argument_list|)
block|{
if|if
condition|(
operator|!
name|config_stats
condition|)
block|{
return|return
name|ENOENT
return|;
block|}
name|tsdn_t
modifier|*
name|tsdn
init|=
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
decl_stmt|;
define|#
directive|define
name|MUTEX_PROF_RESET
parameter_list|(
name|mtx
parameter_list|)
define|\
value|malloc_mutex_lock(tsdn,&mtx);					\     malloc_mutex_prof_data_reset(tsdn,&mtx);				\     malloc_mutex_unlock(tsdn,&mtx);
comment|/* Global mutexes: ctl and prof. */
name|MUTEX_PROF_RESET
argument_list|(
name|ctl_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_background_thread
condition|)
block|{
name|MUTEX_PROF_RESET
argument_list|(
name|background_thread_lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config_prof
operator|&&
name|opt_prof
condition|)
block|{
name|MUTEX_PROF_RESET
argument_list|(
name|bt2gctx_mtx
argument_list|)
expr_stmt|;
block|}
comment|/* Per arena mutexes. */
name|unsigned
name|n
init|=
name|narenas_total_get
argument_list|()
decl_stmt|;
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|arena_t
modifier|*
name|arena
init|=
name|arena_get
argument_list|(
name|tsdn
argument_list|,
name|i
argument_list|,
name|false
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|arena
condition|)
block|{
continue|continue;
block|}
name|MUTEX_PROF_RESET
argument_list|(
name|arena
operator|->
name|large_mtx
argument_list|)
expr_stmt|;
name|MUTEX_PROF_RESET
argument_list|(
name|arena
operator|->
name|extent_avail_mtx
argument_list|)
expr_stmt|;
name|MUTEX_PROF_RESET
argument_list|(
name|arena
operator|->
name|extents_dirty
operator|.
name|mtx
argument_list|)
expr_stmt|;
name|MUTEX_PROF_RESET
argument_list|(
name|arena
operator|->
name|extents_muzzy
operator|.
name|mtx
argument_list|)
expr_stmt|;
name|MUTEX_PROF_RESET
argument_list|(
name|arena
operator|->
name|extents_retained
operator|.
name|mtx
argument_list|)
expr_stmt|;
name|MUTEX_PROF_RESET
argument_list|(
name|arena
operator|->
name|decay_dirty
operator|.
name|mtx
argument_list|)
expr_stmt|;
name|MUTEX_PROF_RESET
argument_list|(
name|arena
operator|->
name|decay_muzzy
operator|.
name|mtx
argument_list|)
expr_stmt|;
name|MUTEX_PROF_RESET
argument_list|(
name|arena
operator|->
name|tcache_ql_mtx
argument_list|)
expr_stmt|;
name|MUTEX_PROF_RESET
argument_list|(
name|arena
operator|->
name|base
operator|->
name|mtx
argument_list|)
expr_stmt|;
for|for
control|(
name|szind_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|NBINS
condition|;
name|i
operator|++
control|)
block|{
name|arena_bin_t
modifier|*
name|bin
init|=
operator|&
name|arena
operator|->
name|bins
index|[
name|i
index|]
decl_stmt|;
name|MUTEX_PROF_RESET
argument_list|(
name|bin
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
undef|#
directive|undef
name|MUTEX_PROF_RESET
return|return
literal|0
return|;
block|}
end_decl_stmt

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_bins_j_nmalloc
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->bstats[mib[
literal|4
argument|]].nmalloc
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_bins_j_ndalloc
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->bstats[mib[
literal|4
argument|]].ndalloc
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_bins_j_nrequests
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->bstats[mib[
literal|4
argument|]].nrequests
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_bins_j_curregs
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->bstats[mib[
literal|4
argument|]].curregs
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_bins_j_nfills
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->bstats[mib[
literal|4
argument|]].nfills
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_bins_j_nflushes
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->bstats[mib[
literal|4
argument|]].nflushes
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_bins_j_nslabs
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->bstats[mib[
literal|4
argument|]].nslabs
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_bins_j_nreslabs
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->bstats[mib[
literal|4
argument|]].reslabs
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_bins_j_curslabs
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->bstats[mib[
literal|4
argument|]].curslabs
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_function
specifier|static
specifier|const
name|ctl_named_node_t
modifier|*
name|stats_arenas_i_bins_j_index
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|size_t
name|j
parameter_list|)
block|{
if|if
condition|(
name|j
operator|>
name|NBINS
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|super_stats_arenas_i_bins_j_node
return|;
block|}
end_function

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_lextents_j_nmalloc
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->lstats[mib[
literal|4
argument|]].nmalloc)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_lextents_j_ndalloc
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->lstats[mib[
literal|4
argument|]].ndalloc)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_lextents_j_nrequests
argument_list|,
argument|arena_stats_read_u64(&arenas_i(mib[
literal|2
argument|])->astats->lstats[mib[
literal|4
argument|]].nrequests)
argument_list|,
argument|uint64_t
argument_list|)
end_macro

begin_macro
name|CTL_RO_CGEN
argument_list|(
argument|config_stats
argument_list|,
argument|stats_arenas_i_lextents_j_curlextents
argument_list|,
argument|arenas_i(mib[
literal|2
argument|])->astats->lstats[mib[
literal|4
argument|]].curlextents
argument_list|,
argument|size_t
argument_list|)
end_macro

begin_function
specifier|static
specifier|const
name|ctl_named_node_t
modifier|*
name|stats_arenas_i_lextents_j_index
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|size_t
name|j
parameter_list|)
block|{
if|if
condition|(
name|j
operator|>
name|NSIZES
operator|-
name|NBINS
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|super_stats_arenas_i_lextents_j_node
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|ctl_named_node_t
modifier|*
name|stats_arenas_i_index
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|size_t
modifier|*
name|mib
parameter_list|,
name|size_t
name|miblen
parameter_list|,
name|size_t
name|i
parameter_list|)
block|{
specifier|const
name|ctl_named_node_t
modifier|*
name|ret
decl_stmt|;
name|size_t
name|a
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
name|a
operator|=
name|arenas_i2a_impl
argument_list|(
name|i
argument_list|,
name|true
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|==
name|UINT_MAX
operator|||
operator|!
name|ctl_arenas
operator|->
name|arenas
index|[
name|a
index|]
operator|->
name|initialized
condition|)
block|{
name|ret
operator|=
name|NULL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|ret
operator|=
name|super_stats_arenas_i_node
expr_stmt|;
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|ctl_mtx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


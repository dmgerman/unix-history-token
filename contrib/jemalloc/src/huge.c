begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_HUGE_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal.h"
end_include

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|extent_node_t
modifier|*
name|huge_node_get
parameter_list|(
specifier|const
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|node
operator|=
name|chunk_lookup
argument_list|(
name|ptr
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|extent_node_achunk_get
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|node
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|huge_node_set
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|,
name|extent_node_t
modifier|*
name|node
parameter_list|)
block|{
name|assert
argument_list|(
name|extent_node_addr_get
argument_list|(
name|node
argument_list|)
operator|==
name|ptr
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|extent_node_achunk_get
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|chunk_register
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|node
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|huge_node_reset
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|,
name|extent_node_t
modifier|*
name|node
parameter_list|)
block|{
name|bool
name|err
decl_stmt|;
name|err
operator|=
name|huge_node_set
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|err
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|huge_node_unset
parameter_list|(
specifier|const
name|void
modifier|*
name|ptr
parameter_list|,
specifier|const
name|extent_node_t
modifier|*
name|node
parameter_list|)
block|{
name|chunk_deregister
argument_list|(
name|ptr
argument_list|,
name|node
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
modifier|*
name|huge_malloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
name|assert
argument_list|(
name|usize
operator|==
name|s2u
argument_list|(
name|usize
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|huge_palloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|chunksize
argument_list|,
name|zero
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|huge_palloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
name|void
modifier|*
name|ret
decl_stmt|;
name|size_t
name|ausize
decl_stmt|;
name|arena_t
modifier|*
name|iarena
decl_stmt|;
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|bool
name|is_zeroed
decl_stmt|;
comment|/* Allocate one or more contiguous chunks for this request. */
name|assert
argument_list|(
operator|!
name|tsdn_null
argument_list|(
name|tsdn
argument_list|)
operator|||
name|arena
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ausize
operator|=
name|sa2u
argument_list|(
name|usize
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ausize
operator|==
literal|0
operator|||
name|ausize
operator|>
name|HUGE_MAXCLASS
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|assert
argument_list|(
name|ausize
operator|>=
name|chunksize
argument_list|)
expr_stmt|;
comment|/* Allocate an extent node with which to track the chunk. */
name|iarena
operator|=
operator|(
operator|!
name|tsdn_null
argument_list|(
name|tsdn
argument_list|)
operator|)
condition|?
name|arena_ichoose
argument_list|(
name|tsdn_tsd
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|NULL
argument_list|)
else|:
name|a0get
argument_list|()
expr_stmt|;
name|node
operator|=
name|ipallocztm
argument_list|(
name|tsdn
argument_list|,
name|CACHELINE_CEILING
argument_list|(
sizeof|sizeof
argument_list|(
name|extent_node_t
argument_list|)
argument_list|)
argument_list|,
name|CACHELINE
argument_list|,
name|false
argument_list|,
name|NULL
argument_list|,
name|true
argument_list|,
name|iarena
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* 	 * Copy zero into is_zeroed and pass the copy to chunk_alloc(), so that 	 * it is possible to make correct junk/zero fill decisions below. 	 */
name|is_zeroed
operator|=
name|zero
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
operator|!
name|tsdn_null
argument_list|(
name|tsdn
argument_list|)
argument_list|)
condition|)
name|arena
operator|=
name|arena_choose
argument_list|(
name|tsdn_tsd
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|arena
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|arena
operator|==
name|NULL
argument_list|)
operator|||
operator|(
name|ret
operator|=
name|arena_chunk_alloc_huge
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|alignment
argument_list|,
operator|&
name|is_zeroed
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|idalloctm
argument_list|(
name|tsdn
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
name|true
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|extent_node_init
argument_list|(
name|node
argument_list|,
name|arena
argument_list|,
name|ret
argument_list|,
name|usize
argument_list|,
name|is_zeroed
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|huge_node_set
argument_list|(
name|tsdn
argument_list|,
name|ret
argument_list|,
name|node
argument_list|)
condition|)
block|{
name|arena_chunk_dalloc_huge
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|ret
argument_list|,
name|usize
argument_list|)
expr_stmt|;
name|idalloctm
argument_list|(
name|tsdn
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
name|true
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Insert node into huge. */
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
name|ql_elm_new
argument_list|(
name|node
argument_list|,
name|ql_link
argument_list|)
expr_stmt|;
name|ql_tail_insert
argument_list|(
operator|&
name|arena
operator|->
name|huge
argument_list|,
name|node
argument_list|,
name|ql_link
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|zero
operator|||
operator|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_zero
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|is_zeroed
condition|)
name|memset
argument_list|(
name|ret
argument_list|,
literal|0
argument_list|,
name|usize
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_junk_alloc
argument_list|)
condition|)
name|memset
argument_list|(
name|ret
argument_list|,
name|JEMALLOC_ALLOC_JUNK
argument_list|,
name|usize
argument_list|)
expr_stmt|;
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|JEMALLOC_JET
end_ifdef

begin_undef
undef|#
directive|undef
name|huge_dalloc_junk
end_undef

begin_define
define|#
directive|define
name|huge_dalloc_junk
value|JEMALLOC_N(huge_dalloc_junk_impl)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|huge_dalloc_junk
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|usize
parameter_list|)
block|{
if|if
condition|(
name|config_fill
operator|&&
name|have_dss
operator|&&
name|unlikely
argument_list|(
name|opt_junk_free
argument_list|)
condition|)
block|{
comment|/* 		 * Only bother junk filling if the chunk isn't about to be 		 * unmapped. 		 */
if|if
condition|(
operator|!
name|config_munmap
operator|||
operator|(
name|have_dss
operator|&&
name|chunk_in_dss
argument_list|(
name|ptr
argument_list|)
operator|)
condition|)
name|memset
argument_list|(
name|ptr
argument_list|,
name|JEMALLOC_FREE_JUNK
argument_list|,
name|usize
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|JEMALLOC_JET
end_ifdef

begin_undef
undef|#
directive|undef
name|huge_dalloc_junk
end_undef

begin_define
define|#
directive|define
name|huge_dalloc_junk
value|JEMALLOC_N(huge_dalloc_junk)
end_define

begin_decl_stmt
name|huge_dalloc_junk_t
modifier|*
name|huge_dalloc_junk
init|=
name|JEMALLOC_N
argument_list|(
name|huge_dalloc_junk_impl
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|huge_ralloc_no_move_similar
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|oldsize
parameter_list|,
name|size_t
name|usize_min
parameter_list|,
name|size_t
name|usize_max
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
name|size_t
name|usize
decl_stmt|,
name|usize_next
decl_stmt|;
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|chunk_hooks_t
name|chunk_hooks
init|=
name|CHUNK_HOOKS_INITIALIZER
decl_stmt|;
name|bool
name|pre_zeroed
decl_stmt|,
name|post_zeroed
decl_stmt|;
comment|/* Increase usize to incorporate extra. */
for|for
control|(
name|usize
operator|=
name|usize_min
init|;
name|usize
operator|<
name|usize_max
operator|&&
operator|(
name|usize_next
operator|=
name|s2u
argument_list|(
name|usize
operator|+
literal|1
argument_list|)
operator|)
operator|<=
name|oldsize
condition|;
name|usize
operator|=
name|usize_next
control|)
empty_stmt|;
comment|/* Do nothing. */
if|if
condition|(
name|oldsize
operator|==
name|usize
condition|)
return|return;
name|node
operator|=
name|huge_node_get
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|arena
operator|=
name|extent_node_arena_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|pre_zeroed
operator|=
name|extent_node_zeroed_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
comment|/* Fill if necessary (shrinking). */
if|if
condition|(
name|oldsize
operator|>
name|usize
condition|)
block|{
name|size_t
name|sdiff
init|=
name|oldsize
operator|-
name|usize
decl_stmt|;
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_junk_free
argument_list|)
condition|)
block|{
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|+
name|usize
operator|)
argument_list|,
name|JEMALLOC_FREE_JUNK
argument_list|,
name|sdiff
argument_list|)
expr_stmt|;
name|post_zeroed
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
name|post_zeroed
operator|=
operator|!
name|chunk_purge_wrapper
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|chunk_hooks
argument_list|,
name|ptr
argument_list|,
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
argument_list|,
name|usize
argument_list|,
name|sdiff
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|post_zeroed
operator|=
name|pre_zeroed
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
comment|/* Update the size of the huge allocation. */
name|huge_node_unset
argument_list|(
name|ptr
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|extent_node_size_get
argument_list|(
name|node
argument_list|)
operator|!=
name|usize
argument_list|)
expr_stmt|;
name|extent_node_size_set
argument_list|(
name|node
argument_list|,
name|usize
argument_list|)
expr_stmt|;
name|huge_node_reset
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|node
argument_list|)
expr_stmt|;
comment|/* Update zeroed. */
name|extent_node_zeroed_set
argument_list|(
name|node
argument_list|,
name|post_zeroed
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
name|arena_chunk_ralloc_huge_similar
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|ptr
argument_list|,
name|oldsize
argument_list|,
name|usize
argument_list|)
expr_stmt|;
comment|/* Fill if necessary (growing). */
if|if
condition|(
name|oldsize
operator|<
name|usize
condition|)
block|{
if|if
condition|(
name|zero
operator|||
operator|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_zero
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|pre_zeroed
condition|)
block|{
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|+
name|oldsize
operator|)
argument_list|,
literal|0
argument_list|,
name|usize
operator|-
name|oldsize
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_junk_alloc
argument_list|)
condition|)
block|{
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|+
name|oldsize
operator|)
argument_list|,
name|JEMALLOC_ALLOC_JUNK
argument_list|,
name|usize
operator|-
name|oldsize
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|huge_ralloc_no_move_shrink
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|oldsize
parameter_list|,
name|size_t
name|usize
parameter_list|)
block|{
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|chunk_hooks_t
name|chunk_hooks
decl_stmt|;
name|size_t
name|cdiff
decl_stmt|;
name|bool
name|pre_zeroed
decl_stmt|,
name|post_zeroed
decl_stmt|;
name|node
operator|=
name|huge_node_get
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|arena
operator|=
name|extent_node_arena_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|pre_zeroed
operator|=
name|extent_node_zeroed_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|chunk_hooks
operator|=
name|chunk_hooks_get
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|oldsize
operator|>
name|usize
argument_list|)
expr_stmt|;
comment|/* Split excess chunks. */
name|cdiff
operator|=
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
operator|-
name|CHUNK_CEILING
argument_list|(
name|usize
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdiff
operator|!=
literal|0
operator|&&
name|chunk_hooks
operator|.
name|split
argument_list|(
name|ptr
argument_list|,
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
argument_list|,
name|CHUNK_CEILING
argument_list|(
name|usize
argument_list|)
argument_list|,
name|cdiff
argument_list|,
name|true
argument_list|,
name|arena
operator|->
name|ind
argument_list|)
condition|)
return|return
operator|(
name|true
operator|)
return|;
if|if
condition|(
name|oldsize
operator|>
name|usize
condition|)
block|{
name|size_t
name|sdiff
init|=
name|oldsize
operator|-
name|usize
decl_stmt|;
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_junk_free
argument_list|)
condition|)
block|{
name|huge_dalloc_junk
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|+
name|usize
operator|)
argument_list|,
name|sdiff
argument_list|)
expr_stmt|;
name|post_zeroed
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
name|post_zeroed
operator|=
operator|!
name|chunk_purge_wrapper
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|chunk_hooks
argument_list|,
name|CHUNK_ADDR2BASE
argument_list|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|+
name|usize
argument_list|)
argument_list|,
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
argument_list|,
name|CHUNK_ADDR2OFFSET
argument_list|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|+
name|usize
argument_list|)
argument_list|,
name|sdiff
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|post_zeroed
operator|=
name|pre_zeroed
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
comment|/* Update the size of the huge allocation. */
name|huge_node_unset
argument_list|(
name|ptr
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|extent_node_size_set
argument_list|(
name|node
argument_list|,
name|usize
argument_list|)
expr_stmt|;
name|huge_node_reset
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|node
argument_list|)
expr_stmt|;
comment|/* Update zeroed. */
name|extent_node_zeroed_set
argument_list|(
name|node
argument_list|,
name|post_zeroed
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
comment|/* Zap the excess chunks. */
name|arena_chunk_ralloc_huge_shrink
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|ptr
argument_list|,
name|oldsize
argument_list|,
name|usize
argument_list|)
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|huge_ralloc_no_move_expand
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|oldsize
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|bool
name|is_zeroed_subchunk
decl_stmt|,
name|is_zeroed_chunk
decl_stmt|;
name|node
operator|=
name|huge_node_get
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|arena
operator|=
name|extent_node_arena_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
name|is_zeroed_subchunk
operator|=
name|extent_node_zeroed_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
comment|/* 	 * Use is_zeroed_chunk to detect whether the trailing memory is zeroed, 	 * update extent's zeroed field, and zero as necessary. 	 */
name|is_zeroed_chunk
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|arena_chunk_ralloc_huge_expand
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|ptr
argument_list|,
name|oldsize
argument_list|,
name|usize
argument_list|,
operator|&
name|is_zeroed_chunk
argument_list|)
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
name|huge_node_unset
argument_list|(
name|ptr
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|extent_node_size_set
argument_list|(
name|node
argument_list|,
name|usize
argument_list|)
expr_stmt|;
name|extent_node_zeroed_set
argument_list|(
name|node
argument_list|,
name|extent_node_zeroed_get
argument_list|(
name|node
argument_list|)
operator|&&
name|is_zeroed_chunk
argument_list|)
expr_stmt|;
name|huge_node_reset
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|zero
operator|||
operator|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_zero
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|is_zeroed_subchunk
condition|)
block|{
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|+
name|oldsize
operator|)
argument_list|,
literal|0
argument_list|,
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
operator|-
name|oldsize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|is_zeroed_chunk
condition|)
block|{
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|+
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
operator|)
argument_list|,
literal|0
argument_list|,
name|usize
operator|-
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_junk_alloc
argument_list|)
condition|)
block|{
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|+
name|oldsize
operator|)
argument_list|,
name|JEMALLOC_ALLOC_JUNK
argument_list|,
name|usize
operator|-
name|oldsize
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_function
name|bool
name|huge_ralloc_no_move
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|oldsize
parameter_list|,
name|size_t
name|usize_min
parameter_list|,
name|size_t
name|usize_max
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
name|assert
argument_list|(
name|s2u
argument_list|(
name|oldsize
argument_list|)
operator|==
name|oldsize
argument_list|)
expr_stmt|;
comment|/* The following should have been caught by callers. */
name|assert
argument_list|(
name|usize_min
operator|>
literal|0
operator|&&
name|usize_max
operator|<=
name|HUGE_MAXCLASS
argument_list|)
expr_stmt|;
comment|/* Both allocations must be huge to avoid a move. */
if|if
condition|(
name|oldsize
operator|<
name|chunksize
operator|||
name|usize_max
operator|<
name|chunksize
condition|)
return|return
operator|(
name|true
operator|)
return|;
if|if
condition|(
name|CHUNK_CEILING
argument_list|(
name|usize_max
argument_list|)
operator|>
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
condition|)
block|{
comment|/* Attempt to expand the allocation in-place. */
if|if
condition|(
operator|!
name|huge_ralloc_no_move_expand
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|oldsize
argument_list|,
name|usize_max
argument_list|,
name|zero
argument_list|)
condition|)
block|{
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|huge_aalloc
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
comment|/* Try again, this time with usize_min. */
if|if
condition|(
name|usize_min
operator|<
name|usize_max
operator|&&
name|CHUNK_CEILING
argument_list|(
name|usize_min
argument_list|)
operator|>
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
operator|&&
name|huge_ralloc_no_move_expand
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|oldsize
argument_list|,
name|usize_min
argument_list|,
name|zero
argument_list|)
condition|)
block|{
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|huge_aalloc
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
block|}
comment|/* 	 * Avoid moving the allocation if the existing chunk size accommodates 	 * the new size. 	 */
if|if
condition|(
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
operator|>=
name|CHUNK_CEILING
argument_list|(
name|usize_min
argument_list|)
operator|&&
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
operator|<=
name|CHUNK_CEILING
argument_list|(
name|usize_max
argument_list|)
condition|)
block|{
name|huge_ralloc_no_move_similar
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|oldsize
argument_list|,
name|usize_min
argument_list|,
name|usize_max
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|huge_aalloc
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
comment|/* Attempt to shrink the allocation in-place. */
if|if
condition|(
name|CHUNK_CEILING
argument_list|(
name|oldsize
argument_list|)
operator|>
name|CHUNK_CEILING
argument_list|(
name|usize_max
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|huge_ralloc_no_move_shrink
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|oldsize
argument_list|,
name|usize_max
argument_list|)
condition|)
block|{
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|huge_aalloc
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
block|}
return|return
operator|(
name|true
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|huge_ralloc_move_helper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
if|if
condition|(
name|alignment
operator|<=
name|chunksize
condition|)
return|return
operator|(
name|huge_malloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|zero
argument_list|)
operator|)
return|;
return|return
operator|(
name|huge_palloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|huge_ralloc
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|oldsize
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|zero
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|)
block|{
name|void
modifier|*
name|ret
decl_stmt|;
name|size_t
name|copysize
decl_stmt|;
comment|/* The following should have been caught by callers. */
name|assert
argument_list|(
name|usize
operator|>
literal|0
operator|&&
name|usize
operator|<=
name|HUGE_MAXCLASS
argument_list|)
expr_stmt|;
comment|/* Try to avoid moving the allocation. */
if|if
condition|(
operator|!
name|huge_ralloc_no_move
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|ptr
argument_list|,
name|oldsize
argument_list|,
name|usize
argument_list|,
name|usize
argument_list|,
name|zero
argument_list|)
condition|)
return|return
operator|(
name|ptr
operator|)
return|;
comment|/* 	 * usize and oldsize are different enough that we need to use a 	 * different size class.  In that case, fall back to allocating new 	 * space and copying. 	 */
name|ret
operator|=
name|huge_ralloc_move_helper
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|copysize
operator|=
operator|(
name|usize
operator|<
name|oldsize
operator|)
condition|?
name|usize
else|:
name|oldsize
expr_stmt|;
name|memcpy
argument_list|(
name|ret
argument_list|,
name|ptr
argument_list|,
name|copysize
argument_list|)
expr_stmt|;
name|isqalloc
argument_list|(
name|tsd
argument_list|,
name|ptr
argument_list|,
name|oldsize
argument_list|,
name|tcache
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|huge_dalloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|node
operator|=
name|huge_node_get
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|arena
operator|=
name|extent_node_arena_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|huge_node_unset
argument_list|(
name|ptr
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
name|ql_remove
argument_list|(
operator|&
name|arena
operator|->
name|huge
argument_list|,
name|node
argument_list|,
name|ql_link
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
name|huge_dalloc_junk
argument_list|(
name|extent_node_addr_get
argument_list|(
name|node
argument_list|)
argument_list|,
name|extent_node_size_get
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|arena_chunk_dalloc_huge
argument_list|(
name|tsdn
argument_list|,
name|extent_node_arena_get
argument_list|(
name|node
argument_list|)
argument_list|,
name|extent_node_addr_get
argument_list|(
name|node
argument_list|)
argument_list|,
name|extent_node_size_get
argument_list|(
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|idalloctm
argument_list|(
name|tsdn
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
name|true
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|arena_t
modifier|*
name|huge_aalloc
parameter_list|(
specifier|const
name|void
modifier|*
name|ptr
parameter_list|)
block|{
return|return
operator|(
name|extent_node_arena_get
argument_list|(
name|huge_node_get
argument_list|(
name|ptr
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|size_t
name|huge_salloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|node
operator|=
name|huge_node_get
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|arena
operator|=
name|extent_node_arena_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
name|size
operator|=
name|extent_node_size_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|size
operator|)
return|;
block|}
end_function

begin_function
name|prof_tctx_t
modifier|*
name|huge_prof_tctx_get
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|prof_tctx_t
modifier|*
name|tctx
decl_stmt|;
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|node
operator|=
name|huge_node_get
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|arena
operator|=
name|extent_node_arena_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
name|tctx
operator|=
name|extent_node_prof_tctx_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|tctx
operator|)
return|;
block|}
end_function

begin_function
name|void
name|huge_prof_tctx_set
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|,
name|prof_tctx_t
modifier|*
name|tctx
parameter_list|)
block|{
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|node
operator|=
name|huge_node_get
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|arena
operator|=
name|extent_node_arena_get
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
name|extent_node_prof_tctx_set
argument_list|(
name|node
argument_list|,
name|tctx
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|huge_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|huge_prof_tctx_reset
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|huge_prof_tctx_set
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
operator|(
name|prof_tctx_t
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|1U
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


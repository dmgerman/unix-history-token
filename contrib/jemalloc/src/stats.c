begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_STATS_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal.h"
end_include

begin_define
define|#
directive|define
name|CTL_GET
parameter_list|(
name|n
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
value|do {						\ 	size_t sz = sizeof(t);						\ 	xmallctl(n, (void *)v,&sz, NULL, 0);				\ } while (0)
end_define

begin_define
define|#
directive|define
name|CTL_M2_GET
parameter_list|(
name|n
parameter_list|,
name|i
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
value|do {					\ 	size_t mib[6];							\ 	size_t miblen = sizeof(mib) / sizeof(size_t);			\ 	size_t sz = sizeof(t);						\ 	xmallctlnametomib(n, mib,&miblen);				\ 	mib[2] = (i);							\ 	xmallctlbymib(mib, miblen, (void *)v,&sz, NULL, 0);		\ } while (0)
end_define

begin_define
define|#
directive|define
name|CTL_M2_M4_GET
parameter_list|(
name|n
parameter_list|,
name|i
parameter_list|,
name|j
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
value|do {				\ 	size_t mib[6];							\ 	size_t miblen = sizeof(mib) / sizeof(size_t);			\ 	size_t sz = sizeof(t);						\ 	xmallctlnametomib(n, mib,&miblen);				\ 	mib[2] = (i);							\ 	mib[4] = (j);							\ 	xmallctlbymib(mib, miblen, (void *)v,&sz, NULL, 0);		\ } while (0)
end_define

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_decl_stmt
name|bool
name|opt_stats_print
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|stats_cactive
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|stats_arena_bins_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|bool
name|large
parameter_list|,
name|bool
name|huge
parameter_list|,
name|unsigned
name|i
parameter_list|)
block|{
name|size_t
name|page
decl_stmt|;
name|bool
name|in_gap
decl_stmt|,
name|in_gap_prev
decl_stmt|;
name|unsigned
name|nbins
decl_stmt|,
name|j
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.page"
argument_list|,
operator|&
name|page
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nbins"
argument_list|,
operator|&
name|nbins
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"bins\": [\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|config_tcache
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"bins:           size ind    allocated      nmalloc"
literal|"      ndalloc    nrequests      curregs"
literal|"      curruns regs pgs  util       nfills"
literal|"     nflushes      newruns       reruns\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"bins:           size ind    allocated      nmalloc"
literal|"      ndalloc    nrequests      curregs"
literal|"      curruns regs pgs  util      newruns"
literal|"       reruns\n"
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|in_gap
operator|=
name|false
init|;
name|j
operator|<
name|nbins
condition|;
name|j
operator|++
control|)
block|{
name|uint64_t
name|nruns
decl_stmt|;
name|size_t
name|reg_size
decl_stmt|,
name|run_size
decl_stmt|,
name|curregs
decl_stmt|;
name|size_t
name|curruns
decl_stmt|;
name|uint32_t
name|nregs
decl_stmt|;
name|uint64_t
name|nmalloc
decl_stmt|,
name|ndalloc
decl_stmt|,
name|nrequests
decl_stmt|,
name|nfills
decl_stmt|,
name|nflushes
decl_stmt|;
name|uint64_t
name|nreruns
decl_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nruns"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nruns
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|in_gap_prev
operator|=
name|in_gap
expr_stmt|;
name|in_gap
operator|=
operator|(
name|nruns
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|json
operator|&&
name|in_gap_prev
operator|&&
operator|!
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.size"
argument_list|,
name|j
argument_list|,
operator|&
name|reg_size
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.nregs"
argument_list|,
name|j
argument_list|,
operator|&
name|nregs
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.run_size"
argument_list|,
name|j
argument_list|,
operator|&
name|run_size
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nmalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.ndalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.curregs"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|curregs
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nrequests"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_tcache
condition|)
block|{
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nfills"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nfills
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nflushes"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nflushes
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nreruns"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nreruns
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.curruns"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|curruns
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t{\n"
literal|"\t\t\t\t\t\t\"nmalloc\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"ndalloc\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"curregs\": %zu,\n"
literal|"\t\t\t\t\t\t\"nrequests\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|nmalloc
argument_list|,
name|ndalloc
argument_list|,
name|curregs
argument_list|,
name|nrequests
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_tcache
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\t\"nfills\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"nflushes\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|nfills
argument_list|,
name|nflushes
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\t\"nreruns\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"curruns\": %zu\n"
literal|"\t\t\t\t\t}%s\n"
argument_list|,
name|nreruns
argument_list|,
name|curruns
argument_list|,
operator|(
name|j
operator|+
literal|1
operator|<
name|nbins
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|in_gap
condition|)
block|{
name|size_t
name|availregs
decl_stmt|,
name|milli
decl_stmt|;
name|char
name|util
index|[
literal|6
index|]
decl_stmt|;
comment|/* "x.yyy". */
name|availregs
operator|=
name|nregs
operator|*
name|curruns
expr_stmt|;
name|milli
operator|=
operator|(
name|availregs
operator|!=
literal|0
operator|)
condition|?
operator|(
literal|1000
operator|*
name|curregs
operator|)
operator|/
name|availregs
else|:
literal|1000
expr_stmt|;
if|if
condition|(
name|milli
operator|>
literal|1000
condition|)
block|{
comment|/* 				 * Race detected: the counters were read in 				 * separate mallctl calls and concurrent 				 * operations happened in between. In this case 				 * no meaningful utilization can be computed. 				 */
name|malloc_snprintf
argument_list|(
name|util
argument_list|,
sizeof|sizeof
argument_list|(
name|util
argument_list|)
argument_list|,
literal|" race"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|milli
operator|<
literal|10
condition|)
block|{
name|malloc_snprintf
argument_list|(
name|util
argument_list|,
sizeof|sizeof
argument_list|(
name|util
argument_list|)
argument_list|,
literal|"0.00%zu"
argument_list|,
name|milli
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|milli
operator|<
literal|100
condition|)
block|{
name|malloc_snprintf
argument_list|(
name|util
argument_list|,
sizeof|sizeof
argument_list|(
name|util
argument_list|)
argument_list|,
literal|"0.0%zu"
argument_list|,
name|milli
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|milli
operator|<
literal|1000
condition|)
block|{
name|malloc_snprintf
argument_list|(
name|util
argument_list|,
sizeof|sizeof
argument_list|(
name|util
argument_list|)
argument_list|,
literal|"0.%zu"
argument_list|,
name|milli
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|milli
operator|==
literal|1000
argument_list|)
expr_stmt|;
name|malloc_snprintf
argument_list|(
name|util
argument_list|,
sizeof|sizeof
argument_list|(
name|util
argument_list|)
argument_list|,
literal|"1"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config_tcache
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"%20zu %3u %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12zu"
literal|" %12zu %4u %3zu %-5s %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|reg_size
argument_list|,
name|j
argument_list|,
name|curregs
operator|*
name|reg_size
argument_list|,
name|nmalloc
argument_list|,
name|ndalloc
argument_list|,
name|nrequests
argument_list|,
name|curregs
argument_list|,
name|curruns
argument_list|,
name|nregs
argument_list|,
name|run_size
operator|/
name|page
argument_list|,
name|util
argument_list|,
name|nfills
argument_list|,
name|nflushes
argument_list|,
name|nruns
argument_list|,
name|nreruns
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"%20zu %3u %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12zu"
literal|" %12zu %4u %3zu %-5s %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|reg_size
argument_list|,
name|j
argument_list|,
name|curregs
operator|*
name|reg_size
argument_list|,
name|nmalloc
argument_list|,
name|ndalloc
argument_list|,
name|nrequests
argument_list|,
name|curregs
argument_list|,
name|curruns
argument_list|,
name|nregs
argument_list|,
name|run_size
operator|/
name|page
argument_list|,
name|util
argument_list|,
name|nruns
argument_list|,
name|nreruns
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t]%s\n"
argument_list|,
operator|(
name|large
operator|||
name|huge
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|stats_arena_lruns_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|bool
name|huge
parameter_list|,
name|unsigned
name|i
parameter_list|)
block|{
name|unsigned
name|nbins
decl_stmt|,
name|nlruns
decl_stmt|,
name|j
decl_stmt|;
name|bool
name|in_gap
decl_stmt|,
name|in_gap_prev
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nbins"
argument_list|,
operator|&
name|nbins
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nlruns"
argument_list|,
operator|&
name|nlruns
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"lruns\": [\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"large:          size ind    allocated      nmalloc"
literal|"      ndalloc    nrequests      curruns\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|in_gap
operator|=
name|false
init|;
name|j
operator|<
name|nlruns
condition|;
name|j
operator|++
control|)
block|{
name|uint64_t
name|nmalloc
decl_stmt|,
name|ndalloc
decl_stmt|,
name|nrequests
decl_stmt|;
name|size_t
name|run_size
decl_stmt|,
name|curruns
decl_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.lruns.0.nmalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.lruns.0.ndalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.lruns.0.nrequests"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|in_gap_prev
operator|=
name|in_gap
expr_stmt|;
name|in_gap
operator|=
operator|(
name|nrequests
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|json
operator|&&
name|in_gap_prev
operator|&&
operator|!
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"arenas.lrun.0.size"
argument_list|,
name|j
argument_list|,
operator|&
name|run_size
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.lruns.0.curruns"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|curruns
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t{\n"
literal|"\t\t\t\t\t\t\"curruns\": %zu\n"
literal|"\t\t\t\t\t}%s\n"
argument_list|,
name|curruns
argument_list|,
operator|(
name|j
operator|+
literal|1
operator|<
name|nlruns
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"%20zu %3u %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12zu\n"
argument_list|,
name|run_size
argument_list|,
name|nbins
operator|+
name|j
argument_list|,
name|curruns
operator|*
name|run_size
argument_list|,
name|nmalloc
argument_list|,
name|ndalloc
argument_list|,
name|nrequests
argument_list|,
name|curruns
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t]%s\n"
argument_list|,
name|huge
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|stats_arena_hchunks_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|unsigned
name|i
parameter_list|)
block|{
name|unsigned
name|nbins
decl_stmt|,
name|nlruns
decl_stmt|,
name|nhchunks
decl_stmt|,
name|j
decl_stmt|;
name|bool
name|in_gap
decl_stmt|,
name|in_gap_prev
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nbins"
argument_list|,
operator|&
name|nbins
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nlruns"
argument_list|,
operator|&
name|nlruns
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nhchunks"
argument_list|,
operator|&
name|nhchunks
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"hchunks\": [\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"huge:           size ind    allocated      nmalloc"
literal|"      ndalloc    nrequests   curhchunks\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|in_gap
operator|=
name|false
init|;
name|j
operator|<
name|nhchunks
condition|;
name|j
operator|++
control|)
block|{
name|uint64_t
name|nmalloc
decl_stmt|,
name|ndalloc
decl_stmt|,
name|nrequests
decl_stmt|;
name|size_t
name|hchunk_size
decl_stmt|,
name|curhchunks
decl_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.hchunks.0.nmalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.hchunks.0.ndalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.hchunks.0.nrequests"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|in_gap_prev
operator|=
name|in_gap
expr_stmt|;
name|in_gap
operator|=
operator|(
name|nrequests
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|json
operator|&&
name|in_gap_prev
operator|&&
operator|!
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"arenas.hchunk.0.size"
argument_list|,
name|j
argument_list|,
operator|&
name|hchunk_size
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.hchunks.0.curhchunks"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|curhchunks
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t{\n"
literal|"\t\t\t\t\t\t\"curhchunks\": %zu\n"
literal|"\t\t\t\t\t}%s\n"
argument_list|,
name|curhchunks
argument_list|,
operator|(
name|j
operator|+
literal|1
operator|<
name|nhchunks
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"%20zu %3u %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12zu\n"
argument_list|,
name|hchunk_size
argument_list|,
name|nbins
operator|+
name|nlruns
operator|+
name|j
argument_list|,
name|curhchunks
operator|*
name|hchunk_size
argument_list|,
name|nmalloc
argument_list|,
name|ndalloc
argument_list|,
name|nrequests
argument_list|,
name|curhchunks
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t]\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|stats_arena_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|unsigned
name|i
parameter_list|,
name|bool
name|bins
parameter_list|,
name|bool
name|large
parameter_list|,
name|bool
name|huge
parameter_list|)
block|{
name|unsigned
name|nthreads
decl_stmt|;
specifier|const
name|char
modifier|*
name|dss
decl_stmt|;
name|ssize_t
name|lg_dirty_mult
decl_stmt|,
name|decay_time
decl_stmt|;
name|size_t
name|page
decl_stmt|,
name|pactive
decl_stmt|,
name|pdirty
decl_stmt|,
name|mapped
decl_stmt|,
name|retained
decl_stmt|;
name|size_t
name|metadata_mapped
decl_stmt|,
name|metadata_allocated
decl_stmt|;
name|uint64_t
name|npurge
decl_stmt|,
name|nmadvise
decl_stmt|,
name|purged
decl_stmt|;
name|size_t
name|small_allocated
decl_stmt|;
name|uint64_t
name|small_nmalloc
decl_stmt|,
name|small_ndalloc
decl_stmt|,
name|small_nrequests
decl_stmt|;
name|size_t
name|large_allocated
decl_stmt|;
name|uint64_t
name|large_nmalloc
decl_stmt|,
name|large_ndalloc
decl_stmt|,
name|large_nrequests
decl_stmt|;
name|size_t
name|huge_allocated
decl_stmt|;
name|uint64_t
name|huge_nmalloc
decl_stmt|,
name|huge_ndalloc
decl_stmt|,
name|huge_nrequests
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.page"
argument_list|,
operator|&
name|page
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.nthreads"
argument_list|,
name|i
argument_list|,
operator|&
name|nthreads
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"nthreads\": %u,\n"
argument_list|,
name|nthreads
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"assigned threads: %u\n"
argument_list|,
name|nthreads
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.dss"
argument_list|,
name|i
argument_list|,
operator|&
name|dss
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"dss\": \"%s\",\n"
argument_list|,
name|dss
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"dss allocation precedence: %s\n"
argument_list|,
name|dss
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.lg_dirty_mult"
argument_list|,
name|i
argument_list|,
operator|&
name|lg_dirty_mult
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"lg_dirty_mult\": %zd,\n"
argument_list|,
name|lg_dirty_mult
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|opt_purge
operator|==
name|purge_mode_ratio
condition|)
block|{
if|if
condition|(
name|lg_dirty_mult
operator|>=
literal|0
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"min active:dirty page ratio: %u:1\n"
argument_list|,
operator|(
literal|1U
operator|<<
name|lg_dirty_mult
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"min active:dirty page ratio: N/A\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.decay_time"
argument_list|,
name|i
argument_list|,
operator|&
name|decay_time
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"decay_time\": %zd,\n"
argument_list|,
name|decay_time
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|opt_purge
operator|==
name|purge_mode_decay
condition|)
block|{
if|if
condition|(
name|decay_time
operator|>=
literal|0
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"decay time: %zd\n"
argument_list|,
name|decay_time
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"decay time: N/A\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.pactive"
argument_list|,
name|i
argument_list|,
operator|&
name|pactive
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.pdirty"
argument_list|,
name|i
argument_list|,
operator|&
name|pdirty
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.npurge"
argument_list|,
name|i
argument_list|,
operator|&
name|npurge
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.nmadvise"
argument_list|,
name|i
argument_list|,
operator|&
name|nmadvise
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.purged"
argument_list|,
name|i
argument_list|,
operator|&
name|purged
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"pactive\": %zu,\n"
argument_list|,
name|pactive
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"pdirty\": %zu,\n"
argument_list|,
name|pdirty
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"npurge\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|npurge
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"nmadvise\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|nmadvise
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"purged\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|purged
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"purging: dirty: %zu, sweeps: %"
name|FMTu64
literal|", madvises: %"
name|FMTu64
literal|", purged: %"
name|FMTu64
literal|"\n"
argument_list|,
name|pdirty
argument_list|,
name|npurge
argument_list|,
name|nmadvise
argument_list|,
name|purged
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.small.allocated"
argument_list|,
name|i
argument_list|,
operator|&
name|small_allocated
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.small.nmalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|small_nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.small.ndalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|small_ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.small.nrequests"
argument_list|,
name|i
argument_list|,
operator|&
name|small_nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"small\": {\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"allocated\": %zu,\n"
argument_list|,
name|small_allocated
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nmalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|small_nmalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"ndalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|small_ndalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nrequests\": %"
name|FMTu64
literal|"\n"
argument_list|,
name|small_nrequests
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t},\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                            allocated      nmalloc"
literal|"      ndalloc    nrequests\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"small:                   %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|small_allocated
argument_list|,
name|small_nmalloc
argument_list|,
name|small_ndalloc
argument_list|,
name|small_nrequests
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.large.allocated"
argument_list|,
name|i
argument_list|,
operator|&
name|large_allocated
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.large.nmalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|large_nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.large.ndalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|large_ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.large.nrequests"
argument_list|,
name|i
argument_list|,
operator|&
name|large_nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"large\": {\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"allocated\": %zu,\n"
argument_list|,
name|large_allocated
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nmalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|large_nmalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"ndalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|large_ndalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nrequests\": %"
name|FMTu64
literal|"\n"
argument_list|,
name|large_nrequests
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t},\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"large:                   %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|large_allocated
argument_list|,
name|large_nmalloc
argument_list|,
name|large_ndalloc
argument_list|,
name|large_nrequests
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.huge.allocated"
argument_list|,
name|i
argument_list|,
operator|&
name|huge_allocated
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.huge.nmalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|huge_nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.huge.ndalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|huge_ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.huge.nrequests"
argument_list|,
name|i
argument_list|,
operator|&
name|huge_nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"huge\": {\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"allocated\": %zu,\n"
argument_list|,
name|huge_allocated
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nmalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|huge_nmalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"ndalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|huge_ndalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nrequests\": %"
name|FMTu64
literal|"\n"
argument_list|,
name|huge_nrequests
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t},\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"huge:                    %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|huge_allocated
argument_list|,
name|huge_nmalloc
argument_list|,
name|huge_ndalloc
argument_list|,
name|huge_nrequests
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"total:                   %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|small_allocated
operator|+
name|large_allocated
operator|+
name|huge_allocated
argument_list|,
name|small_nmalloc
operator|+
name|large_nmalloc
operator|+
name|huge_nmalloc
argument_list|,
name|small_ndalloc
operator|+
name|large_ndalloc
operator|+
name|huge_ndalloc
argument_list|,
name|small_nrequests
operator|+
name|large_nrequests
operator|+
name|huge_nrequests
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"active:                  %12zu\n"
argument_list|,
name|pactive
operator|*
name|page
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.mapped"
argument_list|,
name|i
argument_list|,
operator|&
name|mapped
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"mapped\": %zu,\n"
argument_list|,
name|mapped
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"mapped:                  %12zu\n"
argument_list|,
name|mapped
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.retained"
argument_list|,
name|i
argument_list|,
operator|&
name|retained
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"retained\": %zu,\n"
argument_list|,
name|retained
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"retained:                %12zu\n"
argument_list|,
name|retained
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.metadata.mapped"
argument_list|,
name|i
argument_list|,
operator|&
name|metadata_mapped
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.metadata.allocated"
argument_list|,
name|i
argument_list|,
operator|&
name|metadata_allocated
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"metadata\": {\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"mapped\": %zu,\n"
argument_list|,
name|metadata_mapped
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"allocated\": %zu\n"
argument_list|,
name|metadata_allocated
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t}%s\n"
argument_list|,
operator|(
name|bins
operator|||
name|large
operator|||
name|huge
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"metadata: mapped: %zu, allocated: %zu\n"
argument_list|,
name|metadata_mapped
argument_list|,
name|metadata_allocated
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bins
condition|)
block|{
name|stats_arena_bins_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|large
argument_list|,
name|huge
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|large
condition|)
name|stats_arena_lruns_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|huge
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|huge
condition|)
name|stats_arena_hchunks_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|stats_general_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|bool
name|more
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cpv
decl_stmt|;
name|bool
name|bv
decl_stmt|;
name|unsigned
name|uv
decl_stmt|;
name|uint32_t
name|u32v
decl_stmt|;
name|uint64_t
name|u64v
decl_stmt|;
name|ssize_t
name|ssv
decl_stmt|;
name|size_t
name|sv
decl_stmt|,
name|bsz
decl_stmt|,
name|usz
decl_stmt|,
name|ssz
decl_stmt|,
name|sssz
decl_stmt|,
name|cpsz
decl_stmt|;
name|bsz
operator|=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
expr_stmt|;
name|usz
operator|=
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
expr_stmt|;
name|ssz
operator|=
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
expr_stmt|;
name|sssz
operator|=
sizeof|sizeof
argument_list|(
name|ssize_t
argument_list|)
expr_stmt|;
name|cpsz
operator|=
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"version"
argument_list|,
operator|&
name|cpv
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"version\": \"%s\",\n"
argument_list|,
name|cpv
argument_list|)
expr_stmt|;
block|}
else|else
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Version: %s\n"
argument_list|,
name|cpv
argument_list|)
expr_stmt|;
comment|/* config. */
define|#
directive|define
name|CONFIG_WRITE_BOOL_JSON
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (json) {							\ 		CTL_GET("config."#n,&bv, bool);			\ 		malloc_cprintf(write_cb, cbopaque,			\ 		    "\t\t\t\""#n"\": %s%s\n", bv ? "true" : "false",	\ 		    (c));						\ 	}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"config\": {\n"
argument_list|)
expr_stmt|;
block|}
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|cache_oblivious
argument_list|,
literal|","
argument_list|)
name|CTL_GET
argument_list|(
literal|"config.debug"
argument_list|,
operator|&
name|bv
argument_list|,
name|bool
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"debug\": %s,\n"
argument_list|,
name|bv
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Assertions %s\n"
argument_list|,
name|bv
condition|?
literal|"enabled"
else|:
literal|"disabled"
argument_list|)
expr_stmt|;
block|}
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|fill
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|lazy_lock
argument_list|,
literal|","
argument_list|)
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"malloc_conf\": \"%s\",\n"
argument_list|,
name|config_malloc_conf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"config.malloc_conf: \"%s\"\n"
argument_list|,
name|config_malloc_conf
argument_list|)
expr_stmt|;
block|}
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|munmap
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|prof
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|prof_libgcc
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|prof_libunwind
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|stats
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|tcache
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|tls
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|utrace
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|valgrind
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|xmalloc
argument_list|,
literal|""
argument_list|)
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t},\n"
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|CONFIG_WRITE_BOOL_JSON
comment|/* opt. */
define|#
directive|define
name|OPT_WRITE_BOOL
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (je_mallctl("opt."#n, (void *)&bv,&bsz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %s%s\n", bv ? "true" :	\ 			    "false", (c));				\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": %s\n", bv ? "true" : "false");	\ 		}							\ 	}
define|#
directive|define
name|OPT_WRITE_BOOL_MUTABLE
parameter_list|(
name|n
parameter_list|,
name|m
parameter_list|,
name|c
parameter_list|)
value|{				\ 	bool bv2;							\ 	if (je_mallctl("opt."#n, (void *)&bv,&bsz, NULL, 0) == 0&&	\ 	    je_mallctl(#m,&bv2, (void *)&bsz, NULL, 0) == 0) {		\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %s%s\n", bv ? "true" :	\ 			    "false", (c));				\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": %s ("#m": %s)\n", bv ? "true"	\ 			    : "false", bv2 ? "true" : "false");		\ 		}							\ 	}								\ }
define|#
directive|define
name|OPT_WRITE_UNSIGNED
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (je_mallctl("opt."#n, (void *)&uv,&usz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %u%s\n", uv, (c));		\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			"  opt."#n": %u\n", uv);			\ 		}							\ 	}
define|#
directive|define
name|OPT_WRITE_SIZE_T
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (je_mallctl("opt."#n, (void *)&sv,&ssz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %zu%s\n", sv, (c));	\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			"  opt."#n": %zu\n", sv);			\ 		}							\ 	}
define|#
directive|define
name|OPT_WRITE_SSIZE_T
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (je_mallctl("opt."#n, (void *)&ssv,&sssz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %zd%s\n", ssv, (c));	\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": %zd\n", ssv);			\ 		}							\ 	}
define|#
directive|define
name|OPT_WRITE_SSIZE_T_MUTABLE
parameter_list|(
name|n
parameter_list|,
name|m
parameter_list|,
name|c
parameter_list|)
value|{				\ 	ssize_t ssv2;							\ 	if (je_mallctl("opt."#n, (void *)&ssv,&sssz, NULL, 0) == 0&&	\ 	    je_mallctl(#m, (void *)&ssv2,&sssz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %zd%s\n", ssv, (c));	\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": %zd ("#m": %zd)\n",		\ 			    ssv, ssv2);					\ 		}							\ 	}								\ }
define|#
directive|define
name|OPT_WRITE_CHAR_P
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (je_mallctl("opt."#n, (void *)&cpv,&cpsz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": \"%s\"%s\n", cpv, (c));	\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": \"%s\"\n", cpv);		\ 		}							\ 	}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"opt\": {\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Run-time option settings:\n"
argument_list|)
expr_stmt|;
block|}
name|OPT_WRITE_BOOL
argument_list|(
argument|abort
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SIZE_T
argument_list|(
argument|lg_chunk
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_CHAR_P
argument_list|(
argument|dss
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_UNSIGNED
argument_list|(
argument|narenas
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_CHAR_P
argument_list|(
argument|purge
argument_list|,
literal|","
argument_list|)
if|if
condition|(
name|json
operator|||
name|opt_purge
operator|==
name|purge_mode_ratio
condition|)
block|{
name|OPT_WRITE_SSIZE_T_MUTABLE
argument_list|(
argument|lg_dirty_mult
argument_list|,
argument|arenas.lg_dirty_mult
argument_list|,
literal|","
argument_list|)
block|}
if|if
condition|(
name|json
operator|||
name|opt_purge
operator|==
name|purge_mode_decay
condition|)
block|{
name|OPT_WRITE_SSIZE_T_MUTABLE
argument_list|(
argument|decay_time
argument_list|,
argument|arenas.decay_time
argument_list|,
literal|","
argument_list|)
block|}
name|OPT_WRITE_CHAR_P
argument_list|(
argument|junk
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SIZE_T
argument_list|(
argument|quarantine
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|redzone
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|zero
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|utrace
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|xmalloc
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|tcache
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SSIZE_T
argument_list|(
argument|lg_tcache_max
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|thp
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_CHAR_P
argument_list|(
argument|prof_prefix
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL_MUTABLE
argument_list|(
argument|prof_active
argument_list|,
argument|prof.active
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL_MUTABLE
argument_list|(
argument|prof_thread_active_init
argument_list|,
argument|prof.thread_active_init
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SSIZE_T_MUTABLE
argument_list|(
argument|lg_prof_sample
argument_list|,
argument|prof.lg_sample
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof_accum
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SSIZE_T
argument_list|(
argument|lg_prof_interval
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof_gdump
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof_final
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof_leak
argument_list|,
literal|","
argument_list|)
comment|/* 	 * stats_print is always emitted, so as long as stats_print comes last 	 * it's safe to unconditionally omit the comma here (rather than having 	 * to conditionally omit it elsewhere depending on configuration). 	 */
name|OPT_WRITE_BOOL
argument_list|(
argument|stats_print
argument_list|,
literal|""
argument_list|)
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t},\n"
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|OPT_WRITE_BOOL
undef|#
directive|undef
name|OPT_WRITE_BOOL_MUTABLE
undef|#
directive|undef
name|OPT_WRITE_SIZE_T
undef|#
directive|undef
name|OPT_WRITE_SSIZE_T
undef|#
directive|undef
name|OPT_WRITE_CHAR_P
comment|/* arenas. */
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"arenas\": {\n"
argument_list|)
expr_stmt|;
block|}
name|CTL_GET
argument_list|(
literal|"arenas.narenas"
argument_list|,
operator|&
name|uv
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"narenas\": %u,\n"
argument_list|,
name|uv
argument_list|)
expr_stmt|;
block|}
else|else
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Arenas: %u\n"
argument_list|,
name|uv
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.lg_dirty_mult"
argument_list|,
operator|&
name|ssv
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"lg_dirty_mult\": %zd,\n"
argument_list|,
name|ssv
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opt_purge
operator|==
name|purge_mode_ratio
condition|)
block|{
if|if
condition|(
name|ssv
operator|>=
literal|0
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Min active:dirty page ratio per arena: "
literal|"%u:1\n"
argument_list|,
operator|(
literal|1U
operator|<<
name|ssv
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Min active:dirty page ratio per arena: "
literal|"N/A\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|CTL_GET
argument_list|(
literal|"arenas.decay_time"
argument_list|,
operator|&
name|ssv
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"decay_time\": %zd,\n"
argument_list|,
name|ssv
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opt_purge
operator|==
name|purge_mode_decay
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Unused dirty page decay time: %zd%s\n"
argument_list|,
name|ssv
argument_list|,
operator|(
name|ssv
operator|<
literal|0
operator|)
condition|?
literal|" (no decay)"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|CTL_GET
argument_list|(
literal|"arenas.quantum"
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"quantum\": %zu,\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
else|else
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Quantum size: %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.page"
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"page\": %zu,\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
else|else
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Page size: %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
if|if
condition|(
name|je_mallctl
argument_list|(
literal|"arenas.tcache_max"
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|sv
argument_list|,
operator|&
name|ssz
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"tcache_max\": %zu,\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Maximum thread-cached size class: %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|unsigned
name|nbins
decl_stmt|,
name|nlruns
decl_stmt|,
name|nhchunks
decl_stmt|,
name|i
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nbins"
argument_list|,
operator|&
name|nbins
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"nbins\": %u,\n"
argument_list|,
name|nbins
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_tcache
condition|)
block|{
name|CTL_GET
argument_list|(
literal|"arenas.nhbins"
argument_list|,
operator|&
name|uv
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"nhbins\": %u,\n"
argument_list|,
name|uv
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"bin\": [\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbins
condition|;
name|i
operator|++
control|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t{\n"
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.size"
argument_list|,
name|i
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"size\": %zu,\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.nregs"
argument_list|,
name|i
argument_list|,
operator|&
name|u32v
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nregs\": %"
name|FMTu32
literal|",\n"
argument_list|,
name|u32v
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.run_size"
argument_list|,
name|i
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"run_size\": %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t}%s\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|<
name|nbins
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t],\n"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nlruns"
argument_list|,
operator|&
name|nlruns
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"nlruns\": %u,\n"
argument_list|,
name|nlruns
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"lrun\": [\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nlruns
condition|;
name|i
operator|++
control|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t{\n"
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.lrun.0.size"
argument_list|,
name|i
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"size\": %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t}%s\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|<
name|nlruns
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t],\n"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nhchunks"
argument_list|,
operator|&
name|nhchunks
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"nhchunks\": %u,\n"
argument_list|,
name|nhchunks
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"hchunk\": [\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nhchunks
condition|;
name|i
operator|++
control|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t{\n"
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.hchunk.0.size"
argument_list|,
name|i
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"size\": %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t}%s\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|<
name|nhchunks
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t]\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t}%s\n"
argument_list|,
operator|(
name|config_prof
operator|||
name|more
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
comment|/* prof. */
if|if
condition|(
name|config_prof
operator|&&
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"prof\": {\n"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.thread_active_init"
argument_list|,
operator|&
name|bv
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"thread_active_init\": %s,\n"
argument_list|,
name|bv
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.active"
argument_list|,
operator|&
name|bv
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"active\": %s,\n"
argument_list|,
name|bv
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.gdump"
argument_list|,
operator|&
name|bv
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"gdump\": %s,\n"
argument_list|,
name|bv
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.interval"
argument_list|,
operator|&
name|u64v
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"interval\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|u64v
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.lg_sample"
argument_list|,
operator|&
name|ssv
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"lg_sample\": %zd\n"
argument_list|,
name|ssv
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t}%s\n"
argument_list|,
name|more
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|stats_print_helper
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|bool
name|merged
parameter_list|,
name|bool
name|unmerged
parameter_list|,
name|bool
name|bins
parameter_list|,
name|bool
name|large
parameter_list|,
name|bool
name|huge
parameter_list|)
block|{
name|size_t
modifier|*
name|cactive
decl_stmt|;
name|size_t
name|allocated
decl_stmt|,
name|active
decl_stmt|,
name|metadata
decl_stmt|,
name|resident
decl_stmt|,
name|mapped
decl_stmt|,
name|retained
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.cactive"
argument_list|,
operator|&
name|cactive
argument_list|,
name|size_t
operator|*
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.allocated"
argument_list|,
operator|&
name|allocated
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.active"
argument_list|,
operator|&
name|active
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.metadata"
argument_list|,
operator|&
name|metadata
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.resident"
argument_list|,
operator|&
name|resident
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.mapped"
argument_list|,
operator|&
name|mapped
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.retained"
argument_list|,
operator|&
name|retained
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"stats\": {\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"cactive\": %zu,\n"
argument_list|,
name|atomic_read_z
argument_list|(
name|cactive
argument_list|)
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"allocated\": %zu,\n"
argument_list|,
name|allocated
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"active\": %zu,\n"
argument_list|,
name|active
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"metadata\": %zu,\n"
argument_list|,
name|metadata
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"resident\": %zu,\n"
argument_list|,
name|resident
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"mapped\": %zu,\n"
argument_list|,
name|mapped
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"retained\": %zu\n"
argument_list|,
name|retained
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t}%s\n"
argument_list|,
operator|(
name|merged
operator|||
name|unmerged
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Allocated: %zu, active: %zu, metadata: %zu,"
literal|" resident: %zu, mapped: %zu, retained: %zu\n"
argument_list|,
name|allocated
argument_list|,
name|active
argument_list|,
name|metadata
argument_list|,
name|resident
argument_list|,
name|mapped
argument_list|,
name|retained
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Current active ceiling: %zu\n"
argument_list|,
name|atomic_read_z
argument_list|(
name|cactive
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|merged
operator|||
name|unmerged
condition|)
block|{
name|unsigned
name|narenas
decl_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"stats.arenas\": {\n"
argument_list|)
expr_stmt|;
block|}
name|CTL_GET
argument_list|(
literal|"arenas.narenas"
argument_list|,
operator|&
name|narenas
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
block|{
name|VARIABLE_ARRAY
argument_list|(
name|bool
argument_list|,
name|initialized
argument_list|,
name|narenas
argument_list|)
expr_stmt|;
name|size_t
name|isz
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|j
decl_stmt|,
name|ninitialized
decl_stmt|;
name|isz
operator|=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
operator|*
name|narenas
expr_stmt|;
name|xmallctl
argument_list|(
literal|"arenas.initialized"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|initialized
argument_list|,
operator|&
name|isz
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ninitialized
operator|=
literal|0
init|;
name|i
operator|<
name|narenas
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|initialized
index|[
name|i
index|]
condition|)
name|ninitialized
operator|++
expr_stmt|;
block|}
comment|/* Merged stats. */
if|if
condition|(
name|merged
operator|&&
operator|(
name|ninitialized
operator|>
literal|1
operator|||
operator|!
name|unmerged
operator|)
condition|)
block|{
comment|/* Print merged arena stats. */
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"merged\": {\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\nMerged arenas stats:\n"
argument_list|)
expr_stmt|;
block|}
name|stats_arena_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|narenas
argument_list|,
name|bins
argument_list|,
name|large
argument_list|,
name|huge
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t}%s\n"
argument_list|,
name|unmerged
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Unmerged stats. */
if|if
condition|(
name|unmerged
condition|)
block|{
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|narenas
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|initialized
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|json
condition|)
block|{
name|j
operator|++
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"%u\": {\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\narenas[%u]:\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|stats_arena_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|i
argument_list|,
name|bins
argument_list|,
name|large
argument_list|,
name|huge
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t}%s\n"
argument_list|,
operator|(
name|j
operator|<
name|ninitialized
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t}\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|stats_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
specifier|const
name|char
modifier|*
name|opts
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|uint64_t
name|epoch
decl_stmt|;
name|size_t
name|u64sz
decl_stmt|;
name|bool
name|json
init|=
name|false
decl_stmt|;
name|bool
name|general
init|=
name|true
decl_stmt|;
name|bool
name|merged
init|=
name|config_stats
decl_stmt|;
name|bool
name|unmerged
init|=
name|config_stats
decl_stmt|;
name|bool
name|bins
init|=
name|true
decl_stmt|;
name|bool
name|large
init|=
name|true
decl_stmt|;
name|bool
name|huge
init|=
name|true
decl_stmt|;
comment|/* 	 * Refresh stats, in case mallctl() was called by the application. 	 * 	 * Check for OOM here, since refreshing the ctl cache can trigger 	 * allocation.  In practice, none of the subsequent mallctl()-related 	 * calls in this function will cause OOM if this one succeeds. 	 * */
name|epoch
operator|=
literal|1
expr_stmt|;
name|u64sz
operator|=
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|je_mallctl
argument_list|(
literal|"epoch"
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|epoch
argument_list|,
operator|&
name|u64sz
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|epoch
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|err
operator|==
name|EAGAIN
condition|)
block|{
name|malloc_write
argument_list|(
literal|"<jemalloc>: Memory allocation failure in "
literal|"mallctl(\"epoch\", ...)\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|malloc_write
argument_list|(
literal|"<jemalloc>: Failure in mallctl(\"epoch\", "
literal|"...)\n"
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|opts
operator|!=
name|NULL
condition|)
block|{
name|unsigned
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|opts
index|[
name|i
index|]
operator|!=
literal|'\0'
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|opts
index|[
name|i
index|]
condition|)
block|{
case|case
literal|'J'
case|:
name|json
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|general
operator|=
name|false
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|merged
operator|=
name|false
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|unmerged
operator|=
name|false
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|bins
operator|=
name|false
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|large
operator|=
name|false
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|huge
operator|=
name|false
expr_stmt|;
break|break;
default|default:
empty_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"{\n"
literal|"\t\"jemalloc\": {\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"___ Begin jemalloc statistics ___\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|general
condition|)
block|{
name|bool
name|more
init|=
operator|(
name|merged
operator|||
name|unmerged
operator|)
decl_stmt|;
name|stats_general_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|more
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config_stats
condition|)
block|{
name|stats_print_helper
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|merged
argument_list|,
name|unmerged
argument_list|,
name|bins
argument_list|,
name|large
argument_list|,
name|huge
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t}\n"
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"--- End jemalloc statistics ---\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


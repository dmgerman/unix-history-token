begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_STATS_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_preamble.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal_includes.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/assert.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/ctl.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/mutex.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/mutex_prof.h"
end_include

begin_decl_stmt
specifier|const
name|char
modifier|*
name|global_mutex_names
index|[
name|mutex_prof_num_global_mutexes
index|]
init|=
block|{
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|#mtx,
name|MUTEX_PROF_GLOBAL_MUTEXES
undef|#
directive|undef
name|OP
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|arena_mutex_names
index|[
name|mutex_prof_num_arena_mutexes
index|]
init|=
block|{
define|#
directive|define
name|OP
parameter_list|(
name|mtx
parameter_list|)
value|#mtx,
name|MUTEX_PROF_ARENA_MUTEXES
undef|#
directive|undef
name|OP
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CTL_GET
parameter_list|(
name|n
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
value|do {						\ 	size_t sz = sizeof(t);						\ 	xmallctl(n, (void *)v,&sz, NULL, 0);				\ } while (0)
end_define

begin_define
define|#
directive|define
name|CTL_M2_GET
parameter_list|(
name|n
parameter_list|,
name|i
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
value|do {					\ 	size_t mib[CTL_MAX_DEPTH];					\ 	size_t miblen = sizeof(mib) / sizeof(size_t);			\ 	size_t sz = sizeof(t);						\ 	xmallctlnametomib(n, mib,&miblen);				\ 	mib[2] = (i);							\ 	xmallctlbymib(mib, miblen, (void *)v,&sz, NULL, 0);		\ } while (0)
end_define

begin_define
define|#
directive|define
name|CTL_M2_M4_GET
parameter_list|(
name|n
parameter_list|,
name|i
parameter_list|,
name|j
parameter_list|,
name|v
parameter_list|,
name|t
parameter_list|)
value|do {				\ 	size_t mib[CTL_MAX_DEPTH];					\ 	size_t miblen = sizeof(mib) / sizeof(size_t);			\ 	size_t sz = sizeof(t);						\ 	xmallctlnametomib(n, mib,&miblen);				\ 	mib[2] = (i);							\ 	mib[4] = (j);							\ 	xmallctlbymib(mib, miblen, (void *)v,&sz, NULL, 0);		\ } while (0)
end_define

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_decl_stmt
name|bool
name|opt_stats_print
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|opt_stats_print_opts
index|[
name|stats_print_tot_num_options
operator|+
literal|1
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Calculate x.yyy and output a string (takes a fixed sized char array). */
end_comment

begin_function
specifier|static
name|bool
name|get_rate_str
parameter_list|(
name|uint64_t
name|dividend
parameter_list|,
name|uint64_t
name|divisor
parameter_list|,
name|char
name|str
index|[
literal|6
index|]
parameter_list|)
block|{
if|if
condition|(
name|divisor
operator|==
literal|0
operator|||
name|dividend
operator|>
name|divisor
condition|)
block|{
comment|/* The rate is not supposed to be greater than 1. */
return|return
name|true
return|;
block|}
if|if
condition|(
name|dividend
operator|>
literal|0
condition|)
block|{
name|assert
argument_list|(
name|UINT64_MAX
operator|/
name|dividend
operator|>=
literal|1000
argument_list|)
expr_stmt|;
block|}
name|unsigned
name|n
init|=
call|(
name|unsigned
call|)
argument_list|(
operator|(
name|dividend
operator|*
literal|1000
operator|)
operator|/
name|divisor
argument_list|)
decl_stmt|;
if|if
condition|(
name|n
operator|<
literal|10
condition|)
block|{
name|malloc_snprintf
argument_list|(
name|str
argument_list|,
literal|6
argument_list|,
literal|"0.00%u"
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n
operator|<
literal|100
condition|)
block|{
name|malloc_snprintf
argument_list|(
name|str
argument_list|,
literal|6
argument_list|,
literal|"0.0%u"
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n
operator|<
literal|1000
condition|)
block|{
name|malloc_snprintf
argument_list|(
name|str
argument_list|,
literal|6
argument_list|,
literal|"0.%u"
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_snprintf
argument_list|(
name|str
argument_list|,
literal|6
argument_list|,
literal|"1"
argument_list|)
expr_stmt|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MUTEX_CTL_STR_MAX_LENGTH
value|128
end_define

begin_function
specifier|static
name|void
name|gen_mutex_ctl_str
parameter_list|(
name|char
modifier|*
name|str
parameter_list|,
name|size_t
name|buf_len
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
specifier|const
name|char
modifier|*
name|mutex
parameter_list|,
specifier|const
name|char
modifier|*
name|counter
parameter_list|)
block|{
name|malloc_snprintf
argument_list|(
name|str
argument_list|,
name|buf_len
argument_list|,
literal|"stats.%s.%s.%s"
argument_list|,
name|prefix
argument_list|,
name|mutex
argument_list|,
name|counter
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|read_arena_bin_mutex_stats
parameter_list|(
name|unsigned
name|arena_ind
parameter_list|,
name|unsigned
name|bin_ind
parameter_list|,
name|uint64_t
name|results
index|[
name|mutex_prof_num_counters
index|]
parameter_list|)
block|{
name|char
name|cmd
index|[
name|MUTEX_CTL_STR_MAX_LENGTH
index|]
decl_stmt|;
define|#
directive|define
name|OP
parameter_list|(
name|c
parameter_list|,
name|t
parameter_list|)
define|\
value|gen_mutex_ctl_str(cmd, MUTEX_CTL_STR_MAX_LENGTH,			\         "arenas.0.bins.0","mutex", #c);					\     CTL_M2_M4_GET(cmd, arena_ind, bin_ind,				\         (t *)&results[mutex_counter_##c], t);
name|MUTEX_PROF_COUNTERS
undef|#
directive|undef
name|OP
block|}
end_function

begin_function
specifier|static
name|void
name|mutex_stats_output_json
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|uint64_t
name|stats
index|[
name|mutex_prof_num_counters
index|]
parameter_list|,
specifier|const
name|char
modifier|*
name|json_indent
parameter_list|,
name|bool
name|last
parameter_list|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"%s\"%s\": {\n"
argument_list|,
name|json_indent
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|mutex_prof_counter_ind_t
name|k
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|fmt_str
index|[
literal|2
index|]
init|=
block|{
literal|"%s\t\"%s\": %"
name|FMTu32
literal|"%s\n"
block|,
literal|"%s\t\"%s\": %"
name|FMTu64
literal|"%s\n"
block|}
decl_stmt|;
define|#
directive|define
name|OP
parameter_list|(
name|c
parameter_list|,
name|t
parameter_list|)
define|\
value|malloc_cprintf(write_cb, cbopaque,				\ 	    fmt_str[sizeof(t) / sizeof(uint32_t) - 1], 			\ 	    json_indent, #c, (t)stats[mutex_counter_##c],		\ 	    (++k == mutex_prof_num_counters) ? "" : ",");
name|MUTEX_PROF_COUNTERS
undef|#
directive|undef
name|OP
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"%s}%s\n"
argument_list|,
name|json_indent
argument_list|,
name|last
condition|?
literal|""
else|:
literal|","
argument_list|)
decl_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|stats_arena_bins_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|bool
name|large
parameter_list|,
name|bool
name|mutex
parameter_list|,
name|unsigned
name|i
parameter_list|)
block|{
name|size_t
name|page
decl_stmt|;
name|bool
name|in_gap
decl_stmt|,
name|in_gap_prev
decl_stmt|;
name|unsigned
name|nbins
decl_stmt|,
name|j
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.page"
argument_list|,
operator|&
name|page
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nbins"
argument_list|,
operator|&
name|nbins
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"bins\": [\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|mutex_counters
init|=
literal|"   n_lock_ops    n_waiting"
literal|"   n_spin_acq  total_wait_ns  max_wait_ns\n"
decl_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"bins:           size ind    allocated      nmalloc"
literal|"      ndalloc    nrequests      curregs     curslabs regs"
literal|" pgs  util       nfills     nflushes     newslabs"
literal|"      reslabs%s"
argument_list|,
name|mutex
condition|?
name|mutex_counters
else|:
literal|"\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|in_gap
operator|=
name|false
init|;
name|j
operator|<
name|nbins
condition|;
name|j
operator|++
control|)
block|{
name|uint64_t
name|nslabs
decl_stmt|;
name|size_t
name|reg_size
decl_stmt|,
name|slab_size
decl_stmt|,
name|curregs
decl_stmt|;
name|size_t
name|curslabs
decl_stmt|;
name|uint32_t
name|nregs
decl_stmt|;
name|uint64_t
name|nmalloc
decl_stmt|,
name|ndalloc
decl_stmt|,
name|nrequests
decl_stmt|,
name|nfills
decl_stmt|,
name|nflushes
decl_stmt|;
name|uint64_t
name|nreslabs
decl_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nslabs"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nslabs
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|in_gap_prev
operator|=
name|in_gap
expr_stmt|;
name|in_gap
operator|=
operator|(
name|nslabs
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|json
operator|&&
name|in_gap_prev
operator|&&
operator|!
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.size"
argument_list|,
name|j
argument_list|,
operator|&
name|reg_size
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.nregs"
argument_list|,
name|j
argument_list|,
operator|&
name|nregs
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.slab_size"
argument_list|,
name|j
argument_list|,
operator|&
name|slab_size
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nmalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.ndalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.curregs"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|curregs
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nrequests"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nfills"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nfills
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nflushes"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nflushes
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.nreslabs"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nreslabs
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.bins.0.curslabs"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|curslabs
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t{\n"
literal|"\t\t\t\t\t\t\"nmalloc\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"ndalloc\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"curregs\": %zu,\n"
literal|"\t\t\t\t\t\t\"nrequests\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"nfills\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"nflushes\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"nreslabs\": %"
name|FMTu64
literal|",\n"
literal|"\t\t\t\t\t\t\"curslabs\": %zu%s\n"
argument_list|,
name|nmalloc
argument_list|,
name|ndalloc
argument_list|,
name|curregs
argument_list|,
name|nrequests
argument_list|,
name|nfills
argument_list|,
name|nflushes
argument_list|,
name|nreslabs
argument_list|,
name|curslabs
argument_list|,
name|mutex
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|mutex
condition|)
block|{
name|uint64_t
name|mutex_stats
index|[
name|mutex_prof_num_counters
index|]
decl_stmt|;
name|read_arena_bin_mutex_stats
argument_list|(
name|i
argument_list|,
name|j
argument_list|,
name|mutex_stats
argument_list|)
expr_stmt|;
name|mutex_stats_output_json
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"mutex"
argument_list|,
name|mutex_stats
argument_list|,
literal|"\t\t\t\t\t\t"
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t}%s\n"
argument_list|,
operator|(
name|j
operator|+
literal|1
operator|<
name|nbins
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|in_gap
condition|)
block|{
name|size_t
name|availregs
init|=
name|nregs
operator|*
name|curslabs
decl_stmt|;
name|char
name|util
index|[
literal|6
index|]
decl_stmt|;
if|if
condition|(
name|get_rate_str
argument_list|(
operator|(
name|uint64_t
operator|)
name|curregs
argument_list|,
operator|(
name|uint64_t
operator|)
name|availregs
argument_list|,
name|util
argument_list|)
condition|)
block|{
if|if
condition|(
name|availregs
operator|==
literal|0
condition|)
block|{
name|malloc_snprintf
argument_list|(
name|util
argument_list|,
sizeof|sizeof
argument_list|(
name|util
argument_list|)
argument_list|,
literal|"1"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|curregs
operator|>
name|availregs
condition|)
block|{
comment|/* 					 * Race detected: the counters were read 					 * in separate mallctl calls and 					 * concurrent operations happened in 					 * between. In this case no meaningful 					 * utilization can be computed. 					 */
name|malloc_snprintf
argument_list|(
name|util
argument_list|,
sizeof|sizeof
argument_list|(
name|util
argument_list|)
argument_list|,
literal|" race"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|not_reached
argument_list|()
expr_stmt|;
block|}
block|}
name|uint64_t
name|mutex_stats
index|[
name|mutex_prof_num_counters
index|]
decl_stmt|;
if|if
condition|(
name|mutex
condition|)
block|{
name|read_arena_bin_mutex_stats
argument_list|(
name|i
argument_list|,
name|j
argument_list|,
name|mutex_stats
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"%20zu %3u %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12zu %12zu %4u"
literal|" %3zu %-5s %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
argument_list|,
name|reg_size
argument_list|,
name|j
argument_list|,
name|curregs
operator|*
name|reg_size
argument_list|,
name|nmalloc
argument_list|,
name|ndalloc
argument_list|,
name|nrequests
argument_list|,
name|curregs
argument_list|,
name|curslabs
argument_list|,
name|nregs
argument_list|,
name|slab_size
operator|/
name|page
argument_list|,
name|util
argument_list|,
name|nfills
argument_list|,
name|nflushes
argument_list|,
name|nslabs
argument_list|,
name|nreslabs
argument_list|)
expr_stmt|;
comment|/* Output less info for bin mutexes to save space. */
if|if
condition|(
name|mutex
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %14"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|mutex_stats
index|[
name|mutex_counter_num_ops
index|]
argument_list|,
name|mutex_stats
index|[
name|mutex_counter_num_wait
index|]
argument_list|,
name|mutex_stats
index|[
name|mutex_counter_num_spin_acq
index|]
argument_list|,
name|mutex_stats
index|[
name|mutex_counter_total_wait_time
index|]
argument_list|,
name|mutex_stats
index|[
name|mutex_counter_max_wait_time
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t]%s\n"
argument_list|,
name|large
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|stats_arena_lextents_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|unsigned
name|i
parameter_list|)
block|{
name|unsigned
name|nbins
decl_stmt|,
name|nlextents
decl_stmt|,
name|j
decl_stmt|;
name|bool
name|in_gap
decl_stmt|,
name|in_gap_prev
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nbins"
argument_list|,
operator|&
name|nbins
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nlextents"
argument_list|,
operator|&
name|nlextents
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"lextents\": [\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"large:          size ind    allocated      nmalloc"
literal|"      ndalloc    nrequests  curlextents\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|in_gap
operator|=
name|false
init|;
name|j
operator|<
name|nlextents
condition|;
name|j
operator|++
control|)
block|{
name|uint64_t
name|nmalloc
decl_stmt|,
name|ndalloc
decl_stmt|,
name|nrequests
decl_stmt|;
name|size_t
name|lextent_size
decl_stmt|,
name|curlextents
decl_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.lextents.0.nmalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.lextents.0.ndalloc"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.lextents.0.nrequests"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|in_gap_prev
operator|=
name|in_gap
expr_stmt|;
name|in_gap
operator|=
operator|(
name|nrequests
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|json
operator|&&
name|in_gap_prev
operator|&&
operator|!
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"arenas.lextent.0.size"
argument_list|,
name|j
argument_list|,
operator|&
name|lextent_size
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_M4_GET
argument_list|(
literal|"stats.arenas.0.lextents.0.curlextents"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
operator|&
name|curlextents
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t{\n"
literal|"\t\t\t\t\t\t\"curlextents\": %zu\n"
literal|"\t\t\t\t\t}%s\n"
argument_list|,
name|curlextents
argument_list|,
operator|(
name|j
operator|+
literal|1
operator|<
name|nlextents
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"%20zu %3u %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12zu\n"
argument_list|,
name|lextent_size
argument_list|,
name|nbins
operator|+
name|j
argument_list|,
name|curlextents
operator|*
name|lextent_size
argument_list|,
name|nmalloc
argument_list|,
name|ndalloc
argument_list|,
name|nrequests
argument_list|,
name|curlextents
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t]\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|in_gap
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                     ---\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|read_arena_mutex_stats
parameter_list|(
name|unsigned
name|arena_ind
parameter_list|,
name|uint64_t
name|results
index|[
name|mutex_prof_num_arena_mutexes
index|]
index|[
name|mutex_prof_num_counters
index|]
parameter_list|)
block|{
name|char
name|cmd
index|[
name|MUTEX_CTL_STR_MAX_LENGTH
index|]
decl_stmt|;
name|mutex_prof_arena_ind_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mutex_prof_num_arena_mutexes
condition|;
name|i
operator|++
control|)
block|{
define|#
directive|define
name|OP
parameter_list|(
name|c
parameter_list|,
name|t
parameter_list|)
define|\
value|gen_mutex_ctl_str(cmd, MUTEX_CTL_STR_MAX_LENGTH,	\ 		    "arenas.0.mutexes",	arena_mutex_names[i], #c);	\ 		CTL_M2_GET(cmd, arena_ind,				\ 		    (t *)&results[i][mutex_counter_##c], t);
name|MUTEX_PROF_COUNTERS
undef|#
directive|undef
name|OP
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mutex_stats_output
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|uint64_t
name|stats
index|[
name|mutex_prof_num_counters
index|]
parameter_list|,
name|bool
name|first_mutex
parameter_list|)
block|{
if|if
condition|(
name|first_mutex
condition|)
block|{
comment|/* Print title. */
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                           n_lock_ops       n_waiting"
literal|"      n_spin_acq  n_owner_switch   total_wait_ns"
literal|"     max_wait_ns  max_n_thds\n"
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|":%*c"
argument_list|,
call|(
name|int
call|)
argument_list|(
literal|20
operator|-
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|char
modifier|*
name|fmt_str
index|[
literal|2
index|]
init|=
block|{
literal|"%12"
name|FMTu32
block|,
literal|"%16"
name|FMTu64
block|}
decl_stmt|;
define|#
directive|define
name|OP
parameter_list|(
name|c
parameter_list|,
name|t
parameter_list|)
define|\
value|malloc_cprintf(write_cb, cbopaque,				\ 	    fmt_str[sizeof(t) / sizeof(uint32_t) - 1],			\ 	    (t)stats[mutex_counter_##c]);
name|MUTEX_PROF_COUNTERS
undef|#
directive|undef
name|OP
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\n"
argument_list|)
decl_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|stats_arena_mutexes_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|bool
name|json_end
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
name|uint64_t
name|mutex_stats
index|[
name|mutex_prof_num_arena_mutexes
index|]
index|[
name|mutex_prof_num_counters
index|]
decl_stmt|;
name|read_arena_mutex_stats
argument_list|(
name|arena_ind
argument_list|,
name|mutex_stats
argument_list|)
expr_stmt|;
comment|/* Output mutex stats. */
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"mutexes\": {\n"
argument_list|)
expr_stmt|;
name|mutex_prof_arena_ind_t
name|i
decl_stmt|,
name|last_mutex
decl_stmt|;
name|last_mutex
operator|=
name|mutex_prof_num_arena_mutexes
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mutex_prof_num_arena_mutexes
condition|;
name|i
operator|++
control|)
block|{
name|mutex_stats_output_json
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|arena_mutex_names
index|[
name|i
index|]
argument_list|,
name|mutex_stats
index|[
name|i
index|]
argument_list|,
literal|"\t\t\t\t\t"
argument_list|,
operator|(
name|i
operator|==
name|last_mutex
operator|)
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t}%s\n"
argument_list|,
name|json_end
condition|?
literal|""
else|:
literal|","
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mutex_prof_arena_ind_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mutex_prof_num_arena_mutexes
condition|;
name|i
operator|++
control|)
block|{
name|mutex_stats_output
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|arena_mutex_names
index|[
name|i
index|]
argument_list|,
name|mutex_stats
index|[
name|i
index|]
argument_list|,
name|i
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|stats_arena_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|unsigned
name|i
parameter_list|,
name|bool
name|bins
parameter_list|,
name|bool
name|large
parameter_list|,
name|bool
name|mutex
parameter_list|)
block|{
name|unsigned
name|nthreads
decl_stmt|;
specifier|const
name|char
modifier|*
name|dss
decl_stmt|;
name|ssize_t
name|dirty_decay_ms
decl_stmt|,
name|muzzy_decay_ms
decl_stmt|;
name|size_t
name|page
decl_stmt|,
name|pactive
decl_stmt|,
name|pdirty
decl_stmt|,
name|pmuzzy
decl_stmt|,
name|mapped
decl_stmt|,
name|retained
decl_stmt|;
name|size_t
name|base
decl_stmt|,
name|internal
decl_stmt|,
name|resident
decl_stmt|;
name|uint64_t
name|dirty_npurge
decl_stmt|,
name|dirty_nmadvise
decl_stmt|,
name|dirty_purged
decl_stmt|;
name|uint64_t
name|muzzy_npurge
decl_stmt|,
name|muzzy_nmadvise
decl_stmt|,
name|muzzy_purged
decl_stmt|;
name|size_t
name|small_allocated
decl_stmt|;
name|uint64_t
name|small_nmalloc
decl_stmt|,
name|small_ndalloc
decl_stmt|,
name|small_nrequests
decl_stmt|;
name|size_t
name|large_allocated
decl_stmt|;
name|uint64_t
name|large_nmalloc
decl_stmt|,
name|large_ndalloc
decl_stmt|,
name|large_nrequests
decl_stmt|;
name|size_t
name|tcache_bytes
decl_stmt|;
name|uint64_t
name|uptime
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.page"
argument_list|,
operator|&
name|page
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.nthreads"
argument_list|,
name|i
argument_list|,
operator|&
name|nthreads
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"nthreads\": %u,\n"
argument_list|,
name|nthreads
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"assigned threads: %u\n"
argument_list|,
name|nthreads
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.uptime"
argument_list|,
name|i
argument_list|,
operator|&
name|uptime
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"uptime_ns\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|uptime
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"uptime: %"
name|FMTu64
literal|"\n"
argument_list|,
name|uptime
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.dss"
argument_list|,
name|i
argument_list|,
operator|&
name|dss
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"dss\": \"%s\",\n"
argument_list|,
name|dss
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"dss allocation precedence: %s\n"
argument_list|,
name|dss
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.dirty_decay_ms"
argument_list|,
name|i
argument_list|,
operator|&
name|dirty_decay_ms
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.muzzy_decay_ms"
argument_list|,
name|i
argument_list|,
operator|&
name|muzzy_decay_ms
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.pactive"
argument_list|,
name|i
argument_list|,
operator|&
name|pactive
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.pdirty"
argument_list|,
name|i
argument_list|,
operator|&
name|pdirty
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.pmuzzy"
argument_list|,
name|i
argument_list|,
operator|&
name|pmuzzy
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.dirty_npurge"
argument_list|,
name|i
argument_list|,
operator|&
name|dirty_npurge
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.dirty_nmadvise"
argument_list|,
name|i
argument_list|,
operator|&
name|dirty_nmadvise
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.dirty_purged"
argument_list|,
name|i
argument_list|,
operator|&
name|dirty_purged
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.muzzy_npurge"
argument_list|,
name|i
argument_list|,
operator|&
name|muzzy_npurge
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.muzzy_nmadvise"
argument_list|,
name|i
argument_list|,
operator|&
name|muzzy_nmadvise
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.muzzy_purged"
argument_list|,
name|i
argument_list|,
operator|&
name|muzzy_purged
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"dirty_decay_ms\": %zd,\n"
argument_list|,
name|dirty_decay_ms
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"muzzy_decay_ms\": %zd,\n"
argument_list|,
name|muzzy_decay_ms
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"pactive\": %zu,\n"
argument_list|,
name|pactive
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"pdirty\": %zu,\n"
argument_list|,
name|pdirty
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"pmuzzy\": %zu,\n"
argument_list|,
name|pmuzzy
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"dirty_npurge\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|dirty_npurge
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"dirty_nmadvise\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|dirty_nmadvise
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"dirty_purged\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|dirty_purged
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"muzzy_npurge\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|muzzy_npurge
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"muzzy_nmadvise\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|muzzy_nmadvise
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"muzzy_purged\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|muzzy_purged
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"decaying:  time       npages       sweeps     madvises"
literal|"       purged\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty_decay_ms
operator|>=
literal|0
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"   dirty: %5zd %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|dirty_decay_ms
argument_list|,
name|pdirty
argument_list|,
name|dirty_npurge
argument_list|,
name|dirty_nmadvise
argument_list|,
name|dirty_purged
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"   dirty:   N/A %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|pdirty
argument_list|,
name|dirty_npurge
argument_list|,
name|dirty_nmadvise
argument_list|,
name|dirty_purged
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|muzzy_decay_ms
operator|>=
literal|0
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"   muzzy: %5zd %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|muzzy_decay_ms
argument_list|,
name|pmuzzy
argument_list|,
name|muzzy_npurge
argument_list|,
name|muzzy_nmadvise
argument_list|,
name|muzzy_purged
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"   muzzy:   N/A %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|pmuzzy
argument_list|,
name|muzzy_npurge
argument_list|,
name|muzzy_nmadvise
argument_list|,
name|muzzy_purged
argument_list|)
expr_stmt|;
block|}
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.small.allocated"
argument_list|,
name|i
argument_list|,
operator|&
name|small_allocated
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.small.nmalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|small_nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.small.ndalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|small_ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.small.nrequests"
argument_list|,
name|i
argument_list|,
operator|&
name|small_nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"small\": {\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"allocated\": %zu,\n"
argument_list|,
name|small_allocated
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nmalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|small_nmalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"ndalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|small_ndalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nrequests\": %"
name|FMTu64
literal|"\n"
argument_list|,
name|small_nrequests
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t},\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"                            allocated      nmalloc"
literal|"      ndalloc    nrequests\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"small:                   %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|small_allocated
argument_list|,
name|small_nmalloc
argument_list|,
name|small_ndalloc
argument_list|,
name|small_nrequests
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.large.allocated"
argument_list|,
name|i
argument_list|,
operator|&
name|large_allocated
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.large.nmalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|large_nmalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.large.ndalloc"
argument_list|,
name|i
argument_list|,
operator|&
name|large_ndalloc
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.large.nrequests"
argument_list|,
name|i
argument_list|,
operator|&
name|large_nrequests
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"large\": {\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"allocated\": %zu,\n"
argument_list|,
name|large_allocated
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nmalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|large_nmalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"ndalloc\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|large_ndalloc
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nrequests\": %"
name|FMTu64
literal|"\n"
argument_list|,
name|large_nrequests
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t},\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"large:                   %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|large_allocated
argument_list|,
name|large_nmalloc
argument_list|,
name|large_ndalloc
argument_list|,
name|large_nrequests
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"total:                   %12zu %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|" %12"
name|FMTu64
literal|"\n"
argument_list|,
name|small_allocated
operator|+
name|large_allocated
argument_list|,
name|small_nmalloc
operator|+
name|large_nmalloc
argument_list|,
name|small_ndalloc
operator|+
name|large_ndalloc
argument_list|,
name|small_nrequests
operator|+
name|large_nrequests
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"active:                  %12zu\n"
argument_list|,
name|pactive
operator|*
name|page
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.mapped"
argument_list|,
name|i
argument_list|,
operator|&
name|mapped
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"mapped\": %zu,\n"
argument_list|,
name|mapped
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"mapped:                  %12zu\n"
argument_list|,
name|mapped
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.retained"
argument_list|,
name|i
argument_list|,
operator|&
name|retained
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"retained\": %zu,\n"
argument_list|,
name|retained
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"retained:                %12zu\n"
argument_list|,
name|retained
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.base"
argument_list|,
name|i
argument_list|,
operator|&
name|base
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"base\": %zu,\n"
argument_list|,
name|base
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"base:                    %12zu\n"
argument_list|,
name|base
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.internal"
argument_list|,
name|i
argument_list|,
operator|&
name|internal
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"internal\": %zu,\n"
argument_list|,
name|internal
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"internal:                %12zu\n"
argument_list|,
name|internal
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.tcache_bytes"
argument_list|,
name|i
argument_list|,
operator|&
name|tcache_bytes
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"tcache\": %zu,\n"
argument_list|,
name|tcache_bytes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"tcache:                  %12zu\n"
argument_list|,
name|tcache_bytes
argument_list|)
expr_stmt|;
block|}
name|CTL_M2_GET
argument_list|(
literal|"stats.arenas.0.resident"
argument_list|,
name|i
argument_list|,
operator|&
name|resident
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"resident\": %zu%s\n"
argument_list|,
name|resident
argument_list|,
operator|(
name|bins
operator|||
name|large
operator|||
name|mutex
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"resident:                %12zu\n"
argument_list|,
name|resident
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mutex
condition|)
block|{
name|stats_arena_mutexes_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
operator|!
operator|(
name|bins
operator|||
name|large
operator|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bins
condition|)
block|{
name|stats_arena_bins_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|large
argument_list|,
name|mutex
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|large
condition|)
block|{
name|stats_arena_lextents_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|stats_general_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|bool
name|more
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cpv
decl_stmt|;
name|bool
name|bv
decl_stmt|;
name|unsigned
name|uv
decl_stmt|;
name|uint32_t
name|u32v
decl_stmt|;
name|uint64_t
name|u64v
decl_stmt|;
name|ssize_t
name|ssv
decl_stmt|;
name|size_t
name|sv
decl_stmt|,
name|bsz
decl_stmt|,
name|usz
decl_stmt|,
name|ssz
decl_stmt|,
name|sssz
decl_stmt|,
name|cpsz
decl_stmt|;
name|bsz
operator|=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
expr_stmt|;
name|usz
operator|=
sizeof|sizeof
argument_list|(
name|unsigned
argument_list|)
expr_stmt|;
name|ssz
operator|=
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
expr_stmt|;
name|sssz
operator|=
sizeof|sizeof
argument_list|(
name|ssize_t
argument_list|)
expr_stmt|;
name|cpsz
operator|=
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"version"
argument_list|,
operator|&
name|cpv
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"version\": \"%s\",\n"
argument_list|,
name|cpv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Version: %s\n"
argument_list|,
name|cpv
argument_list|)
expr_stmt|;
block|}
comment|/* config. */
define|#
directive|define
name|CONFIG_WRITE_BOOL_JSON
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (json) {							\ 		CTL_GET("config."#n,&bv, bool);			\ 		malloc_cprintf(write_cb, cbopaque,			\ 		    "\t\t\t\""#n"\": %s%s\n", bv ? "true" : "false",	\ 		    (c));						\ 	}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"config\": {\n"
argument_list|)
expr_stmt|;
block|}
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|cache_oblivious
argument_list|,
literal|","
argument_list|)
name|CTL_GET
argument_list|(
literal|"config.debug"
argument_list|,
operator|&
name|bv
argument_list|,
name|bool
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"debug\": %s,\n"
argument_list|,
name|bv
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Assertions %s\n"
argument_list|,
name|bv
condition|?
literal|"enabled"
else|:
literal|"disabled"
argument_list|)
expr_stmt|;
block|}
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|fill
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|lazy_lock
argument_list|,
literal|","
argument_list|)
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"malloc_conf\": \"%s\",\n"
argument_list|,
name|config_malloc_conf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"config.malloc_conf: \"%s\"\n"
argument_list|,
name|config_malloc_conf
argument_list|)
expr_stmt|;
block|}
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|prof
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|prof_libgcc
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|prof_libunwind
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|stats
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|thp
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|utrace
argument_list|,
literal|","
argument_list|)
name|CONFIG_WRITE_BOOL_JSON
argument_list|(
argument|xmalloc
argument_list|,
literal|""
argument_list|)
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t},\n"
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|CONFIG_WRITE_BOOL_JSON
comment|/* opt. */
define|#
directive|define
name|OPT_WRITE_BOOL
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (je_mallctl("opt."#n, (void *)&bv,&bsz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %s%s\n", bv ? "true" :	\ 			    "false", (c));				\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": %s\n", bv ? "true" : "false");	\ 		}							\ 	}
define|#
directive|define
name|OPT_WRITE_BOOL_MUTABLE
parameter_list|(
name|n
parameter_list|,
name|m
parameter_list|,
name|c
parameter_list|)
value|{				\ 	bool bv2;							\ 	if (je_mallctl("opt."#n, (void *)&bv,&bsz, NULL, 0) == 0&&	\ 	    je_mallctl(#m, (void *)&bv2,&bsz, NULL, 0) == 0) {		\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %s%s\n", bv ? "true" :	\ 			    "false", (c));				\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": %s ("#m": %s)\n", bv ? "true"	\ 			    : "false", bv2 ? "true" : "false");		\ 		}							\ 	}								\ }
define|#
directive|define
name|OPT_WRITE_UNSIGNED
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (je_mallctl("opt."#n, (void *)&uv,&usz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %u%s\n", uv, (c));		\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			"  opt."#n": %u\n", uv);			\ 		}							\ 	}
define|#
directive|define
name|OPT_WRITE_SSIZE_T
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (je_mallctl("opt."#n, (void *)&ssv,&sssz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %zd%s\n", ssv, (c));	\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": %zd\n", ssv);			\ 		}							\ 	}
define|#
directive|define
name|OPT_WRITE_SSIZE_T_MUTABLE
parameter_list|(
name|n
parameter_list|,
name|m
parameter_list|,
name|c
parameter_list|)
value|{				\ 	ssize_t ssv2;							\ 	if (je_mallctl("opt."#n, (void *)&ssv,&sssz, NULL, 0) == 0&&	\ 	    je_mallctl(#m, (void *)&ssv2,&sssz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": %zd%s\n", ssv, (c));	\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": %zd ("#m": %zd)\n",		\ 			    ssv, ssv2);					\ 		}							\ 	}								\ }
define|#
directive|define
name|OPT_WRITE_CHAR_P
parameter_list|(
name|n
parameter_list|,
name|c
parameter_list|)
define|\
value|if (je_mallctl("opt."#n, (void *)&cpv,&cpsz, NULL, 0) == 0) {	\ 		if (json) {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "\t\t\t\""#n"\": \"%s\"%s\n", cpv, (c));	\ 		} else {						\ 			malloc_cprintf(write_cb, cbopaque,		\ 			    "  opt."#n": \"%s\"\n", cpv);		\ 		}							\ 	}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"opt\": {\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Run-time option settings:\n"
argument_list|)
expr_stmt|;
block|}
name|OPT_WRITE_BOOL
argument_list|(
argument|abort
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|abort_conf
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|retain
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_CHAR_P
argument_list|(
argument|dss
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_UNSIGNED
argument_list|(
argument|narenas
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_CHAR_P
argument_list|(
argument|percpu_arena
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL_MUTABLE
argument_list|(
argument|background_thread
argument_list|,
argument|background_thread
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SSIZE_T_MUTABLE
argument_list|(
argument|dirty_decay_ms
argument_list|,
argument|arenas.dirty_decay_ms
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SSIZE_T_MUTABLE
argument_list|(
argument|muzzy_decay_ms
argument_list|,
argument|arenas.muzzy_decay_ms
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_CHAR_P
argument_list|(
argument|junk
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|zero
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|utrace
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|xmalloc
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|tcache
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SSIZE_T
argument_list|(
argument|lg_tcache_max
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_CHAR_P
argument_list|(
argument|prof_prefix
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL_MUTABLE
argument_list|(
argument|prof_active
argument_list|,
argument|prof.active
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL_MUTABLE
argument_list|(
argument|prof_thread_active_init
argument_list|,
argument|prof.thread_active_init
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SSIZE_T_MUTABLE
argument_list|(
argument|lg_prof_sample
argument_list|,
argument|prof.lg_sample
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof_accum
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_SSIZE_T
argument_list|(
argument|lg_prof_interval
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof_gdump
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof_final
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|prof_leak
argument_list|,
literal|","
argument_list|)
name|OPT_WRITE_BOOL
argument_list|(
argument|stats_print
argument_list|,
literal|","
argument_list|)
if|if
condition|(
name|json
operator|||
name|opt_stats_print
condition|)
block|{
comment|/* 		 * stats_print_opts is always emitted for JSON, so as long as it 		 * comes last it's safe to unconditionally omit the comma here 		 * (rather than having to conditionally omit it elsewhere 		 * depending on configuration). 		 */
name|OPT_WRITE_CHAR_P
argument_list|(
argument|stats_print_opts
argument_list|,
literal|""
argument_list|)
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t},\n"
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|OPT_WRITE_BOOL
undef|#
directive|undef
name|OPT_WRITE_BOOL_MUTABLE
undef|#
directive|undef
name|OPT_WRITE_SSIZE_T
undef|#
directive|undef
name|OPT_WRITE_CHAR_P
comment|/* arenas. */
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"arenas\": {\n"
argument_list|)
expr_stmt|;
block|}
name|CTL_GET
argument_list|(
literal|"arenas.narenas"
argument_list|,
operator|&
name|uv
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"narenas\": %u,\n"
argument_list|,
name|uv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Arenas: %u\n"
argument_list|,
name|uv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|json
condition|)
block|{
name|CTL_GET
argument_list|(
literal|"arenas.dirty_decay_ms"
argument_list|,
operator|&
name|ssv
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"dirty_decay_ms\": %zd,\n"
argument_list|,
name|ssv
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.muzzy_decay_ms"
argument_list|,
operator|&
name|ssv
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"muzzy_decay_ms\": %zd,\n"
argument_list|,
name|ssv
argument_list|)
expr_stmt|;
block|}
name|CTL_GET
argument_list|(
literal|"arenas.quantum"
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"quantum\": %zu,\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Quantum size: %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
name|CTL_GET
argument_list|(
literal|"arenas.page"
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"page\": %zu,\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Page size: %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|je_mallctl
argument_list|(
literal|"arenas.tcache_max"
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|sv
argument_list|,
operator|&
name|ssz
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"tcache_max\": %zu,\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Maximum thread-cached size class: %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|unsigned
name|nbins
decl_stmt|,
name|nlextents
decl_stmt|,
name|i
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nbins"
argument_list|,
operator|&
name|nbins
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"nbins\": %u,\n"
argument_list|,
name|nbins
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nhbins"
argument_list|,
operator|&
name|uv
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"nhbins\": %u,\n"
argument_list|,
name|uv
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"bin\": [\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbins
condition|;
name|i
operator|++
control|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t{\n"
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.size"
argument_list|,
name|i
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"size\": %zu,\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.nregs"
argument_list|,
name|i
argument_list|,
operator|&
name|u32v
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"nregs\": %"
name|FMTu32
literal|",\n"
argument_list|,
name|u32v
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.bin.0.slab_size"
argument_list|,
name|i
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"slab_size\": %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t}%s\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|<
name|nbins
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t],\n"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"arenas.nlextents"
argument_list|,
operator|&
name|nlextents
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"nlextents\": %u,\n"
argument_list|,
name|nlextents
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"lextent\": [\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nlextents
condition|;
name|i
operator|++
control|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t{\n"
argument_list|)
expr_stmt|;
name|CTL_M2_GET
argument_list|(
literal|"arenas.lextent.0.size"
argument_list|,
name|i
argument_list|,
operator|&
name|sv
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\t\"size\": %zu\n"
argument_list|,
name|sv
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t}%s\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|<
name|nlextents
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t]\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t}%s\n"
argument_list|,
operator|(
name|config_prof
operator|||
name|more
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
comment|/* prof. */
if|if
condition|(
name|config_prof
operator|&&
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"prof\": {\n"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.thread_active_init"
argument_list|,
operator|&
name|bv
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"thread_active_init\": %s,\n"
argument_list|,
name|bv
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.active"
argument_list|,
operator|&
name|bv
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"active\": %s,\n"
argument_list|,
name|bv
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.gdump"
argument_list|,
operator|&
name|bv
argument_list|,
name|bool
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"gdump\": %s,\n"
argument_list|,
name|bv
condition|?
literal|"true"
else|:
literal|"false"
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.interval"
argument_list|,
operator|&
name|u64v
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"interval\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|u64v
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"prof.lg_sample"
argument_list|,
operator|&
name|ssv
argument_list|,
name|ssize_t
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"lg_sample\": %zd\n"
argument_list|,
name|ssv
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t}%s\n"
argument_list|,
name|more
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|read_global_mutex_stats
parameter_list|(
name|uint64_t
name|results
index|[
name|mutex_prof_num_global_mutexes
index|]
index|[
name|mutex_prof_num_counters
index|]
parameter_list|)
block|{
name|char
name|cmd
index|[
name|MUTEX_CTL_STR_MAX_LENGTH
index|]
decl_stmt|;
name|mutex_prof_global_ind_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mutex_prof_num_global_mutexes
condition|;
name|i
operator|++
control|)
block|{
define|#
directive|define
name|OP
parameter_list|(
name|c
parameter_list|,
name|t
parameter_list|)
define|\
value|gen_mutex_ctl_str(cmd, MUTEX_CTL_STR_MAX_LENGTH,	\ 		    "mutexes", global_mutex_names[i], #c);		\ 		CTL_GET(cmd, (t *)&results[i][mutex_counter_##c], t);
name|MUTEX_PROF_COUNTERS
undef|#
directive|undef
name|OP
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|stats_print_helper
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
name|bool
name|json
parameter_list|,
name|bool
name|merged
parameter_list|,
name|bool
name|destroyed
parameter_list|,
name|bool
name|unmerged
parameter_list|,
name|bool
name|bins
parameter_list|,
name|bool
name|large
parameter_list|,
name|bool
name|mutex
parameter_list|)
block|{
name|size_t
name|allocated
decl_stmt|,
name|active
decl_stmt|,
name|metadata
decl_stmt|,
name|resident
decl_stmt|,
name|mapped
decl_stmt|,
name|retained
decl_stmt|;
name|size_t
name|num_background_threads
decl_stmt|;
name|uint64_t
name|background_thread_num_runs
decl_stmt|,
name|background_thread_run_interval
decl_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.allocated"
argument_list|,
operator|&
name|allocated
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.active"
argument_list|,
operator|&
name|active
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.metadata"
argument_list|,
operator|&
name|metadata
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.resident"
argument_list|,
operator|&
name|resident
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.mapped"
argument_list|,
operator|&
name|mapped
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.retained"
argument_list|,
operator|&
name|retained
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|uint64_t
name|mutex_stats
index|[
name|mutex_prof_num_global_mutexes
index|]
index|[
name|mutex_prof_num_counters
index|]
decl_stmt|;
if|if
condition|(
name|mutex
condition|)
block|{
name|read_global_mutex_stats
argument_list|(
name|mutex_stats
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|have_background_thread
condition|)
block|{
name|CTL_GET
argument_list|(
literal|"stats.background_thread.num_threads"
argument_list|,
operator|&
name|num_background_threads
argument_list|,
name|size_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.background_thread.num_runs"
argument_list|,
operator|&
name|background_thread_num_runs
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|CTL_GET
argument_list|(
literal|"stats.background_thread.run_interval"
argument_list|,
operator|&
name|background_thread_run_interval
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|num_background_threads
operator|=
literal|0
expr_stmt|;
name|background_thread_num_runs
operator|=
literal|0
expr_stmt|;
name|background_thread_run_interval
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"stats\": {\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"allocated\": %zu,\n"
argument_list|,
name|allocated
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"active\": %zu,\n"
argument_list|,
name|active
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"metadata\": %zu,\n"
argument_list|,
name|metadata
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"resident\": %zu,\n"
argument_list|,
name|resident
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"mapped\": %zu,\n"
argument_list|,
name|mapped
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"retained\": %zu,\n"
argument_list|,
name|retained
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"background_thread\": {\n"
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"num_threads\": %zu,\n"
argument_list|,
name|num_background_threads
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"num_runs\": %"
name|FMTu64
literal|",\n"
argument_list|,
name|background_thread_num_runs
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\t\"run_interval\": %"
name|FMTu64
literal|"\n"
argument_list|,
name|background_thread_run_interval
argument_list|)
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t}%s\n"
argument_list|,
name|mutex
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|mutex
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"mutexes\": {\n"
argument_list|)
expr_stmt|;
name|mutex_prof_global_ind_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mutex_prof_num_global_mutexes
condition|;
name|i
operator|++
control|)
block|{
name|mutex_stats_output_json
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|global_mutex_names
index|[
name|i
index|]
argument_list|,
name|mutex_stats
index|[
name|i
index|]
argument_list|,
literal|"\t\t\t\t"
argument_list|,
name|i
operator|==
name|mutex_prof_num_global_mutexes
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t}\n"
argument_list|)
expr_stmt|;
block|}
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t}%s\n"
argument_list|,
operator|(
name|merged
operator|||
name|unmerged
operator|||
name|destroyed
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Allocated: %zu, active: %zu, metadata: %zu,"
literal|" resident: %zu, mapped: %zu, retained: %zu\n"
argument_list|,
name|allocated
argument_list|,
name|active
argument_list|,
name|metadata
argument_list|,
name|resident
argument_list|,
name|mapped
argument_list|,
name|retained
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_background_thread
operator|&&
name|num_background_threads
operator|>
literal|0
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"Background threads: %zu, num_runs: %"
name|FMTu64
literal|", "
literal|"run_interval: %"
name|FMTu64
literal|" ns\n"
argument_list|,
name|num_background_threads
argument_list|,
name|background_thread_num_runs
argument_list|,
name|background_thread_run_interval
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mutex
condition|)
block|{
name|mutex_prof_global_ind_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mutex_prof_num_global_mutexes
condition|;
name|i
operator|++
control|)
block|{
name|mutex_stats_output
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|global_mutex_names
index|[
name|i
index|]
argument_list|,
name|mutex_stats
index|[
name|i
index|]
argument_list|,
name|i
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|merged
operator|||
name|destroyed
operator|||
name|unmerged
condition|)
block|{
name|unsigned
name|narenas
decl_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\"stats.arenas\": {\n"
argument_list|)
expr_stmt|;
block|}
name|CTL_GET
argument_list|(
literal|"arenas.narenas"
argument_list|,
operator|&
name|narenas
argument_list|,
name|unsigned
argument_list|)
expr_stmt|;
block|{
name|size_t
name|mib
index|[
literal|3
index|]
decl_stmt|;
name|size_t
name|miblen
init|=
sizeof|sizeof
argument_list|(
name|mib
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|VARIABLE_ARRAY
argument_list|(
name|bool
argument_list|,
name|initialized
argument_list|,
name|narenas
argument_list|)
expr_stmt|;
name|bool
name|destroyed_initialized
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|j
decl_stmt|,
name|ninitialized
decl_stmt|;
name|xmallctlnametomib
argument_list|(
literal|"arena.0.initialized"
argument_list|,
name|mib
argument_list|,
operator|&
name|miblen
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ninitialized
operator|=
literal|0
init|;
name|i
operator|<
name|narenas
condition|;
name|i
operator|++
control|)
block|{
name|mib
index|[
literal|1
index|]
operator|=
name|i
expr_stmt|;
name|sz
operator|=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
expr_stmt|;
name|xmallctlbymib
argument_list|(
name|mib
argument_list|,
name|miblen
argument_list|,
operator|&
name|initialized
index|[
name|i
index|]
argument_list|,
operator|&
name|sz
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|initialized
index|[
name|i
index|]
condition|)
block|{
name|ninitialized
operator|++
expr_stmt|;
block|}
block|}
name|mib
index|[
literal|1
index|]
operator|=
name|MALLCTL_ARENAS_DESTROYED
expr_stmt|;
name|sz
operator|=
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
expr_stmt|;
name|xmallctlbymib
argument_list|(
name|mib
argument_list|,
name|miblen
argument_list|,
operator|&
name|destroyed_initialized
argument_list|,
operator|&
name|sz
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Merged stats. */
if|if
condition|(
name|merged
operator|&&
operator|(
name|ninitialized
operator|>
literal|1
operator|||
operator|!
name|unmerged
operator|)
condition|)
block|{
comment|/* Print merged arena stats. */
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"merged\": {\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\nMerged arenas stats:\n"
argument_list|)
expr_stmt|;
block|}
name|stats_arena_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|MALLCTL_ARENAS_ALL
argument_list|,
name|bins
argument_list|,
name|large
argument_list|,
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t}%s\n"
argument_list|,
operator|(
operator|(
name|destroyed_initialized
operator|&&
name|destroyed
operator|)
operator|||
name|unmerged
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Destroyed stats. */
if|if
condition|(
name|destroyed_initialized
operator|&&
name|destroyed
condition|)
block|{
comment|/* Print destroyed arena stats. */
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"destroyed\": {\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\nDestroyed arenas stats:\n"
argument_list|)
expr_stmt|;
block|}
name|stats_arena_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|MALLCTL_ARENAS_DESTROYED
argument_list|,
name|bins
argument_list|,
name|large
argument_list|,
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t}%s\n"
argument_list|,
name|unmerged
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Unmerged stats. */
if|if
condition|(
name|unmerged
condition|)
block|{
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|narenas
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|initialized
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|json
condition|)
block|{
name|j
operator|++
expr_stmt|;
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t\"%u\": {\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\narenas[%u]:\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|stats_arena_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|i
argument_list|,
name|bins
argument_list|,
name|large
argument_list|,
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t\t}%s\n"
argument_list|,
operator|(
name|j
operator|<
name|ninitialized
operator|)
condition|?
literal|","
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t\t}\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|stats_print
parameter_list|(
name|void
function_decl|(
modifier|*
name|write_cb
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cbopaque
parameter_list|,
specifier|const
name|char
modifier|*
name|opts
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|uint64_t
name|epoch
decl_stmt|;
name|size_t
name|u64sz
decl_stmt|;
define|#
directive|define
name|OPTION
parameter_list|(
name|o
parameter_list|,
name|v
parameter_list|,
name|d
parameter_list|,
name|s
parameter_list|)
value|bool v = d;
name|STATS_PRINT_OPTIONS
undef|#
directive|undef
name|OPTION
comment|/* 	 * Refresh stats, in case mallctl() was called by the application. 	 * 	 * Check for OOM here, since refreshing the ctl cache can trigger 	 * allocation.  In practice, none of the subsequent mallctl()-related 	 * calls in this function will cause OOM if this one succeeds. 	 * */
name|epoch
init|=
literal|1
decl_stmt|;
name|u64sz
operator|=
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|je_mallctl
argument_list|(
literal|"epoch"
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|epoch
argument_list|,
operator|&
name|u64sz
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|epoch
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|err
operator|==
name|EAGAIN
condition|)
block|{
name|malloc_write
argument_list|(
literal|"<jemalloc>: Memory allocation failure in "
literal|"mallctl(\"epoch\", ...)\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|malloc_write
argument_list|(
literal|"<jemalloc>: Failure in mallctl(\"epoch\", "
literal|"...)\n"
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|opts
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|;
name|opts
index|[
name|i
index|]
operator|!=
literal|'\0'
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|opts
index|[
name|i
index|]
condition|)
block|{
define|#
directive|define
name|OPTION
parameter_list|(
name|o
parameter_list|,
name|v
parameter_list|,
name|d
parameter_list|,
name|s
parameter_list|)
value|case o: v = s; break;
name|STATS_PRINT_OPTIONS
undef|#
directive|undef
name|OPTION
default|default:
empty_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"{\n"
literal|"\t\"jemalloc\": {\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"___ Begin jemalloc statistics ___\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|general
condition|)
block|{
name|stats_general_print
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|config_stats
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config_stats
condition|)
block|{
name|stats_print_helper
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
name|json
argument_list|,
name|merged
argument_list|,
name|destroyed
argument_list|,
name|unmerged
argument_list|,
name|bins
argument_list|,
name|large
argument_list|,
name|mutex
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|json
condition|)
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"\t}\n"
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_cprintf
argument_list|(
name|write_cb
argument_list|,
name|cbopaque
argument_list|,
literal|"--- End jemalloc statistics ---\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


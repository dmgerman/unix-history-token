begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_LARGE_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_preamble.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal_includes.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/assert.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/extent_mmap.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/mutex.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/rtree.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/util.h"
end_include

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
name|void
modifier|*
name|large_malloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
name|assert
argument_list|(
name|usize
operator|==
name|sz_s2u
argument_list|(
name|usize
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|large_palloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|CACHELINE
argument_list|,
name|zero
argument_list|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|large_palloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
name|size_t
name|ausize
decl_stmt|;
name|extent_t
modifier|*
name|extent
decl_stmt|;
name|bool
name|is_zeroed
decl_stmt|;
name|UNUSED
name|bool
name|idump
name|JEMALLOC_CC_SILENCE_INIT
argument_list|(
name|false
argument_list|)
decl_stmt|;
name|assert
argument_list|(
operator|!
name|tsdn_null
argument_list|(
name|tsdn
argument_list|)
operator|||
name|arena
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ausize
operator|=
name|sz_sa2u
argument_list|(
name|usize
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ausize
operator|==
literal|0
operator|||
name|ausize
operator|>
name|LARGE_MAXCLASS
argument_list|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_zero
argument_list|)
condition|)
block|{
name|zero
operator|=
name|true
expr_stmt|;
block|}
comment|/* 	 * Copy zero into is_zeroed and pass the copy when allocating the 	 * extent, so that it is possible to make correct junk/zero fill 	 * decisions below, even if is_zeroed ends up true when zero is false. 	 */
name|is_zeroed
operator|=
name|zero
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
operator|!
name|tsdn_null
argument_list|(
name|tsdn
argument_list|)
argument_list|)
condition|)
block|{
name|arena
operator|=
name|arena_choose
argument_list|(
name|tsdn_tsd
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|unlikely
argument_list|(
name|arena
operator|==
name|NULL
argument_list|)
operator|||
operator|(
name|extent
operator|=
name|arena_extent_alloc_large
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|alignment
argument_list|,
operator|&
name|is_zeroed
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* See comments in arena_bin_slabs_full_insert(). */
if|if
condition|(
operator|!
name|arena_is_auto
argument_list|(
name|arena
argument_list|)
condition|)
block|{
comment|/* Insert extent into large. */
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|large_mtx
argument_list|)
expr_stmt|;
name|extent_list_append
argument_list|(
operator|&
name|arena
operator|->
name|large
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|large_mtx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config_prof
operator|&&
name|arena_prof_accum
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|)
condition|)
block|{
name|prof_idump
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zero
condition|)
block|{
name|assert
argument_list|(
name|is_zeroed
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_junk_alloc
argument_list|)
condition|)
block|{
name|memset
argument_list|(
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|JEMALLOC_ALLOC_JUNK
argument_list|,
name|extent_usize_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
return|return
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|large_dalloc_junk_impl
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|memset
argument_list|(
name|ptr
argument_list|,
name|JEMALLOC_FREE_JUNK
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|large_dalloc_junk_t
modifier|*
name|JET_MUTABLE
name|large_dalloc_junk
init|=
name|large_dalloc_junk_impl
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|large_dalloc_maybe_junk_impl
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
if|if
condition|(
name|config_fill
operator|&&
name|have_dss
operator|&&
name|unlikely
argument_list|(
name|opt_junk_free
argument_list|)
condition|)
block|{
comment|/* 		 * Only bother junk filling if the extent isn't about to be 		 * unmapped. 		 */
if|if
condition|(
name|opt_retain
operator|||
operator|(
name|have_dss
operator|&&
name|extent_in_dss
argument_list|(
name|ptr
argument_list|)
operator|)
condition|)
block|{
name|large_dalloc_junk
argument_list|(
name|ptr
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_decl_stmt
name|large_dalloc_maybe_junk_t
modifier|*
name|JET_MUTABLE
name|large_dalloc_maybe_junk
init|=
name|large_dalloc_maybe_junk_impl
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|bool
name|large_ralloc_no_move_shrink
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|usize
parameter_list|)
block|{
name|arena_t
modifier|*
name|arena
init|=
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|size_t
name|oldusize
init|=
name|extent_usize_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|extent_hooks_t
modifier|*
name|extent_hooks
init|=
name|extent_hooks_get
argument_list|(
name|arena
argument_list|)
decl_stmt|;
name|size_t
name|diff
init|=
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|-
operator|(
name|usize
operator|+
name|sz_large_pad
operator|)
decl_stmt|;
name|assert
argument_list|(
name|oldusize
operator|>
name|usize
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_hooks
operator|->
name|split
operator|==
name|NULL
condition|)
block|{
return|return
name|true
return|;
block|}
comment|/* Split excess pages. */
if|if
condition|(
name|diff
operator|!=
literal|0
condition|)
block|{
name|extent_t
modifier|*
name|trail
init|=
name|extent_split_wrapper
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
name|extent
argument_list|,
name|usize
operator|+
name|sz_large_pad
argument_list|,
name|sz_size2index
argument_list|(
name|usize
argument_list|)
argument_list|,
name|false
argument_list|,
name|diff
argument_list|,
name|NSIZES
argument_list|,
name|false
argument_list|)
decl_stmt|;
if|if
condition|(
name|trail
operator|==
name|NULL
condition|)
block|{
return|return
name|true
return|;
block|}
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_junk_free
argument_list|)
condition|)
block|{
name|large_dalloc_maybe_junk
argument_list|(
name|extent_addr_get
argument_list|(
name|trail
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|trail
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|arena_extents_dirty_dalloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
name|trail
argument_list|)
expr_stmt|;
block|}
name|arena_extent_ralloc_large_shrink
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|,
name|oldusize
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|large_ralloc_no_move_expand
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
name|arena_t
modifier|*
name|arena
init|=
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|size_t
name|oldusize
init|=
name|extent_usize_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|extent_hooks_t
modifier|*
name|extent_hooks
init|=
name|extent_hooks_get
argument_list|(
name|arena
argument_list|)
decl_stmt|;
name|size_t
name|trailsize
init|=
name|usize
operator|-
name|oldusize
decl_stmt|;
if|if
condition|(
name|extent_hooks
operator|->
name|merge
operator|==
name|NULL
condition|)
block|{
return|return
name|true
return|;
block|}
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_zero
argument_list|)
condition|)
block|{
name|zero
operator|=
name|true
expr_stmt|;
block|}
comment|/* 	 * Copy zero into is_zeroed_trail and pass the copy when allocating the 	 * extent, so that it is possible to make correct junk/zero fill 	 * decisions below, even if is_zeroed_trail ends up true when zero is 	 * false. 	 */
name|bool
name|is_zeroed_trail
init|=
name|zero
decl_stmt|;
name|bool
name|commit
init|=
name|true
decl_stmt|;
name|extent_t
modifier|*
name|trail
decl_stmt|;
name|bool
name|new_mapping
decl_stmt|;
if|if
condition|(
operator|(
name|trail
operator|=
name|extents_alloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_dirty
argument_list|,
name|extent_past_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|trailsize
argument_list|,
literal|0
argument_list|,
name|CACHELINE
argument_list|,
name|false
argument_list|,
name|NSIZES
argument_list|,
operator|&
name|is_zeroed_trail
argument_list|,
operator|&
name|commit
argument_list|)
operator|)
operator|!=
name|NULL
operator|||
operator|(
name|trail
operator|=
name|extents_alloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_muzzy
argument_list|,
name|extent_past_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|trailsize
argument_list|,
literal|0
argument_list|,
name|CACHELINE
argument_list|,
name|false
argument_list|,
name|NSIZES
argument_list|,
operator|&
name|is_zeroed_trail
argument_list|,
operator|&
name|commit
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|config_stats
condition|)
block|{
name|new_mapping
operator|=
name|false
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|trail
operator|=
name|extent_alloc_wrapper
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
name|extent_past_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|trailsize
argument_list|,
literal|0
argument_list|,
name|CACHELINE
argument_list|,
name|false
argument_list|,
name|NSIZES
argument_list|,
operator|&
name|is_zeroed_trail
argument_list|,
operator|&
name|commit
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
return|return
name|true
return|;
block|}
if|if
condition|(
name|config_stats
condition|)
block|{
name|new_mapping
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|extent_merge_wrapper
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
name|extent
argument_list|,
name|trail
argument_list|)
condition|)
block|{
name|extent_dalloc_wrapper
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
name|trail
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|szind_t
name|szind
init|=
name|sz_size2index
argument_list|(
name|usize
argument_list|)
decl_stmt|;
name|extent_szind_set
argument_list|(
name|extent
argument_list|,
name|szind
argument_list|)
expr_stmt|;
name|rtree_szind_slab_update
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|szind
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_stats
operator|&&
name|new_mapping
condition|)
block|{
name|arena_stats_mapped_add
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|stats
argument_list|,
name|trailsize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zero
condition|)
block|{
if|if
condition|(
name|config_cache_oblivious
condition|)
block|{
comment|/* 			 * Zero the trailing bytes of the original allocation's 			 * last page, since they are in an indeterminate state. 			 * There will always be trailing bytes, because ptr's 			 * offset from the beginning of the extent is a multiple 			 * of CACHELINE in [0 .. PAGE). 			 */
name|void
modifier|*
name|zbase
init|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
operator|+
name|oldusize
operator|)
decl_stmt|;
name|void
modifier|*
name|zpast
init|=
name|PAGE_ADDR2BASE
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|zbase
operator|+
name|PAGE
operator|)
argument_list|)
decl_stmt|;
name|size_t
name|nzero
init|=
operator|(
name|uintptr_t
operator|)
name|zpast
operator|-
operator|(
name|uintptr_t
operator|)
name|zbase
decl_stmt|;
name|assert
argument_list|(
name|nzero
operator|>
literal|0
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|zbase
argument_list|,
literal|0
argument_list|,
name|nzero
argument_list|)
expr_stmt|;
block|}
name|assert
argument_list|(
name|is_zeroed_trail
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config_fill
operator|&&
name|unlikely
argument_list|(
name|opt_junk_alloc
argument_list|)
condition|)
block|{
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
operator|+
name|oldusize
operator|)
argument_list|,
name|JEMALLOC_ALLOC_JUNK
argument_list|,
name|usize
operator|-
name|oldusize
argument_list|)
expr_stmt|;
block|}
name|arena_extent_ralloc_large_expand
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|,
name|oldusize
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
name|bool
name|large_ralloc_no_move
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|usize_min
parameter_list|,
name|size_t
name|usize_max
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
name|size_t
name|oldusize
init|=
name|extent_usize_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
comment|/* The following should have been caught by callers. */
name|assert
argument_list|(
name|usize_min
operator|>
literal|0
operator|&&
name|usize_max
operator|<=
name|LARGE_MAXCLASS
argument_list|)
expr_stmt|;
comment|/* Both allocation sizes must be large to avoid a move. */
name|assert
argument_list|(
name|oldusize
operator|>=
name|LARGE_MINCLASS
operator|&&
name|usize_max
operator|>=
name|LARGE_MINCLASS
argument_list|)
expr_stmt|;
if|if
condition|(
name|usize_max
operator|>
name|oldusize
condition|)
block|{
comment|/* Attempt to expand the allocation in-place. */
if|if
condition|(
operator|!
name|large_ralloc_no_move_expand
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|usize_max
argument_list|,
name|zero
argument_list|)
condition|)
block|{
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* Try again, this time with usize_min. */
if|if
condition|(
name|usize_min
operator|<
name|usize_max
operator|&&
name|usize_min
operator|>
name|oldusize
operator|&&
name|large_ralloc_no_move_expand
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|usize_min
argument_list|,
name|zero
argument_list|)
condition|)
block|{
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
comment|/* 	 * Avoid moving the allocation if the existing extent size accommodates 	 * the new size. 	 */
if|if
condition|(
name|oldusize
operator|>=
name|usize_min
operator|&&
name|oldusize
operator|<=
name|usize_max
condition|)
block|{
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* Attempt to shrink the allocation in-place. */
if|if
condition|(
name|oldusize
operator|>
name|usize_max
condition|)
block|{
if|if
condition|(
operator|!
name|large_ralloc_no_move_shrink
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|usize_max
argument_list|)
condition|)
block|{
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|large_ralloc_move_helper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|zero
parameter_list|)
block|{
if|if
condition|(
name|alignment
operator|<=
name|CACHELINE
condition|)
block|{
return|return
name|large_malloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|zero
argument_list|)
return|;
block|}
return|return
name|large_palloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|large_ralloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|zero
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|)
block|{
name|size_t
name|oldusize
init|=
name|extent_usize_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
comment|/* The following should have been caught by callers. */
name|assert
argument_list|(
name|usize
operator|>
literal|0
operator|&&
name|usize
operator|<=
name|LARGE_MAXCLASS
argument_list|)
expr_stmt|;
comment|/* Both allocation sizes must be large to avoid a move. */
name|assert
argument_list|(
name|oldusize
operator|>=
name|LARGE_MINCLASS
operator|&&
name|usize
operator|>=
name|LARGE_MINCLASS
argument_list|)
expr_stmt|;
comment|/* Try to avoid moving the allocation. */
if|if
condition|(
operator|!
name|large_ralloc_no_move
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|usize
argument_list|,
name|usize
argument_list|,
name|zero
argument_list|)
condition|)
block|{
return|return
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
return|;
block|}
comment|/* 	 * usize and old size are different enough that we need to use a 	 * different size class.  In that case, fall back to allocating new 	 * space and copying. 	 */
name|void
modifier|*
name|ret
init|=
name|large_ralloc_move_helper
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|usize
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|size_t
name|copysize
init|=
operator|(
name|usize
operator|<
name|oldusize
operator|)
condition|?
name|usize
else|:
name|oldusize
decl_stmt|;
name|memcpy
argument_list|(
name|ret
argument_list|,
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|copysize
argument_list|)
expr_stmt|;
name|isdalloct
argument_list|(
name|tsdn
argument_list|,
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|oldusize
argument_list|,
name|tcache
argument_list|,
name|NULL
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * junked_locked indicates whether the extent's data have been junk-filled, and  * whether the arena's large_mtx is currently held.  */
end_comment

begin_function
specifier|static
name|void
name|large_dalloc_prep_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|junked_locked
parameter_list|)
block|{
if|if
condition|(
operator|!
name|junked_locked
condition|)
block|{
comment|/* See comments in arena_bin_slabs_full_insert(). */
if|if
condition|(
operator|!
name|arena_is_auto
argument_list|(
name|arena
argument_list|)
condition|)
block|{
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|large_mtx
argument_list|)
expr_stmt|;
name|extent_list_remove
argument_list|(
operator|&
name|arena
operator|->
name|large
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|large_mtx
argument_list|)
expr_stmt|;
block|}
name|large_dalloc_maybe_junk
argument_list|(
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_usize_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|malloc_mutex_assert_owner
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|large_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arena_is_auto
argument_list|(
name|arena
argument_list|)
condition|)
block|{
name|extent_list_remove
argument_list|(
operator|&
name|arena
operator|->
name|large
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
block|}
name|arena_extent_dalloc_large_prep
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|large_dalloc_finish_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|extent_hooks_t
modifier|*
name|extent_hooks
init|=
name|EXTENT_HOOKS_INITIALIZER
decl_stmt|;
name|arena_extents_dirty_dalloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|large_dalloc_prep_junked_locked
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|large_dalloc_prep_impl
argument_list|(
name|tsdn
argument_list|,
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|large_dalloc_finish
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|large_dalloc_finish_impl
argument_list|(
name|tsdn
argument_list|,
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|large_dalloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|arena_t
modifier|*
name|arena
init|=
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|large_dalloc_prep_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|large_dalloc_finish_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|arena_decay_tick
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|size_t
name|large_salloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
return|return
name|extent_usize_get
argument_list|(
name|extent
argument_list|)
return|;
block|}
end_function

begin_function
name|prof_tctx_t
modifier|*
name|large_prof_tctx_get
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
return|return
name|extent_prof_tctx_get
argument_list|(
name|extent
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|large_prof_tctx_set
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|prof_tctx_t
modifier|*
name|tctx
parameter_list|)
block|{
name|extent_prof_tctx_set
argument_list|(
name|extent
argument_list|,
name|tctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|large_prof_tctx_reset
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|large_prof_tctx_set
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
operator|(
name|prof_tctx_t
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|1U
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


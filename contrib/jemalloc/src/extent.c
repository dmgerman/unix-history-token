begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_EXTENT_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_preamble.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal_includes.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/assert.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/extent_dss.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/extent_mmap.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/ph.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/rtree.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/mutex.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/mutex_pool.h"
end_include

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_decl_stmt
name|rtree_t
name|extents_rtree
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Keyed by the address of the extent_t being protected. */
end_comment

begin_decl_stmt
name|mutex_pool_t
name|extent_mutex_pool
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|bitmap_info_t
name|extents_bitmap_info
init|=
name|BITMAP_INFO_INITIALIZER
argument_list|(
name|NPSIZES
operator|+
literal|1
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
modifier|*
name|extent_alloc_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|extent_dalloc_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|bool
name|committed
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|extent_destroy_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|bool
name|committed
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|extent_commit_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|extent_commit_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|bool
name|extent_decommit_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|PAGES_CAN_PURGE_LAZY
end_ifdef

begin_function_decl
specifier|static
name|bool
name|extent_purge_lazy_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|bool
name|extent_purge_lazy_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|PAGES_CAN_PURGE_FORCED
end_ifdef

begin_function_decl
specifier|static
name|bool
name|extent_purge_forced_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|bool
name|extent_purge_forced_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|JEMALLOC_MAPS_COALESCE
end_ifdef

begin_function_decl
specifier|static
name|bool
name|extent_split_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|size_a
parameter_list|,
name|size_t
name|size_b
parameter_list|,
name|bool
name|committed
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|extent_t
modifier|*
name|extent_split_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|size_a
parameter_list|,
name|szind_t
name|szind_a
parameter_list|,
name|bool
name|slab_a
parameter_list|,
name|size_t
name|size_b
parameter_list|,
name|szind_t
name|szind_b
parameter_list|,
name|bool
name|slab_b
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|JEMALLOC_MAPS_COALESCE
end_ifdef

begin_function_decl
specifier|static
name|bool
name|extent_merge_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr_a
parameter_list|,
name|size_t
name|size_a
parameter_list|,
name|void
modifier|*
name|addr_b
parameter_list|,
name|size_t
name|size_b
parameter_list|,
name|bool
name|committed
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|bool
name|extent_merge_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|a
parameter_list|,
name|extent_t
modifier|*
name|b
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|const
name|extent_hooks_t
name|extent_hooks_default
init|=
block|{
name|extent_alloc_default
block|,
name|extent_dalloc_default
block|,
name|extent_destroy_default
block|,
name|extent_commit_default
block|,
name|extent_decommit_default
ifdef|#
directive|ifdef
name|PAGES_CAN_PURGE_LAZY
block|,
name|extent_purge_lazy_default
else|#
directive|else
block|,
name|NULL
endif|#
directive|endif
ifdef|#
directive|ifdef
name|PAGES_CAN_PURGE_FORCED
block|,
name|extent_purge_forced_default
else|#
directive|else
block|,
name|NULL
endif|#
directive|endif
ifdef|#
directive|ifdef
name|JEMALLOC_MAPS_COALESCE
block|,
name|extent_split_default
block|,
name|extent_merge_default
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Used exclusively for gdump triggering. */
end_comment

begin_decl_stmt
specifier|static
name|atomic_zu_t
name|curpages
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|atomic_zu_t
name|highpages
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*  * Function prototypes for static functions that are referenced prior to  * definition.  */
end_comment

begin_function_decl
specifier|static
name|void
name|extent_deregister
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|extent_t
modifier|*
name|extent_recycle
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|usize
parameter_list|,
name|size_t
name|pad
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|slab
parameter_list|,
name|szind_t
name|szind
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|extent_t
modifier|*
name|extent_try_coalesce
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|rtree_ctx_t
modifier|*
name|rtree_ctx
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
modifier|*
name|coalesced
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|extent_record
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************************************************************************/
end_comment

begin_macro
name|rb_gen
argument_list|(
argument|UNUSED
argument_list|,
argument|extent_avail_
argument_list|,
argument|extent_tree_t
argument_list|,
argument|extent_t
argument_list|,
argument|rb_link
argument_list|,
argument|extent_esnead_comp
argument_list|)
end_macro

begin_typedef
typedef|typedef
enum|enum
block|{
name|lock_result_success
block|,
name|lock_result_failure
block|,
name|lock_result_no_extent
block|}
name|lock_result_t
typedef|;
end_typedef

begin_function
specifier|static
name|lock_result_t
name|extent_rtree_leaf_elm_try_lock
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|rtree_leaf_elm_t
modifier|*
name|elm
parameter_list|,
name|extent_t
modifier|*
modifier|*
name|result
parameter_list|)
block|{
name|extent_t
modifier|*
name|extent1
init|=
name|rtree_leaf_elm_extent_read
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|elm
argument_list|,
name|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|extent1
operator|==
name|NULL
condition|)
block|{
return|return
name|lock_result_no_extent
return|;
block|}
comment|/* 	 * It's possible that the extent changed out from under us, and with it 	 * the leaf->extent mapping.  We have to recheck while holding the lock. 	 */
name|extent_lock
argument_list|(
name|tsdn
argument_list|,
name|extent1
argument_list|)
expr_stmt|;
name|extent_t
modifier|*
name|extent2
init|=
name|rtree_leaf_elm_extent_read
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|elm
argument_list|,
name|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|extent1
operator|==
name|extent2
condition|)
block|{
operator|*
name|result
operator|=
name|extent1
expr_stmt|;
return|return
name|lock_result_success
return|;
block|}
else|else
block|{
name|extent_unlock
argument_list|(
name|tsdn
argument_list|,
name|extent1
argument_list|)
expr_stmt|;
return|return
name|lock_result_failure
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Returns a pool-locked extent_t * if there's one associated with the given  * address, and NULL otherwise.  */
end_comment

begin_function
specifier|static
name|extent_t
modifier|*
name|extent_lock_from_addr
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|rtree_ctx_t
modifier|*
name|rtree_ctx
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|)
block|{
name|extent_t
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|rtree_leaf_elm_t
modifier|*
name|elm
init|=
name|rtree_leaf_elm_lookup
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|addr
argument_list|,
name|false
argument_list|,
name|false
argument_list|)
decl_stmt|;
if|if
condition|(
name|elm
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|lock_result_t
name|lock_result
decl_stmt|;
do|do
block|{
name|lock_result
operator|=
name|extent_rtree_leaf_elm_try_lock
argument_list|(
name|tsdn
argument_list|,
name|elm
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|lock_result
operator|==
name|lock_result_failure
condition|)
do|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|extent_t
modifier|*
name|extent_alloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|)
block|{
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_avail_mtx
argument_list|)
expr_stmt|;
name|extent_t
modifier|*
name|extent
init|=
name|extent_avail_first
argument_list|(
operator|&
name|arena
operator|->
name|extent_avail
argument_list|)
decl_stmt|;
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_avail_mtx
argument_list|)
expr_stmt|;
return|return
name|base_alloc_extent
argument_list|(
name|tsdn
argument_list|,
name|arena
operator|->
name|base
argument_list|)
return|;
block|}
name|extent_avail_remove
argument_list|(
operator|&
name|arena
operator|->
name|extent_avail
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_avail_mtx
argument_list|)
expr_stmt|;
return|return
name|extent
return|;
block|}
end_function

begin_function
name|void
name|extent_dalloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_avail_mtx
argument_list|)
expr_stmt|;
name|extent_avail_insert
argument_list|(
operator|&
name|arena
operator|->
name|extent_avail
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_avail_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|extent_hooks_t
modifier|*
name|extent_hooks_get
parameter_list|(
name|arena_t
modifier|*
name|arena
parameter_list|)
block|{
return|return
name|base_extent_hooks_get
argument_list|(
name|arena
operator|->
name|base
argument_list|)
return|;
block|}
end_function

begin_function
name|extent_hooks_t
modifier|*
name|extent_hooks_set
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|)
block|{
name|background_thread_info_t
modifier|*
name|info
decl_stmt|;
if|if
condition|(
name|have_background_thread
condition|)
block|{
name|info
operator|=
name|arena_background_thread_info_get
argument_list|(
name|arena
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|info
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
name|extent_hooks_t
modifier|*
name|ret
init|=
name|base_extent_hooks_set
argument_list|(
name|arena
operator|->
name|base
argument_list|,
name|extent_hooks
argument_list|)
decl_stmt|;
if|if
condition|(
name|have_background_thread
condition|)
block|{
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|info
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_hooks_assure_initialized
parameter_list|(
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|)
block|{
if|if
condition|(
operator|*
name|r_extent_hooks
operator|==
name|EXTENT_HOOKS_INITIALIZER
condition|)
block|{
operator|*
name|r_extent_hooks
operator|=
name|extent_hooks_get
argument_list|(
name|arena
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|JEMALLOC_JET
end_ifndef

begin_function
specifier|static
endif|#
directive|endif
name|size_t
name|extent_size_quantize_floor
parameter_list|(
name|size_t
name|size
parameter_list|)
block|{
name|size_t
name|ret
decl_stmt|;
name|pszind_t
name|pind
decl_stmt|;
name|assert
argument_list|(
name|size
operator|>
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|size
operator|&
name|PAGE_MASK
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|pind
operator|=
name|sz_psz2ind
argument_list|(
name|size
operator|-
name|sz_large_pad
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pind
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Avoid underflow.  This short-circuit would also do the right 		 * thing for all sizes in the range for which there are 		 * PAGE-spaced size classes, but it's simplest to just handle 		 * the one case that would cause erroneous results. 		 */
return|return
name|size
return|;
block|}
name|ret
operator|=
name|sz_pind2sz
argument_list|(
name|pind
operator|-
literal|1
argument_list|)
operator|+
name|sz_large_pad
expr_stmt|;
name|assert
argument_list|(
name|ret
operator|<=
name|size
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|JEMALLOC_JET
end_ifndef

begin_function
specifier|static
endif|#
directive|endif
name|size_t
name|extent_size_quantize_ceil
parameter_list|(
name|size_t
name|size
parameter_list|)
block|{
name|size_t
name|ret
decl_stmt|;
name|assert
argument_list|(
name|size
operator|>
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|size
operator|-
name|sz_large_pad
operator|<=
name|LARGE_MAXCLASS
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|size
operator|&
name|PAGE_MASK
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
name|extent_size_quantize_floor
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
name|size
condition|)
block|{
comment|/* 		 * Skip a quantization that may have an adequately large extent, 		 * because under-sized extents may be mixed in.  This only 		 * happens when an unusual size is requested, i.e. for aligned 		 * allocation, and is just one of several places where linear 		 * search would potentially find sufficiently aligned available 		 * memory somewhere lower. 		 */
name|ret
operator|=
name|sz_pind2sz
argument_list|(
name|sz_psz2ind
argument_list|(
name|ret
operator|-
name|sz_large_pad
operator|+
literal|1
argument_list|)
argument_list|)
operator|+
name|sz_large_pad
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Generate pairing heap functions. */
end_comment

begin_macro
name|ph_gen
argument_list|(
argument_list|,
argument|extent_heap_
argument_list|,
argument|extent_heap_t
argument_list|,
argument|extent_t
argument_list|,
argument|ph_link
argument_list|,
argument|extent_snad_comp
argument_list|)
end_macro

begin_function
name|bool
name|extents_init
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_state_t
name|state
parameter_list|,
name|bool
name|delay_coalesce
parameter_list|)
block|{
if|if
condition|(
name|malloc_mutex_init
argument_list|(
operator|&
name|extents
operator|->
name|mtx
argument_list|,
literal|"extents"
argument_list|,
name|WITNESS_RANK_EXTENTS
argument_list|,
name|malloc_mutex_rank_exclusive
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|;
name|i
operator|<
name|NPSIZES
operator|+
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|extent_heap_new
argument_list|(
operator|&
name|extents
operator|->
name|heaps
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|bitmap_init
argument_list|(
name|extents
operator|->
name|bitmap
argument_list|,
operator|&
name|extents_bitmap_info
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|extent_list_init
argument_list|(
operator|&
name|extents
operator|->
name|lru
argument_list|)
expr_stmt|;
name|atomic_store_zu
argument_list|(
operator|&
name|extents
operator|->
name|npages
argument_list|,
literal|0
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
name|extents
operator|->
name|state
operator|=
name|state
expr_stmt|;
name|extents
operator|->
name|delay_coalesce
operator|=
name|delay_coalesce
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
name|extent_state_t
name|extents_state_get
parameter_list|(
specifier|const
name|extents_t
modifier|*
name|extents
parameter_list|)
block|{
return|return
name|extents
operator|->
name|state
return|;
block|}
end_function

begin_function
name|size_t
name|extents_npages_get
parameter_list|(
name|extents_t
modifier|*
name|extents
parameter_list|)
block|{
return|return
name|atomic_load_zu
argument_list|(
operator|&
name|extents
operator|->
name|npages
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|extents_insert_locked
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|preserve_lru
parameter_list|)
block|{
name|malloc_mutex_assert_owner
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|extent_state_get
argument_list|(
name|extent
argument_list|)
operator|==
name|extents
operator|->
name|state
argument_list|)
expr_stmt|;
name|size_t
name|size
init|=
name|extent_size_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|size_t
name|psz
init|=
name|extent_size_quantize_floor
argument_list|(
name|size
argument_list|)
decl_stmt|;
name|pszind_t
name|pind
init|=
name|sz_psz2ind
argument_list|(
name|psz
argument_list|)
decl_stmt|;
if|if
condition|(
name|extent_heap_empty
argument_list|(
operator|&
name|extents
operator|->
name|heaps
index|[
name|pind
index|]
argument_list|)
condition|)
block|{
name|bitmap_unset
argument_list|(
name|extents
operator|->
name|bitmap
argument_list|,
operator|&
name|extents_bitmap_info
argument_list|,
operator|(
name|size_t
operator|)
name|pind
argument_list|)
expr_stmt|;
block|}
name|extent_heap_insert
argument_list|(
operator|&
name|extents
operator|->
name|heaps
index|[
name|pind
index|]
argument_list|,
name|extent
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|preserve_lru
condition|)
block|{
name|extent_list_append
argument_list|(
operator|&
name|extents
operator|->
name|lru
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
name|size_t
name|npages
init|=
name|size
operator|>>
name|LG_PAGE
decl_stmt|;
comment|/* 	 * All modifications to npages hold the mutex (as asserted above), so we 	 * don't need an atomic fetch-add; we can get by with a load followed by 	 * a store. 	 */
name|size_t
name|cur_extents_npages
init|=
name|atomic_load_zu
argument_list|(
operator|&
name|extents
operator|->
name|npages
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
decl_stmt|;
name|atomic_store_zu
argument_list|(
operator|&
name|extents
operator|->
name|npages
argument_list|,
name|cur_extents_npages
operator|+
name|npages
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|extents_remove_locked
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|preserve_lru
parameter_list|)
block|{
name|malloc_mutex_assert_owner
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|extent_state_get
argument_list|(
name|extent
argument_list|)
operator|==
name|extents
operator|->
name|state
argument_list|)
expr_stmt|;
name|size_t
name|size
init|=
name|extent_size_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|size_t
name|psz
init|=
name|extent_size_quantize_floor
argument_list|(
name|size
argument_list|)
decl_stmt|;
name|pszind_t
name|pind
init|=
name|sz_psz2ind
argument_list|(
name|psz
argument_list|)
decl_stmt|;
name|extent_heap_remove
argument_list|(
operator|&
name|extents
operator|->
name|heaps
index|[
name|pind
index|]
argument_list|,
name|extent
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_heap_empty
argument_list|(
operator|&
name|extents
operator|->
name|heaps
index|[
name|pind
index|]
argument_list|)
condition|)
block|{
name|bitmap_set
argument_list|(
name|extents
operator|->
name|bitmap
argument_list|,
operator|&
name|extents_bitmap_info
argument_list|,
operator|(
name|size_t
operator|)
name|pind
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|preserve_lru
condition|)
block|{
name|extent_list_remove
argument_list|(
operator|&
name|extents
operator|->
name|lru
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
name|size_t
name|npages
init|=
name|size
operator|>>
name|LG_PAGE
decl_stmt|;
comment|/* 	 * As in extents_insert_locked, we hold extents->mtx and so don't need 	 * atomic operations for updating extents->npages. 	 */
name|size_t
name|cur_extents_npages
init|=
name|atomic_load_zu
argument_list|(
operator|&
name|extents
operator|->
name|npages
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|cur_extents_npages
operator|>=
name|npages
argument_list|)
expr_stmt|;
name|atomic_store_zu
argument_list|(
operator|&
name|extents
operator|->
name|npages
argument_list|,
name|cur_extents_npages
operator|-
operator|(
name|size
operator|>>
name|LG_PAGE
operator|)
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Do any-best-fit extent selection, i.e. select any extent that best fits. */
end_comment

begin_function
specifier|static
name|extent_t
modifier|*
name|extents_best_fit_locked
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|pszind_t
name|pind
init|=
name|sz_psz2ind
argument_list|(
name|extent_size_quantize_ceil
argument_list|(
name|size
argument_list|)
argument_list|)
decl_stmt|;
name|pszind_t
name|i
init|=
operator|(
name|pszind_t
operator|)
name|bitmap_ffu
argument_list|(
name|extents
operator|->
name|bitmap
argument_list|,
operator|&
name|extents_bitmap_info
argument_list|,
operator|(
name|size_t
operator|)
name|pind
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|<
name|NPSIZES
operator|+
literal|1
condition|)
block|{
name|assert
argument_list|(
operator|!
name|extent_heap_empty
argument_list|(
operator|&
name|extents
operator|->
name|heaps
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|extent_t
modifier|*
name|extent
init|=
name|extent_heap_any
argument_list|(
operator|&
name|extents
operator|->
name|heaps
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>=
name|size
argument_list|)
expr_stmt|;
return|return
name|extent
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * Do first-fit extent selection, i.e. select the oldest/lowest extent that is  * large enough.  */
end_comment

begin_function
specifier|static
name|extent_t
modifier|*
name|extents_first_fit_locked
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|extent_t
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|pszind_t
name|pind
init|=
name|sz_psz2ind
argument_list|(
name|extent_size_quantize_ceil
argument_list|(
name|size
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|pszind_t
name|i
init|=
operator|(
name|pszind_t
operator|)
name|bitmap_ffu
argument_list|(
name|extents
operator|->
name|bitmap
argument_list|,
operator|&
name|extents_bitmap_info
argument_list|,
operator|(
name|size_t
operator|)
name|pind
argument_list|)
init|;
name|i
operator|<
name|NPSIZES
operator|+
literal|1
condition|;
name|i
operator|=
operator|(
name|pszind_t
operator|)
name|bitmap_ffu
argument_list|(
name|extents
operator|->
name|bitmap
argument_list|,
operator|&
name|extents_bitmap_info
argument_list|,
operator|(
name|size_t
operator|)
name|i
operator|+
literal|1
argument_list|)
control|)
block|{
name|assert
argument_list|(
operator|!
name|extent_heap_empty
argument_list|(
operator|&
name|extents
operator|->
name|heaps
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|extent_t
modifier|*
name|extent
init|=
name|extent_heap_first
argument_list|(
operator|&
name|extents
operator|->
name|heaps
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>=
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
operator|||
name|extent_snad_comp
argument_list|(
name|extent
argument_list|,
name|ret
argument_list|)
operator|<
literal|0
condition|)
block|{
name|ret
operator|=
name|extent
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|NPSIZES
condition|)
block|{
break|break;
block|}
name|assert
argument_list|(
name|i
operator|<
name|NPSIZES
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Do {best,first}-fit extent selection, where the selection policy choice is  * based on extents->delay_coalesce.  Best-fit selection requires less  * searching, but its layout policy is less stable and may cause higher virtual  * memory fragmentation as a side effect.  */
end_comment

begin_function
specifier|static
name|extent_t
modifier|*
name|extents_fit_locked
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|malloc_mutex_assert_owner
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
name|extents
operator|->
name|delay_coalesce
condition|?
name|extents_best_fit_locked
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|size
argument_list|)
else|:
name|extents_first_fit_locked
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|size
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_try_delayed_coalesce
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|rtree_ctx_t
modifier|*
name|rtree_ctx
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|extent_state_set
argument_list|(
name|extent
argument_list|,
name|extent_state_active
argument_list|)
expr_stmt|;
name|bool
name|coalesced
decl_stmt|;
name|extent
operator|=
name|extent_try_coalesce
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|rtree_ctx
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
operator|&
name|coalesced
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|extent_state_set
argument_list|(
name|extent
argument_list|,
name|extents_state_get
argument_list|(
name|extents
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|coalesced
condition|)
block|{
return|return
name|true
return|;
block|}
name|extents_insert_locked
argument_list|(
name|tsdn
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
name|extent_t
modifier|*
name|extents_alloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|pad
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|slab
parameter_list|,
name|szind_t
name|szind
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|)
block|{
name|assert
argument_list|(
name|size
operator|+
name|pad
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|alignment
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|extent_recycle
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extents
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|pad
argument_list|,
name|alignment
argument_list|,
name|slab
argument_list|,
name|szind
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|extents_dalloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|assert
argument_list|(
name|extent_base_get
argument_list|(
name|extent
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|extent_addr_set
argument_list|(
name|extent
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
name|extent_zeroed_set
argument_list|(
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|extent_record
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|extent_t
modifier|*
name|extents_evict
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|size_t
name|npages_min
parameter_list|)
block|{
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
comment|/* 	 * Get the LRU coalesced extent, if any.  If coalescing was delayed, 	 * the loop will iterate until the LRU extent is fully coalesced. 	 */
name|extent_t
modifier|*
name|extent
decl_stmt|;
while|while
condition|(
name|true
condition|)
block|{
comment|/* Get the LRU extent, if any. */
name|extent
operator|=
name|extent_list_first
argument_list|(
operator|&
name|extents
operator|->
name|lru
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
goto|goto
name|label_return
goto|;
block|}
comment|/* Check the eviction limit. */
name|size_t
name|npages
init|=
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>>
name|LG_PAGE
decl_stmt|;
name|size_t
name|extents_npages
init|=
name|atomic_load_zu
argument_list|(
operator|&
name|extents
operator|->
name|npages
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
decl_stmt|;
if|if
condition|(
name|extents_npages
operator|-
name|npages
operator|<
name|npages_min
condition|)
block|{
name|extent
operator|=
name|NULL
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
name|extents_remove_locked
argument_list|(
name|tsdn
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|extents
operator|->
name|delay_coalesce
condition|)
block|{
break|break;
block|}
comment|/* Try to coalesce. */
if|if
condition|(
name|extent_try_delayed_coalesce
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|rtree_ctx
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|)
condition|)
block|{
break|break;
block|}
comment|/* 		 * The LRU extent was just coalesced and the result placed in 		 * the LRU at its neighbor's position.  Start over. 		 */
block|}
comment|/* 	 * Either mark the extent active or deregister it to protect against 	 * concurrent operations. 	 */
switch|switch
condition|(
name|extents_state_get
argument_list|(
name|extents
argument_list|)
condition|)
block|{
case|case
name|extent_state_active
case|:
name|not_reached
argument_list|()
expr_stmt|;
case|case
name|extent_state_dirty
case|:
case|case
name|extent_state_muzzy
case|:
name|extent_state_set
argument_list|(
name|extent
argument_list|,
name|extent_state_active
argument_list|)
expr_stmt|;
break|break;
case|case
name|extent_state_retained
case|:
name|extent_deregister
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
break|break;
default|default:
name|not_reached
argument_list|()
expr_stmt|;
block|}
name|label_return
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
name|extent
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|extents_leak
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
comment|/* 	 * Leak extent after making sure its pages have already been purged, so 	 * that this is only a virtual memory leak. 	 */
if|if
condition|(
name|extents_state_get
argument_list|(
name|extents
argument_list|)
operator|==
name|extent_state_dirty
condition|)
block|{
if|if
condition|(
name|extent_purge_lazy_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
literal|0
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|growing_retained
argument_list|)
condition|)
block|{
name|extent_purge_forced_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
literal|0
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|growing_retained
argument_list|)
expr_stmt|;
block|}
block|}
name|extent_dalloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|extents_prefork
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|)
block|{
name|malloc_mutex_prefork
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|extents_postfork_parent
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|)
block|{
name|malloc_mutex_postfork_parent
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|extents_postfork_child
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|)
block|{
name|malloc_mutex_postfork_child
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_deactivate_locked
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|preserve_lru
parameter_list|)
block|{
name|assert
argument_list|(
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
operator|==
name|arena
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|extent_state_get
argument_list|(
name|extent
argument_list|)
operator|==
name|extent_state_active
argument_list|)
expr_stmt|;
name|extent_state_set
argument_list|(
name|extent
argument_list|,
name|extents_state_get
argument_list|(
name|extents
argument_list|)
argument_list|)
expr_stmt|;
name|extents_insert_locked
argument_list|(
name|tsdn
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|preserve_lru
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_deactivate
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|preserve_lru
parameter_list|)
block|{
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|extent_deactivate_locked
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|preserve_lru
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_activate_locked
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|preserve_lru
parameter_list|)
block|{
name|assert
argument_list|(
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
operator|==
name|arena
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|extent_state_get
argument_list|(
name|extent
argument_list|)
operator|==
name|extents_state_get
argument_list|(
name|extents
argument_list|)
argument_list|)
expr_stmt|;
name|extents_remove_locked
argument_list|(
name|tsdn
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|preserve_lru
argument_list|)
expr_stmt|;
name|extent_state_set
argument_list|(
name|extent
argument_list|,
name|extent_state_active
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_rtree_leaf_elms_lookup
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|rtree_ctx_t
modifier|*
name|rtree_ctx
parameter_list|,
specifier|const
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|dependent
parameter_list|,
name|bool
name|init_missing
parameter_list|,
name|rtree_leaf_elm_t
modifier|*
modifier|*
name|r_elm_a
parameter_list|,
name|rtree_leaf_elm_t
modifier|*
modifier|*
name|r_elm_b
parameter_list|)
block|{
operator|*
name|r_elm_a
operator|=
name|rtree_leaf_elm_lookup
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|dependent
argument_list|,
name|init_missing
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dependent
operator|&&
operator|*
name|r_elm_a
operator|==
name|NULL
condition|)
block|{
return|return
name|true
return|;
block|}
name|assert
argument_list|(
operator|*
name|r_elm_a
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|r_elm_b
operator|=
name|rtree_leaf_elm_lookup
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_last_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|dependent
argument_list|,
name|init_missing
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dependent
operator|&&
operator|*
name|r_elm_b
operator|==
name|NULL
condition|)
block|{
return|return
name|true
return|;
block|}
name|assert
argument_list|(
operator|*
name|r_elm_b
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_rtree_write_acquired
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|rtree_leaf_elm_t
modifier|*
name|elm_a
parameter_list|,
name|rtree_leaf_elm_t
modifier|*
name|elm_b
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|szind_t
name|szind
parameter_list|,
name|bool
name|slab
parameter_list|)
block|{
name|rtree_leaf_elm_write
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|elm_a
argument_list|,
name|extent
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|)
expr_stmt|;
if|if
condition|(
name|elm_b
operator|!=
name|NULL
condition|)
block|{
name|rtree_leaf_elm_write
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|elm_b
argument_list|,
name|extent
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|extent_interior_register
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|rtree_ctx_t
modifier|*
name|rtree_ctx
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|szind_t
name|szind
parameter_list|)
block|{
name|assert
argument_list|(
name|extent_slab_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Register interior. */
for|for
control|(
name|size_t
name|i
init|=
literal|1
init|;
name|i
operator|<
operator|(
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>>
name|LG_PAGE
operator|)
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|rtree_write
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_base_get
argument_list|(
name|extent
argument_list|)
operator|+
call|(
name|uintptr_t
call|)
argument_list|(
name|i
operator|<<
name|LG_PAGE
argument_list|)
argument_list|,
name|extent
argument_list|,
name|szind
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|extent_gdump_add
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|cassert
argument_list|(
name|config_prof
argument_list|)
expr_stmt|;
comment|/* prof_gdump() requirement. */
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_prof
operator|&&
name|extent_state_get
argument_list|(
name|extent
argument_list|)
operator|==
name|extent_state_active
condition|)
block|{
name|size_t
name|nadd
init|=
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>>
name|LG_PAGE
decl_stmt|;
name|size_t
name|cur
init|=
name|atomic_fetch_add_zu
argument_list|(
operator|&
name|curpages
argument_list|,
name|nadd
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
operator|+
name|nadd
decl_stmt|;
name|size_t
name|high
init|=
name|atomic_load_zu
argument_list|(
operator|&
name|highpages
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
decl_stmt|;
while|while
condition|(
name|cur
operator|>
name|high
operator|&&
operator|!
name|atomic_compare_exchange_weak_zu
argument_list|(
operator|&
name|highpages
argument_list|,
operator|&
name|high
argument_list|,
name|cur
argument_list|,
name|ATOMIC_RELAXED
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
condition|)
block|{
comment|/* 			 * Don't refresh cur, because it may have decreased 			 * since this thread lost the highpages update race. 			 * Note that high is updated in case of CAS failure. 			 */
block|}
if|if
condition|(
name|cur
operator|>
name|high
operator|&&
name|prof_gdump_get_unlocked
argument_list|()
condition|)
block|{
name|prof_gdump
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|extent_gdump_sub
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|cassert
argument_list|(
name|config_prof
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_prof
operator|&&
name|extent_state_get
argument_list|(
name|extent
argument_list|)
operator|==
name|extent_state_active
condition|)
block|{
name|size_t
name|nsub
init|=
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>>
name|LG_PAGE
decl_stmt|;
name|assert
argument_list|(
name|atomic_load_zu
argument_list|(
operator|&
name|curpages
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
operator|>=
name|nsub
argument_list|)
expr_stmt|;
name|atomic_fetch_sub_zu
argument_list|(
operator|&
name|curpages
argument_list|,
name|nsub
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_register_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|gdump_add
parameter_list|)
block|{
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|rtree_leaf_elm_t
modifier|*
name|elm_a
decl_stmt|,
modifier|*
name|elm_b
decl_stmt|;
comment|/* 	 * We need to hold the lock to protect against a concurrent coalesce 	 * operation that sees us in a partial state. 	 */
name|extent_lock
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_rtree_leaf_elms_lookup
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|extent
argument_list|,
name|false
argument_list|,
name|true
argument_list|,
operator|&
name|elm_a
argument_list|,
operator|&
name|elm_b
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
name|szind_t
name|szind
init|=
name|extent_szind_get_maybe_invalid
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|bool
name|slab
init|=
name|extent_slab_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|extent_rtree_write_acquired
argument_list|(
name|tsdn
argument_list|,
name|elm_a
argument_list|,
name|elm_b
argument_list|,
name|extent
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|)
expr_stmt|;
if|if
condition|(
name|slab
condition|)
block|{
name|extent_interior_register
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|extent
argument_list|,
name|szind
argument_list|)
expr_stmt|;
block|}
name|extent_unlock
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_prof
operator|&&
name|gdump_add
condition|)
block|{
name|extent_gdump_add
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_register
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
return|return
name|extent_register_impl
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|true
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_register_no_gdump_add
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
return|return
name|extent_register_impl
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_reregister
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|bool
name|err
init|=
name|extent_register
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
decl_stmt|;
name|assert
argument_list|(
operator|!
name|err
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_interior_deregister
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|rtree_ctx_t
modifier|*
name|rtree_ctx
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|assert
argument_list|(
name|extent_slab_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
operator|(
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>>
name|LG_PAGE
operator|)
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|rtree_clear
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_base_get
argument_list|(
name|extent
argument_list|)
operator|+
call|(
name|uintptr_t
call|)
argument_list|(
name|i
operator|<<
name|LG_PAGE
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|extent_deregister
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|rtree_leaf_elm_t
modifier|*
name|elm_a
decl_stmt|,
modifier|*
name|elm_b
decl_stmt|;
name|extent_rtree_leaf_elms_lookup
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|extent
argument_list|,
name|true
argument_list|,
name|false
argument_list|,
operator|&
name|elm_a
argument_list|,
operator|&
name|elm_b
argument_list|)
expr_stmt|;
name|extent_lock
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|extent_rtree_write_acquired
argument_list|(
name|tsdn
argument_list|,
name|elm_a
argument_list|,
name|elm_b
argument_list|,
name|NULL
argument_list|,
name|NSIZES
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_slab_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
name|extent_interior_deregister
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|extent_slab_set
argument_list|(
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
name|extent_unlock
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_prof
condition|)
block|{
name|extent_gdump_sub
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|extent_t
modifier|*
name|extent_recycle_extract
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|rtree_ctx_t
modifier|*
name|rtree_ctx
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|pad
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|slab
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
name|growing_retained
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|alignment
operator|>
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_debug
operator|&&
name|new_addr
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Non-NULL new_addr has two use cases: 		 * 		 *   1) Recycle a known-extant extent, e.g. during purging. 		 *   2) Perform in-place expanding reallocation. 		 * 		 * Regardless of use case, new_addr must either refer to a 		 * non-existing extent, or to the base of an extant extent, 		 * since only active slabs support interior lookups (which of 		 * course cannot be recycled). 		 */
name|assert
argument_list|(
name|PAGE_ADDR2BASE
argument_list|(
name|new_addr
argument_list|)
operator|==
name|new_addr
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|pad
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|alignment
operator|<=
name|PAGE
argument_list|)
expr_stmt|;
block|}
name|size_t
name|esize
init|=
name|size
operator|+
name|pad
decl_stmt|;
name|size_t
name|alloc_size
init|=
name|esize
operator|+
name|PAGE_CEILING
argument_list|(
name|alignment
argument_list|)
operator|-
name|PAGE
decl_stmt|;
comment|/* Beware size_t wrap-around. */
if|if
condition|(
name|alloc_size
operator|<
name|esize
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
name|extent_t
modifier|*
name|extent
decl_stmt|;
if|if
condition|(
name|new_addr
operator|!=
name|NULL
condition|)
block|{
name|extent
operator|=
name|extent_lock_from_addr
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|new_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent
operator|!=
name|NULL
condition|)
block|{
comment|/* 			 * We might null-out extent to report an error, but we 			 * still need to unlock the associated mutex after. 			 */
name|extent_t
modifier|*
name|unlock_extent
init|=
name|extent
decl_stmt|;
name|assert
argument_list|(
name|extent_base_get
argument_list|(
name|extent
argument_list|)
operator|==
name|new_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_arena_get
argument_list|(
name|extent
argument_list|)
operator|!=
name|arena
operator|||
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|<
name|esize
operator|||
name|extent_state_get
argument_list|(
name|extent
argument_list|)
operator|!=
name|extents_state_get
argument_list|(
name|extents
argument_list|)
condition|)
block|{
name|extent
operator|=
name|NULL
expr_stmt|;
block|}
name|extent_unlock
argument_list|(
name|tsdn
argument_list|,
name|unlock_extent
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|extent
operator|=
name|extents_fit_locked
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|alloc_size
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|extent_activate_locked
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_zeroed_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
operator|*
name|zero
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
operator|*
name|commit
operator|=
name|true
expr_stmt|;
block|}
return|return
name|extent
return|;
block|}
end_function

begin_function
specifier|static
name|extent_t
modifier|*
name|extent_recycle_split
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|rtree_ctx_t
modifier|*
name|rtree_ctx
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|pad
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|slab
parameter_list|,
name|szind_t
name|szind
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|size_t
name|esize
init|=
name|size
operator|+
name|pad
decl_stmt|;
name|size_t
name|leadsize
init|=
name|ALIGNMENT_CEILING
argument_list|(
operator|(
name|uintptr_t
operator|)
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|PAGE_CEILING
argument_list|(
name|alignment
argument_list|)
argument_list|)
operator|-
operator|(
name|uintptr_t
operator|)
name|extent_base_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|new_addr
operator|==
name|NULL
operator|||
name|leadsize
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>=
name|leadsize
operator|+
name|esize
argument_list|)
expr_stmt|;
name|size_t
name|trailsize
init|=
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|-
name|leadsize
operator|-
name|esize
decl_stmt|;
comment|/* Split the lead. */
if|if
condition|(
name|leadsize
operator|!=
literal|0
condition|)
block|{
name|extent_t
modifier|*
name|lead
init|=
name|extent
decl_stmt|;
name|extent
operator|=
name|extent_split_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|lead
argument_list|,
name|leadsize
argument_list|,
name|NSIZES
argument_list|,
name|false
argument_list|,
name|esize
operator|+
name|trailsize
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|,
name|growing_retained
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
name|extent_deregister
argument_list|(
name|tsdn
argument_list|,
name|lead
argument_list|)
expr_stmt|;
name|extents_leak
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extents
argument_list|,
name|lead
argument_list|,
name|growing_retained
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|extent_deactivate
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|lead
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
comment|/* Split the trail. */
if|if
condition|(
name|trailsize
operator|!=
literal|0
condition|)
block|{
name|extent_t
modifier|*
name|trail
init|=
name|extent_split_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
name|esize
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|,
name|trailsize
argument_list|,
name|NSIZES
argument_list|,
name|false
argument_list|,
name|growing_retained
argument_list|)
decl_stmt|;
if|if
condition|(
name|trail
operator|==
name|NULL
condition|)
block|{
name|extent_deregister
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|extents_leak
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|growing_retained
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|extent_deactivate
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|trail
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|leadsize
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Splitting causes szind to be set as a side effect, but no 		 * splitting occurred. 		 */
name|extent_szind_set
argument_list|(
name|extent
argument_list|,
name|szind
argument_list|)
expr_stmt|;
if|if
condition|(
name|szind
operator|!=
name|NSIZES
condition|)
block|{
name|rtree_szind_slab_update
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|)
expr_stmt|;
if|if
condition|(
name|slab
operator|&&
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>
name|PAGE
condition|)
block|{
name|rtree_szind_slab_update
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_past_get
argument_list|(
name|extent
argument_list|)
operator|-
operator|(
name|uintptr_t
operator|)
name|PAGE
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|extent
return|;
block|}
end_function

begin_function
specifier|static
name|extent_t
modifier|*
name|extent_recycle
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|pad
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|slab
parameter_list|,
name|szind_t
name|szind
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
name|growing_retained
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|new_addr
operator|==
name|NULL
operator|||
operator|!
name|slab
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|pad
operator|==
literal|0
operator|||
operator|!
name|slab
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
operator|*
name|zero
operator|||
operator|!
name|slab
argument_list|)
expr_stmt|;
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|bool
name|committed
init|=
name|false
decl_stmt|;
name|extent_t
modifier|*
name|extent
init|=
name|extent_recycle_extract
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|rtree_ctx
argument_list|,
name|extents
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|pad
argument_list|,
name|alignment
argument_list|,
name|slab
argument_list|,
name|zero
argument_list|,
operator|&
name|committed
argument_list|,
name|growing_retained
argument_list|)
decl_stmt|;
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|committed
condition|)
block|{
operator|*
name|commit
operator|=
name|true
expr_stmt|;
block|}
name|extent
operator|=
name|extent_recycle_split
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|rtree_ctx
argument_list|,
name|extents
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|pad
argument_list|,
name|alignment
argument_list|,
name|slab
argument_list|,
name|szind
argument_list|,
name|extent
argument_list|,
name|growing_retained
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|*
name|commit
operator|&&
operator|!
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
if|if
condition|(
name|extent_commit_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
literal|0
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|growing_retained
argument_list|)
condition|)
block|{
name|extent_record
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|growing_retained
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|extent_zeroed_set
argument_list|(
name|extent
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pad
operator|!=
literal|0
condition|)
block|{
name|extent_addr_randomize
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
block|}
name|assert
argument_list|(
name|extent_state_get
argument_list|(
name|extent
argument_list|)
operator|==
name|extent_state_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|slab
condition|)
block|{
name|extent_slab_set
argument_list|(
name|extent
argument_list|,
name|slab
argument_list|)
expr_stmt|;
name|extent_interior_register
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|extent
argument_list|,
name|szind
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|zero
condition|)
block|{
name|void
modifier|*
name|addr
init|=
name|extent_base_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|size_t
name|size
init|=
name|extent_size_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|extent_zeroed_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
if|if
condition|(
name|pages_purge_forced
argument_list|(
name|addr
argument_list|,
name|size
argument_list|)
condition|)
block|{
name|memset
argument_list|(
name|addr
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|config_debug
condition|)
block|{
name|size_t
modifier|*
name|p
init|=
operator|(
name|size_t
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|addr
decl_stmt|;
for|for
control|(
name|size_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|size
operator|/
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|assert
argument_list|(
name|p
index|[
name|i
index|]
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|extent
return|;
block|}
end_function

begin_comment
comment|/*  * If the caller specifies (!*zero), it is still possible to receive zeroed  * memory, in which case *zero is toggled to true.  arena_extent_alloc() takes  * advantage of this to avoid demanding zeroed extents, but taking advantage of  * them if they are returned.  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|extent_alloc_core
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|,
name|dss_prec_t
name|dss_prec
parameter_list|)
block|{
name|void
modifier|*
name|ret
decl_stmt|;
name|assert
argument_list|(
name|size
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|alignment
operator|!=
literal|0
argument_list|)
expr_stmt|;
comment|/* "primary" dss. */
if|if
condition|(
name|have_dss
operator|&&
name|dss_prec
operator|==
name|dss_prec_primary
operator|&&
operator|(
name|ret
operator|=
name|extent_alloc_dss
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
return|return
name|ret
return|;
block|}
comment|/* mmap. */
if|if
condition|(
operator|(
name|ret
operator|=
name|extent_alloc_mmap
argument_list|(
name|new_addr
argument_list|,
name|size
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
return|return
name|ret
return|;
block|}
comment|/* "secondary" dss. */
if|if
condition|(
name|have_dss
operator|&&
name|dss_prec
operator|==
name|dss_prec_secondary
operator|&&
operator|(
name|ret
operator|=
name|extent_alloc_dss
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
return|return
name|ret
return|;
block|}
comment|/* All strategies for allocation failed. */
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|extent_alloc_default_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|)
block|{
name|void
modifier|*
name|ret
decl_stmt|;
name|ret
operator|=
name|extent_alloc_core
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|,
operator|(
name|dss_prec_t
operator|)
name|atomic_load_u
argument_list|(
operator|&
name|arena
operator|->
name|dss_prec
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|extent_alloc_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
name|tsdn_t
modifier|*
name|tsdn
decl_stmt|;
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|tsdn
operator|=
name|tsdn_fetch
argument_list|()
expr_stmt|;
name|arena
operator|=
name|arena_get
argument_list|(
name|tsdn
argument_list|,
name|arena_ind
argument_list|,
name|false
argument_list|)
expr_stmt|;
comment|/* 	 * The arena we're allocating on behalf of must have been initialized 	 * already. 	 */
name|assert
argument_list|(
name|arena
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|extent_alloc_default_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_hook_pre_reentrancy
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|)
block|{
name|tsd_t
modifier|*
name|tsd
init|=
name|tsdn_null
argument_list|(
name|tsdn
argument_list|)
condition|?
name|tsd_fetch
argument_list|()
else|:
name|tsdn_tsd
argument_list|(
name|tsdn
argument_list|)
decl_stmt|;
name|pre_reentrancy
argument_list|(
name|tsd
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_hook_post_reentrancy
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|)
block|{
name|tsd_t
modifier|*
name|tsd
init|=
name|tsdn_null
argument_list|(
name|tsdn
argument_list|)
condition|?
name|tsd_fetch
argument_list|()
else|:
name|tsdn_tsd
argument_list|(
name|tsdn
argument_list|)
decl_stmt|;
name|post_reentrancy
argument_list|(
name|tsd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * If virtual memory is retained, create increasingly larger extents from which  * to split requested extents in order to limit the total number of disjoint  * virtual memory ranges retained by each arena.  */
end_comment

begin_function
specifier|static
name|extent_t
modifier|*
name|extent_grow_retained
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|pad
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|slab
parameter_list|,
name|szind_t
name|szind
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|)
block|{
name|malloc_mutex_assert_owner
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_grow_mtx
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|pad
operator|==
literal|0
operator|||
operator|!
name|slab
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
operator|*
name|zero
operator|||
operator|!
name|slab
argument_list|)
expr_stmt|;
name|size_t
name|esize
init|=
name|size
operator|+
name|pad
decl_stmt|;
name|size_t
name|alloc_size_min
init|=
name|esize
operator|+
name|PAGE_CEILING
argument_list|(
name|alignment
argument_list|)
operator|-
name|PAGE
decl_stmt|;
comment|/* Beware size_t wrap-around. */
if|if
condition|(
name|alloc_size_min
operator|<
name|esize
condition|)
block|{
goto|goto
name|label_err
goto|;
block|}
comment|/* 	 * Find the next extent size in the series that would be large enough to 	 * satisfy this request. 	 */
name|pszind_t
name|egn_skip
init|=
literal|0
decl_stmt|;
name|size_t
name|alloc_size
init|=
name|sz_pind2sz
argument_list|(
name|arena
operator|->
name|extent_grow_next
operator|+
name|egn_skip
argument_list|)
decl_stmt|;
while|while
condition|(
name|alloc_size
operator|<
name|alloc_size_min
condition|)
block|{
name|egn_skip
operator|++
expr_stmt|;
if|if
condition|(
name|arena
operator|->
name|extent_grow_next
operator|+
name|egn_skip
operator|==
name|NPSIZES
condition|)
block|{
comment|/* Outside legal range. */
goto|goto
name|label_err
goto|;
block|}
name|assert
argument_list|(
name|arena
operator|->
name|extent_grow_next
operator|+
name|egn_skip
operator|<
name|NPSIZES
argument_list|)
expr_stmt|;
name|alloc_size
operator|=
name|sz_pind2sz
argument_list|(
name|arena
operator|->
name|extent_grow_next
operator|+
name|egn_skip
argument_list|)
expr_stmt|;
block|}
name|extent_t
modifier|*
name|extent
init|=
name|extent_alloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
decl_stmt|;
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
goto|goto
name|label_err
goto|;
block|}
name|bool
name|zeroed
init|=
name|false
decl_stmt|;
name|bool
name|committed
init|=
name|false
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|==
operator|&
name|extent_hooks_default
condition|)
block|{
name|ptr
operator|=
name|extent_alloc_core
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|NULL
argument_list|,
name|alloc_size
argument_list|,
name|PAGE
argument_list|,
operator|&
name|zeroed
argument_list|,
operator|&
name|committed
argument_list|,
operator|(
name|dss_prec_t
operator|)
name|atomic_load_u
argument_list|(
operator|&
name|arena
operator|->
name|dss_prec
argument_list|,
name|ATOMIC_RELAXED
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|ptr
operator|=
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|alloc
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|NULL
argument_list|,
name|alloc_size
argument_list|,
name|PAGE
argument_list|,
operator|&
name|zeroed
argument_list|,
operator|&
name|committed
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
expr_stmt|;
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
name|extent_init
argument_list|(
name|extent
argument_list|,
name|arena
argument_list|,
name|ptr
argument_list|,
name|alloc_size
argument_list|,
name|false
argument_list|,
name|NSIZES
argument_list|,
name|arena_extent_sn_next
argument_list|(
name|arena
argument_list|)
argument_list|,
name|extent_state_active
argument_list|,
name|zeroed
argument_list|,
name|committed
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
block|{
name|extent_dalloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|)
expr_stmt|;
goto|goto
name|label_err
goto|;
block|}
if|if
condition|(
name|extent_register_no_gdump_add
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
condition|)
block|{
name|extents_leak
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|extent
argument_list|,
name|true
argument_list|)
expr_stmt|;
goto|goto
name|label_err
goto|;
block|}
name|size_t
name|leadsize
init|=
name|ALIGNMENT_CEILING
argument_list|(
operator|(
name|uintptr_t
operator|)
name|ptr
argument_list|,
name|PAGE_CEILING
argument_list|(
name|alignment
argument_list|)
argument_list|)
operator|-
operator|(
name|uintptr_t
operator|)
name|ptr
decl_stmt|;
name|assert
argument_list|(
name|alloc_size
operator|>=
name|leadsize
operator|+
name|esize
argument_list|)
expr_stmt|;
name|size_t
name|trailsize
init|=
name|alloc_size
operator|-
name|leadsize
operator|-
name|esize
decl_stmt|;
if|if
condition|(
name|extent_zeroed_get
argument_list|(
name|extent
argument_list|)
operator|&&
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
operator|*
name|zero
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
operator|*
name|commit
operator|=
name|true
expr_stmt|;
block|}
comment|/* Split the lead. */
if|if
condition|(
name|leadsize
operator|!=
literal|0
condition|)
block|{
name|extent_t
modifier|*
name|lead
init|=
name|extent
decl_stmt|;
name|extent
operator|=
name|extent_split_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|lead
argument_list|,
name|leadsize
argument_list|,
name|NSIZES
argument_list|,
name|false
argument_list|,
name|esize
operator|+
name|trailsize
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
name|extent_deregister
argument_list|(
name|tsdn
argument_list|,
name|lead
argument_list|)
expr_stmt|;
name|extents_leak
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|lead
argument_list|,
name|true
argument_list|)
expr_stmt|;
goto|goto
name|label_err
goto|;
block|}
name|extent_record
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|lead
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
comment|/* Split the trail. */
if|if
condition|(
name|trailsize
operator|!=
literal|0
condition|)
block|{
name|extent_t
modifier|*
name|trail
init|=
name|extent_split_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
name|esize
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|,
name|trailsize
argument_list|,
name|NSIZES
argument_list|,
name|false
argument_list|,
name|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|trail
operator|==
name|NULL
condition|)
block|{
name|extent_deregister
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|extents_leak
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|extent
argument_list|,
name|true
argument_list|)
expr_stmt|;
goto|goto
name|label_err
goto|;
block|}
name|extent_record
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|trail
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|leadsize
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Splitting causes szind to be set as a side effect, but no 		 * splitting occurred. 		 */
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|extent_szind_set
argument_list|(
name|extent
argument_list|,
name|szind
argument_list|)
expr_stmt|;
if|if
condition|(
name|szind
operator|!=
name|NSIZES
condition|)
block|{
name|rtree_szind_slab_update
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|)
expr_stmt|;
if|if
condition|(
name|slab
operator|&&
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|>
name|PAGE
condition|)
block|{
name|rtree_szind_slab_update
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_past_get
argument_list|(
name|extent
argument_list|)
operator|-
operator|(
name|uintptr_t
operator|)
name|PAGE
argument_list|,
name|szind
argument_list|,
name|slab
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|*
name|commit
operator|&&
operator|!
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
if|if
condition|(
name|extent_commit_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
literal|0
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|true
argument_list|)
condition|)
block|{
name|extent_record
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|extent
argument_list|,
name|true
argument_list|)
expr_stmt|;
goto|goto
name|label_err
goto|;
block|}
name|extent_zeroed_set
argument_list|(
name|extent
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Increment extent_grow_next if doing so wouldn't exceed the legal 	 * range. 	 */
if|if
condition|(
name|arena
operator|->
name|extent_grow_next
operator|+
name|egn_skip
operator|+
literal|1
operator|<
name|NPSIZES
condition|)
block|{
name|arena
operator|->
name|extent_grow_next
operator|+=
name|egn_skip
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|arena
operator|->
name|extent_grow_next
operator|=
name|NPSIZES
operator|-
literal|1
expr_stmt|;
block|}
comment|/* All opportunities for failure are past. */
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_grow_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_prof
condition|)
block|{
comment|/* Adjust gdump stats now that extent is final size. */
name|extent_gdump_add
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pad
operator|!=
literal|0
condition|)
block|{
name|extent_addr_randomize
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|slab
condition|)
block|{
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|extent_slab_set
argument_list|(
name|extent
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|extent_interior_register
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|extent
argument_list|,
name|szind
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|zero
operator|&&
operator|!
name|extent_zeroed_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
name|void
modifier|*
name|addr
init|=
name|extent_base_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
name|size_t
name|size
init|=
name|extent_size_get
argument_list|(
name|extent
argument_list|)
decl_stmt|;
if|if
condition|(
name|pages_purge_forced
argument_list|(
name|addr
argument_list|,
name|size
argument_list|)
condition|)
block|{
name|memset
argument_list|(
name|addr
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|extent
return|;
name|label_err
label|:
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_grow_mtx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|extent_t
modifier|*
name|extent_alloc_retained
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|pad
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|slab
parameter_list|,
name|szind_t
name|szind
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|)
block|{
name|assert
argument_list|(
name|size
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|alignment
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_grow_mtx
argument_list|)
expr_stmt|;
name|extent_t
modifier|*
name|extent
init|=
name|extent_recycle
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|pad
argument_list|,
name|alignment
argument_list|,
name|slab
argument_list|,
name|szind
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|,
name|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|extent
operator|!=
name|NULL
condition|)
block|{
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_grow_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_prof
condition|)
block|{
name|extent_gdump_add
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|opt_retain
operator|&&
name|new_addr
operator|==
name|NULL
condition|)
block|{
name|extent
operator|=
name|extent_grow_retained
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|size
argument_list|,
name|pad
argument_list|,
name|alignment
argument_list|,
name|slab
argument_list|,
name|szind
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|)
expr_stmt|;
comment|/* extent_grow_retained() always releases extent_grow_mtx. */
block|}
else|else
block|{
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_grow_mtx
argument_list|)
expr_stmt|;
block|}
name|malloc_mutex_assert_not_owner
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|extent_grow_mtx
argument_list|)
expr_stmt|;
return|return
name|extent
return|;
block|}
end_function

begin_function
specifier|static
name|extent_t
modifier|*
name|extent_alloc_wrapper_hard
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|pad
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|slab
parameter_list|,
name|szind_t
name|szind
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|)
block|{
name|size_t
name|esize
init|=
name|size
operator|+
name|pad
decl_stmt|;
name|extent_t
modifier|*
name|extent
init|=
name|extent_alloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
decl_stmt|;
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|void
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|==
operator|&
name|extent_hooks_default
condition|)
block|{
comment|/* Call directly to propagate tsdn. */
name|addr
operator|=
name|extent_alloc_default_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|new_addr
argument_list|,
name|esize
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|alloc
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|new_addr
argument_list|,
name|esize
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
expr_stmt|;
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
block|{
name|extent_dalloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|extent_init
argument_list|(
name|extent
argument_list|,
name|arena
argument_list|,
name|addr
argument_list|,
name|esize
argument_list|,
name|slab
argument_list|,
name|szind
argument_list|,
name|arena_extent_sn_next
argument_list|(
name|arena
argument_list|)
argument_list|,
name|extent_state_active
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|)
expr_stmt|;
if|if
condition|(
name|pad
operator|!=
literal|0
condition|)
block|{
name|extent_addr_randomize
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|extent_register
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
condition|)
block|{
name|extents_leak
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|extent
return|;
block|}
end_function

begin_function
name|extent_t
modifier|*
name|extent_alloc_wrapper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|void
modifier|*
name|new_addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|pad
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|slab
parameter_list|,
name|szind_t
name|szind
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|,
name|bool
modifier|*
name|commit
parameter_list|)
block|{
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
name|extent_t
modifier|*
name|extent
init|=
name|extent_alloc_retained
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|pad
argument_list|,
name|alignment
argument_list|,
name|slab
argument_list|,
name|szind
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|)
decl_stmt|;
if|if
condition|(
name|extent
operator|==
name|NULL
condition|)
block|{
name|extent
operator|=
name|extent_alloc_wrapper_hard
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|new_addr
argument_list|,
name|size
argument_list|,
name|pad
argument_list|,
name|alignment
argument_list|,
name|slab
argument_list|,
name|szind
argument_list|,
name|zero
argument_list|,
name|commit
argument_list|)
expr_stmt|;
block|}
return|return
name|extent
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_can_coalesce
parameter_list|(
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
specifier|const
name|extent_t
modifier|*
name|inner
parameter_list|,
specifier|const
name|extent_t
modifier|*
name|outer
parameter_list|)
block|{
name|assert
argument_list|(
name|extent_arena_get
argument_list|(
name|inner
argument_list|)
operator|==
name|arena
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_arena_get
argument_list|(
name|outer
argument_list|)
operator|!=
name|arena
condition|)
block|{
return|return
name|false
return|;
block|}
name|assert
argument_list|(
name|extent_state_get
argument_list|(
name|inner
argument_list|)
operator|==
name|extent_state_active
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_state_get
argument_list|(
name|outer
argument_list|)
operator|!=
name|extents
operator|->
name|state
condition|)
block|{
return|return
name|false
return|;
block|}
if|if
condition|(
name|extent_committed_get
argument_list|(
name|inner
argument_list|)
operator|!=
name|extent_committed_get
argument_list|(
name|outer
argument_list|)
condition|)
block|{
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_coalesce
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|inner
parameter_list|,
name|extent_t
modifier|*
name|outer
parameter_list|,
name|bool
name|forward
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|assert
argument_list|(
name|extent_can_coalesce
argument_list|(
name|arena
argument_list|,
name|extents
argument_list|,
name|inner
argument_list|,
name|outer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|forward
operator|&&
name|extents
operator|->
name|delay_coalesce
condition|)
block|{
comment|/* 		 * The extent that remains after coalescing must occupy the 		 * outer extent's position in the LRU.  For forward coalescing, 		 * swap the inner extent into the LRU. 		 */
name|extent_list_replace
argument_list|(
operator|&
name|extents
operator|->
name|lru
argument_list|,
name|outer
argument_list|,
name|inner
argument_list|)
expr_stmt|;
block|}
name|extent_activate_locked
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|outer
argument_list|,
name|extents
operator|->
name|delay_coalesce
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|bool
name|err
init|=
name|extent_merge_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|forward
condition|?
name|inner
else|:
name|outer
argument_list|,
name|forward
condition|?
name|outer
else|:
name|inner
argument_list|,
name|growing_retained
argument_list|)
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|forward
operator|&&
name|extents
operator|->
name|delay_coalesce
condition|)
block|{
name|extent_list_replace
argument_list|(
operator|&
name|extents
operator|->
name|lru
argument_list|,
name|inner
argument_list|,
name|outer
argument_list|)
expr_stmt|;
block|}
name|extent_deactivate_locked
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|outer
argument_list|,
name|extents
operator|->
name|delay_coalesce
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|extent_t
modifier|*
name|extent_try_coalesce
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|rtree_ctx_t
modifier|*
name|rtree_ctx
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
modifier|*
name|coalesced
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
comment|/* 	 * Continue attempting to coalesce until failure, to protect against 	 * races with other threads that are thwarted by this one. 	 */
name|bool
name|again
decl_stmt|;
do|do
block|{
name|again
operator|=
name|false
expr_stmt|;
comment|/* Try to coalesce forward. */
name|extent_t
modifier|*
name|next
init|=
name|extent_lock_from_addr
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|extent_past_get
argument_list|(
name|extent
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|next
operator|!=
name|NULL
condition|)
block|{
comment|/* 			 * extents->mtx only protects against races for 			 * like-state extents, so call extent_can_coalesce() 			 * before releasing next's pool lock. 			 */
name|bool
name|can_coalesce
init|=
name|extent_can_coalesce
argument_list|(
name|arena
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|next
argument_list|)
decl_stmt|;
name|extent_unlock
argument_list|(
name|tsdn
argument_list|,
name|next
argument_list|)
expr_stmt|;
if|if
condition|(
name|can_coalesce
operator|&&
operator|!
name|extent_coalesce
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|next
argument_list|,
name|true
argument_list|,
name|growing_retained
argument_list|)
condition|)
block|{
if|if
condition|(
name|extents
operator|->
name|delay_coalesce
condition|)
block|{
comment|/* Do minimal coalescing. */
operator|*
name|coalesced
operator|=
name|true
expr_stmt|;
return|return
name|extent
return|;
block|}
name|again
operator|=
name|true
expr_stmt|;
block|}
block|}
comment|/* Try to coalesce backward. */
name|extent_t
modifier|*
name|prev
init|=
name|extent_lock_from_addr
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|extent_before_get
argument_list|(
name|extent
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|prev
operator|!=
name|NULL
condition|)
block|{
name|bool
name|can_coalesce
init|=
name|extent_can_coalesce
argument_list|(
name|arena
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|prev
argument_list|)
decl_stmt|;
name|extent_unlock
argument_list|(
name|tsdn
argument_list|,
name|prev
argument_list|)
expr_stmt|;
if|if
condition|(
name|can_coalesce
operator|&&
operator|!
name|extent_coalesce
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|prev
argument_list|,
name|false
argument_list|,
name|growing_retained
argument_list|)
condition|)
block|{
name|extent
operator|=
name|prev
expr_stmt|;
if|if
condition|(
name|extents
operator|->
name|delay_coalesce
condition|)
block|{
comment|/* Do minimal coalescing. */
operator|*
name|coalesced
operator|=
name|true
expr_stmt|;
return|return
name|extent
return|;
block|}
name|again
operator|=
name|true
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
name|again
condition|)
do|;
if|if
condition|(
name|extents
operator|->
name|delay_coalesce
condition|)
block|{
operator|*
name|coalesced
operator|=
name|false
expr_stmt|;
block|}
return|return
name|extent
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_record
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extents_t
modifier|*
name|extents
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|assert
argument_list|(
operator|(
name|extents_state_get
argument_list|(
name|extents
argument_list|)
operator|!=
name|extent_state_dirty
operator|&&
name|extents_state_get
argument_list|(
name|extents
argument_list|)
operator|!=
name|extent_state_muzzy
operator|)
operator|||
operator|!
name|extent_zeroed_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
name|extent_szind_set
argument_list|(
name|extent
argument_list|,
name|NSIZES
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_slab_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
name|extent_interior_deregister
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|extent_slab_set
argument_list|(
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
name|assert
argument_list|(
name|rtree_extent_read
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|rtree_ctx
argument_list|,
operator|(
name|uintptr_t
operator|)
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|true
argument_list|)
operator|==
name|extent
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|extents
operator|->
name|delay_coalesce
condition|)
block|{
name|extent
operator|=
name|extent_try_coalesce
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|rtree_ctx
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|NULL
argument_list|,
name|growing_retained
argument_list|)
expr_stmt|;
block|}
name|extent_deactivate_locked
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extents
argument_list|,
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|extent_dalloc_gap
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|extent_hooks_t
modifier|*
name|extent_hooks
init|=
name|EXTENT_HOOKS_INITIALIZER
decl_stmt|;
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_register
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
condition|)
block|{
name|extents_leak
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
return|return;
block|}
name|extent_dalloc_wrapper
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
operator|&
name|extent_hooks
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_dalloc_default_impl
parameter_list|(
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
if|if
condition|(
operator|!
name|have_dss
operator|||
operator|!
name|extent_in_dss
argument_list|(
name|addr
argument_list|)
condition|)
block|{
return|return
name|extent_dalloc_mmap
argument_list|(
name|addr
argument_list|,
name|size
argument_list|)
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_dalloc_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|bool
name|committed
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
return|return
name|extent_dalloc_default_impl
argument_list|(
name|addr
argument_list|,
name|size
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_dalloc_wrapper_try
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|bool
name|err
decl_stmt|;
name|assert
argument_list|(
name|extent_base_get
argument_list|(
name|extent
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|extent_addr_set
argument_list|(
name|extent
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
comment|/* Try to deallocate. */
if|if
condition|(
operator|*
name|r_extent_hooks
operator|==
operator|&
name|extent_hooks_default
condition|)
block|{
comment|/* Call directly to propagate tsdn. */
name|err
operator|=
name|extent_dalloc_default_impl
argument_list|(
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|err
operator|=
operator|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|dalloc
operator|==
name|NULL
operator|||
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|dalloc
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|extent_dalloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|void
name|extent_dalloc_wrapper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Deregister first to avoid a race with other allocating threads, and 	 * reregister if deallocation fails. 	 */
name|extent_deregister
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|extent_dalloc_wrapper_try
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|)
condition|)
block|{
return|return;
block|}
name|extent_reregister
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
comment|/* Try to decommit; purge if that fails. */
name|bool
name|zeroed
decl_stmt|;
if|if
condition|(
operator|!
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
condition|)
block|{
name|zeroed
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|extent_decommit_wrapper
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
literal|0
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|)
condition|)
block|{
name|zeroed
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|purge_forced
operator|!=
name|NULL
operator|&&
operator|!
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|purge_forced
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
literal|0
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
condition|)
block|{
name|zeroed
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|extent_state_get
argument_list|(
name|extent
argument_list|)
operator|==
name|extent_state_muzzy
operator|||
operator|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|purge_lazy
operator|!=
name|NULL
operator|&&
operator|!
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|purge_lazy
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
literal|0
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|zeroed
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
name|zeroed
operator|=
name|false
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
name|extent_zeroed_set
argument_list|(
name|extent
argument_list|,
name|zeroed
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_prof
condition|)
block|{
name|extent_gdump_sub
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
name|extent_record
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
operator|&
name|arena
operator|->
name|extents_retained
argument_list|,
name|extent
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|extent_destroy_default_impl
parameter_list|(
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
if|if
condition|(
operator|!
name|have_dss
operator|||
operator|!
name|extent_in_dss
argument_list|(
name|addr
argument_list|)
condition|)
block|{
name|pages_unmap
argument_list|(
name|addr
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|extent_destroy_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|bool
name|committed
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
name|extent_destroy_default_impl
argument_list|(
name|addr
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|extent_destroy_wrapper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|)
block|{
name|assert
argument_list|(
name|extent_base_get
argument_list|(
name|extent
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Deregister first to avoid a race with other allocating threads. */
name|extent_deregister
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|)
expr_stmt|;
name|extent_addr_set
argument_list|(
name|extent
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
comment|/* Try to destroy; silently fail otherwise. */
if|if
condition|(
operator|*
name|r_extent_hooks
operator|==
operator|&
name|extent_hooks_default
condition|)
block|{
comment|/* Call directly to propagate tsdn. */
name|extent_destroy_default_impl
argument_list|(
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|destroy
operator|!=
name|NULL
condition|)
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|destroy
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
expr_stmt|;
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
name|extent_dalloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|extent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_commit_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
return|return
name|pages_commit
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|addr
operator|+
operator|(
name|uintptr_t
operator|)
name|offset
operator|)
argument_list|,
name|length
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_commit_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
name|growing_retained
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
name|bool
name|err
init|=
operator|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|commit
operator|==
name|NULL
operator|||
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|commit
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
operator|)
decl_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
name|extent_committed_set
argument_list|(
name|extent
argument_list|,
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
operator|||
operator|!
name|err
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|bool
name|extent_commit_wrapper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
return|return
name|extent_commit_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_decommit_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
return|return
name|pages_decommit
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|addr
operator|+
operator|(
name|uintptr_t
operator|)
name|offset
operator|)
argument_list|,
name|length
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|extent_decommit_wrapper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
name|bool
name|err
init|=
operator|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|decommit
operator|==
name|NULL
operator|||
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|decommit
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
operator|)
decl_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
name|extent_committed_set
argument_list|(
name|extent
argument_list|,
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
operator|&&
name|err
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PAGES_CAN_PURGE_LAZY
end_ifdef

begin_function
specifier|static
name|bool
name|extent_purge_lazy_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
name|assert
argument_list|(
name|addr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|offset
operator|&
name|PAGE_MASK
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|length
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|length
operator|&
name|PAGE_MASK
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
name|pages_purge_lazy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|addr
operator|+
operator|(
name|uintptr_t
operator|)
name|offset
operator|)
argument_list|,
name|length
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|bool
name|extent_purge_lazy_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
name|growing_retained
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|purge_lazy
operator|==
name|NULL
condition|)
block|{
return|return
name|true
return|;
block|}
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
name|bool
name|err
init|=
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|purge_lazy
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|bool
name|extent_purge_lazy_wrapper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
return|return
name|extent_purge_lazy_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PAGES_CAN_PURGE_FORCED
end_ifdef

begin_function
specifier|static
name|bool
name|extent_purge_forced_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
name|assert
argument_list|(
name|addr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|offset
operator|&
name|PAGE_MASK
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|length
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|length
operator|&
name|PAGE_MASK
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
name|pages_purge_forced
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|addr
operator|+
operator|(
name|uintptr_t
operator|)
name|offset
operator|)
argument_list|,
name|length
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|bool
name|extent_purge_forced_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
name|growing_retained
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|purge_forced
operator|==
name|NULL
condition|)
block|{
return|return
name|true
return|;
block|}
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
name|bool
name|err
init|=
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|purge_forced
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|bool
name|extent_purge_forced_wrapper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|offset
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
return|return
name|extent_purge_forced_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|JEMALLOC_MAPS_COALESCE
end_ifdef

begin_function
specifier|static
name|bool
name|extent_split_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|size_a
parameter_list|,
name|size_t
name|size_b
parameter_list|,
name|bool
name|committed
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
return|return
operator|!
name|maps_coalesce
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|extent_t
modifier|*
name|extent_split_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|size_a
parameter_list|,
name|szind_t
name|szind_a
parameter_list|,
name|bool
name|slab_a
parameter_list|,
name|size_t
name|size_b
parameter_list|,
name|szind_t
name|szind_b
parameter_list|,
name|bool
name|slab_b
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|assert
argument_list|(
name|extent_size_get
argument_list|(
name|extent
argument_list|)
operator|==
name|size_a
operator|+
name|size_b
argument_list|)
expr_stmt|;
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
name|growing_retained
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|split
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|extent_t
modifier|*
name|trail
init|=
name|extent_alloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
decl_stmt|;
if|if
condition|(
name|trail
operator|==
name|NULL
condition|)
block|{
goto|goto
name|label_error_a
goto|;
block|}
name|extent_init
argument_list|(
name|trail
argument_list|,
name|arena
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|extent_base_get
argument_list|(
name|extent
argument_list|)
operator|+
name|size_a
operator|)
argument_list|,
name|size_b
argument_list|,
name|slab_b
argument_list|,
name|szind_b
argument_list|,
name|extent_sn_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_state_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_zeroed_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|rtree_leaf_elm_t
modifier|*
name|lead_elm_a
decl_stmt|,
modifier|*
name|lead_elm_b
decl_stmt|;
block|{
name|extent_t
name|lead
decl_stmt|;
name|extent_init
argument_list|(
operator|&
name|lead
argument_list|,
name|arena
argument_list|,
name|extent_addr_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|size_a
argument_list|,
name|slab_a
argument_list|,
name|szind_a
argument_list|,
name|extent_sn_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_state_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_zeroed_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
argument_list|)
expr_stmt|;
name|extent_rtree_leaf_elms_lookup
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
operator|&
name|lead
argument_list|,
name|false
argument_list|,
name|true
argument_list|,
operator|&
name|lead_elm_a
argument_list|,
operator|&
name|lead_elm_b
argument_list|)
expr_stmt|;
block|}
name|rtree_leaf_elm_t
modifier|*
name|trail_elm_a
decl_stmt|,
modifier|*
name|trail_elm_b
decl_stmt|;
name|extent_rtree_leaf_elms_lookup
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|trail
argument_list|,
name|false
argument_list|,
name|true
argument_list|,
operator|&
name|trail_elm_a
argument_list|,
operator|&
name|trail_elm_b
argument_list|)
expr_stmt|;
if|if
condition|(
name|lead_elm_a
operator|==
name|NULL
operator|||
name|lead_elm_b
operator|==
name|NULL
operator|||
name|trail_elm_a
operator|==
name|NULL
operator|||
name|trail_elm_b
operator|==
name|NULL
condition|)
block|{
goto|goto
name|label_error_b
goto|;
block|}
name|extent_lock2
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|trail
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
name|bool
name|err
init|=
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|split
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|size_a
operator|+
name|size_b
argument_list|,
name|size_a
argument_list|,
name|size_b
argument_list|,
name|extent_committed_get
argument_list|(
name|extent
argument_list|)
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|!=
operator|&
name|extent_hooks_default
condition|)
block|{
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
block|{
goto|goto
name|label_error_c
goto|;
block|}
name|extent_size_set
argument_list|(
name|extent
argument_list|,
name|size_a
argument_list|)
expr_stmt|;
name|extent_szind_set
argument_list|(
name|extent
argument_list|,
name|szind_a
argument_list|)
expr_stmt|;
name|extent_rtree_write_acquired
argument_list|(
name|tsdn
argument_list|,
name|lead_elm_a
argument_list|,
name|lead_elm_b
argument_list|,
name|extent
argument_list|,
name|szind_a
argument_list|,
name|slab_a
argument_list|)
expr_stmt|;
name|extent_rtree_write_acquired
argument_list|(
name|tsdn
argument_list|,
name|trail_elm_a
argument_list|,
name|trail_elm_b
argument_list|,
name|trail
argument_list|,
name|szind_b
argument_list|,
name|slab_b
argument_list|)
expr_stmt|;
name|extent_unlock2
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|trail
argument_list|)
expr_stmt|;
return|return
name|trail
return|;
name|label_error_c
label|:
name|extent_unlock2
argument_list|(
name|tsdn
argument_list|,
name|extent
argument_list|,
name|trail
argument_list|)
expr_stmt|;
name|label_error_b
label|:
name|extent_dalloc
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|trail
argument_list|)
expr_stmt|;
name|label_error_a
label|:
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|extent_t
modifier|*
name|extent_split_wrapper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|extent
parameter_list|,
name|size_t
name|size_a
parameter_list|,
name|szind_t
name|szind_a
parameter_list|,
name|bool
name|slab_a
parameter_list|,
name|size_t
name|size_b
parameter_list|,
name|szind_t
name|szind_b
parameter_list|,
name|bool
name|slab_b
parameter_list|)
block|{
return|return
name|extent_split_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|extent
argument_list|,
name|size_a
argument_list|,
name|szind_a
argument_list|,
name|slab_a
argument_list|,
name|size_b
argument_list|,
name|szind_b
argument_list|,
name|slab_b
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|extent_merge_default_impl
parameter_list|(
name|void
modifier|*
name|addr_a
parameter_list|,
name|void
modifier|*
name|addr_b
parameter_list|)
block|{
if|if
condition|(
operator|!
name|maps_coalesce
condition|)
block|{
return|return
name|true
return|;
block|}
if|if
condition|(
name|have_dss
operator|&&
operator|!
name|extent_dss_mergeable
argument_list|(
name|addr_a
argument_list|,
name|addr_b
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|JEMALLOC_MAPS_COALESCE
end_ifdef

begin_function
specifier|static
name|bool
name|extent_merge_default
parameter_list|(
name|extent_hooks_t
modifier|*
name|extent_hooks
parameter_list|,
name|void
modifier|*
name|addr_a
parameter_list|,
name|size_t
name|size_a
parameter_list|,
name|void
modifier|*
name|addr_b
parameter_list|,
name|size_t
name|size_b
parameter_list|,
name|bool
name|committed
parameter_list|,
name|unsigned
name|arena_ind
parameter_list|)
block|{
return|return
name|extent_merge_default_impl
argument_list|(
name|addr_a
argument_list|,
name|addr_b
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|bool
name|extent_merge_impl
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|a
parameter_list|,
name|extent_t
modifier|*
name|b
parameter_list|,
name|bool
name|growing_retained
parameter_list|)
block|{
name|witness_assert_depth_to_rank
argument_list|(
name|tsdn_witness_tsdp_get
argument_list|(
name|tsdn
argument_list|)
argument_list|,
name|WITNESS_RANK_CORE
argument_list|,
name|growing_retained
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|extent_hooks_assure_initialized
argument_list|(
name|arena
argument_list|,
name|r_extent_hooks
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|merge
operator|==
name|NULL
condition|)
block|{
return|return
name|true
return|;
block|}
name|bool
name|err
decl_stmt|;
if|if
condition|(
operator|*
name|r_extent_hooks
operator|==
operator|&
name|extent_hooks_default
condition|)
block|{
comment|/* Call directly to propagate tsdn. */
name|err
operator|=
name|extent_merge_default_impl
argument_list|(
name|extent_base_get
argument_list|(
name|a
argument_list|)
argument_list|,
name|extent_base_get
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|extent_hook_pre_reentrancy
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|err
operator|=
operator|(
operator|*
name|r_extent_hooks
operator|)
operator|->
name|merge
argument_list|(
operator|*
name|r_extent_hooks
argument_list|,
name|extent_base_get
argument_list|(
name|a
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|a
argument_list|)
argument_list|,
name|extent_base_get
argument_list|(
name|b
argument_list|)
argument_list|,
name|extent_size_get
argument_list|(
name|b
argument_list|)
argument_list|,
name|extent_committed_get
argument_list|(
name|a
argument_list|)
argument_list|,
name|arena_ind_get
argument_list|(
name|arena
argument_list|)
argument_list|)
expr_stmt|;
name|extent_hook_post_reentrancy
argument_list|(
name|tsdn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
block|{
return|return
name|true
return|;
block|}
comment|/* 	 * The rtree writes must happen while all the relevant elements are 	 * owned, so the following code uses decomposed helper functions rather 	 * than extent_{,de}register() to do things in the right order. 	 */
name|rtree_ctx_t
name|rtree_ctx_fallback
decl_stmt|;
name|rtree_ctx_t
modifier|*
name|rtree_ctx
init|=
name|tsdn_rtree_ctx
argument_list|(
name|tsdn
argument_list|,
operator|&
name|rtree_ctx_fallback
argument_list|)
decl_stmt|;
name|rtree_leaf_elm_t
modifier|*
name|a_elm_a
decl_stmt|,
modifier|*
name|a_elm_b
decl_stmt|,
modifier|*
name|b_elm_a
decl_stmt|,
modifier|*
name|b_elm_b
decl_stmt|;
name|extent_rtree_leaf_elms_lookup
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|a
argument_list|,
name|true
argument_list|,
name|false
argument_list|,
operator|&
name|a_elm_a
argument_list|,
operator|&
name|a_elm_b
argument_list|)
expr_stmt|;
name|extent_rtree_leaf_elms_lookup
argument_list|(
name|tsdn
argument_list|,
name|rtree_ctx
argument_list|,
name|b
argument_list|,
name|true
argument_list|,
name|false
argument_list|,
operator|&
name|b_elm_a
argument_list|,
operator|&
name|b_elm_b
argument_list|)
expr_stmt|;
name|extent_lock2
argument_list|(
name|tsdn
argument_list|,
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|a_elm_b
operator|!=
name|NULL
condition|)
block|{
name|rtree_leaf_elm_write
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|a_elm_b
argument_list|,
name|NULL
argument_list|,
name|NSIZES
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|b_elm_b
operator|!=
name|NULL
condition|)
block|{
name|rtree_leaf_elm_write
argument_list|(
name|tsdn
argument_list|,
operator|&
name|extents_rtree
argument_list|,
name|b_elm_a
argument_list|,
name|NULL
argument_list|,
name|NSIZES
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|b_elm_b
operator|=
name|b_elm_a
expr_stmt|;
block|}
name|extent_size_set
argument_list|(
name|a
argument_list|,
name|extent_size_get
argument_list|(
name|a
argument_list|)
operator|+
name|extent_size_get
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|extent_szind_set
argument_list|(
name|a
argument_list|,
name|NSIZES
argument_list|)
expr_stmt|;
name|extent_sn_set
argument_list|(
name|a
argument_list|,
operator|(
name|extent_sn_get
argument_list|(
name|a
argument_list|)
operator|<
name|extent_sn_get
argument_list|(
name|b
argument_list|)
operator|)
condition|?
name|extent_sn_get
argument_list|(
name|a
argument_list|)
else|:
name|extent_sn_get
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|extent_zeroed_set
argument_list|(
name|a
argument_list|,
name|extent_zeroed_get
argument_list|(
name|a
argument_list|)
operator|&&
name|extent_zeroed_get
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|extent_rtree_write_acquired
argument_list|(
name|tsdn
argument_list|,
name|a_elm_a
argument_list|,
name|b_elm_b
argument_list|,
name|a
argument_list|,
name|NSIZES
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|extent_unlock2
argument_list|(
name|tsdn
argument_list|,
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|extent_dalloc
argument_list|(
name|tsdn
argument_list|,
name|extent_arena_get
argument_list|(
name|b
argument_list|)
argument_list|,
name|b
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_function
name|bool
name|extent_merge_wrapper
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|extent_hooks_t
modifier|*
modifier|*
name|r_extent_hooks
parameter_list|,
name|extent_t
modifier|*
name|a
parameter_list|,
name|extent_t
modifier|*
name|b
parameter_list|)
block|{
return|return
name|extent_merge_impl
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|r_extent_hooks
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|extent_boot
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|rtree_new
argument_list|(
operator|&
name|extents_rtree
argument_list|,
name|true
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
if|if
condition|(
name|mutex_pool_init
argument_list|(
operator|&
name|extent_mutex_pool
argument_list|,
literal|"extent_mutex_pool"
argument_list|,
name|WITNESS_RANK_EXTENT_POOL
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
if|if
condition|(
name|have_dss
condition|)
block|{
name|extent_dss_boot
argument_list|()
expr_stmt|;
block|}
return|return
name|false
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_WITNESS_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_preamble.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal_includes.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/assert.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/malloc_io.h"
end_include

begin_function
name|void
name|witness_init
parameter_list|(
name|witness_t
modifier|*
name|witness
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|witness_rank_t
name|rank
parameter_list|,
name|witness_comp_t
modifier|*
name|comp
parameter_list|,
name|void
modifier|*
name|opaque
parameter_list|)
block|{
name|witness
operator|->
name|name
operator|=
name|name
expr_stmt|;
name|witness
operator|->
name|rank
operator|=
name|rank
expr_stmt|;
name|witness
operator|->
name|comp
operator|=
name|comp
expr_stmt|;
name|witness
operator|->
name|opaque
operator|=
name|opaque
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|witness_lock_error_impl
parameter_list|(
specifier|const
name|witness_list_t
modifier|*
name|witnesses
parameter_list|,
specifier|const
name|witness_t
modifier|*
name|witness
parameter_list|)
block|{
name|witness_t
modifier|*
name|w
decl_stmt|;
name|malloc_printf
argument_list|(
literal|"<jemalloc>: Lock rank order reversal:"
argument_list|)
expr_stmt|;
name|ql_foreach
argument_list|(
argument|w
argument_list|,
argument|witnesses
argument_list|,
argument|link
argument_list|)
block|{
name|malloc_printf
argument_list|(
literal|" %s(%u)"
argument_list|,
name|w
operator|->
name|name
argument_list|,
name|w
operator|->
name|rank
argument_list|)
expr_stmt|;
block|}
name|malloc_printf
argument_list|(
literal|" %s(%u)\n"
argument_list|,
name|witness
operator|->
name|name
argument_list|,
name|witness
operator|->
name|rank
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|witness_lock_error_t
modifier|*
name|JET_MUTABLE
name|witness_lock_error
init|=
name|witness_lock_error_impl
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|witness_owner_error_impl
parameter_list|(
specifier|const
name|witness_t
modifier|*
name|witness
parameter_list|)
block|{
name|malloc_printf
argument_list|(
literal|"<jemalloc>: Should own %s(%u)\n"
argument_list|,
name|witness
operator|->
name|name
argument_list|,
name|witness
operator|->
name|rank
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|witness_owner_error_t
modifier|*
name|JET_MUTABLE
name|witness_owner_error
init|=
name|witness_owner_error_impl
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|witness_not_owner_error_impl
parameter_list|(
specifier|const
name|witness_t
modifier|*
name|witness
parameter_list|)
block|{
name|malloc_printf
argument_list|(
literal|"<jemalloc>: Should not own %s(%u)\n"
argument_list|,
name|witness
operator|->
name|name
argument_list|,
name|witness
operator|->
name|rank
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|witness_not_owner_error_t
modifier|*
name|JET_MUTABLE
name|witness_not_owner_error
init|=
name|witness_not_owner_error_impl
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|witness_depth_error_impl
parameter_list|(
specifier|const
name|witness_list_t
modifier|*
name|witnesses
parameter_list|,
name|witness_rank_t
name|rank_inclusive
parameter_list|,
name|unsigned
name|depth
parameter_list|)
block|{
name|witness_t
modifier|*
name|w
decl_stmt|;
name|malloc_printf
argument_list|(
literal|"<jemalloc>: Should own %u lock%s of rank>= %u:"
argument_list|,
name|depth
argument_list|,
operator|(
name|depth
operator|!=
literal|1
operator|)
condition|?
literal|"s"
else|:
literal|""
argument_list|,
name|rank_inclusive
argument_list|)
expr_stmt|;
name|ql_foreach
argument_list|(
argument|w
argument_list|,
argument|witnesses
argument_list|,
argument|link
argument_list|)
block|{
name|malloc_printf
argument_list|(
literal|" %s(%u)"
argument_list|,
name|w
operator|->
name|name
argument_list|,
name|w
operator|->
name|rank
argument_list|)
expr_stmt|;
block|}
name|malloc_printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|witness_depth_error_t
modifier|*
name|JET_MUTABLE
name|witness_depth_error
init|=
name|witness_depth_error_impl
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|witnesses_cleanup
parameter_list|(
name|witness_tsd_t
modifier|*
name|witness_tsd
parameter_list|)
block|{
name|witness_assert_lockless
argument_list|(
name|witness_tsd_tsdn
argument_list|(
name|witness_tsd
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Do nothing. */
block|}
end_function

begin_function
name|void
name|witness_prefork
parameter_list|(
name|witness_tsd_t
modifier|*
name|witness_tsd
parameter_list|)
block|{
if|if
condition|(
operator|!
name|config_debug
condition|)
block|{
return|return;
block|}
name|witness_tsd
operator|->
name|forking
operator|=
name|true
expr_stmt|;
block|}
end_function

begin_function
name|void
name|witness_postfork_parent
parameter_list|(
name|witness_tsd_t
modifier|*
name|witness_tsd
parameter_list|)
block|{
if|if
condition|(
operator|!
name|config_debug
condition|)
block|{
return|return;
block|}
name|witness_tsd
operator|->
name|forking
operator|=
name|false
expr_stmt|;
block|}
end_function

begin_function
name|void
name|witness_postfork_child
parameter_list|(
name|witness_tsd_t
modifier|*
name|witness_tsd
parameter_list|)
block|{
if|if
condition|(
operator|!
name|config_debug
condition|)
block|{
return|return;
block|}
ifndef|#
directive|ifndef
name|JEMALLOC_MUTEX_INIT_CB
name|witness_list_t
modifier|*
name|witnesses
decl_stmt|;
name|witnesses
operator|=
operator|&
name|witness_tsd
operator|->
name|witnesses
expr_stmt|;
name|ql_new
argument_list|(
name|witnesses
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|witness_tsd
operator|->
name|forking
operator|=
name|false
expr_stmt|;
block|}
end_function

end_unit


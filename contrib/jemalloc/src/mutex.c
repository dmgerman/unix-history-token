begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_MUTEX_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|JEMALLOC_LAZY_LOCK
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
end_if

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|_CRT_SPINCOUNT
end_ifndef

begin_define
define|#
directive|define
name|_CRT_SPINCOUNT
value|4000
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|JEMALLOC_LAZY_LOCK
end_ifdef

begin_decl_stmt
name|bool
name|isthreaded
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|JEMALLOC_MUTEX_INIT_CB
end_ifdef

begin_decl_stmt
specifier|static
name|bool
name|postpone_init
init|=
name|true
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|malloc_mutex_t
modifier|*
name|postponed_mutexes
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|JEMALLOC_LAZY_LOCK
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
end_if

begin_function_decl
specifier|static
name|void
name|pthread_create_once
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*  * We intercept pthread_create() calls in order to toggle isthreaded if the  * process goes multi-threaded.  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|JEMALLOC_LAZY_LOCK
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
end_if

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|pthread_create_fptr
function_decl|)
parameter_list|(
name|pthread_t
modifier|*
name|__restrict
parameter_list|,
specifier|const
name|pthread_attr_t
modifier|*
parameter_list|,
name|void
modifier|*
function_decl|(
modifier|*
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|__restrict
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|pthread_create_once
parameter_list|(
name|void
parameter_list|)
block|{
name|pthread_create_fptr
operator|=
name|dlsym
argument_list|(
name|RTLD_NEXT
argument_list|,
literal|"pthread_create"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pthread_create_fptr
operator|==
name|NULL
condition|)
block|{
name|malloc_write
argument_list|(
literal|"<jemalloc>: Error in dlsym(RTLD_NEXT, "
literal|"\"pthread_create\")\n"
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
name|isthreaded
operator|=
name|true
expr_stmt|;
block|}
end_function

begin_function
name|JEMALLOC_EXPORT
name|int
name|pthread_create
parameter_list|(
name|pthread_t
modifier|*
name|__restrict
name|thread
parameter_list|,
specifier|const
name|pthread_attr_t
modifier|*
name|__restrict
name|attr
parameter_list|,
name|void
modifier|*
function_decl|(
modifier|*
name|start_routine
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|__restrict
name|arg
parameter_list|)
block|{
specifier|static
name|pthread_once_t
name|once_control
init|=
name|PTHREAD_ONCE_INIT
decl_stmt|;
name|pthread_once
argument_list|(
operator|&
name|once_control
argument_list|,
name|pthread_create_once
argument_list|)
expr_stmt|;
return|return
operator|(
name|pthread_create_fptr
argument_list|(
name|thread
argument_list|,
name|attr
argument_list|,
name|start_routine
argument_list|,
name|arg
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/******************************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|JEMALLOC_MUTEX_INIT_CB
end_ifdef

begin_function_decl
name|JEMALLOC_EXPORT
name|int
name|_pthread_mutex_init_calloc_cb
parameter_list|(
name|pthread_mutex_t
modifier|*
name|mutex
parameter_list|,
name|void
modifier|*
function_decl|(
name|calloc_cb
function_decl|)
parameter_list|(
name|size_t
parameter_list|,
name|size_t
parameter_list|)
parameter_list|)
function_decl|;
end_function_decl

begin_pragma
pragma|#
directive|pragma
name|weak
name|_pthread_mutex_init_calloc_cb
end_pragma

begin_function
name|int
name|_pthread_mutex_init_calloc_cb
parameter_list|(
name|pthread_mutex_t
modifier|*
name|mutex
parameter_list|,
name|void
modifier|*
function_decl|(
name|calloc_cb
function_decl|)
parameter_list|(
name|size_t
parameter_list|,
name|size_t
parameter_list|)
parameter_list|)
block|{
return|return
operator|(
operator|(
operator|(
name|int
argument_list|(
operator|*
argument_list|)
argument_list|(
name|pthread_mutex_t
operator|*
argument_list|,
name|void
operator|*
call|(
modifier|*
call|)
argument_list|(
name|size_t
argument_list|,
name|size_t
argument_list|)
argument_list|)
operator|)
name|__libc_interposing
index|[
name|INTERPOS__pthread_mutex_init_calloc_cb
index|]
operator|)
operator|(
name|mutex
operator|,
name|calloc_cb
operator|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|bool
name|malloc_mutex_init
parameter_list|(
name|malloc_mutex_t
modifier|*
name|mutex
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|_WIN32
if|if
condition|(
operator|!
name|InitializeCriticalSectionAndSpinCount
argument_list|(
operator|&
name|mutex
operator|->
name|lock
argument_list|,
name|_CRT_SPINCOUNT
argument_list|)
condition|)
return|return
operator|(
name|true
operator|)
return|;
elif|#
directive|elif
operator|(
name|defined
argument_list|(
name|JEMALLOC_OSSPIN
argument_list|)
operator|)
name|mutex
operator|->
name|lock
operator|=
literal|0
expr_stmt|;
elif|#
directive|elif
operator|(
name|defined
argument_list|(
name|JEMALLOC_MUTEX_INIT_CB
argument_list|)
operator|)
if|if
condition|(
name|postpone_init
condition|)
block|{
name|mutex
operator|->
name|postponed_next
operator|=
name|postponed_mutexes
expr_stmt|;
name|postponed_mutexes
operator|=
name|mutex
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|_pthread_mutex_init_calloc_cb
argument_list|(
operator|&
name|mutex
operator|->
name|lock
argument_list|,
name|base_calloc
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|true
operator|)
return|;
block|}
else|#
directive|else
name|pthread_mutexattr_t
name|attr
decl_stmt|;
if|if
condition|(
name|pthread_mutexattr_init
argument_list|(
operator|&
name|attr
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|pthread_mutexattr_settype
argument_list|(
operator|&
name|attr
argument_list|,
name|MALLOC_MUTEX_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pthread_mutex_init
argument_list|(
operator|&
name|mutex
operator|->
name|lock
argument_list|,
operator|&
name|attr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|pthread_mutexattr_destroy
argument_list|(
operator|&
name|attr
argument_list|)
expr_stmt|;
return|return
operator|(
name|true
operator|)
return|;
block|}
name|pthread_mutexattr_destroy
argument_list|(
operator|&
name|attr
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_function
name|void
name|malloc_mutex_prefork
parameter_list|(
name|malloc_mutex_t
modifier|*
name|mutex
parameter_list|)
block|{
name|malloc_mutex_lock
argument_list|(
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|malloc_mutex_postfork_parent
parameter_list|(
name|malloc_mutex_t
modifier|*
name|mutex
parameter_list|)
block|{
name|malloc_mutex_unlock
argument_list|(
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|malloc_mutex_postfork_child
parameter_list|(
name|malloc_mutex_t
modifier|*
name|mutex
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|JEMALLOC_MUTEX_INIT_CB
name|malloc_mutex_unlock
argument_list|(
name|mutex
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|malloc_mutex_init
argument_list|(
name|mutex
argument_list|)
condition|)
block|{
name|malloc_printf
argument_list|(
literal|"<jemalloc>: Error re-initializing mutex in "
literal|"child\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_abort
condition|)
name|abort
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
name|bool
name|malloc_mutex_first_thread
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|JEMALLOC_MUTEX_INIT_CB
name|postpone_init
operator|=
name|false
expr_stmt|;
while|while
condition|(
name|postponed_mutexes
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|_pthread_mutex_init_calloc_cb
argument_list|(
operator|&
name|postponed_mutexes
operator|->
name|lock
argument_list|,
name|base_calloc
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|postponed_mutexes
operator|=
name|postponed_mutexes
operator|->
name|postponed_next
expr_stmt|;
block|}
endif|#
directive|endif
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_function
name|bool
name|mutex_boot
parameter_list|(
name|void
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|JEMALLOC_MUTEX_INIT_CB
return|return
operator|(
name|malloc_mutex_first_thread
argument_list|()
operator|)
return|;
else|#
directive|else
return|return
operator|(
name|false
operator|)
return|;
endif|#
directive|endif
block|}
end_function

end_unit


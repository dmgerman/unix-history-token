begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_TCACHE_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal.h"
end_include

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_decl_stmt
name|bool
name|opt_tcache
init|=
name|true
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ssize_t
name|opt_lg_tcache_max
init|=
name|LG_TCACHE_MAXCLASS_DEFAULT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|tcache_bin_info_t
modifier|*
name|tcache_bin_info
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|stack_nelms
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Total stack elms per tcache. */
end_comment

begin_decl_stmt
name|unsigned
name|nhbins
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|tcache_maxclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|tcaches_t
modifier|*
name|tcaches
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Index of first element within tcaches that has never been used. */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|tcaches_past
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Head of singly linked list tracking available tcaches elements. */
end_comment

begin_decl_stmt
specifier|static
name|tcaches_t
modifier|*
name|tcaches_avail
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
name|size_t
name|tcache_salloc
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|)
block|{
return|return
operator|(
name|arena_salloc
argument_list|(
name|tsdn
argument_list|,
name|ptr
argument_list|,
name|false
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|tcache_event_hard
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|)
block|{
name|szind_t
name|binind
init|=
name|tcache
operator|->
name|next_gc_bin
decl_stmt|;
name|tcache_bin_t
modifier|*
name|tbin
init|=
operator|&
name|tcache
operator|->
name|tbins
index|[
name|binind
index|]
decl_stmt|;
name|tcache_bin_info_t
modifier|*
name|tbin_info
init|=
operator|&
name|tcache_bin_info
index|[
name|binind
index|]
decl_stmt|;
if|if
condition|(
name|tbin
operator|->
name|low_water
operator|>
literal|0
condition|)
block|{
comment|/* 		 * Flush (ceiling) 3/4 of the objects below the low water mark. 		 */
if|if
condition|(
name|binind
operator|<
name|NBINS
condition|)
block|{
name|tcache_bin_flush_small
argument_list|(
name|tsd
argument_list|,
name|tcache
argument_list|,
name|tbin
argument_list|,
name|binind
argument_list|,
name|tbin
operator|->
name|ncached
operator|-
name|tbin
operator|->
name|low_water
operator|+
operator|(
name|tbin
operator|->
name|low_water
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tcache_bin_flush_large
argument_list|(
name|tsd
argument_list|,
name|tbin
argument_list|,
name|binind
argument_list|,
name|tbin
operator|->
name|ncached
operator|-
name|tbin
operator|->
name|low_water
operator|+
operator|(
name|tbin
operator|->
name|low_water
operator|>>
literal|2
operator|)
argument_list|,
name|tcache
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Reduce fill count by 2X.  Limit lg_fill_div such that the 		 * fill count is always at least 1. 		 */
if|if
condition|(
operator|(
name|tbin_info
operator|->
name|ncached_max
operator|>>
operator|(
name|tbin
operator|->
name|lg_fill_div
operator|+
literal|1
operator|)
operator|)
operator|>=
literal|1
condition|)
name|tbin
operator|->
name|lg_fill_div
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tbin
operator|->
name|low_water
operator|<
literal|0
condition|)
block|{
comment|/* 		 * Increase fill count by 2X.  Make sure lg_fill_div stays 		 * greater than 0. 		 */
if|if
condition|(
name|tbin
operator|->
name|lg_fill_div
operator|>
literal|1
condition|)
name|tbin
operator|->
name|lg_fill_div
operator|--
expr_stmt|;
block|}
name|tbin
operator|->
name|low_water
operator|=
name|tbin
operator|->
name|ncached
expr_stmt|;
name|tcache
operator|->
name|next_gc_bin
operator|++
expr_stmt|;
if|if
condition|(
name|tcache
operator|->
name|next_gc_bin
operator|==
name|nhbins
condition|)
name|tcache
operator|->
name|next_gc_bin
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
modifier|*
name|tcache_alloc_small_hard
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|,
name|tcache_bin_t
modifier|*
name|tbin
parameter_list|,
name|szind_t
name|binind
parameter_list|,
name|bool
modifier|*
name|tcache_success
parameter_list|)
block|{
name|void
modifier|*
name|ret
decl_stmt|;
name|arena_tcache_fill_small
argument_list|(
name|tsdn
argument_list|,
name|arena
argument_list|,
name|tbin
argument_list|,
name|binind
argument_list|,
name|config_prof
condition|?
name|tcache
operator|->
name|prof_accumbytes
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_prof
condition|)
name|tcache
operator|->
name|prof_accumbytes
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|tcache_alloc_easy
argument_list|(
name|tbin
argument_list|,
name|tcache_success
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|tcache_bin_flush_small
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|,
name|tcache_bin_t
modifier|*
name|tbin
parameter_list|,
name|szind_t
name|binind
parameter_list|,
name|unsigned
name|rem
parameter_list|)
block|{
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|nflush
decl_stmt|,
name|ndeferred
decl_stmt|;
name|bool
name|merged_stats
init|=
name|false
decl_stmt|;
name|assert
argument_list|(
name|binind
operator|<
name|NBINS
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rem
operator|<=
name|tbin
operator|->
name|ncached
argument_list|)
expr_stmt|;
name|arena
operator|=
name|arena_choose
argument_list|(
name|tsd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|arena
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|nflush
operator|=
name|tbin
operator|->
name|ncached
operator|-
name|rem
init|;
name|nflush
operator|>
literal|0
condition|;
name|nflush
operator|=
name|ndeferred
control|)
block|{
comment|/* Lock the arena bin associated with the first object. */
name|arena_chunk_t
modifier|*
name|chunk
init|=
operator|(
name|arena_chunk_t
operator|*
operator|)
name|CHUNK_ADDR2BASE
argument_list|(
operator|*
operator|(
name|tbin
operator|->
name|avail
operator|-
literal|1
operator|)
argument_list|)
decl_stmt|;
name|arena_t
modifier|*
name|bin_arena
init|=
name|extent_node_arena_get
argument_list|(
operator|&
name|chunk
operator|->
name|node
argument_list|)
decl_stmt|;
name|arena_bin_t
modifier|*
name|bin
init|=
operator|&
name|bin_arena
operator|->
name|bins
index|[
name|binind
index|]
decl_stmt|;
if|if
condition|(
name|config_prof
operator|&&
name|bin_arena
operator|==
name|arena
condition|)
block|{
if|if
condition|(
name|arena_prof_accum
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena
argument_list|,
name|tcache
operator|->
name|prof_accumbytes
argument_list|)
condition|)
name|prof_idump
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|)
expr_stmt|;
name|tcache
operator|->
name|prof_accumbytes
operator|=
literal|0
expr_stmt|;
block|}
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|bin
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_stats
operator|&&
name|bin_arena
operator|==
name|arena
condition|)
block|{
name|assert
argument_list|(
operator|!
name|merged_stats
argument_list|)
expr_stmt|;
name|merged_stats
operator|=
name|true
expr_stmt|;
name|bin
operator|->
name|stats
operator|.
name|nflushes
operator|++
expr_stmt|;
name|bin
operator|->
name|stats
operator|.
name|nrequests
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
operator|=
literal|0
expr_stmt|;
block|}
name|ndeferred
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nflush
condition|;
name|i
operator|++
control|)
block|{
name|ptr
operator|=
operator|*
operator|(
name|tbin
operator|->
name|avail
operator|-
literal|1
operator|-
name|i
operator|)
expr_stmt|;
name|assert
argument_list|(
name|ptr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|chunk
operator|=
operator|(
name|arena_chunk_t
operator|*
operator|)
name|CHUNK_ADDR2BASE
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_node_arena_get
argument_list|(
operator|&
name|chunk
operator|->
name|node
argument_list|)
operator|==
name|bin_arena
condition|)
block|{
name|size_t
name|pageind
init|=
operator|(
operator|(
name|uintptr_t
operator|)
name|ptr
operator|-
operator|(
name|uintptr_t
operator|)
name|chunk
operator|)
operator|>>
name|LG_PAGE
decl_stmt|;
name|arena_chunk_map_bits_t
modifier|*
name|bitselm
init|=
name|arena_bitselm_get_mutable
argument_list|(
name|chunk
argument_list|,
name|pageind
argument_list|)
decl_stmt|;
name|arena_dalloc_bin_junked_locked
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|bin_arena
argument_list|,
name|chunk
argument_list|,
name|ptr
argument_list|,
name|bitselm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * This object was allocated via a different 				 * arena bin than the one that is currently 				 * locked.  Stash the object, so that it can be 				 * handled in a future pass. 				 */
operator|*
operator|(
name|tbin
operator|->
name|avail
operator|-
literal|1
operator|-
name|ndeferred
operator|)
operator|=
name|ptr
expr_stmt|;
name|ndeferred
operator|++
expr_stmt|;
block|}
block|}
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|bin
operator|->
name|lock
argument_list|)
expr_stmt|;
name|arena_decay_ticks
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|bin_arena
argument_list|,
name|nflush
operator|-
name|ndeferred
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config_stats
operator|&&
operator|!
name|merged_stats
condition|)
block|{
comment|/* 		 * The flush loop didn't happen to flush to this thread's 		 * arena, so the stats didn't get merged.  Manually do so now. 		 */
name|arena_bin_t
modifier|*
name|bin
init|=
operator|&
name|arena
operator|->
name|bins
index|[
name|binind
index|]
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|bin
operator|->
name|lock
argument_list|)
expr_stmt|;
name|bin
operator|->
name|stats
operator|.
name|nflushes
operator|++
expr_stmt|;
name|bin
operator|->
name|stats
operator|.
name|nrequests
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
operator|=
literal|0
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|bin
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|memmove
argument_list|(
name|tbin
operator|->
name|avail
operator|-
name|rem
argument_list|,
name|tbin
operator|->
name|avail
operator|-
name|tbin
operator|->
name|ncached
argument_list|,
name|rem
operator|*
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|tbin
operator|->
name|ncached
operator|=
name|rem
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|tbin
operator|->
name|ncached
operator|<
name|tbin
operator|->
name|low_water
condition|)
name|tbin
operator|->
name|low_water
operator|=
name|tbin
operator|->
name|ncached
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tcache_bin_flush_large
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|tcache_bin_t
modifier|*
name|tbin
parameter_list|,
name|szind_t
name|binind
parameter_list|,
name|unsigned
name|rem
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|)
block|{
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|nflush
decl_stmt|,
name|ndeferred
decl_stmt|;
name|bool
name|merged_stats
init|=
name|false
decl_stmt|;
name|assert
argument_list|(
name|binind
operator|<
name|nhbins
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|rem
operator|<=
name|tbin
operator|->
name|ncached
argument_list|)
expr_stmt|;
name|arena
operator|=
name|arena_choose
argument_list|(
name|tsd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|arena
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|nflush
operator|=
name|tbin
operator|->
name|ncached
operator|-
name|rem
init|;
name|nflush
operator|>
literal|0
condition|;
name|nflush
operator|=
name|ndeferred
control|)
block|{
comment|/* Lock the arena associated with the first object. */
name|arena_chunk_t
modifier|*
name|chunk
init|=
operator|(
name|arena_chunk_t
operator|*
operator|)
name|CHUNK_ADDR2BASE
argument_list|(
operator|*
operator|(
name|tbin
operator|->
name|avail
operator|-
literal|1
operator|)
argument_list|)
decl_stmt|;
name|arena_t
modifier|*
name|locked_arena
init|=
name|extent_node_arena_get
argument_list|(
operator|&
name|chunk
operator|->
name|node
argument_list|)
decl_stmt|;
name|UNUSED
name|bool
name|idump
decl_stmt|;
if|if
condition|(
name|config_prof
condition|)
name|idump
operator|=
name|false
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|locked_arena
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|config_prof
operator|||
name|config_stats
operator|)
operator|&&
name|locked_arena
operator|==
name|arena
condition|)
block|{
if|if
condition|(
name|config_prof
condition|)
block|{
name|idump
operator|=
name|arena_prof_accum_locked
argument_list|(
name|arena
argument_list|,
name|tcache
operator|->
name|prof_accumbytes
argument_list|)
expr_stmt|;
name|tcache
operator|->
name|prof_accumbytes
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|config_stats
condition|)
block|{
name|merged_stats
operator|=
name|true
expr_stmt|;
name|arena
operator|->
name|stats
operator|.
name|nrequests_large
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|arena
operator|->
name|stats
operator|.
name|lstats
index|[
name|binind
operator|-
name|NBINS
index|]
operator|.
name|nrequests
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|ndeferred
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nflush
condition|;
name|i
operator|++
control|)
block|{
name|ptr
operator|=
operator|*
operator|(
name|tbin
operator|->
name|avail
operator|-
literal|1
operator|-
name|i
operator|)
expr_stmt|;
name|assert
argument_list|(
name|ptr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|chunk
operator|=
operator|(
name|arena_chunk_t
operator|*
operator|)
name|CHUNK_ADDR2BASE
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|extent_node_arena_get
argument_list|(
operator|&
name|chunk
operator|->
name|node
argument_list|)
operator|==
name|locked_arena
condition|)
block|{
name|arena_dalloc_large_junked_locked
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|locked_arena
argument_list|,
name|chunk
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * This object was allocated via a different 				 * arena than the one that is currently locked. 				 * Stash the object, so that it can be handled 				 * in a future pass. 				 */
operator|*
operator|(
name|tbin
operator|->
name|avail
operator|-
literal|1
operator|-
name|ndeferred
operator|)
operator|=
name|ptr
expr_stmt|;
name|ndeferred
operator|++
expr_stmt|;
block|}
block|}
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|locked_arena
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_prof
operator|&&
name|idump
condition|)
name|prof_idump
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|)
expr_stmt|;
name|arena_decay_ticks
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|locked_arena
argument_list|,
name|nflush
operator|-
name|ndeferred
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config_stats
operator|&&
operator|!
name|merged_stats
condition|)
block|{
comment|/* 		 * The flush loop didn't happen to flush to this thread's 		 * arena, so the stats didn't get merged.  Manually do so now. 		 */
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|arena
operator|->
name|lock
argument_list|)
expr_stmt|;
name|arena
operator|->
name|stats
operator|.
name|nrequests_large
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|arena
operator|->
name|stats
operator|.
name|lstats
index|[
name|binind
operator|-
name|NBINS
index|]
operator|.
name|nrequests
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
operator|=
literal|0
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|arena
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|memmove
argument_list|(
name|tbin
operator|->
name|avail
operator|-
name|rem
argument_list|,
name|tbin
operator|->
name|avail
operator|-
name|tbin
operator|->
name|ncached
argument_list|,
name|rem
operator|*
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|tbin
operator|->
name|ncached
operator|=
name|rem
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|tbin
operator|->
name|ncached
operator|<
name|tbin
operator|->
name|low_water
condition|)
name|tbin
operator|->
name|low_water
operator|=
name|tbin
operator|->
name|ncached
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tcache_arena_associate
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|)
block|{
if|if
condition|(
name|config_stats
condition|)
block|{
comment|/* Link into list of extant tcaches. */
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ql_elm_new
argument_list|(
name|tcache
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|ql_tail_insert
argument_list|(
operator|&
name|arena
operator|->
name|tcache_ql
argument_list|,
name|tcache
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|tcache_arena_dissociate
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|)
block|{
if|if
condition|(
name|config_stats
condition|)
block|{
comment|/* Unlink from list of extant tcaches. */
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_debug
condition|)
block|{
name|bool
name|in_ql
init|=
name|false
decl_stmt|;
name|tcache_t
modifier|*
name|iter
decl_stmt|;
name|ql_foreach
argument_list|(
argument|iter
argument_list|,
argument|&arena->tcache_ql
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|iter
operator|==
name|tcache
condition|)
block|{
name|in_ql
operator|=
name|true
expr_stmt|;
break|break;
block|}
block|}
name|assert
argument_list|(
name|in_ql
argument_list|)
expr_stmt|;
block|}
name|ql_remove
argument_list|(
operator|&
name|arena
operator|->
name|tcache_ql
argument_list|,
name|tcache
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|tcache_stats_merge
argument_list|(
name|tsdn
argument_list|,
name|tcache
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|tcache_arena_reassociate
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|,
name|arena_t
modifier|*
name|oldarena
parameter_list|,
name|arena_t
modifier|*
name|newarena
parameter_list|)
block|{
name|tcache_arena_dissociate
argument_list|(
name|tsdn
argument_list|,
name|tcache
argument_list|,
name|oldarena
argument_list|)
expr_stmt|;
name|tcache_arena_associate
argument_list|(
name|tsdn
argument_list|,
name|tcache
argument_list|,
name|newarena
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|tcache_t
modifier|*
name|tcache_get_hard
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|)
block|{
name|arena_t
modifier|*
name|arena
decl_stmt|;
if|if
condition|(
operator|!
name|tcache_enabled_get
argument_list|()
condition|)
block|{
if|if
condition|(
name|tsd_nominal
argument_list|(
name|tsd
argument_list|)
condition|)
name|tcache_enabled_set
argument_list|(
name|false
argument_list|)
expr_stmt|;
comment|/* Memoize. */
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|arena
operator|=
name|arena_choose
argument_list|(
name|tsd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|arena
operator|==
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|tcache_create
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|tcache_t
modifier|*
name|tcache_create
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|)
block|{
name|tcache_t
modifier|*
name|tcache
decl_stmt|;
name|size_t
name|size
decl_stmt|,
name|stack_offset
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|size
operator|=
name|offsetof
argument_list|(
name|tcache_t
argument_list|,
name|tbins
argument_list|)
operator|+
operator|(
sizeof|sizeof
argument_list|(
name|tcache_bin_t
argument_list|)
operator|*
name|nhbins
operator|)
expr_stmt|;
comment|/* Naturally align the pointer stacks. */
name|size
operator|=
name|PTR_CEILING
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|stack_offset
operator|=
name|size
expr_stmt|;
name|size
operator|+=
name|stack_nelms
operator|*
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
comment|/* Avoid false cacheline sharing. */
name|size
operator|=
name|sa2u
argument_list|(
name|size
argument_list|,
name|CACHELINE
argument_list|)
expr_stmt|;
name|tcache
operator|=
name|ipallocztm
argument_list|(
name|tsdn
argument_list|,
name|size
argument_list|,
name|CACHELINE
argument_list|,
name|true
argument_list|,
name|NULL
argument_list|,
name|true
argument_list|,
name|arena_get
argument_list|(
name|TSDN_NULL
argument_list|,
literal|0
argument_list|,
name|true
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcache
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|tcache_arena_associate
argument_list|(
name|tsdn
argument_list|,
name|tcache
argument_list|,
name|arena
argument_list|)
expr_stmt|;
name|ticker_init
argument_list|(
operator|&
name|tcache
operator|->
name|gc_ticker
argument_list|,
name|TCACHE_GC_INCR
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|TCACHE_NSLOTS_SMALL_MAX
operator|&
literal|1U
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nhbins
condition|;
name|i
operator|++
control|)
block|{
name|tcache
operator|->
name|tbins
index|[
name|i
index|]
operator|.
name|lg_fill_div
operator|=
literal|1
expr_stmt|;
name|stack_offset
operator|+=
name|tcache_bin_info
index|[
name|i
index|]
operator|.
name|ncached_max
operator|*
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
expr_stmt|;
comment|/* 		 * avail points past the available space.  Allocations will 		 * access the slots toward higher addresses (for the benefit of 		 * prefetch). 		 */
name|tcache
operator|->
name|tbins
index|[
name|i
index|]
operator|.
name|avail
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|tcache
operator|+
operator|(
name|uintptr_t
operator|)
name|stack_offset
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|tcache
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tcache_destroy
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|)
block|{
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|arena
operator|=
name|arena_choose
argument_list|(
name|tsd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|tcache_arena_dissociate
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|tcache
argument_list|,
name|arena
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBINS
condition|;
name|i
operator|++
control|)
block|{
name|tcache_bin_t
modifier|*
name|tbin
init|=
operator|&
name|tcache
operator|->
name|tbins
index|[
name|i
index|]
decl_stmt|;
name|tcache_bin_flush_small
argument_list|(
name|tsd
argument_list|,
name|tcache
argument_list|,
name|tbin
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_stats
operator|&&
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
operator|!=
literal|0
condition|)
block|{
name|arena_bin_t
modifier|*
name|bin
init|=
operator|&
name|arena
operator|->
name|bins
index|[
name|i
index|]
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|bin
operator|->
name|lock
argument_list|)
expr_stmt|;
name|bin
operator|->
name|stats
operator|.
name|nrequests
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|bin
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
init|;
name|i
operator|<
name|nhbins
condition|;
name|i
operator|++
control|)
block|{
name|tcache_bin_t
modifier|*
name|tbin
init|=
operator|&
name|tcache
operator|->
name|tbins
index|[
name|i
index|]
decl_stmt|;
name|tcache_bin_flush_large
argument_list|(
name|tsd
argument_list|,
name|tbin
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
name|tcache
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_stats
operator|&&
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
operator|!=
literal|0
condition|)
block|{
name|malloc_mutex_lock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|arena
operator|->
name|lock
argument_list|)
expr_stmt|;
name|arena
operator|->
name|stats
operator|.
name|nrequests_large
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|arena
operator|->
name|stats
operator|.
name|lstats
index|[
name|i
operator|-
name|NBINS
index|]
operator|.
name|nrequests
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
operator|&
name|arena
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|config_prof
operator|&&
name|tcache
operator|->
name|prof_accumbytes
operator|>
literal|0
operator|&&
name|arena_prof_accum
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena
argument_list|,
name|tcache
operator|->
name|prof_accumbytes
argument_list|)
condition|)
name|prof_idump
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|)
expr_stmt|;
name|idalloctm
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|tcache
argument_list|,
name|NULL
argument_list|,
name|true
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tcache_cleanup
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|)
block|{
name|tcache_t
modifier|*
name|tcache
decl_stmt|;
if|if
condition|(
operator|!
name|config_tcache
condition|)
return|return;
if|if
condition|(
operator|(
name|tcache
operator|=
name|tsd_tcache_get
argument_list|(
name|tsd
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|tcache_destroy
argument_list|(
name|tsd
argument_list|,
name|tcache
argument_list|)
expr_stmt|;
name|tsd_tcache_set
argument_list|(
name|tsd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|tcache_enabled_cleanup
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|)
block|{
comment|/* Do nothing. */
block|}
end_function

begin_function
name|void
name|tcache_stats_merge
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|,
name|tcache_t
modifier|*
name|tcache
parameter_list|,
name|arena_t
modifier|*
name|arena
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|cassert
argument_list|(
name|config_stats
argument_list|)
expr_stmt|;
name|malloc_mutex_assert_owner
argument_list|(
name|tsdn
argument_list|,
operator|&
name|arena
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* Merge and reset tcache stats. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBINS
condition|;
name|i
operator|++
control|)
block|{
name|arena_bin_t
modifier|*
name|bin
init|=
operator|&
name|arena
operator|->
name|bins
index|[
name|i
index|]
decl_stmt|;
name|tcache_bin_t
modifier|*
name|tbin
init|=
operator|&
name|tcache
operator|->
name|tbins
index|[
name|i
index|]
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|bin
operator|->
name|lock
argument_list|)
expr_stmt|;
name|bin
operator|->
name|stats
operator|.
name|nrequests
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
name|tsdn
argument_list|,
operator|&
name|bin
operator|->
name|lock
argument_list|)
expr_stmt|;
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
name|nhbins
condition|;
name|i
operator|++
control|)
block|{
name|malloc_large_stats_t
modifier|*
name|lstats
init|=
operator|&
name|arena
operator|->
name|stats
operator|.
name|lstats
index|[
name|i
operator|-
name|NBINS
index|]
decl_stmt|;
name|tcache_bin_t
modifier|*
name|tbin
init|=
operator|&
name|tcache
operator|->
name|tbins
index|[
name|i
index|]
decl_stmt|;
name|arena
operator|->
name|stats
operator|.
name|nrequests_large
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|lstats
operator|->
name|nrequests
operator|+=
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
expr_stmt|;
name|tbin
operator|->
name|tstats
operator|.
name|nrequests
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|bool
name|tcaches_create
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|unsigned
modifier|*
name|r_ind
parameter_list|)
block|{
name|arena_t
modifier|*
name|arena
decl_stmt|;
name|tcache_t
modifier|*
name|tcache
decl_stmt|;
name|tcaches_t
modifier|*
name|elm
decl_stmt|;
if|if
condition|(
name|tcaches
operator|==
name|NULL
condition|)
block|{
name|tcaches
operator|=
name|base_alloc
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|tcache_t
operator|*
argument_list|)
operator|*
operator|(
name|MALLOCX_TCACHE_MAX
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcaches
operator|==
name|NULL
condition|)
return|return
operator|(
name|true
operator|)
return|;
block|}
if|if
condition|(
name|tcaches_avail
operator|==
name|NULL
operator|&&
name|tcaches_past
operator|>
name|MALLOCX_TCACHE_MAX
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|arena
operator|=
name|arena_ichoose
argument_list|(
name|tsd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|arena
operator|==
name|NULL
argument_list|)
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|tcache
operator|=
name|tcache_create
argument_list|(
name|tsd_tsdn
argument_list|(
name|tsd
argument_list|)
argument_list|,
name|arena
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcache
operator|==
name|NULL
condition|)
return|return
operator|(
name|true
operator|)
return|;
if|if
condition|(
name|tcaches_avail
operator|!=
name|NULL
condition|)
block|{
name|elm
operator|=
name|tcaches_avail
expr_stmt|;
name|tcaches_avail
operator|=
name|tcaches_avail
operator|->
name|next
expr_stmt|;
name|elm
operator|->
name|tcache
operator|=
name|tcache
expr_stmt|;
operator|*
name|r_ind
operator|=
call|(
name|unsigned
call|)
argument_list|(
name|elm
operator|-
name|tcaches
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|elm
operator|=
operator|&
name|tcaches
index|[
name|tcaches_past
index|]
expr_stmt|;
name|elm
operator|->
name|tcache
operator|=
name|tcache
expr_stmt|;
operator|*
name|r_ind
operator|=
name|tcaches_past
expr_stmt|;
name|tcaches_past
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tcaches_elm_flush
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|tcaches_t
modifier|*
name|elm
parameter_list|)
block|{
if|if
condition|(
name|elm
operator|->
name|tcache
operator|==
name|NULL
condition|)
return|return;
name|tcache_destroy
argument_list|(
name|tsd
argument_list|,
name|elm
operator|->
name|tcache
argument_list|)
expr_stmt|;
name|elm
operator|->
name|tcache
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tcaches_flush
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|unsigned
name|ind
parameter_list|)
block|{
name|tcaches_elm_flush
argument_list|(
name|tsd
argument_list|,
operator|&
name|tcaches
index|[
name|ind
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tcaches_destroy
parameter_list|(
name|tsd_t
modifier|*
name|tsd
parameter_list|,
name|unsigned
name|ind
parameter_list|)
block|{
name|tcaches_t
modifier|*
name|elm
init|=
operator|&
name|tcaches
index|[
name|ind
index|]
decl_stmt|;
name|tcaches_elm_flush
argument_list|(
name|tsd
argument_list|,
name|elm
argument_list|)
expr_stmt|;
name|elm
operator|->
name|next
operator|=
name|tcaches_avail
expr_stmt|;
name|tcaches_avail
operator|=
name|elm
expr_stmt|;
block|}
end_function

begin_function
name|bool
name|tcache_boot
parameter_list|(
name|tsdn_t
modifier|*
name|tsdn
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
comment|/* 	 * If necessary, clamp opt_lg_tcache_max, now that large_maxclass is 	 * known. 	 */
if|if
condition|(
name|opt_lg_tcache_max
operator|<
literal|0
operator|||
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|opt_lg_tcache_max
operator|)
operator|<
name|SMALL_MAXCLASS
condition|)
name|tcache_maxclass
operator|=
name|SMALL_MAXCLASS
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|opt_lg_tcache_max
operator|)
operator|>
name|large_maxclass
condition|)
name|tcache_maxclass
operator|=
name|large_maxclass
expr_stmt|;
else|else
name|tcache_maxclass
operator|=
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|opt_lg_tcache_max
operator|)
expr_stmt|;
name|nhbins
operator|=
name|size2index
argument_list|(
name|tcache_maxclass
argument_list|)
operator|+
literal|1
expr_stmt|;
comment|/* Initialize tcache_bin_info. */
name|tcache_bin_info
operator|=
operator|(
name|tcache_bin_info_t
operator|*
operator|)
name|base_alloc
argument_list|(
name|tsdn
argument_list|,
name|nhbins
operator|*
sizeof|sizeof
argument_list|(
name|tcache_bin_info_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcache_bin_info
operator|==
name|NULL
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|stack_nelms
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NBINS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|arena_bin_info
index|[
name|i
index|]
operator|.
name|nregs
operator|<<
literal|1
operator|)
operator|<=
name|TCACHE_NSLOTS_SMALL_MIN
condition|)
block|{
name|tcache_bin_info
index|[
name|i
index|]
operator|.
name|ncached_max
operator|=
name|TCACHE_NSLOTS_SMALL_MIN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|arena_bin_info
index|[
name|i
index|]
operator|.
name|nregs
operator|<<
literal|1
operator|)
operator|<=
name|TCACHE_NSLOTS_SMALL_MAX
condition|)
block|{
name|tcache_bin_info
index|[
name|i
index|]
operator|.
name|ncached_max
operator|=
operator|(
name|arena_bin_info
index|[
name|i
index|]
operator|.
name|nregs
operator|<<
literal|1
operator|)
expr_stmt|;
block|}
else|else
block|{
name|tcache_bin_info
index|[
name|i
index|]
operator|.
name|ncached_max
operator|=
name|TCACHE_NSLOTS_SMALL_MAX
expr_stmt|;
block|}
name|stack_nelms
operator|+=
name|tcache_bin_info
index|[
name|i
index|]
operator|.
name|ncached_max
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
name|nhbins
condition|;
name|i
operator|++
control|)
block|{
name|tcache_bin_info
index|[
name|i
index|]
operator|.
name|ncached_max
operator|=
name|TCACHE_NSLOTS_LARGE
expr_stmt|;
name|stack_nelms
operator|+=
name|tcache_bin_info
index|[
name|i
index|]
operator|.
name|ncached_max
expr_stmt|;
block|}
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

end_unit


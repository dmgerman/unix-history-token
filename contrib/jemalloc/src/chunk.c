begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_CHUNK_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal.h"
end_include

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_decl_stmt
name|size_t
name|opt_lg_chunk
init|=
name|LG_CHUNK_DEFAULT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|malloc_mutex_t
name|chunks_mtx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|chunk_stats_t
name|stats_chunks
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Trees of chunks that were previously allocated (trees differ only in node  * ordering).  These are used when allocating chunks, in an attempt to re-use  * address space.  Depending on function, different tree orderings are needed,  * which is why there are two trees with the same contents.  */
end_comment

begin_decl_stmt
specifier|static
name|extent_tree_t
name|chunks_szad
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|extent_tree_t
name|chunks_ad
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|rtree_t
modifier|*
name|chunks_rtree
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Various chunk-related settings. */
end_comment

begin_decl_stmt
name|size_t
name|chunksize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|chunksize_mask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* (chunksize - 1). */
end_comment

begin_decl_stmt
name|size_t
name|chunk_npages
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|map_bias
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|arena_maxclass
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Max size class for arenas. */
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Function prototypes for non-inline static functions. */
end_comment

begin_function_decl
specifier|static
name|void
modifier|*
name|chunk_recycle
parameter_list|(
name|size_t
name|size
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|chunk_record
parameter_list|(
name|void
modifier|*
name|chunk
parameter_list|,
name|size_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|void
modifier|*
name|chunk_recycle
parameter_list|(
name|size_t
name|size
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|)
block|{
name|void
modifier|*
name|ret
decl_stmt|;
name|extent_node_t
modifier|*
name|node
decl_stmt|;
name|extent_node_t
name|key
decl_stmt|;
name|size_t
name|alloc_size
decl_stmt|,
name|leadsize
decl_stmt|,
name|trailsize
decl_stmt|;
name|alloc_size
operator|=
name|size
operator|+
name|alignment
operator|-
name|chunksize
expr_stmt|;
comment|/* Beware size_t wrap-around. */
if|if
condition|(
name|alloc_size
operator|<
name|size
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|key
operator|.
name|addr
operator|=
name|NULL
expr_stmt|;
name|key
operator|.
name|size
operator|=
name|alloc_size
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
name|node
operator|=
name|extent_tree_szad_nsearch
argument_list|(
operator|&
name|chunks_szad
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|malloc_mutex_unlock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|leadsize
operator|=
name|ALIGNMENT_CEILING
argument_list|(
operator|(
name|uintptr_t
operator|)
name|node
operator|->
name|addr
argument_list|,
name|alignment
argument_list|)
operator|-
operator|(
name|uintptr_t
operator|)
name|node
operator|->
name|addr
expr_stmt|;
name|assert
argument_list|(
name|alloc_size
operator|>=
name|leadsize
operator|+
name|size
argument_list|)
expr_stmt|;
name|trailsize
operator|=
name|alloc_size
operator|-
name|leadsize
operator|-
name|size
expr_stmt|;
name|ret
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|node
operator|->
name|addr
operator|+
name|leadsize
operator|)
expr_stmt|;
comment|/* Remove node from the tree. */
name|extent_tree_szad_remove
argument_list|(
operator|&
name|chunks_szad
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|extent_tree_ad_remove
argument_list|(
operator|&
name|chunks_ad
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|leadsize
operator|!=
literal|0
condition|)
block|{
comment|/* Insert the leading space as a smaller chunk. */
name|node
operator|->
name|size
operator|=
name|leadsize
expr_stmt|;
name|extent_tree_szad_insert
argument_list|(
operator|&
name|chunks_szad
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|extent_tree_ad_insert
argument_list|(
operator|&
name|chunks_ad
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|trailsize
operator|!=
literal|0
condition|)
block|{
comment|/* Insert the trailing space as a smaller chunk. */
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * An additional node is required, but 			 * base_node_alloc() can cause a new base chunk to be 			 * allocated.  Drop chunks_mtx in order to avoid 			 * deadlock, and if node allocation fails, deallocate 			 * the result before returning an error. 			 */
name|malloc_mutex_unlock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
name|node
operator|=
name|base_node_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|chunk_dealloc
argument_list|(
name|ret
argument_list|,
name|size
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|malloc_mutex_lock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
block|}
name|node
operator|->
name|addr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
call|(
name|uintptr_t
call|)
argument_list|(
name|ret
argument_list|)
operator|+
name|size
operator|)
expr_stmt|;
name|node
operator|->
name|size
operator|=
name|trailsize
expr_stmt|;
name|extent_tree_szad_insert
argument_list|(
operator|&
name|chunks_szad
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|extent_tree_ad_insert
argument_list|(
operator|&
name|chunks_ad
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
block|}
name|malloc_mutex_unlock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|!=
name|NULL
condition|)
name|base_node_dealloc
argument_list|(
name|node
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|JEMALLOC_PURGE_MADVISE_FREE
if|if
condition|(
operator|*
name|zero
condition|)
block|{
name|VALGRIND_MAKE_MEM_UNDEFINED
argument_list|(
name|ret
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ret
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * If the caller specifies (*zero == false), it is still possible to receive  * zeroed memory, in which case *zero is toggled to true.  arena_chunk_alloc()  * takes advantage of this to avoid demanding zeroed chunks, but taking  * advantage of them if they are returned.  */
end_comment

begin_function
name|void
modifier|*
name|chunk_alloc
parameter_list|(
name|size_t
name|size
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
name|base
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|)
block|{
name|void
modifier|*
name|ret
decl_stmt|;
name|assert
argument_list|(
name|size
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|size
operator|&
name|chunksize_mask
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|alignment
operator|&
name|chunksize_mask
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
name|chunk_recycle
argument_list|(
name|size
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|NULL
condition|)
goto|goto
name|label_return
goto|;
if|if
condition|(
name|config_dss
condition|)
block|{
name|ret
operator|=
name|chunk_alloc_dss
argument_list|(
name|size
argument_list|,
name|alignment
argument_list|,
name|zero
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|NULL
condition|)
goto|goto
name|label_return
goto|;
block|}
name|ret
operator|=
name|chunk_alloc_mmap
argument_list|(
name|size
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|NULL
condition|)
block|{
operator|*
name|zero
operator|=
name|true
expr_stmt|;
goto|goto
name|label_return
goto|;
block|}
comment|/* All strategies for allocation failed. */
name|ret
operator|=
name|NULL
expr_stmt|;
name|label_return
label|:
if|if
condition|(
name|config_ivsalloc
operator|&&
name|base
operator|==
name|false
operator|&&
name|ret
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rtree_set
argument_list|(
name|chunks_rtree
argument_list|,
operator|(
name|uintptr_t
operator|)
name|ret
argument_list|,
name|ret
argument_list|)
condition|)
block|{
name|chunk_dealloc
argument_list|(
name|ret
argument_list|,
name|size
argument_list|,
name|true
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
if|if
condition|(
operator|(
name|config_stats
operator|||
name|config_prof
operator|)
operator|&&
name|ret
operator|!=
name|NULL
condition|)
block|{
name|bool
name|gdump
decl_stmt|;
name|malloc_mutex_lock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_stats
condition|)
name|stats_chunks
operator|.
name|nchunks
operator|+=
operator|(
name|size
operator|/
name|chunksize
operator|)
expr_stmt|;
name|stats_chunks
operator|.
name|curchunks
operator|+=
operator|(
name|size
operator|/
name|chunksize
operator|)
expr_stmt|;
if|if
condition|(
name|stats_chunks
operator|.
name|curchunks
operator|>
name|stats_chunks
operator|.
name|highchunks
condition|)
block|{
name|stats_chunks
operator|.
name|highchunks
operator|=
name|stats_chunks
operator|.
name|curchunks
expr_stmt|;
if|if
condition|(
name|config_prof
condition|)
name|gdump
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config_prof
condition|)
name|gdump
operator|=
name|false
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_prof
operator|&&
name|opt_prof
operator|&&
name|opt_prof_gdump
operator|&&
name|gdump
condition|)
name|prof_gdump
argument_list|()
expr_stmt|;
block|}
name|assert
argument_list|(
name|CHUNK_ADDR2BASE
argument_list|(
name|ret
argument_list|)
operator|==
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|chunk_record
parameter_list|(
name|void
modifier|*
name|chunk
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|extent_node_t
modifier|*
name|xnode
decl_stmt|,
modifier|*
name|node
decl_stmt|,
modifier|*
name|prev
decl_stmt|,
name|key
decl_stmt|;
name|pages_purge
argument_list|(
name|chunk
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|xnode
operator|=
name|NULL
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
while|while
condition|(
name|true
condition|)
block|{
name|key
operator|.
name|addr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|chunk
operator|+
name|size
operator|)
expr_stmt|;
name|node
operator|=
name|extent_tree_ad_nsearch
argument_list|(
operator|&
name|chunks_ad
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
comment|/* Try to coalesce forward. */
if|if
condition|(
name|node
operator|!=
name|NULL
operator|&&
name|node
operator|->
name|addr
operator|==
name|key
operator|.
name|addr
condition|)
block|{
comment|/* 			 * Coalesce chunk with the following address range. 			 * This does not change the position within chunks_ad, 			 * so only remove/insert from/into chunks_szad. 			 */
name|extent_tree_szad_remove
argument_list|(
operator|&
name|chunks_szad
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|node
operator|->
name|addr
operator|=
name|chunk
expr_stmt|;
name|node
operator|->
name|size
operator|+=
name|size
expr_stmt|;
name|extent_tree_szad_insert
argument_list|(
operator|&
name|chunks_szad
argument_list|,
name|node
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|xnode
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * It is possible that base_node_alloc() will cause a 			 * new base chunk to be allocated, so take care not to 			 * deadlock on chunks_mtx, and recover if another thread 			 * deallocates an adjacent chunk while this one is busy 			 * allocating xnode. 			 */
name|malloc_mutex_unlock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
name|xnode
operator|=
name|base_node_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|xnode
operator|==
name|NULL
condition|)
return|return;
name|malloc_mutex_lock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Coalescing forward failed, so insert a new node. */
name|node
operator|=
name|xnode
expr_stmt|;
name|xnode
operator|=
name|NULL
expr_stmt|;
name|node
operator|->
name|addr
operator|=
name|chunk
expr_stmt|;
name|node
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|extent_tree_ad_insert
argument_list|(
operator|&
name|chunks_ad
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|extent_tree_szad_insert
argument_list|(
operator|&
name|chunks_szad
argument_list|,
name|node
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* Discard xnode if it ended up unused due to a race. */
if|if
condition|(
name|xnode
operator|!=
name|NULL
condition|)
name|base_node_dealloc
argument_list|(
name|xnode
argument_list|)
expr_stmt|;
comment|/* Try to coalesce backward. */
name|prev
operator|=
name|extent_tree_ad_prev
argument_list|(
operator|&
name|chunks_ad
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
operator|!=
name|NULL
operator|&&
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|prev
operator|->
name|addr
operator|+
name|prev
operator|->
name|size
operator|)
operator|==
name|chunk
condition|)
block|{
comment|/* 		 * Coalesce chunk with the previous address range.  This does 		 * not change the position within chunks_ad, so only 		 * remove/insert node from/into chunks_szad. 		 */
name|extent_tree_szad_remove
argument_list|(
operator|&
name|chunks_szad
argument_list|,
name|prev
argument_list|)
expr_stmt|;
name|extent_tree_ad_remove
argument_list|(
operator|&
name|chunks_ad
argument_list|,
name|prev
argument_list|)
expr_stmt|;
name|extent_tree_szad_remove
argument_list|(
operator|&
name|chunks_szad
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|node
operator|->
name|addr
operator|=
name|prev
operator|->
name|addr
expr_stmt|;
name|node
operator|->
name|size
operator|+=
name|prev
operator|->
name|size
expr_stmt|;
name|extent_tree_szad_insert
argument_list|(
operator|&
name|chunks_szad
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|base_node_dealloc
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|malloc_mutex_unlock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|chunk_dealloc
parameter_list|(
name|void
modifier|*
name|chunk
parameter_list|,
name|size_t
name|size
parameter_list|,
name|bool
name|unmap
parameter_list|)
block|{
name|assert
argument_list|(
name|chunk
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|CHUNK_ADDR2BASE
argument_list|(
name|chunk
argument_list|)
operator|==
name|chunk
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|size
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|size
operator|&
name|chunksize_mask
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_ivsalloc
condition|)
name|rtree_set
argument_list|(
name|chunks_rtree
argument_list|,
operator|(
name|uintptr_t
operator|)
name|chunk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_stats
operator|||
name|config_prof
condition|)
block|{
name|malloc_mutex_lock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
name|stats_chunks
operator|.
name|curchunks
operator|-=
operator|(
name|size
operator|/
name|chunksize
operator|)
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|unmap
condition|)
block|{
if|if
condition|(
name|chunk_dealloc_mmap
argument_list|(
name|chunk
argument_list|,
name|size
argument_list|)
operator|==
name|false
condition|)
return|return;
name|chunk_record
argument_list|(
name|chunk
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|bool
name|chunk_boot0
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Set variables according to the value of opt_lg_chunk. */
name|chunksize
operator|=
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|opt_lg_chunk
operator|)
expr_stmt|;
name|assert
argument_list|(
name|chunksize
operator|>=
name|PAGE
argument_list|)
expr_stmt|;
name|chunksize_mask
operator|=
name|chunksize
operator|-
literal|1
expr_stmt|;
name|chunk_npages
operator|=
operator|(
name|chunksize
operator|>>
name|LG_PAGE
operator|)
expr_stmt|;
if|if
condition|(
name|config_stats
operator|||
name|config_prof
condition|)
block|{
if|if
condition|(
name|malloc_mutex_init
argument_list|(
operator|&
name|chunks_mtx
argument_list|)
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|memset
argument_list|(
operator|&
name|stats_chunks
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|chunk_stats_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config_dss
operator|&&
name|chunk_dss_boot
argument_list|()
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|extent_tree_szad_new
argument_list|(
operator|&
name|chunks_szad
argument_list|)
expr_stmt|;
name|extent_tree_ad_new
argument_list|(
operator|&
name|chunks_ad
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_ivsalloc
condition|)
block|{
name|chunks_rtree
operator|=
name|rtree_new
argument_list|(
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
operator|(
name|LG_SIZEOF_PTR
operator|+
literal|3
operator|)
operator|)
operator|-
name|opt_lg_chunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|chunks_rtree
operator|==
name|NULL
condition|)
return|return
operator|(
name|true
operator|)
return|;
block|}
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_function
name|bool
name|chunk_boot1
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|chunk_mmap_boot
argument_list|()
condition|)
return|return
operator|(
name|true
operator|)
return|;
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

end_unit


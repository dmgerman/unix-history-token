begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_preamble.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal_includes.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/nstime.h"
end_include

begin_include
include|#
directive|include
file|"jemalloc/internal/assert.h"
end_include

begin_define
define|#
directive|define
name|BILLION
value|UINT64_C(1000000000)
end_define

begin_define
define|#
directive|define
name|MILLION
value|UINT64_C(1000000)
end_define

begin_function
name|void
name|nstime_init
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|,
name|uint64_t
name|ns
parameter_list|)
block|{
name|time
operator|->
name|ns
operator|=
name|ns
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nstime_init2
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|,
name|uint64_t
name|sec
parameter_list|,
name|uint64_t
name|nsec
parameter_list|)
block|{
name|time
operator|->
name|ns
operator|=
name|sec
operator|*
name|BILLION
operator|+
name|nsec
expr_stmt|;
block|}
end_function

begin_function
name|uint64_t
name|nstime_ns
parameter_list|(
specifier|const
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
return|return
name|time
operator|->
name|ns
return|;
block|}
end_function

begin_function
name|uint64_t
name|nstime_msec
parameter_list|(
specifier|const
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
return|return
name|time
operator|->
name|ns
operator|/
name|MILLION
return|;
block|}
end_function

begin_function
name|uint64_t
name|nstime_sec
parameter_list|(
specifier|const
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
return|return
name|time
operator|->
name|ns
operator|/
name|BILLION
return|;
block|}
end_function

begin_function
name|uint64_t
name|nstime_nsec
parameter_list|(
specifier|const
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
return|return
name|time
operator|->
name|ns
operator|%
name|BILLION
return|;
block|}
end_function

begin_function
name|void
name|nstime_copy
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|,
specifier|const
name|nstime_t
modifier|*
name|source
parameter_list|)
block|{
operator|*
name|time
operator|=
operator|*
name|source
expr_stmt|;
block|}
end_function

begin_function
name|int
name|nstime_compare
parameter_list|(
specifier|const
name|nstime_t
modifier|*
name|a
parameter_list|,
specifier|const
name|nstime_t
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|(
name|a
operator|->
name|ns
operator|>
name|b
operator|->
name|ns
operator|)
operator|-
operator|(
name|a
operator|->
name|ns
operator|<
name|b
operator|->
name|ns
operator|)
return|;
block|}
end_function

begin_function
name|void
name|nstime_add
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|,
specifier|const
name|nstime_t
modifier|*
name|addend
parameter_list|)
block|{
name|assert
argument_list|(
name|UINT64_MAX
operator|-
name|time
operator|->
name|ns
operator|>=
name|addend
operator|->
name|ns
argument_list|)
expr_stmt|;
name|time
operator|->
name|ns
operator|+=
name|addend
operator|->
name|ns
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nstime_iadd
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|,
name|uint64_t
name|addend
parameter_list|)
block|{
name|assert
argument_list|(
name|UINT64_MAX
operator|-
name|time
operator|->
name|ns
operator|>=
name|addend
argument_list|)
expr_stmt|;
name|time
operator|->
name|ns
operator|+=
name|addend
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nstime_subtract
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|,
specifier|const
name|nstime_t
modifier|*
name|subtrahend
parameter_list|)
block|{
name|assert
argument_list|(
name|nstime_compare
argument_list|(
name|time
argument_list|,
name|subtrahend
argument_list|)
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|time
operator|->
name|ns
operator|-=
name|subtrahend
operator|->
name|ns
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nstime_isubtract
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|,
name|uint64_t
name|subtrahend
parameter_list|)
block|{
name|assert
argument_list|(
name|time
operator|->
name|ns
operator|>=
name|subtrahend
argument_list|)
expr_stmt|;
name|time
operator|->
name|ns
operator|-=
name|subtrahend
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nstime_imultiply
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|,
name|uint64_t
name|multiplier
parameter_list|)
block|{
name|assert
argument_list|(
operator|(
operator|(
operator|(
name|time
operator|->
name|ns
operator||
name|multiplier
operator|)
operator|&
operator|(
name|UINT64_MAX
operator|<<
operator|(
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|<<
literal|2
operator|)
operator|)
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|time
operator|->
name|ns
operator|*
name|multiplier
operator|)
operator|/
name|multiplier
operator|==
name|time
operator|->
name|ns
operator|)
argument_list|)
expr_stmt|;
name|time
operator|->
name|ns
operator|*=
name|multiplier
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nstime_idivide
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|,
name|uint64_t
name|divisor
parameter_list|)
block|{
name|assert
argument_list|(
name|divisor
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|time
operator|->
name|ns
operator|/=
name|divisor
expr_stmt|;
block|}
end_function

begin_function
name|uint64_t
name|nstime_divide
parameter_list|(
specifier|const
name|nstime_t
modifier|*
name|time
parameter_list|,
specifier|const
name|nstime_t
modifier|*
name|divisor
parameter_list|)
block|{
name|assert
argument_list|(
name|divisor
operator|->
name|ns
operator|!=
literal|0
argument_list|)
expr_stmt|;
return|return
name|time
operator|->
name|ns
operator|/
name|divisor
operator|->
name|ns
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32
end_ifdef

begin_define
define|#
directive|define
name|NSTIME_MONOTONIC
value|true
end_define

begin_function
specifier|static
name|void
name|nstime_get
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
name|FILETIME
name|ft
decl_stmt|;
name|uint64_t
name|ticks_100ns
decl_stmt|;
name|GetSystemTimeAsFileTime
argument_list|(
operator|&
name|ft
argument_list|)
expr_stmt|;
name|ticks_100ns
operator|=
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|ft
operator|.
name|dwHighDateTime
operator|)
operator|<<
literal|32
operator|)
operator||
name|ft
operator|.
name|dwLowDateTime
expr_stmt|;
name|nstime_init
argument_list|(
name|time
argument_list|,
name|ticks_100ns
operator|*
literal|100
argument_list|)
expr_stmt|;
block|}
end_function

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|JEMALLOC_HAVE_CLOCK_MONOTONIC_COARSE
argument_list|)
end_elif

begin_define
define|#
directive|define
name|NSTIME_MONOTONIC
value|true
end_define

begin_function
specifier|static
name|void
name|nstime_get
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
name|struct
name|timespec
name|ts
decl_stmt|;
name|clock_gettime
argument_list|(
name|CLOCK_MONOTONIC_COARSE
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
name|nstime_init2
argument_list|(
name|time
argument_list|,
name|ts
operator|.
name|tv_sec
argument_list|,
name|ts
operator|.
name|tv_nsec
argument_list|)
expr_stmt|;
block|}
end_function

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|JEMALLOC_HAVE_CLOCK_MONOTONIC
argument_list|)
end_elif

begin_define
define|#
directive|define
name|NSTIME_MONOTONIC
value|true
end_define

begin_function
specifier|static
name|void
name|nstime_get
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
name|struct
name|timespec
name|ts
decl_stmt|;
name|clock_gettime
argument_list|(
name|CLOCK_MONOTONIC
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
name|nstime_init2
argument_list|(
name|time
argument_list|,
name|ts
operator|.
name|tv_sec
argument_list|,
name|ts
operator|.
name|tv_nsec
argument_list|)
expr_stmt|;
block|}
end_function

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|JEMALLOC_HAVE_MACH_ABSOLUTE_TIME
argument_list|)
end_elif

begin_define
define|#
directive|define
name|NSTIME_MONOTONIC
value|true
end_define

begin_function
specifier|static
name|void
name|nstime_get
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
name|nstime_init
argument_list|(
name|time
argument_list|,
name|mach_absolute_time
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|NSTIME_MONOTONIC
value|false
end_define

begin_function
specifier|static
name|void
name|nstime_get
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|nstime_init2
argument_list|(
name|time
argument_list|,
name|tv
operator|.
name|tv_sec
argument_list|,
name|tv
operator|.
name|tv_usec
operator|*
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|bool
name|nstime_monotonic_impl
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|NSTIME_MONOTONIC
return|;
undef|#
directive|undef
name|NSTIME_MONOTONIC
block|}
end_function

begin_decl_stmt
name|nstime_monotonic_t
modifier|*
name|JET_MUTABLE
name|nstime_monotonic
init|=
name|nstime_monotonic_impl
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|bool
name|nstime_update_impl
parameter_list|(
name|nstime_t
modifier|*
name|time
parameter_list|)
block|{
name|nstime_t
name|old_time
decl_stmt|;
name|nstime_copy
argument_list|(
operator|&
name|old_time
argument_list|,
name|time
argument_list|)
expr_stmt|;
name|nstime_get
argument_list|(
name|time
argument_list|)
expr_stmt|;
comment|/* Handle non-monotonic clocks. */
if|if
condition|(
name|unlikely
argument_list|(
name|nstime_compare
argument_list|(
operator|&
name|old_time
argument_list|,
name|time
argument_list|)
operator|>
literal|0
argument_list|)
condition|)
block|{
name|nstime_copy
argument_list|(
name|time
argument_list|,
operator|&
name|old_time
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_decl_stmt
name|nstime_update_t
modifier|*
name|JET_MUTABLE
name|nstime_update
init|=
name|nstime_update_impl
decl_stmt|;
end_decl_stmt

end_unit


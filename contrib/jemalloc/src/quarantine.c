begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal.h"
end_include

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_typedef
typedef|typedef
name|struct
name|quarantine_s
name|quarantine_t
typedef|;
end_typedef

begin_struct
struct|struct
name|quarantine_s
block|{
name|size_t
name|curbytes
decl_stmt|;
name|size_t
name|curobjs
decl_stmt|;
name|size_t
name|first
decl_stmt|;
define|#
directive|define
name|LG_MAXOBJS_INIT
value|10
name|size_t
name|lg_maxobjs
decl_stmt|;
name|void
modifier|*
name|objs
index|[
literal|1
index|]
decl_stmt|;
comment|/* Dynamically sized ring buffer. */
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|quarantine_cleanup
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_macro
name|malloc_tsd_data
argument_list|(
argument|static
argument_list|,
argument|quarantine
argument_list|,
argument|quarantine_t *
argument_list|,
argument|NULL
argument_list|)
end_macro

begin_macro
name|malloc_tsd_funcs
argument_list|(
argument|JEMALLOC_INLINE
argument_list|,
argument|quarantine
argument_list|,
argument|quarantine_t *
argument_list|,
argument|NULL
argument_list|,
argument|quarantine_cleanup
argument_list|)
end_macro

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Function prototypes for non-inline static functions. */
end_comment

begin_function_decl
specifier|static
name|quarantine_t
modifier|*
name|quarantine_init
parameter_list|(
name|size_t
name|lg_maxobjs
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|quarantine_t
modifier|*
name|quarantine_grow
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|quarantine_drain
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|,
name|size_t
name|upper_bound
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|quarantine_t
modifier|*
name|quarantine_init
parameter_list|(
name|size_t
name|lg_maxobjs
parameter_list|)
block|{
name|quarantine_t
modifier|*
name|quarantine
decl_stmt|;
name|quarantine
operator|=
operator|(
name|quarantine_t
operator|*
operator|)
name|imalloc
argument_list|(
name|offsetof
argument_list|(
name|quarantine_t
argument_list|,
name|objs
argument_list|)
operator|+
operator|(
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|lg_maxobjs
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|quarantine
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|quarantine
operator|->
name|curbytes
operator|=
literal|0
expr_stmt|;
name|quarantine
operator|->
name|curobjs
operator|=
literal|0
expr_stmt|;
name|quarantine
operator|->
name|first
operator|=
literal|0
expr_stmt|;
name|quarantine
operator|->
name|lg_maxobjs
operator|=
name|lg_maxobjs
expr_stmt|;
name|quarantine_tsd_set
argument_list|(
operator|&
name|quarantine
argument_list|)
expr_stmt|;
return|return
operator|(
name|quarantine
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|quarantine_t
modifier|*
name|quarantine_grow
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|)
block|{
name|quarantine_t
modifier|*
name|ret
decl_stmt|;
name|ret
operator|=
name|quarantine_init
argument_list|(
name|quarantine
operator|->
name|lg_maxobjs
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
return|return
operator|(
name|quarantine
operator|)
return|;
name|ret
operator|->
name|curbytes
operator|=
name|quarantine
operator|->
name|curbytes
expr_stmt|;
if|if
condition|(
name|quarantine
operator|->
name|first
operator|+
name|quarantine
operator|->
name|curobjs
operator|<
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
condition|)
block|{
comment|/* objs ring buffer data are contiguous. */
name|memcpy
argument_list|(
name|ret
operator|->
name|objs
argument_list|,
operator|&
name|quarantine
operator|->
name|objs
index|[
name|quarantine
operator|->
name|first
index|]
argument_list|,
name|quarantine
operator|->
name|curobjs
operator|*
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|->
name|curobjs
operator|=
name|quarantine
operator|->
name|curobjs
expr_stmt|;
block|}
else|else
block|{
comment|/* objs ring buffer data wrap around. */
name|size_t
name|ncopy
init|=
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
operator|-
name|quarantine
operator|->
name|first
decl_stmt|;
name|memcpy
argument_list|(
name|ret
operator|->
name|objs
argument_list|,
operator|&
name|quarantine
operator|->
name|objs
index|[
name|quarantine
operator|->
name|first
index|]
argument_list|,
name|ncopy
operator|*
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|->
name|curobjs
operator|=
name|ncopy
expr_stmt|;
if|if
condition|(
name|quarantine
operator|->
name|curobjs
operator|!=
literal|0
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|ret
operator|->
name|objs
index|[
name|ret
operator|->
name|curobjs
index|]
argument_list|,
name|quarantine
operator|->
name|objs
argument_list|,
name|quarantine
operator|->
name|curobjs
operator|-
name|ncopy
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|quarantine_drain
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|,
name|size_t
name|upper_bound
parameter_list|)
block|{
while|while
condition|(
name|quarantine
operator|->
name|curbytes
operator|>
name|upper_bound
operator|&&
name|quarantine
operator|->
name|curobjs
operator|>
literal|0
condition|)
block|{
name|void
modifier|*
name|ptr
init|=
name|quarantine
operator|->
name|objs
index|[
name|quarantine
operator|->
name|first
index|]
decl_stmt|;
name|size_t
name|usize
init|=
name|isalloc
argument_list|(
name|ptr
argument_list|,
name|config_prof
argument_list|)
decl_stmt|;
name|idalloc
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|quarantine
operator|->
name|curbytes
operator|-=
name|usize
expr_stmt|;
name|quarantine
operator|->
name|curobjs
operator|--
expr_stmt|;
name|quarantine
operator|->
name|first
operator|=
operator|(
name|quarantine
operator|->
name|first
operator|+
literal|1
operator|)
operator|&
operator|(
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|quarantine
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|quarantine_t
modifier|*
name|quarantine
decl_stmt|;
name|size_t
name|usize
init|=
name|isalloc
argument_list|(
name|ptr
argument_list|,
name|config_prof
argument_list|)
decl_stmt|;
name|cassert
argument_list|(
name|config_fill
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|opt_quarantine
argument_list|)
expr_stmt|;
name|quarantine
operator|=
operator|*
name|quarantine_tsd_get
argument_list|()
expr_stmt|;
if|if
condition|(
name|quarantine
operator|==
name|NULL
operator|&&
operator|(
name|quarantine
operator|=
name|quarantine_init
argument_list|(
name|LG_MAXOBJS_INIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|idalloc
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Drain one or more objects if the quarantine size limit would be 	 * exceeded by appending ptr. 	 */
if|if
condition|(
name|quarantine
operator|->
name|curbytes
operator|+
name|usize
operator|>
name|opt_quarantine
condition|)
block|{
name|size_t
name|upper_bound
init|=
operator|(
name|opt_quarantine
operator|>=
name|usize
operator|)
condition|?
name|opt_quarantine
operator|-
name|usize
else|:
literal|0
decl_stmt|;
name|quarantine_drain
argument_list|(
name|quarantine
argument_list|,
name|upper_bound
argument_list|)
expr_stmt|;
block|}
comment|/* Grow the quarantine ring buffer if it's full. */
if|if
condition|(
name|quarantine
operator|->
name|curobjs
operator|==
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
condition|)
name|quarantine
operator|=
name|quarantine_grow
argument_list|(
name|quarantine
argument_list|)
expr_stmt|;
comment|/* quarantine_grow() must free a slot if it fails to grow. */
name|assert
argument_list|(
name|quarantine
operator|->
name|curobjs
operator|<
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
argument_list|)
expr_stmt|;
comment|/* Append ptr if its size doesn't exceed the quarantine size. */
if|if
condition|(
name|quarantine
operator|->
name|curbytes
operator|+
name|usize
operator|<=
name|opt_quarantine
condition|)
block|{
name|size_t
name|offset
init|=
operator|(
name|quarantine
operator|->
name|first
operator|+
name|quarantine
operator|->
name|curobjs
operator|)
operator|&
operator|(
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
operator|-
literal|1
operator|)
decl_stmt|;
name|quarantine
operator|->
name|objs
index|[
name|offset
index|]
operator|=
name|ptr
expr_stmt|;
name|quarantine
operator|->
name|curbytes
operator|+=
name|usize
expr_stmt|;
name|quarantine
operator|->
name|curobjs
operator|++
expr_stmt|;
if|if
condition|(
name|opt_junk
condition|)
name|memset
argument_list|(
name|ptr
argument_list|,
literal|0x5a
argument_list|,
name|usize
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|quarantine
operator|->
name|curbytes
operator|==
literal|0
argument_list|)
expr_stmt|;
name|idalloc
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|quarantine_cleanup
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|quarantine_t
modifier|*
name|quarantine
init|=
operator|*
operator|(
name|quarantine_t
operator|*
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|quarantine
operator|!=
name|NULL
condition|)
block|{
name|quarantine_drain
argument_list|(
name|quarantine
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|idalloc
argument_list|(
name|quarantine
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|bool
name|quarantine_boot
parameter_list|(
name|void
parameter_list|)
block|{
name|cassert
argument_list|(
name|config_fill
argument_list|)
expr_stmt|;
if|if
condition|(
name|quarantine_tsd_boot
argument_list|()
condition|)
return|return
operator|(
name|true
operator|)
return|;
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

end_unit


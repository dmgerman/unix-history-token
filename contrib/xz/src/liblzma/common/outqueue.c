begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|///////////////////////////////////////////////////////////////////////////////
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|/// \file       outqueue.c
end_comment

begin_comment
comment|/// \brief      Output queue handling in multithreaded coding
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//  Author:     Lasse Collin
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//  This file has been put into the public domain.
end_comment

begin_comment
comment|//  You can do whatever you want with this file.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|///////////////////////////////////////////////////////////////////////////////
end_comment

begin_include
include|#
directive|include
file|"outqueue.h"
end_include

begin_comment
comment|/// This is to ease integer overflow checking: We may allocate up to
end_comment

begin_comment
comment|/// 2 * LZMA_THREADS_MAX buffers and we need some extra memory for other
end_comment

begin_comment
comment|/// data structures (that's the second /2).
end_comment

begin_define
define|#
directive|define
name|BUF_SIZE_MAX
value|(UINT64_MAX / LZMA_THREADS_MAX / 2 / 2)
end_define

begin_function
specifier|static
name|lzma_ret
name|get_options
parameter_list|(
name|uint64_t
modifier|*
name|bufs_alloc_size
parameter_list|,
name|uint32_t
modifier|*
name|bufs_count
parameter_list|,
name|uint64_t
name|buf_size_max
parameter_list|,
name|uint32_t
name|threads
parameter_list|)
block|{
if|if
condition|(
name|threads
operator|>
name|LZMA_THREADS_MAX
operator|||
name|buf_size_max
operator|>
name|BUF_SIZE_MAX
condition|)
return|return
name|LZMA_OPTIONS_ERROR
return|;
comment|// The number of buffers is twice the number of threads.
comment|// This wastes RAM but keeps the threads busy when buffers
comment|// finish out of order.
comment|//
comment|// NOTE: If this is changed, update BUF_SIZE_MAX too.
operator|*
name|bufs_count
operator|=
name|threads
operator|*
literal|2
expr_stmt|;
operator|*
name|bufs_alloc_size
operator|=
operator|*
name|bufs_count
operator|*
name|buf_size_max
expr_stmt|;
return|return
name|LZMA_OK
return|;
block|}
end_function

begin_function
specifier|extern
name|uint64_t
name|lzma_outq_memusage
parameter_list|(
name|uint64_t
name|buf_size_max
parameter_list|,
name|uint32_t
name|threads
parameter_list|)
block|{
name|uint64_t
name|bufs_alloc_size
decl_stmt|;
name|uint32_t
name|bufs_count
decl_stmt|;
if|if
condition|(
name|get_options
argument_list|(
operator|&
name|bufs_alloc_size
argument_list|,
operator|&
name|bufs_count
argument_list|,
name|buf_size_max
argument_list|,
name|threads
argument_list|)
operator|!=
name|LZMA_OK
condition|)
return|return
name|UINT64_MAX
return|;
return|return
sizeof|sizeof
argument_list|(
name|lzma_outq
argument_list|)
operator|+
name|bufs_count
operator|*
sizeof|sizeof
argument_list|(
name|lzma_outbuf
argument_list|)
operator|+
name|bufs_alloc_size
return|;
block|}
end_function

begin_function
specifier|extern
name|lzma_ret
name|lzma_outq_init
parameter_list|(
name|lzma_outq
modifier|*
name|outq
parameter_list|,
specifier|const
name|lzma_allocator
modifier|*
name|allocator
parameter_list|,
name|uint64_t
name|buf_size_max
parameter_list|,
name|uint32_t
name|threads
parameter_list|)
block|{
name|uint64_t
name|bufs_alloc_size
decl_stmt|;
name|uint32_t
name|bufs_count
decl_stmt|;
comment|// Set bufs_count and bufs_alloc_size.
name|return_if_error
argument_list|(
name|get_options
argument_list|(
operator|&
name|bufs_alloc_size
argument_list|,
operator|&
name|bufs_count
argument_list|,
name|buf_size_max
argument_list|,
name|threads
argument_list|)
argument_list|)
expr_stmt|;
comment|// Allocate memory if needed.
if|if
condition|(
name|outq
operator|->
name|buf_size_max
operator|!=
name|buf_size_max
operator|||
name|outq
operator|->
name|bufs_allocated
operator|!=
name|bufs_count
condition|)
block|{
name|lzma_outq_end
argument_list|(
name|outq
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
if|#
directive|if
name|SIZE_MAX
operator|<
name|UINT64_MAX
if|if
condition|(
name|bufs_alloc_size
operator|>
name|SIZE_MAX
condition|)
return|return
name|LZMA_MEM_ERROR
return|;
endif|#
directive|endif
name|outq
operator|->
name|bufs
operator|=
name|lzma_alloc
argument_list|(
name|bufs_count
operator|*
sizeof|sizeof
argument_list|(
name|lzma_outbuf
argument_list|)
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
name|outq
operator|->
name|bufs_mem
operator|=
name|lzma_alloc
argument_list|(
call|(
name|size_t
call|)
argument_list|(
name|bufs_alloc_size
argument_list|)
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
if|if
condition|(
name|outq
operator|->
name|bufs
operator|==
name|NULL
operator|||
name|outq
operator|->
name|bufs_mem
operator|==
name|NULL
condition|)
block|{
name|lzma_outq_end
argument_list|(
name|outq
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
return|return
name|LZMA_MEM_ERROR
return|;
block|}
block|}
comment|// Initialize the rest of the main structure. Initialization of
comment|// outq->bufs[] is done when they are actually needed.
name|outq
operator|->
name|buf_size_max
operator|=
call|(
name|size_t
call|)
argument_list|(
name|buf_size_max
argument_list|)
expr_stmt|;
name|outq
operator|->
name|bufs_allocated
operator|=
name|bufs_count
expr_stmt|;
name|outq
operator|->
name|bufs_pos
operator|=
literal|0
expr_stmt|;
name|outq
operator|->
name|bufs_used
operator|=
literal|0
expr_stmt|;
name|outq
operator|->
name|read_pos
operator|=
literal|0
expr_stmt|;
return|return
name|LZMA_OK
return|;
block|}
end_function

begin_function
specifier|extern
name|void
name|lzma_outq_end
parameter_list|(
name|lzma_outq
modifier|*
name|outq
parameter_list|,
specifier|const
name|lzma_allocator
modifier|*
name|allocator
parameter_list|)
block|{
name|lzma_free
argument_list|(
name|outq
operator|->
name|bufs
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
name|outq
operator|->
name|bufs
operator|=
name|NULL
expr_stmt|;
name|lzma_free
argument_list|(
name|outq
operator|->
name|bufs_mem
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
name|outq
operator|->
name|bufs_mem
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|extern
name|lzma_outbuf
modifier|*
name|lzma_outq_get_buf
parameter_list|(
name|lzma_outq
modifier|*
name|outq
parameter_list|)
block|{
comment|// Caller must have checked it with lzma_outq_has_buf().
name|assert
argument_list|(
name|outq
operator|->
name|bufs_used
operator|<
name|outq
operator|->
name|bufs_allocated
argument_list|)
expr_stmt|;
comment|// Initialize the new buffer.
name|lzma_outbuf
modifier|*
name|buf
init|=
operator|&
name|outq
operator|->
name|bufs
index|[
name|outq
operator|->
name|bufs_pos
index|]
decl_stmt|;
name|buf
operator|->
name|buf
operator|=
name|outq
operator|->
name|bufs_mem
operator|+
name|outq
operator|->
name|bufs_pos
operator|*
name|outq
operator|->
name|buf_size_max
expr_stmt|;
name|buf
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|finished
operator|=
name|false
expr_stmt|;
comment|// Update the queue state.
if|if
condition|(
operator|++
name|outq
operator|->
name|bufs_pos
operator|==
name|outq
operator|->
name|bufs_allocated
condition|)
name|outq
operator|->
name|bufs_pos
operator|=
literal|0
expr_stmt|;
operator|++
name|outq
operator|->
name|bufs_used
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|extern
name|bool
name|lzma_outq_is_readable
parameter_list|(
specifier|const
name|lzma_outq
modifier|*
name|outq
parameter_list|)
block|{
name|uint32_t
name|i
init|=
name|outq
operator|->
name|bufs_pos
operator|-
name|outq
operator|->
name|bufs_used
decl_stmt|;
if|if
condition|(
name|outq
operator|->
name|bufs_pos
operator|<
name|outq
operator|->
name|bufs_used
condition|)
name|i
operator|+=
name|outq
operator|->
name|bufs_allocated
expr_stmt|;
return|return
name|outq
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|finished
return|;
block|}
end_function

begin_function
specifier|extern
name|lzma_ret
name|lzma_outq_read
parameter_list|(
name|lzma_outq
modifier|*
specifier|restrict
name|outq
parameter_list|,
name|uint8_t
modifier|*
specifier|restrict
name|out
parameter_list|,
name|size_t
modifier|*
specifier|restrict
name|out_pos
parameter_list|,
name|size_t
name|out_size
parameter_list|,
name|lzma_vli
modifier|*
specifier|restrict
name|unpadded_size
parameter_list|,
name|lzma_vli
modifier|*
specifier|restrict
name|uncompressed_size
parameter_list|)
block|{
comment|// There must be at least one buffer from which to read.
if|if
condition|(
name|outq
operator|->
name|bufs_used
operator|==
literal|0
condition|)
return|return
name|LZMA_OK
return|;
comment|// Get the buffer.
name|uint32_t
name|i
init|=
name|outq
operator|->
name|bufs_pos
operator|-
name|outq
operator|->
name|bufs_used
decl_stmt|;
if|if
condition|(
name|outq
operator|->
name|bufs_pos
operator|<
name|outq
operator|->
name|bufs_used
condition|)
name|i
operator|+=
name|outq
operator|->
name|bufs_allocated
expr_stmt|;
name|lzma_outbuf
modifier|*
name|buf
init|=
operator|&
name|outq
operator|->
name|bufs
index|[
name|i
index|]
decl_stmt|;
comment|// If it isn't finished yet, we cannot read from it.
if|if
condition|(
operator|!
name|buf
operator|->
name|finished
condition|)
return|return
name|LZMA_OK
return|;
comment|// Copy from the buffer to output.
name|lzma_bufcpy
argument_list|(
name|buf
operator|->
name|buf
argument_list|,
operator|&
name|outq
operator|->
name|read_pos
argument_list|,
name|buf
operator|->
name|size
argument_list|,
name|out
argument_list|,
name|out_pos
argument_list|,
name|out_size
argument_list|)
expr_stmt|;
comment|// Return if we didn't get all the data from the buffer.
if|if
condition|(
name|outq
operator|->
name|read_pos
operator|<
name|buf
operator|->
name|size
condition|)
return|return
name|LZMA_OK
return|;
comment|// The buffer was finished. Tell the caller its size information.
operator|*
name|unpadded_size
operator|=
name|buf
operator|->
name|unpadded_size
expr_stmt|;
operator|*
name|uncompressed_size
operator|=
name|buf
operator|->
name|uncompressed_size
expr_stmt|;
comment|// Free this buffer for further use.
operator|--
name|outq
operator|->
name|bufs_used
expr_stmt|;
name|outq
operator|->
name|read_pos
operator|=
literal|0
expr_stmt|;
return|return
name|LZMA_STREAM_END
return|;
block|}
end_function

end_unit


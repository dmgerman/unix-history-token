begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|///////////////////////////////////////////////////////////////////////////////
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|/// \file       filter_decoder.c
end_comment

begin_comment
comment|/// \brief      Filter ID mapping to filter-specific functions
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//  Author:     Lasse Collin
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//  This file has been put into the public domain.
end_comment

begin_comment
comment|//  You can do whatever you want with this file.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|///////////////////////////////////////////////////////////////////////////////
end_comment

begin_include
include|#
directive|include
file|"filter_decoder.h"
end_include

begin_include
include|#
directive|include
file|"filter_common.h"
end_include

begin_include
include|#
directive|include
file|"lzma_decoder.h"
end_include

begin_include
include|#
directive|include
file|"lzma2_decoder.h"
end_include

begin_include
include|#
directive|include
file|"subblock_decoder.h"
end_include

begin_include
include|#
directive|include
file|"subblock_decoder_helper.h"
end_include

begin_include
include|#
directive|include
file|"simple_decoder.h"
end_include

begin_include
include|#
directive|include
file|"delta_decoder.h"
end_include

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/// Filter ID
name|lzma_vli
name|id
decl_stmt|;
comment|/// Initializes the filter encoder and calls lzma_next_filter_init()
comment|/// for filters + 1.
name|lzma_init_function
name|init
decl_stmt|;
comment|/// Calculates memory usage of the encoder. If the options are
comment|/// invalid, UINT64_MAX is returned.
name|uint64_t
function_decl|(
modifier|*
name|memusage
function_decl|)
parameter_list|(
specifier|const
name|void
modifier|*
name|options
parameter_list|)
function_decl|;
comment|/// Decodes Filter Properties.
comment|///
comment|/// \return     - LZMA_OK: Properties decoded successfully.
comment|///             - LZMA_OPTIONS_ERROR: Unsupported properties
comment|///             - LZMA_MEM_ERROR: Memory allocation failed.
name|lzma_ret
function_decl|(
modifier|*
name|props_decode
function_decl|)
parameter_list|(
name|void
modifier|*
modifier|*
name|options
parameter_list|,
name|lzma_allocator
modifier|*
name|allocator
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|props
parameter_list|,
name|size_t
name|props_size
parameter_list|)
function_decl|;
block|}
name|lzma_filter_decoder
typedef|;
end_typedef

begin_decl_stmt
specifier|static
specifier|const
name|lzma_filter_decoder
name|decoders
index|[]
init|=
block|{
ifdef|#
directive|ifdef
name|HAVE_DECODER_LZMA1
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_LZMA1
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_lzma_decoder_init
block|,
operator|.
name|memusage
operator|=
operator|&
name|lzma_lzma_decoder_memusage
block|,
operator|.
name|props_decode
operator|=
operator|&
name|lzma_lzma_props_decode
block|, 	}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_DECODER_LZMA2
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_LZMA2
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_lzma2_decoder_init
block|,
operator|.
name|memusage
operator|=
operator|&
name|lzma_lzma2_decoder_memusage
block|,
operator|.
name|props_decode
operator|=
operator|&
name|lzma_lzma2_props_decode
block|, 	}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_DECODER_SUBBLOCK
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_SUBBLOCK
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_subblock_decoder_init
block|,
comment|// 		.memusage =&lzma_subblock_decoder_memusage,
operator|.
name|props_decode
operator|=
name|NULL
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_SUBBLOCK_HELPER
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_subblock_decoder_helper_init
block|,
operator|.
name|memusage
operator|=
name|NULL
block|,
operator|.
name|props_decode
operator|=
name|NULL
block|, 	}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_DECODER_X86
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_X86
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_simple_x86_decoder_init
block|,
operator|.
name|memusage
operator|=
name|NULL
block|,
operator|.
name|props_decode
operator|=
operator|&
name|lzma_simple_props_decode
block|, 	}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_DECODER_POWERPC
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_POWERPC
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_simple_powerpc_decoder_init
block|,
operator|.
name|memusage
operator|=
name|NULL
block|,
operator|.
name|props_decode
operator|=
operator|&
name|lzma_simple_props_decode
block|, 	}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_DECODER_IA64
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_IA64
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_simple_ia64_decoder_init
block|,
operator|.
name|memusage
operator|=
name|NULL
block|,
operator|.
name|props_decode
operator|=
operator|&
name|lzma_simple_props_decode
block|, 	}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_DECODER_ARM
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_ARM
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_simple_arm_decoder_init
block|,
operator|.
name|memusage
operator|=
name|NULL
block|,
operator|.
name|props_decode
operator|=
operator|&
name|lzma_simple_props_decode
block|, 	}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_DECODER_ARMTHUMB
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_ARMTHUMB
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_simple_armthumb_decoder_init
block|,
operator|.
name|memusage
operator|=
name|NULL
block|,
operator|.
name|props_decode
operator|=
operator|&
name|lzma_simple_props_decode
block|, 	}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_DECODER_SPARC
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_SPARC
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_simple_sparc_decoder_init
block|,
operator|.
name|memusage
operator|=
name|NULL
block|,
operator|.
name|props_decode
operator|=
operator|&
name|lzma_simple_props_decode
block|, 	}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_DECODER_DELTA
block|{
operator|.
name|id
operator|=
name|LZMA_FILTER_DELTA
block|,
operator|.
name|init
operator|=
operator|&
name|lzma_delta_decoder_init
block|,
operator|.
name|memusage
operator|=
operator|&
name|lzma_delta_coder_memusage
block|,
operator|.
name|props_decode
operator|=
operator|&
name|lzma_delta_props_decode
block|, 	}
block|,
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|lzma_filter_decoder
modifier|*
name|decoder_find
parameter_list|(
name|lzma_vli
name|id
parameter_list|)
block|{
for|for
control|(
name|size_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|decoders
argument_list|)
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|decoders
index|[
name|i
index|]
operator|.
name|id
operator|==
name|id
condition|)
return|return
name|decoders
operator|+
name|i
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_extern
extern|extern LZMA_API(lzma_bool
end_extern

begin_macro
unit|)
name|lzma_filter_decoder_is_supported
argument_list|(
argument|lzma_vli id
argument_list|)
end_macro

begin_block
block|{
return|return
name|decoder_find
argument_list|(
name|id
argument_list|)
operator|!=
name|NULL
return|;
block|}
end_block

begin_function
specifier|extern
name|lzma_ret
name|lzma_raw_decoder_init
parameter_list|(
name|lzma_next_coder
modifier|*
name|next
parameter_list|,
name|lzma_allocator
modifier|*
name|allocator
parameter_list|,
specifier|const
name|lzma_filter
modifier|*
name|options
parameter_list|)
block|{
return|return
name|lzma_raw_coder_init
argument_list|(
name|next
argument_list|,
name|allocator
argument_list|,
name|options
argument_list|,
call|(
name|lzma_filter_find
call|)
argument_list|(
operator|&
name|decoder_find
argument_list|)
argument_list|,
name|false
argument_list|)
return|;
block|}
end_function

begin_extern
extern|extern LZMA_API(lzma_ret
end_extern

begin_macro
unit|)
name|lzma_raw_decoder
argument_list|(
argument|lzma_stream *strm
argument_list|,
argument|const lzma_filter *options
argument_list|)
end_macro

begin_block
block|{
name|lzma_next_strm_init
argument_list|(
name|lzma_raw_decoder_init
argument_list|,
name|strm
argument_list|,
name|options
argument_list|)
expr_stmt|;
name|strm
operator|->
name|internal
operator|->
name|supported_actions
index|[
name|LZMA_RUN
index|]
operator|=
name|true
expr_stmt|;
name|strm
operator|->
name|internal
operator|->
name|supported_actions
index|[
name|LZMA_FINISH
index|]
operator|=
name|true
expr_stmt|;
return|return
name|LZMA_OK
return|;
block|}
end_block

begin_extern
extern|extern LZMA_API(uint64_t
end_extern

begin_macro
unit|)
name|lzma_raw_decoder_memusage
argument_list|(
argument|const lzma_filter *filters
argument_list|)
end_macro

begin_block
block|{
return|return
name|lzma_raw_coder_memusage
argument_list|(
call|(
name|lzma_filter_find
call|)
argument_list|(
operator|&
name|decoder_find
argument_list|)
argument_list|,
name|filters
argument_list|)
return|;
block|}
end_block

begin_extern
extern|extern LZMA_API(lzma_ret
end_extern

begin_macro
unit|)
name|lzma_properties_decode
argument_list|(
argument|lzma_filter *filter
argument_list|,
argument|lzma_allocator *allocator
argument_list|,
argument|const uint8_t *props
argument_list|,
argument|size_t props_size
argument_list|)
end_macro

begin_block
block|{
comment|// Make it always NULL so that the caller can always safely free() it.
name|filter
operator|->
name|options
operator|=
name|NULL
expr_stmt|;
specifier|const
name|lzma_filter_decoder
modifier|*
specifier|const
name|fd
init|=
name|decoder_find
argument_list|(
name|filter
operator|->
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|fd
operator|==
name|NULL
condition|)
return|return
name|LZMA_OPTIONS_ERROR
return|;
if|if
condition|(
name|fd
operator|->
name|props_decode
operator|==
name|NULL
condition|)
return|return
name|props_size
operator|==
literal|0
condition|?
name|LZMA_OK
else|:
name|LZMA_OPTIONS_ERROR
return|;
return|return
name|fd
operator|->
name|props_decode
argument_list|(
operator|&
name|filter
operator|->
name|options
argument_list|,
name|allocator
argument_list|,
name|props
argument_list|,
name|props_size
argument_list|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|///////////////////////////////////////////////////////////////////////////////
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|/// \file       delta_common.c
end_comment

begin_comment
comment|/// \brief      Common stuff for Delta encoder and decoder
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//  Author:     Lasse Collin
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//  This file has been put into the public domain.
end_comment

begin_comment
comment|//  You can do whatever you want with this file.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|///////////////////////////////////////////////////////////////////////////////
end_comment

begin_include
include|#
directive|include
file|"delta_common.h"
end_include

begin_include
include|#
directive|include
file|"delta_private.h"
end_include

begin_function
specifier|static
name|void
name|delta_coder_end
parameter_list|(
name|void
modifier|*
name|coder_ptr
parameter_list|,
specifier|const
name|lzma_allocator
modifier|*
name|allocator
parameter_list|)
block|{
name|lzma_delta_coder
modifier|*
name|coder
init|=
name|coder_ptr
decl_stmt|;
name|lzma_next_end
argument_list|(
operator|&
name|coder
operator|->
name|next
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
name|lzma_free
argument_list|(
name|coder
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|extern
name|lzma_ret
name|lzma_delta_coder_init
parameter_list|(
name|lzma_next_coder
modifier|*
name|next
parameter_list|,
specifier|const
name|lzma_allocator
modifier|*
name|allocator
parameter_list|,
specifier|const
name|lzma_filter_info
modifier|*
name|filters
parameter_list|)
block|{
comment|// Allocate memory for the decoder if needed.
name|lzma_delta_coder
modifier|*
name|coder
init|=
name|next
operator|->
name|coder
decl_stmt|;
if|if
condition|(
name|coder
operator|==
name|NULL
condition|)
block|{
name|coder
operator|=
name|lzma_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|lzma_delta_coder
argument_list|)
argument_list|,
name|allocator
argument_list|)
expr_stmt|;
if|if
condition|(
name|coder
operator|==
name|NULL
condition|)
return|return
name|LZMA_MEM_ERROR
return|;
name|next
operator|->
name|coder
operator|=
name|coder
expr_stmt|;
comment|// End function is the same for encoder and decoder.
name|next
operator|->
name|end
operator|=
operator|&
name|delta_coder_end
expr_stmt|;
name|coder
operator|->
name|next
operator|=
name|LZMA_NEXT_CODER_INIT
expr_stmt|;
block|}
comment|// Validate the options.
if|if
condition|(
name|lzma_delta_coder_memusage
argument_list|(
name|filters
index|[
literal|0
index|]
operator|.
name|options
argument_list|)
operator|==
name|UINT64_MAX
condition|)
return|return
name|LZMA_OPTIONS_ERROR
return|;
comment|// Set the delta distance.
specifier|const
name|lzma_options_delta
modifier|*
name|opt
init|=
name|filters
index|[
literal|0
index|]
operator|.
name|options
decl_stmt|;
name|coder
operator|->
name|distance
operator|=
name|opt
operator|->
name|dist
expr_stmt|;
comment|// Initialize the rest of the variables.
name|coder
operator|->
name|pos
operator|=
literal|0
expr_stmt|;
name|memzero
argument_list|(
name|coder
operator|->
name|history
argument_list|,
name|LZMA_DELTA_DIST_MAX
argument_list|)
expr_stmt|;
comment|// Initialize the next decoder in the chain, if any.
return|return
name|lzma_next_filter_init
argument_list|(
operator|&
name|coder
operator|->
name|next
argument_list|,
name|allocator
argument_list|,
name|filters
operator|+
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|uint64_t
name|lzma_delta_coder_memusage
parameter_list|(
specifier|const
name|void
modifier|*
name|options
parameter_list|)
block|{
specifier|const
name|lzma_options_delta
modifier|*
name|opt
init|=
name|options
decl_stmt|;
if|if
condition|(
name|opt
operator|==
name|NULL
operator|||
name|opt
operator|->
name|type
operator|!=
name|LZMA_DELTA_TYPE_BYTE
operator|||
name|opt
operator|->
name|dist
operator|<
name|LZMA_DELTA_DIST_MIN
operator|||
name|opt
operator|->
name|dist
operator|>
name|LZMA_DELTA_DIST_MAX
condition|)
return|return
name|UINT64_MAX
return|;
return|return
sizeof|sizeof
argument_list|(
name|lzma_delta_coder
argument_list|)
return|;
block|}
end_function

end_unit


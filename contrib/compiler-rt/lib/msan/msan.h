begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===-- msan.h --------------------------------------------------*- C++ -*-===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is a part of MemorySanitizer.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// Private MSan header.
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|MSAN_H
end_ifndef

begin_define
define|#
directive|define
name|MSAN_H
end_define

begin_include
include|#
directive|include
file|"sanitizer_common/sanitizer_flags.h"
end_include

begin_include
include|#
directive|include
file|"sanitizer_common/sanitizer_internal_defs.h"
end_include

begin_include
include|#
directive|include
file|"sanitizer_common/sanitizer_stacktrace.h"
end_include

begin_include
include|#
directive|include
file|"msan_interface_internal.h"
end_include

begin_include
include|#
directive|include
file|"msan_flags.h"
end_include

begin_include
include|#
directive|include
file|"ubsan/ubsan_platform.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|MSAN_REPLACE_OPERATORS_NEW_AND_DELETE
end_ifndef

begin_define
define|#
directive|define
name|MSAN_REPLACE_OPERATORS_NEW_AND_DELETE
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|MSAN_CONTAINS_UBSAN
end_ifndef

begin_define
define|#
directive|define
name|MSAN_CONTAINS_UBSAN
value|CAN_SANITIZE_UB
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|MappingDesc
block|{
name|uptr
name|start
decl_stmt|;
name|uptr
name|end
decl_stmt|;
enum|enum
name|Type
block|{
name|INVALID
block|,
name|APP
block|,
name|SHADOW
block|,
name|ORIGIN
block|}
name|type
enum|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|}
struct|;
end_struct

begin_if
if|#
directive|if
name|SANITIZER_LINUX
operator|&&
name|defined
argument_list|(
name|__mips64
argument_list|)
end_if

begin_comment
comment|// MIPS64 maps:
end_comment

begin_comment
comment|// - 0x0000000000-0x0200000000: Program own segments
end_comment

begin_comment
comment|// - 0xa200000000-0xc000000000: PIE program segments
end_comment

begin_comment
comment|// - 0xe200000000-0xffffffffff: libraries segments.
end_comment

begin_decl_stmt
specifier|const
name|MappingDesc
name|kMemoryLayout
index|[]
init|=
block|{
block|{
literal|0x000000000000ULL
block|,
literal|0x000200000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-1"
block|}
block|,
block|{
literal|0x000200000000ULL
block|,
literal|0x002200000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x002200000000ULL
block|,
literal|0x004000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-2"
block|}
block|,
block|{
literal|0x004000000000ULL
block|,
literal|0x004200000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x004200000000ULL
block|,
literal|0x006000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-2"
block|}
block|,
block|{
literal|0x006000000000ULL
block|,
literal|0x006200000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x006200000000ULL
block|,
literal|0x008000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-3"
block|}
block|,
block|{
literal|0x008000000000ULL
block|,
literal|0x008200000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-1"
block|}
block|,
block|{
literal|0x008200000000ULL
block|,
literal|0x00a000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-3"
block|}
block|,
block|{
literal|0x00a000000000ULL
block|,
literal|0x00a200000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-1"
block|}
block|,
block|{
literal|0x00a200000000ULL
block|,
literal|0x00c000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-2"
block|}
block|,
block|{
literal|0x00c000000000ULL
block|,
literal|0x00e200000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x00e200000000ULL
block|,
literal|0x00ffffffffffULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-3"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MEM_TO_SHADOW
parameter_list|(
name|mem
parameter_list|)
value|(((uptr)(mem)) ^ 0x8000000000ULL)
end_define

begin_define
define|#
directive|define
name|SHADOW_TO_ORIGIN
parameter_list|(
name|shadow
parameter_list|)
value|(((uptr)(shadow)) + 0x2000000000ULL)
end_define

begin_elif
elif|#
directive|elif
name|SANITIZER_LINUX
operator|&&
name|defined
argument_list|(
name|__aarch64__
argument_list|)
end_elif

begin_comment
comment|// The mapping describes both 39-bits, 42-bits, and 48-bits VMA.  AArch64
end_comment

begin_comment
comment|// maps:
end_comment

begin_comment
comment|// - 0x0000000000000-0x0000010000000: 39/42/48-bits program own segments
end_comment

begin_comment
comment|// - 0x0005500000000-0x0005600000000: 39-bits PIE program segments
end_comment

begin_comment
comment|// - 0x0007f80000000-0x0007fffffffff: 39-bits libraries segments
end_comment

begin_comment
comment|// - 0x002aa00000000-0x002ab00000000: 42-bits PIE program segments
end_comment

begin_comment
comment|// - 0x003ff00000000-0x003ffffffffff: 42-bits libraries segments
end_comment

begin_comment
comment|// - 0x0aaaaa0000000-0x0aaab00000000: 48-bits PIE program segments
end_comment

begin_comment
comment|// - 0xffff000000000-0x1000000000000: 48-bits libraries segments
end_comment

begin_comment
comment|// It is fragmented in multiples segments to increase the memory available
end_comment

begin_comment
comment|// on 42-bits (12.21% of total VMA available for 42-bits and 13.28 for
end_comment

begin_comment
comment|// 39 bits). The 48-bits segments only cover the usual PIE/default segments
end_comment

begin_comment
comment|// plus some more segments (262144GB total, 0.39% total VMA).
end_comment

begin_decl_stmt
specifier|const
name|MappingDesc
name|kMemoryLayout
index|[]
init|=
block|{
block|{
literal|0x00000000000ULL
block|,
literal|0x01000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x01000000000ULL
block|,
literal|0x02000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-2"
block|}
block|,
block|{
literal|0x02000000000ULL
block|,
literal|0x03000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-2"
block|}
block|,
block|{
literal|0x03000000000ULL
block|,
literal|0x04000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-1"
block|}
block|,
block|{
literal|0x04000000000ULL
block|,
literal|0x05000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-1"
block|}
block|,
block|{
literal|0x05000000000ULL
block|,
literal|0x06000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-1"
block|}
block|,
block|{
literal|0x06000000000ULL
block|,
literal|0x07000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x07000000000ULL
block|,
literal|0x08000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-2"
block|}
block|,
block|{
literal|0x08000000000ULL
block|,
literal|0x09000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
comment|// The mappings below are used only for 42-bits VMA.
block|{
literal|0x09000000000ULL
block|,
literal|0x0A000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-3"
block|}
block|,
block|{
literal|0x0A000000000ULL
block|,
literal|0x0B000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-3"
block|}
block|,
block|{
literal|0x0B000000000ULL
block|,
literal|0x0F000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0F000000000ULL
block|,
literal|0x10000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-3"
block|}
block|,
block|{
literal|0x10000000000ULL
block|,
literal|0x11000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x11000000000ULL
block|,
literal|0x12000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-4"
block|}
block|,
block|{
literal|0x12000000000ULL
block|,
literal|0x17000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x17000000000ULL
block|,
literal|0x18000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-4"
block|}
block|,
block|{
literal|0x18000000000ULL
block|,
literal|0x19000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-4"
block|}
block|,
block|{
literal|0x19000000000ULL
block|,
literal|0x20000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x20000000000ULL
block|,
literal|0x21000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-5"
block|}
block|,
block|{
literal|0x21000000000ULL
block|,
literal|0x26000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x26000000000ULL
block|,
literal|0x27000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-5"
block|}
block|,
block|{
literal|0x27000000000ULL
block|,
literal|0x28000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-5"
block|}
block|,
block|{
literal|0x28000000000ULL
block|,
literal|0x29000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-7"
block|}
block|,
block|{
literal|0x29000000000ULL
block|,
literal|0x2A000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-7"
block|}
block|,
block|{
literal|0x2A000000000ULL
block|,
literal|0x2B000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-6"
block|}
block|,
block|{
literal|0x2B000000000ULL
block|,
literal|0x2C000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x2C000000000ULL
block|,
literal|0x2D000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-6"
block|}
block|,
block|{
literal|0x2D000000000ULL
block|,
literal|0x2E000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-6"
block|}
block|,
block|{
literal|0x2E000000000ULL
block|,
literal|0x2F000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-7"
block|}
block|,
block|{
literal|0x2F000000000ULL
block|,
literal|0x39000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x39000000000ULL
block|,
literal|0x3A000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-9"
block|}
block|,
block|{
literal|0x3A000000000ULL
block|,
literal|0x3B000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-9"
block|}
block|,
block|{
literal|0x3B000000000ULL
block|,
literal|0x3C000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-8"
block|}
block|,
block|{
literal|0x3C000000000ULL
block|,
literal|0x3D000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x3D000000000ULL
block|,
literal|0x3E000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-8"
block|}
block|,
block|{
literal|0x3E000000000ULL
block|,
literal|0x3F000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-8"
block|}
block|,
block|{
literal|0x3F000000000ULL
block|,
literal|0x40000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-9"
block|}
block|,
comment|// The mappings below are used only for 48-bits VMA.
comment|// TODO(unknown): 48-bit mapping ony covers the usual PIE, non-PIE
comment|// segments and some more segments totalizing 262144GB of VMA (which cover
comment|// only 0.32% of all 48-bit VMA). Memory avaliability can be increase by
comment|// adding multiple application segments like 39 and 42 mapping.
block|{
literal|0x0040000000000ULL
block|,
literal|0x0041000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0041000000000ULL
block|,
literal|0x0042000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-10"
block|}
block|,
block|{
literal|0x0042000000000ULL
block|,
literal|0x0047000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0047000000000ULL
block|,
literal|0x0048000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-10"
block|}
block|,
block|{
literal|0x0048000000000ULL
block|,
literal|0x0049000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-10"
block|}
block|,
block|{
literal|0x0049000000000ULL
block|,
literal|0x0050000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0050000000000ULL
block|,
literal|0x0051000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-11"
block|}
block|,
block|{
literal|0x0051000000000ULL
block|,
literal|0x0056000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0056000000000ULL
block|,
literal|0x0057000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-11"
block|}
block|,
block|{
literal|0x0057000000000ULL
block|,
literal|0x0058000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-11"
block|}
block|,
block|{
literal|0x0058000000000ULL
block|,
literal|0x0059000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-12"
block|}
block|,
block|{
literal|0x0059000000000ULL
block|,
literal|0x005E000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x005E000000000ULL
block|,
literal|0x005F000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-12"
block|}
block|,
block|{
literal|0x005F000000000ULL
block|,
literal|0x0060000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-12"
block|}
block|,
block|{
literal|0x0060000000000ULL
block|,
literal|0x0061000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0061000000000ULL
block|,
literal|0x0062000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-13"
block|}
block|,
block|{
literal|0x0062000000000ULL
block|,
literal|0x0067000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0067000000000ULL
block|,
literal|0x0068000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-13"
block|}
block|,
block|{
literal|0x0068000000000ULL
block|,
literal|0x0069000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-13"
block|}
block|,
block|{
literal|0x0069000000000ULL
block|,
literal|0x0AAAAA0000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0AAAAA0000000ULL
block|,
literal|0x0AAAB00000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-14"
block|}
block|,
block|{
literal|0x0AAAB00000000ULL
block|,
literal|0x0AACAA0000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0AACAA0000000ULL
block|,
literal|0x0AACB00000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-14"
block|}
block|,
block|{
literal|0x0AACB00000000ULL
block|,
literal|0x0AADAA0000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0AADAA0000000ULL
block|,
literal|0x0AADB00000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-14"
block|}
block|,
block|{
literal|0x0AADB00000000ULL
block|,
literal|0x0FF9F00000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0FF9F00000000ULL
block|,
literal|0x0FFA000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-15"
block|}
block|,
block|{
literal|0x0FFA000000000ULL
block|,
literal|0x0FFAF00000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0FFAF00000000ULL
block|,
literal|0x0FFB000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-15"
block|}
block|,
block|{
literal|0x0FFB000000000ULL
block|,
literal|0x0FFFF00000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x0FFFF00000000ULL
block|,
literal|0x1000000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-15"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MEM_TO_SHADOW
parameter_list|(
name|mem
parameter_list|)
value|((uptr)mem ^ 0x6000000000ULL)
end_define

begin_define
define|#
directive|define
name|SHADOW_TO_ORIGIN
parameter_list|(
name|shadow
parameter_list|)
value|(((uptr)(shadow)) + 0x1000000000ULL)
end_define

begin_elif
elif|#
directive|elif
name|SANITIZER_LINUX
operator|&&
name|SANITIZER_PPC64
end_elif

begin_decl_stmt
specifier|const
name|MappingDesc
name|kMemoryLayout
index|[]
init|=
block|{
block|{
literal|0x000000000000ULL
block|,
literal|0x000100000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"low memory"
block|}
block|,
block|{
literal|0x000100000000ULL
block|,
literal|0x080000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x080000000000ULL
block|,
literal|0x180100000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow"
block|}
block|,
block|{
literal|0x180100000000ULL
block|,
literal|0x1C0000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x1C0000000000ULL
block|,
literal|0x2C0100000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin"
block|}
block|,
block|{
literal|0x2C0100000000ULL
block|,
literal|0x300000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x300000000000ULL
block|,
literal|0x400000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"high memory"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|// Maps low and high app ranges to contiguous space with zero base:
end_comment

begin_comment
comment|//   Low:  0000 0000 0000 - 0000 ffff ffff  ->  1000 0000 0000 - 1000 ffff ffff
end_comment

begin_comment
comment|//   High: 3000 0000 0000 - 3fff ffff ffff  ->  0000 0000 0000 - 0fff ffff ffff
end_comment

begin_define
define|#
directive|define
name|LINEARIZE_MEM
parameter_list|(
name|mem
parameter_list|)
define|\
value|(((uptr)(mem)& ~0x200000000000ULL) ^ 0x100000000000ULL)
end_define

begin_define
define|#
directive|define
name|MEM_TO_SHADOW
parameter_list|(
name|mem
parameter_list|)
value|(LINEARIZE_MEM((mem)) + 0x080000000000ULL)
end_define

begin_define
define|#
directive|define
name|SHADOW_TO_ORIGIN
parameter_list|(
name|shadow
parameter_list|)
value|(((uptr)(shadow)) + 0x140000000000ULL)
end_define

begin_elif
elif|#
directive|elif
name|SANITIZER_FREEBSD
operator|&&
name|SANITIZER_WORDSIZE
operator|==
literal|64
end_elif

begin_comment
comment|// Low memory: main binary, MAP_32BIT mappings and modules
end_comment

begin_comment
comment|// High memory: heap, modules and main thread stack
end_comment

begin_decl_stmt
specifier|const
name|MappingDesc
name|kMemoryLayout
index|[]
init|=
block|{
block|{
literal|0x000000000000ULL
block|,
literal|0x010000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"low memory"
block|}
block|,
block|{
literal|0x010000000000ULL
block|,
literal|0x100000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x100000000000ULL
block|,
literal|0x310000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow"
block|}
block|,
block|{
literal|0x310000000000ULL
block|,
literal|0x380000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x380000000000ULL
block|,
literal|0x590000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin"
block|}
block|,
block|{
literal|0x590000000000ULL
block|,
literal|0x600000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x600000000000ULL
block|,
literal|0x800000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"high memory"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|// Maps low and high app ranges to contiguous space with zero base:
end_comment

begin_comment
comment|//   Low:  0000 0000 0000 - 00ff ffff ffff  ->  2000 0000 0000 - 20ff ffff ffff
end_comment

begin_comment
comment|//   High: 6000 0000 0000 - 7fff ffff ffff  ->  0000 0000 0000 - 1fff ffff ffff
end_comment

begin_define
define|#
directive|define
name|LINEARIZE_MEM
parameter_list|(
name|mem
parameter_list|)
define|\
value|(((uptr)(mem)& ~0xc00000000000ULL) ^ 0x200000000000ULL)
end_define

begin_define
define|#
directive|define
name|MEM_TO_SHADOW
parameter_list|(
name|mem
parameter_list|)
value|(LINEARIZE_MEM((mem)) + 0x100000000000ULL)
end_define

begin_define
define|#
directive|define
name|SHADOW_TO_ORIGIN
parameter_list|(
name|shadow
parameter_list|)
value|(((uptr)(shadow)) + 0x280000000000)
end_define

begin_elif
elif|#
directive|elif
name|SANITIZER_LINUX
operator|&&
name|SANITIZER_WORDSIZE
operator|==
literal|64
end_elif

begin_ifdef
ifdef|#
directive|ifdef
name|MSAN_LINUX_X86_64_OLD_MAPPING
end_ifdef

begin_comment
comment|// Requries PIE binary and ASLR enabled.
end_comment

begin_comment
comment|// Main thread stack and DSOs at 0x7f0000000000 (sometimes 0x7e0000000000).
end_comment

begin_comment
comment|// Heap at 0x600000000000.
end_comment

begin_decl_stmt
specifier|const
name|MappingDesc
name|kMemoryLayout
index|[]
init|=
block|{
block|{
literal|0x000000000000ULL
block|,
literal|0x200000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x200000000000ULL
block|,
literal|0x400000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow"
block|}
block|,
block|{
literal|0x400000000000ULL
block|,
literal|0x600000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin"
block|}
block|,
block|{
literal|0x600000000000ULL
block|,
literal|0x800000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MEM_TO_SHADOW
parameter_list|(
name|mem
parameter_list|)
value|(((uptr)(mem))& ~0x400000000000ULL)
end_define

begin_define
define|#
directive|define
name|SHADOW_TO_ORIGIN
parameter_list|(
name|mem
parameter_list|)
value|(((uptr)(mem)) + 0x200000000000ULL)
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|// MSAN_LINUX_X86_64_OLD_MAPPING
end_comment

begin_comment
comment|// All of the following configurations are supported.
end_comment

begin_comment
comment|// ASLR disabled: main executable and DSOs at 0x555550000000
end_comment

begin_comment
comment|// PIE and ASLR: main executable and DSOs at 0x7f0000000000
end_comment

begin_comment
comment|// non-PIE: main executable below 0x100000000, DSOs at 0x7f0000000000
end_comment

begin_comment
comment|// Heap at 0x700000000000.
end_comment

begin_decl_stmt
specifier|const
name|MappingDesc
name|kMemoryLayout
index|[]
init|=
block|{
block|{
literal|0x000000000000ULL
block|,
literal|0x010000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-1"
block|}
block|,
block|{
literal|0x010000000000ULL
block|,
literal|0x100000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-2"
block|}
block|,
block|{
literal|0x100000000000ULL
block|,
literal|0x110000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x110000000000ULL
block|,
literal|0x200000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-2"
block|}
block|,
block|{
literal|0x200000000000ULL
block|,
literal|0x300000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-3"
block|}
block|,
block|{
literal|0x300000000000ULL
block|,
literal|0x400000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-3"
block|}
block|,
block|{
literal|0x400000000000ULL
block|,
literal|0x500000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x500000000000ULL
block|,
literal|0x510000000000ULL
block|,
name|MappingDesc
operator|::
name|SHADOW
block|,
literal|"shadow-1"
block|}
block|,
block|{
literal|0x510000000000ULL
block|,
literal|0x600000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-2"
block|}
block|,
block|{
literal|0x600000000000ULL
block|,
literal|0x610000000000ULL
block|,
name|MappingDesc
operator|::
name|ORIGIN
block|,
literal|"origin-1"
block|}
block|,
block|{
literal|0x610000000000ULL
block|,
literal|0x700000000000ULL
block|,
name|MappingDesc
operator|::
name|INVALID
block|,
literal|"invalid"
block|}
block|,
block|{
literal|0x700000000000ULL
block|,
literal|0x800000000000ULL
block|,
name|MappingDesc
operator|::
name|APP
block|,
literal|"app-3"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MEM_TO_SHADOW
parameter_list|(
name|mem
parameter_list|)
value|(((uptr)(mem)) ^ 0x500000000000ULL)
end_define

begin_define
define|#
directive|define
name|SHADOW_TO_ORIGIN
parameter_list|(
name|mem
parameter_list|)
value|(((uptr)(mem)) + 0x100000000000ULL)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// MSAN_LINUX_X86_64_OLD_MAPPING
end_comment

begin_else
else|#
directive|else
end_else

begin_error
error|#
directive|error
literal|"Unsupported platform"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|const
name|uptr
name|kMemoryLayoutSize
init|=
sizeof|sizeof
argument_list|(
name|kMemoryLayout
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|kMemoryLayout
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MEM_TO_ORIGIN
parameter_list|(
name|mem
parameter_list|)
value|(SHADOW_TO_ORIGIN(MEM_TO_SHADOW((mem))))
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|__clang__
end_ifndef

begin_macro
name|__attribute__
argument_list|(
argument|(optimize(
literal|"unroll-loops"
argument|))
argument_list|)
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|inline
name|bool
name|addr_is_type
argument_list|(
name|uptr
name|addr
argument_list|,
name|MappingDesc
operator|::
name|Type
name|mapping_type
argument_list|)
block|{
comment|// It is critical for performance that this loop is unrolled (because then it is
comment|// simplified into just a few constant comparisons).
ifdef|#
directive|ifdef
name|__clang__
pragma|#
directive|pragma
name|unroll
endif|#
directive|endif
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|;
name|i
operator|<
name|kMemoryLayoutSize
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|kMemoryLayout
index|[
name|i
index|]
operator|.
name|type
operator|==
name|mapping_type
operator|&&
name|addr
operator|>=
name|kMemoryLayout
index|[
name|i
index|]
operator|.
name|start
operator|&&
name|addr
operator|<
name|kMemoryLayout
index|[
name|i
index|]
operator|.
name|end
condition|)
return|return
name|true
return|;
return|return
name|false
return|;
block|}
end_decl_stmt

begin_define
define|#
directive|define
name|MEM_IS_APP
parameter_list|(
name|mem
parameter_list|)
value|addr_is_type((uptr)(mem), MappingDesc::APP)
end_define

begin_define
define|#
directive|define
name|MEM_IS_SHADOW
parameter_list|(
name|mem
parameter_list|)
value|addr_is_type((uptr)(mem), MappingDesc::SHADOW)
end_define

begin_define
define|#
directive|define
name|MEM_IS_ORIGIN
parameter_list|(
name|mem
parameter_list|)
value|addr_is_type((uptr)(mem), MappingDesc::ORIGIN)
end_define

begin_comment
comment|// These constants must be kept in sync with the ones in MemorySanitizer.cc.
end_comment

begin_decl_stmt
specifier|const
name|int
name|kMsanParamTlsSize
init|=
literal|800
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|int
name|kMsanRetvalTlsSize
init|=
literal|800
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|namespace
name|__msan
block|{
specifier|extern
name|int
name|msan_inited
decl_stmt|;
specifier|extern
name|bool
name|msan_init_is_running
decl_stmt|;
specifier|extern
name|int
name|msan_report_count
decl_stmt|;
name|bool
name|ProtectRange
parameter_list|(
name|uptr
name|beg
parameter_list|,
name|uptr
name|end
parameter_list|)
function_decl|;
name|bool
name|InitShadow
parameter_list|(
name|bool
name|init_origins
parameter_list|)
function_decl|;
name|char
modifier|*
name|GetProcSelfMaps
parameter_list|()
function_decl|;
name|void
name|InitializeInterceptors
parameter_list|()
function_decl|;
name|void
name|MsanAllocatorInit
parameter_list|()
function_decl|;
name|void
name|MsanAllocatorThreadFinish
parameter_list|()
function_decl|;
name|void
name|MsanDeallocate
parameter_list|(
name|StackTrace
modifier|*
name|stack
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
function_decl|;
name|void
modifier|*
name|msan_malloc
parameter_list|(
name|uptr
name|size
parameter_list|,
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
name|void
modifier|*
name|msan_calloc
parameter_list|(
name|uptr
name|nmemb
parameter_list|,
name|uptr
name|size
parameter_list|,
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
name|void
modifier|*
name|msan_realloc
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|,
name|uptr
name|size
parameter_list|,
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
name|void
modifier|*
name|msan_valloc
parameter_list|(
name|uptr
name|size
parameter_list|,
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
name|void
modifier|*
name|msan_pvalloc
parameter_list|(
name|uptr
name|size
parameter_list|,
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
name|void
modifier|*
name|msan_aligned_alloc
parameter_list|(
name|uptr
name|alignment
parameter_list|,
name|uptr
name|size
parameter_list|,
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
name|void
modifier|*
name|msan_memalign
parameter_list|(
name|uptr
name|alignment
parameter_list|,
name|uptr
name|size
parameter_list|,
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
name|int
name|msan_posix_memalign
parameter_list|(
name|void
modifier|*
modifier|*
name|memptr
parameter_list|,
name|uptr
name|alignment
parameter_list|,
name|uptr
name|size
parameter_list|,
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
name|void
name|InstallTrapHandler
parameter_list|()
function_decl|;
name|void
name|InstallAtExitHandler
parameter_list|()
function_decl|;
specifier|const
name|char
modifier|*
name|GetStackOriginDescr
parameter_list|(
name|u32
name|id
parameter_list|,
name|uptr
modifier|*
name|pc
parameter_list|)
function_decl|;
name|void
name|EnterSymbolizer
parameter_list|()
function_decl|;
name|void
name|ExitSymbolizer
parameter_list|()
function_decl|;
name|bool
name|IsInSymbolizer
parameter_list|()
function_decl|;
struct|struct
name|SymbolizerScope
block|{
name|SymbolizerScope
argument_list|()
block|{
name|EnterSymbolizer
argument_list|()
expr_stmt|;
block|}
operator|~
name|SymbolizerScope
argument_list|()
block|{
name|ExitSymbolizer
argument_list|()
block|; }
block|}
struct|;
name|void
name|PrintWarning
parameter_list|(
name|uptr
name|pc
parameter_list|,
name|uptr
name|bp
parameter_list|)
function_decl|;
name|void
name|PrintWarningWithOrigin
parameter_list|(
name|uptr
name|pc
parameter_list|,
name|uptr
name|bp
parameter_list|,
name|u32
name|origin
parameter_list|)
function_decl|;
name|void
name|GetStackTrace
parameter_list|(
name|BufferedStackTrace
modifier|*
name|stack
parameter_list|,
name|uptr
name|max_s
parameter_list|,
name|uptr
name|pc
parameter_list|,
name|uptr
name|bp
parameter_list|,
name|bool
name|request_fast_unwind
parameter_list|)
function_decl|;
name|void
name|ReportUMR
parameter_list|(
name|StackTrace
modifier|*
name|stack
parameter_list|,
name|u32
name|origin
parameter_list|)
function_decl|;
name|void
name|ReportExpectedUMRNotFound
parameter_list|(
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
name|void
name|ReportStats
parameter_list|()
function_decl|;
name|void
name|ReportAtExitStatistics
parameter_list|()
function_decl|;
name|void
name|DescribeMemoryRange
parameter_list|(
specifier|const
name|void
modifier|*
name|x
parameter_list|,
name|uptr
name|size
parameter_list|)
function_decl|;
name|void
name|ReportUMRInsideAddressRange
parameter_list|(
specifier|const
name|char
modifier|*
name|what
parameter_list|,
specifier|const
name|void
modifier|*
name|start
parameter_list|,
name|uptr
name|size
parameter_list|,
name|uptr
name|offset
parameter_list|)
function_decl|;
comment|// Unpoison first n function arguments.
name|void
name|UnpoisonParam
parameter_list|(
name|uptr
name|n
parameter_list|)
function_decl|;
name|void
name|UnpoisonThreadLocalState
parameter_list|()
function_decl|;
comment|// Returns a "chained" origin id, pointing to the given stack trace followed by
comment|// the previous origin id.
name|u32
name|ChainOrigin
parameter_list|(
name|u32
name|id
parameter_list|,
name|StackTrace
modifier|*
name|stack
parameter_list|)
function_decl|;
specifier|const
name|int
name|STACK_TRACE_TAG_POISON
init|=
name|StackTrace
operator|::
name|TAG_CUSTOM
operator|+
literal|1
decl_stmt|;
define|#
directive|define
name|GET_MALLOC_STACK_TRACE
define|\
value|BufferedStackTrace stack;                                                    \   if (__msan_get_track_origins()&& msan_inited)                               \   GetStackTrace(&stack, common_flags()->malloc_context_size,                   \                 StackTrace::GetCurrentPc(), GET_CURRENT_FRAME(),               \                 common_flags()->fast_unwind_on_malloc)
comment|// For platforms which support slow unwinder only, we restrict the store context
comment|// size to 1, basically only storing the current pc. We do this because the slow
comment|// unwinder which is based on libunwind is not async signal safe and causes
comment|// random freezes in forking applications as well as in signal handlers.
define|#
directive|define
name|GET_STORE_STACK_TRACE_PC_BP
parameter_list|(
name|pc
parameter_list|,
name|bp
parameter_list|)
define|\
value|BufferedStackTrace stack;                                                    \   if (__msan_get_track_origins()> 1&& msan_inited) {                         \     if (!SANITIZER_CAN_FAST_UNWIND)                                            \       GetStackTrace(&stack, Min(1, flags()->store_context_size), pc, bp,       \                     false);                                                    \     else                                                                       \       GetStackTrace(&stack, flags()->store_context_size, pc, bp,               \                     common_flags()->fast_unwind_on_malloc);                    \   }
define|#
directive|define
name|GET_FATAL_STACK_TRACE_PC_BP
parameter_list|(
name|pc
parameter_list|,
name|bp
parameter_list|)
define|\
value|BufferedStackTrace stack;                                                    \   if (msan_inited)                                                             \   GetStackTrace(&stack, kStackTraceMax, pc, bp,                                \                 common_flags()->fast_unwind_on_fatal)
define|#
directive|define
name|GET_STORE_STACK_TRACE
define|\
value|GET_STORE_STACK_TRACE_PC_BP(StackTrace::GetCurrentPc(), GET_CURRENT_FRAME())
name|class
name|ScopedThreadLocalStateBackup
block|{
name|public
label|:
name|ScopedThreadLocalStateBackup
argument_list|()
block|{
name|Backup
argument_list|()
expr_stmt|;
block|}
operator|~
name|ScopedThreadLocalStateBackup
argument_list|()
block|{
name|Restore
argument_list|()
block|; }
name|void
name|Backup
argument_list|()
expr_stmt|;
name|void
name|Restore
parameter_list|()
function_decl|;
name|private
label|:
name|u64
name|va_arg_overflow_size_tls
decl_stmt|;
block|}
empty_stmt|;
name|void
name|MsanTSDInit
parameter_list|(
name|void
function_decl|(
modifier|*
name|destructor
function_decl|)
parameter_list|(
name|void
modifier|*
name|tsd
parameter_list|)
parameter_list|)
function_decl|;
name|void
modifier|*
name|MsanTSDGet
parameter_list|()
function_decl|;
name|void
name|MsanTSDSet
parameter_list|(
name|void
modifier|*
name|tsd
parameter_list|)
function_decl|;
name|void
name|MsanTSDDtor
parameter_list|(
name|void
modifier|*
name|tsd
parameter_list|)
function_decl|;
block|}
end_decl_stmt

begin_comment
comment|// namespace __msan
end_comment

begin_define
define|#
directive|define
name|MSAN_MALLOC_HOOK
parameter_list|(
name|ptr
parameter_list|,
name|size
parameter_list|)
define|\
value|do {                                    \     if (&__sanitizer_malloc_hook) {       \       UnpoisonParam(2);                   \       __sanitizer_malloc_hook(ptr, size); \     }                                     \     RunMallocHooks(ptr, size);            \   } while (false)
end_define

begin_define
define|#
directive|define
name|MSAN_FREE_HOOK
parameter_list|(
name|ptr
parameter_list|)
define|\
value|do {                            \     if (&__sanitizer_free_hook) { \       UnpoisonParam(1);           \       __sanitizer_free_hook(ptr); \     }                             \     RunFreeHooks(ptr);            \   } while (false)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// MSAN_H
end_comment

end_unit


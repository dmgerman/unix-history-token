begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*===- InstrProfilingMerge.c - Profile in-process Merging  ---------------===*\ |* |*                     The LLVM Compiler Infrastructure |* |* This file is distributed under the University of Illinois Open Source |* License. See LICENSE.TXT for details. |* |*===----------------------------------------------------------------------===* |* This file defines the API needed for in-process merging of profile data |* stored in memory buffer. \*===---------------------------------------------------------------------===*/
end_comment

begin_include
include|#
directive|include
file|"InstrProfiling.h"
end_include

begin_include
include|#
directive|include
file|"InstrProfilingInternal.h"
end_include

begin_include
include|#
directive|include
file|"InstrProfilingUtil.h"
end_include

begin_define
define|#
directive|define
name|INSTR_PROF_VALUE_PROF_DATA
end_define

begin_include
include|#
directive|include
file|"InstrProfData.inc"
end_include

begin_function_decl
name|COMPILER_RT_WEAK
name|void
function_decl|(
modifier|*
name|VPMergeHook
function_decl|)
parameter_list|(
name|ValueProfData
modifier|*
parameter_list|,
name|__llvm_profile_data
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function
name|COMPILER_RT_VISIBILITY
name|uint64_t
name|lprofGetLoadModuleSignature
parameter_list|()
block|{
comment|/* A very fast way to compute a module signature.  */
name|uint64_t
name|CounterSize
init|=
call|(
name|uint64_t
call|)
argument_list|(
name|__llvm_profile_end_counters
argument_list|()
operator|-
name|__llvm_profile_begin_counters
argument_list|()
argument_list|)
decl_stmt|;
name|uint64_t
name|DataSize
init|=
name|__llvm_profile_get_data_size
argument_list|(
name|__llvm_profile_begin_data
argument_list|()
argument_list|,
name|__llvm_profile_end_data
argument_list|()
argument_list|)
decl_stmt|;
name|uint64_t
name|NamesSize
init|=
call|(
name|uint64_t
call|)
argument_list|(
name|__llvm_profile_end_names
argument_list|()
operator|-
name|__llvm_profile_begin_names
argument_list|()
argument_list|)
decl_stmt|;
name|uint64_t
name|NumVnodes
init|=
call|(
name|uint64_t
call|)
argument_list|(
name|__llvm_profile_end_vnodes
argument_list|()
operator|-
name|__llvm_profile_begin_vnodes
argument_list|()
argument_list|)
decl_stmt|;
specifier|const
name|__llvm_profile_data
modifier|*
name|FirstD
init|=
name|__llvm_profile_begin_data
argument_list|()
decl_stmt|;
return|return
operator|(
name|NamesSize
operator|<<
literal|40
operator|)
operator|+
operator|(
name|CounterSize
operator|<<
literal|30
operator|)
operator|+
operator|(
name|DataSize
operator|<<
literal|20
operator|)
operator|+
operator|(
name|NumVnodes
operator|<<
literal|10
operator|)
operator|+
operator|(
name|DataSize
operator|>
literal|0
condition|?
name|FirstD
operator|->
name|NameRef
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Returns 1 if profile is not structurally compatible.  */
end_comment

begin_function
name|COMPILER_RT_VISIBILITY
name|int
name|__llvm_profile_check_compatibility
parameter_list|(
specifier|const
name|char
modifier|*
name|ProfileData
parameter_list|,
name|uint64_t
name|ProfileSize
parameter_list|)
block|{
comment|/* Check profile header only for now  */
name|__llvm_profile_header
modifier|*
name|Header
init|=
operator|(
name|__llvm_profile_header
operator|*
operator|)
name|ProfileData
decl_stmt|;
name|__llvm_profile_data
modifier|*
name|SrcDataStart
decl_stmt|,
modifier|*
name|SrcDataEnd
decl_stmt|,
modifier|*
name|SrcData
decl_stmt|,
modifier|*
name|DstData
decl_stmt|;
name|SrcDataStart
operator|=
operator|(
name|__llvm_profile_data
operator|*
operator|)
operator|(
name|ProfileData
operator|+
sizeof|sizeof
argument_list|(
name|__llvm_profile_header
argument_list|)
operator|)
expr_stmt|;
name|SrcDataEnd
operator|=
name|SrcDataStart
operator|+
name|Header
operator|->
name|DataSize
expr_stmt|;
if|if
condition|(
name|ProfileSize
operator|<
sizeof|sizeof
argument_list|(
name|__llvm_profile_header
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* Check the header first.  */
if|if
condition|(
name|Header
operator|->
name|Magic
operator|!=
name|__llvm_profile_get_magic
argument_list|()
operator|||
name|Header
operator|->
name|Version
operator|!=
name|__llvm_profile_get_version
argument_list|()
operator|||
name|Header
operator|->
name|DataSize
operator|!=
name|__llvm_profile_get_data_size
argument_list|(
name|__llvm_profile_begin_data
argument_list|()
argument_list|,
name|__llvm_profile_end_data
argument_list|()
argument_list|)
operator|||
name|Header
operator|->
name|CountersSize
operator|!=
call|(
name|uint64_t
call|)
argument_list|(
name|__llvm_profile_end_counters
argument_list|()
operator|-
name|__llvm_profile_begin_counters
argument_list|()
argument_list|)
operator|||
name|Header
operator|->
name|NamesSize
operator|!=
call|(
name|uint64_t
call|)
argument_list|(
name|__llvm_profile_end_names
argument_list|()
operator|-
name|__llvm_profile_begin_names
argument_list|()
argument_list|)
operator|||
name|Header
operator|->
name|ValueKindLast
operator|!=
name|IPVK_Last
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|ProfileSize
operator|<
sizeof|sizeof
argument_list|(
name|__llvm_profile_header
argument_list|)
operator|+
name|Header
operator|->
name|DataSize
operator|*
sizeof|sizeof
argument_list|(
name|__llvm_profile_data
argument_list|)
operator|+
name|Header
operator|->
name|NamesSize
operator|+
name|Header
operator|->
name|CountersSize
condition|)
return|return
literal|1
return|;
for|for
control|(
name|SrcData
operator|=
name|SrcDataStart
operator|,
name|DstData
operator|=
operator|(
name|__llvm_profile_data
operator|*
operator|)
name|__llvm_profile_begin_data
argument_list|()
init|;
name|SrcData
operator|<
name|SrcDataEnd
condition|;
operator|++
name|SrcData
operator|,
operator|++
name|DstData
control|)
block|{
if|if
condition|(
name|SrcData
operator|->
name|NameRef
operator|!=
name|DstData
operator|->
name|NameRef
operator|||
name|SrcData
operator|->
name|FuncHash
operator|!=
name|DstData
operator|->
name|FuncHash
operator|||
name|SrcData
operator|->
name|NumCounters
operator|!=
name|DstData
operator|->
name|NumCounters
condition|)
return|return
literal|1
return|;
block|}
comment|/* Matched! */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|COMPILER_RT_VISIBILITY
name|void
name|__llvm_profile_merge_from_buffer
parameter_list|(
specifier|const
name|char
modifier|*
name|ProfileData
parameter_list|,
name|uint64_t
name|ProfileSize
parameter_list|)
block|{
name|__llvm_profile_data
modifier|*
name|SrcDataStart
decl_stmt|,
modifier|*
name|SrcDataEnd
decl_stmt|,
modifier|*
name|SrcData
decl_stmt|,
modifier|*
name|DstData
decl_stmt|;
name|__llvm_profile_header
modifier|*
name|Header
init|=
operator|(
name|__llvm_profile_header
operator|*
operator|)
name|ProfileData
decl_stmt|;
name|uint64_t
modifier|*
name|SrcCountersStart
decl_stmt|;
specifier|const
name|char
modifier|*
name|SrcNameStart
decl_stmt|;
name|ValueProfData
modifier|*
name|SrcValueProfDataStart
decl_stmt|,
modifier|*
name|SrcValueProfData
decl_stmt|;
name|SrcDataStart
operator|=
operator|(
name|__llvm_profile_data
operator|*
operator|)
operator|(
name|ProfileData
operator|+
sizeof|sizeof
argument_list|(
name|__llvm_profile_header
argument_list|)
operator|)
expr_stmt|;
name|SrcDataEnd
operator|=
name|SrcDataStart
operator|+
name|Header
operator|->
name|DataSize
expr_stmt|;
name|SrcCountersStart
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|SrcDataEnd
expr_stmt|;
name|SrcNameStart
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|SrcCountersStart
operator|+
name|Header
operator|->
name|CountersSize
operator|)
expr_stmt|;
name|SrcValueProfDataStart
operator|=
operator|(
name|ValueProfData
operator|*
operator|)
operator|(
name|SrcNameStart
operator|+
name|Header
operator|->
name|NamesSize
operator|+
name|__llvm_profile_get_num_padding_bytes
argument_list|(
name|Header
operator|->
name|NamesSize
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|SrcData
operator|=
name|SrcDataStart
operator|,
name|DstData
operator|=
operator|(
name|__llvm_profile_data
operator|*
operator|)
name|__llvm_profile_begin_data
argument_list|()
operator|,
name|SrcValueProfData
operator|=
name|SrcValueProfDataStart
init|;
name|SrcData
operator|<
name|SrcDataEnd
condition|;
operator|++
name|SrcData
operator|,
operator|++
name|DstData
control|)
block|{
name|uint64_t
modifier|*
name|SrcCounters
decl_stmt|;
name|uint64_t
modifier|*
name|DstCounters
init|=
operator|(
name|uint64_t
operator|*
operator|)
name|DstData
operator|->
name|CounterPtr
decl_stmt|;
name|unsigned
name|I
decl_stmt|,
name|NC
decl_stmt|,
name|NVK
init|=
literal|0
decl_stmt|;
name|NC
operator|=
name|SrcData
operator|->
name|NumCounters
expr_stmt|;
name|SrcCounters
operator|=
name|SrcCountersStart
operator|+
operator|(
operator|(
name|size_t
operator|)
name|SrcData
operator|->
name|CounterPtr
operator|-
name|Header
operator|->
name|CountersDelta
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
expr_stmt|;
for|for
control|(
name|I
operator|=
literal|0
init|;
name|I
operator|<
name|NC
condition|;
name|I
operator|++
control|)
name|DstCounters
index|[
name|I
index|]
operator|+=
name|SrcCounters
index|[
name|I
index|]
expr_stmt|;
comment|/* Now merge value profile data.  */
if|if
condition|(
operator|!
name|VPMergeHook
condition|)
continue|continue;
for|for
control|(
name|I
operator|=
literal|0
init|;
name|I
operator|<=
name|IPVK_Last
condition|;
name|I
operator|++
control|)
name|NVK
operator|+=
operator|(
name|SrcData
operator|->
name|NumValueSites
index|[
name|I
index|]
operator|!=
literal|0
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|NVK
condition|)
continue|continue;
name|VPMergeHook
argument_list|(
name|SrcValueProfData
argument_list|,
name|DstData
argument_list|)
expr_stmt|;
name|SrcValueProfData
operator|=
operator|(
name|ValueProfData
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|SrcValueProfData
operator|+
name|SrcValueProfData
operator|->
name|TotalSize
operator|)
expr_stmt|;
block|}
block|}
end_function

end_unit


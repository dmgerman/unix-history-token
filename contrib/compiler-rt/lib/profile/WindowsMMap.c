begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * This code is derived from uClibc (original license follows).  * https://git.uclibc.org/uClibc/tree/utils/mmap-windows.c  */
end_comment

begin_comment
comment|/* mmap() replacement for Windows  *  * Author: Mike Frysinger<vapier@gentoo.org>  * Placed into the public domain  */
end_comment

begin_comment
comment|/* References:  * CreateFileMapping: http://msdn.microsoft.com/en-us/library/aa366537(VS.85).aspx  * CloseHandle:       http://msdn.microsoft.com/en-us/library/ms724211(VS.85).aspx  * MapViewOfFile:     http://msdn.microsoft.com/en-us/library/aa366761(VS.85).aspx  * UnmapViewOfFile:   http://msdn.microsoft.com/en-us/library/aa366882(VS.85).aspx  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_WIN32
argument_list|)
end_if

begin_include
include|#
directive|include
file|"WindowsMMap.h"
end_include

begin_include
include|#
directive|include
file|"InstrProfiling.h"
end_include

begin_define
define|#
directive|define
name|WIN32_LEAN_AND_MEAN
end_define

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__USE_FILE_OFFSET64
end_ifdef

begin_define
define|#
directive|define
name|DWORD_HI
parameter_list|(
name|x
parameter_list|)
value|(x>> 32)
end_define

begin_define
define|#
directive|define
name|DWORD_LO
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xffffffff)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DWORD_HI
parameter_list|(
name|x
parameter_list|)
value|(0)
end_define

begin_define
define|#
directive|define
name|DWORD_LO
parameter_list|(
name|x
parameter_list|)
value|(x)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|COMPILER_RT_VISIBILITY
name|void
modifier|*
name|mmap
parameter_list|(
name|void
modifier|*
name|start
parameter_list|,
name|size_t
name|length
parameter_list|,
name|int
name|prot
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|fd
parameter_list|,
name|off_t
name|offset
parameter_list|)
block|{
if|if
condition|(
name|prot
operator|&
operator|~
operator|(
name|PROT_READ
operator||
name|PROT_WRITE
operator||
name|PROT_EXEC
operator|)
condition|)
return|return
name|MAP_FAILED
return|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|MAP_ANON
operator|)
operator|||
name|offset
condition|)
return|return
name|MAP_FAILED
return|;
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|MAP_ANON
condition|)
return|return
name|MAP_FAILED
return|;
name|DWORD
name|flProtect
decl_stmt|;
if|if
condition|(
name|prot
operator|&
name|PROT_WRITE
condition|)
block|{
if|if
condition|(
name|prot
operator|&
name|PROT_EXEC
condition|)
name|flProtect
operator|=
name|PAGE_EXECUTE_READWRITE
expr_stmt|;
else|else
name|flProtect
operator|=
name|PAGE_READWRITE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|prot
operator|&
name|PROT_EXEC
condition|)
block|{
if|if
condition|(
name|prot
operator|&
name|PROT_READ
condition|)
name|flProtect
operator|=
name|PAGE_EXECUTE_READ
expr_stmt|;
elseif|else
if|if
condition|(
name|prot
operator|&
name|PROT_EXEC
condition|)
name|flProtect
operator|=
name|PAGE_EXECUTE
expr_stmt|;
block|}
else|else
name|flProtect
operator|=
name|PAGE_READONLY
expr_stmt|;
name|off_t
name|end
init|=
name|length
operator|+
name|offset
decl_stmt|;
name|HANDLE
name|mmap_fd
decl_stmt|,
name|h
decl_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
name|mmap_fd
operator|=
name|INVALID_HANDLE_VALUE
expr_stmt|;
else|else
name|mmap_fd
operator|=
operator|(
name|HANDLE
operator|)
name|_get_osfhandle
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|h
operator|=
name|CreateFileMapping
argument_list|(
name|mmap_fd
argument_list|,
name|NULL
argument_list|,
name|flProtect
argument_list|,
name|DWORD_HI
argument_list|(
name|end
argument_list|)
argument_list|,
name|DWORD_LO
argument_list|(
name|end
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
return|return
name|MAP_FAILED
return|;
name|DWORD
name|dwDesiredAccess
decl_stmt|;
if|if
condition|(
name|prot
operator|&
name|PROT_WRITE
condition|)
name|dwDesiredAccess
operator|=
name|FILE_MAP_WRITE
expr_stmt|;
else|else
name|dwDesiredAccess
operator|=
name|FILE_MAP_READ
expr_stmt|;
if|if
condition|(
name|prot
operator|&
name|PROT_EXEC
condition|)
name|dwDesiredAccess
operator||=
name|FILE_MAP_EXECUTE
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|MAP_PRIVATE
condition|)
name|dwDesiredAccess
operator||=
name|FILE_MAP_COPY
expr_stmt|;
name|void
modifier|*
name|ret
init|=
name|MapViewOfFile
argument_list|(
name|h
argument_list|,
name|dwDesiredAccess
argument_list|,
name|DWORD_HI
argument_list|(
name|offset
argument_list|)
argument_list|,
name|DWORD_LO
argument_list|(
name|offset
argument_list|)
argument_list|,
name|length
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
name|CloseHandle
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|ret
operator|=
name|MAP_FAILED
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|COMPILER_RT_VISIBILITY
name|void
name|munmap
parameter_list|(
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|UnmapViewOfFile
argument_list|(
name|addr
argument_list|)
expr_stmt|;
comment|/* ruh-ro, we leaked handle from CreateFileMapping() ... */
block|}
end_function

begin_function
name|COMPILER_RT_VISIBILITY
name|int
name|msync
parameter_list|(
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|length
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
if|if
condition|(
name|flags
operator|&
name|MS_INVALIDATE
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Not supported. */
comment|/* Exactly one of MS_ASYNC or MS_SYNC must be specified. */
switch|switch
condition|(
name|flags
operator|&
operator|(
name|MS_ASYNC
operator||
name|MS_SYNC
operator|)
condition|)
block|{
case|case
name|MS_SYNC
case|:
case|case
name|MS_ASYNC
case|:
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|FlushViewOfFile
argument_list|(
name|addr
argument_list|,
name|length
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|flags
operator|&
name|MS_SYNC
condition|)
block|{
comment|/* FIXME: No longer have access to handle from CreateFileMapping(). */
comment|/*      * if (!FlushFileBuffers(h))      *   return -1;      */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|COMPILER_RT_VISIBILITY
name|int
name|flock
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|operation
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
comment|/* Not supported. */
block|}
end_function

begin_undef
undef|#
directive|undef
name|DWORD_HI
end_undef

begin_undef
undef|#
directive|undef
name|DWORD_LO
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _WIN32 */
end_comment

end_unit


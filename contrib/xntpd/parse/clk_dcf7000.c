begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_if
if|#
directive|if
name|defined
argument_list|(
name|REFCLOCK
argument_list|)
operator|&&
operator|(
name|defined
argument_list|(
name|PARSE
argument_list|)
operator|||
name|defined
argument_list|(
name|PARSEPPS
argument_list|)
operator|)
operator|&&
name|defined
argument_list|(
name|CLOCK_DCF7000
argument_list|)
end_if

begin_comment
comment|/*  * /src/NTP/REPOSITORY/v3/parse/clk_dcf7000.c,v 3.11 1994/02/02 17:45:14 kardel Exp  *    * clk_dcf7000.c,v 3.11 1994/02/02 17:45:14 kardel Exp  *  * ELV DCF7000 module  *  * Copyright (c) 1992,1993,1994  * Frank Kardel Friedrich-Alexander Universitaet Erlangen-Nuernberg  *                                      * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  */
end_comment

begin_include
include|#
directive|include
file|"sys/types.h"
end_include

begin_include
include|#
directive|include
file|"sys/time.h"
end_include

begin_include
include|#
directive|include
file|"sys/errno.h"
end_include

begin_include
include|#
directive|include
file|"ntp_fp.h"
end_include

begin_include
include|#
directive|include
file|"ntp_unixtime.h"
end_include

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"parse.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|format
name|dcf7000_fmt
init|=
block|{
comment|/* ELV DCF7000 */
block|{
block|{
literal|6
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|2
block|}
block|,
block|{
literal|0
block|,
literal|2
block|}
block|,
block|{
literal|12
block|,
literal|2
block|}
block|,
block|{
literal|15
block|,
literal|2
block|}
block|,
block|{
literal|18
block|,
literal|2
block|}
block|,
block|{
literal|9
block|,
literal|2
block|}
block|,
block|{
literal|21
block|,
literal|2
block|}
block|,   }
block|,
literal|"  -  -  -  -  -  -  -  \r"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|unsigned
name|LONG
name|cvt_dcf7000
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|clockformat_t
name|clock_dcf7000
init|=
block|{
name|cvt_dcf7000
block|,
comment|/* ELV DCF77 conversion */
name|syn_simple
block|,
comment|/* easy time stamps */
operator|(
name|unsigned
name|LONG
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
literal|0
block|,
comment|/* no direct PPS monitoring */
operator|(
name|unsigned
name|LONG
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
literal|0
block|,
comment|/* no time code synthesizer monitoring */
operator|(
name|void
operator|*
operator|)
operator|&
name|dcf7000_fmt
block|,
comment|/* conversion configuration */
literal|"ELV DCF7000"
block|,
comment|/* ELV clock */
literal|24
block|,
comment|/* string buffer */
name|F_END
operator||
name|SYNC_END
block|,
comment|/* END packet delimiter / synchronisation */
block|{
literal|0
block|,
literal|0
block|}
block|,
literal|'\0'
block|,
literal|'\r'
block|,
literal|'\0'
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * cvt_dcf7000  *  * convert dcf7000 type format  */
end_comment

begin_function
specifier|static
name|unsigned
name|LONG
name|cvt_dcf7000
parameter_list|(
name|buffer
parameter_list|,
name|size
parameter_list|,
name|format
parameter_list|,
name|clock
parameter_list|)
specifier|register
name|char
modifier|*
name|buffer
decl_stmt|;
specifier|register
name|int
name|size
decl_stmt|;
specifier|register
name|struct
name|format
modifier|*
name|format
decl_stmt|;
specifier|register
name|clocktime_t
modifier|*
name|clock
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|Strok
argument_list|(
name|buffer
argument_list|,
name|format
operator|->
name|fixed_string
argument_list|)
condition|)
block|{
return|return
name|CVT_NONE
return|;
block|}
else|else
block|{
if|if
condition|(
name|Stoi
argument_list|(
operator|&
name|buffer
index|[
name|format
operator|->
name|field_offsets
index|[
name|O_DAY
index|]
operator|.
name|offset
index|]
argument_list|,
operator|&
name|clock
operator|->
name|day
argument_list|,
name|format
operator|->
name|field_offsets
index|[
name|O_DAY
index|]
operator|.
name|length
argument_list|)
operator|||
name|Stoi
argument_list|(
operator|&
name|buffer
index|[
name|format
operator|->
name|field_offsets
index|[
name|O_MONTH
index|]
operator|.
name|offset
index|]
argument_list|,
operator|&
name|clock
operator|->
name|month
argument_list|,
name|format
operator|->
name|field_offsets
index|[
name|O_MONTH
index|]
operator|.
name|length
argument_list|)
operator|||
name|Stoi
argument_list|(
operator|&
name|buffer
index|[
name|format
operator|->
name|field_offsets
index|[
name|O_YEAR
index|]
operator|.
name|offset
index|]
argument_list|,
operator|&
name|clock
operator|->
name|year
argument_list|,
name|format
operator|->
name|field_offsets
index|[
name|O_YEAR
index|]
operator|.
name|length
argument_list|)
operator|||
name|Stoi
argument_list|(
operator|&
name|buffer
index|[
name|format
operator|->
name|field_offsets
index|[
name|O_HOUR
index|]
operator|.
name|offset
index|]
argument_list|,
operator|&
name|clock
operator|->
name|hour
argument_list|,
name|format
operator|->
name|field_offsets
index|[
name|O_HOUR
index|]
operator|.
name|length
argument_list|)
operator|||
name|Stoi
argument_list|(
operator|&
name|buffer
index|[
name|format
operator|->
name|field_offsets
index|[
name|O_MIN
index|]
operator|.
name|offset
index|]
argument_list|,
operator|&
name|clock
operator|->
name|minute
argument_list|,
name|format
operator|->
name|field_offsets
index|[
name|O_MIN
index|]
operator|.
name|length
argument_list|)
operator|||
name|Stoi
argument_list|(
operator|&
name|buffer
index|[
name|format
operator|->
name|field_offsets
index|[
name|O_SEC
index|]
operator|.
name|offset
index|]
argument_list|,
operator|&
name|clock
operator|->
name|second
argument_list|,
name|format
operator|->
name|field_offsets
index|[
name|O_SEC
index|]
operator|.
name|length
argument_list|)
condition|)
block|{
return|return
name|CVT_FAIL
operator||
name|CVT_BADFMT
return|;
block|}
else|else
block|{
name|char
modifier|*
name|f
init|=
operator|&
name|buffer
index|[
name|format
operator|->
name|field_offsets
index|[
name|O_FLAGS
index|]
operator|.
name|offset
index|]
decl_stmt|;
name|LONG
name|flags
decl_stmt|;
name|clock
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|clock
operator|->
name|usecond
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|Stoi
argument_list|(
name|f
argument_list|,
operator|&
name|flags
argument_list|,
name|format
operator|->
name|field_offsets
index|[
name|O_FLAGS
index|]
operator|.
name|length
argument_list|)
condition|)
block|{
return|return
name|CVT_FAIL
operator||
name|CVT_BADFMT
return|;
block|}
else|else
block|{
if|if
condition|(
name|flags
operator|&
literal|0x1
condition|)
name|clock
operator|->
name|utcoffset
operator|=
operator|-
literal|2
operator|*
literal|60
operator|*
literal|60
expr_stmt|;
else|else
name|clock
operator|->
name|utcoffset
operator|=
operator|-
literal|1
operator|*
literal|60
operator|*
literal|60
expr_stmt|;
if|if
condition|(
name|flags
operator|&
literal|0x2
condition|)
name|clock
operator|->
name|flags
operator||=
name|PARSEB_ANNOUNCE
expr_stmt|;
if|if
condition|(
name|flags
operator|&
literal|0x4
condition|)
name|clock
operator|->
name|flags
operator||=
name|PARSEB_NOSYNC
expr_stmt|;
block|}
return|return
name|CVT_OK
return|;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(PARSE)&& defined(CLOCK_DCF7000) */
end_comment

begin_comment
comment|/*  * History:  *  * clk_dcf7000.c,v  * Revision 3.11  1994/02/02  17:45:14  kardel  * rcs ids fixed  *  * Revision 3.6  1993/10/09  15:01:27  kardel  * file structure unified  *  * Revision 3.5  1993/10/03  19:10:41  kardel  * restructured I/O handling  *  * Revision 3.4  1993/09/27  21:08:02  kardel  * utcoffset now in seconds  *  * Revision 3.3  1993/09/26  23:40:20  kardel  * new parse driver logic  *  * Revision 3.2  1993/07/09  11:37:15  kardel  * Initial restructured version + GPS support  *  * Revision 3.1  1993/07/06  10:00:14  kardel  * DCF77 driver goes generic...  *  */
end_comment

end_unit


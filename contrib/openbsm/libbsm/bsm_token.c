begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004 Apple Computer, Inc.  * Copyright (c) 2005 SPARTA, Inc.  * All rights reserved.  *  * This code was developed in part by Robert N. M. Watson, Senior Principal  * Scientist, SPARTA, Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1.  Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  * 2.  Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of  *     its contributors may be used to endorse or promote products derived  *     from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING  * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  * $P4: //depot/projects/trustedbsd/openbsm/libbsm/bsm_token.c#62 $  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<config/config.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_ENDIAN_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !HAVE_SYS_ENDIAN_H */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_MACHINE_ENDIAN_H
end_ifdef

begin_include
include|#
directive|include
file|<machine/endian.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !HAVE_MACHINE_ENDIAN_H */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_ENDIAN_H
end_ifdef

begin_include
include|#
directive|include
file|<endian.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !HAVE_ENDIAN_H */
end_comment

begin_error
error|#
directive|error
literal|"No supported endian.h"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !HAVE_ENDIAN_H */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !HAVE_MACHINE_ENDIAN_H */
end_comment

begin_include
include|#
directive|include
file|<compat/endian.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !HAVE_SYS_ENDIAN_H */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_FULL_QUEUE_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !HAVE_FULL_QUEUE_H */
end_comment

begin_include
include|#
directive|include
file|<compat/queue.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !HAVE_FULL_QUEUE_H */
end_comment

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<sys/ipc.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<bsm/audit_internal.h>
end_include

begin_include
include|#
directive|include
file|<bsm/libbsm.h>
end_include

begin_define
define|#
directive|define
name|GET_TOKEN_AREA
parameter_list|(
name|t
parameter_list|,
name|dptr
parameter_list|,
name|length
parameter_list|)
value|do {				\ 	(t) = malloc(sizeof(token_t));					\ 	if ((t) != NULL) {						\ 		(t)->len = (length);					\ 		(dptr) = (t->t_data) = malloc((length) * sizeof(u_char)); \ 		if ((dptr) == NULL) {					\ 			free(t);					\ 			(t) = NULL;					\ 		} else							\ 			memset((dptr), 0, (length));			\ 	} else								\ 		(dptr) = NULL;						\ 	assert(t == NULL || dptr != NULL);				\ } while (0)
end_define

begin_comment
comment|/*  * token ID                1 byte  * argument #              1 byte  * argument value          4 bytes/8 bytes (32-bit/64-bit value)  * text length             2 bytes  * text                    N bytes + 1 terminating NULL byte  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_arg32
parameter_list|(
name|char
name|n
parameter_list|,
name|char
modifier|*
name|text
parameter_list|,
name|u_int32_t
name|v
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|textlen
decl_stmt|;
name|textlen
operator|=
name|strlen
argument_list|(
name|text
argument_list|)
expr_stmt|;
name|textlen
operator|+=
literal|1
expr_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
name|textlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_ARG32
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|dptr
argument_list|,
name|text
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_arg64
parameter_list|(
name|char
name|n
parameter_list|,
name|char
modifier|*
name|text
parameter_list|,
name|u_int64_t
name|v
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|textlen
decl_stmt|;
name|textlen
operator|=
name|strlen
argument_list|(
name|text
argument_list|)
expr_stmt|;
name|textlen
operator|+=
literal|1
expr_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
name|textlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_ARG64
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|dptr
argument_list|,
name|text
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_arg
parameter_list|(
name|char
name|n
parameter_list|,
name|char
modifier|*
name|text
parameter_list|,
name|u_int32_t
name|v
parameter_list|)
block|{
return|return
operator|(
name|au_to_arg32
argument_list|(
name|n
argument_list|,
name|text
argument_list|,
name|v
argument_list|)
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_KERNEL
argument_list|)
operator|||
name|defined
argument_list|(
name|KERNEL
argument_list|)
end_if

begin_comment
comment|/*  * token ID                1 byte  * file access mode        4 bytes  * owner user ID           4 bytes  * owner group ID          4 bytes  * file system ID          4 bytes  * node ID                 8 bytes  * device                  4 bytes/8 bytes (32-bit/64-bit)  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_attr32
parameter_list|(
name|struct
name|vnode_au_info
modifier|*
name|vni
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|pad0_16
init|=
literal|0
decl_stmt|;
name|u_int16_t
name|pad0_32
init|=
literal|0
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_ATTR32
argument_list|)
expr_stmt|;
comment|/* 	 * Darwin defines the size for the file mode 	 * as 2 bytes; BSM defines 4 so pad with 0 	 */
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|pad0_16
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_mode
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_uid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_gid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_fsid
argument_list|)
expr_stmt|;
comment|/* 	 * Some systems use 32-bit file ID's, other's use 64-bit file IDs. 	 * Attempt to handle both, and let the compiler sort it out.  If we 	 * could pick this out at compile-time, it would be better, so as to 	 * avoid the else case below. 	 */
if|if
condition|(
sizeof|sizeof
argument_list|(
name|vni
operator|->
name|vn_fileid
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
block|{
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pad0_32
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_fileid
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
sizeof|sizeof
argument_list|(
name|vni
operator|->
name|vn_fileid
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
condition|)
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_fileid
argument_list|)
expr_stmt|;
else|else
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
literal|0LL
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_attr64
parameter_list|(
name|struct
name|vnode_au_info
modifier|*
name|vni
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|pad0_16
init|=
literal|0
decl_stmt|;
name|u_int16_t
name|pad0_32
init|=
literal|0
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|*
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_ATTR64
argument_list|)
expr_stmt|;
comment|/* 	 * Darwin defines the size for the file mode 	 * as 2 bytes; BSM defines 4 so pad with 0 	 */
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|pad0_16
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_mode
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_uid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_gid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_fsid
argument_list|)
expr_stmt|;
comment|/* 	 * Some systems use 32-bit file ID's, other's use 64-bit file IDs. 	 * Attempt to handle both, and let the compiler sort it out.  If we 	 * could pick this out at compile-time, it would be better, so as to 	 * avoid the else case below. 	 */
if|if
condition|(
sizeof|sizeof
argument_list|(
name|vni
operator|->
name|vn_fileid
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
block|{
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pad0_32
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_fileid
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
sizeof|sizeof
argument_list|(
name|vni
operator|->
name|vn_fileid
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
condition|)
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_fileid
argument_list|)
expr_stmt|;
else|else
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
literal|0LL
argument_list|)
expr_stmt|;
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|vni
operator|->
name|vn_dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_attr
parameter_list|(
name|struct
name|vnode_au_info
modifier|*
name|vni
parameter_list|)
block|{
return|return
operator|(
name|au_to_attr32
argument_list|(
name|vni
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !(defined(_KERNEL) || defined(KERNEL) */
end_comment

begin_comment
comment|/*  * token ID                1 byte  * how to print            1 byte  * basic unit              1 byte  * unit count              1 byte  * data items              (depends on basic unit)  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_data
parameter_list|(
name|char
name|unit_print
parameter_list|,
name|char
name|unit_type
parameter_list|,
name|char
name|unit_count
parameter_list|,
name|char
modifier|*
name|p
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|size_t
name|datasize
decl_stmt|,
name|totdata
decl_stmt|;
comment|/* Determine the size of the basic unit. */
switch|switch
condition|(
name|unit_type
condition|)
block|{
case|case
name|AUR_BYTE
case|:
comment|/* case AUR_CHAR: */
name|datasize
operator|=
name|AUR_BYTE_SIZE
expr_stmt|;
break|break;
case|case
name|AUR_SHORT
case|:
name|datasize
operator|=
name|AUR_SHORT_SIZE
expr_stmt|;
break|break;
case|case
name|AUR_INT32
case|:
comment|/* case AUR_INT: */
name|datasize
operator|=
name|AUR_INT32_SIZE
expr_stmt|;
break|break;
case|case
name|AUR_INT64
case|:
name|datasize
operator|=
name|AUR_INT64_SIZE
expr_stmt|;
break|break;
default|default:
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|totdata
operator|=
name|datasize
operator|*
name|unit_count
expr_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
name|totdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_DATA
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|unit_print
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|unit_type
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|unit_count
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
name|p
argument_list|,
name|totdata
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * status		   4 bytes  * return value            4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_exit
parameter_list|(
name|int
name|retval
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_EXIT
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|retval
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_groups
parameter_list|(
name|int
modifier|*
name|groups
parameter_list|)
block|{
return|return
operator|(
name|au_to_newgroups
argument_list|(
name|AUDIT_MAX_GROUPS
argument_list|,
operator|(
name|gid_t
operator|*
operator|)
name|groups
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * number groups           2 bytes  * group list              count * 4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_newgroups
parameter_list|(
name|u_int16_t
name|n
parameter_list|,
name|gid_t
modifier|*
name|groups
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
name|n
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_NEWGROUPS
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|n
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|groups
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * internet address        4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_in_addr
parameter_list|(
name|struct
name|in_addr
modifier|*
name|internet_addr
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_IN_ADDR
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|internet_addr
operator|->
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * address type/length     4 bytes  * Address                16 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_in_addr_ex
parameter_list|(
name|struct
name|in6_addr
modifier|*
name|internet_addr
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|type
init|=
name|AF_INET6
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|5
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_IN_ADDR_EX
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
name|internet_addr
argument_list|,
literal|5
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * ip header		   20 bytes  *  * The IP header should be submitted in network byte order.  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_ip
parameter_list|(
name|struct
name|ip
modifier|*
name|ip
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_IP
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * object ID type          1 byte  * object ID               4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_ipc
parameter_list|(
name|char
name|type
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_IPC
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * owner user ID           4 bytes  * owner group ID          4 bytes  * creator user ID         4 bytes  * creator group ID        4 bytes  * access mode             4 bytes  * slot sequence #         4 bytes  * key                     4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_ipc_perm
parameter_list|(
name|struct
name|ipc_perm
modifier|*
name|perm
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|pad0
init|=
literal|0
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
literal|12
operator|*
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_IPC_PERM
argument_list|)
expr_stmt|;
comment|/* 	 * Darwin defines the sizes for ipc_perm members 	 * as 2 bytes; BSM defines 4 so pad with 0 	 */
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|pad0
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|perm
operator|->
name|uid
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|pad0
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|perm
operator|->
name|gid
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|pad0
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|perm
operator|->
name|cuid
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|pad0
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|perm
operator|->
name|cgid
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|pad0
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|perm
operator|->
name|mode
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|pad0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_IPC_PERM___SEQ
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|perm
operator|->
name|__seq
argument_list|)
expr_stmt|;
else|#
directive|else
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|perm
operator|->
name|seq
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_IPC_PERM___KEY
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|perm
operator|->
name|__key
argument_list|)
expr_stmt|;
else|#
directive|else
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|perm
operator|->
name|key
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * port IP address         2 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_iport
parameter_list|(
name|u_int16_t
name|iport
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_IPORT
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|iport
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * size                    2 bytes  * data                    size bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_opaque
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|u_int16_t
name|bytes
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
name|bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_OPAQUE
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
name|data
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * seconds of time         4 bytes  * milliseconds of time    4 bytes  * file name len           2 bytes  * file pathname           N bytes + 1 terminating NULL byte  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_file
parameter_list|(
name|char
modifier|*
name|file
parameter_list|,
name|struct
name|timeval
name|tm
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|filelen
decl_stmt|;
name|u_int32_t
name|timems
decl_stmt|;
name|filelen
operator|=
name|strlen
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|filelen
operator|+=
literal|1
expr_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
name|filelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|timems
operator|=
name|tm
operator|.
name|tv_usec
operator|/
literal|1000
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_OTHER_FILE32
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tm
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|timems
argument_list|)
expr_stmt|;
comment|/* We need time in ms. */
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|filelen
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|dptr
argument_list|,
name|file
argument_list|,
name|filelen
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * text length             2 bytes  * text                    N bytes + 1 terminating NULL byte  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_text
parameter_list|(
name|char
modifier|*
name|text
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|textlen
decl_stmt|;
name|textlen
operator|=
name|strlen
argument_list|(
name|text
argument_list|)
expr_stmt|;
name|textlen
operator|+=
literal|1
expr_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
name|textlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_TEXT
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|dptr
argument_list|,
name|text
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * path length             2 bytes  * path                    N bytes + 1 terminating NULL byte  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_path
parameter_list|(
name|char
modifier|*
name|text
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|textlen
decl_stmt|;
name|textlen
operator|=
name|strlen
argument_list|(
name|text
argument_list|)
expr_stmt|;
name|textlen
operator|+=
literal|1
expr_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
name|textlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_PATH
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|dptr
argument_list|,
name|text
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * audit ID                4 bytes  * effective user ID       4 bytes  * effective group ID      4 bytes  * real user ID            4 bytes  * real group ID           4 bytes  * process ID              4 bytes  * session ID              4 bytes  * terminal ID  *   port ID               4 bytes/8 bytes (32-bit/64-bit value)  *   machine address       4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_process32
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_t
modifier|*
name|tid
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|9
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_PROCESS32
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|auid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|euid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|egid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|ruid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rgid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|port
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|machine
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_process64
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_t
modifier|*
name|tid
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_PROCESS64
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|auid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|euid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|egid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|ruid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rgid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|port
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|machine
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_process
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_t
modifier|*
name|tid
parameter_list|)
block|{
return|return
operator|(
name|au_to_process32
argument_list|(
name|auid
argument_list|,
name|euid
argument_list|,
name|egid
argument_list|,
name|ruid
argument_list|,
name|rgid
argument_list|,
name|pid
argument_list|,
name|sid
argument_list|,
name|tid
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * audit ID                4 bytes  * effective user ID       4 bytes  * effective group ID      4 bytes  * real user ID            4 bytes  * real group ID           4 bytes  * process ID              4 bytes  * session ID              4 bytes  * terminal ID  *   port ID               4 bytes/8 bytes (32-bit/64-bit value)  *   address type-len      4 bytes  *   machine address      16 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_process32_ex
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_addr_t
modifier|*
name|tid
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv4
condition|)
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|10
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv6
condition|)
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|13
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_PROCESS32_EX
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|auid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|euid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|egid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|ruid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rgid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|at_port
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|at_type
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv6
condition|)
block|{
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|3
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_process64_ex
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_addr_t
modifier|*
name|tid
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv4
condition|)
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|7
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv6
condition|)
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|7
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|+
literal|5
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_PROCESS64_EX
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|auid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|euid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|egid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|ruid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rgid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|at_port
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|at_type
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv6
condition|)
block|{
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|3
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_process_ex
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_addr_t
modifier|*
name|tid
parameter_list|)
block|{
return|return
operator|(
name|au_to_process32_ex
argument_list|(
name|auid
argument_list|,
name|euid
argument_list|,
name|egid
argument_list|,
name|ruid
argument_list|,
name|rgid
argument_list|,
name|pid
argument_list|,
name|sid
argument_list|,
name|tid
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * error status            1 byte  * return value            4 bytes/8 bytes (32-bit/64-bit value)  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_return32
parameter_list|(
name|char
name|status
parameter_list|,
name|u_int32_t
name|ret
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_RETURN32
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_return64
parameter_list|(
name|char
name|status
parameter_list|,
name|u_int64_t
name|ret
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_RETURN64
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_return
parameter_list|(
name|char
name|status
parameter_list|,
name|u_int32_t
name|ret
parameter_list|)
block|{
return|return
operator|(
name|au_to_return32
argument_list|(
name|status
argument_list|,
name|ret
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * sequence number         4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_seq
parameter_list|(
name|long
name|audit_count
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_SEQ
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|audit_count
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * socket family           2 bytes  * path                    104 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_sock_unix
parameter_list|(
name|struct
name|sockaddr_un
modifier|*
name|so
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
name|strlen
argument_list|(
name|so
operator|->
name|sun_path
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AU_SOCK_UNIX_TOKEN
argument_list|)
expr_stmt|;
comment|/* BSM token has two bytes for family */
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|so
operator|->
name|sun_family
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|dptr
argument_list|,
name|so
operator|->
name|sun_path
argument_list|,
name|strlen
argument_list|(
name|so
operator|->
name|sun_path
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * socket family           2 bytes  * local port              2 bytes  * socket address          4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_sock_inet32
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
name|so
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|uint16_t
name|family
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_SOCKINET32
argument_list|)
expr_stmt|;
comment|/* 	 * BSM defines the family field as 16 bits, but many operating 	 * systems have an 8-bit sin_family field.  Extend to 16 bits before 	 * writing into the token.  Assume that both the port and the address 	 * in the sockaddr_in are already in network byte order, but family 	 * is in local byte order. 	 * 	 * XXXRW: Should a name space conversion be taking place on the value 	 * of sin_family?  	 */
name|family
operator|=
name|so
operator|->
name|sin_family
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|family
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|so
operator|->
name|sin_port
argument_list|,
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|so
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_sock_inet128
parameter_list|(
name|struct
name|sockaddr_in6
modifier|*
name|so
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_SOCKINET128
argument_list|)
expr_stmt|;
comment|/* 	 * In Darwin, sin6_family is one octet, but BSM defines the token  	 * to store two. So we copy in a 0 first.  	 */
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|so
operator|->
name|sin6_family
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|so
operator|->
name|sin6_port
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|so
operator|->
name|sin6_addr
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_sock_inet
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
name|so
parameter_list|)
block|{
return|return
operator|(
name|au_to_sock_inet32
argument_list|(
name|so
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * audit ID                4 bytes  * effective user ID       4 bytes  * effective group ID      4 bytes  * real user ID            4 bytes  * real group ID           4 bytes  * process ID              4 bytes  * session ID              4 bytes  * terminal ID  *   port ID               4 bytes/8 bytes (32-bit/64-bit value)  *   machine address       4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_subject32
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_t
modifier|*
name|tid
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|9
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_SUBJECT32
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|auid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|euid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|egid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|ruid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rgid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|port
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|machine
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_subject64
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_t
modifier|*
name|tid
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|7
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_SUBJECT64
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|auid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|euid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|egid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|ruid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rgid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|port
argument_list|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|machine
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_subject
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_t
modifier|*
name|tid
parameter_list|)
block|{
return|return
operator|(
name|au_to_subject32
argument_list|(
name|auid
argument_list|,
name|euid
argument_list|,
name|egid
argument_list|,
name|ruid
argument_list|,
name|rgid
argument_list|,
name|pid
argument_list|,
name|sid
argument_list|,
name|tid
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * audit ID                4 bytes  * effective user ID       4 bytes  * effective group ID      4 bytes  * real user ID            4 bytes  * real group ID           4 bytes  * process ID              4 bytes  * session ID              4 bytes  * terminal ID  *   port ID               4 bytes/8 bytes (32-bit/64-bit value)  *   address type/length   4 bytes  *   machine address      16 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_subject32_ex
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_addr_t
modifier|*
name|tid
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv4
condition|)
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|10
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv6
condition|)
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|13
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_SUBJECT32_EX
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|auid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|euid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|egid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|ruid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rgid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|at_port
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|at_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv6
condition|)
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|0
index|]
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_subject64_ex
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_addr_t
modifier|*
name|tid
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv4
condition|)
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|7
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv6
condition|)
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|7
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
operator|+
literal|5
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_SUBJECT64_EX
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|auid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|euid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|egid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|ruid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rgid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|at_port
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tid
operator|->
name|at_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|tid
operator|->
name|at_type
operator|==
name|AU_IPv6
condition|)
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|0
index|]
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
operator|&
name|tid
operator|->
name|at_addr
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_subject_ex
parameter_list|(
name|au_id_t
name|auid
parameter_list|,
name|uid_t
name|euid
parameter_list|,
name|gid_t
name|egid
parameter_list|,
name|uid_t
name|ruid
parameter_list|,
name|gid_t
name|rgid
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|au_asid_t
name|sid
parameter_list|,
name|au_tid_addr_t
modifier|*
name|tid
parameter_list|)
block|{
return|return
operator|(
name|au_to_subject32_ex
argument_list|(
name|auid
argument_list|,
name|euid
argument_list|,
name|egid
argument_list|,
name|ruid
argument_list|,
name|rgid
argument_list|,
name|pid
argument_list|,
name|sid
argument_list|,
name|tid
argument_list|)
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_KERNEL
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|KERNEL
argument_list|)
operator|&&
name|defined
argument_list|(
name|HAVE_AUDIT_SYSCALLS
argument_list|)
end_if

begin_comment
comment|/*  * Collects audit information for the current process  * and creates a subject token from it  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_me
parameter_list|(
name|void
parameter_list|)
block|{
name|auditinfo_t
name|auinfo
decl_stmt|;
if|if
condition|(
name|getaudit
argument_list|(
operator|&
name|auinfo
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|au_to_subject32
argument_list|(
name|auinfo
operator|.
name|ai_auid
argument_list|,
name|geteuid
argument_list|()
argument_list|,
name|getegid
argument_list|()
argument_list|,
name|getuid
argument_list|()
argument_list|,
name|getgid
argument_list|()
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|auinfo
operator|.
name|ai_asid
argument_list|,
operator|&
name|auinfo
operator|.
name|ai_termid
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * token ID				1 byte  * count				4 bytes  * text					count null-terminated strings  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_exec_args
parameter_list|(
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|nextarg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|size_t
name|totlen
init|=
literal|0
decl_stmt|;
name|nextarg
operator|=
operator|*
name|argv
expr_stmt|;
while|while
condition|(
name|nextarg
operator|!=
name|NULL
condition|)
block|{
name|int
name|nextlen
decl_stmt|;
name|nextlen
operator|=
name|strlen
argument_list|(
name|nextarg
argument_list|)
expr_stmt|;
name|totlen
operator|+=
name|nextlen
operator|+
literal|1
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|nextarg
operator|=
operator|*
operator|(
name|argv
operator|+
name|count
operator|)
expr_stmt|;
block|}
name|totlen
operator|+=
name|count
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
expr_stmt|;
comment|/* nul terminations. */
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
name|totlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_EXEC_ARGS
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|nextarg
operator|=
operator|*
operator|(
name|argv
operator|+
name|i
operator|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
name|nextarg
argument_list|,
name|strlen
argument_list|(
name|nextarg
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * zonename length         2 bytes  * zonename                N bytes + 1 terminating NULL byte  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_zonename
parameter_list|(
name|char
modifier|*
name|zonename
parameter_list|)
block|{
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|textlen
decl_stmt|;
name|token_t
modifier|*
name|t
decl_stmt|;
name|textlen
operator|=
name|strlen
argument_list|(
name|zonename
argument_list|)
expr_stmt|;
name|textlen
operator|+=
literal|1
expr_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
name|textlen
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_ZONENAME
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
name|ADD_STRING
argument_list|(
name|dptr
argument_list|,
name|zonename
argument_list|,
name|textlen
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID				1 byte  * count				4 bytes  * text					count null-terminated strings  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_exec_env
parameter_list|(
name|char
modifier|*
modifier|*
name|envp
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|size_t
name|totlen
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|nextenv
decl_stmt|;
name|nextenv
operator|=
operator|*
name|envp
expr_stmt|;
while|while
condition|(
name|nextenv
operator|!=
name|NULL
condition|)
block|{
name|int
name|nextlen
decl_stmt|;
name|nextlen
operator|=
name|strlen
argument_list|(
name|nextenv
argument_list|)
expr_stmt|;
name|totlen
operator|+=
name|nextlen
operator|+
literal|1
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|nextenv
operator|=
operator|*
operator|(
name|envp
operator|+
name|count
operator|)
expr_stmt|;
block|}
name|totlen
operator|+=
sizeof|sizeof
argument_list|(
name|char
argument_list|)
operator|*
name|count
expr_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
name|totlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_EXEC_ENV
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|nextenv
operator|=
operator|*
operator|(
name|envp
operator|+
name|i
operator|)
expr_stmt|;
name|ADD_MEM
argument_list|(
name|dptr
argument_list|,
name|nextenv
argument_list|,
name|strlen
argument_list|(
name|nextenv
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * token ID                1 byte  * record byte count       4 bytes  * version #               1 byte    [2]  * event type              2 bytes  * event modifier          2 bytes  * seconds of time         4 bytes/8 bytes (32-bit/64-bit value)  * milliseconds of time    4 bytes/8 bytes (32-bit/64-bit value)  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_header32_tm
parameter_list|(
name|int
name|rec_size
parameter_list|,
name|au_event_t
name|e_type
parameter_list|,
name|au_emod_t
name|e_mod
parameter_list|,
name|struct
name|timeval
name|tm
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|timems
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_HEADER32
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rec_size
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUDIT_HEADER_VERSION_OPENBSM
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|e_type
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|e_mod
argument_list|)
expr_stmt|;
name|timems
operator|=
name|tm
operator|.
name|tv_usec
operator|/
literal|1000
expr_stmt|;
comment|/* Add the timestamp */
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|tm
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|timems
argument_list|)
expr_stmt|;
comment|/* We need time in ms. */
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_header64_tm
parameter_list|(
name|int
name|rec_size
parameter_list|,
name|au_event_t
name|e_type
parameter_list|,
name|au_emod_t
name|e_mod
parameter_list|,
name|struct
name|timeval
name|tm
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|timems
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int64_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_HEADER64
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rec_size
argument_list|)
expr_stmt|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUDIT_HEADER_VERSION_OPENBSM
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|e_type
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|e_mod
argument_list|)
expr_stmt|;
name|timems
operator|=
name|tm
operator|.
name|tv_usec
operator|/
literal|1000
expr_stmt|;
comment|/* Add the timestamp */
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|tm
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|ADD_U_INT64
argument_list|(
name|dptr
argument_list|,
name|timems
argument_list|)
expr_stmt|;
comment|/* We need time in ms. */
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|KERNEL
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|_KERNEL
argument_list|)
end_if

begin_function
name|token_t
modifier|*
name|au_to_header32
parameter_list|(
name|int
name|rec_size
parameter_list|,
name|au_event_t
name|e_type
parameter_list|,
name|au_emod_t
name|e_mod
parameter_list|)
block|{
name|struct
name|timeval
name|tm
decl_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|tm
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|au_to_header32_tm
argument_list|(
name|rec_size
argument_list|,
name|e_type
argument_list|,
name|e_mod
argument_list|,
name|tm
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_header64
parameter_list|(
name|__unused
name|int
name|rec_size
parameter_list|,
name|__unused
name|au_event_t
name|e_type
parameter_list|,
name|__unused
name|au_emod_t
name|e_mod
parameter_list|)
block|{
name|struct
name|timeval
name|tm
decl_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|tm
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|au_to_header64_tm
argument_list|(
name|rec_size
argument_list|,
name|e_type
argument_list|,
name|e_mod
argument_list|,
name|tm
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|token_t
modifier|*
name|au_to_header
parameter_list|(
name|int
name|rec_size
parameter_list|,
name|au_event_t
name|e_type
parameter_list|,
name|au_emod_t
name|e_mod
parameter_list|)
block|{
return|return
operator|(
name|au_to_header32
argument_list|(
name|rec_size
argument_list|,
name|e_type
argument_list|,
name|e_mod
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * token ID                1 byte  * trailer magic number    2 bytes  * record byte count       4 bytes  */
end_comment

begin_function
name|token_t
modifier|*
name|au_to_trailer
parameter_list|(
name|int
name|rec_size
parameter_list|)
block|{
name|token_t
modifier|*
name|t
decl_stmt|;
name|u_char
modifier|*
name|dptr
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|magic
init|=
name|TRAILER_PAD_MAGIC
decl_stmt|;
name|GET_TOKEN_AREA
argument_list|(
name|t
argument_list|,
name|dptr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_char
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ADD_U_CHAR
argument_list|(
name|dptr
argument_list|,
name|AUT_TRAILER
argument_list|)
expr_stmt|;
name|ADD_U_INT16
argument_list|(
name|dptr
argument_list|,
name|magic
argument_list|)
expr_stmt|;
name|ADD_U_INT32
argument_list|(
name|dptr
argument_list|,
name|rec_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GNU Objective C Runtime archiving    Copyright (C) 1993, 1995, 1996, 1997 Free Software Foundation, Inc.    Contributed by Kresten Krab Thorup  This file is part of GNU CC.  GNU CC is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2, or (at your option) any later version.  GNU CC is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with GNU CC; see the file COPYING.  If not, write to the Free Software Foundation, 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* As a special exception, if you link this library with files compiled with    GCC to produce an executable, this does not cause the resulting executable    to be covered by the GNU General Public License. This exception does not    however invalidate any other reasons why the executable file might be    covered by the GNU General Public License.  */
end_comment

begin_include
include|#
directive|include
file|"tconfig.h"
end_include

begin_include
include|#
directive|include
file|"runtime.h"
end_include

begin_include
include|#
directive|include
file|"typedstream.h"
end_include

begin_include
include|#
directive|include
file|"encoding.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_STDLIB_H
end_ifdef

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|extern
name|int
name|fflush
parameter_list|(
name|FILE
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|ROUND
parameter_list|(
name|V
parameter_list|,
name|A
parameter_list|)
define|\
value|({ typeof(V) __v=(V); typeof(A) __a=(A);  \      __a*((__v+__a-1)/__a); })
end_define

begin_define
define|#
directive|define
name|PTR2LONG
parameter_list|(
name|P
parameter_list|)
value|(((char*)(P))-(char*)0)
end_define

begin_define
define|#
directive|define
name|LONG2PTR
parameter_list|(
name|L
parameter_list|)
value|(((char*)0)+(L))
end_define

begin_comment
comment|/* Declare some functions... */
end_comment

begin_function_decl
specifier|static
name|int
name|objc_read_class
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|Class
modifier|*
name|class
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|objc_sizeof_type
parameter_list|(
specifier|const
name|char
modifier|*
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|objc_write_use_common
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|long
name|key
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|objc_write_register_common
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|long
name|key
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|objc_write_class
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|struct
name|objc_class
modifier|*
name|class
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|const
name|char
modifier|*
name|objc_skip_type
parameter_list|(
specifier|const
name|char
modifier|*
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|__objc_finish_write_root_object
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|__objc_finish_read_root_object
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|__inline__
name|int
name|__objc_code_unsigned_char
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|char
name|val
parameter_list|)
block|{
if|if
condition|(
operator|(
name|val
operator|&
name|_B_VALUE
operator|)
operator|==
name|val
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|val
operator||
name|_B_SINT
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|_B_NINT
operator||
literal|0x01
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|val
expr_stmt|;
return|return
literal|2
return|;
block|}
block|}
end_function

begin_function
name|int
name|objc_write_unsigned_char
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|char
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|char
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
name|int
name|len
init|=
name|__objc_code_unsigned_char
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
decl_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|__objc_code_char
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|signed
name|char
name|val
parameter_list|)
block|{
if|if
condition|(
name|val
operator|>=
literal|0
condition|)
return|return
name|__objc_code_unsigned_char
argument_list|(
name|buf
argument_list|,
name|val
argument_list|)
return|;
else|else
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|_B_NINT
operator||
name|_B_SIGN
operator||
literal|0x01
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
operator|-
name|val
expr_stmt|;
return|return
literal|2
return|;
block|}
block|}
end_function

begin_function
name|int
name|objc_write_char
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|signed
name|char
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
sizeof|sizeof
argument_list|(
name|char
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|len
init|=
name|__objc_code_char
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
decl_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|__objc_code_unsigned_short
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|short
name|val
parameter_list|)
block|{
if|if
condition|(
operator|(
name|val
operator|&
name|_B_VALUE
operator|)
operator|==
name|val
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|val
operator||
name|_B_SINT
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
block|{
name|int
name|c
decl_stmt|,
name|b
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|_B_NINT
expr_stmt|;
for|for
control|(
name|c
operator|=
sizeof|sizeof
argument_list|(
name|short
argument_list|)
init|;
name|c
operator|!=
literal|0
condition|;
name|c
operator|-=
literal|1
control|)
if|if
condition|(
operator|(
operator|(
name|val
operator|>>
operator|(
literal|8
operator|*
operator|(
name|c
operator|-
literal|1
operator|)
operator|)
operator|)
operator|%
literal|0x100
operator|)
operator|!=
literal|0
condition|)
break|break;
name|buf
index|[
literal|0
index|]
operator||=
name|c
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|1
init|;
name|c
operator|!=
literal|0
condition|;
name|c
operator|--
operator|,
name|b
operator|++
control|)
block|{
name|buf
index|[
name|b
index|]
operator|=
operator|(
name|val
operator|>>
operator|(
literal|8
operator|*
operator|(
name|c
operator|-
literal|1
operator|)
operator|)
operator|)
operator|%
literal|0x100
expr_stmt|;
block|}
return|return
name|b
return|;
block|}
block|}
end_function

begin_function
name|int
name|objc_write_unsigned_short
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|short
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
name|int
name|len
init|=
name|__objc_code_unsigned_short
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
decl_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|__objc_code_short
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|short
name|val
parameter_list|)
block|{
name|int
name|sign
init|=
operator|(
name|val
operator|<
literal|0
operator|)
decl_stmt|;
name|int
name|size
init|=
name|__objc_code_unsigned_short
argument_list|(
name|buf
argument_list|,
name|sign
condition|?
operator|-
name|val
else|:
name|val
argument_list|)
decl_stmt|;
if|if
condition|(
name|sign
condition|)
name|buf
index|[
literal|0
index|]
operator||=
name|_B_SIGN
expr_stmt|;
return|return
name|size
return|;
block|}
end_function

begin_function
name|int
name|objc_write_short
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|short
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
sizeof|sizeof
argument_list|(
name|short
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|len
init|=
name|__objc_code_short
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
decl_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|__objc_code_unsigned_int
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|int
name|val
parameter_list|)
block|{
if|if
condition|(
operator|(
name|val
operator|&
name|_B_VALUE
operator|)
operator|==
name|val
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|val
operator||
name|_B_SINT
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
block|{
name|int
name|c
decl_stmt|,
name|b
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|_B_NINT
expr_stmt|;
for|for
control|(
name|c
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
init|;
name|c
operator|!=
literal|0
condition|;
name|c
operator|-=
literal|1
control|)
if|if
condition|(
operator|(
operator|(
name|val
operator|>>
operator|(
literal|8
operator|*
operator|(
name|c
operator|-
literal|1
operator|)
operator|)
operator|)
operator|%
literal|0x100
operator|)
operator|!=
literal|0
condition|)
break|break;
name|buf
index|[
literal|0
index|]
operator||=
name|c
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|1
init|;
name|c
operator|!=
literal|0
condition|;
name|c
operator|--
operator|,
name|b
operator|++
control|)
block|{
name|buf
index|[
name|b
index|]
operator|=
operator|(
name|val
operator|>>
operator|(
literal|8
operator|*
operator|(
name|c
operator|-
literal|1
operator|)
operator|)
operator|)
operator|%
literal|0x100
expr_stmt|;
block|}
return|return
name|b
return|;
block|}
block|}
end_function

begin_function
name|int
name|objc_write_unsigned_int
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|int
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
name|int
name|len
init|=
name|__objc_code_unsigned_int
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
decl_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|__objc_code_int
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|int
name|sign
init|=
operator|(
name|val
operator|<
literal|0
operator|)
decl_stmt|;
name|int
name|size
init|=
name|__objc_code_unsigned_int
argument_list|(
name|buf
argument_list|,
name|sign
condition|?
operator|-
name|val
else|:
name|val
argument_list|)
decl_stmt|;
if|if
condition|(
name|sign
condition|)
name|buf
index|[
literal|0
index|]
operator||=
name|_B_SIGN
expr_stmt|;
return|return
name|size
return|;
block|}
end_function

begin_function
name|int
name|objc_write_int
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|len
init|=
name|__objc_code_int
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
decl_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|__objc_code_unsigned_long
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|long
name|val
parameter_list|)
block|{
if|if
condition|(
operator|(
name|val
operator|&
name|_B_VALUE
operator|)
operator|==
name|val
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|val
operator||
name|_B_SINT
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
block|{
name|int
name|c
decl_stmt|,
name|b
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|_B_NINT
expr_stmt|;
for|for
control|(
name|c
operator|=
sizeof|sizeof
argument_list|(
name|long
argument_list|)
init|;
name|c
operator|!=
literal|0
condition|;
name|c
operator|-=
literal|1
control|)
if|if
condition|(
operator|(
operator|(
name|val
operator|>>
operator|(
literal|8
operator|*
operator|(
name|c
operator|-
literal|1
operator|)
operator|)
operator|)
operator|%
literal|0x100
operator|)
operator|!=
literal|0
condition|)
break|break;
name|buf
index|[
literal|0
index|]
operator||=
name|c
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|1
init|;
name|c
operator|!=
literal|0
condition|;
name|c
operator|--
operator|,
name|b
operator|++
control|)
block|{
name|buf
index|[
name|b
index|]
operator|=
operator|(
name|val
operator|>>
operator|(
literal|8
operator|*
operator|(
name|c
operator|-
literal|1
operator|)
operator|)
operator|)
operator|%
literal|0x100
expr_stmt|;
block|}
return|return
name|b
return|;
block|}
block|}
end_function

begin_function
name|int
name|objc_write_unsigned_long
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|long
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
name|int
name|len
init|=
name|__objc_code_unsigned_long
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
decl_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|__objc_code_long
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|long
name|val
parameter_list|)
block|{
name|int
name|sign
init|=
operator|(
name|val
operator|<
literal|0
operator|)
decl_stmt|;
name|int
name|size
init|=
name|__objc_code_unsigned_long
argument_list|(
name|buf
argument_list|,
name|sign
condition|?
operator|-
name|val
else|:
name|val
argument_list|)
decl_stmt|;
if|if
condition|(
name|sign
condition|)
name|buf
index|[
literal|0
index|]
operator||=
name|_B_SIGN
expr_stmt|;
return|return
name|size
return|;
block|}
end_function

begin_function
name|int
name|objc_write_long
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|long
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
sizeof|sizeof
argument_list|(
name|long
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|len
init|=
name|__objc_code_long
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
decl_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|objc_write_string
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|string
parameter_list|,
name|unsigned
name|int
name|nbytes
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
name|int
name|len
init|=
name|__objc_code_unsigned_int
argument_list|(
name|buf
argument_list|,
name|nbytes
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_SINT
condition|)
name|buf
index|[
literal|0
index|]
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
operator||
name|_B_SSTR
expr_stmt|;
else|else
comment|/* _B_NINT */
name|buf
index|[
literal|0
index|]
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
operator||
name|_B_NSTR
expr_stmt|;
if|if
condition|(
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|!=
literal|0
condition|)
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|string
argument_list|,
name|nbytes
argument_list|)
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|objc_write_string_atomic
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|char
modifier|*
name|string
parameter_list|,
name|unsigned
name|int
name|nbytes
parameter_list|)
block|{
name|unsigned
name|long
name|key
decl_stmt|;
if|if
condition|(
operator|(
name|key
operator|=
name|PTR2LONG
argument_list|(
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|stream_table
argument_list|,
name|string
argument_list|)
argument_list|)
operator|)
condition|)
return|return
name|objc_write_use_common
argument_list|(
name|stream
argument_list|,
name|key
argument_list|)
return|;
else|else
block|{
name|int
name|length
decl_stmt|;
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
operator|=
name|PTR2LONG
argument_list|(
name|string
argument_list|)
argument_list|)
argument_list|,
name|string
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|length
operator|=
name|objc_write_register_common
argument_list|(
name|stream
argument_list|,
name|key
argument_list|)
operator|)
condition|)
return|return
name|objc_write_string
argument_list|(
name|stream
argument_list|,
name|string
argument_list|,
name|nbytes
argument_list|)
return|;
return|return
name|length
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|objc_write_register_common
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|long
name|key
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
operator|+
literal|2
expr|]
expr_stmt|;
name|int
name|len
init|=
name|__objc_code_unsigned_long
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|1
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|_B_RCOMM
operator||
literal|0x01
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|&=
name|_B_VALUE
expr_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
return|;
block|}
else|else
block|{
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|buf
index|[
literal|1
index|]
operator|&
name|_B_VALUE
operator|)
operator||
name|_B_RCOMM
expr_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
operator|+
literal|1
argument_list|,
name|len
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|objc_write_use_common
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|long
name|key
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
operator|+
literal|2
expr|]
expr_stmt|;
name|int
name|len
init|=
name|__objc_code_unsigned_long
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|1
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
name|_B_UCOMM
operator||
literal|0x01
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|&=
name|_B_VALUE
expr_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
return|;
block|}
else|else
block|{
name|buf
index|[
literal|1
index|]
operator|=
operator|(
name|buf
index|[
literal|1
index|]
operator|&
name|_B_VALUE
operator|)
operator||
name|_B_UCOMM
expr_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
operator|+
literal|1
argument_list|,
name|len
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|__objc_write_extension
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|char
name|code
parameter_list|)
block|{
if|if
condition|(
name|code
operator|<=
name|_B_VALUE
condition|)
block|{
name|unsigned
name|char
name|buf
init|=
name|code
operator||
name|_B_EXT
decl_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
operator|&
name|buf
argument_list|,
literal|1
argument_list|)
return|;
block|}
else|else
block|{
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_OPCODE
argument_list|,
literal|"__objc_write_extension: bad opcode %c\n"
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
name|__inline__
name|int
name|__objc_write_object
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|id
name|object
parameter_list|)
block|{
name|unsigned
name|char
name|buf
init|=
literal|'\0'
decl_stmt|;
name|SEL
name|write_sel
init|=
name|sel_get_any_uid
argument_list|(
literal|"write:"
argument_list|)
decl_stmt|;
if|if
condition|(
name|object
condition|)
block|{
name|__objc_write_extension
argument_list|(
name|stream
argument_list|,
name|_BX_OBJECT
argument_list|)
expr_stmt|;
name|objc_write_class
argument_list|(
name|stream
argument_list|,
name|object
operator|->
name|class_pointer
argument_list|)
expr_stmt|;
operator|(
operator|*
name|objc_msg_lookup
argument_list|(
name|object
argument_list|,
name|write_sel
argument_list|)
operator|)
operator|(
name|object
operator|,
name|write_sel
operator|,
name|stream
operator|)
expr_stmt|;
return|return
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
operator|&
name|buf
argument_list|,
literal|1
argument_list|)
return|;
block|}
else|else
return|return
name|objc_write_use_common
argument_list|(
name|stream
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|objc_write_object_reference
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|id
name|object
parameter_list|)
block|{
name|unsigned
name|long
name|key
decl_stmt|;
if|if
condition|(
operator|(
name|key
operator|=
name|PTR2LONG
argument_list|(
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|object_table
argument_list|,
name|object
argument_list|)
argument_list|)
operator|)
condition|)
return|return
name|objc_write_use_common
argument_list|(
name|stream
argument_list|,
name|key
argument_list|)
return|;
name|__objc_write_extension
argument_list|(
name|stream
argument_list|,
name|_BX_OBJREF
argument_list|)
expr_stmt|;
return|return
name|objc_write_unsigned_long
argument_list|(
name|stream
argument_list|,
name|PTR2LONG
argument_list|(
name|object
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|objc_write_root_object
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|id
name|object
parameter_list|)
block|{
name|int
name|len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|stream
operator|->
name|writing_root_p
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_RECURSE_ROOT
argument_list|,
literal|"objc_write_root_object called recursively"
argument_list|)
expr_stmt|;
else|else
block|{
name|stream
operator|->
name|writing_root_p
operator|=
literal|1
expr_stmt|;
name|__objc_write_extension
argument_list|(
name|stream
argument_list|,
name|_BX_OBJROOT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|objc_write_object
argument_list|(
name|stream
argument_list|,
name|object
argument_list|)
operator|)
condition|)
name|__objc_finish_write_root_object
argument_list|(
name|stream
argument_list|)
expr_stmt|;
name|stream
operator|->
name|writing_root_p
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|int
name|objc_write_object
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|id
name|object
parameter_list|)
block|{
name|unsigned
name|long
name|key
decl_stmt|;
if|if
condition|(
operator|(
name|key
operator|=
name|PTR2LONG
argument_list|(
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|object_table
argument_list|,
name|object
argument_list|)
argument_list|)
operator|)
condition|)
return|return
name|objc_write_use_common
argument_list|(
name|stream
argument_list|,
name|key
argument_list|)
return|;
elseif|else
if|if
condition|(
name|object
operator|==
name|nil
condition|)
return|return
name|objc_write_use_common
argument_list|(
name|stream
argument_list|,
literal|0
argument_list|)
return|;
else|else
block|{
name|int
name|length
decl_stmt|;
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|object_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
operator|=
name|PTR2LONG
argument_list|(
name|object
argument_list|)
argument_list|)
argument_list|,
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|length
operator|=
name|objc_write_register_common
argument_list|(
name|stream
argument_list|,
name|key
argument_list|)
operator|)
condition|)
return|return
name|__objc_write_object
argument_list|(
name|stream
argument_list|,
name|object
argument_list|)
return|;
return|return
name|length
return|;
block|}
block|}
end_function

begin_function
name|__inline__
name|int
name|__objc_write_class
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|struct
name|objc_class
modifier|*
name|class
parameter_list|)
block|{
name|__objc_write_extension
argument_list|(
name|stream
argument_list|,
name|_BX_CLASS
argument_list|)
expr_stmt|;
name|objc_write_string_atomic
argument_list|(
name|stream
argument_list|,
operator|(
name|char
operator|*
operator|)
name|class
operator|->
name|name
argument_list|,
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|class
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|objc_write_unsigned_long
argument_list|(
name|stream
argument_list|,
name|class
operator|->
name|version
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|objc_write_class
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|struct
name|objc_class
modifier|*
name|class
parameter_list|)
block|{
name|unsigned
name|long
name|key
decl_stmt|;
if|if
condition|(
operator|(
name|key
operator|=
name|PTR2LONG
argument_list|(
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|stream_table
argument_list|,
name|class
argument_list|)
argument_list|)
operator|)
condition|)
return|return
name|objc_write_use_common
argument_list|(
name|stream
argument_list|,
name|key
argument_list|)
return|;
else|else
block|{
name|int
name|length
decl_stmt|;
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
operator|=
name|PTR2LONG
argument_list|(
name|class
argument_list|)
argument_list|)
argument_list|,
name|class
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|length
operator|=
name|objc_write_register_common
argument_list|(
name|stream
argument_list|,
name|key
argument_list|)
operator|)
condition|)
return|return
name|__objc_write_class
argument_list|(
name|stream
argument_list|,
name|class
argument_list|)
return|;
return|return
name|length
return|;
block|}
block|}
end_function

begin_function
name|__inline__
name|int
name|__objc_write_selector
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|SEL
name|selector
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sel_name
decl_stmt|;
name|__objc_write_extension
argument_list|(
name|stream
argument_list|,
name|_BX_SEL
argument_list|)
expr_stmt|;
comment|/* to handle NULL selectors */
if|if
condition|(
operator|(
name|SEL
operator|)
literal|0
operator|==
name|selector
condition|)
return|return
name|objc_write_string
argument_list|(
name|stream
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
return|;
name|sel_name
operator|=
name|sel_get_name
argument_list|(
name|selector
argument_list|)
expr_stmt|;
return|return
name|objc_write_string
argument_list|(
name|stream
argument_list|,
name|sel_name
argument_list|,
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sel_name
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|objc_write_selector
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|SEL
name|selector
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sel_name
decl_stmt|;
name|unsigned
name|long
name|key
decl_stmt|;
comment|/* to handle NULL selectors */
if|if
condition|(
operator|(
name|SEL
operator|)
literal|0
operator|==
name|selector
condition|)
return|return
name|__objc_write_selector
argument_list|(
name|stream
argument_list|,
name|selector
argument_list|)
return|;
name|sel_name
operator|=
name|sel_get_name
argument_list|(
name|selector
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|key
operator|=
name|PTR2LONG
argument_list|(
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|stream_table
argument_list|,
name|sel_name
argument_list|)
argument_list|)
operator|)
condition|)
return|return
name|objc_write_use_common
argument_list|(
name|stream
argument_list|,
name|key
argument_list|)
return|;
else|else
block|{
name|int
name|length
decl_stmt|;
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
operator|=
name|PTR2LONG
argument_list|(
name|sel_name
argument_list|)
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|sel_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|length
operator|=
name|objc_write_register_common
argument_list|(
name|stream
argument_list|,
name|key
argument_list|)
operator|)
condition|)
return|return
name|__objc_write_selector
argument_list|(
name|stream
argument_list|,
name|selector
argument_list|)
return|;
return|return
name|length
return|;
block|}
block|}
end_function

begin_comment
comment|/* ** Read operations  */
end_comment

begin_function
name|__inline__
name|int
name|objc_read_char
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|unsigned
name|char
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
operator|&
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|buf
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_SINT
condition|)
operator|(
operator|*
name|val
operator|)
operator|=
operator|(
name|buf
operator|&
name|_B_VALUE
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|buf
operator|&
name|_B_NUMBER
operator|)
operator|==
literal|1
condition|)
block|{
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|val
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|&
name|_B_SIGN
condition|)
operator|(
operator|*
name|val
operator|)
operator|=
operator|-
literal|1
operator|*
operator|(
operator|*
name|val
operator|)
expr_stmt|;
block|}
else|else
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected 8bit signed int, got %dbit int"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|buf
operator|&
name|_B_NUMBER
argument_list|)
operator|*
literal|8
argument_list|)
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|__inline__
name|int
name|objc_read_unsigned_char
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|char
modifier|*
name|val
parameter_list|)
block|{
name|unsigned
name|char
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
operator|&
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|buf
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_SINT
condition|)
operator|(
operator|*
name|val
operator|)
operator|=
operator|(
name|buf
operator|&
name|_B_VALUE
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|buf
operator|&
name|_B_NUMBER
operator|)
operator|==
literal|1
condition|)
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|val
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected 8bit unsigned int, got %dbit int"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|buf
operator|&
name|_B_NUMBER
argument_list|)
operator|*
literal|8
argument_list|)
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|__inline__
name|int
name|objc_read_short
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|short
modifier|*
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
sizeof|sizeof
argument_list|(
name|short
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_SINT
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
expr_stmt|;
else|else
block|{
name|int
name|pos
init|=
literal|1
decl_stmt|;
name|int
name|nbytes
init|=
name|buf
index|[
literal|0
index|]
operator|&
name|_B_NUMBER
decl_stmt|;
if|if
condition|(
name|nbytes
operator|>
sizeof|sizeof
argument_list|(
name|short
argument_list|)
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected short, got bigger (%dbits)"
argument_list|,
name|nbytes
operator|*
literal|8
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
operator|+
literal|1
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
operator|(
operator|*
name|value
operator|)
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<=
name|nbytes
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
operator|(
operator|*
name|value
operator|)
operator|*
literal|0x100
operator|)
operator|+
name|buf
index|[
name|pos
operator|++
index|]
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_SIGN
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|-
operator|(
operator|*
name|value
operator|)
expr_stmt|;
block|}
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|__inline__
name|int
name|objc_read_unsigned_short
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|short
modifier|*
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_SINT
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
expr_stmt|;
else|else
block|{
name|int
name|pos
init|=
literal|1
decl_stmt|;
name|int
name|nbytes
init|=
name|buf
index|[
literal|0
index|]
operator|&
name|_B_NUMBER
decl_stmt|;
if|if
condition|(
name|nbytes
operator|>
sizeof|sizeof
argument_list|(
name|short
argument_list|)
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected short, got int or bigger"
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
operator|+
literal|1
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
operator|(
operator|*
name|value
operator|)
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<=
name|nbytes
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
operator|(
operator|*
name|value
operator|)
operator|*
literal|0x100
operator|)
operator|+
name|buf
index|[
name|pos
operator|++
index|]
expr_stmt|;
block|}
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|__inline__
name|int
name|objc_read_int
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|int
modifier|*
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_SINT
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
expr_stmt|;
else|else
block|{
name|int
name|pos
init|=
literal|1
decl_stmt|;
name|int
name|nbytes
init|=
name|buf
index|[
literal|0
index|]
operator|&
name|_B_NUMBER
decl_stmt|;
if|if
condition|(
name|nbytes
operator|>
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected int, got bigger"
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
operator|+
literal|1
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
operator|(
operator|*
name|value
operator|)
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<=
name|nbytes
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
operator|(
operator|*
name|value
operator|)
operator|*
literal|0x100
operator|)
operator|+
name|buf
index|[
name|pos
operator|++
index|]
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_SIGN
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|-
operator|(
operator|*
name|value
operator|)
expr_stmt|;
block|}
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|__inline__
name|int
name|objc_read_long
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|long
modifier|*
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
sizeof|sizeof
argument_list|(
name|long
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_SINT
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
expr_stmt|;
else|else
block|{
name|int
name|pos
init|=
literal|1
decl_stmt|;
name|int
name|nbytes
init|=
name|buf
index|[
literal|0
index|]
operator|&
name|_B_NUMBER
decl_stmt|;
if|if
condition|(
name|nbytes
operator|>
sizeof|sizeof
argument_list|(
name|long
argument_list|)
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected long, got bigger"
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
operator|+
literal|1
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
operator|(
operator|*
name|value
operator|)
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<=
name|nbytes
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
operator|(
operator|*
name|value
operator|)
operator|*
literal|0x100
operator|)
operator|+
name|buf
index|[
name|pos
operator|++
index|]
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_SIGN
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|-
operator|(
operator|*
name|value
operator|)
expr_stmt|;
block|}
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|__inline__
name|int
name|__objc_read_nbyte_uint
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|int
name|nbytes
parameter_list|,
name|unsigned
name|int
modifier|*
name|val
parameter_list|)
block|{
name|int
name|len
decl_stmt|,
name|pos
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
if|if
condition|(
name|nbytes
operator|>
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected int, got bigger"
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
operator|(
operator|*
name|val
operator|)
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|nbytes
condition|)
operator|(
operator|*
name|val
operator|)
operator|=
operator|(
operator|(
operator|*
name|val
operator|)
operator|*
literal|0x100
operator|)
operator|+
name|buf
index|[
name|pos
operator|++
index|]
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|__inline__
name|int
name|objc_read_unsigned_int
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|int
modifier|*
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_SINT
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
expr_stmt|;
else|else
name|len
operator|=
name|__objc_read_nbyte_uint
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|int
name|__objc_read_nbyte_ulong
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|int
name|nbytes
parameter_list|,
name|unsigned
name|long
modifier|*
name|val
parameter_list|)
block|{
name|int
name|len
decl_stmt|,
name|pos
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
if|if
condition|(
name|nbytes
operator|>
sizeof|sizeof
argument_list|(
name|long
argument_list|)
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected long, got bigger"
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
operator|(
operator|*
name|val
operator|)
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|nbytes
condition|)
operator|(
operator|*
name|val
operator|)
operator|=
operator|(
operator|(
operator|*
name|val
operator|)
operator|*
literal|0x100
operator|)
operator|+
name|buf
index|[
name|pos
operator|++
index|]
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|__inline__
name|int
name|objc_read_unsigned_long
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|unsigned
name|long
modifier|*
name|value
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_SINT
condition|)
operator|(
operator|*
name|value
operator|)
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
expr_stmt|;
else|else
name|len
operator|=
name|__objc_read_nbyte_ulong
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|__inline__
name|int
name|objc_read_string
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|char
modifier|*
modifier|*
name|string
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
operator|+
literal|1
expr|]
expr_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
name|unsigned
name|long
name|key
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_RCOMM
condition|)
comment|/* register following */
block|{
name|len
operator|=
name|__objc_read_nbyte_ulong
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
condition|)
block|{
case|case
name|_B_SSTR
case|:
block|{
name|int
name|length
init|=
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
decl_stmt|;
operator|(
operator|*
name|string
operator|)
operator|=
operator|(
name|char
operator|*
operator|)
name|objc_malloc
argument_list|(
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|,
operator|*
name|string
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
operator|*
name|string
argument_list|,
name|length
argument_list|)
expr_stmt|;
operator|(
operator|*
name|string
operator|)
index|[
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|_B_UCOMM
case|:
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
name|len
operator|=
name|__objc_read_nbyte_ulong
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|string
operator|=
name|objc_malloc
argument_list|(
name|strlen
argument_list|(
name|tmp
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
operator|*
name|string
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|_B_NSTR
case|:
block|{
name|unsigned
name|int
name|nbytes
init|=
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
decl_stmt|;
name|len
operator|=
name|__objc_read_nbyte_uint
argument_list|(
name|stream
argument_list|,
name|nbytes
argument_list|,
operator|&
name|nbytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
operator|(
operator|*
name|string
operator|)
operator|=
operator|(
name|char
operator|*
operator|)
name|objc_malloc
argument_list|(
name|nbytes
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|,
operator|*
name|string
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
operator|*
name|string
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
operator|(
operator|*
name|string
operator|)
index|[
name|nbytes
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected string, got opcode %c\n"
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|int
name|objc_read_object
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|id
modifier|*
name|object
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
expr|]
expr_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
name|SEL
name|read_sel
init|=
name|sel_get_any_uid
argument_list|(
literal|"read:"
argument_list|)
decl_stmt|;
name|unsigned
name|long
name|key
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_RCOMM
condition|)
comment|/* register common */
block|{
name|len
operator|=
name|__objc_read_nbyte_ulong
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
operator|(
name|_B_EXT
operator||
name|_BX_OBJECT
operator|)
condition|)
block|{
name|Class
name|class
decl_stmt|;
comment|/* get class */
name|len
operator|=
name|objc_read_class
argument_list|(
name|stream
argument_list|,
operator|&
name|class
argument_list|)
expr_stmt|;
comment|/* create instance */
operator|(
operator|*
name|object
operator|)
operator|=
name|class_create_instance
argument_list|(
name|class
argument_list|)
expr_stmt|;
comment|/* register? */
if|if
condition|(
name|key
condition|)
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|object_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|,
operator|*
name|object
argument_list|)
expr_stmt|;
comment|/* send -read: */
if|if
condition|(
name|__objc_responds_to
argument_list|(
operator|*
name|object
argument_list|,
name|read_sel
argument_list|)
condition|)
operator|(
operator|*
name|get_imp
argument_list|(
name|class
argument_list|,
name|read_sel
argument_list|)
operator|)
operator|(
operator|*
name|object
operator|,
name|read_sel
operator|,
name|stream
operator|)
expr_stmt|;
comment|/* check null-byte */
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected null-byte, got opcode %c"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_UCOMM
condition|)
block|{
if|if
condition|(
name|key
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_KEY
argument_list|,
literal|"cannot register use upcode..."
argument_list|)
expr_stmt|;
name|len
operator|=
name|__objc_read_nbyte_ulong
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
operator|(
operator|*
name|object
operator|)
operator|=
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|object_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
operator|(
name|_B_EXT
operator||
name|_BX_OBJREF
operator|)
condition|)
comment|/* a forward reference */
block|{
name|struct
name|objc_list
modifier|*
name|other
decl_stmt|;
name|len
operator|=
name|objc_read_unsigned_long
argument_list|(
name|stream
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|other
operator|=
operator|(
expr|struct
name|objc_list
operator|*
operator|)
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|object_refs
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|object_refs
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|list_cons
argument_list|(
name|object
argument_list|,
name|other
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
operator|(
name|_B_EXT
operator||
name|_BX_OBJROOT
operator|)
condition|)
comment|/* a root object */
block|{
if|if
condition|(
name|key
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_KEY
argument_list|,
literal|"cannot register root object..."
argument_list|)
expr_stmt|;
name|len
operator|=
name|objc_read_object
argument_list|(
name|stream
argument_list|,
name|object
argument_list|)
expr_stmt|;
name|__objc_finish_read_root_object
argument_list|(
name|stream
argument_list|)
expr_stmt|;
block|}
else|else
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected object, got opcode %c"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|objc_read_class
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|Class
modifier|*
name|class
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
expr|]
expr_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
name|unsigned
name|long
name|key
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_RCOMM
condition|)
comment|/* register following */
block|{
name|len
operator|=
name|__objc_read_nbyte_ulong
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
operator|(
name|_B_EXT
operator||
name|_BX_CLASS
operator|)
condition|)
block|{
name|char
modifier|*
name|class_name
decl_stmt|;
name|unsigned
name|long
name|version
decl_stmt|;
comment|/* get class */
name|len
operator|=
name|objc_read_string
argument_list|(
name|stream
argument_list|,
operator|&
name|class_name
argument_list|)
expr_stmt|;
operator|(
operator|*
name|class
operator|)
operator|=
name|objc_get_class
argument_list|(
name|class_name
argument_list|)
expr_stmt|;
name|objc_free
argument_list|(
name|class_name
argument_list|)
expr_stmt|;
comment|/* register */
if|if
condition|(
name|key
condition|)
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|,
operator|*
name|class
argument_list|)
expr_stmt|;
name|objc_read_unsigned_long
argument_list|(
name|stream
argument_list|,
operator|&
name|version
argument_list|)
expr_stmt|;
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|class_table
argument_list|,
operator|(
operator|*
name|class
operator|)
operator|->
name|name
argument_list|,
operator|(
name|void
operator|*
operator|)
name|version
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_UCOMM
condition|)
block|{
if|if
condition|(
name|key
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_KEY
argument_list|,
literal|"cannot register use upcode..."
argument_list|)
expr_stmt|;
name|len
operator|=
name|__objc_read_nbyte_ulong
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
operator|(
operator|*
name|class
operator|)
operator|=
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|class
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_CLASS
argument_list|,
literal|"cannot find class for key %lu"
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
else|else
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected class, got opcode %c"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|int
name|objc_read_selector
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|,
name|SEL
modifier|*
name|selector
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
expr|]
expr_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
name|unsigned
name|long
name|key
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_RCOMM
condition|)
comment|/* register following */
block|{
name|len
operator|=
name|__objc_read_nbyte_ulong
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|len
operator|=
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
operator|(
name|_B_EXT
operator||
name|_BX_SEL
operator|)
condition|)
comment|/* selector! */
block|{
name|char
modifier|*
name|selector_name
decl_stmt|;
comment|/* get selector */
name|len
operator|=
name|objc_read_string
argument_list|(
name|stream
argument_list|,
operator|&
name|selector_name
argument_list|)
expr_stmt|;
comment|/* To handle NULL selectors */
if|if
condition|(
literal|0
operator|==
name|strlen
argument_list|(
name|selector_name
argument_list|)
condition|)
block|{
operator|(
operator|*
name|selector
operator|)
operator|=
operator|(
name|SEL
operator|)
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
operator|(
operator|*
name|selector
operator|)
operator|=
name|sel_get_any_uid
argument_list|(
name|selector_name
argument_list|)
expr_stmt|;
name|objc_free
argument_list|(
name|selector_name
argument_list|)
expr_stmt|;
comment|/* register */
if|if
condition|(
name|key
condition|)
name|hash_add
argument_list|(
operator|&
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|*
name|selector
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_CODE
operator|)
operator|==
name|_B_UCOMM
condition|)
block|{
if|if
condition|(
name|key
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_KEY
argument_list|,
literal|"cannot register use upcode..."
argument_list|)
expr_stmt|;
name|len
operator|=
name|__objc_read_nbyte_ulong
argument_list|(
name|stream
argument_list|,
operator|(
name|buf
index|[
literal|0
index|]
operator|&
name|_B_VALUE
operator|)
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
operator|(
operator|*
name|selector
operator|)
operator|=
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|stream_table
argument_list|,
name|LONG2PTR
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_DATA
argument_list|,
literal|"expected selector, got opcode %c"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/* ** USER LEVEL FUNCTIONS */
end_comment

begin_comment
comment|/* ** Write one object, encoded in TYPE and pointed to by DATA to the ** typed stream STREAM.   */
end_comment

begin_function
name|int
name|objc_write_type
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|)
block|{
switch|switch
condition|(
operator|*
name|type
condition|)
block|{
case|case
name|_C_ID
case|:
return|return
name|objc_write_object
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|id
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_CLASS
case|:
return|return
name|objc_write_class
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|Class
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_SEL
case|:
return|return
name|objc_write_selector
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|SEL
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_CHR
case|:
return|return
name|objc_write_char
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|signed
name|char
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_UCHR
case|:
return|return
name|objc_write_unsigned_char
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_SHT
case|:
return|return
name|objc_write_short
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|short
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_USHT
case|:
return|return
name|objc_write_unsigned_short
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_INT
case|:
return|return
name|objc_write_int
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_UINT
case|:
return|return
name|objc_write_unsigned_int
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_LNG
case|:
return|return
name|objc_write_long
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|long
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_ULNG
case|:
return|return
name|objc_write_unsigned_long
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_CHARPTR
case|:
return|return
name|objc_write_string
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|data
argument_list|,
name|strlen
argument_list|(
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|data
argument_list|)
argument_list|)
return|;
break|break;
case|case
name|_C_ATOM
case|:
return|return
name|objc_write_string_atomic
argument_list|(
name|stream
argument_list|,
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|data
argument_list|,
name|strlen
argument_list|(
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|data
argument_list|)
argument_list|)
return|;
break|break;
case|case
name|_C_ARY_B
case|:
block|{
name|int
name|len
init|=
name|atoi
argument_list|(
name|type
operator|+
literal|1
argument_list|)
decl_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
operator|++
name|type
argument_list|)
condition|)
empty_stmt|;
return|return
name|objc_write_array
argument_list|(
name|stream
argument_list|,
name|type
argument_list|,
name|len
argument_list|,
name|data
argument_list|)
return|;
block|}
break|break;
case|case
name|_C_STRUCT_B
case|:
block|{
name|int
name|acc_size
init|=
literal|0
decl_stmt|;
name|int
name|align
decl_stmt|;
while|while
condition|(
operator|*
name|type
operator|!=
name|_C_STRUCT_E
operator|&&
operator|*
name|type
operator|++
operator|!=
literal|'='
condition|)
empty_stmt|;
comment|/* skip "<name>=" */
while|while
condition|(
operator|*
name|type
operator|!=
name|_C_STRUCT_E
condition|)
block|{
name|align
operator|=
name|objc_alignof_type
argument_list|(
name|type
argument_list|)
expr_stmt|;
comment|/* padd to alignment */
name|acc_size
operator|+=
name|ROUND
argument_list|(
name|acc_size
argument_list|,
name|align
argument_list|)
expr_stmt|;
name|objc_write_type
argument_list|(
name|stream
argument_list|,
name|type
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|data
operator|)
operator|+
name|acc_size
argument_list|)
expr_stmt|;
name|acc_size
operator|+=
name|objc_sizeof_type
argument_list|(
name|type
argument_list|)
expr_stmt|;
comment|/* add component size */
name|type
operator|=
name|objc_skip_typespec
argument_list|(
name|type
argument_list|)
expr_stmt|;
comment|/* skip component */
block|}
return|return
literal|1
return|;
block|}
default|default:
block|{
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_TYPE
argument_list|,
literal|"objc_write_type: cannot parse typespec: %s\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ** Read one object, encoded in TYPE and pointed to by DATA to the ** typed stream STREAM.  DATA specifies the address of the types to ** read.  Expected type is checked against the type actually present ** on the stream.  */
end_comment

begin_function
name|int
name|objc_read_type
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|char
name|c
decl_stmt|;
switch|switch
condition|(
name|c
operator|=
operator|*
name|type
condition|)
block|{
case|case
name|_C_ID
case|:
return|return
name|objc_read_object
argument_list|(
name|stream
argument_list|,
operator|(
name|id
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_CLASS
case|:
return|return
name|objc_read_class
argument_list|(
name|stream
argument_list|,
operator|(
name|Class
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_SEL
case|:
return|return
name|objc_read_selector
argument_list|(
name|stream
argument_list|,
operator|(
name|SEL
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_CHR
case|:
return|return
name|objc_read_char
argument_list|(
name|stream
argument_list|,
operator|(
name|char
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_UCHR
case|:
return|return
name|objc_read_unsigned_char
argument_list|(
name|stream
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_SHT
case|:
return|return
name|objc_read_short
argument_list|(
name|stream
argument_list|,
operator|(
name|short
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_USHT
case|:
return|return
name|objc_read_unsigned_short
argument_list|(
name|stream
argument_list|,
operator|(
name|unsigned
name|short
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_INT
case|:
return|return
name|objc_read_int
argument_list|(
name|stream
argument_list|,
operator|(
name|int
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_UINT
case|:
return|return
name|objc_read_unsigned_int
argument_list|(
name|stream
argument_list|,
operator|(
name|unsigned
name|int
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_LNG
case|:
return|return
name|objc_read_long
argument_list|(
name|stream
argument_list|,
operator|(
name|long
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_ULNG
case|:
return|return
name|objc_read_unsigned_long
argument_list|(
name|stream
argument_list|,
operator|(
name|unsigned
name|long
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_CHARPTR
case|:
case|case
name|_C_ATOM
case|:
return|return
name|objc_read_string
argument_list|(
name|stream
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|data
argument_list|)
return|;
break|break;
case|case
name|_C_ARY_B
case|:
block|{
name|int
name|len
init|=
name|atoi
argument_list|(
name|type
operator|+
literal|1
argument_list|)
decl_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
operator|++
name|type
argument_list|)
condition|)
empty_stmt|;
return|return
name|objc_read_array
argument_list|(
name|stream
argument_list|,
name|type
argument_list|,
name|len
argument_list|,
name|data
argument_list|)
return|;
block|}
break|break;
case|case
name|_C_STRUCT_B
case|:
block|{
name|int
name|acc_size
init|=
literal|0
decl_stmt|;
name|int
name|align
decl_stmt|;
while|while
condition|(
operator|*
name|type
operator|!=
name|_C_STRUCT_E
operator|&&
operator|*
name|type
operator|++
operator|!=
literal|'='
condition|)
empty_stmt|;
comment|/* skip "<name>=" */
while|while
condition|(
operator|*
name|type
operator|!=
name|_C_STRUCT_E
condition|)
block|{
name|align
operator|=
name|objc_alignof_type
argument_list|(
name|type
argument_list|)
expr_stmt|;
comment|/* padd to alignment */
name|acc_size
operator|+=
name|ROUND
argument_list|(
name|acc_size
argument_list|,
name|align
argument_list|)
expr_stmt|;
name|objc_read_type
argument_list|(
name|stream
argument_list|,
name|type
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|data
operator|)
operator|+
name|acc_size
argument_list|)
expr_stmt|;
name|acc_size
operator|+=
name|objc_sizeof_type
argument_list|(
name|type
argument_list|)
expr_stmt|;
comment|/* add component size */
name|type
operator|=
name|objc_skip_typespec
argument_list|(
name|type
argument_list|)
expr_stmt|;
comment|/* skip component */
block|}
return|return
literal|1
return|;
block|}
default|default:
block|{
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_TYPE
argument_list|,
literal|"objc_read_type: cannot parse typespec: %s\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ** Write the object specified by the template TYPE to STREAM.  Last ** arguments specify addresses of values to be written.  It might  ** seem surprising to specify values by address, but this is extremely ** convenient for copy-paste with objc_read_types calls.  A more ** down-to-the-earth cause for this passing of addresses is that values ** of arbitrary size is not well supported in ANSI C for functions with ** variable number of arguments. */
end_comment

begin_function
name|int
name|objc_write_types
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
specifier|const
name|char
modifier|*
name|c
decl_stmt|;
name|int
name|res
init|=
literal|0
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|type
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
name|type
init|;
operator|*
name|c
condition|;
name|c
operator|=
name|objc_skip_typespec
argument_list|(
name|c
argument_list|)
control|)
block|{
switch|switch
condition|(
operator|*
name|c
condition|)
block|{
case|case
name|_C_ID
case|:
name|res
operator|=
name|objc_write_object
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
name|args
argument_list|,
name|id
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_CLASS
case|:
name|res
operator|=
name|objc_write_class
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
name|args
argument_list|,
name|Class
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_SEL
case|:
name|res
operator|=
name|objc_write_selector
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
name|args
argument_list|,
name|SEL
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_CHR
case|:
name|res
operator|=
name|objc_write_char
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
name|args
argument_list|,
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_UCHR
case|:
name|res
operator|=
name|objc_write_unsigned_char
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
argument|args
argument_list|,
argument|unsigned char*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_SHT
case|:
name|res
operator|=
name|objc_write_short
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
name|args
argument_list|,
name|short
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_USHT
case|:
name|res
operator|=
name|objc_write_unsigned_short
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
argument|args
argument_list|,
argument|unsigned short*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_INT
case|:
name|res
operator|=
name|objc_write_int
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
name|args
argument_list|,
name|int
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_UINT
case|:
name|res
operator|=
name|objc_write_unsigned_int
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
argument|args
argument_list|,
argument|unsigned int*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_LNG
case|:
name|res
operator|=
name|objc_write_long
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
name|args
argument_list|,
name|long
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_ULNG
case|:
name|res
operator|=
name|objc_write_unsigned_long
argument_list|(
name|stream
argument_list|,
operator|*
name|va_arg
argument_list|(
argument|args
argument_list|,
argument|unsigned long*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_CHARPTR
case|:
block|{
name|char
modifier|*
modifier|*
name|str
init|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|char
operator|*
operator|*
argument_list|)
decl_stmt|;
name|res
operator|=
name|objc_write_string
argument_list|(
name|stream
argument_list|,
operator|*
name|str
argument_list|,
name|strlen
argument_list|(
operator|*
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|_C_ATOM
case|:
block|{
name|char
modifier|*
modifier|*
name|str
init|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|char
operator|*
operator|*
argument_list|)
decl_stmt|;
name|res
operator|=
name|objc_write_string_atomic
argument_list|(
name|stream
argument_list|,
operator|*
name|str
argument_list|,
name|strlen
argument_list|(
operator|*
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|_C_ARY_B
case|:
block|{
name|int
name|len
init|=
name|atoi
argument_list|(
name|c
operator|+
literal|1
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|t
init|=
name|c
decl_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
operator|++
name|t
argument_list|)
condition|)
empty_stmt|;
name|res
operator|=
name|objc_write_array
argument_list|(
name|stream
argument_list|,
name|t
argument_list|,
name|len
argument_list|,
name|va_arg
argument_list|(
name|args
argument_list|,
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|objc_skip_typespec
argument_list|(
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|t
operator|!=
name|_C_ARY_E
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_TYPE
argument_list|,
literal|"expected `]', got: %s"
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_TYPE
argument_list|,
literal|"objc_write_types: cannot parse typespec: %s\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
block|}
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  ** Last arguments specify addresses of values to be read.  Expected ** type is checked against the type actually present on the stream.  */
end_comment

begin_function
name|int
name|objc_read_types
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
specifier|const
name|char
modifier|*
name|c
decl_stmt|;
name|int
name|res
init|=
literal|0
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|type
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
name|type
init|;
operator|*
name|c
condition|;
name|c
operator|=
name|objc_skip_typespec
argument_list|(
name|c
argument_list|)
control|)
block|{
switch|switch
condition|(
operator|*
name|c
condition|)
block|{
case|case
name|_C_ID
case|:
name|res
operator|=
name|objc_read_object
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
name|args
argument_list|,
name|id
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_CLASS
case|:
name|res
operator|=
name|objc_read_class
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
name|args
argument_list|,
name|Class
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_SEL
case|:
name|res
operator|=
name|objc_read_selector
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
name|args
argument_list|,
name|SEL
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_CHR
case|:
name|res
operator|=
name|objc_read_char
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
name|args
argument_list|,
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_UCHR
case|:
name|res
operator|=
name|objc_read_unsigned_char
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
argument|args
argument_list|,
argument|unsigned char*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_SHT
case|:
name|res
operator|=
name|objc_read_short
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
name|args
argument_list|,
name|short
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_USHT
case|:
name|res
operator|=
name|objc_read_unsigned_short
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
argument|args
argument_list|,
argument|unsigned short*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_INT
case|:
name|res
operator|=
name|objc_read_int
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
name|args
argument_list|,
name|int
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_UINT
case|:
name|res
operator|=
name|objc_read_unsigned_int
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
argument|args
argument_list|,
argument|unsigned int*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_LNG
case|:
name|res
operator|=
name|objc_read_long
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
name|args
argument_list|,
name|long
operator|*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_ULNG
case|:
name|res
operator|=
name|objc_read_unsigned_long
argument_list|(
name|stream
argument_list|,
name|va_arg
argument_list|(
argument|args
argument_list|,
argument|unsigned long*
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|_C_CHARPTR
case|:
case|case
name|_C_ATOM
case|:
block|{
name|char
modifier|*
modifier|*
name|str
init|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|char
operator|*
operator|*
argument_list|)
decl_stmt|;
name|res
operator|=
name|objc_read_string
argument_list|(
name|stream
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|_C_ARY_B
case|:
block|{
name|int
name|len
init|=
name|atoi
argument_list|(
name|c
operator|+
literal|1
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|t
init|=
name|c
decl_stmt|;
while|while
condition|(
name|isdigit
argument_list|(
operator|*
operator|++
name|t
argument_list|)
condition|)
empty_stmt|;
name|res
operator|=
name|objc_read_array
argument_list|(
name|stream
argument_list|,
name|t
argument_list|,
name|len
argument_list|,
name|va_arg
argument_list|(
name|args
argument_list|,
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|objc_skip_typespec
argument_list|(
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|t
operator|!=
name|_C_ARY_E
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_TYPE
argument_list|,
literal|"expected `]', got: %s"
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_BAD_TYPE
argument_list|,
literal|"objc_read_types: cannot parse typespec: %s\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
block|}
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/* ** Write an array of COUNT elements of TYPE from the memory address DATA. ** This is equivalent of objc_write_type (stream, "[N<type>]", data) */
end_comment

begin_function
name|int
name|objc_write_array
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|int
name|count
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|off
init|=
name|objc_sizeof_type
argument_list|(
name|type
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|where
init|=
name|data
decl_stmt|;
while|while
condition|(
name|count
operator|--
operator|>
literal|0
condition|)
block|{
name|objc_write_type
argument_list|(
name|stream
argument_list|,
name|type
argument_list|,
name|where
argument_list|)
expr_stmt|;
name|where
operator|+=
name|off
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* ** Read an array of COUNT elements of TYPE into the memory address ** DATA.  The memory pointed to by data is supposed to be allocated ** by the callee.  This is equivalent of  **   objc_read_type (stream, "[N<type>]", data) */
end_comment

begin_function
name|int
name|objc_read_array
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
name|int
name|count
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|off
init|=
name|objc_sizeof_type
argument_list|(
name|type
argument_list|)
decl_stmt|;
name|char
modifier|*
name|where
init|=
operator|(
name|char
operator|*
operator|)
name|data
decl_stmt|;
while|while
condition|(
name|count
operator|--
operator|>
literal|0
condition|)
block|{
name|objc_read_type
argument_list|(
name|stream
argument_list|,
name|type
argument_list|,
name|where
argument_list|)
expr_stmt|;
name|where
operator|+=
name|off
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__objc_fread
parameter_list|(
name|FILE
modifier|*
name|file
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
return|return
name|fread
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
literal|1
argument_list|,
name|file
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__objc_fwrite
parameter_list|(
name|FILE
modifier|*
name|file
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
return|return
name|fwrite
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
literal|1
argument_list|,
name|file
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__objc_feof
parameter_list|(
name|FILE
modifier|*
name|file
parameter_list|)
block|{
return|return
name|feof
argument_list|(
name|file
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__objc_no_write
parameter_list|(
name|FILE
modifier|*
name|file
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_NO_WRITE
argument_list|,
literal|"TypedStream not open for writing"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__objc_no_read
parameter_list|(
name|FILE
modifier|*
name|file
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_NO_READ
argument_list|,
literal|"TypedStream not open for reading"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__objc_read_typed_stream_signature
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|int
name|pos
init|=
literal|0
decl_stmt|;
do|do
call|(
modifier|*
name|stream
operator|->
name|read
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buffer
operator|+
name|pos
argument_list|,
literal|1
argument_list|)
expr_stmt|;
do|while
condition|(
name|buffer
index|[
name|pos
operator|++
index|]
operator|!=
literal|'\0'
condition|)
do|;
name|sscanf
argument_list|(
name|buffer
argument_list|,
literal|"GNU TypedStream %d"
argument_list|,
operator|&
name|stream
operator|->
name|version
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|->
name|version
operator|!=
name|OBJC_TYPED_STREAM_VERSION
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_STREAM_VERSION
argument_list|,
literal|"cannot handle TypedStream version %d"
argument_list|,
name|stream
operator|->
name|version
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__objc_write_typed_stream_signature
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"GNU TypedStream %d"
argument_list|,
name|OBJC_TYPED_STREAM_VERSION
argument_list|)
expr_stmt|;
name|stream
operator|->
name|version
operator|=
name|OBJC_TYPED_STREAM_VERSION
expr_stmt|;
call|(
modifier|*
name|stream
operator|->
name|write
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|,
name|buffer
argument_list|,
name|strlen
argument_list|(
name|buffer
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__objc_finish_write_root_object
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|)
block|{
name|hash_delete
argument_list|(
name|stream
operator|->
name|object_table
argument_list|)
expr_stmt|;
name|stream
operator|->
name|object_table
operator|=
name|hash_new
argument_list|(
literal|64
argument_list|,
operator|(
name|hash_func_type
operator|)
name|hash_ptr
argument_list|,
operator|(
name|compare_func_type
operator|)
name|compare_ptrs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|__objc_finish_read_root_object
parameter_list|(
name|struct
name|objc_typed_stream
modifier|*
name|stream
parameter_list|)
block|{
name|node_ptr
name|node
decl_stmt|;
name|SEL
name|awake_sel
init|=
name|sel_get_any_uid
argument_list|(
literal|"awake"
argument_list|)
decl_stmt|;
name|cache_ptr
name|free_list
init|=
name|hash_new
argument_list|(
literal|64
argument_list|,
operator|(
name|hash_func_type
operator|)
name|hash_ptr
argument_list|,
operator|(
name|compare_func_type
operator|)
name|compare_ptrs
argument_list|)
decl_stmt|;
comment|/* resolve object forward references */
for|for
control|(
name|node
operator|=
name|hash_next
argument_list|(
name|stream
operator|->
name|object_refs
argument_list|,
name|NULL
argument_list|)
init|;
name|node
condition|;
name|node
operator|=
name|hash_next
argument_list|(
name|stream
operator|->
name|object_refs
argument_list|,
name|node
argument_list|)
control|)
block|{
name|struct
name|objc_list
modifier|*
name|reflist
init|=
name|node
operator|->
name|value
decl_stmt|;
specifier|const
name|void
modifier|*
name|key
init|=
name|node
operator|->
name|key
decl_stmt|;
name|id
name|object
init|=
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|object_table
argument_list|,
name|key
argument_list|)
decl_stmt|;
while|while
condition|(
name|reflist
condition|)
block|{
operator|*
operator|(
operator|(
name|id
operator|*
operator|)
name|reflist
operator|->
name|head
operator|)
operator|=
name|object
expr_stmt|;
if|if
condition|(
name|hash_value_for_key
argument_list|(
name|free_list
argument_list|,
name|reflist
argument_list|)
operator|==
name|NULL
condition|)
name|hash_add
argument_list|(
operator|&
name|free_list
argument_list|,
name|reflist
argument_list|,
name|reflist
argument_list|)
expr_stmt|;
name|reflist
operator|=
name|reflist
operator|->
name|tail
expr_stmt|;
block|}
block|}
comment|/* apply __objc_free to all objects stored in free_list */
for|for
control|(
name|node
operator|=
name|hash_next
argument_list|(
name|free_list
argument_list|,
name|NULL
argument_list|)
init|;
name|node
condition|;
name|node
operator|=
name|hash_next
argument_list|(
name|free_list
argument_list|,
name|node
argument_list|)
control|)
name|objc_free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|node
operator|->
name|key
argument_list|)
expr_stmt|;
name|hash_delete
argument_list|(
name|free_list
argument_list|)
expr_stmt|;
comment|/* empty object reference table */
name|hash_delete
argument_list|(
name|stream
operator|->
name|object_refs
argument_list|)
expr_stmt|;
name|stream
operator|->
name|object_refs
operator|=
name|hash_new
argument_list|(
literal|8
argument_list|,
operator|(
name|hash_func_type
operator|)
name|hash_ptr
argument_list|,
operator|(
name|compare_func_type
operator|)
name|compare_ptrs
argument_list|)
expr_stmt|;
comment|/* call -awake for all objects read  */
if|if
condition|(
name|awake_sel
condition|)
block|{
for|for
control|(
name|node
operator|=
name|hash_next
argument_list|(
name|stream
operator|->
name|object_table
argument_list|,
name|NULL
argument_list|)
init|;
name|node
condition|;
name|node
operator|=
name|hash_next
argument_list|(
name|stream
operator|->
name|object_table
argument_list|,
name|node
argument_list|)
control|)
block|{
name|id
name|object
init|=
name|node
operator|->
name|value
decl_stmt|;
if|if
condition|(
name|__objc_responds_to
argument_list|(
name|object
argument_list|,
name|awake_sel
argument_list|)
condition|)
operator|(
operator|*
name|objc_msg_lookup
argument_list|(
name|object
argument_list|,
name|awake_sel
argument_list|)
operator|)
operator|(
name|object
operator|,
name|awake_sel
operator|)
expr_stmt|;
block|}
block|}
comment|/* empty object table */
name|hash_delete
argument_list|(
name|stream
operator|->
name|object_table
argument_list|)
expr_stmt|;
name|stream
operator|->
name|object_table
operator|=
name|hash_new
argument_list|(
literal|64
argument_list|,
operator|(
name|hash_func_type
operator|)
name|hash_ptr
argument_list|,
operator|(
name|compare_func_type
operator|)
name|compare_ptrs
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** Open the stream PHYSICAL in MODE */
end_comment

begin_function
name|TypedStream
modifier|*
name|objc_open_typed_stream
parameter_list|(
name|FILE
modifier|*
name|physical
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|TypedStream
modifier|*
name|s
init|=
operator|(
name|TypedStream
operator|*
operator|)
name|objc_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|TypedStream
argument_list|)
argument_list|)
decl_stmt|;
name|s
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
name|s
operator|->
name|physical
operator|=
name|physical
expr_stmt|;
name|s
operator|->
name|stream_table
operator|=
name|hash_new
argument_list|(
literal|64
argument_list|,
operator|(
name|hash_func_type
operator|)
name|hash_ptr
argument_list|,
operator|(
name|compare_func_type
operator|)
name|compare_ptrs
argument_list|)
expr_stmt|;
name|s
operator|->
name|object_table
operator|=
name|hash_new
argument_list|(
literal|64
argument_list|,
operator|(
name|hash_func_type
operator|)
name|hash_ptr
argument_list|,
operator|(
name|compare_func_type
operator|)
name|compare_ptrs
argument_list|)
expr_stmt|;
name|s
operator|->
name|eof
operator|=
operator|(
name|objc_typed_eof_func
operator|)
name|__objc_feof
expr_stmt|;
name|s
operator|->
name|flush
operator|=
operator|(
name|objc_typed_flush_func
operator|)
name|fflush
expr_stmt|;
name|s
operator|->
name|writing_root_p
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|OBJC_READONLY
condition|)
block|{
name|s
operator|->
name|class_table
operator|=
name|hash_new
argument_list|(
literal|8
argument_list|,
operator|(
name|hash_func_type
operator|)
name|hash_string
argument_list|,
operator|(
name|compare_func_type
operator|)
name|compare_strings
argument_list|)
expr_stmt|;
name|s
operator|->
name|object_refs
operator|=
name|hash_new
argument_list|(
literal|8
argument_list|,
operator|(
name|hash_func_type
operator|)
name|hash_ptr
argument_list|,
operator|(
name|compare_func_type
operator|)
name|compare_ptrs
argument_list|)
expr_stmt|;
name|s
operator|->
name|read
operator|=
operator|(
name|objc_typed_read_func
operator|)
name|__objc_fread
expr_stmt|;
name|s
operator|->
name|write
operator|=
operator|(
name|objc_typed_write_func
operator|)
name|__objc_no_write
expr_stmt|;
name|__objc_read_typed_stream_signature
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|OBJC_WRITEONLY
condition|)
block|{
name|s
operator|->
name|class_table
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|object_refs
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|read
operator|=
operator|(
name|objc_typed_read_func
operator|)
name|__objc_no_read
expr_stmt|;
name|s
operator|->
name|write
operator|=
operator|(
name|objc_typed_write_func
operator|)
name|__objc_fwrite
expr_stmt|;
name|__objc_write_typed_stream_signature
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|objc_close_typed_stream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|s
operator|->
name|type
operator|=
name|OBJC_FILE_STREAM
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

begin_comment
comment|/* ** Open the file named by FILE_NAME in MODE */
end_comment

begin_function
name|TypedStream
modifier|*
name|objc_open_typed_stream_for_file
parameter_list|(
specifier|const
name|char
modifier|*
name|file_name
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|FILE
modifier|*
name|file
init|=
name|NULL
decl_stmt|;
name|TypedStream
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|mode
operator|==
name|OBJC_READONLY
condition|)
name|file
operator|=
name|fopen
argument_list|(
name|file_name
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
else|else
name|file
operator|=
name|fopen
argument_list|(
name|file_name
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|file
condition|)
block|{
name|s
operator|=
name|objc_open_typed_stream
argument_list|(
name|file
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
name|s
operator|->
name|type
operator||=
name|OBJC_MANAGED_STREAM
expr_stmt|;
return|return
name|s
return|;
block|}
else|else
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* ** Close STREAM freeing the structure it self.  If it was opened with  ** objc_open_typed_stream_for_file, the file will also be closed. */
end_comment

begin_function
name|void
name|objc_close_typed_stream
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|)
block|{
if|if
condition|(
name|stream
operator|->
name|mode
operator|==
name|OBJC_READONLY
condition|)
block|{
name|__objc_finish_read_root_object
argument_list|(
name|stream
argument_list|)
expr_stmt|;
comment|/* Just in case... */
name|hash_delete
argument_list|(
name|stream
operator|->
name|class_table
argument_list|)
expr_stmt|;
name|hash_delete
argument_list|(
name|stream
operator|->
name|object_refs
argument_list|)
expr_stmt|;
block|}
name|hash_delete
argument_list|(
name|stream
operator|->
name|stream_table
argument_list|)
expr_stmt|;
name|hash_delete
argument_list|(
name|stream
operator|->
name|object_table
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|->
name|type
operator|==
operator|(
name|OBJC_MANAGED_STREAM
operator||
name|OBJC_FILE_STREAM
operator|)
condition|)
name|fclose
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|stream
operator|->
name|physical
argument_list|)
expr_stmt|;
name|objc_free
argument_list|(
name|stream
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|BOOL
name|objc_end_of_typed_stream
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|)
block|{
return|return
call|(
modifier|*
name|stream
operator|->
name|eof
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|objc_flush_typed_stream
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|)
block|{
call|(
modifier|*
name|stream
operator|->
name|flush
call|)
argument_list|(
name|stream
operator|->
name|physical
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|long
name|objc_get_stream_class_version
parameter_list|(
name|TypedStream
modifier|*
name|stream
parameter_list|,
name|Class
name|class
parameter_list|)
block|{
if|if
condition|(
name|stream
operator|->
name|class_table
condition|)
return|return
name|PTR2LONG
argument_list|(
name|hash_value_for_key
argument_list|(
name|stream
operator|->
name|class_table
argument_list|,
name|class
operator|->
name|name
argument_list|)
argument_list|)
return|;
else|else
return|return
name|class_get_version
argument_list|(
name|class
argument_list|)
return|;
block|}
end_function

end_unit


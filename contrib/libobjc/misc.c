begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* GNU Objective C Runtime Miscellaneous     Copyright (C) 1993, 1994, 1995, 1996, 1997 Free Software Foundation, Inc.    Contributed by Kresten Krab Thorup  This file is part of GNU CC.  GNU CC is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2, or (at your option) any later version.  GNU CC is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with GNU CC; see the file COPYING.  If not, write to the Free Software Foundation, 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* As a special exception, if you link this library with files compiled with    GCC to produce an executable, this does not cause the resulting executable    to be covered by the GNU General Public License. This exception does not    however invalidate any other reasons why the executable file might be    covered by the GNU General Public License.  */
end_comment

begin_define
define|#
directive|define
name|__USE_FIXED_PROTOTYPES__
end_define

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"runtime.h"
end_include

begin_comment
comment|/* ** Error handler function ** NULL so that default is to just print to stderr */
end_comment

begin_decl_stmt
specifier|static
name|objc_error_handler
name|_objc_error_handler
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Trigger an objc error */
end_comment

begin_function
name|void
name|objc_error
parameter_list|(
name|id
name|object
parameter_list|,
name|int
name|code
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|objc_verror
argument_list|(
name|object
argument_list|,
name|code
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Trigger an objc error */
end_comment

begin_function
name|void
name|objc_verror
parameter_list|(
name|id
name|object
parameter_list|,
name|int
name|code
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|BOOL
name|result
init|=
name|NO
decl_stmt|;
comment|/* Call the error handler if its there      Otherwise print to stderr */
if|if
condition|(
name|_objc_error_handler
condition|)
name|result
operator|=
call|(
modifier|*
name|_objc_error_handler
call|)
argument_list|(
name|object
argument_list|,
name|code
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
else|else
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
comment|/* Continue if the error handler says its ok      Otherwise abort the program */
if|if
condition|(
name|result
condition|)
return|return;
else|else
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Set the error handler */
end_comment

begin_function
name|objc_error_handler
name|objc_set_error_handler
parameter_list|(
name|objc_error_handler
name|func
parameter_list|)
block|{
name|objc_error_handler
name|temp
init|=
name|_objc_error_handler
decl_stmt|;
name|_objc_error_handler
operator|=
name|func
expr_stmt|;
return|return
name|temp
return|;
block|}
end_function

begin_comment
comment|/* ** Standard functions for memory allocation and disposal. ** Users should use these functions in their ObjC programs so ** that they work properly with garbage collectors as well as ** can take advantage of the exception/error handling available. */
end_comment

begin_function
name|void
modifier|*
name|objc_malloc
parameter_list|(
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|res
init|=
operator|(
name|void
operator|*
operator|)
call|(
modifier|*
name|_objc_malloc
call|)
argument_list|(
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_MEMORY
argument_list|,
literal|"Virtual memory exhausted\n"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|objc_atomic_malloc
parameter_list|(
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|res
init|=
operator|(
name|void
operator|*
operator|)
call|(
modifier|*
name|_objc_atomic_malloc
call|)
argument_list|(
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_MEMORY
argument_list|,
literal|"Virtual memory exhausted\n"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|objc_valloc
parameter_list|(
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|res
init|=
operator|(
name|void
operator|*
operator|)
call|(
modifier|*
name|_objc_valloc
call|)
argument_list|(
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_MEMORY
argument_list|,
literal|"Virtual memory exhausted\n"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|objc_realloc
parameter_list|(
name|void
modifier|*
name|mem
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|res
init|=
operator|(
name|void
operator|*
operator|)
call|(
modifier|*
name|_objc_realloc
call|)
argument_list|(
name|mem
argument_list|,
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_MEMORY
argument_list|,
literal|"Virtual memory exhausted\n"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|objc_calloc
parameter_list|(
name|size_t
name|nelem
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|res
init|=
operator|(
name|void
operator|*
operator|)
call|(
modifier|*
name|_objc_calloc
call|)
argument_list|(
name|nelem
argument_list|,
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_MEMORY
argument_list|,
literal|"Virtual memory exhausted\n"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|void
name|objc_free
parameter_list|(
name|void
modifier|*
name|mem
parameter_list|)
block|{
call|(
modifier|*
name|_objc_free
call|)
argument_list|(
name|mem
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** Hook functions for memory allocation and disposal. ** This makes it easy to substitute garbage collection systems ** such as Boehm's GC by assigning these function pointers ** to the GC's allocation routines.  By default these point ** to the ANSI standard malloc, realloc, free, etc. ** ** Users should call the normal objc routines above for ** memory allocation and disposal within their programs. */
end_comment

begin_if
if|#
directive|if
name|OBJC_WITH_GC
end_if

begin_include
include|#
directive|include
file|<gc.h>
end_include

begin_function
specifier|static
name|void
modifier|*
name|GC_calloc
parameter_list|(
name|size_t
name|nelem
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|p
init|=
name|GC_malloc
argument_list|(
name|nelem
operator|*
name|size
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
name|objc_error
argument_list|(
name|nil
argument_list|,
name|OBJC_ERR_MEMORY
argument_list|,
literal|"Virtual memory exhausted!\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|nelem
operator|*
name|size
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|noFree
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{}
end_function

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_malloc
function_decl|)
parameter_list|(
name|size_t
parameter_list|)
init|=
name|GC_malloc
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_atomic_malloc
function_decl|)
parameter_list|(
name|size_t
parameter_list|)
init|=
name|GC_malloc_atomic
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_valloc
function_decl|)
parameter_list|(
name|size_t
parameter_list|)
init|=
name|GC_malloc
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_realloc
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|)
init|=
name|GC_realloc
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_calloc
function_decl|)
parameter_list|(
name|size_t
parameter_list|,
name|size_t
parameter_list|)
init|=
name|GC_calloc
function_decl|;
end_function_decl

begin_function_decl
name|void
function_decl|(
modifier|*
name|_objc_free
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
init|=
name|noFree
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_malloc
function_decl|)
parameter_list|(
name|size_t
parameter_list|)
init|=
name|malloc
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_atomic_malloc
function_decl|)
parameter_list|(
name|size_t
parameter_list|)
init|=
name|malloc
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_valloc
function_decl|)
parameter_list|(
name|size_t
parameter_list|)
init|=
name|malloc
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_realloc
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|)
init|=
name|realloc
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
function_decl|(
modifier|*
name|_objc_calloc
function_decl|)
parameter_list|(
name|size_t
parameter_list|,
name|size_t
parameter_list|)
init|=
name|calloc
function_decl|;
end_function_decl

begin_function_decl
name|void
function_decl|(
modifier|*
name|_objc_free
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
init|=
name|free
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

end_unit


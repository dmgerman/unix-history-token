begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ** Copyright (C) 1991, 1997 Free Software Foundation, Inc. **  ** This file is part of TACK. **  ** TACK is free software; you can redistribute it and/or modify ** it under the terms of the GNU General Public License as published by ** the Free Software Foundation; either version 2, or (at your option) ** any later version. **  ** TACK is distributed in the hope that it will be useful, ** but WITHOUT ANY WARRANTY; without even the implied warranty of ** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the ** GNU General Public License for more details. **  ** You should have received a copy of the GNU General Public License ** along with TACK; see the file COPYING.  If not, write to ** the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, ** Boston, MA 02110-1301, USA */
end_comment

begin_include
include|#
directive|include
file|<tack.h>
end_include

begin_macro
name|MODULE_ID
argument_list|(
literal|"$Id: tack.c,v 1.4 2005/09/17 19:49:16 tom Exp $"
argument_list|)
end_macro

begin_comment
comment|/*    This program is designed to test terminfo, not curses.  Therefore    I have used as little of curses as possible.     Pads associated with the following capabilities are used to set    delay times in the handler:  (cr), (ind), (cub1), (ff), (tab).     I use the (nxon) capability to set the tty handler with/without    xon/xoff.  If (smxon)/(rmxon) is defined I will change the terminal    too.     (xon) inhibits the sending of delay characters in putp().    If the terminal is defined with no padding then the (xon) boolean    is a don't care.  In this case I recommend that it be reset.  */
end_comment

begin_comment
comment|/*****************************************************************************  *  * Option processing  *  *****************************************************************************/
end_comment

begin_comment
comment|/* options and modes */
end_comment

begin_decl_stmt
name|int
name|debug_level
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* debugging level */
end_comment

begin_decl_stmt
name|int
name|translate_mode
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* translate tab, bs, cr, lf, ff */
end_comment

begin_decl_stmt
name|int
name|scan_mode
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* use scan codes */
end_comment

begin_decl_stmt
name|int
name|char_mask
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* either 0xFF else 0x7F, eight bit data mask */
end_comment

begin_decl_stmt
name|int
name|select_delay_type
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* set handler delays for<cr><lf> */
end_comment

begin_decl_stmt
name|int
name|select_xon_xoff
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TTY driver XON/XOFF mode select */
end_comment

begin_decl_stmt
name|int
name|hex_out
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Display output in hex */
end_comment

begin_decl_stmt
name|int
name|send_reset_init
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Send the reset and initialization strings */
end_comment

begin_decl_stmt
name|FILE
modifier|*
name|log_fp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Terminal logfile */
end_comment

begin_comment
comment|/*****************************************************************************  *  * Menu definitions  *  *****************************************************************************/
end_comment

begin_function_decl
specifier|static
name|void
name|tools_hex_echo
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tools_debug
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|char
name|hex_echo_menu_entry
index|[
literal|80
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_list
name|tools_test_list
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"s) ANSI status reports"
block|,
name|tools_status
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"g) ANSI SGR modes (bold, underline, reverse)"
block|,
name|tools_sgr
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"c) ANSI character sets"
block|,
name|tools_charset
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|hex_echo_menu_entry
block|,
name|tools_hex_echo
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"e) echo tool"
block|,
name|tools_report
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"r) reply tool"
block|,
name|tools_report
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"p) performance testing"
block|,
literal|0
block|,
operator|&
name|sync_menu
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"i) send reset and init"
block|,
name|menu_reset_init
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|"u8) (u9"
block|,
literal|0
block|,
literal|"u) test ENQ/ACK handshake"
block|,
name|sync_handshake
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"d) change debug level"
block|,
name|tools_debug
block|,
literal|0
block|}
block|,
block|{
name|MENU_LAST
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|tools_menu
init|=
block|{
literal|0
block|,
literal|'q'
block|,
literal|0
block|,
literal|"Tools Menu"
block|,
literal|"tools"
block|,
literal|0
block|,
literal|0
block|,
name|tools_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|tty_width
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tty_delay
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tty_xon
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tty_trans
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tty_show_state
parameter_list|(
name|struct
name|test_menu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|char
name|tty_width_menu
index|[
literal|80
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|tty_delay_menu
index|[
literal|80
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|tty_xon_menu
index|[
literal|80
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|tty_trans_menu
index|[
literal|80
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|enable_xon_xoff
index|[]
init|=
block|{
literal|"x) enable xon/xoff"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|disable_xon_xoff
index|[]
init|=
block|{
literal|"x) disable xon/xoff"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_list
name|tty_test_list
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|tty_width_menu
block|,
name|tty_width
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|tty_delay_menu
block|,
name|tty_delay
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|tty_xon_menu
block|,
name|tty_xon
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|tty_trans_menu
block|,
name|tty_trans
block|,
literal|0
block|}
block|,
block|{
name|MENU_LAST
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|tty_menu
init|=
block|{
literal|0
block|,
literal|'q'
block|,
literal|0
block|,
literal|"Terminal and driver configuration"
block|,
literal|"tty"
block|,
literal|0
block|,
name|tty_show_state
block|,
name|tty_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|test_menu
name|edit_menu
init|=
block|{
literal|0
block|,
literal|'q'
block|,
literal|0
block|,
literal|"Edit terminfo menu"
block|,
literal|"edit"
block|,
literal|0
block|,
literal|0
block|,
name|edit_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|mode_menu
init|=
block|{
literal|0
block|,
literal|'n'
block|,
literal|0
block|,
literal|"Test modes and glitches:"
block|,
literal|"mode"
block|,
literal|"n) run standard tests"
block|,
literal|0
block|,
name|mode_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|acs_menu
init|=
block|{
literal|0
block|,
literal|'n'
block|,
literal|0
block|,
literal|"Test alternate character set and graphics rendition:"
block|,
literal|"acs"
block|,
literal|"n) run standard tests"
block|,
literal|0
block|,
name|acs_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|color_menu
init|=
block|{
literal|0
block|,
literal|'n'
block|,
literal|0
block|,
literal|"Test color:"
block|,
literal|"color"
block|,
literal|"n) run standard tests"
block|,
literal|0
block|,
name|color_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|crum_menu
init|=
block|{
literal|0
block|,
literal|'n'
block|,
literal|0
block|,
literal|"Test cursor movement:"
block|,
literal|"move"
block|,
literal|"n) run standard tests"
block|,
literal|0
block|,
name|crum_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|funkey_menu
init|=
block|{
literal|0
block|,
literal|'n'
block|,
literal|0
block|,
literal|"Test function keys:"
block|,
literal|"fkey"
block|,
literal|"n) run standard tests"
block|,
name|sync_test
block|,
name|funkey_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|printer_menu
init|=
block|{
literal|0
block|,
literal|'n'
block|,
literal|0
block|,
literal|"Test printer:"
block|,
literal|"printer"
block|,
literal|"n) run standard tests"
block|,
literal|0
block|,
name|printer_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|pad_gen
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|pad_menu
init|=
block|{
literal|0
block|,
literal|'n'
block|,
literal|0
block|,
literal|"Test padding and string capabilities:"
block|,
literal|"pad"
block|,
literal|"n) run standard tests"
block|,
name|sync_test
block|,
name|pad_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_list
name|normal_test_list
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"e) edit terminfo"
block|,
literal|0
block|,
operator|&
name|edit_menu
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"i) send reset and init"
block|,
name|menu_reset_init
block|,
literal|0
block|}
block|,
block|{
name|MENU_NEXT
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"x) test modes and glitches"
block|,
literal|0
block|,
operator|&
name|mode_menu
block|}
block|,
block|{
name|MENU_NEXT
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"a) test alternate character set and graphic rendition"
block|,
literal|0
block|,
operator|&
name|acs_menu
block|}
block|,
block|{
name|MENU_NEXT
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"c) test color"
block|,
literal|0
block|,
operator|&
name|color_menu
block|}
block|,
block|{
name|MENU_NEXT
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"m) test cursor movement"
block|,
literal|0
block|,
operator|&
name|crum_menu
block|}
block|,
block|{
name|MENU_NEXT
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"f) test function keys"
block|,
literal|0
block|,
operator|&
name|funkey_menu
block|}
block|,
block|{
name|MENU_NEXT
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"p) test padding and string capabilities"
block|,
literal|0
block|,
operator|&
name|pad_menu
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"P) test printer"
block|,
literal|0
block|,
operator|&
name|printer_menu
block|}
block|,
block|{
name|MENU_MENU
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"/) test a specific capability"
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"t) auto generate pad delays"
block|,
name|pad_gen
block|,
operator|&
name|pad_menu
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|"u8) (u9"
block|,
literal|0
block|,
literal|0
block|,
name|sync_handshake
block|,
literal|0
block|}
block|,
block|{
name|MENU_LAST
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|normal_menu
init|=
block|{
literal|0
block|,
literal|'n'
block|,
literal|0
block|,
literal|"Main test menu"
block|,
literal|"test"
block|,
literal|"n) run standard tests"
block|,
literal|0
block|,
name|normal_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|start_tools
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|start_modes
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|start_basic
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|start_log
parameter_list|(
name|struct
name|test_list
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|char
name|logging_menu_entry
index|[
literal|80
index|]
init|=
literal|"l) start logging"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_list
name|start_test_list
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"b) display basic information"
block|,
name|start_basic
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"m) change modes"
block|,
name|start_modes
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"t) tools"
block|,
name|start_tools
block|,
literal|0
block|}
block|,
block|{
name|MENU_COMPLETE
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"n) begin testing"
block|,
literal|0
block|,
operator|&
name|normal_menu
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|logging_menu_entry
block|,
name|start_log
block|,
literal|0
block|}
block|,
block|{
name|MENU_LAST
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_menu
name|start_menu
init|=
block|{
literal|0
block|,
literal|'n'
block|,
literal|0
block|,
literal|"Main Menu"
block|,
literal|"tack"
block|,
literal|0
block|,
literal|0
block|,
name|start_test_list
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|test_list
name|write_terminfo_list
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|"w) write the current terminfo to a file"
block|,
name|save_info
block|,
literal|0
block|}
block|,
block|{
name|MENU_LAST
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  *  * Menu command interpretation.  *  *****************************************************************************/
end_comment

begin_comment
comment|/* **	tools_hex_echo(testlist, state, ch) ** **	Flip the hex echo flag. */
end_comment

begin_function
specifier|static
name|void
name|tools_hex_echo
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
name|GCC_UNUSED
parameter_list|)
block|{
if|if
condition|(
name|hex_out
condition|)
block|{
name|hex_out
operator|=
name|FALSE
expr_stmt|;
name|strcpy
argument_list|(
name|hex_echo_menu_entry
argument_list|,
literal|"h) enable hex output on echo tool"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hex_out
operator|=
name|TRUE
expr_stmt|;
name|strcpy
argument_list|(
name|hex_echo_menu_entry
argument_list|,
literal|"h) disable hex output on echo tool"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **	tools_debug(testlist, state, ch) ** **	Change the debug level. */
end_comment

begin_function
specifier|static
name|void
name|tools_debug
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
parameter_list|)
block|{
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|ptext
argument_list|(
literal|"Enter a new value: "
argument_list|)
expr_stmt|;
name|read_string
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
condition|)
block|{
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|debug_level
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|temp
argument_list|,
literal|"Debug level is now %d"
argument_list|,
name|debug_level
argument_list|)
expr_stmt|;
name|ptext
argument_list|(
name|temp
argument_list|)
expr_stmt|;
operator|*
name|ch
operator|=
name|REQUEST_PROMPT
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **	start_tools(testlist, state, ch) ** **	Run the generic test tools */
end_comment

begin_function
specifier|static
name|void
name|start_tools
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
name|GCC_UNUSED
parameter_list|)
block|{
if|if
condition|(
name|hex_out
condition|)
block|{
name|strcpy
argument_list|(
name|hex_echo_menu_entry
argument_list|,
literal|"h) disable hex output on echo tool"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|hex_echo_menu_entry
argument_list|,
literal|"h) enable hex output on echo tool"
argument_list|)
expr_stmt|;
block|}
name|menu_display
argument_list|(
operator|&
name|tools_menu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **	tty_show_state() ** **	Display the current state on the tty driver settings */
end_comment

begin_function
specifier|static
name|void
name|tty_show_state
parameter_list|(
name|struct
name|test_menu
modifier|*
name|menu
name|GCC_UNUSED
parameter_list|)
block|{
name|put_crlf
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|temp
argument_list|,
literal|"Accepting %d bits, UNIX delays %d, XON/XOFF %sabled, speed %u, translate %s, scan-code mode %s."
argument_list|,
operator|(
name|char_mask
operator|==
name|ALLOW_PARITY
operator|)
condition|?
literal|8
else|:
literal|7
argument_list|,
name|select_delay_type
argument_list|,
name|select_xon_xoff
condition|?
literal|"en"
else|:
literal|"dis"
argument_list|,
name|tty_baud_rate
argument_list|,
name|translate_mode
condition|?
literal|"on"
else|:
literal|"off"
argument_list|,
name|scan_mode
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
name|ptextln
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|put_crlf
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **	tty_width(testlist, state, ch) ** **	Change the character width */
end_comment

begin_function
specifier|static
name|void
name|tty_width
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
name|GCC_UNUSED
parameter_list|)
block|{
if|if
condition|(
name|char_mask
operator|==
name|STRIP_PARITY
condition|)
block|{
name|char_mask
operator|=
name|ALLOW_PARITY
expr_stmt|;
name|strcpy
argument_list|(
name|tty_width_menu
argument_list|,
literal|"7) treat terminal as 7-bit"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char_mask
operator|=
name|STRIP_PARITY
expr_stmt|;
name|strcpy
argument_list|(
name|tty_width_menu
argument_list|,
literal|"8) treat terminal as 8-bit"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **	tty_delay(testlist, state, ch) ** **	Change the delay for<cr><lf> in the TTY driver */
end_comment

begin_function
specifier|static
name|void
name|tty_delay
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
name|GCC_UNUSED
parameter_list|)
block|{
if|if
condition|(
name|select_delay_type
condition|)
block|{
name|select_delay_type
operator|=
name|FALSE
expr_stmt|;
name|strcpy
argument_list|(
name|tty_delay_menu
argument_list|,
literal|"d) enable UNIX tty driver delays for<cr><lf>"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|select_delay_type
operator|=
name|TRUE
expr_stmt|;
name|strcpy
argument_list|(
name|tty_delay_menu
argument_list|,
literal|"d) disable UNIX tty driver delays for<cr><lf>"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **	tty_xon(testlist, state, ch) ** **	Change the XON/XOFF flags in the TTY driver */
end_comment

begin_function
specifier|static
name|void
name|tty_xon
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
name|GCC_UNUSED
parameter_list|)
block|{
if|if
condition|(
name|select_xon_xoff
condition|)
block|{
if|if
condition|(
name|needs_xon_xoff
condition|)
block|{
name|ptextln
argument_list|(
literal|"This terminal is marked as needing XON/XOFF protocol with (nxon)"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|exit_xon_mode
condition|)
block|{
name|tc_putp
argument_list|(
name|exit_xon_mode
argument_list|)
expr_stmt|;
block|}
name|xon_xoff
operator|=
name|select_xon_xoff
operator|=
name|FALSE
expr_stmt|;
name|strcpy
argument_list|(
name|tty_xon_menu
argument_list|,
name|enable_xon_xoff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|enter_xon_mode
condition|)
block|{
name|tc_putp
argument_list|(
name|enter_xon_mode
argument_list|)
expr_stmt|;
block|}
name|xon_xoff
operator|=
name|select_xon_xoff
operator|=
name|TRUE
expr_stmt|;
name|strcpy
argument_list|(
name|tty_xon_menu
argument_list|,
name|disable_xon_xoff
argument_list|)
expr_stmt|;
block|}
name|tty_set
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **	tty_trans(testlist, state, ch) ** **	Change the translation mode for special characters */
end_comment

begin_function
specifier|static
name|void
name|tty_trans
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
name|GCC_UNUSED
parameter_list|)
block|{
if|if
condition|(
name|translate_mode
condition|)
block|{
name|translate_mode
operator|=
name|FALSE
expr_stmt|;
name|strcpy
argument_list|(
name|tty_trans_menu
argument_list|,
literal|"t) use terminfo values for \\b\\f\\n\\r\\t"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|translate_mode
operator|=
name|TRUE
expr_stmt|;
name|strcpy
argument_list|(
name|tty_trans_menu
argument_list|,
literal|"t) override terminfo values for \\b\\f\\n\\r\\t"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **	pad_gen(testlist, state, ch) ** **	Menu function for automatic pad generation */
end_comment

begin_function
specifier|static
name|void
name|pad_gen
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
parameter_list|)
block|{
name|control_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|tty_can_sync
operator|==
name|SYNC_NOT_TESTED
condition|)
block|{
name|verify_time
argument_list|()
expr_stmt|;
block|}
name|auto_pad_mode
operator|=
name|TRUE
expr_stmt|;
name|menu_display
argument_list|(
name|t
operator|->
name|sub_menu
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|auto_pad_mode
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **	start_modes(testlist, state, ch) ** **	Change the TTY modes */
end_comment

begin_function
specifier|static
name|void
name|start_modes
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
name|GCC_UNUSED
parameter_list|)
block|{
if|if
condition|(
name|select_delay_type
condition|)
block|{
name|strcpy
argument_list|(
name|tty_delay_menu
argument_list|,
literal|"d) disable UNIX tty driver delays for<cr><lf>"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|tty_delay_menu
argument_list|,
literal|"d) enable UNIX tty driver delays for<cr><lf>"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|char_mask
operator|==
name|ALLOW_PARITY
condition|)
block|{
name|strcpy
argument_list|(
name|tty_width_menu
argument_list|,
literal|"7) treat terminal as 7-bit"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|tty_width_menu
argument_list|,
literal|"8) treat terminal as 8-bit"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|select_xon_xoff
condition|)
block|{
name|strcpy
argument_list|(
name|tty_xon_menu
argument_list|,
name|disable_xon_xoff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|tty_xon_menu
argument_list|,
name|enable_xon_xoff
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|translate_mode
condition|)
block|{
name|strcpy
argument_list|(
name|tty_trans_menu
argument_list|,
literal|"t) override terminfo values for \\b\\f\\n\\r\\t"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|tty_trans_menu
argument_list|,
literal|"t) use terminfo values for \\b\\f\\n\\r\\t"
argument_list|)
expr_stmt|;
block|}
name|menu_display
argument_list|(
operator|&
name|tty_menu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tty_set
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **	start_basic(testlist, state, ch) ** **	Display basic terminal information */
end_comment

begin_function
specifier|static
name|void
name|start_basic
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
parameter_list|)
block|{
name|display_basic
argument_list|()
expr_stmt|;
operator|*
name|ch
operator|=
name|REQUEST_PROMPT
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **	start_log(testlist, state, ch) ** **	Start/stop in logging function */
end_comment

begin_function
specifier|static
name|void
name|start_log
parameter_list|(
name|struct
name|test_list
modifier|*
name|t
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|state
name|GCC_UNUSED
parameter_list|,
name|int
modifier|*
name|ch
name|GCC_UNUSED
parameter_list|)
block|{
if|if
condition|(
name|logging_menu_entry
index|[
literal|5
index|]
operator|==
literal|'a'
condition|)
block|{
name|ptextln
argument_list|(
literal|"The log file will capture all characters sent to the terminal."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|log_fp
operator|=
name|fopen
argument_list|(
literal|"tack.log"
argument_list|,
literal|"w"
argument_list|)
operator|)
condition|)
block|{
name|ptextln
argument_list|(
literal|"Start logging to file: tack.log"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|logging_menu_entry
argument_list|,
literal|"l) stop logging"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ptextln
argument_list|(
literal|"File open error: tack.log"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|log_fp
condition|)
block|{
name|fclose
argument_list|(
name|log_fp
argument_list|)
expr_stmt|;
name|log_fp
operator|=
literal|0
expr_stmt|;
block|}
name|ptextln
argument_list|(
literal|"Terminal output logging stopped."
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|logging_menu_entry
argument_list|,
literal|"l) start logging"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* **	show_usage() ** **	Tell the user how its done. */
end_comment

begin_function
name|void
name|show_usage
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [-itV] [term]\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **	print_version() ** **	Print version and other useful information. */
end_comment

begin_function
name|void
name|print_version
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"tack version %d.%02d\n"
argument_list|,
name|MAJOR_VERSION
argument_list|,
name|MINOR_VERSION
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Copyright (C) 1997 Free Software Foundation, Inc.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Tack comes with NO WARRANTY, to the extent permitted by law.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"You may redistribute copies of Tack under the terms of the\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"GNU General Public License.  For more information about\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"these matters, see the file named COPYING.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  *  * Main sequence  *  *****************************************************************************/
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|term_variable
decl_stmt|;
comment|/* scan the option flags */
name|send_reset_init
operator|=
name|TRUE
expr_stmt|;
name|translate_mode
operator|=
name|FALSE
expr_stmt|;
name|term_variable
operator|=
name|getenv
argument_list|(
literal|"TERM"
argument_list|)
expr_stmt|;
name|tty_can_sync
operator|=
name|SYNC_NOT_TESTED
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|1
init|;
name|argv
index|[
name|i
index|]
index|[
name|j
index|]
condition|;
name|j
operator|++
control|)
block|{
switch|switch
condition|(
name|argv
index|[
name|i
index|]
index|[
name|j
index|]
condition|)
block|{
case|case
literal|'V'
case|:
name|print_version
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
literal|'i'
case|:
name|send_reset_init
operator|=
name|FALSE
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|translate_mode
operator|=
name|FALSE
expr_stmt|;
break|break;
default|default:
name|show_usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
else|else
block|{
name|term_variable
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tty_basename
argument_list|,
name|term_variable
argument_list|)
expr_stmt|;
name|curses_setup
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|menu_can_scan
argument_list|(
operator|&
name|normal_menu
argument_list|)
expr_stmt|;
comment|/* extract which caps can be tested */
name|menu_display
argument_list|(
operator|&
name|start_menu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|user_modified
argument_list|()
condition|)
block|{
name|sprintf
argument_list|(
name|temp
argument_list|,
literal|"Hit y to save changes to file: %s  ? "
argument_list|,
name|tty_basename
argument_list|)
expr_stmt|;
name|ptext
argument_list|(
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait_here
argument_list|()
operator|==
literal|'y'
condition|)
block|{
name|save_info
argument_list|(
name|write_terminfo_list
argument_list|,
operator|&
name|i
argument_list|,
operator|&
name|j
argument_list|)
expr_stmt|;
block|}
block|}
name|put_str
argument_list|(
literal|"\nTerminal test complete\n"
argument_list|)
expr_stmt|;
name|bye_kids
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* footnotes.c -- Some functions for manipulating footnotes.    $Id: footnotes.c,v 1.2 2002/11/06 00:41:17 karl Exp $     Copyright (C) 1993, 1997, 1998, 1999, 2002 Free Software Foundation, Inc.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2, or (at your option)    any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.     Written by Brian Fox (bfox@ai.mit.edu). */
end_comment

begin_include
include|#
directive|include
file|"info.h"
end_include

begin_comment
comment|/* Nonzero means attempt to show footnotes when displaying a new window. */
end_comment

begin_decl_stmt
name|int
name|auto_footnotes_p
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|footnote_nodename
init|=
literal|"*Footnotes*"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|FOOTNOTE_HEADER_FORMAT
define|\
value|"*** Footnotes appearing in the node \"%s\" ***\n"
end_define

begin_comment
comment|/* Find the window currently showing footnotes. */
end_comment

begin_function
specifier|static
name|WINDOW
modifier|*
name|find_footnotes_window
parameter_list|()
block|{
name|WINDOW
modifier|*
name|win
decl_stmt|;
comment|/* Try to find an existing window first. */
for|for
control|(
name|win
operator|=
name|windows
init|;
name|win
condition|;
name|win
operator|=
name|win
operator|->
name|next
control|)
if|if
condition|(
name|internal_info_node_p
argument_list|(
name|win
operator|->
name|node
argument_list|)
operator|&&
operator|(
name|strcmp
argument_list|(
name|win
operator|->
name|node
operator|->
name|nodename
argument_list|,
name|footnote_nodename
argument_list|)
operator|==
literal|0
operator|)
condition|)
break|break;
return|return
operator|(
name|win
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Manufacture a node containing the footnotes of this node, and    return the manufactured node.  If NODE has no footnotes, return a     NULL pointer. */
end_comment

begin_function
name|NODE
modifier|*
name|make_footnotes_node
parameter_list|(
name|node
parameter_list|)
name|NODE
modifier|*
name|node
decl_stmt|;
block|{
name|NODE
modifier|*
name|fn_node
decl_stmt|,
modifier|*
name|result
init|=
operator|(
name|NODE
operator|*
operator|)
name|NULL
decl_stmt|;
name|long
name|fn_start
decl_stmt|;
comment|/* Make the initial assumption that the footnotes appear as simple      text within this windows node. */
name|fn_node
operator|=
name|node
expr_stmt|;
comment|/* See if this node contains the magic footnote label. */
name|fn_start
operator|=
name|info_search_in_node
argument_list|(
name|FOOTNOTE_LABEL
argument_list|,
name|node
argument_list|,
literal|0
argument_list|,
operator|(
name|WINDOW
operator|*
operator|)
name|NULL
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* If it doesn't, check to see if it has an associated footnotes node. */
if|if
condition|(
name|fn_start
operator|==
operator|-
literal|1
condition|)
block|{
name|REFERENCE
modifier|*
modifier|*
name|refs
decl_stmt|;
name|refs
operator|=
name|info_xrefs_of_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|refs
condition|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|refname
decl_stmt|;
name|int
name|reflen
init|=
name|strlen
argument_list|(
literal|"-Footnotes"
argument_list|)
operator|+
name|strlen
argument_list|(
name|node
operator|->
name|nodename
argument_list|)
decl_stmt|;
name|refname
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|reflen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|refname
argument_list|,
name|node
operator|->
name|nodename
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|refname
argument_list|,
literal|"-Footnotes"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|refs
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|refs
index|[
name|i
index|]
operator|->
name|nodename
operator|!=
operator|(
name|char
operator|*
operator|)
name|NULL
operator|)
operator|&&
comment|/* Support both the older "foo-Footnotes" and the new                    style "foo-Footnote-NN" references.  */
operator|(
name|strcmp
argument_list|(
name|refs
index|[
name|i
index|]
operator|->
name|nodename
argument_list|,
name|refname
argument_list|)
operator|==
literal|0
operator|||
operator|(
name|strncmp
argument_list|(
name|refs
index|[
name|i
index|]
operator|->
name|nodename
argument_list|,
name|refname
argument_list|,
name|reflen
operator|-
literal|1
argument_list|)
operator|==
literal|0
operator|&&
name|refs
index|[
name|i
index|]
operator|->
name|nodename
index|[
name|reflen
operator|-
literal|1
index|]
operator|==
literal|'-'
operator|&&
name|isdigit
argument_list|(
name|refs
index|[
name|i
index|]
operator|->
name|nodename
index|[
name|reflen
index|]
argument_list|)
operator|)
operator|)
condition|)
block|{
name|char
modifier|*
name|filename
decl_stmt|;
name|filename
operator|=
name|node
operator|->
name|parent
expr_stmt|;
if|if
condition|(
operator|!
name|filename
condition|)
name|filename
operator|=
name|node
operator|->
name|filename
expr_stmt|;
name|fn_node
operator|=
name|info_get_node
argument_list|(
name|filename
argument_list|,
name|refname
argument_list|)
expr_stmt|;
if|if
condition|(
name|fn_node
condition|)
name|fn_start
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|free
argument_list|(
name|refname
argument_list|)
expr_stmt|;
name|info_free_references
argument_list|(
name|refs
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* If we never found the start of a footnotes area, quit now. */
if|if
condition|(
name|fn_start
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|(
name|NODE
operator|*
operator|)
name|NULL
operator|)
return|;
comment|/* Make the new node. */
name|result
operator|=
operator|(
name|NODE
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|NODE
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|result
operator|->
name|display_pos
operator|=
literal|0
expr_stmt|;
comment|/* Get the size of the footnotes appearing within this node. */
block|{
name|char
modifier|*
name|header
decl_stmt|;
name|long
name|text_start
init|=
name|fn_start
decl_stmt|;
name|header
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
literal|1
operator|+
name|strlen
argument_list|(
name|node
operator|->
name|nodename
argument_list|)
operator|+
name|strlen
argument_list|(
name|FOOTNOTE_HEADER_FORMAT
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|header
argument_list|,
name|FOOTNOTE_HEADER_FORMAT
argument_list|,
name|node
operator|->
name|nodename
argument_list|)
expr_stmt|;
comment|/* Move the start of the displayed text to right after the first line.        This effectively skips either "---- footno...", or "File: foo...". */
while|while
condition|(
name|text_start
operator|<
name|fn_node
operator|->
name|nodelen
condition|)
if|if
condition|(
name|fn_node
operator|->
name|contents
index|[
name|text_start
operator|++
index|]
operator|==
literal|'\n'
condition|)
break|break;
name|result
operator|->
name|nodelen
operator|=
name|strlen
argument_list|(
name|header
argument_list|)
operator|+
name|fn_node
operator|->
name|nodelen
operator|-
name|text_start
expr_stmt|;
comment|/* Set the contents of this node. */
name|result
operator|->
name|contents
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
literal|1
operator|+
name|result
operator|->
name|nodelen
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|result
operator|->
name|contents
argument_list|,
literal|"%s"
argument_list|,
name|header
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|result
operator|->
name|contents
operator|+
name|strlen
argument_list|(
name|header
argument_list|)
argument_list|,
name|fn_node
operator|->
name|contents
operator|+
name|text_start
argument_list|,
name|fn_node
operator|->
name|nodelen
operator|-
name|text_start
argument_list|)
expr_stmt|;
name|name_internal_node
argument_list|(
name|result
argument_list|,
name|footnote_nodename
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|header
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|NOTDEF
argument_list|)
comment|/* If the footnotes were gleaned from the node that we were called with,      shorten the calling node's display length. */
if|if
condition|(
name|fn_node
operator|==
name|node
condition|)
name|narrow_node
argument_list|(
name|node
argument_list|,
literal|0
argument_list|,
name|fn_start
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NOTDEF */
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Create or delete the footnotes window depending on whether footnotes    exist in WINDOW's node or not.  Returns FN_FOUND if footnotes were found    and displayed.  Returns FN_UNFOUND if there were no footnotes found    in WINDOW's node.  Returns FN_UNABLE if there were footnotes, but the    window to show them couldn't be made. */
end_comment

begin_function
name|int
name|info_get_or_remove_footnotes
parameter_list|(
name|window
parameter_list|)
name|WINDOW
modifier|*
name|window
decl_stmt|;
block|{
name|WINDOW
modifier|*
name|fn_win
decl_stmt|;
name|NODE
modifier|*
name|new_footnotes
decl_stmt|;
name|fn_win
operator|=
name|find_footnotes_window
argument_list|()
expr_stmt|;
comment|/* If we are in the footnotes window, change nothing. */
if|if
condition|(
name|fn_win
operator|==
name|window
condition|)
return|return
operator|(
name|FN_FOUND
operator|)
return|;
comment|/* Try to find footnotes for this window's node. */
name|new_footnotes
operator|=
name|make_footnotes_node
argument_list|(
name|window
operator|->
name|node
argument_list|)
expr_stmt|;
comment|/* If there was a window showing footnotes, and there are no footnotes      for the current window, delete the old footnote window. */
if|if
condition|(
name|fn_win
operator|&&
operator|!
name|new_footnotes
condition|)
block|{
if|if
condition|(
name|windows
operator|->
name|next
condition|)
name|info_delete_window_internal
argument_list|(
name|fn_win
argument_list|)
expr_stmt|;
block|}
comment|/* If there are footnotes for this window's node, but no window around      showing footnotes, try to make a new window. */
if|if
condition|(
name|new_footnotes
operator|&&
operator|!
name|fn_win
condition|)
block|{
name|WINDOW
modifier|*
name|old_active
decl_stmt|;
name|WINDOW
modifier|*
name|last
decl_stmt|,
modifier|*
name|win
decl_stmt|;
comment|/* Always make this window be the last one appearing in the list.  Find          the last window in the chain. */
for|for
control|(
name|win
operator|=
name|windows
operator|,
name|last
operator|=
name|windows
init|;
name|win
condition|;
name|last
operator|=
name|win
operator|,
name|win
operator|=
name|win
operator|->
name|next
control|)
empty_stmt|;
comment|/* Try to split this window, and make the split window the one to          contain the footnotes. */
name|old_active
operator|=
name|active_window
expr_stmt|;
name|active_window
operator|=
name|last
expr_stmt|;
name|fn_win
operator|=
name|window_make_window
argument_list|(
name|new_footnotes
argument_list|)
expr_stmt|;
name|active_window
operator|=
name|old_active
expr_stmt|;
if|if
condition|(
operator|!
name|fn_win
condition|)
block|{
name|free
argument_list|(
name|new_footnotes
operator|->
name|contents
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|new_footnotes
argument_list|)
expr_stmt|;
comment|/* If we are hacking automatic footnotes, and there are footnotes              but we couldn't display them, print a message to that effect. */
if|if
condition|(
name|auto_footnotes_p
condition|)
name|inform_in_echo_area
argument_list|(
name|_
argument_list|(
literal|"Footnotes could not be displayed"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|FN_UNABLE
operator|)
return|;
block|}
block|}
comment|/* If there are footnotes, and there is a window to display them,      make that window be the number of lines appearing in the footnotes. */
if|if
condition|(
name|new_footnotes
operator|&&
name|fn_win
condition|)
block|{
name|window_set_node_of_window
argument_list|(
name|fn_win
argument_list|,
name|new_footnotes
argument_list|)
expr_stmt|;
name|window_change_window_height
argument_list|(
name|fn_win
argument_list|,
name|fn_win
operator|->
name|line_count
operator|-
name|fn_win
operator|->
name|height
argument_list|)
expr_stmt|;
name|remember_window_and_node
argument_list|(
name|fn_win
argument_list|,
name|new_footnotes
argument_list|)
expr_stmt|;
name|add_gcable_pointer
argument_list|(
name|new_footnotes
operator|->
name|contents
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|new_footnotes
condition|)
return|return
operator|(
name|FN_UNFOUND
operator|)
return|;
else|else
return|return
operator|(
name|FN_FOUND
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Show the footnotes associated with this node in another window. */
end_comment

begin_macro
name|DECLARE_INFO_COMMAND
argument_list|(
argument|info_show_footnotes
argument_list|,
argument|_(
literal|"Show the footnotes associated with this node in another window"
argument|)
argument_list|)
end_macro

begin_block
block|{
comment|/* A negative argument means just make the window go away. */
if|if
condition|(
name|count
operator|<
literal|0
condition|)
block|{
name|WINDOW
modifier|*
name|fn_win
init|=
name|find_footnotes_window
argument_list|()
decl_stmt|;
comment|/* If there is an old footnotes window, and it isn't the only window          on the screen, delete it. */
if|if
condition|(
name|fn_win
operator|&&
name|windows
operator|->
name|next
condition|)
name|info_delete_window_internal
argument_list|(
name|fn_win
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|result
decl_stmt|;
name|result
operator|=
name|info_get_or_remove_footnotes
argument_list|(
name|window
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|FN_UNFOUND
case|:
name|info_error
argument_list|(
name|msg_no_foot_node
argument_list|)
expr_stmt|;
break|break;
case|case
name|FN_UNABLE
case|:
name|info_error
argument_list|(
name|msg_win_too_small
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

end_unit


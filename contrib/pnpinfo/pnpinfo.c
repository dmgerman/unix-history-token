begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1996, Sujal M. Patel  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_include
include|#
directive|include
file|<isa/pnpreg.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DEB
parameter_list|(
name|x
parameter_list|)
value|x
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DEB
parameter_list|(
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|DDB
parameter_list|(
name|x
parameter_list|)
value|x
end_define

begin_function
name|void
name|pnp_write
parameter_list|(
name|int
name|d
parameter_list|,
name|u_char
name|r
parameter_list|)
block|{
name|outb
argument_list|(
name|_PNP_ADDRESS
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|_PNP_WRITE_DATA
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* The READ_DATA port that we are using currently */
end_comment

begin_decl_stmt
specifier|static
name|int
name|rd_port
decl_stmt|;
end_decl_stmt

begin_function
name|u_char
name|pnp_read
parameter_list|(
name|int
name|d
parameter_list|)
block|{
name|outb
argument_list|(
name|_PNP_ADDRESS
argument_list|,
name|d
argument_list|)
expr_stmt|;
return|return
name|inb
argument_list|(
operator|(
name|rd_port
operator|<<
literal|2
operator|)
operator|+
literal|3
argument_list|)
operator|&
literal|0xff
return|;
block|}
end_function

begin_function
name|u_short
name|pnp_readw
parameter_list|(
name|int
name|d
parameter_list|)
block|{
name|int
name|c
init|=
name|pnp_read
argument_list|(
name|d
argument_list|)
operator|<<
literal|8
decl_stmt|;
name|c
operator||=
name|pnp_read
argument_list|(
name|d
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
name|c
return|;
block|}
end_function

begin_decl_stmt
name|int
name|logdevs
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|DELAY
name|__P
argument_list|(
operator|(
name|int
name|i
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|send_Initiation_LFSR
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|get_serial
name|__P
argument_list|(
operator|(
name|u_char
operator|*
name|data
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|get_resource_info
name|__P
argument_list|(
operator|(
name|u_char
operator|*
name|buffer
operator|,
name|int
name|len
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|handle_small_res
name|__P
argument_list|(
operator|(
name|u_char
operator|*
name|resinfo
operator|,
name|int
name|item
operator|,
name|int
name|len
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|handle_large_res
name|__P
argument_list|(
operator|(
name|u_char
operator|*
name|resinfo
operator|,
name|int
name|item
operator|,
name|int
name|len
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|dump_resdata
name|__P
argument_list|(
operator|(
name|u_char
operator|*
name|data
operator|,
name|int
name|csn
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|isolation_protocol
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  * DELAY does accurate delaying in user-space.  * This function busy-waits.  */
end_comment

begin_function
name|void
name|DELAY
parameter_list|(
name|int
name|i
parameter_list|)
block|{
name|struct
name|timeval
name|t
decl_stmt|;
name|long
name|start
decl_stmt|,
name|stop
decl_stmt|;
name|i
operator|*=
literal|4
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|t
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|start
operator|=
name|t
operator|.
name|tv_sec
operator|*
literal|1000000
operator|+
name|t
operator|.
name|tv_usec
expr_stmt|;
do|do
block|{
name|gettimeofday
argument_list|(
operator|&
name|t
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|stop
operator|=
name|t
operator|.
name|tv_sec
operator|*
literal|1000000
operator|+
name|t
operator|.
name|tv_usec
expr_stmt|;
block|}
do|while
condition|(
name|start
operator|+
name|i
operator|>
name|stop
condition|)
do|;
block|}
end_function

begin_comment
comment|/*  * Send Initiation LFSR as described in "Plug and Play ISA Specification,  * Intel May 94."  */
end_comment

begin_function
name|void
name|send_Initiation_LFSR
parameter_list|()
block|{
name|int
name|cur
decl_stmt|,
name|i
decl_stmt|;
name|pnp_write
argument_list|(
name|PNP_CONFIG_CONTROL
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
comment|/* Reset the LSFR */
name|outb
argument_list|(
name|_PNP_ADDRESS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|_PNP_ADDRESS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* yes, we do need it twice! */
name|cur
operator|=
literal|0x6a
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|outb
argument_list|(
name|_PNP_ADDRESS
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|cur
operator|=
operator|(
name|cur
operator|>>
literal|1
operator|)
operator||
operator|(
operator|(
operator|(
name|cur
operator|^
operator|(
name|cur
operator|>>
literal|1
operator|)
operator|)
operator|<<
literal|7
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Get the device's serial number.  Returns 1 if the serial is valid.  */
end_comment

begin_function
name|int
name|get_serial
parameter_list|(
name|u_char
modifier|*
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|bit
decl_stmt|,
name|valid
init|=
literal|0
decl_stmt|,
name|sum
init|=
literal|0x6a
decl_stmt|;
name|bzero
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
operator|*
literal|9
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|72
condition|;
name|i
operator|++
control|)
block|{
name|bit
operator|=
name|inb
argument_list|(
operator|(
name|rd_port
operator|<<
literal|2
operator|)
operator||
literal|0x3
argument_list|)
operator|==
literal|0x55
expr_stmt|;
name|DELAY
argument_list|(
literal|250
argument_list|)
expr_stmt|;
comment|/* Delay 250 usec */
comment|/* Can't Short Circuit the next evaluation, so 'and' is last */
name|bit
operator|=
operator|(
name|inb
argument_list|(
operator|(
name|rd_port
operator|<<
literal|2
operator|)
operator||
literal|0x3
argument_list|)
operator|==
literal|0xaa
operator|)
operator|&&
name|bit
expr_stmt|;
name|DELAY
argument_list|(
literal|250
argument_list|)
expr_stmt|;
comment|/* Delay 250 usec */
name|valid
operator|=
name|valid
operator|||
name|bit
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|64
condition|)
name|sum
operator|=
operator|(
name|sum
operator|>>
literal|1
operator|)
operator||
operator|(
operator|(
operator|(
name|sum
operator|^
operator|(
name|sum
operator|>>
literal|1
operator|)
operator|^
name|bit
operator|)
operator|<<
literal|7
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|data
index|[
name|i
operator|/
literal|8
index|]
operator|=
operator|(
name|data
index|[
name|i
operator|/
literal|8
index|]
operator|>>
literal|1
operator|)
operator||
operator|(
name|bit
condition|?
literal|0x80
else|:
literal|0
operator|)
expr_stmt|;
block|}
name|valid
operator|=
name|valid
operator|&&
operator|(
name|data
index|[
literal|8
index|]
operator|==
name|sum
operator|)
expr_stmt|;
return|return
name|valid
return|;
block|}
end_function

begin_comment
comment|/*  * Fill's the buffer with resource info from the device.  * Returns 0 if the device fails to report  */
end_comment

begin_function
name|int
name|get_resource_info
parameter_list|(
name|u_char
modifier|*
name|buffer
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|outb
argument_list|(
name|_PNP_ADDRESS
argument_list|,
name|PNP_STATUS
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|100
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|inb
argument_list|(
operator|(
name|rd_port
operator|<<
literal|2
operator|)
operator||
literal|0x3
argument_list|)
operator|)
operator|&
literal|0x1
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|j
operator|==
literal|100
condition|)
block|{
name|printf
argument_list|(
literal|"PnP device failed to report resource data\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|outb
argument_list|(
name|_PNP_ADDRESS
argument_list|,
name|PNP_RESOURCE_DATA
argument_list|)
expr_stmt|;
name|buffer
index|[
name|i
index|]
operator|=
name|inb
argument_list|(
operator|(
name|rd_port
operator|<<
literal|2
operator|)
operator||
literal|0x3
argument_list|)
expr_stmt|;
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"--- get_resource_info: got 0x%02x\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|buffer
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|report_dma_info
parameter_list|(
name|x
parameter_list|)
name|int
name|x
decl_stmt|;
block|{
name|char
modifier|*
name|s1
init|=
name|NULL
decl_stmt|,
modifier|*
name|s2
init|=
name|NULL
decl_stmt|,
modifier|*
name|s3
init|=
name|NULL
decl_stmt|,
modifier|*
name|s4
init|=
name|NULL
decl_stmt|,
modifier|*
name|s5
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|x
operator|&
literal|0x3
condition|)
block|{
case|case
literal|0
case|:
name|s1
operator|=
literal|"8-bit"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|s1
operator|=
literal|"8/16-bit"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|s1
operator|=
literal|"16-bit"
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|DIAGNOSTIC
case|case
literal|3
case|:
name|s1
operator|=
literal|"Reserved"
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
name|s2
operator|=
operator|(
name|x
operator|&
literal|0x4
operator|)
condition|?
literal|"bus master"
else|:
literal|"not a bus master"
expr_stmt|;
name|s3
operator|=
operator|(
name|x
operator|&
literal|0x8
operator|)
condition|?
literal|"count by byte"
else|:
literal|""
expr_stmt|;
name|s4
operator|=
operator|(
name|x
operator|&
literal|0x10
operator|)
condition|?
literal|"count by word"
else|:
literal|""
expr_stmt|;
switch|switch
condition|(
operator|(
name|x
operator|&
literal|0x60
operator|)
operator|>>
literal|5
condition|)
block|{
case|case
literal|0
case|:
name|s5
operator|=
literal|"Compatibility mode"
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|s5
operator|=
literal|"Type A"
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|s5
operator|=
literal|"Type B"
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|s5
operator|=
literal|"Type F"
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\t%s, %s, %s, %s, %s\n"
argument_list|,
name|s1
argument_list|,
name|s2
argument_list|,
name|s3
argument_list|,
name|s4
argument_list|,
name|s5
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|report_memory_info
parameter_list|(
name|int
name|x
parameter_list|)
block|{
if|if
condition|(
name|x
operator|&
literal|0x1
condition|)
name|printf
argument_list|(
literal|"Memory Range: Writeable\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Memory Range: Not writeable (ROM)\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|&
literal|0x2
condition|)
name|printf
argument_list|(
literal|"Memory Range: Read-cacheable, write-through\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Memory Range: Non-cacheable\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|&
literal|0x4
condition|)
name|printf
argument_list|(
literal|"Memory Range: Decode supports high address\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Memory Range: Decode supports range length\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|x
operator|&
literal|0x18
operator|)
operator|>>
literal|3
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"Memory Range: 8-bit memory only\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"Memory Range: 16-bit memory only\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"Memory Range: 8-bit and 16-bit memory supported\n"
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|DIAGNOSTIC
case|case
literal|3
case|:
name|printf
argument_list|(
literal|"Memory Range: Reserved\n"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
if|if
condition|(
name|x
operator|&
literal|0x20
condition|)
name|printf
argument_list|(
literal|"Memory Range: Memory is shadowable\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Memory Range: Memory is not shadowable\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|&
literal|0x40
condition|)
name|printf
argument_list|(
literal|"Memory Range: Memory is an expansion ROM\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Memory Range: Memory is not an expansion ROM\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DIAGNOSTIC
if|if
condition|(
name|x
operator|&
literal|0x80
condition|)
name|printf
argument_list|(
literal|"Memory Range: Reserved (Device is brain-damaged)\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  *  Small Resource Tag Handler  *  *  Returns 1 if checksum was valid (and an END_TAG was received).  *  Returns -1 if checksum was invalid (and an END_TAG was received).  *  Returns 0 for other tags.  */
end_comment

begin_function
name|int
name|handle_small_res
parameter_list|(
name|u_char
modifier|*
name|resinfo
parameter_list|,
name|int
name|item
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"*** ITEM 0x%04x len %d detected\n"
argument_list|,
name|item
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|item
condition|)
block|{
default|default:
name|printf
argument_list|(
literal|"*** ITEM 0x%02x detected\n"
argument_list|,
name|item
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_VERSION
case|:
name|printf
argument_list|(
literal|"PnP Version %d.%d, Vendor Version %d\n"
argument_list|,
name|resinfo
index|[
literal|0
index|]
operator|>>
literal|4
argument_list|,
name|resinfo
index|[
literal|0
index|]
operator|&
operator|(
literal|0xf
operator|)
argument_list|,
name|resinfo
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_LOGICAL_DEVICE
case|:
name|printf
argument_list|(
literal|"\nLogical Device ID: %c%c%c%02x%02x 0x%08x #%d\n"
argument_list|,
operator|(
operator|(
name|resinfo
index|[
literal|0
index|]
operator|&
literal|0x7c
operator|)
operator|>>
literal|2
operator|)
operator|+
literal|64
argument_list|,
operator|(
operator|(
operator|(
name|resinfo
index|[
literal|0
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|resinfo
index|[
literal|1
index|]
operator|&
literal|0xe0
operator|)
operator|>>
literal|5
operator|)
operator|)
operator|+
literal|64
argument_list|,
operator|(
name|resinfo
index|[
literal|1
index|]
operator|&
literal|0x1f
operator|)
operator|+
literal|64
argument_list|,
name|resinfo
index|[
literal|2
index|]
argument_list|,
name|resinfo
index|[
literal|3
index|]
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
operator|(
name|resinfo
operator|)
argument_list|,
name|logdevs
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|resinfo
index|[
literal|4
index|]
operator|&
literal|0x1
condition|)
name|printf
argument_list|(
literal|"\tDevice powers up active\n"
argument_list|)
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|resinfo
index|[
literal|4
index|]
operator|&
literal|0x2
condition|)
name|printf
argument_list|(
literal|"\tDevice supports I/O Range Check\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|resinfo
index|[
literal|4
index|]
operator|>
literal|0x3
condition|)
name|printf
argument_list|(
literal|"\tReserved register funcs %02x\n"
argument_list|,
name|resinfo
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|6
condition|)
name|printf
argument_list|(
literal|"\tVendor register funcs %02x\n"
argument_list|,
name|resinfo
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_COMPAT_DEVICE
case|:
name|printf
argument_list|(
literal|"Compatible Device ID: %c%c%c%02x%02x (%08x)\n"
argument_list|,
operator|(
operator|(
name|resinfo
index|[
literal|0
index|]
operator|&
literal|0x7c
operator|)
operator|>>
literal|2
operator|)
operator|+
literal|64
argument_list|,
operator|(
operator|(
operator|(
name|resinfo
index|[
literal|0
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|resinfo
index|[
literal|1
index|]
operator|&
literal|0xe0
operator|)
operator|>>
literal|5
operator|)
operator|)
operator|+
literal|64
argument_list|,
operator|(
name|resinfo
index|[
literal|1
index|]
operator|&
literal|0x1f
operator|)
operator|+
literal|64
argument_list|,
name|resinfo
index|[
literal|2
index|]
argument_list|,
name|resinfo
index|[
literal|3
index|]
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|resinfo
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_IRQ_FORMAT
case|:
name|printf
argument_list|(
literal|"    IRQ: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|resinfo
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|resinfo
index|[
literal|1
index|]
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|i
operator|+
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|resinfo
index|[
literal|2
index|]
operator|&
literal|0x1
condition|)
name|printf
argument_list|(
literal|"IRQ: High true edge sensitive\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|resinfo
index|[
literal|2
index|]
operator|&
literal|0x2
condition|)
name|printf
argument_list|(
literal|"IRQ: Low true edge sensitive\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|resinfo
index|[
literal|2
index|]
operator|&
literal|0x4
condition|)
name|printf
argument_list|(
literal|"IRQ: High true level sensitive\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|resinfo
index|[
literal|2
index|]
operator|&
literal|0x8
condition|)
name|printf
argument_list|(
literal|"IRQ: Low true level sensitive\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" - only one type (true/edge)\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PNP_TAG_DMA_FORMAT
case|:
name|printf
argument_list|(
literal|"    DMA: channel(s) "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|resinfo
index|[
literal|0
index|]
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|report_dma_info
argument_list|(
name|resinfo
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_START_DEPENDANT
case|:
name|printf
argument_list|(
literal|"TAG Start DF\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|1
condition|)
block|{
switch|switch
condition|(
name|resinfo
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"Good Configuration\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"Acceptable Configuration\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"Sub-optimal Configuration\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
name|PNP_TAG_END_DEPENDANT
case|:
name|printf
argument_list|(
literal|"TAG End DF\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_IO_RANGE
case|:
name|printf
argument_list|(
literal|"    I/O Range 0x%x .. 0x%x, alignment 0x%x, len 0x%x\n"
argument_list|,
name|resinfo
index|[
literal|1
index|]
operator|+
operator|(
name|resinfo
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
argument_list|,
name|resinfo
index|[
literal|3
index|]
operator|+
operator|(
name|resinfo
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
argument_list|,
name|resinfo
index|[
literal|5
index|]
argument_list|,
name|resinfo
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|resinfo
index|[
literal|0
index|]
condition|)
name|printf
argument_list|(
literal|"\t[16-bit addr]\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t[not 16-bit addr]\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_IO_FIXED
case|:
name|printf
argument_list|(
literal|"    FIXED I/O base address 0x%x length 0x%x\n"
argument_list|,
name|resinfo
index|[
literal|0
index|]
operator|+
operator|(
operator|(
name|resinfo
index|[
literal|1
index|]
operator|&
literal|3
operator|)
operator|<<
literal|8
operator|)
argument_list|,
comment|/* XXX */
name|resinfo
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|DIAGNOSTIC
case|case
name|PNP_TAG_RESERVED
case|:
name|printf
argument_list|(
literal|"Reserved Tag Detected\n"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|PNP_TAG_VENDOR
case|:
name|printf
argument_list|(
literal|"*** Small Vendor Tag Detected\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_END
case|:
name|printf
argument_list|(
literal|"End Tag\n\n"
argument_list|)
expr_stmt|;
comment|/* XXX Record and Verify Checksum */
return|return
literal|1
return|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|handle_large_res
parameter_list|(
name|u_char
modifier|*
name|resinfo
parameter_list|,
name|int
name|item
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"*** Large ITEM %d len %d found\n"
argument_list|,
name|item
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|item
condition|)
block|{
case|case
name|PNP_TAG_MEMORY_RANGE
case|:
name|report_memory_info
argument_list|(
name|resinfo
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Memory range minimum address: 0x%x\n"
argument_list|,
operator|(
name|resinfo
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator|+
operator|(
name|resinfo
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Memory range maximum address: 0x%x\n"
argument_list|,
operator|(
name|resinfo
index|[
literal|3
index|]
operator|<<
literal|8
operator|)
operator|+
operator|(
name|resinfo
index|[
literal|4
index|]
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Memory range base alignment: 0x%x\n"
argument_list|,
operator|(
name|i
operator|=
operator|(
name|resinfo
index|[
literal|5
index|]
operator|+
operator|(
name|resinfo
index|[
literal|6
index|]
operator|<<
literal|8
operator|)
operator|)
operator|)
condition|?
name|i
else|:
operator|(
literal|1
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Memory range length: 0x%x\n"
argument_list|,
operator|(
name|resinfo
index|[
literal|7
index|]
operator|+
operator|(
name|resinfo
index|[
literal|8
index|]
operator|<<
literal|8
operator|)
operator|)
operator|*
literal|256
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_ID_ANSI
case|:
name|printf
argument_list|(
literal|"Device Description: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|resinfo
index|[
name|i
index|]
condition|)
comment|/* XXX */
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|resinfo
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_ID_UNICODE
case|:
name|printf
argument_list|(
literal|"ID String Unicode Detected (Undefined)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_LARGE_VENDOR
case|:
name|printf
argument_list|(
literal|"Large Vendor Defined Detected\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_MEMORY32_RANGE
case|:
name|printf
argument_list|(
literal|"32bit Memory Range Desc Unimplemented\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PNP_TAG_MEMORY32_FIXED
case|:
name|printf
argument_list|(
literal|"32bit Fixed Location Desc Unimplemented\n"
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|DIAGNOSTIC
case|case
name|PNP_TAG_LARGE_RESERVED
case|:
name|printf
argument_list|(
literal|"Large Reserved Tag Detected\n"
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
block|}
end_function

begin_comment
comment|/*  * Dump all the information about configurations.  */
end_comment

begin_function
name|void
name|dump_resdata
parameter_list|(
name|u_char
modifier|*
name|data
parameter_list|,
name|int
name|csn
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|large_len
decl_stmt|;
name|u_char
name|tag
decl_stmt|,
modifier|*
name|resinfo
decl_stmt|;
name|DDB
argument_list|(
name|printf
argument_list|(
literal|"\nCard assigned CSN #%d\n"
argument_list|,
name|csn
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Vendor ID %c%c%c%02x%02x (0x%08x), Serial Number 0x%08x\n"
argument_list|,
operator|(
operator|(
name|data
index|[
literal|0
index|]
operator|&
literal|0x7c
operator|)
operator|>>
literal|2
operator|)
operator|+
literal|64
argument_list|,
operator|(
operator|(
operator|(
name|data
index|[
literal|0
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|data
index|[
literal|1
index|]
operator|&
literal|0xe0
operator|)
operator|>>
literal|5
operator|)
operator|)
operator|+
literal|64
argument_list|,
operator|(
name|data
index|[
literal|1
index|]
operator|&
literal|0x1f
operator|)
operator|+
literal|64
argument_list|,
name|data
index|[
literal|2
index|]
argument_list|,
name|data
index|[
literal|3
index|]
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
operator|&
operator|(
name|data
index|[
literal|0
index|]
operator|)
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
operator|&
operator|(
name|data
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
name|pnp_write
argument_list|(
name|PNP_SET_CSN
argument_list|,
name|csn
argument_list|)
expr_stmt|;
comment|/* Move this out of this function XXX */
name|outb
argument_list|(
name|_PNP_ADDRESS
argument_list|,
name|PNP_STATUS
argument_list|)
expr_stmt|;
comment|/* Allows up to 1kb of Resource Info,  Should be plenty */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1024
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|get_resource_info
argument_list|(
operator|&
name|tag
argument_list|,
literal|1
argument_list|)
condition|)
break|break;
if|if
condition|(
name|PNP_RES_TYPE
argument_list|(
name|tag
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Handle small resouce data types */
name|resinfo
operator|=
name|malloc
argument_list|(
name|PNP_SRES_LEN
argument_list|(
name|tag
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|get_resource_info
argument_list|(
name|resinfo
argument_list|,
name|PNP_SRES_LEN
argument_list|(
name|tag
argument_list|)
argument_list|)
condition|)
break|break;
if|if
condition|(
name|handle_small_res
argument_list|(
name|resinfo
argument_list|,
name|PNP_SRES_NUM
argument_list|(
name|tag
argument_list|)
argument_list|,
name|PNP_SRES_LEN
argument_list|(
name|tag
argument_list|)
argument_list|)
operator|==
literal|1
condition|)
break|break;
name|free
argument_list|(
name|resinfo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Handle large resouce data types */
name|u_char
name|buf
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|get_resource_info
argument_list|(
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
literal|2
argument_list|)
condition|)
break|break;
name|large_len
operator|=
operator|(
name|buf
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator|+
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|resinfo
operator|=
name|malloc
argument_list|(
name|large_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|get_resource_info
argument_list|(
name|resinfo
argument_list|,
name|large_len
argument_list|)
condition|)
break|break;
name|handle_large_res
argument_list|(
name|resinfo
argument_list|,
name|PNP_LRES_NUM
argument_list|(
name|tag
argument_list|)
argument_list|,
name|large_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|resinfo
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"Successfully got %d resources, %d logical fdevs\n"
argument_list|,
name|i
argument_list|,
name|logdevs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-- card select # 0x%04x\n"
argument_list|,
name|pnp_read
argument_list|(
name|PNP_SET_CSN
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nCSN %c%c%c%02x%02x (0x%08x), Serial Number 0x%08x\n"
argument_list|,
operator|(
operator|(
name|data
index|[
literal|0
index|]
operator|&
literal|0x7c
operator|)
operator|>>
literal|2
operator|)
operator|+
literal|64
argument_list|,
operator|(
operator|(
operator|(
name|data
index|[
literal|0
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|data
index|[
literal|1
index|]
operator|&
literal|0xe0
operator|)
operator|>>
literal|5
operator|)
operator|)
operator|+
literal|64
argument_list|,
operator|(
name|data
index|[
literal|1
index|]
operator|&
literal|0x1f
operator|)
operator|+
literal|64
argument_list|,
name|data
index|[
literal|2
index|]
argument_list|,
name|data
index|[
literal|3
index|]
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
operator|&
operator|(
name|data
index|[
literal|0
index|]
operator|)
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
operator|&
operator|(
name|data
index|[
literal|4
index|]
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|logdevs
condition|;
name|i
operator|++
control|)
block|{
name|int
name|j
decl_stmt|;
name|pnp_write
argument_list|(
name|PNP_SET_LDN
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nLogical device #%d\n"
argument_list|,
name|pnp_read
argument_list|(
name|PNP_SET_LDN
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"IO: "
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
name|printf
argument_list|(
literal|" 0x%02x%02x"
argument_list|,
name|pnp_read
argument_list|(
name|PNP_IO_BASE_HIGH
argument_list|(
name|i
argument_list|)
argument_list|)
argument_list|,
name|pnp_read
argument_list|(
name|PNP_IO_BASE_LOW
argument_list|(
name|i
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nIRQ %d %d\n"
argument_list|,
name|pnp_read
argument_list|(
name|PNP_IRQ_LEVEL
argument_list|(
literal|0
argument_list|)
argument_list|)
argument_list|,
name|pnp_read
argument_list|(
name|PNP_IRQ_LEVEL
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DMA %d %d\n"
argument_list|,
name|pnp_read
argument_list|(
name|PNP_DMA_CHANNEL
argument_list|(
literal|0
argument_list|)
argument_list|)
argument_list|,
name|pnp_read
argument_list|(
name|PNP_DMA_CHANNEL
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"IO range check 0x%02x activate 0x%02x\n"
argument_list|,
name|pnp_read
argument_list|(
name|PNP_IO_RANGE_CHECK
argument_list|)
argument_list|,
name|pnp_read
argument_list|(
name|PNP_ACTIVATE
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Run the isolation protocol. Use rd_port as the READ_DATA port  * value (caller should try multiple READ_DATA locations before giving  * up). Upon exiting, all cards are aware that they should use rd_port  * as the READ_DATA port;  *  */
end_comment

begin_function
name|int
name|isolation_protocol
parameter_list|()
block|{
name|int
name|csn
decl_stmt|;
name|u_char
name|data
index|[
literal|9
index|]
decl_stmt|;
name|send_Initiation_LFSR
argument_list|()
expr_stmt|;
comment|/* Reset CSN for All Cards */
name|pnp_write
argument_list|(
name|PNP_CONFIG_CONTROL
argument_list|,
literal|0x04
argument_list|)
expr_stmt|;
for|for
control|(
name|csn
operator|=
literal|1
init|;
operator|(
name|csn
operator|<
name|PNP_MAX_CARDS
operator|)
condition|;
name|csn
operator|++
control|)
block|{
comment|/* Wake up cards without a CSN */
name|logdevs
operator|=
literal|0
expr_stmt|;
name|pnp_write
argument_list|(
name|PNP_WAKE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pnp_write
argument_list|(
name|PNP_SET_RD_DATA
argument_list|,
name|rd_port
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|_PNP_ADDRESS
argument_list|,
name|PNP_SERIAL_ISOLATION
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* Delay 1 msec */
if|if
condition|(
name|get_serial
argument_list|(
name|data
argument_list|)
condition|)
name|dump_resdata
argument_list|(
name|data
argument_list|,
name|csn
argument_list|)
expr_stmt|;
else|else
break|break;
block|}
return|return
name|csn
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|num_pnp_devs
decl_stmt|;
ifdef|#
directive|ifdef
name|__i386__
comment|/* Hey what about a i386_iopl() call :) */
if|if
condition|(
name|open
argument_list|(
literal|"/dev/io"
argument_list|,
name|O_RDONLY
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"pnpinfo: Can't get I/O privilege.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|__alpha__
name|ioperm
argument_list|(
literal|0x203
argument_list|,
literal|0x400
operator|-
literal|0x203
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"Checking for Plug-n-Play devices...\n"
argument_list|)
expr_stmt|;
comment|/* Try various READ_DATA ports from 0x203-0x3ff */
for|for
control|(
name|rd_port
operator|=
literal|0x80
init|;
operator|(
name|rd_port
operator|<
literal|0xff
operator|)
condition|;
name|rd_port
operator|+=
literal|0x10
control|)
block|{
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"Trying Read_Port at %x...\n"
argument_list|,
operator|(
name|rd_port
operator|<<
literal|2
operator|)
operator||
literal|0x3
argument_list|)
argument_list|)
expr_stmt|;
name|num_pnp_devs
operator|=
name|isolation_protocol
argument_list|(
name|rd_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_pnp_devs
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|num_pnp_devs
condition|)
block|{
name|printf
argument_list|(
literal|"No Plug-n-Play devices were found\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

end_unit


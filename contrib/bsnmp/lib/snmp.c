begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2001-2003  *	Fraunhofer Institute for Open Communication Systems (FhG Fokus).  *	All rights reserved.  *  * Author: Harti Brandt<harti@freebsd.org>  *   * Copyright (c) 2010 The FreeBSD Foundation  * All rights reserved.  *  * Portions of this software were developed by Shteryana Sotirova Shopova  * under sponsorship from the FreeBSD Foundation.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *   * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Begemot: bsnmp/lib/snmp.c,v 1.40 2005/10/04 14:32:42 brandt_h Exp $  *  * SNMP  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_STDINT_H
end_ifdef

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|HAVE_INTTYPES_H
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"asn1.h"
end_include

begin_include
include|#
directive|include
file|"snmp.h"
end_include

begin_include
include|#
directive|include
file|"snmppriv.h"
end_include

begin_function_decl
specifier|static
name|void
name|snmp_error_func
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|snmp_printf_func
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
function_decl|(
modifier|*
name|snmp_error
function_decl|)
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
init|=
name|snmp_error_func
function_decl|;
end_function_decl

begin_function_decl
name|void
function_decl|(
modifier|*
name|snmp_printf
function_decl|)
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
init|=
name|snmp_printf_func
function_decl|;
end_function_decl

begin_comment
comment|/*  * Get the next variable binding from the list.  * ASN errors on the sequence or the OID are always fatal.  */
end_comment

begin_function
specifier|static
name|enum
name|asn_err
name|get_var_binding
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|binding
parameter_list|)
block|{
name|u_char
name|type
decl_stmt|;
name|asn_len_t
name|len
decl_stmt|,
name|trailer
decl_stmt|;
name|enum
name|asn_err
name|err
decl_stmt|;
if|if
condition|(
name|asn_get_sequence
argument_list|(
name|b
argument_list|,
operator|&
name|len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse varbind header"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
comment|/* temporary truncate the length so that the parser does not 	 * eat up bytes behind the sequence in the case the encoding is 	 * wrong of inner elements. */
name|trailer
operator|=
name|b
operator|->
name|asn_len
operator|-
name|len
expr_stmt|;
name|b
operator|->
name|asn_len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|asn_get_objid
argument_list|(
name|b
argument_list|,
operator|&
name|binding
operator|->
name|var
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse binding objid"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_header
argument_list|(
name|b
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse binding value header"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ASN_TYPE_NULL
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_NULL
expr_stmt|;
name|err
operator|=
name|asn_get_null_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_TYPE_INTEGER
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_INTEGER
expr_stmt|;
name|err
operator|=
name|asn_get_integer_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|,
operator|&
name|binding
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_TYPE_OCTETSTRING
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_OCTETSTRING
expr_stmt|;
name|binding
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|binding
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
operator|==
name|NULL
condition|)
block|{
name|snmp_error
argument_list|(
literal|"%s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
name|binding
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|err
operator|=
name|asn_get_octetstring_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|,
name|binding
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
operator|&
name|binding
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASN_ERR_STOPPED
argument_list|(
name|err
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|binding
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|)
expr_stmt|;
name|binding
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
case|case
name|ASN_TYPE_OBJID
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_OID
expr_stmt|;
name|err
operator|=
name|asn_get_objid_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|,
operator|&
name|binding
operator|->
name|v
operator|.
name|oid
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_CLASS_APPLICATION
operator||
name|ASN_APP_IPADDRESS
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_IPADDRESS
expr_stmt|;
name|err
operator|=
name|asn_get_ipaddress_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|,
name|binding
operator|->
name|v
operator|.
name|ipaddress
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_CLASS_APPLICATION
operator||
name|ASN_APP_TIMETICKS
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_TIMETICKS
expr_stmt|;
name|err
operator|=
name|asn_get_uint32_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|,
operator|&
name|binding
operator|->
name|v
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_CLASS_APPLICATION
operator||
name|ASN_APP_COUNTER
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_COUNTER
expr_stmt|;
name|err
operator|=
name|asn_get_uint32_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|,
operator|&
name|binding
operator|->
name|v
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_CLASS_APPLICATION
operator||
name|ASN_APP_GAUGE
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_GAUGE
expr_stmt|;
name|err
operator|=
name|asn_get_uint32_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|,
operator|&
name|binding
operator|->
name|v
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_CLASS_APPLICATION
operator||
name|ASN_APP_COUNTER64
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_COUNTER64
expr_stmt|;
name|err
operator|=
name|asn_get_counter64_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|,
operator|&
name|binding
operator|->
name|v
operator|.
name|counter64
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_CLASS_CONTEXT
operator||
name|ASN_EXCEPT_NOSUCHOBJECT
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_NOSUCHOBJECT
expr_stmt|;
name|err
operator|=
name|asn_get_null_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_CLASS_CONTEXT
operator||
name|ASN_EXCEPT_NOSUCHINSTANCE
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_NOSUCHINSTANCE
expr_stmt|;
name|err
operator|=
name|asn_get_null_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN_CLASS_CONTEXT
operator||
name|ASN_EXCEPT_ENDOFMIBVIEW
case|:
name|binding
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_ENDOFMIBVIEW
expr_stmt|;
name|err
operator|=
name|asn_get_null_raw
argument_list|(
name|b
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|(
name|err
operator|=
name|asn_skip
argument_list|(
name|b
argument_list|,
name|len
argument_list|)
operator|)
operator|==
name|ASN_ERR_OK
condition|)
name|err
operator|=
name|ASN_ERR_TAG
expr_stmt|;
name|snmp_error
argument_list|(
literal|"bad binding value type 0x%x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ASN_ERR_STOPPED
argument_list|(
name|err
argument_list|)
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse binding value"
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
if|if
condition|(
name|b
operator|->
name|asn_len
operator|!=
literal|0
condition|)
name|snmp_error
argument_list|(
literal|"ignoring junk at end of binding"
argument_list|)
expr_stmt|;
name|b
operator|->
name|asn_len
operator|=
name|trailer
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Parse the different PDUs contents. Any ASN error in the outer components  * are fatal. Only errors in variable values may be tolerated. If all  * components can be parsed it returns either ASN_ERR_OK or the first  * error that was found.  */
end_comment

begin_function
name|enum
name|asn_err
name|snmp_parse_pdus_hdr
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|asn_len_t
modifier|*
name|lenp
parameter_list|)
block|{
if|if
condition|(
name|pdu
operator|->
name|type
operator|==
name|SNMP_PDU_TRAP
condition|)
block|{
if|if
condition|(
name|asn_get_objid
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|enterprise
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse trap enterprise"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_ipaddress
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|agent_addr
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse trap agent address"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_integer
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|generic_trap
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse 'generic-trap'"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_integer
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|specific_trap
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse 'specific-trap'"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_timeticks
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|time_stamp
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse trap 'time-stamp'"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|asn_get_integer
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|request_id
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse 'request-id'"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_integer
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|error_status
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse 'error_status'"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_integer
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|error_index
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse 'error_index'"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
block|}
if|if
condition|(
name|asn_get_sequence
argument_list|(
name|b
argument_list|,
name|lenp
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot get varlist header"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
return|return
operator|(
name|ASN_ERR_OK
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|asn_err
name|parse_pdus
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|int32_t
modifier|*
name|ip
parameter_list|)
block|{
name|asn_len_t
name|len
decl_stmt|,
name|trailer
decl_stmt|;
name|struct
name|snmp_value
modifier|*
name|v
decl_stmt|;
name|enum
name|asn_err
name|err
decl_stmt|,
name|err1
decl_stmt|;
name|err
operator|=
name|snmp_parse_pdus_hdr
argument_list|(
name|b
argument_list|,
name|pdu
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASN_ERR_STOPPED
argument_list|(
name|err
argument_list|)
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|trailer
operator|=
name|b
operator|->
name|asn_len
operator|-
name|len
expr_stmt|;
name|v
operator|=
name|pdu
operator|->
name|bindings
expr_stmt|;
name|err
operator|=
name|ASN_ERR_OK
expr_stmt|;
while|while
condition|(
name|b
operator|->
name|asn_len
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|pdu
operator|->
name|nbindings
operator|==
name|SNMP_MAX_BINDINGS
condition|)
block|{
name|snmp_error
argument_list|(
literal|"too many bindings (> %u) in PDU"
argument_list|,
name|SNMP_MAX_BINDINGS
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
name|err1
operator|=
name|get_var_binding
argument_list|(
name|b
argument_list|,
name|v
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASN_ERR_STOPPED
argument_list|(
name|err1
argument_list|)
condition|)
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
if|if
condition|(
name|err1
operator|!=
name|ASN_ERR_OK
operator|&&
name|err
operator|==
name|ASN_ERR_OK
condition|)
block|{
name|err
operator|=
name|err1
expr_stmt|;
operator|*
name|ip
operator|=
name|pdu
operator|->
name|nbindings
operator|+
literal|1
expr_stmt|;
block|}
name|pdu
operator|->
name|nbindings
operator|++
expr_stmt|;
name|v
operator|++
expr_stmt|;
block|}
name|b
operator|->
name|asn_len
operator|=
name|trailer
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|asn_err
name|parse_secparams
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|asn_len_t
name|octs_len
decl_stmt|;
name|u_char
name|buf
index|[
literal|256
index|]
decl_stmt|;
comment|/* XXX: calc max possible size here */
name|struct
name|asn_buf
name|tb
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|tb
operator|.
name|asn_ptr
operator|=
name|buf
expr_stmt|;
name|tb
operator|.
name|asn_len
operator|=
literal|256
expr_stmt|;
name|u_int
name|len
decl_stmt|;
if|if
condition|(
name|asn_get_octetstring
argument_list|(
name|b
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot parse usm header"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
name|tb
operator|.
name|asn_len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|asn_get_sequence
argument_list|(
operator|&
name|tb
argument_list|,
operator|&
name|octs_len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode usm header"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
name|octs_len
operator|=
name|SNMP_ENGINE_ID_SIZ
expr_stmt|;
if|if
condition|(
name|asn_get_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|pdu
operator|->
name|engine
operator|.
name|engine_id
argument_list|,
operator|&
name|octs_len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg engine id"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
name|pdu
operator|->
name|engine
operator|.
name|engine_len
operator|=
name|octs_len
expr_stmt|;
if|if
condition|(
name|asn_get_integer
argument_list|(
operator|&
name|tb
argument_list|,
operator|&
name|pdu
operator|->
name|engine
operator|.
name|engine_boots
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg engine boots"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_integer
argument_list|(
operator|&
name|tb
argument_list|,
operator|&
name|pdu
operator|->
name|engine
operator|.
name|engine_time
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg engine time"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
name|octs_len
operator|=
name|SNMP_ADM_STR32_SIZ
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|asn_get_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|pdu
operator|->
name|user
operator|.
name|sec_name
argument_list|,
operator|&
name|octs_len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg user name"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
name|pdu
operator|->
name|user
operator|.
name|sec_name
index|[
name|octs_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|octs_len
operator|=
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|msg_digest
argument_list|)
expr_stmt|;
if|if
condition|(
name|asn_get_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|pdu
operator|->
name|msg_digest
argument_list|,
operator|&
name|octs_len
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
operator|(
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_AUTH_FLAG
operator|)
operator|!=
literal|0
operator|&&
name|octs_len
operator|!=
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|msg_digest
argument_list|)
operator|)
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg authentication param"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
name|octs_len
operator|=
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|msg_salt
argument_list|)
expr_stmt|;
if|if
condition|(
name|asn_get_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|pdu
operator|->
name|msg_salt
argument_list|,
operator|&
name|octs_len
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
operator|(
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_PRIV_FLAG
operator|)
operator|!=
literal|0
operator|&&
name|octs_len
operator|!=
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|msg_salt
argument_list|)
operator|)
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg authentication param"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_AUTH_FLAG
operator|)
operator|!=
literal|0
condition|)
block|{
name|pdu
operator|->
name|digest_ptr
operator|=
name|b
operator|->
name|asn_ptr
operator|-
name|SNMP_USM_AUTH_SIZE
expr_stmt|;
name|pdu
operator|->
name|digest_ptr
operator|-=
name|octs_len
operator|+
name|ASN_MAXLENLEN
expr_stmt|;
block|}
return|return
operator|(
name|ASN_ERR_OK
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|snmp_code
name|pdu_encode_secparams
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|u_char
name|buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|sptr
decl_stmt|;
name|struct
name|asn_buf
name|tb
decl_stmt|;
name|size_t
name|auth_off
decl_stmt|,
name|moved
init|=
literal|0
decl_stmt|;
name|auth_off
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|tb
operator|.
name|asn_ptr
operator|=
name|buf
expr_stmt|;
name|tb
operator|.
name|asn_len
operator|=
literal|256
expr_stmt|;
if|if
condition|(
name|asn_put_temp_header
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|ASN_TYPE_SEQUENCE
operator||
name|ASN_TYPE_CONSTRUCTED
operator|)
argument_list|,
operator|&
name|sptr
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|engine
operator|.
name|engine_id
argument_list|,
name|pdu
operator|->
name|engine
operator|.
name|engine_len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_integer
argument_list|(
operator|&
name|tb
argument_list|,
name|pdu
operator|->
name|engine
operator|.
name|engine_boots
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_integer
argument_list|(
operator|&
name|tb
argument_list|,
name|pdu
operator|->
name|engine
operator|.
name|engine_time
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|user
operator|.
name|sec_name
argument_list|,
name|strlen
argument_list|(
name|pdu
operator|->
name|user
operator|.
name|sec_name
argument_list|)
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_AUTH_FLAG
operator|)
operator|!=
literal|0
condition|)
block|{
name|auth_off
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|tb
operator|.
name|asn_len
operator|+
name|ASN_MAXLENLEN
expr_stmt|;
if|if
condition|(
name|asn_put_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|msg_digest
argument_list|,
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|msg_digest
argument_list|)
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|asn_put_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|msg_digest
argument_list|,
literal|0
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_PRIV_FLAG
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|asn_put_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|msg_salt
argument_list|,
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|msg_salt
argument_list|)
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|asn_put_octetstring
argument_list|(
operator|&
name|tb
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|msg_salt
argument_list|,
literal|0
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_commit_header
argument_list|(
operator|&
name|tb
argument_list|,
name|sptr
argument_list|,
operator|&
name|moved
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_AUTH_FLAG
operator|)
operator|!=
literal|0
condition|)
name|pdu
operator|->
name|digest_ptr
operator|=
name|b
operator|->
name|asn_ptr
operator|+
name|auth_off
operator|-
name|moved
expr_stmt|;
if|if
condition|(
name|asn_put_octetstring
argument_list|(
name|b
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|tb
operator|.
name|asn_len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
name|pdu
operator|->
name|digest_ptr
operator|+=
name|ASN_MAXLENLEN
expr_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_PRIV_FLAG
operator|)
operator|!=
literal|0
operator|&&
name|asn_put_temp_header
argument_list|(
name|b
argument_list|,
name|ASN_TYPE_OCTETSTRING
argument_list|,
operator|&
name|pdu
operator|->
name|encrypted_ptr
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
return|return
operator|(
name|SNMP_CODE_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Decode the PDU except for the variable bindings itself.  * If decoding fails because of a bad binding, but the rest can be  * decoded, ip points to the index of the failed variable (errors  * OORANGE, BADLEN or BADVERS).  */
end_comment

begin_function
name|enum
name|snmp_code
name|snmp_pdu_decode
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|int32_t
modifier|*
name|ip
parameter_list|)
block|{
name|enum
name|snmp_code
name|code
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|snmp_pdu_decode_header
argument_list|(
name|b
argument_list|,
name|pdu
argument_list|)
operator|)
operator|!=
name|SNMP_CODE_OK
condition|)
return|return
operator|(
name|code
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V3
condition|)
block|{
if|if
condition|(
name|pdu
operator|->
name|security_model
operator|!=
name|SNMP_SECMODEL_USM
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
operator|(
name|code
operator|=
name|snmp_pdu_decode_secmode
argument_list|(
name|b
argument_list|,
name|pdu
argument_list|)
operator|)
operator|!=
name|SNMP_CODE_OK
condition|)
return|return
operator|(
name|code
operator|)
return|;
block|}
name|code
operator|=
name|snmp_pdu_decode_scoped
argument_list|(
name|b
argument_list|,
name|pdu
argument_list|,
name|ip
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|SNMP_CODE_FAILED
case|:
name|snmp_pdu_free
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_CODE_BADENC
case|:
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_Verr
condition|)
return|return
operator|(
name|SNMP_CODE_BADVERS
operator|)
return|;
default|default:
break|break;
block|}
return|return
operator|(
name|code
operator|)
return|;
block|}
end_function

begin_function
name|enum
name|snmp_code
name|snmp_pdu_decode_header
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|int32_t
name|version
decl_stmt|;
name|u_int
name|octs_len
decl_stmt|;
name|asn_len_t
name|len
decl_stmt|;
name|pdu
operator|->
name|outer_ptr
operator|=
name|b
operator|->
name|asn_ptr
expr_stmt|;
name|pdu
operator|->
name|outer_len
operator|=
name|b
operator|->
name|asn_len
expr_stmt|;
if|if
condition|(
name|asn_get_sequence
argument_list|(
name|b
argument_list|,
operator|&
name|len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode pdu header"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|b
operator|->
name|asn_len
operator|<
name|len
condition|)
block|{
name|snmp_error
argument_list|(
literal|"outer sequence value too short"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|b
operator|->
name|asn_len
operator|!=
name|len
condition|)
block|{
name|snmp_error
argument_list|(
literal|"ignoring trailing junk in message"
argument_list|)
expr_stmt|;
name|b
operator|->
name|asn_len
operator|=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|asn_get_integer
argument_list|(
name|b
argument_list|,
operator|&
name|version
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode version"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|version
operator|==
literal|0
condition|)
name|pdu
operator|->
name|version
operator|=
name|SNMP_V1
expr_stmt|;
elseif|else
if|if
condition|(
name|version
operator|==
literal|1
condition|)
name|pdu
operator|->
name|version
operator|=
name|SNMP_V2c
expr_stmt|;
elseif|else
if|if
condition|(
name|version
operator|==
literal|3
condition|)
name|pdu
operator|->
name|version
operator|=
name|SNMP_V3
expr_stmt|;
else|else
block|{
name|pdu
operator|->
name|version
operator|=
name|SNMP_Verr
expr_stmt|;
name|snmp_error
argument_list|(
literal|"unsupported SNMP version"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_BADENC
operator|)
return|;
block|}
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V3
condition|)
block|{
if|if
condition|(
name|asn_get_sequence
argument_list|(
name|b
argument_list|,
operator|&
name|len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode pdu global data header"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_integer
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|identifier
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg indetifier"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_integer
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|engine
operator|.
name|max_msg_size
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg size"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
name|octs_len
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|asn_get_octetstring
argument_list|(
name|b
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|pdu
operator|->
name|flags
argument_list|,
operator|&
name|octs_len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg flags"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_get_integer
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|security_model
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg size"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|pdu
operator|->
name|security_model
operator|!=
name|SNMP_SECMODEL_USM
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|parse_secparams
argument_list|(
name|b
argument_list|,
name|pdu
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
else|else
block|{
name|octs_len
operator|=
name|SNMP_COMMUNITY_MAXLEN
expr_stmt|;
if|if
condition|(
name|asn_get_octetstring
argument_list|(
name|b
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|community
argument_list|,
operator|&
name|octs_len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode community"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
name|pdu
operator|->
name|community
index|[
name|octs_len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_CODE_OK
operator|)
return|;
block|}
end_function

begin_function
name|enum
name|snmp_code
name|snmp_pdu_decode_scoped
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|int32_t
modifier|*
name|ip
parameter_list|)
block|{
name|u_char
name|type
decl_stmt|;
name|asn_len_t
name|len
decl_stmt|,
name|trailer
decl_stmt|;
name|enum
name|asn_err
name|err
decl_stmt|;
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V3
condition|)
block|{
if|if
condition|(
name|asn_get_sequence
argument_list|(
name|b
argument_list|,
operator|&
name|len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode scoped pdu header"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
name|len
operator|=
name|SNMP_ENGINE_ID_SIZ
expr_stmt|;
if|if
condition|(
name|asn_get_octetstring
argument_list|(
name|b
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|pdu
operator|->
name|context_engine
argument_list|,
operator|&
name|len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg context engine"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
name|pdu
operator|->
name|context_engine_len
operator|=
name|len
expr_stmt|;
name|len
operator|=
name|SNMP_CONTEXT_NAME_SIZ
expr_stmt|;
if|if
condition|(
name|asn_get_octetstring
argument_list|(
name|b
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|pdu
operator|->
name|context_name
argument_list|,
operator|&
name|len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode msg context name"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
name|pdu
operator|->
name|context_name
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|asn_get_header
argument_list|(
name|b
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot get pdu header"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|type
operator|&
operator|~
name|ASN_TYPE_MASK
operator|)
operator|!=
operator|(
name|ASN_TYPE_CONSTRUCTED
operator||
name|ASN_CLASS_CONTEXT
operator|)
condition|)
block|{
name|snmp_error
argument_list|(
literal|"bad pdu header tag"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
name|pdu
operator|->
name|type
operator|=
name|type
operator|&
name|ASN_TYPE_MASK
expr_stmt|;
switch|switch
condition|(
name|pdu
operator|->
name|type
condition|)
block|{
case|case
name|SNMP_PDU_GET
case|:
case|case
name|SNMP_PDU_GETNEXT
case|:
case|case
name|SNMP_PDU_RESPONSE
case|:
case|case
name|SNMP_PDU_SET
case|:
break|break;
case|case
name|SNMP_PDU_TRAP
case|:
if|if
condition|(
name|pdu
operator|->
name|version
operator|!=
name|SNMP_V1
condition|)
block|{
name|snmp_error
argument_list|(
literal|"bad pdu type %u"
argument_list|,
name|pdu
operator|->
name|type
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
break|break;
case|case
name|SNMP_PDU_GETBULK
case|:
case|case
name|SNMP_PDU_INFORM
case|:
case|case
name|SNMP_PDU_TRAP2
case|:
case|case
name|SNMP_PDU_REPORT
case|:
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V1
condition|)
block|{
name|snmp_error
argument_list|(
literal|"bad pdu type %u"
argument_list|,
name|pdu
operator|->
name|type
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
break|break;
default|default:
name|snmp_error
argument_list|(
literal|"bad pdu type %u"
argument_list|,
name|pdu
operator|->
name|type
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
name|trailer
operator|=
name|b
operator|->
name|asn_len
operator|-
name|len
expr_stmt|;
name|b
operator|->
name|asn_len
operator|=
name|len
expr_stmt|;
name|err
operator|=
name|parse_pdus
argument_list|(
name|b
argument_list|,
name|pdu
argument_list|,
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASN_ERR_STOPPED
argument_list|(
name|err
argument_list|)
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|b
operator|->
name|asn_len
operator|!=
literal|0
condition|)
name|snmp_error
argument_list|(
literal|"ignoring trailing junk after pdu"
argument_list|)
expr_stmt|;
name|b
operator|->
name|asn_len
operator|=
name|trailer
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_OK
operator|)
return|;
block|}
end_function

begin_function
name|enum
name|snmp_code
name|snmp_pdu_decode_secmode
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|u_char
name|type
decl_stmt|;
name|enum
name|snmp_code
name|code
decl_stmt|;
name|uint8_t
name|digest
index|[
name|SNMP_USM_AUTH_SIZE
index|]
decl_stmt|;
if|if
condition|(
name|pdu
operator|->
name|user
operator|.
name|auth_proto
operator|!=
name|SNMP_AUTH_NOAUTH
operator|&&
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_AUTH_FLAG
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|SNMP_CODE_BADSECLEVEL
operator|)
return|;
if|if
condition|(
operator|(
name|code
operator|=
name|snmp_pdu_calc_digest
argument_list|(
name|pdu
argument_list|,
name|digest
argument_list|)
operator|)
operator|!=
name|SNMP_CODE_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|user
operator|.
name|auth_proto
operator|!=
name|SNMP_AUTH_NOAUTH
operator|&&
name|memcmp
argument_list|(
name|digest
argument_list|,
name|pdu
operator|->
name|msg_digest
argument_list|,
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|msg_digest
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|SNMP_CODE_BADDIGEST
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|user
operator|.
name|priv_proto
operator|!=
name|SNMP_PRIV_NOPRIV
operator|&&
operator|(
name|asn_get_header
argument_list|(
name|b
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|pdu
operator|->
name|scoped_len
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
name|type
operator|!=
name|ASN_TYPE_OCTETSTRING
operator|)
condition|)
block|{
name|snmp_error
argument_list|(
literal|"cannot decode encrypted pdu"
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
name|pdu
operator|->
name|scoped_ptr
operator|=
name|b
operator|->
name|asn_ptr
expr_stmt|;
if|if
condition|(
name|pdu
operator|->
name|user
operator|.
name|priv_proto
operator|!=
name|SNMP_PRIV_NOPRIV
operator|&&
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_PRIV_FLAG
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|SNMP_CODE_BADSECLEVEL
operator|)
return|;
if|if
condition|(
operator|(
name|code
operator|=
name|snmp_pdu_decrypt
argument_list|(
name|pdu
argument_list|)
operator|)
operator|!=
name|SNMP_CODE_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
return|return
operator|(
name|code
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check whether what we have is the complete PDU by snooping at the  * enclosing structure header. This returns:  *   -1		if there are ASN.1 errors  *    0		if we need more data  *> 0		the length of this PDU  */
end_comment

begin_function
name|int
name|snmp_pdu_snoop
parameter_list|(
specifier|const
name|struct
name|asn_buf
modifier|*
name|b0
parameter_list|)
block|{
name|u_int
name|length
decl_stmt|;
name|asn_len_t
name|len
decl_stmt|;
name|struct
name|asn_buf
name|b
init|=
operator|*
name|b0
decl_stmt|;
comment|/*<0x10|0x20><len><data...> */
if|if
condition|(
name|b
operator|.
name|asn_len
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|b
operator|.
name|asn_cptr
index|[
literal|0
index|]
operator|!=
operator|(
name|ASN_TYPE_SEQUENCE
operator||
name|ASN_TYPE_CONSTRUCTED
operator|)
condition|)
block|{
name|asn_error
argument_list|(
operator|&
name|b
argument_list|,
literal|"bad sequence type %u"
argument_list|,
name|b
operator|.
name|asn_cptr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|b
operator|.
name|asn_len
operator|--
expr_stmt|;
name|b
operator|.
name|asn_cptr
operator|++
expr_stmt|;
if|if
condition|(
name|b
operator|.
name|asn_len
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|*
name|b
operator|.
name|asn_cptr
operator|&
literal|0x80
condition|)
block|{
comment|/* long length */
name|length
operator|=
operator|*
name|b
operator|.
name|asn_cptr
operator|++
operator|&
literal|0x7f
expr_stmt|;
name|b
operator|.
name|asn_len
operator|--
expr_stmt|;
if|if
condition|(
name|length
operator|==
literal|0
condition|)
block|{
name|asn_error
argument_list|(
operator|&
name|b
argument_list|,
literal|"indefinite length not supported"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|length
operator|>
name|ASN_MAXLENLEN
condition|)
block|{
name|asn_error
argument_list|(
operator|&
name|b
argument_list|,
literal|"long length too long (%u)"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|length
operator|>
name|b
operator|.
name|asn_len
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|len
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|length
operator|--
condition|)
block|{
name|len
operator|=
operator|(
name|len
operator|<<
literal|8
operator|)
operator||
operator|*
name|b
operator|.
name|asn_cptr
operator|++
expr_stmt|;
name|b
operator|.
name|asn_len
operator|--
expr_stmt|;
block|}
block|}
else|else
block|{
name|len
operator|=
operator|*
name|b
operator|.
name|asn_cptr
operator|++
expr_stmt|;
name|b
operator|.
name|asn_len
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|>
name|b
operator|.
name|asn_len
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|len
operator|+
name|b
operator|.
name|asn_cptr
operator|-
name|b0
operator|->
name|asn_cptr
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Encode the SNMP PDU without the variable bindings field.  * We do this the rather uneffective way by  * moving things around and assuming that the length field will never  * use more than 2 bytes.  * We need a number of pointers to apply the fixes afterwards.  */
end_comment

begin_function
name|enum
name|snmp_code
name|snmp_pdu_encode_header
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|enum
name|asn_err
name|err
decl_stmt|;
name|u_char
modifier|*
name|v3_hdr_ptr
decl_stmt|;
if|if
condition|(
name|asn_put_temp_header
argument_list|(
name|b
argument_list|,
operator|(
name|ASN_TYPE_SEQUENCE
operator||
name|ASN_TYPE_CONSTRUCTED
operator|)
argument_list|,
operator|&
name|pdu
operator|->
name|outer_ptr
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V1
condition|)
name|err
operator|=
name|asn_put_integer
argument_list|(
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V2c
condition|)
name|err
operator|=
name|asn_put_integer
argument_list|(
name|b
argument_list|,
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V3
condition|)
name|err
operator|=
name|asn_put_integer
argument_list|(
name|b
argument_list|,
literal|3
argument_list|)
expr_stmt|;
else|else
return|return
operator|(
name|SNMP_CODE_BADVERS
operator|)
return|;
if|if
condition|(
name|err
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V3
condition|)
block|{
if|if
condition|(
name|asn_put_temp_header
argument_list|(
name|b
argument_list|,
operator|(
name|ASN_TYPE_SEQUENCE
operator||
name|ASN_TYPE_CONSTRUCTED
operator|)
argument_list|,
operator|&
name|v3_hdr_ptr
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_integer
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|identifier
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_integer
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|engine
operator|.
name|max_msg_size
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|type
operator|!=
name|SNMP_PDU_RESPONSE
operator|&&
name|pdu
operator|->
name|type
operator|!=
name|SNMP_PDU_TRAP
operator|&&
name|pdu
operator|->
name|type
operator|!=
name|SNMP_PDU_TRAP2
operator|&&
name|pdu
operator|->
name|type
operator|!=
name|SNMP_PDU_REPORT
condition|)
name|pdu
operator|->
name|flags
operator||=
name|SNMP_MSG_REPORT_FLAG
expr_stmt|;
if|if
condition|(
name|asn_put_octetstring
argument_list|(
name|b
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|pdu
operator|->
name|flags
argument_list|,
literal|1
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_integer
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|security_model
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_commit_header
argument_list|(
name|b
argument_list|,
name|v3_hdr_ptr
argument_list|,
name|NULL
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|security_model
operator|!=
name|SNMP_SECMODEL_USM
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu_encode_secparams
argument_list|(
name|b
argument_list|,
name|pdu
argument_list|)
operator|!=
name|SNMP_CODE_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
comment|/*  View-based Access Conntrol information */
if|if
condition|(
name|asn_put_temp_header
argument_list|(
name|b
argument_list|,
operator|(
name|ASN_TYPE_SEQUENCE
operator||
name|ASN_TYPE_CONSTRUCTED
operator|)
argument_list|,
operator|&
name|pdu
operator|->
name|scoped_ptr
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_octetstring
argument_list|(
name|b
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|context_engine
argument_list|,
name|pdu
operator|->
name|context_engine_len
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_octetstring
argument_list|(
name|b
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|context_name
argument_list|,
name|strlen
argument_list|(
name|pdu
operator|->
name|context_name
argument_list|)
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|asn_put_octetstring
argument_list|(
name|b
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|pdu
operator|->
name|community
argument_list|,
name|strlen
argument_list|(
name|pdu
operator|->
name|community
argument_list|)
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_put_temp_header
argument_list|(
name|b
argument_list|,
operator|(
name|ASN_TYPE_CONSTRUCTED
operator||
name|ASN_CLASS_CONTEXT
operator||
name|pdu
operator|->
name|type
operator|)
argument_list|,
operator|&
name|pdu
operator|->
name|pdu_ptr
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|type
operator|==
name|SNMP_PDU_TRAP
condition|)
block|{
if|if
condition|(
name|pdu
operator|->
name|version
operator|!=
name|SNMP_V1
operator|||
name|asn_put_objid
argument_list|(
name|b
argument_list|,
operator|&
name|pdu
operator|->
name|enterprise
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
name|asn_put_ipaddress
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|agent_addr
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
name|asn_put_integer
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|generic_trap
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
name|asn_put_integer
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|specific_trap
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
name|asn_put_timeticks
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|time_stamp
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V1
operator|&&
operator|(
name|pdu
operator|->
name|type
operator|==
name|SNMP_PDU_GETBULK
operator|||
name|pdu
operator|->
name|type
operator|==
name|SNMP_PDU_INFORM
operator|||
name|pdu
operator|->
name|type
operator|==
name|SNMP_PDU_TRAP2
operator|||
name|pdu
operator|->
name|type
operator|==
name|SNMP_PDU_REPORT
operator|)
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|asn_put_integer
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|request_id
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
name|asn_put_integer
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|error_status
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
name|asn_put_integer
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|error_index
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_put_temp_header
argument_list|(
name|b
argument_list|,
operator|(
name|ASN_TYPE_SEQUENCE
operator||
name|ASN_TYPE_CONSTRUCTED
operator|)
argument_list|,
operator|&
name|pdu
operator|->
name|vars_ptr
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
return|return
operator|(
name|SNMP_CODE_OK
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|asn_err
name|snmp_pdu_fix_padd
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|asn_len_t
name|padlen
decl_stmt|;
if|if
condition|(
name|pdu
operator|->
name|user
operator|.
name|priv_proto
operator|==
name|SNMP_PRIV_DES
operator|&&
name|pdu
operator|->
name|scoped_len
operator|%
literal|8
operator|!=
literal|0
condition|)
block|{
name|padlen
operator|=
literal|8
operator|-
operator|(
name|pdu
operator|->
name|scoped_len
operator|%
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|asn_pad
argument_list|(
name|b
argument_list|,
name|padlen
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|ASN_ERR_FAILED
operator|)
return|;
name|pdu
operator|->
name|scoped_len
operator|+=
name|padlen
expr_stmt|;
block|}
return|return
operator|(
name|ASN_ERR_OK
operator|)
return|;
block|}
end_function

begin_function
name|enum
name|snmp_code
name|snmp_fix_encoding
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|size_t
name|moved
init|=
literal|0
decl_stmt|;
name|enum
name|snmp_code
name|code
decl_stmt|;
if|if
condition|(
name|asn_commit_header
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|vars_ptr
argument_list|,
name|NULL
argument_list|)
operator|!=
name|ASN_ERR_OK
operator|||
name|asn_commit_header
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|pdu_ptr
argument_list|,
name|NULL
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V3
condition|)
block|{
if|if
condition|(
name|asn_commit_header
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|scoped_ptr
argument_list|,
name|NULL
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
name|pdu
operator|->
name|scoped_len
operator|=
name|b
operator|->
name|asn_ptr
operator|-
name|pdu
operator|->
name|scoped_ptr
expr_stmt|;
if|if
condition|(
name|snmp_pdu_fix_padd
argument_list|(
name|b
argument_list|,
name|pdu
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|security_model
operator|!=
name|SNMP_SECMODEL_USM
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|snmp_pdu_encrypt
argument_list|(
name|pdu
argument_list|)
operator|!=
name|SNMP_CODE_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
name|pdu
operator|->
name|user
operator|.
name|priv_proto
operator|!=
name|SNMP_PRIV_NOPRIV
operator|&&
name|asn_commit_header
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|encrypted_ptr
argument_list|,
name|NULL
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
block|}
if|if
condition|(
name|asn_commit_header
argument_list|(
name|b
argument_list|,
name|pdu
operator|->
name|outer_ptr
argument_list|,
operator|&
name|moved
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
name|pdu
operator|->
name|outer_len
operator|=
name|b
operator|->
name|asn_ptr
operator|-
name|pdu
operator|->
name|outer_ptr
expr_stmt|;
name|pdu
operator|->
name|digest_ptr
operator|-=
name|moved
expr_stmt|;
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V3
condition|)
block|{
if|if
condition|(
operator|(
name|code
operator|=
name|snmp_pdu_calc_digest
argument_list|(
name|pdu
argument_list|,
name|pdu
operator|->
name|msg_digest
argument_list|)
operator|)
operator|!=
name|SNMP_CODE_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
if|if
condition|(
operator|(
name|pdu
operator|->
name|flags
operator|&
name|SNMP_MSG_AUTH_FLAG
operator|)
operator|!=
literal|0
condition|)
name|memcpy
argument_list|(
name|pdu
operator|->
name|digest_ptr
argument_list|,
name|pdu
operator|->
name|msg_digest
argument_list|,
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|msg_digest
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_CODE_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Encode a binding. Caller must ensure, that the syntax is ok for that version.  * Be sure not to cobber b, when something fails.  */
end_comment

begin_function
name|enum
name|asn_err
name|snmp_binding_encode
parameter_list|(
name|struct
name|asn_buf
modifier|*
name|b
parameter_list|,
specifier|const
name|struct
name|snmp_value
modifier|*
name|binding
parameter_list|)
block|{
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|enum
name|asn_err
name|err
decl_stmt|;
name|struct
name|asn_buf
name|save
init|=
operator|*
name|b
decl_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|asn_put_temp_header
argument_list|(
name|b
argument_list|,
operator|(
name|ASN_TYPE_SEQUENCE
operator||
name|ASN_TYPE_CONSTRUCTED
operator|)
argument_list|,
operator|&
name|ptr
argument_list|)
operator|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
operator|*
name|b
operator|=
name|save
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|err
operator|=
name|asn_put_objid
argument_list|(
name|b
argument_list|,
operator|&
name|binding
operator|->
name|var
argument_list|)
operator|)
operator|!=
name|ASN_ERR_OK
condition|)
block|{
operator|*
name|b
operator|=
name|save
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
switch|switch
condition|(
name|binding
operator|->
name|syntax
condition|)
block|{
case|case
name|SNMP_SYNTAX_NULL
case|:
name|err
operator|=
name|asn_put_null
argument_list|(
name|b
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_INTEGER
case|:
name|err
operator|=
name|asn_put_integer
argument_list|(
name|b
argument_list|,
name|binding
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_OCTETSTRING
case|:
name|err
operator|=
name|asn_put_octetstring
argument_list|(
name|b
argument_list|,
name|binding
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|binding
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_OID
case|:
name|err
operator|=
name|asn_put_objid
argument_list|(
name|b
argument_list|,
operator|&
name|binding
operator|->
name|v
operator|.
name|oid
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_IPADDRESS
case|:
name|err
operator|=
name|asn_put_ipaddress
argument_list|(
name|b
argument_list|,
name|binding
operator|->
name|v
operator|.
name|ipaddress
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_TIMETICKS
case|:
name|err
operator|=
name|asn_put_uint32
argument_list|(
name|b
argument_list|,
name|ASN_APP_TIMETICKS
argument_list|,
name|binding
operator|->
name|v
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_COUNTER
case|:
name|err
operator|=
name|asn_put_uint32
argument_list|(
name|b
argument_list|,
name|ASN_APP_COUNTER
argument_list|,
name|binding
operator|->
name|v
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_GAUGE
case|:
name|err
operator|=
name|asn_put_uint32
argument_list|(
name|b
argument_list|,
name|ASN_APP_GAUGE
argument_list|,
name|binding
operator|->
name|v
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_COUNTER64
case|:
name|err
operator|=
name|asn_put_counter64
argument_list|(
name|b
argument_list|,
name|binding
operator|->
name|v
operator|.
name|counter64
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_NOSUCHOBJECT
case|:
name|err
operator|=
name|asn_put_exception
argument_list|(
name|b
argument_list|,
name|ASN_EXCEPT_NOSUCHOBJECT
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_NOSUCHINSTANCE
case|:
name|err
operator|=
name|asn_put_exception
argument_list|(
name|b
argument_list|,
name|ASN_EXCEPT_NOSUCHINSTANCE
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_ENDOFMIBVIEW
case|:
name|err
operator|=
name|asn_put_exception
argument_list|(
name|b
argument_list|,
name|ASN_EXCEPT_ENDOFMIBVIEW
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|err
operator|!=
name|ASN_ERR_OK
condition|)
block|{
operator|*
name|b
operator|=
name|save
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|asn_commit_header
argument_list|(
name|b
argument_list|,
name|ptr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|ASN_ERR_OK
condition|)
block|{
operator|*
name|b
operator|=
name|save
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
return|return
operator|(
name|ASN_ERR_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Encode an PDU.  */
end_comment

begin_function
name|enum
name|snmp_code
name|snmp_pdu_encode
parameter_list|(
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|,
name|struct
name|asn_buf
modifier|*
name|resp_b
parameter_list|)
block|{
name|u_int
name|idx
decl_stmt|;
name|enum
name|snmp_code
name|err
decl_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|snmp_pdu_encode_header
argument_list|(
name|resp_b
argument_list|,
name|pdu
argument_list|)
operator|)
operator|!=
name|SNMP_CODE_OK
condition|)
return|return
operator|(
name|err
operator|)
return|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|pdu
operator|->
name|nbindings
condition|;
name|idx
operator|++
control|)
if|if
condition|(
name|snmp_binding_encode
argument_list|(
name|resp_b
argument_list|,
operator|&
name|pdu
operator|->
name|bindings
index|[
name|idx
index|]
argument_list|)
operator|!=
name|ASN_ERR_OK
condition|)
return|return
operator|(
name|SNMP_CODE_FAILED
operator|)
return|;
return|return
operator|(
name|snmp_fix_encoding
argument_list|(
name|resp_b
argument_list|,
name|pdu
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_binding
parameter_list|(
specifier|const
name|struct
name|snmp_value
modifier|*
name|b
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
name|char
name|buf
index|[
name|ASN_OIDSTRLEN
index|]
decl_stmt|;
name|snmp_printf
argument_list|(
literal|"%s="
argument_list|,
name|asn_oid2str_r
argument_list|(
operator|&
name|b
operator|->
name|var
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|b
operator|->
name|syntax
condition|)
block|{
case|case
name|SNMP_SYNTAX_NULL
case|:
name|snmp_printf
argument_list|(
literal|"NULL"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_INTEGER
case|:
name|snmp_printf
argument_list|(
literal|"INTEGER %d"
argument_list|,
name|b
operator|->
name|v
operator|.
name|integer
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_OCTETSTRING
case|:
name|snmp_printf
argument_list|(
literal|"OCTET STRING %lu:"
argument_list|,
name|b
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|b
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
condition|;
name|i
operator|++
control|)
name|snmp_printf
argument_list|(
literal|" %02x"
argument_list|,
name|b
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_OID
case|:
name|snmp_printf
argument_list|(
literal|"OID %s"
argument_list|,
name|asn_oid2str_r
argument_list|(
operator|&
name|b
operator|->
name|v
operator|.
name|oid
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_IPADDRESS
case|:
name|snmp_printf
argument_list|(
literal|"IPADDRESS %u.%u.%u.%u"
argument_list|,
name|b
operator|->
name|v
operator|.
name|ipaddress
index|[
literal|0
index|]
argument_list|,
name|b
operator|->
name|v
operator|.
name|ipaddress
index|[
literal|1
index|]
argument_list|,
name|b
operator|->
name|v
operator|.
name|ipaddress
index|[
literal|2
index|]
argument_list|,
name|b
operator|->
name|v
operator|.
name|ipaddress
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_COUNTER
case|:
name|snmp_printf
argument_list|(
literal|"COUNTER %u"
argument_list|,
name|b
operator|->
name|v
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_GAUGE
case|:
name|snmp_printf
argument_list|(
literal|"GAUGE %u"
argument_list|,
name|b
operator|->
name|v
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_TIMETICKS
case|:
name|snmp_printf
argument_list|(
literal|"TIMETICKS %u"
argument_list|,
name|b
operator|->
name|v
operator|.
name|uint32
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_COUNTER64
case|:
name|snmp_printf
argument_list|(
literal|"COUNTER64 %lld"
argument_list|,
name|b
operator|->
name|v
operator|.
name|counter64
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_NOSUCHOBJECT
case|:
name|snmp_printf
argument_list|(
literal|"NoSuchObject"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_NOSUCHINSTANCE
case|:
name|snmp_printf
argument_list|(
literal|"NoSuchInstance"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_SYNTAX_ENDOFMIBVIEW
case|:
name|snmp_printf
argument_list|(
literal|"EndOfMibView"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|snmp_printf
argument_list|(
literal|"UNKNOWN SYNTAX %u"
argument_list|,
name|b
operator|->
name|syntax
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|dump_bindings
parameter_list|(
specifier|const
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pdu
operator|->
name|nbindings
condition|;
name|i
operator|++
control|)
block|{
name|snmp_printf
argument_list|(
literal|" [%u]: "
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|dump_binding
argument_list|(
operator|&
name|pdu
operator|->
name|bindings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|snmp_printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|dump_notrap
parameter_list|(
specifier|const
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|snmp_printf
argument_list|(
literal|" request_id=%d"
argument_list|,
name|pdu
operator|->
name|request_id
argument_list|)
expr_stmt|;
name|snmp_printf
argument_list|(
literal|" error_status=%d"
argument_list|,
name|pdu
operator|->
name|error_status
argument_list|)
expr_stmt|;
name|snmp_printf
argument_list|(
literal|" error_index=%d\n"
argument_list|,
name|pdu
operator|->
name|error_index
argument_list|)
expr_stmt|;
name|dump_bindings
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|snmp_pdu_dump
parameter_list|(
specifier|const
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|char
name|buf
index|[
name|ASN_OIDSTRLEN
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|vers
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|types
index|[]
init|=
block|{
index|[
name|SNMP_PDU_GET
index|]
operator|=
literal|"GET"
block|,
index|[
name|SNMP_PDU_GETNEXT
index|]
operator|=
literal|"GETNEXT"
block|,
index|[
name|SNMP_PDU_RESPONSE
index|]
operator|=
literal|"RESPONSE"
block|,
index|[
name|SNMP_PDU_SET
index|]
operator|=
literal|"SET"
block|,
index|[
name|SNMP_PDU_TRAP
index|]
operator|=
literal|"TRAPv1"
block|,
index|[
name|SNMP_PDU_GETBULK
index|]
operator|=
literal|"GETBULK"
block|,
index|[
name|SNMP_PDU_INFORM
index|]
operator|=
literal|"INFORM"
block|,
index|[
name|SNMP_PDU_TRAP2
index|]
operator|=
literal|"TRAPv2"
block|,
index|[
name|SNMP_PDU_REPORT
index|]
operator|=
literal|"REPORT"
block|, 	}
decl_stmt|;
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V1
condition|)
name|vers
operator|=
literal|"SNMPv1"
expr_stmt|;
elseif|else
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V2c
condition|)
name|vers
operator|=
literal|"SNMPv2c"
expr_stmt|;
elseif|else
if|if
condition|(
name|pdu
operator|->
name|version
operator|==
name|SNMP_V3
condition|)
name|vers
operator|=
literal|"SNMPv3"
expr_stmt|;
else|else
name|vers
operator|=
literal|"v?"
expr_stmt|;
switch|switch
condition|(
name|pdu
operator|->
name|type
condition|)
block|{
case|case
name|SNMP_PDU_TRAP
case|:
name|snmp_printf
argument_list|(
literal|"%s %s '%s'"
argument_list|,
name|types
index|[
name|pdu
operator|->
name|type
index|]
argument_list|,
name|vers
argument_list|,
name|pdu
operator|->
name|community
argument_list|)
expr_stmt|;
name|snmp_printf
argument_list|(
literal|" enterprise=%s"
argument_list|,
name|asn_oid2str_r
argument_list|(
operator|&
name|pdu
operator|->
name|enterprise
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|snmp_printf
argument_list|(
literal|" agent_addr=%u.%u.%u.%u"
argument_list|,
name|pdu
operator|->
name|agent_addr
index|[
literal|0
index|]
argument_list|,
name|pdu
operator|->
name|agent_addr
index|[
literal|1
index|]
argument_list|,
name|pdu
operator|->
name|agent_addr
index|[
literal|2
index|]
argument_list|,
name|pdu
operator|->
name|agent_addr
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|snmp_printf
argument_list|(
literal|" generic_trap=%d"
argument_list|,
name|pdu
operator|->
name|generic_trap
argument_list|)
expr_stmt|;
name|snmp_printf
argument_list|(
literal|" specific_trap=%d"
argument_list|,
name|pdu
operator|->
name|specific_trap
argument_list|)
expr_stmt|;
name|snmp_printf
argument_list|(
literal|" time-stamp=%u\n"
argument_list|,
name|pdu
operator|->
name|time_stamp
argument_list|)
expr_stmt|;
name|dump_bindings
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_PDU_GET
case|:
case|case
name|SNMP_PDU_GETNEXT
case|:
case|case
name|SNMP_PDU_RESPONSE
case|:
case|case
name|SNMP_PDU_SET
case|:
case|case
name|SNMP_PDU_GETBULK
case|:
case|case
name|SNMP_PDU_INFORM
case|:
case|case
name|SNMP_PDU_TRAP2
case|:
case|case
name|SNMP_PDU_REPORT
case|:
name|snmp_printf
argument_list|(
literal|"%s %s '%s'"
argument_list|,
name|types
index|[
name|pdu
operator|->
name|type
index|]
argument_list|,
name|vers
argument_list|,
name|pdu
operator|->
name|community
argument_list|)
expr_stmt|;
name|dump_notrap
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
break|break;
default|default:
name|snmp_printf
argument_list|(
literal|"bad pdu type %u\n"
argument_list|,
name|pdu
operator|->
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|snmp_value_free
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|)
block|{
if|if
condition|(
name|value
operator|->
name|syntax
operator|==
name|SNMP_SYNTAX_OCTETSTRING
condition|)
name|free
argument_list|(
name|value
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|)
expr_stmt|;
name|value
operator|->
name|syntax
operator|=
name|SNMP_SYNTAX_NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|snmp_value_copy
parameter_list|(
name|struct
name|snmp_value
modifier|*
name|to
parameter_list|,
specifier|const
name|struct
name|snmp_value
modifier|*
name|from
parameter_list|)
block|{
name|to
operator|->
name|var
operator|=
name|from
operator|->
name|var
expr_stmt|;
name|to
operator|->
name|syntax
operator|=
name|from
operator|->
name|syntax
expr_stmt|;
if|if
condition|(
name|from
operator|->
name|syntax
operator|==
name|SNMP_SYNTAX_OCTETSTRING
condition|)
block|{
if|if
condition|(
operator|(
name|to
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
operator|=
name|from
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
operator|)
operator|==
literal|0
condition|)
name|to
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|to
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
operator|=
name|malloc
argument_list|(
name|to
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|to
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|(
name|void
operator|)
name|memcpy
argument_list|(
name|to
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|from
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|to
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|to
operator|->
name|v
operator|=
name|from
operator|->
name|v
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|snmp_pdu_init_secparams
parameter_list|(
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|int32_t
name|rval
decl_stmt|;
if|if
condition|(
name|pdu
operator|->
name|user
operator|.
name|auth_proto
operator|!=
name|SNMP_AUTH_NOAUTH
condition|)
name|pdu
operator|->
name|flags
operator||=
name|SNMP_MSG_AUTH_FLAG
expr_stmt|;
switch|switch
condition|(
name|pdu
operator|->
name|user
operator|.
name|priv_proto
condition|)
block|{
case|case
name|SNMP_PRIV_DES
case|:
name|memcpy
argument_list|(
name|pdu
operator|->
name|msg_salt
argument_list|,
operator|&
name|pdu
operator|->
name|engine
operator|.
name|engine_boots
argument_list|,
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|engine
operator|.
name|engine_boots
argument_list|)
argument_list|)
expr_stmt|;
name|rval
operator|=
name|random
argument_list|()
expr_stmt|;
name|memcpy
argument_list|(
name|pdu
operator|->
name|msg_salt
operator|+
sizeof|sizeof
argument_list|(
name|pdu
operator|->
name|engine
operator|.
name|engine_boots
argument_list|)
argument_list|,
operator|&
name|rval
argument_list|,
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|pdu
operator|->
name|flags
operator||=
name|SNMP_MSG_PRIV_FLAG
expr_stmt|;
break|break;
case|case
name|SNMP_PRIV_AES
case|:
name|rval
operator|=
name|random
argument_list|()
expr_stmt|;
name|memcpy
argument_list|(
name|pdu
operator|->
name|msg_salt
argument_list|,
operator|&
name|rval
argument_list|,
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|rval
operator|=
name|random
argument_list|()
expr_stmt|;
name|memcpy
argument_list|(
name|pdu
operator|->
name|msg_salt
operator|+
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
argument_list|,
operator|&
name|rval
argument_list|,
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|pdu
operator|->
name|flags
operator||=
name|SNMP_MSG_PRIV_FLAG
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|void
name|snmp_pdu_free
parameter_list|(
name|struct
name|snmp_pdu
modifier|*
name|pdu
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pdu
operator|->
name|nbindings
condition|;
name|i
operator|++
control|)
name|snmp_value_free
argument_list|(
operator|&
name|pdu
operator|->
name|bindings
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Parse an ASCII SNMP value into the binary form  */
end_comment

begin_function
name|int
name|snmp_value_parse
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|enum
name|snmp_syntax
name|syntax
parameter_list|,
name|union
name|snmp_values
modifier|*
name|v
parameter_list|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
switch|switch
condition|(
name|syntax
condition|)
block|{
case|case
name|SNMP_SYNTAX_NULL
case|:
case|case
name|SNMP_SYNTAX_NOSUCHOBJECT
case|:
case|case
name|SNMP_SYNTAX_NOSUCHINSTANCE
case|:
case|case
name|SNMP_SYNTAX_ENDOFMIBVIEW
case|:
if|if
condition|(
operator|*
name|str
operator|!=
literal|'\0'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SNMP_SYNTAX_INTEGER
case|:
name|v
operator|->
name|integer
operator|=
name|strtoll
argument_list|(
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|'\0'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SNMP_SYNTAX_OCTETSTRING
case|:
block|{
name|u_long
name|len
decl_stmt|;
comment|/* actual length of string */
name|u_long
name|alloc
decl_stmt|;
comment|/* allocate length of string */
name|u_char
modifier|*
name|octs
decl_stmt|;
comment|/* actual octets */
name|u_long
name|oct
decl_stmt|;
comment|/* actual octet */
name|u_char
modifier|*
name|nocts
decl_stmt|;
comment|/* to avoid memory leak */
name|u_char
name|c
decl_stmt|;
comment|/* actual character */
define|#
directive|define
name|STUFFC
parameter_list|(
name|C
parameter_list|)
define|\
value|if (alloc == len) {					\ 			alloc += 100;					\ 			if ((nocts = realloc(octs, alloc)) == NULL) {	\ 				free(octs);				\ 				return (-1);				\ 			}						\ 			octs = nocts;					\ 		}							\ 		octs[len++] = (C);
name|len
operator|=
name|alloc
operator|=
literal|0
expr_stmt|;
name|octs
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|==
literal|'"'
condition|)
block|{
name|str
operator|++
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|str
operator|++
operator|)
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'"'
condition|)
block|{
if|if
condition|(
operator|*
name|str
operator|!=
literal|'\0'
condition|)
block|{
name|free
argument_list|(
name|octs
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
break|break;
block|}
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
block|{
switch|switch
condition|(
name|c
operator|=
operator|*
name|str
operator|++
condition|)
block|{
case|case
literal|'\\'
case|:
break|break;
case|case
literal|'a'
case|:
name|c
operator|=
literal|'\a'
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|c
operator|=
literal|'\b'
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|c
operator|=
literal|'\f'
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|c
operator|=
literal|'\n'
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|c
operator|=
literal|'\r'
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|c
operator|=
literal|'\t'
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|c
operator|=
literal|'\v'
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|c
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|str
argument_list|)
condition|)
break|break;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|str
argument_list|)
condition|)
name|c
operator|=
operator|*
name|str
operator|++
operator|-
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
name|isupper
argument_list|(
operator|*
name|str
argument_list|)
condition|)
name|c
operator|=
operator|*
name|str
operator|++
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
else|else
name|c
operator|=
operator|*
name|str
operator|++
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|*
name|str
argument_list|)
condition|)
break|break;
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|str
argument_list|)
condition|)
name|c
operator|+=
operator|*
name|str
operator|++
operator|-
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
name|isupper
argument_list|(
operator|*
name|str
argument_list|)
condition|)
name|c
operator|+=
operator|*
name|str
operator|++
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
else|else
name|c
operator|+=
operator|*
name|str
operator|++
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
break|break;
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
name|c
operator|=
operator|*
name|str
operator|++
operator|-
literal|'0'
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|<
literal|'0'
operator|||
operator|*
name|str
operator|>
literal|'7'
condition|)
break|break;
name|c
operator|=
operator|*
name|str
operator|++
operator|-
literal|'0'
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|<
literal|'0'
operator|||
operator|*
name|str
operator|>
literal|'7'
condition|)
break|break;
name|c
operator|=
operator|*
name|str
operator|++
operator|-
literal|'0'
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|STUFFC
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
operator|*
name|str
operator|!=
literal|'\0'
condition|)
block|{
name|oct
operator|=
name|strtoul
argument_list|(
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|str
operator|=
name|end
expr_stmt|;
if|if
condition|(
name|oct
operator|>
literal|0xff
condition|)
block|{
name|free
argument_list|(
name|octs
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|STUFFC
argument_list|(
name|oct
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|==
literal|':'
condition|)
name|str
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|str
operator|!=
literal|'\0'
condition|)
block|{
name|free
argument_list|(
name|octs
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
block|}
name|v
operator|->
name|octetstring
operator|.
name|octets
operator|=
name|octs
expr_stmt|;
name|v
operator|->
name|octetstring
operator|.
name|len
operator|=
name|len
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
undef|#
directive|undef
name|STUFFC
block|}
case|case
name|SNMP_SYNTAX_OID
case|:
block|{
name|u_long
name|subid
decl_stmt|;
name|v
operator|->
name|oid
operator|.
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|v
operator|->
name|oid
operator|.
name|len
operator|==
name|ASN_MAXOIDLEN
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|subid
operator|=
name|strtoul
argument_list|(
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|str
operator|=
name|end
expr_stmt|;
if|if
condition|(
name|subid
operator|>
name|ASN_MAXID
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|v
operator|->
name|oid
operator|.
name|subs
index|[
name|v
operator|->
name|oid
operator|.
name|len
operator|++
index|]
operator|=
operator|(
name|asn_subid_t
operator|)
name|subid
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|==
literal|'\0'
condition|)
break|break;
if|if
condition|(
operator|*
name|str
operator|!=
literal|'.'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|str
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|SNMP_SYNTAX_IPADDRESS
case|:
block|{
name|struct
name|hostent
modifier|*
name|he
decl_stmt|;
name|u_long
name|ip
index|[
literal|4
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%lu.%lu.%lu.%lu%n"
argument_list|,
operator|&
name|ip
index|[
literal|0
index|]
argument_list|,
operator|&
name|ip
index|[
literal|1
index|]
argument_list|,
operator|&
name|ip
index|[
literal|2
index|]
argument_list|,
operator|&
name|ip
index|[
literal|3
index|]
argument_list|,
operator|&
name|n
argument_list|)
operator|==
literal|4
operator|&&
operator|(
name|size_t
operator|)
name|n
operator|==
name|strlen
argument_list|(
name|str
argument_list|)
operator|&&
name|ip
index|[
literal|0
index|]
operator|<=
literal|0xff
operator|&&
name|ip
index|[
literal|1
index|]
operator|<=
literal|0xff
operator|&&
name|ip
index|[
literal|2
index|]
operator|<=
literal|0xff
operator|&&
name|ip
index|[
literal|3
index|]
operator|<=
literal|0xff
condition|)
block|{
name|v
operator|->
name|ipaddress
index|[
literal|0
index|]
operator|=
operator|(
name|u_char
operator|)
name|ip
index|[
literal|0
index|]
expr_stmt|;
name|v
operator|->
name|ipaddress
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|ip
index|[
literal|1
index|]
expr_stmt|;
name|v
operator|->
name|ipaddress
index|[
literal|2
index|]
operator|=
operator|(
name|u_char
operator|)
name|ip
index|[
literal|2
index|]
expr_stmt|;
name|v
operator|->
name|ipaddress
index|[
literal|3
index|]
operator|=
operator|(
name|u_char
operator|)
name|ip
index|[
literal|3
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|he
operator|=
name|gethostbyname
argument_list|(
name|str
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|he
operator|->
name|h_addrtype
operator|!=
name|AF_INET
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|v
operator|->
name|ipaddress
index|[
literal|0
index|]
operator|=
name|he
operator|->
name|h_addr
index|[
literal|0
index|]
expr_stmt|;
name|v
operator|->
name|ipaddress
index|[
literal|1
index|]
operator|=
name|he
operator|->
name|h_addr
index|[
literal|1
index|]
expr_stmt|;
name|v
operator|->
name|ipaddress
index|[
literal|2
index|]
operator|=
name|he
operator|->
name|h_addr
index|[
literal|2
index|]
expr_stmt|;
name|v
operator|->
name|ipaddress
index|[
literal|3
index|]
operator|=
name|he
operator|->
name|h_addr
index|[
literal|3
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|SNMP_SYNTAX_COUNTER
case|:
case|case
name|SNMP_SYNTAX_GAUGE
case|:
case|case
name|SNMP_SYNTAX_TIMETICKS
case|:
block|{
name|uint64_t
name|sub
decl_stmt|;
name|sub
operator|=
name|strtoull
argument_list|(
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|'\0'
operator|||
name|sub
operator|>
literal|0xffffffff
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|v
operator|->
name|uint32
operator|=
operator|(
name|uint32_t
operator|)
name|sub
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|SNMP_SYNTAX_COUNTER64
case|:
name|v
operator|->
name|counter64
operator|=
name|strtoull
argument_list|(
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|'\0'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|snmp_error_func
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"SNMP: "
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|snmp_printf_func
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


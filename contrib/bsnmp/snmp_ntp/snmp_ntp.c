begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2005  *	Hartmut Brandt.  *	All rights reserved.  *  * Author: Harti Brandt<harti@freebsd.org>  *  * Redistribution of this software and documentation and use in source and  * binary forms, with or without modification, are permitted provided that  * the following conditions are met:  *  * 1. Redistributions of source code or documentation must retain the above  *    copyright notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE AND DOCUMENTATION IS PROVIDED BY FRAUNHOFER FOKUS  * AND ITS CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND  * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL  * FRAUNHOFER FOKUS OR ITS CONTRIBUTORS  BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,  * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $Begemot: bsnmp/snmp_ntp/snmp_ntp.c,v 1.9 2005/10/06 07:15:01 brandt_h Exp $  *  * NTP interface for SNMPd.  */
end_comment

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/select.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_STDINT_H
end_ifdef

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|HAVE_INTTYPES_H
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"support.h"
end_include

begin_include
include|#
directive|include
file|"snmpmod.h"
end_include

begin_include
include|#
directive|include
file|"ntp_tree.h"
end_include

begin_include
include|#
directive|include
file|"ntp_oid.h"
end_include

begin_define
define|#
directive|define
name|NTPC_MAX
value|576
end_define

begin_define
define|#
directive|define
name|NTPC_VERSION
value|3
end_define

begin_define
define|#
directive|define
name|NTPC_MODE
value|6
end_define

begin_define
define|#
directive|define
name|NTPC_DMAX
value|468
end_define

begin_define
define|#
directive|define
name|NTPC_BIT_RESP
value|0x80
end_define

begin_define
define|#
directive|define
name|NTPC_BIT_ERROR
value|0x40
end_define

begin_define
define|#
directive|define
name|NTPC_BIT_MORE
value|0x20
end_define

begin_define
define|#
directive|define
name|NTPC_OPMASK
value|0x1f
end_define

begin_define
define|#
directive|define
name|NTPC_OP_READSTAT
value|1
end_define

begin_define
define|#
directive|define
name|NTPC_OP_READVAR
value|2
end_define

begin_comment
comment|/* our module handle */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|lmodule
modifier|*
name|module
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* debug flag */
end_comment

begin_decl_stmt
specifier|static
name|uint32_t
name|ntp_debug
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DBG_DUMP_PKTS
value|0x01
end_define

begin_define
define|#
directive|define
name|DBG_DUMP_VARS
value|0x02
end_define

begin_comment
comment|/* OIDs */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|oid_ntpMIB
init|=
name|OIDX_ntpMIB
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the Object Resource registration index */
end_comment

begin_decl_stmt
specifier|static
name|u_int
name|reg_index
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* last time we've fetch the system variables */
end_comment

begin_decl_stmt
specifier|static
name|uint64_t
name|sysinfo_tick
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* cached system variables */
end_comment

begin_decl_stmt
specifier|static
name|int32_t
name|sys_leap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysb_leap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int32_t
name|sys_stratum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysb_stratum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int32_t
name|sys_precision
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysb_precision
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|sys_rootdelay
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|sys_rootdispersion
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|sys_refid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sys_reftime
index|[
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysb_reftime
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int32_t
name|sys_poll
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysb_poll
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|sys_peer
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysb_peer
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_char
name|sys_clock
index|[
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysb_clock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|sys_system
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|sys_processor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysb_jitter
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|double
name|sys_jitter
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysb_stability
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|double
name|sys_stability
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* last time we've fetch the peer list */
end_comment

begin_decl_stmt
specifier|static
name|uint64_t
name|peers_tick
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* request sequence number generator */
end_comment

begin_decl_stmt
specifier|static
name|uint16_t
name|seqno
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* NTPD socket */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ntpd_sock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
modifier|*
name|ntpd_fd
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|peer
block|{
comment|/* required entries for macros */
name|uint32_t
name|index
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|peer
argument_list|)
name|link
expr_stmt|;
name|int32_t
name|config
decl_stmt|;
comment|/* config bit */
name|u_char
name|srcadr
index|[
literal|4
index|]
decl_stmt|;
comment|/* PeerAddress */
name|uint32_t
name|srcport
decl_stmt|;
comment|/* PeerPort */
name|u_char
name|dstadr
index|[
literal|4
index|]
decl_stmt|;
comment|/* HostAddress */
name|uint32_t
name|dstport
decl_stmt|;
comment|/* HostPort */
name|int32_t
name|leap
decl_stmt|;
comment|/* Leap */
name|int32_t
name|hmode
decl_stmt|;
comment|/* Mode */
name|int32_t
name|stratum
decl_stmt|;
comment|/* Stratum */
name|int32_t
name|ppoll
decl_stmt|;
comment|/* PeerPoll */
name|int32_t
name|hpoll
decl_stmt|;
comment|/* HostPoll */
name|int32_t
name|precision
decl_stmt|;
comment|/* Precision */
name|char
modifier|*
name|rootdelay
decl_stmt|;
comment|/* RootDelay */
name|char
modifier|*
name|rootdispersion
decl_stmt|;
comment|/* RootDispersion */
name|char
modifier|*
name|refid
decl_stmt|;
comment|/* RefId */
name|u_char
name|reftime
index|[
literal|8
index|]
decl_stmt|;
comment|/* RefTime */
name|u_char
name|orgtime
index|[
literal|8
index|]
decl_stmt|;
comment|/* OrgTime */
name|u_char
name|rcvtime
index|[
literal|8
index|]
decl_stmt|;
comment|/* ReceiveTime */
name|u_char
name|xmttime
index|[
literal|8
index|]
decl_stmt|;
comment|/* TransmitTime */
name|u_int32_t
name|reach
decl_stmt|;
comment|/* Reach */
name|int32_t
name|timer
decl_stmt|;
comment|/* Timer */
name|char
modifier|*
name|offset
decl_stmt|;
comment|/* Offset */
name|char
modifier|*
name|delay
decl_stmt|;
comment|/* Delay */
name|char
modifier|*
name|dispersion
decl_stmt|;
comment|/* Dispersion */
name|int32_t
name|filt_entries
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|peer_list
argument_list|,
name|peer
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* list of peers */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|peer_list
name|peers
init|=
name|TAILQ_HEAD_INITIALIZER
argument_list|(
name|peers
argument_list|)
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|filt
block|{
comment|/* required fields */
name|struct
name|asn_oid
name|index
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|filt
argument_list|)
name|link
expr_stmt|;
name|char
modifier|*
name|offset
decl_stmt|;
name|char
modifier|*
name|delay
decl_stmt|;
name|char
modifier|*
name|dispersion
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|filt_list
argument_list|,
name|filt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* list of filters */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|filt_list
name|filts
init|=
name|TAILQ_HEAD_INITIALIZER
argument_list|(
name|filts
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* configuration */
end_comment

begin_decl_stmt
specifier|static
name|u_char
modifier|*
name|ntp_host
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_char
modifier|*
name|ntp_port
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|ntp_timeout
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|ntpd_input
parameter_list|(
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|open_socket
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* the initialization function */
end_comment

begin_function
specifier|static
name|int
name|ntp_init
parameter_list|(
name|struct
name|lmodule
modifier|*
name|mod
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
name|__unused
parameter_list|)
block|{
name|module
operator|=
name|mod
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bad number of arguments for %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|ntp_host
operator|=
name|strdup
argument_list|(
literal|"localhost"
argument_list|)
expr_stmt|;
name|ntp_port
operator|=
name|strdup
argument_list|(
literal|"ntp"
argument_list|)
expr_stmt|;
name|ntp_timeout
operator|=
literal|50
expr_stmt|;
comment|/* 0.5sec */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Module is started  */
end_comment

begin_function
specifier|static
name|void
name|ntp_start
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|open_socket
argument_list|()
operator|!=
operator|-
literal|1
condition|)
block|{
name|ntpd_fd
operator|=
name|fd_select
argument_list|(
name|ntpd_sock
argument_list|,
name|ntpd_input
argument_list|,
name|NULL
argument_list|,
name|module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntpd_fd
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"fd_select failed on ntpd socket: %m"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|reg_index
operator|=
name|or_register
argument_list|(
operator|&
name|oid_ntpMIB
argument_list|,
literal|"The MIB for NTP."
argument_list|,
name|module
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Called, when the module is to be unloaded after it was successfully loaded  */
end_comment

begin_function
specifier|static
name|int
name|ntp_fini
parameter_list|(
name|void
parameter_list|)
block|{
name|or_unregister
argument_list|(
name|reg_index
argument_list|)
expr_stmt|;
name|fd_deselect
argument_list|(
name|ntpd_fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|snmp_module
name|config
init|=
block|{
operator|.
name|comment
operator|=
literal|"This module implements the NTP MIB"
block|,
operator|.
name|init
operator|=
name|ntp_init
block|,
operator|.
name|start
operator|=
name|ntp_start
block|,
operator|.
name|fini
operator|=
name|ntp_fini
block|,
operator|.
name|tree
operator|=
name|ntp_ctree
block|,
operator|.
name|tree_size
operator|=
name|ntp_CTREE_SIZE
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Open the NTPD socket  */
end_comment

begin_function
specifier|static
name|int
name|open_socket
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res
decl_stmt|,
modifier|*
name|res0
decl_stmt|;
name|int
name|error
decl_stmt|;
specifier|const
name|char
modifier|*
name|cause
decl_stmt|;
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|AF_INET
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|error
operator|=
name|getaddrinfo
argument_list|(
name|ntp_host
argument_list|,
name|ntp_port
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s(%s): %s"
argument_list|,
name|ntp_host
argument_list|,
name|ntp_port
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ntpd_sock
operator|=
operator|-
literal|1
expr_stmt|;
name|cause
operator|=
literal|"no address"
expr_stmt|;
name|errno
operator|=
name|EADDRNOTAVAIL
expr_stmt|;
for|for
control|(
name|res
operator|=
name|res0
init|;
name|res
operator|!=
name|NULL
condition|;
name|res
operator|=
name|res
operator|->
name|ai_next
control|)
block|{
name|ntpd_sock
operator|=
name|socket
argument_list|(
name|res
operator|->
name|ai_family
argument_list|,
name|res
operator|->
name|ai_socktype
argument_list|,
name|res
operator|->
name|ai_protocol
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntpd_sock
operator|==
operator|-
literal|1
condition|)
block|{
name|cause
operator|=
literal|"socket"
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|connect
argument_list|(
name|ntpd_sock
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|cause
operator|=
literal|"connect"
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|ntpd_sock
argument_list|)
expr_stmt|;
name|ntpd_sock
operator|=
operator|-
literal|1
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
if|if
condition|(
name|ntpd_sock
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s: %m"
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|freeaddrinfo
argument_list|(
name|res0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Dump a packet  */
end_comment

begin_function
specifier|static
name|void
name|dump_packet
parameter_list|(
specifier|const
name|u_char
modifier|*
name|pkt
parameter_list|,
name|size_t
name|ret
parameter_list|)
block|{
name|char
name|buf
index|[
literal|8
operator|*
literal|3
operator|+
literal|1
index|]
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ret
condition|;
name|i
operator|+=
literal|8
control|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|i
operator|+
name|j
operator|<
operator|(
name|size_t
operator|)
name|ret
operator|&&
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|" %02x"
argument_list|,
name|pkt
index|[
name|i
operator|+
name|j
index|]
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"%04zu:%s"
argument_list|,
name|i
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Execute an NTP request.  */
end_comment

begin_function
specifier|static
name|int
name|ntpd_request
parameter_list|(
name|u_int
name|op
parameter_list|,
name|u_int
name|associd
parameter_list|,
specifier|const
name|char
modifier|*
name|vars
parameter_list|)
block|{
name|u_char
modifier|*
name|rpkt
decl_stmt|;
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|size_t
name|vlen
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|rpkt
operator|=
name|malloc
argument_list|(
name|NTPC_MAX
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%m"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memset
argument_list|(
name|rpkt
argument_list|,
literal|0
argument_list|,
name|NTPC_MAX
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|rpkt
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
operator|(
name|NTPC_VERSION
operator|<<
literal|3
operator|)
operator||
name|NTPC_MODE
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|op
expr_stmt|;
if|if
condition|(
operator|++
name|seqno
operator|==
literal|0
condition|)
name|seqno
operator|++
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|seqno
operator|>>
literal|8
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|seqno
expr_stmt|;
comment|/* skip status */
name|ptr
operator|+=
literal|2
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|associd
operator|>>
literal|8
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|associd
expr_stmt|;
comment|/* skip offset */
name|ptr
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|vars
operator|!=
name|NULL
condition|)
block|{
name|vlen
operator|=
name|strlen
argument_list|(
name|vars
argument_list|)
expr_stmt|;
if|if
condition|(
name|vlen
operator|>
name|NTPC_DMAX
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"NTP request too long (%zu)"
argument_list|,
name|vlen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rpkt
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
name|ptr
operator|++
operator|=
name|vlen
operator|>>
literal|8
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|vlen
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|vars
argument_list|,
name|vlen
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|vlen
expr_stmt|;
block|}
else|else
comment|/* skip data length (is already zero) */
name|ptr
operator|+=
literal|2
expr_stmt|;
while|while
condition|(
operator|(
name|ptr
operator|-
name|rpkt
operator|)
operator|%
literal|4
operator|!=
literal|0
condition|)
operator|*
name|ptr
operator|++
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ntp_debug
operator|&
name|DBG_DUMP_PKTS
condition|)
block|{
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"sending %zd bytes"
argument_list|,
name|ptr
operator|-
name|rpkt
argument_list|)
expr_stmt|;
name|dump_packet
argument_list|(
name|rpkt
argument_list|,
name|ptr
operator|-
name|rpkt
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|send
argument_list|(
name|ntpd_sock
argument_list|,
name|rpkt
argument_list|,
name|ptr
operator|-
name|rpkt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"cannot send to ntpd: %m"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rpkt
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Callback if packet arrived from NTPD  */
end_comment

begin_function
specifier|static
name|int
name|ntpd_read
parameter_list|(
name|uint16_t
modifier|*
name|op
parameter_list|,
name|uint16_t
modifier|*
name|associd
parameter_list|,
name|u_char
modifier|*
modifier|*
name|data
parameter_list|,
name|size_t
modifier|*
name|datalen
parameter_list|)
block|{
name|u_char
name|pkt
index|[
name|NTPC_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|u_char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|nptr
decl_stmt|;
name|u_int
name|n
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|size_t
name|z
decl_stmt|;
name|u_int
name|offset
decl_stmt|;
comment|/* current offset */
name|int
name|more
decl_stmt|;
comment|/* more flag */
name|int
name|sel
decl_stmt|;
name|struct
name|timeval
name|inc
decl_stmt|,
name|end
decl_stmt|,
name|rem
decl_stmt|;
name|fd_set
name|iset
decl_stmt|;
operator|*
name|datalen
operator|=
literal|0
expr_stmt|;
operator|*
name|data
operator|=
name|NULL
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
name|inc
operator|.
name|tv_sec
operator|=
name|ntp_timeout
operator|/
literal|100
expr_stmt|;
name|inc
operator|.
name|tv_usec
operator|=
operator|(
name|ntp_timeout
operator|%
literal|100
operator|)
operator|*
literal|1000
expr_stmt|;
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|end
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|timeradd
argument_list|(
operator|&
name|end
argument_list|,
operator|&
name|inc
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
name|next
label|:
comment|/* compute remaining time */
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|rem
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|timercmp
argument_list|(
operator|&
name|rem
argument_list|,
operator|&
name|end
argument_list|,
operator|>=
argument_list|)
condition|)
block|{
comment|/* do a poll */
name|rem
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|rem
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|timersub
argument_list|(
operator|&
name|end
argument_list|,
operator|&
name|rem
argument_list|,
operator|&
name|rem
argument_list|)
expr_stmt|;
block|}
comment|/* select */
name|FD_ZERO
argument_list|(
operator|&
name|iset
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ntpd_sock
argument_list|,
operator|&
name|iset
argument_list|)
expr_stmt|;
name|sel
operator|=
name|select
argument_list|(
name|ntpd_sock
operator|+
literal|1
argument_list|,
operator|&
name|iset
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|rem
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINTR
condition|)
goto|goto
name|next
goto|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"select ntpd_sock: %m"
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|sel
operator|==
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"timeout on NTP connection"
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* now read it */
name|ret
operator|=
name|recv
argument_list|(
name|ntpd_sock
argument_list|,
name|pkt
argument_list|,
sizeof|sizeof
argument_list|(
name|pkt
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"error reading from ntpd: %m"
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|ntp_debug
operator|&
name|DBG_DUMP_PKTS
condition|)
block|{
name|syslog
argument_list|(
name|LOG_INFO
argument_list|,
literal|"got %zd bytes"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|dump_packet
argument_list|(
name|pkt
argument_list|,
operator|(
name|size_t
operator|)
name|ret
argument_list|)
expr_stmt|;
block|}
name|ptr
operator|=
name|pkt
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ptr
operator|&
literal|0x3f
operator|)
operator|!=
operator|(
operator|(
name|NTPC_VERSION
operator|<<
literal|3
operator|)
operator||
name|NTPC_MODE
operator|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"unexpected packet version 0x%x"
argument_list|,
operator|*
name|ptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
name|ptr
operator|&
name|NTPC_BIT_RESP
operator|)
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"not a response packet"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|ptr
operator|&
name|NTPC_BIT_ERROR
condition|)
block|{
name|z
operator|=
operator|*
name|datalen
operator|-
literal|12
expr_stmt|;
if|if
condition|(
name|z
operator|>
name|NTPC_DMAX
condition|)
name|z
operator|=
name|NTPC_DMAX
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"error response: %.*s"
argument_list|,
operator|(
name|int
operator|)
name|z
argument_list|,
name|pkt
operator|+
literal|12
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|more
operator|=
operator|(
operator|*
name|ptr
operator|&
name|NTPC_BIT_MORE
operator|)
expr_stmt|;
operator|*
name|op
operator|=
operator|*
name|ptr
operator|++
operator|&
name|NTPC_OPMASK
expr_stmt|;
comment|/* seqno */
name|n
operator|=
operator|*
name|ptr
operator|++
operator|<<
literal|8
expr_stmt|;
name|n
operator||=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|seqno
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"expecting seqno %u, got %u"
argument_list|,
name|seqno
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* status */
name|n
operator|=
operator|*
name|ptr
operator|++
operator|<<
literal|8
expr_stmt|;
name|n
operator||=
operator|*
name|ptr
operator|++
expr_stmt|;
comment|/* associd */
operator|*
name|associd
operator|=
operator|*
name|ptr
operator|++
operator|<<
literal|8
expr_stmt|;
operator|*
name|associd
operator||=
operator|*
name|ptr
operator|++
expr_stmt|;
comment|/* offset */
name|n
operator|=
operator|*
name|ptr
operator|++
operator|<<
literal|8
expr_stmt|;
name|n
operator||=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|offset
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"offset: expecting %u, got %u"
argument_list|,
name|offset
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* count */
name|n
operator|=
operator|*
name|ptr
operator|++
operator|<<
literal|8
expr_stmt|;
name|n
operator||=
operator|*
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|ret
operator|<
literal|12
operator|+
name|n
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"packet too short"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|nptr
operator|=
name|realloc
argument_list|(
operator|*
name|data
argument_list|,
operator|*
name|datalen
operator|+
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|nptr
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"cannot allocate memory: %m"
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
name|data
operator|=
name|nptr
expr_stmt|;
name|memcpy
argument_list|(
operator|*
name|data
operator|+
name|offset
argument_list|,
name|ptr
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|datalen
operator|+=
name|n
expr_stmt|;
if|if
condition|(
operator|!
name|more
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|offset
operator|+=
name|n
expr_stmt|;
goto|goto
name|next
goto|;
block|}
end_function

begin_comment
comment|/*  * Send a request and wait for the response  */
end_comment

begin_function
specifier|static
name|int
name|ntpd_dialog
parameter_list|(
name|u_int
name|op
parameter_list|,
name|u_int
name|associd
parameter_list|,
specifier|const
name|char
modifier|*
name|vars
parameter_list|,
name|u_char
modifier|*
modifier|*
name|data
parameter_list|,
name|size_t
modifier|*
name|datalen
parameter_list|)
block|{
name|uint16_t
name|rassocid
decl_stmt|;
name|uint16_t
name|rop
decl_stmt|;
if|if
condition|(
name|ntpd_request
argument_list|(
name|op
argument_list|,
name|associd
argument_list|,
name|vars
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|ntpd_read
argument_list|(
operator|&
name|rop
argument_list|,
operator|&
name|rassocid
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|rop
operator|!=
name|op
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bad response op 0x%x"
argument_list|,
name|rop
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|associd
operator|!=
name|rassocid
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"response for wrong associd"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Callback if packet arrived from NTPD  */
end_comment

begin_function
specifier|static
name|void
name|ntpd_input
parameter_list|(
name|int
name|fd
name|__unused
parameter_list|,
name|void
modifier|*
name|arg
name|__unused
parameter_list|)
block|{
name|uint16_t
name|associd
decl_stmt|;
name|uint16_t
name|op
decl_stmt|;
name|u_char
modifier|*
name|data
decl_stmt|;
name|size_t
name|datalen
decl_stmt|;
if|if
condition|(
name|ntpd_read
argument_list|(
operator|&
name|op
argument_list|,
operator|&
name|associd
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|datalen
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Find the value of a variable  */
end_comment

begin_function
specifier|static
name|int
name|ntpd_parse
parameter_list|(
name|u_char
modifier|*
modifier|*
name|data
parameter_list|,
name|size_t
modifier|*
name|datalen
parameter_list|,
name|char
modifier|*
modifier|*
name|namep
parameter_list|,
name|char
modifier|*
modifier|*
name|valp
parameter_list|)
block|{
name|u_char
modifier|*
name|ptr
init|=
operator|*
name|data
decl_stmt|;
name|u_char
modifier|*
name|end
init|=
name|ptr
operator|+
operator|*
name|datalen
decl_stmt|;
name|char
modifier|*
name|ptr1
decl_stmt|;
name|char
name|endc
decl_stmt|;
comment|/* skip leading spaces */
while|while
condition|(
name|ptr
operator|<
name|end
operator|&&
name|isspace
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ptr
argument_list|)
condition|)
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|end
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|*
name|namep
operator|=
name|ptr
expr_stmt|;
comment|/* skip to space or '=' or ','*/
while|while
condition|(
name|ptr
operator|<
name|end
operator|&&
operator|!
name|isspace
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ptr
argument_list|)
operator|&&
operator|*
name|ptr
operator|!=
literal|'='
operator|&&
operator|*
name|ptr
operator|!=
literal|','
condition|)
name|ptr
operator|++
expr_stmt|;
name|endc
operator|=
operator|*
name|ptr
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|'\0'
expr_stmt|;
comment|/* skip space */
while|while
condition|(
name|ptr
operator|<
name|end
operator|&&
name|isspace
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ptr
argument_list|)
condition|)
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|end
operator|||
name|endc
operator|==
literal|','
condition|)
block|{
comment|/* no value */
operator|*
name|valp
operator|=
name|NULL
expr_stmt|;
operator|*
name|datalen
operator|-=
name|ptr
operator|-
operator|*
name|data
expr_stmt|;
operator|*
name|data
operator|=
name|ptr
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'"'
condition|)
block|{
comment|/* quoted */
name|ptr
operator|++
expr_stmt|;
operator|*
name|valp
operator|=
name|ptr
expr_stmt|;
while|while
condition|(
name|ptr
operator|<
name|end
operator|&&
operator|*
name|ptr
operator|!=
literal|'"'
condition|)
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|end
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|*
name|ptr
operator|++
operator|=
literal|'\0'
expr_stmt|;
comment|/* find comma */
while|while
condition|(
name|ptr
operator|<
name|end
operator|&&
name|isspace
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ptr
argument_list|)
operator|&&
operator|*
name|ptr
operator|==
literal|','
condition|)
name|ptr
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|*
name|valp
operator|=
name|ptr
expr_stmt|;
comment|/* skip to end of value */
while|while
condition|(
name|ptr
operator|<
name|end
operator|&&
operator|*
name|ptr
operator|!=
literal|','
condition|)
name|ptr
operator|++
expr_stmt|;
comment|/* remove trailing blanks */
for|for
control|(
name|ptr1
operator|=
name|ptr
init|;
name|ptr1
operator|>
operator|*
name|valp
condition|;
name|ptr1
operator|--
control|)
if|if
condition|(
operator|!
name|isspace
argument_list|(
operator|(
name|int
operator|)
name|ptr1
index|[
operator|-
literal|1
index|]
argument_list|)
condition|)
break|break;
operator|*
name|ptr1
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|ptr
operator|<
name|end
condition|)
name|ptr
operator|++
expr_stmt|;
block|}
operator|*
name|datalen
operator|-=
name|ptr
operator|-
operator|*
name|data
expr_stmt|;
operator|*
name|data
operator|=
name|ptr
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Parse an int32 value  */
end_comment

begin_function
specifier|static
name|int
name|val_parse_int32
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int32_t
modifier|*
name|p
parameter_list|,
name|int32_t
name|min
parameter_list|,
name|int32_t
name|max
parameter_list|,
name|int
name|base
parameter_list|)
block|{
name|long
name|n
decl_stmt|;
name|char
modifier|*
name|end
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|n
operator|=
name|strtol
argument_list|(
name|val
argument_list|,
operator|&
name|end
argument_list|,
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
operator|||
operator|*
name|end
operator|!=
literal|'\0'
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|n
operator|<
name|min
operator|||
name|n
operator|>
name|max
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|*
name|p
operator|=
operator|(
name|int32_t
operator|)
name|n
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Parse an uint32 value  */
end_comment

begin_function
specifier|static
name|int
name|val_parse_uint32
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|uint32_t
modifier|*
name|p
parameter_list|,
name|uint32_t
name|min
parameter_list|,
name|uint32_t
name|max
parameter_list|,
name|int
name|base
parameter_list|)
block|{
name|u_long
name|n
decl_stmt|;
name|char
modifier|*
name|end
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|n
operator|=
name|strtoul
argument_list|(
name|val
argument_list|,
operator|&
name|end
argument_list|,
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
operator|||
operator|*
name|end
operator|!=
literal|'\0'
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|n
operator|<
name|min
operator|||
name|n
operator|>
name|max
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|*
name|p
operator|=
operator|(
name|uint32_t
operator|)
name|n
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Parse a double  */
end_comment

begin_function
specifier|static
name|int
name|val_parse_double
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|double
modifier|*
name|p
parameter_list|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
operator|*
name|p
operator|=
name|strtod
argument_list|(
name|val
argument_list|,
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
operator|||
operator|*
name|end
operator|!=
literal|'\0'
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|val_parse_ts
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|r
decl_stmt|,
name|n
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|f
decl_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|val
argument_list|)
operator|>
literal|2
operator|&&
name|val
index|[
literal|0
index|]
operator|==
literal|'0'
operator|&&
name|val
index|[
literal|1
index|]
operator|==
literal|'x'
condition|)
block|{
comment|/* hex format */
name|r
operator|=
name|sscanf
argument_list|(
name|val
operator|+
literal|2
argument_list|,
literal|"%x.%x%n"
argument_list|,
operator|&
name|i
argument_list|,
operator|&
name|f
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
literal|2
operator|||
operator|(
name|size_t
operator|)
name|n
operator|!=
name|strlen
argument_list|(
name|val
operator|+
literal|2
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
comment|/* probably decimal */
name|r
operator|=
name|sscanf
argument_list|(
name|val
argument_list|,
literal|"%d.%d%n"
argument_list|,
operator|&
name|i
argument_list|,
operator|&
name|f
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
literal|2
operator|||
operator|(
name|size_t
operator|)
name|n
operator|!=
name|strlen
argument_list|(
name|val
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|buf
index|[
literal|0
index|]
operator|=
name|i
operator|>>
literal|24
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|i
operator|>>
literal|16
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|i
operator|>>
literal|8
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
name|i
operator|>>
literal|0
expr_stmt|;
name|buf
index|[
literal|4
index|]
operator|=
name|f
operator|>>
literal|24
expr_stmt|;
name|buf
index|[
literal|5
index|]
operator|=
name|f
operator|>>
literal|16
expr_stmt|;
name|buf
index|[
literal|6
index|]
operator|=
name|f
operator|>>
literal|8
expr_stmt|;
name|buf
index|[
literal|7
index|]
operator|=
name|f
operator|>>
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Parse an IP address. This resolves non-numeric names.  */
end_comment

begin_function
specifier|static
name|int
name|val_parse_ip
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|u_char
name|ip
index|[
literal|4
index|]
parameter_list|)
block|{
name|int
name|r
decl_stmt|,
name|n
decl_stmt|,
name|error
decl_stmt|;
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res0
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin_local
decl_stmt|;
name|r
operator|=
name|sscanf
argument_list|(
name|val
argument_list|,
literal|"%hhd.%hhd.%hhd.%hhd%n"
argument_list|,
operator|&
name|ip
index|[
literal|0
index|]
argument_list|,
operator|&
name|ip
index|[
literal|1
index|]
argument_list|,
operator|&
name|ip
index|[
literal|2
index|]
argument_list|,
operator|&
name|ip
index|[
literal|3
index|]
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|4
operator|&&
operator|(
name|size_t
operator|)
name|n
operator|==
name|strlen
argument_list|(
name|val
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|memset
argument_list|(
name|ip
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|AF_INET
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|error
operator|=
name|getaddrinfo
argument_list|(
name|val
argument_list|,
name|NULL
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s: %s"
argument_list|,
name|val
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|res0
operator|==
name|NULL
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s: no address"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sin_local
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|res0
operator|->
name|ai_addr
expr_stmt|;
name|ip
index|[
literal|3
index|]
operator|=
name|sin_local
operator|->
name|sin_addr
operator|.
name|s_addr
operator|>>
literal|24
expr_stmt|;
name|ip
index|[
literal|2
index|]
operator|=
name|sin_local
operator|->
name|sin_addr
operator|.
name|s_addr
operator|>>
literal|16
expr_stmt|;
name|ip
index|[
literal|1
index|]
operator|=
name|sin_local
operator|->
name|sin_addr
operator|.
name|s_addr
operator|>>
literal|8
expr_stmt|;
name|ip
index|[
literal|0
index|]
operator|=
name|sin_local
operator|->
name|sin_addr
operator|.
name|s_addr
operator|>>
literal|0
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fetch system info  */
end_comment

begin_function
specifier|static
name|int
name|fetch_sysinfo
parameter_list|(
name|void
parameter_list|)
block|{
name|u_char
modifier|*
name|data
decl_stmt|;
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|size_t
name|datalen
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
if|if
condition|(
name|ntpd_dialog
argument_list|(
name|NTPC_OP_READVAR
argument_list|,
literal|0
argument_list|,
literal|"leap,stratum,precision,rootdelay,rootdispersion,refid,reftime,"
literal|"poll,peer,clock,system,processor,jitter,stability"
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|datalen
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* clear info */
name|sysb_leap
operator|=
literal|0
expr_stmt|;
name|sysb_stratum
operator|=
literal|0
expr_stmt|;
name|sysb_precision
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|sys_rootdelay
argument_list|)
expr_stmt|;
name|sys_rootdelay
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|sys_rootdispersion
argument_list|)
expr_stmt|;
name|sys_rootdispersion
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|sys_refid
argument_list|)
expr_stmt|;
name|sys_refid
operator|=
name|NULL
expr_stmt|;
name|sysb_reftime
operator|=
literal|0
expr_stmt|;
name|sysb_poll
operator|=
literal|0
expr_stmt|;
name|sysb_peer
operator|=
literal|0
expr_stmt|;
name|sysb_clock
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|sys_system
argument_list|)
expr_stmt|;
name|sys_system
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|sys_processor
argument_list|)
expr_stmt|;
name|sys_processor
operator|=
name|NULL
expr_stmt|;
name|sysb_jitter
operator|=
literal|0
expr_stmt|;
name|sysb_stability
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|data
expr_stmt|;
while|while
condition|(
name|ntpd_parse
argument_list|(
operator|&
name|ptr
argument_list|,
operator|&
name|datalen
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|val
argument_list|)
condition|)
block|{
if|if
condition|(
name|ntp_debug
operator|&
name|DBG_DUMP_VARS
condition|)
name|syslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"%s: '%s'='%s'"
argument_list|,
name|__func__
argument_list|,
name|name
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"leap"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.leap"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysb_leap
operator|=
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|sys_leap
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"stratum"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.stratum"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysb_stratum
operator|=
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|sys_stratum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"precision"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.precision"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysb_precision
operator|=
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|sys_precision
argument_list|,
name|INT32_MIN
argument_list|,
name|INT32_MAX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"rootdelay"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.rootdelay"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sys_rootdelay
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"rootdispersion"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.rootdispersion"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sys_rootdispersion
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"refid"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.refid"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sys_refid
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"reftime"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.reftime"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysb_reftime
operator|=
name|val_parse_ts
argument_list|(
name|val
argument_list|,
name|sys_reftime
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"poll"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.poll"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysb_poll
operator|=
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|sys_poll
argument_list|,
name|INT32_MIN
argument_list|,
name|INT32_MAX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.peer"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysb_peer
operator|=
name|val_parse_uint32
argument_list|(
name|val
argument_list|,
operator|&
name|sys_peer
argument_list|,
literal|0
argument_list|,
name|UINT32_MAX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"clock"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.clock"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysb_clock
operator|=
name|val_parse_ts
argument_list|(
name|val
argument_list|,
name|sys_clock
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"system"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.system"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sys_system
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"processor"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.processor"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sys_processor
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"jitter"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.jitter"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysb_jitter
operator|=
name|val_parse_double
argument_list|(
name|val
argument_list|,
operator|&
name|sys_jitter
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"stability"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.stability"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysb_stability
operator|=
name|val_parse_double
argument_list|(
name|val
argument_list|,
operator|&
name|sys_stability
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_filt
parameter_list|(
name|char
modifier|*
name|val
parameter_list|,
name|uint16_t
name|associd
parameter_list|,
name|int
name|which
parameter_list|)
block|{
name|char
modifier|*
name|w
decl_stmt|;
name|int
name|cnt
decl_stmt|;
name|struct
name|filt
modifier|*
name|f
decl_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|w
operator|=
name|strtok
argument_list|(
name|val
argument_list|,
literal|" \t"
argument_list|)
init|;
name|w
operator|!=
name|NULL
condition|;
name|w
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|" \t"
argument_list|)
control|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|f
argument_list|,
argument|&filts
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|f
operator|->
name|index
operator|.
name|subs
index|[
literal|0
index|]
operator|==
name|associd
operator|&&
name|f
operator|->
name|index
operator|.
name|subs
index|[
literal|1
index|]
operator|==
call|(
name|asn_subid_t
call|)
argument_list|(
name|cnt
operator|+
literal|1
argument_list|)
condition|)
break|break;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|f
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|f
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|f
operator|->
name|index
operator|.
name|len
operator|=
literal|2
expr_stmt|;
name|f
operator|->
name|index
operator|.
name|subs
index|[
literal|0
index|]
operator|=
name|associd
expr_stmt|;
name|f
operator|->
name|index
operator|.
name|subs
index|[
literal|1
index|]
operator|=
name|cnt
operator|+
literal|1
expr_stmt|;
name|INSERT_OBJECT_OID
argument_list|(
name|f
argument_list|,
operator|&
name|filts
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|which
condition|)
block|{
case|case
literal|0
case|:
name|f
operator|->
name|offset
operator|=
name|strdup
argument_list|(
name|w
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|f
operator|->
name|delay
operator|=
name|strdup
argument_list|(
name|w
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|f
operator|->
name|dispersion
operator|=
name|strdup
argument_list|(
name|w
argument_list|)
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
name|cnt
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|cnt
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Fetch the complete peer list  */
end_comment

begin_function
specifier|static
name|int
name|fetch_peers
parameter_list|(
name|void
parameter_list|)
block|{
name|u_char
modifier|*
name|data
decl_stmt|,
modifier|*
name|pdata
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|size_t
name|datalen
decl_stmt|,
name|pdatalen
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|peer
modifier|*
name|p
decl_stmt|;
name|struct
name|filt
modifier|*
name|f
decl_stmt|;
name|uint16_t
name|associd
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|val
decl_stmt|;
comment|/* free the old list */
while|while
condition|(
operator|(
name|p
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|peers
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|peers
argument_list|,
name|p
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|rootdelay
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|rootdispersion
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|refid
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|offset
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|delay
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
operator|->
name|dispersion
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|f
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|filts
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|filts
argument_list|,
name|f
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
operator|->
name|offset
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
operator|->
name|delay
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
operator|->
name|dispersion
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
comment|/* fetch the list of associations */
if|if
condition|(
name|ntpd_dialog
argument_list|(
name|NTPC_OP_READSTAT
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|datalen
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
call|(
name|int
call|)
argument_list|(
name|datalen
operator|/
literal|4
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|associd
operator|=
name|data
index|[
literal|4
operator|*
name|i
operator|+
literal|0
index|]
operator|<<
literal|8
expr_stmt|;
name|associd
operator||=
name|data
index|[
literal|4
operator|*
name|i
operator|+
literal|1
index|]
operator|<<
literal|0
expr_stmt|;
comment|/* ask for the association variables */
if|if
condition|(
name|ntpd_dialog
argument_list|(
name|NTPC_OP_READVAR
argument_list|,
name|associd
argument_list|,
literal|"config,srcadr,srcport,dstadr,dstport,leap,hmode,stratum,"
literal|"hpoll,ppoll,precision,rootdelay,rootdispersion,refid,"
literal|"reftime,org,rec,xmt,reach,timer,offset,delay,dispersion,"
literal|"filtdelay,filtoffset,filtdisp"
argument_list|,
operator|&
name|pdata
argument_list|,
operator|&
name|pdatalen
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* now save and parse the data */
name|p
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%m"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|index
operator|=
name|associd
expr_stmt|;
name|INSERT_OBJECT_INT
argument_list|(
name|p
argument_list|,
operator|&
name|peers
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|pdata
expr_stmt|;
while|while
condition|(
name|ntpd_parse
argument_list|(
operator|&
name|ptr
argument_list|,
operator|&
name|pdatalen
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|val
argument_list|)
condition|)
block|{
if|if
condition|(
name|ntp_debug
operator|&
name|DBG_DUMP_VARS
condition|)
name|syslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"%s: '%s'='%s'"
argument_list|,
name|__func__
argument_list|,
name|name
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"config"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.config"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|config
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"srcadr"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.srcadr"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_ip
argument_list|(
name|val
argument_list|,
name|p
operator|->
name|srcadr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"srcport"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.srcport"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_uint32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|srcport
argument_list|,
literal|1
argument_list|,
literal|65535
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"dstadr"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.dstadr"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_ip
argument_list|(
name|val
argument_list|,
name|p
operator|->
name|dstadr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"dstport"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.dstport"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_uint32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|dstport
argument_list|,
literal|1
argument_list|,
literal|65535
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"leap"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.leap"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|leap
argument_list|,
literal|0
argument_list|,
literal|3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"hmode"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.hmode"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|hmode
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"stratum"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.stratum"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|stratum
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"ppoll"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.ppoll"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|ppoll
argument_list|,
name|INT32_MIN
argument_list|,
name|INT32_MAX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"hpoll"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.hpoll"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|hpoll
argument_list|,
name|INT32_MIN
argument_list|,
name|INT32_MAX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"precision"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.precision"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|hpoll
argument_list|,
name|INT32_MIN
argument_list|,
name|INT32_MAX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"rootdelay"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.rootdelay"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|rootdelay
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"rootdispersion"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.rootdispersion"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|rootdispersion
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"refid"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.refid"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|refid
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"reftime"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.reftime"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_ts
argument_list|(
name|val
argument_list|,
name|p
operator|->
name|reftime
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"org"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.org"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_ts
argument_list|(
name|val
argument_list|,
name|p
operator|->
name|orgtime
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"rec"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.rec"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_ts
argument_list|(
name|val
argument_list|,
name|p
operator|->
name|rcvtime
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"xmt"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"sys.xmt"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_ts
argument_list|(
name|val
argument_list|,
name|p
operator|->
name|xmttime
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"reach"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.reach"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_uint32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|reach
argument_list|,
literal|0
argument_list|,
literal|65535
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"timer"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.timer"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val_parse_int32
argument_list|(
name|val
argument_list|,
operator|&
name|p
operator|->
name|timer
argument_list|,
name|INT32_MIN
argument_list|,
name|INT32_MAX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"offset"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.offset"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|offset
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"delay"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.delay"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|delay
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"dispersion"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.dispersion"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|dispersion
operator|=
name|strdup
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"filtdelay"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.filtdelay"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|filt_entries
operator|=
name|parse_filt
argument_list|(
name|val
argument_list|,
name|associd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"filtoffset"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.filtoffset"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|filt_entries
operator|=
name|parse_filt
argument_list|(
name|val
argument_list|,
name|associd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"filtdisp"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"peer.filtdisp"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|filt_entries
operator|=
name|parse_filt
argument_list|(
name|val
argument_list|,
name|associd
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|pdata
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * System variables - read-only scalars only.  */
end_comment

begin_function
name|int
name|op_ntpSystem
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GETNEXT
case|:
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
name|this_tick
operator|>
name|sysinfo_tick
condition|)
block|{
if|if
condition|(
name|fetch_sysinfo
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|sysinfo_tick
operator|=
name|this_tick
expr_stmt|;
block|}
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_ntpSysLeap
case|:
if|if
condition|(
operator|!
name|sysb_leap
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|sys_leap
expr_stmt|;
break|break;
case|case
name|LEAF_ntpSysStratum
case|:
if|if
condition|(
operator|!
name|sysb_stratum
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|sys_stratum
expr_stmt|;
break|break;
case|case
name|LEAF_ntpSysPrecision
case|:
if|if
condition|(
operator|!
name|sysb_precision
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|sys_precision
expr_stmt|;
break|break;
case|case
name|LEAF_ntpSysRootDelay
case|:
if|if
condition|(
name|sys_rootdelay
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|sys_rootdelay
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpSysRootDispersion
case|:
if|if
condition|(
name|sys_rootdispersion
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|sys_rootdispersion
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpSysRefId
case|:
if|if
condition|(
name|sys_refid
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|sys_refid
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpSysRefTime
case|:
if|if
condition|(
name|sysb_reftime
operator|==
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|sys_reftime
argument_list|,
literal|8
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpSysPoll
case|:
if|if
condition|(
name|sysb_poll
operator|==
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|sys_poll
expr_stmt|;
break|break;
case|case
name|LEAF_ntpSysPeer
case|:
if|if
condition|(
name|sysb_peer
operator|==
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|sys_peer
expr_stmt|;
break|break;
case|case
name|LEAF_ntpSysClock
case|:
if|if
condition|(
name|sysb_clock
operator|==
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|sys_clock
argument_list|,
literal|8
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpSysSystem
case|:
if|if
condition|(
name|sys_system
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|sys_system
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpSysProcessor
case|:
if|if
condition|(
name|sys_processor
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|sys_processor
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_SET
case|:
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
case|case
name|SNMP_OP_ROLLBACK
case|:
name|abort
argument_list|()
expr_stmt|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|op_ntpPeersVarTable
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|iidx
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|uint32_t
name|peer
decl_stmt|;
name|struct
name|peer
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|this_tick
operator|>
name|peers_tick
condition|)
block|{
if|if
condition|(
name|fetch_peers
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|peers_tick
operator|=
name|this_tick
expr_stmt|;
block|}
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GETNEXT
case|:
name|t
operator|=
name|NEXT_OBJECT_INT
argument_list|(
operator|&
name|peers
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|var
operator|.
name|len
operator|=
name|sub
operator|+
literal|1
expr_stmt|;
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
operator|=
name|t
operator|->
name|index
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GET
case|:
name|t
operator|=
name|FIND_OBJECT_INT
argument_list|(
operator|&
name|peers
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
name|index_decode
argument_list|(
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|iidx
argument_list|,
operator|&
name|peer
argument_list|)
condition|)
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
name|t
operator|=
name|FIND_OBJECT_INT
argument_list|(
operator|&
name|peers
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|!=
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
case|case
name|SNMP_OP_ROLLBACK
case|:
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
comment|/* 	 * Come here for GET and COMMIT 	 */
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_ntpPeersConfigured
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|t
operator|->
name|config
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersPeerAddress
case|:
return|return
operator|(
name|ip_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|srcadr
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersPeerPort
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|t
operator|->
name|srcport
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersHostAddress
case|:
return|return
operator|(
name|ip_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|dstadr
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersHostPort
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|t
operator|->
name|dstport
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersLeap
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|t
operator|->
name|leap
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersMode
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|t
operator|->
name|hmode
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersStratum
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|t
operator|->
name|stratum
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersPeerPoll
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|t
operator|->
name|ppoll
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersHostPoll
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|t
operator|->
name|hpoll
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersPrecision
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|t
operator|->
name|precision
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersRootDelay
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|rootdelay
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersRootDispersion
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|rootdispersion
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersRefId
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|refid
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersRefTime
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|reftime
argument_list|,
literal|8
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersOrgTime
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|orgtime
argument_list|,
literal|8
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersReceiveTime
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|rcvtime
argument_list|,
literal|8
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersTransmitTime
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|xmttime
argument_list|,
literal|8
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersReach
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|t
operator|->
name|reach
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersTimer
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|t
operator|->
name|timer
expr_stmt|;
break|break;
case|case
name|LEAF_ntpPeersOffset
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|offset
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersDelay
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|delay
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpPeersDispersion
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|dispersion
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_ntpFilterPeersVarTable
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|iidx
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|uint32_t
name|peer
decl_stmt|;
name|struct
name|peer
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|this_tick
operator|>
name|peers_tick
condition|)
block|{
if|if
condition|(
name|fetch_peers
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|peers_tick
operator|=
name|this_tick
expr_stmt|;
block|}
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GETNEXT
case|:
name|t
operator|=
name|NEXT_OBJECT_INT
argument_list|(
operator|&
name|peers
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|var
operator|.
name|len
operator|=
name|sub
operator|+
literal|1
expr_stmt|;
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
operator|=
name|t
operator|->
name|index
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GET
case|:
name|t
operator|=
name|FIND_OBJECT_INT
argument_list|(
operator|&
name|peers
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
name|index_decode
argument_list|(
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|iidx
argument_list|,
operator|&
name|peer
argument_list|)
condition|)
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
name|t
operator|=
name|FIND_OBJECT_INT
argument_list|(
operator|&
name|peers
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|!=
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
case|case
name|SNMP_OP_ROLLBACK
case|:
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
comment|/* 	 * Come here for GET and COMMIT 	 */
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_ntpFilterValidEntries
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|t
operator|->
name|filt_entries
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_ntpFilterRegisterTable
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
name|__unused
parameter_list|,
name|u_int
name|sub
name|__unused
parameter_list|,
name|u_int
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
name|__unused
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|uint32_t
name|peer
decl_stmt|;
name|uint32_t
name|filt
decl_stmt|;
name|struct
name|filt
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|this_tick
operator|>
name|peers_tick
condition|)
block|{
if|if
condition|(
name|fetch_peers
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|peers_tick
operator|=
name|this_tick
expr_stmt|;
block|}
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GETNEXT
case|:
name|t
operator|=
name|NEXT_OBJECT_OID
argument_list|(
operator|&
name|filts
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|index_append
argument_list|(
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|,
operator|&
name|t
operator|->
name|index
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GET
case|:
name|t
operator|=
name|FIND_OBJECT_OID
argument_list|(
operator|&
name|filts
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
name|index_decode
argument_list|(
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|iidx
argument_list|,
operator|&
name|peer
argument_list|,
operator|&
name|filt
argument_list|)
condition|)
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
name|t
operator|=
name|FIND_OBJECT_OID
argument_list|(
operator|&
name|filts
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|!=
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
case|case
name|SNMP_OP_ROLLBACK
case|:
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
comment|/* 	 * Come here for GET and COMMIT 	 */
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_ntpFilterPeersOffset
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|offset
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpFilterPeersDelay
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|delay
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_ntpFilterPeersDispersion
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|t
operator|->
name|dispersion
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * System variables - read-only scalars only.  */
end_comment

begin_function
name|int
name|op_begemot_ntp
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|asn_subid_t
name|which
init|=
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GETNEXT
case|:
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_GET
case|:
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_begemotNtpHost
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|ntp_host
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_begemotNtpPort
case|:
return|return
operator|(
name|string_get
argument_list|(
name|value
argument_list|,
name|ntp_port
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_begemotNtpTimeout
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ntp_timeout
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpDebug
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ntp_debug
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpJitter
case|:
if|if
condition|(
name|this_tick
operator|>
name|sysinfo_tick
condition|)
block|{
if|if
condition|(
name|fetch_sysinfo
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|sysinfo_tick
operator|=
name|this_tick
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|sysb_jitter
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
name|sys_jitter
operator|/
literal|1000
operator|*
operator|(
literal|1ULL
operator|<<
literal|32
operator|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpStability
case|:
if|if
condition|(
name|this_tick
operator|>
name|sysinfo_tick
condition|)
block|{
if|if
condition|(
name|fetch_sysinfo
argument_list|()
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|sysinfo_tick
operator|=
name|this_tick
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|sysb_stability
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
name|sys_stability
operator|*
operator|(
literal|1ULL
operator|<<
literal|32
operator|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_SET
case|:
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_begemotNtpHost
case|:
comment|/* only at initialization */
if|if
condition|(
name|community
operator|!=
name|COMM_INITIALIZE
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
operator|(
name|ret
operator|=
name|string_save
argument_list|(
name|value
argument_list|,
name|ctx
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|ntp_host
argument_list|)
operator|)
operator|!=
name|SNMP_ERR_NOERROR
condition|)
return|return
operator|(
name|ret
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpPort
case|:
comment|/* only at initialization */
if|if
condition|(
name|community
operator|!=
name|COMM_INITIALIZE
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
operator|(
name|ret
operator|=
name|string_save
argument_list|(
name|value
argument_list|,
name|ctx
argument_list|,
operator|-
literal|1
argument_list|,
operator|&
name|ntp_port
argument_list|)
operator|)
operator|!=
name|SNMP_ERR_NOERROR
condition|)
return|return
operator|(
name|ret
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpTimeout
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|ntp_timeout
expr_stmt|;
if|if
condition|(
name|value
operator|->
name|v
operator|.
name|uint32
operator|<
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
name|ntp_timeout
operator|=
name|value
operator|->
name|v
operator|.
name|integer
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpDebug
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|ntp_debug
expr_stmt|;
name|ntp_debug
operator|=
name|value
operator|->
name|v
operator|.
name|integer
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_ROLLBACK
case|:
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_begemotNtpHost
case|:
name|string_rollback
argument_list|(
name|ctx
argument_list|,
operator|&
name|ntp_host
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpPort
case|:
name|string_rollback
argument_list|(
name|ctx
argument_list|,
operator|&
name|ntp_port
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpTimeout
case|:
name|ntp_timeout
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|int1
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpDebug
case|:
name|ntp_debug
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|int1
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_COMMIT
case|:
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|LEAF_begemotNtpHost
case|:
name|string_commit
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpPort
case|:
name|string_commit
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_begemotNtpTimeout
case|:
case|case
name|LEAF_begemotNtpDebug
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2001-2003  *	Fraunhofer Institute for Open Communication Systems (FhG Fokus).  *	All rights reserved.  *  * Author: Harti Brandt<harti@freebsd.org>  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *   * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Begemot: bsnmp/snmp_mibII/mibII_interfaces.c,v 1.16 2005/11/02 12:07:40 brandt_h Exp $  *  * Interfaces group.  */
end_comment

begin_include
include|#
directive|include
file|"mibII.h"
end_include

begin_include
include|#
directive|include
file|"mibII_oid.h"
end_include

begin_comment
comment|/*  * This structure catches all changes to a interface entry  */
end_comment

begin_struct
struct|struct
name|ifchange
block|{
name|struct
name|snmp_dependency
name|dep
decl_stmt|;
name|u_int
name|ifindex
decl_stmt|;
name|uint32_t
name|set
decl_stmt|;
name|int
name|promisc
decl_stmt|;
name|int
name|admin
decl_stmt|;
name|int
name|traps
decl_stmt|;
name|uint32_t
name|rb
decl_stmt|;
name|int
name|rb_flags
decl_stmt|;
name|int
name|rb_traps
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|IFC_PROMISC
value|0x0001
end_define

begin_define
define|#
directive|define
name|IFC_ADMIN
value|0x0002
end_define

begin_define
define|#
directive|define
name|IFC_TRAPS
value|0x0004
end_define

begin_define
define|#
directive|define
name|IFRB_FLAGS
value|0x0001
end_define

begin_define
define|#
directive|define
name|IFRB_TRAPS
value|0x0002
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|oid_ifTable
init|=
name|OIDX_ifTable
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * This function handles all changes to the interface table and interface  * extension table.  */
end_comment

begin_function
specifier|static
name|int
name|ifchange_func
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_dependency
modifier|*
name|dep
parameter_list|,
name|enum
name|snmp_depop
name|op
parameter_list|)
block|{
name|struct
name|ifchange
modifier|*
name|ifc
init|=
operator|(
expr|struct
name|ifchange
operator|*
operator|)
name|dep
decl_stmt|;
name|struct
name|mibif
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|,
name|ifr1
decl_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|=
name|mib_find_if
argument_list|(
name|ifc
operator|->
name|ifindex
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_DEPOP_COMMIT
case|:
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifp
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|mib_netsock
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"GIFFLAGS(%s): %m"
argument_list|,
name|ifp
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
block|}
if|if
condition|(
name|ifc
operator|->
name|set
operator|&
name|IFC_PROMISC
condition|)
block|{
name|ifr
operator|.
name|ifr_flags
operator|&=
operator|~
name|IFF_PROMISC
expr_stmt|;
if|if
condition|(
name|ifc
operator|->
name|promisc
condition|)
name|ifr
operator|.
name|ifr_flags
operator||=
name|IFF_PROMISC
expr_stmt|;
name|ifc
operator|->
name|rb
operator||=
name|IFRB_FLAGS
expr_stmt|;
block|}
if|if
condition|(
name|ifc
operator|->
name|set
operator|&
name|IFC_ADMIN
condition|)
block|{
name|ifr
operator|.
name|ifr_flags
operator|&=
operator|~
name|IFF_UP
expr_stmt|;
if|if
condition|(
name|ifc
operator|->
name|admin
condition|)
name|ifr
operator|.
name|ifr_flags
operator||=
name|IFF_UP
expr_stmt|;
name|ifc
operator|->
name|rb
operator||=
name|IFRB_FLAGS
expr_stmt|;
block|}
if|if
condition|(
name|ifc
operator|->
name|rb
operator|&
name|IFRB_FLAGS
condition|)
block|{
name|strncpy
argument_list|(
name|ifr1
operator|.
name|ifr_name
argument_list|,
name|ifp
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr1
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|mib_netsock
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|&
name|ifr1
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"GIFFLAGS(%s): %m"
argument_list|,
name|ifp
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
block|}
name|ifc
operator|->
name|rb_flags
operator|=
name|ifr1
operator|.
name|ifr_flags
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|mib_netsock
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"SIFFLAGS(%s): %m"
argument_list|,
name|ifp
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|mib_fetch_ifmib
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ifc
operator|->
name|set
operator|&
name|IFC_TRAPS
condition|)
block|{
name|ifc
operator|->
name|rb
operator||=
name|IFRB_TRAPS
expr_stmt|;
name|ifc
operator|->
name|rb_traps
operator|=
name|ifp
operator|->
name|trap_enable
expr_stmt|;
name|ifp
operator|->
name|trap_enable
operator|=
name|ifc
operator|->
name|traps
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_DEPOP_ROLLBACK
case|:
if|if
condition|(
name|ifc
operator|->
name|rb
operator|&
name|IFRB_FLAGS
condition|)
block|{
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifp
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_flags
operator|=
name|ifc
operator|->
name|rb_flags
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|mib_netsock
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"SIFFLAGS(%s): %m"
argument_list|,
name|ifp
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_UNDO_FAILED
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|mib_fetch_ifmib
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ifc
operator|->
name|rb
operator|&
name|IFRB_TRAPS
condition|)
name|ifp
operator|->
name|trap_enable
operator|=
name|ifc
operator|->
name|rb_traps
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_DEPOP_FINISH
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Return difference to daemon start time in ticks truncated to a  * 32-bit value. If the timeval is 0 then return 0.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|ticks_get_timeval
parameter_list|(
name|struct
name|timeval
modifier|*
name|tv
parameter_list|)
block|{
name|uint64_t
name|v
decl_stmt|;
if|if
condition|(
name|tv
operator|->
name|tv_sec
operator|!=
literal|0
operator|||
name|tv
operator|->
name|tv_usec
operator|!=
literal|0
condition|)
block|{
name|v
operator|=
literal|100ULL
operator|*
name|tv
operator|->
name|tv_sec
operator|+
name|tv
operator|->
name|tv_usec
operator|/
literal|10000ULL
expr_stmt|;
if|if
condition|(
name|v
operator|>
name|start_tick
condition|)
return|return
operator|(
name|v
operator|-
name|start_tick
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Scalars  */
end_comment

begin_function
name|int
name|op_interfaces
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|idx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GETNEXT
case|:
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_GET
case|:
break|break;
case|case
name|SNMP_OP_SET
case|:
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
case|case
name|SNMP_OP_ROLLBACK
case|:
case|case
name|SNMP_OP_COMMIT
case|:
name|abort
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_ifNumber
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|mib_if_number
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Iftable entry  */
end_comment

begin_function
name|int
name|op_ifentry
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|struct
name|mibif
modifier|*
name|ifp
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|ifchange
modifier|*
name|ifc
decl_stmt|;
name|struct
name|asn_oid
name|idx
decl_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|ifp
operator|=
name|NEXT_OBJECT_INT
argument_list|(
operator|&
name|mibif_list
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|var
operator|.
name|len
operator|=
name|sub
operator|+
literal|1
expr_stmt|;
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
operator|=
name|ifp
operator|->
name|index
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
name|value
operator|->
name|var
operator|.
name|len
operator|-
name|sub
operator|!=
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
operator|(
name|ifp
operator|=
name|mib_find_if
argument_list|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
name|value
operator|->
name|var
operator|.
name|len
operator|-
name|sub
operator|!=
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
if|if
condition|(
operator|(
name|ifp
operator|=
name|mib_find_if
argument_list|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
if|if
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|!=
name|LEAF_ifAdminStatus
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
name|idx
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|idx
operator|.
name|subs
index|[
literal|0
index|]
operator|=
name|ifp
operator|->
name|index
expr_stmt|;
if|if
condition|(
name|value
operator|->
name|v
operator|.
name|integer
operator|!=
literal|1
operator|&&
name|value
operator|->
name|v
operator|.
name|integer
operator|!=
literal|2
condition|)
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
if|if
condition|(
operator|(
name|ifc
operator|=
operator|(
expr|struct
name|ifchange
operator|*
operator|)
name|snmp_dep_lookup
argument_list|(
name|ctx
argument_list|,
operator|&
name|oid_ifTable
argument_list|,
operator|&
name|idx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ifc
argument_list|)
argument_list|,
name|ifchange_func
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_RES_UNAVAIL
operator|)
return|;
name|ifc
operator|->
name|ifindex
operator|=
name|ifp
operator|->
name|index
expr_stmt|;
if|if
condition|(
name|ifc
operator|->
name|set
operator|&
name|IFC_ADMIN
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|ifc
operator|->
name|set
operator||=
name|IFC_ADMIN
expr_stmt|;
name|ifc
operator|->
name|admin
operator|=
operator|(
name|value
operator|->
name|v
operator|.
name|integer
operator|==
literal|1
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_ROLLBACK
case|:
case|case
name|SNMP_OP_COMMIT
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
if|if
condition|(
name|ifp
operator|->
name|mibtick
operator|<
name|this_tick
condition|)
operator|(
name|void
operator|)
name|mib_fetch_ifmib
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|SNMP_ERR_NOERROR
expr_stmt|;
switch|switch
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_ifIndex
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|ifp
operator|->
name|index
expr_stmt|;
break|break;
case|case
name|LEAF_ifDescr
case|:
name|ret
operator|=
name|string_get
argument_list|(
name|value
argument_list|,
name|ifp
operator|->
name|descr
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_ifType
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_type
expr_stmt|;
break|break;
case|case
name|LEAF_ifMtu
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_mtu
expr_stmt|;
break|break;
case|case
name|LEAF_ifSpeed
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_baudrate
expr_stmt|;
break|break;
case|case
name|LEAF_ifPhysAddress
case|:
name|ret
operator|=
name|string_get
argument_list|(
name|value
argument_list|,
name|ifp
operator|->
name|physaddr
argument_list|,
name|ifp
operator|->
name|physaddrlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_ifAdminStatus
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
operator|(
name|ifp
operator|->
name|mib
operator|.
name|ifmd_flags
operator|&
name|IFF_UP
operator|)
condition|?
literal|1
else|:
literal|2
expr_stmt|;
break|break;
case|case
name|LEAF_ifOperStatus
case|:
comment|/* 		 * According to RFC 2863 the state should be Up if the 		 * interface is ready to transmit packets. We takes this to 		 * mean that the interface should be running and should have 		 * a carrier. If it is running and has no carrier we interpret 		 * this as 'waiting for an external event' (plugging in the 		 * cable) and hence return 'dormant'. 		 */
if|if
condition|(
name|ifp
operator|->
name|mib
operator|.
name|ifmd_flags
operator|&
name|IFF_RUNNING
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_link_state
operator|==
name|LINK_STATE_DOWN
condition|)
name|value
operator|->
name|v
operator|.
name|integer
operator|=
literal|5
expr_stmt|;
comment|/* state dormant */
else|else
name|value
operator|->
name|v
operator|.
name|integer
operator|=
literal|1
expr_stmt|;
comment|/* state up */
block|}
else|else
name|value
operator|->
name|v
operator|.
name|integer
operator|=
literal|2
expr_stmt|;
comment|/* state down */
break|break;
case|case
name|LEAF_ifLastChange
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ticks_get_timeval
argument_list|(
operator|&
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_lastchange
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_ifInOctets
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_ibytes
expr_stmt|;
break|break;
case|case
name|LEAF_ifInUcastPkts
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_ipackets
operator|-
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_imcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifInNUcastPkts
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_imcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifInDiscards
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_iqdrops
expr_stmt|;
break|break;
case|case
name|LEAF_ifInErrors
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_ierrors
expr_stmt|;
break|break;
case|case
name|LEAF_ifInUnknownProtos
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_noproto
expr_stmt|;
break|break;
case|case
name|LEAF_ifOutOctets
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_obytes
expr_stmt|;
break|break;
case|case
name|LEAF_ifOutUcastPkts
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_opackets
operator|-
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_omcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifOutNUcastPkts
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_omcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifOutDiscards
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_snd_drops
expr_stmt|;
break|break;
case|case
name|LEAF_ifOutErrors
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_oerrors
expr_stmt|;
break|break;
case|case
name|LEAF_ifOutQLen
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_snd_len
expr_stmt|;
break|break;
case|case
name|LEAF_ifSpecific
case|:
name|value
operator|->
name|v
operator|.
name|oid
operator|=
name|ifp
operator|->
name|spec_oid
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * IfXtable entry  */
end_comment

begin_function
name|int
name|op_ifxtable
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|value
parameter_list|,
name|u_int
name|sub
parameter_list|,
name|u_int
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|struct
name|mibif
modifier|*
name|ifp
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|ifchange
modifier|*
name|ifc
decl_stmt|;
name|struct
name|asn_oid
name|idx
decl_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
name|again
label|:
if|if
condition|(
name|op
operator|!=
name|SNMP_OP_GETNEXT
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
comment|/* FALLTHROUGH */
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|ifp
operator|=
name|NEXT_OBJECT_INT
argument_list|(
operator|&
name|mibif_list
argument_list|,
operator|&
name|value
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|value
operator|->
name|var
operator|.
name|len
operator|=
name|sub
operator|+
literal|1
expr_stmt|;
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
operator|=
name|ifp
operator|->
name|index
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
name|value
operator|->
name|var
operator|.
name|len
operator|-
name|sub
operator|!=
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
operator|(
name|ifp
operator|=
name|mib_find_if
argument_list|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
name|value
operator|->
name|var
operator|.
name|len
operator|-
name|sub
operator|!=
literal|1
condition|)
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
if|if
condition|(
operator|(
name|ifp
operator|=
name|mib_find_if
argument_list|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NO_CREATION
operator|)
return|;
name|idx
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|idx
operator|.
name|subs
index|[
literal|0
index|]
operator|=
name|ifp
operator|->
name|index
expr_stmt|;
if|if
condition|(
operator|(
name|ifc
operator|=
operator|(
expr|struct
name|ifchange
operator|*
operator|)
name|snmp_dep_lookup
argument_list|(
name|ctx
argument_list|,
operator|&
name|oid_ifTable
argument_list|,
operator|&
name|idx
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ifc
argument_list|)
argument_list|,
name|ifchange_func
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_RES_UNAVAIL
operator|)
return|;
name|ifc
operator|->
name|ifindex
operator|=
name|ifp
operator|->
name|index
expr_stmt|;
switch|switch
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_ifLinkUpDownTrapEnable
case|:
if|if
condition|(
name|value
operator|->
name|v
operator|.
name|integer
operator|!=
literal|1
operator|&&
name|value
operator|->
name|v
operator|.
name|integer
operator|!=
literal|2
condition|)
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
if|if
condition|(
name|ifc
operator|->
name|set
operator|&
name|IFC_TRAPS
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|ifc
operator|->
name|set
operator||=
name|IFC_TRAPS
expr_stmt|;
name|ifc
operator|->
name|traps
operator|=
operator|(
name|value
operator|->
name|v
operator|.
name|integer
operator|==
literal|1
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_ifPromiscuousMode
case|:
if|if
condition|(
name|value
operator|->
name|v
operator|.
name|integer
operator|!=
literal|1
operator|&&
name|value
operator|->
name|v
operator|.
name|integer
operator|!=
literal|2
condition|)
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
if|if
condition|(
name|ifc
operator|->
name|set
operator|&
name|IFC_PROMISC
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|ifc
operator|->
name|set
operator||=
name|IFC_PROMISC
expr_stmt|;
name|ifc
operator|->
name|promisc
operator|=
operator|(
name|value
operator|->
name|v
operator|.
name|integer
operator|==
literal|1
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
case|case
name|SNMP_OP_ROLLBACK
case|:
case|case
name|SNMP_OP_COMMIT
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
if|if
condition|(
name|ifp
operator|->
name|mibtick
operator|<
name|this_tick
condition|)
operator|(
name|void
operator|)
name|mib_fetch_ifmib
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|SNMP_ERR_NOERROR
expr_stmt|;
switch|switch
condition|(
name|value
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_ifName
case|:
name|ret
operator|=
name|string_get
argument_list|(
name|value
argument_list|,
name|ifp
operator|->
name|name
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_ifInMulticastPkts
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_imcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifInBroadcastPkts
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|LEAF_ifOutMulticastPkts
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_omcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifOutBroadcastPkts
case|:
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|LEAF_ifHCInOctets
case|:
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|flags
operator|&
name|MIBIF_HIGHSPEED
operator|)
condition|)
goto|goto
name|again
goto|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
name|MIBIF_PRIV
argument_list|(
name|ifp
argument_list|)
operator|->
name|hc_inoctets
expr_stmt|;
break|break;
case|case
name|LEAF_ifHCInUcastPkts
case|:
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|flags
operator|&
operator|(
name|MIBIF_VERYHIGHSPEED
operator||
name|MIBIF_HIGHSPEED
operator|)
operator|)
condition|)
goto|goto
name|again
goto|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
name|MIBIF_PRIV
argument_list|(
name|ifp
argument_list|)
operator|->
name|hc_ipackets
operator|-
name|MIBIF_PRIV
argument_list|(
name|ifp
argument_list|)
operator|->
name|hc_imcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifHCInMulticastPkts
case|:
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|flags
operator|&
operator|(
name|MIBIF_VERYHIGHSPEED
operator||
name|MIBIF_HIGHSPEED
operator|)
operator|)
condition|)
goto|goto
name|again
goto|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
name|MIBIF_PRIV
argument_list|(
name|ifp
argument_list|)
operator|->
name|hc_imcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifHCInBroadcastPkts
case|:
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|flags
operator|&
operator|(
name|MIBIF_VERYHIGHSPEED
operator||
name|MIBIF_HIGHSPEED
operator|)
operator|)
condition|)
goto|goto
name|again
goto|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|LEAF_ifHCOutOctets
case|:
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|flags
operator|&
name|MIBIF_HIGHSPEED
operator|)
condition|)
goto|goto
name|again
goto|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
name|MIBIF_PRIV
argument_list|(
name|ifp
argument_list|)
operator|->
name|hc_outoctets
expr_stmt|;
break|break;
case|case
name|LEAF_ifHCOutUcastPkts
case|:
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|flags
operator|&
operator|(
name|MIBIF_VERYHIGHSPEED
operator||
name|MIBIF_HIGHSPEED
operator|)
operator|)
condition|)
goto|goto
name|again
goto|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
name|MIBIF_PRIV
argument_list|(
name|ifp
argument_list|)
operator|->
name|hc_opackets
operator|-
name|MIBIF_PRIV
argument_list|(
name|ifp
argument_list|)
operator|->
name|hc_omcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifHCOutMulticastPkts
case|:
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|flags
operator|&
operator|(
name|MIBIF_VERYHIGHSPEED
operator||
name|MIBIF_HIGHSPEED
operator|)
operator|)
condition|)
goto|goto
name|again
goto|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
name|MIBIF_PRIV
argument_list|(
name|ifp
argument_list|)
operator|->
name|hc_omcasts
expr_stmt|;
break|break;
case|case
name|LEAF_ifHCOutBroadcastPkts
case|:
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|flags
operator|&
operator|(
name|MIBIF_VERYHIGHSPEED
operator||
name|MIBIF_HIGHSPEED
operator|)
operator|)
condition|)
goto|goto
name|again
goto|;
name|value
operator|->
name|v
operator|.
name|counter64
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|LEAF_ifLinkUpDownTrapEnable
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|ifp
operator|->
name|trap_enable
condition|?
literal|1
else|:
literal|2
expr_stmt|;
break|break;
case|case
name|LEAF_ifHighSpeed
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
operator|(
name|ifp
operator|->
name|mib
operator|.
name|ifmd_data
operator|.
name|ifi_baudrate
operator|+
literal|499999
operator|)
operator|/
literal|1000000
expr_stmt|;
break|break;
case|case
name|LEAF_ifPromiscuousMode
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
operator|(
name|ifp
operator|->
name|mib
operator|.
name|ifmd_flags
operator|&
name|IFF_PROMISC
operator|)
condition|?
literal|1
else|:
literal|2
expr_stmt|;
break|break;
case|case
name|LEAF_ifConnectorPresent
case|:
name|value
operator|->
name|v
operator|.
name|integer
operator|=
name|ifp
operator|->
name|has_connector
condition|?
literal|1
else|:
literal|2
expr_stmt|;
break|break;
case|case
name|LEAF_ifAlias
case|:
name|ret
operator|=
name|string_get
argument_list|(
name|value
argument_list|,
literal|""
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_ifCounterDiscontinuityTime
case|:
if|if
condition|(
name|ifp
operator|->
name|counter_disc
operator|>
name|start_tick
condition|)
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
name|ifp
operator|->
name|counter_disc
operator|-
name|start_tick
expr_stmt|;
else|else
name|value
operator|->
name|v
operator|.
name|uint32
operator|=
literal|0
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010 The FreeBSD Foundation  * All rights reserved.  *  * This software was developed by Shteryana Sotirova Shopova under  * sponsorship from the FreeBSD Foundation.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|"asn1.h"
end_include

begin_include
include|#
directive|include
file|"snmp.h"
end_include

begin_include
include|#
directive|include
file|"snmpmod.h"
end_include

begin_include
include|#
directive|include
file|"vacm_tree.h"
end_include

begin_include
include|#
directive|include
file|"vacm_oid.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|lmodule
modifier|*
name|vacm_module
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* For the registration. */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|asn_oid
name|oid_vacm
init|=
name|OIDX_snmpVacmMIB
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint
name|reg_vacm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int32_t
name|vacm_lock
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Internal datastructures and forward declarations.  */
end_comment

begin_function_decl
specifier|static
name|void
name|vacm_append_userindex
parameter_list|(
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|,
specifier|const
name|struct
name|vacm_user
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vacm_user_index_decode
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|,
name|int32_t
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vacm_user
modifier|*
name|vacm_get_user
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vacm_user
modifier|*
name|vacm_get_next_user
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vacm_append_access_rule_index
parameter_list|(
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|,
specifier|const
name|struct
name|vacm_access
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vacm_access_rule_index_decode
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|,
name|char
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int32_t
modifier|*
parameter_list|,
name|int32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vacm_access
modifier|*
name|vacm_get_access_rule
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vacm_access
modifier|*
name|vacm_get_next_access_rule
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vacm_view_index_decode
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|,
name|char
modifier|*
parameter_list|,
name|struct
name|asn_oid
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vacm_append_viewindex
parameter_list|(
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|,
specifier|const
name|struct
name|vacm_view
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vacm_view
modifier|*
name|vacm_get_view
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vacm_view
modifier|*
name|vacm_get_next_view
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vacm_view
modifier|*
name|vacm_get_view_by_name
parameter_list|(
name|u_char
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vacm_context
modifier|*
name|vacm_get_context
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vacm_context
modifier|*
name|vacm_get_next_context
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vacm_append_ctxindex
parameter_list|(
name|struct
name|asn_oid
modifier|*
parameter_list|,
name|uint
parameter_list|,
specifier|const
name|struct
name|vacm_context
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|op_vacm_context
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint32_t
name|sub
parameter_list|,
name|uint32_t
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|char
name|cname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|size_t
name|cnamelen
decl_stmt|;
name|struct
name|vacm_context
modifier|*
name|vacm_ctx
decl_stmt|;
if|if
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|!=
name|LEAF_vacmContextName
condition|)
name|abort
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
operator|(
name|vacm_ctx
operator|=
name|vacm_get_context
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|vacm_ctx
operator|=
name|vacm_get_next_context
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|vacm_append_ctxindex
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|vacm_ctx
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
operator|(
name|vacm_ctx
operator|=
name|vacm_get_context
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
if|if
condition|(
name|community
operator|!=
name|COMM_INITIALIZE
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
index|]
operator|>=
name|SNMP_ADM_STR32_SIZ
condition|)
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
if|if
condition|(
name|index_decode
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|iidx
argument_list|,
operator|&
name|cname
argument_list|,
operator|&
name|cnamelen
argument_list|)
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|cname
index|[
name|cnamelen
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|vacm_ctx
operator|=
name|vacm_add_context
argument_list|(
name|cname
argument_list|,
name|reg_vacm
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
comment|/* FALLTHROUGH*/
case|case
name|SNMP_OP_ROLLBACK
case|:
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|vacm_ctx
operator|->
name|ctxname
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_vacm_security_to_group
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint32_t
name|sub
parameter_list|,
name|uint32_t
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|int32_t
name|smodel
decl_stmt|;
name|char
name|uname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|struct
name|vacm_user
modifier|*
name|user
decl_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
operator|(
name|user
operator|=
name|vacm_get_user
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|user
operator|=
name|vacm_get_next_user
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|vacm_append_userindex
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|user
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
operator|(
name|user
operator|=
name|vacm_get_user
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
operator|&&
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|!=
name|LEAF_vacmSecurityToGroupStatus
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
name|user
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|community
operator|!=
name|COMM_INITIALIZE
operator|&&
name|user
operator|->
name|type
operator|==
name|StorageType_readOnly
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|user
operator|->
name|status
operator|==
name|RowStatus_active
operator|&&
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_destroy
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
block|}
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmGroupName
case|:
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
operator|=
name|user
operator|->
name|group
operator|->
name|groupname
expr_stmt|;
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|strlen
argument_list|(
name|user
operator|->
name|group
operator|->
name|groupname
argument_list|)
expr_stmt|;
return|return
operator|(
name|vacm_user_set_group
argument_list|(
name|user
argument_list|,
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
operator|)
return|;
case|case
name|LEAF_vacmSecurityToGroupStorageType
case|:
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
case|case
name|LEAF_vacmSecurityToGroupStatus
case|:
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_createAndGo
operator|||
name|vacm_user_index_decode
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
operator|&
name|smodel
argument_list|,
name|uname
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|user
operator|=
name|vacm_new_user
argument_list|(
name|smodel
argument_list|,
name|uname
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|user
operator|->
name|status
operator|=
name|RowStatus_destroy
expr_stmt|;
if|if
condition|(
name|community
operator|!=
name|COMM_INITIALIZE
condition|)
name|user
operator|->
name|type
operator|=
name|StorageType_volatile
expr_stmt|;
else|else
name|user
operator|->
name|type
operator|=
name|StorageType_readOnly
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_active
operator|&&
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_destroy
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|user
operator|->
name|status
expr_stmt|;
name|user
operator|->
name|status
operator|=
name|val
operator|->
name|v
operator|.
name|integer
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
if|if
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|!=
name|LEAF_vacmSecurityToGroupStatus
condition|)
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
if|if
condition|(
operator|(
name|user
operator|=
name|vacm_get_user
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|v
operator|.
name|integer
condition|)
block|{
case|case
name|RowStatus_destroy
case|:
return|return
operator|(
name|vacm_delete_user
argument_list|(
name|user
argument_list|)
operator|)
return|;
case|case
name|RowStatus_createAndGo
case|:
name|user
operator|->
name|status
operator|=
name|RowStatus_active
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_ROLLBACK
case|:
if|if
condition|(
operator|(
name|user
operator|=
name|vacm_get_user
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmGroupName
case|:
return|return
operator|(
name|vacm_user_set_group
argument_list|(
name|user
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|int1
argument_list|)
operator|)
return|;
case|case
name|LEAF_vacmSecurityToGroupStatus
case|:
if|if
condition|(
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|==
name|RowStatus_destroy
condition|)
return|return
operator|(
name|vacm_delete_user
argument_list|(
name|user
argument_list|)
operator|)
return|;
name|user
operator|->
name|status
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|int1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmGroupName
case|:
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|user
operator|->
name|group
operator|->
name|groupname
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_vacmSecurityToGroupStorageType
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|user
operator|->
name|type
expr_stmt|;
break|break;
case|case
name|LEAF_vacmSecurityToGroupStatus
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|user
operator|->
name|status
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_vacm_access
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint32_t
name|sub
parameter_list|,
name|uint32_t
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|int32_t
name|smodel
decl_stmt|,
name|slevel
decl_stmt|;
name|char
name|gname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|,
name|cprefix
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|struct
name|vacm_access
modifier|*
name|acl
decl_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
operator|(
name|acl
operator|=
name|vacm_get_access_rule
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|acl
operator|=
name|vacm_get_next_access_rule
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|vacm_append_access_rule_index
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|acl
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
operator|(
name|acl
operator|=
name|vacm_get_access_rule
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
operator|&&
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|!=
name|LEAF_vacmAccessStatus
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
name|acl
operator|!=
name|NULL
operator|&&
name|community
operator|!=
name|COMM_INITIALIZE
operator|&&
name|acl
operator|->
name|type
operator|==
name|StorageType_readOnly
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmAccessContextMatch
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|acl
operator|->
name|ctx_match
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|==
name|vacmAccessContextMatch_exact
condition|)
name|acl
operator|->
name|ctx_match
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|==
name|vacmAccessContextMatch_prefix
condition|)
name|acl
operator|->
name|ctx_match
operator|=
literal|0
expr_stmt|;
else|else
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
break|break;
case|case
name|LEAF_vacmAccessReadViewName
case|:
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
operator|=
name|acl
operator|->
name|read_view
expr_stmt|;
name|acl
operator|->
name|read_view
operator|=
name|vacm_get_view_by_name
argument_list|(
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|acl
operator|->
name|read_view
operator|==
name|NULL
condition|)
block|{
name|acl
operator|->
name|read_view
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|LEAF_vacmAccessWriteViewName
case|:
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
operator|=
name|acl
operator|->
name|write_view
expr_stmt|;
if|if
condition|(
operator|(
name|acl
operator|->
name|write_view
operator|=
name|vacm_get_view_by_name
argument_list|(
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|acl
operator|->
name|write_view
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
block|}
break|break;
case|case
name|LEAF_vacmAccessNotifyViewName
case|:
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
operator|=
name|acl
operator|->
name|notify_view
expr_stmt|;
if|if
condition|(
operator|(
name|acl
operator|->
name|notify_view
operator|=
name|vacm_get_view_by_name
argument_list|(
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|acl
operator|->
name|notify_view
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
block|}
break|break;
case|case
name|LEAF_vacmAccessStorageType
case|:
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
case|case
name|LEAF_vacmAccessStatus
case|:
if|if
condition|(
name|acl
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_createAndGo
operator|||
name|vacm_access_rule_index_decode
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|gname
argument_list|,
name|cprefix
argument_list|,
operator|&
name|smodel
argument_list|,
operator|&
name|slevel
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
if|if
condition|(
operator|(
name|acl
operator|=
name|vacm_new_access_rule
argument_list|(
name|gname
argument_list|,
name|cprefix
argument_list|,
name|smodel
argument_list|,
name|slevel
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|acl
operator|->
name|status
operator|=
name|RowStatus_destroy
expr_stmt|;
if|if
condition|(
name|community
operator|!=
name|COMM_INITIALIZE
condition|)
name|acl
operator|->
name|type
operator|=
name|StorageType_volatile
expr_stmt|;
else|else
name|acl
operator|->
name|type
operator|=
name|StorageType_readOnly
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_active
operator|&&
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_destroy
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|acl
operator|->
name|status
expr_stmt|;
name|acl
operator|->
name|status
operator|=
name|val
operator|->
name|v
operator|.
name|integer
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
if|if
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|!=
name|LEAF_vacmAccessStatus
condition|)
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
if|if
condition|(
operator|(
name|acl
operator|=
name|vacm_get_access_rule
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|==
name|RowStatus_destroy
condition|)
return|return
operator|(
name|vacm_delete_access_rule
argument_list|(
name|acl
argument_list|)
operator|)
return|;
else|else
name|acl
operator|->
name|status
operator|=
name|RowStatus_active
expr_stmt|;
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_ROLLBACK
case|:
if|if
condition|(
operator|(
name|acl
operator|=
name|vacm_get_access_rule
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmAccessContextMatch
case|:
name|acl
operator|->
name|ctx_match
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|int1
expr_stmt|;
break|break;
case|case
name|LEAF_vacmAccessReadViewName
case|:
name|acl
operator|->
name|read_view
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
expr_stmt|;
break|break;
case|case
name|LEAF_vacmAccessWriteViewName
case|:
name|acl
operator|->
name|write_view
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
expr_stmt|;
break|break;
case|case
name|LEAF_vacmAccessNotifyViewName
case|:
name|acl
operator|->
name|notify_view
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
expr_stmt|;
break|break;
case|case
name|LEAF_vacmAccessStatus
case|:
if|if
condition|(
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|==
name|RowStatus_destroy
condition|)
return|return
operator|(
name|vacm_delete_access_rule
argument_list|(
name|acl
argument_list|)
operator|)
return|;
default|default:
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmAccessContextMatch
case|:
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|acl
operator|->
name|ctx_prefix
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
case|case
name|LEAF_vacmAccessReadViewName
case|:
if|if
condition|(
name|acl
operator|->
name|read_view
operator|!=
name|NULL
condition|)
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|acl
operator|->
name|read_view
operator|->
name|viewname
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|)
return|;
case|case
name|LEAF_vacmAccessWriteViewName
case|:
if|if
condition|(
name|acl
operator|->
name|write_view
operator|!=
name|NULL
condition|)
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|acl
operator|->
name|write_view
operator|->
name|viewname
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|)
return|;
case|case
name|LEAF_vacmAccessNotifyViewName
case|:
if|if
condition|(
name|acl
operator|->
name|notify_view
operator|!=
name|NULL
condition|)
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|acl
operator|->
name|notify_view
operator|->
name|viewname
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|)
return|;
case|case
name|LEAF_vacmAccessStorageType
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|acl
operator|->
name|type
expr_stmt|;
break|break;
case|case
name|LEAF_vacmAccessStatus
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|acl
operator|->
name|status
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_vacm_view_lock
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
name|__unused
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint32_t
name|sub
parameter_list|,
name|uint32_t
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
if|if
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|!=
name|LEAF_vacmViewSpinLock
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
operator|++
name|vacm_lock
operator|==
name|INT32_MAX
condition|)
name|vacm_lock
operator|=
literal|0
expr_stmt|;
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|vacm_lock
expr_stmt|;
break|break;
case|case
name|SNMP_OP_GETNEXT
case|:
name|abort
argument_list|()
expr_stmt|;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|vacm_lock
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
break|break;
case|case
name|SNMP_OP_ROLLBACK
case|:
comment|/* FALLTHROUGH */
case|case
name|SNMP_OP_COMMIT
case|:
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
name|int
name|op_vacm_view
parameter_list|(
name|struct
name|snmp_context
modifier|*
name|ctx
parameter_list|,
name|struct
name|snmp_value
modifier|*
name|val
parameter_list|,
name|uint32_t
name|sub
parameter_list|,
name|uint32_t
name|iidx
name|__unused
parameter_list|,
name|enum
name|snmp_op
name|op
parameter_list|)
block|{
name|char
name|vname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|struct
name|asn_oid
name|oid
decl_stmt|;
name|struct
name|vacm_view
modifier|*
name|view
decl_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|SNMP_OP_GET
case|:
if|if
condition|(
operator|(
name|view
operator|=
name|vacm_get_view
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
break|break;
case|case
name|SNMP_OP_GETNEXT
case|:
if|if
condition|(
operator|(
name|view
operator|=
name|vacm_get_next_view
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
name|vacm_append_viewindex
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|view
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNMP_OP_SET
case|:
if|if
condition|(
operator|(
name|view
operator|=
name|vacm_get_view
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
operator|&&
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
operator|!=
name|LEAF_vacmViewTreeFamilyStatus
condition|)
return|return
operator|(
name|SNMP_ERR_NOSUCHNAME
operator|)
return|;
if|if
condition|(
name|view
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|community
operator|!=
name|COMM_INITIALIZE
operator|&&
name|view
operator|->
name|type
operator|==
name|StorageType_readOnly
condition|)
return|return
operator|(
name|SNMP_ERR_NOT_WRITEABLE
operator|)
return|;
if|if
condition|(
name|view
operator|->
name|status
operator|==
name|RowStatus_active
operator|&&
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_destroy
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
block|}
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmViewTreeFamilyMask
case|:
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
operator|>
sizeof|sizeof
argument_list|(
name|view
operator|->
name|mask
argument_list|)
condition|)
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|view
operator|->
name|mask
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|memset
argument_list|(
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|view
operator|->
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
argument_list|,
name|view
operator|->
name|mask
argument_list|,
sizeof|sizeof
argument_list|(
name|view
operator|->
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|view
operator|->
name|mask
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|view
operator|->
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|view
operator|->
name|mask
argument_list|,
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|octets
argument_list|,
name|val
operator|->
name|v
operator|.
name|octetstring
operator|.
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_vacmViewTreeFamilyType
case|:
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|view
operator|->
name|exclude
expr_stmt|;
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|==
name|vacmViewTreeFamilyType_included
condition|)
name|view
operator|->
name|exclude
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|==
name|vacmViewTreeFamilyType_excluded
condition|)
name|view
operator|->
name|exclude
operator|=
literal|1
expr_stmt|;
else|else
return|return
operator|(
name|SNMP_ERR_WRONG_VALUE
operator|)
return|;
break|break;
case|case
name|LEAF_vacmViewTreeFamilyStorageType
case|:
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
case|case
name|LEAF_vacmViewTreeFamilyStatus
case|:
if|if
condition|(
name|view
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_createAndGo
operator|||
name|vacm_view_index_decode
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|,
name|vname
argument_list|,
operator|&
name|oid
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
if|if
condition|(
operator|(
name|view
operator|=
name|vacm_new_view
argument_list|(
name|vname
argument_list|,
operator|&
name|oid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
name|view
operator|->
name|status
operator|=
name|RowStatus_destroy
expr_stmt|;
if|if
condition|(
name|community
operator|!=
name|COMM_INITIALIZE
condition|)
name|view
operator|->
name|type
operator|=
name|StorageType_volatile
expr_stmt|;
else|else
name|view
operator|->
name|type
operator|=
name|StorageType_readOnly
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_active
operator|&&
name|val
operator|->
name|v
operator|.
name|integer
operator|!=
name|RowStatus_destroy
condition|)
return|return
operator|(
name|SNMP_ERR_INCONS_VALUE
operator|)
return|;
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|=
name|view
operator|->
name|status
expr_stmt|;
name|view
operator|->
name|status
operator|=
name|val
operator|->
name|v
operator|.
name|integer
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_COMMIT
case|:
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmViewTreeFamilyMask
case|:
name|free
argument_list|(
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_vacmViewTreeFamilyStatus
case|:
if|if
condition|(
operator|(
name|view
operator|=
name|vacm_get_view
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|v
operator|.
name|integer
condition|)
block|{
case|case
name|RowStatus_destroy
case|:
return|return
operator|(
name|vacm_delete_view
argument_list|(
name|view
argument_list|)
operator|)
return|;
case|case
name|RowStatus_createAndGo
case|:
name|view
operator|->
name|status
operator|=
name|RowStatus_active
expr_stmt|;
break|break;
default|default:
comment|/* NOTREACHED*/
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
block|}
default|default:
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
case|case
name|SNMP_OP_ROLLBACK
case|:
if|if
condition|(
operator|(
name|view
operator|=
name|vacm_get_view
argument_list|(
operator|&
name|val
operator|->
name|var
argument_list|,
name|sub
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|SNMP_ERR_GENERR
operator|)
return|;
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmViewTreeFamilyMask
case|:
name|memcpy
argument_list|(
name|view
operator|->
name|mask
argument_list|,
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
argument_list|,
sizeof|sizeof
argument_list|(
name|view
operator|->
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctx
operator|->
name|scratch
operator|->
name|ptr1
argument_list|)
expr_stmt|;
break|break;
case|case
name|LEAF_vacmViewTreeFamilyType
case|:
name|view
operator|->
name|exclude
operator|=
name|ctx
operator|->
name|scratch
operator|->
name|int1
expr_stmt|;
break|break;
case|case
name|LEAF_vacmViewTreeFamilyStatus
case|:
if|if
condition|(
name|ctx
operator|->
name|scratch
operator|->
name|int1
operator|==
name|RowStatus_destroy
condition|)
return|return
operator|(
name|vacm_delete_view
argument_list|(
name|view
argument_list|)
operator|)
return|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|val
operator|->
name|var
operator|.
name|subs
index|[
name|sub
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|LEAF_vacmViewTreeFamilyMask
case|:
return|return
operator|(
name|string_get
argument_list|(
name|val
argument_list|,
name|view
operator|->
name|mask
argument_list|,
sizeof|sizeof
argument_list|(
name|view
operator|->
name|mask
argument_list|)
argument_list|)
operator|)
return|;
case|case
name|LEAF_vacmViewTreeFamilyType
case|:
if|if
condition|(
name|view
operator|->
name|exclude
condition|)
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|vacmViewTreeFamilyType_excluded
expr_stmt|;
else|else
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|vacmViewTreeFamilyType_included
expr_stmt|;
break|break;
case|case
name|LEAF_vacmViewTreeFamilyStorageType
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|view
operator|->
name|type
expr_stmt|;
break|break;
case|case
name|LEAF_vacmViewTreeFamilyStatus
case|:
name|val
operator|->
name|v
operator|.
name|integer
operator|=
name|view
operator|->
name|status
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|SNMP_ERR_NOERROR
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vacm_append_userindex
parameter_list|(
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|,
specifier|const
name|struct
name|vacm_user
modifier|*
name|user
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|oid
operator|->
name|len
operator|=
name|sub
operator|+
name|strlen
argument_list|(
name|user
operator|->
name|secname
argument_list|)
operator|+
literal|2
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
operator|++
index|]
operator|=
name|user
operator|->
name|sec_model
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|=
name|strlen
argument_list|(
name|user
operator|->
name|secname
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|strlen
argument_list|(
name|user
operator|->
name|secname
argument_list|)
condition|;
name|i
operator|++
control|)
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
index|]
operator|=
name|user
operator|->
name|secname
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vacm_user_index_decode
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|,
name|int32_t
modifier|*
name|smodel
parameter_list|,
name|char
modifier|*
name|uname
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
operator|*
name|smodel
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
operator|++
index|]
expr_stmt|;
if|if
condition|(
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|>=
name|SNMP_ADM_STR32_SIZ
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oid
operator|->
name|subs
index|[
name|sub
index|]
condition|;
name|i
operator|++
control|)
name|uname
index|[
name|i
index|]
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|uname
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vacm_user
modifier|*
name|vacm_get_user
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|int32_t
name|smodel
decl_stmt|;
name|char
name|uname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|struct
name|vacm_user
modifier|*
name|user
decl_stmt|;
if|if
condition|(
name|vacm_user_index_decode
argument_list|(
name|oid
argument_list|,
name|sub
argument_list|,
operator|&
name|smodel
argument_list|,
name|uname
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|user
operator|=
name|vacm_first_user
argument_list|()
init|;
name|user
operator|!=
name|NULL
condition|;
name|user
operator|=
name|vacm_next_user
argument_list|(
name|user
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|uname
argument_list|,
name|user
operator|->
name|secname
argument_list|)
operator|==
literal|0
operator|&&
name|user
operator|->
name|sec_model
operator|==
name|smodel
condition|)
return|return
operator|(
name|user
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vacm_user
modifier|*
name|vacm_get_next_user
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|int32_t
name|smodel
decl_stmt|;
name|char
name|uname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|struct
name|vacm_user
modifier|*
name|user
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|len
operator|-
name|sub
operator|==
literal|0
condition|)
return|return
operator|(
name|vacm_first_user
argument_list|()
operator|)
return|;
if|if
condition|(
name|vacm_user_index_decode
argument_list|(
name|oid
argument_list|,
name|sub
argument_list|,
operator|&
name|smodel
argument_list|,
name|uname
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|user
operator|=
name|vacm_first_user
argument_list|()
init|;
name|user
operator|!=
name|NULL
condition|;
name|user
operator|=
name|vacm_next_user
argument_list|(
name|user
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|uname
argument_list|,
name|user
operator|->
name|secname
argument_list|)
operator|==
literal|0
operator|&&
name|user
operator|->
name|sec_model
operator|==
name|smodel
condition|)
return|return
operator|(
name|vacm_next_user
argument_list|(
name|user
argument_list|)
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vacm_append_access_rule_index
parameter_list|(
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|,
specifier|const
name|struct
name|vacm_access
modifier|*
name|acl
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|oid
operator|->
name|len
operator|=
name|sub
operator|+
name|strlen
argument_list|(
name|acl
operator|->
name|group
operator|->
name|groupname
argument_list|)
operator|+
name|strlen
argument_list|(
name|acl
operator|->
name|ctx_prefix
argument_list|)
operator|+
literal|4
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|=
name|strlen
argument_list|(
name|acl
operator|->
name|group
operator|->
name|groupname
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|strlen
argument_list|(
name|acl
operator|->
name|group
operator|->
name|groupname
argument_list|)
condition|;
name|i
operator|++
control|)
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
index|]
operator|=
name|acl
operator|->
name|group
operator|->
name|groupname
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|sub
operator|+=
name|strlen
argument_list|(
name|acl
operator|->
name|group
operator|->
name|groupname
argument_list|)
operator|+
literal|1
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|=
name|strlen
argument_list|(
name|acl
operator|->
name|ctx_prefix
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|strlen
argument_list|(
name|acl
operator|->
name|ctx_prefix
argument_list|)
condition|;
name|i
operator|++
control|)
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
index|]
operator|=
name|acl
operator|->
name|ctx_prefix
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|sub
operator|+=
name|strlen
argument_list|(
name|acl
operator|->
name|ctx_prefix
argument_list|)
operator|+
literal|1
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
operator|++
index|]
operator|=
name|acl
operator|->
name|sec_model
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|=
name|acl
operator|->
name|sec_level
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vacm_access_rule_index_decode
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|,
name|char
modifier|*
name|gname
parameter_list|,
name|char
modifier|*
name|cprefix
parameter_list|,
name|int32_t
modifier|*
name|smodel
parameter_list|,
name|int32_t
modifier|*
name|slevel
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|>=
name|SNMP_ADM_STR32_SIZ
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oid
operator|->
name|subs
index|[
name|sub
index|]
condition|;
name|i
operator|++
control|)
name|gname
index|[
name|i
index|]
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|gname
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|sub
operator|+=
name|strlen
argument_list|(
name|gname
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|>=
name|SNMP_ADM_STR32_SIZ
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oid
operator|->
name|subs
index|[
name|sub
index|]
condition|;
name|i
operator|++
control|)
name|cprefix
index|[
name|i
index|]
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|cprefix
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|sub
operator|+=
name|strlen
argument_list|(
name|cprefix
argument_list|)
operator|+
literal|1
expr_stmt|;
operator|*
name|smodel
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
operator|++
index|]
expr_stmt|;
operator|*
name|slevel
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|vacm_access
modifier|*
name|vacm_get_access_rule
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|int32_t
name|smodel
decl_stmt|,
name|slevel
decl_stmt|;
name|char
name|gname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|,
name|prefix
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|struct
name|vacm_access
modifier|*
name|acl
decl_stmt|;
if|if
condition|(
name|vacm_access_rule_index_decode
argument_list|(
name|oid
argument_list|,
name|sub
argument_list|,
name|gname
argument_list|,
name|prefix
argument_list|,
operator|&
name|smodel
argument_list|,
operator|&
name|slevel
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|acl
operator|=
name|vacm_first_access_rule
argument_list|()
init|;
name|acl
operator|!=
name|NULL
condition|;
name|acl
operator|=
name|vacm_next_access_rule
argument_list|(
name|acl
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|gname
argument_list|,
name|acl
operator|->
name|group
operator|->
name|groupname
argument_list|)
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|prefix
argument_list|,
name|acl
operator|->
name|ctx_prefix
argument_list|)
operator|==
literal|0
operator|&&
name|smodel
operator|==
name|acl
operator|->
name|sec_model
operator|&&
name|slevel
operator|==
name|acl
operator|->
name|sec_level
condition|)
return|return
operator|(
name|acl
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|vacm_access
modifier|*
name|vacm_get_next_access_rule
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
name|__unused
parameter_list|,
name|uint
name|sub
name|__unused
parameter_list|)
block|{
name|int32_t
name|smodel
decl_stmt|,
name|slevel
decl_stmt|;
name|char
name|gname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|,
name|prefix
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|struct
name|vacm_access
modifier|*
name|acl
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|len
operator|-
name|sub
operator|==
literal|0
condition|)
return|return
operator|(
name|vacm_first_access_rule
argument_list|()
operator|)
return|;
if|if
condition|(
name|vacm_access_rule_index_decode
argument_list|(
name|oid
argument_list|,
name|sub
argument_list|,
name|gname
argument_list|,
name|prefix
argument_list|,
operator|&
name|smodel
argument_list|,
operator|&
name|slevel
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|acl
operator|=
name|vacm_first_access_rule
argument_list|()
init|;
name|acl
operator|!=
name|NULL
condition|;
name|acl
operator|=
name|vacm_next_access_rule
argument_list|(
name|acl
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|gname
argument_list|,
name|acl
operator|->
name|group
operator|->
name|groupname
argument_list|)
operator|==
literal|0
operator|&&
name|strcmp
argument_list|(
name|prefix
argument_list|,
name|acl
operator|->
name|ctx_prefix
argument_list|)
operator|==
literal|0
operator|&&
name|smodel
operator|==
name|acl
operator|->
name|sec_model
operator|&&
name|slevel
operator|==
name|acl
operator|->
name|sec_model
condition|)
return|return
operator|(
name|vacm_next_access_rule
argument_list|(
name|acl
argument_list|)
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vacm_view_index_decode
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|,
name|char
modifier|*
name|vname
parameter_list|,
name|struct
name|asn_oid
modifier|*
name|view_oid
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|int
name|viod_off
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|>=
name|SNMP_ADM_STR32_SIZ
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oid
operator|->
name|subs
index|[
name|sub
index|]
condition|;
name|i
operator|++
control|)
name|vname
index|[
name|i
index|]
operator|=
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|vname
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|viod_off
operator|=
name|sub
operator|+
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|view_oid
operator|->
name|len
operator|=
name|oid
operator|->
name|subs
index|[
name|viod_off
index|]
operator|)
operator|>
name|ASN_MAXOIDLEN
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|memcpy
argument_list|(
operator|&
name|view_oid
operator|->
name|subs
index|[
literal|0
index|]
argument_list|,
operator|&
name|oid
operator|->
name|subs
index|[
name|viod_off
operator|+
literal|1
index|]
argument_list|,
name|view_oid
operator|->
name|len
operator|*
sizeof|sizeof
argument_list|(
name|view_oid
operator|->
name|subs
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vacm_append_viewindex
parameter_list|(
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|,
specifier|const
name|struct
name|vacm_view
modifier|*
name|view
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|oid
operator|->
name|len
operator|=
name|sub
operator|+
name|strlen
argument_list|(
name|view
operator|->
name|viewname
argument_list|)
operator|+
literal|1
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|=
name|strlen
argument_list|(
name|view
operator|->
name|viewname
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|strlen
argument_list|(
name|view
operator|->
name|viewname
argument_list|)
condition|;
name|i
operator|++
control|)
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
index|]
operator|=
name|view
operator|->
name|viewname
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|sub
operator|+=
name|strlen
argument_list|(
name|view
operator|->
name|viewname
argument_list|)
operator|+
literal|1
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|=
name|view
operator|->
name|subtree
operator|.
name|len
expr_stmt|;
name|oid
operator|->
name|len
operator|++
expr_stmt|;
name|asn_append_oid
argument_list|(
name|oid
argument_list|,
operator|&
name|view
operator|->
name|subtree
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|vacm_view
modifier|*
name|vacm_get_view
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|char
name|vname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|struct
name|asn_oid
name|subtree
decl_stmt|;
name|struct
name|vacm_view
modifier|*
name|view
decl_stmt|;
if|if
condition|(
name|vacm_view_index_decode
argument_list|(
name|oid
argument_list|,
name|sub
argument_list|,
name|vname
argument_list|,
operator|&
name|subtree
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|view
operator|=
name|vacm_first_view
argument_list|()
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|vacm_next_view
argument_list|(
name|view
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|vname
argument_list|,
name|view
operator|->
name|viewname
argument_list|)
operator|==
literal|0
operator|&&
name|asn_compare_oid
argument_list|(
operator|&
name|subtree
argument_list|,
operator|&
name|view
operator|->
name|subtree
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|view
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|vacm_view
modifier|*
name|vacm_get_next_view
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|char
name|vname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|struct
name|asn_oid
name|subtree
decl_stmt|;
name|struct
name|vacm_view
modifier|*
name|view
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|len
operator|-
name|sub
operator|==
literal|0
condition|)
return|return
operator|(
name|vacm_first_view
argument_list|()
operator|)
return|;
if|if
condition|(
name|vacm_view_index_decode
argument_list|(
name|oid
argument_list|,
name|sub
argument_list|,
name|vname
argument_list|,
operator|&
name|subtree
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|view
operator|=
name|vacm_first_view
argument_list|()
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|vacm_next_view
argument_list|(
name|view
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|vname
argument_list|,
name|view
operator|->
name|viewname
argument_list|)
operator|==
literal|0
operator|&&
name|asn_compare_oid
argument_list|(
operator|&
name|subtree
argument_list|,
operator|&
name|view
operator|->
name|subtree
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vacm_next_view
argument_list|(
name|view
argument_list|)
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vacm_view
modifier|*
name|vacm_get_view_by_name
parameter_list|(
name|u_char
modifier|*
name|octets
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|struct
name|vacm_view
modifier|*
name|view
decl_stmt|;
for|for
control|(
name|view
operator|=
name|vacm_first_view
argument_list|()
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|vacm_next_view
argument_list|(
name|view
argument_list|)
control|)
if|if
condition|(
name|strlen
argument_list|(
name|view
operator|->
name|viewname
argument_list|)
operator|==
name|len
operator|&&
name|memcmp
argument_list|(
name|octets
argument_list|,
name|view
operator|->
name|viewname
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|view
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vacm_context
modifier|*
name|vacm_get_context
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|char
name|cname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|size_t
name|cnamelen
decl_stmt|;
name|u_int
name|index_count
decl_stmt|;
name|struct
name|vacm_context
modifier|*
name|vacm_ctx
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|>=
name|SNMP_ADM_STR32_SIZ
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|index_count
operator|=
literal|0
expr_stmt|;
name|index_count
operator|=
name|SNMP_INDEX
argument_list|(
name|index_count
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|index_decode
argument_list|(
name|oid
argument_list|,
name|sub
argument_list|,
name|index_count
argument_list|,
operator|&
name|cname
argument_list|,
operator|&
name|cnamelen
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|vacm_ctx
operator|=
name|vacm_first_context
argument_list|()
init|;
name|vacm_ctx
operator|!=
name|NULL
condition|;
name|vacm_ctx
operator|=
name|vacm_next_context
argument_list|(
name|vacm_ctx
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|cname
argument_list|,
name|vacm_ctx
operator|->
name|ctxname
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vacm_ctx
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vacm_context
modifier|*
name|vacm_get_next_context
parameter_list|(
specifier|const
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|)
block|{
name|char
name|cname
index|[
name|SNMP_ADM_STR32_SIZ
index|]
decl_stmt|;
name|size_t
name|cnamelen
decl_stmt|;
name|u_int
name|index_count
decl_stmt|;
name|struct
name|vacm_context
modifier|*
name|vacm_ctx
decl_stmt|;
if|if
condition|(
name|oid
operator|->
name|len
operator|-
name|sub
operator|==
literal|0
condition|)
return|return
operator|(
name|vacm_first_context
argument_list|()
operator|)
return|;
if|if
condition|(
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|>=
name|SNMP_ADM_STR32_SIZ
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|index_count
operator|=
literal|0
expr_stmt|;
name|index_count
operator|=
name|SNMP_INDEX
argument_list|(
name|index_count
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|index_decode
argument_list|(
name|oid
argument_list|,
name|sub
argument_list|,
name|index_count
argument_list|,
operator|&
name|cname
argument_list|,
operator|&
name|cnamelen
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|vacm_ctx
operator|=
name|vacm_first_context
argument_list|()
init|;
name|vacm_ctx
operator|!=
name|NULL
condition|;
name|vacm_ctx
operator|=
name|vacm_next_context
argument_list|(
name|vacm_ctx
argument_list|)
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|cname
argument_list|,
name|vacm_ctx
operator|->
name|ctxname
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vacm_next_context
argument_list|(
name|vacm_ctx
argument_list|)
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vacm_append_ctxindex
parameter_list|(
name|struct
name|asn_oid
modifier|*
name|oid
parameter_list|,
name|uint
name|sub
parameter_list|,
specifier|const
name|struct
name|vacm_context
modifier|*
name|ctx
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|oid
operator|->
name|len
operator|=
name|sub
operator|+
name|strlen
argument_list|(
name|ctx
operator|->
name|ctxname
argument_list|)
operator|+
literal|1
expr_stmt|;
name|oid
operator|->
name|subs
index|[
name|sub
index|]
operator|=
name|strlen
argument_list|(
name|ctx
operator|->
name|ctxname
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|strlen
argument_list|(
name|ctx
operator|->
name|ctxname
argument_list|)
condition|;
name|i
operator|++
control|)
name|oid
operator|->
name|subs
index|[
name|sub
operator|+
name|i
index|]
operator|=
name|ctx
operator|->
name|ctxname
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * VACM snmp module initialization hook.  * Returns 0 on success,< 0 on error.  */
end_comment

begin_function
specifier|static
name|int
name|vacm_init
parameter_list|(
name|struct
name|lmodule
modifier|*
name|mod
parameter_list|,
name|int
name|argc
name|__unused
parameter_list|,
name|char
modifier|*
name|argv
index|[]
name|__unused
parameter_list|)
block|{
name|vacm_module
operator|=
name|mod
expr_stmt|;
name|vacm_lock
operator|=
name|random
argument_list|()
expr_stmt|;
name|vacm_groups_init
argument_list|()
expr_stmt|;
comment|/* XXX: TODO - initialize structures */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VACM snmp module finalization hook.  */
end_comment

begin_function
specifier|static
name|int
name|vacm_fini
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* XXX: TODO - cleanup */
name|vacm_flush_contexts
argument_list|(
name|reg_vacm
argument_list|)
expr_stmt|;
name|or_unregister
argument_list|(
name|reg_vacm
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * VACM snmp module start operation.  */
end_comment

begin_function
specifier|static
name|void
name|vacm_start
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|char
name|dflt_ctx
index|[]
init|=
literal|""
decl_stmt|;
name|reg_vacm
operator|=
name|or_register
argument_list|(
operator|&
name|oid_vacm
argument_list|,
literal|"The MIB module for managing SNMP View-based Access Control Model."
argument_list|,
name|vacm_module
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vacm_add_context
argument_list|(
name|dflt_ctx
argument_list|,
name|reg_vacm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vacm_dump
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|vacm_context
modifier|*
name|vacmctx
decl_stmt|;
name|struct
name|vacm_user
modifier|*
name|vuser
decl_stmt|;
name|struct
name|vacm_access
modifier|*
name|vacl
decl_stmt|;
name|struct
name|vacm_view
modifier|*
name|view
decl_stmt|;
specifier|static
name|char
name|oidbuf
index|[
name|ASN_OIDSTRLEN
index|]
decl_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Context list:"
argument_list|)
expr_stmt|;
for|for
control|(
name|vacmctx
operator|=
name|vacm_first_context
argument_list|()
init|;
name|vacmctx
operator|!=
name|NULL
condition|;
name|vacmctx
operator|=
name|vacm_next_context
argument_list|(
name|vacmctx
argument_list|)
control|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Context \"%s\", module id %d"
argument_list|,
name|vacmctx
operator|->
name|ctxname
argument_list|,
name|vacmctx
operator|->
name|regid
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"VACM users:"
argument_list|)
expr_stmt|;
for|for
control|(
name|vuser
operator|=
name|vacm_first_user
argument_list|()
init|;
name|vuser
operator|!=
name|NULL
condition|;
name|vuser
operator|=
name|vacm_next_user
argument_list|(
name|vuser
argument_list|)
control|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Uname %s, Group %s, model %d"
argument_list|,
name|vuser
operator|->
name|secname
argument_list|,
name|vuser
operator|->
name|group
operator|!=
name|NULL
condition|?
name|vuser
operator|->
name|group
operator|->
name|groupname
else|:
literal|"Unknown"
argument_list|,
name|vuser
operator|->
name|sec_model
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"VACM Access rules:"
argument_list|)
expr_stmt|;
for|for
control|(
name|vacl
operator|=
name|vacm_first_access_rule
argument_list|()
init|;
name|vacl
operator|!=
name|NULL
condition|;
name|vacl
operator|=
name|vacm_next_access_rule
argument_list|(
name|vacl
argument_list|)
control|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Group %s, CtxPrefix %s, Model %d, Level %d, "
literal|"RV %s, WR %s, NV %s"
argument_list|,
name|vacl
operator|->
name|group
operator|!=
name|NULL
condition|?
name|vacl
operator|->
name|group
operator|->
name|groupname
else|:
literal|"Unknown"
argument_list|,
name|vacl
operator|->
name|ctx_prefix
argument_list|,
name|vacl
operator|->
name|sec_model
argument_list|,
name|vacl
operator|->
name|sec_level
argument_list|,
name|vacl
operator|->
name|read_view
operator|!=
name|NULL
condition|?
name|vacl
operator|->
name|read_view
operator|->
name|viewname
else|:
literal|"None"
argument_list|,
name|vacl
operator|->
name|write_view
operator|!=
name|NULL
condition|?
name|vacl
operator|->
name|write_view
operator|->
name|viewname
else|:
literal|"None"
argument_list|,
name|vacl
operator|->
name|notify_view
operator|!=
name|NULL
condition|?
name|vacl
operator|->
name|notify_view
operator|->
name|viewname
else|:
literal|"None"
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"VACM Views:"
argument_list|)
expr_stmt|;
for|for
control|(
name|view
operator|=
name|vacm_first_view
argument_list|()
init|;
name|view
operator|!=
name|NULL
condition|;
name|view
operator|=
name|vacm_next_view
argument_list|(
name|view
argument_list|)
control|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"View %s, Tree %s - %s"
argument_list|,
name|view
operator|->
name|viewname
argument_list|,
name|asn_oid2str_r
argument_list|(
operator|&
name|view
operator|->
name|subtree
argument_list|,
name|oidbuf
argument_list|)
argument_list|,
name|view
operator|->
name|exclude
condition|?
literal|"excluded"
else|:
literal|"included"
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|char
name|vacm_comment
index|[]
init|= \
literal|"This module implements SNMP View-based Access Control Model defined in RFC 3415."
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|struct
name|snmp_module
name|config
init|=
block|{
operator|.
name|comment
operator|=
name|vacm_comment
block|,
operator|.
name|init
operator|=
name|vacm_init
block|,
operator|.
name|fini
operator|=
name|vacm_fini
block|,
operator|.
name|start
operator|=
name|vacm_start
block|,
operator|.
name|tree
operator|=
name|vacm_ctree
block|,
operator|.
name|dump
operator|=
name|vacm_dump
block|,
operator|.
name|tree_size
operator|=
name|vacm_CTREE_SIZE
block|, }
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ** Copyright (c) 1999-2001 Sendmail, Inc. and its suppliers. **	All rights reserved. ** ** By using this file, you agree to the terms and conditions set ** forth in the LICENSE file which can be found at the top level of ** the sendmail distribution. */
end_comment

begin_include
include|#
directive|include
file|<sm/gen.h>
end_include

begin_macro
name|SM_RCSID
argument_list|(
literal|"@(#)$Id: smdb2.c,v 8.69 2001/09/12 21:19:12 gshapiro Exp $"
argument_list|)
end_macro

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sendmail/sendmail.h>
end_include

begin_include
include|#
directive|include
file|<libsmdb/smdb.h>
end_include

begin_if
if|#
directive|if
operator|(
name|DB_VERSION_MAJOR
operator|>=
literal|2
operator|)
end_if

begin_define
define|#
directive|define
name|SMDB2_FILE_EXTENSION
value|"db"
end_define

begin_struct
struct|struct
name|smdb_db2_database
block|{
name|DB
modifier|*
name|smdb2_db
decl_stmt|;
name|int
name|smdb2_lock_fd
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|smdb_db2_database
name|SMDB_DB2_DATABASE
typedef|;
end_typedef

begin_comment
comment|/* **  SMDB_TYPE_TO_DB2_TYPE -- Translates smdb database type to db2 type. ** **	Parameters: **		type -- The type to translate. ** **	Returns: **		The DB2 type that corresponsds to the passed in SMDB type. **		Returns -1 if there is no equivalent type. ** */
end_comment

begin_function
name|DBTYPE
name|smdb_type_to_db2_type
parameter_list|(
name|type
parameter_list|)
name|SMDB_DBTYPE
name|type
decl_stmt|;
block|{
if|if
condition|(
name|type
operator|==
name|SMDB_TYPE_DEFAULT
condition|)
return|return
name|DB_HASH
return|;
if|if
condition|(
name|strncmp
argument_list|(
name|type
argument_list|,
name|SMDB_TYPE_HASH
argument_list|,
name|SMDB_TYPE_HASH_LEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|DB_HASH
return|;
if|if
condition|(
name|strncmp
argument_list|(
name|type
argument_list|,
name|SMDB_TYPE_BTREE
argument_list|,
name|SMDB_TYPE_BTREE_LEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|DB_BTREE
return|;
return|return
name|DB_UNKNOWN
return|;
block|}
end_function

begin_comment
comment|/* **  DB2_ERROR_TO_SMDB -- Translates db2 errors to smdbe errors ** **	Parameters: **		error -- The error to translate. ** **	Returns: **		The SMDBE error corresponding to the db2 error. **		If we don't have a corresponding error, it returs errno. ** */
end_comment

begin_function
name|int
name|db2_error_to_smdb
parameter_list|(
name|error
parameter_list|)
name|int
name|error
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
switch|switch
condition|(
name|error
condition|)
block|{
ifdef|#
directive|ifdef
name|DB_INCOMPLETE
case|case
name|DB_INCOMPLETE
case|:
name|result
operator|=
name|SMDBE_INCOMPLETE
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* DB_INCOMPLETE */
ifdef|#
directive|ifdef
name|DB_NOTFOUND
case|case
name|DB_NOTFOUND
case|:
name|result
operator|=
name|SMDBE_NOT_FOUND
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* DB_NOTFOUND */
ifdef|#
directive|ifdef
name|DB_KEYEMPTY
case|case
name|DB_KEYEMPTY
case|:
name|result
operator|=
name|SMDBE_KEY_EMPTY
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* DB_KEYEMPTY */
ifdef|#
directive|ifdef
name|DB_KEYEXIST
case|case
name|DB_KEYEXIST
case|:
name|result
operator|=
name|SMDBE_KEY_EXIST
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* DB_KEYEXIST */
ifdef|#
directive|ifdef
name|DB_LOCK_DEADLOCK
case|case
name|DB_LOCK_DEADLOCK
case|:
name|result
operator|=
name|SMDBE_LOCK_DEADLOCK
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* DB_LOCK_DEADLOCK */
ifdef|#
directive|ifdef
name|DB_LOCK_NOTGRANTED
case|case
name|DB_LOCK_NOTGRANTED
case|:
name|result
operator|=
name|SMDBE_LOCK_NOT_GRANTED
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* DB_LOCK_NOTGRANTED */
ifdef|#
directive|ifdef
name|DB_LOCK_NOTHELD
case|case
name|DB_LOCK_NOTHELD
case|:
name|result
operator|=
name|SMDBE_LOCK_NOT_HELD
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* DB_LOCK_NOTHELD */
ifdef|#
directive|ifdef
name|DB_RUNRECOVERY
case|case
name|DB_RUNRECOVERY
case|:
name|result
operator|=
name|SMDBE_RUN_RECOVERY
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* DB_RUNRECOVERY */
ifdef|#
directive|ifdef
name|DB_OLD_VERSION
case|case
name|DB_OLD_VERSION
case|:
name|result
operator|=
name|SMDBE_OLD_VERSION
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* DB_OLD_VERSION */
case|case
literal|0
case|:
name|result
operator|=
name|SMDBE_OK
expr_stmt|;
break|break;
default|default:
name|result
operator|=
name|error
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* **  SMDB_PUT_FLAGS_TO_DB2_FLAGS -- Translates smdb put flags to db2 put flags. ** **	Parameters: **		flags -- The flags to translate. ** **	Returns: **		The db2 flags that are equivalent to the smdb flags. ** **	Notes: **		Any invalid flags are ignored. ** */
end_comment

begin_function
name|unsigned
name|int
name|smdb_put_flags_to_db2_flags
parameter_list|(
name|flags
parameter_list|)
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|int
name|return_flags
decl_stmt|;
name|return_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bitset
argument_list|(
name|SMDBF_NO_OVERWRITE
argument_list|,
name|flags
argument_list|)
condition|)
name|return_flags
operator||=
name|DB_NOOVERWRITE
expr_stmt|;
return|return
name|return_flags
return|;
block|}
end_function

begin_comment
comment|/* **  SMDB_CURSOR_GET_FLAGS_TO_DB2 -- Translates smdb cursor get flags to db2 **	getflags. ** **	Parameters: **		flags -- The flags to translate. ** **	Returns: **		The db2 flags that are equivalent to the smdb flags. ** **	Notes: **		-1 is returned if flag is unknown. ** */
end_comment

begin_function
name|int
name|smdb_cursor_get_flags_to_db2
parameter_list|(
name|flags
parameter_list|)
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
switch|switch
condition|(
name|flags
condition|)
block|{
case|case
name|SMDB_CURSOR_GET_FIRST
case|:
return|return
name|DB_FIRST
return|;
case|case
name|SMDB_CURSOR_GET_LAST
case|:
return|return
name|DB_LAST
return|;
case|case
name|SMDB_CURSOR_GET_NEXT
case|:
return|return
name|DB_NEXT
return|;
case|case
name|SMDB_CURSOR_GET_RANGE
case|:
return|return
name|DB_SET_RANGE
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_comment
comment|/* **  Except for smdb_db_open, the rest of these functions correspond to the **  interface laid out in smdb.h. */
end_comment

begin_function
name|SMDB_DB2_DATABASE
modifier|*
name|smdb2_malloc_database
parameter_list|()
block|{
name|SMDB_DB2_DATABASE
modifier|*
name|db2
decl_stmt|;
name|db2
operator|=
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SMDB_DB2_DATABASE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|db2
operator|!=
name|NULL
condition|)
name|db2
operator|->
name|smdb2_lock_fd
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|db2
return|;
block|}
end_function

begin_function
name|int
name|smdb2_close
parameter_list|(
name|database
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|SMDB_DB2_DATABASE
modifier|*
name|db2
init|=
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
decl_stmt|;
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb2_db
decl_stmt|;
name|result
operator|=
name|db2_error_to_smdb
argument_list|(
name|db
operator|->
name|close
argument_list|(
name|db
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|db2
operator|->
name|smdb2_lock_fd
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|db2
operator|->
name|smdb2_lock_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db2
argument_list|)
expr_stmt|;
name|database
operator|->
name|smdb_impl
operator|=
name|NULL
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|int
name|smdb2_del
parameter_list|(
name|database
parameter_list|,
name|key
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
block|{
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb2_db
decl_stmt|;
name|DBT
name|dbkey
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbkey
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbkey
argument_list|)
expr_stmt|;
name|dbkey
operator|.
name|data
operator|=
name|key
operator|->
name|data
expr_stmt|;
name|dbkey
operator|.
name|size
operator|=
name|key
operator|->
name|size
expr_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|db
operator|->
name|del
argument_list|(
name|db
argument_list|,
name|NULL
argument_list|,
operator|&
name|dbkey
argument_list|,
name|flags
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb2_fd
parameter_list|(
name|database
parameter_list|,
name|fd
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|int
modifier|*
name|fd
decl_stmt|;
block|{
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb2_db
decl_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|db
operator|->
name|fd
argument_list|(
name|db
argument_list|,
name|fd
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb2_lockfd
parameter_list|(
name|database
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
block|{
name|SMDB_DB2_DATABASE
modifier|*
name|db2
init|=
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
decl_stmt|;
return|return
name|db2
operator|->
name|smdb2_lock_fd
return|;
block|}
end_function

begin_function
name|int
name|smdb2_get
parameter_list|(
name|database
parameter_list|,
name|key
parameter_list|,
name|data
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|data
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb2_db
decl_stmt|;
name|DBT
name|dbkey
decl_stmt|,
name|dbdata
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbdata
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbkey
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbkey
argument_list|)
expr_stmt|;
name|dbkey
operator|.
name|data
operator|=
name|key
operator|->
name|data
expr_stmt|;
name|dbkey
operator|.
name|size
operator|=
name|key
operator|->
name|size
expr_stmt|;
name|result
operator|=
name|db
operator|->
name|get
argument_list|(
name|db
argument_list|,
name|NULL
argument_list|,
operator|&
name|dbkey
argument_list|,
operator|&
name|dbdata
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|data
operator|->
name|data
operator|=
name|dbdata
operator|.
name|data
expr_stmt|;
name|data
operator|->
name|size
operator|=
name|dbdata
operator|.
name|size
expr_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|result
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb2_put
parameter_list|(
name|database
parameter_list|,
name|key
parameter_list|,
name|data
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|data
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
block|{
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb2_db
decl_stmt|;
name|DBT
name|dbkey
decl_stmt|,
name|dbdata
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbdata
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbkey
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbkey
argument_list|)
expr_stmt|;
name|dbkey
operator|.
name|data
operator|=
name|key
operator|->
name|data
expr_stmt|;
name|dbkey
operator|.
name|size
operator|=
name|key
operator|->
name|size
expr_stmt|;
name|dbdata
operator|.
name|data
operator|=
name|data
operator|->
name|data
expr_stmt|;
name|dbdata
operator|.
name|size
operator|=
name|data
operator|->
name|size
expr_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|db
operator|->
name|put
argument_list|(
name|db
argument_list|,
name|NULL
argument_list|,
operator|&
name|dbkey
argument_list|,
operator|&
name|dbdata
argument_list|,
name|smdb_put_flags_to_db2_flags
argument_list|(
name|flags
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb2_set_owner
parameter_list|(
name|database
parameter_list|,
name|uid
parameter_list|,
name|gid
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|uid_t
name|uid
decl_stmt|;
name|gid_t
name|gid
decl_stmt|;
block|{
if|#
directive|if
name|HASFCHOWN
name|int
name|fd
decl_stmt|;
name|int
name|result
decl_stmt|;
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb2_db
decl_stmt|;
name|result
operator|=
name|db
operator|->
name|fd
argument_list|(
name|db
argument_list|,
operator|&
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
return|return
name|result
return|;
name|result
operator|=
name|fchown
argument_list|(
name|fd
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
return|return
name|errno
return|;
endif|#
directive|endif
comment|/* HASFCHOWN */
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdb2_sync
parameter_list|(
name|database
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
block|{
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb2_db
decl_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|db
operator|->
name|sync
argument_list|(
name|db
argument_list|,
name|flags
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb2_cursor_close
parameter_list|(
name|cursor
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
block|{
name|int
name|ret
decl_stmt|;
name|DBC
modifier|*
name|dbc
init|=
operator|(
name|DBC
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|ret
operator|=
name|db2_error_to_smdb
argument_list|(
name|dbc
operator|->
name|c_close
argument_list|(
name|dbc
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|smdb2_cursor_del
parameter_list|(
name|cursor
parameter_list|,
name|flags
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|DBC
modifier|*
name|dbc
init|=
operator|(
name|DBC
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|dbc
operator|->
name|c_del
argument_list|(
name|dbc
argument_list|,
literal|0
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb2_cursor_get
parameter_list|(
name|cursor
parameter_list|,
name|key
parameter_list|,
name|value
parameter_list|,
name|flags
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|value
decl_stmt|;
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|int
name|db2_flags
decl_stmt|;
name|int
name|result
decl_stmt|;
name|DBC
modifier|*
name|dbc
init|=
operator|(
name|DBC
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|DBT
name|dbkey
decl_stmt|,
name|dbdata
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbdata
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbkey
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbkey
argument_list|)
expr_stmt|;
name|db2_flags
operator|=
name|smdb_cursor_get_flags_to_db2
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|result
operator|=
name|dbc
operator|->
name|c_get
argument_list|(
name|dbc
argument_list|,
operator|&
name|dbkey
argument_list|,
operator|&
name|dbdata
argument_list|,
name|db2_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|DB_NOTFOUND
condition|)
return|return
name|SMDBE_LAST_ENTRY
return|;
name|key
operator|->
name|data
operator|=
name|dbkey
operator|.
name|data
expr_stmt|;
name|key
operator|->
name|size
operator|=
name|dbkey
operator|.
name|size
expr_stmt|;
name|value
operator|->
name|data
operator|=
name|dbdata
operator|.
name|data
expr_stmt|;
name|value
operator|->
name|size
operator|=
name|dbdata
operator|.
name|size
expr_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|result
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb2_cursor_put
parameter_list|(
name|cursor
parameter_list|,
name|key
parameter_list|,
name|value
parameter_list|,
name|flags
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|value
decl_stmt|;
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|DBC
modifier|*
name|dbc
init|=
operator|(
name|DBC
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|DBT
name|dbkey
decl_stmt|,
name|dbdata
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbdata
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbdata
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbkey
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbkey
argument_list|)
expr_stmt|;
name|dbkey
operator|.
name|data
operator|=
name|key
operator|->
name|data
expr_stmt|;
name|dbkey
operator|.
name|size
operator|=
name|key
operator|->
name|size
expr_stmt|;
name|dbdata
operator|.
name|data
operator|=
name|value
operator|->
name|data
expr_stmt|;
name|dbdata
operator|.
name|size
operator|=
name|value
operator|->
name|size
expr_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|dbc
operator|->
name|c_put
argument_list|(
name|dbc
argument_list|,
operator|&
name|dbkey
argument_list|,
operator|&
name|dbdata
argument_list|,
literal|0
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb2_cursor
parameter_list|(
name|database
parameter_list|,
name|cursor
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_CURSOR
modifier|*
modifier|*
name|cursor
decl_stmt|;
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB2_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb2_db
decl_stmt|;
name|DBC
modifier|*
name|db2_cursor
decl_stmt|;
if|#
directive|if
name|DB_VERSION_MAJOR
operator|>
literal|2
operator|||
name|DB_VERSION_MINOR
operator|>=
literal|6
name|result
operator|=
name|db
operator|->
name|cursor
argument_list|(
name|db
argument_list|,
name|NULL
argument_list|,
operator|&
name|db2_cursor
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* DB_VERSION_MAJOR> 2 || DB_VERSION_MINOR>= 6 */
name|result
operator|=
name|db
operator|->
name|cursor
argument_list|(
name|db
argument_list|,
name|NULL
argument_list|,
operator|&
name|db2_cursor
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DB_VERSION_MAJOR> 2 || DB_VERSION_MINOR>= 6 */
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
return|return
name|db2_error_to_smdb
argument_list|(
name|result
argument_list|)
return|;
operator|*
name|cursor
operator|=
operator|(
name|SMDB_CURSOR
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SMDB_CURSOR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cursor
operator|==
name|NULL
condition|)
return|return
name|SMDBE_MALLOC
return|;
operator|(
operator|*
name|cursor
operator|)
operator|->
name|smdbc_close
operator|=
name|smdb2_cursor_close
expr_stmt|;
operator|(
operator|*
name|cursor
operator|)
operator|->
name|smdbc_del
operator|=
name|smdb2_cursor_del
expr_stmt|;
operator|(
operator|*
name|cursor
operator|)
operator|->
name|smdbc_get
operator|=
name|smdb2_cursor_get
expr_stmt|;
operator|(
operator|*
name|cursor
operator|)
operator|->
name|smdbc_put
operator|=
name|smdb2_cursor_put
expr_stmt|;
operator|(
operator|*
name|cursor
operator|)
operator|->
name|smdbc_impl
operator|=
name|db2_cursor
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
name|DB_VERSION_MAJOR
operator|==
literal|2
end_if

begin_function
specifier|static
name|int
name|smdb_db_open_internal
parameter_list|(
name|db_name
parameter_list|,
name|db_type
parameter_list|,
name|db_flags
parameter_list|,
name|db_params
parameter_list|,
name|db
parameter_list|)
name|char
modifier|*
name|db_name
decl_stmt|;
name|DBTYPE
name|db_type
decl_stmt|;
name|int
name|db_flags
decl_stmt|;
name|SMDB_DBPARAMS
modifier|*
name|db_params
decl_stmt|;
name|DB
modifier|*
modifier|*
name|db
decl_stmt|;
block|{
name|void
modifier|*
name|params
decl_stmt|;
name|DB_INFO
name|db_info
decl_stmt|;
name|params
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|db_info
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|db_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|db_params
operator|!=
name|NULL
condition|)
block|{
name|db_info
operator|.
name|db_cachesize
operator|=
name|db_params
operator|->
name|smdbp_cache_size
expr_stmt|;
if|if
condition|(
name|db_type
operator|==
name|DB_HASH
condition|)
name|db_info
operator|.
name|h_nelem
operator|=
name|db_params
operator|->
name|smdbp_num_elements
expr_stmt|;
if|if
condition|(
name|db_params
operator|->
name|smdbp_allow_dup
condition|)
name|db_info
operator|.
name|flags
operator||=
name|DB_DUP
expr_stmt|;
name|params
operator|=
operator|&
name|db_info
expr_stmt|;
block|}
return|return
name|db_open
argument_list|(
name|db_name
argument_list|,
name|db_type
argument_list|,
name|db_flags
argument_list|,
literal|0644
argument_list|,
name|NULL
argument_list|,
name|params
argument_list|,
name|db
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DB_VERSION_MAJOR == 2 */
end_comment

begin_if
if|#
directive|if
name|DB_VERSION_MAJOR
operator|>
literal|2
end_if

begin_function
specifier|static
name|int
name|smdb_db_open_internal
parameter_list|(
name|db_name
parameter_list|,
name|db_type
parameter_list|,
name|db_flags
parameter_list|,
name|db_params
parameter_list|,
name|db
parameter_list|)
name|char
modifier|*
name|db_name
decl_stmt|;
name|DBTYPE
name|db_type
decl_stmt|;
name|int
name|db_flags
decl_stmt|;
name|SMDB_DBPARAMS
modifier|*
name|db_params
decl_stmt|;
name|DB
modifier|*
modifier|*
name|db
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|result
operator|=
name|db_create
argument_list|(
name|db
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
operator|||
operator|*
name|db
operator|==
name|NULL
condition|)
return|return
name|result
return|;
if|if
condition|(
name|db_params
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
operator|(
operator|*
name|db
operator|)
operator|->
name|set_cachesize
argument_list|(
operator|*
name|db
argument_list|,
literal|0
argument_list|,
name|db_params
operator|->
name|smdbp_cache_size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
call|(
name|void
call|)
argument_list|(
operator|*
name|db
argument_list|)
operator|->
name|close
argument_list|(
operator|(
operator|*
name|db
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|db
operator|=
name|NULL
expr_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|result
argument_list|)
return|;
block|}
if|if
condition|(
name|db_type
operator|==
name|DB_HASH
condition|)
block|{
name|result
operator|=
operator|(
operator|*
name|db
operator|)
operator|->
name|set_h_nelem
argument_list|(
operator|*
name|db
argument_list|,
name|db_params
operator|->
name|smdbp_num_elements
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
call|(
name|void
call|)
argument_list|(
operator|*
name|db
argument_list|)
operator|->
name|close
argument_list|(
operator|*
name|db
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|db
operator|=
name|NULL
expr_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|result
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|db_params
operator|->
name|smdbp_allow_dup
condition|)
block|{
name|result
operator|=
operator|(
operator|*
name|db
operator|)
operator|->
name|set_flags
argument_list|(
operator|*
name|db
argument_list|,
name|DB_DUP
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
call|(
name|void
call|)
argument_list|(
operator|*
name|db
argument_list|)
operator|->
name|close
argument_list|(
operator|*
name|db
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|db
operator|=
name|NULL
expr_stmt|;
return|return
name|db2_error_to_smdb
argument_list|(
name|result
argument_list|)
return|;
block|}
block|}
block|}
name|result
operator|=
operator|(
operator|*
name|db
operator|)
operator|->
name|open
argument_list|(
operator|*
name|db
argument_list|,
name|db_name
argument_list|,
name|NULL
argument_list|,
name|db_type
argument_list|,
name|db_flags
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
call|(
name|void
call|)
argument_list|(
operator|*
name|db
argument_list|)
operator|->
name|close
argument_list|(
operator|*
name|db
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|db
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|db2_error_to_smdb
argument_list|(
name|result
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DB_VERSION_MAJOR> 2 */
end_comment

begin_comment
comment|/* **  SMDB_DB_OPEN -- Opens a db database. ** **	Parameters: **		database -- An unallocated database pointer to a pointer. **		db_name -- The name of the database without extension. **		mode -- File permisions for a created database. **		mode_mask -- Mode bits that must match on an opened database. **		sff -- Flags for safefile. **		type -- The type of database to open **			See smdb_type_to_db2_type for valid types. **		user_info -- User information for file permissions. **		db_params -- **			An SMDB_DBPARAMS struct including params. These **			are processed according to the type of the **			database. Currently supported params (only for **			HASH type) are: **			   num_elements **			   cache_size ** **	Returns: **		SMDBE_OK -- Success, other errno: **		SMDBE_MALLOC -- Cannot allocate memory. **		SMDBE_BAD_OPEN -- db_open didn't return an error, but **				 somehow the DB pointer is NULL. **		Anything else: translated error from db2 */
end_comment

begin_function
name|int
name|smdb_db_open
parameter_list|(
name|database
parameter_list|,
name|db_name
parameter_list|,
name|mode
parameter_list|,
name|mode_mask
parameter_list|,
name|sff
parameter_list|,
name|type
parameter_list|,
name|user_info
parameter_list|,
name|db_params
parameter_list|)
name|SMDB_DATABASE
modifier|*
modifier|*
name|database
decl_stmt|;
name|char
modifier|*
name|db_name
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|int
name|mode_mask
decl_stmt|;
name|long
name|sff
decl_stmt|;
name|SMDB_DBTYPE
name|type
decl_stmt|;
name|SMDB_USER_INFO
modifier|*
name|user_info
decl_stmt|;
name|SMDB_DBPARAMS
modifier|*
name|db_params
decl_stmt|;
block|{
name|bool
name|lockcreated
init|=
name|false
decl_stmt|;
name|int
name|result
decl_stmt|;
name|int
name|db_flags
decl_stmt|;
name|int
name|lock_fd
decl_stmt|;
name|int
name|db_fd
decl_stmt|;
name|SMDB_DATABASE
modifier|*
name|smdb_db
decl_stmt|;
name|SMDB_DB2_DATABASE
modifier|*
name|db2
decl_stmt|;
name|DB
modifier|*
name|db
decl_stmt|;
name|DBTYPE
name|db_type
decl_stmt|;
name|struct
name|stat
name|stat_info
decl_stmt|;
name|char
name|db_file_name
index|[
name|SMDB_MAX_NAME_LEN
index|]
decl_stmt|;
operator|*
name|database
operator|=
name|NULL
expr_stmt|;
name|result
operator|=
name|smdb_add_extension
argument_list|(
name|db_file_name
argument_list|,
name|SMDB_MAX_NAME_LEN
argument_list|,
name|db_name
argument_list|,
name|SMDB2_FILE_EXTENSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
name|result
operator|=
name|smdb_setup_file
argument_list|(
name|db_name
argument_list|,
name|SMDB2_FILE_EXTENSION
argument_list|,
name|mode_mask
argument_list|,
name|sff
argument_list|,
name|user_info
argument_list|,
operator|&
name|stat_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
name|lock_fd
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|stat_info
operator|.
name|st_mode
operator|==
name|ST_MODE_NOFILE
operator|&&
name|bitset
argument_list|(
name|mode
argument_list|,
name|O_CREAT
argument_list|)
condition|)
name|lockcreated
operator|=
name|true
expr_stmt|;
name|result
operator|=
name|smdb_lock_file
argument_list|(
operator|&
name|lock_fd
argument_list|,
name|db_name
argument_list|,
name|mode
argument_list|,
name|sff
argument_list|,
name|SMDB2_FILE_EXTENSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
if|if
condition|(
name|lockcreated
condition|)
block|{
name|mode
operator||=
name|O_TRUNC
expr_stmt|;
name|mode
operator|&=
operator|~
operator|(
name|O_CREAT
operator||
name|O_EXCL
operator|)
expr_stmt|;
block|}
name|smdb_db
operator|=
name|smdb_malloc_database
argument_list|()
expr_stmt|;
if|if
condition|(
name|smdb_db
operator|==
name|NULL
condition|)
return|return
name|SMDBE_MALLOC
return|;
name|db2
operator|=
name|smdb2_malloc_database
argument_list|()
expr_stmt|;
if|if
condition|(
name|db2
operator|==
name|NULL
condition|)
return|return
name|SMDBE_MALLOC
return|;
name|db2
operator|->
name|smdb2_lock_fd
operator|=
name|lock_fd
expr_stmt|;
name|db_type
operator|=
name|smdb_type_to_db2_type
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|db
operator|=
name|NULL
expr_stmt|;
name|db_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bitset
argument_list|(
name|O_CREAT
argument_list|,
name|mode
argument_list|)
condition|)
name|db_flags
operator||=
name|DB_CREATE
expr_stmt|;
if|if
condition|(
name|bitset
argument_list|(
name|O_TRUNC
argument_list|,
name|mode
argument_list|)
condition|)
name|db_flags
operator||=
name|DB_TRUNCATE
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|O_RDONLY
condition|)
name|db_flags
operator||=
name|DB_RDONLY
expr_stmt|;
if|#
directive|if
operator|!
name|HASFLOCK
operator|&&
name|defined
argument_list|(
name|DB_FCNTL_LOCKING
argument_list|)
name|db_flags
operator||=
name|DB_FCNTL_LOCKING
expr_stmt|;
endif|#
directive|endif
comment|/* !HASFLOCK&& defined(DB_FCNTL_LOCKING) */
name|result
operator|=
name|smdb_db_open_internal
argument_list|(
name|db_file_name
argument_list|,
name|db_type
argument_list|,
name|db_flags
argument_list|,
name|db_params
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
literal|0
operator|&&
name|db
operator|!=
name|NULL
condition|)
block|{
name|result
operator|=
name|db
operator|->
name|fd
argument_list|(
name|db
argument_list|,
operator|&
name|db_fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
literal|0
condition|)
name|result
operator|=
name|SMDBE_OK
expr_stmt|;
block|}
else|else
block|{
comment|/* Try and narrow down on the problem */
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
name|result
operator|=
name|db2_error_to_smdb
argument_list|(
name|result
argument_list|)
expr_stmt|;
else|else
name|result
operator|=
name|SMDBE_BAD_OPEN
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|SMDBE_OK
condition|)
name|result
operator|=
name|smdb_filechanged
argument_list|(
name|db_name
argument_list|,
name|SMDB2_FILE_EXTENSION
argument_list|,
name|db_fd
argument_list|,
operator|&
name|stat_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|SMDBE_OK
condition|)
block|{
comment|/* Everything is ok. Setup driver */
name|db2
operator|->
name|smdb2_db
operator|=
name|db
expr_stmt|;
name|smdb_db
operator|->
name|smdb_close
operator|=
name|smdb2_close
expr_stmt|;
name|smdb_db
operator|->
name|smdb_del
operator|=
name|smdb2_del
expr_stmt|;
name|smdb_db
operator|->
name|smdb_fd
operator|=
name|smdb2_fd
expr_stmt|;
name|smdb_db
operator|->
name|smdb_lockfd
operator|=
name|smdb2_lockfd
expr_stmt|;
name|smdb_db
operator|->
name|smdb_get
operator|=
name|smdb2_get
expr_stmt|;
name|smdb_db
operator|->
name|smdb_put
operator|=
name|smdb2_put
expr_stmt|;
name|smdb_db
operator|->
name|smdb_set_owner
operator|=
name|smdb2_set_owner
expr_stmt|;
name|smdb_db
operator|->
name|smdb_sync
operator|=
name|smdb2_sync
expr_stmt|;
name|smdb_db
operator|->
name|smdb_cursor
operator|=
name|smdb2_cursor
expr_stmt|;
name|smdb_db
operator|->
name|smdb_impl
operator|=
name|db2
expr_stmt|;
operator|*
name|database
operator|=
name|smdb_db
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|db
operator|->
name|close
argument_list|(
name|db
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|smdb_unlock_file
argument_list|(
name|db2
operator|->
name|smdb2_lock_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db2
argument_list|)
expr_stmt|;
name|smdb_free_database
argument_list|(
name|smdb_db
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (DB_VERSION_MAJOR>= 2) */
end_comment

end_unit


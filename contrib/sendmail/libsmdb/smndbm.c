begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ** Copyright (c) 1999-2002 Sendmail, Inc. and its suppliers. **	All rights reserved. ** ** By using this file, you agree to the terms and conditions set ** forth in the LICENSE file which can be found at the top level of ** the sendmail distribution. */
end_comment

begin_include
include|#
directive|include
file|<sm/gen.h>
end_include

begin_macro
name|SM_RCSID
argument_list|(
literal|"@(#)$Id: smndbm.c,v 8.51 2002/01/21 04:10:44 gshapiro Exp $"
argument_list|)
end_macro

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sendmail/sendmail.h>
end_include

begin_include
include|#
directive|include
file|<libsmdb/smdb.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|NDBM
end_ifdef

begin_define
define|#
directive|define
name|SMNDB_DIR_FILE_EXTENSION
value|"dir"
end_define

begin_define
define|#
directive|define
name|SMNDB_PAG_FILE_EXTENSION
value|"pag"
end_define

begin_struct
struct|struct
name|smdb_dbm_database_struct
block|{
name|DBM
modifier|*
name|smndbm_dbm
decl_stmt|;
name|int
name|smndbm_lock_fd
decl_stmt|;
name|bool
name|smndbm_cursor_in_use
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|smdb_dbm_database_struct
name|SMDB_DBM_DATABASE
typedef|;
end_typedef

begin_struct
struct|struct
name|smdb_dbm_cursor_struct
block|{
name|SMDB_DBM_DATABASE
modifier|*
name|smndbmc_db
decl_stmt|;
name|datum
name|smndbmc_current_key
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|smdb_dbm_cursor_struct
name|SMDB_DBM_CURSOR
typedef|;
end_typedef

begin_comment
comment|/* **  SMDB_PUT_FLAGS_TO_NDBM_FLAGS -- Translates smdb put flags to ndbm put flags. ** **	Parameters: **		flags -- The flags to translate. ** **	Returns: **		The ndbm flags that are equivalent to the smdb flags. ** **	Notes: **		Any invalid flags are ignored. ** */
end_comment

begin_function
name|int
name|smdb_put_flags_to_ndbm_flags
parameter_list|(
name|flags
parameter_list|)
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|int
name|return_flags
decl_stmt|;
name|return_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bitset
argument_list|(
name|SMDBF_NO_OVERWRITE
argument_list|,
name|flags
argument_list|)
condition|)
name|return_flags
operator|=
name|DBM_INSERT
expr_stmt|;
else|else
name|return_flags
operator|=
name|DBM_REPLACE
expr_stmt|;
return|return
name|return_flags
return|;
block|}
end_function

begin_comment
comment|/* **  Except for smdb_ndbm_open, the rest of these function correspond to the **  interface laid out in smdb.h. */
end_comment

begin_function
name|SMDB_DBM_DATABASE
modifier|*
name|smdbm_malloc_database
parameter_list|()
block|{
name|SMDB_DBM_DATABASE
modifier|*
name|db
decl_stmt|;
name|db
operator|=
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SMDB_DBM_DATABASE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
block|{
name|db
operator|->
name|smndbm_dbm
operator|=
name|NULL
expr_stmt|;
name|db
operator|->
name|smndbm_lock_fd
operator|=
operator|-
literal|1
expr_stmt|;
name|db
operator|->
name|smndbm_cursor_in_use
operator|=
name|false
expr_stmt|;
block|}
return|return
name|db
return|;
block|}
end_function

begin_function
name|int
name|smdbm_close
parameter_list|(
name|database
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
block|{
name|SMDB_DBM_DATABASE
modifier|*
name|db
init|=
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
decl_stmt|;
name|DBM
modifier|*
name|dbm
init|=
operator|(
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smndbm_dbm
decl_stmt|;
name|dbm_close
argument_list|(
name|dbm
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|->
name|smndbm_lock_fd
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|db
operator|->
name|smndbm_lock_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|database
operator|->
name|smdb_impl
operator|=
name|NULL
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdbm_del
parameter_list|(
name|database
parameter_list|,
name|key
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|DBM
modifier|*
name|dbm
init|=
operator|(
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smndbm_dbm
decl_stmt|;
name|datum
name|dbkey
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbkey
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbkey
argument_list|)
expr_stmt|;
name|dbkey
operator|.
name|dptr
operator|=
name|key
operator|->
name|data
expr_stmt|;
name|dbkey
operator|.
name|dsize
operator|=
name|key
operator|->
name|size
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dbm_delete
argument_list|(
name|dbm
argument_list|,
name|dbkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
if|if
condition|(
name|dbm_error
argument_list|(
name|dbm
argument_list|)
condition|)
return|return
name|SMDBE_IO_ERROR
return|;
if|if
condition|(
name|save_errno
operator|!=
literal|0
condition|)
return|return
name|save_errno
return|;
return|return
name|SMDBE_NOT_FOUND
return|;
block|}
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdbm_fd
parameter_list|(
name|database
parameter_list|,
name|fd
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|int
modifier|*
name|fd
decl_stmt|;
block|{
name|DBM
modifier|*
name|dbm
init|=
operator|(
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smndbm_dbm
decl_stmt|;
operator|*
name|fd
operator|=
name|dbm_dirfno
argument_list|(
name|dbm
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fd
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdbm_lockfd
parameter_list|(
name|database
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
block|{
name|SMDB_DBM_DATABASE
modifier|*
name|db
init|=
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
decl_stmt|;
return|return
name|db
operator|->
name|smndbm_lock_fd
return|;
block|}
end_function

begin_function
name|int
name|smdbm_get
parameter_list|(
name|database
parameter_list|,
name|key
parameter_list|,
name|data
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|data
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
block|{
name|DBM
modifier|*
name|dbm
init|=
operator|(
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smndbm_dbm
decl_stmt|;
name|datum
name|dbkey
decl_stmt|,
name|dbdata
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbkey
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbkey
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbdata
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbdata
argument_list|)
expr_stmt|;
name|dbkey
operator|.
name|dptr
operator|=
name|key
operator|->
name|data
expr_stmt|;
name|dbkey
operator|.
name|dsize
operator|=
name|key
operator|->
name|size
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|dbdata
operator|=
name|dbm_fetch
argument_list|(
name|dbm
argument_list|,
name|dbkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbdata
operator|.
name|dptr
operator|==
name|NULL
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
if|if
condition|(
name|dbm_error
argument_list|(
name|dbm
argument_list|)
condition|)
return|return
name|SMDBE_IO_ERROR
return|;
if|if
condition|(
name|save_errno
operator|!=
literal|0
condition|)
return|return
name|save_errno
return|;
return|return
name|SMDBE_NOT_FOUND
return|;
block|}
name|data
operator|->
name|data
operator|=
name|dbdata
operator|.
name|dptr
expr_stmt|;
name|data
operator|->
name|size
operator|=
name|dbdata
operator|.
name|dsize
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdbm_put
parameter_list|(
name|database
parameter_list|,
name|key
parameter_list|,
name|data
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|data
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|int
name|save_errno
decl_stmt|;
name|DBM
modifier|*
name|dbm
init|=
operator|(
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smndbm_dbm
decl_stmt|;
name|datum
name|dbkey
decl_stmt|,
name|dbdata
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbkey
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbkey
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbdata
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbdata
argument_list|)
expr_stmt|;
name|dbkey
operator|.
name|dptr
operator|=
name|key
operator|->
name|data
expr_stmt|;
name|dbkey
operator|.
name|dsize
operator|=
name|key
operator|->
name|size
expr_stmt|;
name|dbdata
operator|.
name|dptr
operator|=
name|data
operator|->
name|data
expr_stmt|;
name|dbdata
operator|.
name|dsize
operator|=
name|data
operator|->
name|size
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dbm_store
argument_list|(
name|dbm
argument_list|,
name|dbkey
argument_list|,
name|dbdata
argument_list|,
name|smdb_put_flags_to_ndbm_flags
argument_list|(
name|flags
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
literal|1
case|:
return|return
name|SMDBE_DUPLICATE
return|;
case|case
literal|0
case|:
return|return
name|SMDBE_OK
return|;
default|default:
name|save_errno
operator|=
name|errno
expr_stmt|;
if|if
condition|(
name|dbm_error
argument_list|(
name|dbm
argument_list|)
condition|)
return|return
name|SMDBE_IO_ERROR
return|;
if|if
condition|(
name|save_errno
operator|!=
literal|0
condition|)
return|return
name|save_errno
return|;
return|return
name|SMDBE_IO_ERROR
return|;
block|}
comment|/* NOTREACHED */
block|}
end_function

begin_function
name|int
name|smndbm_set_owner
parameter_list|(
name|database
parameter_list|,
name|uid
parameter_list|,
name|gid
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|uid_t
name|uid
decl_stmt|;
name|gid_t
name|gid
decl_stmt|;
block|{
if|#
directive|if
name|HASFCHOWN
name|int
name|fd
decl_stmt|;
name|int
name|result
decl_stmt|;
name|DBM
modifier|*
name|dbm
init|=
operator|(
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smndbm_dbm
decl_stmt|;
name|fd
operator|=
name|dbm_dirfno
argument_list|(
name|dbm
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
name|result
operator|=
name|fchown
argument_list|(
name|fd
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
return|return
name|errno
return|;
name|fd
operator|=
name|dbm_pagfno
argument_list|(
name|dbm
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<=
literal|0
condition|)
return|return
name|EINVAL
return|;
name|result
operator|=
name|fchown
argument_list|(
name|fd
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
return|return
name|errno
return|;
endif|#
directive|endif
comment|/* HASFCHOWN */
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdbm_sync
parameter_list|(
name|database
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
block|{
return|return
name|SMDBE_UNSUPPORTED
return|;
block|}
end_function

begin_function
name|int
name|smdbm_cursor_close
parameter_list|(
name|cursor
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
block|{
name|SMDB_DBM_CURSOR
modifier|*
name|dbm_cursor
init|=
operator|(
name|SMDB_DBM_CURSOR
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|SMDB_DBM_DATABASE
modifier|*
name|db
init|=
name|dbm_cursor
operator|->
name|smndbmc_db
decl_stmt|;
if|if
condition|(
operator|!
name|db
operator|->
name|smndbm_cursor_in_use
condition|)
return|return
name|SMDBE_NOT_A_VALID_CURSOR
return|;
name|db
operator|->
name|smndbm_cursor_in_use
operator|=
name|false
expr_stmt|;
name|free
argument_list|(
name|dbm_cursor
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdbm_cursor_del
parameter_list|(
name|cursor
parameter_list|,
name|flags
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|SMDB_DBM_CURSOR
modifier|*
name|dbm_cursor
init|=
operator|(
name|SMDB_DBM_CURSOR
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|SMDB_DBM_DATABASE
modifier|*
name|db
init|=
name|dbm_cursor
operator|->
name|smndbmc_db
decl_stmt|;
name|DBM
modifier|*
name|dbm
init|=
name|db
operator|->
name|smndbm_dbm
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dbm_delete
argument_list|(
name|dbm
argument_list|,
name|dbm_cursor
operator|->
name|smndbmc_current_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
if|if
condition|(
name|dbm_error
argument_list|(
name|dbm
argument_list|)
condition|)
return|return
name|SMDBE_IO_ERROR
return|;
if|if
condition|(
name|save_errno
operator|!=
literal|0
condition|)
return|return
name|save_errno
return|;
return|return
name|SMDBE_NOT_FOUND
return|;
block|}
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdbm_cursor_get
parameter_list|(
name|cursor
parameter_list|,
name|key
parameter_list|,
name|value
parameter_list|,
name|flags
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|value
decl_stmt|;
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|SMDB_DBM_CURSOR
modifier|*
name|dbm_cursor
init|=
operator|(
name|SMDB_DBM_CURSOR
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|SMDB_DBM_DATABASE
modifier|*
name|db
init|=
name|dbm_cursor
operator|->
name|smndbmc_db
decl_stmt|;
name|DBM
modifier|*
name|dbm
init|=
name|db
operator|->
name|smndbm_dbm
decl_stmt|;
name|datum
name|dbkey
decl_stmt|,
name|dbdata
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbkey
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbkey
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbdata
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|==
name|SMDB_CURSOR_GET_RANGE
condition|)
return|return
name|SMDBE_UNSUPPORTED
return|;
if|if
condition|(
name|dbm_cursor
operator|->
name|smndbmc_current_key
operator|.
name|dptr
operator|==
name|NULL
condition|)
block|{
name|dbm_cursor
operator|->
name|smndbmc_current_key
operator|=
name|dbm_firstkey
argument_list|(
name|dbm
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbm_cursor
operator|->
name|smndbmc_current_key
operator|.
name|dptr
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|dbm_error
argument_list|(
name|dbm
argument_list|)
condition|)
return|return
name|SMDBE_IO_ERROR
return|;
return|return
name|SMDBE_LAST_ENTRY
return|;
block|}
block|}
else|else
block|{
name|dbm_cursor
operator|->
name|smndbmc_current_key
operator|=
name|dbm_nextkey
argument_list|(
name|dbm
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbm_cursor
operator|->
name|smndbmc_current_key
operator|.
name|dptr
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|dbm_error
argument_list|(
name|dbm
argument_list|)
condition|)
return|return
name|SMDBE_IO_ERROR
return|;
return|return
name|SMDBE_LAST_ENTRY
return|;
block|}
block|}
name|errno
operator|=
literal|0
expr_stmt|;
name|dbdata
operator|=
name|dbm_fetch
argument_list|(
name|dbm
argument_list|,
name|dbm_cursor
operator|->
name|smndbmc_current_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbdata
operator|.
name|dptr
operator|==
name|NULL
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
if|if
condition|(
name|dbm_error
argument_list|(
name|dbm
argument_list|)
condition|)
return|return
name|SMDBE_IO_ERROR
return|;
if|if
condition|(
name|save_errno
operator|!=
literal|0
condition|)
return|return
name|save_errno
return|;
return|return
name|SMDBE_NOT_FOUND
return|;
block|}
name|value
operator|->
name|data
operator|=
name|dbdata
operator|.
name|dptr
expr_stmt|;
name|value
operator|->
name|size
operator|=
name|dbdata
operator|.
name|dsize
expr_stmt|;
name|key
operator|->
name|data
operator|=
name|dbm_cursor
operator|->
name|smndbmc_current_key
operator|.
name|dptr
expr_stmt|;
name|key
operator|->
name|size
operator|=
name|dbm_cursor
operator|->
name|smndbmc_current_key
operator|.
name|dsize
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdbm_cursor_put
parameter_list|(
name|cursor
parameter_list|,
name|key
parameter_list|,
name|value
parameter_list|,
name|flags
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|value
decl_stmt|;
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|int
name|save_errno
decl_stmt|;
name|SMDB_DBM_CURSOR
modifier|*
name|dbm_cursor
init|=
operator|(
name|SMDB_DBM_CURSOR
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|SMDB_DBM_DATABASE
modifier|*
name|db
init|=
name|dbm_cursor
operator|->
name|smndbmc_db
decl_stmt|;
name|DBM
modifier|*
name|dbm
init|=
name|db
operator|->
name|smndbm_dbm
decl_stmt|;
name|datum
name|dbdata
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|dbdata
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|dbdata
argument_list|)
expr_stmt|;
name|dbdata
operator|.
name|dptr
operator|=
name|value
operator|->
name|data
expr_stmt|;
name|dbdata
operator|.
name|dsize
operator|=
name|value
operator|->
name|size
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|result
operator|=
name|dbm_store
argument_list|(
name|dbm
argument_list|,
name|dbm_cursor
operator|->
name|smndbmc_current_key
argument_list|,
name|dbdata
argument_list|,
name|smdb_put_flags_to_ndbm_flags
argument_list|(
name|flags
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
literal|1
case|:
return|return
name|SMDBE_DUPLICATE
return|;
case|case
literal|0
case|:
return|return
name|SMDBE_OK
return|;
default|default:
name|save_errno
operator|=
name|errno
expr_stmt|;
if|if
condition|(
name|dbm_error
argument_list|(
name|dbm
argument_list|)
condition|)
return|return
name|SMDBE_IO_ERROR
return|;
if|if
condition|(
name|save_errno
operator|!=
literal|0
condition|)
return|return
name|save_errno
return|;
return|return
name|SMDBE_IO_ERROR
return|;
block|}
comment|/* NOTREACHED */
block|}
end_function

begin_function
name|int
name|smdbm_cursor
parameter_list|(
name|database
parameter_list|,
name|cursor
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_CURSOR
modifier|*
modifier|*
name|cursor
decl_stmt|;
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|SMDB_DBM_DATABASE
modifier|*
name|db
init|=
operator|(
name|SMDB_DBM_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
decl_stmt|;
name|SMDB_CURSOR
modifier|*
name|cur
decl_stmt|;
name|SMDB_DBM_CURSOR
modifier|*
name|dbm_cursor
decl_stmt|;
if|if
condition|(
name|db
operator|->
name|smndbm_cursor_in_use
condition|)
return|return
name|SMDBE_ONLY_SUPPORTS_ONE_CURSOR
return|;
name|db
operator|->
name|smndbm_cursor_in_use
operator|=
name|true
expr_stmt|;
name|dbm_cursor
operator|=
operator|(
name|SMDB_DBM_CURSOR
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SMDB_DBM_CURSOR
argument_list|)
argument_list|)
expr_stmt|;
name|dbm_cursor
operator|->
name|smndbmc_db
operator|=
name|db
expr_stmt|;
name|dbm_cursor
operator|->
name|smndbmc_current_key
operator|.
name|dptr
operator|=
name|NULL
expr_stmt|;
name|dbm_cursor
operator|->
name|smndbmc_current_key
operator|.
name|dsize
operator|=
literal|0
expr_stmt|;
name|cur
operator|=
operator|(
name|SMDB_CURSOR
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SMDB_CURSOR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|==
name|NULL
condition|)
return|return
name|SMDBE_MALLOC
return|;
name|cur
operator|->
name|smdbc_impl
operator|=
name|dbm_cursor
expr_stmt|;
name|cur
operator|->
name|smdbc_close
operator|=
name|smdbm_cursor_close
expr_stmt|;
name|cur
operator|->
name|smdbc_del
operator|=
name|smdbm_cursor_del
expr_stmt|;
name|cur
operator|->
name|smdbc_get
operator|=
name|smdbm_cursor_get
expr_stmt|;
name|cur
operator|->
name|smdbc_put
operator|=
name|smdbm_cursor_put
expr_stmt|;
operator|*
name|cursor
operator|=
name|cur
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_comment
comment|/* **  SMDB_NDBM_OPEN -- Opens a ndbm database. ** **	Parameters: **		database -- An unallocated database pointer to a pointer. **		db_name -- The name of the database without extension. **		mode -- File permisions on a created database. **		mode_mask -- Mode bits that much match on an opened database. **		sff -- Flags to safefile. **		type -- The type of database to open. **			Only SMDB_NDBM is supported. **		user_info -- Information on the user to use for file **			    permissions. **		db_params -- No params are supported. ** **	Returns: **		SMDBE_OK -- Success, otherwise errno: **		SMDBE_MALLOC -- Cannot allocate memory. **		SMDBE_UNSUPPORTED -- The type is not supported. **		SMDBE_GDBM_IS_BAD -- We have detected GDBM and we don't **				    like it. **		SMDBE_BAD_OPEN -- dbm_open failed and errno was not set. **		Anything else: errno */
end_comment

begin_function
name|int
name|smdb_ndbm_open
parameter_list|(
name|database
parameter_list|,
name|db_name
parameter_list|,
name|mode
parameter_list|,
name|mode_mask
parameter_list|,
name|sff
parameter_list|,
name|type
parameter_list|,
name|user_info
parameter_list|,
name|db_params
parameter_list|)
name|SMDB_DATABASE
modifier|*
modifier|*
name|database
decl_stmt|;
name|char
modifier|*
name|db_name
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|int
name|mode_mask
decl_stmt|;
name|long
name|sff
decl_stmt|;
name|SMDB_DBTYPE
name|type
decl_stmt|;
name|SMDB_USER_INFO
modifier|*
name|user_info
decl_stmt|;
name|SMDB_DBPARAMS
modifier|*
name|db_params
decl_stmt|;
block|{
name|bool
name|lockcreated
init|=
name|false
decl_stmt|;
name|int
name|result
decl_stmt|;
name|int
name|lock_fd
decl_stmt|;
name|SMDB_DATABASE
modifier|*
name|smdb_db
decl_stmt|;
name|SMDB_DBM_DATABASE
modifier|*
name|db
decl_stmt|;
name|DBM
modifier|*
name|dbm
init|=
name|NULL
decl_stmt|;
name|struct
name|stat
name|dir_stat_info
decl_stmt|;
name|struct
name|stat
name|pag_stat_info
decl_stmt|;
name|result
operator|=
name|SMDBE_OK
expr_stmt|;
operator|*
name|database
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|NULL
condition|)
return|return
name|SMDBE_UNKNOWN_DB_TYPE
return|;
name|result
operator|=
name|smdb_setup_file
argument_list|(
name|db_name
argument_list|,
name|SMNDB_DIR_FILE_EXTENSION
argument_list|,
name|mode_mask
argument_list|,
name|sff
argument_list|,
name|user_info
argument_list|,
operator|&
name|dir_stat_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
name|result
operator|=
name|smdb_setup_file
argument_list|(
name|db_name
argument_list|,
name|SMNDB_PAG_FILE_EXTENSION
argument_list|,
name|mode_mask
argument_list|,
name|sff
argument_list|,
name|user_info
argument_list|,
operator|&
name|pag_stat_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
if|if
condition|(
operator|(
name|dir_stat_info
operator|.
name|st_mode
operator|==
name|ST_MODE_NOFILE
operator|||
name|pag_stat_info
operator|.
name|st_mode
operator|==
name|ST_MODE_NOFILE
operator|)
operator|&&
name|bitset
argument_list|(
name|mode
argument_list|,
name|O_CREAT
argument_list|)
condition|)
name|lockcreated
operator|=
name|true
expr_stmt|;
name|lock_fd
operator|=
operator|-
literal|1
expr_stmt|;
name|result
operator|=
name|smdb_lock_file
argument_list|(
operator|&
name|lock_fd
argument_list|,
name|db_name
argument_list|,
name|mode
argument_list|,
name|sff
argument_list|,
name|SMNDB_DIR_FILE_EXTENSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
if|if
condition|(
name|lockcreated
condition|)
block|{
name|int
name|pag_fd
decl_stmt|;
comment|/* Need to pre-open the .pag file as well with O_EXCL */
name|result
operator|=
name|smdb_lock_file
argument_list|(
operator|&
name|pag_fd
argument_list|,
name|db_name
argument_list|,
name|mode
argument_list|,
name|sff
argument_list|,
name|SMNDB_PAG_FILE_EXTENSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|lock_fd
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|pag_fd
argument_list|)
expr_stmt|;
name|mode
operator||=
name|O_TRUNC
expr_stmt|;
name|mode
operator|&=
operator|~
operator|(
name|O_CREAT
operator||
name|O_EXCL
operator|)
expr_stmt|;
block|}
name|smdb_db
operator|=
name|smdb_malloc_database
argument_list|()
expr_stmt|;
if|if
condition|(
name|smdb_db
operator|==
name|NULL
condition|)
name|result
operator|=
name|SMDBE_MALLOC
expr_stmt|;
name|db
operator|=
name|smdbm_malloc_database
argument_list|()
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
name|result
operator|=
name|SMDBE_MALLOC
expr_stmt|;
comment|/* Try to open database */
if|if
condition|(
name|result
operator|==
name|SMDBE_OK
condition|)
block|{
name|db
operator|->
name|smndbm_lock_fd
operator|=
name|lock_fd
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|dbm
operator|=
name|dbm_open
argument_list|(
name|db_name
argument_list|,
name|mode
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbm
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|errno
operator|==
literal|0
condition|)
name|result
operator|=
name|SMDBE_BAD_OPEN
expr_stmt|;
else|else
name|result
operator|=
name|errno
expr_stmt|;
block|}
name|db
operator|->
name|smndbm_dbm
operator|=
name|dbm
expr_stmt|;
block|}
comment|/* Check for GDBM */
if|if
condition|(
name|result
operator|==
name|SMDBE_OK
condition|)
block|{
if|if
condition|(
name|dbm_dirfno
argument_list|(
name|dbm
argument_list|)
operator|==
name|dbm_pagfno
argument_list|(
name|dbm
argument_list|)
condition|)
name|result
operator|=
name|SMDBE_GDBM_IS_BAD
expr_stmt|;
block|}
comment|/* Check for filechanged */
if|if
condition|(
name|result
operator|==
name|SMDBE_OK
condition|)
block|{
name|result
operator|=
name|smdb_filechanged
argument_list|(
name|db_name
argument_list|,
name|SMNDB_DIR_FILE_EXTENSION
argument_list|,
name|dbm_dirfno
argument_list|(
name|dbm
argument_list|)
argument_list|,
operator|&
name|dir_stat_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|SMDBE_OK
condition|)
block|{
name|result
operator|=
name|smdb_filechanged
argument_list|(
name|db_name
argument_list|,
name|SMNDB_PAG_FILE_EXTENSION
argument_list|,
name|dbm_pagfno
argument_list|(
name|dbm
argument_list|)
argument_list|,
operator|&
name|pag_stat_info
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* XXX Got to get fchown stuff in here */
comment|/* Setup driver if everything is ok */
if|if
condition|(
name|result
operator|==
name|SMDBE_OK
condition|)
block|{
operator|*
name|database
operator|=
name|smdb_db
expr_stmt|;
name|smdb_db
operator|->
name|smdb_close
operator|=
name|smdbm_close
expr_stmt|;
name|smdb_db
operator|->
name|smdb_del
operator|=
name|smdbm_del
expr_stmt|;
name|smdb_db
operator|->
name|smdb_fd
operator|=
name|smdbm_fd
expr_stmt|;
name|smdb_db
operator|->
name|smdb_lockfd
operator|=
name|smdbm_lockfd
expr_stmt|;
name|smdb_db
operator|->
name|smdb_get
operator|=
name|smdbm_get
expr_stmt|;
name|smdb_db
operator|->
name|smdb_put
operator|=
name|smdbm_put
expr_stmt|;
name|smdb_db
operator|->
name|smdb_set_owner
operator|=
name|smndbm_set_owner
expr_stmt|;
name|smdb_db
operator|->
name|smdb_sync
operator|=
name|smdbm_sync
expr_stmt|;
name|smdb_db
operator|->
name|smdb_cursor
operator|=
name|smdbm_cursor
expr_stmt|;
name|smdb_db
operator|->
name|smdb_impl
operator|=
name|db
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
comment|/* If we're here, something bad happened, clean up */
if|if
condition|(
name|dbm
operator|!=
name|NULL
condition|)
name|dbm_close
argument_list|(
name|dbm
argument_list|)
expr_stmt|;
name|smdb_unlock_file
argument_list|(
name|db
operator|->
name|smndbm_lock_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|smdb_free_database
argument_list|(
name|smdb_db
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NDBM */
end_comment

end_unit


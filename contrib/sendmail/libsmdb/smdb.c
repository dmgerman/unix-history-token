begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ** Copyright (c) 1999-2001 Sendmail, Inc. and its suppliers. **	All rights reserved. ** ** By using this file, you agree to the terms and conditions set ** forth in the LICENSE file which can be found at the top level of ** the sendmail distribution. */
end_comment

begin_include
include|#
directive|include
file|<sm/gen.h>
end_include

begin_macro
name|SM_RCSID
argument_list|(
literal|"@(#)$Id: smdb.c,v 8.53 2001/11/19 19:31:14 gshapiro Exp $"
argument_list|)
end_macro

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sendmail/sendmail.h>
end_include

begin_include
include|#
directive|include
file|<libsmdb/smdb.h>
end_include

begin_comment
comment|/* ** SMDB_MALLOC_DATABASE -- Allocates a database structure. ** **	Parameters: **		None ** **	Returns: **		An pointer to an allocated SMDB_DATABASE structure or **		NULL if it couldn't allocate the memory. */
end_comment

begin_function
name|SMDB_DATABASE
modifier|*
name|smdb_malloc_database
parameter_list|()
block|{
name|SMDB_DATABASE
modifier|*
name|db
decl_stmt|;
name|db
operator|=
operator|(
name|SMDB_DATABASE
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SMDB_DATABASE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|memset
argument_list|(
name|db
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
name|SMDB_DATABASE
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|db
return|;
block|}
end_function

begin_comment
comment|/* ** SMDB_FREE_DATABASE -- Unallocates a database structure. ** **	Parameters: **		database -- a SMDB_DATABASE pointer to deallocate. ** **	Returns: **		None */
end_comment

begin_function
name|void
name|smdb_free_database
parameter_list|(
name|database
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
block|{
if|if
condition|(
name|database
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|database
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **  SMDB_LOCKFILE -- lock a file using flock or (shudder) fcntl locking ** **	Parameters: **		fd -- the file descriptor of the file. **		type -- type of the lock.  Bits can be: **			LOCK_EX -- exclusive lock. **			LOCK_NB -- non-blocking. ** **	Returns: **		true if the lock was acquired. **		false otherwise. */
end_comment

begin_function
specifier|static
name|bool
name|smdb_lockfile
parameter_list|(
name|fd
parameter_list|,
name|type
parameter_list|)
name|int
name|fd
decl_stmt|;
name|int
name|type
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|int
name|save_errno
decl_stmt|;
if|#
directive|if
operator|!
name|HASFLOCK
name|int
name|action
decl_stmt|;
name|struct
name|flock
name|lfd
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|lfd
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|lfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitset
argument_list|(
name|LOCK_UN
argument_list|,
name|type
argument_list|)
condition|)
name|lfd
operator|.
name|l_type
operator|=
name|F_UNLCK
expr_stmt|;
elseif|else
if|if
condition|(
name|bitset
argument_list|(
name|LOCK_EX
argument_list|,
name|type
argument_list|)
condition|)
name|lfd
operator|.
name|l_type
operator|=
name|F_WRLCK
expr_stmt|;
else|else
name|lfd
operator|.
name|l_type
operator|=
name|F_RDLCK
expr_stmt|;
if|if
condition|(
name|bitset
argument_list|(
name|LOCK_NB
argument_list|,
name|type
argument_list|)
condition|)
name|action
operator|=
name|F_SETLK
expr_stmt|;
else|else
name|action
operator|=
name|F_SETLKW
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|fcntl
argument_list|(
name|fd
argument_list|,
name|action
argument_list|,
operator|&
name|lfd
argument_list|)
operator|)
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EINTR
condition|)
continue|continue;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
return|return
name|true
return|;
name|save_errno
operator|=
name|errno
expr_stmt|;
comment|/* 	**  On SunOS, if you are testing using -oQ/tmp/mqueue or 	**  -oA/tmp/aliases or anything like that, and /tmp is mounted 	**  as type "tmp" (that is, served from swap space), the 	**  previous fcntl will fail with "Invalid argument" errors. 	**  Since this is fairly common during testing, we will assume 	**  that this indicates that the lock is successfully grabbed. 	*/
if|if
condition|(
name|save_errno
operator|==
name|EINVAL
condition|)
return|return
name|true
return|;
if|if
condition|(
operator|!
name|bitset
argument_list|(
name|LOCK_NB
argument_list|,
name|type
argument_list|)
operator|||
operator|(
name|save_errno
operator|!=
name|EACCES
operator|&&
name|save_errno
operator|!=
name|EAGAIN
operator|)
condition|)
block|{
name|int
name|omode
init|=
operator|-
literal|1
decl_stmt|;
ifdef|#
directive|ifdef
name|F_GETFL
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|fd
argument_list|,
name|F_GETFL
argument_list|,
operator|&
name|omode
argument_list|)
expr_stmt|;
name|errno
operator|=
name|save_errno
expr_stmt|;
endif|#
directive|endif
comment|/* F_GETFL */
if|#
directive|if
literal|0
block|syslog(LOG_ERR, "cannot lockf(%s%s, fd=%d, type=%o, omode=%o, euid=%d)", 		       filename, ext, fd, type, omode, (int) geteuid());
endif|#
directive|endif
comment|/* 0 */
return|return
name|false
return|;
block|}
else|#
directive|else
comment|/* !HASFLOCK */
while|while
condition|(
operator|(
name|i
operator|=
name|flock
argument_list|(
name|fd
argument_list|,
name|type
argument_list|)
operator|)
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EINTR
condition|)
continue|continue;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
return|return
name|true
return|;
name|save_errno
operator|=
name|errno
expr_stmt|;
if|if
condition|(
operator|!
name|bitset
argument_list|(
name|LOCK_NB
argument_list|,
name|type
argument_list|)
operator|||
name|save_errno
operator|!=
name|EWOULDBLOCK
condition|)
block|{
name|int
name|omode
init|=
operator|-
literal|1
decl_stmt|;
ifdef|#
directive|ifdef
name|F_GETFL
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|fd
argument_list|,
name|F_GETFL
argument_list|,
operator|&
name|omode
argument_list|)
expr_stmt|;
name|errno
operator|=
name|save_errno
expr_stmt|;
endif|#
directive|endif
comment|/* F_GETFL */
if|#
directive|if
literal|0
block|syslog(LOG_ERR, "cannot flock(%s%s, fd=%d, type=%o, omode=%o, euid=%d)", 		       filename, ext, fd, type, omode, (int) geteuid());
endif|#
directive|endif
comment|/* 0 */
return|return
name|false
return|;
block|}
endif|#
directive|endif
comment|/* !HASFLOCK */
name|errno
operator|=
name|save_errno
expr_stmt|;
return|return
name|false
return|;
block|}
end_function

begin_comment
comment|/* ** SMDB_OPEN_DATABASE -- Opens a database. ** **	This opens a database. If type is SMDB_DEFAULT it tries to **	use a DB1 or DB2 hash. If that isn't available, it will try **	to use NDBM. If a specific type is given it will try to open **	a database of that type. ** **	Parameters: **		database -- An pointer to a SMDB_DATABASE pointer where the **			   opened database will be stored. This should **			   be unallocated. **		db_name -- The name of the database to open. Do not include **			  the file name extension. **		mode -- The mode to set on the database file or files. **		mode_mask -- Mode bits that must match on an opened database. **		sff -- Flags to safefile. **		type -- The type of database to open. Supported types **		       vary depending on what was compiled in. **		user_info -- Information on the user to use for file **			    permissions. **		params -- Params specific to the database being opened. **			 Only supports some DB hash options right now **			 (see smdb_db_open() for details). ** **	Returns: **		SMDBE_OK -- Success. **		Anything else is an error. Look up more info about the **		error in the comments for the specific open() used. */
end_comment

begin_function
name|int
name|smdb_open_database
parameter_list|(
name|database
parameter_list|,
name|db_name
parameter_list|,
name|mode
parameter_list|,
name|mode_mask
parameter_list|,
name|sff
parameter_list|,
name|type
parameter_list|,
name|user_info
parameter_list|,
name|params
parameter_list|)
name|SMDB_DATABASE
modifier|*
modifier|*
name|database
decl_stmt|;
name|char
modifier|*
name|db_name
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|int
name|mode_mask
decl_stmt|;
name|long
name|sff
decl_stmt|;
name|SMDB_DBTYPE
name|type
decl_stmt|;
name|SMDB_USER_INFO
modifier|*
name|user_info
decl_stmt|;
name|SMDB_DBPARAMS
modifier|*
name|params
decl_stmt|;
block|{
name|bool
name|type_was_default
init|=
name|false
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|SMDB_TYPE_DEFAULT
condition|)
block|{
name|type_was_default
operator|=
name|true
expr_stmt|;
ifdef|#
directive|ifdef
name|NEWDB
name|type
operator|=
name|SMDB_TYPE_HASH
expr_stmt|;
else|#
directive|else
comment|/* NEWDB */
ifdef|#
directive|ifdef
name|NDBM
name|type
operator|=
name|SMDB_TYPE_NDBM
expr_stmt|;
endif|#
directive|endif
comment|/* NDBM */
endif|#
directive|endif
comment|/* NEWDB */
block|}
if|if
condition|(
name|type
operator|==
name|SMDB_TYPE_DEFAULT
condition|)
return|return
name|SMDBE_UNKNOWN_DB_TYPE
return|;
if|if
condition|(
operator|(
name|strncmp
argument_list|(
name|type
argument_list|,
name|SMDB_TYPE_HASH
argument_list|,
name|SMDB_TYPE_HASH_LEN
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strncmp
argument_list|(
name|type
argument_list|,
name|SMDB_TYPE_BTREE
argument_list|,
name|SMDB_TYPE_BTREE_LEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|NEWDB
name|int
name|result
decl_stmt|;
name|result
operator|=
name|smdb_db_open
argument_list|(
name|database
argument_list|,
name|db_name
argument_list|,
name|mode
argument_list|,
name|mode_mask
argument_list|,
name|sff
argument_list|,
name|type
argument_list|,
name|user_info
argument_list|,
name|params
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NDBM
if|if
condition|(
name|result
operator|==
name|ENOENT
operator|&&
name|type_was_default
condition|)
name|type
operator|=
name|SMDB_TYPE_NDBM
expr_stmt|;
else|else
endif|#
directive|endif
comment|/* NDBM */
return|return
name|result
return|;
else|#
directive|else
comment|/* NEWDB */
return|return
name|SMDBE_UNSUPPORTED_DB_TYPE
return|;
endif|#
directive|endif
comment|/* NEWDB */
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|type
argument_list|,
name|SMDB_TYPE_NDBM
argument_list|,
name|SMDB_TYPE_NDBM_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|NDBM
name|int
name|result
decl_stmt|;
name|result
operator|=
name|smdb_ndbm_open
argument_list|(
name|database
argument_list|,
name|db_name
argument_list|,
name|mode
argument_list|,
name|mode_mask
argument_list|,
name|sff
argument_list|,
name|type
argument_list|,
name|user_info
argument_list|,
name|params
argument_list|)
expr_stmt|;
return|return
name|result
return|;
else|#
directive|else
comment|/* NDBM */
return|return
name|SMDBE_UNSUPPORTED_DB_TYPE
return|;
endif|#
directive|endif
comment|/* NDBM */
block|}
return|return
name|SMDBE_UNKNOWN_DB_TYPE
return|;
block|}
end_function

begin_comment
comment|/* ** SMDB_ADD_EXTENSION -- Adds an extension to a file name. ** **	Just adds a . followed by a string to a db_name if there **	is room and the db_name does not already have that extension. ** **	Parameters: **		full_name -- The final file name. **		max_full_name_len -- The max length for full_name. **		db_name -- The name of the db. **		extension -- The extension to add. ** **	Returns: **		SMDBE_OK -- Success. **		Anything else is an error. Look up more info about the **		error in the comments for the specific open() used. */
end_comment

begin_function
name|int
name|smdb_add_extension
parameter_list|(
name|full_name
parameter_list|,
name|max_full_name_len
parameter_list|,
name|db_name
parameter_list|,
name|extension
parameter_list|)
name|char
modifier|*
name|full_name
decl_stmt|;
name|int
name|max_full_name_len
decl_stmt|;
name|char
modifier|*
name|db_name
decl_stmt|;
name|char
modifier|*
name|extension
decl_stmt|;
block|{
name|int
name|extension_len
decl_stmt|;
name|int
name|db_name_len
decl_stmt|;
if|if
condition|(
name|full_name
operator|==
name|NULL
operator|||
name|db_name
operator|==
name|NULL
operator|||
name|extension
operator|==
name|NULL
condition|)
return|return
name|SMDBE_INVALID_PARAMETER
return|;
name|extension_len
operator|=
name|strlen
argument_list|(
name|extension
argument_list|)
expr_stmt|;
name|db_name_len
operator|=
name|strlen
argument_list|(
name|db_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|extension_len
operator|+
name|db_name_len
operator|+
literal|2
operator|>
name|max_full_name_len
condition|)
return|return
name|SMDBE_DB_NAME_TOO_LONG
return|;
if|if
condition|(
name|db_name_len
operator|<
name|extension_len
operator|+
literal|1
operator|||
name|db_name
index|[
name|db_name_len
operator|-
name|extension_len
operator|-
literal|1
index|]
operator|!=
literal|'.'
operator|||
name|strcmp
argument_list|(
operator|&
name|db_name
index|[
name|db_name_len
operator|-
name|extension_len
index|]
argument_list|,
name|extension
argument_list|)
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|sm_snprintf
argument_list|(
name|full_name
argument_list|,
name|max_full_name_len
argument_list|,
literal|"%s.%s"
argument_list|,
name|db_name
argument_list|,
name|extension
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sm_strlcpy
argument_list|(
name|full_name
argument_list|,
name|db_name
argument_list|,
name|max_full_name_len
argument_list|)
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_comment
comment|/* **  SMDB_LOCK_FILE -- Locks the database file. ** **	Locks the actual database file. ** **	Parameters: **		lock_fd -- The resulting descriptor for the locked file. **		db_name -- The name of the database without extension. **		mode -- The open mode. **		sff -- Flags to safefile. **		extension -- The extension for the file. ** **	Returns: **		SMDBE_OK -- Success, otherwise errno. */
end_comment

begin_function
name|int
name|smdb_lock_file
parameter_list|(
name|lock_fd
parameter_list|,
name|db_name
parameter_list|,
name|mode
parameter_list|,
name|sff
parameter_list|,
name|extension
parameter_list|)
name|int
modifier|*
name|lock_fd
decl_stmt|;
name|char
modifier|*
name|db_name
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|long
name|sff
decl_stmt|;
name|char
modifier|*
name|extension
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|char
name|file_name
index|[
name|SMDB_MAX_NAME_LEN
index|]
decl_stmt|;
name|result
operator|=
name|smdb_add_extension
argument_list|(
name|file_name
argument_list|,
name|SMDB_MAX_NAME_LEN
argument_list|,
name|db_name
argument_list|,
name|extension
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
operator|*
name|lock_fd
operator|=
name|safeopen
argument_list|(
name|file_name
argument_list|,
name|mode
operator|&
operator|~
name|O_TRUNC
argument_list|,
literal|0644
argument_list|,
name|sff
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|lock_fd
operator|<
literal|0
condition|)
return|return
name|errno
return|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_comment
comment|/* **  SMDB_UNLOCK_FILE -- Unlocks a file ** **	Unlocks a file. ** **	Parameters: **		lock_fd -- The descriptor for the locked file. ** **	Returns: **		SMDBE_OK -- Success, otherwise errno. */
end_comment

begin_function
name|int
name|smdb_unlock_file
parameter_list|(
name|lock_fd
parameter_list|)
name|int
name|lock_fd
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|result
operator|=
name|close
argument_list|(
name|lock_fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
return|return
name|errno
return|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_comment
comment|/* **  SMDB_LOCK_MAP -- Locks a database. ** **	Parameters: **		database -- database description. **		type -- type of the lock.  Bits can be: **			LOCK_EX -- exclusive lock. **			LOCK_NB -- non-blocking. ** **	Returns: **		SMDBE_OK -- Success, otherwise errno. */
end_comment

begin_function
name|int
name|smdb_lock_map
parameter_list|(
name|database
parameter_list|,
name|type
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|int
name|type
decl_stmt|;
block|{
name|int
name|fd
decl_stmt|;
name|fd
operator|=
name|database
operator|->
name|smdb_lockfd
argument_list|(
name|database
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
return|return
name|SMDBE_NOT_FOUND
return|;
if|if
condition|(
operator|!
name|smdb_lockfile
argument_list|(
name|fd
argument_list|,
name|type
argument_list|)
condition|)
return|return
name|SMDBE_LOCK_NOT_GRANTED
return|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_comment
comment|/* **  SMDB_UNLOCK_MAP -- Unlocks a database ** **	Parameters: **		database -- database description. ** **	Returns: **		SMDBE_OK -- Success, otherwise errno. */
end_comment

begin_function
name|int
name|smdb_unlock_map
parameter_list|(
name|database
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
block|{
name|int
name|fd
decl_stmt|;
name|fd
operator|=
name|database
operator|->
name|smdb_lockfd
argument_list|(
name|database
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
return|return
name|SMDBE_NOT_FOUND
return|;
if|if
condition|(
operator|!
name|smdb_lockfile
argument_list|(
name|fd
argument_list|,
name|LOCK_UN
argument_list|)
condition|)
return|return
name|SMDBE_LOCK_NOT_HELD
return|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_comment
comment|/* **  SMDB_SETUP_FILE -- Gets db file ready for use. ** **	Makes sure permissions on file are safe and creates it if it **	doesn't exist. ** **	Parameters: **		db_name -- The name of the database without extension. **		extension -- The extension. **		sff -- Flags to safefile. **		mode_mask -- Mode bits that must match. **		user_info -- Information on the user to use for file **			    permissions. **		stat_info -- A place to put the stat info for the file. **	Returns: **		SMDBE_OK -- Success, otherwise errno. */
end_comment

begin_function
name|int
name|smdb_setup_file
parameter_list|(
name|db_name
parameter_list|,
name|extension
parameter_list|,
name|mode_mask
parameter_list|,
name|sff
parameter_list|,
name|user_info
parameter_list|,
name|stat_info
parameter_list|)
name|char
modifier|*
name|db_name
decl_stmt|;
name|char
modifier|*
name|extension
decl_stmt|;
name|int
name|mode_mask
decl_stmt|;
name|long
name|sff
decl_stmt|;
name|SMDB_USER_INFO
modifier|*
name|user_info
decl_stmt|;
name|struct
name|stat
modifier|*
name|stat_info
decl_stmt|;
block|{
name|int
name|st
decl_stmt|;
name|int
name|result
decl_stmt|;
name|char
name|db_file_name
index|[
name|SMDB_MAX_NAME_LEN
index|]
decl_stmt|;
name|result
operator|=
name|smdb_add_extension
argument_list|(
name|db_file_name
argument_list|,
name|SMDB_MAX_NAME_LEN
argument_list|,
name|db_name
argument_list|,
name|extension
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
name|st
operator|=
name|safefile
argument_list|(
name|db_file_name
argument_list|,
name|user_info
operator|->
name|smdbu_id
argument_list|,
name|user_info
operator|->
name|smdbu_group_id
argument_list|,
name|user_info
operator|->
name|smdbu_name
argument_list|,
name|sff
argument_list|,
name|mode_mask
argument_list|,
name|stat_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|!=
literal|0
condition|)
return|return
name|st
return|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_comment
comment|/* **  SMDB_FILECHANGED -- Checks to see if a file changed. ** **	Compares the passed in stat_info with a current stat on **	the passed in file descriptor. Check filechanged for **	return values. ** **	Parameters: **		db_name -- The name of the database without extension. **		extension -- The extension. **		db_fd -- A file descriptor for the database file. **		stat_info -- An old stat_info. **	Returns: **		SMDBE_OK -- Success, otherwise errno. */
end_comment

begin_function
name|int
name|smdb_filechanged
parameter_list|(
name|db_name
parameter_list|,
name|extension
parameter_list|,
name|db_fd
parameter_list|,
name|stat_info
parameter_list|)
name|char
modifier|*
name|db_name
decl_stmt|;
name|char
modifier|*
name|extension
decl_stmt|;
name|int
name|db_fd
decl_stmt|;
name|struct
name|stat
modifier|*
name|stat_info
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|char
name|db_file_name
index|[
name|SMDB_MAX_NAME_LEN
index|]
decl_stmt|;
name|result
operator|=
name|smdb_add_extension
argument_list|(
name|db_file_name
argument_list|,
name|SMDB_MAX_NAME_LEN
argument_list|,
name|db_name
argument_list|,
name|extension
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
return|return
name|filechanged
argument_list|(
name|db_file_name
argument_list|,
name|db_fd
argument_list|,
name|stat_info
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ** SMDB_PRINT_AVAILABLE_TYPES -- Prints the names of the available types. ** **	Parameters: **		None ** **	Returns: **		None */
end_comment

begin_function
name|void
name|smdb_print_available_types
parameter_list|()
block|{
ifdef|#
directive|ifdef
name|NDBM
name|printf
argument_list|(
literal|"dbm\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NDBM */
ifdef|#
directive|ifdef
name|NEWDB
name|printf
argument_list|(
literal|"hash\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"btree\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NEWDB */
block|}
end_function

begin_comment
comment|/* ** SMDB_DB_DEFINITION -- Given a database type, return database definition ** **	Reads though a structure making an association with the database **	type and the required cpp define from sendmail/README. **	List size is dynamic and must be NULL terminated. ** **	Parameters: **		type -- The name of the database type. ** **	Returns: **		definition for type, otherwise NULL. */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|SMDB_DBTYPE
name|type
decl_stmt|;
name|char
modifier|*
name|dbdef
decl_stmt|;
block|}
name|dbtype
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|dbtype
name|DatabaseDefs
index|[]
init|=
block|{
block|{
name|SMDB_TYPE_HASH
block|,
literal|"NEWDB"
block|}
block|,
block|{
name|SMDB_TYPE_BTREE
block|,
literal|"NEWDB"
block|}
block|,
block|{
name|SMDB_TYPE_NDBM
block|,
literal|"NDBM"
block|}
block|,
block|{
name|NULL
block|,
literal|"OOPS"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
name|smdb_db_definition
parameter_list|(
name|type
parameter_list|)
name|SMDB_DBTYPE
name|type
decl_stmt|;
block|{
name|dbtype
modifier|*
name|ptr
init|=
name|DatabaseDefs
decl_stmt|;
while|while
condition|(
name|ptr
operator|!=
name|NULL
operator|&&
name|ptr
operator|->
name|type
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
name|ptr
operator|->
name|type
argument_list|)
operator|==
literal|0
condition|)
return|return
name|ptr
operator|->
name|dbdef
return|;
name|ptr
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

end_unit


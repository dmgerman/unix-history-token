begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ** Copyright (c) 1999-2000 Sendmail, Inc. and its suppliers. **	All rights reserved. ** ** By using this file, you agree to the terms and conditions set ** forth in the LICENSE file which can be found at the top level of ** the sendmail distribution. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|id
index|[]
init|=
literal|"@(#)$Id: smdb1.c,v 8.43.4.1 2000/08/24 17:08:00 gshapiro Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ! lint */
end_comment

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sendmail/sendmail.h>
end_include

begin_include
include|#
directive|include
file|<libsmdb/smdb.h>
end_include

begin_if
if|#
directive|if
operator|(
name|DB_VERSION_MAJOR
operator|==
literal|1
operator|)
end_if

begin_define
define|#
directive|define
name|SMDB1_FILE_EXTENSION
value|"db"
end_define

begin_struct
struct|struct
name|smdb_db1_struct
block|{
name|DB
modifier|*
name|smdb1_db
decl_stmt|;
name|int
name|smdb1_lock_fd
decl_stmt|;
name|bool
name|smdb1_cursor_in_use
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|smdb_db1_struct
name|SMDB_DB1_DATABASE
typedef|;
end_typedef

begin_struct
struct|struct
name|smdb_db1_cursor
block|{
name|SMDB_DB1_DATABASE
modifier|*
name|db
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|smdb_db1_cursor
name|SMDB_DB1_CURSOR
typedef|;
end_typedef

begin_escape
end_escape

begin_comment
comment|/* **  SMDB_TYPE_TO_DB1_TYPE -- Translates smdb database type to db1 type. ** **	Parameters: **		type -- The type to translate. ** **	Returns: **		The DB1 type that corresponsds to the passed in SMDB type. **		Returns -1 if there is no equivalent type. ** */
end_comment

begin_function
name|DBTYPE
name|smdb_type_to_db1_type
parameter_list|(
name|type
parameter_list|)
name|SMDB_DBTYPE
name|type
decl_stmt|;
block|{
if|if
condition|(
name|type
operator|==
name|SMDB_TYPE_DEFAULT
condition|)
return|return
name|DB_HASH
return|;
if|if
condition|(
name|strncmp
argument_list|(
name|type
argument_list|,
name|SMDB_TYPE_HASH
argument_list|,
name|SMDB_TYPE_HASH_LEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|DB_HASH
return|;
if|if
condition|(
name|strncmp
argument_list|(
name|type
argument_list|,
name|SMDB_TYPE_BTREE
argument_list|,
name|SMDB_TYPE_BTREE_LEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|DB_BTREE
return|;
comment|/* Should never get here thanks to test in smdb_db_open() */
return|return
name|DB_HASH
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* **  SMDB_PUT_FLAGS_TO_DB1_FLAGS -- Translates smdb put flags to db1 put flags. ** **	Parameters: **		flags -- The flags to translate. ** **	Returns: **		The db1 flags that are equivalent to the smdb flags. ** **	Notes: **		Any invalid flags are ignored. ** */
end_comment

begin_function
name|u_int
name|smdb_put_flags_to_db1_flags
parameter_list|(
name|flags
parameter_list|)
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|int
name|return_flags
decl_stmt|;
name|return_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bitset
argument_list|(
name|SMDBF_NO_OVERWRITE
argument_list|,
name|flags
argument_list|)
condition|)
name|return_flags
operator||=
name|R_NOOVERWRITE
expr_stmt|;
return|return
name|return_flags
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* **  SMDB_CURSOR_GET_FLAGS_TO_SMDB1 ** **	Parameters: **		flags -- The flags to translate. ** **	Returns: **		The db1 flags that are equivalent to the smdb flags. ** **	Notes: **		Returns -1 if we don't support the flag. ** */
end_comment

begin_function
name|int
name|smdb_cursor_get_flags_to_smdb1
parameter_list|(
name|flags
parameter_list|)
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
switch|switch
condition|(
name|flags
condition|)
block|{
case|case
name|SMDB_CURSOR_GET_FIRST
case|:
return|return
name|R_FIRST
return|;
case|case
name|SMDB_CURSOR_GET_LAST
case|:
return|return
name|R_LAST
return|;
case|case
name|SMDB_CURSOR_GET_NEXT
case|:
return|return
name|R_NEXT
return|;
case|case
name|SMDB_CURSOR_GET_RANGE
case|:
return|return
name|R_CURSOR
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
name|SMDB_DB1_DATABASE
modifier|*
name|smdb1_malloc_database
parameter_list|()
block|{
name|SMDB_DB1_DATABASE
modifier|*
name|db1
decl_stmt|;
name|db1
operator|=
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SMDB_DB1_DATABASE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|db1
operator|!=
name|NULL
condition|)
block|{
name|db1
operator|->
name|smdb1_lock_fd
operator|=
operator|-
literal|1
expr_stmt|;
name|db1
operator|->
name|smdb1_cursor_in_use
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|db1
return|;
block|}
end_function

begin_comment
comment|/* ** The rest of these function correspond to the interface laid out ** in smdb.h. */
end_comment

begin_function
name|int
name|smdb1_close
parameter_list|(
name|database
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
block|{
name|SMDB_DB1_DATABASE
modifier|*
name|db1
init|=
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
decl_stmt|;
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb1_db
decl_stmt|;
if|if
condition|(
name|db1
operator|->
name|smdb1_lock_fd
operator|!=
operator|-
literal|1
condition|)
operator|(
name|void
operator|)
name|close
argument_list|(
name|db1
operator|->
name|smdb1_lock_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db1
argument_list|)
expr_stmt|;
name|database
operator|->
name|smdb_impl
operator|=
name|NULL
expr_stmt|;
return|return
name|db
operator|->
name|close
argument_list|(
name|db
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb1_del
parameter_list|(
name|database
parameter_list|,
name|key
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
block|{
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb1_db
decl_stmt|;
return|return
name|db
operator|->
name|del
argument_list|(
name|db
argument_list|,
operator|&
name|key
operator|->
name|db
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb1_fd
parameter_list|(
name|database
parameter_list|,
name|fd
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|int
modifier|*
name|fd
decl_stmt|;
block|{
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb1_db
decl_stmt|;
operator|*
name|fd
operator|=
name|db
operator|->
name|fd
argument_list|(
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fd
operator|==
operator|-
literal|1
condition|)
return|return
name|errno
return|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdb1_lockfd
parameter_list|(
name|database
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
block|{
name|SMDB_DB1_DATABASE
modifier|*
name|db1
init|=
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
decl_stmt|;
return|return
name|db1
operator|->
name|smdb1_lock_fd
return|;
block|}
end_function

begin_function
name|int
name|smdb1_get
parameter_list|(
name|database
parameter_list|,
name|key
parameter_list|,
name|data
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|data
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb1_db
decl_stmt|;
name|result
operator|=
name|db
operator|->
name|get
argument_list|(
name|db
argument_list|,
operator|&
name|key
operator|->
name|db
argument_list|,
operator|&
name|data
operator|->
name|db
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|result
operator|==
literal|1
condition|)
return|return
name|SMDBE_NOT_FOUND
return|;
return|return
name|errno
return|;
block|}
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdb1_put
parameter_list|(
name|database
parameter_list|,
name|key
parameter_list|,
name|data
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|data
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
block|{
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb1_db
decl_stmt|;
return|return
name|db
operator|->
name|put
argument_list|(
name|db
argument_list|,
operator|&
name|key
operator|->
name|db
argument_list|,
operator|&
name|data
operator|->
name|db
argument_list|,
name|smdb_put_flags_to_db1_flags
argument_list|(
name|flags
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb1_set_owner
parameter_list|(
name|database
parameter_list|,
name|uid
parameter_list|,
name|gid
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|uid_t
name|uid
decl_stmt|;
name|gid_t
name|gid
decl_stmt|;
block|{
if|#
directive|if
name|HASFCHOWN
name|int
name|fd
decl_stmt|;
name|int
name|result
decl_stmt|;
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb1_db
decl_stmt|;
name|fd
operator|=
name|db
operator|->
name|fd
argument_list|(
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
return|return
name|errno
return|;
name|result
operator|=
name|fchown
argument_list|(
name|fd
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
return|return
name|errno
return|;
endif|#
directive|endif
comment|/* HASFCHOWN */
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdb1_sync
parameter_list|(
name|database
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
block|{
name|DB
modifier|*
name|db
init|=
operator|(
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
operator|)
operator|->
name|smdb1_db
decl_stmt|;
return|return
name|db
operator|->
name|sync
argument_list|(
name|db
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb1_cursor_close
parameter_list|(
name|cursor
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
block|{
name|SMDB_DB1_CURSOR
modifier|*
name|db1_cursor
init|=
operator|(
name|SMDB_DB1_CURSOR
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|SMDB_DB1_DATABASE
modifier|*
name|db1
init|=
name|db1_cursor
operator|->
name|db
decl_stmt|;
if|if
condition|(
operator|!
name|db1
operator|->
name|smdb1_cursor_in_use
condition|)
return|return
name|SMDBE_NOT_A_VALID_CURSOR
return|;
name|db1
operator|->
name|smdb1_cursor_in_use
operator|=
name|FALSE
expr_stmt|;
name|free
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdb1_cursor_del
parameter_list|(
name|cursor
parameter_list|,
name|flags
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
block|{
name|SMDB_DB1_CURSOR
modifier|*
name|db1_cursor
init|=
operator|(
name|SMDB_DB1_CURSOR
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|SMDB_DB1_DATABASE
modifier|*
name|db1
init|=
name|db1_cursor
operator|->
name|db
decl_stmt|;
name|DB
modifier|*
name|db
init|=
name|db1
operator|->
name|smdb1_db
decl_stmt|;
return|return
name|db
operator|->
name|del
argument_list|(
name|db
argument_list|,
name|NULL
argument_list|,
name|R_CURSOR
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb1_cursor_get
parameter_list|(
name|cursor
parameter_list|,
name|key
parameter_list|,
name|value
parameter_list|,
name|flags
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|value
decl_stmt|;
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|int
name|db1_flags
decl_stmt|;
name|int
name|result
decl_stmt|;
name|SMDB_DB1_CURSOR
modifier|*
name|db1_cursor
init|=
operator|(
name|SMDB_DB1_CURSOR
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|SMDB_DB1_DATABASE
modifier|*
name|db1
init|=
name|db1_cursor
operator|->
name|db
decl_stmt|;
name|DB
modifier|*
name|db
init|=
name|db1
operator|->
name|smdb1_db
decl_stmt|;
name|db1_flags
operator|=
name|smdb_cursor_get_flags_to_smdb1
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|result
operator|=
name|db
operator|->
name|seq
argument_list|(
name|db
argument_list|,
operator|&
name|key
operator|->
name|db
argument_list|,
operator|&
name|value
operator|->
name|db
argument_list|,
name|db1_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
operator|-
literal|1
condition|)
return|return
name|errno
return|;
if|if
condition|(
name|result
operator|==
literal|1
condition|)
return|return
name|SMDBE_LAST_ENTRY
return|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_function
name|int
name|smdb1_cursor_put
parameter_list|(
name|cursor
parameter_list|,
name|key
parameter_list|,
name|value
parameter_list|,
name|flags
parameter_list|)
name|SMDB_CURSOR
modifier|*
name|cursor
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|key
decl_stmt|;
name|SMDB_DBENT
modifier|*
name|value
decl_stmt|;
name|SMDB_FLAG
name|flags
decl_stmt|;
block|{
name|SMDB_DB1_CURSOR
modifier|*
name|db1_cursor
init|=
operator|(
name|SMDB_DB1_CURSOR
operator|*
operator|)
name|cursor
operator|->
name|smdbc_impl
decl_stmt|;
name|SMDB_DB1_DATABASE
modifier|*
name|db1
init|=
name|db1_cursor
operator|->
name|db
decl_stmt|;
name|DB
modifier|*
name|db
init|=
name|db1
operator|->
name|smdb1_db
decl_stmt|;
return|return
name|db
operator|->
name|put
argument_list|(
name|db
argument_list|,
operator|&
name|key
operator|->
name|db
argument_list|,
operator|&
name|value
operator|->
name|db
argument_list|,
name|R_CURSOR
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|smdb1_cursor
parameter_list|(
name|database
parameter_list|,
name|cursor
parameter_list|,
name|flags
parameter_list|)
name|SMDB_DATABASE
modifier|*
name|database
decl_stmt|;
name|SMDB_CURSOR
modifier|*
modifier|*
name|cursor
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
block|{
name|SMDB_DB1_DATABASE
modifier|*
name|db1
init|=
operator|(
name|SMDB_DB1_DATABASE
operator|*
operator|)
name|database
operator|->
name|smdb_impl
decl_stmt|;
name|SMDB_CURSOR
modifier|*
name|cur
decl_stmt|;
name|SMDB_DB1_CURSOR
modifier|*
name|db1_cursor
decl_stmt|;
if|if
condition|(
name|db1
operator|->
name|smdb1_cursor_in_use
condition|)
return|return
name|SMDBE_ONLY_SUPPORTS_ONE_CURSOR
return|;
name|db1
operator|->
name|smdb1_cursor_in_use
operator|=
name|TRUE
expr_stmt|;
name|db1_cursor
operator|=
operator|(
name|SMDB_DB1_CURSOR
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SMDB_DB1_CURSOR
argument_list|)
argument_list|)
expr_stmt|;
name|db1_cursor
operator|->
name|db
operator|=
name|db1
expr_stmt|;
name|cur
operator|=
operator|(
name|SMDB_CURSOR
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SMDB_CURSOR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|==
name|NULL
condition|)
return|return
name|SMDBE_MALLOC
return|;
name|cur
operator|->
name|smdbc_impl
operator|=
name|db1_cursor
expr_stmt|;
name|cur
operator|->
name|smdbc_close
operator|=
name|smdb1_cursor_close
expr_stmt|;
name|cur
operator|->
name|smdbc_del
operator|=
name|smdb1_cursor_del
expr_stmt|;
name|cur
operator|->
name|smdbc_get
operator|=
name|smdb1_cursor_get
expr_stmt|;
name|cur
operator|->
name|smdbc_put
operator|=
name|smdb1_cursor_put
expr_stmt|;
operator|*
name|cursor
operator|=
name|cur
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* **  SMDB_DB_OPEN -- Opens a db1 database. ** **	Parameters: **		database -- An unallocated database pointer to a pointer. **		db_name -- The name of the database without extension. **		mode -- File permisions on the database if created. **		mode_mask -- Mode bits that must match on an existing database. **		sff -- Flags for safefile. **		type -- The type of database to open **			See smdb_type_to_db1_type for valid types. **		user_info -- Information on the user to use for file **			    permissions. **		db_params -- **			An SMDB_DBPARAMS struct including params. These **			are processed according to the type of the **			database. Currently supported params (only for **			HASH type) are: **			   num_elements **			   cache_size ** **	Returns: **		SMDBE_OK -- Success, otherwise errno. */
end_comment

begin_function
name|int
name|smdb_db_open
parameter_list|(
name|database
parameter_list|,
name|db_name
parameter_list|,
name|mode
parameter_list|,
name|mode_mask
parameter_list|,
name|sff
parameter_list|,
name|type
parameter_list|,
name|user_info
parameter_list|,
name|db_params
parameter_list|)
name|SMDB_DATABASE
modifier|*
modifier|*
name|database
decl_stmt|;
name|char
modifier|*
name|db_name
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|int
name|mode_mask
decl_stmt|;
name|long
name|sff
decl_stmt|;
name|SMDB_DBTYPE
name|type
decl_stmt|;
name|SMDB_USER_INFO
modifier|*
name|user_info
decl_stmt|;
name|SMDB_DBPARAMS
modifier|*
name|db_params
decl_stmt|;
block|{
name|int
name|db_fd
decl_stmt|;
name|int
name|lock_fd
decl_stmt|;
name|int
name|result
decl_stmt|;
name|void
modifier|*
name|params
decl_stmt|;
name|SMDB_DATABASE
modifier|*
name|smdb_db
decl_stmt|;
name|SMDB_DB1_DATABASE
modifier|*
name|db1
decl_stmt|;
name|DB
modifier|*
name|db
decl_stmt|;
name|HASHINFO
name|hash_info
decl_stmt|;
name|BTREEINFO
name|btree_info
decl_stmt|;
name|DBTYPE
name|db_type
decl_stmt|;
name|struct
name|stat
name|stat_info
decl_stmt|;
name|char
name|db_file_name
index|[
name|SMDB_MAX_NAME_LEN
index|]
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|NULL
operator|||
operator|(
name|strncmp
argument_list|(
name|SMDB_TYPE_HASH
argument_list|,
name|type
argument_list|,
name|SMDB_TYPE_HASH_LEN
argument_list|)
operator|!=
literal|0
operator|&&
name|strncmp
argument_list|(
name|SMDB_TYPE_BTREE
argument_list|,
name|type
argument_list|,
name|SMDB_TYPE_BTREE_LEN
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
name|SMDBE_UNKNOWN_DB_TYPE
return|;
name|result
operator|=
name|smdb_add_extension
argument_list|(
name|db_file_name
argument_list|,
name|SMDB_MAX_NAME_LEN
argument_list|,
name|db_name
argument_list|,
name|SMDB1_FILE_EXTENSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
name|result
operator|=
name|smdb_setup_file
argument_list|(
name|db_name
argument_list|,
name|SMDB1_FILE_EXTENSION
argument_list|,
name|mode_mask
argument_list|,
name|sff
argument_list|,
name|user_info
argument_list|,
operator|&
name|stat_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
name|lock_fd
operator|=
operator|-
literal|1
expr_stmt|;
if|#
directive|if
name|O_EXLOCK
name|mode
operator||=
name|O_EXLOCK
expr_stmt|;
else|#
directive|else
comment|/* O_EXLOCK */
name|result
operator|=
name|smdb_lock_file
argument_list|(
operator|&
name|lock_fd
argument_list|,
name|db_name
argument_list|,
name|mode
argument_list|,
name|sff
argument_list|,
name|SMDB1_FILE_EXTENSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
return|return
name|result
return|;
endif|#
directive|endif
comment|/* O_EXLOCK */
operator|*
name|database
operator|=
name|NULL
expr_stmt|;
name|smdb_db
operator|=
name|smdb_malloc_database
argument_list|()
expr_stmt|;
name|db1
operator|=
name|smdb1_malloc_database
argument_list|()
expr_stmt|;
if|if
condition|(
name|smdb_db
operator|==
name|NULL
operator|||
name|db1
operator|==
name|NULL
condition|)
return|return
name|SMDBE_MALLOC
return|;
name|db1
operator|->
name|smdb1_lock_fd
operator|=
name|lock_fd
expr_stmt|;
name|params
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|db_params
operator|!=
name|NULL
operator|&&
operator|(
name|strncmp
argument_list|(
name|SMDB_TYPE_HASH
argument_list|,
name|type
argument_list|,
name|SMDB_TYPE_HASH_LEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|memset
argument_list|(
operator|&
name|hash_info
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|hash_info
argument_list|)
expr_stmt|;
name|hash_info
operator|.
name|nelem
operator|=
name|db_params
operator|->
name|smdbp_num_elements
expr_stmt|;
name|hash_info
operator|.
name|cachesize
operator|=
name|db_params
operator|->
name|smdbp_cache_size
expr_stmt|;
name|params
operator|=
operator|&
name|hash_info
expr_stmt|;
block|}
if|if
condition|(
name|db_params
operator|!=
name|NULL
operator|&&
operator|(
name|strncmp
argument_list|(
name|SMDB_TYPE_BTREE
argument_list|,
name|type
argument_list|,
name|SMDB_TYPE_BTREE_LEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|memset
argument_list|(
operator|&
name|btree_info
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|btree_info
argument_list|)
expr_stmt|;
name|btree_info
operator|.
name|cachesize
operator|=
name|db_params
operator|->
name|smdbp_cache_size
expr_stmt|;
if|if
condition|(
name|db_params
operator|->
name|smdbp_allow_dup
condition|)
name|btree_info
operator|.
name|flags
operator||=
name|R_DUP
expr_stmt|;
name|params
operator|=
operator|&
name|btree_info
expr_stmt|;
block|}
name|db_type
operator|=
name|smdb_type_to_db1_type
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|db
operator|=
name|dbopen
argument_list|(
name|db_file_name
argument_list|,
name|mode
argument_list|,
literal|0644
argument_list|,
name|db_type
argument_list|,
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
block|{
name|db_fd
operator|=
name|db
operator|->
name|fd
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|result
operator|=
name|smdb_filechanged
argument_list|(
name|db_name
argument_list|,
name|SMDB1_FILE_EXTENSION
argument_list|,
name|db_fd
argument_list|,
operator|&
name|stat_info
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|errno
operator|==
literal|0
condition|)
name|result
operator|=
name|SMDBE_BAD_OPEN
expr_stmt|;
else|else
name|result
operator|=
name|errno
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|SMDBE_OK
condition|)
block|{
comment|/* Everything is ok. Setup driver */
name|db1
operator|->
name|smdb1_db
operator|=
name|db
expr_stmt|;
name|smdb_db
operator|->
name|smdb_close
operator|=
name|smdb1_close
expr_stmt|;
name|smdb_db
operator|->
name|smdb_del
operator|=
name|smdb1_del
expr_stmt|;
name|smdb_db
operator|->
name|smdb_fd
operator|=
name|smdb1_fd
expr_stmt|;
name|smdb_db
operator|->
name|smdb_lockfd
operator|=
name|smdb1_lockfd
expr_stmt|;
name|smdb_db
operator|->
name|smdb_get
operator|=
name|smdb1_get
expr_stmt|;
name|smdb_db
operator|->
name|smdb_put
operator|=
name|smdb1_put
expr_stmt|;
name|smdb_db
operator|->
name|smdb_set_owner
operator|=
name|smdb1_set_owner
expr_stmt|;
name|smdb_db
operator|->
name|smdb_sync
operator|=
name|smdb1_sync
expr_stmt|;
name|smdb_db
operator|->
name|smdb_cursor
operator|=
name|smdb1_cursor
expr_stmt|;
name|smdb_db
operator|->
name|smdb_impl
operator|=
name|db1
expr_stmt|;
operator|*
name|database
operator|=
name|smdb_db
expr_stmt|;
return|return
name|SMDBE_OK
return|;
block|}
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|db
operator|->
name|close
argument_list|(
name|db
argument_list|)
expr_stmt|;
comment|/* Error opening database */
operator|(
name|void
operator|)
name|smdb_unlock_file
argument_list|(
name|db1
operator|->
name|smdb1_lock_fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db1
argument_list|)
expr_stmt|;
name|smdb_free_database
argument_list|(
name|smdb_db
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (DB_VERSION_MAJOR == 1) */
end_comment

end_unit


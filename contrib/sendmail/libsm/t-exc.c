begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2001 Proofpoint, Inc. and its suppliers.  *	All rights reserved.  *  * By using this file, you agree to the terms and conditions set  * forth in the LICENSE file which can be found at the top level of  * the sendmail distribution.  */
end_comment

begin_include
include|#
directive|include
file|<sm/gen.h>
end_include

begin_macro
name|SM_IDSTR
argument_list|(
argument|id
argument_list|,
literal|"@(#)$Id: t-exc.c,v 1.21 2013/11/22 20:51:43 ca Exp $"
argument_list|)
end_macro

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sm/heap.h>
end_include

begin_include
include|#
directive|include
file|<sm/io.h>
end_include

begin_include
include|#
directive|include
file|<sm/test.h>
end_include

begin_decl_stmt
specifier|const
name|SM_EXC_TYPE_T
name|EtypeTest1
init|=
block|{
name|SmExcTypeMagic
block|,
literal|"E:test1"
block|,
literal|"i"
block|,
name|sm_etype_printf
block|,
literal|"test1 exception argv[0]=%0"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|SM_EXC_TYPE_T
name|EtypeTest2
init|=
block|{
name|SmExcTypeMagic
block|,
literal|"E:test2"
block|,
literal|"i"
block|,
name|sm_etype_printf
block|,
literal|"test2 exception argv[0]=%0"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|void
modifier|*
name|p
decl_stmt|;
name|int
specifier|volatile
name|x
decl_stmt|;
name|char
modifier|*
name|unknown
decl_stmt|,
modifier|*
name|cant
decl_stmt|;
name|sm_test_begin
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"test exception handling"
argument_list|)
expr_stmt|;
comment|/* 	**  SM_TRY 	*/
name|cant
operator|=
literal|"can't happen"
expr_stmt|;
name|x
operator|=
literal|0
expr_stmt|;
name|SM_TRY
name|x
init|=
literal|1
decl_stmt|;
name|SM_END_TRY
name|SM_TEST
argument_list|(
name|x
operator|==
literal|1
argument_list|)
decl_stmt|;
comment|/* 	**  SM_FINALLY-0 	*/
name|x
operator|=
literal|0
expr_stmt|;
name|SM_TRY
name|x
init|=
literal|1
decl_stmt|;
name|SM_FINALLY
name|x
init|=
literal|2
decl_stmt|;
name|SM_END_TRY
name|SM_TEST
argument_list|(
name|x
operator|==
literal|2
argument_list|)
decl_stmt|;
comment|/* 	**  SM_FINALLY-1 	*/
name|x
operator|=
literal|0
expr_stmt|;
name|SM_TRY
name|SM_TRY
name|x
init|=
literal|1
decl_stmt|;
name|sm_exc_raisenew_x
argument_list|(
operator|&
name|EtypeTest1
argument_list|,
literal|17
argument_list|)
expr_stmt|;
name|SM_FINALLY
name|x
init|=
literal|2
decl_stmt|;
name|sm_exc_raisenew_x
argument_list|(
operator|&
name|EtypeTest2
argument_list|,
literal|42
argument_list|)
expr_stmt|;
name|SM_END_TRY
name|SM_EXCEPT
argument_list|(
name|exc
argument_list|,
literal|"E:test2"
argument_list|)
argument_list|(
name|void
argument_list|)
name|sm_io_fprintf
argument_list|(
name|smioout
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"got exception test2: can't happen\n"
argument_list|)
decl_stmt|;
name|SM_EXCEPT
argument_list|(
argument|exc
argument_list|,
literal|"E:test1"
argument_list|)
name|SM_TEST
argument_list|(
name|x
operator|==
literal|2
operator|&&
name|exc
operator|->
name|exc_argv
index|[
literal|0
index|]
operator|.
name|v_int
operator|==
literal|17
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|x
operator|==
literal|2
operator|&&
name|exc
operator|->
name|exc_argv
index|[
literal|0
index|]
operator|.
name|v_int
operator|==
literal|17
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioout
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"can't happen: x=%d argv[0]=%d\n"
argument_list|,
name|x
argument_list|,
name|exc
operator|->
name|exc_argv
index|[
literal|0
index|]
operator|.
name|v_int
argument_list|)
expr_stmt|;
block|}
name|SM_EXCEPT
argument_list|(
argument|exc
argument_list|,
literal|"*"
argument_list|)
block|{
name|unknown
operator|=
literal|"unknown exception: "
expr_stmt|;
name|SM_TEST
argument_list|(
name|strcmp
argument_list|(
name|unknown
argument_list|,
name|cant
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|SM_END_TRY
name|x
init|=
literal|3
decl_stmt|;
name|SM_TRY
name|x
init|=
literal|4
decl_stmt|;
name|sm_exc_raisenew_x
argument_list|(
operator|&
name|EtypeTest1
argument_list|,
literal|94
argument_list|)
expr_stmt|;
name|SM_FINALLY
name|x
init|=
literal|5
decl_stmt|;
name|sm_exc_raisenew_x
argument_list|(
operator|&
name|EtypeTest2
argument_list|,
literal|95
argument_list|)
expr_stmt|;
name|SM_EXCEPT
argument_list|(
argument|exc
argument_list|,
literal|"E:test2"
argument_list|)
block|{
name|unknown
operator|=
literal|"got exception test2: "
expr_stmt|;
name|SM_TEST
argument_list|(
name|strcmp
argument_list|(
name|unknown
argument_list|,
name|cant
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|SM_EXCEPT
argument_list|(
argument|exc
argument_list|,
literal|"E:test1"
argument_list|)
name|SM_TEST
argument_list|(
name|x
operator|==
literal|5
operator|&&
name|exc
operator|->
name|exc_argv
index|[
literal|0
index|]
operator|.
name|v_int
operator|==
literal|94
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|x
operator|==
literal|5
operator|&&
name|exc
operator|->
name|exc_argv
index|[
literal|0
index|]
operator|.
name|v_int
operator|==
literal|94
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioout
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"can't happen: x=%d argv[0]=%d\n"
argument_list|,
name|x
argument_list|,
name|exc
operator|->
name|exc_argv
index|[
literal|0
index|]
operator|.
name|v_int
argument_list|)
expr_stmt|;
block|}
name|SM_EXCEPT
argument_list|(
argument|exc
argument_list|,
literal|"*"
argument_list|)
block|{
name|unknown
operator|=
literal|"unknown exception: "
expr_stmt|;
name|SM_TEST
argument_list|(
name|strcmp
argument_list|(
name|unknown
argument_list|,
name|cant
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|SM_END_TRY
name|SM_TRY
name|sm_exc_raisenew_x
argument_list|(
operator|&
name|SmEtypeErr
argument_list|,
literal|"test %d"
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|SM_EXCEPT
argument_list|(
argument|exc
argument_list|,
literal|"*"
argument_list|)
if|#
directive|if
name|DEBUG
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioout
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"test 0 got an exception, as expected:\n"
argument_list|)
expr_stmt|;
name|sm_exc_print
argument_list|(
name|exc
argument_list|,
name|smioout
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
return|return
name|sm_test_end
argument_list|()
return|;
name|SM_END_TRY
name|p
init|=
name|sm_malloc_x
argument_list|(
call|(
name|size_t
call|)
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
decl_stmt|;
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioout
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"sm_malloc_x unexpectedly succeeded, returning %p\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|unknown
operator|=
literal|"sm_malloc_x unexpectedly succeeded"
expr_stmt|;
name|SM_TEST
argument_list|(
name|strcmp
argument_list|(
name|unknown
argument_list|,
name|cant
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
name|sm_test_end
argument_list|()
return|;
block|}
end_function

end_unit


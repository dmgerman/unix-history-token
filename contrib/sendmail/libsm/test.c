begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2002 Proofpoint, Inc. and its suppliers.  *	All rights reserved.  *  * By using this file, you agree to the terms and conditions set  * forth in the LICENSE file which can be found at the top level of  * the sendmail distribution.  */
end_comment

begin_include
include|#
directive|include
file|<sm/gen.h>
end_include

begin_macro
name|SM_IDSTR
argument_list|(
argument|Id
argument_list|,
literal|"@(#)$Id: test.c,v 1.17 2013-11-22 20:51:44 ca Exp $"
argument_list|)
end_macro

begin_comment
comment|/* **  Abstractions for writing libsm test programs. */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sm/debug.h>
end_include

begin_include
include|#
directive|include
file|<sm/test.h>
end_include

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|optind
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|optopt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|opterr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|SmTestIndex
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|SmTestNumErrors
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bool
name|SmTestVerbose
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|Help
index|[]
init|=
literal|"\ %s [-h] [-d debugging] [-v]\n\ \n\ %s\n\ \n\ -h		Display this help information.\n\ -d debugging	Set debug activation levels.\n\ -v		Verbose output.\n\ "
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|Usage
index|[]
init|=
literal|"\ Usage: %s [-h] [-v]\n\ Use %s -h for help.\n\ "
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* **  SM_TEST_BEGIN -- initialize test system. ** **	Parameters: **		argc -- argument counter. **		argv -- argument vector. **		testname -- description of tests. ** **	Results: **		none. */
end_comment

begin_function
name|void
name|sm_test_begin
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|testname
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|char
modifier|*
name|testname
decl_stmt|;
block|{
name|int
name|c
decl_stmt|;
name|SmTestIndex
operator|=
literal|0
expr_stmt|;
name|SmTestNumErrors
operator|=
literal|0
expr_stmt|;
name|SmTestVerbose
operator|=
name|false
expr_stmt|;
name|opterr
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"vhd:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'v'
case|:
name|SmTestVerbose
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|sm_debug_addsettings_x
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
name|Help
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|testname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
default|default:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown command line option -%c\n"
argument_list|,
name|optopt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|Usage
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* **  SM_TEST -- single test. ** **	Parameters: **		success -- did test succeeed? **		expr -- expression that has been evaluated. **		filename -- guess... **		lineno -- line number. ** **	Results: **		value of success. */
end_comment

begin_function
name|bool
name|sm_test
parameter_list|(
name|success
parameter_list|,
name|expr
parameter_list|,
name|filename
parameter_list|,
name|lineno
parameter_list|)
name|bool
name|success
decl_stmt|;
name|char
modifier|*
name|expr
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|;
name|int
name|lineno
decl_stmt|;
block|{
operator|++
name|SmTestIndex
expr_stmt|;
if|if
condition|(
name|SmTestVerbose
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d.."
argument_list|,
name|SmTestIndex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|success
condition|)
block|{
operator|++
name|SmTestNumErrors
expr_stmt|;
if|if
condition|(
operator|!
name|SmTestVerbose
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d.."
argument_list|,
name|SmTestIndex
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad! %s:%d %s\n"
argument_list|,
name|filename
argument_list|,
name|lineno
argument_list|,
name|expr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SmTestVerbose
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ok\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|success
return|;
block|}
end_function

begin_comment
comment|/* **  SM_TEST_END -- end of test system. ** **	Parameters: **		none. ** **	Results: **		number of errors. */
end_comment

begin_function
name|int
name|sm_test_end
parameter_list|()
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d of %d tests completed successfully\n"
argument_list|,
name|SmTestIndex
operator|-
name|SmTestNumErrors
argument_list|,
name|SmTestIndex
argument_list|)
expr_stmt|;
if|if
condition|(
name|SmTestNumErrors
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"*** %d error%s in test! ***\n"
argument_list|,
name|SmTestNumErrors
argument_list|,
name|SmTestNumErrors
operator|>
literal|1
condition|?
literal|"s"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
name|SmTestNumErrors
return|;
block|}
end_function

end_unit


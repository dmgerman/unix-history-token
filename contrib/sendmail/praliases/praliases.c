begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1998-2001, 2008 Proofpoint, Inc. and its suppliers.  *	All rights reserved.  * Copyright (c) 1983 Eric P. Allman.  All rights reserved.  * Copyright (c) 1988, 1993  *	The Regents of the University of California.  All rights reserved.  *  * By using this file, you agree to the terms and conditions set  * forth in the LICENSE file which can be found at the top level of  * the sendmail distribution.  *  */
end_comment

begin_include
include|#
directive|include
file|<sm/gen.h>
end_include

begin_macro
name|SM_IDSTR
argument_list|(
argument|copyright
argument_list|,
literal|"@(#) Copyright (c) 1998-2001 Proofpoint, Inc. and its suppliers.\n\ 	All rights reserved.\n\      Copyright (c) 1983 Eric P. Allman.  All rights reserved.\n\      Copyright (c) 1988, 1993\n\ 	The Regents of the University of California.  All rights reserved.\n"
argument_list|)
end_macro

begin_macro
name|SM_IDSTR
argument_list|(
argument|id
argument_list|,
literal|"@(#)$Id: praliases.c,v 8.98 2013-11-22 20:51:53 ca Exp $"
argument_list|)
end_macro

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|EX_OK
end_ifdef

begin_undef
undef|#
directive|undef
name|EX_OK
end_undef

begin_comment
comment|/* unistd.h may have another use for this */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EX_OK */
end_comment

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|NOT_SENDMAIL
end_ifndef

begin_define
define|#
directive|define
name|NOT_SENDMAIL
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ! NOT_SENDMAIL */
end_comment

begin_include
include|#
directive|include
file|<sendmail/sendmail.h>
end_include

begin_include
include|#
directive|include
file|<sendmail/pathnames.h>
end_include

begin_include
include|#
directive|include
file|<libsmdb/smdb.h>
end_include

begin_decl_stmt
specifier|static
name|void
name|praliases
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|int
operator|,
name|char
operator|*
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uid_t
name|RealUid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|gid_t
name|RealGid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|RealUserName
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uid_t
name|RunAsUid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|gid_t
name|RunAsGid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|RunAsUserName
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Verbose
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bool
name|DontInitGroups
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uid_t
name|TrustedUid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BITMAP256
name|DontBlameSendmail
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DELIMITERS
value|" ,/"
end_define

begin_define
define|#
directive|define
name|PATH_SEPARATOR
value|':'
end_define

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|char
modifier|*
name|cfile
decl_stmt|;
name|char
modifier|*
name|filename
init|=
name|NULL
decl_stmt|;
name|SM_FILE_T
modifier|*
name|cfp
decl_stmt|;
name|int
name|ch
decl_stmt|;
name|char
name|afilebuf
index|[
name|MAXLINE
index|]
decl_stmt|;
name|char
name|buf
index|[
name|MAXLINE
index|]
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
specifier|static
name|char
name|rnamebuf
index|[
name|MAXNAME
index|]
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|;
name|clrbitmap
argument_list|(
name|DontBlameSendmail
argument_list|)
expr_stmt|;
name|RunAsUid
operator|=
name|RealUid
operator|=
name|getuid
argument_list|()
expr_stmt|;
name|RunAsGid
operator|=
name|RealGid
operator|=
name|getgid
argument_list|()
expr_stmt|;
name|pw
operator|=
name|getpwuid
argument_list|(
name|RealUid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pw
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pw
operator|->
name|pw_name
argument_list|)
operator|>
name|MAXNAME
operator|-
literal|1
condition|)
name|pw
operator|->
name|pw_name
index|[
name|MAXNAME
index|]
operator|=
literal|0
expr_stmt|;
name|sm_snprintf
argument_list|(
name|rnamebuf
argument_list|,
sizeof|sizeof
name|rnamebuf
argument_list|,
literal|"%s"
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|sm_snprintf
argument_list|(
name|rnamebuf
argument_list|,
sizeof|sizeof
name|rnamebuf
argument_list|,
literal|"Unknown UID %d"
argument_list|,
operator|(
name|int
operator|)
name|RealUid
argument_list|)
expr_stmt|;
name|RunAsUserName
operator|=
name|RealUserName
operator|=
name|rnamebuf
expr_stmt|;
name|cfile
operator|=
name|getcfname
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|SM_GET_SENDMAIL_CF
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"C:f:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
operator|(
name|char
operator|)
name|ch
condition|)
block|{
case|case
literal|'C'
case|:
name|cfile
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|filename
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioerr
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"usage: praliases [-C cffile] [-f aliasfile]"
literal|" [key ...]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|filename
operator|!=
name|NULL
condition|)
block|{
name|praliases
argument_list|(
name|filename
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_OK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cfp
operator|=
name|sm_io_open
argument_list|(
name|SmFtStdio
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
name|cfile
argument_list|,
name|SM_IO_RDONLY
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioerr
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"praliases: %s: %s\n"
argument_list|,
name|cfile
argument_list|,
name|sm_errstring
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_NOINPUT
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|sm_io_fgets
argument_list|(
name|cfp
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|>=
literal|0
condition|)
block|{
specifier|register
name|char
modifier|*
name|b
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|b
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|!=
name|NULL
condition|)
operator|*
name|b
operator|=
literal|'\0'
expr_stmt|;
name|b
operator|=
name|buf
expr_stmt|;
switch|switch
condition|(
operator|*
name|b
operator|++
condition|)
block|{
case|case
literal|'O'
case|:
comment|/* option -- see if alias file */
if|if
condition|(
name|sm_strncasecmp
argument_list|(
name|b
argument_list|,
literal|" AliasFile"
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
operator|&&
operator|!
operator|(
name|isascii
argument_list|(
name|b
index|[
literal|10
index|]
argument_list|)
operator|&&
name|isalnum
argument_list|(
name|b
index|[
literal|10
index|]
argument_list|)
operator|)
condition|)
block|{
comment|/* new form -- find value */
name|b
operator|=
name|strchr
argument_list|(
name|b
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
continue|continue;
while|while
condition|(
name|isascii
argument_list|(
operator|*
operator|++
name|b
argument_list|)
operator|&&
name|isspace
argument_list|(
operator|*
name|b
argument_list|)
condition|)
continue|continue;
block|}
elseif|else
if|if
condition|(
operator|*
name|b
operator|++
operator|!=
literal|'A'
condition|)
block|{
comment|/* something else boring */
continue|continue;
block|}
comment|/* this is the A or AliasFile option -- save it */
if|if
condition|(
name|sm_strlcpy
argument_list|(
name|afilebuf
argument_list|,
name|b
argument_list|,
sizeof|sizeof
name|afilebuf
argument_list|)
operator|>=
sizeof|sizeof
name|afilebuf
condition|)
block|{
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioerr
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"praliases: AliasFile filename too long: %.30s\n"
argument_list|,
name|b
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sm_io_close
argument_list|(
name|cfp
argument_list|,
name|SM_TIME_DEFAULT
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_CONFIG
argument_list|)
expr_stmt|;
block|}
name|b
operator|=
name|afilebuf
expr_stmt|;
for|for
control|(
name|p
operator|=
name|b
init|;
name|p
operator|!=
name|NULL
condition|;
control|)
block|{
while|while
condition|(
name|isascii
argument_list|(
operator|*
name|p
argument_list|)
operator|&&
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
break|break;
name|b
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|strpbrk
argument_list|(
name|p
argument_list|,
name|DELIMITERS
argument_list|)
expr_stmt|;
comment|/* find end of spec */
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|bool
name|quoted
init|=
name|false
decl_stmt|;
for|for
control|(
init|;
operator|*
name|p
operator|!=
literal|'\0'
condition|;
name|p
operator|++
control|)
block|{
comment|/* 						**  Don't break into a quoted 						**  string. 						*/
if|if
condition|(
operator|*
name|p
operator|==
literal|'"'
condition|)
name|quoted
operator|=
operator|!
name|quoted
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|p
operator|==
literal|','
operator|&&
operator|!
name|quoted
condition|)
break|break;
block|}
comment|/* No more alias specs follow */
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
block|{
comment|/* chop trailing whitespace */
while|while
condition|(
name|isascii
argument_list|(
operator|*
name|p
argument_list|)
operator|&&
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
operator|&&
name|p
operator|>
name|b
condition|)
name|p
operator|--
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|e
init|=
name|p
operator|-
literal|1
decl_stmt|;
comment|/* chop trailing whitespace */
while|while
condition|(
name|isascii
argument_list|(
operator|*
name|e
argument_list|)
operator|&&
name|isspace
argument_list|(
operator|*
name|e
argument_list|)
operator|&&
name|e
operator|>
name|b
condition|)
name|e
operator|--
expr_stmt|;
operator|*
operator|++
name|e
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
name|praliases
argument_list|(
name|b
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
block|}
default|default:
continue|continue;
block|}
block|}
operator|(
name|void
operator|)
name|sm_io_close
argument_list|(
name|cfp
argument_list|,
name|SM_TIME_DEFAULT
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_OK
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
return|return
name|EX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|praliases
parameter_list|(
name|filename
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|filename
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|char
modifier|*
name|colon
decl_stmt|;
name|char
modifier|*
name|db_name
decl_stmt|;
name|char
modifier|*
name|db_type
decl_stmt|;
name|SMDB_DATABASE
modifier|*
name|database
init|=
name|NULL
decl_stmt|;
name|SMDB_CURSOR
modifier|*
name|cursor
init|=
name|NULL
decl_stmt|;
name|SMDB_DBENT
name|db_key
decl_stmt|,
name|db_value
decl_stmt|;
name|SMDB_DBPARAMS
name|params
decl_stmt|;
name|SMDB_USER_INFO
name|user_info
decl_stmt|;
name|colon
operator|=
name|strchr
argument_list|(
name|filename
argument_list|,
name|PATH_SEPARATOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|colon
operator|==
name|NULL
condition|)
block|{
name|db_name
operator|=
name|filename
expr_stmt|;
name|db_type
operator|=
name|SMDB_TYPE_DEFAULT
expr_stmt|;
block|}
else|else
block|{
operator|*
name|colon
operator|=
literal|'\0'
expr_stmt|;
name|db_name
operator|=
name|colon
operator|+
literal|1
expr_stmt|;
name|db_type
operator|=
name|filename
expr_stmt|;
block|}
comment|/* clean off arguments */
for|for
control|(
init|;
condition|;
control|)
block|{
while|while
condition|(
name|isascii
argument_list|(
operator|*
name|db_name
argument_list|)
operator|&&
name|isspace
argument_list|(
operator|*
name|db_name
argument_list|)
condition|)
name|db_name
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|db_name
operator|!=
literal|'-'
condition|)
break|break;
while|while
condition|(
operator|*
name|db_name
operator|!=
literal|'\0'
operator|&&
operator|!
operator|(
name|isascii
argument_list|(
operator|*
name|db_name
argument_list|)
operator|&&
name|isspace
argument_list|(
operator|*
name|db_name
argument_list|)
operator|)
condition|)
name|db_name
operator|++
expr_stmt|;
block|}
comment|/* Skip non-file based DB types */
if|if
condition|(
name|db_type
operator|!=
name|NULL
operator|&&
operator|*
name|db_type
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|db_type
operator|!=
name|SMDB_TYPE_DEFAULT
operator|&&
name|strcmp
argument_list|(
name|db_type
argument_list|,
literal|"hash"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|db_type
argument_list|,
literal|"btree"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|db_type
argument_list|,
literal|"dbm"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|sm_io_fprintf
argument_list|(
name|smioerr
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"praliases: Skipping non-file based alias type %s\n"
argument_list|,
name|db_type
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
operator|*
name|db_name
operator|==
literal|'\0'
operator|||
operator|(
name|db_type
operator|!=
name|NULL
operator|&&
operator|*
name|db_type
operator|==
literal|'\0'
operator|)
condition|)
block|{
if|if
condition|(
name|colon
operator|!=
name|NULL
condition|)
operator|*
name|colon
operator|=
literal|':'
expr_stmt|;
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioerr
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"praliases: illegal alias specification: %s\n"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
goto|goto
name|fatal
goto|;
block|}
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|params
argument_list|)
expr_stmt|;
name|params
operator|.
name|smdbp_cache_size
operator|=
literal|1024
operator|*
literal|1024
expr_stmt|;
name|user_info
operator|.
name|smdbu_id
operator|=
name|RunAsUid
expr_stmt|;
name|user_info
operator|.
name|smdbu_group_id
operator|=
name|RunAsGid
expr_stmt|;
operator|(
name|void
operator|)
name|sm_strlcpy
argument_list|(
name|user_info
operator|.
name|smdbu_name
argument_list|,
name|RunAsUserName
argument_list|,
name|SMDB_MAX_USER_NAME_LEN
argument_list|)
expr_stmt|;
name|result
operator|=
name|smdb_open_database
argument_list|(
operator|&
name|database
argument_list|,
name|db_name
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|,
name|SFF_ROOTOK
argument_list|,
name|db_type
argument_list|,
operator|&
name|user_info
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
block|{
name|sm_io_fprintf
argument_list|(
name|smioerr
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"praliases: %s: open: %s\n"
argument_list|,
name|db_name
argument_list|,
name|sm_errstring
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fatal
goto|;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
name|memset
argument_list|(
operator|&
name|db_key
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|db_key
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|db_value
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|db_value
argument_list|)
expr_stmt|;
name|result
operator|=
name|database
operator|->
name|smdb_cursor
argument_list|(
name|database
argument_list|,
operator|&
name|cursor
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
condition|)
block|{
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioerr
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"praliases: %s: set cursor: %s\n"
argument_list|,
name|db_name
argument_list|,
name|sm_errstring
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fatal
goto|;
block|}
while|while
condition|(
operator|(
name|result
operator|=
name|cursor
operator|->
name|smdbc_get
argument_list|(
name|cursor
argument_list|,
operator|&
name|db_key
argument_list|,
operator|&
name|db_value
argument_list|,
name|SMDB_CURSOR_GET_NEXT
argument_list|)
operator|)
operator|==
name|SMDBE_OK
condition|)
block|{
if|#
directive|if
literal|0
comment|/* skip magic @:@ entry */
block|if (db_key.size == 2&& 			    db_key.data[0] == '@'&& 			    db_key.data[1] == '\0'&& 			    db_value.size == 2&& 			    db_value.data[0] == '@'&& 			    db_value.data[1] == '\0') 				continue;
endif|#
directive|endif
comment|/* 0 */
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioout
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"%.*s:%.*s\n"
argument_list|,
operator|(
name|int
operator|)
name|db_key
operator|.
name|size
argument_list|,
operator|(
name|char
operator|*
operator|)
name|db_key
operator|.
name|data
argument_list|,
operator|(
name|int
operator|)
name|db_value
operator|.
name|size
argument_list|,
operator|(
name|char
operator|*
operator|)
name|db_value
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|!=
name|SMDBE_OK
operator|&&
name|result
operator|!=
name|SMDBE_LAST_ENTRY
condition|)
block|{
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioerr
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"praliases: %s: get value at cursor: %s\n"
argument_list|,
name|db_name
argument_list|,
name|sm_errstring
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fatal
goto|;
block|}
block|}
else|else
for|for
control|(
init|;
operator|*
name|argv
operator|!=
name|NULL
condition|;
operator|++
name|argv
control|)
block|{
name|int
name|get_res
decl_stmt|;
name|memset
argument_list|(
operator|&
name|db_key
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|db_key
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|db_value
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
name|db_value
argument_list|)
expr_stmt|;
name|db_key
operator|.
name|data
operator|=
operator|*
name|argv
expr_stmt|;
name|db_key
operator|.
name|size
operator|=
name|strlen
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
name|get_res
operator|=
name|database
operator|->
name|smdb_get
argument_list|(
name|database
argument_list|,
operator|&
name|db_key
argument_list|,
operator|&
name|db_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_res
operator|==
name|SMDBE_NOT_FOUND
condition|)
block|{
name|db_key
operator|.
name|size
operator|++
expr_stmt|;
name|get_res
operator|=
name|database
operator|->
name|smdb_get
argument_list|(
name|database
argument_list|,
operator|&
name|db_key
argument_list|,
operator|&
name|db_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|get_res
operator|==
name|SMDBE_OK
condition|)
block|{
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioout
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"%.*s:%.*s\n"
argument_list|,
operator|(
name|int
operator|)
name|db_key
operator|.
name|size
argument_list|,
operator|(
name|char
operator|*
operator|)
name|db_key
operator|.
name|data
argument_list|,
operator|(
name|int
operator|)
name|db_value
operator|.
name|size
argument_list|,
operator|(
name|char
operator|*
operator|)
name|db_value
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioout
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"%s: No such key\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|db_key
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
name|fatal
label|:
if|if
condition|(
name|cursor
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|cursor
operator|->
name|smdbc_close
argument_list|(
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|database
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|database
operator|->
name|smdb_close
argument_list|(
name|database
argument_list|)
expr_stmt|;
if|if
condition|(
name|colon
operator|!=
name|NULL
condition|)
operator|*
name|colon
operator|=
literal|':'
expr_stmt|;
return|return;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2008 Christos Zoulas  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Parse Composite Document Files, the format used in Microsoft Office  * document files before they switched to zipped XML.  * Info from: http://sc.openoffice.org/compdocfileformat.pdf  *  * N.B. This is the "Composite Document File" format, and not the  * "Compound Document Format", nor the "Channel Definition Format".  */
end_comment

begin_include
include|#
directive|include
file|"file.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_macro
name|FILE_RCSID
argument_list|(
literal|"@(#)$File: cdf.c,v 1.106 2017/04/30 17:05:02 christos Exp $"
argument_list|)
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CDF_DEBUG
end_ifdef

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIMITS_H
end_ifdef

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|EFTYPE
end_ifndef

begin_define
define|#
directive|define
name|EFTYPE
value|EINVAL
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"cdf.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CDF_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|a
parameter_list|)
value|printf a, fflush(stdout)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|a
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_union
specifier|static
union|union
block|{
name|char
name|s
index|[
literal|4
index|]
decl_stmt|;
name|uint32_t
name|u
decl_stmt|;
block|}
name|cdf_bo
union|;
end_union

begin_define
define|#
directive|define
name|NEED_SWAP
value|(cdf_bo.u == (uint32_t)0x01020304)
end_define

begin_define
define|#
directive|define
name|CDF_TOLE8
parameter_list|(
name|x
parameter_list|)
value|((uint64_t)(NEED_SWAP ? _cdf_tole8(x) : (uint64_t)(x)))
end_define

begin_define
define|#
directive|define
name|CDF_TOLE4
parameter_list|(
name|x
parameter_list|)
value|((uint32_t)(NEED_SWAP ? _cdf_tole4(x) : (uint32_t)(x)))
end_define

begin_define
define|#
directive|define
name|CDF_TOLE2
parameter_list|(
name|x
parameter_list|)
value|((uint16_t)(NEED_SWAP ? _cdf_tole2(x) : (uint16_t)(x)))
end_define

begin_define
define|#
directive|define
name|CDF_TOLE
parameter_list|(
name|x
parameter_list|)
value|(
comment|/*CONSTCOND*/
value|sizeof(x) == 2 ? \ 			    CDF_TOLE2(CAST(uint16_t, x)) : \ 			(
comment|/*CONSTCOND*/
value|sizeof(x) == 4 ? \ 			    CDF_TOLE4(CAST(uint32_t, x)) : \ 			    CDF_TOLE8(CAST(uint64_t, x))))
end_define

begin_define
define|#
directive|define
name|CDF_GETUINT32
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|cdf_getuint32(x, y)
end_define

begin_define
define|#
directive|define
name|CDF_MALLOC
parameter_list|(
name|n
parameter_list|)
value|cdf_malloc(__FILE__, __LINE__, (n))
end_define

begin_define
define|#
directive|define
name|CDF_REALLOC
parameter_list|(
name|p
parameter_list|,
name|n
parameter_list|)
value|cdf_realloc(__FILE__, __LINE__, (p), (n))
end_define

begin_define
define|#
directive|define
name|CDF_CALLOC
parameter_list|(
name|n
parameter_list|,
name|u
parameter_list|)
value|cdf_calloc(__FILE__, __LINE__, (n), (u))
end_define

begin_decl_stmt
specifier|static
name|void
modifier|*
name|cdf_malloc
argument_list|(
specifier|const
name|char
operator|*
name|file
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|size_t
name|line
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|size_t
name|n
argument_list|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"%s,%zu: %s %zu\n"
operator|,
name|file
operator|,
name|line
operator|,
name|__func__
operator|,
name|n
operator|)
argument_list|)
expr_stmt|;
return|return
name|malloc
argument_list|(
name|n
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
modifier|*
name|cdf_realloc
argument_list|(
specifier|const
name|char
operator|*
name|file
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|size_t
name|line
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|void
operator|*
name|p
argument_list|,
name|size_t
name|n
argument_list|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"%s,%zu: %s %zu\n"
operator|,
name|file
operator|,
name|line
operator|,
name|__func__
operator|,
name|n
operator|)
argument_list|)
expr_stmt|;
return|return
name|realloc
argument_list|(
name|p
argument_list|,
name|n
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
modifier|*
name|cdf_calloc
argument_list|(
specifier|const
name|char
operator|*
name|file
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|size_t
name|line
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|size_t
name|n
argument_list|,
name|size_t
name|u
argument_list|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"%s,%zu: %s %zu %zu\n"
operator|,
name|file
operator|,
name|line
operator|,
name|__func__
operator|,
name|n
operator|,
name|u
operator|)
argument_list|)
expr_stmt|;
return|return
name|calloc
argument_list|(
name|n
argument_list|,
name|u
argument_list|)
return|;
block|}
end_decl_stmt

begin_comment
comment|/*  * swap a short  */
end_comment

begin_function
specifier|static
name|uint16_t
name|_cdf_tole2
parameter_list|(
name|uint16_t
name|sv
parameter_list|)
block|{
name|uint16_t
name|rv
decl_stmt|;
name|uint8_t
modifier|*
name|s
init|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|sv
decl_stmt|;
name|uint8_t
modifier|*
name|d
init|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|rv
decl_stmt|;
name|d
index|[
literal|0
index|]
operator|=
name|s
index|[
literal|1
index|]
expr_stmt|;
name|d
index|[
literal|1
index|]
operator|=
name|s
index|[
literal|0
index|]
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_comment
comment|/*  * swap an int  */
end_comment

begin_function
specifier|static
name|uint32_t
name|_cdf_tole4
parameter_list|(
name|uint32_t
name|sv
parameter_list|)
block|{
name|uint32_t
name|rv
decl_stmt|;
name|uint8_t
modifier|*
name|s
init|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|sv
decl_stmt|;
name|uint8_t
modifier|*
name|d
init|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|rv
decl_stmt|;
name|d
index|[
literal|0
index|]
operator|=
name|s
index|[
literal|3
index|]
expr_stmt|;
name|d
index|[
literal|1
index|]
operator|=
name|s
index|[
literal|2
index|]
expr_stmt|;
name|d
index|[
literal|2
index|]
operator|=
name|s
index|[
literal|1
index|]
expr_stmt|;
name|d
index|[
literal|3
index|]
operator|=
name|s
index|[
literal|0
index|]
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_comment
comment|/*  * swap a quad  */
end_comment

begin_function
specifier|static
name|uint64_t
name|_cdf_tole8
parameter_list|(
name|uint64_t
name|sv
parameter_list|)
block|{
name|uint64_t
name|rv
decl_stmt|;
name|uint8_t
modifier|*
name|s
init|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|sv
decl_stmt|;
name|uint8_t
modifier|*
name|d
init|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|rv
decl_stmt|;
name|d
index|[
literal|0
index|]
operator|=
name|s
index|[
literal|7
index|]
expr_stmt|;
name|d
index|[
literal|1
index|]
operator|=
name|s
index|[
literal|6
index|]
expr_stmt|;
name|d
index|[
literal|2
index|]
operator|=
name|s
index|[
literal|5
index|]
expr_stmt|;
name|d
index|[
literal|3
index|]
operator|=
name|s
index|[
literal|4
index|]
expr_stmt|;
name|d
index|[
literal|4
index|]
operator|=
name|s
index|[
literal|3
index|]
expr_stmt|;
name|d
index|[
literal|5
index|]
operator|=
name|s
index|[
literal|2
index|]
expr_stmt|;
name|d
index|[
literal|6
index|]
operator|=
name|s
index|[
literal|1
index|]
expr_stmt|;
name|d
index|[
literal|7
index|]
operator|=
name|s
index|[
literal|0
index|]
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_comment
comment|/*  * grab a uint32_t from a possibly unaligned address, and return it in  * the native host order.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|cdf_getuint32
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|p
parameter_list|,
name|size_t
name|offs
parameter_list|)
block|{
name|uint32_t
name|rv
decl_stmt|;
operator|(
name|void
operator|)
name|memcpy
argument_list|(
operator|&
name|rv
argument_list|,
name|p
operator|+
name|offs
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|CDF_TOLE4
argument_list|(
name|rv
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|CDF_UNPACK
parameter_list|(
name|a
parameter_list|)
define|\
value|(void)memcpy(&(a),&buf[len], sizeof(a)), len += sizeof(a)
end_define

begin_define
define|#
directive|define
name|CDF_UNPACKA
parameter_list|(
name|a
parameter_list|)
define|\
value|(void)memcpy((a),&buf[len], sizeof(a)), len += sizeof(a)
end_define

begin_function
name|uint16_t
name|cdf_tole2
parameter_list|(
name|uint16_t
name|sv
parameter_list|)
block|{
return|return
name|CDF_TOLE2
argument_list|(
name|sv
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|cdf_tole4
parameter_list|(
name|uint32_t
name|sv
parameter_list|)
block|{
return|return
name|CDF_TOLE4
argument_list|(
name|sv
argument_list|)
return|;
block|}
end_function

begin_function
name|uint64_t
name|cdf_tole8
parameter_list|(
name|uint64_t
name|sv
parameter_list|)
block|{
return|return
name|CDF_TOLE8
argument_list|(
name|sv
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|cdf_swap_header
parameter_list|(
name|cdf_header_t
modifier|*
name|h
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|h
operator|->
name|h_magic
operator|=
name|CDF_TOLE8
argument_list|(
name|h
operator|->
name|h_magic
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_uuid
index|[
literal|0
index|]
operator|=
name|CDF_TOLE8
argument_list|(
name|h
operator|->
name|h_uuid
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_uuid
index|[
literal|1
index|]
operator|=
name|CDF_TOLE8
argument_list|(
name|h
operator|->
name|h_uuid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_revision
operator|=
name|CDF_TOLE2
argument_list|(
name|h
operator|->
name|h_revision
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_version
operator|=
name|CDF_TOLE2
argument_list|(
name|h
operator|->
name|h_version
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_byte_order
operator|=
name|CDF_TOLE2
argument_list|(
name|h
operator|->
name|h_byte_order
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_sec_size_p2
operator|=
name|CDF_TOLE2
argument_list|(
name|h
operator|->
name|h_sec_size_p2
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_short_sec_size_p2
operator|=
name|CDF_TOLE2
argument_list|(
name|h
operator|->
name|h_short_sec_size_p2
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_num_sectors_in_sat
operator|=
name|CDF_TOLE4
argument_list|(
name|h
operator|->
name|h_num_sectors_in_sat
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_secid_first_directory
operator|=
name|CDF_TOLE4
argument_list|(
name|h
operator|->
name|h_secid_first_directory
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_min_size_standard_stream
operator|=
name|CDF_TOLE4
argument_list|(
name|h
operator|->
name|h_min_size_standard_stream
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_secid_first_sector_in_short_sat
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|h
operator|->
name|h_secid_first_sector_in_short_sat
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_num_sectors_in_short_sat
operator|=
name|CDF_TOLE4
argument_list|(
name|h
operator|->
name|h_num_sectors_in_short_sat
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_secid_first_sector_in_master_sat
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|h
operator|->
name|h_secid_first_sector_in_master_sat
argument_list|)
expr_stmt|;
name|h
operator|->
name|h_num_sectors_in_master_sat
operator|=
name|CDF_TOLE4
argument_list|(
name|h
operator|->
name|h_num_sectors_in_master_sat
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|__arraycount
argument_list|(
name|h
operator|->
name|h_master_sat
argument_list|)
condition|;
name|i
operator|++
control|)
name|h
operator|->
name|h_master_sat
index|[
name|i
index|]
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|h
operator|->
name|h_master_sat
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cdf_unpack_header
parameter_list|(
name|cdf_header_t
modifier|*
name|h
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_magic
argument_list|)
expr_stmt|;
name|CDF_UNPACKA
argument_list|(
name|h
operator|->
name|h_uuid
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_revision
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_version
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_byte_order
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_sec_size_p2
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_short_sec_size_p2
argument_list|)
expr_stmt|;
name|CDF_UNPACKA
argument_list|(
name|h
operator|->
name|h_unused0
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_num_sectors_in_sat
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_secid_first_directory
argument_list|)
expr_stmt|;
name|CDF_UNPACKA
argument_list|(
name|h
operator|->
name|h_unused1
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_min_size_standard_stream
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_secid_first_sector_in_short_sat
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_num_sectors_in_short_sat
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_secid_first_sector_in_master_sat
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_num_sectors_in_master_sat
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|__arraycount
argument_list|(
name|h
operator|->
name|h_master_sat
argument_list|)
condition|;
name|i
operator|++
control|)
name|CDF_UNPACK
argument_list|(
name|h
operator|->
name|h_master_sat
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cdf_swap_dir
parameter_list|(
name|cdf_directory_t
modifier|*
name|d
parameter_list|)
block|{
name|d
operator|->
name|d_namelen
operator|=
name|CDF_TOLE2
argument_list|(
name|d
operator|->
name|d_namelen
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_left_child
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|d
operator|->
name|d_left_child
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_right_child
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|d
operator|->
name|d_right_child
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_storage
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|d
operator|->
name|d_storage
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_storage_uuid
index|[
literal|0
index|]
operator|=
name|CDF_TOLE8
argument_list|(
name|d
operator|->
name|d_storage_uuid
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_storage_uuid
index|[
literal|1
index|]
operator|=
name|CDF_TOLE8
argument_list|(
name|d
operator|->
name|d_storage_uuid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_flags
operator|=
name|CDF_TOLE4
argument_list|(
name|d
operator|->
name|d_flags
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_created
operator|=
name|CDF_TOLE8
argument_list|(
operator|(
name|uint64_t
operator|)
name|d
operator|->
name|d_created
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_modified
operator|=
name|CDF_TOLE8
argument_list|(
operator|(
name|uint64_t
operator|)
name|d
operator|->
name|d_modified
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_stream_first_sector
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|d
operator|->
name|d_stream_first_sector
argument_list|)
expr_stmt|;
name|d
operator|->
name|d_size
operator|=
name|CDF_TOLE4
argument_list|(
name|d
operator|->
name|d_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cdf_swap_class
parameter_list|(
name|cdf_classid_t
modifier|*
name|d
parameter_list|)
block|{
name|d
operator|->
name|cl_dword
operator|=
name|CDF_TOLE4
argument_list|(
name|d
operator|->
name|cl_dword
argument_list|)
expr_stmt|;
name|d
operator|->
name|cl_word
index|[
literal|0
index|]
operator|=
name|CDF_TOLE2
argument_list|(
name|d
operator|->
name|cl_word
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|d
operator|->
name|cl_word
index|[
literal|1
index|]
operator|=
name|CDF_TOLE2
argument_list|(
name|d
operator|->
name|cl_word
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cdf_unpack_dir
parameter_list|(
name|cdf_directory_t
modifier|*
name|d
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|CDF_UNPACKA
argument_list|(
name|d
operator|->
name|d_name
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_namelen
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_type
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_color
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_left_child
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_right_child
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_storage
argument_list|)
expr_stmt|;
name|CDF_UNPACKA
argument_list|(
name|d
operator|->
name|d_storage_uuid
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_flags
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_created
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_modified
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_stream_first_sector
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_size
argument_list|)
expr_stmt|;
name|CDF_UNPACK
argument_list|(
name|d
operator|->
name|d_unused0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|cdf_zero_stream
parameter_list|(
name|cdf_stream_t
modifier|*
name|scn
parameter_list|)
block|{
name|scn
operator|->
name|sst_len
operator|=
literal|0
expr_stmt|;
name|scn
operator|->
name|sst_dirlen
operator|=
literal|0
expr_stmt|;
name|scn
operator|->
name|sst_ss
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|scn
operator|->
name|sst_tab
argument_list|)
expr_stmt|;
name|scn
operator|->
name|sst_tab
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|cdf_check_stream
parameter_list|(
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|)
block|{
name|size_t
name|ss
init|=
name|sst
operator|->
name|sst_dirlen
operator|<
name|h
operator|->
name|h_min_size_standard_stream
condition|?
name|CDF_SHORT_SEC_SIZE
argument_list|(
name|h
argument_list|)
else|:
name|CDF_SEC_SIZE
argument_list|(
name|h
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|ss
operator|==
name|sst
operator|->
name|sst_ss
argument_list|)
expr_stmt|;
return|return
name|sst
operator|->
name|sst_ss
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cdf_check_stream_offset
parameter_list|(
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|void
modifier|*
name|p
parameter_list|,
name|size_t
name|tail
parameter_list|,
name|int
name|line
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|b
init|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|sst
operator|->
name|sst_tab
decl_stmt|;
specifier|const
name|char
modifier|*
name|e
init|=
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|p
operator|)
operator|+
name|tail
decl_stmt|;
name|size_t
name|ss
init|=
name|cdf_check_stream
argument_list|(
name|sst
argument_list|,
name|h
argument_list|)
decl_stmt|;
comment|/*LINTED*/
operator|(
name|void
operator|)
operator|&
name|line
expr_stmt|;
if|if
condition|(
name|e
operator|>=
name|b
operator|&&
call|(
name|size_t
call|)
argument_list|(
name|e
operator|-
name|b
argument_list|)
operator|<=
name|ss
operator|*
name|sst
operator|->
name|sst_len
condition|)
return|return
literal|0
return|;
name|DPRINTF
argument_list|(
operator|(
literal|"%d: offset begin %p< end %p || %"
name|SIZE_T_FORMAT
literal|"u"
literal|"> %"
name|SIZE_T_FORMAT
literal|"u [%"
name|SIZE_T_FORMAT
literal|"u %"
name|SIZE_T_FORMAT
literal|"u]\n"
operator|,
name|line
operator|,
name|b
operator|,
name|e
operator|,
call|(
name|size_t
call|)
argument_list|(
name|e
operator|-
name|b
argument_list|)
operator|,
name|ss
operator|*
name|sst
operator|->
name|sst_len
operator|,
name|ss
operator|,
name|sst
operator|->
name|sst_len
operator|)
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EFTYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|cdf_read
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
name|off_t
name|off
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|siz
init|=
operator|(
name|size_t
operator|)
name|off
operator|+
name|len
decl_stmt|;
if|if
condition|(
call|(
name|off_t
call|)
argument_list|(
name|off
operator|+
name|len
argument_list|)
operator|!=
operator|(
name|off_t
operator|)
name|siz
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|info
operator|->
name|i_buf
operator|!=
name|NULL
operator|&&
name|info
operator|->
name|i_len
operator|>=
name|siz
condition|)
block|{
operator|(
name|void
operator|)
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|info
operator|->
name|i_buf
index|[
name|off
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|ssize_t
operator|)
name|len
return|;
block|}
if|if
condition|(
name|info
operator|->
name|i_fd
operator|==
operator|-
literal|1
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|pread
argument_list|(
name|info
operator|->
name|i_fd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|off
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
name|len
condition|)
return|return
operator|-
literal|1
return|;
return|return
operator|(
name|ssize_t
operator|)
name|len
return|;
name|out
label|:
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_header
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
name|cdf_header_t
modifier|*
name|h
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|memcpy
argument_list|(
name|cdf_bo
operator|.
name|s
argument_list|,
literal|"\01\02\03\04"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdf_read
argument_list|(
name|info
argument_list|,
operator|(
name|off_t
operator|)
literal|0
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|cdf_unpack_header
argument_list|(
name|h
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|cdf_swap_header
argument_list|(
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|->
name|h_magic
operator|!=
name|CDF_MAGIC
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Bad magic %#"
name|INT64_T_FORMAT
literal|"x != %#"
name|INT64_T_FORMAT
literal|"x\n"
operator|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|h
operator|->
name|h_magic
operator|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|CDF_MAGIC
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|h
operator|->
name|h_sec_size_p2
operator|>
literal|20
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Bad sector size %hu\n"
operator|,
name|h
operator|->
name|h_sec_size_p2
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|h
operator|->
name|h_short_sec_size_p2
operator|>
literal|20
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Bad short sector size %hu\n"
operator|,
name|h
operator|->
name|h_short_sec_size_p2
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
return|return
literal|0
return|;
name|out
label|:
name|errno
operator|=
name|EFTYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|ssize_t
name|cdf_read_sector
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|offs
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
name|cdf_secid_t
name|id
parameter_list|)
block|{
name|size_t
name|ss
init|=
name|CDF_SEC_SIZE
argument_list|(
name|h
argument_list|)
decl_stmt|;
name|size_t
name|pos
init|=
name|CDF_SEC_POS
argument_list|(
name|h
argument_list|,
name|id
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|ss
operator|==
name|len
argument_list|)
expr_stmt|;
return|return
name|cdf_read
argument_list|(
name|info
argument_list|,
operator|(
name|off_t
operator|)
name|pos
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|buf
operator|)
operator|+
name|offs
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
name|ssize_t
name|cdf_read_short_sector
parameter_list|(
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|offs
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
name|cdf_secid_t
name|id
parameter_list|)
block|{
name|size_t
name|ss
init|=
name|CDF_SHORT_SEC_SIZE
argument_list|(
name|h
argument_list|)
decl_stmt|;
name|size_t
name|pos
init|=
name|CDF_SHORT_SEC_POS
argument_list|(
name|h
argument_list|,
name|id
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|ss
operator|==
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|CDF_SEC_SIZE
argument_list|(
name|h
argument_list|)
operator|*
name|sst
operator|->
name|sst_len
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Out of bounds read %"
name|SIZE_T_FORMAT
literal|"u> %"
name|SIZE_T_FORMAT
literal|"u\n"
operator|,
name|pos
operator|+
name|len
operator|,
name|CDF_SEC_SIZE
argument_list|(
name|h
argument_list|)
operator|*
name|sst
operator|->
name|sst_len
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|(
name|void
operator|)
name|memcpy
argument_list|(
operator|(
operator|(
name|char
operator|*
operator|)
name|buf
operator|)
operator|+
name|offs
argument_list|,
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|sst
operator|->
name|sst_tab
operator|)
operator|+
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|len
return|;
name|out
label|:
name|errno
operator|=
name|EFTYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Read the sector allocation table.  */
end_comment

begin_function
name|int
name|cdf_read_sat
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
name|cdf_header_t
modifier|*
name|h
parameter_list|,
name|cdf_sat_t
modifier|*
name|sat
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|size_t
name|ss
init|=
name|CDF_SEC_SIZE
argument_list|(
name|h
argument_list|)
decl_stmt|;
name|cdf_secid_t
modifier|*
name|msa
decl_stmt|,
name|mid
decl_stmt|,
name|sec
decl_stmt|;
name|size_t
name|nsatpersec
init|=
operator|(
name|ss
operator|/
sizeof|sizeof
argument_list|(
name|mid
argument_list|)
operator|)
operator|-
literal|1
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|__arraycount
argument_list|(
name|h
operator|->
name|h_master_sat
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|h
operator|->
name|h_master_sat
index|[
name|i
index|]
operator|==
name|CDF_SECID_FREE
condition|)
break|break;
define|#
directive|define
name|CDF_SEC_LIMIT
value|(UINT32_MAX / (8 * ss))
if|if
condition|(
operator|(
name|nsatpersec
operator|>
literal|0
operator|&&
name|h
operator|->
name|h_num_sectors_in_master_sat
operator|>
name|CDF_SEC_LIMIT
operator|/
name|nsatpersec
operator|)
operator|||
name|i
operator|>
name|CDF_SEC_LIMIT
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Number of sectors in master SAT too big %u %"
name|SIZE_T_FORMAT
literal|"u\n"
operator|,
name|h
operator|->
name|h_num_sectors_in_master_sat
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EFTYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sat
operator|->
name|sat_len
operator|=
name|h
operator|->
name|h_num_sectors_in_master_sat
operator|*
name|nsatpersec
operator|+
name|i
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"sat_len = %"
name|SIZE_T_FORMAT
literal|"u ss = %"
name|SIZE_T_FORMAT
literal|"u\n"
operator|,
name|sat
operator|->
name|sat_len
operator|,
name|ss
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sat
operator|->
name|sat_tab
operator|=
name|CAST
argument_list|(
name|cdf_secid_t
operator|*
argument_list|,
name|CDF_CALLOC
argument_list|(
name|sat
operator|->
name|sat_len
argument_list|,
name|ss
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|__arraycount
argument_list|(
name|h
operator|->
name|h_master_sat
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|h
operator|->
name|h_master_sat
index|[
name|i
index|]
operator|<
literal|0
condition|)
break|break;
if|if
condition|(
name|cdf_read_sector
argument_list|(
name|info
argument_list|,
name|sat
operator|->
name|sat_tab
argument_list|,
name|ss
operator|*
name|i
argument_list|,
name|ss
argument_list|,
name|h
argument_list|,
name|h
operator|->
name|h_master_sat
index|[
name|i
index|]
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
name|ss
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Reading sector %d"
operator|,
name|h
operator|->
name|h_master_sat
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|msa
operator|=
name|CAST
argument_list|(
name|cdf_secid_t
operator|*
argument_list|,
name|CDF_CALLOC
argument_list|(
literal|1
argument_list|,
name|ss
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|out1
goto|;
name|mid
operator|=
name|h
operator|->
name|h_secid_first_sector_in_master_sat
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|h
operator|->
name|h_num_sectors_in_master_sat
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|mid
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|j
operator|>=
name|CDF_LOOP_LIMIT
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Reading master sector loop limit"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
if|if
condition|(
name|cdf_read_sector
argument_list|(
name|info
argument_list|,
name|msa
argument_list|,
literal|0
argument_list|,
name|ss
argument_list|,
name|h
argument_list|,
name|mid
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
name|ss
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Reading master sector %d"
operator|,
name|mid
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|nsatpersec
condition|;
name|k
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|sec
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|msa
index|[
name|k
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sec
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|i
operator|>=
name|sat
operator|->
name|sat_len
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Out of bounds reading MSA %"
name|SIZE_T_FORMAT
literal|"u>= %"
name|SIZE_T_FORMAT
literal|"u"
operator|,
name|i
operator|,
name|sat
operator|->
name|sat_len
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
if|if
condition|(
name|cdf_read_sector
argument_list|(
name|info
argument_list|,
name|sat
operator|->
name|sat_tab
argument_list|,
name|ss
operator|*
name|i
argument_list|,
name|ss
argument_list|,
name|h
argument_list|,
name|sec
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
name|ss
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Reading sector %d"
operator|,
name|CDF_TOLE4
argument_list|(
name|msa
index|[
name|k
index|]
argument_list|)
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
block|}
name|mid
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|msa
index|[
name|nsatpersec
index|]
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|sat
operator|->
name|sat_len
operator|=
name|i
expr_stmt|;
name|free
argument_list|(
name|msa
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out3
label|:
name|errno
operator|=
name|EFTYPE
expr_stmt|;
name|out2
label|:
name|free
argument_list|(
name|msa
argument_list|)
expr_stmt|;
name|out1
label|:
name|free
argument_list|(
name|sat
operator|->
name|sat_tab
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|size_t
name|cdf_count_chain
parameter_list|(
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
name|cdf_secid_t
name|sid
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|cdf_secid_t
name|maxsector
init|=
call|(
name|cdf_secid_t
call|)
argument_list|(
operator|(
name|sat
operator|->
name|sat_len
operator|*
name|size
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|maxsector
argument_list|)
argument_list|)
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"Chain:"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sid
operator|==
name|CDF_SECID_END_OF_CHAIN
condition|)
block|{
comment|/* 0-length chain. */
name|DPRINTF
argument_list|(
operator|(
literal|" empty\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|j
operator|=
name|i
operator|=
literal|0
init|;
name|sid
operator|>=
literal|0
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|" %d"
operator|,
name|sid
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|>=
name|CDF_LOOP_LIMIT
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Counting chain loop limit"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|sid
operator|>=
name|maxsector
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Sector %d>= %d\n"
operator|,
name|sid
operator|,
name|maxsector
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|sid
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|sat
operator|->
name|sat_tab
index|[
name|sid
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|" none, sid: %d\n"
operator|,
name|sid
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|i
return|;
name|out
label|:
name|errno
operator|=
name|EFTYPE
expr_stmt|;
return|return
operator|(
name|size_t
operator|)
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_long_sector_chain
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
name|cdf_secid_t
name|sid
parameter_list|,
name|size_t
name|len
parameter_list|,
name|cdf_stream_t
modifier|*
name|scn
parameter_list|)
block|{
name|size_t
name|ss
init|=
name|CDF_SEC_SIZE
argument_list|(
name|h
argument_list|)
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ssize_t
name|nr
decl_stmt|;
name|scn
operator|->
name|sst_tab
operator|=
name|NULL
expr_stmt|;
name|scn
operator|->
name|sst_len
operator|=
name|cdf_count_chain
argument_list|(
name|sat
argument_list|,
name|sid
argument_list|,
name|ss
argument_list|)
expr_stmt|;
name|scn
operator|->
name|sst_dirlen
operator|=
name|MAX
argument_list|(
name|h
operator|->
name|h_min_size_standard_stream
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|scn
operator|->
name|sst_ss
operator|=
name|ss
expr_stmt|;
if|if
condition|(
name|sid
operator|==
name|CDF_SECID_END_OF_CHAIN
operator|||
name|len
operator|==
literal|0
condition|)
return|return
name|cdf_zero_stream
argument_list|(
name|scn
argument_list|)
return|;
if|if
condition|(
name|scn
operator|->
name|sst_len
operator|==
operator|(
name|size_t
operator|)
operator|-
literal|1
condition|)
goto|goto
name|out
goto|;
name|scn
operator|->
name|sst_tab
operator|=
name|CDF_CALLOC
argument_list|(
name|scn
operator|->
name|sst_len
argument_list|,
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|scn
operator|->
name|sst_tab
operator|==
name|NULL
condition|)
return|return
name|cdf_zero_stream
argument_list|(
name|scn
argument_list|)
return|;
for|for
control|(
name|j
operator|=
name|i
operator|=
literal|0
init|;
name|sid
operator|>=
literal|0
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|>=
name|CDF_LOOP_LIMIT
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Read long sector chain loop limit"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|i
operator|>=
name|scn
operator|->
name|sst_len
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Out of bounds reading long sector chain "
literal|"%"
name|SIZE_T_FORMAT
literal|"u> %"
name|SIZE_T_FORMAT
literal|"u\n"
operator|,
name|i
operator|,
name|scn
operator|->
name|sst_len
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|nr
operator|=
name|cdf_read_sector
argument_list|(
name|info
argument_list|,
name|scn
operator|->
name|sst_tab
argument_list|,
name|i
operator|*
name|ss
argument_list|,
name|ss
argument_list|,
name|h
argument_list|,
name|sid
argument_list|)
operator|)
operator|!=
operator|(
name|ssize_t
operator|)
name|ss
condition|)
block|{
if|if
condition|(
name|i
operator|==
name|scn
operator|->
name|sst_len
operator|-
literal|1
operator|&&
name|nr
operator|>
literal|0
condition|)
block|{
comment|/* Last sector might be truncated */
return|return
literal|0
return|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"Reading long sector chain %d"
operator|,
name|sid
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|sid
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|sat
operator|->
name|sat_tab
index|[
name|sid
index|]
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
name|out
label|:
name|errno
operator|=
name|EFTYPE
expr_stmt|;
return|return
name|cdf_zero_stream
argument_list|(
name|scn
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_short_sector_chain
parameter_list|(
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|ssat
parameter_list|,
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
name|cdf_secid_t
name|sid
parameter_list|,
name|size_t
name|len
parameter_list|,
name|cdf_stream_t
modifier|*
name|scn
parameter_list|)
block|{
name|size_t
name|ss
init|=
name|CDF_SHORT_SEC_SIZE
argument_list|(
name|h
argument_list|)
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|scn
operator|->
name|sst_tab
operator|=
name|NULL
expr_stmt|;
name|scn
operator|->
name|sst_len
operator|=
name|cdf_count_chain
argument_list|(
name|ssat
argument_list|,
name|sid
argument_list|,
name|CDF_SEC_SIZE
argument_list|(
name|h
argument_list|)
argument_list|)
expr_stmt|;
name|scn
operator|->
name|sst_dirlen
operator|=
name|len
expr_stmt|;
name|scn
operator|->
name|sst_ss
operator|=
name|ss
expr_stmt|;
if|if
condition|(
name|scn
operator|->
name|sst_len
operator|==
operator|(
name|size_t
operator|)
operator|-
literal|1
condition|)
goto|goto
name|out
goto|;
name|scn
operator|->
name|sst_tab
operator|=
name|CDF_CALLOC
argument_list|(
name|scn
operator|->
name|sst_len
argument_list|,
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|scn
operator|->
name|sst_tab
operator|==
name|NULL
condition|)
return|return
name|cdf_zero_stream
argument_list|(
name|scn
argument_list|)
return|;
for|for
control|(
name|j
operator|=
name|i
operator|=
literal|0
init|;
name|sid
operator|>=
literal|0
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|>=
name|CDF_LOOP_LIMIT
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Read short sector chain loop limit"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|i
operator|>=
name|scn
operator|->
name|sst_len
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Out of bounds reading short sector chain "
literal|"%"
name|SIZE_T_FORMAT
literal|"u> %"
name|SIZE_T_FORMAT
literal|"u\n"
operator|,
name|i
operator|,
name|scn
operator|->
name|sst_len
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|cdf_read_short_sector
argument_list|(
name|sst
argument_list|,
name|scn
operator|->
name|sst_tab
argument_list|,
name|i
operator|*
name|ss
argument_list|,
name|ss
argument_list|,
name|h
argument_list|,
name|sid
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
name|ss
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Reading short sector chain %d"
operator|,
name|sid
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|sid
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|ssat
operator|->
name|sat_tab
index|[
name|sid
index|]
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
name|out
label|:
name|errno
operator|=
name|EFTYPE
expr_stmt|;
return|return
name|cdf_zero_stream
argument_list|(
name|scn
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_sector_chain
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|ssat
parameter_list|,
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
name|cdf_secid_t
name|sid
parameter_list|,
name|size_t
name|len
parameter_list|,
name|cdf_stream_t
modifier|*
name|scn
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
name|h
operator|->
name|h_min_size_standard_stream
operator|&&
name|sst
operator|->
name|sst_tab
operator|!=
name|NULL
condition|)
return|return
name|cdf_read_short_sector_chain
argument_list|(
name|h
argument_list|,
name|ssat
argument_list|,
name|sst
argument_list|,
name|sid
argument_list|,
name|len
argument_list|,
name|scn
argument_list|)
return|;
else|else
return|return
name|cdf_read_long_sector_chain
argument_list|(
name|info
argument_list|,
name|h
argument_list|,
name|sat
argument_list|,
name|sid
argument_list|,
name|len
argument_list|,
name|scn
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_dir
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
name|cdf_dir_t
modifier|*
name|dir
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|size_t
name|ss
init|=
name|CDF_SEC_SIZE
argument_list|(
name|h
argument_list|)
decl_stmt|,
name|ns
decl_stmt|,
name|nd
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|cdf_secid_t
name|sid
init|=
name|h
operator|->
name|h_secid_first_directory
decl_stmt|;
name|ns
operator|=
name|cdf_count_chain
argument_list|(
name|sat
argument_list|,
name|sid
argument_list|,
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|ns
operator|==
operator|(
name|size_t
operator|)
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|nd
operator|=
name|ss
operator|/
name|CDF_DIRECTORY_SIZE
expr_stmt|;
name|dir
operator|->
name|dir_len
operator|=
name|ns
operator|*
name|nd
expr_stmt|;
name|dir
operator|->
name|dir_tab
operator|=
name|CAST
argument_list|(
name|cdf_directory_t
operator|*
argument_list|,
name|CDF_CALLOC
argument_list|(
name|dir
operator|->
name|dir_len
argument_list|,
sizeof|sizeof
argument_list|(
name|dir
operator|->
name|dir_tab
index|[
literal|0
index|]
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|->
name|dir_tab
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|(
name|buf
operator|=
name|CAST
argument_list|(
name|char
operator|*
argument_list|,
name|CDF_MALLOC
argument_list|(
name|ss
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|dir
operator|->
name|dir_tab
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|j
operator|=
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ns
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|>=
name|CDF_LOOP_LIMIT
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Read dir loop limit"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|cdf_read_sector
argument_list|(
name|info
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|ss
argument_list|,
name|h
argument_list|,
name|sid
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
name|ss
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Reading directory sector %d"
operator|,
name|sid
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nd
condition|;
name|j
operator|++
control|)
block|{
name|cdf_unpack_dir
argument_list|(
operator|&
name|dir
operator|->
name|dir_tab
index|[
name|i
operator|*
name|nd
operator|+
name|j
index|]
argument_list|,
operator|&
name|buf
index|[
name|j
operator|*
name|CDF_DIRECTORY_SIZE
index|]
argument_list|)
expr_stmt|;
block|}
name|sid
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|sat
operator|->
name|sat_tab
index|[
name|sid
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|NEED_SWAP
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dir
operator|->
name|dir_len
condition|;
name|i
operator|++
control|)
name|cdf_swap_dir
argument_list|(
operator|&
name|dir
operator|->
name|dir_tab
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|free
argument_list|(
name|dir
operator|->
name|dir_tab
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EFTYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_ssat
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
name|cdf_sat_t
modifier|*
name|ssat
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|size_t
name|ss
init|=
name|CDF_SEC_SIZE
argument_list|(
name|h
argument_list|)
decl_stmt|;
name|cdf_secid_t
name|sid
init|=
name|h
operator|->
name|h_secid_first_sector_in_short_sat
decl_stmt|;
name|ssat
operator|->
name|sat_tab
operator|=
name|NULL
expr_stmt|;
name|ssat
operator|->
name|sat_len
operator|=
name|cdf_count_chain
argument_list|(
name|sat
argument_list|,
name|sid
argument_list|,
name|ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssat
operator|->
name|sat_len
operator|==
operator|(
name|size_t
operator|)
operator|-
literal|1
condition|)
goto|goto
name|out
goto|;
name|ssat
operator|->
name|sat_tab
operator|=
name|CAST
argument_list|(
name|cdf_secid_t
operator|*
argument_list|,
name|CDF_CALLOC
argument_list|(
name|ssat
operator|->
name|sat_len
argument_list|,
name|ss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssat
operator|->
name|sat_tab
operator|==
name|NULL
condition|)
goto|goto
name|out1
goto|;
for|for
control|(
name|j
operator|=
name|i
operator|=
literal|0
init|;
name|sid
operator|>=
literal|0
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|>=
name|CDF_LOOP_LIMIT
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Read short sat sector loop limit"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|i
operator|>=
name|ssat
operator|->
name|sat_len
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Out of bounds reading short sector chain "
literal|"%"
name|SIZE_T_FORMAT
literal|"u> %"
name|SIZE_T_FORMAT
literal|"u\n"
operator|,
name|i
operator|,
name|ssat
operator|->
name|sat_len
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|cdf_read_sector
argument_list|(
name|info
argument_list|,
name|ssat
operator|->
name|sat_tab
argument_list|,
name|i
operator|*
name|ss
argument_list|,
name|ss
argument_list|,
name|h
argument_list|,
name|sid
argument_list|)
operator|!=
operator|(
name|ssize_t
operator|)
name|ss
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Reading short sat sector %d"
operator|,
name|sid
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
name|sid
operator|=
name|CDF_TOLE4
argument_list|(
operator|(
name|uint32_t
operator|)
name|sat
operator|->
name|sat_tab
index|[
name|sid
index|]
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
name|out
label|:
name|errno
operator|=
name|EFTYPE
expr_stmt|;
name|out1
label|:
name|free
argument_list|(
name|ssat
operator|->
name|sat_tab
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_short_stream
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
specifier|const
name|cdf_dir_t
modifier|*
name|dir
parameter_list|,
name|cdf_stream_t
modifier|*
name|scn
parameter_list|,
specifier|const
name|cdf_directory_t
modifier|*
modifier|*
name|root
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
specifier|const
name|cdf_directory_t
modifier|*
name|d
decl_stmt|;
operator|*
name|root
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dir
operator|->
name|dir_len
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|dir
operator|->
name|dir_tab
index|[
name|i
index|]
operator|.
name|d_type
operator|==
name|CDF_DIR_TYPE_ROOT_STORAGE
condition|)
break|break;
comment|/* If the it is not there, just fake it; some docs don't have it */
if|if
condition|(
name|i
operator|==
name|dir
operator|->
name|dir_len
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Cannot find root storage dir\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|d
operator|=
operator|&
name|dir
operator|->
name|dir_tab
index|[
name|i
index|]
expr_stmt|;
operator|*
name|root
operator|=
name|d
expr_stmt|;
comment|/* If the it is not there, just fake it; some docs don't have it */
if|if
condition|(
name|d
operator|->
name|d_stream_first_sector
operator|<
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"No first secror in dir\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
return|return
name|cdf_read_long_sector_chain
argument_list|(
name|info
argument_list|,
name|h
argument_list|,
name|sat
argument_list|,
name|d
operator|->
name|d_stream_first_sector
argument_list|,
name|d
operator|->
name|d_size
argument_list|,
name|scn
argument_list|)
return|;
name|out
label|:
name|scn
operator|->
name|sst_tab
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|cdf_zero_stream
argument_list|(
name|scn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cdf_namecmp
parameter_list|(
specifier|const
name|char
modifier|*
name|d
parameter_list|,
specifier|const
name|uint16_t
modifier|*
name|s
parameter_list|,
name|size_t
name|l
parameter_list|)
block|{
for|for
control|(
init|;
name|l
operator|--
condition|;
name|d
operator|++
operator|,
name|s
operator|++
control|)
if|if
condition|(
operator|*
name|d
operator|!=
name|CDF_TOLE2
argument_list|(
operator|*
name|s
argument_list|)
condition|)
return|return
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d
operator|-
name|CDF_TOLE2
argument_list|(
operator|*
name|s
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_doc_summary_info
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|ssat
parameter_list|,
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
specifier|const
name|cdf_dir_t
modifier|*
name|dir
parameter_list|,
name|cdf_stream_t
modifier|*
name|scn
parameter_list|)
block|{
return|return
name|cdf_read_user_stream
argument_list|(
name|info
argument_list|,
name|h
argument_list|,
name|sat
argument_list|,
name|ssat
argument_list|,
name|sst
argument_list|,
name|dir
argument_list|,
literal|"\05DocumentSummaryInformation"
argument_list|,
name|scn
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_summary_info
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|ssat
parameter_list|,
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
specifier|const
name|cdf_dir_t
modifier|*
name|dir
parameter_list|,
name|cdf_stream_t
modifier|*
name|scn
parameter_list|)
block|{
return|return
name|cdf_read_user_stream
argument_list|(
name|info
argument_list|,
name|h
argument_list|,
name|sat
argument_list|,
name|ssat
argument_list|,
name|sst
argument_list|,
name|dir
argument_list|,
literal|"\05SummaryInformation"
argument_list|,
name|scn
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_user_stream
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|ssat
parameter_list|,
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
specifier|const
name|cdf_dir_t
modifier|*
name|dir
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|cdf_stream_t
modifier|*
name|scn
parameter_list|)
block|{
specifier|const
name|cdf_directory_t
modifier|*
name|d
decl_stmt|;
name|int
name|i
init|=
name|cdf_find_stream
argument_list|(
name|dir
argument_list|,
name|name
argument_list|,
name|CDF_DIR_TYPE_USER_STREAM
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
name|memset
argument_list|(
name|scn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|scn
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|d
operator|=
operator|&
name|dir
operator|->
name|dir_tab
index|[
name|i
operator|-
literal|1
index|]
expr_stmt|;
return|return
name|cdf_read_sector_chain
argument_list|(
name|info
argument_list|,
name|h
argument_list|,
name|sat
argument_list|,
name|ssat
argument_list|,
name|sst
argument_list|,
name|d
operator|->
name|d_stream_first_sector
argument_list|,
name|d
operator|->
name|d_size
argument_list|,
name|scn
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cdf_find_stream
parameter_list|(
specifier|const
name|cdf_dir_t
modifier|*
name|dir
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|name_len
init|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
decl_stmt|;
for|for
control|(
name|i
operator|=
name|dir
operator|->
name|dir_len
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
if|if
condition|(
name|dir
operator|->
name|dir_tab
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|d_type
operator|==
name|type
operator|&&
name|cdf_namecmp
argument_list|(
name|name
argument_list|,
name|dir
operator|->
name|dir_tab
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|d_name
argument_list|,
name|name_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
return|return
name|CAST
argument_list|(
name|int
argument_list|,
name|i
argument_list|)
return|;
name|DPRINTF
argument_list|(
operator|(
literal|"Cannot find type %d `%s'\n"
operator|,
name|type
operator|,
name|name
operator|)
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ESRCH
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|CDF_SHLEN_LIMIT
value|(UINT32_MAX / 8)
end_define

begin_define
define|#
directive|define
name|CDF_PROP_LIMIT
value|(UINT32_MAX / (8 * sizeof(cdf_property_info_t)))
end_define

begin_function
specifier|static
specifier|const
name|void
modifier|*
name|cdf_offset
parameter_list|(
specifier|const
name|void
modifier|*
name|p
parameter_list|,
name|size_t
name|l
parameter_list|)
block|{
return|return
name|CAST
argument_list|(
specifier|const
name|void
operator|*
argument_list|,
name|CAST
argument_list|(
specifier|const
name|uint8_t
operator|*
argument_list|,
name|p
argument_list|)
operator|+
name|l
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|uint8_t
modifier|*
name|cdf_get_property_info_pos
parameter_list|(
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|p
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|e
parameter_list|,
name|size_t
name|i
parameter_list|)
block|{
name|size_t
name|tail
init|=
operator|(
name|i
operator|<<
literal|1
operator|)
operator|+
literal|1
decl_stmt|;
name|size_t
name|ofs
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|q
decl_stmt|;
if|if
condition|(
name|p
operator|>=
name|e
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Past end %p< %p\n"
operator|,
name|e
operator|,
name|p
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|cdf_check_stream_offset
argument_list|(
name|sst
argument_list|,
name|h
argument_list|,
name|p
argument_list|,
operator|(
name|tail
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|__LINE__
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|NULL
return|;
name|ofs
operator|=
name|CDF_GETUINT32
argument_list|(
name|p
argument_list|,
name|tail
argument_list|)
expr_stmt|;
name|q
operator|=
name|CAST
argument_list|(
specifier|const
name|uint8_t
operator|*
argument_list|,
name|cdf_offset
argument_list|(
name|CAST
argument_list|(
specifier|const
name|void
operator|*
argument_list|,
name|p
argument_list|)
argument_list|,
name|ofs
operator|-
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|<
name|p
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Wrapped around %p< %p\n"
operator|,
name|q
operator|,
name|p
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|q
operator|>=
name|e
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"Ran off the end %p>= %p\n"
operator|,
name|q
operator|,
name|e
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|q
return|;
block|}
end_function

begin_function
specifier|static
name|cdf_property_info_t
modifier|*
name|cdf_grow_info
parameter_list|(
name|cdf_property_info_t
modifier|*
modifier|*
name|info
parameter_list|,
name|size_t
modifier|*
name|maxcount
parameter_list|,
name|size_t
name|incr
parameter_list|)
block|{
name|cdf_property_info_t
modifier|*
name|inp
decl_stmt|;
name|size_t
name|newcount
init|=
operator|*
name|maxcount
operator|+
name|incr
decl_stmt|;
if|if
condition|(
name|newcount
operator|>
name|CDF_PROP_LIMIT
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"exceeded property limit %zu> %zu\n"
operator|,
name|newcount
operator|,
name|CDF_PROP_LIMIT
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|inp
operator|=
name|CAST
argument_list|(
name|cdf_property_info_t
operator|*
argument_list|,
name|CDF_REALLOC
argument_list|(
operator|*
name|info
argument_list|,
name|newcount
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|inp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
operator|*
name|info
operator|=
name|inp
expr_stmt|;
operator|*
name|maxcount
operator|=
name|newcount
expr_stmt|;
return|return
name|inp
return|;
name|out
label|:
name|free
argument_list|(
operator|*
name|info
argument_list|)
expr_stmt|;
operator|*
name|maxcount
operator|=
literal|0
expr_stmt|;
operator|*
name|info
operator|=
name|NULL
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cdf_copy_info
parameter_list|(
name|cdf_property_info_t
modifier|*
name|inp
parameter_list|,
specifier|const
name|void
modifier|*
name|p
parameter_list|,
specifier|const
name|void
modifier|*
name|e
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|inp
operator|->
name|pi_type
operator|&
name|CDF_VECTOR
condition|)
return|return
literal|0
return|;
if|if
condition|(
call|(
name|size_t
call|)
argument_list|(
name|CAST
argument_list|(
specifier|const
name|char
operator|*
argument_list|,
name|e
argument_list|)
operator|-
name|CAST
argument_list|(
specifier|const
name|char
operator|*
argument_list|,
name|p
argument_list|)
argument_list|)
operator|<
name|len
condition|)
return|return
literal|0
return|;
operator|(
name|void
operator|)
name|memcpy
argument_list|(
operator|&
name|inp
operator|->
name|pi_val
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|len
condition|)
block|{
case|case
literal|2
case|:
name|inp
operator|->
name|pi_u16
operator|=
name|CDF_TOLE2
argument_list|(
name|inp
operator|->
name|pi_u16
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|inp
operator|->
name|pi_u32
operator|=
name|CDF_TOLE4
argument_list|(
name|inp
operator|->
name|pi_u32
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|inp
operator|->
name|pi_u64
operator|=
name|CDF_TOLE8
argument_list|(
name|inp
operator|->
name|pi_u64
argument_list|)
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cdf_read_property_info
parameter_list|(
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
name|uint32_t
name|offs
parameter_list|,
name|cdf_property_info_t
modifier|*
modifier|*
name|info
parameter_list|,
name|size_t
modifier|*
name|count
parameter_list|,
name|size_t
modifier|*
name|maxcount
parameter_list|)
block|{
specifier|const
name|cdf_section_header_t
modifier|*
name|shp
decl_stmt|;
name|cdf_section_header_t
name|sh
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|,
modifier|*
name|e
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|o4
decl_stmt|,
name|nelements
decl_stmt|,
name|j
decl_stmt|,
name|slen
decl_stmt|,
name|left
decl_stmt|;
name|cdf_property_info_t
modifier|*
name|inp
decl_stmt|;
if|if
condition|(
name|offs
operator|>
name|UINT32_MAX
operator|/
literal|4
condition|)
block|{
name|errno
operator|=
name|EFTYPE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|shp
operator|=
name|CAST
argument_list|(
specifier|const
name|cdf_section_header_t
operator|*
argument_list|,
name|cdf_offset
argument_list|(
name|sst
operator|->
name|sst_tab
argument_list|,
name|offs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdf_check_stream_offset
argument_list|(
name|sst
argument_list|,
name|h
argument_list|,
name|shp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|shp
argument_list|)
argument_list|,
name|__LINE__
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|out
goto|;
name|sh
operator|.
name|sh_len
operator|=
name|CDF_TOLE4
argument_list|(
name|shp
operator|->
name|sh_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sh
operator|.
name|sh_len
operator|>
name|CDF_SHLEN_LIMIT
condition|)
block|{
name|errno
operator|=
name|EFTYPE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|cdf_check_stream_offset
argument_list|(
name|sst
argument_list|,
name|h
argument_list|,
name|shp
argument_list|,
name|sh
operator|.
name|sh_len
argument_list|,
name|__LINE__
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|out
goto|;
name|sh
operator|.
name|sh_properties
operator|=
name|CDF_TOLE4
argument_list|(
name|shp
operator|->
name|sh_properties
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"section len: %u properties %u\n"
operator|,
name|sh
operator|.
name|sh_len
operator|,
name|sh
operator|.
name|sh_properties
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sh
operator|.
name|sh_properties
operator|>
name|CDF_PROP_LIMIT
condition|)
goto|goto
name|out
goto|;
name|inp
operator|=
name|cdf_grow_info
argument_list|(
name|info
argument_list|,
name|maxcount
argument_list|,
name|sh
operator|.
name|sh_properties
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|inp
operator|+=
operator|*
name|count
expr_stmt|;
operator|*
name|count
operator|+=
name|sh
operator|.
name|sh_properties
expr_stmt|;
name|p
operator|=
name|CAST
argument_list|(
specifier|const
name|uint8_t
operator|*
argument_list|,
name|cdf_offset
argument_list|(
name|sst
operator|->
name|sst_tab
argument_list|,
name|offs
operator|+
sizeof|sizeof
argument_list|(
name|sh
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|=
name|CAST
argument_list|(
specifier|const
name|uint8_t
operator|*
argument_list|,
name|cdf_offset
argument_list|(
name|shp
argument_list|,
name|sh
operator|.
name|sh_len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|>=
name|e
operator|||
name|cdf_check_stream_offset
argument_list|(
name|sst
argument_list|,
name|h
argument_list|,
name|e
argument_list|,
literal|0
argument_list|,
name|__LINE__
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sh
operator|.
name|sh_properties
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|q
operator|=
name|cdf_get_property_info_pos
argument_list|(
name|sst
argument_list|,
name|h
argument_list|,
name|p
argument_list|,
name|e
argument_list|,
name|i
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|inp
index|[
name|i
index|]
operator|.
name|pi_id
operator|=
name|CDF_GETUINT32
argument_list|(
name|p
argument_list|,
name|i
operator|<<
literal|1
argument_list|)
expr_stmt|;
name|left
operator|=
name|CAST
argument_list|(
name|size_t
argument_list|,
name|e
operator|-
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|left
operator|<
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"short info (no type)_\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|inp
index|[
name|i
index|]
operator|.
name|pi_type
operator|=
name|CDF_GETUINT32
argument_list|(
name|q
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"%"
name|SIZE_T_FORMAT
literal|"u) id=%#x type=%#x offs=%#tx,%#x\n"
operator|,
name|i
operator|,
name|inp
index|[
name|i
index|]
operator|.
name|pi_id
operator|,
name|inp
index|[
name|i
index|]
operator|.
name|pi_type
operator|,
name|q
operator|-
name|p
operator|,
name|offs
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
index|[
name|i
index|]
operator|.
name|pi_type
operator|&
name|CDF_VECTOR
condition|)
block|{
if|if
condition|(
name|left
operator|<
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
literal|2
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"missing CDF_VECTOR length\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|nelements
operator|=
name|CDF_GETUINT32
argument_list|(
name|q
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|nelements
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"CDF_VECTOR with nelements == 0\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|slen
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|nelements
operator|=
literal|1
expr_stmt|;
name|slen
operator|=
literal|1
expr_stmt|;
block|}
name|o4
operator|=
name|slen
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
index|[
name|i
index|]
operator|.
name|pi_type
operator|&
operator|(
name|CDF_ARRAY
operator||
name|CDF_BYREF
operator||
name|CDF_RESERVED
operator|)
condition|)
goto|goto
name|unknown
goto|;
switch|switch
condition|(
name|inp
index|[
name|i
index|]
operator|.
name|pi_type
operator|&
name|CDF_TYPEMASK
condition|)
block|{
case|case
name|CDF_NULL
case|:
case|case
name|CDF_EMPTY
case|:
break|break;
case|case
name|CDF_SIGNED16
case|:
if|if
condition|(
operator|!
name|cdf_copy_info
argument_list|(
operator|&
name|inp
index|[
name|i
index|]
argument_list|,
operator|&
name|q
index|[
name|o4
index|]
argument_list|,
name|e
argument_list|,
sizeof|sizeof
argument_list|(
name|int16_t
argument_list|)
argument_list|)
condition|)
goto|goto
name|unknown
goto|;
break|break;
case|case
name|CDF_SIGNED32
case|:
case|case
name|CDF_BOOL
case|:
case|case
name|CDF_UNSIGNED32
case|:
case|case
name|CDF_FLOAT
case|:
if|if
condition|(
operator|!
name|cdf_copy_info
argument_list|(
operator|&
name|inp
index|[
name|i
index|]
argument_list|,
operator|&
name|q
index|[
name|o4
index|]
argument_list|,
name|e
argument_list|,
sizeof|sizeof
argument_list|(
name|int32_t
argument_list|)
argument_list|)
condition|)
goto|goto
name|unknown
goto|;
break|break;
case|case
name|CDF_SIGNED64
case|:
case|case
name|CDF_UNSIGNED64
case|:
case|case
name|CDF_DOUBLE
case|:
case|case
name|CDF_FILETIME
case|:
if|if
condition|(
operator|!
name|cdf_copy_info
argument_list|(
operator|&
name|inp
index|[
name|i
index|]
argument_list|,
operator|&
name|q
index|[
name|o4
index|]
argument_list|,
name|e
argument_list|,
sizeof|sizeof
argument_list|(
name|int64_t
argument_list|)
argument_list|)
condition|)
goto|goto
name|unknown
goto|;
break|break;
case|case
name|CDF_LENGTH32_STRING
case|:
case|case
name|CDF_LENGTH32_WSTRING
case|:
if|if
condition|(
name|nelements
operator|>
literal|1
condition|)
block|{
name|size_t
name|nelem
init|=
name|inp
operator|-
operator|*
name|info
decl_stmt|;
name|inp
operator|=
name|cdf_grow_info
argument_list|(
name|info
argument_list|,
name|maxcount
argument_list|,
name|nelements
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|inp
operator|+=
name|nelem
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"nelements = %"
name|SIZE_T_FORMAT
literal|"u\n"
operator|,
name|nelements
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nelements
operator|&&
name|i
operator|<
name|sh
operator|.
name|sh_properties
condition|;
name|j
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|uint32_t
name|l
decl_stmt|;
if|if
condition|(
name|o4
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|>
name|left
condition|)
goto|goto
name|out
goto|;
name|l
operator|=
name|CDF_GETUINT32
argument_list|(
name|q
argument_list|,
name|slen
argument_list|)
expr_stmt|;
name|o4
operator|+=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|o4
operator|+
name|l
operator|>
name|left
condition|)
goto|goto
name|out
goto|;
name|inp
index|[
name|i
index|]
operator|.
name|pi_str
operator|.
name|s_len
operator|=
name|l
expr_stmt|;
name|inp
index|[
name|i
index|]
operator|.
name|pi_str
operator|.
name|s_buf
operator|=
name|CAST
argument_list|(
specifier|const
name|char
operator|*
argument_list|,
name|CAST
argument_list|(
specifier|const
name|void
operator|*
argument_list|,
operator|&
name|q
index|[
name|o4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"o=%zu l=%d(%"
name|SIZE_T_FORMAT
literal|"u), t=%zu s=%s\n"
operator|,
name|o4
operator|,
name|l
operator|,
name|CDF_ROUND
argument_list|(
name|l
argument_list|,
sizeof|sizeof
argument_list|(
name|l
argument_list|)
argument_list|)
operator|,
name|left
operator|,
name|inp
index|[
name|i
index|]
operator|.
name|pi_str
operator|.
name|s_buf
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|&
literal|1
condition|)
name|l
operator|++
expr_stmt|;
name|slen
operator|+=
name|l
operator|>>
literal|1
expr_stmt|;
name|o4
operator|=
name|slen
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
block|}
name|i
operator|--
expr_stmt|;
break|break;
case|case
name|CDF_CLIPBOARD
case|:
if|if
condition|(
name|inp
index|[
name|i
index|]
operator|.
name|pi_type
operator|&
name|CDF_VECTOR
condition|)
goto|goto
name|unknown
goto|;
break|break;
default|default:
name|unknown
label|:
name|memset
argument_list|(
operator|&
name|inp
index|[
name|i
index|]
operator|.
name|pi_val
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|inp
index|[
name|i
index|]
operator|.
name|pi_val
argument_list|)
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"Don't know how to deal with %#x\n"
operator|,
name|inp
index|[
name|i
index|]
operator|.
name|pi_type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
literal|0
return|;
name|out
label|:
name|free
argument_list|(
operator|*
name|info
argument_list|)
expr_stmt|;
operator|*
name|info
operator|=
name|NULL
expr_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
operator|*
name|maxcount
operator|=
literal|0
expr_stmt|;
name|errno
operator|=
name|EFTYPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cdf_unpack_summary_info
parameter_list|(
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
name|cdf_summary_info_header_t
modifier|*
name|ssi
parameter_list|,
name|cdf_property_info_t
modifier|*
modifier|*
name|info
parameter_list|,
name|size_t
modifier|*
name|count
parameter_list|)
block|{
name|size_t
name|maxcount
decl_stmt|;
specifier|const
name|cdf_summary_info_header_t
modifier|*
name|si
init|=
name|CAST
argument_list|(
specifier|const
name|cdf_summary_info_header_t
operator|*
argument_list|,
name|sst
operator|->
name|sst_tab
argument_list|)
decl_stmt|;
specifier|const
name|cdf_section_declaration_t
modifier|*
name|sd
init|=
name|CAST
argument_list|(
specifier|const
name|cdf_section_declaration_t
operator|*
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|sst
operator|->
name|sst_tab
operator|+
name|CDF_SECTION_DECLARATION_OFFSET
operator|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|cdf_check_stream_offset
argument_list|(
name|sst
argument_list|,
name|h
argument_list|,
name|si
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|si
argument_list|)
argument_list|,
name|__LINE__
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|cdf_check_stream_offset
argument_list|(
name|sst
argument_list|,
name|h
argument_list|,
name|sd
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sd
argument_list|)
argument_list|,
name|__LINE__
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|ssi
operator|->
name|si_byte_order
operator|=
name|CDF_TOLE2
argument_list|(
name|si
operator|->
name|si_byte_order
argument_list|)
expr_stmt|;
name|ssi
operator|->
name|si_os_version
operator|=
name|CDF_TOLE2
argument_list|(
name|si
operator|->
name|si_os_version
argument_list|)
expr_stmt|;
name|ssi
operator|->
name|si_os
operator|=
name|CDF_TOLE2
argument_list|(
name|si
operator|->
name|si_os
argument_list|)
expr_stmt|;
name|ssi
operator|->
name|si_class
operator|=
name|si
operator|->
name|si_class
expr_stmt|;
name|cdf_swap_class
argument_list|(
operator|&
name|ssi
operator|->
name|si_class
argument_list|)
expr_stmt|;
name|ssi
operator|->
name|si_count
operator|=
name|CDF_TOLE4
argument_list|(
name|si
operator|->
name|si_count
argument_list|)
expr_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
name|maxcount
operator|=
literal|0
expr_stmt|;
operator|*
name|info
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|cdf_read_property_info
argument_list|(
name|sst
argument_list|,
name|h
argument_list|,
name|CDF_TOLE4
argument_list|(
name|sd
operator|->
name|sd_offset
argument_list|)
argument_list|,
name|info
argument_list|,
name|count
argument_list|,
operator|&
name|maxcount
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|extract_catalog_field
parameter_list|(
name|t
parameter_list|,
name|f
parameter_list|,
name|l
parameter_list|)
define|\
value|if (b + l + sizeof(cep->f)> eb) { \ 	    cep->ce_namlen = 0; \ 	    break; \     } \     memcpy(&cep->f, b + (l), sizeof(cep->f)); \     ce[i].f = CAST(t, CDF_TOLE(cep->f))
end_define

begin_function
name|int
name|cdf_unpack_catalog
parameter_list|(
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
name|cdf_catalog_t
modifier|*
modifier|*
name|cat
parameter_list|)
block|{
name|size_t
name|ss
init|=
name|cdf_check_stream
argument_list|(
name|sst
argument_list|,
name|h
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|b
init|=
name|CAST
argument_list|(
specifier|const
name|char
operator|*
argument_list|,
name|sst
operator|->
name|sst_tab
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|nb
decl_stmt|,
modifier|*
name|eb
init|=
name|b
operator|+
name|ss
operator|*
name|sst
operator|->
name|sst_len
decl_stmt|;
name|size_t
name|nr
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|cdf_catalog_entry_t
modifier|*
name|ce
decl_stmt|;
name|uint16_t
name|reclen
decl_stmt|;
specifier|const
name|uint16_t
modifier|*
name|np
decl_stmt|;
for|for
control|(
name|nr
operator|=
literal|0
init|;
condition|;
name|nr
operator|++
control|)
block|{
name|memcpy
argument_list|(
operator|&
name|reclen
argument_list|,
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|reclen
argument_list|)
argument_list|)
expr_stmt|;
name|reclen
operator|=
name|CDF_TOLE2
argument_list|(
name|reclen
argument_list|)
expr_stmt|;
if|if
condition|(
name|reclen
operator|==
literal|0
condition|)
break|break;
name|b
operator|+=
name|reclen
expr_stmt|;
if|if
condition|(
name|b
operator|>
name|eb
condition|)
break|break;
block|}
if|if
condition|(
name|nr
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|nr
operator|--
expr_stmt|;
operator|*
name|cat
operator|=
name|CAST
argument_list|(
name|cdf_catalog_t
operator|*
argument_list|,
name|CDF_MALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|cdf_catalog_t
argument_list|)
operator|+
name|nr
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|ce
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cat
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ce
operator|=
operator|(
operator|*
name|cat
operator|)
operator|->
name|cat_e
expr_stmt|;
name|memset
argument_list|(
name|ce
argument_list|,
literal|0
argument_list|,
name|nr
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|ce
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|=
name|CAST
argument_list|(
specifier|const
name|char
operator|*
argument_list|,
name|sst
operator|->
name|sst_tab
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr
condition|;
name|b
operator|+=
name|reclen
control|)
block|{
name|cdf_catalog_entry_t
modifier|*
name|cep
init|=
operator|&
name|ce
index|[
name|j
index|]
decl_stmt|;
name|uint16_t
name|rlen
decl_stmt|;
name|extract_catalog_field
argument_list|(
name|uint16_t
argument_list|,
name|ce_namlen
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|extract_catalog_field
argument_list|(
name|uint16_t
argument_list|,
name|ce_num
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|extract_catalog_field
argument_list|(
name|uint64_t
argument_list|,
name|ce_timestamp
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|reclen
operator|=
name|cep
operator|->
name|ce_namlen
expr_stmt|;
if|if
condition|(
name|reclen
operator|<
literal|14
condition|)
block|{
name|cep
operator|->
name|ce_namlen
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
name|cep
operator|->
name|ce_namlen
operator|=
name|__arraycount
argument_list|(
name|cep
operator|->
name|ce_name
argument_list|)
operator|-
literal|1
expr_stmt|;
name|rlen
operator|=
name|reclen
operator|-
literal|14
expr_stmt|;
if|if
condition|(
name|cep
operator|->
name|ce_namlen
operator|>
name|rlen
condition|)
name|cep
operator|->
name|ce_namlen
operator|=
name|rlen
expr_stmt|;
name|np
operator|=
name|CAST
argument_list|(
specifier|const
name|uint16_t
operator|*
argument_list|,
name|CAST
argument_list|(
specifier|const
name|void
operator|*
argument_list|,
operator|(
name|b
operator|+
literal|16
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|nb
operator|=
name|CAST
argument_list|(
specifier|const
name|char
operator|*
argument_list|,
name|CAST
argument_list|(
specifier|const
name|void
operator|*
argument_list|,
operator|(
name|np
operator|+
name|cep
operator|->
name|ce_namlen
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nb
operator|>
name|eb
condition|)
block|{
name|cep
operator|->
name|ce_namlen
operator|=
literal|0
expr_stmt|;
break|break;
block|}
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|cep
operator|->
name|ce_namlen
condition|;
name|k
operator|++
control|)
name|cep
operator|->
name|ce_name
index|[
name|k
index|]
operator|=
name|np
index|[
name|k
index|]
expr_stmt|;
comment|/* XXX: CDF_TOLE2? */
name|cep
operator|->
name|ce_name
index|[
name|cep
operator|->
name|ce_namlen
index|]
operator|=
literal|0
expr_stmt|;
name|j
operator|=
name|i
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
operator|(
operator|*
name|cat
operator|)
operator|->
name|cat_num
operator|=
name|j
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cdf_print_classid
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|,
specifier|const
name|cdf_classid_t
modifier|*
name|id
parameter_list|)
block|{
return|return
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%.8x-%.4x-%.4x-%.2x%.2x-"
literal|"%.2x%.2x%.2x%.2x%.2x%.2x"
argument_list|,
name|id
operator|->
name|cl_dword
argument_list|,
name|id
operator|->
name|cl_word
index|[
literal|0
index|]
argument_list|,
name|id
operator|->
name|cl_word
index|[
literal|1
index|]
argument_list|,
name|id
operator|->
name|cl_two
index|[
literal|0
index|]
argument_list|,
name|id
operator|->
name|cl_two
index|[
literal|1
index|]
argument_list|,
name|id
operator|->
name|cl_six
index|[
literal|0
index|]
argument_list|,
name|id
operator|->
name|cl_six
index|[
literal|1
index|]
argument_list|,
name|id
operator|->
name|cl_six
index|[
literal|2
index|]
argument_list|,
name|id
operator|->
name|cl_six
index|[
literal|3
index|]
argument_list|,
name|id
operator|->
name|cl_six
index|[
literal|4
index|]
argument_list|,
name|id
operator|->
name|cl_six
index|[
literal|5
index|]
argument_list|)
return|;
block|}
end_function

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint32_t
name|v
decl_stmt|;
specifier|const
name|char
modifier|*
name|n
decl_stmt|;
block|}
name|vn
index|[]
init|=
block|{
block|{
name|CDF_PROPERTY_CODE_PAGE
block|,
literal|"Code page"
block|}
block|,
block|{
name|CDF_PROPERTY_TITLE
block|,
literal|"Title"
block|}
block|,
block|{
name|CDF_PROPERTY_SUBJECT
block|,
literal|"Subject"
block|}
block|,
block|{
name|CDF_PROPERTY_AUTHOR
block|,
literal|"Author"
block|}
block|,
block|{
name|CDF_PROPERTY_KEYWORDS
block|,
literal|"Keywords"
block|}
block|,
block|{
name|CDF_PROPERTY_COMMENTS
block|,
literal|"Comments"
block|}
block|,
block|{
name|CDF_PROPERTY_TEMPLATE
block|,
literal|"Template"
block|}
block|,
block|{
name|CDF_PROPERTY_LAST_SAVED_BY
block|,
literal|"Last Saved By"
block|}
block|,
block|{
name|CDF_PROPERTY_REVISION_NUMBER
block|,
literal|"Revision Number"
block|}
block|,
block|{
name|CDF_PROPERTY_TOTAL_EDITING_TIME
block|,
literal|"Total Editing Time"
block|}
block|,
block|{
name|CDF_PROPERTY_LAST_PRINTED
block|,
literal|"Last Printed"
block|}
block|,
block|{
name|CDF_PROPERTY_CREATE_TIME
block|,
literal|"Create Time/Date"
block|}
block|,
block|{
name|CDF_PROPERTY_LAST_SAVED_TIME
block|,
literal|"Last Saved Time/Date"
block|}
block|,
block|{
name|CDF_PROPERTY_NUMBER_OF_PAGES
block|,
literal|"Number of Pages"
block|}
block|,
block|{
name|CDF_PROPERTY_NUMBER_OF_WORDS
block|,
literal|"Number of Words"
block|}
block|,
block|{
name|CDF_PROPERTY_NUMBER_OF_CHARACTERS
block|,
literal|"Number of Characters"
block|}
block|,
block|{
name|CDF_PROPERTY_THUMBNAIL
block|,
literal|"Thumbnail"
block|}
block|,
block|{
name|CDF_PROPERTY_NAME_OF_APPLICATION
block|,
literal|"Name of Creating Application"
block|}
block|,
block|{
name|CDF_PROPERTY_SECURITY
block|,
literal|"Security"
block|}
block|,
block|{
name|CDF_PROPERTY_LOCALE_ID
block|,
literal|"Locale ID"
block|}
block|, }
struct|;
end_struct

begin_function
name|int
name|cdf_print_property_name
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|bufsiz
parameter_list|,
name|uint32_t
name|p
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|__arraycount
argument_list|(
name|vn
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|vn
index|[
name|i
index|]
operator|.
name|v
operator|==
name|p
condition|)
return|return
name|snprintf
argument_list|(
name|buf
argument_list|,
name|bufsiz
argument_list|,
literal|"%s"
argument_list|,
name|vn
index|[
name|i
index|]
operator|.
name|n
argument_list|)
return|;
return|return
name|snprintf
argument_list|(
name|buf
argument_list|,
name|bufsiz
argument_list|,
literal|"%#x"
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|cdf_print_elapsed_time
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|bufsiz
parameter_list|,
name|cdf_timestamp_t
name|ts
parameter_list|)
block|{
name|int
name|len
init|=
literal|0
decl_stmt|;
name|int
name|days
decl_stmt|,
name|hours
decl_stmt|,
name|mins
decl_stmt|,
name|secs
decl_stmt|;
name|ts
operator|/=
name|CDF_TIME_PREC
expr_stmt|;
name|secs
operator|=
call|(
name|int
call|)
argument_list|(
name|ts
operator|%
literal|60
argument_list|)
expr_stmt|;
name|ts
operator|/=
literal|60
expr_stmt|;
name|mins
operator|=
call|(
name|int
call|)
argument_list|(
name|ts
operator|%
literal|60
argument_list|)
expr_stmt|;
name|ts
operator|/=
literal|60
expr_stmt|;
name|hours
operator|=
call|(
name|int
call|)
argument_list|(
name|ts
operator|%
literal|24
argument_list|)
expr_stmt|;
name|ts
operator|/=
literal|24
expr_stmt|;
name|days
operator|=
operator|(
name|int
operator|)
name|ts
expr_stmt|;
if|if
condition|(
name|days
condition|)
block|{
name|len
operator|+=
name|snprintf
argument_list|(
name|buf
operator|+
name|len
argument_list|,
name|bufsiz
operator|-
name|len
argument_list|,
literal|"%dd+"
argument_list|,
name|days
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|len
operator|>=
name|bufsiz
condition|)
return|return
name|len
return|;
block|}
if|if
condition|(
name|days
operator|||
name|hours
condition|)
block|{
name|len
operator|+=
name|snprintf
argument_list|(
name|buf
operator|+
name|len
argument_list|,
name|bufsiz
operator|-
name|len
argument_list|,
literal|"%.2d:"
argument_list|,
name|hours
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|len
operator|>=
name|bufsiz
condition|)
return|return
name|len
return|;
block|}
name|len
operator|+=
name|snprintf
argument_list|(
name|buf
operator|+
name|len
argument_list|,
name|bufsiz
operator|-
name|len
argument_list|,
literal|"%.2d:"
argument_list|,
name|mins
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|len
operator|>=
name|bufsiz
condition|)
return|return
name|len
return|;
name|len
operator|+=
name|snprintf
argument_list|(
name|buf
operator|+
name|len
argument_list|,
name|bufsiz
operator|-
name|len
argument_list|,
literal|"%.2d"
argument_list|,
name|secs
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|cdf_u16tos8
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|uint16_t
modifier|*
name|p
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
operator|&&
name|p
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
operator|(
name|char
operator|)
name|p
index|[
name|i
index|]
expr_stmt|;
name|buf
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CDF_DEBUG
end_ifdef

begin_function
name|void
name|cdf_dump_header
parameter_list|(
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
define|#
directive|define
name|DUMP
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(void)fprintf(stderr, "%40.40s = " a "\n", # b, h->h_ ## b)
define|#
directive|define
name|DUMP2
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(void)fprintf(stderr, "%40.40s = " a " (" a ")\n", # b, \     h->h_ ## b, 1<< h->h_ ## b)
name|DUMP
argument_list|(
literal|"%d"
argument_list|,
name|revision
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
literal|"%d"
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
literal|"%#x"
argument_list|,
name|byte_order
argument_list|)
expr_stmt|;
name|DUMP2
argument_list|(
literal|"%d"
argument_list|,
name|sec_size_p2
argument_list|)
expr_stmt|;
name|DUMP2
argument_list|(
literal|"%d"
argument_list|,
name|short_sec_size_p2
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
literal|"%d"
argument_list|,
name|num_sectors_in_sat
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
literal|"%d"
argument_list|,
name|secid_first_directory
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
literal|"%d"
argument_list|,
name|min_size_standard_stream
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
literal|"%d"
argument_list|,
name|secid_first_sector_in_short_sat
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
literal|"%d"
argument_list|,
name|num_sectors_in_short_sat
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
literal|"%d"
argument_list|,
name|secid_first_sector_in_master_sat
argument_list|)
expr_stmt|;
name|DUMP
argument_list|(
literal|"%d"
argument_list|,
name|num_sectors_in_master_sat
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|__arraycount
argument_list|(
name|h
operator|->
name|h_master_sat
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|h
operator|->
name|h_master_sat
index|[
name|i
index|]
operator|==
name|CDF_SECID_FREE
condition|)
break|break;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%35.35s[%.3"
name|SIZE_T_FORMAT
literal|"u] = %d\n"
argument_list|,
literal|"master_sat"
argument_list|,
name|i
argument_list|,
name|h
operator|->
name|h_master_sat
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|cdf_dump_sat
parameter_list|(
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|s
init|=
name|size
operator|/
sizeof|sizeof
argument_list|(
name|cdf_secid_t
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sat
operator|->
name|sat_len
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s[%"
name|SIZE_T_FORMAT
literal|"u]:\n%.6"
name|SIZE_T_FORMAT
literal|"u: "
argument_list|,
name|prefix
argument_list|,
name|i
argument_list|,
name|i
operator|*
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|s
condition|;
name|j
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%5d, "
argument_list|,
name|CDF_TOLE4
argument_list|(
name|sat
operator|->
name|sat_tab
index|[
name|s
operator|*
name|i
operator|+
name|j
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|+
literal|1
operator|)
operator|%
literal|10
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n%.6"
name|SIZE_T_FORMAT
literal|"u: "
argument_list|,
name|i
operator|*
name|s
operator|+
name|j
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|cdf_dump
parameter_list|(
specifier|const
name|void
modifier|*
name|v
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|p
init|=
name|v
decl_stmt|;
name|char
name|abuf
index|[
literal|16
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%.4x: "
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
operator|,
name|p
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%.2x "
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
name|abuf
index|[
name|j
operator|++
index|]
operator|=
name|isprint
argument_list|(
operator|*
name|p
argument_list|)
condition|?
operator|*
name|p
else|:
literal|'.'
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|16
condition|)
block|{
name|j
operator|=
literal|0
expr_stmt|;
name|abuf
index|[
literal|15
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n%.4"
name|SIZE_T_FORMAT
literal|"x: "
argument_list|,
name|abuf
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cdf_dump_stream
parameter_list|(
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|)
block|{
name|size_t
name|ss
init|=
name|sst
operator|->
name|sst_ss
decl_stmt|;
name|cdf_dump
argument_list|(
name|sst
operator|->
name|sst_tab
argument_list|,
name|ss
operator|*
name|sst
operator|->
name|sst_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cdf_dump_dir
parameter_list|(
specifier|const
name|cdf_info_t
modifier|*
name|info
parameter_list|,
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|sat
parameter_list|,
specifier|const
name|cdf_sat_t
modifier|*
name|ssat
parameter_list|,
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|,
specifier|const
name|cdf_dir_t
modifier|*
name|dir
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|cdf_directory_t
modifier|*
name|d
decl_stmt|;
name|char
name|name
index|[
name|__arraycount
argument_list|(
name|d
operator|->
name|d_name
argument_list|)
index|]
decl_stmt|;
name|cdf_stream_t
name|scn
decl_stmt|;
name|struct
name|timespec
name|ts
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|types
index|[]
init|=
block|{
literal|"empty"
block|,
literal|"user storage"
block|,
literal|"user stream"
block|,
literal|"lockbytes"
block|,
literal|"property"
block|,
literal|"root storage"
block|}
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dir
operator|->
name|dir_len
condition|;
name|i
operator|++
control|)
block|{
name|char
name|buf
index|[
literal|26
index|]
decl_stmt|;
name|d
operator|=
operator|&
name|dir
operator|->
name|dir_tab
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|name
argument_list|)
condition|;
name|j
operator|++
control|)
name|name
index|[
name|j
index|]
operator|=
operator|(
name|char
operator|)
name|CDF_TOLE2
argument_list|(
name|d
operator|->
name|d_name
index|[
name|j
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Directory %"
name|SIZE_T_FORMAT
literal|"u: %s\n"
argument_list|,
name|i
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|d_type
operator|<
name|__arraycount
argument_list|(
name|types
argument_list|)
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Type: %s\n"
argument_list|,
name|types
index|[
name|d
operator|->
name|d_type
index|]
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Type: %d\n"
argument_list|,
name|d
operator|->
name|d_type
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Color: %s\n"
argument_list|,
name|d
operator|->
name|d_color
condition|?
literal|"black"
else|:
literal|"red"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Left child: %d\n"
argument_list|,
name|d
operator|->
name|d_left_child
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Right child: %d\n"
argument_list|,
name|d
operator|->
name|d_right_child
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Flags: %#x\n"
argument_list|,
name|d
operator|->
name|d_flags
argument_list|)
expr_stmt|;
name|cdf_timestamp_to_timespec
argument_list|(
operator|&
name|ts
argument_list|,
name|d
operator|->
name|d_created
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Created %s"
argument_list|,
name|cdf_ctime
argument_list|(
operator|&
name|ts
operator|.
name|tv_sec
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|cdf_timestamp_to_timespec
argument_list|(
operator|&
name|ts
argument_list|,
name|d
operator|->
name|d_modified
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Modified %s"
argument_list|,
name|cdf_ctime
argument_list|(
operator|&
name|ts
operator|.
name|tv_sec
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Stream %d\n"
argument_list|,
name|d
operator|->
name|d_stream_first_sector
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Size %d\n"
argument_list|,
name|d
operator|->
name|d_size
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|d
operator|->
name|d_type
condition|)
block|{
case|case
name|CDF_DIR_TYPE_USER_STORAGE
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Storage: %d\n"
argument_list|,
name|d
operator|->
name|d_storage
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDF_DIR_TYPE_USER_STREAM
case|:
if|if
condition|(
name|sst
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|cdf_read_sector_chain
argument_list|(
name|info
argument_list|,
name|h
argument_list|,
name|sat
argument_list|,
name|ssat
argument_list|,
name|sst
argument_list|,
name|d
operator|->
name|d_stream_first_sector
argument_list|,
name|d
operator|->
name|d_size
argument_list|,
operator|&
name|scn
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"Can't read stream for %s at %d len %d"
argument_list|,
name|name
argument_list|,
name|d
operator|->
name|d_stream_first_sector
argument_list|,
name|d
operator|->
name|d_size
argument_list|)
expr_stmt|;
break|break;
block|}
name|cdf_dump_stream
argument_list|(
operator|&
name|scn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|scn
operator|.
name|sst_tab
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
block|}
end_function

begin_function
name|void
name|cdf_dump_property_info
parameter_list|(
specifier|const
name|cdf_property_info_t
modifier|*
name|info
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|cdf_timestamp_t
name|tp
decl_stmt|;
name|struct
name|timespec
name|ts
decl_stmt|;
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|cdf_print_property_name
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_id
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%"
name|SIZE_T_FORMAT
literal|"u) %s: "
argument_list|,
name|i
argument_list|,
name|buf
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|info
index|[
name|i
index|]
operator|.
name|pi_type
condition|)
block|{
case|case
name|CDF_NULL
case|:
break|break;
case|case
name|CDF_SIGNED16
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"signed 16 [%hd]\n"
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_s16
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDF_SIGNED32
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"signed 32 [%d]\n"
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_s32
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDF_UNSIGNED32
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unsigned 32 [%u]\n"
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_u32
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDF_FLOAT
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"float [%g]\n"
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_f
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDF_DOUBLE
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"double [%g]\n"
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_d
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDF_LENGTH32_STRING
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"string %u [%.*s]\n"
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_str
operator|.
name|s_len
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_str
operator|.
name|s_len
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_str
operator|.
name|s_buf
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDF_LENGTH32_WSTRING
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"string %u ["
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_str
operator|.
name|s_len
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|info
index|[
name|i
index|]
operator|.
name|pi_str
operator|.
name|s_len
operator|-
literal|1
condition|;
name|j
operator|++
control|)
operator|(
name|void
operator|)
name|fputc
argument_list|(
name|info
index|[
name|i
index|]
operator|.
name|pi_str
operator|.
name|s_buf
index|[
name|j
operator|<<
literal|1
index|]
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"]\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|CDF_FILETIME
case|:
name|tp
operator|=
name|info
index|[
name|i
index|]
operator|.
name|pi_tp
expr_stmt|;
if|if
condition|(
name|tp
operator|<
literal|1000000000000000LL
condition|)
block|{
name|cdf_print_elapsed_time
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|tp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"timestamp %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
name|tbuf
index|[
literal|26
index|]
decl_stmt|;
name|cdf_timestamp_to_timespec
argument_list|(
operator|&
name|ts
argument_list|,
name|tp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"timestamp %s"
argument_list|,
name|cdf_ctime
argument_list|(
operator|&
name|ts
operator|.
name|tv_sec
argument_list|,
name|tbuf
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CDF_CLIPBOARD
case|:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"CLIPBOARD %u\n"
argument_list|,
name|info
index|[
name|i
index|]
operator|.
name|pi_u32
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"Don't know how to deal with %#x\n"
operator|,
name|info
index|[
name|i
index|]
operator|.
name|pi_type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
name|void
name|cdf_dump_summary_info
parameter_list|(
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|cdf_summary_info_header_t
name|ssi
decl_stmt|;
name|cdf_property_info_t
modifier|*
name|info
decl_stmt|;
name|size_t
name|count
decl_stmt|;
operator|(
name|void
operator|)
operator|&
name|h
expr_stmt|;
if|if
condition|(
name|cdf_unpack_summary_info
argument_list|(
name|sst
argument_list|,
name|h
argument_list|,
operator|&
name|ssi
argument_list|,
operator|&
name|info
argument_list|,
operator|&
name|count
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Endian: %#x\n"
argument_list|,
name|ssi
operator|.
name|si_byte_order
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Os Version %d.%d\n"
argument_list|,
name|ssi
operator|.
name|si_os_version
operator|&
literal|0xff
argument_list|,
name|ssi
operator|.
name|si_os_version
operator|>>
literal|8
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Os %d\n"
argument_list|,
name|ssi
operator|.
name|si_os
argument_list|)
expr_stmt|;
name|cdf_print_classid
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|ssi
operator|.
name|si_class
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Class %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Count %d\n"
argument_list|,
name|ssi
operator|.
name|si_count
argument_list|)
expr_stmt|;
name|cdf_dump_property_info
argument_list|(
name|info
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cdf_dump_catalog
parameter_list|(
specifier|const
name|cdf_header_t
modifier|*
name|h
parameter_list|,
specifier|const
name|cdf_stream_t
modifier|*
name|sst
parameter_list|)
block|{
name|cdf_catalog_t
modifier|*
name|cat
decl_stmt|;
name|cdf_unpack_catalog
argument_list|(
name|h
argument_list|,
name|sst
argument_list|,
operator|&
name|cat
argument_list|)
expr_stmt|;
specifier|const
name|cdf_catalog_entry_t
modifier|*
name|ce
init|=
name|cat
operator|->
name|cat_e
decl_stmt|;
name|struct
name|timespec
name|ts
decl_stmt|;
name|char
name|tbuf
index|[
literal|64
index|]
decl_stmt|,
name|sbuf
index|[
literal|256
index|]
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"Catalog:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cat
operator|->
name|cat_num
condition|;
name|i
operator|++
control|)
block|{
name|cdf_timestamp_to_timespec
argument_list|(
operator|&
name|ts
argument_list|,
name|ce
index|[
name|i
index|]
operator|.
name|ce_timestamp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t%d %s %s"
argument_list|,
name|ce
index|[
name|i
index|]
operator|.
name|ce_num
argument_list|,
name|cdf_u16tos8
argument_list|(
name|sbuf
argument_list|,
name|ce
index|[
name|i
index|]
operator|.
name|ce_namlen
argument_list|,
name|ce
index|[
name|i
index|]
operator|.
name|ce_name
argument_list|)
argument_list|,
name|cdf_ctime
argument_list|(
operator|&
name|ts
operator|.
name|tv_sec
argument_list|,
name|tbuf
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|cat
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|TEST
end_ifdef

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|cdf_header_t
name|h
decl_stmt|;
name|cdf_sat_t
name|sat
decl_stmt|,
name|ssat
decl_stmt|;
name|cdf_stream_t
name|sst
decl_stmt|,
name|scn
decl_stmt|;
name|cdf_dir_t
name|dir
decl_stmt|;
name|cdf_info_t
name|info
decl_stmt|;
specifier|const
name|cdf_directory_t
modifier|*
name|root
decl_stmt|;
ifdef|#
directive|ifdef
name|__linux__
define|#
directive|define
name|getprogname
parameter_list|()
value|__progname
specifier|extern
name|char
modifier|*
name|__progname
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s<filename>\n"
argument_list|,
name|getprogname
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|info
operator|.
name|i_buf
operator|=
name|NULL
expr_stmt|;
name|info
operator|.
name|i_len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|info
operator|.
name|i_fd
operator|=
name|open
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Cannot open `%s'"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdf_read_header
argument_list|(
operator|&
name|info
argument_list|,
operator|&
name|h
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Cannot read header"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CDF_DEBUG
name|cdf_dump_header
argument_list|(
operator|&
name|h
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cdf_read_sat
argument_list|(
operator|&
name|info
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|sat
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Cannot read sat"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CDF_DEBUG
name|cdf_dump_sat
argument_list|(
literal|"SAT"
argument_list|,
operator|&
name|sat
argument_list|,
name|CDF_SEC_SIZE
argument_list|(
operator|&
name|h
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cdf_read_ssat
argument_list|(
operator|&
name|info
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|sat
argument_list|,
operator|&
name|ssat
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Cannot read ssat"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CDF_DEBUG
name|cdf_dump_sat
argument_list|(
literal|"SSAT"
argument_list|,
operator|&
name|ssat
argument_list|,
name|CDF_SHORT_SEC_SIZE
argument_list|(
operator|&
name|h
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cdf_read_dir
argument_list|(
operator|&
name|info
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|sat
argument_list|,
operator|&
name|dir
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Cannot read dir"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdf_read_short_stream
argument_list|(
operator|&
name|info
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|sat
argument_list|,
operator|&
name|dir
argument_list|,
operator|&
name|sst
argument_list|,
operator|&
name|root
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Cannot read short stream"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CDF_DEBUG
name|cdf_dump_stream
argument_list|(
operator|&
name|sst
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CDF_DEBUG
name|cdf_dump_dir
argument_list|(
operator|&
name|info
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|sat
argument_list|,
operator|&
name|ssat
argument_list|,
operator|&
name|sst
argument_list|,
operator|&
name|dir
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cdf_read_summary_info
argument_list|(
operator|&
name|info
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|sat
argument_list|,
operator|&
name|ssat
argument_list|,
operator|&
name|sst
argument_list|,
operator|&
name|dir
argument_list|,
operator|&
name|scn
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|warn
argument_list|(
literal|"Cannot read summary info"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CDF_DEBUG
else|else
name|cdf_dump_summary_info
argument_list|(
operator|&
name|h
argument_list|,
operator|&
name|scn
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cdf_read_user_stream
argument_list|(
operator|&
name|info
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|sat
argument_list|,
operator|&
name|ssat
argument_list|,
operator|&
name|sst
argument_list|,
operator|&
name|dir
argument_list|,
literal|"Catalog"
argument_list|,
operator|&
name|scn
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|warn
argument_list|(
literal|"Cannot read catalog"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CDF_DEBUG
else|else
name|cdf_dump_catalog
argument_list|(
operator|&
name|h
argument_list|,
operator|&
name|scn
argument_list|)
expr_stmt|;
endif|#
directive|endif
operator|(
name|void
operator|)
name|close
argument_list|(
name|info
operator|.
name|i_fd
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Adapted from: apptype.c, Written by Eberhard Mattes and put into the  * public domain  *   * Notes: 1. Qualify the filename so that DosQueryAppType does not do extraneous  * searches.  *   * 2. DosQueryAppType will return FAPPTYP_DOS on a file ending with ".com"  * (other than an OS/2 exe or Win exe with this name). Eberhard Mattes  * remarks Tue, 6 Apr 93: Moreover, it reports the type of the (new and very  * bug ridden) Win Emacs as "OS/2 executable".  *   * 3. apptype() uses the filename if given, otherwise a tmp file is created with  * the contents of buf. If buf is not the complete file, apptype can  * incorrectly identify the exe type. The "-z" option of "file" is the reason  * for this ugly code.  */
end_comment

begin_comment
comment|/*  * amai: Darrel Hankerson did the changes described here.  *   * It remains to check the validity of comments (2.) since it's referred to an  * "old" OS/2 version.  *   */
end_comment

begin_include
include|#
directive|include
file|"file.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_macro
name|FILE_RCSID
argument_list|(
literal|"@(#)$File: apptype.c,v 1.10 2009/02/03 20:27:51 christos Exp $"
argument_list|)
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* lint */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__EMX__
end_ifdef

begin_include
include|#
directive|include
file|<io.h>
end_include

begin_define
define|#
directive|define
name|INCL_DOSSESMGR
end_define

begin_define
define|#
directive|define
name|INCL_DOSERRORS
end_define

begin_define
define|#
directive|define
name|INCL_DOSFILEMGR
end_define

begin_include
include|#
directive|include
file|<os2.h>
end_include

begin_typedef
typedef|typedef
name|ULONG
name|APPTYPE
typedef|;
end_typedef

begin_function
name|protected
name|int
name|file_os2_apptype
parameter_list|(
name|struct
name|magic_set
modifier|*
name|ms
parameter_list|,
specifier|const
name|char
modifier|*
name|fn
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|nb
parameter_list|)
block|{
name|APPTYPE
name|rc
decl_stmt|,
name|type
decl_stmt|;
name|char
name|path
index|[
name|_MAX_PATH
index|]
decl_stmt|,
name|drive
index|[
name|_MAX_DRIVE
index|]
decl_stmt|,
name|dir
index|[
name|_MAX_DIR
index|]
decl_stmt|,
name|fname
index|[
name|_MAX_FNAME
index|]
decl_stmt|,
name|ext
index|[
name|_MAX_EXT
index|]
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
if|if
condition|(
name|fn
condition|)
name|filename
operator|=
name|strdup
argument_list|(
name|fn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|filename
operator|=
name|tempnam
argument_list|(
literal|"./"
argument_list|,
literal|"tmp"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|file_error
argument_list|(
name|ms
argument_list|,
name|errno
argument_list|,
literal|"cannot create tempnam"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* qualify the filename to prevent extraneous searches */
name|_splitpath
argument_list|(
name|filename
argument_list|,
name|drive
argument_list|,
name|dir
argument_list|,
name|fname
argument_list|,
name|ext
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s%s%s%s"
argument_list|,
name|drive
argument_list|,
operator|(
operator|*
name|dir
operator|==
literal|'\0'
operator|)
condition|?
literal|"./"
else|:
name|dir
argument_list|,
name|fname
argument_list|,
operator|(
operator|*
name|ext
operator|==
literal|'\0'
operator|)
condition|?
literal|"."
else|:
name|ext
argument_list|)
expr_stmt|;
if|if
condition|(
name|fn
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|path
argument_list|,
literal|"wb"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|file_error
argument_list|(
name|ms
argument_list|,
name|errno
argument_list|,
literal|"cannot open tmp file `%s'"
argument_list|,
name|path
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|nb
argument_list|,
name|fp
argument_list|)
operator|!=
name|nb
condition|)
block|{
name|file_error
argument_list|(
name|ms
argument_list|,
name|errno
argument_list|,
literal|"cannot write tmp file `%s'"
argument_list|,
name|path
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|DosQueryAppType
argument_list|(
name|path
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|fn
operator|==
name|NULL
condition|)
block|{
name|unlink
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|if (rc == ERROR_INVALID_EXE_SIGNATURE) 		printf("%s: not an executable file\n", fname); 	else if (rc == ERROR_FILE_NOT_FOUND) 		printf("%s: not found\n", fname); 	else if (rc == ERROR_ACCESS_DENIED) 		printf("%s: access denied\n", fname); 	else if (rc != 0) 		printf("%s: error code = %lu\n", fname, rc); 	else
else|#
directive|else
comment|/* 	 * for our purpose here it's sufficient to just ignore the error and 	 * return w/o success (=0) 	 */
if|if
condition|(
name|rc
condition|)
return|return
operator|(
literal|0
operator|)
return|;
endif|#
directive|endif
if|if
condition|(
name|type
operator|&
name|FAPPTYP_32BIT
condition|)
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"32-bit "
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|type
operator|&
name|FAPPTYP_PHYSDRV
condition|)
block|{
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"physical device driver"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|type
operator|&
name|FAPPTYP_VIRTDRV
condition|)
block|{
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"virtual device driver"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|type
operator|&
name|FAPPTYP_DLL
condition|)
block|{
if|if
condition|(
name|type
operator|&
name|FAPPTYP_PROTDLL
condition|)
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"protected "
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"DLL"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|type
operator|&
operator|(
name|FAPPTYP_WINDOWSREAL
operator||
name|FAPPTYP_WINDOWSPROT
operator|)
condition|)
block|{
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"Windows executable"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|type
operator|&
name|FAPPTYP_DOS
condition|)
block|{
comment|/* 		 * The API routine is partially broken on filenames ending 		 * ".com". 		 */
if|if
condition|(
name|stricmp
argument_list|(
name|ext
argument_list|,
literal|".com"
argument_list|)
operator|==
literal|0
condition|)
if|if
condition|(
name|strncmp
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|buf
argument_list|,
literal|"MZ"
argument_list|,
literal|2
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"DOS executable"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
comment|/* ---------------------------------------- */
comment|/* Might learn more from the magic(4) entry */
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|", magic(4)-> "
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
return|return
operator|(
literal|0
operator|)
return|;
comment|/* ---------------------------------------- */
block|}
elseif|else
if|if
condition|(
name|type
operator|&
name|FAPPTYP_BOUND
condition|)
block|{
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"bound executable"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|type
operator|&
literal|7
operator|)
operator|==
name|FAPPTYP_WINDOWAPI
condition|)
block|{
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"PM executable"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|"OS/2 executable"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
switch|switch
condition|(
name|type
operator|&
operator|(
name|FAPPTYP_NOTWINDOWCOMPAT
operator||
name|FAPPTYP_WINDOWCOMPAT
operator||
name|FAPPTYP_WINDOWAPI
operator|)
condition|)
block|{
case|case
name|FAPPTYP_NOTWINDOWCOMPAT
case|:
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|" [NOTWINDOWCOMPAT]"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|FAPPTYP_WINDOWCOMPAT
case|:
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|" [WINDOWCOMPAT]"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|FAPPTYP_WINDOWAPI
case|:
if|if
condition|(
name|file_printf
argument_list|(
name|ms
argument_list|,
literal|" [WINDOWAPI]"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
break|break;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2007 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|_SYS_ZFS_CONTEXT_H
end_ifndef

begin_define
define|#
directive|define
name|_SYS_ZFS_CONTEXT_H
end_define

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"%Z%%M%	%I%	%E% SMI"
end_pragma

begin_ifdef
ifdef|#
directive|ifdef
name|__cplusplus
end_ifdef

begin_extern
extern|extern
literal|"C"
block|{
endif|#
directive|endif
define|#
directive|define
name|_SYS_MUTEX_H
define|#
directive|define
name|_SYS_RWLOCK_H
define|#
directive|define
name|_SYS_CONDVAR_H
define|#
directive|define
name|_SYS_SYSTM_H
define|#
directive|define
name|_SYS_DEBUG_H
define|#
directive|define
name|_SYS_T_LOCK_H
define|#
directive|define
name|_SYS_VNODE_H
define|#
directive|define
name|_SYS_VFS_H
define|#
directive|define
name|_SYS_SUNDDI_H
define|#
directive|define
name|_SYS_CALLB_H
define|#
directive|define
name|_SYS_SCHED_H_
include|#
directive|include
file|<solaris.h>
include|#
directive|include
file|<stdio.h>
include|#
directive|include
file|<stdlib.h>
include|#
directive|include
file|<stddef.h>
include|#
directive|include
file|<stdarg.h>
include|#
directive|include
file|<fcntl.h>
include|#
directive|include
file|<unistd.h>
include|#
directive|include
file|<errno.h>
include|#
directive|include
file|<string.h>
include|#
directive|include
file|<strings.h>
include|#
directive|include
file|<thread.h>
include|#
directive|include
file|<assert.h>
include|#
directive|include
file|<limits.h>
include|#
directive|include
file|<dirent.h>
include|#
directive|include
file|<time.h>
include|#
directive|include
file|<math.h>
include|#
directive|include
file|<umem.h>
include|#
directive|include
file|<vmem.h>
include|#
directive|include
file|<fsshare.h>
include|#
directive|include
file|<sys/note.h>
include|#
directive|include
file|<sys/types.h>
include|#
directive|include
file|<sys/atomic.h>
include|#
directive|include
file|<sys/sysmacros.h>
include|#
directive|include
file|<sys/bitmap.h>
include|#
directive|include
file|<sys/resource.h>
include|#
directive|include
file|<sys/byteorder.h>
include|#
directive|include
file|<sys/list.h>
include|#
directive|include
file|<sys/time.h>
include|#
directive|include
file|<sys/uio.h>
include|#
directive|include
file|<sys/mntent.h>
include|#
directive|include
file|<sys/mnttab.h>
include|#
directive|include
file|<sys/zfs_debug.h>
include|#
directive|include
file|<sys/debug.h>
include|#
directive|include
file|<sys/sdt.h>
include|#
directive|include
file|<sys/kstat.h>
include|#
directive|include
file|<sys/kernel.h>
include|#
directive|include
file|<machine/atomic.h>
define|#
directive|define
name|ZFS_EXPORTS_PATH
value|"/etc/zfs/exports"
comment|/*  * Debugging  */
comment|/*  * Note that we are not using the debugging levels.  */
define|#
directive|define
name|CE_CONT
value|0
comment|/* continuation		*/
define|#
directive|define
name|CE_NOTE
value|1
comment|/* notice		*/
define|#
directive|define
name|CE_WARN
value|2
comment|/* warning		*/
define|#
directive|define
name|CE_PANIC
value|3
comment|/* panic		*/
define|#
directive|define
name|CE_IGNORE
value|4
comment|/* print nothing	*/
comment|/*  * ZFS debugging  */
define|#
directive|define
name|ZFS_LOG
parameter_list|(
modifier|...
parameter_list|)
value|do {  } while (0)
typedef|typedef
name|u_longlong_t
name|rlim64_t
typedef|;
define|#
directive|define
name|RLIM64_INFINITY
value|((rlim64_t)-3)
ifdef|#
directive|ifdef
name|ZFS_DEBUG
specifier|extern
name|void
name|dprintf_setup
parameter_list|(
name|int
modifier|*
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
endif|#
directive|endif
comment|/* ZFS_DEBUG */
specifier|extern
name|void
name|cmn_err
parameter_list|(
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
specifier|extern
name|void
name|vcmn_err
parameter_list|(
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|__va_list
parameter_list|)
function_decl|;
specifier|extern
name|void
name|panic
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
specifier|extern
name|void
name|vpanic
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|__va_list
parameter_list|)
function_decl|;
comment|/* This definition is copied from assert.h. */
if|#
directive|if
name|defined
argument_list|(
name|__STDC__
argument_list|)
if|#
directive|if
name|__STDC_VERSION__
operator|-
literal|0
operator|>=
literal|199901L
define|#
directive|define
name|verify
parameter_list|(
name|EX
parameter_list|)
value|(void)((EX) || \ 	(__assert_c99(#EX, __FILE__, __LINE__, __func__), 0))
else|#
directive|else
define|#
directive|define
name|verify
parameter_list|(
name|EX
parameter_list|)
value|(void)((EX) || (__assert(#EX, __FILE__, __LINE__), 0))
endif|#
directive|endif
comment|/* __STDC_VERSION__ - 0>= 199901L */
else|#
directive|else
define|#
directive|define
name|verify
parameter_list|(
name|EX
parameter_list|)
value|(void)((EX) || (_assert("EX", __FILE__, __LINE__), 0))
endif|#
directive|endif
comment|/* __STDC__ */
define|#
directive|define
name|VERIFY
value|verify
define|#
directive|define
name|ASSERT
value|assert
specifier|extern
name|void
name|__assert
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
ifdef|#
directive|ifdef
name|lint
define|#
directive|define
name|VERIFY3_IMPL
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|,
name|t
parameter_list|)
value|if (x == z) ((void)0)
else|#
directive|else
comment|/* BEGIN CSTYLED */
define|#
directive|define
name|VERIFY3_IMPL
parameter_list|(
name|LEFT
parameter_list|,
name|OP
parameter_list|,
name|RIGHT
parameter_list|,
name|TYPE
parameter_list|)
value|do { \ 	const TYPE __left = (TYPE)(LEFT); \ 	const TYPE __right = (TYPE)(RIGHT); \ 	if (!(__left OP __right)) { \ 		char *__buf = alloca(256); \ 		(void) snprintf(__buf, 256, "%s %s %s (0x%llx %s 0x%llx)", \ 			#LEFT, #OP, #RIGHT, \ 			(u_longlong_t)__left, #OP, (u_longlong_t)__right); \ 		__assert(__buf, __FILE__, __LINE__); \ 	} \ _NOTE(CONSTCOND) } while (0)
comment|/* END CSTYLED */
endif|#
directive|endif
comment|/* lint */
define|#
directive|define
name|VERIFY3S
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|VERIFY3_IMPL(x, y, z, int64_t)
define|#
directive|define
name|VERIFY3U
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|VERIFY3_IMPL(x, y, z, uint64_t)
define|#
directive|define
name|VERIFY3P
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|VERIFY3_IMPL(x, y, z, uintptr_t)
ifdef|#
directive|ifdef
name|NDEBUG
define|#
directive|define
name|ASSERT3S
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|((void)0)
define|#
directive|define
name|ASSERT3U
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|((void)0)
define|#
directive|define
name|ASSERT3P
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|((void)0)
else|#
directive|else
define|#
directive|define
name|ASSERT3S
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|VERIFY3S(x, y, z)
define|#
directive|define
name|ASSERT3U
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|VERIFY3U(x, y, z)
define|#
directive|define
name|ASSERT3P
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|VERIFY3P(x, y, z)
endif|#
directive|endif
comment|/*  * Dtrace SDT probes have different signatures in userland than they do in  * kernel.  If they're being used in kernel code, re-define them out of  * existence for their counterparts in libzpool.  */
ifdef|#
directive|ifdef
name|DTRACE_PROBE1
undef|#
directive|undef
name|DTRACE_PROBE1
define|#
directive|define
name|DTRACE_PROBE1
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
value|((void)0)
endif|#
directive|endif
comment|/* DTRACE_PROBE1 */
ifdef|#
directive|ifdef
name|DTRACE_PROBE2
undef|#
directive|undef
name|DTRACE_PROBE2
define|#
directive|define
name|DTRACE_PROBE2
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|,
name|e
parameter_list|)
value|((void)0)
endif|#
directive|endif
comment|/* DTRACE_PROBE2 */
ifdef|#
directive|ifdef
name|DTRACE_PROBE3
undef|#
directive|undef
name|DTRACE_PROBE3
define|#
directive|define
name|DTRACE_PROBE3
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|,
name|e
parameter_list|,
name|f
parameter_list|,
name|g
parameter_list|)
value|((void)0)
endif|#
directive|endif
comment|/* DTRACE_PROBE3 */
ifdef|#
directive|ifdef
name|DTRACE_PROBE4
undef|#
directive|undef
name|DTRACE_PROBE4
define|#
directive|define
name|DTRACE_PROBE4
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|,
name|e
parameter_list|,
name|f
parameter_list|,
name|g
parameter_list|,
name|h
parameter_list|,
name|i
parameter_list|)
value|((void)0)
endif|#
directive|endif
comment|/* DTRACE_PROBE4 */
comment|/*  * Threads  */
define|#
directive|define
name|curthread
value|((void *)(uintptr_t)thr_self())
typedef|typedef
name|struct
name|kthread
name|kthread_t
typedef|;
define|#
directive|define
name|thread_create
parameter_list|(
name|stk
parameter_list|,
name|stksize
parameter_list|,
name|func
parameter_list|,
name|arg
parameter_list|,
name|len
parameter_list|,
name|pp
parameter_list|,
name|state
parameter_list|,
name|pri
parameter_list|)
define|\
value|zk_thread_create(func, arg)
define|#
directive|define
name|thread_exit
parameter_list|()
value|thr_exit(NULL)
specifier|extern
name|kthread_t
modifier|*
name|zk_thread_create
parameter_list|(
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|()
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
define|#
directive|define
name|issig
parameter_list|(
name|why
parameter_list|)
value|(FALSE)
define|#
directive|define
name|ISSIG
parameter_list|(
name|thr
parameter_list|,
name|why
parameter_list|)
value|(FALSE)
comment|/*  * Mutexes  */
typedef|typedef
struct|struct
name|kmutex
block|{
name|void
modifier|*
name|m_owner
decl_stmt|;
name|mutex_t
name|m_lock
decl_stmt|;
block|}
name|kmutex_t
typedef|;
define|#
directive|define
name|MUTEX_DEFAULT
value|USYNC_THREAD
undef|#
directive|undef
name|MUTEX_HELD
define|#
directive|define
name|MUTEX_HELD
parameter_list|(
name|m
parameter_list|)
value|((m)->m_owner == curthread)
comment|/*  * Argh -- we have to get cheesy here because the kernel and userland  * have different signatures for the same routine.  */
comment|//extern int _mutex_init(mutex_t *mp, int type, void *arg);
comment|//extern int _mutex_destroy(mutex_t *mp);
define|#
directive|define
name|mutex_init
parameter_list|(
name|mp
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|,
name|d
parameter_list|)
value|zmutex_init((kmutex_t *)(mp))
define|#
directive|define
name|mutex_destroy
parameter_list|(
name|mp
parameter_list|)
value|zmutex_destroy((kmutex_t *)(mp))
specifier|extern
name|void
name|zmutex_init
parameter_list|(
name|kmutex_t
modifier|*
name|mp
parameter_list|)
function_decl|;
specifier|extern
name|void
name|zmutex_destroy
parameter_list|(
name|kmutex_t
modifier|*
name|mp
parameter_list|)
function_decl|;
specifier|extern
name|void
name|mutex_enter
parameter_list|(
name|kmutex_t
modifier|*
name|mp
parameter_list|)
function_decl|;
specifier|extern
name|void
name|mutex_exit
parameter_list|(
name|kmutex_t
modifier|*
name|mp
parameter_list|)
function_decl|;
specifier|extern
name|int
name|mutex_tryenter
parameter_list|(
name|kmutex_t
modifier|*
name|mp
parameter_list|)
function_decl|;
specifier|extern
name|void
modifier|*
name|mutex_owner
parameter_list|(
name|kmutex_t
modifier|*
name|mp
parameter_list|)
function_decl|;
comment|/*  * RW locks  */
typedef|typedef
struct|struct
name|krwlock
block|{
name|int
name|rw_count
decl_stmt|;
name|void
modifier|*
name|rw_owner
decl_stmt|;
name|rwlock_t
name|rw_lock
decl_stmt|;
block|}
name|krwlock_t
typedef|;
typedef|typedef
name|int
name|krw_t
typedef|;
define|#
directive|define
name|RW_READER
value|0
define|#
directive|define
name|RW_WRITER
value|1
define|#
directive|define
name|RW_DEFAULT
value|USYNC_THREAD
undef|#
directive|undef
name|RW_READ_HELD
undef|#
directive|undef
name|RW_WRITE_HELD
define|#
directive|define
name|RW_WRITE_HELD
parameter_list|(
name|x
parameter_list|)
value|((x)->rw_owner == curthread)
define|#
directive|define
name|RW_LOCK_HELD
parameter_list|(
name|x
parameter_list|)
value|rw_lock_held(x)
specifier|extern
name|void
name|rw_init
parameter_list|(
name|krwlock_t
modifier|*
name|rwlp
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|int
name|type
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
specifier|extern
name|void
name|rw_destroy
parameter_list|(
name|krwlock_t
modifier|*
name|rwlp
parameter_list|)
function_decl|;
specifier|extern
name|void
name|rw_enter
parameter_list|(
name|krwlock_t
modifier|*
name|rwlp
parameter_list|,
name|krw_t
name|rw
parameter_list|)
function_decl|;
specifier|extern
name|int
name|rw_tryenter
parameter_list|(
name|krwlock_t
modifier|*
name|rwlp
parameter_list|,
name|krw_t
name|rw
parameter_list|)
function_decl|;
specifier|extern
name|int
name|rw_tryupgrade
parameter_list|(
name|krwlock_t
modifier|*
name|rwlp
parameter_list|)
function_decl|;
specifier|extern
name|void
name|rw_exit
parameter_list|(
name|krwlock_t
modifier|*
name|rwlp
parameter_list|)
function_decl|;
specifier|extern
name|int
name|rw_lock_held
parameter_list|(
name|krwlock_t
modifier|*
name|rwlp
parameter_list|)
function_decl|;
define|#
directive|define
name|rw_downgrade
parameter_list|(
name|rwlp
parameter_list|)
value|do { } while (0)
comment|/*  * Condition variables  */
typedef|typedef
name|cond_t
name|kcondvar_t
typedef|;
define|#
directive|define
name|CV_DEFAULT
value|USYNC_THREAD
specifier|extern
name|void
name|cv_init
parameter_list|(
name|kcondvar_t
modifier|*
name|cv
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|int
name|type
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
specifier|extern
name|void
name|cv_destroy
parameter_list|(
name|kcondvar_t
modifier|*
name|cv
parameter_list|)
function_decl|;
specifier|extern
name|void
name|cv_wait
parameter_list|(
name|kcondvar_t
modifier|*
name|cv
parameter_list|,
name|kmutex_t
modifier|*
name|mp
parameter_list|)
function_decl|;
specifier|extern
name|clock_t
name|cv_timedwait
parameter_list|(
name|kcondvar_t
modifier|*
name|cv
parameter_list|,
name|kmutex_t
modifier|*
name|mp
parameter_list|,
name|clock_t
name|abstime
parameter_list|)
function_decl|;
specifier|extern
name|void
name|cv_signal
parameter_list|(
name|kcondvar_t
modifier|*
name|cv
parameter_list|)
function_decl|;
specifier|extern
name|void
name|cv_broadcast
parameter_list|(
name|kcondvar_t
modifier|*
name|cv
parameter_list|)
function_decl|;
comment|/*  * Kernel memory  */
define|#
directive|define
name|KM_SLEEP
value|UMEM_NOFAIL
define|#
directive|define
name|KM_NOSLEEP
value|UMEM_DEFAULT
define|#
directive|define
name|KMC_NODEBUG
value|UMC_NODEBUG
define|#
directive|define
name|kmem_alloc
parameter_list|(
name|_s
parameter_list|,
name|_f
parameter_list|)
value|umem_alloc(_s, _f)
define|#
directive|define
name|kmem_zalloc
parameter_list|(
name|_s
parameter_list|,
name|_f
parameter_list|)
value|umem_zalloc(_s, _f)
define|#
directive|define
name|kmem_free
parameter_list|(
name|_b
parameter_list|,
name|_s
parameter_list|)
value|umem_free(_b, _s)
define|#
directive|define
name|kmem_cache_create
parameter_list|(
name|_a
parameter_list|,
name|_b
parameter_list|,
name|_c
parameter_list|,
name|_d
parameter_list|,
name|_e
parameter_list|,
name|_f
parameter_list|,
name|_g
parameter_list|,
name|_h
parameter_list|,
name|_i
parameter_list|)
define|\
value|umem_cache_create(_a, _b, _c, _d, _e, _f, _g, _h, _i)
define|#
directive|define
name|kmem_cache_destroy
parameter_list|(
name|_c
parameter_list|)
value|umem_cache_destroy(_c)
define|#
directive|define
name|kmem_cache_alloc
parameter_list|(
name|_c
parameter_list|,
name|_f
parameter_list|)
value|umem_cache_alloc(_c, _f)
define|#
directive|define
name|kmem_cache_free
parameter_list|(
name|_c
parameter_list|,
name|_b
parameter_list|)
value|umem_cache_free(_c, _b)
define|#
directive|define
name|kmem_debugging
parameter_list|()
value|0
define|#
directive|define
name|kmem_cache_reap_now
parameter_list|(
name|c
parameter_list|)
typedef|typedef
name|umem_cache_t
name|kmem_cache_t
typedef|;
comment|/*  * Task queues  */
typedef|typedef
name|struct
name|taskq
name|taskq_t
typedef|;
typedef|typedef
name|uintptr_t
name|taskqid_t
typedef|;
typedef|typedef
name|void
function_decl|(
name|task_func_t
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
define|#
directive|define
name|TASKQ_PREPOPULATE
value|0x0001
define|#
directive|define
name|TASKQ_CPR_SAFE
value|0x0002
comment|/* Use CPR safe protocol */
define|#
directive|define
name|TASKQ_DYNAMIC
value|0x0004
comment|/* Use dynamic thread scheduling */
define|#
directive|define
name|TQ_SLEEP
value|KM_SLEEP
comment|/* Can block for memory */
define|#
directive|define
name|TQ_NOSLEEP
value|KM_NOSLEEP
comment|/* cannot block for memory; may fail */
define|#
directive|define
name|TQ_NOQUEUE
value|0x02
comment|/* Do not enqueue if can't dispatch */
specifier|extern
name|taskq_t
modifier|*
name|taskq_create
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|pri_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|uint_t
parameter_list|)
function_decl|;
specifier|extern
name|taskqid_t
name|taskq_dispatch
parameter_list|(
name|taskq_t
modifier|*
parameter_list|,
name|task_func_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|uint_t
parameter_list|)
function_decl|;
specifier|extern
name|void
name|taskq_destroy
parameter_list|(
name|taskq_t
modifier|*
parameter_list|)
function_decl|;
specifier|extern
name|void
name|taskq_wait
parameter_list|(
name|taskq_t
modifier|*
parameter_list|)
function_decl|;
specifier|extern
name|int
name|taskq_member
parameter_list|(
name|taskq_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
comment|/*  * vnodes  */
typedef|typedef
struct|struct
name|vnode
block|{
name|uint64_t
name|v_size
decl_stmt|;
name|int
name|v_fd
decl_stmt|;
name|char
modifier|*
name|v_path
decl_stmt|;
block|}
name|vnode_t
typedef|;
typedef|typedef
struct|struct
name|vattr
block|{
name|uint_t
name|va_mask
decl_stmt|;
comment|/* bit-mask of attributes */
name|u_offset_t
name|va_size
decl_stmt|;
comment|/* file size in bytes */
block|}
name|vattr_t
typedef|;
define|#
directive|define
name|AT_TYPE
value|0x0001
define|#
directive|define
name|AT_MODE
value|0x0002
define|#
directive|define
name|AT_UID
value|0x0004
define|#
directive|define
name|AT_GID
value|0x0008
define|#
directive|define
name|AT_FSID
value|0x0010
define|#
directive|define
name|AT_NODEID
value|0x0020
define|#
directive|define
name|AT_NLINK
value|0x0040
define|#
directive|define
name|AT_SIZE
value|0x0080
define|#
directive|define
name|AT_ATIME
value|0x0100
define|#
directive|define
name|AT_MTIME
value|0x0200
define|#
directive|define
name|AT_CTIME
value|0x0400
define|#
directive|define
name|AT_RDEV
value|0x0800
define|#
directive|define
name|AT_BLKSIZE
value|0x1000
define|#
directive|define
name|AT_NBLOCKS
value|0x2000
define|#
directive|define
name|AT_SEQ
value|0x8000
define|#
directive|define
name|CRCREAT
value|0
define|#
directive|define
name|VOP_CLOSE
parameter_list|(
name|vp
parameter_list|,
name|f
parameter_list|,
name|c
parameter_list|,
name|o
parameter_list|,
name|cr
parameter_list|)
value|0
define|#
directive|define
name|VOP_PUTPAGE
parameter_list|(
name|vp
parameter_list|,
name|of
parameter_list|,
name|sz
parameter_list|,
name|fl
parameter_list|,
name|cr
parameter_list|)
value|0
define|#
directive|define
name|VOP_GETATTR
parameter_list|(
name|vp
parameter_list|,
name|vap
parameter_list|,
name|fl
parameter_list|,
name|cr
parameter_list|)
value|((vap)->va_size = (vp)->v_size, 0)
define|#
directive|define
name|VOP_FSYNC
parameter_list|(
name|vp
parameter_list|,
name|f
parameter_list|,
name|cr
parameter_list|)
value|fsync((vp)->v_fd)
define|#
directive|define
name|VN_RELE
parameter_list|(
name|vp
parameter_list|)
value|vn_close(vp)
specifier|extern
name|int
name|vn_open
parameter_list|(
name|char
modifier|*
name|path
parameter_list|,
name|int
name|x1
parameter_list|,
name|int
name|oflags
parameter_list|,
name|int
name|mode
parameter_list|,
name|vnode_t
modifier|*
modifier|*
name|vpp
parameter_list|,
name|int
name|x2
parameter_list|,
name|int
name|x3
parameter_list|)
function_decl|;
specifier|extern
name|int
name|vn_openat
parameter_list|(
name|char
modifier|*
name|path
parameter_list|,
name|int
name|x1
parameter_list|,
name|int
name|oflags
parameter_list|,
name|int
name|mode
parameter_list|,
name|vnode_t
modifier|*
modifier|*
name|vpp
parameter_list|,
name|int
name|x2
parameter_list|,
name|int
name|x3
parameter_list|,
name|vnode_t
modifier|*
name|vp
parameter_list|)
function_decl|;
specifier|extern
name|int
name|vn_rdwr
parameter_list|(
name|int
name|uio
parameter_list|,
name|vnode_t
modifier|*
name|vp
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|ssize_t
name|len
parameter_list|,
name|offset_t
name|offset
parameter_list|,
name|int
name|x1
parameter_list|,
name|int
name|x2
parameter_list|,
name|rlim64_t
name|x3
parameter_list|,
name|void
modifier|*
name|x4
parameter_list|,
name|ssize_t
modifier|*
name|residp
parameter_list|)
function_decl|;
specifier|extern
name|void
name|vn_close
parameter_list|(
name|vnode_t
modifier|*
name|vp
parameter_list|)
function_decl|;
define|#
directive|define
name|vn_remove
parameter_list|(
name|path
parameter_list|,
name|x1
parameter_list|,
name|x2
parameter_list|)
value|remove(path)
define|#
directive|define
name|vn_rename
parameter_list|(
name|from
parameter_list|,
name|to
parameter_list|,
name|seg
parameter_list|)
value|rename((from), (to))
define|#
directive|define
name|vn_is_readonly
parameter_list|(
name|vp
parameter_list|)
value|B_FALSE
specifier|extern
name|vnode_t
modifier|*
name|rootdir
decl_stmt|;
include|#
directive|include
file|<sys/file.h>
comment|/* for FREAD, FWRITE, etc */
define|#
directive|define
name|FTRUNC
value|O_TRUNC
comment|/*  * Random stuff  */
define|#
directive|define
name|lbolt
value|(gethrtime()>> 23)
define|#
directive|define
name|lbolt64
value|(gethrtime()>> 23)
comment|//#define	hz	119	/* frequency when using gethrtime()>> 23 for lbolt */
specifier|extern
name|void
name|delay
parameter_list|(
name|clock_t
name|ticks
parameter_list|)
function_decl|;
define|#
directive|define
name|gethrestime_sec
parameter_list|()
value|time(NULL)
define|#
directive|define
name|max_ncpus
value|64
define|#
directive|define
name|minclsyspri
value|60
define|#
directive|define
name|maxclsyspri
value|99
define|#
directive|define
name|CPU_SEQID
value|(thr_self()& (max_ncpus - 1))
define|#
directive|define
name|kcred
value|NULL
define|#
directive|define
name|CRED
parameter_list|()
value|NULL
specifier|extern
name|uint64_t
name|physmem
decl_stmt|;
specifier|extern
name|int
name|highbit
parameter_list|(
name|ulong_t
name|i
parameter_list|)
function_decl|;
specifier|extern
name|int
name|random_get_bytes
parameter_list|(
name|uint8_t
modifier|*
name|ptr
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
specifier|extern
name|int
name|random_get_pseudo_bytes
parameter_list|(
name|uint8_t
modifier|*
name|ptr
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
specifier|extern
name|void
name|kernel_init
parameter_list|(
name|int
parameter_list|)
function_decl|;
specifier|extern
name|void
name|kernel_fini
parameter_list|(
name|void
parameter_list|)
function_decl|;
struct_decl|struct
name|spa
struct_decl|;
specifier|extern
name|void
name|nicenum
parameter_list|(
name|uint64_t
name|num
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
specifier|extern
name|void
name|show_pool_stats
parameter_list|(
name|struct
name|spa
modifier|*
parameter_list|)
function_decl|;
typedef|typedef
struct|struct
name|callb_cpr
block|{
name|kmutex_t
modifier|*
name|cc_lockp
decl_stmt|;
block|}
name|callb_cpr_t
typedef|;
define|#
directive|define
name|CALLB_CPR_INIT
parameter_list|(
name|cp
parameter_list|,
name|lockp
parameter_list|,
name|func
parameter_list|,
name|name
parameter_list|)
value|{		\ 	(cp)->cc_lockp = lockp;					\ }
define|#
directive|define
name|CALLB_CPR_SAFE_BEGIN
parameter_list|(
name|cp
parameter_list|)
value|{				\ 	ASSERT(MUTEX_HELD((cp)->cc_lockp));			\ }
define|#
directive|define
name|CALLB_CPR_SAFE_END
parameter_list|(
name|cp
parameter_list|,
name|lockp
parameter_list|)
value|{				\ 	ASSERT(MUTEX_HELD((cp)->cc_lockp));			\ }
define|#
directive|define
name|CALLB_CPR_EXIT
parameter_list|(
name|cp
parameter_list|)
value|{					\ 	ASSERT(MUTEX_HELD((cp)->cc_lockp));			\ 	mutex_exit((cp)->cc_lockp);				\ }
define|#
directive|define
name|zone_dataset_visible
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(1)
define|#
directive|define
name|INGLOBALZONE
parameter_list|(
name|z
parameter_list|)
value|(1)
comment|/*  * Hostname information  */
specifier|extern
name|struct
name|utsname
name|utsname
decl_stmt|;
specifier|extern
name|char
name|hw_serial
index|[]
decl_stmt|;
specifier|extern
name|int
name|ddi_strtoul
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|char
modifier|*
modifier|*
name|nptr
parameter_list|,
name|int
name|base
parameter_list|,
name|unsigned
name|long
modifier|*
name|result
parameter_list|)
function_decl|;
ifdef|#
directive|ifdef
name|__cplusplus
block|}
end_extern

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ZFS Boot Related stuff. */
end_comment

begin_struct
struct|struct
name|_buf
block|{
name|intptr_t
name|_fd
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bootstat
block|{
name|uint64_t
name|st_size
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|extern
name|struct
name|_buf
modifier|*
name|kobj_open_file
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|kobj_read_file
parameter_list|(
name|struct
name|_buf
modifier|*
name|file
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|size
parameter_list|,
name|unsigned
name|off
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|kobj_close_file
parameter_list|(
name|struct
name|_buf
modifier|*
name|file
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|kobj_get_filesize
parameter_list|(
name|struct
name|_buf
modifier|*
name|file
parameter_list|,
name|uint64_t
modifier|*
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Random compatibility stuff. */
end_comment

begin_define
define|#
directive|define
name|lbolt
value|(gethrtime()>> 23)
end_define

begin_define
define|#
directive|define
name|lbolt64
value|(gethrtime()>> 23)
end_define

begin_decl_stmt
specifier|extern
name|int
name|hz
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint64_t
name|physmem
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|gethrestime_sec
parameter_list|()
value|time(NULL)
end_define

begin_define
define|#
directive|define
name|open64
parameter_list|(
modifier|...
parameter_list|)
value|open(__VA_ARGS__)
end_define

begin_define
define|#
directive|define
name|pread64
parameter_list|(
name|d
parameter_list|,
name|p
parameter_list|,
name|n
parameter_list|,
name|o
parameter_list|)
value|pread(d, p, n, o)
end_define

begin_define
define|#
directive|define
name|pwrite64
parameter_list|(
name|d
parameter_list|,
name|p
parameter_list|,
name|n
parameter_list|,
name|o
parameter_list|)
value|pwrite(d, p, n, o)
end_define

begin_define
define|#
directive|define
name|readdir64
parameter_list|(
name|d
parameter_list|)
value|readdir(d)
end_define

begin_define
define|#
directive|define
name|SIGPENDING
parameter_list|(
name|td
parameter_list|)
value|(0)
end_define

begin_define
define|#
directive|define
name|root_mount_wait
parameter_list|()
value|do { } while (0)
end_define

begin_struct
struct|struct
name|file
block|{
name|void
modifier|*
name|dummy
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|FCREAT
value|O_CREAT
end_define

begin_define
define|#
directive|define
name|FOFFMAX
value|0x0
end_define

begin_define
define|#
directive|define
name|SX_SYSINIT
parameter_list|(
name|name
parameter_list|,
name|lock
parameter_list|,
name|desc
parameter_list|)
end_define

begin_define
define|#
directive|define
name|SYSCTL_DECL
parameter_list|(
modifier|...
parameter_list|)
end_define

begin_define
define|#
directive|define
name|SYSCTL_INT
parameter_list|(
modifier|...
parameter_list|)
end_define

begin_define
define|#
directive|define
name|SYSCTL_NODE
parameter_list|(
modifier|...
parameter_list|)
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|TUNABLE_INT
end_ifdef

begin_undef
undef|#
directive|undef
name|TUNABLE_INT
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|TUNABLE_INT
parameter_list|(
modifier|...
parameter_list|)
end_define

begin_comment
comment|/* Errors */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|ERESTART
end_ifndef

begin_define
define|#
directive|define
name|ERESTART
value|(-1)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _SYS_ZFS_CONTEXT_H */
end_comment

end_unit


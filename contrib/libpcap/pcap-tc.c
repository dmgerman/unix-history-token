begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2008 CACE Technologies, Davis (California)  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  * notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  * notice, this list of conditions and the following disclaimer in the  * documentation and/or other materials provided with the distribution.  * 3. Neither the name of CACE Technologies nor the names of its  * contributors may be used to endorse or promote products derived from  * this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<pcap.h>
end_include

begin_include
include|#
directive|include
file|<pcap-int.h>
end_include

begin_include
include|#
directive|include
file|"pcap-tc.h"
end_include

begin_include
include|#
directive|include
file|<malloc.h>
end_include

begin_include
include|#
directive|include
file|<memory.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32
end_ifdef

begin_include
include|#
directive|include
file|<tchar.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnQueryPortList
function_decl|)
parameter_list|(
name|PTC_PORT
modifier|*
name|ppPorts
parameter_list|,
name|PULONG
name|pLength
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnFreePortList
function_decl|)
parameter_list|(
name|TC_PORT
modifier|*
name|pPorts
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|PCHAR
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnStatusGetString
function_decl|)
parameter_list|(
name|TC_STATUS
name|status
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|PCHAR
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnPortGetName
function_decl|)
parameter_list|(
name|TC_PORT
name|port
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|PCHAR
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnPortGetDescription
function_decl|)
parameter_list|(
name|TC_PORT
name|port
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnInstanceOpenByName
function_decl|)
parameter_list|(
name|PCHAR
name|name
parameter_list|,
name|PTC_INSTANCE
name|pInstance
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnInstanceClose
function_decl|)
parameter_list|(
name|TC_INSTANCE
name|instance
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnInstanceSetFeature
function_decl|)
parameter_list|(
name|TC_INSTANCE
name|instance
parameter_list|,
name|ULONG
name|feature
parameter_list|,
name|ULONG
name|value
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnInstanceQueryFeature
function_decl|)
parameter_list|(
name|TC_INSTANCE
name|instance
parameter_list|,
name|ULONG
name|feature
parameter_list|,
name|PULONG
name|pValue
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnInstanceReceivePackets
function_decl|)
parameter_list|(
name|TC_INSTANCE
name|instance
parameter_list|,
name|PTC_PACKETS_BUFFER
name|pBuffer
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|HANDLE
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnInstanceGetReceiveWaitHandle
function_decl|)
parameter_list|(
name|TC_INSTANCE
name|instance
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnInstanceTransmitPackets
function_decl|)
parameter_list|(
name|TC_INSTANCE
name|instance
parameter_list|,
name|TC_PACKETS_BUFFER
name|pBuffer
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnInstanceQueryStatistics
function_decl|)
parameter_list|(
name|TC_INSTANCE
name|instance
parameter_list|,
name|PTC_STATISTICS
name|pStatistics
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnPacketsBufferCreate
function_decl|)
parameter_list|(
name|ULONG
name|size
parameter_list|,
name|PTC_PACKETS_BUFFER
name|pBuffer
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|VOID
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnPacketsBufferDestroy
function_decl|)
parameter_list|(
name|TC_PACKETS_BUFFER
name|buffer
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnPacketsBufferQueryNextPacket
function_decl|)
parameter_list|(
name|TC_PACKETS_BUFFER
name|buffer
parameter_list|,
name|PTC_PACKET_HEADER
name|pHeader
parameter_list|,
name|PVOID
modifier|*
name|ppData
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnPacketsBufferCommitNextPacket
function_decl|)
parameter_list|(
name|TC_PACKETS_BUFFER
name|buffer
parameter_list|,
name|PTC_PACKET_HEADER
name|pHeader
parameter_list|,
name|PVOID
name|pData
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|VOID
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnStatisticsDestroy
function_decl|)
parameter_list|(
name|TC_STATISTICS
name|statistics
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnStatisticsUpdate
function_decl|)
parameter_list|(
name|TC_STATISTICS
name|statistics
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|TC_STATUS
function_decl|(
name|TC_CALLCONV
modifier|*
name|TcFcnStatisticsQueryValue
function_decl|)
parameter_list|(
name|TC_STATISTICS
name|statistics
parameter_list|,
name|ULONG
name|counterId
parameter_list|,
name|PULONGLONG
name|pValue
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|LONG
block|{
name|TC_API_UNLOADED
init|=
literal|0
block|,
name|TC_API_LOADED
block|,
name|TC_API_CANNOT_LOAD
block|,
name|TC_API_LOADING
block|}
name|TC_API_LOAD_STATUS
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_TC_FUNCTIONS
block|{
name|TC_API_LOAD_STATUS
name|LoadStatus
decl_stmt|;
ifdef|#
directive|ifdef
name|_WIN32
name|HMODULE
name|hTcApiDllHandle
decl_stmt|;
endif|#
directive|endif
name|TcFcnQueryPortList
name|QueryPortList
decl_stmt|;
name|TcFcnFreePortList
name|FreePortList
decl_stmt|;
name|TcFcnStatusGetString
name|StatusGetString
decl_stmt|;
name|TcFcnPortGetName
name|PortGetName
decl_stmt|;
name|TcFcnPortGetDescription
name|PortGetDescription
decl_stmt|;
name|TcFcnInstanceOpenByName
name|InstanceOpenByName
decl_stmt|;
name|TcFcnInstanceClose
name|InstanceClose
decl_stmt|;
name|TcFcnInstanceSetFeature
name|InstanceSetFeature
decl_stmt|;
name|TcFcnInstanceQueryFeature
name|InstanceQueryFeature
decl_stmt|;
name|TcFcnInstanceReceivePackets
name|InstanceReceivePackets
decl_stmt|;
ifdef|#
directive|ifdef
name|_WIN32
name|TcFcnInstanceGetReceiveWaitHandle
name|InstanceGetReceiveWaitHandle
decl_stmt|;
endif|#
directive|endif
name|TcFcnInstanceTransmitPackets
name|InstanceTransmitPackets
decl_stmt|;
name|TcFcnInstanceQueryStatistics
name|InstanceQueryStatistics
decl_stmt|;
name|TcFcnPacketsBufferCreate
name|PacketsBufferCreate
decl_stmt|;
name|TcFcnPacketsBufferDestroy
name|PacketsBufferDestroy
decl_stmt|;
name|TcFcnPacketsBufferQueryNextPacket
name|PacketsBufferQueryNextPacket
decl_stmt|;
name|TcFcnPacketsBufferCommitNextPacket
name|PacketsBufferCommitNextPacket
decl_stmt|;
name|TcFcnStatisticsDestroy
name|StatisticsDestroy
decl_stmt|;
name|TcFcnStatisticsUpdate
name|StatisticsUpdate
decl_stmt|;
name|TcFcnStatisticsQueryValue
name|StatisticsQueryValue
decl_stmt|;
block|}
name|TC_FUNCTIONS
typedef|;
end_typedef

begin_function_decl
specifier|static
name|pcap_if_t
modifier|*
name|TcCreatePcapIfFromPort
parameter_list|(
name|TC_PORT
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcSetDatalink
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|dlt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcGetNonBlock
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|errbuf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcSetNonBlock
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|nonblock
parameter_list|,
name|char
modifier|*
name|errbuf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|TcCleanup
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcInject
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcRead
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|cnt
parameter_list|,
name|pcap_handler
name|callback
parameter_list|,
name|u_char
modifier|*
name|user
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcStats
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|struct
name|pcap_stat
modifier|*
name|ps
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcSetFilter
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|struct
name|bpf_program
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32
end_ifdef

begin_function_decl
specifier|static
name|struct
name|pcap_stat
modifier|*
name|TcStatsEx
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
modifier|*
name|pcap_stat_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcSetBuff
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|dim
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcSetMode
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcSetMinToCopy
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|HANDLE
name|TcGetReceiveWaitHandle
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcOidGetRequest
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|bpf_u_int32
name|oid
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
modifier|*
name|lenp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcOidSetRequest
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|bpf_u_int32
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
modifier|*
name|lenp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int
name|TcSendqueueTransmit
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|pcap_send_queue
modifier|*
name|queue
parameter_list|,
name|int
name|sync
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcSetUserBuffer
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcLiveDump
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|maxsize
parameter_list|,
name|int
name|maxpacks
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcLiveDumpEnded
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|sync
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|PAirpcapHandle
name|TcGetAirPcapHandle
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32
end_ifdef

begin_decl_stmt
name|TC_FUNCTIONS
name|g_TcFunctions
init|=
block|{
name|TC_API_UNLOADED
block|,
comment|/* LoadStatus */
name|NULL
block|,
comment|/* hTcApiDllHandle */
name|NULL
block|,
comment|/* QueryPortList */
name|NULL
block|,
comment|/* FreePortList */
name|NULL
block|,
comment|/* StatusGetString */
name|NULL
block|,
comment|/* PortGetName */
name|NULL
block|,
comment|/* PortGetDescription */
name|NULL
block|,
comment|/* InstanceOpenByName */
name|NULL
block|,
comment|/* InstanceClose */
name|NULL
block|,
comment|/* InstanceSetFeature */
name|NULL
block|,
comment|/* InstanceQueryFeature */
name|NULL
block|,
comment|/* InstanceReceivePackets */
name|NULL
block|,
comment|/* InstanceGetReceiveWaitHandle */
name|NULL
block|,
comment|/* InstanceTransmitPackets */
name|NULL
block|,
comment|/* InstanceQueryStatistics */
name|NULL
block|,
comment|/* PacketsBufferCreate */
name|NULL
block|,
comment|/* PacketsBufferDestroy */
name|NULL
block|,
comment|/* PacketsBufferQueryNextPacket */
name|NULL
block|,
comment|/* PacketsBufferCommitNextPacket */
name|NULL
block|,
comment|/* StatisticsDestroy */
name|NULL
block|,
comment|/* StatisticsUpdate */
name|NULL
comment|/* StatisticsQueryValue */
block|}
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|TC_FUNCTIONS
name|g_TcFunctions
init|=
block|{
name|TC_API_LOADED
block|,
comment|/* LoadStatus */
name|TcQueryPortList
block|,
name|TcFreePortList
block|,
name|TcStatusGetString
block|,
name|TcPortGetName
block|,
name|TcPortGetDescription
block|,
name|TcInstanceOpenByName
block|,
name|TcInstanceClose
block|,
name|TcInstanceSetFeature
block|,
name|TcInstanceQueryFeature
block|,
name|TcInstanceReceivePackets
block|,
ifdef|#
directive|ifdef
name|_WIN32
name|TcInstanceGetReceiveWaitHandle
block|,
endif|#
directive|endif
name|TcInstanceTransmitPackets
block|,
name|TcInstanceQueryStatistics
block|,
name|TcPacketsBufferCreate
block|,
name|TcPacketsBufferDestroy
block|,
name|TcPacketsBufferQueryNextPacket
block|,
name|TcPacketsBufferCommitNextPacket
block|,
name|TcStatisticsDestroy
block|,
name|TcStatisticsUpdate
block|,
name|TcStatisticsQueryValue
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAX_TC_PACKET_SIZE
value|9500
end_define

begin_pragma
pragma|#
directive|pragma
name|pack
name|(
name|push
name|,
name|1
name|)
end_pragma

begin_define
define|#
directive|define
name|PPH_PH_FLAG_PADDING
value|((UCHAR)0x01)
end_define

begin_define
define|#
directive|define
name|PPH_PH_VERSION
value|((UCHAR)0x00)
end_define

begin_typedef
typedef|typedef
struct|struct
name|_PPI_PACKET_HEADER
block|{
name|UCHAR
name|PphVersion
decl_stmt|;
name|UCHAR
name|PphFlags
decl_stmt|;
name|USHORT
name|PphLength
decl_stmt|;
name|ULONG
name|PphDlt
decl_stmt|;
block|}
name|PPI_PACKET_HEADER
operator|,
typedef|*
name|PPPI_PACKET_HEADER
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_PPI_FIELD_HEADER
block|{
name|USHORT
name|PfhType
decl_stmt|;
name|USHORT
name|PfhLength
decl_stmt|;
block|}
name|PPI_FIELD_HEADER
operator|,
typedef|*
name|PPPI_FIELD_HEADER
typedef|;
end_typedef

begin_define
define|#
directive|define
name|PPI_FIELD_TYPE_AGGREGATION_EXTENSION
value|((UCHAR)0x08)
end_define

begin_typedef
typedef|typedef
struct|struct
name|_PPI_FIELD_AGGREGATION_EXTENSION
block|{
name|ULONG
name|InterfaceId
decl_stmt|;
block|}
name|PPI_FIELD_AGGREGATION_EXTENSION
operator|,
typedef|*
name|PPPI_FIELD_AGGREGATION_EXTENSION
typedef|;
end_typedef

begin_define
define|#
directive|define
name|PPI_FIELD_TYPE_802_3_EXTENSION
value|((UCHAR)0x09)
end_define

begin_define
define|#
directive|define
name|PPI_FLD_802_3_EXT_FLAG_FCS_PRESENT
value|((ULONG)0x00000001)
end_define

begin_typedef
typedef|typedef
struct|struct
name|_PPI_FIELD_802_3_EXTENSION
block|{
name|ULONG
name|Flags
decl_stmt|;
name|ULONG
name|Errors
decl_stmt|;
block|}
name|PPI_FIELD_802_3_EXTENSION
operator|,
typedef|*
name|PPPI_FIELD_802_3_EXTENSION
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_PPI_HEADER
block|{
name|PPI_PACKET_HEADER
name|PacketHeader
decl_stmt|;
name|PPI_FIELD_HEADER
name|AggregationFieldHeader
decl_stmt|;
name|PPI_FIELD_AGGREGATION_EXTENSION
name|AggregationField
decl_stmt|;
name|PPI_FIELD_HEADER
name|Dot3FieldHeader
decl_stmt|;
name|PPI_FIELD_802_3_EXTENSION
name|Dot3Field
decl_stmt|;
block|}
name|PPI_HEADER
operator|,
typedef|*
name|PPPI_HEADER
typedef|;
end_typedef

begin_pragma
pragma|#
directive|pragma
name|pack
name|(
name|pop
name|)
end_pragma

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32
end_ifdef

begin_comment
comment|//
end_comment

begin_comment
comment|// This wrapper around loadlibrary appends the system folder (usually c:\windows\system32)
end_comment

begin_comment
comment|// to the relative path of the DLL, so that the DLL is always loaded from an absolute path
end_comment

begin_comment
comment|// (It's no longer possible to load airpcap.dll from the application folder).
end_comment

begin_comment
comment|// This solves the DLL Hijacking issue discovered in August 2010
end_comment

begin_comment
comment|// http://blog.metasploit.com/2010/08/exploiting-dll-hijacking-flaws.html
end_comment

begin_comment
comment|//
end_comment

begin_function
name|HMODULE
name|LoadLibrarySafe
parameter_list|(
name|LPCTSTR
name|lpFileName
parameter_list|)
block|{
name|TCHAR
name|path
index|[
name|MAX_PATH
index|]
decl_stmt|;
name|TCHAR
name|fullFileName
index|[
name|MAX_PATH
index|]
decl_stmt|;
name|UINT
name|res
decl_stmt|;
name|HMODULE
name|hModule
init|=
name|NULL
decl_stmt|;
do|do
block|{
name|res
operator|=
name|GetSystemDirectory
argument_list|(
name|path
argument_list|,
name|MAX_PATH
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
comment|//
comment|// some bad failure occurred;
comment|//
break|break;
block|}
if|if
condition|(
name|res
operator|>
name|MAX_PATH
condition|)
block|{
comment|//
comment|// the buffer was not big enough
comment|//
name|SetLastError
argument_list|(
name|ERROR_INSUFFICIENT_BUFFER
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|res
operator|+
literal|1
operator|+
name|_tcslen
argument_list|(
name|lpFileName
argument_list|)
operator|+
literal|1
operator|<
name|MAX_PATH
condition|)
block|{
name|memcpy
argument_list|(
name|fullFileName
argument_list|,
name|path
argument_list|,
name|res
operator|*
sizeof|sizeof
argument_list|(
name|TCHAR
argument_list|)
argument_list|)
expr_stmt|;
name|fullFileName
index|[
name|res
index|]
operator|=
name|_T
argument_list|(
literal|'\\'
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|fullFileName
index|[
name|res
operator|+
literal|1
index|]
argument_list|,
name|lpFileName
argument_list|,
operator|(
name|_tcslen
argument_list|(
name|lpFileName
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|TCHAR
argument_list|)
argument_list|)
expr_stmt|;
name|hModule
operator|=
name|LoadLibrary
argument_list|(
name|fullFileName
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SetLastError
argument_list|(
name|ERROR_INSUFFICIENT_BUFFER
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|FALSE
condition|)
do|;
return|return
name|hModule
return|;
block|}
end_function

begin_comment
comment|/*  * NOTE: this function should be called by the pcap functions that can theoretically  *       deal with the Tc library for the first time, namely listing the adapters and  *       opening one. All the other ones (close, read, write, set parameters) work  *       on an open instance of TC, so we do not care to call this function  */
end_comment

begin_function
name|TC_API_LOAD_STATUS
name|LoadTcFunctions
parameter_list|(
name|void
parameter_list|)
block|{
name|TC_API_LOAD_STATUS
name|currentStatus
decl_stmt|;
do|do
block|{
name|currentStatus
operator|=
name|InterlockedCompareExchange
argument_list|(
operator|(
name|LONG
operator|*
operator|)
operator|&
name|g_TcFunctions
operator|.
name|LoadStatus
argument_list|,
name|TC_API_LOADING
argument_list|,
name|TC_API_UNLOADED
argument_list|)
expr_stmt|;
while|while
condition|(
name|currentStatus
operator|==
name|TC_API_LOADING
condition|)
block|{
name|currentStatus
operator|=
name|InterlockedCompareExchange
argument_list|(
operator|(
name|LONG
operator|*
operator|)
operator|&
name|g_TcFunctions
operator|.
name|LoadStatus
argument_list|,
name|TC_API_LOADING
argument_list|,
name|TC_API_LOADING
argument_list|)
expr_stmt|;
name|Sleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * at this point we are either in the LOADED state, unloaded state (i.e. we are the ones loading everything) 		 * or in cannot load 		 */
if|if
condition|(
name|currentStatus
operator|==
name|TC_API_LOADED
condition|)
block|{
return|return
name|TC_API_LOADED
return|;
block|}
if|if
condition|(
name|currentStatus
operator|==
name|TC_API_CANNOT_LOAD
condition|)
block|{
return|return
name|TC_API_CANNOT_LOAD
return|;
block|}
name|currentStatus
operator|=
name|TC_API_CANNOT_LOAD
expr_stmt|;
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
operator|=
name|LoadLibrarySafe
argument_list|(
literal|"TcApi.dll"
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
operator|==
name|NULL
condition|)
break|break;
name|g_TcFunctions
operator|.
name|QueryPortList
operator|=
operator|(
name|TcFcnQueryPortList
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcQueryPortList"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|FreePortList
operator|=
operator|(
name|TcFcnFreePortList
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcFreePortList"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|StatusGetString
operator|=
operator|(
name|TcFcnStatusGetString
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcStatusGetString"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|PortGetName
operator|=
operator|(
name|TcFcnPortGetName
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcPortGetName"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|PortGetDescription
operator|=
operator|(
name|TcFcnPortGetDescription
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcPortGetDescription"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|InstanceOpenByName
operator|=
operator|(
name|TcFcnInstanceOpenByName
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcInstanceOpenByName"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|InstanceClose
operator|=
operator|(
name|TcFcnInstanceClose
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcInstanceClose"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|InstanceSetFeature
operator|=
operator|(
name|TcFcnInstanceSetFeature
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcInstanceSetFeature"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|InstanceQueryFeature
operator|=
operator|(
name|TcFcnInstanceQueryFeature
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcInstanceQueryFeature"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|InstanceReceivePackets
operator|=
operator|(
name|TcFcnInstanceReceivePackets
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcInstanceReceivePackets"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|InstanceGetReceiveWaitHandle
operator|=
operator|(
name|TcFcnInstanceGetReceiveWaitHandle
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcInstanceGetReceiveWaitHandle"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|InstanceTransmitPackets
operator|=
operator|(
name|TcFcnInstanceTransmitPackets
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcInstanceTransmitPackets"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|InstanceQueryStatistics
operator|=
operator|(
name|TcFcnInstanceQueryStatistics
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcInstanceQueryStatistics"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|PacketsBufferCreate
operator|=
operator|(
name|TcFcnPacketsBufferCreate
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcPacketsBufferCreate"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|PacketsBufferDestroy
operator|=
operator|(
name|TcFcnPacketsBufferDestroy
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcPacketsBufferDestroy"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|PacketsBufferQueryNextPacket
operator|=
operator|(
name|TcFcnPacketsBufferQueryNextPacket
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcPacketsBufferQueryNextPacket"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|PacketsBufferCommitNextPacket
operator|=
operator|(
name|TcFcnPacketsBufferCommitNextPacket
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcPacketsBufferCommitNextPacket"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|StatisticsDestroy
operator|=
operator|(
name|TcFcnStatisticsDestroy
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcStatisticsDestroy"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|StatisticsUpdate
operator|=
operator|(
name|TcFcnStatisticsUpdate
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcStatisticsUpdate"
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|StatisticsQueryValue
operator|=
operator|(
name|TcFcnStatisticsQueryValue
operator|)
name|GetProcAddress
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|,
literal|"TcStatisticsQueryValue"
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_TcFunctions
operator|.
name|QueryPortList
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|FreePortList
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|StatusGetString
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|PortGetName
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|PortGetDescription
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|InstanceOpenByName
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|InstanceClose
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|InstanceSetFeature
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|InstanceQueryFeature
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|InstanceReceivePackets
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|InstanceGetReceiveWaitHandle
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|InstanceTransmitPackets
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|InstanceQueryStatistics
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|PacketsBufferCreate
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|PacketsBufferDestroy
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|PacketsBufferQueryNextPacket
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|PacketsBufferCommitNextPacket
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|StatisticsDestroy
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|StatisticsUpdate
operator|==
name|NULL
operator|||
name|g_TcFunctions
operator|.
name|StatisticsQueryValue
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
comment|/* 		 * everything got loaded, yay!! 		 */
name|currentStatus
operator|=
name|TC_API_LOADED
expr_stmt|;
block|}
do|while
condition|(
name|FALSE
condition|)
do|;
if|if
condition|(
name|currentStatus
operator|!=
name|TC_API_LOADED
condition|)
block|{
if|if
condition|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
operator|!=
name|NULL
condition|)
block|{
name|FreeLibrary
argument_list|(
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
argument_list|)
expr_stmt|;
name|g_TcFunctions
operator|.
name|hTcApiDllHandle
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|InterlockedExchange
argument_list|(
operator|(
name|LONG
operator|*
operator|)
operator|&
name|g_TcFunctions
operator|.
name|LoadStatus
argument_list|,
name|currentStatus
argument_list|)
expr_stmt|;
return|return
name|currentStatus
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|// static linking
end_comment

begin_function
name|TC_API_LOAD_STATUS
name|LoadTcFunctions
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|TC_API_LOADED
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Private data for capturing on TurboCap devices.  */
end_comment

begin_struct
struct|struct
name|pcap_tc
block|{
name|TC_INSTANCE
name|TcInstance
decl_stmt|;
name|TC_PACKETS_BUFFER
name|TcPacketsBuffer
decl_stmt|;
name|ULONG
name|TcAcceptedCount
decl_stmt|;
name|u_char
modifier|*
name|PpiPacket
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|int
name|TcFindAllDevs
parameter_list|(
name|pcap_if_t
modifier|*
modifier|*
name|alldevsp
parameter_list|,
name|char
modifier|*
name|errbuf
parameter_list|)
block|{
name|TC_API_LOAD_STATUS
name|loadStatus
decl_stmt|;
name|ULONG
name|numPorts
decl_stmt|;
name|PTC_PORT
name|pPorts
init|=
name|NULL
decl_stmt|;
name|TC_STATUS
name|status
decl_stmt|;
name|int
name|result
init|=
literal|0
decl_stmt|;
name|pcap_if_t
modifier|*
name|dev
decl_stmt|,
modifier|*
name|cursor
decl_stmt|;
name|ULONG
name|i
decl_stmt|;
do|do
block|{
name|loadStatus
operator|=
name|LoadTcFunctions
argument_list|()
expr_stmt|;
if|if
condition|(
name|loadStatus
operator|!=
name|TC_API_LOADED
condition|)
block|{
name|result
operator|=
literal|0
expr_stmt|;
break|break;
block|}
comment|/* 		 * enumerate the ports, and add them to the list 		 */
name|status
operator|=
name|g_TcFunctions
operator|.
name|QueryPortList
argument_list|(
operator|&
name|pPorts
argument_list|,
operator|&
name|numPorts
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|result
operator|=
literal|0
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numPorts
condition|;
name|i
operator|++
control|)
block|{
comment|/* 			 * transform the port into an entry in the list 			 */
name|dev
operator|=
name|TcCreatePcapIfFromPort
argument_list|(
name|pPorts
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|!=
name|NULL
condition|)
block|{
comment|/* 				 * append it at the end 				 */
if|if
condition|(
operator|*
name|alldevsp
operator|==
name|NULL
condition|)
block|{
operator|*
name|alldevsp
operator|=
name|dev
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|cursor
operator|=
operator|*
name|alldevsp
init|;
name|cursor
operator|->
name|next
operator|!=
name|NULL
condition|;
name|cursor
operator|=
name|cursor
operator|->
name|next
control|)
empty_stmt|;
name|cursor
operator|->
name|next
operator|=
name|dev
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|numPorts
operator|>
literal|0
condition|)
block|{
comment|/* 			 * ignore the result here 			 */
name|status
operator|=
name|g_TcFunctions
operator|.
name|FreePortList
argument_list|(
name|pPorts
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|FALSE
condition|)
do|;
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|pcap_if_t
modifier|*
name|TcCreatePcapIfFromPort
parameter_list|(
name|TC_PORT
name|port
parameter_list|)
block|{
name|CHAR
modifier|*
name|name
decl_stmt|;
name|CHAR
modifier|*
name|description
decl_stmt|;
name|pcap_if_t
modifier|*
name|newIf
init|=
name|NULL
decl_stmt|;
name|newIf
operator|=
operator|(
name|pcap_if_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|newIf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|newIf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|newIf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|newIf
argument_list|)
argument_list|)
expr_stmt|;
name|name
operator|=
name|g_TcFunctions
operator|.
name|PortGetName
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|description
operator|=
name|g_TcFunctions
operator|.
name|PortGetDescription
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|newIf
operator|->
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|newIf
operator|->
name|name
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|newIf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|newIf
operator|->
name|description
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|strlen
argument_list|(
name|description
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|newIf
operator|->
name|description
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|newIf
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newIf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|strcpy
argument_list|(
name|newIf
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|newIf
operator|->
name|description
argument_list|,
name|description
argument_list|)
expr_stmt|;
name|newIf
operator|->
name|addresses
operator|=
name|NULL
expr_stmt|;
name|newIf
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|newIf
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
return|return
name|newIf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcActivate
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|pcap_tc
modifier|*
name|pt
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|TC_STATUS
name|status
decl_stmt|;
name|ULONG
name|timeout
decl_stmt|;
name|PPPI_HEADER
name|pPpiHeader
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|opt
operator|.
name|rfmon
condition|)
block|{
comment|/* 		 * No monitor mode on Tc cards; they're Ethernet 		 * capture adapters. 		 */
return|return
name|PCAP_ERROR_RFMON_NOTSUP
return|;
block|}
name|pt
operator|->
name|PpiPacket
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|PPI_HEADER
argument_list|)
operator|+
name|MAX_TC_PACKET_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pt
operator|->
name|PpiPacket
operator|==
name|NULL
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Error allocating memory"
argument_list|)
expr_stmt|;
return|return
name|PCAP_ERROR
return|;
block|}
comment|/* 	 * Initialize the PPI fixed fields 	 */
name|pPpiHeader
operator|=
operator|(
name|PPPI_HEADER
operator|)
name|pt
operator|->
name|PpiPacket
expr_stmt|;
name|pPpiHeader
operator|->
name|PacketHeader
operator|.
name|PphDlt
operator|=
name|DLT_EN10MB
expr_stmt|;
name|pPpiHeader
operator|->
name|PacketHeader
operator|.
name|PphLength
operator|=
sizeof|sizeof
argument_list|(
name|PPI_HEADER
argument_list|)
expr_stmt|;
name|pPpiHeader
operator|->
name|PacketHeader
operator|.
name|PphFlags
operator|=
literal|0
expr_stmt|;
name|pPpiHeader
operator|->
name|PacketHeader
operator|.
name|PphVersion
operator|=
literal|0
expr_stmt|;
name|pPpiHeader
operator|->
name|AggregationFieldHeader
operator|.
name|PfhLength
operator|=
sizeof|sizeof
argument_list|(
name|PPI_FIELD_AGGREGATION_EXTENSION
argument_list|)
expr_stmt|;
name|pPpiHeader
operator|->
name|AggregationFieldHeader
operator|.
name|PfhType
operator|=
name|PPI_FIELD_TYPE_AGGREGATION_EXTENSION
expr_stmt|;
name|pPpiHeader
operator|->
name|Dot3FieldHeader
operator|.
name|PfhLength
operator|=
sizeof|sizeof
argument_list|(
name|PPI_FIELD_802_3_EXTENSION
argument_list|)
expr_stmt|;
name|pPpiHeader
operator|->
name|Dot3FieldHeader
operator|.
name|PfhType
operator|=
name|PPI_FIELD_TYPE_802_3_EXTENSION
expr_stmt|;
name|status
operator|=
name|g_TcFunctions
operator|.
name|InstanceOpenByName
argument_list|(
name|p
operator|->
name|opt
operator|.
name|device
argument_list|,
operator|&
name|pt
operator|->
name|TcInstance
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
comment|/* Adapter detected but we are not able to open it. Return failure. */
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Error opening TurboCap adapter: %s"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|PCAP_ERROR
return|;
block|}
name|p
operator|->
name|linktype
operator|=
name|DLT_EN10MB
expr_stmt|;
name|p
operator|->
name|dlt_list
operator|=
operator|(
name|u_int
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|u_int
argument_list|)
operator|*
literal|2
argument_list|)
expr_stmt|;
comment|/* 	 * If that fails, just leave the list empty. 	 */
if|if
condition|(
name|p
operator|->
name|dlt_list
operator|!=
name|NULL
condition|)
block|{
name|p
operator|->
name|dlt_list
index|[
literal|0
index|]
operator|=
name|DLT_EN10MB
expr_stmt|;
name|p
operator|->
name|dlt_list
index|[
literal|1
index|]
operator|=
name|DLT_PPI
expr_stmt|;
name|p
operator|->
name|dlt_count
operator|=
literal|2
expr_stmt|;
block|}
comment|/* 	 * ignore promiscuous mode 	 * p->opt.promisc 	 */
comment|/* 	 * ignore all the buffer sizes 	 */
comment|/* 	 * enable reception 	 */
name|status
operator|=
name|g_TcFunctions
operator|.
name|InstanceSetFeature
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|,
name|TC_INST_FT_RX_STATUS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Error enabling reception on a TurboCap instance: %s"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* 	 * enable transmission 	 */
name|status
operator|=
name|g_TcFunctions
operator|.
name|InstanceSetFeature
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|,
name|TC_INST_FT_TX_STATUS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Ignore the error here. 	 */
name|p
operator|->
name|inject_op
operator|=
name|TcInject
expr_stmt|;
comment|/* 	 * if the timeout is -1, it means immediate return, no timeout 	 * if the timeout is 0, it means INFINITE 	 */
if|if
condition|(
name|p
operator|->
name|opt
operator|.
name|timeout
operator|==
literal|0
condition|)
block|{
name|timeout
operator|=
literal|0xFFFFFFFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|opt
operator|.
name|timeout
operator|<
literal|0
condition|)
block|{
comment|/* 		 *  we insert a minimal timeout here 		 */
name|timeout
operator|=
literal|10
expr_stmt|;
block|}
else|else
block|{
name|timeout
operator|=
name|p
operator|->
name|opt
operator|.
name|timeout
expr_stmt|;
block|}
name|status
operator|=
name|g_TcFunctions
operator|.
name|InstanceSetFeature
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|,
name|TC_INST_FT_READ_TIMEOUT
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Error setting the read timeout a TurboCap instance: %s"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|p
operator|->
name|read_op
operator|=
name|TcRead
expr_stmt|;
name|p
operator|->
name|setfilter_op
operator|=
name|TcSetFilter
expr_stmt|;
name|p
operator|->
name|setdirection_op
operator|=
name|NULL
expr_stmt|;
comment|/* Not implemented. */
name|p
operator|->
name|set_datalink_op
operator|=
name|TcSetDatalink
expr_stmt|;
name|p
operator|->
name|getnonblock_op
operator|=
name|TcGetNonBlock
expr_stmt|;
name|p
operator|->
name|setnonblock_op
operator|=
name|TcSetNonBlock
expr_stmt|;
name|p
operator|->
name|stats_op
operator|=
name|TcStats
expr_stmt|;
ifdef|#
directive|ifdef
name|_WIN32
name|p
operator|->
name|stats_ex_op
operator|=
name|TcStatsEx
expr_stmt|;
name|p
operator|->
name|setbuff_op
operator|=
name|TcSetBuff
expr_stmt|;
name|p
operator|->
name|setmode_op
operator|=
name|TcSetMode
expr_stmt|;
name|p
operator|->
name|setmintocopy_op
operator|=
name|TcSetMinToCopy
expr_stmt|;
name|p
operator|->
name|getevent_op
operator|=
name|TcGetReceiveWaitHandle
expr_stmt|;
name|p
operator|->
name|oid_get_request_op
operator|=
name|TcOidGetRequest
expr_stmt|;
name|p
operator|->
name|oid_set_request_op
operator|=
name|TcOidSetRequest
expr_stmt|;
name|p
operator|->
name|sendqueue_transmit_op
operator|=
name|TcSendqueueTransmit
expr_stmt|;
name|p
operator|->
name|setuserbuffer_op
operator|=
name|TcSetUserBuffer
expr_stmt|;
name|p
operator|->
name|live_dump_op
operator|=
name|TcLiveDump
expr_stmt|;
name|p
operator|->
name|live_dump_ended_op
operator|=
name|TcLiveDumpEnded
expr_stmt|;
name|p
operator|->
name|get_airpcap_handle_op
operator|=
name|TcGetAirPcapHandle
expr_stmt|;
else|#
directive|else
name|p
operator|->
name|selectable_fd
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
name|p
operator|->
name|cleanup_op
operator|=
name|TcCleanup
expr_stmt|;
return|return
literal|0
return|;
name|bad
label|:
name|TcCleanup
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|PCAP_ERROR
return|;
block|}
end_function

begin_function
name|pcap_t
modifier|*
name|TcCreate
parameter_list|(
specifier|const
name|char
modifier|*
name|device
parameter_list|,
name|char
modifier|*
name|ebuf
parameter_list|,
name|int
modifier|*
name|is_ours
parameter_list|)
block|{
name|ULONG
name|numPorts
decl_stmt|;
name|PTC_PORT
name|pPorts
init|=
name|NULL
decl_stmt|;
name|TC_STATUS
name|status
decl_stmt|;
name|int
name|is_tc
decl_stmt|;
name|ULONG
name|i
decl_stmt|;
name|pcap_t
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|LoadTcFunctions
argument_list|()
operator|!=
name|TC_API_LOADED
condition|)
block|{
comment|/* 		 * XXX - report this as an error rather than as 		 * "not a TurboCap device"? 		 */
operator|*
name|is_ours
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * enumerate the ports, and add them to the list 	 */
name|status
operator|=
name|g_TcFunctions
operator|.
name|QueryPortList
argument_list|(
operator|&
name|pPorts
argument_list|,
operator|&
name|numPorts
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
comment|/* 		 * XXX - report this as an error rather than as 		 * "not a TurboCap device"? 		 */
operator|*
name|is_ours
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|is_tc
operator|=
name|FALSE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numPorts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|g_TcFunctions
operator|.
name|PortGetName
argument_list|(
name|pPorts
index|[
name|i
index|]
argument_list|)
argument_list|,
name|device
argument_list|)
operator|==
literal|0
condition|)
block|{
name|is_tc
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|numPorts
operator|>
literal|0
condition|)
block|{
comment|/* 		 * ignore the result here 		 */
operator|(
name|void
operator|)
name|g_TcFunctions
operator|.
name|FreePortList
argument_list|(
name|pPorts
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|is_tc
condition|)
block|{
operator|*
name|is_ours
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* OK, it's probably ours. */
operator|*
name|is_ours
operator|=
literal|1
expr_stmt|;
name|p
operator|=
name|pcap_create_common
argument_list|(
name|ebuf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pcap_tc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|p
operator|->
name|activate_op
operator|=
name|TcActivate
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcSetDatalink
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|dlt
parameter_list|)
block|{
comment|/* 	 * always return 0, as the check is done by pcap_set_datalink 	 */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcGetNonBlock
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|errbuf
parameter_list|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Getting the non blocking status is not available for TurboCap ports"
argument_list|)
expr_stmt|;
name|pcap_snprintf
argument_list|(
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Getting the non blocking status is not available for TurboCap ports"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcSetNonBlock
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|nonblock
parameter_list|,
name|char
modifier|*
name|errbuf
parameter_list|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Setting the non blocking status is not available for TurboCap ports"
argument_list|)
expr_stmt|;
name|pcap_snprintf
argument_list|(
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Setting the non blocking status is not available for TurboCap ports"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|TcCleanup
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|pcap_tc
modifier|*
name|pt
init|=
name|p
operator|->
name|priv
decl_stmt|;
if|if
condition|(
name|pt
operator|->
name|TcPacketsBuffer
operator|!=
name|NULL
condition|)
block|{
name|g_TcFunctions
operator|.
name|PacketsBufferDestroy
argument_list|(
name|pt
operator|->
name|TcPacketsBuffer
argument_list|)
expr_stmt|;
name|pt
operator|->
name|TcPacketsBuffer
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|pt
operator|->
name|TcInstance
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * here we do not check for the error values 		 */
name|g_TcFunctions
operator|.
name|InstanceClose
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|)
expr_stmt|;
name|pt
operator|->
name|TcInstance
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|pt
operator|->
name|PpiPacket
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|pt
operator|->
name|PpiPacket
argument_list|)
expr_stmt|;
name|pt
operator|->
name|PpiPacket
operator|=
name|NULL
expr_stmt|;
block|}
name|pcap_cleanup_live_common
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Send a packet to the network */
end_comment

begin_function
specifier|static
name|int
name|TcInject
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|struct
name|pcap_tc
modifier|*
name|pt
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|TC_STATUS
name|status
decl_stmt|;
name|TC_PACKETS_BUFFER
name|buffer
decl_stmt|;
name|TC_PACKET_HEADER
name|header
decl_stmt|;
if|if
condition|(
name|size
operator|>=
literal|0xFFFF
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"send error: the TurboCap API does not support packets larger than 64k"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|status
operator|=
name|g_TcFunctions
operator|.
name|PacketsBufferCreate
argument_list|(
sizeof|sizeof
argument_list|(
name|TC_PACKET_HEADER
argument_list|)
operator|+
name|TC_ALIGN_USHORT_TO_64BIT
argument_list|(
operator|(
name|USHORT
operator|)
name|size
argument_list|)
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"send error: TcPacketsBufferCreate failure: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * we assume that the packet is without the checksum, as common with WinPcap 	 */
name|memset
argument_list|(
operator|&
name|header
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|header
argument_list|)
argument_list|)
expr_stmt|;
name|header
operator|.
name|Length
operator|=
operator|(
name|USHORT
operator|)
name|size
expr_stmt|;
name|header
operator|.
name|CapturedLength
operator|=
name|header
operator|.
name|Length
expr_stmt|;
name|status
operator|=
name|g_TcFunctions
operator|.
name|PacketsBufferCommitNextPacket
argument_list|(
name|buffer
argument_list|,
operator|&
name|header
argument_list|,
operator|(
name|PVOID
operator|)
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|TC_SUCCESS
condition|)
block|{
name|status
operator|=
name|g_TcFunctions
operator|.
name|InstanceTransmitPackets
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"send error: TcInstanceTransmitPackets failure: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"send error: TcPacketsBufferCommitNextPacket failure: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
name|g_TcFunctions
operator|.
name|PacketsBufferDestroy
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|TcRead
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|cnt
parameter_list|,
name|pcap_handler
name|callback
parameter_list|,
name|u_char
modifier|*
name|user
parameter_list|)
block|{
name|struct
name|pcap_tc
modifier|*
name|pt
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|TC_STATUS
name|status
decl_stmt|;
name|int
name|n
init|=
literal|0
decl_stmt|;
comment|/* 	 * Has "pcap_breakloop()" been called? 	 */
if|if
condition|(
name|p
operator|->
name|break_loop
condition|)
block|{
comment|/* 		 * Yes - clear the flag that indicates that it 		 * has, and return -2 to indicate that we were 		 * told to break out of the loop. 		 */
name|p
operator|->
name|break_loop
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
if|if
condition|(
name|pt
operator|->
name|TcPacketsBuffer
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|g_TcFunctions
operator|.
name|InstanceReceivePackets
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|,
operator|&
name|pt
operator|->
name|TcPacketsBuffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"read error, TcInstanceReceivePackets failure: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
while|while
condition|(
name|TRUE
condition|)
block|{
name|struct
name|pcap_pkthdr
name|hdr
decl_stmt|;
name|TC_PACKET_HEADER
name|tcHeader
decl_stmt|;
name|PVOID
name|data
decl_stmt|;
name|ULONG
name|filterResult
decl_stmt|;
comment|/* 		 * Has "pcap_breakloop()" been called? 		 * If so, return immediately - if we haven't read any 		 * packets, clear the flag and return -2 to indicate 		 * that we were told to break out of the loop, otherwise 		 * leave the flag set, so that the *next* call will break 		 * out of the loop without having read any packets, and 		 * return the number of packets we've processed so far. 		 */
if|if
condition|(
name|p
operator|->
name|break_loop
condition|)
block|{
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|break_loop
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
else|else
block|{
return|return
name|n
return|;
block|}
block|}
if|if
condition|(
name|pt
operator|->
name|TcPacketsBuffer
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|status
operator|=
name|g_TcFunctions
operator|.
name|PacketsBufferQueryNextPacket
argument_list|(
name|pt
operator|->
name|TcPacketsBuffer
argument_list|,
operator|&
name|tcHeader
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|TC_ERROR_END_OF_BUFFER
condition|)
block|{
name|g_TcFunctions
operator|.
name|PacketsBufferDestroy
argument_list|(
name|pt
operator|->
name|TcPacketsBuffer
argument_list|)
expr_stmt|;
name|pt
operator|->
name|TcPacketsBuffer
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"read error, TcPacketsBufferQueryNextPacket failure: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* No underlaying filtering system. We need to filter on our own */
if|if
condition|(
name|p
operator|->
name|fcode
operator|.
name|bf_insns
condition|)
block|{
name|filterResult
operator|=
name|bpf_filter
argument_list|(
name|p
operator|->
name|fcode
operator|.
name|bf_insns
argument_list|,
name|data
argument_list|,
name|tcHeader
operator|.
name|Length
argument_list|,
name|tcHeader
operator|.
name|CapturedLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|filterResult
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|filterResult
operator|>
name|tcHeader
operator|.
name|CapturedLength
condition|)
block|{
name|filterResult
operator|=
name|tcHeader
operator|.
name|CapturedLength
expr_stmt|;
block|}
block|}
else|else
block|{
name|filterResult
operator|=
name|tcHeader
operator|.
name|CapturedLength
expr_stmt|;
block|}
name|pt
operator|->
name|TcAcceptedCount
operator|++
expr_stmt|;
name|hdr
operator|.
name|ts
operator|.
name|tv_sec
operator|=
call|(
name|bpf_u_int32
call|)
argument_list|(
name|tcHeader
operator|.
name|Timestamp
operator|/
call|(
name|ULONGLONG
call|)
argument_list|(
literal|1000
operator|*
literal|1000
operator|*
literal|1000
argument_list|)
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|ts
operator|.
name|tv_usec
operator|=
call|(
name|bpf_u_int32
call|)
argument_list|(
operator|(
name|tcHeader
operator|.
name|Timestamp
operator|%
call|(
name|ULONGLONG
call|)
argument_list|(
literal|1000
operator|*
literal|1000
operator|*
literal|1000
argument_list|)
operator|)
operator|/
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|linktype
operator|==
name|DLT_EN10MB
condition|)
block|{
name|hdr
operator|.
name|caplen
operator|=
name|filterResult
expr_stmt|;
name|hdr
operator|.
name|len
operator|=
name|tcHeader
operator|.
name|Length
expr_stmt|;
call|(
modifier|*
name|callback
call|)
argument_list|(
name|user
argument_list|,
operator|&
name|hdr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PPPI_HEADER
name|pPpiHeader
init|=
operator|(
name|PPPI_HEADER
operator|)
name|pt
operator|->
name|PpiPacket
decl_stmt|;
name|PVOID
name|data2
init|=
name|pPpiHeader
operator|+
literal|1
decl_stmt|;
name|pPpiHeader
operator|->
name|AggregationField
operator|.
name|InterfaceId
operator|=
name|TC_PH_FLAGS_RX_PORT_ID
argument_list|(
name|tcHeader
operator|.
name|Flags
argument_list|)
expr_stmt|;
name|pPpiHeader
operator|->
name|Dot3Field
operator|.
name|Errors
operator|=
name|tcHeader
operator|.
name|Errors
expr_stmt|;
if|if
condition|(
name|tcHeader
operator|.
name|Flags
operator|&
name|TC_PH_FLAGS_CHECKSUM
condition|)
block|{
name|pPpiHeader
operator|->
name|Dot3Field
operator|.
name|Flags
operator|=
name|PPI_FLD_802_3_EXT_FLAG_FCS_PRESENT
expr_stmt|;
block|}
else|else
block|{
name|pPpiHeader
operator|->
name|Dot3Field
operator|.
name|Flags
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|filterResult
operator|<=
name|MAX_TC_PACKET_SIZE
condition|)
block|{
name|memcpy
argument_list|(
name|data2
argument_list|,
name|data
argument_list|,
name|filterResult
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|caplen
operator|=
sizeof|sizeof
argument_list|(
name|PPI_HEADER
argument_list|)
operator|+
name|filterResult
expr_stmt|;
name|hdr
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
name|PPI_HEADER
argument_list|)
operator|+
name|tcHeader
operator|.
name|Length
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|data2
argument_list|,
name|data
argument_list|,
name|MAX_TC_PACKET_SIZE
argument_list|)
expr_stmt|;
name|hdr
operator|.
name|caplen
operator|=
sizeof|sizeof
argument_list|(
name|PPI_HEADER
argument_list|)
operator|+
name|MAX_TC_PACKET_SIZE
expr_stmt|;
name|hdr
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
name|PPI_HEADER
argument_list|)
operator|+
name|tcHeader
operator|.
name|Length
expr_stmt|;
block|}
call|(
modifier|*
name|callback
call|)
argument_list|(
name|user
argument_list|,
operator|&
name|hdr
argument_list|,
name|pt
operator|->
name|PpiPacket
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|++
name|n
operator|>=
name|cnt
operator|&&
name|cnt
operator|>
literal|0
condition|)
block|{
return|return
name|n
return|;
block|}
block|}
return|return
name|n
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcStats
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|struct
name|pcap_stat
modifier|*
name|ps
parameter_list|)
block|{
name|struct
name|pcap_tc
modifier|*
name|pt
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|TC_STATISTICS
name|statistics
decl_stmt|;
name|TC_STATUS
name|status
decl_stmt|;
name|ULONGLONG
name|counter
decl_stmt|;
name|struct
name|pcap_stat
name|s
decl_stmt|;
name|status
operator|=
name|g_TcFunctions
operator|.
name|InstanceQueryStatistics
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|,
operator|&
name|statistics
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"TurboCap error in TcInstanceQueryStatistics: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|s
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|g_TcFunctions
operator|.
name|StatisticsQueryValue
argument_list|(
name|statistics
argument_list|,
name|TC_COUNTER_INSTANCE_TOTAL_RX_PACKETS
argument_list|,
operator|&
name|counter
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"TurboCap error in TcStatisticsQueryValue: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|counter
operator|<=
operator|(
name|ULONGLONG
operator|)
literal|0xFFFFFFFF
condition|)
block|{
name|s
operator|.
name|ps_recv
operator|=
operator|(
name|ULONG
operator|)
name|counter
expr_stmt|;
block|}
else|else
block|{
name|s
operator|.
name|ps_recv
operator|=
literal|0xFFFFFFFF
expr_stmt|;
block|}
name|status
operator|=
name|g_TcFunctions
operator|.
name|StatisticsQueryValue
argument_list|(
name|statistics
argument_list|,
name|TC_COUNTER_INSTANCE_RX_DROPPED_PACKETS
argument_list|,
operator|&
name|counter
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"TurboCap error in TcStatisticsQueryValue: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|counter
operator|<=
operator|(
name|ULONGLONG
operator|)
literal|0xFFFFFFFF
condition|)
block|{
name|s
operator|.
name|ps_ifdrop
operator|=
operator|(
name|ULONG
operator|)
name|counter
expr_stmt|;
name|s
operator|.
name|ps_drop
operator|=
operator|(
name|ULONG
operator|)
name|counter
expr_stmt|;
block|}
else|else
block|{
name|s
operator|.
name|ps_ifdrop
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|s
operator|.
name|ps_drop
operator|=
literal|0xFFFFFFFF
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|&&
name|defined
argument_list|(
name|HAVE_REMOTE
argument_list|)
name|s
operator|.
name|ps_capt
operator|=
name|pt
operator|->
name|TcAcceptedCount
expr_stmt|;
endif|#
directive|endif
operator|*
name|ps
operator|=
name|s
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * We filter at user level, since the kernel driver does't process the packets  */
end_comment

begin_function
specifier|static
name|int
name|TcSetFilter
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|struct
name|bpf_program
modifier|*
name|fp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|strncpy
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
literal|"setfilter: No filter specified"
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|->
name|errbuf
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Install a user level filter */
if|if
condition|(
name|install_bpf_program
argument_list|(
name|p
argument_list|,
name|fp
argument_list|)
operator|<
literal|0
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|->
name|errbuf
argument_list|)
argument_list|,
literal|"setfilter, unable to install the filter: %s"
argument_list|,
name|pcap_strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32
end_ifdef

begin_function
specifier|static
name|struct
name|pcap_stat
modifier|*
name|TcStatsEx
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
modifier|*
name|pcap_stat_size
parameter_list|)
block|{
name|struct
name|pcap_tc
modifier|*
name|pt
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|TC_STATISTICS
name|statistics
decl_stmt|;
name|TC_STATUS
name|status
decl_stmt|;
name|ULONGLONG
name|counter
decl_stmt|;
operator|*
name|pcap_stat_size
operator|=
sizeof|sizeof
argument_list|(
name|p
operator|->
name|stat
argument_list|)
expr_stmt|;
name|status
operator|=
name|g_TcFunctions
operator|.
name|InstanceQueryStatistics
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|,
operator|&
name|statistics
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"TurboCap error in TcInstanceQueryStatistics: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|p
operator|->
name|stat
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|->
name|stat
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|g_TcFunctions
operator|.
name|StatisticsQueryValue
argument_list|(
name|statistics
argument_list|,
name|TC_COUNTER_INSTANCE_TOTAL_RX_PACKETS
argument_list|,
operator|&
name|counter
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"TurboCap error in TcStatisticsQueryValue: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|counter
operator|<=
operator|(
name|ULONGLONG
operator|)
literal|0xFFFFFFFF
condition|)
block|{
name|p
operator|->
name|stat
operator|.
name|ps_recv
operator|=
operator|(
name|ULONG
operator|)
name|counter
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|stat
operator|.
name|ps_recv
operator|=
literal|0xFFFFFFFF
expr_stmt|;
block|}
name|status
operator|=
name|g_TcFunctions
operator|.
name|StatisticsQueryValue
argument_list|(
name|statistics
argument_list|,
name|TC_COUNTER_INSTANCE_RX_DROPPED_PACKETS
argument_list|,
operator|&
name|counter
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"TurboCap error in TcStatisticsQueryValue: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|counter
operator|<=
operator|(
name|ULONGLONG
operator|)
literal|0xFFFFFFFF
condition|)
block|{
name|p
operator|->
name|stat
operator|.
name|ps_ifdrop
operator|=
operator|(
name|ULONG
operator|)
name|counter
expr_stmt|;
name|p
operator|->
name|stat
operator|.
name|ps_drop
operator|=
operator|(
name|ULONG
operator|)
name|counter
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|stat
operator|.
name|ps_ifdrop
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|p
operator|->
name|stat
operator|.
name|ps_drop
operator|=
literal|0xFFFFFFFF
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|HAVE_REMOTE
name|p
operator|->
name|stat
operator|.
name|ps_capt
operator|=
name|pt
operator|->
name|TcAcceptedCount
expr_stmt|;
endif|#
directive|endif
return|return
operator|&
name|p
operator|->
name|stat
return|;
block|}
end_function

begin_comment
comment|/* Set the dimension of the kernel-level capture buffer */
end_comment

begin_function
specifier|static
name|int
name|TcSetBuff
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|dim
parameter_list|)
block|{
comment|/* 	 * XXX turbocap has an internal way of managing buffers. 	 * And at the moment it's not configurable, so we just 	 * silently ignore the request to set the buffer. 	 */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcSetMode
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
name|mode
operator|!=
name|MODE_CAPT
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Mode %u not supported by TurboCap devices. TurboCap only supports capture."
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcSetMinToCopy
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|struct
name|pcap_tc
modifier|*
name|pt
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|TC_STATUS
name|status
decl_stmt|;
if|if
condition|(
name|size
operator|<
literal|0
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Mintocopy cannot be less than 0."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|status
operator|=
name|g_TcFunctions
operator|.
name|InstanceSetFeature
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|,
name|TC_INST_FT_MINTOCOPY
argument_list|,
operator|(
name|ULONG
operator|)
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|TC_SUCCESS
condition|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"TurboCap error setting the mintocopy: %s (%08x)"
argument_list|,
name|g_TcFunctions
operator|.
name|StatusGetString
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|HANDLE
name|TcGetReceiveWaitHandle
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|pcap_tc
modifier|*
name|pt
init|=
name|p
operator|->
name|priv
decl_stmt|;
return|return
name|g_TcFunctions
operator|.
name|InstanceGetReceiveWaitHandle
argument_list|(
name|pt
operator|->
name|TcInstance
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcOidGetRequest
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|bpf_u_int32
name|oid
name|_U_
parameter_list|,
name|void
modifier|*
name|data
name|_U_
parameter_list|,
name|size_t
modifier|*
name|lenp
name|_U_
parameter_list|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"An OID get request cannot be performed on a TurboCap device"
argument_list|)
expr_stmt|;
return|return
name|PCAP_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcOidSetRequest
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|bpf_u_int32
name|oid
name|_U_
parameter_list|,
specifier|const
name|void
modifier|*
name|data
name|_U_
parameter_list|,
name|size_t
modifier|*
name|lenp
name|_U_
parameter_list|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"An OID set request cannot be performed on a TurboCap device"
argument_list|)
expr_stmt|;
return|return
name|PCAP_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|TcSendqueueTransmit
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|pcap_send_queue
modifier|*
name|queue
name|_U_
parameter_list|,
name|int
name|sync
name|_U_
parameter_list|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Packets cannot be bulk transmitted on a TurboCap device"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcSetUserBuffer
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|size
name|_U_
parameter_list|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"The user buffer cannot be set on a TurboCap device"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcLiveDump
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|filename
name|_U_
parameter_list|,
name|int
name|maxsize
name|_U_
parameter_list|,
name|int
name|maxpacks
name|_U_
parameter_list|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Live packet dumping cannot be performed on a TurboCap device"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcLiveDumpEnded
parameter_list|(
name|pcap_t
modifier|*
name|p
parameter_list|,
name|int
name|sync
name|_U_
parameter_list|)
block|{
name|pcap_snprintf
argument_list|(
name|p
operator|->
name|errbuf
argument_list|,
name|PCAP_ERRBUF_SIZE
argument_list|,
literal|"Live packet dumping cannot be performed on a TurboCap device"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|PAirpcapHandle
name|TcGetAirPcapHandle
parameter_list|(
name|pcap_t
modifier|*
name|p
name|_U_
parameter_list|)
block|{
return|return
name|NULL
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


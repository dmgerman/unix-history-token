begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  File.........: pktdrvr.c  *  *  Responsible..: Gisle Vanem,  giva@bgnett.no  *  *  Created......: 26.Sept 1995  *  *  Description..: Packet-driver interface for 16/32-bit C :  *                 Borland C/C++ 3.0+ small/large model  *                 Watcom C/C++ 11+, DOS4GW flat model  *                 Metaware HighC 3.1+ and PharLap 386|DosX  *                 GNU C/C++ 2.7+ and djgpp 2.x extender  *  *  References...: PC/TCP Packet driver Specification. rev 1.09  *                 FTP Software Inc.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<dos.h>
end_include

begin_include
include|#
directive|include
file|"pcap-dos.h"
end_include

begin_include
include|#
directive|include
file|"pcap-int.h"
end_include

begin_include
include|#
directive|include
file|"msdos/pktdrvr.h"
end_include

begin_if
if|#
directive|if
operator|(
name|DOSX
operator|)
end_if

begin_define
define|#
directive|define
name|NUM_RX_BUF
value|32
end_define

begin_comment
comment|/* # of buffers in Rx FIFO queue */
end_comment

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|NUM_RX_BUF
value|10
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|DIM
parameter_list|(
name|x
parameter_list|)
value|(sizeof((x)) / sizeof(x[0]))
end_define

begin_define
define|#
directive|define
name|PUTS
parameter_list|(
name|s
parameter_list|)
value|do {                                           \                    if (!pktInfo.quiet)                          \                       pktInfo.error ?                           \                         printf ("%s: %s\n", s, pktInfo.error) : \                         printf ("%s\n", pktInfo.error = s);     \                  } while (0)
end_define

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__HIGHC__
argument_list|)
end_if

begin_decl_stmt
specifier|extern
name|UINT
name|_mwenv
decl_stmt|;
end_decl_stmt

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|__DJGPP__
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<dpmi.h>
end_include

begin_include
include|#
directive|include
file|<go32.h>
end_include

begin_include
include|#
directive|include
file|<pc.h>
end_include

begin_include
include|#
directive|include
file|<sys/farptr.h>
end_include

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|__WATCOMC__
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<i86.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_decl_stmt
specifier|extern
name|char
name|_Extender
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_function_decl
specifier|extern
name|void
name|far
name|PktReceiver
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|(
name|DOSX
operator|&
operator|(
name|DJGPP
operator||
name|DOS4GW
operator|)
operator|)
end_if

begin_include
include|#
directive|include
file|<sys/pack_on.h>
end_include

begin_struct
struct|struct
name|DPMI_regs
block|{
name|DWORD
name|r_di
decl_stmt|;
name|DWORD
name|r_si
decl_stmt|;
name|DWORD
name|r_bp
decl_stmt|;
name|DWORD
name|reserved
decl_stmt|;
name|DWORD
name|r_bx
decl_stmt|;
name|DWORD
name|r_dx
decl_stmt|;
name|DWORD
name|r_cx
decl_stmt|;
name|DWORD
name|r_ax
decl_stmt|;
name|WORD
name|r_flags
decl_stmt|;
name|WORD
name|r_es
decl_stmt|,
name|r_ds
decl_stmt|,
name|r_fs
decl_stmt|,
name|r_gs
decl_stmt|;
name|WORD
name|r_ip
decl_stmt|,
name|r_cs
decl_stmt|,
name|r_sp
decl_stmt|,
name|r_ss
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Data located in a real-mode segment. This becomes far at runtime    */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
comment|/* must match data/code in pkt_rx1.s */
name|WORD
name|_rxOutOfs
decl_stmt|;
name|WORD
name|_rxInOfs
decl_stmt|;
name|DWORD
name|_pktDrop
decl_stmt|;
name|BYTE
name|_pktTemp
index|[
literal|20
index|]
decl_stmt|;
name|TX_ELEMENT
name|_pktTxBuf
index|[
literal|1
index|]
decl_stmt|;
name|RX_ELEMENT
name|_pktRxBuf
index|[
name|NUM_RX_BUF
index|]
decl_stmt|;
name|WORD
name|_dummy
index|[
literal|2
index|]
decl_stmt|;
comment|/* screenSeg,newInOffset */
name|BYTE
name|_fanChars
index|[
literal|4
index|]
decl_stmt|;
name|WORD
name|_fanIndex
decl_stmt|;
name|BYTE
name|_PktReceiver
index|[
literal|15
index|]
decl_stmt|;
comment|/* starts on a paragraph (16byte) */
block|}
name|PktRealStub
typedef|;
end_typedef

begin_include
include|#
directive|include
file|<sys/pack_off.h>
end_include

begin_decl_stmt
specifier|static
name|BYTE
name|real_stub_array
index|[]
init|=
block|{
include|#
directive|include
file|"pkt_stub.inc"
comment|/* generated opcode array */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|rxOutOfs
value|offsetof (PktRealStub,_rxOutOfs)
end_define

begin_define
define|#
directive|define
name|rxInOfs
value|offsetof (PktRealStub,_rxInOfs)
end_define

begin_define
define|#
directive|define
name|PktReceiver
value|offsetof (PktRealStub,_PktReceiver [para_skip])
end_define

begin_define
define|#
directive|define
name|pktDrop
value|offsetof (PktRealStub,_pktDrop)
end_define

begin_define
define|#
directive|define
name|pktTemp
value|offsetof (PktRealStub,_pktTemp)
end_define

begin_define
define|#
directive|define
name|pktTxBuf
value|offsetof (PktRealStub,_pktTxBuf)
end_define

begin_define
define|#
directive|define
name|FIRST_RX_BUF
value|offsetof (PktRealStub,_pktRxBuf [0])
end_define

begin_define
define|#
directive|define
name|LAST_RX_BUF
value|offsetof (PktRealStub,_pktRxBuf [NUM_RX_BUF-1])
end_define

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|extern
name|WORD
name|rxOutOfs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* offsets into pktRxBuf FIFO queue   */
end_comment

begin_decl_stmt
specifier|extern
name|WORD
name|rxInOfs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|DWORD
name|pktDrop
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* # packets dropped in PktReceiver() */
end_comment

begin_decl_stmt
specifier|extern
name|BYTE
name|pktRxEnd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* marks the end of r-mode code/data  */
end_comment

begin_decl_stmt
specifier|extern
name|RX_ELEMENT
name|pktRxBuf
index|[
name|NUM_RX_BUF
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* PktDrvr Rx buffers */
end_comment

begin_decl_stmt
specifier|extern
name|TX_ELEMENT
name|pktTxBuf
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* PktDrvr Tx buffer  */
end_comment

begin_decl_stmt
specifier|extern
name|char
name|pktTemp
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* PktDrvr temp area  */
end_comment

begin_define
define|#
directive|define
name|FIRST_RX_BUF
value|(WORD)&pktRxBuf [0]
end_define

begin_define
define|#
directive|define
name|LAST_RX_BUF
value|(WORD)&pktRxBuf [NUM_RX_BUF-1]
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__BORLANDC__
end_ifdef

begin_comment
comment|/* Use Borland's inline functions */
end_comment

begin_define
define|#
directive|define
name|memcpy
value|__memcpy__
end_define

begin_define
define|#
directive|define
name|memcmp
value|__memcmp__
end_define

begin_define
define|#
directive|define
name|memset
value|__memset__
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
end_if

begin_function_decl
specifier|extern
name|void
name|PktReceiver
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* in pkt_rx0.asm */
end_comment

begin_function_decl
specifier|static
name|int
name|RealCopy
parameter_list|(
name|ULONG
parameter_list|,
name|ULONG
parameter_list|,
name|REALPTR
modifier|*
parameter_list|,
name|FARPTR
modifier|*
parameter_list|,
name|USHORT
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_undef
undef|#
directive|undef
name|FP_SEG
end_undef

begin_undef
undef|#
directive|undef
name|FP_OFF
end_undef

begin_define
define|#
directive|define
name|FP_OFF
parameter_list|(
name|x
parameter_list|)
value|((WORD)(x))
end_define

begin_define
define|#
directive|define
name|FP_SEG
parameter_list|(
name|x
parameter_list|)
value|((WORD)(realBase>> 16))
end_define

begin_define
define|#
directive|define
name|DOS_ADDR
parameter_list|(
name|s
parameter_list|,
name|o
parameter_list|)
value|(((DWORD)(s)<< 16) + (WORD)(o))
end_define

begin_define
define|#
directive|define
name|r_ax
value|eax
end_define

begin_define
define|#
directive|define
name|r_bx
value|ebx
end_define

begin_define
define|#
directive|define
name|r_dx
value|edx
end_define

begin_define
define|#
directive|define
name|r_cx
value|ecx
end_define

begin_define
define|#
directive|define
name|r_si
value|esi
end_define

begin_define
define|#
directive|define
name|r_di
value|edi
end_define

begin_define
define|#
directive|define
name|r_ds
value|ds
end_define

begin_define
define|#
directive|define
name|r_es
value|es
end_define

begin_decl_stmt
name|LOCAL
name|FARPTR
name|protBase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|LOCAL
name|REALPTR
name|realBase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|LOCAL
name|WORD
name|realSeg
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* DOS para-address of allocated area */
end_comment

begin_decl_stmt
name|LOCAL
name|SWI_REGS
name|reg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|WORD
name|_far
modifier|*
name|rxOutOfsFp
decl_stmt|,
modifier|*
name|rxInOfsFp
decl_stmt|;
end_decl_stmt

begin_elif
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
end_elif

begin_decl_stmt
specifier|static
name|_go32_dpmi_seginfo
name|rm_mem
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|__dpmi_regs
name|reg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|DWORD
name|realBase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|para_skip
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DOS_ADDR
parameter_list|(
name|s
parameter_list|,
name|o
parameter_list|)
value|(((WORD)(s)<< 4) + (o))
end_define

begin_define
define|#
directive|define
name|r_ax
value|x.ax
end_define

begin_define
define|#
directive|define
name|r_bx
value|x.bx
end_define

begin_define
define|#
directive|define
name|r_dx
value|x.dx
end_define

begin_define
define|#
directive|define
name|r_cx
value|x.cx
end_define

begin_define
define|#
directive|define
name|r_si
value|x.si
end_define

begin_define
define|#
directive|define
name|r_di
value|x.di
end_define

begin_define
define|#
directive|define
name|r_ds
value|x.ds
end_define

begin_define
define|#
directive|define
name|r_es
value|x.es
end_define

begin_elif
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
end_elif

begin_decl_stmt
name|LOCAL
name|struct
name|DPMI_regs
name|reg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|LOCAL
name|WORD
name|rm_base_seg
decl_stmt|,
name|rm_base_sel
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|LOCAL
name|DWORD
name|realBase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|LOCAL
name|int
name|para_skip
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
name|LOCAL
name|DWORD
name|dpmi_get_real_vector
parameter_list|(
name|int
name|intr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|LOCAL
name|WORD
name|dpmi_real_malloc
parameter_list|(
name|int
name|size
parameter_list|,
name|WORD
modifier|*
name|selector
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|LOCAL
name|void
name|dpmi_real_free
parameter_list|(
name|WORD
name|selector
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|DOS_ADDR
parameter_list|(
name|s
parameter_list|,
name|o
parameter_list|)
value|(((DWORD)(s)<< 4) + (WORD)(o))
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* real-mode Borland etc. */
end_comment

begin_struct
specifier|static
struct|struct
block|{
name|WORD
name|r_ax
decl_stmt|,
name|r_bx
decl_stmt|,
name|r_cx
decl_stmt|,
name|r_dx
decl_stmt|,
name|r_bp
decl_stmt|;
name|WORD
name|r_si
decl_stmt|,
name|r_di
decl_stmt|,
name|r_ds
decl_stmt|,
name|r_es
decl_stmt|,
name|r_flags
decl_stmt|;
block|}
name|reg
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__HIGHC__
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|Alias
name|(
name|pktDrop
name|,
literal|"_pktDrop"
name|)
end_pragma

begin_pragma
pragma|#
directive|pragma
name|Alias
name|(
name|pktRxBuf
name|,
literal|"_pktRxBuf"
name|)
end_pragma

begin_pragma
pragma|#
directive|pragma
name|Alias
name|(
name|pktTxBuf
name|,
literal|"_pktTxBuf"
name|)
end_pragma

begin_pragma
pragma|#
directive|pragma
name|Alias
name|(
name|pktTemp
name|,
literal|"_pktTemp"
name|)
end_pragma

begin_pragma
pragma|#
directive|pragma
name|Alias
name|(
name|rxOutOfs
name|,
literal|"_rxOutOfs"
name|)
end_pragma

begin_pragma
pragma|#
directive|pragma
name|Alias
name|(
name|rxInOfs
name|,
literal|"_rxInOfs"
name|)
end_pragma

begin_pragma
pragma|#
directive|pragma
name|Alias
name|(
name|pktRxEnd
name|,
literal|"_pktRxEnd"
name|)
end_pragma

begin_pragma
pragma|#
directive|pragma
name|Alias
name|(
name|PktReceiver
name|,
literal|"_PktReceiver"
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|PUBLIC
name|PKT_STAT
name|pktStat
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* statistics for packets    */
end_comment

begin_decl_stmt
name|PUBLIC
name|PKT_INFO
name|pktInfo
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* packet-driver information */
end_comment

begin_decl_stmt
name|PUBLIC
name|PKT_RX_MODE
name|receiveMode
init|=
name|PDRX_DIRECT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|PUBLIC
name|ETHER
name|myAddress
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|PUBLIC
name|ETHER
name|ethBroadcast
init|=
block|{
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|,
literal|255
block|}
decl_stmt|;
end_decl_stmt

begin_macro
name|LOCAL
end_macro

begin_struct
struct|struct
block|{
comment|/* internal statistics */
name|DWORD
name|tooSmall
decl_stmt|;
comment|/* size< ETH_MIN */
name|DWORD
name|tooLarge
decl_stmt|;
comment|/* size> ETH_MAX */
name|DWORD
name|badSync
decl_stmt|;
comment|/* count_1 != count_2 */
name|DWORD
name|wrongHandle
decl_stmt|;
comment|/* upcall to wrong handle */
block|}
name|intStat
struct|;
end_struct

begin_comment
comment|/***************************************************************************/
end_comment

begin_function
name|PUBLIC
specifier|const
name|char
modifier|*
name|PktGetErrorStr
parameter_list|(
name|int
name|errNum
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|errStr
index|[]
init|=
block|{
literal|""
block|,
literal|"Invalid handle number"
block|,
literal|"No interfaces of specified class found"
block|,
literal|"No interfaces of specified type found"
block|,
literal|"No interfaces of specified number found"
block|,
literal|"Bad packet type specified"
block|,
literal|"Interface does not support multicast"
block|,
literal|"Packet driver cannot terminate"
block|,
literal|"Invalid receiver mode specified"
block|,
literal|"Insufficient memory space"
block|,
literal|"Type previously accessed, and not released"
block|,
literal|"Command out of range, or not implemented"
block|,
literal|"Cannot send packet (usually hardware error)"
block|,
literal|"Cannot change hardware address (> 1 handle open)"
block|,
literal|"Hardware address has bad length or format"
block|,
literal|"Cannot reset interface (more than 1 handle open)"
block|,
literal|"Bad Check-sum"
block|,
literal|"Bad size"
block|,
literal|"Bad sync"
block|,
literal|"Source hit"
block|}
decl_stmt|;
if|if
condition|(
name|errNum
operator|<
literal|0
operator|||
name|errNum
operator|>=
name|DIM
argument_list|(
name|errStr
argument_list|)
condition|)
return|return
operator|(
literal|"Unknown driver error."
operator|)
return|;
return|return
operator|(
name|errStr
index|[
name|errNum
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
specifier|const
name|char
modifier|*
name|PktGetClassName
parameter_list|(
name|WORD
name|class
parameter_list|)
block|{
switch|switch
condition|(
name|class
condition|)
block|{
case|case
name|PD_ETHER
case|:
return|return
operator|(
literal|"DIX-Ether"
operator|)
return|;
case|case
name|PD_PRONET10
case|:
return|return
operator|(
literal|"ProNET-10"
operator|)
return|;
case|case
name|PD_IEEE8025
case|:
return|return
operator|(
literal|"IEEE 802.5"
operator|)
return|;
case|case
name|PD_OMNINET
case|:
return|return
operator|(
literal|"OmniNet"
operator|)
return|;
case|case
name|PD_APPLETALK
case|:
return|return
operator|(
literal|"AppleTalk"
operator|)
return|;
case|case
name|PD_SLIP
case|:
return|return
operator|(
literal|"SLIP"
operator|)
return|;
case|case
name|PD_STARTLAN
case|:
return|return
operator|(
literal|"StartLAN"
operator|)
return|;
case|case
name|PD_ARCNET
case|:
return|return
operator|(
literal|"ArcNet"
operator|)
return|;
case|case
name|PD_AX25
case|:
return|return
operator|(
literal|"AX.25"
operator|)
return|;
case|case
name|PD_KISS
case|:
return|return
operator|(
literal|"KISS"
operator|)
return|;
case|case
name|PD_IEEE8023_2
case|:
return|return
operator|(
literal|"IEEE 802.3 w/802.2 hdr"
operator|)
return|;
case|case
name|PD_FDDI8022
case|:
return|return
operator|(
literal|"FDDI w/802.2 hdr"
operator|)
return|;
case|case
name|PD_X25
case|:
return|return
operator|(
literal|"X.25"
operator|)
return|;
case|case
name|PD_LANstar
case|:
return|return
operator|(
literal|"LANstar"
operator|)
return|;
case|case
name|PD_PPP
case|:
return|return
operator|(
literal|"PPP"
operator|)
return|;
default|default:
return|return
operator|(
literal|"unknown"
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|char
specifier|const
modifier|*
name|PktRXmodeStr
parameter_list|(
name|PKT_RX_MODE
name|mode
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|modeStr
index|[]
init|=
block|{
literal|"Receiver turned off"
block|,
literal|"Receive only directly addressed packets"
block|,
literal|"Receive direct& broadcast packets"
block|,
literal|"Receive direct,broadcast and limited multicast packets"
block|,
literal|"Receive direct,broadcast and all multicast packets"
block|,
literal|"Receive all packets (promiscuouos mode)"
block|}
decl_stmt|;
if|if
condition|(
name|mode
operator|>
name|DIM
argument_list|(
name|modeStr
argument_list|)
condition|)
return|return
operator|(
literal|"??"
operator|)
return|;
return|return
operator|(
name|modeStr
index|[
name|mode
operator|-
literal|1
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|LOCAL
name|__inline
name|BOOL
name|PktInterrupt
parameter_list|(
name|void
parameter_list|)
block|{
name|BOOL
name|okay
decl_stmt|;
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
name|_dx_real_int
argument_list|(
operator|(
name|UINT
operator|)
name|pktInfo
operator|.
name|intr
argument_list|,
operator|&
name|reg
argument_list|)
expr_stmt|;
name|okay
operator|=
operator|(
operator|(
name|reg
operator|.
name|flags
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
expr_stmt|;
comment|/* OK if carry clear */
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|__dpmi_int
argument_list|(
operator|(
name|int
operator|)
name|pktInfo
operator|.
name|intr
argument_list|,
operator|&
name|reg
argument_list|)
expr_stmt|;
name|okay
operator|=
operator|(
operator|(
name|reg
operator|.
name|x
operator|.
name|flags
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|union
name|REGS
name|r
decl_stmt|;
name|struct
name|SREGS
name|s
decl_stmt|;
name|memset
argument_list|(
operator|&
name|r
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|segread
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
name|r
operator|.
name|w
operator|.
name|ax
operator|=
literal|0x300
expr_stmt|;
name|r
operator|.
name|x
operator|.
name|ebx
operator|=
name|pktInfo
operator|.
name|intr
expr_stmt|;
name|r
operator|.
name|w
operator|.
name|cx
operator|=
literal|0
expr_stmt|;
name|s
operator|.
name|es
operator|=
name|FP_SEG
argument_list|(
operator|&
name|reg
argument_list|)
expr_stmt|;
name|r
operator|.
name|x
operator|.
name|edi
operator|=
name|FP_OFF
argument_list|(
operator|&
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|.
name|r_flags
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|r_ss
operator|=
name|reg
operator|.
name|r_sp
operator|=
literal|0
expr_stmt|;
comment|/* DPMI host provides stack */
name|int386x
argument_list|(
literal|0x31
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|okay
operator|=
operator|(
operator|!
name|r
operator|.
name|w
operator|.
name|cflag
operator|)
expr_stmt|;
else|#
directive|else
name|reg
operator|.
name|r_flags
operator|=
literal|0
expr_stmt|;
name|intr
argument_list|(
name|pktInfo
operator|.
name|intr
argument_list|,
operator|(
expr|struct
name|REGPACK
operator|*
operator|)
operator|&
name|reg
argument_list|)
expr_stmt|;
name|okay
operator|=
operator|(
operator|(
name|reg
operator|.
name|r_flags
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|okay
condition|)
name|pktInfo
operator|.
name|error
operator|=
name|NULL
expr_stmt|;
else|else
name|pktInfo
operator|.
name|error
operator|=
name|PktGetErrorStr
argument_list|(
name|reg
operator|.
name|r_dx
operator|>>
literal|8
argument_list|)
expr_stmt|;
return|return
operator|(
name|okay
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/*  * Search for packet driver at interrupt 60h through 80h. If ASCIIZ  * string "PKT DRVR" found at offset 3 in the interrupt handler, return  * interrupt number, else return zero in pktInfo.intr  */
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktSearchDriver
parameter_list|(
name|void
parameter_list|)
block|{
name|BYTE
name|intr
init|=
literal|0x20
decl_stmt|;
name|BOOL
name|found
init|=
name|FALSE
decl_stmt|;
while|while
condition|(
operator|!
name|found
operator|&&
name|intr
operator|<
literal|0xFF
condition|)
block|{
specifier|static
name|char
name|str
index|[
literal|12
index|]
decl_stmt|;
comment|/* 3 + strlen("PKT DRVR") */
specifier|static
name|char
name|pktStr
index|[
literal|9
index|]
init|=
literal|"PKT DRVR"
decl_stmt|;
comment|/* ASCIIZ string at ofs 3 */
name|DWORD
name|rp
decl_stmt|;
comment|/* in interrupt  routine  */
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
name|_dx_rmiv_get
argument_list|(
name|intr
argument_list|,
operator|&
name|rp
argument_list|)
expr_stmt|;
name|ReadRealMem
argument_list|(
operator|&
name|str
argument_list|,
operator|(
name|REALPTR
operator|)
name|rp
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|__dpmi_raddr
name|realAdr
decl_stmt|;
name|__dpmi_get_real_mode_interrupt_vector
argument_list|(
name|intr
argument_list|,
operator|&
name|realAdr
argument_list|)
expr_stmt|;
name|rp
operator|=
operator|(
name|realAdr
operator|.
name|segment
operator|<<
literal|4
operator|)
operator|+
name|realAdr
operator|.
name|offset16
expr_stmt|;
name|dosmemget
argument_list|(
name|rp
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|rp
operator|=
name|dpmi_get_real_vector
argument_list|(
name|intr
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|str
argument_list|,
operator|(
name|void
operator|*
operator|)
name|rp
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|_fmemcpy
argument_list|(
operator|&
name|str
argument_list|,
name|getvect
argument_list|(
name|intr
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|found
operator|=
name|memcmp
argument_list|(
operator|&
name|str
index|[
literal|3
index|]
argument_list|,
operator|&
name|pktStr
argument_list|,
sizeof|sizeof
argument_list|(
name|pktStr
argument_list|)
argument_list|)
operator|==
literal|0
expr_stmt|;
name|intr
operator|++
expr_stmt|;
block|}
name|pktInfo
operator|.
name|intr
operator|=
operator|(
name|found
condition|?
name|intr
operator|-
literal|1
else|:
literal|0
operator|)
expr_stmt|;
return|return
operator|(
name|found
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
specifier|static
name|BOOL
name|PktSetAccess
parameter_list|(
name|void
parameter_list|)
block|{
name|reg
operator|.
name|r_ax
operator|=
literal|0x0200
operator|+
name|pktInfo
operator|.
name|class
expr_stmt|;
name|reg
operator|.
name|r_bx
operator|=
literal|0xFFFF
expr_stmt|;
name|reg
operator|.
name|r_dx
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|r_cx
operator|=
literal|0
expr_stmt|;
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
name|reg
operator|.
name|ds
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|esi
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|es
operator|=
name|RP_SEG
argument_list|(
name|realBase
argument_list|)
expr_stmt|;
name|reg
operator|.
name|edi
operator|=
operator|(
name|WORD
operator|)
operator|&
name|PktReceiver
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|reg
operator|.
name|x
operator|.
name|ds
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|x
operator|.
name|si
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|x
operator|.
name|es
operator|=
name|rm_mem
operator|.
name|rm_segment
expr_stmt|;
name|reg
operator|.
name|x
operator|.
name|di
operator|=
name|PktReceiver
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|reg
operator|.
name|r_ds
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|r_si
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|r_es
operator|=
name|rm_base_seg
expr_stmt|;
name|reg
operator|.
name|r_di
operator|=
name|PktReceiver
expr_stmt|;
else|#
directive|else
name|reg
operator|.
name|r_ds
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|r_si
operator|=
literal|0
expr_stmt|;
name|reg
operator|.
name|r_es
operator|=
name|FP_SEG
argument_list|(
operator|&
name|PktReceiver
argument_list|)
expr_stmt|;
name|reg
operator|.
name|r_di
operator|=
name|FP_OFF
argument_list|(
operator|&
name|PktReceiver
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|PktInterrupt
argument_list|()
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|pktInfo
operator|.
name|handle
operator|=
name|reg
operator|.
name|r_ax
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktReleaseHandle
parameter_list|(
name|WORD
name|handle
parameter_list|)
block|{
name|reg
operator|.
name|r_ax
operator|=
literal|0x0300
expr_stmt|;
name|reg
operator|.
name|r_bx
operator|=
name|handle
expr_stmt|;
return|return
name|PktInterrupt
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktTransmit
parameter_list|(
specifier|const
name|void
modifier|*
name|eth
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|>
name|ETH_MTU
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|reg
operator|.
name|r_ax
operator|=
literal|0x0400
expr_stmt|;
comment|/* Function 4, send pkt */
name|reg
operator|.
name|r_cx
operator|=
name|len
expr_stmt|;
comment|/* total size of frame  */
if|#
directive|if
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|dosmemput
argument_list|(
name|eth
argument_list|,
name|len
argument_list|,
name|realBase
operator|+
name|pktTxBuf
argument_list|)
expr_stmt|;
name|reg
operator|.
name|x
operator|.
name|ds
operator|=
name|rm_mem
operator|.
name|rm_segment
expr_stmt|;
comment|/* DOS data segment and */
name|reg
operator|.
name|x
operator|.
name|si
operator|=
name|pktTxBuf
expr_stmt|;
comment|/* DOS offset to buffer */
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|realBase
operator|+
name|pktTxBuf
operator|)
argument_list|,
name|eth
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|reg
operator|.
name|r_ds
operator|=
name|rm_base_seg
expr_stmt|;
name|reg
operator|.
name|r_si
operator|=
name|pktTxBuf
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
name|memcpy
argument_list|(
operator|&
name|pktTxBuf
argument_list|,
name|eth
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|reg
operator|.
name|r_ds
operator|=
name|FP_SEG
argument_list|(
operator|&
name|pktTxBuf
argument_list|)
expr_stmt|;
name|reg
operator|.
name|r_si
operator|=
name|FP_OFF
argument_list|(
operator|&
name|pktTxBuf
argument_list|)
expr_stmt|;
else|#
directive|else
name|reg
operator|.
name|r_ds
operator|=
name|FP_SEG
argument_list|(
name|eth
argument_list|)
expr_stmt|;
name|reg
operator|.
name|r_si
operator|=
name|FP_OFF
argument_list|(
name|eth
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|PktInterrupt
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_if
if|#
directive|if
operator|(
name|DOSX
operator|&
operator|(
name|DJGPP
operator||
name|DOS4GW
operator|)
operator|)
end_if

begin_decl_stmt
name|LOCAL
name|__inline
name|BOOL
name|CheckElement
argument_list|(
name|RX_ELEMENT
operator|*
name|rx
argument_list|)
else|#
directive|else
name|LOCAL
name|__inline
name|BOOL
name|CheckElement
argument_list|(
name|RX_ELEMENT
name|_far
operator|*
name|rx
argument_list|)
endif|#
directive|endif
block|{
name|WORD
name|count_1
decl_stmt|,
name|count_2
decl_stmt|;
comment|/*    * We got an upcall to the same RMCB with wrong handle.    * This can happen if we failed to release handle at program exit    */
if|if
condition|(
name|rx
operator|->
name|handle
operator|!=
name|pktInfo
operator|.
name|handle
condition|)
block|{
name|pktInfo
operator|.
name|error
operator|=
literal|"Wrong handle"
expr_stmt|;
name|intStat
operator|.
name|wrongHandle
operator|++
expr_stmt|;
name|PktReleaseHandle
argument_list|(
name|rx
operator|->
name|handle
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
name|count_1
operator|=
name|rx
operator|->
name|firstCount
expr_stmt|;
name|count_2
operator|=
name|rx
operator|->
name|secondCount
expr_stmt|;
if|if
condition|(
name|count_1
operator|!=
name|count_2
condition|)
block|{
name|pktInfo
operator|.
name|error
operator|=
literal|"Bad sync"
expr_stmt|;
name|intStat
operator|.
name|badSync
operator|++
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|if
condition|(
name|count_1
operator|>
name|ETH_MAX
condition|)
block|{
name|pktInfo
operator|.
name|error
operator|=
literal|"Large esize"
expr_stmt|;
name|intStat
operator|.
name|tooLarge
operator|++
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|#
directive|if
literal|0
block|if (count_1< ETH_MIN)   {     pktInfo.error = "Small esize";     intStat.tooSmall++;     return (FALSE);   }
endif|#
directive|endif
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_decl_stmt

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktTerminHandle
parameter_list|(
name|WORD
name|handle
parameter_list|)
block|{
name|reg
operator|.
name|r_ax
operator|=
literal|0x0500
expr_stmt|;
name|reg
operator|.
name|r_bx
operator|=
name|handle
expr_stmt|;
return|return
name|PktInterrupt
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktResetInterface
parameter_list|(
name|WORD
name|handle
parameter_list|)
block|{
name|reg
operator|.
name|r_ax
operator|=
literal|0x0700
expr_stmt|;
name|reg
operator|.
name|r_bx
operator|=
name|handle
expr_stmt|;
return|return
name|PktInterrupt
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktSetReceiverMode
parameter_list|(
name|PKT_RX_MODE
name|mode
parameter_list|)
block|{
if|if
condition|(
name|pktInfo
operator|.
name|class
operator|==
name|PD_SLIP
operator|||
name|pktInfo
operator|.
name|class
operator|==
name|PD_PPP
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
name|reg
operator|.
name|r_ax
operator|=
literal|0x1400
expr_stmt|;
name|reg
operator|.
name|r_bx
operator|=
name|pktInfo
operator|.
name|handle
expr_stmt|;
name|reg
operator|.
name|r_cx
operator|=
operator|(
name|WORD
operator|)
name|mode
expr_stmt|;
if|if
condition|(
operator|!
name|PktInterrupt
argument_list|()
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|receiveMode
operator|=
name|mode
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktGetReceiverMode
parameter_list|(
name|PKT_RX_MODE
modifier|*
name|mode
parameter_list|)
block|{
name|reg
operator|.
name|r_ax
operator|=
literal|0x1500
expr_stmt|;
name|reg
operator|.
name|r_bx
operator|=
name|pktInfo
operator|.
name|handle
expr_stmt|;
if|if
condition|(
operator|!
name|PktInterrupt
argument_list|()
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
operator|*
name|mode
operator|=
name|reg
operator|.
name|r_ax
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_decl_stmt
specifier|static
name|PKT_STAT
name|initialStat
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* statistics at startup */
end_comment

begin_decl_stmt
specifier|static
name|BOOL
name|resetStat
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* statistics reset ? */
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktGetStatistics
parameter_list|(
name|WORD
name|handle
parameter_list|)
block|{
name|reg
operator|.
name|r_ax
operator|=
literal|0x1800
expr_stmt|;
name|reg
operator|.
name|r_bx
operator|=
name|handle
expr_stmt|;
if|if
condition|(
operator|!
name|PktInterrupt
argument_list|()
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
name|ReadRealMem
argument_list|(
operator|&
name|pktStat
argument_list|,
name|DOS_ADDR
argument_list|(
name|reg
operator|.
name|ds
argument_list|,
name|reg
operator|.
name|esi
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|pktStat
argument_list|)
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|dosmemget
argument_list|(
name|DOS_ADDR
argument_list|(
name|reg
operator|.
name|x
operator|.
name|ds
argument_list|,
name|reg
operator|.
name|x
operator|.
name|si
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|pktStat
argument_list|)
argument_list|,
operator|&
name|pktStat
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|memcpy
argument_list|(
operator|&
name|pktStat
argument_list|,
operator|(
name|void
operator|*
operator|)
name|DOS_ADDR
argument_list|(
name|reg
operator|.
name|r_ds
argument_list|,
name|reg
operator|.
name|r_si
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|pktStat
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|_fmemcpy
argument_list|(
operator|&
name|pktStat
argument_list|,
name|MK_FP
argument_list|(
name|reg
operator|.
name|r_ds
argument_list|,
name|reg
operator|.
name|r_si
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|pktStat
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktSessStatistics
parameter_list|(
name|WORD
name|handle
parameter_list|)
block|{
if|if
condition|(
operator|!
name|PktGetStatistics
argument_list|(
name|pktInfo
operator|.
name|handle
argument_list|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
if|if
condition|(
name|resetStat
condition|)
block|{
name|pktStat
operator|.
name|inPackets
operator|-=
name|initialStat
operator|.
name|inPackets
expr_stmt|;
name|pktStat
operator|.
name|outPackets
operator|-=
name|initialStat
operator|.
name|outPackets
expr_stmt|;
name|pktStat
operator|.
name|inBytes
operator|-=
name|initialStat
operator|.
name|inBytes
expr_stmt|;
name|pktStat
operator|.
name|outBytes
operator|-=
name|initialStat
operator|.
name|outBytes
expr_stmt|;
name|pktStat
operator|.
name|inErrors
operator|-=
name|initialStat
operator|.
name|inErrors
expr_stmt|;
name|pktStat
operator|.
name|outErrors
operator|-=
name|initialStat
operator|.
name|outErrors
expr_stmt|;
name|pktStat
operator|.
name|outErrors
operator|-=
name|initialStat
operator|.
name|outErrors
expr_stmt|;
name|pktStat
operator|.
name|lost
operator|-=
name|initialStat
operator|.
name|lost
expr_stmt|;
block|}
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktResetStatistics
parameter_list|(
name|WORD
name|handle
parameter_list|)
block|{
if|if
condition|(
operator|!
name|PktGetStatistics
argument_list|(
name|pktInfo
operator|.
name|handle
argument_list|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|memcpy
argument_list|(
operator|&
name|initialStat
argument_list|,
operator|&
name|pktStat
argument_list|,
sizeof|sizeof
argument_list|(
name|initialStat
argument_list|)
argument_list|)
expr_stmt|;
name|resetStat
operator|=
name|TRUE
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktGetAddress
parameter_list|(
name|ETHER
modifier|*
name|addr
parameter_list|)
block|{
name|reg
operator|.
name|r_ax
operator|=
literal|0x0600
expr_stmt|;
name|reg
operator|.
name|r_bx
operator|=
name|pktInfo
operator|.
name|handle
expr_stmt|;
name|reg
operator|.
name|r_cx
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|reg
operator|.
name|x
operator|.
name|es
operator|=
name|rm_mem
operator|.
name|rm_segment
expr_stmt|;
name|reg
operator|.
name|x
operator|.
name|di
operator|=
name|pktTemp
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|reg
operator|.
name|r_es
operator|=
name|rm_base_seg
expr_stmt|;
name|reg
operator|.
name|r_di
operator|=
name|pktTemp
expr_stmt|;
else|#
directive|else
name|reg
operator|.
name|r_es
operator|=
name|FP_SEG
argument_list|(
operator|&
name|pktTemp
argument_list|)
expr_stmt|;
name|reg
operator|.
name|r_di
operator|=
name|FP_OFF
argument_list|(
operator|&
name|pktTemp
argument_list|)
expr_stmt|;
comment|/* ES:DI = address for result */
endif|#
directive|endif
if|if
condition|(
operator|!
name|PktInterrupt
argument_list|()
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
name|ReadRealMem
argument_list|(
name|addr
argument_list|,
name|realBase
operator|+
operator|(
name|WORD
operator|)
operator|&
name|pktTemp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|dosmemget
argument_list|(
name|realBase
operator|+
name|pktTemp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|,
name|addr
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|memcpy
argument_list|(
name|addr
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|realBase
operator|+
name|pktTemp
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
operator|&
name|pktTemp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktSetAddress
parameter_list|(
specifier|const
name|ETHER
modifier|*
name|addr
parameter_list|)
block|{
comment|/* copy addr to real-mode scrath area */
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
name|WriteRealMem
argument_list|(
name|realBase
operator|+
operator|(
name|WORD
operator|)
operator|&
name|pktTemp
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|dosmemput
argument_list|(
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|,
name|realBase
operator|+
name|pktTemp
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|realBase
operator|+
name|pktTemp
operator|)
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|memcpy
argument_list|(
operator|&
name|pktTemp
argument_list|,
operator|(
name|void
operator|*
operator|)
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|reg
operator|.
name|r_ax
operator|=
literal|0x1900
expr_stmt|;
name|reg
operator|.
name|r_cx
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
expr_stmt|;
comment|/* address length       */
if|#
directive|if
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|reg
operator|.
name|x
operator|.
name|es
operator|=
name|rm_mem
operator|.
name|rm_segment
expr_stmt|;
comment|/* DOS offset to param  */
name|reg
operator|.
name|x
operator|.
name|di
operator|=
name|pktTemp
expr_stmt|;
comment|/* DOS segment to param */
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|reg
operator|.
name|r_es
operator|=
name|rm_base_seg
expr_stmt|;
name|reg
operator|.
name|r_di
operator|=
name|pktTemp
expr_stmt|;
else|#
directive|else
name|reg
operator|.
name|r_es
operator|=
name|FP_SEG
argument_list|(
operator|&
name|pktTemp
argument_list|)
expr_stmt|;
name|reg
operator|.
name|r_di
operator|=
name|FP_OFF
argument_list|(
operator|&
name|pktTemp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|PktInterrupt
argument_list|()
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktGetDriverInfo
parameter_list|(
name|void
parameter_list|)
block|{
name|pktInfo
operator|.
name|majVer
operator|=
literal|0
expr_stmt|;
name|pktInfo
operator|.
name|minVer
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pktInfo
operator|.
name|name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pktInfo
operator|.
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|.
name|r_ax
operator|=
literal|0x01FF
expr_stmt|;
name|reg
operator|.
name|r_bx
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|PktInterrupt
argument_list|()
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|pktInfo
operator|.
name|number
operator|=
name|reg
operator|.
name|r_cx
operator|&
literal|0xFF
expr_stmt|;
name|pktInfo
operator|.
name|class
operator|=
name|reg
operator|.
name|r_cx
operator|>>
literal|8
expr_stmt|;
if|#
directive|if
literal|0
block|pktInfo.minVer = reg.r_bx % 10;   pktInfo.majVer = reg.r_bx / 10;
else|#
directive|else
name|pktInfo
operator|.
name|majVer
operator|=
name|reg
operator|.
name|r_bx
expr_stmt|;
comment|// !!
endif|#
directive|endif
name|pktInfo
operator|.
name|funcs
operator|=
name|reg
operator|.
name|r_ax
operator|&
literal|0xFF
expr_stmt|;
name|pktInfo
operator|.
name|type
operator|=
name|reg
operator|.
name|r_dx
operator|&
literal|0xFF
expr_stmt|;
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
name|ReadRealMem
argument_list|(
operator|&
name|pktInfo
operator|.
name|name
argument_list|,
name|DOS_ADDR
argument_list|(
name|reg
operator|.
name|ds
argument_list|,
name|reg
operator|.
name|esi
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|pktInfo
operator|.
name|name
argument_list|)
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|dosmemget
argument_list|(
name|DOS_ADDR
argument_list|(
name|reg
operator|.
name|x
operator|.
name|ds
argument_list|,
name|reg
operator|.
name|x
operator|.
name|si
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|pktInfo
operator|.
name|name
argument_list|)
argument_list|,
operator|&
name|pktInfo
operator|.
name|name
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|memcpy
argument_list|(
operator|&
name|pktInfo
operator|.
name|name
argument_list|,
operator|(
name|void
operator|*
operator|)
name|DOS_ADDR
argument_list|(
name|reg
operator|.
name|r_ds
argument_list|,
name|reg
operator|.
name|r_si
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|pktInfo
operator|.
name|name
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|_fmemcpy
argument_list|(
operator|&
name|pktInfo
operator|.
name|name
argument_list|,
name|MK_FP
argument_list|(
name|reg
operator|.
name|r_ds
argument_list|,
name|reg
operator|.
name|r_si
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|pktInfo
operator|.
name|name
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktGetDriverParam
parameter_list|(
name|void
parameter_list|)
block|{
name|reg
operator|.
name|r_ax
operator|=
literal|0x0A00
expr_stmt|;
if|if
condition|(
operator|!
name|PktInterrupt
argument_list|()
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
name|ReadRealMem
argument_list|(
operator|&
name|pktInfo
operator|.
name|majVer
argument_list|,
name|DOS_ADDR
argument_list|(
name|reg
operator|.
name|es
argument_list|,
name|reg
operator|.
name|edi
argument_list|)
argument_list|,
name|PKT_PARAM_SIZE
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|dosmemget
argument_list|(
name|DOS_ADDR
argument_list|(
name|reg
operator|.
name|x
operator|.
name|es
argument_list|,
name|reg
operator|.
name|x
operator|.
name|di
argument_list|)
argument_list|,
name|PKT_PARAM_SIZE
argument_list|,
operator|&
name|pktInfo
operator|.
name|majVer
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|memcpy
argument_list|(
operator|&
name|pktInfo
operator|.
name|majVer
argument_list|,
operator|(
name|void
operator|*
operator|)
name|DOS_ADDR
argument_list|(
name|reg
operator|.
name|r_es
argument_list|,
name|reg
operator|.
name|r_di
argument_list|)
argument_list|,
name|PKT_PARAM_SIZE
argument_list|)
expr_stmt|;
else|#
directive|else
name|_fmemcpy
argument_list|(
operator|&
name|pktInfo
operator|.
name|majVer
argument_list|,
name|MK_FP
argument_list|(
name|reg
operator|.
name|r_es
argument_list|,
name|reg
operator|.
name|r_di
argument_list|)
argument_list|,
name|PKT_PARAM_SIZE
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_if
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
end_if

begin_function
name|PUBLIC
name|int
name|PktReceive
parameter_list|(
name|BYTE
modifier|*
name|buf
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|WORD
name|inOfs
init|=
operator|*
name|rxInOfsFp
decl_stmt|;
name|WORD
name|outOfs
init|=
operator|*
name|rxOutOfsFp
decl_stmt|;
if|if
condition|(
name|outOfs
operator|!=
name|inOfs
condition|)
block|{
name|RX_ELEMENT
name|_far
modifier|*
name|head
init|=
operator|(
name|RX_ELEMENT
name|_far
operator|*
operator|)
operator|(
name|protBase
operator|+
name|outOfs
operator|)
decl_stmt|;
name|int
name|size
decl_stmt|,
name|len
init|=
name|max
decl_stmt|;
if|if
condition|(
name|CheckElement
argument_list|(
name|head
argument_list|)
condition|)
block|{
name|size
operator|=
name|min
argument_list|(
name|head
operator|->
name|firstCount
argument_list|,
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|min
argument_list|(
name|size
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|_fmemcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|head
operator|->
name|destin
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
name|size
operator|=
operator|-
literal|1
expr_stmt|;
name|outOfs
operator|+=
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|outOfs
operator|>
name|LAST_RX_BUF
condition|)
name|outOfs
operator|=
name|FIRST_RX_BUF
expr_stmt|;
operator|*
name|rxOutOfsFp
operator|=
name|outOfs
expr_stmt|;
return|return
operator|(
name|size
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|PUBLIC
name|void
name|PktQueueBusy
parameter_list|(
name|BOOL
name|busy
parameter_list|)
block|{
operator|*
name|rxOutOfsFp
operator|=
name|busy
condition|?
operator|(
operator|*
name|rxInOfsFp
operator|+
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
operator|)
else|:
operator|*
name|rxInOfsFp
expr_stmt|;
if|if
condition|(
operator|*
name|rxOutOfsFp
operator|>
name|LAST_RX_BUF
condition|)
operator|*
name|rxOutOfsFp
operator|=
name|FIRST_RX_BUF
expr_stmt|;
operator|*
operator|(
name|DWORD
name|_far
operator|*
operator|)
operator|(
name|protBase
operator|+
operator|(
name|WORD
operator|)
operator|&
name|pktDrop
operator|)
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|PUBLIC
name|WORD
name|PktBuffersUsed
parameter_list|(
name|void
parameter_list|)
block|{
name|WORD
name|inOfs
init|=
operator|*
name|rxInOfsFp
decl_stmt|;
name|WORD
name|outOfs
init|=
operator|*
name|rxOutOfsFp
decl_stmt|;
if|if
condition|(
name|inOfs
operator|>=
name|outOfs
condition|)
return|return
operator|(
name|inOfs
operator|-
name|outOfs
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
return|;
return|return
operator|(
name|NUM_RX_BUF
operator|-
operator|(
name|outOfs
operator|-
name|inOfs
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|PUBLIC
name|DWORD
name|PktRxDropped
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
operator|*
operator|(
name|DWORD
name|_far
operator|*
operator|)
operator|(
name|protBase
operator|+
operator|(
name|WORD
operator|)
operator|&
name|pktDrop
operator|)
operator|)
return|;
block|}
end_function

begin_elif
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
end_elif

begin_function
name|PUBLIC
name|int
name|PktReceive
parameter_list|(
name|BYTE
modifier|*
name|buf
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|WORD
name|ofs
init|=
name|_farpeekw
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxOutOfs
argument_list|)
decl_stmt|;
if|if
condition|(
name|ofs
operator|!=
name|_farpeekw
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxInOfs
argument_list|)
condition|)
block|{
name|RX_ELEMENT
name|head
decl_stmt|;
name|int
name|size
decl_stmt|,
name|len
init|=
name|max
decl_stmt|;
name|head
operator|.
name|firstCount
operator|=
name|_farpeekw
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|ofs
argument_list|)
expr_stmt|;
name|head
operator|.
name|secondCount
operator|=
name|_farpeekw
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|ofs
operator|+
literal|2
argument_list|)
expr_stmt|;
name|head
operator|.
name|handle
operator|=
name|_farpeekw
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|ofs
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|CheckElement
argument_list|(
operator|&
name|head
argument_list|)
condition|)
block|{
name|size
operator|=
name|min
argument_list|(
name|head
operator|.
name|firstCount
argument_list|,
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|min
argument_list|(
name|size
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|dosmemget
argument_list|(
name|realBase
operator|+
name|ofs
operator|+
literal|6
argument_list|,
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
name|size
operator|=
operator|-
literal|1
expr_stmt|;
name|ofs
operator|+=
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ofs
operator|>
name|LAST_RX_BUF
condition|)
name|_farpokew
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxOutOfs
argument_list|,
name|FIRST_RX_BUF
argument_list|)
expr_stmt|;
else|else
name|_farpokew
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxOutOfs
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
return|return
operator|(
name|size
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|PUBLIC
name|void
name|PktQueueBusy
parameter_list|(
name|BOOL
name|busy
parameter_list|)
block|{
name|WORD
name|ofs
decl_stmt|;
name|disable
argument_list|()
expr_stmt|;
name|ofs
operator|=
name|_farpeekw
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxInOfs
argument_list|)
expr_stmt|;
if|if
condition|(
name|busy
condition|)
name|ofs
operator|+=
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ofs
operator|>
name|LAST_RX_BUF
condition|)
name|_farpokew
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxOutOfs
argument_list|,
name|FIRST_RX_BUF
argument_list|)
expr_stmt|;
else|else
name|_farpokew
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxOutOfs
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
name|_farpokel
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|pktDrop
argument_list|,
literal|0UL
argument_list|)
expr_stmt|;
name|enable
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|PUBLIC
name|WORD
name|PktBuffersUsed
parameter_list|(
name|void
parameter_list|)
block|{
name|WORD
name|inOfs
decl_stmt|,
name|outOfs
decl_stmt|;
name|disable
argument_list|()
expr_stmt|;
name|inOfs
operator|=
name|_farpeekw
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxInOfs
argument_list|)
expr_stmt|;
name|outOfs
operator|=
name|_farpeekw
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxOutOfs
argument_list|)
expr_stmt|;
name|enable
argument_list|()
expr_stmt|;
if|if
condition|(
name|inOfs
operator|>=
name|outOfs
condition|)
return|return
operator|(
name|inOfs
operator|-
name|outOfs
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
return|;
return|return
operator|(
name|NUM_RX_BUF
operator|-
operator|(
name|outOfs
operator|-
name|inOfs
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|PUBLIC
name|DWORD
name|PktRxDropped
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|_farpeekl
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|pktDrop
argument_list|)
return|;
block|}
end_function

begin_elif
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
end_elif

begin_function
name|PUBLIC
name|int
name|PktReceive
parameter_list|(
name|BYTE
modifier|*
name|buf
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|WORD
name|ofs
init|=
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxOutOfs
operator|)
decl_stmt|;
if|if
condition|(
name|ofs
operator|!=
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxInOfs
operator|)
condition|)
block|{
name|RX_ELEMENT
name|head
decl_stmt|;
name|int
name|size
decl_stmt|,
name|len
init|=
name|max
decl_stmt|;
name|head
operator|.
name|firstCount
operator|=
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|ofs
operator|)
expr_stmt|;
name|head
operator|.
name|secondCount
operator|=
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|ofs
operator|+
literal|2
operator|)
expr_stmt|;
name|head
operator|.
name|handle
operator|=
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|ofs
operator|+
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|CheckElement
argument_list|(
operator|&
name|head
argument_list|)
condition|)
block|{
name|size
operator|=
name|min
argument_list|(
name|head
operator|.
name|firstCount
argument_list|,
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|min
argument_list|(
name|size
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|(
name|realBase
operator|+
name|ofs
operator|+
literal|6
operator|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
name|size
operator|=
operator|-
literal|1
expr_stmt|;
name|ofs
operator|+=
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ofs
operator|>
name|LAST_RX_BUF
condition|)
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxOutOfs
operator|)
operator|=
name|FIRST_RX_BUF
expr_stmt|;
else|else
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxOutOfs
operator|)
operator|=
name|ofs
expr_stmt|;
return|return
operator|(
name|size
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|PUBLIC
name|void
name|PktQueueBusy
parameter_list|(
name|BOOL
name|busy
parameter_list|)
block|{
name|WORD
name|ofs
decl_stmt|;
name|_disable
argument_list|()
expr_stmt|;
name|ofs
operator|=
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxInOfs
operator|)
expr_stmt|;
if|if
condition|(
name|busy
condition|)
name|ofs
operator|+=
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ofs
operator|>
name|LAST_RX_BUF
condition|)
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxOutOfs
operator|)
operator|=
name|FIRST_RX_BUF
expr_stmt|;
else|else
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxOutOfs
operator|)
operator|=
name|ofs
expr_stmt|;
operator|*
operator|(
name|DWORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|pktDrop
operator|)
operator|=
literal|0UL
expr_stmt|;
name|_enable
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|PUBLIC
name|WORD
name|PktBuffersUsed
parameter_list|(
name|void
parameter_list|)
block|{
name|WORD
name|inOfs
decl_stmt|,
name|outOfs
decl_stmt|;
name|_disable
argument_list|()
expr_stmt|;
name|inOfs
operator|=
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxInOfs
operator|)
expr_stmt|;
name|outOfs
operator|=
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxOutOfs
operator|)
expr_stmt|;
name|_enable
argument_list|()
expr_stmt|;
if|if
condition|(
name|inOfs
operator|>=
name|outOfs
condition|)
return|return
operator|(
name|inOfs
operator|-
name|outOfs
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
return|;
return|return
operator|(
name|NUM_RX_BUF
operator|-
operator|(
name|outOfs
operator|-
name|inOfs
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|PUBLIC
name|DWORD
name|PktRxDropped
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|*
operator|(
name|DWORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|pktDrop
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* real-mode small/large model */
end_comment

begin_function
name|PUBLIC
name|int
name|PktReceive
parameter_list|(
name|BYTE
modifier|*
name|buf
parameter_list|,
name|int
name|max
parameter_list|)
block|{
if|if
condition|(
name|rxOutOfs
operator|!=
name|rxInOfs
condition|)
block|{
name|RX_ELEMENT
name|far
modifier|*
name|head
init|=
operator|(
name|RX_ELEMENT
name|far
operator|*
operator|)
name|MK_FP
argument_list|(
name|_DS
argument_list|,
name|rxOutOfs
argument_list|)
decl_stmt|;
name|int
name|size
decl_stmt|,
name|len
init|=
name|max
decl_stmt|;
if|if
condition|(
name|CheckElement
argument_list|(
name|head
argument_list|)
condition|)
block|{
name|size
operator|=
name|min
argument_list|(
name|head
operator|->
name|firstCount
argument_list|,
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|min
argument_list|(
name|size
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|_fmemcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|head
operator|->
name|destin
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
name|size
operator|=
operator|-
literal|1
expr_stmt|;
name|rxOutOfs
operator|+=
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxOutOfs
operator|>
name|LAST_RX_BUF
condition|)
name|rxOutOfs
operator|=
name|FIRST_RX_BUF
expr_stmt|;
return|return
operator|(
name|size
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|PUBLIC
name|void
name|PktQueueBusy
parameter_list|(
name|BOOL
name|busy
parameter_list|)
block|{
name|rxOutOfs
operator|=
name|busy
condition|?
operator|(
name|rxInOfs
operator|+
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
operator|)
else|:
name|rxInOfs
expr_stmt|;
if|if
condition|(
name|rxOutOfs
operator|>
name|LAST_RX_BUF
condition|)
name|rxOutOfs
operator|=
name|FIRST_RX_BUF
expr_stmt|;
name|pktDrop
operator|=
literal|0L
expr_stmt|;
block|}
end_function

begin_function
name|PUBLIC
name|WORD
name|PktBuffersUsed
parameter_list|(
name|void
parameter_list|)
block|{
name|WORD
name|inOfs
init|=
name|rxInOfs
decl_stmt|;
name|WORD
name|outOfs
init|=
name|rxOutOfs
decl_stmt|;
if|if
condition|(
name|inOfs
operator|>=
name|outOfs
condition|)
return|return
operator|(
operator|(
name|inOfs
operator|-
name|outOfs
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
operator|)
return|;
return|return
operator|(
name|NUM_RX_BUF
operator|-
operator|(
name|outOfs
operator|-
name|inOfs
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|RX_ELEMENT
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|PUBLIC
name|DWORD
name|PktRxDropped
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|pktDrop
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|LOCAL
name|__inline
name|void
name|PktFreeMem
parameter_list|(
name|void
parameter_list|)
block|{
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
if|if
condition|(
name|realSeg
condition|)
block|{
name|_dx_real_free
argument_list|(
name|realSeg
argument_list|)
expr_stmt|;
name|realSeg
operator|=
literal|0
expr_stmt|;
block|}
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
if|if
condition|(
name|rm_mem
operator|.
name|rm_segment
condition|)
block|{
name|unsigned
name|ofs
decl_stmt|;
comment|/* clear the DOS-mem to prevent further upcalls */
for|for
control|(
name|ofs
operator|=
literal|0
init|;
name|ofs
operator|<
literal|16
operator|*
name|rm_mem
operator|.
name|size
operator|/
literal|4
condition|;
name|ofs
operator|+=
literal|4
control|)
name|_farpokel
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|ofs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_go32_dpmi_free_dos_memory
argument_list|(
operator|&
name|rm_mem
argument_list|)
expr_stmt|;
name|rm_mem
operator|.
name|rm_segment
operator|=
literal|0
expr_stmt|;
block|}
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
if|if
condition|(
name|rm_base_sel
condition|)
block|{
name|dpmi_real_free
argument_list|(
name|rm_base_sel
argument_list|)
expr_stmt|;
name|rm_base_sel
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktExitDriver
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|pktInfo
operator|.
name|handle
condition|)
block|{
if|if
condition|(
operator|!
name|PktSetReceiverMode
argument_list|(
name|PDRX_BROADCAST
argument_list|)
condition|)
name|PUTS
argument_list|(
literal|"Error restoring receiver mode."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|PktReleaseHandle
argument_list|(
name|pktInfo
operator|.
name|handle
argument_list|)
condition|)
name|PUTS
argument_list|(
literal|"Error releasing PKT-DRVR handle."
argument_list|)
expr_stmt|;
name|PktFreeMem
argument_list|()
expr_stmt|;
name|pktInfo
operator|.
name|handle
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|pcap_pkt_debug
operator|>=
literal|1
condition|)
name|printf
argument_list|(
literal|"Internal stats: too-small %lu, too-large %lu, bad-sync %lu, "
literal|"wrong-handle %lu\n"
argument_list|,
name|intStat
operator|.
name|tooSmall
argument_list|,
name|intStat
operator|.
name|tooLarge
argument_list|,
name|intStat
operator|.
name|badSync
argument_list|,
name|intStat
operator|.
name|wrongHandle
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|DOSX
operator|&
operator|(
name|DJGPP
operator||
name|DOS4GW
operator|)
operator|)
end_if

begin_function
specifier|static
name|void
name|dump_pkt_stub
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PktReceiver %lu, pkt_stub[PktReceiver] =\n"
argument_list|,
name|PktReceiver
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|15
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%02X, "
argument_list|,
name|real_stub_array
index|[
name|i
operator|+
name|PktReceiver
index|]
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Front end initialization routine  */
end_comment

begin_function
name|PUBLIC
name|BOOL
name|PktInitDriver
parameter_list|(
name|PKT_RX_MODE
name|mode
parameter_list|)
block|{
name|PKT_RX_MODE
name|rxMode
decl_stmt|;
name|BOOL
name|writeInfo
init|=
operator|(
name|pcap_pkt_debug
operator|>=
literal|3
operator|)
decl_stmt|;
name|pktInfo
operator|.
name|quiet
operator|=
operator|(
name|pcap_pkt_debug
operator|<
literal|3
operator|)
expr_stmt|;
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
operator|&&
name|defined
argument_list|(
name|__HIGHC__
argument_list|)
if|if
condition|(
name|_mwenv
operator|!=
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Only Pharlap DOS extender supported.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
endif|#
directive|endif
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
operator|&&
name|defined
argument_list|(
name|__WATCOMC__
argument_list|)
if|if
condition|(
name|_Extender
operator|!=
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Only DOS4GW style extenders supported.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|PktSearchDriver
argument_list|()
condition|)
block|{
name|PUTS
argument_list|(
literal|"Packet driver not found."
argument_list|)
expr_stmt|;
name|PktFreeMem
argument_list|()
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|PktGetDriverInfo
argument_list|()
condition|)
block|{
name|PUTS
argument_list|(
literal|"Error getting pkt-drvr information."
argument_list|)
expr_stmt|;
name|PktFreeMem
argument_list|()
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|#
directive|if
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
if|if
condition|(
name|RealCopy
argument_list|(
operator|(
name|ULONG
operator|)
operator|&
name|rxOutOfs
argument_list|,
operator|(
name|ULONG
operator|)
operator|&
name|pktRxEnd
argument_list|,
operator|&
name|realBase
argument_list|,
operator|&
name|protBase
argument_list|,
operator|(
name|USHORT
operator|*
operator|)
operator|&
name|realSeg
argument_list|)
condition|)
block|{
name|rxOutOfsFp
operator|=
operator|(
name|WORD
name|_far
operator|*
operator|)
operator|(
name|protBase
operator|+
operator|(
name|WORD
operator|)
operator|&
name|rxOutOfs
operator|)
expr_stmt|;
name|rxInOfsFp
operator|=
operator|(
name|WORD
name|_far
operator|*
operator|)
operator|(
name|protBase
operator|+
operator|(
name|WORD
operator|)
operator|&
name|rxInOfs
operator|)
expr_stmt|;
operator|*
name|rxOutOfsFp
operator|=
name|FIRST_RX_BUF
expr_stmt|;
operator|*
name|rxInOfsFp
operator|=
name|FIRST_RX_BUF
expr_stmt|;
block|}
else|else
block|{
name|PUTS
argument_list|(
literal|"Cannot allocate real-mode stub."
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
elif|#
directive|elif
operator|(
name|DOSX
operator|&
operator|(
name|DJGPP
operator||
name|DOS4GW
operator|)
operator|)
if|if
condition|(
sizeof|sizeof
argument_list|(
name|real_stub_array
argument_list|)
operator|>
literal|0xFFFF
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"`real_stub_array[]' too big.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|#
directive|if
operator|(
name|DOSX
operator|&
name|DJGPP
operator|)
name|rm_mem
operator|.
name|size
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|real_stub_array
argument_list|)
operator|+
literal|15
operator|)
operator|/
literal|16
expr_stmt|;
if|if
condition|(
name|_go32_dpmi_allocate_dos_memory
argument_list|(
operator|&
name|rm_mem
argument_list|)
operator|||
name|rm_mem
operator|.
name|rm_offset
operator|!=
literal|0
condition|)
block|{
name|PUTS
argument_list|(
literal|"real-mode init failed."
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
name|realBase
operator|=
operator|(
name|rm_mem
operator|.
name|rm_segment
operator|<<
literal|4
operator|)
expr_stmt|;
name|dosmemput
argument_list|(
operator|&
name|real_stub_array
argument_list|,
sizeof|sizeof
argument_list|(
name|real_stub_array
argument_list|)
argument_list|,
name|realBase
argument_list|)
expr_stmt|;
name|_farpokel
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxOutOfs
argument_list|,
name|FIRST_RX_BUF
argument_list|)
expr_stmt|;
name|_farpokel
argument_list|(
name|_dos_ds
argument_list|,
name|realBase
operator|+
name|rxInOfs
argument_list|,
name|FIRST_RX_BUF
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
name|rm_base_seg
operator|=
name|dpmi_real_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|real_stub_array
argument_list|)
argument_list|,
operator|&
name|rm_base_sel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rm_base_seg
condition|)
block|{
name|PUTS
argument_list|(
literal|"real-mode init failed."
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
name|realBase
operator|=
operator|(
name|rm_base_seg
operator|<<
literal|4
operator|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
name|realBase
argument_list|,
operator|&
name|real_stub_array
argument_list|,
sizeof|sizeof
argument_list|(
name|real_stub_array
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxOutOfs
operator|)
operator|=
name|FIRST_RX_BUF
expr_stmt|;
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|realBase
operator|+
name|rxInOfs
operator|)
operator|=
name|FIRST_RX_BUF
expr_stmt|;
endif|#
directive|endif
block|{
name|int
name|pushf
init|=
name|PktReceiver
decl_stmt|;
while|while
condition|(
name|real_stub_array
index|[
name|pushf
operator|++
index|]
operator|!=
literal|0x9C
operator|&&
comment|/* pushf */
name|real_stub_array
index|[
name|pushf
index|]
operator|!=
literal|0xFA
condition|)
comment|/* cli   */
block|{
if|if
condition|(
operator|++
name|para_skip
operator|>
literal|16
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Something wrong with `pkt_stub.inc'.\n"
argument_list|)
expr_stmt|;
name|para_skip
operator|=
literal|0
expr_stmt|;
name|dump_pkt_stub
argument_list|()
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
block|}
if|if
condition|(
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|real_stub_array
operator|+
name|offsetof
argument_list|(
name|PktRealStub
argument_list|,
name|_dummy
argument_list|)
operator|)
operator|!=
literal|0xB800
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"`real_stub_array[]' is misaligned.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
block|}
if|if
condition|(
name|pcap_pkt_debug
operator|>
literal|2
condition|)
name|dump_pkt_stub
argument_list|()
expr_stmt|;
else|#
directive|else
name|rxOutOfs
operator|=
name|FIRST_RX_BUF
expr_stmt|;
name|rxInOfs
operator|=
name|FIRST_RX_BUF
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|PktSetAccess
argument_list|()
condition|)
block|{
name|PUTS
argument_list|(
literal|"Error setting pkt-drvr access."
argument_list|)
expr_stmt|;
name|PktFreeMem
argument_list|()
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|PktGetAddress
argument_list|(
operator|&
name|myAddress
argument_list|)
condition|)
block|{
name|PUTS
argument_list|(
literal|"Error fetching adapter address."
argument_list|)
expr_stmt|;
name|PktFreeMem
argument_list|()
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|PktSetReceiverMode
argument_list|(
name|mode
argument_list|)
condition|)
block|{
name|PUTS
argument_list|(
literal|"Error setting receiver mode."
argument_list|)
expr_stmt|;
name|PktFreeMem
argument_list|()
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|PktGetReceiverMode
argument_list|(
operator|&
name|rxMode
argument_list|)
condition|)
block|{
name|PUTS
argument_list|(
literal|"Error getting receiver mode."
argument_list|)
expr_stmt|;
name|PktFreeMem
argument_list|()
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|if
condition|(
name|writeInfo
condition|)
name|printf
argument_list|(
literal|"Pkt-driver information:\n"
literal|"  Version  : %d.%d\n"
literal|"  Name     : %.15s\n"
literal|"  Class    : %u (%s)\n"
literal|"  Type     : %u\n"
literal|"  Number   : %u\n"
literal|"  Funcs    : %u\n"
literal|"  Intr     : %Xh\n"
literal|"  Handle   : %u\n"
literal|"  Extended : %s\n"
literal|"  Hi-perf  : %s\n"
literal|"  RX mode  : %s\n"
literal|"  Eth-addr : %02X:%02X:%02X:%02X:%02X:%02X\n"
argument_list|,
name|pktInfo
operator|.
name|majVer
argument_list|,
name|pktInfo
operator|.
name|minVer
argument_list|,
name|pktInfo
operator|.
name|name
argument_list|,
name|pktInfo
operator|.
name|class
argument_list|,
name|PktGetClassName
argument_list|(
name|pktInfo
operator|.
name|class
argument_list|)
argument_list|,
name|pktInfo
operator|.
name|type
argument_list|,
name|pktInfo
operator|.
name|number
argument_list|,
name|pktInfo
operator|.
name|funcs
argument_list|,
name|pktInfo
operator|.
name|intr
argument_list|,
name|pktInfo
operator|.
name|handle
argument_list|,
name|pktInfo
operator|.
name|funcs
operator|==
literal|2
operator|||
name|pktInfo
operator|.
name|funcs
operator|==
literal|6
condition|?
literal|"Yes"
else|:
literal|"No"
argument_list|,
name|pktInfo
operator|.
name|funcs
operator|==
literal|5
operator|||
name|pktInfo
operator|.
name|funcs
operator|==
literal|6
condition|?
literal|"Yes"
else|:
literal|"No"
argument_list|,
name|PktRXmodeStr
argument_list|(
name|rxMode
argument_list|)
argument_list|,
name|myAddress
index|[
literal|0
index|]
argument_list|,
name|myAddress
index|[
literal|1
index|]
argument_list|,
name|myAddress
index|[
literal|2
index|]
argument_list|,
name|myAddress
index|[
literal|3
index|]
argument_list|,
name|myAddress
index|[
literal|4
index|]
argument_list|,
name|myAddress
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG
argument_list|)
operator|&&
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
if|if
condition|(
name|writeInfo
condition|)
block|{
name|DWORD
name|rAdr
init|=
name|realBase
operator|+
operator|(
name|WORD
operator|)
operator|&
name|PktReceiver
decl_stmt|;
name|unsigned
name|sel
decl_stmt|,
name|ofs
decl_stmt|;
name|printf
argument_list|(
literal|"\nReceiver at   %04X:%04X\n"
argument_list|,
name|RP_SEG
argument_list|(
name|rAdr
argument_list|)
argument_list|,
name|RP_OFF
argument_list|(
name|rAdr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Realbase    = %04X:%04X\n"
argument_list|,
name|RP_SEG
argument_list|(
name|realBase
argument_list|)
argument_list|,
name|RP_OFF
argument_list|(
name|realBase
argument_list|)
argument_list|)
expr_stmt|;
name|sel
operator|=
name|_FP_SEG
argument_list|(
name|protBase
argument_list|)
expr_stmt|;
name|ofs
operator|=
name|_FP_OFF
argument_list|(
name|protBase
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Protbase    = %04X:%08X\n"
argument_list|,
name|sel
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RealSeg     = %04X\n"
argument_list|,
name|realSeg
argument_list|)
expr_stmt|;
name|sel
operator|=
name|_FP_SEG
argument_list|(
name|rxOutOfsFp
argument_list|)
expr_stmt|;
name|ofs
operator|=
name|_FP_OFF
argument_list|(
name|rxOutOfsFp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"rxOutOfsFp  = %04X:%08X\n"
argument_list|,
name|sel
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
name|sel
operator|=
name|_FP_SEG
argument_list|(
name|rxInOfsFp
argument_list|)
expr_stmt|;
name|ofs
operator|=
name|_FP_OFF
argument_list|(
name|rxInOfsFp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"rxInOfsFp   = %04X:%08X\n"
argument_list|,
name|sel
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Ready: *rxOutOfsFp = %04X *rxInOfsFp = %04X\n"
argument_list|,
operator|*
name|rxOutOfsFp
argument_list|,
operator|*
name|rxInOfsFp
argument_list|)
expr_stmt|;
name|PktQueueBusy
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Busy:  *rxOutOfsFp = %04X *rxInOfsFp = %04X\n"
argument_list|,
operator|*
name|rxOutOfsFp
argument_list|,
operator|*
name|rxInOfsFp
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|memset
argument_list|(
operator|&
name|pktStat
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pktStat
argument_list|)
argument_list|)
expr_stmt|;
comment|/* clear statistics */
name|PktQueueBusy
argument_list|(
name|TRUE
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * DPMI functions only for Watcom + DOS4GW extenders  */
end_comment

begin_if
if|#
directive|if
operator|(
name|DOSX
operator|&
name|DOS4GW
operator|)
end_if

begin_function
name|LOCAL
name|DWORD
name|dpmi_get_real_vector
parameter_list|(
name|int
name|intr
parameter_list|)
block|{
name|union
name|REGS
name|r
decl_stmt|;
name|r
operator|.
name|x
operator|.
name|eax
operator|=
literal|0x200
expr_stmt|;
name|r
operator|.
name|x
operator|.
name|ebx
operator|=
operator|(
name|DWORD
operator|)
name|intr
expr_stmt|;
name|int386
argument_list|(
literal|0x31
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|r
operator|.
name|w
operator|.
name|cx
operator|<<
literal|4
operator|)
operator|+
name|r
operator|.
name|w
operator|.
name|dx
operator|)
return|;
block|}
end_function

begin_function
name|LOCAL
name|WORD
name|dpmi_real_malloc
parameter_list|(
name|int
name|size
parameter_list|,
name|WORD
modifier|*
name|selector
parameter_list|)
block|{
name|union
name|REGS
name|r
decl_stmt|;
name|r
operator|.
name|x
operator|.
name|eax
operator|=
literal|0x0100
expr_stmt|;
comment|/* DPMI allocate DOS memory */
name|r
operator|.
name|x
operator|.
name|ebx
operator|=
operator|(
name|size
operator|+
literal|15
operator|)
operator|/
literal|16
expr_stmt|;
comment|/* Number of paragraphs requested */
name|int386
argument_list|(
literal|0x31
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|.
name|w
operator|.
name|cflag
operator|&
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|*
name|selector
operator|=
name|r
operator|.
name|w
operator|.
name|dx
expr_stmt|;
return|return
operator|(
name|r
operator|.
name|w
operator|.
name|ax
operator|)
return|;
comment|/* Return segment address */
block|}
end_function

begin_function
name|LOCAL
name|void
name|dpmi_real_free
parameter_list|(
name|WORD
name|selector
parameter_list|)
block|{
name|union
name|REGS
name|r
decl_stmt|;
name|r
operator|.
name|x
operator|.
name|eax
operator|=
literal|0x101
expr_stmt|;
comment|/* DPMI free DOS memory */
name|r
operator|.
name|x
operator|.
name|ebx
operator|=
name|selector
expr_stmt|;
comment|/* Selector to free */
name|int386
argument_list|(
literal|0x31
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|DOSX
argument_list|)
operator|&&
operator|(
name|DOSX
operator|&
name|PHARLAP
operator|)
end_if

begin_comment
comment|/*  * Description:  *     This routine allocates conventional memory for the specified block  *     of code (which must be within the first 64K of the protected mode  *     program segment) and copies the code to it.  *  *     The caller should free up the conventional memory block when it  *     is done with the conventional memory.  *  *     NOTE THIS ROUTINE REQUIRES 386|DOS-EXTENDER 3.0 OR LATER.  *  * Calling arguments:  *     start_offs      start of real mode code in program segment  *     end_offs        1 byte past end of real mode code in program segment  *     real_basep      returned;  real mode ptr to use as a base for the  *                        real mode code (eg, to get the real mode FAR  *                        addr of a function foo(), take  *                        real_basep + (ULONG) foo).  *                        This pointer is constructed such that  *                        offsets within the real mode segment are  *                        the same as the link-time offsets in the  *                        protected mode program segment  *     prot_basep      returned;  prot mode ptr to use as a base for getting  *                        to the conventional memory, also constructed  *                        so that adding the prot mode offset of a  *                        function or variable to the base gets you a  *                        ptr to the function or variable in the  *                        conventional memory block.  *     rmem_adrp       returned;  real mode para addr of allocated  *                        conventional memory block, to be used to free  *                        up the conventional memory when done.  DO NOT  *                        USE THIS TO CONSTRUCT A REAL MODE PTR, USE  *                        REAL_BASEP INSTEAD SO THAT OFFSETS WORK OUT  *                        CORRECTLY.  *  * Returned values:  *     0      if error  *     1      if success  */
end_comment

begin_function
name|int
name|RealCopy
parameter_list|(
name|ULONG
name|start_offs
parameter_list|,
name|ULONG
name|end_offs
parameter_list|,
name|REALPTR
modifier|*
name|real_basep
parameter_list|,
name|FARPTR
modifier|*
name|prot_basep
parameter_list|,
name|USHORT
modifier|*
name|rmem_adrp
parameter_list|)
block|{
name|ULONG
name|rm_base
decl_stmt|;
comment|/* base real mode para addr for accessing */
comment|/* allocated conventional memory          */
name|UCHAR
modifier|*
name|source
decl_stmt|;
comment|/* source pointer for copy                */
name|FARPTR
name|destin
decl_stmt|;
comment|/* destination pointer for copy           */
name|ULONG
name|len
decl_stmt|;
comment|/* number of bytes to copy                */
name|ULONG
name|temp
decl_stmt|;
name|USHORT
name|stemp
decl_stmt|;
comment|/* First check for valid inputs    */
if|if
condition|(
name|start_offs
operator|>=
name|end_offs
operator|||
name|end_offs
operator|>
literal|0x10000
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
comment|/* Round start_offs down to a paragraph (16-byte) boundary so we can set up    * the real mode pointer easily. Round up end_offs to make sure we allocate    * enough paragraphs    */
name|start_offs
operator|&=
operator|~
literal|15
expr_stmt|;
name|end_offs
operator|=
operator|(
literal|15
operator|+
operator|(
name|end_offs
operator|<<
literal|4
operator|)
operator|)
operator|>>
literal|4
expr_stmt|;
comment|/* Allocate the conventional memory for our real mode code.  Remember to    * round byte count UP to 16-byte paragraph size.  We alloc it    * above the DOS data buffer so both the DOS data buffer and the appl    * conventional mem block can still be resized.    *    * First just try to alloc it;  if we can't get it, shrink the appl mem    * block down to the minimum, try to alloc the memory again, then grow the    * appl mem block back to the maximum.  (Don't try to shrink the DOS data    * buffer to free conventional memory;  it wouldn't be good for this routine    * to have the possible side effect of making file I/O run slower.)    */
name|len
operator|=
operator|(
operator|(
name|end_offs
operator|-
name|start_offs
operator|)
operator|+
literal|15
operator|)
operator|>>
literal|4
expr_stmt|;
if|if
condition|(
name|_dx_real_above
argument_list|(
name|len
argument_list|,
name|rmem_adrp
argument_list|,
operator|&
name|stemp
argument_list|)
operator|!=
name|_DOSE_NONE
condition|)
block|{
if|if
condition|(
name|_dx_cmem_usage
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|temp
argument_list|,
operator|&
name|temp
argument_list|)
operator|!=
name|_DOSE_NONE
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
if|if
condition|(
name|_dx_real_above
argument_list|(
name|len
argument_list|,
name|rmem_adrp
argument_list|,
operator|&
name|stemp
argument_list|)
operator|!=
name|_DOSE_NONE
condition|)
operator|*
name|rmem_adrp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|_dx_cmem_usage
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
operator|&
name|temp
argument_list|,
operator|&
name|temp
argument_list|)
operator|!=
name|_DOSE_NONE
condition|)
block|{
if|if
condition|(
operator|*
name|rmem_adrp
operator|!=
literal|0
condition|)
name|_dx_real_free
argument_list|(
operator|*
name|rmem_adrp
argument_list|)
expr_stmt|;
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|rmem_adrp
operator|==
literal|0
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
comment|/* Construct real mode& protected mode pointers to access the allocated    * memory.  Note we know start_offs is aligned on a paragraph (16-byte)    * boundary, because we rounded it down.    *    * We make the offsets come out rights by backing off the real mode selector    * by start_offs.    */
name|rm_base
operator|=
operator|(
operator|(
name|ULONG
operator|)
operator|*
name|rmem_adrp
operator|)
operator|-
operator|(
name|start_offs
operator|>>
literal|4
operator|)
expr_stmt|;
name|RP_SET
argument_list|(
operator|*
name|real_basep
argument_list|,
literal|0
argument_list|,
name|rm_base
argument_list|)
expr_stmt|;
name|FP_SET
argument_list|(
operator|*
name|prot_basep
argument_list|,
name|rm_base
operator|<<
literal|4
argument_list|,
name|SS_DOSMEM
argument_list|)
expr_stmt|;
comment|/* Copy the real mode code/data to the allocated memory    */
name|source
operator|=
operator|(
name|UCHAR
operator|*
operator|)
name|start_offs
expr_stmt|;
name|destin
operator|=
operator|*
name|prot_basep
expr_stmt|;
name|FP_SET
argument_list|(
name|destin
argument_list|,
name|FP_OFF
argument_list|(
operator|*
name|prot_basep
argument_list|)
operator|+
name|start_offs
argument_list|,
name|FP_SEL
argument_list|(
operator|*
name|prot_basep
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|end_offs
operator|-
name|start_offs
expr_stmt|;
name|WriteFarMem
argument_list|(
name|destin
argument_list|,
name|source
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DOSX&& (DOSX& PHARLAP) */
end_comment

end_unit


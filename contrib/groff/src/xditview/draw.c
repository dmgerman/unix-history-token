begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * draw.c  *  * accept dvi function calls and translate to X  */
end_comment

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_include
include|#
directive|include
file|<X11/IntrinsicP.h>
end_include

begin_include
include|#
directive|include
file|<X11/StringDefs.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_comment
comment|/* math.h on a Sequent doesn't define M_PI, apparently */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|M_PI
end_ifndef

begin_define
define|#
directive|define
name|M_PI
value|3.14159265358979323846
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"DviP.h"
end_include

begin_define
define|#
directive|define
name|DeviceToX
parameter_list|(
name|dw
parameter_list|,
name|n
parameter_list|)
value|((int)((n) * (dw)->dvi.scale_factor + .5))
end_define

begin_define
define|#
directive|define
name|XPos
parameter_list|(
name|dw
parameter_list|)
value|(DeviceToX((dw), (dw)->dvi.state->x - \                   (dw)->dvi.text_device_width) + (dw)->dvi.text_x_width)
end_define

begin_define
define|#
directive|define
name|YPos
parameter_list|(
name|dw
parameter_list|)
value|(DeviceToX((dw), (dw)->dvi.state->y))
end_define

begin_function_decl
specifier|static
name|int
name|FakeCharacter
parameter_list|()
function_decl|;
end_function_decl

begin_macro
name|HorizontalMove
argument_list|(
argument|dw
argument_list|,
argument|delta
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|delta
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
operator|+=
name|delta
expr_stmt|;
block|}
end_block

begin_macro
name|HorizontalGoto
argument_list|(
argument|dw
argument_list|,
argument|NewPosition
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|NewPosition
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
operator|=
name|NewPosition
expr_stmt|;
block|}
end_block

begin_macro
name|VerticalMove
argument_list|(
argument|dw
argument_list|,
argument|delta
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|delta
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|+=
name|delta
expr_stmt|;
block|}
end_block

begin_macro
name|VerticalGoto
argument_list|(
argument|dw
argument_list|,
argument|NewPosition
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|NewPosition
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|=
name|NewPosition
expr_stmt|;
block|}
end_block

begin_macro
name|AdjustCacheDeltas
argument_list|(
argument|dw
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|extra
decl_stmt|;
name|int
name|nadj
decl_stmt|;
name|int
name|i
decl_stmt|;
name|nadj
operator|=
literal|0
expr_stmt|;
name|extra
operator|=
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|text_device_width
argument_list|)
operator|-
name|dw
operator|->
name|dvi
operator|.
name|text_x_width
expr_stmt|;
if|if
condition|(
name|extra
operator|==
literal|0
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|adjustable
index|[
name|i
index|]
condition|)
operator|++
name|nadj
expr_stmt|;
if|if
condition|(
name|nadj
operator|==
literal|0
condition|)
return|return;
name|dw
operator|->
name|dvi
operator|.
name|text_x_width
operator|+=
name|extra
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|adjustable
index|[
name|i
index|]
condition|)
block|{
name|int
name|x
decl_stmt|;
name|int
modifier|*
name|deltap
decl_stmt|;
name|x
operator|=
name|extra
operator|/
name|nadj
expr_stmt|;
name|deltap
operator|=
operator|&
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
index|[
name|i
index|]
operator|.
name|delta
expr_stmt|;
define|#
directive|define
name|MIN_DELTA
value|2
if|if
condition|(
operator|*
name|deltap
operator|>
literal|0
operator|&&
name|x
operator|+
operator|*
name|deltap
operator|<
name|MIN_DELTA
condition|)
block|{
name|x
operator|=
name|MIN_DELTA
operator|-
operator|*
name|deltap
expr_stmt|;
if|if
condition|(
name|x
operator|<=
literal|0
condition|)
operator|*
name|deltap
operator|=
name|MIN_DELTA
expr_stmt|;
else|else
name|x
operator|=
literal|0
expr_stmt|;
block|}
else|else
operator|*
name|deltap
operator|+=
name|x
expr_stmt|;
name|extra
operator|-=
name|x
expr_stmt|;
operator|--
name|nadj
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|adjustable
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|FlushCharCache
argument_list|(
argument|dw
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_index
operator|!=
literal|0
condition|)
block|{
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XDrawText
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|start_x
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|start_y
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|max
operator|=
name|DVI_TEXT_CACHE_SIZE
expr_stmt|;
if|#
directive|if
literal|0
block|if (dw->dvi.noPolyText) 	    dw->dvi.cache.max = 1;
endif|#
directive|endif
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_index
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
index|[
literal|0
index|]
operator|.
name|nchars
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|start_x
operator|=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|x
operator|=
name|XPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|start_y
operator|=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|y
operator|=
name|YPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|Newline
argument_list|(
argument|dw
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FlushCharCache
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|text_x_width
operator|=
name|dw
operator|->
name|dvi
operator|.
name|text_device_width
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|word_flag
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|Word
argument_list|(
argument|dw
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dw
operator|->
name|dvi
operator|.
name|word_flag
operator|=
literal|1
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|charWidth
parameter_list|(
name|fi
parameter_list|,
name|c
parameter_list|)
value|(\     (fi)->per_char ?\ 	(fi)->per_char[(c) - (fi)->min_char_or_byte2].width\     :\ 	(fi)->max_bounds.width\ )
end_define

begin_function
specifier|static
name|int
name|charExists
parameter_list|(
name|fi
parameter_list|,
name|c
parameter_list|)
name|XFontStruct
modifier|*
name|fi
decl_stmt|;
name|int
name|c
decl_stmt|;
block|{
name|XCharStruct
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|fi
operator|->
name|per_char
operator|==
name|NULL
operator|||
name|c
operator|<
name|fi
operator|->
name|min_char_or_byte2
operator|||
name|c
operator|>
name|fi
operator|->
name|max_char_or_byte2
condition|)
return|return
literal|0
return|;
name|p
operator|=
name|fi
operator|->
name|per_char
operator|+
operator|(
name|c
operator|-
name|fi
operator|->
name|min_char_or_byte2
operator|)
expr_stmt|;
return|return
operator|(
name|p
operator|->
name|lbearing
operator|!=
literal|0
operator|||
name|p
operator|->
name|rbearing
operator|!=
literal|0
operator|||
name|p
operator|->
name|width
operator|!=
literal|0
operator|||
name|p
operator|->
name|ascent
operator|!=
literal|0
operator|||
name|p
operator|->
name|descent
operator|!=
literal|0
operator|||
name|p
operator|->
name|attributes
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DoCharacter
argument_list|(
argument|dw
argument_list|,
argument|c
argument_list|,
argument|wid
argument_list|)
name|DviWidget
name|dw
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|wid
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* width in device units */
end_comment

begin_block
block|{
specifier|register
name|XFontStruct
modifier|*
name|font
decl_stmt|;
specifier|register
name|XTextItem
modifier|*
name|text
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|x
operator|=
name|XPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|y
operator|=
name|YPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
comment|/* 	 * quick and dirty extents calculation: 	 */
if|if
condition|(
operator|!
operator|(
name|y
operator|+
literal|24
operator|>=
name|dw
operator|->
name|dvi
operator|.
name|extents
operator|.
name|y1
operator|&&
name|y
operator|-
literal|24
operator|<=
name|dw
operator|->
name|dvi
operator|.
name|extents
operator|.
name|y2
if|#
directive|if
literal|0
expr|&& x + 24>= dw->dvi.extents.x1&& x - 24<= dw->dvi.extents.x2
endif|#
directive|endif
operator|)
condition|)
return|return;
if|if
condition|(
name|y
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|y
operator|||
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_index
operator|>=
name|DVI_CHAR_CACHE_SIZE
condition|)
block|{
name|FlushCharCache
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|x
operator|=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|x
expr_stmt|;
block|}
comment|/* 	 * load a new font, if the current block is not empty, 	 * step to the next. 	 */
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font_size
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_size
operator|||
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font_number
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
condition|)
block|{
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font_size
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_size
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font_number
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font
operator|=
name|QueryFont
argument_list|(
name|dw
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font_number
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
index|[
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
index|]
operator|.
name|nchars
operator|!=
literal|0
condition|)
block|{
operator|++
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
operator|>=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|max
condition|)
name|FlushCharCache
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
index|[
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
index|]
operator|.
name|nchars
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|adjustable
index|[
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|x
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|x
operator|||
name|dw
operator|->
name|dvi
operator|.
name|word_flag
condition|)
block|{
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
index|[
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
index|]
operator|.
name|nchars
operator|!=
literal|0
condition|)
block|{
operator|++
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
operator|>=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|max
condition|)
name|FlushCharCache
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
index|[
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
index|]
operator|.
name|nchars
operator|=
literal|0
expr_stmt|;
block|}
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|adjustable
index|[
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
index|]
operator|=
name|dw
operator|->
name|dvi
operator|.
name|word_flag
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|word_flag
operator|=
literal|0
expr_stmt|;
block|}
name|font
operator|=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|font
expr_stmt|;
name|text
operator|=
operator|&
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
index|[
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
index|]
expr_stmt|;
if|if
condition|(
name|text
operator|->
name|nchars
operator|==
literal|0
condition|)
block|{
name|text
operator|->
name|chars
operator|=
operator|&
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_cache
index|[
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_index
index|]
expr_stmt|;
name|text
operator|->
name|delta
operator|=
name|x
operator|-
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|x
expr_stmt|;
if|if
condition|(
name|font
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|font
condition|)
block|{
name|text
operator|->
name|font
operator|=
name|font
operator|->
name|fid
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|font
operator|=
name|font
expr_stmt|;
block|}
else|else
name|text
operator|->
name|font
operator|=
name|None
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|x
operator|+=
name|text
operator|->
name|delta
expr_stmt|;
block|}
if|if
condition|(
name|charExists
argument_list|(
name|font
argument_list|,
name|c
argument_list|)
condition|)
block|{
name|int
name|w
decl_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_cache
index|[
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_index
operator|++
index|]
operator|=
operator|(
name|char
operator|)
name|c
expr_stmt|;
operator|++
name|text
operator|->
name|nchars
expr_stmt|;
name|w
operator|=
name|charWidth
argument_list|(
name|font
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|x
operator|+=
name|w
expr_stmt|;
if|if
condition|(
name|wid
operator|!=
literal|0
condition|)
block|{
name|dw
operator|->
name|dvi
operator|.
name|text_x_width
operator|+=
name|w
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|text_device_width
operator|+=
name|wid
expr_stmt|;
block|}
block|}
block|}
end_block

begin_function
specifier|static
name|int
name|FindCharWidth
parameter_list|(
name|dw
parameter_list|,
name|buf
parameter_list|,
name|widp
parameter_list|)
name|DviWidget
name|dw
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
modifier|*
name|widp
decl_stmt|;
block|{
name|int
name|maxpos
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|device_font
operator|==
literal|0
operator|||
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|device_font_number
condition|)
block|{
name|dw
operator|->
name|dvi
operator|.
name|device_font_number
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|device_font
operator|=
name|QueryDeviceFont
argument_list|(
name|dw
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|device_font_number
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|device_font
operator|&&
name|device_char_width
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|device_font
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_size
argument_list|,
name|buf
argument_list|,
name|widp
argument_list|)
condition|)
return|return
literal|1
return|;
name|maxpos
operator|=
name|MaxFontPosition
argument_list|(
name|dw
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|maxpos
condition|;
name|i
operator|++
control|)
block|{
name|DeviceFont
modifier|*
name|f
init|=
name|QueryDeviceFont
argument_list|(
name|dw
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|f
operator|&&
name|device_font_special
argument_list|(
name|f
argument_list|)
operator|&&
name|device_char_width
argument_list|(
name|f
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_size
argument_list|,
name|buf
argument_list|,
name|widp
argument_list|)
condition|)
block|{
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
operator|=
name|i
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Return the width of the character in device units. */
end_comment

begin_function
name|int
name|PutCharacter
parameter_list|(
name|dw
parameter_list|,
name|buf
parameter_list|)
name|DviWidget
name|dw
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
block|{
name|int
name|prevFont
decl_stmt|;
name|int
name|c
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|wid
init|=
literal|0
decl_stmt|;
name|DviCharNameMap
modifier|*
name|map
decl_stmt|;
if|if
condition|(
operator|!
name|dw
operator|->
name|dvi
operator|.
name|display_enable
condition|)
return|return
literal|0
return|;
comment|/* The width doesn't matter in this case. */
name|prevFont
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
expr_stmt|;
if|if
condition|(
operator|!
name|FindCharWidth
argument_list|(
name|dw
argument_list|,
name|buf
argument_list|,
operator|&
name|wid
argument_list|)
condition|)
return|return
literal|0
return|;
name|map
operator|=
name|QueryFontMap
argument_list|(
name|dw
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
condition|)
name|c
operator|=
name|DviCharIndex
argument_list|(
name|map
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|0
condition|)
name|DoCharacter
argument_list|(
name|dw
argument_list|,
name|c
argument_list|,
name|wid
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|FakeCharacter
argument_list|(
name|dw
argument_list|,
name|buf
argument_list|,
name|wid
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
operator|=
name|prevFont
expr_stmt|;
return|return
name|wid
return|;
block|}
end_function

begin_comment
comment|/* Return 1 if we can fake it; 0 otherwise. */
end_comment

begin_function
specifier|static
name|int
name|FakeCharacter
parameter_list|(
name|dw
parameter_list|,
name|buf
parameter_list|,
name|wid
parameter_list|)
name|DviWidget
name|dw
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|wid
decl_stmt|;
block|{
name|int
name|oldx
decl_stmt|,
name|oldw
decl_stmt|;
name|char
name|ch
index|[
literal|2
index|]
decl_stmt|;
name|char
modifier|*
name|chars
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|||
name|buf
index|[
literal|1
index|]
operator|==
literal|'\0'
operator|||
name|buf
index|[
literal|2
index|]
operator|!=
literal|'\0'
condition|)
return|return
literal|0
return|;
define|#
directive|define
name|pack2
parameter_list|(
name|c1
parameter_list|,
name|c2
parameter_list|)
value|(((c1)<< 8) | (c2))
switch|switch
condition|(
name|pack2
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
case|case
name|pack2
argument_list|(
literal|'f'
argument_list|,
literal|'i'
argument_list|)
case|:
name|chars
operator|=
literal|"fi"
expr_stmt|;
break|break;
case|case
name|pack2
argument_list|(
literal|'f'
argument_list|,
literal|'l'
argument_list|)
case|:
name|chars
operator|=
literal|"fl"
expr_stmt|;
break|break;
case|case
name|pack2
argument_list|(
literal|'f'
argument_list|,
literal|'f'
argument_list|)
case|:
name|chars
operator|=
literal|"ff"
expr_stmt|;
break|break;
case|case
name|pack2
argument_list|(
literal|'F'
argument_list|,
literal|'i'
argument_list|)
case|:
name|chars
operator|=
literal|"ffi"
expr_stmt|;
break|break;
case|case
name|pack2
argument_list|(
literal|'F'
argument_list|,
literal|'l'
argument_list|)
case|:
name|chars
operator|=
literal|"ffl"
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|chars
condition|)
return|return
literal|0
return|;
name|oldx
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
expr_stmt|;
name|oldw
operator|=
name|dw
operator|->
name|dvi
operator|.
name|text_device_width
expr_stmt|;
name|ch
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
init|;
operator|*
name|chars
condition|;
name|chars
operator|++
control|)
block|{
name|ch
index|[
literal|0
index|]
operator|=
operator|*
name|chars
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
operator|+=
name|PutCharacter
argument_list|(
name|dw
argument_list|,
name|ch
argument_list|)
expr_stmt|;
block|}
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
operator|=
name|oldx
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|text_device_width
operator|=
name|oldw
operator|+
name|wid
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_macro
name|PutNumberedCharacter
argument_list|(
argument|dw
argument_list|,
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|wid
decl_stmt|;
name|DviCharNameMap
modifier|*
name|map
decl_stmt|;
if|if
condition|(
operator|!
name|dw
operator|->
name|dvi
operator|.
name|display_enable
condition|)
return|return;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|device_font
operator|==
literal|0
operator|||
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|device_font_number
condition|)
block|{
name|dw
operator|->
name|dvi
operator|.
name|device_font_number
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|device_font
operator|=
name|QueryDeviceFont
argument_list|(
name|dw
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|device_font_number
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|device_font
operator|==
literal|0
operator|||
operator|!
name|device_code_width
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|device_font
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_size
argument_list|,
name|c
argument_list|,
operator|&
name|wid
argument_list|)
condition|)
return|return;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|native
condition|)
block|{
name|DoCharacter
argument_list|(
name|dw
argument_list|,
name|c
argument_list|,
name|wid
argument_list|)
expr_stmt|;
return|return;
block|}
name|map
operator|=
name|QueryFontMap
argument_list|(
name|dw
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_number
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|map
condition|)
return|return;
for|for
control|(
name|name
operator|=
name|device_name_for_code
argument_list|(
name|dw
operator|->
name|dvi
operator|.
name|device_font
argument_list|,
name|c
argument_list|)
init|;
name|name
condition|;
name|name
operator|=
name|device_name_for_code
argument_list|(
operator|(
name|DeviceFont
operator|*
operator|)
literal|0
argument_list|,
name|c
argument_list|)
control|)
block|{
name|int
name|code
init|=
name|DviCharIndex
argument_list|(
name|map
argument_list|,
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|>=
literal|0
condition|)
block|{
name|DoCharacter
argument_list|(
name|dw
argument_list|,
name|code
argument_list|,
name|wid
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|FakeCharacter
argument_list|(
name|dw
argument_list|,
name|name
argument_list|,
name|wid
argument_list|)
condition|)
break|break;
block|}
block|}
end_block

begin_macro
name|ClearPage
argument_list|(
argument|dw
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|XClearWindow
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|setGC
argument_list|(
argument|dw
argument_list|)
name|DviWidget
name|dw
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|desired_line_width
decl_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|line_thickness
operator|<
literal|0
condition|)
name|desired_line_width
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|double
operator|)
name|dw
operator|->
name|dvi
operator|.
name|device_resolution
operator|*
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_size
operator|)
operator|/
operator|(
literal|10.0
operator|*
literal|72.0
operator|*
name|dw
operator|->
name|dvi
operator|.
name|sizescale
operator|)
argument_list|)
expr_stmt|;
else|else
name|desired_line_width
operator|=
name|dw
operator|->
name|dvi
operator|.
name|line_thickness
expr_stmt|;
if|if
condition|(
name|desired_line_width
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|line_width
condition|)
block|{
name|XGCValues
name|values
decl_stmt|;
name|values
operator|.
name|line_width
operator|=
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|desired_line_width
argument_list|)
expr_stmt|;
if|if
condition|(
name|values
operator|.
name|line_width
operator|==
literal|0
condition|)
name|values
operator|.
name|line_width
operator|=
literal|1
expr_stmt|;
name|XChangeGC
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|GCLineWidth
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|line_width
operator|=
name|desired_line_width
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
specifier|static
name|setFillGC
argument_list|(
argument|dw
argument_list|)
name|DviWidget
name|dw
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|fill_type
decl_stmt|;
name|unsigned
name|long
name|mask
init|=
name|GCFillStyle
operator||
name|GCForeground
decl_stmt|;
name|fill_type
operator|=
operator|(
name|dw
operator|->
name|dvi
operator|.
name|fill
operator|*
literal|10
operator|)
operator|/
operator|(
name|DVI_FILL_MAX
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|fill_type
operator|!=
name|fill_type
condition|)
block|{
name|XGCValues
name|values
decl_stmt|;
if|if
condition|(
name|fill_type
operator|<=
literal|0
condition|)
block|{
name|values
operator|.
name|foreground
operator|=
name|dw
operator|->
name|dvi
operator|.
name|background
expr_stmt|;
name|values
operator|.
name|fill_style
operator|=
name|FillSolid
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fill_type
operator|>=
literal|9
condition|)
block|{
name|values
operator|.
name|foreground
operator|=
name|dw
operator|->
name|dvi
operator|.
name|foreground
expr_stmt|;
name|values
operator|.
name|fill_style
operator|=
name|FillSolid
expr_stmt|;
block|}
else|else
block|{
name|values
operator|.
name|foreground
operator|=
name|dw
operator|->
name|dvi
operator|.
name|foreground
expr_stmt|;
name|values
operator|.
name|fill_style
operator|=
name|FillOpaqueStippled
expr_stmt|;
name|values
operator|.
name|stipple
operator|=
name|dw
operator|->
name|dvi
operator|.
name|gray
index|[
name|fill_type
operator|-
literal|1
index|]
expr_stmt|;
name|mask
operator||=
name|GCStipple
expr_stmt|;
block|}
name|XChangeGC
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|mask
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|fill_type
operator|=
name|fill_type
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|DrawLine
argument_list|(
argument|dw
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|xp
decl_stmt|,
name|yp
decl_stmt|;
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|xp
operator|=
name|XPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|yp
operator|=
name|YPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XDrawLine
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|xp
argument_list|,
name|yp
argument_list|,
name|xp
operator|+
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|x
argument_list|)
argument_list|,
name|yp
operator|+
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|y
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawCircle
argument_list|(
argument|dw
argument_list|,
argument|diam
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|diam
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|d
decl_stmt|;
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|d
operator|=
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|diam
argument_list|)
expr_stmt|;
name|XDrawArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|XPos
argument_list|(
name|dw
argument_list|)
argument_list|,
name|YPos
argument_list|(
name|dw
argument_list|)
operator|-
name|d
operator|/
literal|2
argument_list|,
name|d
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawFilledCircle
argument_list|(
argument|dw
argument_list|,
argument|diam
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|diam
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|d
decl_stmt|;
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|setFillGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|d
operator|=
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|diam
argument_list|)
expr_stmt|;
name|XFillArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|XPos
argument_list|(
name|dw
argument_list|)
argument_list|,
name|YPos
argument_list|(
name|dw
argument_list|)
operator|-
name|d
operator|/
literal|2
argument_list|,
name|d
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
name|XDrawArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|XPos
argument_list|(
name|dw
argument_list|)
argument_list|,
name|YPos
argument_list|(
name|dw
argument_list|)
operator|-
name|d
operator|/
literal|2
argument_list|,
name|d
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawEllipse
argument_list|(
argument|dw
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XDrawArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|XPos
argument_list|(
name|dw
argument_list|)
argument_list|,
name|YPos
argument_list|(
name|dw
argument_list|)
operator|-
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|b
operator|/
literal|2
argument_list|)
argument_list|,
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|a
argument_list|)
argument_list|,
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|b
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawFilledEllipse
argument_list|(
argument|dw
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|setFillGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XFillArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|XPos
argument_list|(
name|dw
argument_list|)
argument_list|,
name|YPos
argument_list|(
name|dw
argument_list|)
operator|-
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|b
operator|/
literal|2
argument_list|)
argument_list|,
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|a
argument_list|)
argument_list|,
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|b
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
name|XDrawArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|XPos
argument_list|(
name|dw
argument_list|)
argument_list|,
name|YPos
argument_list|(
name|dw
argument_list|)
operator|-
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|b
operator|/
literal|2
argument_list|)
argument_list|,
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|a
argument_list|)
argument_list|,
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|b
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawArc
argument_list|(
argument|dw
argument_list|,
argument|x0
argument_list|,
argument|y0
argument_list|,
argument|x1
argument_list|,
argument|y1
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x0
decl_stmt|,
name|y0
decl_stmt|,
name|x1
decl_stmt|,
name|y1
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|angle1
decl_stmt|,
name|angle2
decl_stmt|;
name|int
name|rad
init|=
call|(
name|int
call|)
argument_list|(
operator|(
name|sqrt
argument_list|(
operator|(
name|double
operator|)
name|x0
operator|*
name|x0
operator|+
operator|(
name|double
operator|)
name|y0
operator|*
name|y0
argument_list|)
operator|+
name|sqrt
argument_list|(
operator|(
name|double
operator|)
name|x1
operator|*
name|x1
operator|+
operator|(
name|double
operator|)
name|y1
operator|*
name|y1
argument_list|)
operator|+
literal|1.0
operator|)
operator|/
literal|2.0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|x0
operator|==
literal|0
operator|&&
name|y0
operator|==
literal|0
operator|)
operator|||
operator|(
name|x1
operator|==
literal|0
operator|&&
name|y1
operator|==
literal|0
operator|)
condition|)
return|return;
name|angle1
operator|=
call|(
name|int
call|)
argument_list|(
name|atan2
argument_list|(
operator|(
name|double
operator|)
name|y0
argument_list|,
operator|(
name|double
operator|)
operator|-
name|x0
argument_list|)
operator|*
literal|180.0
operator|*
literal|64.0
operator|/
name|M_PI
argument_list|)
expr_stmt|;
name|angle2
operator|=
call|(
name|int
call|)
argument_list|(
name|atan2
argument_list|(
operator|(
name|double
operator|)
operator|-
name|y1
argument_list|,
operator|(
name|double
operator|)
name|x1
argument_list|)
operator|*
literal|180.0
operator|*
literal|64.0
operator|/
name|M_PI
argument_list|)
expr_stmt|;
name|angle2
operator|-=
name|angle1
expr_stmt|;
if|if
condition|(
name|angle2
operator|<
literal|0
condition|)
name|angle2
operator|+=
literal|64
operator|*
literal|360
expr_stmt|;
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|rad
operator|=
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|rad
argument_list|)
expr_stmt|;
name|XDrawArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|XPos
argument_list|(
name|dw
argument_list|)
operator|+
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|x0
argument_list|)
operator|-
name|rad
argument_list|,
name|YPos
argument_list|(
name|dw
argument_list|)
operator|+
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|y0
argument_list|)
operator|-
name|rad
argument_list|,
name|rad
operator|*
literal|2
argument_list|,
name|rad
operator|*
literal|2
argument_list|,
name|angle1
argument_list|,
name|angle2
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawPolygon
argument_list|(
argument|dw
argument_list|,
argument|v
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|XPoint
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|n
operator|/=
literal|2
expr_stmt|;
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|XPoint
operator|*
operator|)
name|XtMalloc
argument_list|(
operator|(
name|n
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|XPoint
argument_list|)
argument_list|)
expr_stmt|;
name|p
index|[
literal|0
index|]
operator|.
name|x
operator|=
name|XPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|p
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|YPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|dx
operator|=
literal|0
expr_stmt|;
name|dy
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|dx
operator|+=
name|v
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
name|p
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|x
operator|=
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|dx
argument_list|)
operator|+
name|p
index|[
literal|0
index|]
operator|.
name|x
expr_stmt|;
name|dy
operator|+=
name|v
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|p
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|y
operator|=
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|dy
argument_list|)
operator|+
name|p
index|[
literal|0
index|]
operator|.
name|y
expr_stmt|;
block|}
name|p
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|x
operator|=
name|p
index|[
literal|0
index|]
operator|.
name|x
expr_stmt|;
name|p
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|y
operator|=
name|p
index|[
literal|0
index|]
operator|.
name|y
expr_stmt|;
name|XDrawLines
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|p
argument_list|,
name|n
operator|+
literal|2
argument_list|,
name|CoordModeOrigin
argument_list|)
expr_stmt|;
name|XtFree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawFilledPolygon
argument_list|(
argument|dw
argument_list|,
argument|v
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|XPoint
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|n
operator|/=
literal|2
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|2
condition|)
return|return;
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|setFillGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|XPoint
operator|*
operator|)
name|XtMalloc
argument_list|(
operator|(
name|n
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|XPoint
argument_list|)
argument_list|)
expr_stmt|;
name|p
index|[
literal|0
index|]
operator|.
name|x
operator|=
name|p
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|x
operator|=
name|XPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|p
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|p
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|y
operator|=
name|YPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|dx
operator|=
literal|0
expr_stmt|;
name|dy
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|dx
operator|+=
name|v
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
name|p
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|x
operator|=
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|dx
argument_list|)
operator|+
name|p
index|[
literal|0
index|]
operator|.
name|x
expr_stmt|;
name|dy
operator|+=
name|v
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|p
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|y
operator|=
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|dy
argument_list|)
operator|+
name|p
index|[
literal|0
index|]
operator|.
name|y
expr_stmt|;
block|}
name|XFillPolygon
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|p
argument_list|,
name|n
operator|+
literal|1
argument_list|,
name|Complex
argument_list|,
name|CoordModeOrigin
argument_list|)
expr_stmt|;
name|XDrawLines
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|p
argument_list|,
name|n
operator|+
literal|2
argument_list|,
name|CoordModeOrigin
argument_list|)
expr_stmt|;
name|XtFree
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|POINTS_MAX
value|10000
end_define

begin_expr_stmt
specifier|static
name|appendPoint
argument_list|(
argument|points
argument_list|,
argument|pointi
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|)
name|XPoint
operator|*
name|points
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
modifier|*
name|pointi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|*
name|pointi
operator|<
name|POINTS_MAX
condition|)
block|{
name|points
index|[
operator|*
name|pointi
index|]
operator|.
name|x
operator|=
name|x
expr_stmt|;
name|points
index|[
operator|*
name|pointi
index|]
operator|.
name|y
operator|=
name|y
expr_stmt|;
operator|*
name|pointi
operator|+=
literal|1
expr_stmt|;
block|}
block|}
end_block

begin_define
define|#
directive|define
name|FLATNESS
value|1
end_define

begin_expr_stmt
specifier|static
name|flattenCurve
argument_list|(
argument|points
argument_list|,
argument|pointi
argument_list|,
argument|x2
argument_list|,
argument|y2
argument_list|,
argument|x3
argument_list|,
argument|y3
argument_list|,
argument|x4
argument_list|,
argument|y4
argument_list|)
name|XPoint
operator|*
name|points
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
modifier|*
name|pointi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|x3
decl_stmt|,
name|y3
decl_stmt|,
name|x4
decl_stmt|,
name|y4
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|n1
decl_stmt|,
name|n2
decl_stmt|,
name|n
decl_stmt|;
name|x1
operator|=
name|points
index|[
operator|*
name|pointi
operator|-
literal|1
index|]
operator|.
name|x
expr_stmt|;
name|y1
operator|=
name|points
index|[
operator|*
name|pointi
operator|-
literal|1
index|]
operator|.
name|y
expr_stmt|;
name|dx
operator|=
name|x4
operator|-
name|x1
expr_stmt|;
name|dy
operator|=
name|y4
operator|-
name|y1
expr_stmt|;
name|n1
operator|=
name|dy
operator|*
operator|(
name|x2
operator|-
name|x1
operator|)
operator|-
name|dx
operator|*
operator|(
name|y2
operator|-
name|y1
operator|)
expr_stmt|;
name|n2
operator|=
name|dy
operator|*
operator|(
name|x3
operator|-
name|x1
operator|)
operator|-
name|dx
operator|*
operator|(
name|y3
operator|-
name|y1
operator|)
expr_stmt|;
if|if
condition|(
name|n1
operator|<
literal|0
condition|)
name|n1
operator|=
operator|-
name|n1
expr_stmt|;
if|if
condition|(
name|n2
operator|<
literal|0
condition|)
name|n2
operator|=
operator|-
name|n2
expr_stmt|;
name|n
operator|=
name|n1
operator|>
name|n2
condition|?
name|n1
else|:
name|n2
expr_stmt|;
if|if
condition|(
name|n
operator|*
name|n
operator|/
operator|(
name|dy
operator|*
name|dy
operator|+
name|dx
operator|*
name|dx
operator|)
operator|<=
name|FLATNESS
operator|*
name|FLATNESS
condition|)
name|appendPoint
argument_list|(
name|points
argument_list|,
name|pointi
argument_list|,
name|x4
argument_list|,
name|y4
argument_list|)
expr_stmt|;
else|else
block|{
name|flattenCurve
argument_list|(
name|points
argument_list|,
name|pointi
argument_list|,
operator|(
name|x1
operator|+
name|x2
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|y1
operator|+
name|y2
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|x1
operator|+
name|x2
operator|*
literal|2
operator|+
name|x3
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|y1
operator|+
name|y2
operator|*
literal|2
operator|+
name|y3
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|x1
operator|+
literal|3
operator|*
name|x2
operator|+
literal|3
operator|*
name|x3
operator|+
name|x4
operator|)
operator|/
literal|8
argument_list|,
operator|(
name|y1
operator|+
literal|3
operator|*
name|y2
operator|+
literal|3
operator|*
name|y3
operator|+
name|y4
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|flattenCurve
argument_list|(
name|points
argument_list|,
name|pointi
argument_list|,
operator|(
name|x2
operator|+
name|x3
operator|*
literal|2
operator|+
name|x4
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|y2
operator|+
name|y3
operator|*
literal|2
operator|+
name|y4
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|x3
operator|+
name|x4
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|y3
operator|+
name|y4
operator|)
operator|/
literal|2
argument_list|,
name|x4
argument_list|,
name|y4
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|DrawSpline
argument_list|(
argument|dw
argument_list|,
argument|v
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|sx
decl_stmt|,
name|sy
decl_stmt|,
name|tx
decl_stmt|,
name|ty
decl_stmt|;
name|int
name|ox
decl_stmt|,
name|oy
decl_stmt|,
name|dx
decl_stmt|,
name|dy
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|pointi
decl_stmt|;
name|XPoint
name|points
index|[
name|POINTS_MAX
index|]
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
operator|||
operator|(
name|n
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
return|return;
name|AdjustCacheDeltas
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|ox
operator|=
name|XPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|oy
operator|=
name|YPos
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|dx
operator|=
name|v
index|[
literal|0
index|]
expr_stmt|;
name|dy
operator|=
name|v
index|[
literal|1
index|]
expr_stmt|;
name|sx
operator|=
name|ox
expr_stmt|;
name|sy
operator|=
name|oy
expr_stmt|;
name|tx
operator|=
name|sx
operator|+
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|dx
argument_list|)
expr_stmt|;
name|ty
operator|=
name|sy
operator|+
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|dy
argument_list|)
expr_stmt|;
name|pointi
operator|=
literal|0
expr_stmt|;
name|appendPoint
argument_list|(
name|points
argument_list|,
operator|&
name|pointi
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|)
expr_stmt|;
name|appendPoint
argument_list|(
name|points
argument_list|,
operator|&
name|pointi
argument_list|,
operator|(
name|sx
operator|+
name|tx
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|sy
operator|+
name|ty
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|int
name|ux
init|=
name|ox
operator|+
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|dx
operator|+=
name|v
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|int
name|uy
init|=
name|oy
operator|+
name|DeviceToX
argument_list|(
name|dw
argument_list|,
name|dy
operator|+=
name|v
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
decl_stmt|;
name|flattenCurve
argument_list|(
name|points
argument_list|,
operator|&
name|pointi
argument_list|,
operator|(
name|sx
operator|+
name|tx
operator|*
literal|5
operator|)
operator|/
literal|6
argument_list|,
operator|(
name|sy
operator|+
name|ty
operator|*
literal|5
operator|)
operator|/
literal|6
argument_list|,
operator|(
name|tx
operator|*
literal|5
operator|+
name|ux
operator|)
operator|/
literal|6
argument_list|,
operator|(
name|ty
operator|*
literal|5
operator|+
name|uy
operator|)
operator|/
literal|6
argument_list|,
operator|(
name|tx
operator|+
name|ux
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|ty
operator|+
name|uy
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|sx
operator|=
name|tx
expr_stmt|;
name|sy
operator|=
name|ty
expr_stmt|;
name|tx
operator|=
name|ux
expr_stmt|;
name|ty
operator|=
name|uy
expr_stmt|;
block|}
name|appendPoint
argument_list|(
name|points
argument_list|,
operator|&
name|pointi
argument_list|,
name|tx
argument_list|,
name|ty
argument_list|)
expr_stmt|;
name|XDrawLines
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|points
argument_list|,
name|pointi
argument_list|,
name|CoordModeOrigin
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Local Variables: c-indent-level: 8 c-continued-statement-offset: 8 c-brace-offset: -8 c-argdecl-indent: 8 c-label-offset: -8 c-tab-always-indent: nil End: */
end_comment

end_unit


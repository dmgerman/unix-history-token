begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / VLAN initialization  * Copyright 2003, Instant802 Networks, Inc.  * Copyright 2005-2006, Devicescape Software, Inc.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"vlan_init.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_FULL_DYNAMIC_VLAN
end_ifdef

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<linux/sockios.h>
end_include

begin_include
include|#
directive|include
file|<linux/if_vlan.h>
end_include

begin_typedef
typedef|typedef
name|__uint64_t
name|__u64
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__uint32_t
name|__u32
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__int32_t
name|__s32
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__uint16_t
name|__u16
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__int16_t
name|__s16
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__uint8_t
name|__u8
typedef|;
end_typedef

begin_include
include|#
directive|include
file|<linux/if_bridge.h>
end_include

begin_include
include|#
directive|include
file|"priv_netlink.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_struct
struct|struct
name|full_dynamic_vlan
block|{
name|int
name|s
decl_stmt|;
comment|/* socket on which to listen for new/removed interfaces. */
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ifconfig_helper
parameter_list|(
specifier|const
name|char
modifier|*
name|if_name
parameter_list|,
name|int
name|up
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[AF_INET,SOCK_STREAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|if_name
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIFFLAGS]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|up
condition|)
name|ifr
operator|.
name|ifr_flags
operator||=
name|IFF_UP
expr_stmt|;
else|else
name|ifr
operator|.
name|ifr_flags
operator|&=
operator|~
name|IFF_UP
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIFFLAGS]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ifconfig_up
parameter_list|(
specifier|const
name|char
modifier|*
name|if_name
parameter_list|)
block|{
return|return
name|ifconfig_helper
argument_list|(
name|if_name
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ifconfig_down
parameter_list|(
specifier|const
name|char
modifier|*
name|if_name
parameter_list|)
block|{
return|return
name|ifconfig_helper
argument_list|(
name|if_name
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * These are only available in recent linux headers (without the leading  * underscore).  */
end_comment

begin_define
define|#
directive|define
name|_GET_VLAN_REALDEV_NAME_CMD
value|8
end_define

begin_define
define|#
directive|define
name|_GET_VLAN_VID_CMD
value|9
end_define

begin_comment
comment|/* This value should be 256 ONLY. If it is something else, then hostapd  * might crash!, as this value has been hard-coded in 2.4.x kernel  * bridging code.  */
end_comment

begin_define
define|#
directive|define
name|MAX_BR_PORTS
value|256
end_define

begin_function
specifier|static
name|int
name|br_delif
parameter_list|(
specifier|const
name|char
modifier|*
name|br_name
parameter_list|,
specifier|const
name|char
modifier|*
name|if_name
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|unsigned
name|long
name|args
index|[
literal|2
index|]
decl_stmt|;
name|int
name|if_index
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[AF_INET,SOCK_STREAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|if_index
operator|=
name|if_nametoindex
argument_list|(
name|if_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|if_index
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Failure determining interface index for '%s'\n"
argument_list|,
name|if_name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|args
index|[
literal|0
index|]
operator|=
name|BRCTL_DEL_IF
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
name|if_index
expr_stmt|;
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|br_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|__caddr_t
operator|)
name|args
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCDEVPRIVATE
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EINVAL
condition|)
block|{
comment|/* No error if interface already removed. */
name|perror
argument_list|(
literal|"ioctl[SIOCDEVPRIVATE,BRCTL_DEL_IF]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* 	Add interface 'if_name' to the bridge 'br_name'  	returns -1 on error 	returns 1 if the interface is already part of the bridge 	returns 0 otherwise */
end_comment

begin_function
specifier|static
name|int
name|br_addif
parameter_list|(
specifier|const
name|char
modifier|*
name|br_name
parameter_list|,
specifier|const
name|char
modifier|*
name|if_name
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|unsigned
name|long
name|args
index|[
literal|2
index|]
decl_stmt|;
name|int
name|if_index
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[AF_INET,SOCK_STREAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|if_index
operator|=
name|if_nametoindex
argument_list|(
name|if_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|if_index
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Failure determining interface index for '%s'\n"
argument_list|,
name|if_name
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|args
index|[
literal|0
index|]
operator|=
name|BRCTL_ADD_IF
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
name|if_index
expr_stmt|;
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|br_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|__caddr_t
operator|)
name|args
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCDEVPRIVATE
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EBUSY
condition|)
block|{
comment|/* The interface is already added. */
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|perror
argument_list|(
literal|"ioctl[SIOCDEVPRIVATE,BRCTL_ADD_IF]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|br_delbr
parameter_list|(
specifier|const
name|char
modifier|*
name|br_name
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|unsigned
name|long
name|arg
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[AF_INET,SOCK_STREAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|arg
index|[
literal|0
index|]
operator|=
name|BRCTL_DEL_BRIDGE
expr_stmt|;
name|arg
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|long
operator|)
name|br_name
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGIFBR
argument_list|,
name|arg
argument_list|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|ENXIO
condition|)
block|{
comment|/* No error if bridge already removed. */
name|perror
argument_list|(
literal|"ioctl[BRCTL_DEL_BRIDGE]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* 	Add a bridge with the name 'br_name'.  	returns -1 on error 	returns 1 if the bridge already exists 	returns 0 otherwise */
end_comment

begin_function
specifier|static
name|int
name|br_addbr
parameter_list|(
specifier|const
name|char
modifier|*
name|br_name
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|unsigned
name|long
name|arg
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[AF_INET,SOCK_STREAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|arg
index|[
literal|0
index|]
operator|=
name|BRCTL_ADD_BRIDGE
expr_stmt|;
name|arg
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|long
operator|)
name|br_name
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCGIFBR
argument_list|,
name|arg
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EEXIST
condition|)
block|{
comment|/* The bridge is already added. */
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
block|{
name|perror
argument_list|(
literal|"ioctl[BRCTL_ADD_BRIDGE]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|br_getnumports
parameter_list|(
specifier|const
name|char
modifier|*
name|br_name
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|port_cnt
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|arg
index|[
literal|4
index|]
decl_stmt|;
name|int
name|ifindices
index|[
name|MAX_BR_PORTS
index|]
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[AF_INET,SOCK_STREAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|arg
index|[
literal|0
index|]
operator|=
name|BRCTL_GET_PORT_LIST
expr_stmt|;
name|arg
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|long
operator|)
name|ifindices
expr_stmt|;
name|arg
index|[
literal|2
index|]
operator|=
name|MAX_BR_PORTS
expr_stmt|;
name|arg
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|ifindices
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifindices
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|br_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|__caddr_t
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCDEVPRIVATE
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCDEVPRIVATE,BRCTL_GET_PORT_LIST]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|MAX_BR_PORTS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ifindices
index|[
name|i
index|]
operator|>
literal|0
condition|)
block|{
name|port_cnt
operator|++
expr_stmt|;
block|}
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|port_cnt
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vlan_rem
parameter_list|(
specifier|const
name|char
modifier|*
name|if_name
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|vlan_ioctl_args
name|if_request
decl_stmt|;
if|if
condition|(
operator|(
name|strlen
argument_list|(
name|if_name
argument_list|)
operator|+
literal|1
operator|)
operator|>
sizeof|sizeof
argument_list|(
name|if_request
operator|.
name|device1
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Interface name to long.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[AF_INET,SOCK_STREAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|if_request
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|if_request
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|if_request
operator|.
name|device1
argument_list|,
name|if_name
argument_list|)
expr_stmt|;
name|if_request
operator|.
name|cmd
operator|=
name|DEL_VLAN_CMD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCSIFVLAN
argument_list|,
operator|&
name|if_request
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIFVLAN,DEL_VLAN_CMD]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* 	Add a vlan interface with VLAN ID 'vid' and tagged interface 	'if_name'.  	returns -1 on error 	returns 1 if the interface already exists 	returns 0 otherwise */
end_comment

begin_function
specifier|static
name|int
name|vlan_add
parameter_list|(
specifier|const
name|char
modifier|*
name|if_name
parameter_list|,
name|int
name|vid
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|vlan_ioctl_args
name|if_request
decl_stmt|;
name|ifconfig_up
argument_list|(
name|if_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|strlen
argument_list|(
name|if_name
argument_list|)
operator|+
literal|1
operator|)
operator|>
sizeof|sizeof
argument_list|(
name|if_request
operator|.
name|device1
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Interface name to long.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[AF_INET,SOCK_STREAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|if_request
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|if_request
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Determine if a suitable vlan device already exists. */
name|snprintf
argument_list|(
name|if_request
operator|.
name|device1
argument_list|,
sizeof|sizeof
argument_list|(
name|if_request
operator|.
name|device1
argument_list|)
argument_list|,
literal|"vlan%d"
argument_list|,
name|vid
argument_list|)
expr_stmt|;
name|if_request
operator|.
name|cmd
operator|=
name|_GET_VLAN_VID_CMD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCSIFVLAN
argument_list|,
operator|&
name|if_request
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|if_request
operator|.
name|u
operator|.
name|VID
operator|==
name|vid
condition|)
block|{
name|if_request
operator|.
name|cmd
operator|=
name|_GET_VLAN_REALDEV_NAME_CMD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCSIFVLAN
argument_list|,
operator|&
name|if_request
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|if_request
operator|.
name|u
operator|.
name|device2
argument_list|,
name|if_name
argument_list|,
sizeof|sizeof
argument_list|(
name|if_request
operator|.
name|u
operator|.
name|device2
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
block|}
comment|/* A suitable vlan device does not already exist, add one. */
name|memset
argument_list|(
operator|&
name|if_request
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|if_request
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|if_request
operator|.
name|device1
argument_list|,
name|if_name
argument_list|)
expr_stmt|;
name|if_request
operator|.
name|u
operator|.
name|VID
operator|=
name|vid
expr_stmt|;
name|if_request
operator|.
name|cmd
operator|=
name|ADD_VLAN_CMD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCSIFVLAN
argument_list|,
operator|&
name|if_request
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIFVLAN,ADD_VLAN_CMD]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vlan_set_name_type
parameter_list|(
name|unsigned
name|int
name|name_type
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|vlan_ioctl_args
name|if_request
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[AF_INET,SOCK_STREAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|if_request
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|if_request
argument_list|)
argument_list|)
expr_stmt|;
name|if_request
operator|.
name|u
operator|.
name|name_type
operator|=
name|name_type
expr_stmt|;
name|if_request
operator|.
name|cmd
operator|=
name|SET_VLAN_NAME_TYPE_CMD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SIOCSIFVLAN
argument_list|,
operator|&
name|if_request
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIFVLAN,SET_VLAN_NAME_TYPE_CMD]"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vlan_newlink
parameter_list|(
name|char
modifier|*
name|ifname
parameter_list|,
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|char
name|vlan_ifname
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|char
name|br_name
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|struct
name|hostapd_vlan
modifier|*
name|vlan
init|=
name|hapd
operator|->
name|conf
operator|->
name|vlan
decl_stmt|;
name|char
modifier|*
name|tagged_interface
init|=
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|vlan_tagged_interface
decl_stmt|;
while|while
condition|(
name|vlan
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|ifname
argument_list|,
name|vlan
operator|->
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|br_name
argument_list|,
sizeof|sizeof
argument_list|(
name|br_name
argument_list|)
argument_list|,
literal|"brvlan%d"
argument_list|,
name|vlan
operator|->
name|vlan_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|br_addbr
argument_list|(
name|br_name
argument_list|)
condition|)
name|vlan
operator|->
name|clean
operator||=
name|DVLAN_CLEAN_BR
expr_stmt|;
name|ifconfig_up
argument_list|(
name|br_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|tagged_interface
condition|)
block|{
if|if
condition|(
operator|!
name|vlan_add
argument_list|(
name|tagged_interface
argument_list|,
name|vlan
operator|->
name|vlan_id
argument_list|)
condition|)
name|vlan
operator|->
name|clean
operator||=
name|DVLAN_CLEAN_VLAN
expr_stmt|;
name|snprintf
argument_list|(
name|vlan_ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|vlan_ifname
argument_list|)
argument_list|,
literal|"vlan%d"
argument_list|,
name|vlan
operator|->
name|vlan_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|br_addif
argument_list|(
name|br_name
argument_list|,
name|vlan_ifname
argument_list|)
condition|)
name|vlan
operator|->
name|clean
operator||=
name|DVLAN_CLEAN_VLAN_PORT
expr_stmt|;
name|ifconfig_up
argument_list|(
name|vlan_ifname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|br_addif
argument_list|(
name|br_name
argument_list|,
name|ifname
argument_list|)
condition|)
name|vlan
operator|->
name|clean
operator||=
name|DVLAN_CLEAN_WLAN_PORT
expr_stmt|;
name|ifconfig_up
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
break|break;
block|}
name|vlan
operator|=
name|vlan
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vlan_dellink
parameter_list|(
name|char
modifier|*
name|ifname
parameter_list|,
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|char
name|vlan_ifname
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|char
name|br_name
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|struct
name|hostapd_vlan
modifier|*
name|first
decl_stmt|,
modifier|*
name|prev
decl_stmt|,
modifier|*
name|vlan
init|=
name|hapd
operator|->
name|conf
operator|->
name|vlan
decl_stmt|;
name|char
modifier|*
name|tagged_interface
init|=
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|vlan_tagged_interface
decl_stmt|;
name|int
name|numports
decl_stmt|;
name|first
operator|=
name|prev
operator|=
name|vlan
expr_stmt|;
while|while
condition|(
name|vlan
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|ifname
argument_list|,
name|vlan
operator|->
name|ifname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|br_name
argument_list|,
sizeof|sizeof
argument_list|(
name|br_name
argument_list|)
argument_list|,
literal|"brvlan%d"
argument_list|,
name|vlan
operator|->
name|vlan_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|tagged_interface
condition|)
block|{
name|snprintf
argument_list|(
name|vlan_ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|vlan_ifname
argument_list|)
argument_list|,
literal|"vlan%d"
argument_list|,
name|vlan
operator|->
name|vlan_id
argument_list|)
expr_stmt|;
name|numports
operator|=
name|br_getnumports
argument_list|(
name|br_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|numports
operator|==
literal|1
condition|)
block|{
name|br_delif
argument_list|(
name|br_name
argument_list|,
name|vlan_ifname
argument_list|)
expr_stmt|;
name|vlan_rem
argument_list|(
name|vlan_ifname
argument_list|)
expr_stmt|;
name|ifconfig_down
argument_list|(
name|br_name
argument_list|)
expr_stmt|;
name|br_delbr
argument_list|(
name|br_name
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|vlan
operator|==
name|first
condition|)
block|{
name|hapd
operator|->
name|conf
operator|->
name|vlan
operator|=
name|vlan
operator|->
name|next
expr_stmt|;
block|}
else|else
block|{
name|prev
operator|->
name|next
operator|=
name|vlan
operator|->
name|next
expr_stmt|;
block|}
name|free
argument_list|(
name|vlan
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|vlan
expr_stmt|;
name|vlan
operator|=
name|vlan
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vlan_read_ifnames
parameter_list|(
name|struct
name|nlmsghdr
modifier|*
name|h
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|del
parameter_list|,
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|ifinfomsg
modifier|*
name|ifi
decl_stmt|;
name|int
name|attrlen
decl_stmt|,
name|nlmsg_len
decl_stmt|,
name|rta_len
decl_stmt|;
name|struct
name|rtattr
modifier|*
name|attr
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ifi
argument_list|)
condition|)
return|return;
name|ifi
operator|=
name|NLMSG_DATA
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|nlmsg_len
operator|=
name|NLMSG_ALIGN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ifinfomsg
argument_list|)
argument_list|)
expr_stmt|;
name|attrlen
operator|=
name|h
operator|->
name|nlmsg_len
operator|-
name|nlmsg_len
expr_stmt|;
if|if
condition|(
name|attrlen
operator|<
literal|0
condition|)
return|return;
name|attr
operator|=
operator|(
expr|struct
name|rtattr
operator|*
operator|)
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|ifi
operator|)
operator|+
name|nlmsg_len
operator|)
expr_stmt|;
name|rta_len
operator|=
name|RTA_ALIGN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rtattr
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|RTA_OK
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
condition|)
block|{
name|char
name|ifname
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|rta_type
operator|==
name|IFLA_IFNAME
condition|)
block|{
name|int
name|n
init|=
name|attr
operator|->
name|rta_len
operator|-
name|rta_len
decl_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
break|break;
name|memset
argument_list|(
name|ifname
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|n
operator|>
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
condition|)
name|n
operator|=
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ifname
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|attr
operator|)
operator|+
name|rta_len
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|del
condition|)
name|vlan_dellink
argument_list|(
name|ifname
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
else|else
name|vlan_newlink
argument_list|(
name|ifname
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
block|}
name|attr
operator|=
name|RTA_NEXT
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vlan_event_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|char
name|buf
index|[
literal|8192
index|]
decl_stmt|;
name|int
name|left
decl_stmt|;
name|struct
name|sockaddr_nl
name|from
decl_stmt|;
name|socklen_t
name|fromlen
decl_stmt|;
name|struct
name|nlmsghdr
modifier|*
name|h
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|eloop_ctx
decl_stmt|;
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|left
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|MSG_DONTWAIT
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
operator|&&
name|errno
operator|!=
name|EAGAIN
condition|)
name|perror
argument_list|(
literal|"recvfrom(netlink)"
argument_list|)
expr_stmt|;
return|return;
block|}
name|h
operator|=
operator|(
expr|struct
name|nlmsghdr
operator|*
operator|)
name|buf
expr_stmt|;
while|while
condition|(
name|left
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
condition|)
block|{
name|int
name|len
decl_stmt|,
name|plen
decl_stmt|;
name|len
operator|=
name|h
operator|->
name|nlmsg_len
expr_stmt|;
name|plen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
operator|||
name|plen
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Malformed netlink message: "
literal|"len=%d left=%d plen=%d"
argument_list|,
name|len
argument_list|,
name|left
argument_list|,
name|plen
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|h
operator|->
name|nlmsg_type
condition|)
block|{
case|case
name|RTM_NEWLINK
case|:
name|vlan_read_ifnames
argument_list|(
name|h
argument_list|,
name|plen
argument_list|,
literal|0
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_DELLINK
case|:
name|vlan_read_ifnames
argument_list|(
name|h
argument_list|,
name|plen
argument_list|,
literal|1
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
break|break;
block|}
name|len
operator|=
name|NLMSG_ALIGN
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|left
operator|-=
name|len
expr_stmt|;
name|h
operator|=
operator|(
expr|struct
name|nlmsghdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|h
operator|+
name|len
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|left
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%d extra bytes in the end of netlink message"
argument_list|,
name|left
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|full_dynamic_vlan
modifier|*
name|full_dynamic_vlan_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|sockaddr_nl
name|local
decl_stmt|;
name|struct
name|full_dynamic_vlan
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|priv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|priv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|priv
argument_list|)
argument_list|)
expr_stmt|;
name|vlan_set_name_type
argument_list|(
name|VLAN_NAME_TYPE_PLUS_VID_NO_PAD
argument_list|)
expr_stmt|;
name|priv
operator|->
name|s
operator|=
name|socket
argument_list|(
name|PF_NETLINK
argument_list|,
name|SOCK_RAW
argument_list|,
name|NETLINK_ROUTE
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_NETLINK,SOCK_RAW,NETLINK_ROUTE)"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|local
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|local
argument_list|)
argument_list|)
expr_stmt|;
name|local
operator|.
name|nl_family
operator|=
name|AF_NETLINK
expr_stmt|;
name|local
operator|.
name|nl_groups
operator|=
name|RTMGRP_LINK
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|priv
operator|->
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|local
argument_list|,
sizeof|sizeof
argument_list|(
name|local
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind(netlink)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|priv
operator|->
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|eloop_register_read_sock
argument_list|(
name|priv
operator|->
name|s
argument_list|,
name|vlan_event_receive
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|priv
operator|->
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|priv
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|full_dynamic_vlan_deinit
parameter_list|(
name|struct
name|full_dynamic_vlan
modifier|*
name|priv
parameter_list|)
block|{
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
return|return;
name|eloop_unregister_read_sock
argument_list|(
name|priv
operator|->
name|s
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|priv
operator|->
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_FULL_DYNAMIC_VLAN */
end_comment

begin_function
name|int
name|vlan_setup_encryption_dyn
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_ssid
modifier|*
name|mssid
parameter_list|,
specifier|const
name|char
modifier|*
name|dyn_vlan
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|dyn_vlan
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* Static WEP keys are set here; IEEE 802.1X and WPA uses their own 	 * functions for setting up dynamic broadcast keys. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mssid
operator|->
name|wep
operator|.
name|key
index|[
name|i
index|]
operator|&&
name|hostapd_set_encryption
argument_list|(
name|dyn_vlan
argument_list|,
name|hapd
argument_list|,
literal|"WEP"
argument_list|,
name|NULL
argument_list|,
name|i
argument_list|,
name|mssid
operator|->
name|wep
operator|.
name|key
index|[
name|i
index|]
argument_list|,
name|mssid
operator|->
name|wep
operator|.
name|len
index|[
name|i
index|]
argument_list|,
name|i
operator|==
name|mssid
operator|->
name|wep
operator|.
name|idx
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"VLAN: Could not set WEP encryption for "
literal|"dynamic VLAN.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vlan_dynamic_add
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_vlan
modifier|*
name|vlan
parameter_list|)
block|{
while|while
condition|(
name|vlan
condition|)
block|{
if|if
condition|(
name|vlan
operator|->
name|vlan_id
operator|!=
name|VLAN_ID_WILDCARD
operator|&&
name|hostapd_if_add
argument_list|(
name|hapd
argument_list|,
name|HOSTAPD_IF_VLAN
argument_list|,
name|vlan
operator|->
name|ifname
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EEXIST
condition|)
block|{
name|printf
argument_list|(
literal|"Could not add VLAN iface: %s: %s\n"
argument_list|,
name|vlan
operator|->
name|ifname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|vlan
operator|=
name|vlan
operator|->
name|next
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vlan_dynamic_remove
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_vlan
modifier|*
name|vlan
parameter_list|)
block|{
name|struct
name|hostapd_vlan
modifier|*
name|next
decl_stmt|;
while|while
condition|(
name|vlan
condition|)
block|{
name|next
operator|=
name|vlan
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|vlan
operator|->
name|vlan_id
operator|!=
name|VLAN_ID_WILDCARD
operator|&&
name|hostapd_if_remove
argument_list|(
name|hapd
argument_list|,
name|HOSTAPD_IF_VLAN
argument_list|,
name|vlan
operator|->
name|ifname
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Could not remove VLAN iface: %s: %s\n"
argument_list|,
name|vlan
operator|->
name|ifname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_FULL_DYNAMIC_VLAN
if|if
condition|(
name|vlan
operator|->
name|clean
condition|)
name|vlan_dellink
argument_list|(
name|vlan
operator|->
name|ifname
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_FULL_DYNAMIC_VLAN */
name|vlan
operator|=
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|vlan_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
if|if
condition|(
name|vlan_dynamic_add
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|vlan
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
ifdef|#
directive|ifdef
name|CONFIG_FULL_DYNAMIC_VLAN
name|hapd
operator|->
name|full_dynamic_vlan
operator|=
name|full_dynamic_vlan_init
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_FULL_DYNAMIC_VLAN */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|vlan_deinit
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|vlan_dynamic_remove
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|vlan
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_FULL_DYNAMIC_VLAN
name|full_dynamic_vlan_deinit
argument_list|(
name|hapd
operator|->
name|full_dynamic_vlan
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_FULL_DYNAMIC_VLAN */
block|}
end_function

begin_function
name|int
name|vlan_reconfig
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_config
modifier|*
name|oldconf
parameter_list|,
name|struct
name|hostapd_bss_config
modifier|*
name|oldbss
parameter_list|)
block|{
name|vlan_dynamic_remove
argument_list|(
name|hapd
argument_list|,
name|oldbss
operator|->
name|vlan
argument_list|)
expr_stmt|;
if|if
condition|(
name|vlan_dynamic_add
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|vlan
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|hostapd_vlan
modifier|*
name|vlan_add_dynamic
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_vlan
modifier|*
name|vlan
parameter_list|,
name|int
name|vlan_id
parameter_list|)
block|{
name|struct
name|hostapd_vlan
modifier|*
name|n
decl_stmt|;
name|char
modifier|*
name|ifname
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|vlan
operator|==
name|NULL
operator|||
name|vlan_id
operator|<=
literal|0
operator|||
name|vlan_id
operator|>
name|MAX_VLAN_ID
operator|||
name|vlan
operator|->
name|vlan_id
operator|!=
name|VLAN_ID_WILDCARD
condition|)
return|return
name|NULL
return|;
name|ifname
operator|=
name|strdup
argument_list|(
name|vlan
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifname
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|strchr
argument_list|(
name|ifname
argument_list|,
literal|'#'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|n
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|n
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|n
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|n
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|->
name|vlan_id
operator|=
name|vlan_id
expr_stmt|;
name|n
operator|->
name|dynamic_vlan
operator|=
literal|1
expr_stmt|;
name|snprintf
argument_list|(
name|n
operator|->
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|n
operator|->
name|ifname
argument_list|)
argument_list|,
literal|"%s%d%s"
argument_list|,
name|ifname
argument_list|,
name|vlan_id
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_if_add
argument_list|(
name|hapd
argument_list|,
name|HOSTAPD_IF_VLAN
argument_list|,
name|n
operator|->
name|ifname
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|n
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|n
operator|->
name|next
operator|=
name|hapd
operator|->
name|conf
operator|->
name|vlan
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|vlan
operator|=
name|n
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
name|int
name|vlan_remove_dynamic
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|vlan_id
parameter_list|)
block|{
name|struct
name|hostapd_vlan
modifier|*
name|vlan
decl_stmt|;
if|if
condition|(
name|vlan_id
operator|<=
literal|0
operator|||
name|vlan_id
operator|>
name|MAX_VLAN_ID
condition|)
return|return
literal|1
return|;
name|vlan
operator|=
name|hapd
operator|->
name|conf
operator|->
name|vlan
expr_stmt|;
while|while
condition|(
name|vlan
condition|)
block|{
if|if
condition|(
name|vlan
operator|->
name|vlan_id
operator|==
name|vlan_id
operator|&&
name|vlan
operator|->
name|dynamic_vlan
operator|>
literal|0
condition|)
block|{
name|vlan
operator|->
name|dynamic_vlan
operator|--
expr_stmt|;
break|break;
block|}
name|vlan
operator|=
name|vlan
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|vlan
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|vlan
operator|->
name|dynamic_vlan
operator|==
literal|0
condition|)
name|hostapd_if_remove
argument_list|(
name|hapd
argument_list|,
name|HOSTAPD_IF_VLAN
argument_list|,
name|vlan
operator|->
name|ifname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


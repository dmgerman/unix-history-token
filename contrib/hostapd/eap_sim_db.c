begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / EAP-SIM database/authenticator gateway  * Copyright (c) 2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_comment
comment|/* This is an example implementation of the EAP-SIM database/authentication  * gateway interface that is expected to be replaced with an implementation of  * SS7 gateway to GSM authentication center (HLR/AuC) or a local  * implementation of SIM triplet generator.  *  * The example implementation here reads triplets from a text file in  * IMSI:Kc:SRES:RAND format, IMSI in ASCII, other fields as hex strings. This  * is used to simulate an HLR/AuC. As such, it is not very useful for real life  * authentication, but it is useful both as an example implementation and for  * EAP-SIM testing.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eap_sim_common.h"
end_include

begin_include
include|#
directive|include
file|"eap_sim_db.h"
end_include

begin_comment
comment|/* TODO: add an alternative callback based version of the interface. This is  * needed to work better with the single threaded design of hostapd. For this,  * the EAP data has to be stored somewhere and eap_sim_db is given a context  * pointer for this and a callback function. The callback function will re-send  * the EAP data through normal operations which will eventually end up calling  * eap_sim_db_get_gsm_triplets() again for the same user. This time, eap_sim_db  * should have the triplets available immediately. */
end_comment

begin_struct
struct|struct
name|eap_sim_db_data
block|{
name|char
modifier|*
name|fname
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|KC_LEN
value|8
end_define

begin_define
define|#
directive|define
name|SRES_LEN
value|4
end_define

begin_define
define|#
directive|define
name|RAND_LEN
value|16
end_define

begin_comment
comment|/* Initialize EAP-SIM database/authentication gateway interface.  * Returns pointer to a private data structure. */
end_comment

begin_function
name|void
modifier|*
name|eap_sim_db_init
parameter_list|(
specifier|const
name|char
modifier|*
name|config
parameter_list|)
block|{
name|struct
name|eap_sim_db_data
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|fname
operator|=
name|strdup
argument_list|(
name|config
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|fname
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|data
return|;
block|}
end_function

begin_comment
comment|/* Deinitialize EAP-SIM database/authentication gateway interface.  * priv is the pointer from eap_sim_db_init(). */
end_comment

begin_function
name|void
name|eap_sim_db_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_db_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|free
argument_list|(
name|data
operator|->
name|fname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Get GSM triplets for user name identity (identity_len bytes). In most cases,  * the user name is '1' | IMSI, i.e., 1 followed by the IMSI in ASCII format.  * The identity may also include NAI realm (@realm).  * priv is the pointer from eap_sim_db_init().  * Returns the number of triplets received (has to be less than or equal to  * max_chal) or -1 on error (e.g., user not found). rand, kc, and sres are  * pointers to data areas for the triplets. */
end_comment

begin_function
name|int
name|eap_sim_db_get_gsm_triplets
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|identity
parameter_list|,
name|size_t
name|identity_len
parameter_list|,
name|int
name|max_chal
parameter_list|,
name|u8
modifier|*
name|rand
parameter_list|,
name|u8
modifier|*
name|kc
parameter_list|,
name|u8
modifier|*
name|sres
parameter_list|)
block|{
name|struct
name|eap_sim_db_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|int
name|count
decl_stmt|,
name|i
decl_stmt|;
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|data
operator|->
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM DB: could not open triplet "
literal|"file '%s'"
argument_list|,
name|data
operator|->
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|identity_len
operator|<
literal|2
operator|||
name|identity
index|[
literal|0
index|]
operator|!=
literal|'1'
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM DB: unexpected identity"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|identity
operator|++
expr_stmt|;
name|identity_len
operator|--
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|identity_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|identity
index|[
name|i
index|]
operator|==
literal|'@'
condition|)
block|{
name|identity_len
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM DB: get triplets for IMSI"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|<
name|max_chal
operator|&&
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
comment|/* Parse IMSI:Kc:SRES:RAND and match IMSI with identity. */
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos
operator|!=
literal|'\n'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|pos
operator|-
name|buf
operator|<
literal|60
operator|||
name|pos
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
continue|continue;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|buf
argument_list|)
operator|!=
name|identity_len
operator|||
name|memcmp
argument_list|(
name|buf
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|next
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
operator|==
name|NULL
condition|)
continue|continue;
operator|*
name|next
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
operator|&
name|kc
index|[
name|count
operator|*
name|KC_LEN
index|]
argument_list|,
name|KC_LEN
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
name|pos
operator|=
name|next
expr_stmt|;
name|next
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
operator|==
name|NULL
condition|)
continue|continue;
operator|*
name|next
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
operator|&
name|sres
index|[
name|count
operator|*
name|SRES_LEN
index|]
argument_list|,
name|SRES_LEN
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|next
argument_list|,
operator|&
name|rand
index|[
name|count
operator|*
name|RAND_LEN
index|]
argument_list|,
name|RAND_LEN
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
name|count
operator|++
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM DB: no triplets found"
argument_list|)
expr_stmt|;
name|count
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_comment
comment|/* Verify whether the given user identity (identity_len bytes) is known. In  * most cases, the user name is '1' | IMSI, i.e., 1 followed by the IMSI in  * ASCII format.  * priv is the pointer from eap_sim_db_init().  * Returns 0 if the user is found and GSM triplets would be available for it or  * -1 on error (e.g., user not found or no triplets available). */
end_comment

begin_function
name|int
name|eap_sim_db_identity_known
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|identity
parameter_list|,
name|size_t
name|identity_len
parameter_list|)
block|{
name|struct
name|eap_sim_db_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|identity_len
operator|<
literal|1
operator|||
name|identity
index|[
literal|0
index|]
operator|!=
literal|'1'
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|f
operator|=
name|fopen
argument_list|(
name|data
operator|->
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM DB: could not open triplet "
literal|"file '%s'"
argument_list|,
name|data
operator|->
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|identity_len
operator|<
literal|2
operator|||
name|identity
index|[
literal|0
index|]
operator|!=
literal|'1'
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM DB: unexpected identity"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|identity
operator|++
expr_stmt|;
name|identity_len
operator|--
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|identity_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|identity
index|[
name|i
index|]
operator|==
literal|'@'
condition|)
block|{
name|identity_len
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
comment|/* Parse IMSI:Kc:SRES:RAND and match IMSI with identity. */
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos
operator|!=
literal|'\n'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|pos
operator|-
name|buf
operator|<
literal|60
operator|||
name|pos
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
continue|continue;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|buf
argument_list|)
operator|!=
name|identity_len
operator|||
name|memcmp
argument_list|(
name|buf
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* IMSI not found */
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

end_unit


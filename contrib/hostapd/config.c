begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / Configuration file  * Copyright (c) 2003-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"eap.h"
end_include

begin_include
include|#
directive|include
file|"radius_client.h"
end_include

begin_include
include|#
directive|include
file|"wpa_common.h"
end_include

begin_define
define|#
directive|define
name|MAX_STA_COUNT
value|2007
end_define

begin_function
specifier|static
name|int
name|hostapd_config_read_vlan_file
parameter_list|(
name|struct
name|hostapd_bss_config
modifier|*
name|bss
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|,
name|vlan_id
decl_stmt|;
name|struct
name|hostapd_vlan
modifier|*
name|vlan
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|printf
argument_list|(
literal|"VLAN file '%s' not readable.\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
continue|continue;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'*'
condition|)
block|{
name|vlan_id
operator|=
name|VLAN_ID_WILDCARD
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|vlan_id
operator|=
name|strtol
argument_list|(
name|buf
argument_list|,
operator|&
name|pos
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|pos
operator|||
name|vlan_id
operator|<
literal|1
operator|||
name|vlan_id
operator|>
name|MAX_VLAN_ID
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid VLAN ID at line %d in '%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
operator|||
operator|*
name|pos
operator|==
literal|'\t'
condition|)
name|pos
operator|++
expr_stmt|;
name|pos2
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos2
operator|!=
literal|' '
operator|&&
operator|*
name|pos2
operator|!=
literal|'\t'
operator|&&
operator|*
name|pos2
operator|!=
literal|'\0'
condition|)
name|pos2
operator|++
expr_stmt|;
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
operator|||
name|strlen
argument_list|(
name|pos
argument_list|)
operator|>
name|IFNAMSIZ
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid VLAN ifname at line %d in '%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|vlan
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|vlan
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vlan
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Out of memory while reading VLAN interfaces "
literal|"from '%s'\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
name|vlan
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|vlan
argument_list|)
argument_list|)
expr_stmt|;
name|vlan
operator|->
name|vlan_id
operator|=
name|vlan_id
expr_stmt|;
name|strncpy
argument_list|(
name|vlan
operator|->
name|ifname
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|vlan
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|vlan_tail
condition|)
name|bss
operator|->
name|vlan_tail
operator|->
name|next
operator|=
name|vlan
expr_stmt|;
else|else
name|bss
operator|->
name|vlan
operator|=
name|vlan
expr_stmt|;
name|bss
operator|->
name|vlan_tail
operator|=
name|vlan
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_config_free_vlan
parameter_list|(
name|struct
name|hostapd_bss_config
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|hostapd_vlan
modifier|*
name|vlan
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|vlan
operator|=
name|bss
operator|->
name|vlan
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|vlan
condition|)
block|{
name|prev
operator|=
name|vlan
expr_stmt|;
name|vlan
operator|=
name|vlan
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|bss
operator|->
name|vlan
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* convert floats with one decimal place to value*10 int, i.e.,  * "1.5" will return 15 */
end_comment

begin_function
specifier|static
name|int
name|hostapd_config_read_int10
parameter_list|(
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|d
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|i
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|value
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
name|d
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|>=
literal|'0'
operator|&&
operator|*
name|pos
operator|<=
literal|'9'
condition|)
name|d
operator|=
operator|*
name|pos
operator|-
literal|'0'
expr_stmt|;
block|}
return|return
name|i
operator|*
literal|10
operator|+
name|d
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_config_defaults_bss
parameter_list|(
name|struct
name|hostapd_bss_config
modifier|*
name|bss
parameter_list|)
block|{
name|bss
operator|->
name|logger_syslog_level
operator|=
name|HOSTAPD_LEVEL_INFO
expr_stmt|;
name|bss
operator|->
name|logger_stdout_level
operator|=
name|HOSTAPD_LEVEL_INFO
expr_stmt|;
name|bss
operator|->
name|logger_syslog
operator|=
operator|(
name|unsigned
name|int
operator|)
operator|-
literal|1
expr_stmt|;
name|bss
operator|->
name|logger_stdout
operator|=
operator|(
name|unsigned
name|int
operator|)
operator|-
literal|1
expr_stmt|;
name|bss
operator|->
name|auth_algs
operator|=
name|HOSTAPD_AUTH_OPEN
operator||
name|HOSTAPD_AUTH_SHARED_KEY
expr_stmt|;
name|bss
operator|->
name|wep_rekeying_period
operator|=
literal|300
expr_stmt|;
comment|/* use key0 in individual key and key1 in broadcast key */
name|bss
operator|->
name|broadcast_key_idx_min
operator|=
literal|1
expr_stmt|;
name|bss
operator|->
name|broadcast_key_idx_max
operator|=
literal|2
expr_stmt|;
name|bss
operator|->
name|eap_reauth_period
operator|=
literal|3600
expr_stmt|;
name|bss
operator|->
name|wpa_group_rekey
operator|=
literal|600
expr_stmt|;
name|bss
operator|->
name|wpa_gmk_rekey
operator|=
literal|86400
expr_stmt|;
name|bss
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|bss
operator|->
name|wpa_pairwise
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
name|bss
operator|->
name|wpa_group
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
name|bss
operator|->
name|max_num_sta
operator|=
name|MAX_STA_COUNT
expr_stmt|;
name|bss
operator|->
name|dtim_period
operator|=
literal|2
expr_stmt|;
name|bss
operator|->
name|radius_server_auth_port
operator|=
literal|1812
expr_stmt|;
name|bss
operator|->
name|ap_max_inactivity
operator|=
name|AP_MAX_INACTIVITY
expr_stmt|;
name|bss
operator|->
name|eapol_version
operator|=
name|EAPOL_VERSION
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_config
modifier|*
name|hostapd_config_defaults
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|hostapd_config
modifier|*
name|conf
decl_stmt|;
name|struct
name|hostapd_bss_config
modifier|*
name|bss
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|int
name|aCWmin
init|=
literal|15
decl_stmt|,
name|aCWmax
init|=
literal|1024
decl_stmt|;
specifier|const
name|struct
name|hostapd_wme_ac_params
name|ac_bk
init|=
block|{
name|aCWmin
block|,
name|aCWmax
block|,
literal|7
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
comment|/* background traffic */
specifier|const
name|struct
name|hostapd_wme_ac_params
name|ac_be
init|=
block|{
name|aCWmin
block|,
name|aCWmax
block|,
literal|3
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
comment|/* best effort traffic */
specifier|const
name|struct
name|hostapd_wme_ac_params
name|ac_vi
init|=
comment|/* video traffic */
block|{
name|aCWmin
operator|>>
literal|1
block|,
name|aCWmin
block|,
literal|2
block|,
literal|3000
operator|/
literal|32
block|,
literal|1
block|}
decl_stmt|;
specifier|const
name|struct
name|hostapd_wme_ac_params
name|ac_vo
init|=
comment|/* voice traffic */
block|{
name|aCWmin
operator|>>
literal|2
block|,
name|aCWmin
operator|>>
literal|1
block|,
literal|2
block|,
literal|1500
operator|/
literal|32
block|,
literal|1
block|}
decl_stmt|;
name|conf
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|conf
argument_list|)
argument_list|)
expr_stmt|;
name|bss
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
operator|||
name|bss
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate memory for configuration data.\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* set default driver based on configuration */
name|conf
operator|->
name|driver
operator|=
name|driver_lookup
argument_list|(
literal|"default"
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|driver
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No default driver registered!\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bss
operator|->
name|radius
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
operator|->
name|radius
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|radius
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|hostapd_config_defaults_bss
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|conf
operator|->
name|num_bss
operator|=
literal|1
expr_stmt|;
name|conf
operator|->
name|bss
operator|=
name|bss
expr_stmt|;
name|conf
operator|->
name|beacon_int
operator|=
literal|100
expr_stmt|;
name|conf
operator|->
name|rts_threshold
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* use driver default: 2347 */
name|conf
operator|->
name|fragm_threshold
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* user driver default: 2346 */
name|conf
operator|->
name|send_probe_response
operator|=
literal|1
expr_stmt|;
name|conf
operator|->
name|bridge_packets
operator|=
name|INTERNAL_BRIDGE_DO_NOT_CONTROL
expr_stmt|;
name|memcpy
argument_list|(
name|conf
operator|->
name|country
argument_list|,
literal|"US "
argument_list|,
literal|3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_TX_QUEUES
condition|;
name|i
operator|++
control|)
name|conf
operator|->
name|tx_queue
index|[
name|i
index|]
operator|.
name|aifs
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* use hw default */
name|conf
operator|->
name|wme_ac_params
index|[
literal|0
index|]
operator|=
name|ac_be
expr_stmt|;
name|conf
operator|->
name|wme_ac_params
index|[
literal|1
index|]
operator|=
name|ac_bk
expr_stmt|;
name|conf
operator|->
name|wme_ac_params
index|[
literal|2
index|]
operator|=
name|ac_vi
expr_stmt|;
name|conf
operator|->
name|wme_ac_params
index|[
literal|3
index|]
operator|=
name|ac_vo
expr_stmt|;
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_parse_ip_addr
parameter_list|(
specifier|const
name|char
modifier|*
name|txt
parameter_list|,
name|struct
name|hostapd_ip_addr
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|inet_aton
argument_list|(
name|txt
argument_list|,
operator|&
name|addr
operator|->
name|u
operator|.
name|v4
argument_list|)
condition|)
block|{
name|addr
operator|->
name|af
operator|=
name|AF_INET
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IPV6
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|txt
argument_list|,
operator|&
name|addr
operator|->
name|u
operator|.
name|v6
argument_list|)
operator|>
literal|0
condition|)
block|{
name|addr
operator|->
name|af
operator|=
name|AF_INET6
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IPV6 */
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|hostapd_mac_comp
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
name|memcmp
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|macaddr
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|hostapd_mac_comp_empty
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|)
block|{
name|macaddr
name|empty
init|=
block|{
literal|0
block|}
decl_stmt|;
return|return
name|memcmp
argument_list|(
name|a
argument_list|,
name|empty
argument_list|,
sizeof|sizeof
argument_list|(
name|macaddr
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_config_read_maclist
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|macaddr
modifier|*
modifier|*
name|acl
parameter_list|,
name|int
modifier|*
name|num
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|macaddr
modifier|*
name|newacl
decl_stmt|;
if|if
condition|(
operator|!
name|fname
condition|)
return|return
literal|0
return|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|printf
argument_list|(
literal|"MAC list file '%s' not found.\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
continue|continue;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|buf
argument_list|,
name|addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid MAC address '%s' at line %d in '%s'\n"
argument_list|,
name|buf
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|newacl
operator|=
operator|(
name|macaddr
operator|*
operator|)
name|realloc
argument_list|(
operator|*
name|acl
argument_list|,
operator|(
operator|*
name|num
operator|+
literal|1
operator|)
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|newacl
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"MAC list reallocation failed\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|acl
operator|=
name|newacl
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|*
name|acl
operator|)
index|[
operator|*
name|num
index|]
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
operator|(
operator|*
name|num
operator|)
operator|++
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|qsort
argument_list|(
operator|*
name|acl
argument_list|,
operator|*
name|num
argument_list|,
sizeof|sizeof
argument_list|(
name|macaddr
argument_list|)
argument_list|,
name|hostapd_mac_comp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_config_read_wpa_psk
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|struct
name|hostapd_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|,
name|len
decl_stmt|,
name|ok
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|hostapd_wpa_psk
modifier|*
name|psk
decl_stmt|;
if|if
condition|(
operator|!
name|fname
condition|)
return|return
literal|0
return|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|printf
argument_list|(
literal|"WPA PSK file '%s' not found.\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
continue|continue;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|buf
argument_list|,
name|addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid MAC address '%s' on line %d in '%s'\n"
argument_list|,
name|buf
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|psk
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|psk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|psk
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"WPA PSK allocation failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|addr
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
name|psk
operator|->
name|group
operator|=
literal|1
expr_stmt|;
else|else
name|memcpy
argument_list|(
name|psk
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
literal|17
expr_stmt|;
if|if
condition|(
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"No PSK on line %d in '%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|psk
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|++
expr_stmt|;
name|ok
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|64
operator|&&
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
operator|==
literal|0
condition|)
name|ok
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>=
literal|8
operator|&&
name|len
operator|<
literal|64
condition|)
block|{
name|pbkdf2_sha1
argument_list|(
name|pos
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
literal|4096
argument_list|,
name|psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid PSK '%s' on line %d in '%s'\n"
argument_list|,
name|pos
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|psk
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|psk
operator|->
name|next
operator|=
name|ssid
operator|->
name|wpa_psk
expr_stmt|;
name|ssid
operator|->
name|wpa_psk
operator|=
name|psk
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|hostapd_setup_wpa_psk
parameter_list|(
name|struct
name|hostapd_bss_config
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|hostapd_ssid
modifier|*
name|ssid
init|=
operator|&
name|conf
operator|->
name|ssid
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|wpa_passphrase
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wpa_psk
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Warning: both WPA PSK and passphrase set. "
literal|"Using passphrase.\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ssid
operator|->
name|wpa_psk
argument_list|)
expr_stmt|;
block|}
name|ssid
operator|->
name|wpa_psk
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_wpa_psk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|wpa_psk
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Unable to alloc space for PSK\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSID"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PSK (ASCII passphrase)"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ssid
operator|->
name|wpa_passphrase
argument_list|,
name|strlen
argument_list|(
name|ssid
operator|->
name|wpa_passphrase
argument_list|)
argument_list|)
expr_stmt|;
name|pbkdf2_sha1
argument_list|(
name|ssid
operator|->
name|wpa_passphrase
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
literal|4096
argument_list|,
name|ssid
operator|->
name|wpa_psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PSK (from passphrase)"
argument_list|,
name|ssid
operator|->
name|wpa_psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|wpa_psk
operator|->
name|group
operator|=
literal|1
expr_stmt|;
name|memset
argument_list|(
name|ssid
operator|->
name|wpa_passphrase
argument_list|,
literal|0
argument_list|,
name|strlen
argument_list|(
name|ssid
operator|->
name|wpa_passphrase
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ssid
operator|->
name|wpa_passphrase
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|wpa_passphrase
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|wpa_psk_file
condition|)
block|{
if|if
condition|(
name|hostapd_config_read_wpa_psk
argument_list|(
name|ssid
operator|->
name|wpa_psk_file
argument_list|,
operator|&
name|conf
operator|->
name|ssid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|free
argument_list|(
name|ssid
operator|->
name|wpa_psk_file
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|wpa_psk_file
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_SERVER
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_config_read_eap_user
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|struct
name|hostapd_bss_config
modifier|*
name|conf
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|start
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|,
name|num_methods
decl_stmt|;
name|struct
name|hostapd_eap_user
modifier|*
name|user
decl_stmt|,
modifier|*
name|tail
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|fname
condition|)
return|return
literal|0
return|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|printf
argument_list|(
literal|"EAP user file '%s' not found.\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Lines: "user" METHOD,METHOD2 "password" (password optional) */
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
continue|continue;
name|user
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|'"'
operator|&&
name|buf
index|[
literal|0
index|]
operator|!=
literal|'*'
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid EAP identity (no \" in start) on "
literal|"line %d in '%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|user
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|user
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"EAP user allocation failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|user
operator|->
name|force_version
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'*'
condition|)
block|{
name|pos
operator|=
name|buf
expr_stmt|;
block|}
else|else
block|{
name|pos
operator|=
name|buf
operator|+
literal|1
expr_stmt|;
name|start
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'"'
operator|&&
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid EAP identity (no \" in end) on"
literal|" line %d in '%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|user
operator|->
name|identity
operator|=
name|malloc
argument_list|(
name|pos
operator|-
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|->
name|identity
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate memory for EAP "
literal|"identity\n"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|memcpy
argument_list|(
name|user
operator|->
name|identity
argument_list|,
name|start
argument_list|,
name|pos
operator|-
name|start
argument_list|)
expr_stmt|;
name|user
operator|->
name|identity_len
operator|=
name|pos
operator|-
name|start
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
literal|'"'
operator|&&
name|pos
index|[
literal|1
index|]
operator|==
literal|'*'
condition|)
block|{
name|user
operator|->
name|wildcard_prefix
operator|=
literal|1
expr_stmt|;
name|pos
operator|++
expr_stmt|;
block|}
block|}
name|pos
operator|++
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
operator|||
operator|*
name|pos
operator|==
literal|'\t'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"No EAP method on line %d in '%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|start
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|' '
operator|&&
operator|*
name|pos
operator|!=
literal|'\t'
operator|&&
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|pos
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|++
expr_stmt|;
block|}
name|num_methods
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|start
condition|)
block|{
name|char
modifier|*
name|pos3
init|=
name|strchr
argument_list|(
name|start
argument_list|,
literal|','
argument_list|)
decl_stmt|;
if|if
condition|(
name|pos3
condition|)
block|{
operator|*
name|pos3
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
name|user
operator|->
name|methods
index|[
name|num_methods
index|]
operator|.
name|method
operator|=
name|eap_get_type
argument_list|(
name|start
argument_list|,
operator|&
name|user
operator|->
name|methods
index|[
name|num_methods
index|]
operator|.
name|vendor
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|->
name|methods
index|[
name|num_methods
index|]
operator|.
name|vendor
operator|==
name|EAP_VENDOR_IETF
operator|&&
name|user
operator|->
name|methods
index|[
name|num_methods
index|]
operator|.
name|method
operator|==
name|EAP_TYPE_NONE
condition|)
block|{
name|printf
argument_list|(
literal|"Unsupported EAP type '%s' on line %d "
literal|"in '%s'\n"
argument_list|,
name|start
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|num_methods
operator|++
expr_stmt|;
if|if
condition|(
name|num_methods
operator|>=
name|EAP_USER_MAX_METHODS
condition|)
break|break;
if|if
condition|(
name|pos3
operator|==
name|NULL
condition|)
break|break;
name|start
operator|=
name|pos3
expr_stmt|;
block|}
if|if
condition|(
name|num_methods
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"No EAP types configured on line %d in '%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
operator|||
operator|*
name|pos
operator|==
literal|'\t'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"[ver=0]"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|user
operator|->
name|force_version
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"[ver=1]"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|user
operator|->
name|force_version
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"[2]"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|user
operator|->
name|phase2
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
literal|'"'
condition|)
block|{
name|pos
operator|++
expr_stmt|;
name|start
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'"'
operator|&&
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid EAP password (no \" in end) "
literal|"on line %d in '%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|user
operator|->
name|password
operator|=
name|malloc
argument_list|(
name|pos
operator|-
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|->
name|password
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate memory for EAP "
literal|"password\n"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|memcpy
argument_list|(
name|user
operator|->
name|password
argument_list|,
name|start
argument_list|,
name|pos
operator|-
name|start
argument_list|)
expr_stmt|;
name|user
operator|->
name|password_len
operator|=
name|pos
operator|-
name|start
expr_stmt|;
name|pos
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"hash:"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pos
operator|+=
literal|5
expr_stmt|;
name|pos2
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos2
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos2
operator|!=
literal|' '
operator|&&
operator|*
name|pos2
operator|!=
literal|'\t'
operator|&&
operator|*
name|pos2
operator|!=
literal|'#'
condition|)
name|pos2
operator|++
expr_stmt|;
if|if
condition|(
name|pos2
operator|-
name|pos
operator|!=
literal|32
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid password hash on line %d in "
literal|"'%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|user
operator|->
name|password
operator|=
name|malloc
argument_list|(
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|->
name|password
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate memory for EAP "
literal|"password hash\n"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|user
operator|->
name|password
argument_list|,
literal|16
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid hash password on line %d in "
literal|"'%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|user
operator|->
name|password_len
operator|=
literal|16
expr_stmt|;
name|user
operator|->
name|password_hash
operator|=
literal|1
expr_stmt|;
name|pos
operator|=
name|pos2
expr_stmt|;
block|}
else|else
block|{
name|pos2
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos2
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos2
operator|!=
literal|' '
operator|&&
operator|*
name|pos2
operator|!=
literal|'\t'
operator|&&
operator|*
name|pos2
operator|!=
literal|'#'
condition|)
name|pos2
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|pos2
operator|-
name|pos
operator|)
operator|&
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid hex password on line %d in "
literal|"'%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|user
operator|->
name|password
operator|=
name|malloc
argument_list|(
operator|(
name|pos2
operator|-
name|pos
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|->
name|password
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate memory for EAP "
literal|"password\n"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|user
operator|->
name|password
argument_list|,
operator|(
name|pos2
operator|-
name|pos
operator|)
operator|/
literal|2
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid hex password on line %d in "
literal|"'%s'\n"
argument_list|,
name|line
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|user
operator|->
name|password_len
operator|=
operator|(
name|pos2
operator|-
name|pos
operator|)
operator|/
literal|2
expr_stmt|;
name|pos
operator|=
name|pos2
expr_stmt|;
block|}
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
operator|||
operator|*
name|pos
operator|==
literal|'\t'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"[2]"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|user
operator|->
name|phase2
operator|=
literal|1
expr_stmt|;
block|}
name|done
label|:
if|if
condition|(
name|tail
operator|==
name|NULL
condition|)
block|{
name|tail
operator|=
name|conf
operator|->
name|eap_user
operator|=
name|user
expr_stmt|;
block|}
else|else
block|{
name|tail
operator|->
name|next
operator|=
name|user
expr_stmt|;
name|tail
operator|=
name|user
expr_stmt|;
block|}
continue|continue;
name|failed
label|:
if|if
condition|(
name|user
condition|)
block|{
name|free
argument_list|(
name|user
operator|->
name|password
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|user
operator|->
name|identity
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_SERVER */
end_comment

begin_function
specifier|static
name|int
name|hostapd_config_read_radius_addr
parameter_list|(
name|struct
name|hostapd_radius_server
modifier|*
modifier|*
name|server
parameter_list|,
name|int
modifier|*
name|num_server
parameter_list|,
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|def_port
parameter_list|,
name|struct
name|hostapd_radius_server
modifier|*
modifier|*
name|curr_serv
parameter_list|)
block|{
name|struct
name|hostapd_radius_server
modifier|*
name|nserv
decl_stmt|;
name|int
name|ret
decl_stmt|;
specifier|static
name|int
name|server_index
init|=
literal|1
decl_stmt|;
name|nserv
operator|=
name|realloc
argument_list|(
operator|*
name|server
argument_list|,
operator|(
operator|*
name|num_server
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|nserv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nserv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|server
operator|=
name|nserv
expr_stmt|;
name|nserv
operator|=
operator|&
name|nserv
index|[
operator|*
name|num_server
index|]
expr_stmt|;
operator|(
operator|*
name|num_server
operator|)
operator|++
expr_stmt|;
operator|(
operator|*
name|curr_serv
operator|)
operator|=
name|nserv
expr_stmt|;
name|memset
argument_list|(
name|nserv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nserv
argument_list|)
argument_list|)
expr_stmt|;
name|nserv
operator|->
name|port
operator|=
name|def_port
expr_stmt|;
name|ret
operator|=
name|hostapd_parse_ip_addr
argument_list|(
name|val
argument_list|,
operator|&
name|nserv
operator|->
name|addr
argument_list|)
expr_stmt|;
name|nserv
operator|->
name|index
operator|=
name|server_index
operator|++
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_config_parse_key_mgmt
parameter_list|(
name|int
name|line
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|val
init|=
literal|0
decl_stmt|,
name|last
decl_stmt|;
name|char
modifier|*
name|start
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|start
operator|=
name|buf
expr_stmt|;
while|while
condition|(
name|start
operator|!=
literal|'\0'
condition|)
block|{
while|while
condition|(
operator|*
name|start
operator|==
literal|' '
operator|||
operator|*
name|start
operator|==
literal|'\t'
condition|)
name|start
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|start
operator|==
literal|'\0'
condition|)
break|break;
name|end
operator|=
name|start
expr_stmt|;
while|while
condition|(
operator|*
name|end
operator|!=
literal|' '
operator|&&
operator|*
name|end
operator|!=
literal|'\t'
operator|&&
operator|*
name|end
operator|!=
literal|'\0'
condition|)
name|end
operator|++
expr_stmt|;
name|last
operator|=
operator|*
name|end
operator|==
literal|'\0'
expr_stmt|;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|start
argument_list|,
literal|"WPA-PSK"
argument_list|)
operator|==
literal|0
condition|)
name|val
operator||=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|start
argument_list|,
literal|"WPA-EAP"
argument_list|)
operator|==
literal|0
condition|)
name|val
operator||=
name|WPA_KEY_MGMT_IEEE8021X
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"Line %d: invalid key_mgmt '%s'\n"
argument_list|,
name|line
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|last
condition|)
break|break;
name|start
operator|=
name|end
operator|+
literal|1
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: no key_mgmt values configured.\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_config_parse_cipher
parameter_list|(
name|int
name|line
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|val
init|=
literal|0
decl_stmt|,
name|last
decl_stmt|;
name|char
modifier|*
name|start
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|start
operator|=
name|buf
expr_stmt|;
while|while
condition|(
name|start
operator|!=
literal|'\0'
condition|)
block|{
while|while
condition|(
operator|*
name|start
operator|==
literal|' '
operator|||
operator|*
name|start
operator|==
literal|'\t'
condition|)
name|start
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|start
operator|==
literal|'\0'
condition|)
break|break;
name|end
operator|=
name|start
expr_stmt|;
while|while
condition|(
operator|*
name|end
operator|!=
literal|' '
operator|&&
operator|*
name|end
operator|!=
literal|'\t'
operator|&&
operator|*
name|end
operator|!=
literal|'\0'
condition|)
name|end
operator|++
expr_stmt|;
name|last
operator|=
operator|*
name|end
operator|==
literal|'\0'
expr_stmt|;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|start
argument_list|,
literal|"CCMP"
argument_list|)
operator|==
literal|0
condition|)
name|val
operator||=
name|WPA_CIPHER_CCMP
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|start
argument_list|,
literal|"TKIP"
argument_list|)
operator|==
literal|0
condition|)
name|val
operator||=
name|WPA_CIPHER_TKIP
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|start
argument_list|,
literal|"WEP104"
argument_list|)
operator|==
literal|0
condition|)
name|val
operator||=
name|WPA_CIPHER_WEP104
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|start
argument_list|,
literal|"WEP40"
argument_list|)
operator|==
literal|0
condition|)
name|val
operator||=
name|WPA_CIPHER_WEP40
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|start
argument_list|,
literal|"NONE"
argument_list|)
operator|==
literal|0
condition|)
name|val
operator||=
name|WPA_CIPHER_NONE
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"Line %d: invalid cipher '%s'."
argument_list|,
name|line
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|last
condition|)
break|break;
name|start
operator|=
name|end
operator|+
literal|1
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: no cipher values configured."
argument_list|,
name|line
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_config_check_bss
parameter_list|(
name|struct
name|hostapd_bss_config
modifier|*
name|bss
parameter_list|,
name|struct
name|hostapd_config
modifier|*
name|conf
parameter_list|)
block|{
if|if
condition|(
name|bss
operator|->
name|ieee802_1x
operator|&&
operator|!
name|bss
operator|->
name|eap_server
operator|&&
operator|!
name|bss
operator|->
name|radius
operator|->
name|auth_servers
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid IEEE 802.1X configuration (no EAP "
literal|"authenticator configured).\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|bss
operator|->
name|wpa
operator|&&
operator|(
name|bss
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
operator|)
operator|&&
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
operator|==
name|NULL
operator|&&
name|bss
operator|->
name|ssid
operator|.
name|wpa_passphrase
operator|==
name|NULL
operator|&&
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk_file
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"WPA-PSK enabled, but PSK or passphrase is not "
literal|"configured.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hostapd_mac_comp_empty
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conf
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|&
name|conf
operator|->
name|bss
index|[
name|i
index|]
operator|!=
name|bss
operator|)
operator|&&
operator|(
name|hostapd_mac_comp
argument_list|(
name|conf
operator|->
name|bss
index|[
name|i
index|]
operator|.
name|bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Duplicate BSSID "
name|MACSTR
literal|" on interface '%s' and '%s'.\n"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|conf
operator|->
name|bss
index|[
name|i
index|]
operator|.
name|iface
argument_list|,
name|bss
operator|->
name|iface
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_config_check
parameter_list|(
name|struct
name|hostapd_config
modifier|*
name|conf
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conf
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|hostapd_config_check_bss
argument_list|(
operator|&
name|conf
operator|->
name|bss
index|[
name|i
index|]
argument_list|,
name|conf
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_config_read_wep
parameter_list|(
name|struct
name|hostapd_wep_keys
modifier|*
name|wep
parameter_list|,
name|int
name|keyidx
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|size_t
name|len
init|=
name|strlen
argument_list|(
name|val
argument_list|)
decl_stmt|;
if|if
condition|(
name|keyidx
operator|<
literal|0
operator|||
name|keyidx
operator|>
literal|3
operator|||
name|wep
operator|->
name|key
index|[
name|keyidx
index|]
operator|!=
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|val
index|[
literal|0
index|]
operator|==
literal|'"'
condition|)
block|{
if|if
condition|(
name|len
operator|<
literal|2
operator|||
name|val
index|[
name|len
operator|-
literal|1
index|]
operator|!=
literal|'"'
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|-=
literal|2
expr_stmt|;
name|wep
operator|->
name|key
index|[
name|keyidx
index|]
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wep
operator|->
name|key
index|[
name|keyidx
index|]
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|wep
operator|->
name|key
index|[
name|keyidx
index|]
argument_list|,
name|val
operator|+
literal|1
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wep
operator|->
name|len
index|[
name|keyidx
index|]
operator|=
name|len
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|len
operator|&
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|/=
literal|2
expr_stmt|;
name|wep
operator|->
name|key
index|[
name|keyidx
index|]
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wep
operator|->
name|key
index|[
name|keyidx
index|]
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wep
operator|->
name|len
index|[
name|keyidx
index|]
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|val
argument_list|,
name|wep
operator|->
name|key
index|[
name|keyidx
index|]
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|wep
operator|->
name|keys_set
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_parse_rates
parameter_list|(
name|int
modifier|*
modifier|*
name|rate_list
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|int
modifier|*
name|list
decl_stmt|;
name|int
name|count
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|free
argument_list|(
operator|*
name|rate_list
argument_list|)
expr_stmt|;
operator|*
name|rate_list
operator|=
name|NULL
expr_stmt|;
name|pos
operator|=
name|val
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|' '
condition|)
name|count
operator|++
expr_stmt|;
name|pos
operator|++
expr_stmt|;
block|}
name|list
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
operator|(
name|count
operator|+
literal|2
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|val
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
name|end
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|list
index|[
name|count
operator|++
index|]
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|end
condition|)
break|break;
name|pos
operator|=
name|end
operator|+
literal|1
expr_stmt|;
block|}
name|list
index|[
name|count
index|]
operator|=
operator|-
literal|1
expr_stmt|;
operator|*
name|rate_list
operator|=
name|list
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_config_bss
parameter_list|(
name|struct
name|hostapd_config
modifier|*
name|conf
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|hostapd_bss_config
modifier|*
name|bss
decl_stmt|;
if|if
condition|(
operator|*
name|ifname
operator|==
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
name|bss
operator|=
name|realloc
argument_list|(
name|conf
operator|->
name|bss
argument_list|,
operator|(
name|conf
operator|->
name|num_bss
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_bss_config
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate memory for multi-BSS entry\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conf
operator|->
name|bss
operator|=
name|bss
expr_stmt|;
name|bss
operator|=
operator|&
operator|(
name|conf
operator|->
name|bss
index|[
name|conf
operator|->
name|num_bss
index|]
operator|)
expr_stmt|;
name|memset
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
argument_list|)
expr_stmt|;
name|bss
operator|->
name|radius
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
operator|->
name|radius
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|radius
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate memory for multi-BSS RADIUS "
literal|"data\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conf
operator|->
name|num_bss
operator|++
expr_stmt|;
name|conf
operator|->
name|last_bss
operator|=
name|bss
expr_stmt|;
name|hostapd_config_defaults_bss
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|bss
operator|->
name|iface
argument_list|,
sizeof|sizeof
argument_list|(
name|bss
operator|->
name|iface
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|bss
operator|->
name|ssid
operator|.
name|vlan
argument_list|,
name|bss
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|valid_cw
parameter_list|(
name|int
name|cw
parameter_list|)
block|{
return|return
operator|(
name|cw
operator|==
literal|1
operator|||
name|cw
operator|==
literal|3
operator|||
name|cw
operator|==
literal|7
operator|||
name|cw
operator|==
literal|15
operator|||
name|cw
operator|==
literal|31
operator|||
name|cw
operator|==
literal|63
operator|||
name|cw
operator|==
literal|127
operator|||
name|cw
operator|==
literal|255
operator|||
name|cw
operator|==
literal|511
operator|||
name|cw
operator|==
literal|1023
operator|)
return|;
block|}
end_function

begin_enum
enum|enum
block|{
name|IEEE80211_TX_QUEUE_DATA0
init|=
literal|0
block|,
comment|/* used for EDCA AC_VO data */
name|IEEE80211_TX_QUEUE_DATA1
init|=
literal|1
block|,
comment|/* used for EDCA AC_VI data */
name|IEEE80211_TX_QUEUE_DATA2
init|=
literal|2
block|,
comment|/* used for EDCA AC_BE data */
name|IEEE80211_TX_QUEUE_DATA3
init|=
literal|3
block|,
comment|/* used for EDCA AC_BK data */
name|IEEE80211_TX_QUEUE_DATA4
init|=
literal|4
block|,
name|IEEE80211_TX_QUEUE_AFTER_BEACON
init|=
literal|6
block|,
name|IEEE80211_TX_QUEUE_BEACON
init|=
literal|7
block|}
enum|;
end_enum

begin_function
specifier|static
name|int
name|hostapd_config_tx_queue
parameter_list|(
name|struct
name|hostapd_config
modifier|*
name|conf
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|int
name|num
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|struct
name|hostapd_tx_queue_params
modifier|*
name|queue
decl_stmt|;
comment|/* skip 'tx_queue_' prefix */
name|pos
operator|=
name|name
operator|+
literal|9
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"data"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|&&
name|pos
index|[
literal|4
index|]
operator|>=
literal|'0'
operator|&&
name|pos
index|[
literal|4
index|]
operator|<=
literal|'9'
operator|&&
name|pos
index|[
literal|5
index|]
operator|==
literal|'_'
condition|)
block|{
name|num
operator|=
name|pos
index|[
literal|4
index|]
operator|-
literal|'0'
expr_stmt|;
name|pos
operator|+=
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"after_beacon_"
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
block|{
name|num
operator|=
name|IEEE80211_TX_QUEUE_AFTER_BEACON
expr_stmt|;
name|pos
operator|+=
literal|13
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"beacon_"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|num
operator|=
name|IEEE80211_TX_QUEUE_BEACON
expr_stmt|;
name|pos
operator|+=
literal|7
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown tx_queue name '%s'\n"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|queue
operator|=
operator|&
name|conf
operator|->
name|tx_queue
index|[
name|num
index|]
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"aifs"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|queue
operator|->
name|aifs
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|queue
operator|->
name|aifs
operator|<
literal|0
operator|||
name|queue
operator|->
name|aifs
operator|>
literal|255
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid AIFS value %d\n"
argument_list|,
name|queue
operator|->
name|aifs
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"cwmin"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|queue
operator|->
name|cwmin
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|valid_cw
argument_list|(
name|queue
operator|->
name|cwmin
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid cwMin value %d\n"
argument_list|,
name|queue
operator|->
name|cwmin
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"cwmax"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|queue
operator|->
name|cwmax
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|valid_cw
argument_list|(
name|queue
operator|->
name|cwmax
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid cwMax value %d\n"
argument_list|,
name|queue
operator|->
name|cwmax
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"burst"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|queue
operator|->
name|burst
operator|=
name|hostapd_config_read_int10
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown tx_queue field '%s'\n"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|queue
operator|->
name|configured
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_config_wme_ac
parameter_list|(
name|struct
name|hostapd_config
modifier|*
name|conf
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|val
parameter_list|)
block|{
name|int
name|num
decl_stmt|,
name|v
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|struct
name|hostapd_wme_ac_params
modifier|*
name|ac
decl_stmt|;
comment|/* skip 'wme_ac_' prefix */
name|pos
operator|=
name|name
operator|+
literal|7
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"be_"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|num
operator|=
literal|0
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"bk_"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|num
operator|=
literal|1
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"vi_"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|num
operator|=
literal|2
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"vo_"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|num
operator|=
literal|3
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown wme name '%s'\n"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ac
operator|=
operator|&
name|conf
operator|->
name|wme_ac_params
index|[
name|num
index|]
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"aifs"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|<
literal|1
operator|||
name|v
operator|>
literal|255
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid AIFS value %d\n"
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ac
operator|->
name|aifs
operator|=
name|v
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"cwmin"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|<
literal|0
operator|||
name|v
operator|>
literal|12
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid cwMin value %d\n"
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ac
operator|->
name|cwmin
operator|=
name|v
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"cwmax"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|<
literal|0
operator|||
name|v
operator|>
literal|12
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid cwMax value %d\n"
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ac
operator|->
name|cwmax
operator|=
name|v
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"txop_limit"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|<
literal|0
operator|||
name|v
operator|>
literal|0xffff
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid txop value %d\n"
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ac
operator|->
name|txopLimit
operator|=
name|v
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"acm"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|<
literal|0
operator|||
name|v
operator|>
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid acm value %d\n"
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ac
operator|->
name|admission_control_mandatory
operator|=
name|v
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown wme_ac_ field '%s'\n"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|hostapd_config
modifier|*
name|hostapd_config_read
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|struct
name|hostapd_config
modifier|*
name|conf
decl_stmt|;
name|struct
name|hostapd_bss_config
modifier|*
name|bss
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not open configuration file '%s' for reading.\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|conf
operator|=
name|hostapd_config_defaults
argument_list|()
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bss
operator|=
name|conf
operator|->
name|last_bss
operator|=
name|conf
operator|->
name|bss
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|bss
operator|=
name|conf
operator|->
name|last_bss
expr_stmt|;
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
block|{
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
continue|continue;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid line '%s'\n"
argument_list|,
name|line
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"interface"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|conf
operator|->
name|bss
index|[
literal|0
index|]
operator|.
name|iface
argument_list|,
sizeof|sizeof
argument_list|(
name|conf
operator|->
name|bss
index|[
literal|0
index|]
operator|.
name|iface
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"bridge"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|bss
operator|->
name|bridge
argument_list|,
sizeof|sizeof
argument_list|(
name|bss
operator|->
name|bridge
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"driver"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|driver
operator|=
name|driver_lookup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|driver
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid/unknown driver "
literal|"'%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"debug"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|debug
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"logger_syslog_level"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|logger_syslog_level
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"logger_stdout_level"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|logger_stdout_level
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"logger_syslog"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|logger_syslog
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"logger_stdout"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|logger_stdout
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"dump_file"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|dump_log_name
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ssid"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ssid
operator|.
name|ssid_len
operator|=
name|strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ssid
operator|.
name|ssid_len
operator|>
name|HOSTAPD_MAX_SSID_LEN
operator|||
name|bss
operator|->
name|ssid
operator|.
name|ssid_len
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid SSID '%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|bss
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|pos
argument_list|,
name|bss
operator|->
name|ssid
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|ssid
index|[
name|bss
operator|->
name|ssid
operator|.
name|ssid_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|ssid_set
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"macaddr_acl"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|macaddr_acl
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|macaddr_acl
operator|!=
name|ACCEPT_UNLESS_DENIED
operator|&&
name|bss
operator|->
name|macaddr_acl
operator|!=
name|DENY_UNLESS_ACCEPTED
operator|&&
name|bss
operator|->
name|macaddr_acl
operator|!=
name|USE_EXTERNAL_RADIUS_AUTH
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: unknown macaddr_acl %d\n"
argument_list|,
name|line
argument_list|,
name|bss
operator|->
name|macaddr_acl
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"accept_mac_file"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_read_maclist
argument_list|(
name|pos
argument_list|,
operator|&
name|bss
operator|->
name|accept_mac
argument_list|,
operator|&
name|bss
operator|->
name|num_accept_mac
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: Failed to read "
literal|"accept_mac_file '%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"deny_mac_file"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_read_maclist
argument_list|(
name|pos
argument_list|,
operator|&
name|bss
operator|->
name|deny_mac
argument_list|,
operator|&
name|bss
operator|->
name|num_deny_mac
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: Failed to read "
literal|"deny_mac_file '%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ap_max_inactivity"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ap_max_inactivity
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"country_code"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|conf
operator|->
name|country
argument_list|,
name|pos
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* FIX: make this configurable */
name|conf
operator|->
name|country
index|[
literal|2
index|]
operator|=
literal|' '
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ieee80211d"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|ieee80211d
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ieee80211h"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|ieee80211h
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"assoc_ap_addr"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|pos
argument_list|,
name|bss
operator|->
name|assoc_ap_addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid MAC address '%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
name|bss
operator|->
name|assoc_ap
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ieee8021x"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ieee802_1x
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"eapol_version"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|eapol_version
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|eapol_version
operator|<
literal|1
operator|||
name|bss
operator|->
name|eapol_version
operator|>
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid EAPOL "
literal|"version (%d): '%s'.\n"
argument_list|,
name|line
argument_list|,
name|bss
operator|->
name|eapol_version
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"eapol_version=%d"
argument_list|,
name|bss
operator|->
name|eapol_version
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|EAP_SERVER
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"eap_authenticator"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|eap_server
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Line %d: obsolete eap_authenticator used; "
literal|"this has been renamed to eap_server\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"eap_server"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|eap_server
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"eap_user_file"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_read_eap_user
argument_list|(
name|pos
argument_list|,
name|bss
argument_list|)
condition|)
name|errors
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ca_cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|ca_cert
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ca_cert
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"server_cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|server_cert
argument_list|)
expr_stmt|;
name|bss
operator|->
name|server_cert
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"private_key"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|private_key
argument_list|)
expr_stmt|;
name|bss
operator|->
name|private_key
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"private_key_passwd"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|private_key_passwd
argument_list|)
expr_stmt|;
name|bss
operator|->
name|private_key_passwd
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"check_crl"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|check_crl
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|EAP_SIM
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"eap_sim_db"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|eap_sim_db
argument_list|)
expr_stmt|;
name|bss
operator|->
name|eap_sim_db
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* EAP_SIM */
endif|#
directive|endif
comment|/* EAP_SERVER */
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"eap_message"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|term
decl_stmt|;
name|bss
operator|->
name|eap_req_id_text
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|eap_req_id_text
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: Failed to allocate memory "
literal|"for eap_req_id_text\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
name|bss
operator|->
name|eap_req_id_text_len
operator|=
name|strlen
argument_list|(
name|bss
operator|->
name|eap_req_id_text
argument_list|)
expr_stmt|;
name|term
operator|=
name|strstr
argument_list|(
name|bss
operator|->
name|eap_req_id_text
argument_list|,
literal|"\\0"
argument_list|)
expr_stmt|;
if|if
condition|(
name|term
condition|)
block|{
operator|*
name|term
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|memmove
argument_list|(
name|term
argument_list|,
name|term
operator|+
literal|1
argument_list|,
name|bss
operator|->
name|eap_req_id_text_len
operator|-
operator|(
name|term
operator|-
name|bss
operator|->
name|eap_req_id_text
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bss
operator|->
name|eap_req_id_text_len
operator|--
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wep_key_len_broadcast"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|default_wep_key_len
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|default_wep_key_len
operator|>
literal|13
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid WEP key len %lu "
literal|"(= %lu bits)\n"
argument_list|,
name|line
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|bss
operator|->
name|default_wep_key_len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|bss
operator|->
name|default_wep_key_len
operator|*
literal|8
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wep_key_len_unicast"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|individual_wep_key_len
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|individual_wep_key_len
operator|<
literal|0
operator|||
name|bss
operator|->
name|individual_wep_key_len
operator|>
literal|13
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid WEP key len %d "
literal|"(= %d bits)\n"
argument_list|,
name|line
argument_list|,
name|bss
operator|->
name|individual_wep_key_len
argument_list|,
name|bss
operator|->
name|individual_wep_key_len
operator|*
literal|8
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wep_rekey_period"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|wep_rekeying_period
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wep_rekeying_period
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid period %d\n"
argument_list|,
name|line
argument_list|,
name|bss
operator|->
name|wep_rekeying_period
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"eap_reauth_period"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|eap_reauth_period
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|eap_reauth_period
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid period %d\n"
argument_list|,
name|line
argument_list|,
name|bss
operator|->
name|eap_reauth_period
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"eapol_key_index_workaround"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|eapol_key_index_workaround
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IAPP
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"iapp_interface"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ieee802_11f
operator|=
literal|1
expr_stmt|;
name|snprintf
argument_list|(
name|bss
operator|->
name|iapp_iface
argument_list|,
sizeof|sizeof
argument_list|(
name|bss
operator|->
name|iapp_iface
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IAPP */
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"own_ip_addr"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_parse_ip_addr
argument_list|(
name|pos
argument_list|,
operator|&
name|bss
operator|->
name|own_ip_addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid IP address '%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"nas_identifier"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|nas_identifier
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"auth_server_addr"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_read_radius_addr
argument_list|(
operator|&
name|bss
operator|->
name|radius
operator|->
name|auth_servers
argument_list|,
operator|&
name|bss
operator|->
name|radius
operator|->
name|num_auth_servers
argument_list|,
name|pos
argument_list|,
literal|1812
argument_list|,
operator|&
name|bss
operator|->
name|radius
operator|->
name|auth_server
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid IP address '%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|bss
operator|->
name|radius
operator|->
name|auth_server
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"auth_server_port"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|radius
operator|->
name|auth_server
operator|->
name|port
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
operator|->
name|radius
operator|->
name|auth_server
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"auth_server_shared_secret"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|len
init|=
name|strlen
argument_list|(
name|pos
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
comment|/* RFC 2865, Ch. 3 */
name|printf
argument_list|(
literal|"Line %d: empty shared secret is not "
literal|"allowed.\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
name|bss
operator|->
name|radius
operator|->
name|auth_server
operator|->
name|shared_secret
operator|=
operator|(
name|u8
operator|*
operator|)
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|bss
operator|->
name|radius
operator|->
name|auth_server
operator|->
name|shared_secret_len
operator|=
name|len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"acct_server_addr"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_read_radius_addr
argument_list|(
operator|&
name|bss
operator|->
name|radius
operator|->
name|acct_servers
argument_list|,
operator|&
name|bss
operator|->
name|radius
operator|->
name|num_acct_servers
argument_list|,
name|pos
argument_list|,
literal|1813
argument_list|,
operator|&
name|bss
operator|->
name|radius
operator|->
name|acct_server
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid IP address '%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|bss
operator|->
name|radius
operator|->
name|acct_server
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"acct_server_port"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|radius
operator|->
name|acct_server
operator|->
name|port
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
operator|->
name|radius
operator|->
name|acct_server
operator|&&
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"acct_server_shared_secret"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|len
init|=
name|strlen
argument_list|(
name|pos
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
comment|/* RFC 2865, Ch. 3 */
name|printf
argument_list|(
literal|"Line %d: empty shared secret is not "
literal|"allowed.\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
name|bss
operator|->
name|radius
operator|->
name|acct_server
operator|->
name|shared_secret
operator|=
operator|(
name|u8
operator|*
operator|)
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|bss
operator|->
name|radius
operator|->
name|acct_server
operator|->
name|shared_secret_len
operator|=
name|len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"radius_retry_primary_interval"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|radius
operator|->
name|retry_primary_interval
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"radius_acct_interim_interval"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|radius
operator|->
name|acct_interim_interval
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"auth_algs"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|auth_algs
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|auth_algs
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: no authentication algorithms "
literal|"allowed\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"max_num_sta"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|max_num_sta
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|max_num_sta
operator|<
literal|0
operator|||
name|bss
operator|->
name|max_num_sta
operator|>
name|MAX_STA_COUNT
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: Invalid max_num_sta=%d; "
literal|"allowed range 0..%d\n"
argument_list|,
name|line
argument_list|,
name|bss
operator|->
name|max_num_sta
argument_list|,
name|MAX_STA_COUNT
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wpa"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|wpa
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wpa_group_rekey"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|wpa_group_rekey
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wpa_strict_rekey"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|wpa_strict_rekey
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wpa_gmk_rekey"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|wpa_gmk_rekey
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wpa_passphrase"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|len
init|=
name|strlen
argument_list|(
name|pos
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|8
operator|||
name|len
operator|>
literal|63
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid WPA passphrase length"
literal|" %d (expected 8..63)\n"
argument_list|,
name|line
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|bss
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|wpa_passphrase
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wpa_psk"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_wpa_psk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
operator|==
name|NULL
condition|)
name|errors
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
operator|||
name|pos
index|[
name|PMK_LEN
operator|*
literal|2
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: Invalid PSK '%s'.\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
else|else
block|{
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|group
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wpa_psk_file"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk_file
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk_file
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk_file
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: allocation failed\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wpa_key_mgmt"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|wpa_key_mgmt
operator|=
name|hostapd_config_parse_key_mgmt
argument_list|(
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wpa_key_mgmt
operator|==
operator|-
literal|1
condition|)
name|errors
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wpa_pairwise"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|wpa_pairwise
operator|=
name|hostapd_config_parse_cipher
argument_list|(
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wpa_pairwise
operator|==
operator|-
literal|1
operator|||
name|bss
operator|->
name|wpa_pairwise
operator|==
literal|0
condition|)
name|errors
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|bss
operator|->
name|wpa_pairwise
operator|&
operator|(
name|WPA_CIPHER_NONE
operator||
name|WPA_CIPHER_WEP40
operator||
name|WPA_CIPHER_WEP104
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: unsupported pairwise "
literal|"cipher suite '%s'\n"
argument_list|,
name|bss
operator|->
name|wpa_pairwise
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bss
operator|->
name|wpa_pairwise
operator|&
name|WPA_CIPHER_TKIP
condition|)
name|bss
operator|->
name|wpa_group
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
else|else
name|bss
operator|->
name|wpa_group
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_RSN_PREAUTH
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"rsn_preauth"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|rsn_preauth
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"rsn_preauth_interfaces"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|rsn_preauth_interfaces
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_RSN_PREAUTH */
ifdef|#
directive|ifdef
name|CONFIG_PEERKEY
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"peerkey"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|peerkey
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_PEERKEY */
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ctrl_interface"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ctrl_interface
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ctrl_interface_group"
argument_list|)
operator|==
literal|0
condition|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
name|struct
name|group
modifier|*
name|grp
decl_stmt|;
name|char
modifier|*
name|endp
decl_stmt|;
specifier|const
name|char
modifier|*
name|group
init|=
name|pos
decl_stmt|;
name|grp
operator|=
name|getgrnam
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
condition|)
block|{
name|bss
operator|->
name|ctrl_interface_gid
operator|=
name|grp
operator|->
name|gr_gid
expr_stmt|;
name|bss
operator|->
name|ctrl_interface_gid_set
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_interface_group=%d"
literal|" (from group name '%s')"
argument_list|,
name|bss
operator|->
name|ctrl_interface_gid
argument_list|,
name|group
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Group name not found - try to parse this as gid */
name|bss
operator|->
name|ctrl_interface_gid
operator|=
name|strtol
argument_list|(
name|group
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|group
operator|==
literal|'\0'
operator|||
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Line %d: Invalid group "
literal|"'%s'"
argument_list|,
name|line
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
name|bss
operator|->
name|ctrl_interface_gid_set
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_interface_group=%d"
argument_list|,
name|bss
operator|->
name|ctrl_interface_gid
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
ifdef|#
directive|ifdef
name|RADIUS_SERVER
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"radius_server_clients"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|radius_server_clients
argument_list|)
expr_stmt|;
name|bss
operator|->
name|radius_server_clients
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"radius_server_auth_port"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|radius_server_auth_port
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"radius_server_ipv6"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|radius_server_ipv6
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* RADIUS_SERVER */
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"test_socket"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|bss
operator|->
name|test_socket
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"use_pae_group_addr"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|use_pae_group_addr
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"hw_mode"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"a"
argument_list|)
operator|==
literal|0
condition|)
name|conf
operator|->
name|hw_mode
operator|=
name|HOSTAPD_MODE_IEEE80211A
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"b"
argument_list|)
operator|==
literal|0
condition|)
name|conf
operator|->
name|hw_mode
operator|=
name|HOSTAPD_MODE_IEEE80211B
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"g"
argument_list|)
operator|==
literal|0
condition|)
name|conf
operator|->
name|hw_mode
operator|=
name|HOSTAPD_MODE_IEEE80211G
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"Line %d: unknown hw_mode '%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"channel"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|channel
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"beacon_int"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|val
init|=
name|atoi
argument_list|(
name|pos
argument_list|)
decl_stmt|;
comment|/* MIB defines range as 1..65535, but very small values 			 * cause problems with the current implementation. 			 * Since it is unlikely that this small numbers are 			 * useful in real life scenarios, do not allow beacon 			 * period to be set below 15 TU. */
if|if
condition|(
name|val
operator|<
literal|15
operator|||
name|val
operator|>
literal|65535
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid beacon_int %d "
literal|"(expected 15..65535)\n"
argument_list|,
name|line
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
else|else
name|conf
operator|->
name|beacon_int
operator|=
name|val
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"dtim_period"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|dtim_period
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|dtim_period
operator|<
literal|1
operator|||
name|bss
operator|->
name|dtim_period
operator|>
literal|255
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid dtim_period %d\n"
argument_list|,
name|line
argument_list|,
name|bss
operator|->
name|dtim_period
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"rts_threshold"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|rts_threshold
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|rts_threshold
operator|<
literal|0
operator|||
name|conf
operator|->
name|rts_threshold
operator|>
literal|2347
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid rts_threshold %d\n"
argument_list|,
name|line
argument_list|,
name|conf
operator|->
name|rts_threshold
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"fragm_threshold"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|fragm_threshold
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|fragm_threshold
operator|<
literal|256
operator|||
name|conf
operator|->
name|fragm_threshold
operator|>
literal|2346
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid fragm_threshold %d\n"
argument_list|,
name|line
argument_list|,
name|conf
operator|->
name|fragm_threshold
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"send_probe_response"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|val
init|=
name|atoi
argument_list|(
name|pos
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|!=
literal|0
operator|&&
name|val
operator|!=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid send_probe_response "
literal|"%d (expected 0 or 1)\n"
argument_list|,
name|line
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
name|conf
operator|->
name|send_probe_response
operator|=
name|val
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"supported_rates"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_parse_rates
argument_list|(
operator|&
name|conf
operator|->
name|supported_rates
argument_list|,
name|pos
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid rate list\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"basic_rates"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_parse_rates
argument_list|(
operator|&
name|conf
operator|->
name|basic_rates
argument_list|,
name|pos
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid rate list\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ignore_broadcast_ssid"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ignore_broadcast_ssid
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"bridge_packets"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|bridge_packets
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wep_default_key"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ssid
operator|.
name|wep
operator|.
name|idx
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ssid
operator|.
name|wep
operator|.
name|idx
operator|>
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid wep_default_key index %d\n"
argument_list|,
name|bss
operator|->
name|ssid
operator|.
name|wep
operator|.
name|idx
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wep_key0"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wep_key1"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wep_key2"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wep_key3"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_read_wep
argument_list|(
operator|&
name|bss
operator|->
name|ssid
operator|.
name|wep
argument_list|,
name|buf
index|[
literal|7
index|]
operator|-
literal|'0'
argument_list|,
name|pos
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid WEP key '%s'\n"
argument_list|,
name|line
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"dynamic_vlan"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ssid
operator|.
name|dynamic_vlan
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"vlan_file"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_read_vlan_file
argument_list|(
name|bss
argument_list|,
name|pos
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: failed to read VLAN file "
literal|"'%s'\n"
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_FULL_DYNAMIC_VLAN
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"vlan_tagged_interface"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ssid
operator|.
name|vlan_tagged_interface
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_FULL_DYNAMIC_VLAN */
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"passive_scan_interval"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|passive_scan_interval
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"passive_scan_listen"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|passive_scan_listen
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"passive_scan_mode"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|passive_scan_mode
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ap_table_max_size"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|ap_table_max_size
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ap_table_expiration_time"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|ap_table_expiration_time
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"tx_queue_"
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_tx_queue
argument_list|(
name|conf
argument_list|,
name|buf
argument_list|,
name|pos
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid TX queue item\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"wme_enabled"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|wme_enabled
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"wme_ac_"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_wme_ac
argument_list|(
name|conf
argument_list|,
name|buf
argument_list|,
name|pos
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid wme ac item\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"bss"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_config_bss
argument_list|(
name|conf
argument_list|,
name|pos
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid bss item\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"bssid"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bss
operator|==
name|conf
operator|->
name|bss
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: bssid item not allowed "
literal|"for the default interface\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|pos
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Line %d: invalid bssid item\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"ieee80211w"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ieee80211w
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Line %d: unknown configuration item '%s'\n"
argument_list|,
name|line
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|individual_wep_key_len
operator|==
literal|0
condition|)
block|{
comment|/* individual keys are not use; can use key idx0 for broadcast 		 * keys */
name|bss
operator|->
name|broadcast_key_idx_min
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conf
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
name|bss
operator|=
operator|&
name|conf
operator|->
name|bss
index|[
name|i
index|]
expr_stmt|;
name|bss
operator|->
name|radius
operator|->
name|auth_server
operator|=
name|bss
operator|->
name|radius
operator|->
name|auth_servers
expr_stmt|;
name|bss
operator|->
name|radius
operator|->
name|acct_server
operator|=
name|bss
operator|->
name|radius
operator|->
name|acct_servers
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wpa
operator|&&
name|bss
operator|->
name|ieee802_1x
condition|)
block|{
name|bss
operator|->
name|ssid
operator|.
name|security_policy
operator|=
name|SECURITY_WPA
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
operator|->
name|wpa
condition|)
block|{
name|bss
operator|->
name|ssid
operator|.
name|security_policy
operator|=
name|SECURITY_WPA_PSK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
operator|->
name|ieee802_1x
condition|)
block|{
name|bss
operator|->
name|ssid
operator|.
name|security_policy
operator|=
name|SECURITY_IEEE_802_1X
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|wep
operator|.
name|default_len
operator|=
name|bss
operator|->
name|default_wep_key_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
operator|->
name|ssid
operator|.
name|wep
operator|.
name|keys_set
condition|)
name|bss
operator|->
name|ssid
operator|.
name|security_policy
operator|=
name|SECURITY_STATIC_WEP
expr_stmt|;
else|else
name|bss
operator|->
name|ssid
operator|.
name|security_policy
operator|=
name|SECURITY_PLAINTEXT
expr_stmt|;
block|}
if|if
condition|(
name|hostapd_config_check
argument_list|(
name|conf
argument_list|)
condition|)
name|errors
operator|++
expr_stmt|;
if|if
condition|(
name|errors
condition|)
block|{
name|printf
argument_list|(
literal|"%d errors found in configuration file '%s'\n"
argument_list|,
name|errors
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|hostapd_config_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|conf
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|conf
return|;
block|}
end_function

begin_function
name|int
name|hostapd_wep_key_cmp
parameter_list|(
name|struct
name|hostapd_wep_keys
modifier|*
name|a
parameter_list|,
name|struct
name|hostapd_wep_keys
modifier|*
name|b
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|a
operator|->
name|idx
operator|!=
name|b
operator|->
name|idx
operator|||
name|a
operator|->
name|default_len
operator|!=
name|b
operator|->
name|default_len
condition|)
return|return
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|a
operator|->
name|len
index|[
name|i
index|]
operator|!=
name|b
operator|->
name|len
index|[
name|i
index|]
operator|||
name|memcmp
argument_list|(
name|a
operator|->
name|key
index|[
name|i
index|]
argument_list|,
name|b
operator|->
name|key
index|[
name|i
index|]
argument_list|,
name|a
operator|->
name|len
index|[
name|i
index|]
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_config_free_radius
parameter_list|(
name|struct
name|hostapd_radius_server
modifier|*
name|servers
parameter_list|,
name|int
name|num_servers
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_servers
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|servers
index|[
name|i
index|]
operator|.
name|shared_secret
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|servers
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_config_free_eap_user
parameter_list|(
name|struct
name|hostapd_eap_user
modifier|*
name|user
parameter_list|)
block|{
name|free
argument_list|(
name|user
operator|->
name|identity
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|user
operator|->
name|password
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_config_free_wep
parameter_list|(
name|struct
name|hostapd_wep_keys
modifier|*
name|keys
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|keys
operator|->
name|key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|keys
operator|->
name|key
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_config_free_bss
parameter_list|(
name|struct
name|hostapd_bss_config
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|hostapd_wpa_psk
modifier|*
name|psk
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|struct
name|hostapd_eap_user
modifier|*
name|user
decl_stmt|,
modifier|*
name|prev_user
decl_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
return|return;
name|psk
operator|=
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
expr_stmt|;
while|while
condition|(
name|psk
condition|)
block|{
name|prev
operator|=
name|psk
expr_stmt|;
name|psk
operator|=
name|psk
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk_file
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_FULL_DYNAMIC_VLAN
name|free
argument_list|(
name|conf
operator|->
name|ssid
operator|.
name|vlan_tagged_interface
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_FULL_DYNAMIC_VLAN */
name|user
operator|=
name|conf
operator|->
name|eap_user
expr_stmt|;
while|while
condition|(
name|user
condition|)
block|{
name|prev_user
operator|=
name|user
expr_stmt|;
name|user
operator|=
name|user
operator|->
name|next
expr_stmt|;
name|hostapd_config_free_eap_user
argument_list|(
name|prev_user
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|conf
operator|->
name|dump_log_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|eap_req_id_text
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|accept_mac
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|deny_mac
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|nas_identifier
argument_list|)
expr_stmt|;
name|hostapd_config_free_radius
argument_list|(
name|conf
operator|->
name|radius
operator|->
name|auth_servers
argument_list|,
name|conf
operator|->
name|radius
operator|->
name|num_auth_servers
argument_list|)
expr_stmt|;
name|hostapd_config_free_radius
argument_list|(
name|conf
operator|->
name|radius
operator|->
name|acct_servers
argument_list|,
name|conf
operator|->
name|radius
operator|->
name|num_acct_servers
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|rsn_preauth_interfaces
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|ca_cert
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|server_cert
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|private_key
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|private_key_passwd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|eap_sim_db
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|radius_server_clients
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|radius
argument_list|)
expr_stmt|;
name|hostapd_config_free_vlan
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|dyn_vlan_keys
condition|)
block|{
name|struct
name|hostapd_ssid
modifier|*
name|ssid
init|=
operator|&
name|conf
operator|->
name|ssid
decl_stmt|;
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|ssid
operator|->
name|max_dyn_vlan_keys
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|dyn_vlan_keys
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|hostapd_config_free_wep
argument_list|(
name|ssid
operator|->
name|dyn_vlan_keys
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ssid
operator|->
name|dyn_vlan_keys
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|ssid
operator|->
name|dyn_vlan_keys
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|dyn_vlan_keys
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|hostapd_config_free
parameter_list|(
name|struct
name|hostapd_config
modifier|*
name|conf
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conf
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
name|hostapd_config_free_bss
argument_list|(
operator|&
name|conf
operator|->
name|bss
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
operator|->
name|bss
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Perform a binary search for given MAC address from a pre-sorted list.  * Returns 1 if address is in the list or 0 if not. */
end_comment

begin_function
name|int
name|hostapd_maclist_found
parameter_list|(
name|macaddr
modifier|*
name|list
parameter_list|,
name|int
name|num_entries
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|int
name|start
decl_stmt|,
name|end
decl_stmt|,
name|middle
decl_stmt|,
name|res
decl_stmt|;
name|start
operator|=
literal|0
expr_stmt|;
name|end
operator|=
name|num_entries
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|start
operator|<=
name|end
condition|)
block|{
name|middle
operator|=
operator|(
name|start
operator|+
name|end
operator|)
operator|/
literal|2
expr_stmt|;
name|res
operator|=
name|memcmp
argument_list|(
name|list
index|[
name|middle
index|]
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|start
operator|=
name|middle
operator|+
literal|1
expr_stmt|;
else|else
name|end
operator|=
name|middle
operator|-
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|hostapd_rate_found
parameter_list|(
name|int
modifier|*
name|list
parameter_list|,
name|int
name|rate
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|list
index|[
name|i
index|]
operator|>=
literal|0
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|list
index|[
name|i
index|]
operator|==
name|rate
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|hostapd_get_vlan_id_ifname
parameter_list|(
name|struct
name|hostapd_vlan
modifier|*
name|vlan
parameter_list|,
name|int
name|vlan_id
parameter_list|)
block|{
name|struct
name|hostapd_vlan
modifier|*
name|v
init|=
name|vlan
decl_stmt|;
while|while
condition|(
name|v
condition|)
block|{
if|if
condition|(
name|v
operator|->
name|vlan_id
operator|==
name|vlan_id
operator|||
name|v
operator|->
name|vlan_id
operator|==
name|VLAN_ID_WILDCARD
condition|)
return|return
name|v
operator|->
name|ifname
return|;
name|v
operator|=
name|v
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|hostapd_get_psk
parameter_list|(
specifier|const
name|struct
name|hostapd_bss_config
modifier|*
name|conf
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|prev_psk
parameter_list|)
block|{
name|struct
name|hostapd_wpa_psk
modifier|*
name|psk
decl_stmt|;
name|int
name|next_ok
init|=
name|prev_psk
operator|==
name|NULL
decl_stmt|;
for|for
control|(
name|psk
operator|=
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
init|;
name|psk
operator|!=
name|NULL
condition|;
name|psk
operator|=
name|psk
operator|->
name|next
control|)
block|{
if|if
condition|(
name|next_ok
operator|&&
operator|(
name|psk
operator|->
name|group
operator|||
name|memcmp
argument_list|(
name|psk
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
name|psk
operator|->
name|psk
return|;
if|if
condition|(
name|psk
operator|->
name|psk
operator|==
name|prev_psk
condition|)
name|next_ok
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|struct
name|hostapd_eap_user
modifier|*
name|hostapd_get_eap_user
parameter_list|(
specifier|const
name|struct
name|hostapd_bss_config
modifier|*
name|conf
parameter_list|,
specifier|const
name|u8
modifier|*
name|identity
parameter_list|,
name|size_t
name|identity_len
parameter_list|,
name|int
name|phase2
parameter_list|)
block|{
name|struct
name|hostapd_eap_user
modifier|*
name|user
init|=
name|conf
operator|->
name|eap_user
decl_stmt|;
while|while
condition|(
name|user
condition|)
block|{
if|if
condition|(
operator|!
name|phase2
operator|&&
name|user
operator|->
name|identity
operator|==
name|NULL
condition|)
block|{
comment|/* Wildcard match */
break|break;
block|}
if|if
condition|(
operator|!
name|phase2
operator|&&
name|user
operator|->
name|wildcard_prefix
operator|&&
name|identity_len
operator|>=
name|user
operator|->
name|identity_len
operator|&&
name|memcmp
argument_list|(
name|user
operator|->
name|identity
argument_list|,
name|identity
argument_list|,
name|user
operator|->
name|identity_len
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Wildcard prefix match */
break|break;
block|}
if|if
condition|(
name|user
operator|->
name|phase2
operator|==
operator|!
operator|!
name|phase2
operator|&&
name|user
operator|->
name|identity_len
operator|==
name|identity_len
operator|&&
name|memcmp
argument_list|(
name|user
operator|->
name|identity
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|user
operator|=
name|user
operator|->
name|next
expr_stmt|;
block|}
return|return
name|user
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / IEEE 802.1X Authenticator - EAPOL state machine  * Copyright (c) 2002-2005, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x.h"
end_include

begin_include
include|#
directive|include
file|"eapol_sm.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"preauth.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"eap.h"
end_include

begin_include
include|#
directive|include
file|"state_machine.h"
end_include

begin_define
define|#
directive|define
name|STATE_MACHINE_DATA
value|struct eapol_state_machine
end_define

begin_define
define|#
directive|define
name|STATE_MACHINE_DEBUG_PREFIX
value|"IEEE 802.1X"
end_define

begin_define
define|#
directive|define
name|STATE_MACHINE_ADDR
value|sm->addr
end_define

begin_decl_stmt
specifier|static
name|struct
name|eapol_callbacks
name|eapol_cb
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* EAPOL state machines are described in IEEE Std 802.1X-REV-d11, Chap. 8.2 */
end_comment

begin_define
define|#
directive|define
name|setPortAuthorized
parameter_list|()
define|\
value|ieee802_1x_set_sta_authorized(sm->hapd, sm->sta, 1)
end_define

begin_define
define|#
directive|define
name|setPortUnauthorized
parameter_list|()
define|\
value|ieee802_1x_set_sta_authorized(sm->hapd, sm->sta, 0)
end_define

begin_comment
comment|/* procedures */
end_comment

begin_define
define|#
directive|define
name|txCannedFail
parameter_list|()
value|ieee802_1x_tx_canned_eap(sm->hapd, sm->sta, 0)
end_define

begin_define
define|#
directive|define
name|txCannedSuccess
parameter_list|()
value|ieee802_1x_tx_canned_eap(sm->hapd, sm->sta, 1)
end_define

begin_define
define|#
directive|define
name|txReq
parameter_list|()
value|ieee802_1x_tx_req(sm->hapd, sm->sta)
end_define

begin_define
define|#
directive|define
name|sendRespToServer
parameter_list|()
value|ieee802_1x_send_resp_to_server(sm->hapd, sm->sta)
end_define

begin_define
define|#
directive|define
name|abortAuth
parameter_list|()
value|ieee802_1x_abort_auth(sm->hapd, sm->sta)
end_define

begin_define
define|#
directive|define
name|txKey
parameter_list|()
value|ieee802_1x_tx_key(sm->hapd, sm->sta)
end_define

begin_define
define|#
directive|define
name|processKey
parameter_list|()
value|do { } while (0)
end_define

begin_function_decl
specifier|static
name|void
name|eapol_sm_step_run
parameter_list|(
name|struct
name|eapol_state_machine
modifier|*
name|sm
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|eapol_sm_step_cb
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Port Timers state machine - implemented as a function that will be called  * once a second as a registered event loop timeout */
end_comment

begin_function
specifier|static
name|void
name|eapol_port_timers_tick
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|state
init|=
name|timeout_ctx
decl_stmt|;
if|if
condition|(
name|state
operator|->
name|aWhile
operator|>
literal|0
condition|)
block|{
name|state
operator|->
name|aWhile
operator|--
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|aWhile
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IEEE 802.1X: "
name|MACSTR
literal|" - aWhile --> 0"
argument_list|,
name|MAC2STR
argument_list|(
name|state
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|state
operator|->
name|quietWhile
operator|>
literal|0
condition|)
block|{
name|state
operator|->
name|quietWhile
operator|--
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|quietWhile
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IEEE 802.1X: "
name|MACSTR
literal|" - quietWhile --> 0"
argument_list|,
name|MAC2STR
argument_list|(
name|state
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|state
operator|->
name|reAuthWhen
operator|>
literal|0
condition|)
block|{
name|state
operator|->
name|reAuthWhen
operator|--
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|reAuthWhen
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IEEE 802.1X: "
name|MACSTR
literal|" - reAuthWhen --> 0"
argument_list|,
name|MAC2STR
argument_list|(
name|state
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|eapol_sm_step_run
argument_list|(
name|state
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|eapol_port_timers_tick
argument_list|,
name|eloop_ctx
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Authenticator PAE state machine */
end_comment

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|INITIALIZE
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|INITIALIZE
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|portMode
operator|=
name|Auto
expr_stmt|;
name|sm
operator|->
name|currentId
operator|=
literal|255
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|DISCONNECTED
argument_list|)
end_macro

begin_block
block|{
name|int
name|from_initialize
init|=
name|sm
operator|->
name|auth_pae_state
operator|==
name|AUTH_PAE_INITIALIZE
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|eapolLogoff
condition|)
block|{
if|if
condition|(
name|sm
operator|->
name|auth_pae_state
operator|==
name|AUTH_PAE_CONNECTING
condition|)
name|sm
operator|->
name|authEapLogoffsWhileConnecting
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|auth_pae_state
operator|==
name|AUTH_PAE_AUTHENTICATED
condition|)
name|sm
operator|->
name|authAuthEapLogoffWhileAuthenticated
operator|++
expr_stmt|;
block|}
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|DISCONNECTED
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|authPortStatus
operator|=
name|Unauthorized
expr_stmt|;
name|setPortUnauthorized
argument_list|()
expr_stmt|;
name|sm
operator|->
name|reAuthCount
operator|=
literal|0
expr_stmt|;
name|sm
operator|->
name|eapolLogoff
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|!
name|from_initialize
condition|)
block|{
if|if
condition|(
name|sm
operator|->
name|flags
operator|&
name|EAPOL_SM_PREAUTH
condition|)
name|rsn_preauth_finished
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|sta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|ieee802_1x_finished
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|sta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|RESTART
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|auth_pae_state
operator|==
name|AUTH_PAE_AUTHENTICATED
condition|)
block|{
if|if
condition|(
name|sm
operator|->
name|reAuthenticate
condition|)
name|sm
operator|->
name|authAuthReauthsWhileAuthenticated
operator|++
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eapolStart
condition|)
name|sm
operator|->
name|authAuthEapStartsWhileAuthenticated
operator|++
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eapolLogoff
condition|)
name|sm
operator|->
name|authAuthEapLogoffWhileAuthenticated
operator|++
expr_stmt|;
block|}
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|RESTART
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|eapRestart
operator|=
name|TRUE
expr_stmt|;
name|ieee802_1x_request_identity
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|sta
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|CONNECTING
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|auth_pae_state
operator|!=
name|AUTH_PAE_CONNECTING
condition|)
name|sm
operator|->
name|authEntersConnecting
operator|++
expr_stmt|;
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|CONNECTING
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|reAuthenticate
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|reAuthCount
operator|++
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|HELD
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|auth_pae_state
operator|==
name|AUTH_PAE_AUTHENTICATING
operator|&&
name|sm
operator|->
name|authFail
condition|)
name|sm
operator|->
name|authAuthFailWhileAuthenticating
operator|++
expr_stmt|;
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|HELD
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|authPortStatus
operator|=
name|Unauthorized
expr_stmt|;
name|setPortUnauthorized
argument_list|()
expr_stmt|;
name|sm
operator|->
name|quietWhile
operator|=
name|sm
operator|->
name|quietPeriod
expr_stmt|;
name|sm
operator|->
name|eapolLogoff
operator|=
name|FALSE
expr_stmt|;
name|hostapd_logger
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE8021X
argument_list|,
name|HOSTAPD_LEVEL_WARNING
argument_list|,
literal|"authentication failed - "
literal|"EAP type: %d (%s)"
argument_list|,
name|sm
operator|->
name|eap_type_authsrv
argument_list|,
name|eap_type_text
argument_list|(
name|sm
operator|->
name|eap_type_authsrv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap_type_authsrv
operator|!=
name|sm
operator|->
name|eap_type_supp
condition|)
block|{
name|hostapd_logger
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE8021X
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"Supplicant used different EAP type: %d (%s)"
argument_list|,
name|sm
operator|->
name|eap_type_supp
argument_list|,
name|eap_type_text
argument_list|(
name|sm
operator|->
name|eap_type_supp
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sm
operator|->
name|flags
operator|&
name|EAPOL_SM_PREAUTH
condition|)
name|rsn_preauth_finished
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|sta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|ieee802_1x_finished
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|sta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|AUTHENTICATED
argument_list|)
end_macro

begin_block
block|{
name|char
modifier|*
name|extra
init|=
literal|""
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|auth_pae_state
operator|==
name|AUTH_PAE_AUTHENTICATING
operator|&&
name|sm
operator|->
name|authSuccess
condition|)
name|sm
operator|->
name|authAuthSuccessesWhileAuthenticating
operator|++
expr_stmt|;
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|AUTHENTICATED
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|authPortStatus
operator|=
name|Authorized
expr_stmt|;
name|setPortAuthorized
argument_list|()
expr_stmt|;
name|sm
operator|->
name|reAuthCount
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|flags
operator|&
name|EAPOL_SM_PREAUTH
condition|)
name|extra
operator|=
literal|" (pre-authentication)"
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_auth_sta_get_pmksa
argument_list|(
name|sm
operator|->
name|sta
operator|->
name|wpa_sm
argument_list|)
condition|)
name|extra
operator|=
literal|" (PMKSA cache)"
expr_stmt|;
name|hostapd_logger
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE8021X
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"authenticated - EAP type: %d (%s)"
literal|"%s"
argument_list|,
name|sm
operator|->
name|eap_type_authsrv
argument_list|,
name|eap_type_text
argument_list|(
name|sm
operator|->
name|eap_type_authsrv
argument_list|)
argument_list|,
name|extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|flags
operator|&
name|EAPOL_SM_PREAUTH
condition|)
name|rsn_preauth_finished
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|sta
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|ieee802_1x_finished
argument_list|(
name|sm
operator|->
name|hapd
argument_list|,
name|sm
operator|->
name|sta
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|AUTHENTICATING
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|auth_pae_state
operator|==
name|AUTH_PAE_CONNECTING
operator|&&
name|sm
operator|->
name|rx_identity
condition|)
block|{
name|sm
operator|->
name|authEntersAuthenticating
operator|++
expr_stmt|;
name|sm
operator|->
name|rx_identity
operator|=
name|FALSE
expr_stmt|;
block|}
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|AUTHENTICATING
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|eapolStart
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|authSuccess
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|authFail
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|authTimeout
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|authStart
operator|=
name|TRUE
expr_stmt|;
name|sm
operator|->
name|keyRun
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|keyDone
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|ABORTING
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|auth_pae_state
operator|==
name|AUTH_PAE_AUTHENTICATING
condition|)
block|{
if|if
condition|(
name|sm
operator|->
name|authTimeout
condition|)
name|sm
operator|->
name|authAuthTimeoutsWhileAuthenticating
operator|++
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eapolStart
condition|)
name|sm
operator|->
name|authAuthEapStartsWhileAuthenticating
operator|++
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eapolLogoff
condition|)
name|sm
operator|->
name|authAuthEapLogoffWhileAuthenticating
operator|++
expr_stmt|;
block|}
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|ABORTING
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|authAbort
operator|=
name|TRUE
expr_stmt|;
name|sm
operator|->
name|keyRun
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|keyDone
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|FORCE_AUTH
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|FORCE_AUTH
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|authPortStatus
operator|=
name|Authorized
expr_stmt|;
name|setPortAuthorized
argument_list|()
expr_stmt|;
name|sm
operator|->
name|portMode
operator|=
name|ForceAuthorized
expr_stmt|;
name|sm
operator|->
name|eapolStart
operator|=
name|FALSE
expr_stmt|;
name|txCannedSuccess
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_PAE
argument_list|,
argument|FORCE_UNAUTH
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|AUTH_PAE
argument_list|,
name|FORCE_UNAUTH
argument_list|,
name|auth_pae
argument_list|)
expr_stmt|;
name|sm
operator|->
name|authPortStatus
operator|=
name|Unauthorized
expr_stmt|;
name|setPortUnauthorized
argument_list|()
expr_stmt|;
name|sm
operator|->
name|portMode
operator|=
name|ForceUnauthorized
expr_stmt|;
name|sm
operator|->
name|eapolStart
operator|=
name|FALSE
expr_stmt|;
name|txCannedFail
argument_list|()
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STEP
argument_list|(
argument|AUTH_PAE
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
operator|(
name|sm
operator|->
name|portControl
operator|==
name|Auto
operator|&&
name|sm
operator|->
name|portMode
operator|!=
name|sm
operator|->
name|portControl
operator|)
operator|||
name|sm
operator|->
name|initialize
operator|||
operator|!
name|sm
operator|->
name|portEnabled
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|INITIALIZE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|portControl
operator|==
name|ForceAuthorized
operator|&&
name|sm
operator|->
name|portMode
operator|!=
name|sm
operator|->
name|portControl
operator|&&
operator|!
operator|(
name|sm
operator|->
name|initialize
operator|||
operator|!
name|sm
operator|->
name|portEnabled
operator|)
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|FORCE_AUTH
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|portControl
operator|==
name|ForceUnauthorized
operator|&&
name|sm
operator|->
name|portMode
operator|!=
name|sm
operator|->
name|portControl
operator|&&
operator|!
operator|(
name|sm
operator|->
name|initialize
operator|||
operator|!
name|sm
operator|->
name|portEnabled
operator|)
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|FORCE_UNAUTH
argument_list|)
expr_stmt|;
else|else
block|{
switch|switch
condition|(
name|sm
operator|->
name|auth_pae_state
condition|)
block|{
case|case
name|AUTH_PAE_INITIALIZE
case|:
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|DISCONNECTED
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_PAE_DISCONNECTED
case|:
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|RESTART
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_PAE_RESTART
case|:
if|if
condition|(
operator|!
name|sm
operator|->
name|eapRestart
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|CONNECTING
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_PAE_HELD
case|:
if|if
condition|(
name|sm
operator|->
name|quietWhile
operator|==
literal|0
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|RESTART
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_PAE_CONNECTING
case|:
if|if
condition|(
name|sm
operator|->
name|eapolLogoff
operator|||
name|sm
operator|->
name|reAuthCount
operator|>
name|sm
operator|->
name|reAuthMax
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|DISCONNECTED
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|sm
operator|->
name|eapReq
operator|&&
name|sm
operator|->
name|reAuthCount
operator|<=
name|sm
operator|->
name|reAuthMax
operator|)
operator|||
name|sm
operator|->
name|eapSuccess
operator|||
name|sm
operator|->
name|eapFail
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|AUTHENTICATING
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_PAE_AUTHENTICATED
case|:
if|if
condition|(
name|sm
operator|->
name|eapolStart
operator|||
name|sm
operator|->
name|reAuthenticate
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|RESTART
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapolLogoff
operator|||
operator|!
name|sm
operator|->
name|portValid
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|DISCONNECTED
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_PAE_AUTHENTICATING
case|:
if|if
condition|(
name|sm
operator|->
name|authSuccess
operator|&&
name|sm
operator|->
name|portValid
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|AUTHENTICATED
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|authFail
operator|||
operator|(
name|sm
operator|->
name|keyDone
operator|&&
operator|!
name|sm
operator|->
name|portValid
operator|)
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|HELD
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapolStart
operator|||
name|sm
operator|->
name|eapolLogoff
operator|||
name|sm
operator|->
name|authTimeout
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|ABORTING
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_PAE_ABORTING
case|:
if|if
condition|(
name|sm
operator|->
name|eapolLogoff
operator|&&
operator|!
name|sm
operator|->
name|authAbort
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|DISCONNECTED
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|sm
operator|->
name|eapolLogoff
operator|&&
operator|!
name|sm
operator|->
name|authAbort
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|RESTART
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_PAE_FORCE_AUTH
case|:
if|if
condition|(
name|sm
operator|->
name|eapolStart
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|FORCE_AUTH
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_PAE_FORCE_UNAUTH
case|:
if|if
condition|(
name|sm
operator|->
name|eapolStart
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_PAE
argument_list|,
name|FORCE_UNAUTH
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_block

begin_comment
comment|/* Backend Authentication state machine */
end_comment

begin_macro
name|SM_STATE
argument_list|(
argument|BE_AUTH
argument_list|,
argument|INITIALIZE
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|BE_AUTH
argument_list|,
name|INITIALIZE
argument_list|,
name|be_auth
argument_list|)
expr_stmt|;
name|abortAuth
argument_list|()
expr_stmt|;
name|sm
operator|->
name|eapNoReq
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|authAbort
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|BE_AUTH
argument_list|,
argument|REQUEST
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|BE_AUTH
argument_list|,
name|REQUEST
argument_list|,
name|be_auth
argument_list|)
expr_stmt|;
name|txReq
argument_list|()
expr_stmt|;
name|sm
operator|->
name|eapReq
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|backendOtherRequestsToSupplicant
operator|++
expr_stmt|;
comment|/* 	 * Clearing eapolEap here is not specified in IEEE Std 802.1X-2004, but 	 * it looks like this would be logical thing to do there since the old 	 * EAP response would not be valid anymore after the new EAP request 	 * was sent out. 	 * 	 * A race condition has been reported, in which hostapd ended up 	 * sending out EAP-Response/Identity as a response to the first 	 * EAP-Request from the main EAP method. This can be avoided by 	 * clearing eapolEap here. 	 */
name|sm
operator|->
name|eapolEap
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|BE_AUTH
argument_list|,
argument|RESPONSE
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|BE_AUTH
argument_list|,
name|RESPONSE
argument_list|,
name|be_auth
argument_list|)
expr_stmt|;
name|sm
operator|->
name|authTimeout
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|eapolEap
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|eapNoReq
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|aWhile
operator|=
name|sm
operator|->
name|serverTimeout
expr_stmt|;
name|sm
operator|->
name|eapResp
operator|=
name|TRUE
expr_stmt|;
name|sendRespToServer
argument_list|()
expr_stmt|;
name|sm
operator|->
name|backendResponses
operator|++
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|BE_AUTH
argument_list|,
argument|SUCCESS
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|BE_AUTH
argument_list|,
name|SUCCESS
argument_list|,
name|be_auth
argument_list|)
expr_stmt|;
name|txReq
argument_list|()
expr_stmt|;
name|sm
operator|->
name|authSuccess
operator|=
name|TRUE
expr_stmt|;
name|sm
operator|->
name|keyRun
operator|=
name|TRUE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|BE_AUTH
argument_list|,
argument|FAIL
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|BE_AUTH
argument_list|,
name|FAIL
argument_list|,
name|be_auth
argument_list|)
expr_stmt|;
comment|/* Note: IEEE 802.1X-REV-d11 has unconditional txReq() here. 	 * txCannelFail() is used as a workaround for the case where 	 * authentication server does not include EAP-Message with 	 * Access-Reject. */
if|if
condition|(
name|sm
operator|->
name|last_eap_radius
operator|==
name|NULL
condition|)
name|txCannedFail
argument_list|()
expr_stmt|;
else|else
name|txReq
argument_list|()
expr_stmt|;
name|sm
operator|->
name|authFail
operator|=
name|TRUE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|BE_AUTH
argument_list|,
argument|TIMEOUT
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|BE_AUTH
argument_list|,
name|TIMEOUT
argument_list|,
name|be_auth
argument_list|)
expr_stmt|;
name|sm
operator|->
name|authTimeout
operator|=
name|TRUE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|BE_AUTH
argument_list|,
argument|IDLE
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|BE_AUTH
argument_list|,
name|IDLE
argument_list|,
name|be_auth
argument_list|)
expr_stmt|;
name|sm
operator|->
name|authStart
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|BE_AUTH
argument_list|,
argument|IGNORE
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|BE_AUTH
argument_list|,
name|IGNORE
argument_list|,
name|be_auth
argument_list|)
expr_stmt|;
name|sm
operator|->
name|eapNoReq
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STEP
argument_list|(
argument|BE_AUTH
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|portControl
operator|!=
name|Auto
operator|||
name|sm
operator|->
name|initialize
operator|||
name|sm
operator|->
name|authAbort
condition|)
block|{
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|INITIALIZE
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|sm
operator|->
name|be_auth_state
condition|)
block|{
case|case
name|BE_AUTH_INITIALIZE
case|:
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|IDLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|BE_AUTH_REQUEST
case|:
if|if
condition|(
name|sm
operator|->
name|eapolEap
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|RESPONSE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapReq
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|REQUEST
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapTimeout
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|TIMEOUT
argument_list|)
expr_stmt|;
break|break;
case|case
name|BE_AUTH_RESPONSE
case|:
if|if
condition|(
name|sm
operator|->
name|eapNoReq
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|IGNORE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eapReq
condition|)
block|{
name|sm
operator|->
name|backendAccessChallenges
operator|++
expr_stmt|;
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|REQUEST
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sm
operator|->
name|aWhile
operator|==
literal|0
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|TIMEOUT
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapFail
condition|)
block|{
name|sm
operator|->
name|backendAuthFails
operator|++
expr_stmt|;
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|FAIL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapSuccess
condition|)
block|{
name|sm
operator|->
name|backendAuthSuccesses
operator|++
expr_stmt|;
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BE_AUTH_SUCCESS
case|:
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|IDLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|BE_AUTH_FAIL
case|:
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|IDLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|BE_AUTH_TIMEOUT
case|:
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|IDLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|BE_AUTH_IDLE
case|:
if|if
condition|(
name|sm
operator|->
name|eapFail
operator|&&
name|sm
operator|->
name|authStart
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|FAIL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapReq
operator|&&
name|sm
operator|->
name|authStart
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|REQUEST
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapSuccess
operator|&&
name|sm
operator|->
name|authStart
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
break|break;
case|case
name|BE_AUTH_IGNORE
case|:
if|if
condition|(
name|sm
operator|->
name|eapolEap
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|RESPONSE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapReq
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|REQUEST
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|eapTimeout
condition|)
name|SM_ENTER
argument_list|(
name|BE_AUTH
argument_list|,
name|TIMEOUT
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_comment
comment|/* Reauthentication Timer state machine */
end_comment

begin_macro
name|SM_STATE
argument_list|(
argument|REAUTH_TIMER
argument_list|,
argument|INITIALIZE
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|REAUTH_TIMER
argument_list|,
name|INITIALIZE
argument_list|,
name|reauth_timer
argument_list|)
expr_stmt|;
name|sm
operator|->
name|reAuthWhen
operator|=
name|sm
operator|->
name|reAuthPeriod
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|REAUTH_TIMER
argument_list|,
argument|REAUTHENTICATE
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|REAUTH_TIMER
argument_list|,
name|REAUTHENTICATE
argument_list|,
name|reauth_timer
argument_list|)
expr_stmt|;
name|sm
operator|->
name|reAuthenticate
operator|=
name|TRUE
expr_stmt|;
name|wpa_auth_sm_event
argument_list|(
name|sm
operator|->
name|sta
operator|->
name|wpa_sm
argument_list|,
name|WPA_REAUTH_EAPOL
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STEP
argument_list|(
argument|REAUTH_TIMER
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|portControl
operator|!=
name|Auto
operator|||
name|sm
operator|->
name|initialize
operator|||
name|sm
operator|->
name|authPortStatus
operator|==
name|Unauthorized
operator|||
operator|!
name|sm
operator|->
name|reAuthEnabled
condition|)
block|{
name|SM_ENTER
argument_list|(
name|REAUTH_TIMER
argument_list|,
name|INITIALIZE
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|sm
operator|->
name|reauth_timer_state
condition|)
block|{
case|case
name|REAUTH_TIMER_INITIALIZE
case|:
if|if
condition|(
name|sm
operator|->
name|reAuthWhen
operator|==
literal|0
condition|)
name|SM_ENTER
argument_list|(
name|REAUTH_TIMER
argument_list|,
name|REAUTHENTICATE
argument_list|)
expr_stmt|;
break|break;
case|case
name|REAUTH_TIMER_REAUTHENTICATE
case|:
name|SM_ENTER
argument_list|(
name|REAUTH_TIMER
argument_list|,
name|INITIALIZE
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_comment
comment|/* Authenticator Key Transmit state machine */
end_comment

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_KEY_TX
argument_list|,
argument|NO_KEY_TRANSMIT
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|AUTH_KEY_TX
argument_list|,
name|NO_KEY_TRANSMIT
argument_list|,
name|auth_key_tx
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|AUTH_KEY_TX
argument_list|,
argument|KEY_TRANSMIT
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|AUTH_KEY_TX
argument_list|,
name|KEY_TRANSMIT
argument_list|,
name|auth_key_tx
argument_list|)
expr_stmt|;
name|txKey
argument_list|()
expr_stmt|;
name|sm
operator|->
name|keyAvailable
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|keyDone
operator|=
name|TRUE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STEP
argument_list|(
argument|AUTH_KEY_TX
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|initialize
operator|||
name|sm
operator|->
name|portControl
operator|!=
name|Auto
condition|)
block|{
name|SM_ENTER
argument_list|(
name|AUTH_KEY_TX
argument_list|,
name|NO_KEY_TRANSMIT
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|sm
operator|->
name|auth_key_tx_state
condition|)
block|{
case|case
name|AUTH_KEY_TX_NO_KEY_TRANSMIT
case|:
if|if
condition|(
name|sm
operator|->
name|keyTxEnabled
operator|&&
name|sm
operator|->
name|keyAvailable
operator|&&
name|sm
operator|->
name|keyRun
operator|&&
operator|!
name|wpa_auth_sta_wpa_version
argument_list|(
name|sm
operator|->
name|sta
operator|->
name|wpa_sm
argument_list|)
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_KEY_TX
argument_list|,
name|KEY_TRANSMIT
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_KEY_TX_KEY_TRANSMIT
case|:
if|if
condition|(
operator|!
name|sm
operator|->
name|keyTxEnabled
operator|||
operator|!
name|sm
operator|->
name|keyRun
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_KEY_TX
argument_list|,
name|NO_KEY_TRANSMIT
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sm
operator|->
name|keyAvailable
condition|)
name|SM_ENTER
argument_list|(
name|AUTH_KEY_TX
argument_list|,
name|KEY_TRANSMIT
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_comment
comment|/* Key Receive state machine */
end_comment

begin_macro
name|SM_STATE
argument_list|(
argument|KEY_RX
argument_list|,
argument|NO_KEY_RECEIVE
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|KEY_RX
argument_list|,
name|NO_KEY_RECEIVE
argument_list|,
name|key_rx
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|KEY_RX
argument_list|,
argument|KEY_RECEIVE
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|KEY_RX
argument_list|,
name|KEY_RECEIVE
argument_list|,
name|key_rx
argument_list|)
expr_stmt|;
name|processKey
argument_list|()
expr_stmt|;
name|sm
operator|->
name|rxKey
operator|=
name|FALSE
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STEP
argument_list|(
argument|KEY_RX
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|initialize
operator|||
operator|!
name|sm
operator|->
name|portEnabled
condition|)
block|{
name|SM_ENTER
argument_list|(
name|KEY_RX
argument_list|,
name|NO_KEY_RECEIVE
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|sm
operator|->
name|key_rx_state
condition|)
block|{
case|case
name|KEY_RX_NO_KEY_RECEIVE
case|:
if|if
condition|(
name|sm
operator|->
name|rxKey
condition|)
name|SM_ENTER
argument_list|(
name|KEY_RX
argument_list|,
name|KEY_RECEIVE
argument_list|)
expr_stmt|;
break|break;
case|case
name|KEY_RX_KEY_RECEIVE
case|:
if|if
condition|(
name|sm
operator|->
name|rxKey
condition|)
name|SM_ENTER
argument_list|(
name|KEY_RX
argument_list|,
name|KEY_RECEIVE
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_comment
comment|/* Controlled Directions state machine */
end_comment

begin_macro
name|SM_STATE
argument_list|(
argument|CTRL_DIR
argument_list|,
argument|FORCE_BOTH
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|CTRL_DIR
argument_list|,
name|FORCE_BOTH
argument_list|,
name|ctrl_dir
argument_list|)
expr_stmt|;
name|sm
operator|->
name|operControlledDirections
operator|=
name|Both
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STATE
argument_list|(
argument|CTRL_DIR
argument_list|,
argument|IN_OR_BOTH
argument_list|)
end_macro

begin_block
block|{
name|SM_ENTRY_MA
argument_list|(
name|CTRL_DIR
argument_list|,
name|IN_OR_BOTH
argument_list|,
name|ctrl_dir
argument_list|)
expr_stmt|;
name|sm
operator|->
name|operControlledDirections
operator|=
name|sm
operator|->
name|adminControlledDirections
expr_stmt|;
block|}
end_block

begin_macro
name|SM_STEP
argument_list|(
argument|CTRL_DIR
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|sm
operator|->
name|initialize
condition|)
block|{
name|SM_ENTER
argument_list|(
name|CTRL_DIR
argument_list|,
name|IN_OR_BOTH
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|sm
operator|->
name|ctrl_dir_state
condition|)
block|{
case|case
name|CTRL_DIR_FORCE_BOTH
case|:
if|if
condition|(
name|sm
operator|->
name|portEnabled
operator|&&
name|sm
operator|->
name|operEdge
condition|)
name|SM_ENTER
argument_list|(
name|CTRL_DIR
argument_list|,
name|IN_OR_BOTH
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTRL_DIR_IN_OR_BOTH
case|:
if|if
condition|(
name|sm
operator|->
name|operControlledDirections
operator|!=
name|sm
operator|->
name|adminControlledDirections
condition|)
name|SM_ENTER
argument_list|(
name|CTRL_DIR
argument_list|,
name|IN_OR_BOTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sm
operator|->
name|portEnabled
operator|||
operator|!
name|sm
operator|->
name|operEdge
condition|)
name|SM_ENTER
argument_list|(
name|CTRL_DIR
argument_list|,
name|FORCE_BOTH
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_function
name|struct
name|eapol_state_machine
modifier|*
name|eapol_sm_alloc
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|sm
decl_stmt|;
name|sm
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"IEEE 802.1X port state allocation failed\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|sm
operator|->
name|radius_identifier
operator|=
operator|-
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|sm
operator|->
name|addr
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_PREAUTH
condition|)
name|sm
operator|->
name|flags
operator||=
name|EAPOL_SM_PREAUTH
expr_stmt|;
name|sm
operator|->
name|hapd
operator|=
name|hapd
expr_stmt|;
name|sm
operator|->
name|sta
operator|=
name|sta
expr_stmt|;
comment|/* Set default values for state machine constants */
name|sm
operator|->
name|auth_pae_state
operator|=
name|AUTH_PAE_INITIALIZE
expr_stmt|;
name|sm
operator|->
name|quietPeriod
operator|=
name|AUTH_PAE_DEFAULT_quietPeriod
expr_stmt|;
name|sm
operator|->
name|reAuthMax
operator|=
name|AUTH_PAE_DEFAULT_reAuthMax
expr_stmt|;
name|sm
operator|->
name|be_auth_state
operator|=
name|BE_AUTH_INITIALIZE
expr_stmt|;
name|sm
operator|->
name|serverTimeout
operator|=
name|BE_AUTH_DEFAULT_serverTimeout
expr_stmt|;
name|sm
operator|->
name|reauth_timer_state
operator|=
name|REAUTH_TIMER_INITIALIZE
expr_stmt|;
name|sm
operator|->
name|reAuthPeriod
operator|=
name|hapd
operator|->
name|conf
operator|->
name|eap_reauth_period
expr_stmt|;
name|sm
operator|->
name|reAuthEnabled
operator|=
name|hapd
operator|->
name|conf
operator|->
name|eap_reauth_period
operator|>
literal|0
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
name|sm
operator|->
name|auth_key_tx_state
operator|=
name|AUTH_KEY_TX_NO_KEY_TRANSMIT
expr_stmt|;
name|sm
operator|->
name|key_rx_state
operator|=
name|KEY_RX_NO_KEY_RECEIVE
expr_stmt|;
name|sm
operator|->
name|ctrl_dir_state
operator|=
name|CTRL_DIR_IN_OR_BOTH
expr_stmt|;
name|sm
operator|->
name|portEnabled
operator|=
name|FALSE
expr_stmt|;
name|sm
operator|->
name|portControl
operator|=
name|Auto
expr_stmt|;
name|sm
operator|->
name|keyAvailable
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|conf
operator|->
name|wpa
operator|&&
operator|(
name|hapd
operator|->
name|default_wep_key
operator|||
name|hapd
operator|->
name|conf
operator|->
name|individual_wep_key_len
operator|>
literal|0
operator|)
condition|)
name|sm
operator|->
name|keyTxEnabled
operator|=
name|TRUE
expr_stmt|;
else|else
name|sm
operator|->
name|keyTxEnabled
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
condition|)
name|sm
operator|->
name|portValid
operator|=
name|FALSE
expr_stmt|;
else|else
name|sm
operator|->
name|portValid
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|eap_server
condition|)
block|{
name|struct
name|eap_config
name|eap_conf
decl_stmt|;
name|memset
argument_list|(
operator|&
name|eap_conf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|eap_conf
argument_list|)
argument_list|)
expr_stmt|;
name|eap_conf
operator|.
name|ssl_ctx
operator|=
name|hapd
operator|->
name|ssl_ctx
expr_stmt|;
name|eap_conf
operator|.
name|eap_sim_db_priv
operator|=
name|hapd
operator|->
name|eap_sim_db_priv
expr_stmt|;
name|sm
operator|->
name|eap
operator|=
name|eap_sm_init
argument_list|(
name|sm
argument_list|,
operator|&
name|eapol_cb
argument_list|,
operator|&
name|eap_conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap
operator|==
name|NULL
condition|)
block|{
name|eapol_sm_free
argument_list|(
name|sm
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|eapol_sm_initialize
argument_list|(
name|sm
argument_list|)
expr_stmt|;
return|return
name|sm
return|;
block|}
end_function

begin_function
name|void
name|eapol_sm_free
parameter_list|(
name|struct
name|eapol_state_machine
modifier|*
name|sm
parameter_list|)
block|{
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return;
name|eloop_cancel_timeout
argument_list|(
name|eapol_port_timers_tick
argument_list|,
name|sm
operator|->
name|hapd
argument_list|,
name|sm
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|eapol_sm_step_cb
argument_list|,
name|sm
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap
condition|)
name|eap_sm_deinit
argument_list|(
name|sm
operator|->
name|eap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|eapol_sm_sta_entry_alive
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
operator|||
name|sta
operator|->
name|eapol_sm
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eapol_sm_step_run
parameter_list|(
name|struct
name|eapol_state_machine
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|sm
operator|->
name|hapd
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|unsigned
name|int
name|prev_auth_pae
decl_stmt|,
name|prev_be_auth
decl_stmt|,
name|prev_reauth_timer
decl_stmt|,
name|prev_auth_key_tx
decl_stmt|,
name|prev_key_rx
decl_stmt|,
name|prev_ctrl_dir
decl_stmt|;
name|int
name|max_steps
init|=
literal|100
decl_stmt|;
name|memcpy
argument_list|(
name|addr
argument_list|,
name|sm
operator|->
name|sta
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* 	 * Allow EAPOL state machines to run as long as there are state 	 * changes, but exit and return here through event loop if more than 	 * 100 steps is needed as a precaution against infinite loops inside 	 * eloop callback. 	 */
name|restart
label|:
name|prev_auth_pae
operator|=
name|sm
operator|->
name|auth_pae_state
expr_stmt|;
name|prev_be_auth
operator|=
name|sm
operator|->
name|be_auth_state
expr_stmt|;
name|prev_reauth_timer
operator|=
name|sm
operator|->
name|reauth_timer_state
expr_stmt|;
name|prev_auth_key_tx
operator|=
name|sm
operator|->
name|auth_key_tx_state
expr_stmt|;
name|prev_key_rx
operator|=
name|sm
operator|->
name|key_rx_state
expr_stmt|;
name|prev_ctrl_dir
operator|=
name|sm
operator|->
name|ctrl_dir_state
expr_stmt|;
name|SM_STEP_RUN
argument_list|(
name|AUTH_PAE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|initializing
operator|||
name|eapol_sm_sta_entry_alive
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
condition|)
name|SM_STEP_RUN
argument_list|(
name|BE_AUTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|initializing
operator|||
name|eapol_sm_sta_entry_alive
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
condition|)
name|SM_STEP_RUN
argument_list|(
name|REAUTH_TIMER
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|initializing
operator|||
name|eapol_sm_sta_entry_alive
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
condition|)
name|SM_STEP_RUN
argument_list|(
name|AUTH_KEY_TX
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|initializing
operator|||
name|eapol_sm_sta_entry_alive
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
condition|)
name|SM_STEP_RUN
argument_list|(
name|KEY_RX
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|initializing
operator|||
name|eapol_sm_sta_entry_alive
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
condition|)
name|SM_STEP_RUN
argument_list|(
name|CTRL_DIR
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev_auth_pae
operator|!=
name|sm
operator|->
name|auth_pae_state
operator|||
name|prev_be_auth
operator|!=
name|sm
operator|->
name|be_auth_state
operator|||
name|prev_reauth_timer
operator|!=
name|sm
operator|->
name|reauth_timer_state
operator|||
name|prev_auth_key_tx
operator|!=
name|sm
operator|->
name|auth_key_tx_state
operator|||
name|prev_key_rx
operator|!=
name|sm
operator|->
name|key_rx_state
operator|||
name|prev_ctrl_dir
operator|!=
name|sm
operator|->
name|ctrl_dir_state
condition|)
block|{
if|if
condition|(
operator|--
name|max_steps
operator|>
literal|0
condition|)
goto|goto
name|restart
goto|;
comment|/* Re-run from eloop timeout */
name|eapol_sm_step
argument_list|(
name|sm
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|eapol_sm_sta_entry_alive
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
operator|&&
name|sm
operator|->
name|eap
condition|)
block|{
if|if
condition|(
name|eap_sm_step
argument_list|(
name|sm
operator|->
name|eap
argument_list|)
condition|)
block|{
if|if
condition|(
operator|--
name|max_steps
operator|>
literal|0
condition|)
goto|goto
name|restart
goto|;
comment|/* Re-run from eloop timeout */
name|eapol_sm_step
argument_list|(
name|sm
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|eapol_sm_sta_entry_alive
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
condition|)
name|wpa_auth_sm_notify
argument_list|(
name|sm
operator|->
name|sta
operator|->
name|wpa_sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eapol_sm_step_cb
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|sm
init|=
name|eloop_ctx
decl_stmt|;
name|eapol_sm_step_run
argument_list|(
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|eapol_sm_step
parameter_list|(
name|struct
name|eapol_state_machine
modifier|*
name|sm
parameter_list|)
block|{
comment|/* 	 * Run eapol_sm_step_run from a registered timeout to make sure that 	 * other possible timeouts/events are processed and to avoid long 	 * function call chains. 	 */
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|eapol_sm_step_cb
argument_list|,
name|sm
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|eapol_sm_initialize
parameter_list|(
name|struct
name|eapol_state_machine
modifier|*
name|sm
parameter_list|)
block|{
name|sm
operator|->
name|initializing
operator|=
name|TRUE
expr_stmt|;
comment|/* Initialize the state machines by asserting initialize and then 	 * deasserting it after one step */
name|sm
operator|->
name|initialize
operator|=
name|TRUE
expr_stmt|;
name|eapol_sm_step_run
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|sm
operator|->
name|initialize
operator|=
name|FALSE
expr_stmt|;
name|eapol_sm_step_run
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|sm
operator|->
name|initializing
operator|=
name|FALSE
expr_stmt|;
comment|/* Start one second tick for port timers state machine */
name|eloop_cancel_timeout
argument_list|(
name|eapol_port_timers_tick
argument_list|,
name|sm
operator|->
name|hapd
argument_list|,
name|sm
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|eapol_port_timers_tick
argument_list|,
name|sm
operator|->
name|hapd
argument_list|,
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HOSTAPD_DUMP_STATE
end_ifdef

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|port_type_txt
parameter_list|(
name|PortTypes
name|pt
parameter_list|)
block|{
switch|switch
condition|(
name|pt
condition|)
block|{
case|case
name|ForceUnauthorized
case|:
return|return
literal|"ForceUnauthorized"
return|;
case|case
name|ForceAuthorized
case|:
return|return
literal|"ForceAuthorized"
return|;
case|case
name|Auto
case|:
return|return
literal|"Auto"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|port_state_txt
parameter_list|(
name|PortState
name|ps
parameter_list|)
block|{
switch|switch
condition|(
name|ps
condition|)
block|{
case|case
name|Unauthorized
case|:
return|return
literal|"Unauthorized"
return|;
case|case
name|Authorized
case|:
return|return
literal|"Authorized"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|ctrl_dir_txt
parameter_list|(
name|ControlledDirection
name|dir
parameter_list|)
block|{
switch|switch
condition|(
name|dir
condition|)
block|{
case|case
name|Both
case|:
return|return
literal|"Both"
return|;
case|case
name|In
case|:
return|return
literal|"In"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|auth_pae_state_txt
parameter_list|(
name|int
name|s
parameter_list|)
block|{
switch|switch
condition|(
name|s
condition|)
block|{
case|case
name|AUTH_PAE_INITIALIZE
case|:
return|return
literal|"INITIALIZE"
return|;
case|case
name|AUTH_PAE_DISCONNECTED
case|:
return|return
literal|"DISCONNECTED"
return|;
case|case
name|AUTH_PAE_CONNECTING
case|:
return|return
literal|"CONNECTING"
return|;
case|case
name|AUTH_PAE_AUTHENTICATING
case|:
return|return
literal|"AUTHENTICATING"
return|;
case|case
name|AUTH_PAE_AUTHENTICATED
case|:
return|return
literal|"AUTHENTICATED"
return|;
case|case
name|AUTH_PAE_ABORTING
case|:
return|return
literal|"ABORTING"
return|;
case|case
name|AUTH_PAE_HELD
case|:
return|return
literal|"HELD"
return|;
case|case
name|AUTH_PAE_FORCE_AUTH
case|:
return|return
literal|"FORCE_AUTH"
return|;
case|case
name|AUTH_PAE_FORCE_UNAUTH
case|:
return|return
literal|"FORCE_UNAUTH"
return|;
case|case
name|AUTH_PAE_RESTART
case|:
return|return
literal|"RESTART"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|be_auth_state_txt
parameter_list|(
name|int
name|s
parameter_list|)
block|{
switch|switch
condition|(
name|s
condition|)
block|{
case|case
name|BE_AUTH_REQUEST
case|:
return|return
literal|"REQUEST"
return|;
case|case
name|BE_AUTH_RESPONSE
case|:
return|return
literal|"RESPONSE"
return|;
case|case
name|BE_AUTH_SUCCESS
case|:
return|return
literal|"SUCCESS"
return|;
case|case
name|BE_AUTH_FAIL
case|:
return|return
literal|"FAIL"
return|;
case|case
name|BE_AUTH_TIMEOUT
case|:
return|return
literal|"TIMEOUT"
return|;
case|case
name|BE_AUTH_IDLE
case|:
return|return
literal|"IDLE"
return|;
case|case
name|BE_AUTH_INITIALIZE
case|:
return|return
literal|"INITIALIZE"
return|;
case|case
name|BE_AUTH_IGNORE
case|:
return|return
literal|"IGNORE"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|reauth_timer_state_txt
parameter_list|(
name|int
name|s
parameter_list|)
block|{
switch|switch
condition|(
name|s
condition|)
block|{
case|case
name|REAUTH_TIMER_INITIALIZE
case|:
return|return
literal|"INITIALIZE"
return|;
case|case
name|REAUTH_TIMER_REAUTHENTICATE
case|:
return|return
literal|"REAUTHENTICATE"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|auth_key_tx_state_txt
parameter_list|(
name|int
name|s
parameter_list|)
block|{
switch|switch
condition|(
name|s
condition|)
block|{
case|case
name|AUTH_KEY_TX_NO_KEY_TRANSMIT
case|:
return|return
literal|"NO_KEY_TRANSMIT"
return|;
case|case
name|AUTH_KEY_TX_KEY_TRANSMIT
case|:
return|return
literal|"KEY_TRANSMIT"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|key_rx_state_txt
parameter_list|(
name|int
name|s
parameter_list|)
block|{
switch|switch
condition|(
name|s
condition|)
block|{
case|case
name|KEY_RX_NO_KEY_RECEIVE
case|:
return|return
literal|"NO_KEY_RECEIVE"
return|;
case|case
name|KEY_RX_KEY_RECEIVE
case|:
return|return
literal|"KEY_RECEIVE"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
specifier|const
name|char
modifier|*
name|ctrl_dir_state_txt
parameter_list|(
name|int
name|s
parameter_list|)
block|{
switch|switch
condition|(
name|s
condition|)
block|{
case|case
name|CTRL_DIR_FORCE_BOTH
case|:
return|return
literal|"FORCE_BOTH"
return|;
case|case
name|CTRL_DIR_IN_OR_BOTH
case|:
return|return
literal|"IN_OR_BOTH"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
name|void
name|eapol_sm_dump_state
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|struct
name|eapol_state_machine
modifier|*
name|sm
parameter_list|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%sEAPOL state machine:\n"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s  aWhile=%d quietWhile=%d reAuthWhen=%d\n"
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|aWhile
argument_list|,
name|sm
operator|->
name|quietWhile
argument_list|,
name|sm
operator|->
name|reAuthWhen
argument_list|)
expr_stmt|;
define|#
directive|define
name|_SB
parameter_list|(
name|b
parameter_list|)
value|((b) ? "TRUE" : "FALSE")
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s  authAbort=%s authFail=%s authPortStatus=%s authStart=%s\n"
literal|"%s  authTimeout=%s authSuccess=%s eapFail=%s eapolEap=%s\n"
literal|"%s  eapSuccess=%s eapTimeout=%s initialize=%s "
literal|"keyAvailable=%s\n"
literal|"%s  keyDone=%s keyRun=%s keyTxEnabled=%s portControl=%s\n"
literal|"%s  portEnabled=%s portValid=%s reAuthenticate=%s\n"
argument_list|,
name|prefix
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|authAbort
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|authFail
argument_list|)
argument_list|,
name|port_state_txt
argument_list|(
name|sm
operator|->
name|authPortStatus
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|authStart
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|authTimeout
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|authSuccess
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapFail
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapolEap
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapSuccess
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapTimeout
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|initialize
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|keyAvailable
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|keyDone
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|keyRun
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|keyTxEnabled
argument_list|)
argument_list|,
name|port_type_txt
argument_list|(
name|sm
operator|->
name|portControl
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|portEnabled
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|portValid
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|reAuthenticate
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s  Authenticator PAE:\n"
literal|"%s    state=%s\n"
literal|"%s    eapolLogoff=%s eapolStart=%s eapRestart=%s\n"
literal|"%s    portMode=%s reAuthCount=%d\n"
literal|"%s    quietPeriod=%d reAuthMax=%d\n"
literal|"%s    authEntersConnecting=%d\n"
literal|"%s    authEapLogoffsWhileConnecting=%d\n"
literal|"%s    authEntersAuthenticating=%d\n"
literal|"%s    authAuthSuccessesWhileAuthenticating=%d\n"
literal|"%s    authAuthTimeoutsWhileAuthenticating=%d\n"
literal|"%s    authAuthFailWhileAuthenticating=%d\n"
literal|"%s    authAuthEapStartsWhileAuthenticating=%d\n"
literal|"%s    authAuthEapLogoffWhileAuthenticating=%d\n"
literal|"%s    authAuthReauthsWhileAuthenticated=%d\n"
literal|"%s    authAuthEapStartsWhileAuthenticated=%d\n"
literal|"%s    authAuthEapLogoffWhileAuthenticated=%d\n"
argument_list|,
name|prefix
argument_list|,
name|prefix
argument_list|,
name|auth_pae_state_txt
argument_list|(
name|sm
operator|->
name|auth_pae_state
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapolLogoff
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapolStart
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapRestart
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|port_type_txt
argument_list|(
name|sm
operator|->
name|portMode
argument_list|)
argument_list|,
name|sm
operator|->
name|reAuthCount
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|quietPeriod
argument_list|,
name|sm
operator|->
name|reAuthMax
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authEntersConnecting
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authEapLogoffsWhileConnecting
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authEntersAuthenticating
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authAuthSuccessesWhileAuthenticating
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authAuthTimeoutsWhileAuthenticating
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authAuthFailWhileAuthenticating
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authAuthEapStartsWhileAuthenticating
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authAuthEapLogoffWhileAuthenticating
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authAuthReauthsWhileAuthenticated
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authAuthEapStartsWhileAuthenticated
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|authAuthEapLogoffWhileAuthenticated
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s  Backend Authentication:\n"
literal|"%s    state=%s\n"
literal|"%s    eapNoReq=%s eapReq=%s eapResp=%s\n"
literal|"%s    serverTimeout=%d\n"
literal|"%s    backendResponses=%d\n"
literal|"%s    backendAccessChallenges=%d\n"
literal|"%s    backendOtherRequestsToSupplicant=%d\n"
literal|"%s    backendAuthSuccesses=%d\n"
literal|"%s    backendAuthFails=%d\n"
argument_list|,
name|prefix
argument_list|,
name|prefix
argument_list|,
name|be_auth_state_txt
argument_list|(
name|sm
operator|->
name|be_auth_state
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapNoReq
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapReq
argument_list|)
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|eapResp
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|serverTimeout
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|backendResponses
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|backendAccessChallenges
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|backendOtherRequestsToSupplicant
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|backendAuthSuccesses
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|backendAuthFails
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s  Reauthentication Timer:\n"
literal|"%s    state=%s\n"
literal|"%s    reAuthPeriod=%d reAuthEnabled=%s\n"
argument_list|,
name|prefix
argument_list|,
name|prefix
argument_list|,
name|reauth_timer_state_txt
argument_list|(
name|sm
operator|->
name|reauth_timer_state
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|reAuthPeriod
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|reAuthEnabled
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s  Authenticator Key Transmit:\n"
literal|"%s    state=%s\n"
argument_list|,
name|prefix
argument_list|,
name|prefix
argument_list|,
name|auth_key_tx_state_txt
argument_list|(
name|sm
operator|->
name|auth_key_tx_state
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s  Key Receive:\n"
literal|"%s    state=%s\n"
literal|"%s    rxKey=%s\n"
argument_list|,
name|prefix
argument_list|,
name|prefix
argument_list|,
name|key_rx_state_txt
argument_list|(
name|sm
operator|->
name|key_rx_state
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|rxKey
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s  Controlled Directions:\n"
literal|"%s    state=%s\n"
literal|"%s    adminControlledDirections=%s "
literal|"operControlledDirections=%s\n"
literal|"%s    operEdge=%s\n"
argument_list|,
name|prefix
argument_list|,
name|prefix
argument_list|,
name|ctrl_dir_state_txt
argument_list|(
name|sm
operator|->
name|ctrl_dir_state
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|ctrl_dir_txt
argument_list|(
name|sm
operator|->
name|adminControlledDirections
argument_list|)
argument_list|,
name|ctrl_dir_txt
argument_list|(
name|sm
operator|->
name|operControlledDirections
argument_list|)
argument_list|,
name|prefix
argument_list|,
name|_SB
argument_list|(
name|sm
operator|->
name|operEdge
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|_SB
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HOSTAPD_DUMP_STATE */
end_comment

begin_function
specifier|static
name|Boolean
name|eapol_sm_get_bool
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|eapol_bool_var
name|variable
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
switch|switch
condition|(
name|variable
condition|)
block|{
case|case
name|EAPOL_eapSuccess
case|:
return|return
name|sm
operator|->
name|eapSuccess
return|;
case|case
name|EAPOL_eapRestart
case|:
return|return
name|sm
operator|->
name|eapRestart
return|;
case|case
name|EAPOL_eapFail
case|:
return|return
name|sm
operator|->
name|eapFail
return|;
case|case
name|EAPOL_eapResp
case|:
return|return
name|sm
operator|->
name|eapResp
return|;
case|case
name|EAPOL_eapReq
case|:
return|return
name|sm
operator|->
name|eapReq
return|;
case|case
name|EAPOL_eapNoReq
case|:
return|return
name|sm
operator|->
name|eapNoReq
return|;
case|case
name|EAPOL_portEnabled
case|:
return|return
name|sm
operator|->
name|portEnabled
return|;
case|case
name|EAPOL_eapTimeout
case|:
return|return
name|sm
operator|->
name|eapTimeout
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eapol_sm_set_bool
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|eapol_bool_var
name|variable
parameter_list|,
name|Boolean
name|value
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|variable
condition|)
block|{
case|case
name|EAPOL_eapSuccess
case|:
name|sm
operator|->
name|eapSuccess
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapRestart
case|:
name|sm
operator|->
name|eapRestart
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapFail
case|:
name|sm
operator|->
name|eapFail
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapResp
case|:
name|sm
operator|->
name|eapResp
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapReq
case|:
name|sm
operator|->
name|eapReq
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapNoReq
case|:
name|sm
operator|->
name|eapNoReq
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_portEnabled
case|:
name|sm
operator|->
name|portEnabled
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapTimeout
case|:
name|sm
operator|->
name|eapTimeout
operator|=
name|value
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|eapol_sm_set_eapReqData
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|eapReqData
parameter_list|,
name|size_t
name|eapReqDataLen
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return;
name|free
argument_list|(
name|sm
operator|->
name|last_eap_radius
argument_list|)
expr_stmt|;
name|sm
operator|->
name|last_eap_radius
operator|=
name|malloc
argument_list|(
name|eapReqDataLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|last_eap_radius
operator|==
name|NULL
condition|)
return|return;
name|memcpy
argument_list|(
name|sm
operator|->
name|last_eap_radius
argument_list|,
name|eapReqData
argument_list|,
name|eapReqDataLen
argument_list|)
expr_stmt|;
name|sm
operator|->
name|last_eap_radius_len
operator|=
name|eapReqDataLen
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eapol_sm_set_eapKeyData
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|eapKeyData
parameter_list|,
name|size_t
name|eapKeyDataLen
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return;
name|hapd
operator|=
name|sm
operator|->
name|hapd
expr_stmt|;
if|if
condition|(
name|eapKeyData
operator|&&
name|eapKeyDataLen
operator|>=
literal|64
condition|)
block|{
name|free
argument_list|(
name|sm
operator|->
name|eapol_key_sign
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sm
operator|->
name|eapol_key_crypt
argument_list|)
expr_stmt|;
name|sm
operator|->
name|eapol_key_crypt
operator|=
name|malloc
argument_list|(
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eapol_key_crypt
condition|)
block|{
name|memcpy
argument_list|(
name|sm
operator|->
name|eapol_key_crypt
argument_list|,
name|eapKeyData
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|sm
operator|->
name|eapol_key_crypt_len
operator|=
literal|32
expr_stmt|;
block|}
name|sm
operator|->
name|eapol_key_sign
operator|=
name|malloc
argument_list|(
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eapol_key_sign
condition|)
block|{
name|memcpy
argument_list|(
name|sm
operator|->
name|eapol_key_sign
argument_list|,
name|eapKeyData
operator|+
literal|32
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|sm
operator|->
name|eapol_key_sign_len
operator|=
literal|32
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|default_wep_key
operator|||
name|hapd
operator|->
name|conf
operator|->
name|individual_wep_key_len
operator|>
literal|0
operator|||
name|hapd
operator|->
name|conf
operator|->
name|wpa
condition|)
name|sm
operator|->
name|keyAvailable
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|sm
operator|->
name|eapol_key_sign
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sm
operator|->
name|eapol_key_crypt
argument_list|)
expr_stmt|;
name|sm
operator|->
name|eapol_key_sign
operator|=
name|NULL
expr_stmt|;
name|sm
operator|->
name|eapol_key_crypt
operator|=
name|NULL
expr_stmt|;
name|sm
operator|->
name|eapol_key_sign_len
operator|=
literal|0
expr_stmt|;
name|sm
operator|->
name|eapol_key_crypt_len
operator|=
literal|0
expr_stmt|;
name|sm
operator|->
name|keyAvailable
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eapol_sm_get_eap_user
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|identity
parameter_list|,
name|size_t
name|identity_len
parameter_list|,
name|int
name|phase2
parameter_list|,
name|struct
name|eap_user
modifier|*
name|user
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
specifier|const
name|struct
name|hostapd_eap_user
modifier|*
name|eap_user
decl_stmt|;
name|int
name|i
decl_stmt|,
name|count
decl_stmt|;
name|eap_user
operator|=
name|hostapd_get_eap_user
argument_list|(
name|sm
operator|->
name|hapd
operator|->
name|conf
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|,
name|phase2
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_user
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|->
name|phase2
operator|=
name|phase2
expr_stmt|;
name|count
operator|=
name|EAP_USER_MAX_METHODS
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|EAP_MAX_METHODS
condition|)
name|count
operator|=
name|EAP_MAX_METHODS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|vendor
operator|=
name|eap_user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|vendor
expr_stmt|;
name|user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|method
operator|=
name|eap_user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|method
expr_stmt|;
block|}
if|if
condition|(
name|eap_user
operator|->
name|password
condition|)
block|{
name|user
operator|->
name|password
operator|=
name|malloc
argument_list|(
name|eap_user
operator|->
name|password_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|->
name|password
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|user
operator|->
name|password
argument_list|,
name|eap_user
operator|->
name|password
argument_list|,
name|eap_user
operator|->
name|password_len
argument_list|)
expr_stmt|;
name|user
operator|->
name|password_len
operator|=
name|eap_user
operator|->
name|password_len
expr_stmt|;
block|}
name|user
operator|->
name|force_version
operator|=
name|eap_user
operator|->
name|force_version
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eapol_sm_get_eap_req_id_text
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
operator|*
name|len
operator|=
name|sm
operator|->
name|hapd
operator|->
name|conf
operator|->
name|eap_req_id_text_len
expr_stmt|;
return|return
name|sm
operator|->
name|hapd
operator|->
name|conf
operator|->
name|eap_req_id_text
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|eapol_callbacks
name|eapol_cb
init|=
block|{
operator|.
name|get_bool
operator|=
name|eapol_sm_get_bool
block|,
operator|.
name|set_bool
operator|=
name|eapol_sm_set_bool
block|,
operator|.
name|set_eapReqData
operator|=
name|eapol_sm_set_eapReqData
block|,
operator|.
name|set_eapKeyData
operator|=
name|eapol_sm_set_eapKeyData
block|,
operator|.
name|get_eap_user
operator|=
name|eapol_sm_get_eap_user
block|,
operator|.
name|get_eap_req_id_text
operator|=
name|eapol_sm_get_eap_req_id_text
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|eapol_sm_eap_pending_cb
parameter_list|(
name|struct
name|eapol_state_machine
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|sm
operator|==
name|NULL
operator|||
name|ctx
operator|!=
name|sm
operator|->
name|eap
condition|)
return|return
operator|-
literal|1
return|;
name|eap_sm_pending_cb
argument_list|(
name|sm
operator|->
name|eap
argument_list|)
expr_stmt|;
name|eapol_sm_step
argument_list|(
name|sm
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / Driver interface for development testing  * Copyright (c) 2004-2007, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<dirent.h>
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"eapol_sm.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"accounting.h"
end_include

begin_include
include|#
directive|include
file|"radius.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"hw_features.h"
end_include

begin_struct
struct|struct
name|test_client_socket
block|{
name|struct
name|test_client_socket
modifier|*
name|next
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|sockaddr_un
name|un
decl_stmt|;
name|socklen_t
name|unlen
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|test_driver_bss
block|{
name|struct
name|test_driver_bss
modifier|*
name|next
decl_stmt|;
name|char
name|ifname
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
modifier|*
name|ie
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
name|u8
name|ssid
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|ssid_len
decl_stmt|;
name|int
name|privacy
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|test_driver_data
block|{
name|struct
name|driver_ops
name|ops
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|int
name|test_socket
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|char
modifier|*
name|socket_dir
decl_stmt|;
name|char
modifier|*
name|own_socket_path
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|driver_ops
name|test_driver_ops
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|test_driver_free_bss
parameter_list|(
name|struct
name|test_driver_bss
modifier|*
name|bss
parameter_list|)
block|{
name|free
argument_list|(
name|bss
operator|->
name|ie
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_free_priv
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return;
name|bss
operator|=
name|drv
operator|->
name|bss
expr_stmt|;
while|while
condition|(
name|bss
condition|)
block|{
name|prev
operator|=
name|bss
expr_stmt|;
name|bss
operator|=
name|bss
operator|->
name|next
expr_stmt|;
name|test_driver_free_bss
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
operator|->
name|socket_dir
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|test_client_socket
modifier|*
name|test_driver_get_cli
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
init|=
name|drv
operator|->
name|cli
decl_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|cli
operator|->
name|unlen
operator|==
name|fromlen
operator|&&
name|strncmp
argument_list|(
name|cli
operator|->
name|un
operator|.
name|sun_path
argument_list|,
name|from
operator|->
name|sun_path
argument_list|,
name|fromlen
operator|-
sizeof|sizeof
argument_list|(
name|cli
operator|->
name|un
operator|.
name|sun_family
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
name|cli
return|;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_send_eapol
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|encrypt
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|l2_ethhdr
name|eth
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: no destination client entry"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|eth
operator|.
name|h_dest
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eth
operator|.
name|h_source
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|eth
operator|.
name|h_proto
operator|=
name|htons
argument_list|(
name|ETH_P_EAPOL
argument_list|)
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
literal|"EAPOL "
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
literal|6
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|&
name|eth
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|eth
argument_list|)
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
operator|(
name|u8
operator|*
operator|)
name|data
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|data_len
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|3
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|cli
operator|->
name|un
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|cli
operator|->
name|unlen
expr_stmt|;
return|return
name|sendmsg
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_send_mgmt_frame
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|dest
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|broadcast
init|=
literal|0
decl_stmt|;
name|char
name|desttxt
index|[
literal|30
index|]
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|struct
name|dirent
modifier|*
name|dent
decl_stmt|;
name|DIR
modifier|*
name|dir
decl_stmt|;
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
operator|||
name|len
operator|<
literal|10
operator|||
name|drv
operator|->
name|socket_dir
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: invalid parameters (sock=%d len=%d "
literal|"socket_dir=%p)"
argument_list|,
name|__func__
argument_list|,
name|drv
operator|->
name|test_socket
argument_list|,
name|len
argument_list|,
name|drv
operator|->
name|socket_dir
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dest
operator|=
name|buf
expr_stmt|;
name|dest
operator|+=
literal|4
expr_stmt|;
name|broadcast
operator|=
name|memcmp
argument_list|(
name|dest
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|desttxt
argument_list|,
sizeof|sizeof
argument_list|(
name|desttxt
argument_list|)
argument_list|,
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dest
argument_list|)
argument_list|)
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
literal|"MLME "
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
literal|5
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|buf
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|2
expr_stmt|;
name|dir
operator|=
name|opendir
argument_list|(
name|drv
operator|->
name|socket_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
literal|"test_driver: opendir"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
operator|(
name|dent
operator|=
name|readdir
argument_list|(
name|dir
argument_list|)
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|_DIRENT_HAVE_D_TYPE
comment|/* Skip the file if it is not a socket. Also accept 		 * DT_UNKNOWN (0) in case the C library or underlying file 		 * system does not support d_type. */
if|if
condition|(
name|dent
operator|->
name|d_type
operator|!=
name|DT_SOCK
operator|&&
name|dent
operator|->
name|d_type
operator|!=
name|DT_UNKNOWN
condition|)
continue|continue;
endif|#
directive|endif
comment|/* _DIRENT_HAVE_D_TYPE */
if|if
condition|(
name|strcmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|"."
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
literal|".."
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|snprintf
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|drv
operator|->
name|socket_dir
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|drv
operator|->
name|own_socket_path
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|!
name|broadcast
operator|&&
name|strstr
argument_list|(
name|dent
operator|->
name|d_name
argument_list|,
name|desttxt
argument_list|)
operator|==
name|NULL
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Send management frame to %s"
argument_list|,
name|__func__
argument_list|,
name|dent
operator|->
name|d_name
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sendmsg
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"driver_test: sendmsg"
argument_list|)
expr_stmt|;
block|}
name|closedir
argument_list|(
name|dir
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|ieee802_11_mgmt_cb
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
argument_list|,
name|len
argument_list|,
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
argument_list|,
name|ret
operator|>=
literal|0
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_scan
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: SCAN"
argument_list|)
expr_stmt|;
for|for
control|(
name|bss
operator|=
name|drv
operator|->
name|bss
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* reply: SCANRESP BSSID SSID IEs */
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"SCANRESP "
name|MACSTR
literal|" "
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|bss
operator|->
name|ie
argument_list|,
name|bss
operator|->
name|ielen
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|privacy
condition|)
block|{
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" PRIVACY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_data
modifier|*
name|test_driver_get_hapd
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|test_driver_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|drv
operator|->
name|hapd
operator|->
name|iface
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|NULL
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: bss == NULL"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
name|hapd
operator|=
name|iface
operator|->
name|bss
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|hapd
operator|->
name|own_addr
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|iface
operator|->
name|num_bss
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: no matching interface entry found "
literal|"for BSSID "
name|MACSTR
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|hapd
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_new_sta
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|test_driver_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ielen
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|new_assoc
decl_stmt|,
name|res
decl_stmt|;
name|hapd
operator|=
name|test_driver_get_hapd
argument_list|(
name|drv
argument_list|,
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"associated"
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
block|{
name|accounting_sta_stop
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|accounting_sta_get_id
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
condition|)
block|{
if|if
condition|(
name|ie
operator|==
name|NULL
operator|||
name|ielen
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"test_driver: no IE from STA\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
name|sta
operator|->
name|wpa_sm
operator|=
name|wpa_auth_sta_init
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|sta
operator|->
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"test_driver: Failed to initialize WPA state "
literal|"machine\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|wpa_validate_wpa_ie
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|sta
operator|->
name|wpa_sm
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|WPA_IE_OK
condition|)
block|{
name|printf
argument_list|(
literal|"WPA/RSN information element rejected? "
literal|"(res %u)\n"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|new_assoc
operator|=
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_ASSOC
operator|)
operator|==
literal|0
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_AUTH
operator||
name|WLAN_STA_ASSOC
expr_stmt|;
name|wpa_auth_sm_event
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|WPA_ASSOC
argument_list|)
expr_stmt|;
name|hostapd_new_assoc_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
operator|!
name|new_assoc
argument_list|)
expr_stmt|;
name|ieee802_1x_notify_port_enabled
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_assoc
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|char
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|u8
name|ie
index|[
literal|256
index|]
decl_stmt|,
name|ssid
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|ielen
decl_stmt|,
name|ssid_len
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|,
name|cmd
index|[
literal|50
index|]
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
comment|/* data: STA-addr SSID(hex) IEs(hex) */
name|cli
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cli
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cli
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|data
argument_list|,
name|cli
operator|->
name|addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"test_socket: Invalid MAC address '%s' in ASSOC\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cli
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|data
operator|+
literal|17
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
condition|)
name|pos
operator|++
expr_stmt|;
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|ielen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pos2
condition|)
block|{
name|ssid_len
operator|=
operator|(
name|pos2
operator|-
name|pos
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Invalid SSID"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cli
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver_assoc: SSID"
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
name|ielen
operator|=
name|strlen
argument_list|(
name|pos
argument_list|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|ielen
operator|>
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
condition|)
name|ielen
operator|=
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
operator|<
literal|0
condition|)
name|ielen
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|bss
operator|=
name|drv
operator|->
name|bss
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|bss
operator|->
name|ssid_len
operator|==
name|ssid_len
operator|&&
name|memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: No matching SSID found from "
literal|"configured BSSes"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cli
argument_list|)
expr_stmt|;
return|return;
block|}
name|cli
operator|->
name|bss
operator|=
name|bss
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cli
operator|->
name|un
argument_list|,
name|from
argument_list|,
sizeof|sizeof
argument_list|(
name|cli
operator|->
name|un
argument_list|)
argument_list|)
expr_stmt|;
name|cli
operator|->
name|unlen
operator|=
name|fromlen
expr_stmt|;
name|cli
operator|->
name|next
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
name|drv
operator|->
name|cli
operator|=
name|cli
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_socket: ASSOC sun_path"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|cli
operator|->
name|un
operator|.
name|sun_path
argument_list|,
name|cli
operator|->
name|unlen
operator|-
sizeof|sizeof
argument_list|(
name|cli
operator|->
name|un
operator|.
name|sun_family
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|"ASSOCRESP "
name|MACSTR
literal|" 0"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|cmd
argument_list|,
name|strlen
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_driver_new_sta
argument_list|(
name|drv
argument_list|,
name|bss
argument_list|,
name|cli
operator|->
name|addr
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: failed to add new STA"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_disassoc
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|cli
operator|=
name|test_driver_get_cli
argument_list|(
name|drv
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cli
condition|)
return|return;
name|hostapd_logger
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|cli
operator|->
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"disassociated"
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|cli
operator|->
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|!=
name|NULL
condition|)
block|{
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WLAN_STA_ASSOC
expr_stmt|;
name|wpa_auth_sm_event
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|WPA_DISASSOC
argument_list|)
expr_stmt|;
name|sta
operator|->
name|acct_terminate_cause
operator|=
name|RADIUS_ACCT_TERMINATE_CAUSE_USER_REQUEST
expr_stmt|;
name|ieee802_1x_notify_port_enabled
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ap_free_sta
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_eapol
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|datalen
parameter_list|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
if|if
condition|(
name|datalen
operator|>
literal|14
condition|)
block|{
name|u8
modifier|*
name|proto
init|=
name|data
operator|+
literal|2
operator|*
name|ETH_ALEN
decl_stmt|;
comment|/* Skip Ethernet header */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: dst="
name|MACSTR
literal|" src="
name|MACSTR
literal|" proto=%04x"
argument_list|,
name|MAC2STR
argument_list|(
name|data
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|+
name|ETH_ALEN
argument_list|)
argument_list|,
operator|(
name|proto
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|proto
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|14
expr_stmt|;
name|datalen
operator|-=
literal|14
expr_stmt|;
block|}
name|cli
operator|=
name|test_driver_get_cli
argument_list|(
name|drv
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|cli
condition|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|hapd
operator|=
name|test_driver_get_hapd
argument_list|(
name|drv
argument_list|,
name|cli
operator|->
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
condition|)
return|return;
name|ieee802_1x_receive
argument_list|(
name|hapd
argument_list|,
name|cli
operator|->
name|addr
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_socket: EAPOL from unknown "
literal|"client"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_mlme
parameter_list|(
name|struct
name|test_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|datalen
parameter_list|)
block|{
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|test_driver_get_cli
argument_list|(
name|drv
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
operator|==
name|NULL
operator|&&
name|datalen
operator|>=
literal|16
condition|)
block|{
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|cli
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cli
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cli
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Adding client entry for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|hdr
operator|->
name|addr2
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|hdr
operator|->
name|addr2
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cli
operator|->
name|un
argument_list|,
name|from
argument_list|,
sizeof|sizeof
argument_list|(
name|cli
operator|->
name|un
argument_list|)
argument_list|)
expr_stmt|;
name|cli
operator|->
name|unlen
operator|=
name|fromlen
expr_stmt|;
name|cli
operator|->
name|next
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
name|drv
operator|->
name|cli
operator|=
name|cli
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"test_driver_mlme: received frame"
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|!=
name|WLAN_FC_TYPE_MGMT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: received non-mgmt frame"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|ieee802_11_mgmt
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|,
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_receive_unix
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|char
name|buf
index|[
literal|2000
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|sockaddr_un
name|from
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|;
name|res
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom(test_socket)"
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver: received %u bytes"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"SCAN"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_scan
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"ASSOC "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_assoc
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
literal|"DISASSOC"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_disassoc
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"EAPOL "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_eapol
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
operator|+
literal|6
argument_list|,
name|res
operator|-
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"MLME "
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_driver_mlme
argument_list|(
name|drv
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
operator|+
literal|5
argument_list|,
name|res
operator|-
literal|5
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unknown test_socket command"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_generic_elem
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|elem
parameter_list|,
name|size_t
name|elem_len
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
for|for
control|(
name|bss
operator|=
name|drv
operator|->
name|bss
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|free
argument_list|(
name|bss
operator|->
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|elem
operator|==
name|NULL
condition|)
block|{
name|bss
operator|->
name|ie
operator|=
name|NULL
expr_stmt|;
name|bss
operator|->
name|ielen
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|bss
operator|->
name|ie
operator|=
name|malloc
argument_list|(
name|elem_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ie
condition|)
block|{
name|memcpy
argument_list|(
name|bss
operator|->
name|ie
argument_list|,
name|elem
argument_list|,
name|elem_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ielen
operator|=
name|elem_len
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|bss
operator|->
name|ielen
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_sta_deauth
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"DEAUTH"
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cli
operator|->
name|un
argument_list|,
name|cli
operator|->
name|unlen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_sta_disassoc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|sendto
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
literal|"DISASSOC"
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|cli
operator|->
name|un
argument_list|,
name|cli
operator|->
name|unlen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_hw_modes
modifier|*
name|test_driver_get_hw_feature_data
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u16
modifier|*
name|num_modes
parameter_list|,
name|u16
modifier|*
name|flags
parameter_list|)
block|{
name|struct
name|hostapd_hw_modes
modifier|*
name|modes
decl_stmt|;
operator|*
name|num_modes
operator|=
literal|3
expr_stmt|;
operator|*
name|flags
operator|=
literal|0
expr_stmt|;
name|modes
operator|=
name|wpa_zalloc
argument_list|(
operator|*
name|num_modes
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_hw_modes
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modes
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|modes
index|[
literal|0
index|]
operator|.
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211G
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|num_channels
operator|=
literal|1
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|num_rates
operator|=
literal|1
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|channels
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_channel_data
argument_list|)
argument_list|)
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_rate_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modes
index|[
literal|0
index|]
operator|.
name|channels
operator|==
name|NULL
operator|||
name|modes
index|[
literal|0
index|]
operator|.
name|rates
operator|==
name|NULL
condition|)
block|{
name|hostapd_free_hw_features
argument_list|(
name|modes
argument_list|,
operator|*
name|num_modes
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|modes
index|[
literal|0
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|chan
operator|=
literal|1
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|freq
operator|=
literal|2412
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|flag
operator|=
name|HOSTAPD_CHAN_W_SCAN
operator||
name|HOSTAPD_CHAN_W_ACTIVE_SCAN
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|0
index|]
operator|.
name|rate
operator|=
literal|10
expr_stmt|;
name|modes
index|[
literal|0
index|]
operator|.
name|rates
index|[
literal|0
index|]
operator|.
name|flags
operator|=
name|HOSTAPD_RATE_BASIC
operator||
name|HOSTAPD_RATE_SUPPORTED
operator||
name|HOSTAPD_RATE_CCK
operator||
name|HOSTAPD_RATE_MANDATORY
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211B
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|num_channels
operator|=
literal|1
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|num_rates
operator|=
literal|1
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|channels
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_channel_data
argument_list|)
argument_list|)
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|rates
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_rate_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modes
index|[
literal|1
index|]
operator|.
name|channels
operator|==
name|NULL
operator|||
name|modes
index|[
literal|1
index|]
operator|.
name|rates
operator|==
name|NULL
condition|)
block|{
name|hostapd_free_hw_features
argument_list|(
name|modes
argument_list|,
operator|*
name|num_modes
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|modes
index|[
literal|1
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|chan
operator|=
literal|1
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|freq
operator|=
literal|2412
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|flag
operator|=
name|HOSTAPD_CHAN_W_SCAN
operator||
name|HOSTAPD_CHAN_W_ACTIVE_SCAN
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|rates
index|[
literal|0
index|]
operator|.
name|rate
operator|=
literal|10
expr_stmt|;
name|modes
index|[
literal|1
index|]
operator|.
name|rates
index|[
literal|0
index|]
operator|.
name|flags
operator|=
name|HOSTAPD_RATE_BASIC
operator||
name|HOSTAPD_RATE_SUPPORTED
operator||
name|HOSTAPD_RATE_CCK
operator||
name|HOSTAPD_RATE_MANDATORY
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211A
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|num_channels
operator|=
literal|1
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|num_rates
operator|=
literal|1
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|channels
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_channel_data
argument_list|)
argument_list|)
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_rate_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|modes
index|[
literal|2
index|]
operator|.
name|channels
operator|==
name|NULL
operator|||
name|modes
index|[
literal|2
index|]
operator|.
name|rates
operator|==
name|NULL
condition|)
block|{
name|hostapd_free_hw_features
argument_list|(
name|modes
argument_list|,
operator|*
name|num_modes
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|modes
index|[
literal|2
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|chan
operator|=
literal|60
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|freq
operator|=
literal|5300
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|channels
index|[
literal|0
index|]
operator|.
name|flag
operator|=
name|HOSTAPD_CHAN_W_SCAN
operator||
name|HOSTAPD_CHAN_W_ACTIVE_SCAN
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|0
index|]
operator|.
name|rate
operator|=
literal|60
expr_stmt|;
name|modes
index|[
literal|2
index|]
operator|.
name|rates
index|[
literal|0
index|]
operator|.
name|flags
operator|=
name|HOSTAPD_RATE_BASIC
operator||
name|HOSTAPD_RATE_SUPPORTED
operator||
name|HOSTAPD_RATE_MANDATORY
expr_stmt|;
return|return
name|modes
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_bss_add
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(ifname=%s bssid="
name|MACSTR
literal|")"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|bss
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|strncpy
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|bss
operator|->
name|next
operator|=
name|drv
operator|->
name|bss
expr_stmt|;
name|drv
operator|->
name|bss
operator|=
name|bss
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_bss_remove
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|,
modifier|*
name|prev_c
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(ifname=%s)"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
for|for
control|(
name|prev
operator|=
name|NULL
operator|,
name|bss
operator|=
name|drv
operator|->
name|bss
init|;
name|bss
condition|;
name|prev
operator|=
name|bss
operator|,
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|bss
operator|->
name|next
expr_stmt|;
else|else
name|drv
operator|->
name|bss
operator|=
name|bss
operator|->
name|next
expr_stmt|;
for|for
control|(
name|prev_c
operator|=
name|NULL
operator|,
name|cli
operator|=
name|drv
operator|->
name|cli
init|;
name|cli
condition|;
name|prev_c
operator|=
name|cli
operator|,
name|cli
operator|=
name|cli
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cli
operator|->
name|bss
operator|!=
name|bss
condition|)
continue|continue;
if|if
condition|(
name|prev_c
condition|)
name|prev_c
operator|->
name|next
operator|=
name|cli
operator|->
name|next
expr_stmt|;
else|else
name|drv
operator|->
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|cli
argument_list|)
expr_stmt|;
break|break;
block|}
name|test_driver_free_bss
argument_list|(
name|bss
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_if_add
parameter_list|(
specifier|const
name|char
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|hostapd_driver_if_type
name|type
parameter_list|,
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(iface=%s type=%d ifname=%s)"
argument_list|,
name|__func__
argument_list|,
name|iface
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_if_update
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|hostapd_driver_if_type
name|type
parameter_list|,
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(type=%d ifname=%s)"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_if_remove
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|hostapd_driver_if_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(type=%d ifname=%s)"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_valid_bss_mask
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|mask
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_ssid
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(ifname=%s)"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver_set_ssid: SSID"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|bss
operator|=
name|drv
operator|->
name|bss
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|len
operator|>
sizeof|sizeof
argument_list|(
name|bss
operator|->
name|ssid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid_len
operator|=
name|len
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_privacy
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(ifname=%s enabled=%d)"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
for|for
control|(
name|bss
operator|=
name|drv
operator|->
name|bss
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|bss
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|bss
operator|->
name|privacy
operator|=
name|enabled
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_encryption
parameter_list|(
specifier|const
name|char
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
name|int
name|txkey
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(iface=%s alg=%s idx=%d txkey=%d)"
argument_list|,
name|__func__
argument_list|,
name|iface
argument_list|,
name|alg
argument_list|,
name|idx
argument_list|,
name|txkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   key"
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_set_sta_vlan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|vlan_id
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(addr="
name|MACSTR
literal|" ifname=%s vlan_id=%d)"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|ifname
argument_list|,
name|vlan_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_sta_add
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u16
name|aid
parameter_list|,
name|u16
name|capability
parameter_list|,
name|u8
modifier|*
name|supp_rates
parameter_list|,
name|size_t
name|supp_rates_len
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|;
name|struct
name|test_driver_bss
modifier|*
name|bss
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s(ifname=%s addr="
name|MACSTR
literal|" aid=%d "
literal|"capability=0x%x flags=0x%x"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|aid
argument_list|,
name|capability
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"test_driver_sta_add - supp_rates"
argument_list|,
name|supp_rates
argument_list|,
name|supp_rates_len
argument_list|)
expr_stmt|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|cli
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cli
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: no matching client entry"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|bss
operator|=
name|drv
operator|->
name|bss
init|;
name|bss
condition|;
name|bss
operator|=
name|bss
operator|->
name|next
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|ifname
argument_list|,
name|bss
operator|->
name|ifname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: No matching interface found from "
literal|"configured BSSes"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cli
operator|->
name|bss
operator|=
name|bss
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_driver_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|drv
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|test_driver_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not allocate memory for test driver data\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|drv
operator|->
name|bss
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|drv
operator|->
name|bss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|bss
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not allocate memory for test driver BSS data\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|drv
operator|->
name|ops
operator|=
name|test_driver_ops
expr_stmt|;
name|drv
operator|->
name|hapd
operator|=
name|hapd
expr_stmt|;
comment|/* Generate a MAC address to help testing with multiple APs */
name|hapd
operator|->
name|own_addr
index|[
literal|0
index|]
operator|=
literal|0x02
expr_stmt|;
comment|/* locally administered */
name|sha1_prf
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
argument_list|,
literal|"hostapd test bssid generation"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid_len
argument_list|,
name|hapd
operator|->
name|own_addr
operator|+
literal|1
argument_list|,
name|ETH_ALEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|drv
operator|->
name|bss
operator|->
name|ifname
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|drv
operator|->
name|bss
operator|->
name|bssid
argument_list|,
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|test_socket
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|test_socket
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Too long test_socket path\n"
argument_list|)
expr_stmt|;
name|test_driver_free_priv
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|test_socket
argument_list|,
literal|"DIR:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|size_t
name|len
init|=
name|strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|test_socket
argument_list|)
operator|+
literal|30
decl_stmt|;
name|drv
operator|->
name|socket_dir
operator|=
name|strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|test_socket
operator|+
literal|4
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|own_socket_path
condition|)
block|{
name|snprintf
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|,
name|len
argument_list|,
literal|"%s/AP-"
name|MACSTR
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|test_socket
operator|+
literal|4
argument_list|,
name|MAC2STR
argument_list|(
name|hapd
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|drv
operator|->
name|own_socket_path
operator|=
name|strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|test_socket
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|own_socket_path
operator|==
name|NULL
condition|)
block|{
name|test_driver_free_priv
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|drv
operator|->
name|test_socket
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_UNIX)"
argument_list|)
expr_stmt|;
name|test_driver_free_priv
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|strncpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|drv
operator|->
name|own_socket_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind(PF_UNIX)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|test_driver_free_priv
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|,
name|test_driver_receive_unix
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|drv
operator|->
name|test_socket
operator|=
operator|-
literal|1
expr_stmt|;
name|hapd
operator|->
name|driver
operator|=
operator|&
name|drv
operator|->
name|ops
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_driver_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|test_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|test_client_socket
modifier|*
name|cli
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|cli
operator|=
name|drv
operator|->
name|cli
expr_stmt|;
while|while
condition|(
name|cli
condition|)
block|{
name|prev
operator|=
name|cli
expr_stmt|;
name|cli
operator|=
name|cli
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|test_socket
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|test_socket
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
block|}
name|drv
operator|->
name|hapd
operator|->
name|driver
operator|=
name|NULL
expr_stmt|;
comment|/* There should be only one BSS remaining at this point. */
if|if
condition|(
name|drv
operator|->
name|bss
operator|==
name|NULL
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: drv->bss == NULL"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|drv
operator|->
name|bss
operator|->
name|next
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: drv->bss->next != NULL"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|test_driver_free_priv
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|driver_ops
name|test_driver_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"test"
block|,
operator|.
name|init
operator|=
name|test_driver_init
block|,
operator|.
name|deinit
operator|=
name|test_driver_deinit
block|,
operator|.
name|send_eapol
operator|=
name|test_driver_send_eapol
block|,
operator|.
name|send_mgmt_frame
operator|=
name|test_driver_send_mgmt_frame
block|,
operator|.
name|set_generic_elem
operator|=
name|test_driver_set_generic_elem
block|,
operator|.
name|sta_deauth
operator|=
name|test_driver_sta_deauth
block|,
operator|.
name|sta_disassoc
operator|=
name|test_driver_sta_disassoc
block|,
operator|.
name|get_hw_feature_data
operator|=
name|test_driver_get_hw_feature_data
block|,
operator|.
name|bss_add
operator|=
name|test_driver_bss_add
block|,
operator|.
name|bss_remove
operator|=
name|test_driver_bss_remove
block|,
operator|.
name|if_add
operator|=
name|test_driver_if_add
block|,
operator|.
name|if_update
operator|=
name|test_driver_if_update
block|,
operator|.
name|if_remove
operator|=
name|test_driver_if_remove
block|,
operator|.
name|valid_bss_mask
operator|=
name|test_driver_valid_bss_mask
block|,
operator|.
name|set_ssid
operator|=
name|test_driver_set_ssid
block|,
operator|.
name|set_privacy
operator|=
name|test_driver_set_privacy
block|,
operator|.
name|set_encryption
operator|=
name|test_driver_set_encryption
block|,
operator|.
name|set_sta_vlan
operator|=
name|test_driver_set_sta_vlan
block|,
operator|.
name|sta_add
operator|=
name|test_driver_sta_add
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|test_driver_register
parameter_list|(
name|void
parameter_list|)
block|{
name|driver_register
argument_list|(
name|test_driver_ops
operator|.
name|name
argument_list|,
operator|&
name|test_driver_ops
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


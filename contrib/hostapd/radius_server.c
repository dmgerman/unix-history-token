begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / RADIUS authentication server  * Copyright (c) 2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"radius.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"eap.h"
end_include

begin_include
include|#
directive|include
file|"radius_server.h"
end_include

begin_define
define|#
directive|define
name|RADIUS_SESSION_TIMEOUT
value|60
end_define

begin_define
define|#
directive|define
name|RADIUS_MAX_SESSION
value|100
end_define

begin_define
define|#
directive|define
name|RADIUS_MAX_MSG_LEN
value|3000
end_define

begin_decl_stmt
specifier|static
name|struct
name|eapol_callbacks
name|radius_server_eapol_cb
decl_stmt|;
end_decl_stmt

begin_struct_decl
struct_decl|struct
name|radius_client
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|radius_server_data
struct_decl|;
end_struct_decl

begin_struct
struct|struct
name|radius_session
block|{
name|struct
name|radius_session
modifier|*
name|next
decl_stmt|;
name|struct
name|radius_client
modifier|*
name|client
decl_stmt|;
name|struct
name|radius_server_data
modifier|*
name|server
decl_stmt|;
name|unsigned
name|int
name|sess_id
decl_stmt|;
name|struct
name|eap_sm
modifier|*
name|eap
decl_stmt|;
name|u8
modifier|*
name|eapKeyData
decl_stmt|,
modifier|*
name|eapReqData
decl_stmt|;
name|size_t
name|eapKeyDataLen
decl_stmt|,
name|eapReqDataLen
decl_stmt|;
name|Boolean
name|eapSuccess
decl_stmt|,
name|eapRestart
decl_stmt|,
name|eapFail
decl_stmt|,
name|eapResp
decl_stmt|,
name|eapReq
decl_stmt|,
name|eapNoReq
decl_stmt|;
name|Boolean
name|portEnabled
decl_stmt|,
name|eapTimeout
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|radius_client
block|{
name|struct
name|radius_client
modifier|*
name|next
decl_stmt|;
name|struct
name|in_addr
name|addr
decl_stmt|;
name|struct
name|in_addr
name|mask
decl_stmt|;
name|char
modifier|*
name|shared_secret
decl_stmt|;
name|int
name|shared_secret_len
decl_stmt|;
name|struct
name|radius_session
modifier|*
name|sessions
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|radius_server_data
block|{
name|int
name|auth_sock
decl_stmt|;
name|struct
name|radius_client
modifier|*
name|clients
decl_stmt|;
name|struct
name|radius_server_session
modifier|*
name|sessions
decl_stmt|;
name|unsigned
name|int
name|next_sess_id
decl_stmt|;
name|void
modifier|*
name|hostapd_conf
decl_stmt|;
name|int
name|num_sess
decl_stmt|;
name|void
modifier|*
name|eap_sim_db_priv
decl_stmt|;
name|void
modifier|*
name|ssl_ctx
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|RADIUS_DEBUG
parameter_list|(
name|args
modifier|...
parameter_list|)
define|\
value|wpa_printf(MSG_DEBUG, "RADIUS SRV: " args)
end_define

begin_define
define|#
directive|define
name|RADIUS_ERROR
parameter_list|(
name|args
modifier|...
parameter_list|)
define|\
value|wpa_printf(MSG_ERROR, "RADIUS SRV: " args)
end_define

begin_define
define|#
directive|define
name|RADIUS_DUMP
parameter_list|(
name|args
modifier|...
parameter_list|)
define|\
value|wpa_hexdump(MSG_MSGDUMP, "RADIUS SRV: " args)
end_define

begin_define
define|#
directive|define
name|RADIUS_DUMP_ASCII
parameter_list|(
name|args
modifier|...
parameter_list|)
define|\
value|wpa_hexdump_ascii(MSG_MSGDUMP, "RADIUS SRV: " args)
end_define

begin_function_decl
specifier|static
name|void
name|radius_server_session_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|struct
name|radius_client
modifier|*
name|radius_server_get_client
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|in_addr
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|radius_client
modifier|*
name|client
init|=
name|data
operator|->
name|clients
decl_stmt|;
while|while
condition|(
name|client
condition|)
block|{
if|if
condition|(
operator|(
name|client
operator|->
name|addr
operator|.
name|s_addr
operator|&
name|client
operator|->
name|mask
operator|.
name|s_addr
operator|)
operator|==
operator|(
name|addr
operator|->
name|s_addr
operator|&
name|client
operator|->
name|mask
operator|.
name|s_addr
operator|)
condition|)
block|{
break|break;
block|}
name|client
operator|=
name|client
operator|->
name|next
expr_stmt|;
block|}
return|return
name|client
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radius_session
modifier|*
name|radius_server_get_session
parameter_list|(
name|struct
name|radius_client
modifier|*
name|client
parameter_list|,
name|unsigned
name|int
name|sess_id
parameter_list|)
block|{
name|struct
name|radius_session
modifier|*
name|sess
init|=
name|client
operator|->
name|sessions
decl_stmt|;
while|while
condition|(
name|sess
condition|)
block|{
if|if
condition|(
name|sess
operator|->
name|sess_id
operator|==
name|sess_id
condition|)
block|{
break|break;
block|}
name|sess
operator|=
name|sess
operator|->
name|next
expr_stmt|;
block|}
return|return
name|sess
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radius_server_session_free
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|radius_session
modifier|*
name|sess
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|radius_server_session_timeout
argument_list|,
name|data
argument_list|,
name|sess
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sess
operator|->
name|eapKeyData
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sess
operator|->
name|eapReqData
argument_list|)
expr_stmt|;
name|eap_sm_deinit
argument_list|(
name|sess
operator|->
name|eap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sess
argument_list|)
expr_stmt|;
name|data
operator|->
name|num_sess
operator|--
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radius_server_session_remove
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|radius_session
modifier|*
name|sess
parameter_list|)
block|{
name|struct
name|radius_client
modifier|*
name|client
init|=
name|sess
operator|->
name|client
decl_stmt|;
name|struct
name|radius_session
modifier|*
name|session
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|session
operator|=
name|client
operator|->
name|sessions
expr_stmt|;
while|while
condition|(
name|session
condition|)
block|{
if|if
condition|(
name|session
operator|==
name|sess
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
block|{
name|client
operator|->
name|sessions
operator|=
name|sess
operator|->
name|next
expr_stmt|;
block|}
else|else
block|{
name|prev
operator|->
name|next
operator|=
name|sess
operator|->
name|next
expr_stmt|;
block|}
name|radius_server_session_free
argument_list|(
name|data
argument_list|,
name|sess
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|session
expr_stmt|;
name|session
operator|=
name|session
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radius_server_session_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|radius_server_data
modifier|*
name|data
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|radius_session
modifier|*
name|sess
init|=
name|timeout_ctx
decl_stmt|;
name|RADIUS_DEBUG
argument_list|(
literal|"Timing out authentication session 0x%x"
argument_list|,
name|sess
operator|->
name|sess_id
argument_list|)
expr_stmt|;
name|radius_server_session_remove
argument_list|(
name|data
argument_list|,
name|sess
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radius_session
modifier|*
name|radius_server_new_session
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|radius_client
modifier|*
name|client
parameter_list|)
block|{
name|struct
name|radius_session
modifier|*
name|sess
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|num_sess
operator|>=
name|RADIUS_MAX_SESSION
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Maximum number of existing session - no room "
literal|"for a new session"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|sess
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sess
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|sess
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sess
argument_list|)
argument_list|)
expr_stmt|;
name|sess
operator|->
name|server
operator|=
name|data
expr_stmt|;
name|sess
operator|->
name|client
operator|=
name|client
expr_stmt|;
name|sess
operator|->
name|sess_id
operator|=
name|data
operator|->
name|next_sess_id
operator|++
expr_stmt|;
name|sess
operator|->
name|next
operator|=
name|client
operator|->
name|sessions
expr_stmt|;
name|client
operator|->
name|sessions
operator|=
name|sess
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|RADIUS_SESSION_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|radius_server_session_timeout
argument_list|,
name|data
argument_list|,
name|sess
argument_list|)
expr_stmt|;
name|data
operator|->
name|num_sess
operator|++
expr_stmt|;
return|return
name|sess
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radius_session
modifier|*
name|radius_server_get_new_session
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|radius_client
modifier|*
name|client
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|)
block|{
name|u8
modifier|*
name|user
decl_stmt|;
name|size_t
name|user_len
decl_stmt|;
specifier|const
name|struct
name|hostapd_eap_user
modifier|*
name|eap_user
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|radius_session
modifier|*
name|sess
decl_stmt|;
name|struct
name|eap_config
name|eap_conf
decl_stmt|;
name|RADIUS_DEBUG
argument_list|(
literal|"Creating a new session"
argument_list|)
expr_stmt|;
name|user
operator|=
name|malloc
argument_list|(
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|radius_msg_get_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_USER_NAME
argument_list|,
name|user
argument_list|,
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|||
name|res
operator|>
literal|256
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Could not get User-Name"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|user
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|user_len
operator|=
name|res
expr_stmt|;
name|RADIUS_DUMP_ASCII
argument_list|(
literal|"User-Name"
argument_list|,
name|user
argument_list|,
name|user_len
argument_list|)
expr_stmt|;
name|eap_user
operator|=
name|hostapd_get_eap_user
argument_list|(
name|data
operator|->
name|hostapd_conf
argument_list|,
name|user
argument_list|,
name|user_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_user
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Matching user entry found"
argument_list|)
expr_stmt|;
name|sess
operator|=
name|radius_server_new_session
argument_list|(
name|data
argument_list|,
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess
operator|==
name|NULL
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Failed to create a new session"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"User-Name not found from user database"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|eap_conf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|eap_conf
argument_list|)
argument_list|)
expr_stmt|;
name|eap_conf
operator|.
name|ssl_ctx
operator|=
name|data
operator|->
name|ssl_ctx
expr_stmt|;
name|eap_conf
operator|.
name|eap_sim_db_priv
operator|=
name|data
operator|->
name|eap_sim_db_priv
expr_stmt|;
name|eap_conf
operator|.
name|backend_auth
operator|=
name|TRUE
expr_stmt|;
name|sess
operator|->
name|eap
operator|=
name|eap_sm_init
argument_list|(
name|sess
argument_list|,
operator|&
name|radius_server_eapol_cb
argument_list|,
operator|&
name|eap_conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess
operator|->
name|eap
operator|==
name|NULL
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Failed to initialize EAP state machine for the "
literal|"new session"
argument_list|)
expr_stmt|;
name|radius_server_session_free
argument_list|(
name|data
argument_list|,
name|sess
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|sess
operator|->
name|eapRestart
operator|=
name|TRUE
expr_stmt|;
name|sess
operator|->
name|portEnabled
operator|=
name|TRUE
expr_stmt|;
name|RADIUS_DEBUG
argument_list|(
literal|"New session 0x%x initialized"
argument_list|,
name|sess
operator|->
name|sess_id
argument_list|)
expr_stmt|;
return|return
name|sess
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radius_msg
modifier|*
name|radius_server_encapsulate_eap
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|radius_client
modifier|*
name|client
parameter_list|,
name|struct
name|radius_session
modifier|*
name|sess
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|radius_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|code
decl_stmt|;
name|unsigned
name|int
name|sess_id
decl_stmt|;
if|if
condition|(
name|sess
operator|->
name|eapFail
condition|)
block|{
name|code
operator|=
name|RADIUS_CODE_ACCESS_REJECT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sess
operator|->
name|eapSuccess
condition|)
block|{
name|code
operator|=
name|RADIUS_CODE_ACCESS_ACCEPT
expr_stmt|;
block|}
else|else
block|{
name|code
operator|=
name|RADIUS_CODE_ACCESS_CHALLENGE
expr_stmt|;
block|}
name|msg
operator|=
name|radius_msg_new
argument_list|(
name|code
argument_list|,
name|request
operator|->
name|hdr
operator|->
name|identifier
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|sess_id
operator|=
name|htonl
argument_list|(
name|sess
operator|->
name|sess_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
name|RADIUS_CODE_ACCESS_CHALLENGE
operator|&&
operator|!
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_STATE
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|sess_id
argument_list|,
sizeof|sizeof
argument_list|(
name|sess_id
argument_list|)
argument_list|)
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Failed to add State attribute"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sess
operator|->
name|eapReqData
operator|&&
operator|!
name|radius_msg_add_eap
argument_list|(
name|msg
argument_list|,
name|sess
operator|->
name|eapReqData
argument_list|,
name|sess
operator|->
name|eapReqDataLen
argument_list|)
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Failed to add EAP-Message attribute"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|code
operator|==
name|RADIUS_CODE_ACCESS_ACCEPT
operator|&&
name|sess
operator|->
name|eapKeyData
condition|)
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
name|sess
operator|->
name|eapKeyDataLen
operator|>
literal|64
condition|)
block|{
name|len
operator|=
literal|32
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|sess
operator|->
name|eapKeyDataLen
operator|/
literal|2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|radius_msg_add_mppe_keys
argument_list|(
name|msg
argument_list|,
name|request
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|client
operator|->
name|shared_secret
argument_list|,
name|client
operator|->
name|shared_secret_len
argument_list|,
name|sess
operator|->
name|eapKeyData
operator|+
name|len
argument_list|,
name|len
argument_list|,
name|sess
operator|->
name|eapKeyData
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Failed to add MPPE key attributes"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|radius_msg_finish_srv
argument_list|(
name|msg
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|client
operator|->
name|shared_secret
argument_list|,
name|client
operator|->
name|shared_secret_len
argument_list|,
name|request
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
operator|<
literal|0
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Failed to add Message-Authenticator attribute"
argument_list|)
expr_stmt|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radius_server_reject
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|radius_client
modifier|*
name|client
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|request
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|from
parameter_list|)
block|{
name|struct
name|radius_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|eap_hdr
name|eapfail
decl_stmt|;
name|RADIUS_DEBUG
argument_list|(
literal|"Reject invalid request from %s:%d"
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|->
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|from
operator|->
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|=
name|radius_msg_new
argument_list|(
name|RADIUS_CODE_ACCESS_REJECT
argument_list|,
name|request
operator|->
name|hdr
operator|->
name|identifier
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|eapfail
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|eapfail
argument_list|)
argument_list|)
expr_stmt|;
name|eapfail
operator|.
name|code
operator|=
name|EAP_CODE_FAILURE
expr_stmt|;
name|eapfail
operator|.
name|identifier
operator|=
literal|0
expr_stmt|;
name|eapfail
operator|.
name|length
operator|=
name|htons
argument_list|(
sizeof|sizeof
argument_list|(
name|eapfail
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|radius_msg_add_eap
argument_list|(
name|msg
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|eapfail
argument_list|,
sizeof|sizeof
argument_list|(
name|eapfail
argument_list|)
argument_list|)
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Failed to add EAP-Message attribute"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|radius_msg_finish_srv
argument_list|(
name|msg
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|client
operator|->
name|shared_secret
argument_list|,
name|client
operator|->
name|shared_secret_len
argument_list|,
name|request
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
operator|<
literal|0
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Failed to add Message-Authenticator attribute"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_debug_level
operator|<=
name|MSG_MSGDUMP
condition|)
block|{
name|radius_msg_dump
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sendto
argument_list|(
name|data
operator|->
name|auth_sock
argument_list|,
name|msg
operator|->
name|buf
argument_list|,
name|msg
operator|->
name|buf_used
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto[RADIUS SRV]"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|radius_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radius_server_request
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|from
parameter_list|,
name|struct
name|radius_client
modifier|*
name|client
parameter_list|)
block|{
name|u8
modifier|*
name|eap
init|=
name|NULL
decl_stmt|;
name|size_t
name|eap_len
decl_stmt|;
name|int
name|res
decl_stmt|,
name|state_included
decl_stmt|;
name|u8
name|statebuf
index|[
literal|4
index|]
decl_stmt|,
name|resp_id
decl_stmt|;
name|unsigned
name|int
name|state
decl_stmt|;
name|struct
name|radius_session
modifier|*
name|sess
decl_stmt|;
name|struct
name|radius_msg
modifier|*
name|reply
decl_stmt|;
name|struct
name|eap_hdr
modifier|*
name|hdr
decl_stmt|;
comment|/* TODO: Implement duplicate packet processing */
name|res
operator|=
name|radius_msg_get_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_STATE
argument_list|,
name|statebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|statebuf
argument_list|)
argument_list|)
expr_stmt|;
name|state_included
operator|=
name|res
operator|>=
literal|0
expr_stmt|;
if|if
condition|(
name|res
operator|==
sizeof|sizeof
argument_list|(
name|statebuf
argument_list|)
condition|)
block|{
name|state
operator|=
operator|(
name|statebuf
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|statebuf
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|statebuf
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
name|statebuf
index|[
literal|3
index|]
expr_stmt|;
name|sess
operator|=
name|radius_server_get_session
argument_list|(
name|client
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sess
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sess
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Request for session 0x%x"
argument_list|,
name|sess
operator|->
name|sess_id
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state_included
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"State attribute included but no session found"
argument_list|)
expr_stmt|;
name|radius_server_reject
argument_list|(
name|data
argument_list|,
name|client
argument_list|,
name|msg
argument_list|,
name|from
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|sess
operator|=
name|radius_server_get_new_session
argument_list|(
name|data
argument_list|,
name|client
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess
operator|==
name|NULL
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Could not create a new session"
argument_list|)
expr_stmt|;
name|radius_server_reject
argument_list|(
name|data
argument_list|,
name|client
argument_list|,
name|msg
argument_list|,
name|from
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|eap
operator|=
name|radius_msg_get_eap
argument_list|(
name|msg
argument_list|,
operator|&
name|eap_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"No EAP-Message in RADIUS packet from %s"
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|->
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|RADIUS_DUMP
argument_list|(
literal|"Received EAP data"
argument_list|,
name|eap
argument_list|,
name|eap_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_len
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|hdr
operator|=
operator|(
expr|struct
name|eap_hdr
operator|*
operator|)
name|eap
expr_stmt|;
name|resp_id
operator|=
name|hdr
operator|->
name|identifier
expr_stmt|;
block|}
else|else
block|{
name|resp_id
operator|=
literal|0
expr_stmt|;
block|}
name|eap_set_eapRespData
argument_list|(
name|sess
operator|->
name|eap
argument_list|,
name|eap
argument_list|,
name|eap_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|eap
argument_list|)
expr_stmt|;
name|eap
operator|=
name|NULL
expr_stmt|;
name|sess
operator|->
name|eapResp
operator|=
name|TRUE
expr_stmt|;
name|eap_sm_step
argument_list|(
name|sess
operator|->
name|eap
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess
operator|->
name|eapReqData
condition|)
block|{
name|RADIUS_DUMP
argument_list|(
literal|"EAP data from the state machine"
argument_list|,
name|sess
operator|->
name|eapReqData
argument_list|,
name|sess
operator|->
name|eapReqDataLen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sess
operator|->
name|eapFail
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"No EAP data from the state machine, but eapFail "
literal|"set - generate EAP-Failure"
argument_list|)
expr_stmt|;
name|hdr
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
condition|)
block|{
name|memset
argument_list|(
name|hdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|identifier
operator|=
name|resp_id
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|sess
operator|->
name|eapReqData
operator|=
operator|(
name|u8
operator|*
operator|)
name|hdr
expr_stmt|;
name|sess
operator|->
name|eapReqDataLen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"No EAP data from the state machine - ignore this"
literal|" Access-Request silently (assuming it was a "
literal|"duplicate)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|reply
operator|=
name|radius_server_encapsulate_eap
argument_list|(
name|data
argument_list|,
name|client
argument_list|,
name|sess
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sess
operator|->
name|eapReqData
argument_list|)
expr_stmt|;
name|sess
operator|->
name|eapReqData
operator|=
name|NULL
expr_stmt|;
name|sess
operator|->
name|eapReqDataLen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|reply
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Reply to %s:%d"
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|->
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|from
operator|->
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_debug_level
operator|<=
name|MSG_MSGDUMP
condition|)
block|{
name|radius_msg_dump
argument_list|(
name|reply
argument_list|)
expr_stmt|;
block|}
name|res
operator|=
name|sendto
argument_list|(
name|data
operator|->
name|auth_sock
argument_list|,
name|reply
operator|->
name|buf
argument_list|,
name|reply
operator|->
name|buf_used
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendto[RADIUS SRV]"
argument_list|)
expr_stmt|;
block|}
name|radius_msg_free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sess
operator|->
name|eapSuccess
operator|||
name|sess
operator|->
name|eapFail
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Removing completed session 0x%x"
argument_list|,
name|sess
operator|->
name|sess_id
argument_list|)
expr_stmt|;
name|radius_server_session_remove
argument_list|(
name|data
argument_list|,
name|sess
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radius_server_receive_auth
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|radius_server_data
modifier|*
name|data
init|=
name|eloop_ctx
decl_stmt|;
name|u8
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|struct
name|sockaddr_in
name|from
decl_stmt|;
name|socklen_t
name|fromlen
decl_stmt|;
name|int
name|len
decl_stmt|;
name|struct
name|radius_client
modifier|*
name|client
decl_stmt|;
name|struct
name|radius_msg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|RADIUS_MAX_MSG_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
goto|goto
name|fail
goto|;
block|}
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|len
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
name|RADIUS_MAX_MSG_LEN
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom[radius_server]"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|RADIUS_DEBUG
argument_list|(
literal|"Received %d bytes from %s:%d"
argument_list|,
name|len
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|from
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
name|RADIUS_DUMP
argument_list|(
literal|"Received data"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|client
operator|=
name|radius_server_get_client
argument_list|(
name|data
argument_list|,
operator|&
name|from
operator|.
name|sin_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|==
name|NULL
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Unknown client %s - packet ignored"
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|.
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|msg
operator|=
name|radius_msg_parse
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Parsing incoming RADIUS frame failed"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wpa_debug_level
operator|<=
name|MSG_MSGDUMP
condition|)
block|{
name|radius_msg_dump
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|->
name|hdr
operator|->
name|code
operator|!=
name|RADIUS_CODE_ACCESS_REQUEST
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Unexpected RADIUS code %d"
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|code
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|radius_msg_verify_msg_auth
argument_list|(
name|msg
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|client
operator|->
name|shared_secret
argument_list|,
name|client
operator|->
name|shared_secret_len
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|RADIUS_DEBUG
argument_list|(
literal|"Invalid Message-Authenticator from %s"
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|.
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|radius_server_request
argument_list|(
name|data
argument_list|,
name|msg
argument_list|,
operator|&
name|from
argument_list|,
name|client
argument_list|)
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|msg
condition|)
block|{
name|radius_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radius_server_open_socket
parameter_list|(
name|int
name|port
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radius_server_free_sessions
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|radius_session
modifier|*
name|sessions
parameter_list|)
block|{
name|struct
name|radius_session
modifier|*
name|session
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|session
operator|=
name|sessions
expr_stmt|;
while|while
condition|(
name|session
condition|)
block|{
name|prev
operator|=
name|session
expr_stmt|;
name|session
operator|=
name|session
operator|->
name|next
expr_stmt|;
name|radius_server_session_free
argument_list|(
name|data
argument_list|,
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radius_server_free_clients
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|struct
name|radius_client
modifier|*
name|clients
parameter_list|)
block|{
name|struct
name|radius_client
modifier|*
name|client
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|client
operator|=
name|clients
expr_stmt|;
while|while
condition|(
name|client
condition|)
block|{
name|prev
operator|=
name|client
expr_stmt|;
name|client
operator|=
name|client
operator|->
name|next
expr_stmt|;
name|radius_server_free_sessions
argument_list|(
name|data
argument_list|,
name|prev
operator|->
name|sessions
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|prev
operator|->
name|shared_secret
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|radius_client
modifier|*
name|radius_server_read_clients
parameter_list|(
specifier|const
name|char
modifier|*
name|client_file
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
specifier|const
name|int
name|buf_size
init|=
literal|1024
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|struct
name|radius_client
modifier|*
name|clients
decl_stmt|,
modifier|*
name|tail
decl_stmt|,
modifier|*
name|entry
decl_stmt|;
name|int
name|line
init|=
literal|0
decl_stmt|,
name|mask
decl_stmt|,
name|failed
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|in_addr
name|addr
decl_stmt|;
name|unsigned
name|int
name|val
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|client_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|RADIUS_ERROR
argument_list|(
literal|"Could not open client file '%s'"
argument_list|,
name|client_file
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|buf
operator|=
name|malloc
argument_list|(
name|buf_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|clients
operator|=
name|tail
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
name|buf_size
argument_list|,
name|f
argument_list|)
condition|)
block|{
comment|/* Configuration file format: 		 * 192.168.1.0/24 secret 		 * 192.168.1.2 secret 		 */
name|line
operator|++
expr_stmt|;
name|buf
index|[
name|buf_size
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos
operator|!=
literal|'\n'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|buf
operator|==
literal|'\0'
operator|||
operator|*
name|buf
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|pos
operator|>=
literal|'0'
operator|&&
operator|*
name|pos
operator|<=
literal|'9'
operator|)
operator|||
operator|*
name|pos
operator|==
literal|'.'
condition|)
block|{
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
literal|'/'
condition|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|mask
operator|=
name|strtol
argument_list|(
name|pos
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pos
operator|==
name|end
operator|)
operator|||
operator|(
name|mask
operator|<
literal|0
operator|||
name|mask
operator|>
literal|32
operator|)
condition|)
block|{
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|end
expr_stmt|;
block|}
else|else
block|{
name|mask
operator|=
literal|32
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|inet_aton
argument_list|(
name|buf
argument_list|,
operator|&
name|addr
argument_list|)
operator|==
literal|0
condition|)
block|{
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
operator|||
operator|*
name|pos
operator|==
literal|'\t'
condition|)
block|{
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|entry
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|memset
argument_list|(
name|entry
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|->
name|shared_secret
operator|=
name|strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|shared_secret
operator|==
name|NULL
condition|)
block|{
name|failed
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|entry
argument_list|)
expr_stmt|;
break|break;
block|}
name|entry
operator|->
name|shared_secret_len
operator|=
name|strlen
argument_list|(
name|entry
operator|->
name|shared_secret
argument_list|)
expr_stmt|;
name|entry
operator|->
name|addr
operator|.
name|s_addr
operator|=
name|addr
operator|.
name|s_addr
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mask
condition|;
name|i
operator|++
control|)
name|val
operator||=
literal|1
operator|<<
operator|(
literal|31
operator|-
name|i
operator|)
expr_stmt|;
name|entry
operator|->
name|mask
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|tail
operator|==
name|NULL
condition|)
block|{
name|clients
operator|=
name|tail
operator|=
name|entry
expr_stmt|;
block|}
else|else
block|{
name|tail
operator|->
name|next
operator|=
name|entry
expr_stmt|;
name|tail
operator|=
name|entry
expr_stmt|;
block|}
block|}
if|if
condition|(
name|failed
condition|)
block|{
name|RADIUS_ERROR
argument_list|(
literal|"Invalid line %d in '%s'"
argument_list|,
name|line
argument_list|,
name|client_file
argument_list|)
expr_stmt|;
name|radius_server_free_clients
argument_list|(
name|NULL
argument_list|,
name|clients
argument_list|)
expr_stmt|;
name|clients
operator|=
name|NULL
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|clients
return|;
block|}
end_function

begin_function
name|struct
name|radius_server_data
modifier|*
name|radius_server_init
parameter_list|(
name|struct
name|radius_server_conf
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|radius_server_data
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|hostapd_conf
operator|=
name|conf
operator|->
name|hostapd_conf
expr_stmt|;
name|data
operator|->
name|eap_sim_db_priv
operator|=
name|conf
operator|->
name|eap_sim_db_priv
expr_stmt|;
name|data
operator|->
name|ssl_ctx
operator|=
name|conf
operator|->
name|ssl_ctx
expr_stmt|;
name|data
operator|->
name|clients
operator|=
name|radius_server_read_clients
argument_list|(
name|conf
operator|->
name|client_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|clients
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No RADIUS clients configured.\n"
argument_list|)
expr_stmt|;
name|radius_server_deinit
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|auth_sock
operator|=
name|radius_server_open_socket
argument_list|(
name|conf
operator|->
name|auth_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|auth_sock
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to open UDP socket for RADIUS authentication "
literal|"server\n"
argument_list|)
expr_stmt|;
name|radius_server_deinit
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|eloop_register_read_sock
argument_list|(
name|data
operator|->
name|auth_sock
argument_list|,
name|radius_server_receive_auth
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|radius_server_deinit
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|data
return|;
block|}
end_function

begin_function
name|void
name|radius_server_deinit
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|data
operator|->
name|auth_sock
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|data
operator|->
name|auth_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|data
operator|->
name|auth_sock
argument_list|)
expr_stmt|;
block|}
name|radius_server_free_clients
argument_list|(
name|data
argument_list|,
name|data
operator|->
name|clients
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|radius_server_get_mib
parameter_list|(
name|struct
name|radius_server_data
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
comment|/* TODO: add support for RADIUS authentication server MIB */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|radius_server_get_bool
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|eapol_bool_var
name|variable
parameter_list|)
block|{
name|struct
name|radius_session
modifier|*
name|sess
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|sess
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
switch|switch
condition|(
name|variable
condition|)
block|{
case|case
name|EAPOL_eapSuccess
case|:
return|return
name|sess
operator|->
name|eapSuccess
return|;
case|case
name|EAPOL_eapRestart
case|:
return|return
name|sess
operator|->
name|eapRestart
return|;
case|case
name|EAPOL_eapFail
case|:
return|return
name|sess
operator|->
name|eapFail
return|;
case|case
name|EAPOL_eapResp
case|:
return|return
name|sess
operator|->
name|eapResp
return|;
case|case
name|EAPOL_eapReq
case|:
return|return
name|sess
operator|->
name|eapReq
return|;
case|case
name|EAPOL_eapNoReq
case|:
return|return
name|sess
operator|->
name|eapNoReq
return|;
case|case
name|EAPOL_portEnabled
case|:
return|return
name|sess
operator|->
name|portEnabled
return|;
case|case
name|EAPOL_eapTimeout
case|:
return|return
name|sess
operator|->
name|eapTimeout
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radius_server_set_bool
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|eapol_bool_var
name|variable
parameter_list|,
name|Boolean
name|value
parameter_list|)
block|{
name|struct
name|radius_session
modifier|*
name|sess
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|sess
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|variable
condition|)
block|{
case|case
name|EAPOL_eapSuccess
case|:
name|sess
operator|->
name|eapSuccess
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapRestart
case|:
name|sess
operator|->
name|eapRestart
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapFail
case|:
name|sess
operator|->
name|eapFail
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapResp
case|:
name|sess
operator|->
name|eapResp
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapReq
case|:
name|sess
operator|->
name|eapReq
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapNoReq
case|:
name|sess
operator|->
name|eapNoReq
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_portEnabled
case|:
name|sess
operator|->
name|portEnabled
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|EAPOL_eapTimeout
case|:
name|sess
operator|->
name|eapTimeout
operator|=
name|value
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radius_server_set_eapReqData
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|eapReqData
parameter_list|,
name|size_t
name|eapReqDataLen
parameter_list|)
block|{
name|struct
name|radius_session
modifier|*
name|sess
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|sess
operator|==
name|NULL
condition|)
return|return;
name|free
argument_list|(
name|sess
operator|->
name|eapReqData
argument_list|)
expr_stmt|;
name|sess
operator|->
name|eapReqData
operator|=
name|malloc
argument_list|(
name|eapReqDataLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess
operator|->
name|eapReqData
condition|)
block|{
name|memcpy
argument_list|(
name|sess
operator|->
name|eapReqData
argument_list|,
name|eapReqData
argument_list|,
name|eapReqDataLen
argument_list|)
expr_stmt|;
name|sess
operator|->
name|eapReqDataLen
operator|=
name|eapReqDataLen
expr_stmt|;
block|}
else|else
block|{
name|sess
operator|->
name|eapReqDataLen
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radius_server_set_eapKeyData
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|eapKeyData
parameter_list|,
name|size_t
name|eapKeyDataLen
parameter_list|)
block|{
name|struct
name|radius_session
modifier|*
name|sess
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|sess
operator|==
name|NULL
condition|)
return|return;
name|free
argument_list|(
name|sess
operator|->
name|eapKeyData
argument_list|)
expr_stmt|;
if|if
condition|(
name|eapKeyData
condition|)
block|{
name|sess
operator|->
name|eapKeyData
operator|=
name|malloc
argument_list|(
name|eapKeyDataLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess
operator|->
name|eapKeyData
condition|)
block|{
name|memcpy
argument_list|(
name|sess
operator|->
name|eapKeyData
argument_list|,
name|eapKeyData
argument_list|,
name|eapKeyDataLen
argument_list|)
expr_stmt|;
name|sess
operator|->
name|eapKeyDataLen
operator|=
name|eapKeyDataLen
expr_stmt|;
block|}
else|else
block|{
name|sess
operator|->
name|eapKeyDataLen
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|sess
operator|->
name|eapKeyData
operator|=
name|NULL
expr_stmt|;
name|sess
operator|->
name|eapKeyDataLen
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|radius_server_get_eap_user
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|identity
parameter_list|,
name|size_t
name|identity_len
parameter_list|,
name|int
name|phase2
parameter_list|,
name|struct
name|eap_user
modifier|*
name|user
parameter_list|)
block|{
name|struct
name|radius_session
modifier|*
name|sess
init|=
name|ctx
decl_stmt|;
specifier|const
name|struct
name|hostapd_eap_user
modifier|*
name|eap_user
decl_stmt|;
name|eap_user
operator|=
name|hostapd_get_eap_user
argument_list|(
name|sess
operator|->
name|server
operator|->
name|hostapd_conf
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|,
name|phase2
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_user
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|user
operator|->
name|methods
argument_list|,
name|eap_user
operator|->
name|methods
argument_list|,
name|EAP_USER_MAX_METHODS
operator|>
name|EAP_MAX_METHODS
condition|?
name|EAP_USER_MAX_METHODS
else|:
name|EAP_MAX_METHODS
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_user
operator|->
name|password
condition|)
block|{
name|user
operator|->
name|password
operator|=
name|malloc
argument_list|(
name|eap_user
operator|->
name|password_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|->
name|password
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|user
operator|->
name|password
argument_list|,
name|eap_user
operator|->
name|password
argument_list|,
name|eap_user
operator|->
name|password_len
argument_list|)
expr_stmt|;
name|user
operator|->
name|password_len
operator|=
name|eap_user
operator|->
name|password_len
expr_stmt|;
block|}
name|user
operator|->
name|force_version
operator|=
name|eap_user
operator|->
name|force_version
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|eapol_callbacks
name|radius_server_eapol_cb
init|=
block|{
operator|.
name|get_bool
operator|=
name|radius_server_get_bool
block|,
operator|.
name|set_bool
operator|=
name|radius_server_set_bool
block|,
operator|.
name|set_eapReqData
operator|=
name|radius_server_set_eapReqData
block|,
operator|.
name|set_eapKeyData
operator|=
name|radius_server_set_eapKeyData
block|,
operator|.
name|get_eap_user
operator|=
name|radius_server_get_eap_user
block|, }
decl_stmt|;
end_decl_stmt

end_unit


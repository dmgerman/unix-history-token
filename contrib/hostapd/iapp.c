begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / IEEE 802.11F-2003 Inter-Access Point Protocol (IAPP)  * Copyright (c) 2002-2007, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * Note: IEEE 802.11F-2003 was a experimental use specification. It has expired  * and IEEE has withdrawn it. In other words, it is likely better to look at  * using some other mechanism for AP-to-AP communication than extenting the  * implementation here.  */
end_comment

begin_comment
comment|/* TODO:  * Level 1: no administrative or security support  *	(e.g., static BSSID to IP address mapping in each AP)  * Level 2: support for dynamic mapping of BSSID to IP address  * Level 3: support for encryption and authentication of IAPP messages  * - add support for MOVE-notify and MOVE-response (this requires support for  *   finding out IP address for previous AP using RADIUS)  * - add support for Send- and ACK-Security-Block to speedup IEEE 802.1X during  *   reassociation to another AP  * - implement counters etc. for IAPP MIB  * - verify endianness of fields in IAPP messages; are they big-endian as  *   used here?  * - RADIUS connection for AP registration and BSSID to IP address mapping  * - TCP connection for IAPP MOVE, CACHE  * - broadcast ESP for IAPP ADD-notify  * - ESP for IAPP MOVE messages  * - security block sending/processing  * - IEEE 802.11 context transfer  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|USE_KERNEL_HEADERS
end_ifdef

begin_include
include|#
directive|include
file|<linux/if_packet.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* USE_KERNEL_HEADERS */
end_comment

begin_include
include|#
directive|include
file|<netpacket/packet.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USE_KERNEL_HEADERS */
end_comment

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"iapp.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_define
define|#
directive|define
name|IAPP_MULTICAST
value|"224.0.1.178"
end_define

begin_define
define|#
directive|define
name|IAPP_UDP_PORT
value|3517
end_define

begin_define
define|#
directive|define
name|IAPP_TCP_PORT
value|3517
end_define

begin_struct
struct|struct
name|iapp_hdr
block|{
name|u8
name|version
decl_stmt|;
name|u8
name|command
decl_stmt|;
name|u16
name|identifier
decl_stmt|;
name|u16
name|length
decl_stmt|;
comment|/* followed by length-6 octets of data */
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_define
define|#
directive|define
name|IAPP_VERSION
value|0
end_define

begin_enum
enum|enum
name|IAPP_COMMAND
block|{
name|IAPP_CMD_ADD_notify
init|=
literal|0
block|,
name|IAPP_CMD_MOVE_notify
init|=
literal|1
block|,
name|IAPP_CMD_MOVE_response
init|=
literal|2
block|,
name|IAPP_CMD_Send_Security_Block
init|=
literal|3
block|,
name|IAPP_CMD_ACK_Security_Block
init|=
literal|4
block|,
name|IAPP_CMD_CACHE_notify
init|=
literal|5
block|,
name|IAPP_CMD_CACHE_response
init|=
literal|6
block|, }
enum|;
end_enum

begin_comment
comment|/* ADD-notify - multicast UDP on the local LAN */
end_comment

begin_struct
struct|struct
name|iapp_add_notify
block|{
name|u8
name|addr_len
decl_stmt|;
comment|/* ETH_ALEN */
name|u8
name|reserved
decl_stmt|;
name|u8
name|mac_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u16
name|seq_num
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_comment
comment|/* Layer 2 Update frame (802.2 Type 1 LLC XID Update response) */
end_comment

begin_struct
struct|struct
name|iapp_layer2_update
block|{
name|u8
name|da
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* broadcast */
name|u8
name|sa
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* STA addr */
name|u16
name|len
decl_stmt|;
comment|/* 6 */
name|u8
name|dsap
decl_stmt|;
comment|/* null DSAP address */
name|u8
name|ssap
decl_stmt|;
comment|/* null SSAP address, CR=Response */
name|u8
name|control
decl_stmt|;
name|u8
name|xid_info
index|[
literal|3
index|]
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_comment
comment|/* MOVE-notify - unicast TCP */
end_comment

begin_struct
struct|struct
name|iapp_move_notify
block|{
name|u8
name|addr_len
decl_stmt|;
comment|/* ETH_ALEN */
name|u8
name|reserved
decl_stmt|;
name|u8
name|mac_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u16
name|seq_num
decl_stmt|;
name|u16
name|ctx_block_len
decl_stmt|;
comment|/* followed by ctx_block_len bytes */
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_comment
comment|/* MOVE-response - unicast TCP */
end_comment

begin_struct
struct|struct
name|iapp_move_response
block|{
name|u8
name|addr_len
decl_stmt|;
comment|/* ETH_ALEN */
name|u8
name|status
decl_stmt|;
name|u8
name|mac_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u16
name|seq_num
decl_stmt|;
name|u16
name|ctx_block_len
decl_stmt|;
comment|/* followed by ctx_block_len bytes */
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_enum
enum|enum
block|{
name|IAPP_MOVE_SUCCESSFUL
init|=
literal|0
block|,
name|IAPP_MOVE_DENIED
init|=
literal|1
block|,
name|IAPP_MOVE_STALE_MOVE
init|=
literal|2
block|, }
enum|;
end_enum

begin_comment
comment|/* CACHE-notify */
end_comment

begin_struct
struct|struct
name|iapp_cache_notify
block|{
name|u8
name|addr_len
decl_stmt|;
comment|/* ETH_ALEN */
name|u8
name|reserved
decl_stmt|;
name|u8
name|mac_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u16
name|seq_num
decl_stmt|;
name|u8
name|current_ap
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u16
name|ctx_block_len
decl_stmt|;
comment|/* ctx_block_len bytes of context block followed by 16-bit context 	 * timeout */
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_comment
comment|/* CACHE-response - unicast TCP */
end_comment

begin_struct
struct|struct
name|iapp_cache_response
block|{
name|u8
name|addr_len
decl_stmt|;
comment|/* ETH_ALEN */
name|u8
name|status
decl_stmt|;
name|u8
name|mac_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u16
name|seq_num
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_enum
enum|enum
block|{
name|IAPP_CACHE_SUCCESSFUL
init|=
literal|0
block|,
name|IAPP_CACHE_STALE_CACHE
init|=
literal|1
block|, }
enum|;
end_enum

begin_comment
comment|/* Send-Security-Block - unicast TCP */
end_comment

begin_struct
struct|struct
name|iapp_send_security_block
block|{
name|u8
name|iv
index|[
literal|8
index|]
decl_stmt|;
name|u16
name|sec_block_len
decl_stmt|;
comment|/* followed by sec_block_len bytes of security block */
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_comment
comment|/* ACK-Security-Block - unicast TCP */
end_comment

begin_struct
struct|struct
name|iapp_ack_security_block
block|{
name|u8
name|iv
index|[
literal|8
index|]
decl_stmt|;
name|u8
name|new_ap_ack_authenticator
index|[
literal|48
index|]
decl_stmt|;
block|}
name|__attribute__
argument_list|(
operator|(
name|packed
operator|)
argument_list|)
struct|;
end_struct

begin_struct
struct|struct
name|iapp_data
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|u16
name|identifier
decl_stmt|;
comment|/* next IAPP identifier */
name|struct
name|in_addr
name|own
decl_stmt|,
name|multicast
decl_stmt|;
name|int
name|udp_sock
decl_stmt|;
name|int
name|packet_sock
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|iapp_send_add
parameter_list|(
name|struct
name|iapp_data
modifier|*
name|iapp
parameter_list|,
name|u8
modifier|*
name|mac_addr
parameter_list|,
name|u16
name|seq_num
parameter_list|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|iapp_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|iapp_add_notify
modifier|*
name|add
decl_stmt|;
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
comment|/* Send IAPP ADD-notify to remove possible association from other APs 	 */
name|hdr
operator|=
operator|(
expr|struct
name|iapp_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|hdr
operator|->
name|version
operator|=
name|IAPP_VERSION
expr_stmt|;
name|hdr
operator|->
name|command
operator|=
name|IAPP_CMD_ADD_notify
expr_stmt|;
name|hdr
operator|->
name|identifier
operator|=
name|host_to_be16
argument_list|(
name|iapp
operator|->
name|identifier
operator|++
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|add
argument_list|)
argument_list|)
expr_stmt|;
name|add
operator|=
operator|(
expr|struct
name|iapp_add_notify
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|add
operator|->
name|addr_len
operator|=
name|ETH_ALEN
expr_stmt|;
name|add
operator|->
name|reserved
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|add
operator|->
name|mac_addr
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|add
operator|->
name|seq_num
operator|=
name|host_to_be16
argument_list|(
name|seq_num
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|iapp
operator|->
name|multicast
operator|.
name|s_addr
expr_stmt|;
name|addr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|IAPP_UDP_PORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendto
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|,
name|buf
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
name|add
operator|+
literal|1
operator|)
operator|-
name|buf
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"sendto[IAPP-ADD]"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|iapp_send_layer2_update
parameter_list|(
name|struct
name|iapp_data
modifier|*
name|iapp
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|iapp_layer2_update
name|msg
decl_stmt|;
comment|/* Send Level 2 Update Frame to update forwarding tables in layer 2 	 * bridge devices */
comment|/* 802.2 Type 1 Logical Link Control (LLC) Exchange Identifier (XID) 	 * Update response frame; IEEE Std 802.2-1998, 5.4.1.2.1 */
name|memset
argument_list|(
name|msg
operator|.
name|da
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|sa
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|msg
operator|.
name|len
operator|=
name|host_to_be16
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|msg
operator|.
name|dsap
operator|=
literal|0
expr_stmt|;
comment|/* NULL DSAP address */
name|msg
operator|.
name|ssap
operator|=
literal|0x01
expr_stmt|;
comment|/* NULL SSAP address, CR Bit: Response */
name|msg
operator|.
name|control
operator|=
literal|0xaf
expr_stmt|;
comment|/* XID response lsb.1111F101. 			     * F=0 (no poll command; unsolicited frame) */
name|msg
operator|.
name|xid_info
index|[
literal|0
index|]
operator|=
literal|0x81
expr_stmt|;
comment|/* XID format identifier */
name|msg
operator|.
name|xid_info
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
comment|/* LLC types/classes: Type 1 LLC */
name|msg
operator|.
name|xid_info
index|[
literal|2
index|]
operator|=
literal|1
operator|<<
literal|1
expr_stmt|;
comment|/* XID sender's receive window size (RW) 				   * FIX: what is correct RW with 802.11? */
if|if
condition|(
name|send
argument_list|(
name|iapp
operator|->
name|packet_sock
argument_list|,
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"send[L2 Update]"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|iapp_new_station
parameter_list|(
name|struct
name|iapp_data
modifier|*
name|iapp
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|assoc
decl_stmt|;
name|u16
name|seq
decl_stmt|;
if|if
condition|(
name|iapp
operator|==
name|NULL
condition|)
return|return;
name|assoc
operator|=
name|sta
operator|->
name|last_assoc_req
expr_stmt|;
name|seq
operator|=
name|assoc
condition|?
name|WLAN_GET_SEQ_SEQ
argument_list|(
name|le_to_host16
argument_list|(
name|assoc
operator|->
name|seq_ctrl
argument_list|)
argument_list|)
else|:
literal|0
expr_stmt|;
comment|/* IAPP-ADD.request(MAC Address, Sequence Number, Timeout) */
name|hostapd_logger
argument_list|(
name|iapp
operator|->
name|hapd
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|HOSTAPD_MODULE_IAPP
argument_list|,
name|HOSTAPD_LEVEL_DEBUG
argument_list|,
literal|"IAPP-ADD.request(seq=%d)"
argument_list|,
name|seq
argument_list|)
expr_stmt|;
name|iapp_send_layer2_update
argument_list|(
name|iapp
argument_list|,
name|sta
operator|->
name|addr
argument_list|)
expr_stmt|;
name|iapp_send_add
argument_list|(
name|iapp
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|seq
argument_list|)
expr_stmt|;
if|if
condition|(
name|assoc
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|le_to_host16
argument_list|(
name|assoc
operator|->
name|frame_control
argument_list|)
argument_list|)
operator|==
name|WLAN_FC_STYPE_REASSOC_REQ
condition|)
block|{
comment|/* IAPP-MOVE.request(MAC Address, Sequence Number, Old AP, 		 *                   Context Block, Timeout) 		 */
comment|/* TODO: Send IAPP-MOVE to the old AP; Map Old AP BSSID to 		 * IP address */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|iapp_process_add_notify
parameter_list|(
name|struct
name|iapp_data
modifier|*
name|iapp
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|from
parameter_list|,
name|struct
name|iapp_hdr
modifier|*
name|hdr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|iapp_add_notify
modifier|*
name|add
init|=
operator|(
expr|struct
name|iapp_add_notify
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|add
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid IAPP-ADD packet length %d (expected %lu)\n"
argument_list|,
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|add
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|iapp
operator|->
name|hapd
argument_list|,
name|add
operator|->
name|mac_addr
argument_list|)
expr_stmt|;
comment|/* IAPP-ADD.indication(MAC Address, Sequence Number) */
name|hostapd_logger
argument_list|(
name|iapp
operator|->
name|hapd
argument_list|,
name|add
operator|->
name|mac_addr
argument_list|,
name|HOSTAPD_MODULE_IAPP
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"Received IAPP ADD-notify (seq# %d) from %s:%d%s"
argument_list|,
name|be_to_host16
argument_list|(
name|add
operator|->
name|seq_num
argument_list|)
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|->
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|from
operator|->
name|sin_port
argument_list|)
argument_list|,
name|sta
condition|?
literal|""
else|:
literal|" (STA not found)"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
return|return;
comment|/* TODO: could use seq_num to try to determine whether last association 	 * to this AP is newer than the one advertised in IAPP-ADD. Although, 	 * this is not really a reliable verification. */
name|hostapd_logger
argument_list|(
name|iapp
operator|->
name|hapd
argument_list|,
name|add
operator|->
name|mac_addr
argument_list|,
name|HOSTAPD_MODULE_IAPP
argument_list|,
name|HOSTAPD_LEVEL_DEBUG
argument_list|,
literal|"Removing STA due to IAPP ADD-notify"
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator|&=
operator|~
operator|(
name|WLAN_STA_AUTH
operator||
name|WLAN_STA_ASSOC
operator||
name|WLAN_STA_AUTHORIZED
operator|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|ap_handle_timer
argument_list|,
name|iapp
operator|->
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|ap_handle_timer
argument_list|,
name|iapp
operator|->
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|sta
operator|->
name|timeout_next
operator|=
name|STA_REMOVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|iapp_receive_udp
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|iapp_data
modifier|*
name|iapp
init|=
name|eloop_ctx
decl_stmt|;
name|int
name|len
decl_stmt|,
name|hlen
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|sockaddr_in
name|from
decl_stmt|;
name|socklen_t
name|fromlen
decl_stmt|;
name|struct
name|iapp_hdr
modifier|*
name|hdr
decl_stmt|;
comment|/* Handle incoming IAPP frames (over UDP/IP) */
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|len
operator|=
name|recvfrom
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|from
operator|.
name|sin_addr
operator|.
name|s_addr
operator|==
name|iapp
operator|->
name|own
operator|.
name|s_addr
condition|)
return|return;
comment|/* ignore own IAPP messages */
name|hostapd_logger
argument_list|(
name|iapp
operator|->
name|hapd
argument_list|,
name|NULL
argument_list|,
name|HOSTAPD_MODULE_IAPP
argument_list|,
name|HOSTAPD_LEVEL_DEBUG
argument_list|,
literal|"Received %d byte IAPP frame from %s%s\n"
argument_list|,
name|len
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|len
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|?
literal|" (too short)"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
return|return;
name|hdr
operator|=
operator|(
expr|struct
name|iapp_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|hlen
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
name|hostapd_logger
argument_list|(
name|iapp
operator|->
name|hapd
argument_list|,
name|NULL
argument_list|,
name|HOSTAPD_MODULE_IAPP
argument_list|,
name|HOSTAPD_LEVEL_DEBUG
argument_list|,
literal|"RX: version=%d command=%d id=%d len=%d\n"
argument_list|,
name|hdr
operator|->
name|version
argument_list|,
name|hdr
operator|->
name|command
argument_list|,
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|identifier
argument_list|)
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|version
operator|!=
name|IAPP_VERSION
condition|)
block|{
name|printf
argument_list|(
literal|"Dropping IAPP frame with unknown version %d\n"
argument_list|,
name|hdr
operator|->
name|version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|hlen
operator|>
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"Underflow IAPP frame (hlen=%d len=%d)\n"
argument_list|,
name|hlen
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|hlen
operator|<
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"Ignoring %d extra bytes from IAPP frame\n"
argument_list|,
name|len
operator|-
name|hlen
argument_list|)
expr_stmt|;
name|len
operator|=
name|hlen
expr_stmt|;
block|}
switch|switch
condition|(
name|hdr
operator|->
name|command
condition|)
block|{
case|case
name|IAPP_CMD_ADD_notify
case|:
name|iapp_process_add_notify
argument_list|(
name|iapp
argument_list|,
operator|&
name|from
argument_list|,
name|hdr
argument_list|,
name|hlen
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IAPP_CMD_MOVE_notify
case|:
comment|/* TODO: MOVE is using TCP; so move this to TCP handler once it 		 * is implemented.. */
comment|/* IAPP-MOVE.indication(MAC Address, New BSSID, 		 * Sequence Number, AP Address, Context Block) */
comment|/* TODO: process */
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown IAPP command %d\n"
argument_list|,
name|hdr
operator|->
name|command
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|struct
name|iapp_data
modifier|*
name|iapp_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|iface
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|struct
name|sockaddr_ll
name|addr
decl_stmt|;
name|int
name|ifindex
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|paddr
decl_stmt|,
name|uaddr
decl_stmt|;
name|struct
name|iapp_data
modifier|*
name|iapp
decl_stmt|;
name|struct
name|ip_mreqn
name|mreq
decl_stmt|;
name|iapp
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|iapp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iapp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|iapp
operator|->
name|hapd
operator|=
name|hapd
expr_stmt|;
name|iapp
operator|->
name|udp_sock
operator|=
name|iapp
operator|->
name|packet_sock
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* TODO: 	 * open socket for sending and receiving IAPP frames over TCP 	 */
name|iapp
operator|->
name|udp_sock
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iapp
operator|->
name|udp_sock
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[PF_INET,SOCK_DGRAM]"
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|iface
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|,
name|SIOCGIFINDEX
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGIFINDEX)"
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ifindex
operator|=
name|ifr
operator|.
name|ifr_ifindex
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|,
name|SIOCGIFADDR
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGIFADDR)"
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|paddr
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|ifr
operator|.
name|ifr_addr
expr_stmt|;
if|if
condition|(
name|paddr
operator|->
name|sin_family
operator|!=
name|AF_INET
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid address family %i (SIOCGIFADDR)\n"
argument_list|,
name|paddr
operator|->
name|sin_family
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|iapp
operator|->
name|own
operator|.
name|s_addr
operator|=
name|paddr
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|,
name|SIOCGIFBRDADDR
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGIFBRDADDR)"
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|paddr
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|ifr
operator|.
name|ifr_addr
expr_stmt|;
if|if
condition|(
name|paddr
operator|->
name|sin_family
operator|!=
name|AF_INET
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid address family %i (SIOCGIFBRDADDR)\n"
argument_list|,
name|paddr
operator|->
name|sin_family
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|inet_aton
argument_list|(
name|IAPP_MULTICAST
argument_list|,
operator|&
name|iapp
operator|->
name|multicast
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|uaddr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|uaddr
argument_list|)
argument_list|)
expr_stmt|;
name|uaddr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|uaddr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|IAPP_UDP_PORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|uaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|uaddr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind[UDP]"
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|mreq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
expr_stmt|;
name|mreq
operator|.
name|imr_multiaddr
operator|=
name|iapp
operator|->
name|multicast
expr_stmt|;
name|mreq
operator|.
name|imr_address
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|mreq
operator|.
name|imr_ifindex
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|,
name|SOL_IP
argument_list|,
name|IP_ADD_MEMBERSHIP
argument_list|,
operator|&
name|mreq
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"setsockopt[UDP,IP_ADD_MEMBERSHIP]"
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|iapp
operator|->
name|packet_sock
operator|=
name|socket
argument_list|(
name|PF_PACKET
argument_list|,
name|SOCK_RAW
argument_list|,
name|htons
argument_list|(
name|ETH_P_ALL
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iapp
operator|->
name|packet_sock
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[PF_PACKET,SOCK_RAW]"
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sll_family
operator|=
name|AF_PACKET
expr_stmt|;
name|addr
operator|.
name|sll_ifindex
operator|=
name|ifindex
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|iapp
operator|->
name|packet_sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind[PACKET]"
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|eloop_register_read_sock
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|,
name|iapp_receive_udp
argument_list|,
name|iapp
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Could not register read socket for IAPP.\n"
argument_list|)
expr_stmt|;
name|iapp_deinit
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|printf
argument_list|(
literal|"IEEE 802.11F (IAPP) using interface %s\n"
argument_list|,
name|iface
argument_list|)
expr_stmt|;
comment|/* TODO: For levels 2 and 3: send RADIUS Initiate-Request, receive 	 * RADIUS Initiate-Accept or Initiate-Reject. IAPP port should actually 	 * be openned only after receiving Initiate-Accept. If Initiate-Reject 	 * is received, IAPP is not started. */
return|return
name|iapp
return|;
block|}
end_function

begin_function
name|void
name|iapp_deinit
parameter_list|(
name|struct
name|iapp_data
modifier|*
name|iapp
parameter_list|)
block|{
name|struct
name|ip_mreqn
name|mreq
decl_stmt|;
if|if
condition|(
name|iapp
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|iapp
operator|->
name|udp_sock
operator|>=
literal|0
condition|)
block|{
name|memset
argument_list|(
operator|&
name|mreq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
expr_stmt|;
name|mreq
operator|.
name|imr_multiaddr
operator|=
name|iapp
operator|->
name|multicast
expr_stmt|;
name|mreq
operator|.
name|imr_address
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|mreq
operator|.
name|imr_ifindex
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|,
name|SOL_IP
argument_list|,
name|IP_DROP_MEMBERSHIP
argument_list|,
operator|&
name|mreq
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"setsockopt[UDP,IP_DEL_MEMBERSHIP]"
argument_list|)
expr_stmt|;
block|}
name|eloop_unregister_read_sock
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|iapp
operator|->
name|udp_sock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iapp
operator|->
name|packet_sock
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|iapp
operator|->
name|packet_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|iapp
operator|->
name|packet_sock
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|iapp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|iapp_reconfig
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_config
modifier|*
name|oldconf
parameter_list|,
name|struct
name|hostapd_bss_config
modifier|*
name|oldbss
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ieee802_11f
operator|!=
name|oldbss
operator|->
name|ieee802_11f
operator|||
name|strcmp
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|iapp_iface
argument_list|,
name|oldbss
operator|->
name|iapp_iface
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|iapp_deinit
argument_list|(
name|hapd
operator|->
name|iapp
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|iapp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ieee802_11f
condition|)
block|{
name|hapd
operator|->
name|iapp
operator|=
name|iapp_init
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iapp_iface
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iapp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


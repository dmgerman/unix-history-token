begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / Configuration reloading  * Copyright (c) 2002-2007, Jouni Malinen<j@w1.fi>  * Copyright (c) 2002-2004, Instant802 Networks, Inc.  * Copyright (c) 2005-2006, Devicescape Software, Inc.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"beacon.h"
end_include

begin_include
include|#
directive|include
file|"hw_features.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"radius_client.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"iapp.h"
end_include

begin_include
include|#
directive|include
file|"ap_list.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"vlan_init.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_auth.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x.h"
end_include

begin_include
include|#
directive|include
file|"accounting.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_comment
comment|/**  * struct hostapd_config_change - Configuration change information  * This is for two purposes:  * - Storing configuration information in the hostapd_iface during  *   the asynchronous parts of reconfiguration.  * - Passing configuration information for per-station reconfiguration.  */
end_comment

begin_struct
struct|struct
name|hostapd_config_change
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|newconf
decl_stmt|,
modifier|*
name|oldconf
decl_stmt|;
name|struct
name|hostapd_bss_config
modifier|*
name|newbss
decl_stmt|,
modifier|*
name|oldbss
decl_stmt|;
name|int
name|mac_acl_changed
decl_stmt|;
name|int
name|num_sta_remove
decl_stmt|;
comment|/* number of STAs that need to be removed */
name|int
name|beacon_changed
decl_stmt|;
name|struct
name|hostapd_iface
modifier|*
name|hapd_iface
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
modifier|*
name|new_hapd
decl_stmt|,
modifier|*
modifier|*
name|old_hapd
decl_stmt|;
name|int
name|num_old_hapd
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|hostapd_config_reload_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|hostapd_config_change
modifier|*
name|change
init|=
name|data
decl_stmt|;
name|struct
name|hostapd_bss_config
modifier|*
name|newbss
decl_stmt|,
modifier|*
name|oldbss
decl_stmt|;
name|int
name|deauth
init|=
literal|0
decl_stmt|;
name|u8
name|reason
init|=
name|WLAN_REASON_PREV_AUTH_NOT_VALID
decl_stmt|;
name|newbss
operator|=
name|change
operator|->
name|newbss
expr_stmt|;
name|oldbss
operator|=
name|change
operator|->
name|oldbss
expr_stmt|;
name|hapd
operator|=
name|change
operator|->
name|hapd
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|ssid
operator|==
operator|&
name|oldbss
operator|->
name|ssid
condition|)
block|{
name|sta
operator|->
name|ssid
operator|=
operator|&
name|newbss
operator|->
name|ssid
expr_stmt|;
if|if
condition|(
name|newbss
operator|->
name|ssid
operator|.
name|ssid_len
operator|!=
name|oldbss
operator|->
name|ssid
operator|.
name|ssid_len
operator|||
name|memcmp
argument_list|(
name|newbss
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|oldbss
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|newbss
operator|->
name|ssid
operator|.
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* main SSID was changed - kick STA out */
name|deauth
operator|++
expr_stmt|;
block|}
block|}
name|sta
operator|->
name|ssid_probe
operator|=
name|sta
operator|->
name|ssid
expr_stmt|;
comment|/* 	 * If MAC ACL configuration has changed, deauthenticate stations that 	 * have been removed from accepted list or have been added to denied 	 * list. If external RADIUS server is used for ACL, all stations are 	 * deauthenticated and they will need to authenticate again. This 	 * limits sudden load on the RADIUS server since the verification will 	 * be done over the time needed for the STAs to reauthenticate 	 * themselves. 	 */
if|if
condition|(
name|change
operator|->
name|mac_acl_changed
operator|&&
operator|(
name|newbss
operator|->
name|macaddr_acl
operator|==
name|USE_EXTERNAL_RADIUS_AUTH
operator|||
operator|!
name|hostapd_allowed_address
argument_list|(
name|hapd
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
name|deauth
operator|++
expr_stmt|;
if|if
condition|(
name|newbss
operator|->
name|ieee802_1x
operator|!=
name|oldbss
operator|->
name|ieee802_1x
operator|&&
name|sta
operator|->
name|ssid
operator|==
operator|&
name|hapd
operator|->
name|conf
operator|->
name|ssid
condition|)
name|deauth
operator|++
expr_stmt|;
if|if
condition|(
name|newbss
operator|->
name|wpa
operator|!=
name|oldbss
operator|->
name|wpa
condition|)
name|deauth
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|newbss
operator|->
name|wme_enabled
operator|&&
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_WME
operator|)
condition|)
name|deauth
operator|++
expr_stmt|;
if|if
condition|(
name|newbss
operator|->
name|auth_algs
operator|!=
name|oldbss
operator|->
name|auth_algs
operator|&&
operator|(
operator|(
name|sta
operator|->
name|auth_alg
operator|==
name|WLAN_AUTH_OPEN
operator|&&
operator|!
operator|(
name|newbss
operator|->
name|auth_algs
operator|&
name|HOSTAPD_AUTH_OPEN
operator|)
operator|)
operator|||
operator|(
name|sta
operator|->
name|auth_alg
operator|==
name|WLAN_AUTH_SHARED_KEY
operator|&&
operator|!
operator|(
name|newbss
operator|->
name|auth_algs
operator|&
name|HOSTAPD_AUTH_SHARED_KEY
operator|)
operator|)
operator|)
condition|)
name|deauth
operator|++
expr_stmt|;
if|if
condition|(
name|change
operator|->
name|num_sta_remove
operator|>
literal|0
condition|)
block|{
name|deauth
operator|++
expr_stmt|;
name|reason
operator|=
name|WLAN_REASON_DISASSOC_AP_BUSY
expr_stmt|;
block|}
if|if
condition|(
name|deauth
condition|)
block|{
name|HOSTAPD_DEBUG
argument_list|(
name|HOSTAPD_DEBUG_MINIMAL
argument_list|,
literal|"STA "
name|MACSTR
literal|" deauthenticated during config reloading "
literal|"(reason=%d)\n"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|ieee802_11_send_deauth
argument_list|(
name|hapd
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|ap_sta_deauthenticate
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|change
operator|->
name|num_sta_remove
operator|--
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_reconfig_tx_queue_params
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_config
modifier|*
name|newconf
parameter_list|,
name|struct
name|hostapd_config
modifier|*
name|oldconf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|hostapd_tx_queue_params
modifier|*
name|o
decl_stmt|,
modifier|*
name|n
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_TX_QUEUES
condition|;
name|i
operator|++
control|)
block|{
name|o
operator|=
operator|&
name|oldconf
operator|->
name|tx_queue
index|[
name|i
index|]
expr_stmt|;
name|n
operator|=
operator|&
name|newconf
operator|->
name|tx_queue
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|n
operator|->
name|configured
condition|)
continue|continue;
if|if
condition|(
operator|(
name|n
operator|->
name|aifs
operator|!=
name|o
operator|->
name|aifs
operator|||
name|n
operator|->
name|cwmin
operator|!=
name|o
operator|->
name|cwmin
operator|||
name|n
operator|->
name|cwmax
operator|!=
name|o
operator|->
name|cwmax
operator|||
name|n
operator|->
name|burst
operator|!=
name|o
operator|->
name|burst
operator|)
operator|&&
name|hostapd_set_tx_queue_params
argument_list|(
name|hapd
argument_list|,
name|i
argument_list|,
name|n
operator|->
name|aifs
argument_list|,
name|n
operator|->
name|cwmin
argument_list|,
name|n
operator|->
name|cwmax
argument_list|,
name|n
operator|->
name|burst
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Failed to set TX queue parameters for queue %d"
literal|".\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_reconfig_wme
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_config
modifier|*
name|newconf
parameter_list|,
name|struct
name|hostapd_config
modifier|*
name|oldconf
parameter_list|)
block|{
name|int
name|beacon_changed
init|=
literal|0
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|struct
name|hostapd_wme_ac_params
modifier|*
name|o
decl_stmt|,
modifier|*
name|n
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|newconf
operator|->
name|wme_ac_params
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|newconf
operator|->
name|wme_ac_params
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|o
operator|=
operator|&
name|oldconf
operator|->
name|wme_ac_params
index|[
name|i
index|]
expr_stmt|;
name|n
operator|=
operator|&
name|newconf
operator|->
name|wme_ac_params
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|->
name|cwmin
operator|!=
name|o
operator|->
name|cwmin
operator|||
name|n
operator|->
name|cwmax
operator|!=
name|o
operator|->
name|cwmax
operator|||
name|n
operator|->
name|aifs
operator|!=
name|o
operator|->
name|aifs
operator|||
name|n
operator|->
name|txopLimit
operator|!=
name|o
operator|->
name|txopLimit
operator|||
name|n
operator|->
name|admission_control_mandatory
operator|!=
name|o
operator|->
name|admission_control_mandatory
condition|)
block|{
name|beacon_changed
operator|++
expr_stmt|;
name|hapd
operator|->
name|parameter_set_count
operator|++
expr_stmt|;
block|}
block|}
return|return
name|beacon_changed
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rate_array_diff
parameter_list|(
name|int
modifier|*
name|a1
parameter_list|,
name|int
modifier|*
name|a2
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|a1
operator|==
name|NULL
operator|&&
name|a2
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|a1
operator|==
name|NULL
operator|||
name|a2
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|a1
index|[
name|i
index|]
operator|!=
name|a2
index|[
name|i
index|]
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|a1
index|[
name|i
index|]
operator|==
operator|-
literal|1
condition|)
break|break;
name|i
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_acl_diff
parameter_list|(
name|struct
name|hostapd_bss_config
modifier|*
name|a
parameter_list|,
name|struct
name|hostapd_bss_config
modifier|*
name|b
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|a
operator|->
name|macaddr_acl
operator|!=
name|b
operator|->
name|macaddr_acl
operator|||
name|a
operator|->
name|num_accept_mac
operator|!=
name|b
operator|->
name|num_accept_mac
operator|||
name|a
operator|->
name|num_deny_mac
operator|!=
name|b
operator|->
name|num_deny_mac
condition|)
return|return
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|a
operator|->
name|num_accept_mac
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|a
operator|->
name|accept_mac
index|[
name|i
index|]
argument_list|,
name|b
operator|->
name|accept_mac
index|[
name|i
index|]
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|a
operator|->
name|num_deny_mac
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|a
operator|->
name|deny_mac
index|[
name|i
index|]
argument_list|,
name|b
operator|->
name|deny_mac
index|[
name|i
index|]
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * reload_iface2 - Part 2 of reload_iface  * @hapd_iface: Pointer to hostapd interface data.  */
end_comment

begin_function
specifier|static
name|void
name|reload_iface2
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|hapd_iface
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|hapd_iface
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|newconf
init|=
name|hapd_iface
operator|->
name|change
operator|->
name|newconf
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|oldconf
init|=
name|hapd_iface
operator|->
name|change
operator|->
name|oldconf
decl_stmt|;
name|int
name|beacon_changed
init|=
name|hapd_iface
operator|->
name|change
operator|->
name|beacon_changed
decl_stmt|;
name|hostapd_iface_cb
name|cb
init|=
name|hapd_iface
operator|->
name|reload_iface_cb
decl_stmt|;
if|if
condition|(
name|newconf
operator|->
name|preamble
operator|!=
name|oldconf
operator|->
name|preamble
condition|)
block|{
if|if
condition|(
name|hostapd_set_preamble
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|iconf
operator|->
name|preamble
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Could not set preamble for kernel driver\n"
argument_list|)
expr_stmt|;
name|beacon_changed
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|newconf
operator|->
name|beacon_int
operator|!=
name|oldconf
operator|->
name|beacon_int
condition|)
block|{
comment|/* Need to change beacon interval if it has changed or if 		 * auto channel selection was used. */
if|if
condition|(
name|hostapd_set_beacon_int
argument_list|(
name|hapd
argument_list|,
name|newconf
operator|->
name|beacon_int
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Could not set beacon interval for kernel "
literal|"driver\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|newconf
operator|->
name|beacon_int
operator|!=
name|oldconf
operator|->
name|beacon_int
condition|)
name|beacon_changed
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|newconf
operator|->
name|cts_protection_type
operator|!=
name|oldconf
operator|->
name|cts_protection_type
condition|)
name|beacon_changed
operator|++
expr_stmt|;
if|if
condition|(
name|newconf
operator|->
name|rts_threshold
operator|>
operator|-
literal|1
operator|&&
name|newconf
operator|->
name|rts_threshold
operator|!=
name|oldconf
operator|->
name|rts_threshold
operator|&&
name|hostapd_set_rts
argument_list|(
name|hapd
argument_list|,
name|newconf
operator|->
name|rts_threshold
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Could not set RTS threshold for kernel driver\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|newconf
operator|->
name|fragm_threshold
operator|>
operator|-
literal|1
operator|&&
name|newconf
operator|->
name|fragm_threshold
operator|!=
name|oldconf
operator|->
name|fragm_threshold
operator|&&
name|hostapd_set_frag
argument_list|(
name|hapd
argument_list|,
name|newconf
operator|->
name|fragm_threshold
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Could not set fragmentation threshold for kernel "
literal|"driver\n"
argument_list|)
expr_stmt|;
name|hostapd_reconfig_tx_queue_params
argument_list|(
name|hapd
argument_list|,
name|newconf
argument_list|,
name|oldconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_reconfig_wme
argument_list|(
name|hapd
argument_list|,
name|newconf
argument_list|,
name|oldconf
argument_list|)
operator|>
literal|0
condition|)
name|beacon_changed
operator|++
expr_stmt|;
name|ap_list_reconfig
argument_list|(
name|hapd_iface
argument_list|,
name|oldconf
argument_list|)
expr_stmt|;
name|hapd_iface
operator|->
name|change
operator|->
name|beacon_changed
operator|=
name|beacon_changed
expr_stmt|;
name|hapd_iface
operator|->
name|reload_iface_cb
operator|=
name|NULL
expr_stmt|;
name|cb
argument_list|(
name|hapd_iface
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * reload_iface2_handler - Handler that calls reload_face2  * @eloop_data: Stores the struct hostapd_iface for the interface.  * @user_ctx: Unused.  */
end_comment

begin_function
specifier|static
name|void
name|reload_iface2_handler
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|hapd_iface
init|=
name|eloop_data
decl_stmt|;
name|reload_iface2
argument_list|(
name|hapd_iface
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * reload_hw_mode_done - Callback for after the HW mode is setup  * @hapd_iface: Pointer to interface data.  * @status: Status of the HW mode setup.  */
end_comment

begin_function
specifier|static
name|void
name|reload_hw_mode_done
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|hapd_iface
parameter_list|,
name|int
name|status
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|hapd_iface
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|hostapd_config_change
modifier|*
name|change
init|=
name|hapd_iface
operator|->
name|change
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|newconf
init|=
name|change
operator|->
name|newconf
decl_stmt|;
name|hostapd_iface_cb
name|cb
decl_stmt|;
name|int
name|freq
decl_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to select hw_mode.\n"
argument_list|)
expr_stmt|;
name|cb
operator|=
name|hapd_iface
operator|->
name|reload_iface_cb
expr_stmt|;
name|hapd_iface
operator|->
name|reload_iface_cb
operator|=
name|NULL
expr_stmt|;
name|cb
argument_list|(
name|hapd_iface
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|freq
operator|=
name|hostapd_hw_get_freq
argument_list|(
name|hapd
argument_list|,
name|newconf
operator|->
name|channel
argument_list|)
expr_stmt|;
name|HOSTAPD_DEBUG
argument_list|(
name|HOSTAPD_DEBUG_MINIMAL
argument_list|,
literal|"Mode: %s  Channel: %d  Frequency: %d MHz\n"
argument_list|,
name|hostapd_hw_mode_txt
argument_list|(
name|newconf
operator|->
name|hw_mode
argument_list|)
argument_list|,
name|newconf
operator|->
name|channel
argument_list|,
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_set_freq
argument_list|(
name|hapd
argument_list|,
name|newconf
operator|->
name|hw_mode
argument_list|,
name|freq
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Could not set channel %d (%d MHz) for kernel "
literal|"driver\n"
argument_list|,
name|newconf
operator|->
name|channel
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
name|change
operator|->
name|beacon_changed
operator|++
expr_stmt|;
name|reload_iface2
argument_list|(
name|hapd_iface
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * hostapd_config_reload_iface_start - Start interface reload  * @hapd_iface: Pointer to interface data.  * @cb: The function to callback when done.  * Returns:  0 if it starts successfully; cb will be called when done.  *          -1 on failure; cb will not be called.  */
end_comment

begin_function
specifier|static
name|int
name|hostapd_config_reload_iface_start
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|hapd_iface
parameter_list|,
name|hostapd_iface_cb
name|cb
parameter_list|)
block|{
name|struct
name|hostapd_config_change
modifier|*
name|change
init|=
name|hapd_iface
operator|->
name|change
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|newconf
init|=
name|change
operator|->
name|newconf
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|oldconf
init|=
name|change
operator|->
name|oldconf
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|hapd_iface
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|hapd_iface
operator|->
name|reload_iface_cb
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Interface reload already in progress."
argument_list|,
name|hapd_iface
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|conf
operator|->
name|iface
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hapd_iface
operator|->
name|reload_iface_cb
operator|=
name|cb
expr_stmt|;
if|if
condition|(
name|newconf
operator|->
name|bridge_packets
operator|!=
name|oldconf
operator|->
name|bridge_packets
operator|&&
name|hapd
operator|->
name|iconf
operator|->
name|bridge_packets
operator|!=
name|INTERNAL_BRIDGE_DO_NOT_CONTROL
operator|&&
name|hostapd_set_internal_bridge
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|iconf
operator|->
name|bridge_packets
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Failed to set bridge_packets for kernel driver\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|newconf
operator|->
name|channel
operator|!=
name|oldconf
operator|->
name|channel
operator|||
name|newconf
operator|->
name|hw_mode
operator|!=
name|oldconf
operator|->
name|hw_mode
operator|||
name|rate_array_diff
argument_list|(
name|newconf
operator|->
name|supported_rates
argument_list|,
name|oldconf
operator|->
name|supported_rates
argument_list|)
operator|||
name|rate_array_diff
argument_list|(
name|newconf
operator|->
name|basic_rates
argument_list|,
name|oldconf
operator|->
name|basic_rates
argument_list|)
condition|)
block|{
name|hostapd_free_stas
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_get_hw_features
argument_list|(
name|hapd_iface
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Could not read HW feature info from the kernel"
literal|" driver.\n"
argument_list|)
expr_stmt|;
name|hapd_iface
operator|->
name|reload_iface_cb
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hostapd_select_hw_mode_start
argument_list|(
name|hapd_iface
argument_list|,
name|reload_hw_mode_done
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to start select hw_mode.\n"
argument_list|)
expr_stmt|;
name|hapd_iface
operator|->
name|reload_iface_cb
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|reload_iface2_handler
argument_list|,
name|hapd_iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_reconfig_bss
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_bss_config
modifier|*
name|newbss
parameter_list|,
name|struct
name|hostapd_bss_config
modifier|*
name|oldbss
parameter_list|,
name|struct
name|hostapd_config
modifier|*
name|oldconf
parameter_list|,
name|int
name|beacon_changed
parameter_list|)
block|{
name|struct
name|hostapd_config_change
name|change
decl_stmt|;
name|int
name|encr_changed
init|=
literal|0
decl_stmt|;
name|struct
name|radius_client_data
modifier|*
name|old_radius
decl_stmt|;
name|radius_client_flush
argument_list|(
name|hapd
operator|->
name|radius
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_set_dtim_period
argument_list|(
name|hapd
argument_list|,
name|newbss
operator|->
name|dtim_period
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Could not set DTIM period for kernel driver\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|newbss
operator|->
name|ssid
operator|.
name|ssid_len
operator|!=
name|oldbss
operator|->
name|ssid
operator|.
name|ssid_len
operator|||
name|memcmp
argument_list|(
name|newbss
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|oldbss
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|newbss
operator|->
name|ssid
operator|.
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_set_ssid
argument_list|(
name|hapd
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|newbss
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|newbss
operator|->
name|ssid
operator|.
name|ssid_len
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Could not set SSID for kernel driver\n"
argument_list|)
expr_stmt|;
name|beacon_changed
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|newbss
operator|->
name|ignore_broadcast_ssid
operator|!=
name|oldbss
operator|->
name|ignore_broadcast_ssid
condition|)
name|beacon_changed
operator|++
expr_stmt|;
if|if
condition|(
name|hostapd_wep_key_cmp
argument_list|(
operator|&
name|newbss
operator|->
name|ssid
operator|.
name|wep
argument_list|,
operator|&
name|oldbss
operator|->
name|ssid
operator|.
name|wep
argument_list|)
condition|)
block|{
name|encr_changed
operator|++
expr_stmt|;
name|beacon_changed
operator|++
expr_stmt|;
block|}
name|vlan_reconfig
argument_list|(
name|hapd
argument_list|,
name|oldconf
argument_list|,
name|oldbss
argument_list|)
expr_stmt|;
if|if
condition|(
name|beacon_changed
condition|)
block|{
name|HOSTAPD_DEBUG
argument_list|(
name|HOSTAPD_DEBUG_MINIMAL
argument_list|,
literal|"Updating beacon frame "
literal|"information\n"
argument_list|)
expr_stmt|;
name|ieee802_11_set_beacon
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
name|change
operator|.
name|hapd
operator|=
name|hapd
expr_stmt|;
name|change
operator|.
name|oldconf
operator|=
name|oldconf
expr_stmt|;
name|change
operator|.
name|newconf
operator|=
name|hapd
operator|->
name|iconf
expr_stmt|;
name|change
operator|.
name|oldbss
operator|=
name|oldbss
expr_stmt|;
name|change
operator|.
name|newbss
operator|=
name|newbss
expr_stmt|;
name|change
operator|.
name|mac_acl_changed
operator|=
name|hostapd_acl_diff
argument_list|(
name|newbss
argument_list|,
name|oldbss
argument_list|)
expr_stmt|;
if|if
condition|(
name|newbss
operator|->
name|max_num_sta
operator|!=
name|oldbss
operator|->
name|max_num_sta
operator|&&
name|newbss
operator|->
name|max_num_sta
operator|<
name|hapd
operator|->
name|num_sta
condition|)
block|{
name|change
operator|.
name|num_sta_remove
operator|=
name|hapd
operator|->
name|num_sta
operator|-
name|newbss
operator|->
name|max_num_sta
expr_stmt|;
block|}
else|else
name|change
operator|.
name|num_sta_remove
operator|=
literal|0
expr_stmt|;
name|ap_for_each_sta
argument_list|(
name|hapd
argument_list|,
name|hostapd_config_reload_sta
argument_list|,
operator|&
name|change
argument_list|)
expr_stmt|;
name|old_radius
operator|=
name|hapd
operator|->
name|radius
expr_stmt|;
name|hapd
operator|->
name|radius
operator|=
name|radius_client_reconfig
argument_list|(
name|hapd
operator|->
name|radius
argument_list|,
name|hapd
argument_list|,
name|oldbss
operator|->
name|radius
argument_list|,
name|newbss
operator|->
name|radius
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|radius_client_reconfigured
operator|=
name|old_radius
operator|!=
name|hapd
operator|->
name|radius
operator|||
name|hostapd_ip_diff
argument_list|(
operator|&
name|newbss
operator|->
name|own_ip_addr
argument_list|,
operator|&
name|oldbss
operator|->
name|own_ip_addr
argument_list|)
expr_stmt|;
name|ieee802_1x_reconfig
argument_list|(
name|hapd
argument_list|,
name|oldconf
argument_list|,
name|oldbss
argument_list|)
expr_stmt|;
name|iapp_reconfig
argument_list|(
name|hapd
argument_list|,
name|oldconf
argument_list|,
name|oldbss
argument_list|)
expr_stmt|;
name|hostapd_acl_reconfig
argument_list|(
name|hapd
argument_list|,
name|oldconf
argument_list|)
expr_stmt|;
name|accounting_reconfig
argument_list|(
name|hapd
argument_list|,
name|oldconf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * config_reload2 - Part 2 of configuration reloading  * @hapd_iface:  */
end_comment

begin_function
specifier|static
name|void
name|config_reload2
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|hapd_iface
parameter_list|,
name|int
name|status
parameter_list|)
block|{
name|struct
name|hostapd_config_change
modifier|*
name|change
init|=
name|hapd_iface
operator|->
name|change
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|change
operator|->
name|hapd
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|newconf
init|=
name|change
operator|->
name|newconf
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|oldconf
init|=
name|change
operator|->
name|oldconf
decl_stmt|;
name|int
name|beacon_changed
init|=
name|change
operator|->
name|beacon_changed
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
modifier|*
name|new_hapd
init|=
name|change
operator|->
name|new_hapd
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
modifier|*
name|old_hapd
init|=
name|change
operator|->
name|old_hapd
decl_stmt|;
name|int
name|num_old_hapd
init|=
name|change
operator|->
name|num_old_hapd
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|max_bss
decl_stmt|,
name|same_bssid
decl_stmt|;
name|struct
name|hostapd_bss_config
modifier|*
name|newbss
decl_stmt|,
modifier|*
name|oldbss
decl_stmt|;
name|u8
modifier|*
name|prev_addr
decl_stmt|;
name|hostapd_iface_cb
name|cb
decl_stmt|;
name|free
argument_list|(
name|change
argument_list|)
expr_stmt|;
name|hapd_iface
operator|->
name|change
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to setup new interface config\n"
argument_list|)
expr_stmt|;
name|cb
operator|=
name|hapd_iface
operator|->
name|config_reload_cb
expr_stmt|;
name|hapd_iface
operator|->
name|config_reload_cb
operator|=
name|NULL
expr_stmt|;
comment|/* Invalid configuration - cleanup and terminate hostapd */
name|hapd_iface
operator|->
name|bss
operator|=
name|old_hapd
expr_stmt|;
name|hapd_iface
operator|->
name|num_bss
operator|=
name|num_old_hapd
expr_stmt|;
name|hapd_iface
operator|->
name|conf
operator|=
name|hapd
operator|->
name|iconf
operator|=
name|oldconf
expr_stmt|;
name|hapd
operator|->
name|conf
operator|=
operator|&
name|oldconf
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
name|hostapd_config_free
argument_list|(
name|newconf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|new_hapd
argument_list|)
expr_stmt|;
name|cb
argument_list|(
name|hapd_iface
argument_list|,
operator|-
literal|2
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * If any BSSes have been removed, added, or had their BSSIDs changed, 	 * completely remove and reinitialize such BSSes and all the BSSes 	 * following them since their BSSID might have changed. 	 */
name|max_bss
operator|=
name|oldconf
operator|->
name|num_bss
expr_stmt|;
if|if
condition|(
name|max_bss
operator|>
name|newconf
operator|->
name|num_bss
condition|)
name|max_bss
operator|=
name|newconf
operator|->
name|num_bss
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_bss
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|oldconf
operator|->
name|bss
index|[
name|i
index|]
operator|.
name|iface
argument_list|,
name|newconf
operator|->
name|bss
index|[
name|i
index|]
operator|.
name|iface
argument_list|)
operator|!=
literal|0
operator|||
name|hostapd_mac_comp
argument_list|(
name|oldconf
operator|->
name|bss
index|[
name|i
index|]
operator|.
name|bssid
argument_list|,
name|newconf
operator|->
name|bss
index|[
name|i
index|]
operator|.
name|bssid
argument_list|)
operator|!=
literal|0
condition|)
break|break;
block|}
name|same_bssid
operator|=
name|i
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|oldconf
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
name|oldbss
operator|=
operator|&
name|oldconf
operator|->
name|bss
index|[
name|i
index|]
expr_stmt|;
name|newbss
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|newconf
operator|->
name|num_bss
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|oldbss
operator|->
name|iface
argument_list|,
name|newconf
operator|->
name|bss
index|[
name|j
index|]
operator|.
name|iface
argument_list|)
operator|==
literal|0
condition|)
block|{
name|newbss
operator|=
operator|&
name|newconf
operator|->
name|bss
index|[
name|j
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|newbss
operator|&&
name|i
operator|<
name|same_bssid
condition|)
block|{
name|hapd
operator|=
name|hapd_iface
operator|->
name|bss
index|[
name|j
index|]
operator|=
name|old_hapd
index|[
name|i
index|]
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|=
name|newconf
expr_stmt|;
name|hapd
operator|->
name|conf
operator|=
name|newbss
expr_stmt|;
name|hostapd_reconfig_bss
argument_list|(
name|hapd
argument_list|,
name|newbss
argument_list|,
name|oldbss
argument_list|,
name|oldconf
argument_list|,
name|beacon_changed
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hapd
operator|=
name|old_hapd
index|[
name|i
index|]
expr_stmt|;
name|HOSTAPD_DEBUG
argument_list|(
name|HOSTAPD_DEBUG_MINIMAL
argument_list|,
literal|"Removing BSS (ifname %s)\n"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
expr_stmt|;
name|hostapd_free_stas
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
comment|/* Send broadcast deauthentication for this BSS, but do 			 * not clear all STAs from the driver since other BSSes 			 * may have STA entries. The driver will remove all STA 			 * entries for this BSS anyway when the interface is 			 * being removed. */
if|#
directive|if
literal|0
block|hostapd_deauth_all_stas(hapd); 			hostapd_cleanup(hapd);
endif|#
directive|endif
name|free
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
block|}
name|prev_addr
operator|=
name|hapd_iface
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|own_addr
expr_stmt|;
name|hapd
operator|=
name|hapd_iface
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|newconf
operator|->
name|num_bss
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|hapd_iface
operator|->
name|bss
index|[
name|j
index|]
operator|!=
name|NULL
condition|)
block|{
name|prev_addr
operator|=
name|hapd_iface
operator|->
name|bss
index|[
name|j
index|]
operator|->
name|own_addr
expr_stmt|;
continue|continue;
block|}
name|newbss
operator|=
operator|&
name|newconf
operator|->
name|bss
index|[
name|j
index|]
expr_stmt|;
name|HOSTAPD_DEBUG
argument_list|(
name|HOSTAPD_DEBUG_MINIMAL
argument_list|,
literal|"Reconfiguration: adding "
literal|"new BSS (ifname=%s)\n"
argument_list|,
name|newbss
operator|->
name|iface
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|hapd = hapd_iface->bss[j] = 			hostapd_alloc_bss_data(hapd_iface, newconf, newbss);
endif|#
directive|endif
if|if
condition|(
name|hapd
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to initialize new BSS\n"
argument_list|)
expr_stmt|;
comment|/* FIX: This one is somewhat hard to recover 			 * from.. Would need to remove this BSS from 			 * conf and BSS list. */
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|hapd
operator|->
name|driver
operator|=
name|hapd_iface
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|driver
expr_stmt|;
name|hapd
operator|->
name|iface
operator|=
name|hapd_iface
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|=
name|newconf
expr_stmt|;
name|hapd
operator|->
name|conf
operator|=
name|newbss
expr_stmt|;
name|memcpy
argument_list|(
name|hapd
operator|->
name|own_addr
argument_list|,
name|prev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_mac_comp_empty
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|bssid
argument_list|)
operator|==
literal|0
condition|)
name|prev_addr
operator|=
name|hapd
operator|->
name|own_addr
expr_stmt|;
if|#
directive|if
literal|0
block|if (hostapd_setup_bss(hapd, j == 0)) { 			printf("Failed to setup new BSS\n");
comment|/* FIX */
block|exit(1); 		}
endif|#
directive|endif
block|}
name|free
argument_list|(
name|old_hapd
argument_list|)
expr_stmt|;
name|hostapd_config_free
argument_list|(
name|oldconf
argument_list|)
expr_stmt|;
name|cb
operator|=
name|hapd_iface
operator|->
name|config_reload_cb
expr_stmt|;
name|hapd_iface
operator|->
name|config_reload_cb
operator|=
name|NULL
expr_stmt|;
name|cb
argument_list|(
name|hapd_iface
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * hostapd_config_reload_start - Start reconfiguration of an interface  * @hapd_iface: Pointer to hostapd interface data  * @cb: Function to be called back when done.  *      The status indicates:  *       0 = success, new configuration in use;  *      -1 = failed to update configuraiton, old configuration in use;  *      -2 = failed to update configuration and failed to recover; caller  *           should cleanup and terminate hostapd  * Returns:  *  0 = reconfiguration started;  * -1 = failed to update configuration, old configuration in use;  * -2 = failed to update configuration and failed to recover; caller  *      should cleanup and terminate hostapd  */
end_comment

begin_function
name|int
name|hostapd_config_reload_start
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|hapd_iface
parameter_list|,
name|hostapd_iface_cb
name|cb
parameter_list|)
block|{
name|struct
name|hostapd_config
modifier|*
name|newconf
decl_stmt|,
modifier|*
name|oldconf
decl_stmt|;
name|struct
name|hostapd_config_change
modifier|*
name|change
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|NULL
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
modifier|*
name|old_hapd
decl_stmt|,
modifier|*
modifier|*
name|new_hapd
decl_stmt|;
name|int
name|num_old_hapd
decl_stmt|;
if|if
condition|(
name|hapd_iface
operator|->
name|config_reload_cb
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Config reload already in progress."
argument_list|,
name|hapd_iface
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|conf
operator|->
name|iface
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|newconf
operator|=
name|hostapd_config_read
argument_list|(
name|hapd_iface
operator|->
name|config_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|newconf
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to read new configuration file - continuing "
literal|"with old.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|newconf
operator|->
name|bss
index|[
literal|0
index|]
operator|.
name|iface
argument_list|,
name|hapd_iface
operator|->
name|conf
operator|->
name|bss
index|[
literal|0
index|]
operator|.
name|iface
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Interface name changing is not allowed in "
literal|"configuration reloading (%s -> %s).\n"
argument_list|,
name|hapd_iface
operator|->
name|conf
operator|->
name|bss
index|[
literal|0
index|]
operator|.
name|iface
argument_list|,
name|newconf
operator|->
name|bss
index|[
literal|0
index|]
operator|.
name|iface
argument_list|)
expr_stmt|;
name|hostapd_config_free
argument_list|(
name|newconf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|new_hapd
operator|=
name|wpa_zalloc
argument_list|(
name|newconf
operator|->
name|num_bss
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_data
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_hapd
operator|==
name|NULL
condition|)
block|{
name|hostapd_config_free
argument_list|(
name|newconf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|old_hapd
operator|=
name|hapd_iface
operator|->
name|bss
expr_stmt|;
name|num_old_hapd
operator|=
name|hapd_iface
operator|->
name|num_bss
expr_stmt|;
name|hapd_iface
operator|->
name|bss
operator|=
name|new_hapd
expr_stmt|;
name|hapd_iface
operator|->
name|num_bss
operator|=
name|newconf
operator|->
name|num_bss
expr_stmt|;
comment|/* 	 * First BSS remains the same since interface name changing was 	 * prohibited above. Now, this is only used in 	 * hostapd_config_reload_iface() and following loop will anyway set 	 * this again. 	 */
name|hapd
operator|=
name|hapd_iface
operator|->
name|bss
index|[
literal|0
index|]
operator|=
name|old_hapd
index|[
literal|0
index|]
expr_stmt|;
name|oldconf
operator|=
name|hapd_iface
operator|->
name|conf
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|=
name|hapd_iface
operator|->
name|conf
operator|=
name|newconf
expr_stmt|;
name|hapd
operator|->
name|conf
operator|=
operator|&
name|newconf
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
name|change
operator|=
name|wpa_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_config_change
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|change
operator|==
name|NULL
condition|)
block|{
name|hostapd_config_free
argument_list|(
name|newconf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|change
operator|->
name|hapd
operator|=
name|hapd
expr_stmt|;
name|change
operator|->
name|newconf
operator|=
name|newconf
expr_stmt|;
name|change
operator|->
name|oldconf
operator|=
name|oldconf
expr_stmt|;
name|change
operator|->
name|beacon_changed
operator|=
literal|0
expr_stmt|;
name|change
operator|->
name|hapd_iface
operator|=
name|hapd_iface
expr_stmt|;
name|change
operator|->
name|new_hapd
operator|=
name|new_hapd
expr_stmt|;
name|change
operator|->
name|old_hapd
operator|=
name|old_hapd
expr_stmt|;
name|change
operator|->
name|num_old_hapd
operator|=
name|num_old_hapd
expr_stmt|;
name|hapd_iface
operator|->
name|config_reload_cb
operator|=
name|cb
expr_stmt|;
name|hapd_iface
operator|->
name|change
operator|=
name|change
expr_stmt|;
if|if
condition|(
name|hostapd_config_reload_iface_start
argument_list|(
name|hapd_iface
argument_list|,
name|config_reload2
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to start setup of new interface config\n"
argument_list|)
expr_stmt|;
name|hapd_iface
operator|->
name|config_reload_cb
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|change
argument_list|)
expr_stmt|;
name|hapd_iface
operator|->
name|change
operator|=
name|NULL
expr_stmt|;
comment|/* Invalid configuration - cleanup and terminate hostapd */
name|hapd_iface
operator|->
name|bss
operator|=
name|old_hapd
expr_stmt|;
name|hapd_iface
operator|->
name|num_bss
operator|=
name|num_old_hapd
expr_stmt|;
name|hapd_iface
operator|->
name|conf
operator|=
name|hapd
operator|->
name|iconf
operator|=
name|oldconf
expr_stmt|;
name|hapd
operator|->
name|conf
operator|=
operator|&
name|oldconf
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
name|hostapd_config_free
argument_list|(
name|newconf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|new_hapd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


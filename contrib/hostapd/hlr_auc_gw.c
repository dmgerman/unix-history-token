begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * HLR/AuC testing gateway for hostapd EAP-SIM/AKA database/authenticator  * Copyright (c) 2005-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * This is an example implementation of the EAP-SIM/AKA database/authentication  * gateway interface to HLR/AuC. It is expected to be replaced with an  * implementation of SS7 gateway to GSM/UMTS authentication center (HLR/AuC) or  * a local implementation of SIM triplet and AKA authentication data generator.  *  * hostapd will send SIM/AKA authentication queries over a UNIX domain socket  * to and external program, e.g., this hlr_auc_gw. This interface uses simple  * text-based format:  *  * EAP-SIM / GSM triplet query/response:  * SIM-REQ-AUTH<IMSI><max_chal>  * SIM-RESP-AUTH<IMSI> Kc1:SRES1:RAND1 Kc2:SRES2:RAND2 [Kc3:SRES3:RAND3]  * SIM-RESP-AUTH<IMSI> FAILURE  *  * EAP-AKA / UMTS query/response:  * AKA-REQ-AUTH<IMSI>  * AKA-RESP-AUTH<IMSI><RAND><AUTN><IK><CK><RES>  * AKA-RESP-AUTH<IMSI> FAILURE  *  * EAP-AKA / UMTS AUTS (re-synchronization):  * AKA-AUTS<IMSI><AUTS><RAND>  *  * IMSI and max_chal are sent as an ASCII string,  * Kc/SRES/RAND/AUTN/IK/CK/RES/AUTS as hex strings.  *  * The example implementation here reads GSM authentication triplets from a  * text file in IMSI:Kc:SRES:RAND format, IMSI in ASCII, other fields as hex  * strings. This is used to simulate an HLR/AuC. As such, it is not very useful  * for real life authentication, but it is useful both as an example  * implementation and for EAP-SIM testing.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"milenage.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|default_socket_path
init|=
literal|"/tmp/hlr_auc_gw.sock"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|socket_path
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|default_gsm_triplet_file
init|=
literal|"hostapd.sim_db"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|gsm_triplet_file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|serv_sock
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* OPc and AMF parameters for Milenage (Example algorithms for AKA). */
end_comment

begin_struct
struct|struct
name|milenage_parameters
block|{
name|struct
name|milenage_parameters
modifier|*
name|next
decl_stmt|;
name|char
name|imsi
index|[
literal|20
index|]
decl_stmt|;
name|u8
name|ki
index|[
literal|16
index|]
decl_stmt|;
name|u8
name|opc
index|[
literal|16
index|]
decl_stmt|;
name|u8
name|amf
index|[
literal|2
index|]
decl_stmt|;
name|u8
name|sqn
index|[
literal|6
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|milenage_parameters
modifier|*
name|milenage_db
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|EAP_SIM_MAX_CHAL
value|3
end_define

begin_define
define|#
directive|define
name|EAP_AKA_RAND_LEN
value|16
end_define

begin_define
define|#
directive|define
name|EAP_AKA_AUTN_LEN
value|16
end_define

begin_define
define|#
directive|define
name|EAP_AKA_AUTS_LEN
value|14
end_define

begin_define
define|#
directive|define
name|EAP_AKA_RES_MAX_LEN
value|16
end_define

begin_define
define|#
directive|define
name|EAP_AKA_IK_LEN
value|16
end_define

begin_define
define|#
directive|define
name|EAP_AKA_CK_LEN
value|16
end_define

begin_function
specifier|static
name|int
name|open_socket
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_UNIX)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|strncpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind(PF_UNIX)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|read_milenage
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|line
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|fname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not open Milenage data file '%s'\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|line
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
comment|/* Parse IMSI Ki OPc AMF SQN */
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos
operator|!=
literal|'\n'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
continue|continue;
name|m
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|m
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
comment|/* IMSI */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid IMSI (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|m
operator|->
name|imsi
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Too long IMSI (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|strncpy
argument_list|(
name|m
operator|->
name|imsi
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|m
operator|->
name|imsi
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* Ki */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid Ki (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|32
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|m
operator|->
name|ki
argument_list|,
literal|16
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid Ki (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* OPc */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid OPc (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|32
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|m
operator|->
name|opc
argument_list|,
literal|16
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid OPc (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* AMF */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid AMF (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|4
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|m
operator|->
name|amf
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid AMF (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* SQN */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
condition|)
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|12
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|m
operator|->
name|sqn
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid SEQ (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
name|m
operator|->
name|next
operator|=
name|milenage_db
expr_stmt|;
name|milenage_db
operator|=
name|m
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
block|}
name|free
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|milenage_parameters
modifier|*
name|get_milenage
parameter_list|(
specifier|const
name|char
modifier|*
name|imsi
parameter_list|)
block|{
name|struct
name|milenage_parameters
modifier|*
name|m
init|=
name|milenage_db
decl_stmt|;
while|while
condition|(
name|m
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|m
operator|->
name|imsi
argument_list|,
name|imsi
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|m
operator|=
name|m
operator|->
name|next
expr_stmt|;
block|}
return|return
name|m
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sim_req_auth
parameter_list|(
name|int
name|s
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|char
modifier|*
name|imsi
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|int
name|count
decl_stmt|,
name|max_chal
decl_stmt|,
name|ret
decl_stmt|;
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|char
name|reply
index|[
literal|1000
index|]
decl_stmt|,
modifier|*
name|rpos
decl_stmt|,
modifier|*
name|rend
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|;
name|reply
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|imsi
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|max_chal
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_chal
operator|<
literal|1
operator|||
name|max_chal
operator|<
name|EAP_SIM_MAX_CHAL
condition|)
name|max_chal
operator|=
name|EAP_SIM_MAX_CHAL
expr_stmt|;
block|}
else|else
name|max_chal
operator|=
name|EAP_SIM_MAX_CHAL
expr_stmt|;
name|rend
operator|=
operator|&
name|reply
index|[
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
index|]
expr_stmt|;
name|rpos
operator|=
name|reply
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
literal|"SIM-RESP-AUTH %s"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|rend
operator|-
name|rpos
condition|)
return|return;
name|rpos
operator|+=
name|ret
expr_stmt|;
name|m
operator|=
name|get_milenage
argument_list|(
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
name|u8
name|_rand
index|[
literal|16
index|]
decl_stmt|,
name|sres
index|[
literal|4
index|]
decl_stmt|,
name|kc
index|[
literal|8
index|]
decl_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
name|max_chal
condition|;
name|count
operator|++
control|)
block|{
name|os_get_random
argument_list|(
name|_rand
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|gsm_milenage
argument_list|(
name|m
operator|->
name|opc
argument_list|,
name|m
operator|->
name|ki
argument_list|,
name|_rand
argument_list|,
name|sres
argument_list|,
name|kc
argument_list|)
expr_stmt|;
operator|*
name|rpos
operator|++
operator|=
literal|' '
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|kc
argument_list|,
literal|8
argument_list|)
expr_stmt|;
operator|*
name|rpos
operator|++
operator|=
literal|':'
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|sres
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|*
name|rpos
operator|++
operator|=
literal|':'
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|_rand
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
operator|*
name|rpos
operator|=
literal|'\0'
expr_stmt|;
goto|goto
name|send
goto|;
block|}
comment|/* TODO: could read triplet file into memory during startup and then 	 * have pointer for IMSI to allow more than three first entries to be 	 * used. */
name|f
operator|=
name|fopen
argument_list|(
name|gsm_triplet_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not open GSM triplet file '%s'\n"
argument_list|,
name|gsm_triplet_file
argument_list|)
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
literal|" FAILURE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|rend
operator|-
name|rpos
condition|)
return|return;
name|rpos
operator|+=
name|ret
expr_stmt|;
goto|goto
name|send
goto|;
block|}
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|<
name|max_chal
operator|&&
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
comment|/* Parse IMSI:Kc:SRES:RAND and match IMSI with identity. */
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos
operator|!=
literal|'\n'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|pos
operator|-
name|buf
operator|<
literal|60
operator|||
name|pos
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
continue|continue;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
name|imsi
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|ret
operator|=
name|snprintf
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
literal|" %s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|rend
operator|-
name|rpos
condition|)
block|{
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return;
block|}
name|rpos
operator|+=
name|ret
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"No GSM triplets found for %s\n"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
literal|" FAILURE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|rend
operator|-
name|rpos
condition|)
return|return;
name|rpos
operator|+=
name|ret
expr_stmt|;
block|}
name|send
label|:
name|printf
argument_list|(
literal|"Send: %s\n"
argument_list|,
name|reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendto
argument_list|(
name|s
argument_list|,
name|reply
argument_list|,
name|rpos
operator|-
name|reply
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
name|fromlen
argument_list|)
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|aka_req_auth
parameter_list|(
name|int
name|s
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|char
modifier|*
name|imsi
parameter_list|)
block|{
comment|/* AKA-RESP-AUTH<IMSI><RAND><AUTN><IK><CK><RES> */
name|char
name|reply
index|[
literal|1000
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|_rand
index|[
name|EAP_AKA_RAND_LEN
index|]
decl_stmt|;
name|u8
name|autn
index|[
name|EAP_AKA_AUTN_LEN
index|]
decl_stmt|;
name|u8
name|ik
index|[
name|EAP_AKA_IK_LEN
index|]
decl_stmt|;
name|u8
name|ck
index|[
name|EAP_AKA_CK_LEN
index|]
decl_stmt|;
name|u8
name|res
index|[
name|EAP_AKA_RES_MAX_LEN
index|]
decl_stmt|;
name|size_t
name|res_len
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|;
name|m
operator|=
name|get_milenage
argument_list|(
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
name|os_get_random
argument_list|(
name|_rand
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
expr_stmt|;
name|res_len
operator|=
name|EAP_AKA_RES_MAX_LEN
expr_stmt|;
name|inc_byte_array
argument_list|(
name|m
operator|->
name|sqn
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"AKA: Milenage with SQN=%02x%02x%02x%02x%02x%02x\n"
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|0
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|1
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|2
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|3
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|4
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|milenage_generate
argument_list|(
name|m
operator|->
name|opc
argument_list|,
name|m
operator|->
name|amf
argument_list|,
name|m
operator|->
name|ki
argument_list|,
name|m
operator|->
name|sqn
argument_list|,
name|_rand
argument_list|,
name|autn
argument_list|,
name|ik
argument_list|,
name|ck
argument_list|,
name|res
argument_list|,
operator|&
name|res_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown IMSI: %s\n"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AKA_USE_FIXED_TEST_VALUES
name|printf
argument_list|(
literal|"Using fixed test values for AKA\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|_rand
argument_list|,
literal|'0'
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|autn
argument_list|,
literal|'1'
argument_list|,
name|EAP_AKA_AUTN_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ik
argument_list|,
literal|'3'
argument_list|,
name|EAP_AKA_IK_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ck
argument_list|,
literal|'4'
argument_list|,
name|EAP_AKA_CK_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|res
argument_list|,
literal|'2'
argument_list|,
name|EAP_AKA_RES_MAX_LEN
argument_list|)
expr_stmt|;
name|res_len
operator|=
name|EAP_AKA_RES_MAX_LEN
expr_stmt|;
else|#
directive|else
comment|/* AKA_USE_FIXED_TEST_VALUES */
return|return;
endif|#
directive|endif
comment|/* AKA_USE_FIXED_TEST_VALUES */
block|}
name|pos
operator|=
name|reply
expr_stmt|;
name|end
operator|=
operator|&
name|reply
index|[
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
index|]
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"AKA-RESP-AUTH %s "
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return;
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|_rand
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|autn
argument_list|,
name|EAP_AKA_AUTN_LEN
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|ik
argument_list|,
name|EAP_AKA_IK_LEN
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|ck
argument_list|,
name|EAP_AKA_CK_LEN
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|,
name|res_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Send: %s\n"
argument_list|,
name|reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendto
argument_list|(
name|s
argument_list|,
name|reply
argument_list|,
name|pos
operator|-
name|reply
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
name|fromlen
argument_list|)
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|aka_auts
parameter_list|(
name|int
name|s
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|char
modifier|*
name|imsi
parameter_list|)
block|{
name|char
modifier|*
name|auts
decl_stmt|,
modifier|*
name|rand
decl_stmt|;
name|u8
name|_auts
index|[
name|EAP_AKA_AUTS_LEN
index|]
decl_stmt|,
name|_rand
index|[
name|EAP_AKA_RAND_LEN
index|]
decl_stmt|,
name|sqn
index|[
literal|6
index|]
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|;
comment|/* AKA-AUTS<IMSI><AUTS><RAND> */
name|auts
operator|=
name|strchr
argument_list|(
name|imsi
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|auts
operator|==
name|NULL
condition|)
return|return;
operator|*
name|auts
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|rand
operator|=
name|strchr
argument_list|(
name|auts
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|rand
operator|==
name|NULL
condition|)
return|return;
operator|*
name|rand
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"AKA-AUTS: IMSI=%s AUTS=%s RAND=%s\n"
argument_list|,
name|imsi
argument_list|,
name|auts
argument_list|,
name|rand
argument_list|)
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|auts
argument_list|,
name|_auts
argument_list|,
name|EAP_AKA_AUTS_LEN
argument_list|)
operator|||
name|hexstr2bin
argument_list|(
name|rand
argument_list|,
name|_rand
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Could not parse AUTS/RAND\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|m
operator|=
name|get_milenage
argument_list|(
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Unknown IMSI: %s\n"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|milenage_auts
argument_list|(
name|m
operator|->
name|opc
argument_list|,
name|m
operator|->
name|ki
argument_list|,
name|_rand
argument_list|,
name|_auts
argument_list|,
name|sqn
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"AKA-AUTS: Incorrect MAC-S\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|m
operator|->
name|sqn
argument_list|,
name|sqn
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"AKA-AUTS: Re-synchronized: "
literal|"SQN=%02x%02x%02x%02x%02x%02x\n"
argument_list|,
name|sqn
index|[
literal|0
index|]
argument_list|,
name|sqn
index|[
literal|1
index|]
argument_list|,
name|sqn
index|[
literal|2
index|]
argument_list|,
name|sqn
index|[
literal|3
index|]
argument_list|,
name|sqn
index|[
literal|4
index|]
argument_list|,
name|sqn
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|process
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1000
index|]
decl_stmt|;
name|struct
name|sockaddr_un
name|from
decl_stmt|;
name|socklen_t
name|fromlen
decl_stmt|;
name|ssize_t
name|res
decl_stmt|;
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|res
operator|=
name|recvfrom
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|res
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|res
operator|>=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|res
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
expr_stmt|;
name|buf
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"Received: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"SIM-REQ-AUTH "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
name|sim_req_auth
argument_list|(
name|s
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|13
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"AKA-REQ-AUTH "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
name|aka_req_auth
argument_list|(
name|s
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|13
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"AKA-AUTS "
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
name|aka_auts
argument_list|(
name|s
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|9
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Unknown request: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|m
operator|=
name|milenage_db
expr_stmt|;
while|while
condition|(
name|m
condition|)
block|{
name|prev
operator|=
name|m
expr_stmt|;
name|m
operator|=
name|m
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|serv_sock
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|socket_path
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|handle_term
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Signal %d - terminate\n"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"HLR/AuC testing gateway for hostapd EAP-SIM/AKA "
literal|"database/authenticator\n"
literal|"Copyright (c) 2005-2006, Jouni Malinen<j@w1.fi>\n"
literal|"\n"
literal|"usage:\n"
literal|"hlr_auc_gw [-h] [-s<socket path>] [-g<triplet file>] "
literal|"[-m<milenage file>]\n"
literal|"\n"
literal|"options:\n"
literal|"  -h = show this usage help\n"
literal|"  -s<socket path> = path for UNIX domain socket\n"
literal|"                    (default: %s)\n"
literal|"  -g<triplet file> = path for GSM authentication triplets\n"
literal|"                     (default: %s)\n"
literal|"  -m<milenage file> = path for Milenage keys\n"
argument_list|,
name|default_socket_path
argument_list|,
name|default_gsm_triplet_file
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
name|char
modifier|*
name|milenage_file
init|=
name|NULL
decl_stmt|;
name|socket_path
operator|=
name|default_socket_path
expr_stmt|;
name|gsm_triplet_file
operator|=
name|default_gsm_triplet_file
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"g:hm:s:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0
condition|)
break|break;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'g'
case|:
name|gsm_triplet_file
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|usage
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
case|case
literal|'m'
case|:
name|milenage_file
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|socket_path
operator|=
name|optarg
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|milenage_file
operator|&&
name|read_milenage
argument_list|(
name|milenage_file
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|serv_sock
operator|=
name|open_socket
argument_list|(
name|socket_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|serv_sock
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|printf
argument_list|(
literal|"Listening for requests on %s\n"
argument_list|,
name|socket_path
argument_list|)
expr_stmt|;
name|atexit
argument_list|(
name|cleanup
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|handle_term
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|handle_term
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
name|process
argument_list|(
name|serv_sock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / EAP-SIM (draft-haverinen-pppext-eap-sim-13.txt)  * Copyright (c) 2004-2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eap_i.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"eap_sim_common.h"
end_include

begin_define
define|#
directive|define
name|EAP_SIM_VERSION
value|1
end_define

begin_comment
comment|/* EAP-SIM Subtypes */
end_comment

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_START
value|10
end_define

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_CHALLENGE
value|11
end_define

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_NOTIFICATION
value|12
end_define

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_REAUTHENTICATION
value|13
end_define

begin_define
define|#
directive|define
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
value|14
end_define

begin_comment
comment|/* AT_CLIENT_ERROR_CODE error codes */
end_comment

begin_define
define|#
directive|define
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
value|0
end_define

begin_define
define|#
directive|define
name|EAP_SIM_UNSUPPORTED_VERSION
value|1
end_define

begin_define
define|#
directive|define
name|EAP_SIM_INSUFFICIENT_NUM_OF_CHAL
value|2
end_define

begin_define
define|#
directive|define
name|EAP_SIM_RAND_NOT_FRESH
value|3
end_define

begin_define
define|#
directive|define
name|KC_LEN
value|8
end_define

begin_define
define|#
directive|define
name|SRES_LEN
value|4
end_define

begin_define
define|#
directive|define
name|EAP_SIM_MAX_FAST_REAUTHS
value|1000
end_define

begin_struct
struct|struct
name|eap_sim_data
block|{
name|u8
modifier|*
name|ver_list
decl_stmt|;
name|size_t
name|ver_list_len
decl_stmt|;
name|int
name|selected_version
decl_stmt|;
name|int
name|min_num_chal
decl_stmt|,
name|num_chal
decl_stmt|;
name|u8
name|kc
index|[
literal|3
index|]
index|[
name|KC_LEN
index|]
decl_stmt|;
name|u8
name|sres
index|[
literal|3
index|]
index|[
name|SRES_LEN
index|]
decl_stmt|;
name|u8
name|nonce_mt
index|[
name|EAP_SIM_NONCE_MT_LEN
index|]
decl_stmt|,
name|nonce_s
index|[
name|EAP_SIM_NONCE_S_LEN
index|]
decl_stmt|;
name|u8
name|mk
index|[
name|EAP_SIM_MK_LEN
index|]
decl_stmt|;
name|u8
name|k_aut
index|[
name|EAP_SIM_K_AUT_LEN
index|]
decl_stmt|;
name|u8
name|k_encr
index|[
name|EAP_SIM_K_ENCR_LEN
index|]
decl_stmt|;
name|u8
name|msk
index|[
name|EAP_SIM_KEYING_DATA_LEN
index|]
decl_stmt|;
name|u8
name|rand
index|[
literal|3
index|]
index|[
name|GSM_RAND_LEN
index|]
decl_stmt|;
name|int
name|num_id_req
decl_stmt|,
name|num_notification
decl_stmt|;
name|u8
modifier|*
name|pseudonym
decl_stmt|;
name|size_t
name|pseudonym_len
decl_stmt|;
name|u8
modifier|*
name|reauth_id
decl_stmt|;
name|size_t
name|reauth_id_len
decl_stmt|;
name|int
name|reauth
decl_stmt|;
name|unsigned
name|int
name|counter
decl_stmt|,
name|counter_too_small
decl_stmt|;
name|u8
modifier|*
name|last_eap_identity
decl_stmt|;
name|size_t
name|last_eap_identity_len
decl_stmt|;
enum|enum
block|{
name|CONTINUE
block|,
name|SUCCESS
block|,
name|FAILURE
block|}
name|state
enum|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
modifier|*
name|eap_sim_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|data
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_get_rand
argument_list|(
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to get random data "
literal|"for NONCE_MT"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|min_num_chal
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|config
operator|&&
name|config
operator|->
name|phase1
condition|)
block|{
name|char
modifier|*
name|pos
init|=
name|strstr
argument_list|(
name|config
operator|->
name|phase1
argument_list|,
literal|"sim_min_num_chal="
argument_list|)
decl_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|data
operator|->
name|min_num_chal
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|17
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|min_num_chal
operator|<
literal|2
operator|||
name|data
operator|->
name|min_num_chal
operator|>
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Invalid "
literal|"sim_min_num_chal configuration "
literal|"(%d, expected 2 or 3)"
argument_list|,
name|data
operator|->
name|min_num_chal
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Set minimum number of "
literal|"challenges to %d"
argument_list|,
name|data
operator|->
name|min_num_chal
argument_list|)
expr_stmt|;
block|}
block|}
name|data
operator|->
name|state
operator|=
name|CONTINUE
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_deinit
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|free
argument_list|(
name|data
operator|->
name|ver_list
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|last_eap_identity
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_gsm_auth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: GSM authentication algorithm"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PCSC_FUNCS
if|if
condition|(
name|scard_gsm_auth
argument_list|(
name|sm
operator|->
name|scard_ctx
argument_list|,
name|data
operator|->
name|rand
index|[
literal|0
index|]
argument_list|,
name|data
operator|->
name|sres
index|[
literal|0
index|]
argument_list|,
name|data
operator|->
name|kc
index|[
literal|0
index|]
argument_list|)
operator|||
name|scard_gsm_auth
argument_list|(
name|sm
operator|->
name|scard_ctx
argument_list|,
name|data
operator|->
name|rand
index|[
literal|1
index|]
argument_list|,
name|data
operator|->
name|sres
index|[
literal|1
index|]
argument_list|,
name|data
operator|->
name|kc
index|[
literal|1
index|]
argument_list|)
operator|||
operator|(
name|data
operator|->
name|num_chal
operator|>
literal|2
operator|&&
name|scard_gsm_auth
argument_list|(
name|sm
operator|->
name|scard_ctx
argument_list|,
name|data
operator|->
name|rand
index|[
literal|2
index|]
argument_list|,
name|data
operator|->
name|sres
index|[
literal|2
index|]
argument_list|,
name|data
operator|->
name|kc
index|[
literal|2
index|]
argument_list|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: GSM SIM authentication could "
literal|"not be completed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|#
directive|else
comment|/* PCSC_FUNCS */
comment|/* These hardcoded Kc and SRES values are used for testing. RAND to 	 * KC/SREC mapping is very bogus as far as real authentication is 	 * concerned, but it is quite useful for cases where the AS is rotating 	 * the order of pre-configured values. */
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|num_chal
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|data
operator|->
name|rand
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|0xaa
condition|)
block|{
name|memcpy
argument_list|(
name|data
operator|->
name|kc
index|[
name|i
index|]
argument_list|,
literal|"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7"
argument_list|,
name|KC_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|sres
index|[
name|i
index|]
argument_list|,
literal|"\xd1\xd2\xd3\xd4"
argument_list|,
name|SRES_LEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|rand
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|0xbb
condition|)
block|{
name|memcpy
argument_list|(
name|data
operator|->
name|kc
index|[
name|i
index|]
argument_list|,
literal|"\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7"
argument_list|,
name|KC_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|sres
index|[
name|i
index|]
argument_list|,
literal|"\xe1\xe2\xe3\xe4"
argument_list|,
name|SRES_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|data
operator|->
name|kc
index|[
name|i
index|]
argument_list|,
literal|"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7"
argument_list|,
name|KC_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|sres
index|[
name|i
index|]
argument_list|,
literal|"\xf1\xf2\xf3\xf4"
argument_list|,
name|SRES_LEN
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* PCSC_FUNCS */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_supported_ver
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|version
parameter_list|)
block|{
return|return
name|version
operator|==
name|EAP_SIM_VERSION
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_derive_mk
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|identity
parameter_list|,
name|size_t
name|identity_len
parameter_list|)
block|{
name|u8
name|sel_ver
index|[
literal|2
index|]
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|addr
index|[
literal|5
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|5
index|]
decl_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|identity
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|identity_len
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|kc
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|data
operator|->
name|num_chal
operator|*
name|KC_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|data
operator|->
name|nonce_mt
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|EAP_SIM_NONCE_MT_LEN
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|data
operator|->
name|ver_list
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|data
operator|->
name|ver_list_len
expr_stmt|;
name|addr
index|[
literal|4
index|]
operator|=
name|sel_ver
expr_stmt|;
name|len
index|[
literal|4
index|]
operator|=
literal|2
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|sel_ver
argument_list|,
name|data
operator|->
name|selected_version
argument_list|)
expr_stmt|;
comment|/* MK = SHA1(Identity|n*Kc|NONCE_MT|Version List|Selected Version) */
name|sha1_vector
argument_list|(
literal|5
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: MK"
argument_list|,
name|data
operator|->
name|mk
argument_list|,
name|EAP_SIM_MK_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|CLEAR_PSEUDONYM
value|0x01
end_define

begin_define
define|#
directive|define
name|CLEAR_REAUTH_ID
value|0x02
end_define

begin_define
define|#
directive|define
name|CLEAR_EAP_ID
value|0x04
end_define

begin_function
specifier|static
name|void
name|eap_sim_clear_identities
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: forgetting old%s%s%s"
argument_list|,
name|id
operator|&
name|CLEAR_PSEUDONYM
condition|?
literal|" pseudonym"
else|:
literal|""
argument_list|,
name|id
operator|&
name|CLEAR_REAUTH_ID
condition|?
literal|" reauth_id"
else|:
literal|""
argument_list|,
name|id
operator|&
name|CLEAR_EAP_ID
condition|?
literal|" eap_id"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|&
name|CLEAR_PSEUDONYM
condition|)
block|{
name|free
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|)
expr_stmt|;
name|data
operator|->
name|pseudonym
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|pseudonym_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|id
operator|&
name|CLEAR_REAUTH_ID
condition|)
block|{
name|free
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|id
operator|&
name|CLEAR_EAP_ID
condition|)
block|{
name|free
argument_list|(
name|data
operator|->
name|last_eap_identity
argument_list|)
expr_stmt|;
name|data
operator|->
name|last_eap_identity
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|last_eap_identity_len
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_learn_ids
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|attr
operator|->
name|next_pseudonym
condition|)
block|{
name|free
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|)
expr_stmt|;
name|data
operator|->
name|pseudonym
operator|=
name|malloc
argument_list|(
name|attr
operator|->
name|next_pseudonym_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|pseudonym
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: (encr) No memory for "
literal|"next pseudonym"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|,
name|attr
operator|->
name|next_pseudonym
argument_list|,
name|attr
operator|->
name|next_pseudonym_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|pseudonym_len
operator|=
name|attr
operator|->
name|next_pseudonym_len
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: (encr) AT_NEXT_PSEUDONYM"
argument_list|,
name|data
operator|->
name|pseudonym
argument_list|,
name|data
operator|->
name|pseudonym_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|->
name|next_reauth_id
condition|)
block|{
name|free
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id
operator|=
name|malloc
argument_list|(
name|attr
operator|->
name|next_reauth_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: (encr) No memory for "
literal|"next reauth_id"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|,
name|attr
operator|->
name|next_reauth_id
argument_list|,
name|attr
operator|->
name|next_reauth_id_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
name|attr
operator|->
name|next_reauth_id_len
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: (encr) AT_NEXT_REAUTH_ID"
argument_list|,
name|data
operator|->
name|reauth_id
argument_list|,
name|data
operator|->
name|reauth_id_len
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_client_error
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|data
operator|->
name|state
operator|=
name|FAILURE
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_CLIENT_ERROR_CODE
argument_list|,
name|err
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|respDataLen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_response_start
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|,
name|enum
name|eap_sim_id_req
name|id_req
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|identity
init|=
name|NULL
decl_stmt|;
name|size_t
name|identity_len
init|=
literal|0
decl_stmt|;
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|data
operator|->
name|reauth
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|id_req
operator|==
name|ANY_ID
operator|&&
name|data
operator|->
name|reauth_id
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|reauth_id
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|reauth_id_len
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|id_req
operator|==
name|ANY_ID
operator|||
name|id_req
operator|==
name|FULLAUTH_ID
operator|)
operator|&&
name|data
operator|->
name|pseudonym
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|pseudonym
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|pseudonym_len
expr_stmt|;
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_REAUTH_ID
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|id_req
operator|!=
name|NO_ID_REQ
operator|&&
name|config
operator|&&
name|config
operator|->
name|identity
condition|)
block|{
name|identity
operator|=
name|config
operator|->
name|identity
expr_stmt|;
name|identity_len
operator|=
name|config
operator|->
name|identity_len
expr_stmt|;
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_PSEUDONYM
operator||
name|CLEAR_REAUTH_ID
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|id_req
operator|!=
name|NO_ID_REQ
condition|)
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-SIM Start (id=%d)"
argument_list|,
name|req
operator|->
name|identifier
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_START
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_NONCE_MT"
argument_list|,
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NONCE_MT
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_SELECTED_VERSION %d"
argument_list|,
name|data
operator|->
name|selected_version
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_SELECTED_VERSION
argument_list|,
name|data
operator|->
name|selected_version
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|identity
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IDENTITY"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IDENTITY
argument_list|,
name|identity_len
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
block|}
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|respDataLen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_response_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-SIM Challenge (id=%d)"
argument_list|,
name|req
operator|->
name|identifier
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_CHALLENGE
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|respDataLen
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|sres
argument_list|,
name|data
operator|->
name|num_chal
operator|*
name|SRES_LEN
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_response_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|,
name|int
name|counter_too_small
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|int
name|counter
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-SIM Reauthentication (id=%d)"
argument_list|,
name|req
operator|->
name|identifier
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_REAUTHENTICATION
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IV"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_encr_start
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IV
argument_list|,
name|EAP_SIM_AT_ENCR_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|counter_too_small
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER_TOO_SMALL"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER_TOO_SMALL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|counter
operator|=
name|data
operator|->
name|counter_too_small
expr_stmt|;
block|}
else|else
name|counter
operator|=
name|data
operator|->
name|counter
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER %d"
argument_list|,
name|counter
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER
argument_list|,
name|counter
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_msg_add_encr_end
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_AT_PADDING
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to encrypt "
literal|"AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|respDataLen
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_response_notification
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|,
name|u16
name|notification
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|u8
modifier|*
name|k_aut
init|=
operator|(
name|notification
operator|&
literal|0x4000
operator|)
operator|==
literal|0
condition|?
name|data
operator|->
name|k_aut
else|:
name|NULL
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-SIM Notification (id=%d)"
argument_list|,
name|req
operator|->
name|identifier
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_NOTIFICATION
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_NOTIFICATION"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NOTIFICATION
argument_list|,
name|notification
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|k_aut
operator|&&
name|data
operator|->
name|reauth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IV"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_encr_start
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IV
argument_list|,
name|EAP_SIM_AT_ENCR_DATA
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER %d"
argument_list|,
name|data
operator|->
name|counter
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER
argument_list|,
name|data
operator|->
name|counter
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_msg_add_encr_end
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_AT_PADDING
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to encrypt "
literal|"AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|k_aut
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
block|}
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|respDataLen
argument_list|,
name|k_aut
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_process_start
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|selected_version
init|=
operator|-
literal|1
decl_stmt|,
name|id_error
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Start"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|version_list
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: No AT_VERSION_LIST in "
literal|"SIM/Start"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNSUPPORTED_VERSION
argument_list|)
return|;
block|}
name|free
argument_list|(
name|data
operator|->
name|ver_list
argument_list|)
expr_stmt|;
name|data
operator|->
name|ver_list
operator|=
name|malloc
argument_list|(
name|attr
operator|->
name|version_list_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|ver_list
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Failed to allocate "
literal|"memory for version list"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|memcpy
argument_list|(
name|data
operator|->
name|ver_list
argument_list|,
name|attr
operator|->
name|version_list
argument_list|,
name|attr
operator|->
name|version_list_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|ver_list_len
operator|=
name|attr
operator|->
name|version_list_len
expr_stmt|;
name|pos
operator|=
name|data
operator|->
name|ver_list
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|ver_list_len
operator|/
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|int
name|ver
init|=
name|pos
index|[
literal|0
index|]
operator|*
literal|256
operator|+
name|pos
index|[
literal|1
index|]
decl_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|eap_sim_supported_ver
argument_list|(
name|data
argument_list|,
name|ver
argument_list|)
condition|)
block|{
name|selected_version
operator|=
name|ver
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|selected_version
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Could not find a supported "
literal|"version"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNSUPPORTED_VERSION
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Selected Version %d"
argument_list|,
name|selected_version
argument_list|)
expr_stmt|;
name|data
operator|->
name|selected_version
operator|=
name|selected_version
expr_stmt|;
name|id_error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|attr
operator|->
name|id_req
condition|)
block|{
case|case
name|NO_ID_REQ
case|:
break|break;
case|case
name|ANY_ID
case|:
if|if
condition|(
name|data
operator|->
name|num_id_req
operator|>
literal|0
condition|)
name|id_error
operator|++
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|++
expr_stmt|;
break|break;
case|case
name|FULLAUTH_ID
case|:
if|if
condition|(
name|data
operator|->
name|num_id_req
operator|>
literal|1
condition|)
name|id_error
operator|++
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|++
expr_stmt|;
break|break;
case|case
name|PERMANENT_ID
case|:
if|if
condition|(
name|data
operator|->
name|num_id_req
operator|>
literal|2
condition|)
name|id_error
operator|++
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|id_error
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Too many ID requests "
literal|"used within one authentication"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
return|return
name|eap_sim_response_start
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|attr
operator|->
name|id_req
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_process_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|identity
decl_stmt|;
name|size_t
name|identity_len
decl_stmt|;
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Challenge"
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|attr
operator|->
name|mac
operator|||
operator|!
name|attr
operator|->
name|rand
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Challenge message "
literal|"did not include%s%s"
argument_list|,
operator|!
name|attr
operator|->
name|mac
condition|?
literal|" AT_MAC"
else|:
literal|""
argument_list|,
operator|!
name|attr
operator|->
name|rand
condition|?
literal|" AT_RAND"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: %lu challenges"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|attr
operator|->
name|num_chal
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|num_chal
operator|<
name|data
operator|->
name|min_num_chal
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Insufficient number of "
literal|"challenges (%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|attr
operator|->
name|num_chal
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_INSUFFICIENT_NUM_OF_CHAL
argument_list|)
return|;
block|}
if|if
condition|(
name|attr
operator|->
name|num_chal
operator|>
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Too many challenges "
literal|"(%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|attr
operator|->
name|num_chal
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
comment|/* Verify that RANDs are different */
if|if
condition|(
name|memcmp
argument_list|(
name|attr
operator|->
name|rand
argument_list|,
name|attr
operator|->
name|rand
operator|+
name|GSM_RAND_LEN
argument_list|,
name|GSM_RAND_LEN
argument_list|)
operator|==
literal|0
operator|||
operator|(
name|attr
operator|->
name|num_chal
operator|>
literal|2
operator|&&
operator|(
name|memcmp
argument_list|(
name|attr
operator|->
name|rand
argument_list|,
name|attr
operator|->
name|rand
operator|+
literal|2
operator|*
name|GSM_RAND_LEN
argument_list|,
name|GSM_RAND_LEN
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|attr
operator|->
name|rand
operator|+
name|GSM_RAND_LEN
argument_list|,
name|attr
operator|->
name|rand
operator|+
literal|2
operator|*
name|GSM_RAND_LEN
argument_list|,
name|GSM_RAND_LEN
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Same RAND used multiple times"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_RAND_NOT_FRESH
argument_list|)
return|;
block|}
name|memcpy
argument_list|(
name|data
operator|->
name|rand
argument_list|,
name|attr
operator|->
name|rand
argument_list|,
name|attr
operator|->
name|num_chal
operator|*
name|GSM_RAND_LEN
argument_list|)
expr_stmt|;
name|data
operator|->
name|num_chal
operator|=
name|attr
operator|->
name|num_chal
expr_stmt|;
if|if
condition|(
name|eap_sim_gsm_auth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: GSM authentication failed"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|data
operator|->
name|last_eap_identity
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|last_eap_identity
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|last_eap_identity_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|pseudonym
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|pseudonym
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|pseudonym_len
expr_stmt|;
block|}
else|else
block|{
name|identity
operator|=
name|config
operator|->
name|identity
expr_stmt|;
name|identity_len
operator|=
name|config
operator|->
name|identity_len
expr_stmt|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Selected identity for MK "
literal|"derivation"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
name|eap_sim_derive_mk
argument_list|(
name|data
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|msk
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|req
argument_list|,
name|reqDataLen
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Challenge message "
literal|"used invalid AT_MAC"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
comment|/* Old reauthentication and pseudonym identities must not be used 	 * anymore. In other words, if no new identities are received, full 	 * authentication will be used on next reauthentication. */
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_PSEUDONYM
operator||
name|CLEAR_REAUTH_ID
operator||
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|encr_data
condition|)
block|{
name|u8
modifier|*
name|decrypted
decl_stmt|;
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|eap_sim_learn_ids
argument_list|(
name|data
argument_list|,
operator|&
name|eattr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|FAILURE
condition|)
name|data
operator|->
name|state
operator|=
name|SUCCESS
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
comment|/* draft-haverinen-pppext-eap-sim-13.txt specifies that counter 	 * is initialized to one after fullauth, but initializing it to 	 * zero makes it easier to implement reauth verification. */
name|data
operator|->
name|counter
operator|=
literal|0
expr_stmt|;
return|return
name|eap_sim_response_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_process_notification_reauth
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|u8
modifier|*
name|decrypted
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|encr_data
operator|==
name|NULL
operator|||
name|attr
operator|->
name|iv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Notification message after "
literal|"reauth did not include encrypted data"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to parse encrypted "
literal|"data from notification message"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eattr
operator|.
name|counter
operator|!=
name|data
operator|->
name|counter
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Counter in notification "
literal|"message does not match with counter in reauth "
literal|"message"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_process_notification_auth
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|attr
operator|->
name|mac
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: no AT_MAC in after_auth "
literal|"Notification message"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|req
argument_list|,
name|reqDataLen
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Notification message "
literal|"used invalid AT_MAC"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|data
operator|->
name|reauth
operator|&&
name|eap_sim_process_notification_reauth
argument_list|(
name|data
argument_list|,
name|req
argument_list|,
name|reqDataLen
argument_list|,
name|attr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Invalid notification "
literal|"message after reauth"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_process_notification
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Notification"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|num_notification
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: too many notification "
literal|"rounds (only one allowed)"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|data
operator|->
name|num_notification
operator|++
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|notification
operator|==
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: no AT_NOTIFICATION in "
literal|"Notification message"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
operator|(
name|attr
operator|->
name|notification
operator|&
literal|0x4000
operator|)
operator|==
literal|0
operator|&&
name|eap_sim_process_notification_auth
argument_list|(
name|data
argument_list|,
name|req
argument_list|,
name|reqDataLen
argument_list|,
name|attr
argument_list|)
condition|)
block|{
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|eap_sim_report_notification
argument_list|(
name|sm
operator|->
name|msg_ctx
argument_list|,
name|attr
operator|->
name|notification
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|notification
operator|>=
literal|0
operator|&&
name|attr
operator|->
name|notification
operator|<
literal|32768
condition|)
block|{
name|data
operator|->
name|state
operator|=
name|FAILURE
expr_stmt|;
block|}
return|return
name|eap_sim_response_notification
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|attr
operator|->
name|notification
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_process_reauthentication
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|u8
modifier|*
name|decrypted
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Reauthentication"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Server is trying "
literal|"reauthentication, but no reauth_id available"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|data
operator|->
name|reauth
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|req
argument_list|,
name|reqDataLen
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Reauthentication "
literal|"did not have valid AT_MAC"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|attr
operator|->
name|encr_data
operator|==
name|NULL
operator|||
name|attr
operator|->
name|iv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Reauthentication "
literal|"message did not include encrypted data"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to parse encrypted "
literal|"data from reauthentication message"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|eattr
operator|.
name|nonce_s
operator|==
name|NULL
operator|||
name|eattr
operator|.
name|counter
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: (encr) No%s%s in reauth packet"
argument_list|,
operator|!
name|eattr
operator|.
name|nonce_s
condition|?
literal|" AT_NONCE_S"
else|:
literal|""
argument_list|,
name|eattr
operator|.
name|counter
operator|<
literal|0
condition|?
literal|" AT_COUNTER"
else|:
literal|""
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|eattr
operator|.
name|counter
operator|<=
name|data
operator|->
name|counter
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: (encr) Invalid counter "
literal|"(%d<= %d)"
argument_list|,
name|eattr
operator|.
name|counter
argument_list|,
name|data
operator|->
name|counter
argument_list|)
expr_stmt|;
name|data
operator|->
name|counter_too_small
operator|=
name|eattr
operator|.
name|counter
expr_stmt|;
comment|/* Reply using Re-auth w/ AT_COUNTER_TOO_SMALL. The current 		 * reauth_id must not be used to start a new reauthentication. 		 * However, since it was used in the last EAP-Response-Identity 		 * packet, it has to saved for the following fullauth to be 		 * used in MK derivation. */
name|free
argument_list|(
name|data
operator|->
name|last_eap_identity
argument_list|)
expr_stmt|;
name|data
operator|->
name|last_eap_identity
operator|=
name|data
operator|->
name|reauth_id
expr_stmt|;
name|data
operator|->
name|last_eap_identity_len
operator|=
name|data
operator|->
name|reauth_id_len
expr_stmt|;
name|data
operator|->
name|reauth_id
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|eap_sim_response_reauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
literal|1
argument_list|)
return|;
block|}
name|data
operator|->
name|counter
operator|=
name|eattr
operator|.
name|counter
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|nonce_s
argument_list|,
name|eattr
operator|.
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: (encr) AT_NONCE_S"
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys_reauth
argument_list|(
name|data
operator|->
name|counter
argument_list|,
name|data
operator|->
name|reauth_id
argument_list|,
name|data
operator|->
name|reauth_id_len
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|msk
argument_list|)
expr_stmt|;
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_REAUTH_ID
operator||
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
name|eap_sim_learn_ids
argument_list|(
name|data
argument_list|,
operator|&
name|eattr
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|FAILURE
condition|)
name|data
operator|->
name|state
operator|=
name|SUCCESS
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|counter
operator|>
name|EAP_SIM_MAX_FAST_REAUTHS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Maximum number of "
literal|"fast reauths performed - force fullauth"
argument_list|)
expr_stmt|;
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_REAUTH_ID
operator||
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|eap_sim_response_reauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_process
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|u8
modifier|*
name|reqData
parameter_list|,
name|size_t
name|reqDataLen
parameter_list|,
name|size_t
modifier|*
name|respDataLen
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
decl_stmt|;
name|u8
name|subtype
decl_stmt|,
modifier|*
name|res
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|eap_sim_attrs
name|attr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: EAP data"
argument_list|,
name|reqData
argument_list|,
name|reqDataLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|==
name|NULL
operator|||
name|config
operator|->
name|identity
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Identity not configured"
argument_list|)
expr_stmt|;
name|eap_sm_request_identity
argument_list|(
name|sm
argument_list|,
name|config
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|eap_hdr_validate
argument_list|(
name|EAP_TYPE_SIM
argument_list|,
name|reqData
argument_list|,
name|reqDataLen
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
operator|||
name|len
operator|<
literal|1
condition|)
block|{
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|req
operator|=
operator|(
specifier|const
expr|struct
name|eap_hdr
operator|*
operator|)
name|reqData
expr_stmt|;
name|len
operator|=
name|be_to_host16
argument_list|(
name|req
operator|->
name|length
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|FALSE
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_MAY_CONT
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|ret
operator|->
name|allowNotifications
operator|=
name|TRUE
expr_stmt|;
name|subtype
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Subtype=%d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* Reserved */
if|if
condition|(
name|eap_sim_parse_attr
argument_list|(
name|pos
argument_list|,
name|reqData
operator|+
name|len
argument_list|,
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|res
operator|=
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|subtype
condition|)
block|{
case|case
name|EAP_SIM_SUBTYPE_START
case|:
name|res
operator|=
name|eap_sim_process_start
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|len
argument_list|,
name|respDataLen
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_SIM_SUBTYPE_CHALLENGE
case|:
name|res
operator|=
name|eap_sim_process_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|len
argument_list|,
name|respDataLen
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_SIM_SUBTYPE_NOTIFICATION
case|:
name|res
operator|=
name|eap_sim_process_notification
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|len
argument_list|,
name|respDataLen
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_SIM_SUBTYPE_REAUTHENTICATION
case|:
name|res
operator|=
name|eap_sim_process_reauthentication
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|len
argument_list|,
name|respDataLen
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Client-Error"
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Unknown subtype=%d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_sim_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|req
argument_list|,
name|respDataLen
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
expr_stmt|;
break|break;
block|}
name|done
label|:
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|FAILURE
condition|)
block|{
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|SUCCESS
condition|)
block|{
name|ret
operator|->
name|decision
operator|=
name|DECISION_COND_SUCC
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|->
name|methodState
operator|==
name|METHOD_DONE
condition|)
block|{
name|ret
operator|->
name|allowNotifications
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_has_reauth_data
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|pseudonym
operator|||
name|data
operator|->
name|reauth_id
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_deinit_for_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_sim_init_for_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|hostapd_get_rand
argument_list|(
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to get random data "
literal|"for NONCE_MT"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|state
operator|=
name|CONTINUE
expr_stmt|;
return|return
name|priv
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|eap_sim_get_identity
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth_id
condition|)
block|{
operator|*
name|len
operator|=
name|data
operator|->
name|reauth_id_len
expr_stmt|;
return|return
name|data
operator|->
name|reauth_id
return|;
block|}
if|if
condition|(
name|data
operator|->
name|pseudonym
condition|)
block|{
operator|*
name|len
operator|=
name|data
operator|->
name|pseudonym_len
expr_stmt|;
return|return
name|data
operator|->
name|pseudonym
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_isKeyAvailable
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|state
operator|==
name|SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_getKey
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|malloc
argument_list|(
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|EAP_SIM_KEYING_DATA_LEN
expr_stmt|;
name|memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|eap_method
name|eap_method_sim
init|=
block|{
operator|.
name|method
operator|=
name|EAP_TYPE_SIM
block|,
operator|.
name|name
operator|=
literal|"SIM"
block|,
operator|.
name|init
operator|=
name|eap_sim_init
block|,
operator|.
name|deinit
operator|=
name|eap_sim_deinit
block|,
operator|.
name|process
operator|=
name|eap_sim_process
block|,
operator|.
name|isKeyAvailable
operator|=
name|eap_sim_isKeyAvailable
block|,
operator|.
name|getKey
operator|=
name|eap_sim_getKey
block|,
operator|.
name|has_reauth_data
operator|=
name|eap_sim_has_reauth_data
block|,
operator|.
name|deinit_for_reauth
operator|=
name|eap_sim_deinit_for_reauth
block|,
operator|.
name|init_for_reauth
operator|=
name|eap_sim_init_for_reauth
block|,
operator|.
name|get_identity
operator|=
name|eap_sim_get_identity
block|, }
decl_stmt|;
end_decl_stmt

end_unit


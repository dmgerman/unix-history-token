begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - Windows/NDIS driver interface  * Copyright (c) 2004-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__CYGWIN__
end_ifdef

begin_comment
comment|/* Avoid some header file conflicts by not including standard headers for  * cygwin builds when Packet32.h is included. */
end_comment

begin_include
include|#
directive|include
file|"build_config.h"
end_include

begin_function_decl
name|int
name|close
parameter_list|(
name|int
name|fd
parameter_list|)
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* __CYGWIN__ */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __CYGWIN__ */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_USE_NDISUIO
end_ifdef

begin_include
include|#
directive|include
file|<winsock2.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CONFIG_USE_NDISUIO */
end_comment

begin_include
include|#
directive|include
file|<Packet32.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_USE_NDISUIO */
end_comment

begin_include
include|#
directive|include
file|<ntddndis.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32_WCE
end_ifdef

begin_include
include|#
directive|include
file|<winioctl.h>
end_include

begin_include
include|#
directive|include
file|<nuiouser.h>
end_include

begin_include
include|#
directive|include
file|<devload.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _WIN32_WCE */
end_comment

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"driver_ndis.h"
end_include

begin_function_decl
name|int
name|wpa_driver_register_event_cb
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|wpa_driver_ndis_event_pipe_cb
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_driver_ndis_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_driver_ndis_poll
parameter_list|(
name|void
modifier|*
name|drv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_driver_ndis_poll_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpa_driver_ndis_adapter_init
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpa_driver_ndis_adapter_open
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_driver_ndis_adapter_close
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* FIX: to be removed once this can be compiled with the complete NDIS  * header files */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|OID_802_11_BSSID
end_ifndef

begin_define
define|#
directive|define
name|OID_802_11_BSSID
value|0x0d010101
end_define

begin_define
define|#
directive|define
name|OID_802_11_SSID
value|0x0d010102
end_define

begin_define
define|#
directive|define
name|OID_802_11_INFRASTRUCTURE_MODE
value|0x0d010108
end_define

begin_define
define|#
directive|define
name|OID_802_11_ADD_WEP
value|0x0D010113
end_define

begin_define
define|#
directive|define
name|OID_802_11_REMOVE_WEP
value|0x0D010114
end_define

begin_define
define|#
directive|define
name|OID_802_11_DISASSOCIATE
value|0x0D010115
end_define

begin_define
define|#
directive|define
name|OID_802_11_BSSID_LIST
value|0x0d010217
end_define

begin_define
define|#
directive|define
name|OID_802_11_AUTHENTICATION_MODE
value|0x0d010118
end_define

begin_define
define|#
directive|define
name|OID_802_11_PRIVACY_FILTER
value|0x0d010119
end_define

begin_define
define|#
directive|define
name|OID_802_11_BSSID_LIST_SCAN
value|0x0d01011A
end_define

begin_define
define|#
directive|define
name|OID_802_11_WEP_STATUS
value|0x0d01011B
end_define

begin_define
define|#
directive|define
name|OID_802_11_ENCRYPTION_STATUS
value|OID_802_11_WEP_STATUS
end_define

begin_define
define|#
directive|define
name|OID_802_11_ADD_KEY
value|0x0d01011D
end_define

begin_define
define|#
directive|define
name|OID_802_11_REMOVE_KEY
value|0x0d01011E
end_define

begin_define
define|#
directive|define
name|OID_802_11_ASSOCIATION_INFORMATION
value|0x0d01011F
end_define

begin_define
define|#
directive|define
name|OID_802_11_TEST
value|0x0d010120
end_define

begin_define
define|#
directive|define
name|OID_802_11_CAPABILITY
value|0x0d010122
end_define

begin_define
define|#
directive|define
name|OID_802_11_PMKID
value|0x0d010123
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_LENGTH_SSID
value|32
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_LENGTH_RATES
value|8
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_LENGTH_RATES_EX
value|16
end_define

begin_typedef
typedef|typedef
name|UCHAR
name|NDIS_802_11_MAC_ADDRESS
index|[
literal|6
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_SSID
block|{
name|ULONG
name|SsidLength
decl_stmt|;
name|UCHAR
name|Ssid
index|[
name|NDIS_802_11_LENGTH_SSID
index|]
decl_stmt|;
block|}
name|NDIS_802_11_SSID
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|LONG
name|NDIS_802_11_RSSI
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_NETWORK_TYPE
block|{
name|Ndis802_11FH
block|,
name|Ndis802_11DS
block|,
name|Ndis802_11OFDM5
block|,
name|Ndis802_11OFDM24
block|,
name|Ndis802_11NetworkTypeMax
block|}
name|NDIS_802_11_NETWORK_TYPE
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_CONFIGURATION_FH
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|HopPattern
decl_stmt|;
name|ULONG
name|HopSet
decl_stmt|;
name|ULONG
name|DwellTime
decl_stmt|;
block|}
name|NDIS_802_11_CONFIGURATION_FH
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_CONFIGURATION
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|BeaconPeriod
decl_stmt|;
name|ULONG
name|ATIMWindow
decl_stmt|;
name|ULONG
name|DSConfig
decl_stmt|;
name|NDIS_802_11_CONFIGURATION_FH
name|FHConfig
decl_stmt|;
block|}
name|NDIS_802_11_CONFIGURATION
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_NETWORK_INFRASTRUCTURE
block|{
name|Ndis802_11IBSS
block|,
name|Ndis802_11Infrastructure
block|,
name|Ndis802_11AutoUnknown
block|,
name|Ndis802_11InfrastructureMax
block|}
name|NDIS_802_11_NETWORK_INFRASTRUCTURE
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_AUTHENTICATION_MODE
block|{
name|Ndis802_11AuthModeOpen
block|,
name|Ndis802_11AuthModeShared
block|,
name|Ndis802_11AuthModeAutoSwitch
block|,
name|Ndis802_11AuthModeWPA
block|,
name|Ndis802_11AuthModeWPAPSK
block|,
name|Ndis802_11AuthModeWPANone
block|,
name|Ndis802_11AuthModeWPA2
block|,
name|Ndis802_11AuthModeWPA2PSK
block|,
name|Ndis802_11AuthModeMax
block|}
name|NDIS_802_11_AUTHENTICATION_MODE
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_WEP_STATUS
block|{
name|Ndis802_11WEPEnabled
block|,
name|Ndis802_11Encryption1Enabled
init|=
name|Ndis802_11WEPEnabled
block|,
name|Ndis802_11WEPDisabled
block|,
name|Ndis802_11EncryptionDisabled
init|=
name|Ndis802_11WEPDisabled
block|,
name|Ndis802_11WEPKeyAbsent
block|,
name|Ndis802_11Encryption1KeyAbsent
init|=
name|Ndis802_11WEPKeyAbsent
block|,
name|Ndis802_11WEPNotSupported
block|,
name|Ndis802_11EncryptionNotSupported
init|=
name|Ndis802_11WEPNotSupported
block|,
name|Ndis802_11Encryption2Enabled
block|,
name|Ndis802_11Encryption2KeyAbsent
block|,
name|Ndis802_11Encryption3Enabled
block|,
name|Ndis802_11Encryption3KeyAbsent
block|}
name|NDIS_802_11_WEP_STATUS
operator|,
name|NDIS_802_11_ENCRYPTION_STATUS
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_PRIVACY_FILTER
block|{
name|Ndis802_11PrivFilterAcceptAll
block|,
name|Ndis802_11PrivFilter8021xWEP
block|}
name|NDIS_802_11_PRIVACY_FILTER
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|UCHAR
name|NDIS_802_11_RATES
index|[
name|NDIS_802_11_LENGTH_RATES
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|UCHAR
name|NDIS_802_11_RATES_EX
index|[
name|NDIS_802_11_LENGTH_RATES_EX
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_WLAN_BSSID_EX
block|{
name|ULONG
name|Length
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|MacAddress
decl_stmt|;
comment|/* BSSID */
name|UCHAR
name|Reserved
index|[
literal|2
index|]
decl_stmt|;
name|NDIS_802_11_SSID
name|Ssid
decl_stmt|;
name|ULONG
name|Privacy
decl_stmt|;
name|NDIS_802_11_RSSI
name|Rssi
decl_stmt|;
name|NDIS_802_11_NETWORK_TYPE
name|NetworkTypeInUse
decl_stmt|;
name|NDIS_802_11_CONFIGURATION
name|Configuration
decl_stmt|;
name|NDIS_802_11_NETWORK_INFRASTRUCTURE
name|InfrastructureMode
decl_stmt|;
name|NDIS_802_11_RATES_EX
name|SupportedRates
decl_stmt|;
name|ULONG
name|IELength
decl_stmt|;
name|UCHAR
name|IEs
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_WLAN_BSSID_EX
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_BSSID_LIST_EX
block|{
name|ULONG
name|NumberOfItems
decl_stmt|;
name|NDIS_WLAN_BSSID_EX
name|Bssid
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_BSSID_LIST_EX
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_FIXED_IEs
block|{
name|UCHAR
name|Timestamp
index|[
literal|8
index|]
decl_stmt|;
name|USHORT
name|BeaconInterval
decl_stmt|;
name|USHORT
name|Capabilities
decl_stmt|;
block|}
name|NDIS_802_11_FIXED_IEs
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_WEP
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|KeyIndex
decl_stmt|;
name|ULONG
name|KeyLength
decl_stmt|;
name|UCHAR
name|KeyMaterial
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_WEP
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ULONG
name|NDIS_802_11_KEY_INDEX
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|ULONGLONG
name|NDIS_802_11_KEY_RSC
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_KEY
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|KeyIndex
decl_stmt|;
name|ULONG
name|KeyLength
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
name|NDIS_802_11_KEY_RSC
name|KeyRSC
decl_stmt|;
name|UCHAR
name|KeyMaterial
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_KEY
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_REMOVE_KEY
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|KeyIndex
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
block|}
name|NDIS_802_11_REMOVE_KEY
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_AI_REQFI
block|{
name|USHORT
name|Capabilities
decl_stmt|;
name|USHORT
name|ListenInterval
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|CurrentAPAddress
decl_stmt|;
block|}
name|NDIS_802_11_AI_REQFI
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_AI_RESFI
block|{
name|USHORT
name|Capabilities
decl_stmt|;
name|USHORT
name|StatusCode
decl_stmt|;
name|USHORT
name|AssociationId
decl_stmt|;
block|}
name|NDIS_802_11_AI_RESFI
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_ASSOCIATION_INFORMATION
block|{
name|ULONG
name|Length
decl_stmt|;
name|USHORT
name|AvailableRequestFixedIEs
decl_stmt|;
name|NDIS_802_11_AI_REQFI
name|RequestFixedIEs
decl_stmt|;
name|ULONG
name|RequestIELength
decl_stmt|;
name|ULONG
name|OffsetRequestIEs
decl_stmt|;
name|USHORT
name|AvailableResponseFixedIEs
decl_stmt|;
name|NDIS_802_11_AI_RESFI
name|ResponseFixedIEs
decl_stmt|;
name|ULONG
name|ResponseIELength
decl_stmt|;
name|ULONG
name|OffsetResponseIEs
decl_stmt|;
block|}
name|NDIS_802_11_ASSOCIATION_INFORMATION
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
block|{
name|NDIS_802_11_AUTHENTICATION_MODE
name|AuthModeSupported
decl_stmt|;
name|NDIS_802_11_ENCRYPTION_STATUS
name|EncryptStatusSupported
decl_stmt|;
block|}
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_CAPABILITY
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|Version
decl_stmt|;
name|ULONG
name|NoOfPMKIDs
decl_stmt|;
name|ULONG
name|NoOfAuthEncryptPairsSupported
decl_stmt|;
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
name|AuthenticationEncryptionSupported
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_CAPABILITY
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|UCHAR
name|NDIS_802_11_PMKID_VALUE
index|[
literal|16
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|BSSID_INFO
block|{
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
name|NDIS_802_11_PMKID_VALUE
name|PMKID
decl_stmt|;
block|}
name|BSSID_INFO
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_PMKID
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|BSSIDInfoCount
decl_stmt|;
name|BSSID_INFO
name|BSSIDInfo
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_PMKID
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
name|NDIS_802_11_STATUS_TYPE
block|{
name|Ndis802_11StatusType_Authentication
block|,
name|Ndis802_11StatusType_PMKID_CandidateList
init|=
literal|2
block|,
name|Ndis802_11StatusTypeMax
block|}
name|NDIS_802_11_STATUS_TYPE
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_STATUS_INDICATION
block|{
name|NDIS_802_11_STATUS_TYPE
name|StatusType
decl_stmt|;
block|}
name|NDIS_802_11_STATUS_INDICATION
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|PMKID_CANDIDATE
block|{
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
name|ULONG
name|Flags
decl_stmt|;
block|}
name|PMKID_CANDIDATE
typedef|;
end_typedef

begin_define
define|#
directive|define
name|NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED
value|0x01
end_define

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_PMKID_CANDIDATE_LIST
block|{
name|ULONG
name|Version
decl_stmt|;
name|ULONG
name|NumCandidates
decl_stmt|;
name|PMKID_CANDIDATE
name|CandidateList
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_PMKID_CANDIDATE_LIST
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_AUTHENTICATION_REQUEST
block|{
name|ULONG
name|Length
decl_stmt|;
name|NDIS_802_11_MAC_ADDRESS
name|Bssid
decl_stmt|;
name|ULONG
name|Flags
decl_stmt|;
block|}
name|NDIS_802_11_AUTHENTICATION_REQUEST
typedef|;
end_typedef

begin_define
define|#
directive|define
name|NDIS_802_11_AUTH_REQUEST_REAUTH
value|0x01
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_AUTH_REQUEST_KEYUPDATE
value|0x02
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_AUTH_REQUEST_PAIRWISE_ERROR
value|0x06
end_define

begin_define
define|#
directive|define
name|NDIS_802_11_AUTH_REQUEST_GROUP_ERROR
value|0x0E
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OID_802_11_BSSID */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|OID_802_11_PMKID
end_ifndef

begin_comment
comment|/* Platform SDK for XP did not include WPA2, so add needed definitions */
end_comment

begin_define
define|#
directive|define
name|OID_802_11_CAPABILITY
value|0x0d010122
end_define

begin_define
define|#
directive|define
name|OID_802_11_PMKID
value|0x0d010123
end_define

begin_define
define|#
directive|define
name|Ndis802_11AuthModeWPA2
value|6
end_define

begin_define
define|#
directive|define
name|Ndis802_11AuthModeWPA2PSK
value|7
end_define

begin_define
define|#
directive|define
name|Ndis802_11StatusType_PMKID_CandidateList
value|2
end_define

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
block|{
name|NDIS_802_11_AUTHENTICATION_MODE
name|AuthModeSupported
decl_stmt|;
name|NDIS_802_11_ENCRYPTION_STATUS
name|EncryptStatusSupported
decl_stmt|;
block|}
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_CAPABILITY
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|Version
decl_stmt|;
name|ULONG
name|NoOfPMKIDs
decl_stmt|;
name|ULONG
name|NoOfAuthEncryptPairsSupported
decl_stmt|;
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
name|AuthenticationEncryptionSupported
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_CAPABILITY
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|UCHAR
name|NDIS_802_11_PMKID_VALUE
index|[
literal|16
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|BSSID_INFO
block|{
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
name|NDIS_802_11_PMKID_VALUE
name|PMKID
decl_stmt|;
block|}
name|BSSID_INFO
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_PMKID
block|{
name|ULONG
name|Length
decl_stmt|;
name|ULONG
name|BSSIDInfoCount
decl_stmt|;
name|BSSID_INFO
name|BSSIDInfo
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_PMKID
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|PMKID_CANDIDATE
block|{
name|NDIS_802_11_MAC_ADDRESS
name|BSSID
decl_stmt|;
name|ULONG
name|Flags
decl_stmt|;
block|}
name|PMKID_CANDIDATE
typedef|;
end_typedef

begin_define
define|#
directive|define
name|NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED
value|0x01
end_define

begin_typedef
typedef|typedef
struct|struct
name|NDIS_802_11_PMKID_CANDIDATE_LIST
block|{
name|ULONG
name|Version
decl_stmt|;
name|ULONG
name|NumCandidates
decl_stmt|;
name|PMKID_CANDIDATE
name|CandidateList
index|[
literal|1
index|]
decl_stmt|;
block|}
name|NDIS_802_11_PMKID_CANDIDATE_LIST
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OID_802_11_CAPABILITY */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_USE_NDISUIO
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|_WIN32_WCE
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|__MINGW32_VERSION
end_ifdef

begin_typedef
typedef|typedef
name|ULONG
name|NDIS_OID
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __MINGW32_VERSION */
end_comment

begin_comment
comment|/* from nuiouser.h */
end_comment

begin_define
define|#
directive|define
name|FSCTL_NDISUIO_BASE
value|FILE_DEVICE_NETWORK
end_define

begin_define
define|#
directive|define
name|_NDISUIO_CTL_CODE
parameter_list|(
name|_Function
parameter_list|,
name|_Method
parameter_list|,
name|_Access
parameter_list|)
define|\
value|CTL_CODE(FSCTL_NDISUIO_BASE, _Function, _Method, _Access)
end_define

begin_define
define|#
directive|define
name|IOCTL_NDISUIO_OPEN_DEVICE
define|\
value|_NDISUIO_CTL_CODE(0x200, METHOD_BUFFERED, \ 			  FILE_READ_ACCESS | FILE_WRITE_ACCESS)
end_define

begin_define
define|#
directive|define
name|IOCTL_NDISUIO_QUERY_OID_VALUE
define|\
value|_NDISUIO_CTL_CODE(0x201, METHOD_BUFFERED, \ 			  FILE_READ_ACCESS | FILE_WRITE_ACCESS)
end_define

begin_define
define|#
directive|define
name|IOCTL_NDISUIO_SET_OID_VALUE
define|\
value|_NDISUIO_CTL_CODE(0x205, METHOD_BUFFERED, \ 			  FILE_READ_ACCESS | FILE_WRITE_ACCESS)
end_define

begin_define
define|#
directive|define
name|IOCTL_NDISUIO_SET_ETHER_TYPE
define|\
value|_NDISUIO_CTL_CODE(0x202, METHOD_BUFFERED, \ 			  FILE_READ_ACCESS | FILE_WRITE_ACCESS)
end_define

begin_define
define|#
directive|define
name|IOCTL_NDISUIO_QUERY_BINDING
define|\
value|_NDISUIO_CTL_CODE(0x203, METHOD_BUFFERED, \ 			  FILE_READ_ACCESS | FILE_WRITE_ACCESS)
end_define

begin_define
define|#
directive|define
name|IOCTL_NDISUIO_BIND_WAIT
define|\
value|_NDISUIO_CTL_CODE(0x204, METHOD_BUFFERED, \ 			  FILE_READ_ACCESS | FILE_WRITE_ACCESS)
end_define

begin_typedef
typedef|typedef
struct|struct
name|_NDISUIO_QUERY_OID
block|{
name|NDIS_OID
name|Oid
decl_stmt|;
name|UCHAR
name|Data
index|[
sizeof|sizeof
argument_list|(
name|ULONG
argument_list|)
index|]
decl_stmt|;
block|}
name|NDISUIO_QUERY_OID
operator|,
typedef|*
name|PNDISUIO_QUERY_OID
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_NDISUIO_SET_OID
block|{
name|NDIS_OID
name|Oid
decl_stmt|;
name|UCHAR
name|Data
index|[
sizeof|sizeof
argument_list|(
name|ULONG
argument_list|)
index|]
decl_stmt|;
block|}
name|NDISUIO_SET_OID
operator|,
typedef|*
name|PNDISUIO_SET_OID
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_NDISUIO_QUERY_BINDING
block|{
name|ULONG
name|BindingIndex
decl_stmt|;
name|ULONG
name|DeviceNameOffset
decl_stmt|;
name|ULONG
name|DeviceNameLength
decl_stmt|;
name|ULONG
name|DeviceDescrOffset
decl_stmt|;
name|ULONG
name|DeviceDescrLength
decl_stmt|;
block|}
name|NDISUIO_QUERY_BINDING
operator|,
typedef|*
name|PNDISUIO_QUERY_BINDING
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _WIN32_WCE */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_USE_NDISUIO */
end_comment

begin_function
specifier|static
name|int
name|ndis_get_oid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|unsigned
name|int
name|oid
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_USE_NDISUIO
name|NDISUIO_QUERY_OID
modifier|*
name|o
decl_stmt|;
name|size_t
name|buflen
init|=
sizeof|sizeof
argument_list|(
operator|*
name|o
argument_list|)
operator|+
name|len
decl_stmt|;
name|DWORD
name|written
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|size_t
name|hdrlen
decl_stmt|;
name|o
operator|=
name|os_zalloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|o
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|o
operator|->
name|Oid
operator|=
name|oid
expr_stmt|;
ifdef|#
directive|ifdef
name|_WIN32_WCE
name|o
operator|->
name|ptcDeviceName
operator|=
name|drv
operator|->
name|adapter_name
expr_stmt|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
if|if
condition|(
operator|!
name|DeviceIoControl
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|,
name|IOCTL_NDISUIO_QUERY_OID_VALUE
argument_list|,
name|o
argument_list|,
sizeof|sizeof
argument_list|(
name|NDISUIO_QUERY_OID
argument_list|)
argument_list|,
name|o
argument_list|,
name|buflen
argument_list|,
operator|&
name|written
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: IOCTL_NDISUIO_QUERY_OID_VALUE "
literal|"failed (oid=%08x): %d"
argument_list|,
name|oid
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|o
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hdrlen
operator|=
sizeof|sizeof
argument_list|(
name|NDISUIO_QUERY_OID
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|o
operator|->
name|Data
argument_list|)
expr_stmt|;
if|if
condition|(
name|written
operator|<
name|hdrlen
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: query oid=%08x written (%d); "
literal|"too short"
argument_list|,
name|oid
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|written
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|o
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|written
operator|-=
name|hdrlen
expr_stmt|;
if|if
condition|(
name|written
operator|>
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: query oid=%08x written (%d)> "
literal|"len (%d)"
argument_list|,
name|oid
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|written
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|o
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|data
argument_list|,
name|o
operator|->
name|Data
argument_list|,
name|written
argument_list|)
expr_stmt|;
name|ret
operator|=
name|written
expr_stmt|;
name|os_free
argument_list|(
name|o
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
else|#
directive|else
comment|/* CONFIG_USE_NDISUIO */
name|char
modifier|*
name|buf
decl_stmt|;
name|PACKET_OID_DATA
modifier|*
name|o
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|o
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|o
operator|=
operator|(
name|PACKET_OID_DATA
operator|*
operator|)
name|buf
expr_stmt|;
name|o
operator|->
name|Oid
operator|=
name|oid
expr_stmt|;
name|o
operator|->
name|Length
operator|=
name|len
expr_stmt|;
if|if
condition|(
operator|!
name|PacketRequest
argument_list|(
name|drv
operator|->
name|adapter
argument_list|,
name|FALSE
argument_list|,
name|o
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: oid=0x%x len (%d) failed"
argument_list|,
name|__func__
argument_list|,
name|oid
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|o
operator|->
name|Length
operator|>
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: oid=0x%x Length (%d)> len (%d)"
argument_list|,
name|__func__
argument_list|,
name|oid
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|o
operator|->
name|Length
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|data
argument_list|,
name|o
operator|->
name|Data
argument_list|,
name|o
operator|->
name|Length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|o
operator|->
name|Length
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
endif|#
directive|endif
comment|/* CONFIG_USE_NDISUIO */
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_set_oid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|unsigned
name|int
name|oid
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_USE_NDISUIO
name|NDISUIO_SET_OID
modifier|*
name|o
decl_stmt|;
name|size_t
name|buflen
decl_stmt|,
name|reallen
decl_stmt|;
name|DWORD
name|written
decl_stmt|;
name|char
name|txt
index|[
literal|50
index|]
decl_stmt|;
name|os_snprintf
argument_list|(
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
literal|"NDIS: Set OID %08x"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
name|txt
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|o
argument_list|)
operator|+
name|len
expr_stmt|;
name|reallen
operator|=
name|buflen
operator|-
sizeof|sizeof
argument_list|(
name|o
operator|->
name|Data
argument_list|)
expr_stmt|;
name|o
operator|=
name|os_zalloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|o
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|o
operator|->
name|Oid
operator|=
name|oid
expr_stmt|;
ifdef|#
directive|ifdef
name|_WIN32_WCE
name|o
operator|->
name|ptcDeviceName
operator|=
name|drv
operator|->
name|adapter_name
expr_stmt|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
if|if
condition|(
name|data
condition|)
name|os_memcpy
argument_list|(
name|o
operator|->
name|Data
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DeviceIoControl
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|,
name|IOCTL_NDISUIO_SET_OID_VALUE
argument_list|,
name|o
argument_list|,
name|reallen
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|written
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: IOCTL_NDISUIO_SET_OID_VALUE "
literal|"(oid=%08x) failed: %d"
argument_list|,
name|oid
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|o
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|o
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* CONFIG_USE_NDISUIO */
name|char
modifier|*
name|buf
decl_stmt|;
name|PACKET_OID_DATA
modifier|*
name|o
decl_stmt|;
name|char
name|txt
index|[
literal|50
index|]
decl_stmt|;
name|os_snprintf
argument_list|(
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
literal|"NDIS: Set OID %08x"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
name|txt
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|o
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|o
operator|=
operator|(
name|PACKET_OID_DATA
operator|*
operator|)
name|buf
expr_stmt|;
name|o
operator|->
name|Oid
operator|=
name|oid
expr_stmt|;
name|o
operator|->
name|Length
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|data
condition|)
name|os_memcpy
argument_list|(
name|o
operator|->
name|Data
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|PacketRequest
argument_list|(
name|drv
operator|->
name|adapter
argument_list|,
name|TRUE
argument_list|,
name|o
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: oid=0x%x len (%d) failed"
argument_list|,
name|__func__
argument_list|,
name|oid
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_USE_NDISUIO */
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_set_auth_mode
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|u32
name|auth_mode
init|=
name|mode
decl_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_AUTHENTICATION_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|auth_mode
argument_list|,
sizeof|sizeof
argument_list|(
name|auth_mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_AUTHENTICATION_MODE (%d)"
argument_list|,
operator|(
name|int
operator|)
name|auth_mode
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_get_auth_mode
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|u32
name|auth_mode
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_AUTHENTICATION_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|auth_mode
argument_list|,
sizeof|sizeof
argument_list|(
name|auth_mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
sizeof|sizeof
argument_list|(
name|auth_mode
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to get "
literal|"OID_802_11_AUTHENTICATION_MODE"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|auth_mode
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_set_encr_status
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|encr
parameter_list|)
block|{
name|u32
name|encr_status
init|=
name|encr
decl_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ENCRYPTION_STATUS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|encr_status
argument_list|,
sizeof|sizeof
argument_list|(
name|encr_status
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_ENCRYPTION_STATUS (%d)"
argument_list|,
name|encr
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_get_encr_status
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|u32
name|encr
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ENCRYPTION_STATUS
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|encr
argument_list|,
sizeof|sizeof
argument_list|(
name|encr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
sizeof|sizeof
argument_list|(
name|encr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to get "
literal|"OID_802_11_ENCRYPTION_STATUS"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|encr
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_bssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|wired
condition|)
block|{
comment|/* 		 * Report PAE group address as the "BSSID" for wired 		 * connection. 		 */
name|bssid
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|bssid
index|[
literal|1
index|]
operator|=
literal|0x80
expr_stmt|;
name|bssid
index|[
literal|2
index|]
operator|=
literal|0xc2
expr_stmt|;
name|bssid
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|bssid
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|bssid
index|[
literal|5
index|]
operator|=
literal|0x03
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|NDIS_802_11_SSID
name|buf
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_SSID
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to get SSID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|wired
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Allow get_ssid failure "
literal|"with a wired interface"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|ssid
argument_list|,
name|buf
operator|.
name|Ssid
argument_list|,
name|buf
operator|.
name|SsidLength
argument_list|)
expr_stmt|;
return|return
name|buf
operator|.
name|SsidLength
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_ssid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|NDIS_802_11_SSID
name|buf
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|.
name|SsidLength
operator|=
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
operator|.
name|Ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure radio is marked enabled here so that scan request will not 	 * force SSID to be changed to a random one in order to enable radio at 	 * that point. 	 */
name|drv
operator|->
name|radio_enabled
operator|=
literal|1
expr_stmt|;
return|return
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_SSID
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Disconnect using OID_802_11_DISASSOCIATE. This will also turn the radio off.  */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_ndis_radio_off
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|drv
operator|->
name|radio_enabled
operator|=
literal|0
expr_stmt|;
return|return
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_DISASSOCIATE
argument_list|,
literal|"    "
argument_list|,
literal|4
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Disconnect by setting SSID to random (i.e., likely not used). */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_ndis_disconnect
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|char
name|ssid
index|[
literal|32
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|ssid
index|[
name|i
index|]
operator|=
name|rand
argument_list|()
operator|&
literal|0xff
expr_stmt|;
return|return
name|wpa_driver_ndis_set_ssid
argument_list|(
name|drv
argument_list|,
name|ssid
argument_list|,
literal|32
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_deauthenticate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_ndis_disconnect
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_disassociate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
return|return
name|wpa_driver_ndis_disconnect
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_wpa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: enabled=%d"
argument_list|,
name|__func__
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan timeout - try to get results"
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|timeout_ctx
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|radio_enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: turning radio on before the first"
literal|" scan"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_disconnect
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to enable radio"
argument_list|)
expr_stmt|;
block|}
name|drv
operator|->
name|radio_enabled
operator|=
literal|1
expr_stmt|;
block|}
name|res
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID_LIST_SCAN
argument_list|,
literal|"    "
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|7
argument_list|,
literal|0
argument_list|,
name|wpa_driver_ndis_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_get_ies
parameter_list|(
name|struct
name|wpa_scan_result
modifier|*
name|res
parameter_list|,
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|)
block|{
name|u8
modifier|*
name|pos
init|=
name|ie
decl_stmt|;
name|u8
modifier|*
name|end
init|=
name|ie
operator|+
name|ie_len
decl_stmt|;
if|if
condition|(
name|ie_len
operator|<
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
condition|)
return|return;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
expr_stmt|;
comment|/* wpa_hexdump(MSG_MSGDUMP, "IEs", pos, end - pos); */
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
operator|&&
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|<=
name|end
condition|)
block|{
name|u8
name|ielen
init|=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|ielen
operator|>
name|SSID_MAX_WPA_IE_LEN
condition|)
block|{
name|pos
operator|+=
name|ielen
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|GENERIC_INFO_ELEM
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|os_memcmp
argument_list|(
name|pos
operator|+
literal|2
argument_list|,
literal|"\x00\x50\xf2\x01"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|res
operator|->
name|wpa_ie
argument_list|,
name|pos
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
name|res
operator|->
name|wpa_ie_len
operator|=
name|ielen
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|RSN_INFO_ELEM
condition|)
block|{
name|os_memcpy
argument_list|(
name|res
operator|->
name|rsn_ie
argument_list|,
name|pos
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
name|res
operator|->
name|rsn_ie_len
operator|=
name|ielen
expr_stmt|;
block|}
name|pos
operator|+=
name|ielen
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_scan_results
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|results
parameter_list|,
name|size_t
name|max_size
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|NDIS_802_11_BSSID_LIST_EX
modifier|*
name|b
decl_stmt|;
name|size_t
name|blen
decl_stmt|,
name|count
decl_stmt|,
name|i
decl_stmt|;
name|int
name|len
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|blen
operator|=
literal|65535
expr_stmt|;
name|b
operator|=
name|os_zalloc
argument_list|(
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID_LIST
argument_list|,
operator|(
name|char
operator|*
operator|)
name|b
argument_list|,
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to get scan results"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|count
operator|=
name|b
operator|->
name|NumberOfItems
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|max_size
condition|)
name|count
operator|=
name|max_size
expr_stmt|;
name|os_memset
argument_list|(
name|results
argument_list|,
literal|0
argument_list|,
name|max_size
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_result
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|b
operator|->
name|Bssid
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|NDIS_WLAN_BSSID_EX
modifier|*
name|bss
init|=
operator|(
name|NDIS_WLAN_BSSID_EX
operator|*
operator|)
name|pos
decl_stmt|;
name|os_memcpy
argument_list|(
name|results
index|[
name|i
index|]
operator|.
name|bssid
argument_list|,
name|bss
operator|->
name|MacAddress
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|results
index|[
name|i
index|]
operator|.
name|ssid
argument_list|,
name|bss
operator|->
name|Ssid
operator|.
name|Ssid
argument_list|,
name|bss
operator|->
name|Ssid
operator|.
name|SsidLength
argument_list|)
expr_stmt|;
name|results
index|[
name|i
index|]
operator|.
name|ssid_len
operator|=
name|bss
operator|->
name|Ssid
operator|.
name|SsidLength
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|Privacy
condition|)
name|results
index|[
name|i
index|]
operator|.
name|caps
operator||=
name|IEEE80211_CAP_PRIVACY
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|InfrastructureMode
operator|==
name|Ndis802_11IBSS
condition|)
name|results
index|[
name|i
index|]
operator|.
name|caps
operator||=
name|IEEE80211_CAP_IBSS
expr_stmt|;
elseif|else
if|if
condition|(
name|bss
operator|->
name|InfrastructureMode
operator|==
name|Ndis802_11Infrastructure
condition|)
name|results
index|[
name|i
index|]
operator|.
name|caps
operator||=
name|IEEE80211_CAP_ESS
expr_stmt|;
name|results
index|[
name|i
index|]
operator|.
name|level
operator|=
operator|(
name|int
operator|)
name|bss
operator|->
name|Rssi
expr_stmt|;
name|results
index|[
name|i
index|]
operator|.
name|freq
operator|=
name|bss
operator|->
name|Configuration
operator|.
name|DSConfig
operator|/
literal|1000
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|bss
operator|->
name|SupportedRates
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|bss
operator|->
name|SupportedRates
index|[
name|j
index|]
operator|&
literal|0x7f
operator|)
operator|>
name|results
index|[
name|i
index|]
operator|.
name|maxrate
condition|)
block|{
name|results
index|[
name|i
index|]
operator|.
name|maxrate
operator|=
name|bss
operator|->
name|SupportedRates
index|[
name|j
index|]
operator|&
literal|0x7f
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
operator|(
name|char
operator|*
operator|)
name|bss
operator|->
name|IEs
operator|)
operator|+
name|bss
operator|->
name|IELength
operator|>
operator|(
name|char
operator|*
operator|)
name|b
operator|+
name|blen
condition|)
block|{
comment|/* 			 * Some NDIS drivers have been reported to include an 			 * entry with an invalid IELength in scan results and 			 * this has crashed wpa_supplicant, so validate the 			 * returned value before using it. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: skipped invalid scan "
literal|"result IE (BSSID="
name|MACSTR
literal|") IELength=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|results
index|[
name|i
index|]
operator|.
name|bssid
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|bss
operator|->
name|IELength
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_driver_ndis_get_ies
argument_list|(
operator|&
name|results
index|[
name|i
index|]
argument_list|,
name|bss
operator|->
name|IEs
argument_list|,
name|bss
operator|->
name|IELength
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|bss
operator|->
name|Length
expr_stmt|;
if|if
condition|(
name|pos
operator|>
operator|(
name|char
operator|*
operator|)
name|b
operator|+
name|blen
condition|)
break|break;
block|}
name|os_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
operator|(
name|int
operator|)
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_remove_key
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|key_idx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|int
name|pairwise
parameter_list|)
block|{
name|NDIS_802_11_REMOVE_KEY
name|rkey
decl_stmt|;
name|NDIS_802_11_KEY_INDEX
name|index
decl_stmt|;
name|int
name|res
decl_stmt|,
name|res2
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|rkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rkey
argument_list|)
argument_list|)
expr_stmt|;
name|rkey
operator|.
name|Length
operator|=
sizeof|sizeof
argument_list|(
name|rkey
argument_list|)
expr_stmt|;
name|rkey
operator|.
name|KeyIndex
operator|=
name|key_idx
expr_stmt|;
if|if
condition|(
name|pairwise
condition|)
name|rkey
operator|.
name|KeyIndex
operator||=
literal|1
operator|<<
literal|30
expr_stmt|;
name|os_memcpy
argument_list|(
name|rkey
operator|.
name|BSSID
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|res
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_REMOVE_KEY
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|rkey
argument_list|,
sizeof|sizeof
argument_list|(
name|rkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pairwise
condition|)
block|{
name|index
operator|=
name|key_idx
expr_stmt|;
name|res2
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_REMOVE_WEP
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|index
argument_list|,
sizeof|sizeof
argument_list|(
name|index
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|res2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|&&
name|res2
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_add_wep
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|pairwise
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|NDIS_802_11_WEP
modifier|*
name|wep
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|len
operator|=
literal|12
operator|+
name|key_len
expr_stmt|;
name|wep
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wep
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wep
operator|->
name|Length
operator|=
name|len
expr_stmt|;
name|wep
operator|->
name|KeyIndex
operator|=
name|key_idx
expr_stmt|;
if|if
condition|(
name|set_tx
condition|)
name|wep
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|31
expr_stmt|;
if|#
directive|if
literal|0
comment|/* Setting bit30 does not seem to work with some NDIS drivers */
block|if (pairwise) 		wep->KeyIndex |= 1<< 30;
endif|#
directive|endif
name|wep
operator|->
name|KeyLength
operator|=
name|key_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|wep
operator|->
name|KeyMaterial
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OID_802_11_ADD_WEP"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|wep
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ADD_WEP
argument_list|,
operator|(
name|char
operator|*
operator|)
name|wep
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wep
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_key
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|i
decl_stmt|;
name|NDIS_802_11_KEY
modifier|*
name|nkey
decl_stmt|;
name|int
name|res
decl_stmt|,
name|pairwise
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|addr
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Group Key */
name|pairwise
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_get_bssid
argument_list|(
name|drv
argument_list|,
name|bssid
argument_list|)
operator|<
literal|0
condition|)
name|os_memset
argument_list|(
name|bssid
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Pairwise Key */
name|pairwise
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_NONE
operator|||
name|key_len
operator|==
literal|0
condition|)
block|{
return|return
name|wpa_driver_ndis_remove_key
argument_list|(
name|drv
argument_list|,
name|key_idx
argument_list|,
name|addr
argument_list|,
name|bssid
argument_list|,
name|pairwise
argument_list|)
return|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_WEP
condition|)
block|{
return|return
name|wpa_driver_ndis_add_wep
argument_list|(
name|drv
argument_list|,
name|pairwise
argument_list|,
name|key_idx
argument_list|,
name|set_tx
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
return|;
block|}
name|len
operator|=
literal|12
operator|+
literal|6
operator|+
literal|6
operator|+
literal|8
operator|+
name|key_len
expr_stmt|;
name|nkey
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nkey
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|nkey
operator|->
name|Length
operator|=
name|len
expr_stmt|;
name|nkey
operator|->
name|KeyIndex
operator|=
name|key_idx
expr_stmt|;
if|if
condition|(
name|set_tx
condition|)
name|nkey
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|31
expr_stmt|;
if|if
condition|(
name|pairwise
condition|)
name|nkey
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|30
expr_stmt|;
if|if
condition|(
name|seq
operator|&&
name|seq_len
condition|)
name|nkey
operator|->
name|KeyIndex
operator||=
literal|1
operator|<<
literal|29
expr_stmt|;
name|nkey
operator|->
name|KeyLength
operator|=
name|key_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|BSSID
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|seq
operator|&&
name|seq_len
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|seq_len
condition|;
name|i
operator|++
control|)
name|nkey
operator|->
name|KeyRSC
operator||=
operator|(
name|ULONGLONG
operator|)
name|seq
index|[
name|i
index|]
operator|<<
operator|(
name|i
operator|*
literal|8
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|alg
operator|==
name|WPA_ALG_TKIP
operator|&&
name|key_len
operator|==
literal|32
condition|)
block|{
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
argument_list|,
name|key
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
operator|+
literal|16
argument_list|,
name|key
operator|+
literal|24
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
operator|+
literal|24
argument_list|,
name|key
operator|+
literal|16
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|nkey
operator|->
name|KeyMaterial
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OID_802_11_ADD_KEY"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|nkey
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ADD_KEY
argument_list|,
operator|(
name|char
operator|*
operator|)
name|nkey
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|nkey
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_associate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|u32
name|auth_mode
decl_stmt|,
name|encr
decl_stmt|,
name|priv_mode
decl_stmt|,
name|mode
decl_stmt|;
name|drv
operator|->
name|mode
operator|=
name|params
operator|->
name|mode
expr_stmt|;
comment|/* Note: Setting OID_802_11_INFRASTRUCTURE_MODE clears current keys, 	 * so static WEP keys needs to be set again after this. */
if|if
condition|(
name|params
operator|->
name|mode
operator|==
name|IEEE80211_MODE_IBSS
condition|)
block|{
name|mode
operator|=
name|Ndis802_11IBSS
expr_stmt|;
comment|/* Need to make sure that BSSID polling is enabled for 		 * IBSS mode. */
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|mode
operator|=
name|Ndis802_11Infrastructure
expr_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_INFRASTRUCTURE_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mode
argument_list|,
sizeof|sizeof
argument_list|(
name|mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_INFRASTRUCTURE_MODE (%d)"
argument_list|,
operator|(
name|int
operator|)
name|mode
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
block|}
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_NONE
operator|||
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_802_1X_NO_WPA
condition|)
block|{
comment|/* Re-set WEP keys if static WEP configuration is used. */
name|u8
name|bcast
index|[
name|ETH_ALEN
index|]
init|=
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|params
operator|->
name|wep_key
index|[
name|i
index|]
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Re-setting static WEP "
literal|"key %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_set_key
argument_list|(
name|drv
argument_list|,
name|WPA_ALG_WEP
argument_list|,
name|bcast
argument_list|,
name|i
argument_list|,
name|i
operator|==
name|params
operator|->
name|wep_tx_keyidx
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|params
operator|->
name|wep_key
index|[
name|i
index|]
argument_list|,
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|params
operator|->
name|wpa_ie
operator|==
name|NULL
operator|||
name|params
operator|->
name|wpa_ie_len
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|AUTH_ALG_SHARED_KEY
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|auth_alg
operator|&
name|AUTH_ALG_OPEN_SYSTEM
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeAutoSwitch
expr_stmt|;
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeShared
expr_stmt|;
block|}
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeOpen
expr_stmt|;
name|priv_mode
operator|=
name|Ndis802_11PrivFilterAcceptAll
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|wpa_ie
index|[
literal|0
index|]
operator|==
name|RSN_INFO_ELEM
condition|)
block|{
name|priv_mode
operator|=
name|Ndis802_11PrivFilter8021xWEP
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_PSK
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPA2PSK
expr_stmt|;
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPA2
expr_stmt|;
block|}
else|else
block|{
name|priv_mode
operator|=
name|Ndis802_11PrivFilter8021xWEP
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_WPA_NONE
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPANone
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|key_mgmt_suite
operator|==
name|KEY_MGMT_PSK
condition|)
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPAPSK
expr_stmt|;
else|else
name|auth_mode
operator|=
name|Ndis802_11AuthModeWPA
expr_stmt|;
block|}
switch|switch
condition|(
name|params
operator|->
name|pairwise_suite
condition|)
block|{
case|case
name|CIPHER_CCMP
case|:
name|encr
operator|=
name|Ndis802_11Encryption3Enabled
expr_stmt|;
break|break;
case|case
name|CIPHER_TKIP
case|:
name|encr
operator|=
name|Ndis802_11Encryption2Enabled
expr_stmt|;
break|break;
case|case
name|CIPHER_WEP40
case|:
case|case
name|CIPHER_WEP104
case|:
name|encr
operator|=
name|Ndis802_11Encryption1Enabled
expr_stmt|;
break|break;
case|case
name|CIPHER_NONE
case|:
if|if
condition|(
name|params
operator|->
name|group_suite
operator|==
name|CIPHER_CCMP
condition|)
name|encr
operator|=
name|Ndis802_11Encryption3Enabled
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|group_suite
operator|==
name|CIPHER_TKIP
condition|)
name|encr
operator|=
name|Ndis802_11Encryption2Enabled
expr_stmt|;
else|else
name|encr
operator|=
name|Ndis802_11EncryptionDisabled
expr_stmt|;
break|break;
default|default:
name|encr
operator|=
name|Ndis802_11EncryptionDisabled
expr_stmt|;
block|}
empty_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_PRIVACY_FILTER
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|priv_mode
argument_list|,
sizeof|sizeof
argument_list|(
name|priv_mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_PRIVACY_FILTER (%d)"
argument_list|,
operator|(
name|int
operator|)
name|priv_mode
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
block|}
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|auth_mode
argument_list|)
expr_stmt|;
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|encr
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
block|{
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID
argument_list|,
name|params
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|drv
operator|->
name|oid_bssid_set
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|drv
operator|->
name|oid_bssid_set
condition|)
block|{
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|drv
operator|->
name|oid_bssid_set
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|wpa_driver_ndis_set_ssid
argument_list|(
name|drv
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_pmkid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|int
name|len
decl_stmt|,
name|count
decl_stmt|,
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|entry
decl_stmt|;
name|NDIS_802_11_PMKID
modifier|*
name|p
decl_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|>=
name|drv
operator|->
name|no_of_pmkid
condition|)
break|break;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
name|len
operator|=
literal|8
operator|+
name|count
operator|*
sizeof|sizeof
argument_list|(
name|BSSID_INFO
argument_list|)
expr_stmt|;
name|p
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p
operator|->
name|Length
operator|=
name|len
expr_stmt|;
name|p
operator|->
name|BSSIDInfoCount
operator|=
name|count
expr_stmt|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|os_memcpy
argument_list|(
operator|&
name|p
operator|->
name|BSSIDInfo
index|[
name|i
index|]
operator|.
name|BSSID
argument_list|,
name|entry
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|p
operator|->
name|BSSIDInfo
index|[
name|i
index|]
operator|.
name|PMKID
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OID_802_11_PMKID"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_PMKID
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_add_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|no_of_pmkid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|entry
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|prev
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|entry
condition|)
block|{
comment|/* Replace existing entry for this BSSID and move it into the 		 * beginning of the list. */
name|os_memcpy
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
condition|)
block|{
name|prev
operator|->
name|next
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|entry
operator|->
name|next
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|entry
expr_stmt|;
block|}
block|}
else|else
block|{
name|entry
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
condition|)
block|{
name|os_memcpy
argument_list|(
name|entry
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|entry
operator|->
name|next
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|entry
expr_stmt|;
block|}
block|}
return|return
name|wpa_driver_ndis_set_pmkid
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_remove_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|no_of_pmkid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|entry
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|entry
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|entry
operator|->
name|next
expr_stmt|;
else|else
name|drv
operator|->
name|pmkid
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|entry
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
return|return
name|wpa_driver_ndis_set_pmkid
argument_list|(
name|drv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_flush_pmkid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|NDIS_802_11_PMKID
name|p
decl_stmt|;
name|struct
name|ndis_pmkid_entry
modifier|*
name|pmkid
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|no_of_pmkid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|pmkid
operator|=
name|drv
operator|->
name|pmkid
expr_stmt|;
name|drv
operator|->
name|pmkid
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pmkid
condition|)
block|{
name|prev
operator|=
name|pmkid
expr_stmt|;
name|pmkid
operator|=
name|pmkid
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|os_memset
argument_list|(
operator|&
name|p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|.
name|Length
operator|=
literal|8
expr_stmt|;
name|p
operator|.
name|BSSIDInfoCount
operator|=
literal|0
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: OID_802_11_PMKID (flush)"
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|p
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_PMKID
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|p
argument_list|,
literal|8
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_associnfo
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|NDIS_802_11_ASSOCIATION_INFORMATION
modifier|*
name|ai
decl_stmt|;
name|int
name|len
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|NDIS_802_11_BSSID_LIST_EX
modifier|*
name|b
decl_stmt|;
name|size_t
name|blen
decl_stmt|,
name|i
decl_stmt|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ASSOCIATION_INFORMATION
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to get association "
literal|"information"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
comment|/* Some drivers seem to be producing incorrect length for this 		 * data. Limit the length to the current buffer size to avoid 		 * crashing in hexdump. The data seems to be otherwise valid, 		 * so better try to use it. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: ignored bogus association "
literal|"information length %d"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_ASSOCIATION_INFORMATION
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: re-reading association "
literal|"information failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: ignored bogus association"
literal|" information length %d (re-read)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: association information"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ai
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: too short association "
literal|"information"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ai
operator|=
operator|(
name|NDIS_802_11_ASSOCIATION_INFORMATION
operator|*
operator|)
name|buf
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: ReqFixed=0x%x RespFixed=0x%x off_req=%d "
literal|"off_resp=%d len_req=%d len_resp=%d"
argument_list|,
name|ai
operator|->
name|AvailableRequestFixedIEs
argument_list|,
name|ai
operator|->
name|AvailableResponseFixedIEs
argument_list|,
operator|(
name|int
operator|)
name|ai
operator|->
name|OffsetRequestIEs
argument_list|,
operator|(
name|int
operator|)
name|ai
operator|->
name|OffsetResponseIEs
argument_list|,
operator|(
name|int
operator|)
name|ai
operator|->
name|RequestIELength
argument_list|,
operator|(
name|int
operator|)
name|ai
operator|->
name|ResponseIELength
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|OffsetRequestIEs
operator|+
name|ai
operator|->
name|RequestIELength
operator|>
operator|(
name|unsigned
operator|)
name|len
operator|||
name|ai
operator|->
name|OffsetResponseIEs
operator|+
name|ai
operator|->
name|ResponseIELength
operator|>
operator|(
name|unsigned
operator|)
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: association information - "
literal|"IE overflow"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: Request IEs"
argument_list|,
name|buf
operator|+
name|ai
operator|->
name|OffsetRequestIEs
argument_list|,
name|ai
operator|->
name|RequestIELength
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: Response IEs"
argument_list|,
name|buf
operator|+
name|ai
operator|->
name|OffsetResponseIEs
argument_list|,
name|ai
operator|->
name|ResponseIELength
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|req_ies
operator|=
name|buf
operator|+
name|ai
operator|->
name|OffsetRequestIEs
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|req_ies_len
operator|=
name|ai
operator|->
name|RequestIELength
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies
operator|=
name|buf
operator|+
name|ai
operator|->
name|OffsetResponseIEs
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|resp_ies_len
operator|=
name|ai
operator|->
name|ResponseIELength
expr_stmt|;
name|blen
operator|=
literal|65535
expr_stmt|;
name|b
operator|=
name|os_zalloc
argument_list|(
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
goto|goto
name|skip_scan_results
goto|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_BSSID_LIST
argument_list|,
operator|(
name|char
operator|*
operator|)
name|b
argument_list|,
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to get scan results"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|=
name|NULL
expr_stmt|;
goto|goto
name|skip_scan_results
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d BSSID items to process for AssocInfo"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|b
operator|->
name|NumberOfItems
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|b
operator|->
name|Bssid
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|b
operator|->
name|NumberOfItems
condition|;
name|i
operator|++
control|)
block|{
name|NDIS_WLAN_BSSID_EX
modifier|*
name|bss
init|=
operator|(
name|NDIS_WLAN_BSSID_EX
operator|*
operator|)
name|pos
decl_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|MacAddress
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|bss
operator|->
name|IELength
operator|>
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
condition|)
block|{
name|data
operator|.
name|assoc_info
operator|.
name|beacon_ies
operator|=
operator|(
operator|(
name|u8
operator|*
operator|)
name|bss
operator|->
name|IEs
operator|)
operator|+
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|beacon_ies_len
operator|=
name|bss
operator|->
name|IELength
operator|-
sizeof|sizeof
argument_list|(
name|NDIS_802_11_FIXED_IEs
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: Beacon IEs"
argument_list|,
name|data
operator|.
name|assoc_info
operator|.
name|beacon_ies
argument_list|,
name|data
operator|.
name|assoc_info
operator|.
name|beacon_ies_len
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|bss
operator|->
name|Length
expr_stmt|;
if|if
condition|(
name|pos
operator|>
operator|(
name|char
operator|*
operator|)
name|b
operator|+
name|blen
condition|)
break|break;
block|}
name|skip_scan_results
label|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOCINFO
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_poll_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|poll
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|wired
condition|)
return|return;
if|if
condition|(
name|wpa_driver_ndis_get_bssid
argument_list|(
name|drv
argument_list|,
name|bssid
argument_list|)
condition|)
block|{
comment|/* Disconnected */
if|if
condition|(
name|os_memcmp
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|os_memset
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Connected */
if|if
condition|(
name|os_memcmp
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_get_associnfo
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* When using integrated NDIS event receiver, we can skip BSSID 	 * polling when using infrastructure network. However, when using 	 * IBSS mode, many driver do not seem to generate connection event, 	 * so we need to enable BSSID polling to figure out when IBSS network 	 * has been formed. 	 */
name|poll
operator|=
name|drv
operator|->
name|mode
operator|==
name|IEEE80211_MODE_IBSS
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NDIS_EVENTS_INTEGRATED
ifndef|#
directive|ifndef
name|_WIN32_WCE
name|poll
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
endif|#
directive|endif
comment|/* CONFIG_NDIS_EVENTS_INTEGRATED */
if|if
condition|(
name|poll
condition|)
block|{
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_poll
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_poll_timeout
argument_list|(
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called when driver generates Media Connect Event by calling  * NdisMIndicateStatus() with NDIS_STATUS_MEDIA_CONNECT */
end_comment

begin_function
name|void
name|wpa_driver_ndis_event_connect
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Media Connect Event"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_get_bssid
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|bssid
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_driver_ndis_get_associnfo
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Called when driver generates Media Disconnect Event by calling  * NdisMIndicateStatus() with NDIS_STATUS_MEDIA_DISCONNECT */
end_comment

begin_function
name|void
name|wpa_driver_ndis_event_disconnect
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Media Disconnect Event"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_event_auth
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|NDIS_802_11_AUTHENTICATION_REQUEST
modifier|*
name|req
decl_stmt|;
name|int
name|pairwise
init|=
literal|0
decl_stmt|,
name|group
init|=
literal|0
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
if|if
condition|(
name|data_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Too short Authentication Request "
literal|"Event (len=%d)"
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
return|return;
block|}
name|req
operator|=
operator|(
name|NDIS_802_11_AUTHENTICATION_REQUEST
operator|*
operator|)
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Authentication Request Event: "
literal|"Bssid "
name|MACSTR
literal|" Flags 0x%x"
argument_list|,
name|MAC2STR
argument_list|(
name|req
operator|->
name|Bssid
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|req
operator|->
name|Flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|->
name|Flags
operator|&
name|NDIS_802_11_AUTH_REQUEST_PAIRWISE_ERROR
operator|)
operator|==
name|NDIS_802_11_AUTH_REQUEST_PAIRWISE_ERROR
condition|)
name|pairwise
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|req
operator|->
name|Flags
operator|&
name|NDIS_802_11_AUTH_REQUEST_GROUP_ERROR
operator|)
operator|==
name|NDIS_802_11_AUTH_REQUEST_GROUP_ERROR
condition|)
name|group
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pairwise
operator|||
name|group
condition|)
block|{
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|michael_mic_failure
operator|.
name|unicast
operator|=
name|pairwise
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_MICHAEL_MIC_FAILURE
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_event_pmkid
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|NDIS_802_11_PMKID_CANDIDATE_LIST
modifier|*
name|pmkid
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
if|if
condition|(
name|data_len
operator|<
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Too short PMKID Candidate List "
literal|"Event (len=%d)"
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
return|return;
block|}
name|pmkid
operator|=
operator|(
name|NDIS_802_11_PMKID_CANDIDATE_LIST
operator|*
operator|)
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: PMKID Candidate List Event - Version %d "
literal|"NumCandidates %d"
argument_list|,
operator|(
name|int
operator|)
name|pmkid
operator|->
name|Version
argument_list|,
operator|(
name|int
operator|)
name|pmkid
operator|->
name|NumCandidates
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmkid
operator|->
name|Version
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Unsupported PMKID Candidate List "
literal|"Version %d"
argument_list|,
operator|(
name|int
operator|)
name|pmkid
operator|->
name|Version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data_len
operator|<
literal|8
operator|+
name|pmkid
operator|->
name|NumCandidates
operator|*
sizeof|sizeof
argument_list|(
name|PMKID_CANDIDATE
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: PMKID Candidate List underflow"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pmkid
operator|->
name|NumCandidates
condition|;
name|i
operator|++
control|)
block|{
name|PMKID_CANDIDATE
modifier|*
name|p
init|=
operator|&
name|pmkid
operator|->
name|CandidateList
index|[
name|i
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d: "
name|MACSTR
literal|" Flags 0x%x"
argument_list|,
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|p
operator|->
name|BSSID
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|p
operator|->
name|Flags
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|event
operator|.
name|pmkid_candidate
operator|.
name|bssid
argument_list|,
name|p
operator|->
name|BSSID
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|event
operator|.
name|pmkid_candidate
operator|.
name|index
operator|=
name|i
expr_stmt|;
name|event
operator|.
name|pmkid_candidate
operator|.
name|preauth
operator|=
name|p
operator|->
name|Flags
operator|&
name|NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_PMKID_CANDIDATE
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Called when driver calls NdisMIndicateStatus() with  * NDIS_STATUS_MEDIA_SPECIFIC_INDICATION */
end_comment

begin_function
name|void
name|wpa_driver_ndis_event_media_specific
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|NDIS_802_11_STATUS_INDICATION
modifier|*
name|status
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
operator|||
name|data_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|status
argument_list|)
condition|)
return|return;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Media Specific Indication"
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|status
operator|=
operator|(
name|NDIS_802_11_STATUS_INDICATION
operator|*
operator|)
name|data
expr_stmt|;
name|data
operator|+=
sizeof|sizeof
argument_list|(
name|status
argument_list|)
expr_stmt|;
name|data_len
operator|-=
sizeof|sizeof
argument_list|(
name|status
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
operator|->
name|StatusType
condition|)
block|{
case|case
name|Ndis802_11StatusType_Authentication
case|:
name|wpa_driver_ndis_event_auth
argument_list|(
name|drv
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|Ndis802_11StatusType_PMKID_CandidateList
case|:
name|wpa_driver_ndis_event_pmkid
argument_list|(
name|drv
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Unknown StatusType %d"
argument_list|,
operator|(
name|int
operator|)
name|status
operator|->
name|StatusType
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Called when an adapter is added */
end_comment

begin_function
name|void
name|wpa_driver_ndis_event_adapter_arrival
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|int
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Notify Adapter Arrival"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|30
condition|;
name|i
operator|++
control|)
block|{
comment|/* Re-open Packet32/NDISUIO connection */
name|wpa_driver_ndis_adapter_close
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_adapter_init
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
operator|||
name|wpa_driver_ndis_adapter_open
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Driver re-initialization "
literal|"(%d) failed"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|os_sleep
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Driver re-initialized"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|event
operator|.
name|interface_status
operator|.
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|event
operator|.
name|interface_status
operator|.
name|ifname
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|event
operator|.
name|interface_status
operator|.
name|ievent
operator|=
name|EVENT_INTERFACE_ADDED
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_INTERFACE_STATUS
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called when an adapter is removed */
end_comment

begin_function
name|void
name|wpa_driver_ndis_event_adapter_removal
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Notify Adapter Removal"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|event
operator|.
name|interface_status
operator|.
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|event
operator|.
name|interface_status
operator|.
name|ifname
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|event
operator|.
name|interface_status
operator|.
name|ievent
operator|=
name|EVENT_INTERFACE_REMOVED
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_INTERFACE_STATUS
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_get_wpa_capability
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: verifying driver WPA capability"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|Ndis802_11AuthModeWPA
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_auth_mode
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11AuthModeWPA
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WPA key management supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|Ndis802_11AuthModeWPAPSK
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_auth_mode
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11AuthModeWPAPSK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WPA-PSK key management "
literal|"supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_PSK
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|Ndis802_11Encryption3Enabled
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_encr_status
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11Encryption3KeyAbsent
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: CCMP encryption supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_CCMP
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|Ndis802_11Encryption2Enabled
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_encr_status
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11Encryption2KeyAbsent
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: TKIP encryption supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_TKIP
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|Ndis802_11Encryption1Enabled
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_encr_status
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11Encryption1KeyAbsent
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WEP encryption supported"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_WEP40
operator||
name|WPA_DRIVER_CAPA_ENC_WEP104
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|Ndis802_11AuthModeShared
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_auth_mode
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11AuthModeShared
condition|)
block|{
name|drv
operator|->
name|capa
operator|.
name|auth
operator||=
name|WPA_DRIVER_AUTH_SHARED
expr_stmt|;
block|}
if|if
condition|(
name|ndis_set_auth_mode
argument_list|(
name|drv
argument_list|,
name|Ndis802_11AuthModeOpen
argument_list|)
operator|==
literal|0
operator|&&
name|ndis_get_auth_mode
argument_list|(
name|drv
argument_list|)
operator|==
name|Ndis802_11AuthModeOpen
condition|)
block|{
name|drv
operator|->
name|capa
operator|.
name|auth
operator||=
name|WPA_DRIVER_AUTH_OPEN
expr_stmt|;
block|}
name|ndis_set_encr_status
argument_list|(
name|drv
argument_list|,
name|Ndis802_11EncryptionDisabled
argument_list|)
expr_stmt|;
comment|/* Could also verify OID_802_11_ADD_KEY error reporting and 	 * support for OID_802_11_ASSOCIATION_INFORMATION. */
if|if
condition|(
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
operator|&&
name|drv
operator|->
name|capa
operator|.
name|enc
operator|&
operator|(
name|WPA_DRIVER_CAPA_ENC_TKIP
operator||
name|WPA_DRIVER_CAPA_ENC_CCMP
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: driver supports WPA"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|has_capability
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: no WPA support found"
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: driver capabilities: key_mgmt 0x%x "
literal|"enc 0x%x auth 0x%x"
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|enc
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|auth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_get_capability
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|NDIS_802_11_CAPABILITY
modifier|*
name|c
decl_stmt|;
name|drv
operator|->
name|capa
operator|.
name|flags
operator|=
name|WPA_DRIVER_FLAGS_DRIVER_IE
expr_stmt|;
name|len
operator|=
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_CAPABILITY
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_driver_ndis_get_wpa_capability
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"OID_802_11_CAPABILITY"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|c
operator|=
operator|(
name|NDIS_802_11_CAPABILITY
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|c
argument_list|)
operator|||
name|c
operator|->
name|Version
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: unsupported "
literal|"OID_802_11_CAPABILITY data"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Driver supports OID_802_11_CAPABILITY - "
literal|"NoOfPMKIDs %d NoOfAuthEncrPairs %d"
argument_list|,
operator|(
name|int
operator|)
name|c
operator|->
name|NoOfPMKIDs
argument_list|,
operator|(
name|int
operator|)
name|c
operator|->
name|NoOfAuthEncryptPairsSupported
argument_list|)
expr_stmt|;
name|drv
operator|->
name|has_capability
operator|=
literal|1
expr_stmt|;
name|drv
operator|->
name|no_of_pmkid
operator|=
name|c
operator|->
name|NoOfPMKIDs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
operator|->
name|NoOfAuthEncryptPairsSupported
condition|;
name|i
operator|++
control|)
block|{
name|NDIS_802_11_AUTHENTICATION_ENCRYPTION
modifier|*
name|ae
decl_stmt|;
name|ae
operator|=
operator|&
name|c
operator|->
name|AuthenticationEncryptionSupported
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ae
operator|+
literal|1
operator|)
operator|>
name|buf
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: auth/encr pair list "
literal|"overflow"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: %d - auth %d encr %d"
argument_list|,
name|i
argument_list|,
operator|(
name|int
operator|)
name|ae
operator|->
name|AuthModeSupported
argument_list|,
operator|(
name|int
operator|)
name|ae
operator|->
name|EncryptStatusSupported
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ae
operator|->
name|AuthModeSupported
condition|)
block|{
case|case
name|Ndis802_11AuthModeOpen
case|:
name|drv
operator|->
name|capa
operator|.
name|auth
operator||=
name|WPA_DRIVER_AUTH_OPEN
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeShared
case|:
name|drv
operator|->
name|capa
operator|.
name|auth
operator||=
name|WPA_DRIVER_AUTH_SHARED
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPA
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPAPSK
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_PSK
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPA2
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPA2PSK
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2_PSK
expr_stmt|;
break|break;
case|case
name|Ndis802_11AuthModeWPANone
case|:
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
operator||=
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_NONE
expr_stmt|;
break|break;
default|default:
break|break;
block|}
switch|switch
condition|(
name|ae
operator|->
name|EncryptStatusSupported
condition|)
block|{
case|case
name|Ndis802_11Encryption1Enabled
case|:
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_WEP40
expr_stmt|;
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_WEP104
expr_stmt|;
break|break;
case|case
name|Ndis802_11Encryption2Enabled
case|:
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_TKIP
expr_stmt|;
break|break;
case|case
name|Ndis802_11Encryption3Enabled
case|:
name|drv
operator|->
name|capa
operator|.
name|enc
operator||=
name|WPA_DRIVER_CAPA_ENC_CCMP
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: driver capabilities: key_mgmt 0x%x "
literal|"enc 0x%x auth 0x%x"
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|key_mgmt
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|enc
argument_list|,
name|drv
operator|->
name|capa
operator|.
name|auth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_capa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_capa
modifier|*
name|capa
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|has_capability
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|capa
argument_list|,
operator|&
name|drv
operator|->
name|capa
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|capa
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|wpa_driver_ndis_get_ifname
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
return|return
name|drv
operator|->
name|ifname
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|wpa_driver_ndis_get_mac_addr
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
return|return
name|drv
operator|->
name|own_addr
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32_WCE
end_ifdef

begin_define
define|#
directive|define
name|NDISUIO_MSG_SIZE
value|(sizeof(NDISUIO_DEVICE_NOTIFICATION) + 512)
end_define

begin_function
specifier|static
name|void
name|ndisuio_notification_receive
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|eloop_data
decl_stmt|;
name|NDISUIO_DEVICE_NOTIFICATION
modifier|*
name|hdr
decl_stmt|;
name|u8
name|buf
index|[
name|NDISUIO_MSG_SIZE
index|]
decl_stmt|;
name|DWORD
name|len
decl_stmt|,
name|flags
decl_stmt|;
if|if
condition|(
operator|!
name|ReadMsgQueue
argument_list|(
name|drv
operator|->
name|event_queue
argument_list|,
name|buf
argument_list|,
name|NDISUIO_MSG_SIZE
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|,
operator|&
name|flags
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndisuio_notification_receive: "
literal|"ReadMsgQueue failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|NDISUIO_DEVICE_NOTIFICATION
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndisuio_notification_receive: "
literal|"Too short message (len=%d)"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|hdr
operator|=
operator|(
name|NDISUIO_DEVICE_NOTIFICATION
operator|*
operator|)
name|buf
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Notification received: len=%d type=0x%x"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|,
name|hdr
operator|->
name|dwNotificationType
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hdr
operator|->
name|dwNotificationType
condition|)
block|{
ifdef|#
directive|ifdef
name|NDISUIO_NOTIFICATION_ADAPTER_ARRIVAL
case|case
name|NDISUIO_NOTIFICATION_ADAPTER_ARRIVAL
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: ADAPTER_ARRIVAL"
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_event_adapter_arrival
argument_list|(
name|drv
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NDISUIO_NOTIFICATION_ADAPTER_REMOVAL
case|case
name|NDISUIO_NOTIFICATION_ADAPTER_REMOVAL
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: ADAPTER_REMOVAL"
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_event_adapter_removal
argument_list|(
name|drv
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|NDISUIO_NOTIFICATION_MEDIA_CONNECT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: MEDIA_CONNECT"
argument_list|)
expr_stmt|;
name|SetEvent
argument_list|(
name|drv
operator|->
name|connected_event
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_event_connect
argument_list|(
name|drv
argument_list|)
expr_stmt|;
break|break;
case|case
name|NDISUIO_NOTIFICATION_MEDIA_DISCONNECT
case|:
name|ResetEvent
argument_list|(
name|drv
operator|->
name|connected_event
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: MEDIA_DISCONNECT"
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_event_disconnect
argument_list|(
name|drv
argument_list|)
expr_stmt|;
break|break;
case|case
name|NDISUIO_NOTIFICATION_MEDIA_SPECIFIC_NOTIFICATION
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: MEDIA_SPECIFIC_NOTIFICATION"
argument_list|)
expr_stmt|;
if|#
directive|if
name|_WIN32_WCE
operator|==
literal|420
operator|||
name|_WIN32_WCE
operator|==
literal|0x420
name|wpa_driver_ndis_event_media_specific
argument_list|(
name|drv
argument_list|,
name|hdr
operator|->
name|pvStatusBuffer
argument_list|,
name|hdr
operator|->
name|uiStatusBufferSize
argument_list|)
expr_stmt|;
else|#
directive|else
name|wpa_driver_ndis_event_media_specific
argument_list|(
name|drv
argument_list|,
operator|(
operator|(
specifier|const
name|u8
operator|*
operator|)
name|hdr
operator|)
operator|+
name|hdr
operator|->
name|uiOffsetToStatusBuffer
argument_list|,
operator|(
name|size_t
operator|)
name|hdr
operator|->
name|uiStatusBufferSize
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Unknown notification type 0x%x"
argument_list|,
name|hdr
operator|->
name|dwNotificationType
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ndisuio_notification_deinit
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|NDISUIO_REQUEST_NOTIFICATION
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|hMsgQueue
operator|=
name|drv
operator|->
name|event_queue
expr_stmt|;
name|req
operator|.
name|dwNotificationTypes
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|DeviceIoControl
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|,
name|IOCTL_NDISUIO_REQUEST_NOTIFICATION
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ndisuio_notification_deinit: "
literal|"IOCTL_NDISUIO_REQUEST_NOTIFICATION failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|DeviceIoControl
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|,
name|IOCTL_NDISUIO_CANCEL_NOTIFICATION
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ndisuio_notification_deinit: "
literal|"IOCTL_NDISUIO_CANCEL_NOTIFICATION failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|event_queue
condition|)
block|{
name|eloop_unregister_event
argument_list|(
name|drv
operator|->
name|event_queue
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|event_queue
argument_list|)
argument_list|)
expr_stmt|;
name|CloseHandle
argument_list|(
name|drv
operator|->
name|event_queue
argument_list|)
expr_stmt|;
name|drv
operator|->
name|event_queue
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|connected_event
condition|)
block|{
name|CloseHandle
argument_list|(
name|drv
operator|->
name|connected_event
argument_list|)
expr_stmt|;
name|drv
operator|->
name|connected_event
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ndisuio_notification_init
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|MSGQUEUEOPTIONS
name|opt
decl_stmt|;
name|NDISUIO_REQUEST_NOTIFICATION
name|req
decl_stmt|;
name|drv
operator|->
name|connected_event
operator|=
name|CreateEvent
argument_list|(
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|TEXT
argument_list|(
literal|"WpaSupplicantConnected"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|connected_event
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ndisuio_notification_init: "
literal|"CreateEvent failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|opt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|opt
argument_list|)
argument_list|)
expr_stmt|;
name|opt
operator|.
name|dwSize
operator|=
sizeof|sizeof
argument_list|(
name|opt
argument_list|)
expr_stmt|;
name|opt
operator|.
name|dwMaxMessages
operator|=
literal|5
expr_stmt|;
name|opt
operator|.
name|cbMaxMessage
operator|=
name|NDISUIO_MSG_SIZE
expr_stmt|;
name|opt
operator|.
name|bReadAccess
operator|=
name|TRUE
expr_stmt|;
name|drv
operator|->
name|event_queue
operator|=
name|CreateMsgQueue
argument_list|(
name|NULL
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|event_queue
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ndisuio_notification_init: "
literal|"CreateMsgQueue failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|ndisuio_notification_deinit
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|hMsgQueue
operator|=
name|drv
operator|->
name|event_queue
expr_stmt|;
name|req
operator|.
name|dwNotificationTypes
operator|=
ifdef|#
directive|ifdef
name|NDISUIO_NOTIFICATION_ADAPTER_ARRIVAL
name|NDISUIO_NOTIFICATION_ADAPTER_ARRIVAL
operator||
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NDISUIO_NOTIFICATION_ADAPTER_REMOVAL
name|NDISUIO_NOTIFICATION_ADAPTER_REMOVAL
operator||
endif|#
directive|endif
name|NDISUIO_NOTIFICATION_MEDIA_CONNECT
operator||
name|NDISUIO_NOTIFICATION_MEDIA_DISCONNECT
operator||
name|NDISUIO_NOTIFICATION_MEDIA_SPECIFIC_NOTIFICATION
expr_stmt|;
if|if
condition|(
operator|!
name|DeviceIoControl
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|,
name|IOCTL_NDISUIO_REQUEST_NOTIFICATION
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ndisuio_notification_init: "
literal|"IOCTL_NDISUIO_REQUEST_NOTIFICATION failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|ndisuio_notification_deinit
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eloop_register_event
argument_list|(
name|drv
operator|->
name|event_queue
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|event_queue
argument_list|)
argument_list|,
name|ndisuio_notification_receive
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _WIN32_WCE */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_ndis_get_names
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_USE_NDISUIO
name|NDISUIO_QUERY_BINDING
modifier|*
name|b
decl_stmt|;
name|size_t
name|blen
init|=
sizeof|sizeof
argument_list|(
operator|*
name|b
argument_list|)
operator|+
literal|1024
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|;
name|DWORD
name|written
decl_stmt|;
name|char
name|name
index|[
literal|256
index|]
decl_stmt|,
name|desc
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|dpos
decl_stmt|;
name|WCHAR
modifier|*
name|pos
decl_stmt|;
name|size_t
name|j
decl_stmt|,
name|len
decl_stmt|,
name|dlen
decl_stmt|;
name|b
operator|=
name|os_malloc
argument_list|(
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
name|os_memset
argument_list|(
name|b
argument_list|,
literal|0
argument_list|,
name|blen
argument_list|)
expr_stmt|;
name|b
operator|->
name|BindingIndex
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|!
name|DeviceIoControl
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|,
name|IOCTL_NDISUIO_QUERY_BINDING
argument_list|,
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|NDISUIO_QUERY_BINDING
argument_list|)
argument_list|,
name|b
argument_list|,
name|blen
argument_list|,
operator|&
name|written
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|error
operator|=
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ERROR_NO_MORE_ITEMS
condition|)
break|break;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IOCTL_NDISUIO_QUERY_BINDING "
literal|"failed: %d"
argument_list|,
name|error
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|=
operator|(
name|WCHAR
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|b
operator|+
name|b
operator|->
name|DeviceNameOffset
operator|)
expr_stmt|;
name|len
operator|=
name|b
operator|->
name|DeviceNameLength
expr_stmt|;
if|if
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
name|name
argument_list|)
condition|)
name|len
operator|=
sizeof|sizeof
argument_list|(
name|name
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|len
condition|;
name|j
operator|++
control|)
name|name
index|[
name|j
index|]
operator|=
operator|(
name|char
operator|)
name|pos
index|[
name|j
index|]
expr_stmt|;
name|name
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
operator|(
name|WCHAR
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|b
operator|+
name|b
operator|->
name|DeviceDescrOffset
operator|)
expr_stmt|;
name|len
operator|=
name|b
operator|->
name|DeviceDescrLength
expr_stmt|;
if|if
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
name|desc
argument_list|)
condition|)
name|len
operator|=
sizeof|sizeof
argument_list|(
name|desc
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|len
condition|;
name|j
operator|++
control|)
name|desc
index|[
name|j
index|]
operator|=
operator|(
name|char
operator|)
name|pos
index|[
name|j
index|]
expr_stmt|;
name|desc
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d - %s - %s"
argument_list|,
name|i
argument_list|,
name|name
argument_list|,
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Interface name match"
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|os_strncmp
argument_list|(
name|desc
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|os_strlen
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Interface description "
literal|"match"
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Could not find interface '%s'"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_strncpy
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|os_strncmp
argument_list|(
name|name
argument_list|,
literal|"\\DEVICE\\"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|?
name|name
operator|+
literal|8
else|:
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|_WIN32_WCE
name|drv
operator|->
name|adapter_name
operator|=
name|wpa_strdup_tchar
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|adapter_name
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NDIS: Failed to allocate memory for "
literal|"adapter name"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* _WIN32_WCE */
name|dpos
operator|=
name|os_strstr
argument_list|(
name|desc
argument_list|,
literal|" - "
argument_list|)
expr_stmt|;
if|if
condition|(
name|dpos
condition|)
name|dlen
operator|=
name|dpos
operator|-
name|desc
expr_stmt|;
else|else
name|dlen
operator|=
name|os_strlen
argument_list|(
name|desc
argument_list|)
expr_stmt|;
name|drv
operator|->
name|adapter_desc
operator|=
name|os_malloc
argument_list|(
name|dlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|adapter_desc
condition|)
block|{
name|os_memcpy
argument_list|(
name|drv
operator|->
name|adapter_desc
argument_list|,
name|desc
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|drv
operator|->
name|adapter_desc
index|[
name|dlen
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|os_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Adapter description prefix '%s'"
argument_list|,
name|drv
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* CONFIG_USE_NDISUIO */
name|PTSTR
name|_names
decl_stmt|;
name|char
modifier|*
name|names
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|ULONG
name|len
decl_stmt|;
name|BOOLEAN
name|res
decl_stmt|;
define|#
directive|define
name|MAX_ADAPTERS
value|32
name|char
modifier|*
name|name
index|[
name|MAX_ADAPTERS
index|]
decl_stmt|;
name|char
modifier|*
name|desc
index|[
name|MAX_ADAPTERS
index|]
decl_stmt|;
name|int
name|num_name
decl_stmt|,
name|num_desc
decl_stmt|,
name|i
decl_stmt|,
name|found_name
decl_stmt|,
name|found_desc
decl_stmt|;
name|size_t
name|dlen
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Packet.dll version: %s"
argument_list|,
name|PacketGetVersion
argument_list|()
argument_list|)
expr_stmt|;
name|len
operator|=
literal|8192
expr_stmt|;
name|_names
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|_names
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|PacketGetAdapterNames
argument_list|(
name|_names
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
operator|&&
name|len
operator|>
literal|8192
condition|)
block|{
name|os_free
argument_list|(
name|_names
argument_list|)
expr_stmt|;
name|_names
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|_names
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|PacketGetAdapterNames
argument_list|(
name|_names
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NDIS: Failed to get adapter list "
literal|"(PacketGetAdapterNames)"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|_names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|names
operator|=
operator|(
name|char
operator|*
operator|)
name|_names
expr_stmt|;
if|if
condition|(
name|names
index|[
literal|0
index|]
operator|&&
name|names
index|[
literal|1
index|]
operator|==
literal|'\0'
operator|&&
name|names
index|[
literal|2
index|]
operator|&&
name|names
index|[
literal|3
index|]
operator|==
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Looks like adapter names are in "
literal|"UNICODE"
argument_list|)
expr_stmt|;
comment|/* Convert to ASCII */
name|pos2
operator|=
name|pos
operator|=
name|names
expr_stmt|;
while|while
condition|(
name|pos2
operator|<
name|names
operator|+
name|len
condition|)
block|{
if|if
condition|(
name|pos2
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|&&
name|pos2
index|[
literal|1
index|]
operator|==
literal|'\0'
operator|&&
name|pos2
index|[
literal|2
index|]
operator|==
literal|'\0'
operator|&&
name|pos2
index|[
literal|3
index|]
operator|==
literal|'\0'
condition|)
block|{
name|pos2
operator|+=
literal|4
expr_stmt|;
break|break;
block|}
operator|*
name|pos
operator|++
operator|=
name|pos2
index|[
literal|0
index|]
expr_stmt|;
name|pos2
operator|+=
literal|2
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|pos
operator|+
literal|2
argument_list|,
name|names
argument_list|,
name|pos
operator|-
name|names
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
block|}
else|else
name|pos
operator|=
name|names
expr_stmt|;
name|num_name
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|names
operator|+
name|len
condition|)
block|{
name|name
index|[
name|num_name
index|]
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|&&
name|pos
operator|<
name|names
operator|+
name|len
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>=
name|names
operator|+
name|len
condition|)
block|{
name|os_free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|num_name
operator|++
expr_stmt|;
if|if
condition|(
name|num_name
operator|>=
name|MAX_ADAPTERS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Too many adapters"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d adapter names found"
argument_list|,
name|num_name
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|num_desc
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|names
operator|+
name|len
condition|)
block|{
name|desc
index|[
name|num_desc
index|]
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|&&
name|pos
operator|<
name|names
operator|+
name|len
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>=
name|names
operator|+
name|len
condition|)
block|{
name|os_free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|num_desc
operator|++
expr_stmt|;
if|if
condition|(
name|num_desc
operator|>=
name|MAX_ADAPTERS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Too many adapter "
literal|"descriptions"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d adapter descriptions "
literal|"found"
argument_list|,
name|num_name
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * Windows 98 with Packet.dll 3.0 alpha3 does not include adapter 	 * descriptions. Fill in dummy descriptors to work around this. 	 */
while|while
condition|(
name|num_desc
operator|<
name|num_name
condition|)
name|desc
index|[
name|num_desc
operator|++
index|]
operator|=
literal|"dummy description"
expr_stmt|;
if|if
condition|(
name|num_name
operator|!=
name|num_desc
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: mismatch in adapter name and "
literal|"description counts (%d != %d)"
argument_list|,
name|num_name
argument_list|,
name|num_desc
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|found_name
operator|=
name|found_desc
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_name
condition|;
name|i
operator|++
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: %d - %s - %s"
argument_list|,
name|i
argument_list|,
name|name
index|[
name|i
index|]
argument_list|,
name|desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|found_name
operator|==
operator|-
literal|1
operator|&&
name|os_strstr
argument_list|(
name|name
index|[
name|i
index|]
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
condition|)
name|found_name
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|found_desc
operator|==
operator|-
literal|1
operator|&&
name|os_strncmp
argument_list|(
name|desc
index|[
name|i
index|]
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|os_strlen
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|found_desc
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|found_name
operator|<
literal|0
operator|&&
name|found_desc
operator|>=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Matched interface '%s' based on "
literal|"description '%s'"
argument_list|,
name|name
index|[
name|found_desc
index|]
argument_list|,
name|desc
index|[
name|found_desc
index|]
argument_list|)
expr_stmt|;
name|found_name
operator|=
name|found_desc
expr_stmt|;
name|os_strncpy
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|os_strncmp
argument_list|(
name|name
index|[
name|found_desc
index|]
argument_list|,
literal|"\\Device\\NPF_"
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|?
name|name
index|[
name|found_desc
index|]
operator|+
literal|12
else|:
name|name
index|[
name|found_desc
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|found_name
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Could not find interface '%s'"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|i
operator|=
name|found_name
expr_stmt|;
name|pos
operator|=
name|os_strrchr
argument_list|(
name|desc
index|[
name|i
index|]
argument_list|,
literal|'('
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|dlen
operator|=
name|pos
operator|-
name|desc
index|[
name|i
index|]
expr_stmt|;
name|pos
operator|--
expr_stmt|;
if|if
condition|(
name|pos
operator|>
name|desc
index|[
name|i
index|]
operator|&&
operator|*
name|pos
operator|==
literal|' '
condition|)
name|dlen
operator|--
expr_stmt|;
block|}
else|else
block|{
name|dlen
operator|=
name|os_strlen
argument_list|(
name|desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|drv
operator|->
name|adapter_desc
operator|=
name|os_malloc
argument_list|(
name|dlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|adapter_desc
condition|)
block|{
name|os_memcpy
argument_list|(
name|drv
operator|->
name|adapter_desc
argument_list|,
name|desc
index|[
name|i
index|]
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|drv
operator|->
name|adapter_desc
index|[
name|dlen
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|os_free
argument_list|(
name|names
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Adapter description prefix '%s'"
argument_list|,
name|drv
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_USE_NDISUIO */
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_NATIVE_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
end_if

begin_ifndef
ifndef|#
directive|ifndef
name|_WIN32_WCE
end_ifndef

begin_comment
comment|/*  * These structures are undocumented for WinXP; only WinCE version is  * documented. These would be included wzcsapi.h if it were available. Some  * changes here have been needed to make the structures match with WinXP SP2.  * It is unclear whether these work with any other version.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|LPWSTR
name|wszGuid
decl_stmt|;
block|}
name|INTF_KEY_ENTRY
operator|,
typedef|*
name|PINTF_KEY_ENTRY
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|DWORD
name|dwNumIntfs
decl_stmt|;
name|PINTF_KEY_ENTRY
name|pIntfs
decl_stmt|;
block|}
name|INTFS_KEY_TABLE
operator|,
typedef|*
name|PINTFS_KEY_TABLE
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|DWORD
name|dwDataLen
decl_stmt|;
name|LPBYTE
name|pData
decl_stmt|;
block|}
name|RAW_DATA
operator|,
typedef|*
name|PRAW_DATA
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|LPWSTR
name|wszGuid
decl_stmt|;
name|LPWSTR
name|wszDescr
decl_stmt|;
name|ULONG
name|ulMediaState
decl_stmt|;
name|ULONG
name|ulMediaType
decl_stmt|;
name|ULONG
name|ulPhysicalMediaType
decl_stmt|;
name|INT
name|nInfraMode
decl_stmt|;
name|INT
name|nAuthMode
decl_stmt|;
name|INT
name|nWepStatus
decl_stmt|;
ifndef|#
directive|ifndef
name|_WIN32_WCE
name|u8
name|pad
index|[
literal|2
index|]
decl_stmt|;
comment|/* why is this needed? */
endif|#
directive|endif
comment|/* _WIN32_WCE */
name|DWORD
name|dwCtlFlags
decl_stmt|;
name|DWORD
name|dwCapabilities
decl_stmt|;
comment|/* something added for WinXP SP2(?) */
name|RAW_DATA
name|rdSSID
decl_stmt|;
name|RAW_DATA
name|rdBSSID
decl_stmt|;
name|RAW_DATA
name|rdBSSIDList
decl_stmt|;
name|RAW_DATA
name|rdStSSIDList
decl_stmt|;
name|RAW_DATA
name|rdCtrlData
decl_stmt|;
ifdef|#
directive|ifdef
name|UNDER_CE
name|BOOL
name|bInitialized
decl_stmt|;
endif|#
directive|endif
name|DWORD
name|nWPAMCastCipher
decl_stmt|;
comment|/* add some extra buffer for later additions since this interface is 	 * far from stable */
name|u8
name|later_additions
index|[
literal|100
index|]
decl_stmt|;
block|}
name|INTF_ENTRY
operator|,
typedef|*
name|PINTF_ENTRY
typedef|;
end_typedef

begin_define
define|#
directive|define
name|INTF_ALL
value|0xffffffff
end_define

begin_define
define|#
directive|define
name|INTF_ALL_FLAGS
value|0x0000ffff
end_define

begin_define
define|#
directive|define
name|INTF_CTLFLAGS
value|0x00000010
end_define

begin_define
define|#
directive|define
name|INTFCTL_ENABLED
value|0x8000
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _WIN32_WCE */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32_WCE
end_ifdef

begin_function
specifier|static
name|int
name|wpa_driver_ndis_rebind_adapter
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
name|HANDLE
name|ndis
decl_stmt|;
name|TCHAR
name|multi
index|[
literal|100
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|_tcslen
argument_list|(
name|drv
operator|->
name|adapter_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|80
condition|)
return|return
operator|-
literal|1
return|;
name|ndis
operator|=
name|CreateFile
argument_list|(
name|DD_NDIS_DEVICE_NAME
argument_list|,
name|GENERIC_READ
operator||
name|GENERIC_WRITE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|OPEN_EXISTING
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndis
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to open file to NDIS "
literal|"device: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|++
expr_stmt|;
name|memcpy
argument_list|(
name|multi
argument_list|,
name|drv
operator|->
name|adapter_name
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|TCHAR
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|multi
index|[
name|len
index|]
argument_list|,
name|TEXT
argument_list|(
literal|"NDISUIO\0"
argument_list|)
argument_list|,
literal|9
operator|*
sizeof|sizeof
argument_list|(
name|TCHAR
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|+=
literal|9
expr_stmt|;
if|if
condition|(
operator|!
name|DeviceIoControl
argument_list|(
name|ndis
argument_list|,
name|IOCTL_NDIS_REBIND_ADAPTER
argument_list|,
name|multi
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|TCHAR
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: IOCTL_NDIS_REBIND_ADAPTER "
literal|"failed: 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: rebind multi_sz"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|multi
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|TCHAR
argument_list|)
argument_list|)
expr_stmt|;
name|CloseHandle
argument_list|(
name|ndis
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|CloseHandle
argument_list|(
name|ndis
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Requested NDIS rebind of NDISUIO "
literal|"protocol"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _WIN32_WCE */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_wzc
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|_WIN32_WCE
name|HKEY
name|hk
decl_stmt|,
name|hk2
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|DWORD
name|i
decl_stmt|,
name|hnd
decl_stmt|,
name|len
decl_stmt|;
name|TCHAR
name|keyname
index|[
literal|256
index|]
decl_stmt|,
name|devname
index|[
literal|256
index|]
decl_stmt|;
define|#
directive|define
name|WZC_DRIVER
value|TEXT("Drivers\\BuiltIn\\ZeroConfig")
if|if
condition|(
name|enable
condition|)
block|{
name|HANDLE
name|h
decl_stmt|;
name|h
operator|=
name|ActivateDeviceEx
argument_list|(
name|WZC_DRIVER
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|INVALID_HANDLE_VALUE
operator|||
name|h
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to re-enable WZC "
literal|"- ActivateDeviceEx failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WZC re-enabled"
argument_list|)
expr_stmt|;
return|return
name|wpa_driver_ndis_rebind_adapter
argument_list|(
name|drv
argument_list|)
return|;
block|}
comment|/* 	 * Unfortunately, just disabling the WZC for an interface is not enough 	 * to free NDISUIO for us, so need to disable and unload WZC completely 	 * for now when using WinCE with NDISUIO. In addition, must request 	 * NDISUIO protocol to be rebound to the adapter in order to free the 	 * NDISUIO binding that WZC hold before us. 	 */
comment|/* Enumerate HKLM\Drivers\Active\* to find a handle to WZC. */
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|HKEY_LOCAL_MACHINE
argument_list|,
name|DEVLOAD_ACTIVE_KEY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: RegOpenKeyEx(DEVLOAD_ACTIVE_KEY) "
literal|"failed: %d %d"
argument_list|,
operator|(
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
name|len
operator|=
sizeof|sizeof
argument_list|(
name|keyname
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegEnumKeyEx
argument_list|(
name|hk
argument_list|,
name|i
argument_list|,
name|keyname
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Could not find active "
literal|"WZC - assuming it is not running."
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|hk
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|hk
argument_list|,
name|keyname
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|hk2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: RegOpenKeyEx(active dev) "
literal|"failed: %d %d"
argument_list|,
operator|(
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|devname
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk2
argument_list|,
name|DEVLOAD_DEVKEY_VALNAME
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
name|devname
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: RegQueryValueEx("
literal|"DEVKEY_VALNAME) failed: %d %d"
argument_list|,
operator|(
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|hk2
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|_tcscmp
argument_list|(
name|devname
argument_list|,
name|WZC_DRIVER
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|RegCloseKey
argument_list|(
name|hk2
argument_list|)
expr_stmt|;
block|}
name|RegCloseKey
argument_list|(
name|hk
argument_list|)
expr_stmt|;
comment|/* Found WZC - get handle to it. */
name|len
operator|=
sizeof|sizeof
argument_list|(
name|hnd
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk2
argument_list|,
name|DEVLOAD_HANDLE_VALNAME
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|PUCHAR
operator|)
operator|&
name|hnd
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: RegQueryValueEx(HANDLE_VALNAME) "
literal|"failed: %d %d"
argument_list|,
operator|(
name|int
operator|)
name|ret
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|hk2
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|RegCloseKey
argument_list|(
name|hk2
argument_list|)
expr_stmt|;
comment|/* Deactivate WZC */
if|if
condition|(
operator|!
name|DeactivateDevice
argument_list|(
operator|(
name|HANDLE
operator|)
name|hnd
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: DeactivateDevice failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Disabled WZC temporarily"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|wzc_disabled
operator|=
literal|1
expr_stmt|;
return|return
name|wpa_driver_ndis_rebind_adapter
argument_list|(
name|drv
argument_list|)
return|;
else|#
directive|else
comment|/* _WIN32_WCE */
name|HMODULE
name|hm
decl_stmt|;
name|DWORD
function_decl|(
name|WINAPI
modifier|*
name|wzc_enum_interf
function_decl|)
parameter_list|(
name|LPWSTR
name|pSrvAddr
parameter_list|,
name|PINTFS_KEY_TABLE
name|pIntfs
parameter_list|)
function_decl|;
name|DWORD
function_decl|(
name|WINAPI
modifier|*
name|wzc_query_interf
function_decl|)
parameter_list|(
name|LPWSTR
name|pSrvAddr
parameter_list|,
name|DWORD
name|dwInFlags
parameter_list|,
name|PINTF_ENTRY
name|pIntf
parameter_list|,
name|LPDWORD
name|pdwOutFlags
parameter_list|)
function_decl|;
name|DWORD
function_decl|(
name|WINAPI
modifier|*
name|wzc_set_interf
function_decl|)
parameter_list|(
name|LPWSTR
name|pSrvAddr
parameter_list|,
name|DWORD
name|dwInFlags
parameter_list|,
name|PINTF_ENTRY
name|pIntf
parameter_list|,
name|LPDWORD
name|pdwOutFlags
parameter_list|)
function_decl|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|,
name|j
decl_stmt|;
name|DWORD
name|res
decl_stmt|;
name|INTFS_KEY_TABLE
name|guids
decl_stmt|;
name|INTF_ENTRY
name|intf
decl_stmt|;
name|char
name|guid
index|[
literal|128
index|]
decl_stmt|;
name|WCHAR
modifier|*
name|pos
decl_stmt|;
name|DWORD
name|flags
decl_stmt|,
name|i
decl_stmt|;
name|hm
operator|=
name|LoadLibrary
argument_list|(
name|TEXT
argument_list|(
literal|"wzcsapi.dll"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to load wzcsapi.dll (%u) "
literal|"- WZC probably not running"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|_WIN32_WCE
name|wzc_enum_interf
operator|=
operator|(
name|void
operator|*
operator|)
name|GetProcAddressA
argument_list|(
name|hm
argument_list|,
literal|"WZCEnumInterfaces"
argument_list|)
expr_stmt|;
name|wzc_query_interf
operator|=
operator|(
name|void
operator|*
operator|)
name|GetProcAddressA
argument_list|(
name|hm
argument_list|,
literal|"WZCQueryInterface"
argument_list|)
expr_stmt|;
name|wzc_set_interf
operator|=
operator|(
name|void
operator|*
operator|)
name|GetProcAddressA
argument_list|(
name|hm
argument_list|,
literal|"WZCSetInterface"
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* _WIN32_WCE */
name|wzc_enum_interf
operator|=
operator|(
name|void
operator|*
operator|)
name|GetProcAddress
argument_list|(
name|hm
argument_list|,
literal|"WZCEnumInterfaces"
argument_list|)
expr_stmt|;
name|wzc_query_interf
operator|=
operator|(
name|void
operator|*
operator|)
name|GetProcAddress
argument_list|(
name|hm
argument_list|,
literal|"WZCQueryInterface"
argument_list|)
expr_stmt|;
name|wzc_set_interf
operator|=
operator|(
name|void
operator|*
operator|)
name|GetProcAddress
argument_list|(
name|hm
argument_list|,
literal|"WZCSetInterface"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
if|if
condition|(
name|wzc_enum_interf
operator|==
name|NULL
operator|||
name|wzc_query_interf
operator|==
name|NULL
operator|||
name|wzc_set_interf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WZCEnumInterfaces, "
literal|"WZCQueryInterface, or WZCSetInterface not found "
literal|"in wzcsapi.dll"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_memset
argument_list|(
operator|&
name|guids
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|guids
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|=
name|wzc_enum_interf
argument_list|(
name|NULL
argument_list|,
operator|&
name|guids
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WZCEnumInterfaces failed: %d; "
literal|"WZC service is apparently not running"
argument_list|,
operator|(
name|int
operator|)
name|res
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WZCEnumInterfaces: %d interfaces"
argument_list|,
operator|(
name|int
operator|)
name|guids
operator|.
name|dwNumIntfs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|guids
operator|.
name|dwNumIntfs
condition|;
name|i
operator|++
control|)
block|{
name|pos
operator|=
name|guids
operator|.
name|pIntfs
index|[
name|i
index|]
operator|.
name|wszGuid
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|guid
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|guid
index|[
name|j
index|]
operator|=
operator|(
name|char
operator|)
operator|*
name|pos
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|0
condition|)
break|break;
name|pos
operator|++
expr_stmt|;
block|}
name|guid
index|[
sizeof|sizeof
argument_list|(
name|guid
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: intfs %d GUID '%s'"
argument_list|,
operator|(
name|int
operator|)
name|i
argument_list|,
name|guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|guid
argument_list|)
operator|==
name|NULL
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Current interface found from "
literal|"WZC"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|guids
operator|.
name|dwNumIntfs
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Current interface not found from "
literal|"WZC"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_memset
argument_list|(
operator|&
name|intf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|intf
argument_list|)
argument_list|)
expr_stmt|;
name|intf
operator|.
name|wszGuid
operator|=
name|guids
operator|.
name|pIntfs
index|[
name|i
index|]
operator|.
name|wszGuid
expr_stmt|;
comment|/* Set flags to verify that the structure has not changed. */
name|intf
operator|.
name|dwCtlFlags
operator|=
operator|-
literal|1
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
name|res
operator|=
name|wzc_query_interf
argument_list|(
name|NULL
argument_list|,
name|INTFCTL_ENABLED
argument_list|,
operator|&
name|intf
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Could not query flags for the "
literal|"WZC interface: %d (0x%x)"
argument_list|,
operator|(
name|int
operator|)
name|res
argument_list|,
operator|(
name|int
operator|)
name|res
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: GetLastError: %u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WZC interface flags 0x%x dwCtlFlags 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|flags
argument_list|,
operator|(
name|int
operator|)
name|intf
operator|.
name|dwCtlFlags
argument_list|)
expr_stmt|;
if|if
condition|(
name|intf
operator|.
name|dwCtlFlags
operator|==
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Looks like wzcsapi has changed "
literal|"again - could not disable WZC"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NDIS: intf"
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|intf
argument_list|,
sizeof|sizeof
argument_list|(
name|intf
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|enable
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|intf
operator|.
name|dwCtlFlags
operator|&
name|INTFCTL_ENABLED
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Enabling WZC for this "
literal|"interface"
argument_list|)
expr_stmt|;
name|intf
operator|.
name|dwCtlFlags
operator||=
name|INTFCTL_ENABLED
expr_stmt|;
name|res
operator|=
name|wzc_set_interf
argument_list|(
name|NULL
argument_list|,
name|INTFCTL_ENABLED
argument_list|,
operator|&
name|intf
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to enable "
literal|"WZC: %d (0x%x)"
argument_list|,
operator|(
name|int
operator|)
name|res
argument_list|,
operator|(
name|int
operator|)
name|res
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: GetLastError: %u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Re-enabled WZC for this "
literal|"interface"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|wzc_disabled
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|intf
operator|.
name|dwCtlFlags
operator|&
name|INTFCTL_ENABLED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Disabling WZC for this "
literal|"interface"
argument_list|)
expr_stmt|;
name|intf
operator|.
name|dwCtlFlags
operator|&=
operator|~
name|INTFCTL_ENABLED
expr_stmt|;
name|res
operator|=
name|wzc_set_interf
argument_list|(
name|NULL
argument_list|,
name|INTFCTL_ENABLED
argument_list|,
operator|&
name|intf
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to "
literal|"disable WZC: %d (0x%x)"
argument_list|,
operator|(
name|int
operator|)
name|res
argument_list|,
operator|(
name|int
operator|)
name|res
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: GetLastError: %u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Disabled WZC temporarily "
literal|"for this interface"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|wzc_disabled
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: WZC was not enabled for "
literal|"this interface"
argument_list|)
expr_stmt|;
block|}
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|fail
label|:
name|FreeLibrary
argument_list|(
name|hm
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS || __CYGWIN__ */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_ndis_set_wzc
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS || __CYGWIN__ */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_USE_NDISUIO
end_ifdef

begin_comment
comment|/*  * l2_packet_ndis.c is sharing the same handle to NDISUIO, so we must be able  * to export this handle. This is somewhat ugly, but there is no better  * mechanism available to pass data from driver interface to l2_packet wrapper.  */
end_comment

begin_decl_stmt
specifier|static
name|HANDLE
name|driver_ndis_ndisuio_handle
init|=
name|INVALID_HANDLE_VALUE
decl_stmt|;
end_decl_stmt

begin_function
name|HANDLE
name|driver_ndis_get_ndisuio_handle
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|driver_ndis_ndisuio_handle
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_USE_NDISUIO */
end_comment

begin_function
specifier|static
name|int
name|wpa_driver_ndis_adapter_init
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_USE_NDISUIO
ifndef|#
directive|ifndef
name|_WIN32_WCE
define|#
directive|define
name|NDISUIO_DEVICE_NAME
value|TEXT("\\\\.\\\\Ndisuio")
name|DWORD
name|written
decl_stmt|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
name|drv
operator|->
name|ndisuio
operator|=
name|CreateFile
argument_list|(
name|NDISUIO_DEVICE_NAME
argument_list|,
name|GENERIC_READ
operator||
name|GENERIC_WRITE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|OPEN_EXISTING
argument_list|,
name|FILE_ATTRIBUTE_NORMAL
operator||
name|FILE_FLAG_OVERLAPPED
argument_list|,
name|INVALID_HANDLE_VALUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ndisuio
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NDIS: Failed to open connection to "
literal|"NDISUIO: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|driver_ndis_ndisuio_handle
operator|=
name|drv
operator|->
name|ndisuio
expr_stmt|;
ifndef|#
directive|ifndef
name|_WIN32_WCE
if|if
condition|(
operator|!
name|DeviceIoControl
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|,
name|IOCTL_NDISUIO_BIND_WAIT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|written
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NDIS: IOCTL_NDISUIO_BIND_WAIT failed: "
literal|"%d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|CloseHandle
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ndisuio
operator|=
name|INVALID_HANDLE_VALUE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* _WIN32_WCE */
return|return
literal|0
return|;
else|#
directive|else
comment|/* CONFIG_USE_NDISUIO */
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_USE_NDISUIO */
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ndis_adapter_open
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_USE_NDISUIO
name|DWORD
name|written
decl_stmt|;
define|#
directive|define
name|MAX_NDIS_DEVICE_NAME_LEN
value|256
name|WCHAR
name|ifname
index|[
name|MAX_NDIS_DEVICE_NAME_LEN
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|i
decl_stmt|,
name|pos
decl_stmt|;
specifier|const
name|char
modifier|*
name|prefix
init|=
literal|"\\DEVICE\\"
decl_stmt|;
ifdef|#
directive|ifdef
name|_WIN32_WCE
name|pos
operator|=
literal|0
expr_stmt|;
else|#
directive|else
comment|/* _WIN32_WCE */
name|pos
operator|=
literal|8
expr_stmt|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
name|len
operator|=
name|pos
operator|+
name|os_strlen
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|MAX_NDIS_DEVICE_NAME_LEN
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pos
condition|;
name|i
operator|++
control|)
name|ifname
index|[
name|i
index|]
operator|=
operator|(
name|WCHAR
operator|)
name|prefix
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|pos
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|ifname
index|[
name|i
index|]
operator|=
operator|(
name|WCHAR
operator|)
name|drv
operator|->
name|ifname
index|[
name|i
operator|-
name|pos
index|]
expr_stmt|;
name|ifname
index|[
name|i
index|]
operator|=
literal|L'
expr|\0'
expr_stmt|;
if|if
condition|(
operator|!
name|DeviceIoControl
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|,
name|IOCTL_NDISUIO_OPEN_DEVICE
argument_list|,
name|ifname
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|WCHAR
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|written
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NDIS: IOCTL_NDISUIO_OPEN_DEVICE "
literal|"failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: ifname"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|ifname
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|WCHAR
argument_list|)
argument_list|)
expr_stmt|;
name|CloseHandle
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ndisuio
operator|=
name|INVALID_HANDLE_VALUE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Opened NDISUIO device successfully"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* CONFIG_USE_NDISUIO */
name|char
name|ifname
index|[
literal|128
index|]
decl_stmt|;
name|os_snprintf
argument_list|(
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
argument_list|,
literal|"\\Device\\NPF_%s"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|drv
operator|->
name|adapter
operator|=
name|PacketOpenAdapter
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|adapter
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: PacketOpenAdapter failed for "
literal|"'%s'"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_USE_NDISUIO */
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_adapter_close
parameter_list|(
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_USE_NDISUIO
name|driver_ndis_ndisuio_handle
operator|=
name|INVALID_HANDLE_VALUE
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ndisuio
operator|!=
name|INVALID_HANDLE_VALUE
condition|)
name|CloseHandle
argument_list|(
name|drv
operator|->
name|ndisuio
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* CONFIG_USE_NDISUIO */
if|if
condition|(
name|drv
operator|->
name|adapter
condition|)
name|PacketCloseAdapter
argument_list|(
name|drv
operator|->
name|adapter
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_USE_NDISUIO */
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|wpa_driver_ndis_init
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
decl_stmt|;
name|u32
name|mode
decl_stmt|;
name|drv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|drv
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
comment|/* 	 * Compatibility code to strip possible prefix from the GUID. Previous 	 * versions include \Device\NPF_ prefix for all names, but the internal 	 * interface name is now only the GUI. Both Packet32 and NDISUIO 	 * prefixes are supported. 	 */
if|if
condition|(
name|os_strncmp
argument_list|(
name|ifname
argument_list|,
literal|"\\Device\\NPF_"
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
name|ifname
operator|+=
literal|12
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|ifname
argument_list|,
literal|"\\DEVICE\\"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
name|ifname
operator|+=
literal|8
expr_stmt|;
name|os_strncpy
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_adapter_init
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wpa_driver_ndis_get_names
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_driver_ndis_adapter_close
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_driver_ndis_set_wzc
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_adapter_open
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_driver_ndis_adapter_close
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ndis_get_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_3_CURRENT_ADDRESS
argument_list|,
name|drv
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Get OID_802_3_CURRENT_ADDRESS "
literal|"failed"
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_adapter_close
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_driver_ndis_get_capability
argument_list|(
name|drv
argument_list|)
expr_stmt|;
comment|/* Make sure that the driver does not have any obsolete PMKID entries. 	 */
name|wpa_driver_ndis_flush_pmkid
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_NDIS_EVENTS_INTEGRATED
name|drv
operator|->
name|events
operator|=
name|ndis_events_init
argument_list|(
operator|&
name|drv
operator|->
name|events_pipe
argument_list|,
operator|&
name|drv
operator|->
name|event_avail
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|drv
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|events
operator|==
name|NULL
condition|)
block|{
name|wpa_driver_ndis_deinit
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|eloop_register_event
argument_list|(
name|drv
operator|->
name|event_avail
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|event_avail
argument_list|)
argument_list|,
name|wpa_driver_ndis_event_pipe_cb
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NDIS_EVENTS_INTEGRATED */
ifdef|#
directive|ifdef
name|_WIN32_WCE
if|if
condition|(
name|ndisuio_notification_init
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_driver_ndis_deinit
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
endif|#
directive|endif
comment|/* _WIN32_WCE */
comment|/* Set mode here in case card was configured for ad-hoc mode 	 * previously. */
name|mode
operator|=
name|Ndis802_11Infrastructure
expr_stmt|;
if|if
condition|(
name|ndis_set_oid
argument_list|(
name|drv
argument_list|,
name|OID_802_11_INFRASTRUCTURE_MODE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|mode
argument_list|,
sizeof|sizeof
argument_list|(
name|mode
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Failed to set "
literal|"OID_802_11_INFRASTRUCTURE_MODE (%d)"
argument_list|,
operator|(
name|int
operator|)
name|mode
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
if|if
condition|(
operator|!
name|drv
operator|->
name|has_capability
operator|&&
name|drv
operator|->
name|capa
operator|.
name|enc
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: Driver did not provide "
literal|"any wireless capabilities - assume it is "
literal|"a wired interface"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|wired
operator|=
literal|1
expr_stmt|;
block|}
block|}
return|return
name|drv
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_ndis_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_ndis_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_NDIS_EVENTS_INTEGRATED
if|if
condition|(
name|drv
operator|->
name|events
condition|)
block|{
name|eloop_unregister_event
argument_list|(
name|drv
operator|->
name|event_avail
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|event_avail
argument_list|)
argument_list|)
expr_stmt|;
name|ndis_events_deinit
argument_list|(
name|drv
operator|->
name|events
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NDIS_EVENTS_INTEGRATED */
ifdef|#
directive|ifdef
name|_WIN32_WCE
name|ndisuio_notification_deinit
argument_list|(
name|drv
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_ndis_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_ndis_poll_timeout
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_flush_pmkid
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|wpa_driver_ndis_disconnect
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_ndis_radio_off
argument_list|(
name|drv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NDIS: failed to disassociate and turn "
literal|"radio off"
argument_list|)
expr_stmt|;
block|}
name|wpa_driver_ndis_adapter_close
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|wzc_disabled
condition|)
name|wpa_driver_ndis_set_wzc
argument_list|(
name|drv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|_WIN32_WCE
name|os_free
argument_list|(
name|drv
operator|->
name|adapter_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
name|os_free
argument_list|(
name|drv
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|wpa_driver_ops
name|wpa_driver_ndis_ops
init|=
block|{
literal|"ndis"
block|,
literal|"Windows NDIS driver"
block|,
name|wpa_driver_ndis_get_bssid
block|,
name|wpa_driver_ndis_get_ssid
block|,
name|wpa_driver_ndis_set_wpa
block|,
name|wpa_driver_ndis_set_key
block|,
name|wpa_driver_ndis_init
block|,
name|wpa_driver_ndis_deinit
block|,
name|NULL
comment|/* set_param */
block|,
name|NULL
comment|/* set_countermeasures */
block|,
name|NULL
comment|/* set_drop_unencrypted */
block|,
name|wpa_driver_ndis_scan
block|,
name|wpa_driver_ndis_get_scan_results
block|,
name|wpa_driver_ndis_deauthenticate
block|,
name|wpa_driver_ndis_disassociate
block|,
name|wpa_driver_ndis_associate
block|,
name|NULL
comment|/* set_auth_alg */
block|,
name|wpa_driver_ndis_add_pmkid
block|,
name|wpa_driver_ndis_remove_pmkid
block|,
name|wpa_driver_ndis_flush_pmkid
block|,
name|wpa_driver_ndis_get_capa
block|,
name|wpa_driver_ndis_poll
block|,
name|wpa_driver_ndis_get_ifname
block|,
name|wpa_driver_ndis_get_mac_addr
block|,
name|NULL
comment|/* send_eapol */
block|,
name|NULL
comment|/* set_operstate */
block|,
name|NULL
comment|/* mlme_setprotection */
block|,
name|NULL
comment|/* get_hw_feature_data */
block|,
name|NULL
comment|/* set_channel */
block|,
name|NULL
comment|/* set_ssid */
block|,
name|NULL
comment|/* set_bssid */
block|,
name|NULL
comment|/* send_mlme */
block|,
name|NULL
comment|/* mlme_add_sta */
block|,
name|NULL
comment|/* mlme_remove_sta */
block|}
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / PC/SC smartcard interface for USIM, GSM SIM  * Copyright (c) 2004-2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<winscard.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_comment
comment|/* See ETSI GSM 11.11 and ETSI TS 102 221 for details.  * SIM commands:  * Command APDU: CLA INS P1 P2 P3 Data  *   CLA (class of instruction): A0 for GSM, 00 for USIM  *   INS (instruction)  *   P1 P2 P3 (parameters, P3 = length of Data)  * Response APDU: Data SW1 SW2  *   SW1 SW2 (Status words)  * Commands (INS P1 P2 P3):  *   SELECT: A4 00 00 02<file_id, 2 bytes>  *   GET RESPONSE: C0 00 00<len>  *   RUN GSM ALG: 88 00 00 00<RAND len = 10>  *   RUN UMTS ALG: 88 00 81<len=0x22> data: 0x10 | RAND | 0x10 | AUTN  *	P1 = ID of alg in card  *	P2 = ID of secret key  *   READ BINARY: B0<offset high><offset low><len>  *   VERIFY CHV: 20 00<CHV number> 08  *   CHANGE CHV: 24 00<CHV number> 10  *   DISABLE CHV: 26 00 01 08  *   ENABLE CHV: 28 00 01 08  *   UNBLOCK CHV: 2C 00<00=CHV1, 02=CHV2> 10  *   SLEEP: FA 00 00 00  */
end_comment

begin_comment
comment|/* GSM SIM commands */
end_comment

begin_define
define|#
directive|define
name|SIM_CMD_SELECT
value|0xa0, 0xa4, 0x00, 0x00, 0x02
end_define

begin_define
define|#
directive|define
name|SIM_CMD_RUN_GSM_ALG
value|0xa0, 0x88, 0x00, 0x00, 0x10
end_define

begin_define
define|#
directive|define
name|SIM_CMD_GET_RESPONSE
value|0xa0, 0xc0, 0x00, 0x00
end_define

begin_define
define|#
directive|define
name|SIM_CMD_READ_BIN
value|0xa0, 0xb0, 0x00, 0x00
end_define

begin_define
define|#
directive|define
name|SIM_CMD_VERIFY_CHV1
value|0xa0, 0x20, 0x00, 0x01, 0x08
end_define

begin_comment
comment|/* USIM commands */
end_comment

begin_define
define|#
directive|define
name|USIM_CLA
value|0x00
end_define

begin_define
define|#
directive|define
name|USIM_CMD_RUN_UMTS_ALG
value|0x00, 0x88, 0x00, 0x81, 0x22
end_define

begin_define
define|#
directive|define
name|USIM_CMD_GET_RESPONSE
value|0x00, 0xc0, 0x00, 0x00
end_define

begin_define
define|#
directive|define
name|USIM_FSP_TEMPL_TAG
value|0x62
end_define

begin_define
define|#
directive|define
name|USIM_TLV_FILE_DESC
value|0x82
end_define

begin_define
define|#
directive|define
name|USIM_TLV_FILE_ID
value|0x83
end_define

begin_define
define|#
directive|define
name|USIM_TLV_DF_NAME
value|0x84
end_define

begin_define
define|#
directive|define
name|USIM_TLV_PROPR_INFO
value|0xA5
end_define

begin_define
define|#
directive|define
name|USIM_TLV_LIFE_CYCLE_STATUS
value|0x8A
end_define

begin_define
define|#
directive|define
name|USIM_TLV_FILE_SIZE
value|0x80
end_define

begin_define
define|#
directive|define
name|USIM_TLV_TOTAL_FILE_SIZE
value|0x81
end_define

begin_define
define|#
directive|define
name|USIM_TLV_PIN_STATUS_TEMPLATE
value|0xC6
end_define

begin_define
define|#
directive|define
name|USIM_TLV_SHORT_FILE_ID
value|0x88
end_define

begin_define
define|#
directive|define
name|USIM_PS_DO_TAG
value|0x90
end_define

begin_define
define|#
directive|define
name|AKA_RAND_LEN
value|16
end_define

begin_define
define|#
directive|define
name|AKA_AUTN_LEN
value|16
end_define

begin_define
define|#
directive|define
name|AKA_AUTS_LEN
value|14
end_define

begin_define
define|#
directive|define
name|RES_MAX_LEN
value|16
end_define

begin_define
define|#
directive|define
name|IK_LEN
value|16
end_define

begin_define
define|#
directive|define
name|CK_LEN
value|16
end_define

begin_typedef
typedef|typedef
enum|enum
block|{
name|SCARD_GSM_SIM
block|,
name|SCARD_USIM
block|}
name|sim_types
typedef|;
end_typedef

begin_struct
struct|struct
name|scard_data
block|{
name|long
name|ctx
decl_stmt|;
name|long
name|card
decl_stmt|;
name|unsigned
name|long
name|protocol
decl_stmt|;
name|sim_types
name|sim_type
decl_stmt|;
name|int
name|pin1_required
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|_scard_select_file
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|unsigned
name|short
name|file_id
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buf_len
parameter_list|,
name|sim_types
name|sim_type
parameter_list|,
name|unsigned
name|char
modifier|*
name|aid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scard_select_file
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|unsigned
name|short
name|file_id
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buf_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scard_verify_pin
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|scard_parse_fsp_templ
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|,
name|int
modifier|*
name|ps_do
parameter_list|,
name|int
modifier|*
name|file_len
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
if|if
condition|(
name|ps_do
condition|)
operator|*
name|ps_do
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|file_len
condition|)
operator|*
name|file_len
operator|=
operator|-
literal|1
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|buf_len
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
name|USIM_FSP_TEMPL_TAG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: file header did not "
literal|"start with FSP template tag"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|>=
name|end
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|(
name|pos
operator|+
name|pos
index|[
literal|0
index|]
operator|)
operator|<
name|end
condition|)
name|end
operator|=
name|pos
operator|+
literal|1
operator|+
name|pos
index|[
literal|0
index|]
expr_stmt|;
name|pos
operator|++
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: file header FSP template"
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"SCARD: file header TLV "
literal|"0x%02x len=%d"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|USIM_TLV_FILE_SIZE
operator|&&
operator|(
name|pos
index|[
literal|1
index|]
operator|==
literal|1
operator|||
name|pos
index|[
literal|1
index|]
operator|==
literal|2
operator|)
operator|&&
name|file_len
condition|)
block|{
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|==
literal|1
condition|)
operator|*
name|file_len
operator|=
operator|(
name|int
operator|)
name|pos
index|[
literal|2
index|]
expr_stmt|;
else|else
operator|*
name|file_len
operator|=
operator|(
operator|(
name|int
operator|)
name|pos
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|int
operator|)
name|pos
index|[
literal|3
index|]
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: file_size=%d"
argument_list|,
operator|*
name|file_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|USIM_TLV_PIN_STATUS_TEMPLATE
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|2
operator|&&
name|pos
index|[
literal|2
index|]
operator|==
name|USIM_PS_DO_TAG
operator|&&
name|pos
index|[
literal|3
index|]
operator|>=
literal|1
operator|&&
name|ps_do
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: PS_DO=0x%02x"
argument_list|,
name|pos
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
operator|*
name|ps_do
operator|=
operator|(
name|int
operator|)
name|pos
index|[
literal|4
index|]
expr_stmt|;
block|}
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|end
condition|)
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scard_pin_needed
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|unsigned
name|char
modifier|*
name|hdr
parameter_list|,
name|size_t
name|hlen
parameter_list|)
block|{
if|if
condition|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_GSM_SIM
condition|)
block|{
if|if
condition|(
name|hlen
operator|>
name|SCARD_CHV1_OFFSET
operator|&&
operator|!
operator|(
name|hdr
index|[
name|SCARD_CHV1_OFFSET
index|]
operator|&
name|SCARD_CHV1_FLAG
operator|)
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_USIM
condition|)
block|{
name|int
name|ps_do
decl_stmt|;
if|if
condition|(
name|scard_parse_fsp_templ
argument_list|(
name|hdr
argument_list|,
name|hlen
argument_list|,
operator|&
name|ps_do
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* TODO: there could be more than one PS_DO entry because of 		 * multiple PINs in key reference.. */
if|if
condition|(
name|ps_do
condition|)
return|return
literal|1
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|struct
name|scard_data
modifier|*
name|scard_init
parameter_list|(
name|scard_sim_type
name|sim_type
parameter_list|)
block|{
name|long
name|ret
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|scard_data
modifier|*
name|scard
decl_stmt|;
name|char
modifier|*
name|readers
init|=
name|NULL
decl_stmt|;
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|size_t
name|blen
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: initializing smart card interface"
argument_list|)
expr_stmt|;
name|scard
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|scard
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|scard
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|scard
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|scard
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|SCardEstablishContext
argument_list|(
name|SCARD_SCOPE_SYSTEM
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|scard
operator|->
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Could not establish smart card "
literal|"context (err=%ld)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|ret
operator|=
name|SCardListReaders
argument_list|(
name|scard
operator|->
name|ctx
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: SCardListReaders failed "
literal|"(err=%ld)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|readers
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|readers
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"malloc failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|ret
operator|=
name|SCardListReaders
argument_list|(
name|scard
operator|->
name|ctx
argument_list|,
name|NULL
argument_list|,
name|readers
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: SCardListReaders failed(2) "
literal|"(err=%ld)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|len
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: No smart card readers "
literal|"available."
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
comment|/* readers is a list of available reader. Last entry is terminated with 	 * double NUL. 	 * TODO: add support for selecting the reader; now just use the first 	 * one.. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Selected reader='%s'"
argument_list|,
name|readers
argument_list|)
expr_stmt|;
name|ret
operator|=
name|SCardConnect
argument_list|(
name|scard
operator|->
name|ctx
argument_list|,
name|readers
argument_list|,
name|SCARD_SHARE_SHARED
argument_list|,
name|SCARD_PROTOCOL_T0
argument_list|,
operator|&
name|scard
operator|->
name|card
argument_list|,
operator|&
name|scard
operator|->
name|protocol
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
block|{
if|if
condition|(
name|ret
operator|==
name|SCARD_E_NO_SMARTCARD
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No smart card inserted."
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCardConnect err=%lx"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|free
argument_list|(
name|readers
argument_list|)
expr_stmt|;
name|readers
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: card=%ld active_protocol=%lu"
argument_list|,
name|scard
operator|->
name|card
argument_list|,
name|scard
operator|->
name|protocol
argument_list|)
expr_stmt|;
name|blen
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|scard
operator|->
name|sim_type
operator|=
name|SCARD_GSM_SIM
expr_stmt|;
if|if
condition|(
name|sim_type
operator|==
name|SCARD_USIM_ONLY
operator|||
name|sim_type
operator|==
name|SCARD_TRY_BOTH
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: verifying USIM support"
argument_list|)
expr_stmt|;
if|if
condition|(
name|_scard_select_file
argument_list|(
name|scard
argument_list|,
name|SCARD_FILE_MF
argument_list|,
name|buf
argument_list|,
operator|&
name|blen
argument_list|,
name|SCARD_USIM
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: USIM is not supported"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sim_type
operator|==
name|SCARD_USIM_ONLY
condition|)
goto|goto
name|failed
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Trying to use GSM SIM"
argument_list|)
expr_stmt|;
name|scard
operator|->
name|sim_type
operator|=
name|SCARD_GSM_SIM
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: USIM is supported"
argument_list|)
expr_stmt|;
name|scard
operator|->
name|sim_type
operator|=
name|SCARD_USIM
expr_stmt|;
block|}
block|}
if|if
condition|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_GSM_SIM
condition|)
block|{
name|blen
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|scard_select_file
argument_list|(
name|scard
argument_list|,
name|SCARD_FILE_MF
argument_list|,
name|buf
argument_list|,
operator|&
name|blen
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Failed to read MF"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|blen
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|scard_select_file
argument_list|(
name|scard
argument_list|,
name|SCARD_FILE_GSM_DF
argument_list|,
name|buf
argument_list|,
operator|&
name|blen
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Failed to read GSM DF"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
block|}
else|else
block|{
comment|/* Select based on AID = 3G RID */
name|blen
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|_scard_select_file
argument_list|(
name|scard
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|,
operator|&
name|blen
argument_list|,
name|scard
operator|->
name|sim_type
argument_list|,
literal|"\xA0\x00\x00\x00\x87"
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Failed to read 3G RID "
literal|"AID"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
block|}
comment|/* Verify whether CHV1 (PIN1) is needed to access the card. */
if|if
condition|(
name|scard_pin_needed
argument_list|(
name|scard
argument_list|,
name|buf
argument_list|,
name|blen
argument_list|)
condition|)
block|{
name|scard
operator|->
name|pin1_required
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PIN1 needed for SIM access"
argument_list|)
expr_stmt|;
block|}
return|return
name|scard
return|;
name|failed
label|:
name|free
argument_list|(
name|readers
argument_list|)
expr_stmt|;
name|scard_deinit
argument_list|(
name|scard
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|scard_set_pin
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|)
block|{
if|if
condition|(
name|scard
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Verify whether CHV1 (PIN1) is needed to access the card. */
if|if
condition|(
name|scard
operator|->
name|pin1_required
condition|)
block|{
if|if
condition|(
name|pin
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No PIN configured for SIM "
literal|"access"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|scard_verify_pin
argument_list|(
name|scard
argument_list|,
name|pin
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PIN verification failed for "
literal|"SIM access"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|scard_deinit
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|)
block|{
name|long
name|ret
decl_stmt|;
if|if
condition|(
name|scard
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: deinitializing smart card interface"
argument_list|)
expr_stmt|;
if|if
condition|(
name|scard
operator|->
name|card
condition|)
block|{
name|ret
operator|=
name|SCardDisconnect
argument_list|(
name|scard
operator|->
name|card
argument_list|,
name|SCARD_UNPOWER_CARD
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Failed to disconnect "
literal|"smart card (err=%ld)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|scard
operator|->
name|ctx
condition|)
block|{
name|ret
operator|=
name|SCardReleaseContext
argument_list|(
name|scard
operator|->
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to release smart card "
literal|"context (err=%ld)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|scard
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|long
name|scard_transmit
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|unsigned
name|char
modifier|*
name|send
parameter_list|,
name|size_t
name|send_len
parameter_list|,
name|unsigned
name|char
modifier|*
name|recv
parameter_list|,
name|size_t
modifier|*
name|recv_len
parameter_list|)
block|{
name|long
name|ret
decl_stmt|;
name|unsigned
name|long
name|rlen
decl_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: scard_transmit: send"
argument_list|,
name|send
argument_list|,
name|send_len
argument_list|)
expr_stmt|;
name|rlen
operator|=
operator|*
name|recv_len
expr_stmt|;
name|ret
operator|=
name|SCardTransmit
argument_list|(
name|scard
operator|->
name|card
argument_list|,
name|scard
operator|->
name|protocol
operator|==
name|SCARD_PROTOCOL_T1
condition|?
name|SCARD_PCI_T1
else|:
name|SCARD_PCI_T0
argument_list|,
name|send
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|send_len
argument_list|,
name|NULL
argument_list|,
name|recv
argument_list|,
operator|&
name|rlen
argument_list|)
expr_stmt|;
operator|*
name|recv_len
operator|=
name|rlen
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SCARD_S_SUCCESS
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: scard_transmit: recv"
argument_list|,
name|recv
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: SCardTransmit failed "
literal|"(err=0x%lx)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_scard_select_file
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|unsigned
name|short
name|file_id
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buf_len
parameter_list|,
name|sim_types
name|sim_type
parameter_list|,
name|unsigned
name|char
modifier|*
name|aid
parameter_list|)
block|{
name|long
name|ret
decl_stmt|;
name|unsigned
name|char
name|resp
index|[
literal|3
index|]
decl_stmt|;
name|unsigned
name|char
name|cmd
index|[
literal|10
index|]
init|=
block|{
name|SIM_CMD_SELECT
block|}
decl_stmt|;
name|int
name|cmdlen
decl_stmt|;
name|unsigned
name|char
name|get_resp
index|[
literal|5
index|]
init|=
block|{
name|SIM_CMD_GET_RESPONSE
block|}
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|rlen
decl_stmt|;
if|if
condition|(
name|sim_type
operator|==
name|SCARD_USIM
condition|)
block|{
name|cmd
index|[
literal|0
index|]
operator|=
name|USIM_CLA
expr_stmt|;
name|cmd
index|[
literal|3
index|]
operator|=
literal|0x04
expr_stmt|;
name|get_resp
index|[
literal|0
index|]
operator|=
name|USIM_CLA
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: select file %04x"
argument_list|,
name|file_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|aid
condition|)
block|{
name|cmd
index|[
literal|2
index|]
operator|=
literal|0x04
expr_stmt|;
comment|/* Select by AID */
name|cmd
index|[
literal|4
index|]
operator|=
literal|5
expr_stmt|;
comment|/* len */
name|memcpy
argument_list|(
name|cmd
operator|+
literal|5
argument_list|,
name|aid
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|cmdlen
operator|=
literal|10
expr_stmt|;
block|}
else|else
block|{
name|cmd
index|[
literal|5
index|]
operator|=
name|file_id
operator|>>
literal|8
expr_stmt|;
name|cmd
index|[
literal|6
index|]
operator|=
name|file_id
operator|&
literal|0xff
expr_stmt|;
name|cmdlen
operator|=
literal|7
expr_stmt|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|scard_transmit
argument_list|(
name|scard
argument_list|,
name|cmd
argument_list|,
name|cmdlen
argument_list|,
name|resp
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: SCardTransmit failed "
literal|"(err=0x%lx)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: unexpected resp len "
literal|"%d (expected 2)"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|resp
index|[
literal|0
index|]
operator|==
literal|0x98
operator|&&
name|resp
index|[
literal|1
index|]
operator|==
literal|0x04
condition|)
block|{
comment|/* Security status not satisfied (PIN_WLAN) */
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: Security status not satisfied "
literal|"(PIN_WLAN)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|resp
index|[
literal|0
index|]
operator|==
literal|0x6e
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: used CLA not supported"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|resp
index|[
literal|0
index|]
operator|!=
literal|0x6c
operator|&&
name|resp
index|[
literal|0
index|]
operator|!=
literal|0x9f
operator|&&
name|resp
index|[
literal|0
index|]
operator|!=
literal|0x61
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: unexpected response 0x%02x "
literal|"(expected 0x61, 0x6c, or 0x9f)"
argument_list|,
name|resp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Normal ending of command; resp[1] bytes available */
name|get_resp
index|[
literal|4
index|]
operator|=
name|resp
index|[
literal|1
index|]
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: trying to get response (%d bytes)"
argument_list|,
name|resp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|rlen
operator|=
operator|*
name|buf_len
expr_stmt|;
name|ret
operator|=
name|scard_transmit
argument_list|(
name|scard
argument_list|,
name|get_resp
argument_list|,
sizeof|sizeof
argument_list|(
name|get_resp
argument_list|)
argument_list|,
name|buf
argument_list|,
operator|&
name|rlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SCARD_S_SUCCESS
condition|)
block|{
operator|*
name|buf_len
operator|=
name|resp
index|[
literal|1
index|]
operator|<
name|rlen
condition|?
name|resp
index|[
literal|1
index|]
else|:
name|rlen
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: SCardTransmit err=0x%lx\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scard_select_file
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|unsigned
name|short
name|file_id
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|buf_len
parameter_list|)
block|{
return|return
name|_scard_select_file
argument_list|(
name|scard
argument_list|,
name|file_id
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|,
name|scard
operator|->
name|sim_type
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scard_read_file
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|char
name|cmd
index|[
literal|5
index|]
init|=
block|{
name|SIM_CMD_READ_BIN
block|,
name|len
block|}
decl_stmt|;
name|size_t
name|blen
init|=
name|len
operator|+
literal|3
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|long
name|ret
decl_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_USIM
condition|)
name|cmd
index|[
literal|0
index|]
operator|=
name|USIM_CLA
expr_stmt|;
name|ret
operator|=
name|scard_transmit
argument_list|(
name|scard
argument_list|,
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|buf
argument_list|,
operator|&
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
if|if
condition|(
name|blen
operator|!=
name|len
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: file read returned unexpected "
literal|"length %d (expected %d)"
argument_list|,
name|blen
argument_list|,
name|len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|3
return|;
block|}
if|if
condition|(
name|buf
index|[
name|len
index|]
operator|!=
literal|0x90
operator|||
name|buf
index|[
name|len
operator|+
literal|1
index|]
operator|!=
literal|0x00
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: file read returned unexpected "
literal|"status %02x %02x (expected 90 00)"
argument_list|,
name|buf
index|[
name|len
index|]
argument_list|,
name|buf
index|[
name|len
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|4
return|;
block|}
name|memcpy
argument_list|(
name|data
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scard_verify_pin
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|)
block|{
name|long
name|ret
decl_stmt|;
name|unsigned
name|char
name|resp
index|[
literal|3
index|]
decl_stmt|;
name|char
name|cmd
index|[
literal|5
operator|+
literal|8
index|]
init|=
block|{
name|SIM_CMD_VERIFY_CHV1
block|}
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: verifying PIN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|==
name|NULL
operator|||
name|strlen
argument_list|(
name|pin
argument_list|)
operator|>
literal|8
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_USIM
condition|)
name|cmd
index|[
literal|0
index|]
operator|=
name|USIM_CLA
expr_stmt|;
name|memcpy
argument_list|(
name|cmd
operator|+
literal|5
argument_list|,
name|pin
argument_list|,
name|strlen
argument_list|(
name|pin
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|cmd
operator|+
literal|5
operator|+
name|strlen
argument_list|(
name|pin
argument_list|)
argument_list|,
literal|0xff
argument_list|,
literal|8
operator|-
name|strlen
argument_list|(
name|pin
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|scard_transmit
argument_list|(
name|scard
argument_list|,
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|resp
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|len
operator|!=
literal|2
operator|||
name|resp
index|[
literal|0
index|]
operator|!=
literal|0x90
operator|||
name|resp
index|[
literal|1
index|]
operator|!=
literal|0x00
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: PIN verification failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: PIN verified successfully"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|scard_get_imsi
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|char
modifier|*
name|imsi
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|size_t
name|blen
decl_stmt|,
name|imsilen
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|int
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: reading IMSI from (GSM) EF-IMSI"
argument_list|)
expr_stmt|;
name|blen
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|scard_select_file
argument_list|(
name|scard
argument_list|,
name|SCARD_FILE_GSM_EF_IMSI
argument_list|,
name|buf
argument_list|,
operator|&
name|blen
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|blen
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: too short (GSM) EF-IMSI "
literal|"header (len=%d)"
argument_list|,
name|blen
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
if|if
condition|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_GSM_SIM
condition|)
block|{
name|blen
operator|=
operator|(
name|buf
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
name|buf
index|[
literal|3
index|]
expr_stmt|;
block|}
else|else
block|{
name|int
name|file_size
decl_stmt|;
if|if
condition|(
name|scard_parse_fsp_templ
argument_list|(
name|buf
argument_list|,
name|blen
argument_list|,
name|NULL
argument_list|,
operator|&
name|file_size
argument_list|)
condition|)
return|return
operator|-
literal|3
return|;
name|blen
operator|=
name|file_size
expr_stmt|;
block|}
if|if
condition|(
name|blen
operator|<
literal|2
operator|||
name|blen
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: invalid IMSI file length=%d"
argument_list|,
name|blen
argument_list|)
expr_stmt|;
return|return
operator|-
literal|3
return|;
block|}
name|imsilen
operator|=
operator|(
name|blen
operator|-
literal|2
operator|)
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: IMSI file length=%d imsilen=%d"
argument_list|,
name|blen
argument_list|,
name|imsilen
argument_list|)
expr_stmt|;
if|if
condition|(
name|blen
operator|<
literal|2
operator|||
name|imsilen
operator|>
operator|*
name|len
condition|)
block|{
operator|*
name|len
operator|=
name|imsilen
expr_stmt|;
return|return
operator|-
literal|4
return|;
block|}
if|if
condition|(
name|scard_read_file
argument_list|(
name|scard
argument_list|,
name|buf
argument_list|,
name|blen
argument_list|)
condition|)
return|return
operator|-
literal|5
return|;
name|pos
operator|=
name|imsi
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|'0'
operator|+
operator|(
name|buf
index|[
literal|1
index|]
operator|>>
literal|4
operator|&
literal|0x0f
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|blen
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|char
name|digit
decl_stmt|;
name|digit
operator|=
name|buf
index|[
name|i
index|]
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|digit
operator|<
literal|10
condition|)
operator|*
name|pos
operator|++
operator|=
literal|'0'
operator|+
name|digit
expr_stmt|;
else|else
name|imsilen
operator|--
expr_stmt|;
name|digit
operator|=
name|buf
index|[
name|i
index|]
operator|>>
literal|4
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|digit
operator|<
literal|10
condition|)
operator|*
name|pos
operator|++
operator|=
literal|'0'
operator|+
name|digit
expr_stmt|;
else|else
name|imsilen
operator|--
expr_stmt|;
block|}
operator|*
name|len
operator|=
name|imsilen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|scard_gsm_auth
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|unsigned
name|char
modifier|*
name|rand
parameter_list|,
name|unsigned
name|char
modifier|*
name|sres
parameter_list|,
name|unsigned
name|char
modifier|*
name|kc
parameter_list|)
block|{
name|unsigned
name|char
name|cmd
index|[
literal|5
operator|+
literal|1
operator|+
literal|16
index|]
init|=
block|{
name|SIM_CMD_RUN_GSM_ALG
block|}
decl_stmt|;
name|int
name|cmdlen
decl_stmt|;
name|unsigned
name|char
name|get_resp
index|[
literal|5
index|]
init|=
block|{
name|SIM_CMD_GET_RESPONSE
block|}
decl_stmt|;
name|unsigned
name|char
name|resp
index|[
literal|3
index|]
decl_stmt|,
name|buf
index|[
literal|12
operator|+
literal|3
operator|+
literal|2
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|long
name|ret
decl_stmt|;
if|if
condition|(
name|scard
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: GSM auth - RAND"
argument_list|,
name|rand
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_GSM_SIM
condition|)
block|{
name|cmdlen
operator|=
literal|5
operator|+
literal|16
expr_stmt|;
name|memcpy
argument_list|(
name|cmd
operator|+
literal|5
argument_list|,
name|rand
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cmdlen
operator|=
literal|5
operator|+
literal|1
operator|+
literal|16
expr_stmt|;
name|cmd
index|[
literal|0
index|]
operator|=
name|USIM_CLA
expr_stmt|;
name|cmd
index|[
literal|3
index|]
operator|=
literal|0x80
expr_stmt|;
name|cmd
index|[
literal|4
index|]
operator|=
literal|17
expr_stmt|;
name|cmd
index|[
literal|5
index|]
operator|=
literal|16
expr_stmt|;
name|memcpy
argument_list|(
name|cmd
operator|+
literal|6
argument_list|,
name|rand
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|scard_transmit
argument_list|(
name|scard
argument_list|,
name|cmd
argument_list|,
name|cmdlen
argument_list|,
name|resp
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
operator|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_GSM_SIM
operator|&&
operator|(
name|len
operator|!=
literal|2
operator|||
name|resp
index|[
literal|0
index|]
operator|!=
literal|0x9f
operator|||
name|resp
index|[
literal|1
index|]
operator|!=
literal|0x0c
operator|)
operator|)
operator|||
operator|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_USIM
operator|&&
operator|(
name|len
operator|!=
literal|2
operator|||
name|resp
index|[
literal|0
index|]
operator|!=
literal|0x61
operator|||
name|resp
index|[
literal|1
index|]
operator|!=
literal|0x0e
operator|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: unexpected response for GSM "
literal|"auth request (len=%d resp=%02x %02x)"
argument_list|,
name|len
argument_list|,
name|resp
index|[
literal|0
index|]
argument_list|,
name|resp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|3
return|;
block|}
name|get_resp
index|[
literal|4
index|]
operator|=
name|resp
index|[
literal|1
index|]
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|ret
operator|=
name|scard_transmit
argument_list|(
name|scard
argument_list|,
name|get_resp
argument_list|,
sizeof|sizeof
argument_list|(
name|get_resp
argument_list|)
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
return|return
operator|-
literal|4
return|;
if|if
condition|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_GSM_SIM
condition|)
block|{
if|if
condition|(
name|len
operator|!=
literal|4
operator|+
literal|8
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: unexpected data "
literal|"length for GSM auth (len=%d, expected 14)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|5
return|;
block|}
name|memcpy
argument_list|(
name|sres
argument_list|,
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|kc
argument_list|,
name|buf
operator|+
literal|4
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|len
operator|!=
literal|1
operator|+
literal|4
operator|+
literal|1
operator|+
literal|8
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: unexpected data "
literal|"length for USIM auth (len=%d, "
literal|"expected 16)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|5
return|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|4
operator|||
name|buf
index|[
literal|5
index|]
operator|!=
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: unexpected SREC/Kc "
literal|"length (%d %d, expected 4 8)"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|sres
argument_list|,
name|buf
operator|+
literal|1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|kc
argument_list|,
name|buf
operator|+
literal|6
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: GSM auth - SRES"
argument_list|,
name|sres
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: GSM auth - Kc"
argument_list|,
name|kc
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|scard_umts_auth
parameter_list|(
name|struct
name|scard_data
modifier|*
name|scard
parameter_list|,
name|unsigned
name|char
modifier|*
name|rand
parameter_list|,
name|unsigned
name|char
modifier|*
name|autn
parameter_list|,
name|unsigned
name|char
modifier|*
name|res
parameter_list|,
name|size_t
modifier|*
name|res_len
parameter_list|,
name|unsigned
name|char
modifier|*
name|ik
parameter_list|,
name|unsigned
name|char
modifier|*
name|ck
parameter_list|,
name|unsigned
name|char
modifier|*
name|auts
parameter_list|)
block|{
name|unsigned
name|char
name|cmd
index|[
literal|5
operator|+
literal|1
operator|+
name|AKA_RAND_LEN
operator|+
literal|1
operator|+
name|AKA_AUTN_LEN
index|]
init|=
block|{
name|USIM_CMD_RUN_UMTS_ALG
block|}
decl_stmt|;
name|int
name|cmdlen
decl_stmt|;
name|unsigned
name|char
name|get_resp
index|[
literal|5
index|]
init|=
block|{
name|USIM_CMD_GET_RESPONSE
block|}
decl_stmt|;
name|unsigned
name|char
name|resp
index|[
literal|3
index|]
decl_stmt|,
name|buf
index|[
literal|64
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|long
name|ret
decl_stmt|;
if|if
condition|(
name|scard
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|scard
operator|->
name|sim_type
operator|==
name|SCARD_GSM_SIM
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"SCARD: Non-USIM card - cannot do UMTS "
literal|"auth"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: UMTS auth - RAND"
argument_list|,
name|rand
argument_list|,
name|AKA_RAND_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: UMTS auth - AUTN"
argument_list|,
name|autn
argument_list|,
name|AKA_AUTN_LEN
argument_list|)
expr_stmt|;
name|cmdlen
operator|=
literal|5
operator|+
literal|1
operator|+
name|AKA_RAND_LEN
operator|+
literal|1
operator|+
name|AKA_AUTN_LEN
expr_stmt|;
name|cmd
index|[
literal|5
index|]
operator|=
name|AKA_RAND_LEN
expr_stmt|;
name|memcpy
argument_list|(
name|cmd
operator|+
literal|6
argument_list|,
name|rand
argument_list|,
name|AKA_RAND_LEN
argument_list|)
expr_stmt|;
name|cmd
index|[
literal|6
operator|+
name|AKA_RAND_LEN
index|]
operator|=
name|AKA_AUTN_LEN
expr_stmt|;
name|memcpy
argument_list|(
name|cmd
operator|+
literal|6
operator|+
name|AKA_RAND_LEN
operator|+
literal|1
argument_list|,
name|autn
argument_list|,
name|AKA_AUTN_LEN
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|scard_transmit
argument_list|(
name|scard
argument_list|,
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|resp
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|len
operator|>=
literal|0
operator|&&
name|len
operator|<=
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: UMTS alg response"
argument_list|,
name|resp
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|2
operator|&&
name|resp
index|[
literal|0
index|]
operator|==
literal|0x98
operator|&&
name|resp
index|[
literal|1
index|]
operator|==
literal|0x62
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: UMTS auth failed - "
literal|"MAC != XMAC"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|len
operator|!=
literal|2
operator|||
name|resp
index|[
literal|0
index|]
operator|!=
literal|0x61
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SCARD: unexpected response for UMTS "
literal|"auth request (len=%d resp=%02x %02x)"
argument_list|,
name|len
argument_list|,
name|resp
index|[
literal|0
index|]
argument_list|,
name|resp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|get_resp
index|[
literal|4
index|]
operator|=
name|resp
index|[
literal|1
index|]
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|ret
operator|=
name|scard_transmit
argument_list|(
name|scard
argument_list|,
name|get_resp
argument_list|,
sizeof|sizeof
argument_list|(
name|get_resp
argument_list|)
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SCARD_S_SUCCESS
operator|||
name|len
operator|<
literal|0
operator|||
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: UMTS get response result"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>=
literal|2
operator|+
name|AKA_AUTS_LEN
operator|&&
name|buf
index|[
literal|0
index|]
operator|==
literal|0xdc
operator|&&
name|buf
index|[
literal|1
index|]
operator|==
name|AKA_AUTS_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: UMTS Synchronization-Failure"
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|auts
argument_list|,
name|buf
operator|+
literal|2
argument_list|,
name|AKA_AUTS_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: AUTS"
argument_list|,
name|auts
argument_list|,
name|AKA_AUTS_LEN
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
elseif|else
if|if
condition|(
name|len
operator|>=
literal|6
operator|+
name|IK_LEN
operator|+
name|CK_LEN
operator|&&
name|buf
index|[
literal|0
index|]
operator|==
literal|0xdb
condition|)
block|{
name|pos
operator|=
name|buf
operator|+
literal|1
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|len
expr_stmt|;
comment|/* RES */
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|>
name|RES_MAX_LEN
operator|||
name|pos
operator|+
name|pos
index|[
literal|0
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Invalid RES"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|res_len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|memcpy
argument_list|(
name|res
argument_list|,
name|pos
argument_list|,
operator|*
name|res_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
operator|*
name|res_len
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: RES"
argument_list|,
name|res
argument_list|,
operator|*
name|res_len
argument_list|)
expr_stmt|;
comment|/* CK */
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|!=
name|CK_LEN
operator|||
name|pos
operator|+
name|CK_LEN
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Invalid CK"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|memcpy
argument_list|(
name|ck
argument_list|,
name|pos
argument_list|,
name|CK_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|CK_LEN
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: CK"
argument_list|,
name|ck
argument_list|,
name|CK_LEN
argument_list|)
expr_stmt|;
comment|/* IK */
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|!=
name|IK_LEN
operator|||
name|pos
operator|+
name|IK_LEN
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Invalid IK"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|memcpy
argument_list|(
name|ik
argument_list|,
name|pos
argument_list|,
name|IK_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|IK_LEN
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: IK"
argument_list|,
name|ik
argument_list|,
name|IK_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: Unrecognized response"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

end_unit


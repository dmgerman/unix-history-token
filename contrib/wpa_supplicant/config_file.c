begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / Configuration backend: text file  * Copyright (c) 2003-2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * This file implements a configuration backend for text files. All the  * configuration information is stored in a text file that uses a format  * described in the sample configuration file, wpa_supplicant.conf.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"base64.h"
end_include

begin_function
specifier|static
name|char
modifier|*
name|wpa_config_get_line
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|int
name|size
parameter_list|,
name|FILE
modifier|*
name|stream
parameter_list|,
name|int
modifier|*
name|line
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|sstart
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|s
argument_list|,
name|size
argument_list|,
name|stream
argument_list|)
condition|)
block|{
operator|(
operator|*
name|line
operator|)
operator|++
expr_stmt|;
name|s
index|[
name|size
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|s
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
operator|||
operator|*
name|pos
operator|==
literal|'\t'
operator|||
operator|*
name|pos
operator|==
literal|'\r'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'#'
operator|||
operator|*
name|pos
operator|==
literal|'\n'
operator|||
operator|*
name|pos
operator|==
literal|'\0'
operator|||
operator|*
name|pos
operator|==
literal|'\r'
condition|)
continue|continue;
comment|/* Remove # comments unless they are within a double quoted 		 * string. Remove trailing white space. */
name|sstart
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|'"'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sstart
condition|)
name|sstart
operator|=
name|strrchr
argument_list|(
name|sstart
operator|+
literal|1
argument_list|,
literal|'"'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sstart
condition|)
name|sstart
operator|=
name|pos
expr_stmt|;
name|end
operator|=
name|strchr
argument_list|(
name|sstart
argument_list|,
literal|'#'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|--
operator|=
literal|'\0'
expr_stmt|;
else|else
name|end
operator|=
name|pos
operator|+
name|strlen
argument_list|(
name|pos
argument_list|)
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|end
operator|>
name|pos
operator|&&
operator|(
operator|*
name|end
operator|==
literal|'\n'
operator|||
operator|*
name|end
operator|==
literal|' '
operator|||
operator|*
name|end
operator|==
literal|'\t'
operator|||
operator|*
name|end
operator|==
literal|'\r'
operator|)
condition|)
block|{
operator|*
name|end
operator|--
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
continue|continue;
return|return
name|pos
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|wpa_config_read_network
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|int
modifier|*
name|line
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|,
name|end
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Line: %d - start of a new network block"
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|ssid
operator|=
operator|(
expr|struct
name|wpa_ssid
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|ssid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ssid
argument_list|)
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|pos
operator|=
name|wpa_config_get_line
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|,
name|line
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"}"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|end
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: Invalid SSID line "
literal|"'%s'."
argument_list|,
operator|*
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
operator|*
name|pos2
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|pos2
operator|==
literal|'"'
condition|)
block|{
if|if
condition|(
name|strchr
argument_list|(
name|pos2
operator|+
literal|1
argument_list|,
literal|'"'
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: invalid "
literal|"quotation '%s'."
argument_list|,
operator|*
name|line
argument_list|,
name|pos2
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
name|pos
argument_list|,
name|pos2
argument_list|,
operator|*
name|line
argument_list|)
operator|<
literal|0
condition|)
name|errors
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: network block was not "
literal|"terminated properly."
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: both PSK and "
literal|"passphrase configured."
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
name|wpa_config_update_psk
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
operator|)
operator|&&
operator|!
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: WPA-PSK accepted for key "
literal|"management, but no PSK configured."
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ssid
operator|->
name|group_cipher
operator|&
name|WPA_CIPHER_CCMP
operator|)
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
operator|)
condition|)
block|{
comment|/* Group cipher cannot be stronger than the pairwise cipher. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Line %d: removed CCMP from group cipher"
literal|" list since it was not allowed for pairwise "
literal|"cipher"
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|group_cipher
operator|&=
operator|~
name|WPA_CIPHER_CCMP
expr_stmt|;
block|}
if|if
condition|(
name|errors
condition|)
block|{
name|free
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ssid
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_config_blob
modifier|*
name|wpa_config_read_blob
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|int
modifier|*
name|line
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|unsigned
name|char
modifier|*
name|encoded
init|=
name|NULL
decl_stmt|,
modifier|*
name|nencoded
decl_stmt|;
name|int
name|end
init|=
literal|0
decl_stmt|;
name|size_t
name|encoded_len
init|=
literal|0
decl_stmt|,
name|len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Line: %d - start of a new named blob '%s'"
argument_list|,
operator|*
name|line
argument_list|,
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|pos
operator|=
name|wpa_config_get_line
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|,
name|line
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"}"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|end
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|nencoded
operator|=
name|realloc
argument_list|(
name|encoded
argument_list|,
name|encoded_len
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nencoded
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: not enough memory for "
literal|"blob"
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|encoded
operator|=
name|nencoded
expr_stmt|;
name|memcpy
argument_list|(
name|encoded
operator|+
name|encoded_len
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|encoded_len
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: blob was not terminated "
literal|"properly"
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|blob
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|blob
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|blob
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blob
argument_list|)
argument_list|)
expr_stmt|;
name|blob
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|blob
operator|->
name|data
operator|=
name|base64_decode
argument_list|(
name|encoded
argument_list|,
name|encoded_len
argument_list|,
operator|&
name|blob
operator|->
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|->
name|name
operator|==
name|NULL
operator|||
name|blob
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_config_free_blob
argument_list|(
name|blob
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|blob
return|;
block|}
end_function

begin_function
name|struct
name|wpa_config
modifier|*
name|wpa_config_read
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|,
name|line
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|tail
init|=
name|NULL
decl_stmt|,
modifier|*
name|head
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_config
modifier|*
name|config
decl_stmt|;
name|int
name|id
init|=
literal|0
decl_stmt|,
name|prio
decl_stmt|;
name|config
operator|=
name|wpa_config_alloc_empty
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Reading configuration file '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|name
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|config
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
while|while
condition|(
operator|(
name|pos
operator|=
name|wpa_config_get_line
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|,
operator|&
name|line
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"network={"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ssid
operator|=
name|wpa_config_read_network
argument_list|(
name|f
argument_list|,
operator|&
name|line
argument_list|,
name|id
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: failed to "
literal|"parse network block."
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|head
operator|==
name|NULL
condition|)
block|{
name|head
operator|=
name|tail
operator|=
name|ssid
expr_stmt|;
block|}
else|else
block|{
name|tail
operator|->
name|next
operator|=
name|ssid
expr_stmt|;
name|tail
operator|=
name|ssid
expr_stmt|;
block|}
if|if
condition|(
name|wpa_config_add_prio_network
argument_list|(
name|config
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: failed to add "
literal|"network block to priority list."
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"blob-base64-"
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|name
init|=
name|pos
operator|+
literal|12
decl_stmt|,
modifier|*
name|name_end
decl_stmt|;
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|name_end
operator|=
name|strchr
argument_list|(
name|name
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|name_end
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: no blob name "
literal|"terminator"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
operator|*
name|name_end
operator|=
literal|'\0'
expr_stmt|;
name|blob
operator|=
name|wpa_config_read_blob
argument_list|(
name|f
argument_list|,
operator|&
name|line
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: failed to read"
literal|" blob %s"
argument_list|,
name|line
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
name|wpa_config_set_blob
argument_list|(
name|config
argument_list|,
name|blob
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_CTRL_IFACE
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"ctrl_interface="
argument_list|,
literal|15
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|config
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
name|config
operator|->
name|ctrl_interface
operator|=
name|strdup
argument_list|(
name|pos
operator|+
literal|15
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_interface='%s'"
argument_list|,
name|config
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_CTRL_IFACE_UDP
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"ctrl_interface_group="
argument_list|,
literal|21
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|group
modifier|*
name|grp
decl_stmt|;
name|char
modifier|*
name|endp
decl_stmt|;
specifier|const
name|char
modifier|*
name|group
init|=
name|pos
operator|+
literal|21
decl_stmt|;
name|grp
operator|=
name|getgrnam
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
condition|)
block|{
name|config
operator|->
name|ctrl_interface_gid
operator|=
name|grp
operator|->
name|gr_gid
expr_stmt|;
name|config
operator|->
name|ctrl_interface_gid_set
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_interface_group=%d"
literal|" (from group name '%s')"
argument_list|,
operator|(
name|int
operator|)
name|config
operator|->
name|ctrl_interface_gid
argument_list|,
name|group
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Group name not found - try to parse this as gid */
name|config
operator|->
name|ctrl_interface_gid
operator|=
name|strtol
argument_list|(
name|group
argument_list|,
operator|&
name|endp
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|group
operator|==
literal|'\0'
operator|||
operator|*
name|endp
operator|!=
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Line %d: Invalid group "
literal|"'%s'"
argument_list|,
name|line
argument_list|,
name|group
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
name|config
operator|->
name|ctrl_interface_gid_set
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_interface_group=%d"
argument_list|,
operator|(
name|int
operator|)
name|config
operator|->
name|ctrl_interface_gid
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_CTRL_IFACE_UDP */
endif|#
directive|endif
comment|/* CONFIG_CTRL_IFACE */
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"eapol_version="
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
condition|)
block|{
name|config
operator|->
name|eapol_version
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|14
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|eapol_version
operator|<
literal|1
operator|||
name|config
operator|->
name|eapol_version
operator|>
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: Invalid EAPOL "
literal|"version (%d): '%s'."
argument_list|,
name|line
argument_list|,
name|config
operator|->
name|eapol_version
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"eapol_version=%d"
argument_list|,
name|config
operator|->
name|eapol_version
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"ap_scan="
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|config
operator|->
name|ap_scan
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|8
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ap_scan=%d"
argument_list|,
name|config
operator|->
name|ap_scan
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"fast_reauth="
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
name|config
operator|->
name|fast_reauth
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|12
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"fast_reauth=%d"
argument_list|,
name|config
operator|->
name|fast_reauth
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"opensc_engine_path="
argument_list|,
literal|19
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|config
operator|->
name|opensc_engine_path
argument_list|)
expr_stmt|;
name|config
operator|->
name|opensc_engine_path
operator|=
name|strdup
argument_list|(
name|pos
operator|+
literal|19
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"opensc_engine_path='%s'"
argument_list|,
name|config
operator|->
name|opensc_engine_path
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"pkcs11_engine_path="
argument_list|,
literal|19
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|config
operator|->
name|pkcs11_engine_path
argument_list|)
expr_stmt|;
name|config
operator|->
name|pkcs11_engine_path
operator|=
name|strdup
argument_list|(
name|pos
operator|+
literal|19
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"pkcs11_engine_path='%s'"
argument_list|,
name|config
operator|->
name|pkcs11_engine_path
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"pkcs11_module_path="
argument_list|,
literal|19
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|config
operator|->
name|pkcs11_module_path
argument_list|)
expr_stmt|;
name|config
operator|->
name|pkcs11_module_path
operator|=
name|strdup
argument_list|(
name|pos
operator|+
literal|19
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"pkcs11_module_path='%s'"
argument_list|,
name|config
operator|->
name|pkcs11_module_path
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"driver_param="
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|config
operator|->
name|driver_param
argument_list|)
expr_stmt|;
name|config
operator|->
name|driver_param
operator|=
name|strdup
argument_list|(
name|pos
operator|+
literal|13
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"driver_param='%s'"
argument_list|,
name|config
operator|->
name|driver_param
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"dot11RSNAConfigPMKLifetime="
argument_list|,
literal|27
argument_list|)
operator|==
literal|0
condition|)
block|{
name|config
operator|->
name|dot11RSNAConfigPMKLifetime
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|27
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dot11RSNAConfigPMKLifetime=%d"
argument_list|,
name|config
operator|->
name|dot11RSNAConfigPMKLifetime
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"dot11RSNAConfigPMKReauthThreshold="
argument_list|,
literal|34
argument_list|)
operator|==
literal|0
condition|)
block|{
name|config
operator|->
name|dot11RSNAConfigPMKReauthThreshold
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|34
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dot11RSNAConfigPMKReauthThreshold=%d"
argument_list|,
name|config
operator|->
name|dot11RSNAConfigPMKReauthThreshold
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"dot11RSNAConfigSATimeout="
argument_list|,
literal|25
argument_list|)
operator|==
literal|0
condition|)
block|{
name|config
operator|->
name|dot11RSNAConfigSATimeout
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|25
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dot11RSNAConfigSATimeout=%d"
argument_list|,
name|config
operator|->
name|dot11RSNAConfigSATimeout
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
literal|"update_config="
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
condition|)
block|{
name|config
operator|->
name|update_config
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|14
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"update_config=%d"
argument_list|,
name|config
operator|->
name|update_config
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: Invalid configuration "
literal|"line '%s'."
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|config
operator|->
name|ssid
operator|=
name|head
expr_stmt|;
for|for
control|(
name|prio
operator|=
literal|0
init|;
name|prio
operator|<
name|config
operator|->
name|num_prio
condition|;
name|prio
operator|++
control|)
block|{
name|ssid
operator|=
name|config
operator|->
name|pssid
index|[
name|prio
index|]
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Priority group %d"
argument_list|,
name|ssid
operator|->
name|priority
argument_list|)
expr_stmt|;
while|while
condition|(
name|ssid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   id=%d ssid='%s'"
argument_list|,
name|ssid
operator|->
name|id
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|ssid
operator|->
name|pnext
expr_stmt|;
block|}
block|}
if|if
condition|(
name|errors
condition|)
block|{
name|wpa_config_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|config
operator|=
name|NULL
expr_stmt|;
name|head
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|config
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_str
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
name|field
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t%s=%s\n"
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_int
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
name|int
name|value
parameter_list|,
name|int
name|def
parameter_list|)
block|{
if|if
condition|(
name|value
operator|==
name|def
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t%s=%d\n"
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_bssid
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"bssid"
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tbssid=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_psk
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"psk"
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tpsk=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_proto
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|proto
operator|==
name|DEFAULT_PROTO
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"proto"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tproto=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_key_mgmt
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|==
name|DEFAULT_KEY_MGMT
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"key_mgmt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tkey_mgmt=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_pairwise
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|pairwise_cipher
operator|==
name|DEFAULT_PAIRWISE
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"pairwise"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tpairwise=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_group
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|group_cipher
operator|==
name|DEFAULT_GROUP
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"group"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tgroup=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_auth_alg
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|==
literal|0
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"auth_alg"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tauth_alg=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_eap
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"eap"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\teap=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_wep_key
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|int
name|idx
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
name|field
index|[
literal|20
index|]
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|snprintf
argument_list|(
name|field
argument_list|,
sizeof|sizeof
argument_list|(
name|field
argument_list|)
argument_list|,
literal|"wep_key%d"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
name|field
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t%s=%s\n"
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_config_write_network
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
define|#
directive|define
name|STR
parameter_list|(
name|t
parameter_list|)
value|write_str(f, #t, ssid)
define|#
directive|define
name|INT
parameter_list|(
name|t
parameter_list|)
value|write_int(f, #t, ssid->t, 0)
define|#
directive|define
name|INT_DEF
parameter_list|(
name|t
parameter_list|,
name|def
parameter_list|)
value|write_int(f, #t, ssid->t, def)
name|STR
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|scan_ssid
argument_list|)
expr_stmt|;
name|write_bssid
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_psk
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_proto
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_key_mgmt
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_pairwise
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_group
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_auth_alg
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_eap
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|identity
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|anonymous_identity
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|eappsk
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|nai
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_cert
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|client_cert
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key_passwd
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|dh_file
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|subject_match
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|altsubject_match
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_cert2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|client_cert2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key2_passwd
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|dh_file2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|subject_match2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|altsubject_match2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|phase1
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|phase2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pcsc
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pin
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|engine_id
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|key_id
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|INT_DEF
argument_list|(
name|eapol_flags
argument_list|,
name|DEFAULT_EAPOL_FLAGS
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|write_wep_key
argument_list|(
name|f
argument_list|,
name|i
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|wep_tx_keyidx
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|priority
argument_list|)
expr_stmt|;
name|INT_DEF
argument_list|(
name|eap_workaround
argument_list|,
name|DEFAULT_EAP_WORKAROUND
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pac_file
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|mode
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|proactive_key_caching
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|disabled
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|STR
undef|#
directive|undef
name|INT
undef|#
directive|undef
name|INT_DEF
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_write_blob
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_config_blob
modifier|*
name|blob
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|encoded
decl_stmt|;
name|encoded
operator|=
name|base64_encode
argument_list|(
name|blob
operator|->
name|data
argument_list|,
name|blob
operator|->
name|len
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|encoded
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\nblob-base64-%s={\n%s}\n"
argument_list|,
name|blob
operator|->
name|name
argument_list|,
name|encoded
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_config_write
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|wpa_config
modifier|*
name|config
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Writing configuration file '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|name
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to open '%s' for writing"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_CTRL_IFACE
if|if
condition|(
name|config
operator|->
name|ctrl_interface
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"ctrl_interface=%s\n"
argument_list|,
name|config
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_CTRL_IFACE_UDP
if|if
condition|(
name|config
operator|->
name|ctrl_interface_gid_set
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"ctrl_interface_group=%d\n"
argument_list|,
operator|(
name|int
operator|)
name|config
operator|->
name|ctrl_interface_gid
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_CTRL_IFACE_UDP */
endif|#
directive|endif
comment|/* CONFIG_CTRL_IFACE */
if|if
condition|(
name|config
operator|->
name|eapol_version
operator|!=
name|DEFAULT_EAPOL_VERSION
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"eapol_version=%d\n"
argument_list|,
name|config
operator|->
name|eapol_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|ap_scan
operator|!=
name|DEFAULT_AP_SCAN
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"ap_scan=%d\n"
argument_list|,
name|config
operator|->
name|ap_scan
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|fast_reauth
operator|!=
name|DEFAULT_FAST_REAUTH
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"fast_reauth=%d\n"
argument_list|,
name|config
operator|->
name|fast_reauth
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|opensc_engine_path
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"opensc_engine_path=%s\n"
argument_list|,
name|config
operator|->
name|opensc_engine_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|pkcs11_engine_path
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"pkcs11_engine_path=%s\n"
argument_list|,
name|config
operator|->
name|pkcs11_engine_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|pkcs11_module_path
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"pkcs11_module_path=%s\n"
argument_list|,
name|config
operator|->
name|pkcs11_module_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|driver_param
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"driver_param=%s\n"
argument_list|,
name|config
operator|->
name|driver_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|dot11RSNAConfigPMKLifetime
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"dot11RSNAConfigPMKLifetime=%d\n"
argument_list|,
name|config
operator|->
name|dot11RSNAConfigPMKLifetime
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|dot11RSNAConfigPMKReauthThreshold
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"dot11RSNAConfigPMKReauthThreshold=%d\n"
argument_list|,
name|config
operator|->
name|dot11RSNAConfigPMKReauthThreshold
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|dot11RSNAConfigSATimeout
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"dot11RSNAConfigSATimeout=%d\n"
argument_list|,
name|config
operator|->
name|dot11RSNAConfigSATimeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|update_config
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"update_config=%d\n"
argument_list|,
name|config
operator|->
name|update_config
argument_list|)
expr_stmt|;
for|for
control|(
name|ssid
operator|=
name|config
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\nnetwork={\n"
argument_list|)
expr_stmt|;
name|wpa_config_write_network
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|blob
operator|=
name|config
operator|->
name|blobs
init|;
name|blob
condition|;
name|blob
operator|=
name|blob
operator|->
name|next
control|)
block|{
name|ret
operator|=
name|wpa_config_write_blob
argument_list|(
name|f
argument_list|,
name|blob
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configuration file '%s' written %ssuccessfully"
argument_list|,
name|name
argument_list|,
name|ret
condition|?
literal|"un"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - test code for pre-authentication  * Copyright (c) 2003-2006, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * IEEE 802.1X Supplicant test code (to be used in place of wpa_supplicant.c.  * Not used in production version.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"eapol_sm.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"eap.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"preauth.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_show_keys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|wpa_driver_ops
modifier|*
name|wpa_supplicant_drivers
index|[]
init|=
block|{ }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|preauth_test_data
block|{
name|int
name|auth_timed_out
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|_wpa_supplicant_req_scan
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|int
name|sec
parameter_list|,
name|int
name|usec
parameter_list|)
block|{
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|sec
argument_list|,
name|usec
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|_wpa_supplicant_disassociate
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|wpa_supplicant_disassociate
argument_list|(
name|wpa_s
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|_wpa_supplicant_deauthenticate
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|wpa_alloc_eapol
parameter_list|(
specifier|const
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|u16
name|data_len
parameter_list|,
name|size_t
modifier|*
name|msg_len
parameter_list|,
name|void
modifier|*
modifier|*
name|data_pos
parameter_list|)
block|{
name|struct
name|ieee802_1x_hdr
modifier|*
name|hdr
decl_stmt|;
operator|*
name|msg_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|data_len
expr_stmt|;
name|hdr
operator|=
name|malloc
argument_list|(
operator|*
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|hdr
operator|->
name|version
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|eapol_version
expr_stmt|;
name|hdr
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
name|memcpy
argument_list|(
name|hdr
operator|+
literal|1
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|hdr
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_pos
condition|)
operator|*
name|data_pos
operator|=
name|hdr
operator|+
literal|1
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|hdr
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|_wpa_alloc_eapol
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|u16
name|data_len
parameter_list|,
name|size_t
modifier|*
name|msg_len
parameter_list|,
name|void
modifier|*
modifier|*
name|data_pos
parameter_list|)
block|{
return|return
name|wpa_alloc_eapol
argument_list|(
name|wpa_s
argument_list|,
name|type
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|msg_len
argument_list|,
name|data_pos
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|_wpa_supplicant_set_state
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|wpa_states
name|state
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_s
operator|->
name|wpa_state
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|wpa_states
name|_wpa_supplicant_get_state
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
return|return
name|wpa_s
operator|->
name|wpa_state
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ether_send
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dest
parameter_list|,
name|u16
name|proto
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s - not implemented\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|_wpa_supplicant_get_ssid
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|)
block|{
return|return
name|wpa_supplicant_get_ssid
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|_wpa_supplicant_cancel_auth_timeout
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_get_beacon_ie
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s - not implemented\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_scan
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s - not implemented\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_get_bssid
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s - not implemented\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_set_key
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s - not implemented\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_add_pmkid
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s - not implemented\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_remove_pmkid
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s - not implemented\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_set_config_blob
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|wpa_config_blob
modifier|*
name|blob
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_config_set_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|blob
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|wpa_config_blob
modifier|*
name|wpa_supplicant_get_config_blob
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
return|return
name|wpa_config_get_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_eapol_clean
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|rsn_preauth_deinit
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|pmksa_candidate_free
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|pmksa_cache_free
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|wpa_sm_deinit
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|scard_deinit
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|wpa_supplicant_ctrl_iface_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_config_free
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eapol_test_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|preauth_test_data
modifier|*
name|p
init|=
name|eloop_ctx
decl_stmt|;
name|printf
argument_list|(
literal|"EAPOL test timed out\n"
argument_list|)
expr_stmt|;
name|p
operator|->
name|auth_timed_out
operator|=
literal|1
expr_stmt|;
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eapol_test_poll
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
operator|!
name|rsn_preauth_in_progress
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
condition|)
name|eloop_terminate
argument_list|()
expr_stmt|;
else|else
block|{
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|100000
argument_list|,
name|eapol_test_poll
argument_list|,
name|eloop_ctx
argument_list|,
name|timeout_ctx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|wpa_driver_ops
name|dummy_driver
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|wpa_init_conf
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|l2_packet_data
modifier|*
name|l2
decl_stmt|;
name|struct
name|wpa_sm_ctx
modifier|*
name|ctx
decl_stmt|;
name|memset
argument_list|(
operator|&
name|dummy_driver
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dummy_driver
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|driver
operator|=
operator|&
name|dummy_driver
expr_stmt|;
name|ctx
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ctx
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ctx
operator|=
name|wpa_s
expr_stmt|;
name|ctx
operator|->
name|set_state
operator|=
name|_wpa_supplicant_set_state
expr_stmt|;
name|ctx
operator|->
name|get_state
operator|=
name|_wpa_supplicant_get_state
expr_stmt|;
name|ctx
operator|->
name|req_scan
operator|=
name|_wpa_supplicant_req_scan
expr_stmt|;
name|ctx
operator|->
name|deauthenticate
operator|=
name|_wpa_supplicant_deauthenticate
expr_stmt|;
name|ctx
operator|->
name|disassociate
operator|=
name|_wpa_supplicant_disassociate
expr_stmt|;
name|ctx
operator|->
name|set_key
operator|=
name|wpa_supplicant_set_key
expr_stmt|;
name|ctx
operator|->
name|scan
operator|=
name|wpa_supplicant_scan
expr_stmt|;
name|ctx
operator|->
name|get_ssid
operator|=
name|_wpa_supplicant_get_ssid
expr_stmt|;
name|ctx
operator|->
name|get_bssid
operator|=
name|wpa_supplicant_get_bssid
expr_stmt|;
name|ctx
operator|->
name|ether_send
operator|=
name|wpa_ether_send
expr_stmt|;
name|ctx
operator|->
name|get_beacon_ie
operator|=
name|wpa_supplicant_get_beacon_ie
expr_stmt|;
name|ctx
operator|->
name|alloc_eapol
operator|=
name|_wpa_alloc_eapol
expr_stmt|;
name|ctx
operator|->
name|cancel_auth_timeout
operator|=
name|_wpa_supplicant_cancel_auth_timeout
expr_stmt|;
name|ctx
operator|->
name|add_pmkid
operator|=
name|wpa_supplicant_add_pmkid
expr_stmt|;
name|ctx
operator|->
name|remove_pmkid
operator|=
name|wpa_supplicant_remove_pmkid
expr_stmt|;
name|ctx
operator|->
name|set_config_blob
operator|=
name|wpa_supplicant_set_config_blob
expr_stmt|;
name|ctx
operator|->
name|get_config_blob
operator|=
name|wpa_supplicant_get_config_blob
expr_stmt|;
name|wpa_s
operator|->
name|wpa
operator|=
name|wpa_sm_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|wpa_s
operator|->
name|wpa
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_PROTO
argument_list|,
name|WPA_PROTO_RSN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_sm_set_ifname
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|l2
operator|=
name|l2_packet_init
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|NULL
argument_list|,
name|ETH_P_RSN_PREAUTH
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|l2
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|l2_packet_get_own_addr
argument_list|(
name|l2
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to get own L2 address\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|l2_packet_deinit
argument_list|(
name|l2
argument_list|)
expr_stmt|;
name|wpa_sm_set_own_addr
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eapol_test_terminate
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Signal %d received - terminating"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|wpa_supplicant
name|wpa_s
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|preauth_test_data
name|preauth_test
decl_stmt|;
name|memset
argument_list|(
operator|&
name|preauth_test
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|preauth_test
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_debug_level
operator|=
literal|0
expr_stmt|;
name|wpa_debug_show_keys
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"usage: preauth_test<conf><target MAC address> "
literal|"<ifname>\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
name|bssid
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to parse target address '%s'.\n"
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eloop_init
argument_list|(
operator|&
name|wpa_s
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|wpa_s
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|.
name|conf
operator|=
name|wpa_config_read
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|.
name|conf
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to parse configuration file '%s'.\n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|.
name|conf
operator|->
name|ssid
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No networks defined.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_init_conf
argument_list|(
operator|&
name|wpa_s
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_ctrl_iface_init
argument_list|(
operator|&
name|wpa_s
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to initialize control interface '%s'.\n"
literal|"You may have another preauth_test process already "
literal|"running or the file was\n"
literal|"left by an unclean termination of preauth_test in "
literal|"which case you will need\n"
literal|"to manually remove this file before starting "
literal|"preauth_test again.\n"
argument_list|,
name|wpa_s
operator|.
name|conf
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_supplicant_scard_init
argument_list|(
operator|&
name|wpa_s
argument_list|,
name|wpa_s
operator|.
name|conf
operator|->
name|ssid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|rsn_preauth_init
argument_list|(
name|wpa_s
operator|.
name|wpa
argument_list|,
name|bssid
argument_list|,
name|wpa_s
operator|.
name|conf
operator|->
name|ssid
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|eloop_register_timeout
argument_list|(
literal|30
argument_list|,
literal|0
argument_list|,
name|eapol_test_timeout
argument_list|,
operator|&
name|preauth_test
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|100000
argument_list|,
name|eapol_test_poll
argument_list|,
operator|&
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_signal
argument_list|(
name|SIGINT
argument_list|,
name|eapol_test_terminate
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_signal
argument_list|(
name|SIGTERM
argument_list|,
name|eapol_test_terminate
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_signal
argument_list|(
name|SIGHUP
argument_list|,
name|eapol_test_terminate
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_run
argument_list|()
expr_stmt|;
if|if
condition|(
name|preauth_test
operator|.
name|auth_timed_out
condition|)
name|ret
operator|=
operator|-
literal|2
expr_stmt|;
else|else
block|{
name|ret
operator|=
name|pmksa_cache_get
argument_list|(
name|wpa_s
operator|.
name|wpa
argument_list|,
name|bssid
argument_list|,
name|NULL
argument_list|)
condition|?
literal|0
else|:
operator|-
literal|3
expr_stmt|;
block|}
name|test_eapol_clean
argument_list|(
operator|&
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_destroy
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


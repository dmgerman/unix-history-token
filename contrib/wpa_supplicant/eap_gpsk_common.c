begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * EAP server/peer: EAP-GPSK shared routines  * Copyright (c) 2006-2007, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eap_defs.h"
end_include

begin_include
include|#
directive|include
file|"aes_wrap.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"sha256.h"
end_include

begin_include
include|#
directive|include
file|"eap_gpsk_common.h"
end_include

begin_comment
comment|/**  * eap_gpsk_supported_ciphersuite - Check whether ciphersuite is supported  * @vendor: CSuite/Vendor  * @specifier: CSuite/Specifier  * Returns: 1 if ciphersuite is support, or 0 if not  */
end_comment

begin_function
name|int
name|eap_gpsk_supported_ciphersuite
parameter_list|(
name|int
name|vendor
parameter_list|,
name|int
name|specifier
parameter_list|)
block|{
if|if
condition|(
name|vendor
operator|==
name|EAP_GPSK_VENDOR_IETF
operator|&&
name|specifier
operator|==
name|EAP_GPSK_CIPHER_AES
condition|)
return|return
literal|1
return|;
ifdef|#
directive|ifdef
name|EAP_GPSK_SHA256
if|if
condition|(
name|vendor
operator|==
name|EAP_GPSK_VENDOR_IETF
operator|&&
name|specifier
operator|==
name|EAP_GPSK_CIPHER_SHA256
condition|)
return|return
literal|1
return|;
endif|#
directive|endif
comment|/* EAP_GPSK_SHA256 */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_gpsk_gkdf
parameter_list|(
specifier|const
name|u8
modifier|*
name|psk
comment|/* Y */
parameter_list|,
name|size_t
name|psk_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
comment|/* Z */
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
comment|/* X */
parameter_list|)
block|{
name|u8
modifier|*
name|opos
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|n
decl_stmt|,
name|hashlen
decl_stmt|,
name|left
decl_stmt|,
name|clen
decl_stmt|;
name|u8
name|ibuf
index|[
literal|2
index|]
decl_stmt|,
name|hash
index|[
name|SHA1_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|3
index|]
decl_stmt|;
name|size_t
name|vlen
index|[
literal|3
index|]
decl_stmt|;
name|hashlen
operator|=
name|SHA1_MAC_LEN
expr_stmt|;
comment|/* M_i = Hash-Function (i || Y || Z); */
name|addr
index|[
literal|0
index|]
operator|=
name|ibuf
expr_stmt|;
name|vlen
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
name|ibuf
argument_list|)
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|psk
expr_stmt|;
name|vlen
index|[
literal|1
index|]
operator|=
name|psk_len
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|data
expr_stmt|;
name|vlen
index|[
literal|2
index|]
operator|=
name|data_len
expr_stmt|;
name|opos
operator|=
name|buf
expr_stmt|;
name|left
operator|=
name|len
expr_stmt|;
name|n
operator|=
operator|(
name|len
operator|+
name|hashlen
operator|-
literal|1
operator|)
operator|/
name|hashlen
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|n
condition|;
name|i
operator|++
control|)
block|{
name|WPA_PUT_BE16
argument_list|(
name|ibuf
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sha1_vector
argument_list|(
literal|3
argument_list|,
name|addr
argument_list|,
name|vlen
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|clen
operator|=
name|left
operator|>
name|hashlen
condition|?
name|hashlen
else|:
name|left
expr_stmt|;
name|os_memcpy
argument_list|(
name|opos
argument_list|,
name|hash
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|opos
operator|+=
name|clen
expr_stmt|;
name|left
operator|-=
name|clen
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_gpsk_derive_keys_aes
parameter_list|(
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|seed
parameter_list|,
name|size_t
name|seed_len
parameter_list|,
name|u8
modifier|*
name|msk
parameter_list|,
name|u8
modifier|*
name|emsk
parameter_list|,
name|u8
modifier|*
name|sk
parameter_list|,
name|size_t
modifier|*
name|sk_len
parameter_list|,
name|u8
modifier|*
name|pk
parameter_list|,
name|size_t
modifier|*
name|pk_len
parameter_list|)
block|{
define|#
directive|define
name|EAP_GPSK_SK_LEN_AES
value|16
define|#
directive|define
name|EAP_GPSK_PK_LEN_AES
value|16
name|u8
name|zero_string
index|[
literal|1
index|]
decl_stmt|,
name|mk
index|[
literal|32
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|u8
name|kdf_out
index|[
name|EAP_MSK_LEN
operator|+
name|EAP_EMSK_LEN
operator|+
name|EAP_GPSK_SK_LEN_AES
operator|+
name|EAP_GPSK_PK_LEN_AES
index|]
decl_stmt|;
name|size_t
name|data_len
decl_stmt|;
comment|/* 	 * inputString = RAND_Client || ID_Client || RAND_Server || ID_Server 	 *            (= seed) 	 * KS = 16, PL = psk_len, CSuite_Sel = 0x000000 0x000001 	 * MK = GKDF-32 (0x00, PL || PSK || CSuite_Sel || inputString) 	 * MSK = GKDF-160 (MK, inputString)[0..63] 	 * EMSK = GKDF-160 (MK, inputString)[64..127] 	 * SK = GKDF-160 (MK, inputString)[128..143] 	 * PK = GKDF-160 (MK, inputString)[144..159] 	 * MID = GKDF-16(0x00, "Method ID" || EAP_Method_Type || CSuite_Sel || 	 *               inputString) 	 * Hash-Function = SHA-1 (see [RFC3174]) 	 * hashlen = 20 octets (160 bits) 	 */
name|os_memset
argument_list|(
name|zero_string
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|zero_string
argument_list|)
argument_list|)
expr_stmt|;
name|data_len
operator|=
literal|2
operator|+
name|psk_len
operator|+
literal|6
operator|+
name|seed_len
expr_stmt|;
name|data
operator|=
name|os_malloc
argument_list|(
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|data
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|psk_len
expr_stmt|;
name|WPA_PUT_BE24
argument_list|(
name|pos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* CSuite/Vendor = IETF */
name|pos
operator|+=
literal|3
expr_stmt|;
name|WPA_PUT_BE24
argument_list|(
name|pos
argument_list|,
name|EAP_GPSK_CIPHER_AES
argument_list|)
expr_stmt|;
comment|/* CSuite/Specifier */
name|pos
operator|+=
literal|3
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|seed
argument_list|,
name|seed_len
argument_list|)
expr_stmt|;
comment|/* inputString */
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: Data to MK derivation (AES)"
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_gpsk_gkdf
argument_list|(
name|zero_string
argument_list|,
sizeof|sizeof
argument_list|(
name|zero_string
argument_list|)
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|mk
argument_list|,
sizeof|sizeof
argument_list|(
name|mk
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: MK"
argument_list|,
name|mk
argument_list|,
sizeof|sizeof
argument_list|(
name|mk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_gpsk_gkdf
argument_list|(
name|mk
argument_list|,
sizeof|sizeof
argument_list|(
name|mk
argument_list|)
argument_list|,
name|seed
argument_list|,
name|seed_len
argument_list|,
name|kdf_out
argument_list|,
sizeof|sizeof
argument_list|(
name|kdf_out
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|kdf_out
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: MSK"
argument_list|,
name|pos
argument_list|,
name|EAP_MSK_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msk
argument_list|,
name|pos
argument_list|,
name|EAP_MSK_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|EAP_MSK_LEN
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: EMSK"
argument_list|,
name|pos
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|emsk
argument_list|,
name|pos
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|EAP_EMSK_LEN
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: SK"
argument_list|,
name|pos
argument_list|,
name|EAP_GPSK_SK_LEN_AES
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|sk
argument_list|,
name|pos
argument_list|,
name|EAP_GPSK_SK_LEN_AES
argument_list|)
expr_stmt|;
operator|*
name|sk_len
operator|=
name|EAP_GPSK_SK_LEN_AES
expr_stmt|;
name|pos
operator|+=
name|EAP_GPSK_SK_LEN_AES
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: PK"
argument_list|,
name|pos
argument_list|,
name|EAP_GPSK_PK_LEN_AES
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pk
argument_list|,
name|pos
argument_list|,
name|EAP_GPSK_PK_LEN_AES
argument_list|)
expr_stmt|;
operator|*
name|pk_len
operator|=
name|EAP_GPSK_PK_LEN_AES
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_GPSK_SHA256
end_ifdef

begin_function
specifier|static
name|int
name|eap_gpsk_gkdf_sha256
parameter_list|(
specifier|const
name|u8
modifier|*
name|psk
comment|/* Y */
parameter_list|,
name|size_t
name|psk_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
comment|/* Z */
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
comment|/* X */
parameter_list|)
block|{
name|u8
modifier|*
name|opos
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|n
decl_stmt|,
name|hashlen
decl_stmt|,
name|left
decl_stmt|,
name|clen
decl_stmt|;
name|u8
name|ibuf
index|[
literal|2
index|]
decl_stmt|,
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|3
index|]
decl_stmt|;
name|size_t
name|vlen
index|[
literal|3
index|]
decl_stmt|;
name|hashlen
operator|=
name|SHA256_MAC_LEN
expr_stmt|;
comment|/* M_i = Hash-Function (i || Y || Z); */
name|addr
index|[
literal|0
index|]
operator|=
name|ibuf
expr_stmt|;
name|vlen
index|[
literal|0
index|]
operator|=
sizeof|sizeof
argument_list|(
name|ibuf
argument_list|)
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|psk
expr_stmt|;
name|vlen
index|[
literal|1
index|]
operator|=
name|psk_len
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|data
expr_stmt|;
name|vlen
index|[
literal|2
index|]
operator|=
name|data_len
expr_stmt|;
name|opos
operator|=
name|buf
expr_stmt|;
name|left
operator|=
name|len
expr_stmt|;
name|n
operator|=
operator|(
name|len
operator|+
name|hashlen
operator|-
literal|1
operator|)
operator|/
name|hashlen
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|n
condition|;
name|i
operator|++
control|)
block|{
name|WPA_PUT_BE16
argument_list|(
name|ibuf
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sha256_vector
argument_list|(
literal|3
argument_list|,
name|addr
argument_list|,
name|vlen
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|clen
operator|=
name|left
operator|>
name|hashlen
condition|?
name|hashlen
else|:
name|left
expr_stmt|;
name|os_memcpy
argument_list|(
name|opos
argument_list|,
name|hash
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|opos
operator|+=
name|clen
expr_stmt|;
name|left
operator|-=
name|clen
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_gpsk_derive_keys_sha256
parameter_list|(
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|seed
parameter_list|,
name|size_t
name|seed_len
parameter_list|,
name|u8
modifier|*
name|msk
parameter_list|,
name|u8
modifier|*
name|emsk
parameter_list|,
name|u8
modifier|*
name|sk
parameter_list|,
name|size_t
modifier|*
name|sk_len
parameter_list|,
name|u8
modifier|*
name|pk
parameter_list|,
name|size_t
modifier|*
name|pk_len
parameter_list|)
block|{
define|#
directive|define
name|EAP_GPSK_SK_LEN_SHA256
value|SHA256_MAC_LEN
define|#
directive|define
name|EAP_GPSK_PK_LEN_SHA256
value|SHA256_MAC_LEN
name|u8
name|mk
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|,
name|zero_string
index|[
literal|1
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|u8
name|kdf_out
index|[
name|EAP_MSK_LEN
operator|+
name|EAP_EMSK_LEN
operator|+
name|EAP_GPSK_SK_LEN_SHA256
operator|+
name|EAP_GPSK_PK_LEN_SHA256
index|]
decl_stmt|;
name|size_t
name|data_len
decl_stmt|;
comment|/* 	 * inputString = RAND_Client || ID_Client || RAND_Server || ID_Server 	 *            (= seed) 	 * KS = 32, PL = psk_len, CSuite_Sel = 0x000000 0x000002 	 * MK = GKDF-32 (0x00, PL || PSK || CSuite_Sel || inputString) 	 * MSK = GKDF-192 (MK, inputString)[0..63] 	 * EMSK = GKDF-192 (MK, inputString)[64..127] 	 * SK = GKDF-192 (MK, inputString)[128..159] 	 * PK = GKDF-192 (MK, inputString)[160..191] 	 * MID = GKDF-16(0x00, "Method ID" || EAP_Method_Type || CSuite_Sel || 	 *               inputString) 	 * Hash-Function = SHA256 (see [RFC4634]) 	 * hashlen = 32 octets (256 bits) 	 */
name|os_memset
argument_list|(
name|zero_string
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|zero_string
argument_list|)
argument_list|)
expr_stmt|;
name|data_len
operator|=
literal|2
operator|+
name|psk_len
operator|+
literal|6
operator|+
name|seed_len
expr_stmt|;
name|data
operator|=
name|os_malloc
argument_list|(
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|data
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|psk_len
expr_stmt|;
name|WPA_PUT_BE24
argument_list|(
name|pos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* CSuite/Vendor = IETF */
name|pos
operator|+=
literal|3
expr_stmt|;
name|WPA_PUT_BE24
argument_list|(
name|pos
argument_list|,
name|EAP_GPSK_CIPHER_SHA256
argument_list|)
expr_stmt|;
comment|/* CSuite/Specifier */
name|pos
operator|+=
literal|3
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|seed
argument_list|,
name|seed_len
argument_list|)
expr_stmt|;
comment|/* inputString */
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: Data to MK derivation (SHA256)"
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_gpsk_gkdf_sha256
argument_list|(
name|zero_string
argument_list|,
sizeof|sizeof
argument_list|(
name|zero_string
argument_list|)
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|mk
argument_list|,
sizeof|sizeof
argument_list|(
name|mk
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: MK"
argument_list|,
name|mk
argument_list|,
sizeof|sizeof
argument_list|(
name|mk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_gpsk_gkdf_sha256
argument_list|(
name|mk
argument_list|,
sizeof|sizeof
argument_list|(
name|mk
argument_list|)
argument_list|,
name|seed
argument_list|,
name|seed_len
argument_list|,
name|kdf_out
argument_list|,
sizeof|sizeof
argument_list|(
name|kdf_out
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|kdf_out
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: MSK"
argument_list|,
name|pos
argument_list|,
name|EAP_MSK_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|msk
argument_list|,
name|pos
argument_list|,
name|EAP_MSK_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|EAP_MSK_LEN
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: EMSK"
argument_list|,
name|pos
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|emsk
argument_list|,
name|pos
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|EAP_EMSK_LEN
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: SK"
argument_list|,
name|pos
argument_list|,
name|EAP_GPSK_SK_LEN_SHA256
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|sk
argument_list|,
name|pos
argument_list|,
name|EAP_GPSK_SK_LEN_SHA256
argument_list|)
expr_stmt|;
operator|*
name|sk_len
operator|=
name|EAP_GPSK_SK_LEN_AES
expr_stmt|;
name|pos
operator|+=
name|EAP_GPSK_SK_LEN_AES
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: PK"
argument_list|,
name|pos
argument_list|,
name|EAP_GPSK_PK_LEN_SHA256
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pk
argument_list|,
name|pos
argument_list|,
name|EAP_GPSK_PK_LEN_SHA256
argument_list|)
expr_stmt|;
operator|*
name|pk_len
operator|=
name|EAP_GPSK_PK_LEN_SHA256
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_GPSK_SHA256 */
end_comment

begin_comment
comment|/**  * eap_gpsk_derive_keys - Derive EAP-GPSK keys  * @psk: Pre-shared key (at least 16 bytes if AES is used)  * @psk_len: Length of psk in bytes  * @vendor: CSuite/Vendor  * @specifier: CSuite/Specifier  * @rand_client: 32-byte RAND_Client  * @rand_server: 32-byte RAND_Server  * @id_client: ID_Client  * @id_client_len: Length of ID_Client  * @id_server: ID_Server  * @id_server_len: Length of ID_Server  * @msk: Buffer for 64-byte MSK  * @emsk: Buffer for 64-byte EMSK  * @sk: Buffer for SK (at least EAP_GPSK_MAX_SK_LEN bytes)  * @sk_len: Buffer for returning length of SK  * @pk: Buffer for SK (at least EAP_GPSK_MAX_PK_LEN bytes)  * @pk_len: Buffer for returning length of PK  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|eap_gpsk_derive_keys
parameter_list|(
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|,
name|int
name|vendor
parameter_list|,
name|int
name|specifier
parameter_list|,
specifier|const
name|u8
modifier|*
name|rand_client
parameter_list|,
specifier|const
name|u8
modifier|*
name|rand_server
parameter_list|,
specifier|const
name|u8
modifier|*
name|id_client
parameter_list|,
name|size_t
name|id_client_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|id_server
parameter_list|,
name|size_t
name|id_server_len
parameter_list|,
name|u8
modifier|*
name|msk
parameter_list|,
name|u8
modifier|*
name|emsk
parameter_list|,
name|u8
modifier|*
name|sk
parameter_list|,
name|size_t
modifier|*
name|sk_len
parameter_list|,
name|u8
modifier|*
name|pk
parameter_list|,
name|size_t
modifier|*
name|pk_len
parameter_list|)
block|{
name|u8
modifier|*
name|seed
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|seed_len
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: Deriving keys (%d:%d)"
argument_list|,
name|vendor
argument_list|,
name|specifier
argument_list|)
expr_stmt|;
if|if
condition|(
name|vendor
operator|!=
name|EAP_GPSK_VENDOR_IETF
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: PSK"
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
comment|/* Seed = RAND_Client || ID_Client || RAND_Server || ID_Server */
name|seed_len
operator|=
literal|2
operator|*
name|EAP_GPSK_RAND_LEN
operator|+
name|id_server_len
operator|+
name|id_client_len
expr_stmt|;
name|seed
operator|=
name|os_malloc
argument_list|(
name|seed_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|seed
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: Failed to allocate memory "
literal|"for key derivation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|seed
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|rand_client
argument_list|,
name|EAP_GPSK_RAND_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|EAP_GPSK_RAND_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|id_client
argument_list|,
name|id_client_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|id_client_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|rand_server
argument_list|,
name|EAP_GPSK_RAND_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|EAP_GPSK_RAND_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|id_server
argument_list|,
name|id_server_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|id_server_len
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: Seed"
argument_list|,
name|seed
argument_list|,
name|seed_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|specifier
condition|)
block|{
case|case
name|EAP_GPSK_CIPHER_AES
case|:
name|ret
operator|=
name|eap_gpsk_derive_keys_aes
argument_list|(
name|psk
argument_list|,
name|psk_len
argument_list|,
name|seed
argument_list|,
name|seed_len
argument_list|,
name|msk
argument_list|,
name|emsk
argument_list|,
name|sk
argument_list|,
name|sk_len
argument_list|,
name|pk
argument_list|,
name|pk_len
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|EAP_GPSK_SHA256
case|case
name|EAP_GPSK_CIPHER_SHA256
case|:
name|ret
operator|=
name|eap_gpsk_derive_keys_sha256
argument_list|(
name|psk
argument_list|,
name|psk_len
argument_list|,
name|seed
argument_list|,
name|seed_len
argument_list|,
name|msk
argument_list|,
name|emsk
argument_list|,
name|sk
argument_list|,
name|sk_len
argument_list|,
name|pk
argument_list|,
name|pk_len
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EAP_GPSK_SHA256 */
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: Unknown cipher %d:%d used in "
literal|"key derivation"
argument_list|,
name|vendor
argument_list|,
name|specifier
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|os_free
argument_list|(
name|seed
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * eap_gpsk_mic_len - Get the length of the MIC  * @vendor: CSuite/Vendor  * @specifier: CSuite/Specifier  * Returns: MIC length in bytes  */
end_comment

begin_function
name|size_t
name|eap_gpsk_mic_len
parameter_list|(
name|int
name|vendor
parameter_list|,
name|int
name|specifier
parameter_list|)
block|{
if|if
condition|(
name|vendor
operator|!=
name|EAP_GPSK_VENDOR_IETF
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|specifier
condition|)
block|{
case|case
name|EAP_GPSK_CIPHER_AES
case|:
return|return
literal|16
return|;
ifdef|#
directive|ifdef
name|EAP_GPSK_SHA256
case|case
name|EAP_GPSK_CIPHER_SHA256
case|:
return|return
literal|32
return|;
endif|#
directive|endif
comment|/* EAP_GPSK_SHA256 */
default|default:
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_gpsk_compute_mic_aes
parameter_list|(
specifier|const
name|u8
modifier|*
name|sk
parameter_list|,
name|size_t
name|sk_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u8
modifier|*
name|mic
parameter_list|)
block|{
if|if
condition|(
name|sk_len
operator|!=
literal|16
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: Invalid SK length %d for "
literal|"AES-CMAC MIC"
argument_list|,
name|sk_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|omac1_aes_128
argument_list|(
name|sk
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|mic
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * eap_gpsk_compute_mic - Compute EAP-GPSK MIC for an EAP packet  * @sk: Session key SK from eap_gpsk_derive_keys()  * @sk_len: SK length in bytes from eap_gpsk_derive_keys()  * @vendor: CSuite/Vendor  * @specifier: CSuite/Specifier  * @data: Input data to MIC  * @len: Input data length in bytes  * @mic: Buffer for the computed MIC, eap_gpsk_mic_len(cipher) bytes  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|eap_gpsk_compute_mic
parameter_list|(
specifier|const
name|u8
modifier|*
name|sk
parameter_list|,
name|size_t
name|sk_len
parameter_list|,
name|int
name|vendor
parameter_list|,
name|int
name|specifier
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u8
modifier|*
name|mic
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|vendor
operator|!=
name|EAP_GPSK_VENDOR_IETF
condition|)
return|return
operator|-
literal|1
return|;
switch|switch
condition|(
name|specifier
condition|)
block|{
case|case
name|EAP_GPSK_CIPHER_AES
case|:
name|ret
operator|=
name|eap_gpsk_compute_mic_aes
argument_list|(
name|sk
argument_list|,
name|sk_len
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|mic
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|EAP_GPSK_SHA256
case|case
name|EAP_GPSK_CIPHER_SHA256
case|:
name|hmac_sha256
argument_list|(
name|sk
argument_list|,
name|sk_len
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|mic
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EAP_GPSK_SHA256 */
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-GPSK: Unknown cipher %d:%d used in "
literal|"MIC computation"
argument_list|,
name|vendor
argument_list|,
name|specifier
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Host AP (software wireless LAN access point) user space daemon for  * Host AP kernel driver / RADIUS client  * Copyright (c) 2002-2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"radius.h"
end_include

begin_include
include|#
directive|include
file|"md5.h"
end_include

begin_function
name|struct
name|radius_msg
modifier|*
name|radius_msg_new
parameter_list|(
name|u8
name|code
parameter_list|,
name|u8
name|identifier
parameter_list|)
block|{
name|struct
name|radius_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
operator|(
expr|struct
name|radius_msg
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|radius_msg_initialize
argument_list|(
name|msg
argument_list|,
name|RADIUS_DEFAULT_MSG_SIZE
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|radius_msg_set_hdr
argument_list|(
name|msg
argument_list|,
name|code
argument_list|,
name|identifier
argument_list|)
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_initialize
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|size_t
name|init_len
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|==
name|NULL
operator|||
name|init_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buf
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|init_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|msg
operator|->
name|buf
argument_list|,
literal|0
argument_list|,
name|init_len
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buf_size
operator|=
name|init_len
expr_stmt|;
name|msg
operator|->
name|hdr
operator|=
operator|(
expr|struct
name|radius_hdr
operator|*
operator|)
name|msg
operator|->
name|buf
expr_stmt|;
name|msg
operator|->
name|buf_used
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
operator|->
name|hdr
argument_list|)
expr_stmt|;
name|msg
operator|->
name|attrs
operator|=
operator|(
expr|struct
name|radius_attr_hdr
operator|*
operator|*
operator|)
name|malloc
argument_list|(
name|RADIUS_DEFAULT_ATTR_COUNT
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|msg
operator|->
name|attrs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|attrs
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
name|msg
operator|->
name|hdr
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|attr_size
operator|=
name|RADIUS_DEFAULT_ATTR_COUNT
expr_stmt|;
name|msg
operator|->
name|attr_used
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|radius_msg_set_hdr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|code
parameter_list|,
name|u8
name|identifier
parameter_list|)
block|{
name|msg
operator|->
name|hdr
operator|->
name|code
operator|=
name|code
expr_stmt|;
name|msg
operator|->
name|hdr
operator|->
name|identifier
operator|=
name|identifier
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radius_msg_free
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|->
name|buf
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|msg
operator|->
name|buf
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
name|msg
operator|->
name|hdr
operator|=
name|NULL
expr_stmt|;
block|}
name|msg
operator|->
name|buf_size
operator|=
name|msg
operator|->
name|buf_used
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|attrs
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|msg
operator|->
name|attrs
argument_list|)
expr_stmt|;
name|msg
operator|->
name|attrs
operator|=
name|NULL
expr_stmt|;
block|}
name|msg
operator|->
name|attr_size
operator|=
name|msg
operator|->
name|attr_used
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|radius_code_string
parameter_list|(
name|u8
name|code
parameter_list|)
block|{
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|RADIUS_CODE_ACCESS_REQUEST
case|:
return|return
literal|"Access-Request"
return|;
case|case
name|RADIUS_CODE_ACCESS_ACCEPT
case|:
return|return
literal|"Access-Accept"
return|;
case|case
name|RADIUS_CODE_ACCESS_REJECT
case|:
return|return
literal|"Access-Reject"
return|;
case|case
name|RADIUS_CODE_ACCOUNTING_REQUEST
case|:
return|return
literal|"Accounting-Request"
return|;
case|case
name|RADIUS_CODE_ACCOUNTING_RESPONSE
case|:
return|return
literal|"Accounting-Response"
return|;
case|case
name|RADIUS_CODE_ACCESS_CHALLENGE
case|:
return|return
literal|"Access-Challenge"
return|;
case|case
name|RADIUS_CODE_STATUS_SERVER
case|:
return|return
literal|"Status-Server"
return|;
case|case
name|RADIUS_CODE_STATUS_CLIENT
case|:
return|return
literal|"Status-Client"
return|;
case|case
name|RADIUS_CODE_RESERVED
case|:
return|return
literal|"Reserved"
return|;
default|default:
return|return
literal|"?Unknown?"
return|;
block|}
block|}
end_function

begin_struct
struct|struct
name|radius_attr_type
block|{
name|u8
name|type
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
enum|enum
block|{
name|RADIUS_ATTR_UNDIST
block|,
name|RADIUS_ATTR_TEXT
block|,
name|RADIUS_ATTR_IP
block|,
name|RADIUS_ATTR_HEXDUMP
block|,
name|RADIUS_ATTR_INT32
block|}
name|data_type
enum|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|radius_attr_type
name|radius_attrs
index|[]
init|=
block|{
block|{
name|RADIUS_ATTR_USER_NAME
block|,
literal|"User-Name"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_USER_PASSWORD
block|,
literal|"User-Password"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_NAS_IP_ADDRESS
block|,
literal|"NAS-IP-Address"
block|,
name|RADIUS_ATTR_IP
block|}
block|,
block|{
name|RADIUS_ATTR_NAS_PORT
block|,
literal|"NAS-Port"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_FRAMED_MTU
block|,
literal|"Framed-MTU"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_STATE
block|,
literal|"State"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_CLASS
block|,
literal|"Class"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_VENDOR_SPECIFIC
block|,
literal|"Vendor-Specific"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_SESSION_TIMEOUT
block|,
literal|"Session-Timeout"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_IDLE_TIMEOUT
block|,
literal|"Idle-Timeout"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_TERMINATION_ACTION
block|,
literal|"Termination-Action"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_CALLED_STATION_ID
block|,
literal|"Called-Station-Id"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_CALLING_STATION_ID
block|,
literal|"Calling-Station-Id"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_NAS_IDENTIFIER
block|,
literal|"NAS-Identifier"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_STATUS_TYPE
block|,
literal|"Acct-Status-Type"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_DELAY_TIME
block|,
literal|"Acct-Delay-Time"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_INPUT_OCTETS
block|,
literal|"Acct-Input-Octets"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_OUTPUT_OCTETS
block|,
literal|"Acct-Output-Octets"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_SESSION_ID
block|,
literal|"Acct-Session-Id"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_AUTHENTIC
block|,
literal|"Acct-Authentic"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_SESSION_TIME
block|,
literal|"Acct-Session-Time"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_INPUT_PACKETS
block|,
literal|"Acct-Input-Packets"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_OUTPUT_PACKETS
block|,
literal|"Acct-Output-Packets"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_TERMINATE_CAUSE
block|,
literal|"Acct-Terminate-Cause"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_MULTI_SESSION_ID
block|,
literal|"Acct-Multi-Session-Id"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_LINK_COUNT
block|,
literal|"Acct-Link-Count"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_INPUT_GIGAWORDS
block|,
literal|"Acct-Input-Gigawords"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_OUTPUT_GIGAWORDS
block|,
literal|"Acct-Output-Gigawords"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_EVENT_TIMESTAMP
block|,
literal|"Event-Timestamp"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_NAS_PORT_TYPE
block|,
literal|"NAS-Port-Type"
block|,
name|RADIUS_ATTR_INT32
block|}
block|,
block|{
name|RADIUS_ATTR_CONNECT_INFO
block|,
literal|"Connect-Info"
block|,
name|RADIUS_ATTR_TEXT
block|}
block|,
block|{
name|RADIUS_ATTR_EAP_MESSAGE
block|,
literal|"EAP-Message"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_MESSAGE_AUTHENTICATOR
block|,
literal|"Message-Authenticator"
block|,
name|RADIUS_ATTR_UNDIST
block|}
block|,
block|{
name|RADIUS_ATTR_ACCT_INTERIM_INTERVAL
block|,
literal|"Acct-Interim-Interval"
block|,
name|RADIUS_ATTR_INT32
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|RADIUS_ATTRS
value|(sizeof(radius_attrs) / sizeof(radius_attrs[0]))
end_define

begin_function
specifier|static
name|struct
name|radius_attr_type
modifier|*
name|radius_get_attr_type
parameter_list|(
name|u8
name|type
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADIUS_ATTRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|radius_attrs
index|[
name|i
index|]
operator|.
name|type
condition|)
return|return
operator|&
name|radius_attrs
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radius_msg_dump_attr
parameter_list|(
name|struct
name|radius_attr_hdr
modifier|*
name|hdr
parameter_list|)
block|{
name|struct
name|radius_attr_type
modifier|*
name|attr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pos
decl_stmt|;
name|attr
operator|=
name|radius_get_attr_type
argument_list|(
name|hdr
operator|->
name|type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"   Attribute %d (%s) length=%d\n"
argument_list|,
name|hdr
operator|->
name|type
argument_list|,
name|attr
condition|?
name|attr
operator|->
name|name
else|:
literal|"?Unknown?"
argument_list|,
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
return|return;
name|len
operator|=
name|hdr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|radius_attr_hdr
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
switch|switch
condition|(
name|attr
operator|->
name|data_type
condition|)
block|{
case|case
name|RADIUS_ATTR_TEXT
case|:
name|printf
argument_list|(
literal|"      Value: '"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|print_char
argument_list|(
name|pos
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"'\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADIUS_ATTR_IP
case|:
if|if
condition|(
name|len
operator|==
literal|4
condition|)
block|{
name|struct
name|in_addr
modifier|*
name|addr
init|=
operator|(
expr|struct
name|in_addr
operator|*
operator|)
name|pos
decl_stmt|;
name|printf
argument_list|(
literal|"      Value: %s\n"
argument_list|,
name|inet_ntoa
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"      Invalid IP address length %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADIUS_ATTR_HEXDUMP
case|:
case|case
name|RADIUS_ATTR_UNDIST
case|:
name|printf
argument_list|(
literal|"      Value:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
name|pos
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADIUS_ATTR_INT32
case|:
if|if
condition|(
name|len
operator|==
literal|4
condition|)
block|{
name|u32
modifier|*
name|val
init|=
operator|(
name|u32
operator|*
operator|)
name|pos
decl_stmt|;
name|printf
argument_list|(
literal|"      Value: %d\n"
argument_list|,
name|ntohl
argument_list|(
operator|*
name|val
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"      Invalid INT32 length %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|void
name|radius_msg_dump
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"RADIUS message: code=%d (%s) identifier=%d length=%d\n"
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|code
argument_list|,
name|radius_code_string
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|code
argument_list|)
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|identifier
argument_list|,
name|ntohs
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|length
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|radius_msg_dump_attr
argument_list|(
name|msg
operator|->
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|radius_msg_finish
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
if|if
condition|(
name|secret
condition|)
block|{
name|u8
name|auth
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
name|memset
argument_list|(
name|auth
argument_list|,
literal|0
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|attr
operator|=
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_MESSAGE_AUTHENTICATOR
argument_list|,
name|auth
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"WARNING: Could not add "
literal|"Message-Authenticator\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|msg
operator|->
name|buf_used
argument_list|)
expr_stmt|;
name|hmac_md5
argument_list|(
name|secret
argument_list|,
name|secret_len
argument_list|,
name|msg
operator|->
name|buf
argument_list|,
name|msg
operator|->
name|buf_used
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|msg
operator|->
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|msg
operator|->
name|buf_used
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|buf_used
operator|>
literal|0xffff
condition|)
block|{
name|printf
argument_list|(
literal|"WARNING: too long RADIUS message (%lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|msg
operator|->
name|buf_used
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_finish_srv
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_authenticator
parameter_list|)
block|{
name|u8
name|auth
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
name|MD5_CTX
name|context
decl_stmt|;
name|memset
argument_list|(
name|auth
argument_list|,
literal|0
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|attr
operator|=
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_MESSAGE_AUTHENTICATOR
argument_list|,
name|auth
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"WARNING: Could not add Message-Authenticator\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|msg
operator|->
name|buf_used
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|req_authenticator
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
argument_list|)
expr_stmt|;
name|hmac_md5
argument_list|(
name|secret
argument_list|,
name|secret_len
argument_list|,
name|msg
operator|->
name|buf
argument_list|,
name|msg
operator|->
name|buf_used
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* ResponseAuth = MD5(Code+ID+Length+RequestAuth+Attributes+Secret) */
name|MD5Init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|msg
operator|->
name|hdr
argument_list|,
literal|1
operator|+
literal|1
operator|+
literal|2
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|req_authenticator
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|msg
operator|->
name|hdr
operator|+
literal|1
operator|)
argument_list|,
name|msg
operator|->
name|buf_used
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|msg
operator|->
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|buf_used
operator|>
literal|0xffff
condition|)
block|{
name|printf
argument_list|(
literal|"WARNING: too long RADIUS message (%lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|msg
operator|->
name|buf_used
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|radius_msg_finish_acct
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
name|MD5_CTX
name|context
decl_stmt|;
name|msg
operator|->
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|msg
operator|->
name|buf_used
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
literal|0
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|MD5Init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|msg
operator|->
name|buf
argument_list|,
name|msg
operator|->
name|buf_used
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|buf_used
operator|>
literal|0xffff
condition|)
block|{
name|printf
argument_list|(
literal|"WARNING: too long RADIUS messages (%lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|msg
operator|->
name|buf_used
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|radius_msg_add_attr_to_array
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|radius_attr_hdr
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|->
name|attr_used
operator|>=
name|msg
operator|->
name|attr_size
condition|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
modifier|*
name|nattrs
decl_stmt|;
name|int
name|nlen
init|=
name|msg
operator|->
name|attr_size
operator|*
literal|2
decl_stmt|;
name|nattrs
operator|=
operator|(
expr|struct
name|radius_attr_hdr
operator|*
operator|*
operator|)
name|realloc
argument_list|(
name|msg
operator|->
name|attrs
argument_list|,
name|nlen
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|msg
operator|->
name|attrs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nattrs
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|msg
operator|->
name|attrs
operator|=
name|nattrs
expr_stmt|;
name|msg
operator|->
name|attr_size
operator|=
name|nlen
expr_stmt|;
block|}
name|msg
operator|->
name|attrs
index|[
name|msg
operator|->
name|attr_used
operator|++
index|]
operator|=
name|attr
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|radius_attr_hdr
modifier|*
name|radius_msg_add_attr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|type
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|size_t
name|buf_needed
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
if|if
condition|(
name|data_len
operator|>
name|RADIUS_MAX_ATTR_LEN
condition|)
block|{
name|printf
argument_list|(
literal|"radius_msg_add_attr: too long attribute (%lu bytes)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|data_len
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|buf_needed
operator|=
name|msg
operator|->
name|buf_used
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
operator|+
name|data_len
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|buf_size
operator|<
name|buf_needed
condition|)
block|{
comment|/* allocate more space for message buffer */
name|unsigned
name|char
modifier|*
name|nbuf
decl_stmt|;
name|int
name|nlen
init|=
name|msg
operator|->
name|buf_size
decl_stmt|;
name|int
name|diff
decl_stmt|,
name|i
decl_stmt|;
while|while
condition|(
name|nlen
operator|<
name|buf_needed
condition|)
name|nlen
operator|*=
literal|2
expr_stmt|;
name|nbuf
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|realloc
argument_list|(
name|msg
operator|->
name|buf
argument_list|,
name|nlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbuf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|diff
operator|=
name|nbuf
operator|-
name|msg
operator|->
name|buf
expr_stmt|;
name|msg
operator|->
name|buf
operator|=
name|nbuf
expr_stmt|;
name|msg
operator|->
name|hdr
operator|=
operator|(
expr|struct
name|radius_hdr
operator|*
operator|)
name|msg
operator|->
name|buf
expr_stmt|;
comment|/* adjust attr pointers to match with the new buffer */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
name|msg
operator|->
name|attrs
index|[
name|i
index|]
operator|=
operator|(
expr|struct
name|radius_attr_hdr
operator|*
operator|)
operator|(
operator|(
operator|(
name|u8
operator|*
operator|)
name|msg
operator|->
name|attrs
index|[
name|i
index|]
operator|)
operator|+
name|diff
operator|)
expr_stmt|;
name|memset
argument_list|(
name|msg
operator|->
name|buf
operator|+
name|msg
operator|->
name|buf_size
argument_list|,
literal|0
argument_list|,
name|nlen
operator|-
name|msg
operator|->
name|buf_size
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buf_size
operator|=
name|nlen
expr_stmt|;
block|}
name|attr
operator|=
operator|(
expr|struct
name|radius_attr_hdr
operator|*
operator|)
operator|(
name|msg
operator|->
name|buf
operator|+
name|msg
operator|->
name|buf_used
operator|)
expr_stmt|;
name|attr
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|attr
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
operator|+
name|data_len
expr_stmt|;
if|if
condition|(
name|data_len
operator|>
literal|0
condition|)
name|memcpy
argument_list|(
name|attr
operator|+
literal|1
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buf_used
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
operator|+
name|data_len
expr_stmt|;
if|if
condition|(
name|radius_msg_add_attr_to_array
argument_list|(
name|msg
argument_list|,
name|attr
argument_list|)
condition|)
return|return
name|NULL
return|;
return|return
name|attr
return|;
block|}
end_function

begin_function
name|struct
name|radius_msg
modifier|*
name|radius_msg_parse
parameter_list|(
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|radius_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|radius_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
name|size_t
name|msg_len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
operator|||
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
return|return
name|NULL
return|;
name|hdr
operator|=
operator|(
expr|struct
name|radius_hdr
operator|*
operator|)
name|data
expr_stmt|;
name|msg_len
operator|=
name|ntohs
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|||
name|msg_len
operator|>
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid RADIUS message length\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|msg_len
operator|<
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"Ignored %lu extra bytes after RADIUS message\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
operator|-
name|msg_len
argument_list|)
expr_stmt|;
block|}
name|msg
operator|=
operator|(
expr|struct
name|radius_msg
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|radius_msg_initialize
argument_list|(
name|msg
argument_list|,
name|msg_len
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
name|msg
operator|->
name|buf
argument_list|,
name|data
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|msg
operator|->
name|buf_size
operator|=
name|msg
operator|->
name|buf_used
operator|=
name|msg_len
expr_stmt|;
comment|/* parse attributes */
name|pos
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|msg
operator|->
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|msg
operator|->
name|buf
operator|+
name|msg
operator|->
name|buf_used
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|end
operator|-
name|pos
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|attr
operator|=
operator|(
expr|struct
name|radius_attr_hdr
operator|*
operator|)
name|pos
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|attr
operator|->
name|length
operator|>
name|end
operator|||
name|attr
operator|->
name|length
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
comment|/* TODO: check that attr->length is suitable for attr->type */
if|if
condition|(
name|radius_msg_add_attr_to_array
argument_list|(
name|msg
argument_list|,
name|attr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|pos
operator|+=
name|attr
operator|->
name|length
expr_stmt|;
block|}
return|return
name|msg
return|;
name|fail
label|:
name|radius_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_add_eap
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|;
name|size_t
name|left
init|=
name|data_len
decl_stmt|;
while|while
condition|(
name|left
operator|>
literal|0
condition|)
block|{
name|int
name|len
decl_stmt|;
if|if
condition|(
name|left
operator|>
name|RADIUS_MAX_ATTR_LEN
condition|)
name|len
operator|=
name|RADIUS_MAX_ATTR_LEN
expr_stmt|;
else|else
name|len
operator|=
name|left
expr_stmt|;
if|if
condition|(
operator|!
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_EAP_MESSAGE
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
condition|)
return|return
literal|0
return|;
name|pos
operator|+=
name|len
expr_stmt|;
name|left
operator|-=
name|len
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|radius_msg_get_eap
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|size_t
modifier|*
name|eap_len
parameter_list|)
block|{
name|u8
modifier|*
name|eap
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msg
operator|->
name|attrs
index|[
name|i
index|]
operator|->
name|type
operator|==
name|RADIUS_ATTR_EAP_MESSAGE
condition|)
name|len
operator|+=
name|msg
operator|->
name|attrs
index|[
name|i
index|]
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|radius_attr_hdr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
name|eap
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|eap
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msg
operator|->
name|attrs
index|[
name|i
index|]
operator|->
name|type
operator|==
name|RADIUS_ATTR_EAP_MESSAGE
condition|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|msg
operator|->
name|attrs
index|[
name|i
index|]
decl_stmt|;
name|int
name|flen
init|=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|pos
argument_list|,
name|attr
operator|+
literal|1
argument_list|,
name|flen
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|flen
expr_stmt|;
block|}
block|}
if|if
condition|(
name|eap_len
condition|)
operator|*
name|eap_len
operator|=
name|len
expr_stmt|;
return|return
name|eap
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_verify_msg_auth
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_auth
parameter_list|)
block|{
name|u8
name|auth
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|,
name|orig
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
name|u8
name|orig_authenticator
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msg
operator|->
name|attrs
index|[
name|i
index|]
operator|->
name|type
operator|==
name|RADIUS_ATTR_MESSAGE_AUTHENTICATOR
condition|)
block|{
if|if
condition|(
name|attr
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Multiple Message-Authenticator "
literal|"attributes in RADIUS message\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|attr
operator|=
name|msg
operator|->
name|attrs
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No Message-Authenticator attribute found\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|orig
argument_list|,
name|attr
operator|+
literal|1
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|attr
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|req_auth
condition|)
block|{
name|memcpy
argument_list|(
name|orig_authenticator
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
sizeof|sizeof
argument_list|(
name|orig_authenticator
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|req_auth
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|hmac_md5
argument_list|(
name|secret
argument_list|,
name|secret_len
argument_list|,
name|msg
operator|->
name|buf
argument_list|,
name|msg
operator|->
name|buf_used
argument_list|,
name|auth
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|attr
operator|+
literal|1
argument_list|,
name|orig
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|req_auth
condition|)
block|{
name|memcpy
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|orig_authenticator
argument_list|,
sizeof|sizeof
argument_list|(
name|orig_authenticator
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|orig
argument_list|,
name|auth
argument_list|,
name|MD5_MAC_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid Message-Authenticator!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_verify
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|sent_msg
parameter_list|)
block|{
name|MD5_CTX
name|context
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
if|if
condition|(
name|sent_msg
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No matching Access-Request message found\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|radius_msg_verify_msg_auth
argument_list|(
name|msg
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
comment|/* ResponseAuth = MD5(Code+ID+Length+RequestAuth+Attributes+Secret) */
name|MD5Init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|msg
operator|->
name|hdr
argument_list|,
literal|1
operator|+
literal|1
operator|+
literal|2
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|msg
operator|->
name|hdr
operator|+
literal|1
operator|)
argument_list|,
name|msg
operator|->
name|buf_used
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|msg
operator|->
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|hash
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|hash
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|MD5_MAC_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Response Authenticator invalid!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_verify_acct
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|sent_msg
parameter_list|)
block|{
name|MD5_CTX
name|context
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
name|MD5Init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|msg
operator|->
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|buf_used
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
condition|)
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|msg
operator|->
name|buf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
argument_list|,
name|msg
operator|->
name|buf_used
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|radius_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|hash
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|hash
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|MD5_MAC_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Response Authenticator invalid!\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_copy_attr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|dst
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|src
parameter_list|,
name|u8
name|type
parameter_list|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|src
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|src
operator|->
name|attrs
index|[
name|i
index|]
operator|->
name|type
operator|==
name|type
condition|)
block|{
name|attr
operator|=
name|src
operator|->
name|attrs
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|radius_msg_add_attr
argument_list|(
name|dst
argument_list|,
name|type
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
argument_list|,
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Create Request Authenticator. The value should be unique over the lifetime  * of the shared secret between authenticator and authentication server.  * Use one-way MD5 hash calculated from current timestamp and some data given  * by the caller. */
end_comment

begin_function
name|void
name|radius_msg_make_authenticator
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|MD5_CTX
name|context
decl_stmt|;
name|long
name|int
name|l
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|l
operator|=
name|random
argument_list|()
expr_stmt|;
name|MD5Init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|tv
argument_list|,
sizeof|sizeof
argument_list|(
name|tv
argument_list|)
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|l
argument_list|,
sizeof|sizeof
argument_list|(
name|l
argument_list|)
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Get Vendor-specific RADIUS Attribute from a parsed RADIUS message.  * Returns the Attribute payload and sets alen to indicate the length of the  * payload if a vendor attribute with subtype is found, otherwise returns NULL.  * The returned payload is allocated with malloc() and caller must free it.  */
end_comment

begin_function
specifier|static
name|u8
modifier|*
name|radius_msg_get_vendor_attr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u32
name|vendor
parameter_list|,
name|u8
name|subtype
parameter_list|,
name|size_t
modifier|*
name|alen
parameter_list|)
block|{
name|u8
modifier|*
name|data
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|int
name|i
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|msg
operator|->
name|attrs
index|[
name|i
index|]
decl_stmt|;
name|int
name|left
decl_stmt|;
name|u32
name|vendor_id
decl_stmt|;
name|struct
name|radius_attr_vendor
modifier|*
name|vhdr
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|type
operator|!=
name|RADIUS_ATTR_VENDOR_SPECIFIC
condition|)
continue|continue;
name|left
operator|=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
continue|continue;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|vendor_id
argument_list|,
name|pos
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|ntohl
argument_list|(
name|vendor_id
argument_list|)
operator|!=
name|vendor
condition|)
continue|continue;
while|while
condition|(
name|left
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
condition|)
block|{
name|vhdr
operator|=
operator|(
expr|struct
name|radius_attr_vendor
operator|*
operator|)
name|pos
expr_stmt|;
if|if
condition|(
name|vhdr
operator|->
name|vendor_length
operator|>
name|left
operator|||
name|vhdr
operator|->
name|vendor_length
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
condition|)
block|{
name|left
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vhdr
operator|->
name|vendor_type
operator|!=
name|subtype
condition|)
block|{
name|pos
operator|+=
name|vhdr
operator|->
name|vendor_length
expr_stmt|;
name|left
operator|-=
name|vhdr
operator|->
name|vendor_length
expr_stmt|;
continue|continue;
block|}
name|len
operator|=
name|vhdr
operator|->
name|vendor_length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
expr_stmt|;
name|data
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memcpy
argument_list|(
name|data
argument_list|,
name|pos
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|alen
condition|)
operator|*
name|alen
operator|=
name|len
expr_stmt|;
return|return
name|data
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|decrypt_ms_key
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_authenticator
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
name|size_t
modifier|*
name|reslen
parameter_list|)
block|{
name|u8
modifier|*
name|plain
decl_stmt|,
modifier|*
name|ppos
decl_stmt|,
modifier|*
name|res
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|plen
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
name|MD5_CTX
name|context
decl_stmt|;
name|int
name|i
decl_stmt|,
name|first
init|=
literal|1
decl_stmt|;
comment|/* key: 16-bit salt followed by encrypted key info */
if|if
condition|(
name|len
operator|<
literal|2
operator|+
literal|16
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|key
operator|+
literal|2
expr_stmt|;
name|left
operator|=
name|len
operator|-
literal|2
expr_stmt|;
if|if
condition|(
name|left
operator|%
literal|16
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid ms key len %lu\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|plen
operator|=
name|left
expr_stmt|;
name|ppos
operator|=
name|plain
operator|=
name|malloc
argument_list|(
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
while|while
condition|(
name|left
operator|>
literal|0
condition|)
block|{
comment|/* b(1) = MD5(Secret + Request-Authenticator + Salt) 		 * b(i) = MD5(Secret + c(i - 1)) for i> 1 */
name|MD5Init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|req_authenticator
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|key
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Salt */
name|first
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|pos
operator|-
name|MD5_MAC_LEN
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|hash
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MD5_MAC_LEN
condition|;
name|i
operator|++
control|)
operator|*
name|ppos
operator|++
operator|=
operator|*
name|pos
operator|++
operator|^
name|hash
index|[
name|i
index|]
expr_stmt|;
name|left
operator|-=
name|MD5_MAC_LEN
expr_stmt|;
block|}
if|if
condition|(
name|plain
index|[
literal|0
index|]
operator|>
name|plen
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to decrypt MPPE key\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|malloc
argument_list|(
name|plain
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
name|res
argument_list|,
name|plain
operator|+
literal|1
argument_list|,
name|plain
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|reslen
condition|)
operator|*
name|reslen
operator|=
name|plain
index|[
literal|0
index|]
expr_stmt|;
name|free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|encrypt_ms_key
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
name|u16
name|salt
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_authenticator
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
name|u8
modifier|*
name|ebuf
parameter_list|,
name|size_t
modifier|*
name|elen
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|first
init|=
literal|1
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|,
name|saltbuf
index|[
literal|2
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|MD5_CTX
name|context
decl_stmt|;
name|saltbuf
index|[
literal|0
index|]
operator|=
name|salt
operator|>>
literal|8
expr_stmt|;
name|saltbuf
index|[
literal|1
index|]
operator|=
name|salt
expr_stmt|;
name|len
operator|=
literal|1
operator|+
name|key_len
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|0x0f
condition|)
block|{
name|len
operator|=
operator|(
name|len
operator|&
literal|0xf0
operator|)
operator|+
literal|16
expr_stmt|;
block|}
name|memset
argument_list|(
name|ebuf
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ebuf
index|[
literal|0
index|]
operator|=
name|key_len
expr_stmt|;
name|memcpy
argument_list|(
name|ebuf
operator|+
literal|1
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
operator|*
name|elen
operator|=
name|len
expr_stmt|;
name|pos
operator|=
name|ebuf
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
comment|/* b(1) = MD5(Secret + Request-Authenticator + Salt) 		 * b(i) = MD5(Secret + c(i - 1)) for i> 1 */
name|MD5Init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|req_authenticator
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|saltbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|saltbuf
argument_list|)
argument_list|)
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|pos
operator|-
name|MD5_MAC_LEN
argument_list|,
name|MD5_MAC_LEN
argument_list|)
expr_stmt|;
block|}
name|MD5Final
argument_list|(
name|hash
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MD5_MAC_LEN
condition|;
name|i
operator|++
control|)
operator|*
name|pos
operator|++
operator|^=
name|hash
index|[
name|i
index|]
expr_stmt|;
name|len
operator|-=
name|MD5_MAC_LEN
expr_stmt|;
block|}
block|}
end_function

begin_function
name|struct
name|radius_ms_mppe_keys
modifier|*
name|radius_msg_get_ms_keys
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|sent_msg
parameter_list|,
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
name|u8
modifier|*
name|key
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|struct
name|radius_ms_mppe_keys
modifier|*
name|keys
decl_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
operator|||
name|sent_msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|keys
operator|=
operator|(
expr|struct
name|radius_ms_mppe_keys
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|keys
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|=
name|radius_msg_get_vendor_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_VENDOR_ID_MICROSOFT
argument_list|,
name|RADIUS_VENDOR_ATTR_MS_MPPE_SEND_KEY
argument_list|,
operator|&
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
name|keys
operator|->
name|send
operator|=
name|decrypt_ms_key
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
operator|&
name|keys
operator|->
name|send_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
name|key
operator|=
name|radius_msg_get_vendor_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_VENDOR_ID_MICROSOFT
argument_list|,
name|RADIUS_VENDOR_ATTR_MS_MPPE_RECV_KEY
argument_list|,
operator|&
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
name|keys
operator|->
name|recv
operator|=
name|decrypt_ms_key
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
operator|&
name|keys
operator|->
name|recv_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
return|return
name|keys
return|;
block|}
end_function

begin_function
name|struct
name|radius_ms_mppe_keys
modifier|*
name|radius_msg_get_cisco_keys
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|sent_msg
parameter_list|,
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
name|u8
modifier|*
name|key
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|struct
name|radius_ms_mppe_keys
modifier|*
name|keys
decl_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
operator|||
name|sent_msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|keys
operator|=
operator|(
expr|struct
name|radius_ms_mppe_keys
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|keys
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|=
name|radius_msg_get_vendor_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_VENDOR_ID_CISCO
argument_list|,
name|RADIUS_CISCO_AV_PAIR
argument_list|,
operator|&
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|&&
name|keylen
operator|==
literal|51
operator|&&
name|memcmp
argument_list|(
name|key
argument_list|,
literal|"leap:session-key="
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
condition|)
block|{
name|keys
operator|->
name|recv
operator|=
name|decrypt_ms_key
argument_list|(
name|key
operator|+
literal|17
argument_list|,
name|keylen
operator|-
literal|17
argument_list|,
name|sent_msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
operator|&
name|keys
operator|->
name|recv_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
return|return
name|keys
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_add_mppe_keys
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_authenticator
parameter_list|,
specifier|const
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|send_key
parameter_list|,
name|size_t
name|send_key_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|recv_key
parameter_list|,
name|size_t
name|recv_key_len
parameter_list|)
block|{
name|struct
name|radius_attr_hdr
modifier|*
name|attr
decl_stmt|;
name|u32
name|vendor_id
init|=
name|htonl
argument_list|(
name|RADIUS_VENDOR_ID_MICROSOFT
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
name|struct
name|radius_attr_vendor
modifier|*
name|vhdr
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|elen
decl_stmt|;
name|int
name|hlen
decl_stmt|;
name|u16
name|salt
decl_stmt|;
name|hlen
operator|=
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|vhdr
argument_list|)
operator|+
literal|2
expr_stmt|;
comment|/* MS-MPPE-Send-Key */
name|buf
operator|=
name|malloc
argument_list|(
name|hlen
operator|+
name|send_key_len
operator|+
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|pos
operator|=
name|buf
expr_stmt|;
name|memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|vendor_id
argument_list|,
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|vhdr
operator|=
operator|(
expr|struct
name|radius_attr_vendor
operator|*
operator|)
name|pos
expr_stmt|;
name|vhdr
operator|->
name|vendor_type
operator|=
name|RADIUS_VENDOR_ATTR_MS_MPPE_SEND_KEY
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|vhdr
operator|+
literal|1
operator|)
expr_stmt|;
name|salt
operator|=
name|random
argument_list|()
operator||
literal|0x8000
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|salt
operator|>>
literal|8
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|salt
expr_stmt|;
name|encrypt_ms_key
argument_list|(
name|send_key
argument_list|,
name|send_key_len
argument_list|,
name|salt
argument_list|,
name|req_authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
name|pos
argument_list|,
operator|&
name|elen
argument_list|)
expr_stmt|;
name|vhdr
operator|->
name|vendor_length
operator|=
name|hlen
operator|+
name|elen
operator|-
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|attr
operator|=
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_VENDOR_SPECIFIC
argument_list|,
name|buf
argument_list|,
name|hlen
operator|+
name|elen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/* MS-MPPE-Recv-Key */
name|buf
operator|=
name|malloc
argument_list|(
name|hlen
operator|+
name|send_key_len
operator|+
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|pos
operator|=
name|buf
expr_stmt|;
name|memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|vendor_id
argument_list|,
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|vhdr
operator|=
operator|(
expr|struct
name|radius_attr_vendor
operator|*
operator|)
name|pos
expr_stmt|;
name|vhdr
operator|->
name|vendor_type
operator|=
name|RADIUS_VENDOR_ATTR_MS_MPPE_RECV_KEY
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|vhdr
operator|+
literal|1
operator|)
expr_stmt|;
name|salt
operator|^=
literal|1
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|salt
operator|>>
literal|8
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|salt
expr_stmt|;
name|encrypt_ms_key
argument_list|(
name|recv_key
argument_list|,
name|recv_key_len
argument_list|,
name|salt
argument_list|,
name|req_authenticator
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|,
name|pos
argument_list|,
operator|&
name|elen
argument_list|)
expr_stmt|;
name|vhdr
operator|->
name|vendor_length
operator|=
name|hlen
operator|+
name|elen
operator|-
sizeof|sizeof
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|attr
operator|=
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_VENDOR_SPECIFIC
argument_list|,
name|buf
argument_list|,
name|hlen
operator|+
name|elen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Add User-Password attribute to a RADIUS message and encrypt it as specified  * in RFC 2865, Chap. 5.2 */
end_comment

begin_function
name|struct
name|radius_attr_hdr
modifier|*
name|radius_msg_add_attr_user_password
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|u8
modifier|*
name|secret
parameter_list|,
name|size_t
name|secret_len
parameter_list|)
block|{
name|u8
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|int
name|padlen
decl_stmt|,
name|i
decl_stmt|,
name|pos
decl_stmt|;
name|MD5_CTX
name|context
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|u8
name|hash
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|data_len
operator|>
literal|128
condition|)
return|return
name|NULL
return|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|buf_len
operator|=
name|data_len
expr_stmt|;
name|padlen
operator|=
name|data_len
operator|%
literal|16
expr_stmt|;
if|if
condition|(
name|padlen
condition|)
block|{
name|padlen
operator|=
literal|16
operator|-
name|padlen
expr_stmt|;
name|memset
argument_list|(
name|buf
operator|+
name|data_len
argument_list|,
literal|0
argument_list|,
name|padlen
argument_list|)
expr_stmt|;
name|buf_len
operator|+=
name|padlen
expr_stmt|;
block|}
name|MD5Init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|msg
operator|->
name|hdr
operator|->
name|authenticator
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|hash
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|^=
name|hash
index|[
name|i
index|]
expr_stmt|;
name|pos
operator|=
literal|16
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|buf_len
condition|)
block|{
name|MD5Init
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
name|secret
argument_list|,
name|secret_len
argument_list|)
expr_stmt|;
name|MD5Update
argument_list|(
operator|&
name|context
argument_list|,
operator|&
name|buf
index|[
name|pos
operator|-
literal|16
index|]
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|MD5Final
argument_list|(
name|hash
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|pos
operator|+
name|i
index|]
operator|^=
name|hash
index|[
name|i
index|]
expr_stmt|;
name|pos
operator|+=
literal|16
expr_stmt|;
block|}
return|return
name|radius_msg_add_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_USER_PASSWORD
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_get_attr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|type
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|NULL
decl_stmt|;
name|size_t
name|dlen
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msg
operator|->
name|attrs
index|[
name|i
index|]
operator|->
name|type
operator|==
name|type
condition|)
block|{
name|attr
operator|=
name|msg
operator|->
name|attrs
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|attr
condition|)
return|return
operator|-
literal|1
return|;
name|dlen
operator|=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
name|memcpy
argument_list|(
name|buf
argument_list|,
operator|(
name|attr
operator|+
literal|1
operator|)
argument_list|,
name|dlen
operator|>
name|len
condition|?
name|len
else|:
name|dlen
argument_list|)
expr_stmt|;
return|return
name|dlen
return|;
block|}
end_function

begin_function
name|int
name|radius_msg_get_attr_ptr
parameter_list|(
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|type
parameter_list|,
name|u8
modifier|*
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|radius_attr_hdr
modifier|*
name|attr
init|=
name|NULL
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|msg
operator|->
name|attr_used
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msg
operator|->
name|attrs
index|[
name|i
index|]
operator|->
name|type
operator|==
name|type
condition|)
block|{
name|attr
operator|=
name|msg
operator|->
name|attrs
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|attr
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|buf
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|attr
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|len
operator|=
name|attr
operator|->
name|length
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


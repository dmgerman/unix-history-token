begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant  * Copyright (c) 2003-2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  *  * This file implements functions for registering and unregistering  * %wpa_supplicant interfaces. In addition, this file contains number of  * functions for managing network connections.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eapol_sm.h"
end_include

begin_include
include|#
directive|include
file|"eap.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface_dbus.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"version.h"
end_include

begin_include
include|#
directive|include
file|"preauth.h"
end_include

begin_include
include|#
directive|include
file|"pmksa_cache.h"
end_include

begin_include
include|#
directive|include
file|"wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"mlme.h"
end_include

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_version
init|=
literal|"wpa_supplicant v"
name|VERSION_STR
literal|"\n"
literal|"Copyright (c) 2003-2008, Jouni Malinen<j@w1.fi> and contributors"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_license
init|=
literal|"This program is free software. You can distribute it and/or modify it\n"
literal|"under the terms of the GNU General Public License version 2.\n"
literal|"\n"
literal|"Alternatively, this software may be distributed under the terms of the\n"
literal|"BSD license. See README and COPYING for more details.\n"
ifdef|#
directive|ifdef
name|EAP_TLS_OPENSSL
literal|"\nThis product includes software developed by the OpenSSL Project\n"
literal|"for use in the OpenSSL Toolkit (http://www.openssl.org/)\n"
endif|#
directive|endif
comment|/* EAP_TLS_OPENSSL */
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
end_ifndef

begin_comment
comment|/* Long text divided into parts in order to fit in C89 strings size limits. */
end_comment

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license1
init|=
literal|"This program is free software; you can redistribute it and/or modify\n"
literal|"it under the terms of the GNU General Public License version 2 as\n"
literal|"published by the Free Software Foundation.\n"
literal|"\n"
literal|"This program is distributed in the hope that it will be useful,\n"
literal|"but WITHOUT ANY WARRANTY; without even the implied warranty of\n"
literal|"MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n"
literal|"GNU General Public License for more details.\n"
literal|"\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license2
init|=
literal|"You should have received a copy of the GNU General Public License\n"
literal|"along with this program; if not, write to the Free Software\n"
literal|"Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA\n"
literal|"\n"
literal|"Alternatively, this software may be distributed under the terms of the\n"
literal|"BSD license.\n"
literal|"\n"
literal|"Redistribution and use in source and binary forms, with or without\n"
literal|"modification, are permitted provided that the following conditions are\n"
literal|"met:\n"
literal|"\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license3
init|=
literal|"1. Redistributions of source code must retain the above copyright\n"
literal|"   notice, this list of conditions and the following disclaimer.\n"
literal|"\n"
literal|"2. Redistributions in binary form must reproduce the above copyright\n"
literal|"   notice, this list of conditions and the following disclaimer in the\n"
literal|"   documentation and/or other materials provided with the distribution.\n"
literal|"\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license4
init|=
literal|"3. Neither the name(s) of the above-listed copyright holder(s) nor the\n"
literal|"   names of its contributors may be used to endorse or promote products\n"
literal|"   derived from this software without specific prior written permission.\n"
literal|"\n"
literal|"THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n"
literal|"\"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n"
literal|"LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n"
literal|"A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license5
init|=
literal|"OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n"
literal|"SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n"
literal|"LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n"
literal|"DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n"
literal|"THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n"
literal|"(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n"
literal|"OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n"
literal|"\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_STDOUT_DEBUG */
end_comment

begin_decl_stmt
specifier|extern
name|struct
name|wpa_driver_ops
modifier|*
name|wpa_supplicant_drivers
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_show_keys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_timestamp
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|wpa_supplicant_scan
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|defined
argument_list|(
name|IEEE8021X_EAPOL
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|CONFIG_NO_WPA
argument_list|)
end_if

begin_function
specifier|static
name|u8
modifier|*
name|wpa_alloc_eapol
parameter_list|(
specifier|const
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|u16
name|data_len
parameter_list|,
name|size_t
modifier|*
name|msg_len
parameter_list|,
name|void
modifier|*
modifier|*
name|data_pos
parameter_list|)
block|{
name|struct
name|ieee802_1x_hdr
modifier|*
name|hdr
decl_stmt|;
operator|*
name|msg_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|data_len
expr_stmt|;
name|hdr
operator|=
name|os_malloc
argument_list|(
operator|*
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|hdr
operator|->
name|version
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|eapol_version
expr_stmt|;
name|hdr
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
name|os_memcpy
argument_list|(
name|hdr
operator|+
literal|1
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
else|else
name|os_memset
argument_list|(
name|hdr
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_pos
condition|)
operator|*
name|data_pos
operator|=
name|hdr
operator|+
literal|1
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
name|hdr
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_ether_send - Send Ethernet frame  * @wpa_s: Pointer to wpa_supplicant data  * @dest: Destination MAC address  * @proto: Ethertype in host byte order  * @buf: Frame payload starting from IEEE 802.1X header  * @len: Frame payload length  * Returns:>=0 on success,<0 on failure  */
end_comment

begin_function
specifier|static
name|int
name|wpa_ether_send
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dest
parameter_list|,
name|u16
name|proto
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|l2
condition|)
block|{
return|return
name|l2_packet_send
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|,
name|dest
argument_list|,
name|proto
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
return|return
name|wpa_drv_send_eapol
argument_list|(
name|wpa_s
argument_list|,
name|dest
argument_list|,
name|proto
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IEEE8021X_EAPOL || !CONFIG_NO_WPA */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
end_ifdef

begin_comment
comment|/**  * wpa_supplicant_eapol_send - Send IEEE 802.1X EAPOL packet to Authenticator  * @ctx: Pointer to wpa_supplicant data (wpa_s)  * @type: IEEE 802.1X packet type (IEEE802_1X_TYPE_*)  * @buf: EAPOL payload (after IEEE 802.1X header)  * @len: EAPOL payload length  * Returns:>=0 on success,<0 on failure  *  * This function adds Ethernet and IEEE 802.1X header and sends the EAPOL frame  * to the current Authenticator.  */
end_comment

begin_function
specifier|static
name|int
name|wpa_supplicant_eapol_send
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|type
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|u8
modifier|*
name|msg
decl_stmt|,
modifier|*
name|dst
decl_stmt|,
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|size_t
name|msglen
decl_stmt|;
name|int
name|res
decl_stmt|;
comment|/* TODO: could add l2_packet_sendmsg that allows fragments to avoid 	 * extra copy here */
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_PSK
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
condition|)
block|{
comment|/* Current SSID is not using IEEE 802.1X/EAP, so drop possible 		 * EAPOL frames (mainly, EAPOL-Start) from EAPOL state 		 * machines. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: drop TX EAPOL in non-IEEE 802.1X "
literal|"mode (type=%d len=%lu)"
argument_list|,
name|type
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|pmksa_cache_get_current
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
operator|&&
name|type
operator|==
name|IEEE802_1X_TYPE_EAPOL_START
condition|)
block|{
comment|/* Trying to use PMKSA caching - do not send EAPOL-Start frames 		 * since they will trigger full EAPOL authentication. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKSA caching - do not send "
literal|"EAPOL-Start"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSSID not set when trying to send an "
literal|"EAPOL frame"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|dst
operator|=
name|bssid
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Using current BSSID "
name|MACSTR
literal|" from the driver as the EAPOL destination"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dst
operator|=
name|wpa_s
operator|->
name|last_eapol_src
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Using the source address of the"
literal|" last received EAPOL frame "
name|MACSTR
literal|" as "
literal|"the EAPOL destination"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* BSSID was already set (from (Re)Assoc event, so use it as 		 * the EAPOL destination. */
name|dst
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
block|}
name|msg
operator|=
name|wpa_alloc_eapol
argument_list|(
name|wpa_s
argument_list|,
name|type
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|msglen
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TX EAPOL"
argument_list|,
name|msg
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
name|res
operator|=
name|wpa_ether_send
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|msg
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_eapol_set_wep_key - set WEP key for the driver  * @ctx: Pointer to wpa_supplicant data (wpa_s)  * @unicast: 1 = individual unicast key, 0 = broadcast key  * @keyidx: WEP key index (0..3)  * @key: Pointer to key data  * @keylen: Key length in bytes  * Returns: 0 on success or< 0 on error.  */
end_comment

begin_function
specifier|static
name|int
name|wpa_eapol_set_wep_key
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|unicast
parameter_list|,
name|int
name|keyidx
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
name|int
name|cipher
init|=
operator|(
name|keylen
operator|==
literal|5
operator|)
condition|?
name|WPA_CIPHER_WEP40
else|:
name|WPA_CIPHER_WEP104
decl_stmt|;
if|if
condition|(
name|unicast
condition|)
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|cipher
expr_stmt|;
else|else
name|wpa_s
operator|->
name|group_cipher
operator|=
name|cipher
expr_stmt|;
block|}
return|return
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_WEP
argument_list|,
name|unicast
condition|?
name|wpa_s
operator|->
name|bssid
else|:
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|keyidx
argument_list|,
name|unicast
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_aborted_cached
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_sm_aborted_cached
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IEEE8021X_EAPOL */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|IEEE8021X_EAPOL
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|CONFIG_NO_WPA
argument_list|)
end_if

begin_function
specifier|static
name|void
name|wpa_supplicant_set_config_blob
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|wpa_config_blob
modifier|*
name|blob
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_config_set_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|blob
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|wpa_config_blob
modifier|*
name|wpa_supplicant_get_config_blob
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
return|return
name|wpa_config_get_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|name
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(IEEE8021X_EAPOL) || !defined(CONFIG_NO_WPA) */
end_comment

begin_comment
comment|/* Configure default/group WEP key for static WEP */
end_comment

begin_function
specifier|static
name|int
name|wpa_set_wep_key
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|set_tx
parameter_list|,
name|int
name|keyidx
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
return|return
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_WEP
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|keyidx
argument_list|,
name|set_tx
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_set_wpa_none_key
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|u8
name|key
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|wpa_alg
name|alg
decl_stmt|;
name|u8
name|seq
index|[
literal|6
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
comment|/* IBSS/WPA-None uses only one key (Group) for both receiving and 	 * sending unicast and multicast packets. */
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|IEEE80211_MODE_IBSS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: Invalid mode %d (not IBSS/ad-hoc) "
literal|"for WPA-None"
argument_list|,
name|ssid
operator|->
name|mode
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: No PSK configured for WPA-None"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|wpa_s
operator|->
name|group_cipher
condition|)
block|{
case|case
name|WPA_CIPHER_CCMP
case|:
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|keylen
operator|=
literal|16
expr_stmt|;
name|alg
operator|=
name|WPA_ALG_CCMP
expr_stmt|;
break|break;
case|case
name|WPA_CIPHER_TKIP
case|:
comment|/* WPA-None uses the same Michael MIC key for both TX and RX */
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|16
operator|+
literal|8
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
operator|+
literal|16
operator|+
literal|8
argument_list|,
name|ssid
operator|->
name|psk
operator|+
literal|16
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|keylen
operator|=
literal|32
expr_stmt|;
name|alg
operator|=
name|WPA_ALG_TKIP
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: Invalid group cipher %d for "
literal|"WPA-None"
argument_list|,
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: should actually remember the previously used seq#, both for TX 	 * and RX from each STA.. */
return|return
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|alg
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|seq
argument_list|,
literal|6
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_notify_eapol_done
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: EAPOL processing complete"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X
condition|)
block|{
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_4WAY_HANDSHAKE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_COMPLETED
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IEEE8021X_EAPOL */
end_comment

begin_comment
comment|/**  * wpa_blacklist_get - Get the blacklist entry for a BSSID  * @wpa_s: Pointer to wpa_supplicant data  * @bssid: BSSID  * Returns: Matching blacklist entry for the BSSID or %NULL if not found  */
end_comment

begin_function
name|struct
name|wpa_blacklist
modifier|*
name|wpa_blacklist_get
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|;
name|e
operator|=
name|wpa_s
operator|->
name|blacklist
expr_stmt|;
while|while
condition|(
name|e
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|e
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|e
return|;
name|e
operator|=
name|e
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_blacklist_add - Add an BSSID to the blacklist  * @wpa_s: Pointer to wpa_supplicant data  * @bssid: BSSID to be added to the blacklist  * Returns: 0 on success, -1 on failure  *  * This function adds the specified BSSID to the blacklist or increases the  * blacklist count if the BSSID was already listed. It should be called when  * an association attempt fails either due to the selected BSS rejecting  * association or due to timeout.  *  * This blacklist is used to force %wpa_supplicant to go through all available  * BSSes before retrying to associate with an BSS that rejected or timed out  * association. It does not prevent the listed BSS from being used; it only  * changes the order in which they are tried.  */
end_comment

begin_function
name|int
name|wpa_blacklist_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|;
name|e
operator|=
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
condition|)
block|{
name|e
operator|->
name|count
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSSID "
name|MACSTR
literal|" blacklist count "
literal|"incremented to %d"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
name|e
operator|->
name|count
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|e
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|e
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|e
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|e
operator|->
name|count
operator|=
literal|1
expr_stmt|;
name|e
operator|->
name|next
operator|=
name|wpa_s
operator|->
name|blacklist
expr_stmt|;
name|wpa_s
operator|->
name|blacklist
operator|=
name|e
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Added BSSID "
name|MACSTR
literal|" into blacklist"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_blacklist_del
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|e
operator|=
name|wpa_s
operator|->
name|blacklist
expr_stmt|;
while|while
condition|(
name|e
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|e
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|blacklist
operator|=
name|e
operator|->
name|next
expr_stmt|;
block|}
else|else
block|{
name|prev
operator|->
name|next
operator|=
name|e
operator|->
name|next
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Removed BSSID "
name|MACSTR
literal|" from "
literal|"blacklist"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|e
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|prev
operator|=
name|e
expr_stmt|;
name|e
operator|=
name|e
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_blacklist_clear - Clear the blacklist of all entries  * @wpa_s: Pointer to wpa_supplicant data  */
end_comment

begin_function
name|void
name|wpa_blacklist_clear
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|e
operator|=
name|wpa_s
operator|->
name|blacklist
expr_stmt|;
name|wpa_s
operator|->
name|blacklist
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|e
condition|)
block|{
name|prev
operator|=
name|e
expr_stmt|;
name|e
operator|=
name|e
operator|->
name|next
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Removed BSSID "
name|MACSTR
literal|" from "
literal|"blacklist (clear)"
argument_list|,
name|MAC2STR
argument_list|(
name|prev
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_req_scan - Schedule a scan for neighboring access points  * @wpa_s: Pointer to wpa_supplicant data  * @sec: Number of seconds after which to scan  * @usec: Number of microseconds after which to scan  *  * This function is used to schedule a scan for neighboring access points after  * the specified time.  */
end_comment

begin_function
name|void
name|wpa_supplicant_req_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|sec
parameter_list|,
name|int
name|usec
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Setting scan request: %d sec %d usec"
argument_list|,
name|sec
argument_list|,
name|usec
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
argument_list|,
name|usec
argument_list|,
name|wpa_supplicant_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_cancel_scan - Cancel a scheduled scan request  * @wpa_s: Pointer to wpa_supplicant data  *  * This function is used to cancel a scan request scheduled with  * wpa_supplicant_req_scan().  */
end_comment

begin_function
name|void
name|wpa_supplicant_cancel_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Cancelling scan request"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
specifier|const
name|u8
modifier|*
name|bssid
init|=
name|wpa_s
operator|->
name|bssid
decl_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_bssid
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Authentication with "
name|MACSTR
literal|" timed out."
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
name|wpa_sm_notify_disassoc
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|wpa_supplicant_disassociate
argument_list|(
name|wpa_s
argument_list|,
name|REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_req_auth_timeout - Schedule a timeout for authentication  * @wpa_s: Pointer to wpa_supplicant data  * @sec: Number of seconds after which to time out authentication  * @usec: Number of microseconds after which to time out authentication  *  * This function is used to schedule a timeout for the current authentication  * attempt.  */
end_comment

begin_function
name|void
name|wpa_supplicant_req_auth_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|sec
parameter_list|,
name|int
name|usec
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|driver
operator|&&
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|driver
operator|->
name|name
argument_list|,
literal|"wired"
argument_list|)
operator|==
literal|0
condition|)
return|return;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Setting authentication timeout: %d sec "
literal|"%d usec"
argument_list|,
name|sec
argument_list|,
name|usec
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
argument_list|,
name|usec
argument_list|,
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_cancel_auth_timeout - Cancel authentication timeout  * @wpa_s: Pointer to wpa_supplicant data  *  * This function is used to cancel authentication timeout scheduled with  * wpa_supplicant_req_auth_timeout() and it is called when authentication has  * been completed.  */
end_comment

begin_function
name|void
name|wpa_supplicant_cancel_auth_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Cancelling authentication timeout"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_blacklist_del
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_initiate_eapol - Configure EAPOL state machine  * @wpa_s: Pointer to wpa_supplicant data  *  * This function is used to configure EAPOL state machine based on the selected  * authentication mode.  */
end_comment

begin_function
name|void
name|wpa_supplicant_initiate_eapol
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|struct
name|eapol_config
name|eapol_conf
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_eap_fail
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
name|eapol_sm_notify_portControl
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|ForceAuthorized
argument_list|)
expr_stmt|;
else|else
name|eapol_sm_notify_portControl
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|Auto
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|eapol_conf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|eapol_conf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
name|eapol_conf
operator|.
name|accept_802_1x_keys
operator|=
literal|1
expr_stmt|;
name|eapol_conf
operator|.
name|required_keys
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|eapol_flags
operator|&
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
condition|)
block|{
name|eapol_conf
operator|.
name|required_keys
operator||=
name|EAPOL_REQUIRE_KEY_UNICAST
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|eapol_flags
operator|&
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
condition|)
block|{
name|eapol_conf
operator|.
name|required_keys
operator||=
name|EAPOL_REQUIRE_KEY_BROADCAST
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|&&
name|wpa_s
operator|->
name|driver
operator|&&
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|driver
operator|->
name|name
argument_list|,
literal|"wired"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|eapol_conf
operator|.
name|required_keys
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
condition|)
name|eapol_conf
operator|.
name|fast_reauth
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|fast_reauth
expr_stmt|;
name|eapol_conf
operator|.
name|workaround
operator|=
name|ssid
operator|->
name|eap_workaround
expr_stmt|;
name|eapol_conf
operator|.
name|eap_disabled
operator|=
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_IEEE8021X
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|ssid
argument_list|,
operator|&
name|eapol_conf
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_non_wpa_policy - Set WPA parameters to non-WPA mode  * @wpa_s: Pointer to wpa_supplicant data  * @ssid: Configuration data for the network  *  * This function is used to configure WPA state machine and related parameters  * to a mode where WPA is not enabled. This is called as part of the  * authentication configuration when the selected network does not use WPA.  */
end_comment

begin_function
name|void
name|wpa_supplicant_set_non_wpa_policy
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
expr_stmt|;
else|else
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_NONE
expr_stmt|;
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
name|wpa_s
operator|->
name|mgmt_group_cipher
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|>
literal|5
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_WEP104
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP104
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|>
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_WEP40
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP40
expr_stmt|;
break|break;
block|}
block|}
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_KEY_MGMT
argument_list|,
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_PAIRWISE
argument_list|,
name|wpa_s
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_GROUP
argument_list|,
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_MGMT_GROUP
argument_list|,
name|wpa_s
operator|->
name|mgmt_group_cipher
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|pmksa_cache_clear_current
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_cleanup
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|scard_deinit
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scard
operator|=
name|NULL
expr_stmt|;
name|wpa_sm_set_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_register_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|l2_br
condition|)
block|{
name|l2_packet_deinit
argument_list|(
name|wpa_s
operator|->
name|l2_br
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2_br
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|ctrl_iface
condition|)
block|{
name|wpa_supplicant_ctrl_iface_deinit
argument_list|(
name|wpa_s
operator|->
name|ctrl_iface
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ctrl_iface
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|!=
name|NULL
condition|)
block|{
name|wpa_config_free
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|=
name|NULL
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|confname
operator|=
name|NULL
expr_stmt|;
name|wpa_sm_set_eapol
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_deinit
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|eapol
operator|=
name|NULL
expr_stmt|;
name|rsn_preauth_deinit
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|pmksa_candidate_free
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|wpa_sm_deinit
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wpa
operator|=
name|NULL
expr_stmt|;
name|wpa_blacklist_clear
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|scan_results
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_results
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|num_scan_results
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ieee80211_sta_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_clear_keys - Clear keys configured for the driver  * @wpa_s: Pointer to wpa_supplicant data  * @addr: Previously used BSSID or %NULL if not available  *  * This function clears the encryption keys that has been previously configured  * for the driver.  */
end_comment

begin_function
name|void
name|wpa_clear_keys
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|u8
modifier|*
name|bcast
init|=
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|keys_cleared
condition|)
block|{
comment|/* Some drivers (e.g., ndiswrapper& NDIS drivers) seem to have 		 * timing issues with keys being cleared just before new keys 		 * are set or just after association or something similar. This 		 * shows up in group key handshake failing often because of the 		 * client not receiving the first encrypted packets correctly. 		 * Skipping some of the extra key clearing steps seems to help 		 * in completing group key handshake more reliably. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No keys have been configured - "
literal|"skip key clearing"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* MLME-DELETEKEYS.request */
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|bcast
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|bcast
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|bcast
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|bcast
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* MLME-SETPROTECTION.request(None) */
name|wpa_drv_mlme_setprotection
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|MLME_SETPROTECTION_PROTECT_TYPE_NONE
argument_list|,
name|MLME_SETPROTECTION_KEY_TYPE_PAIRWISE
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|keys_cleared
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_state_txt - Get the connection state name as a text string  * @state: State (wpa_state; WPA_*)  * Returns: The state name as a printable text string  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|wpa_supplicant_state_txt
parameter_list|(
name|int
name|state
parameter_list|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|WPA_DISCONNECTED
case|:
return|return
literal|"DISCONNECTED"
return|;
case|case
name|WPA_INACTIVE
case|:
return|return
literal|"INACTIVE"
return|;
case|case
name|WPA_SCANNING
case|:
return|return
literal|"SCANNING"
return|;
case|case
name|WPA_ASSOCIATING
case|:
return|return
literal|"ASSOCIATING"
return|;
case|case
name|WPA_ASSOCIATED
case|:
return|return
literal|"ASSOCIATED"
return|;
case|case
name|WPA_4WAY_HANDSHAKE
case|:
return|return
literal|"4WAY_HANDSHAKE"
return|;
case|case
name|WPA_GROUP_HANDSHAKE
case|:
return|return
literal|"GROUP_HANDSHAKE"
return|;
case|case
name|WPA_COMPLETED
case|:
return|return
literal|"COMPLETED"
return|;
default|default:
return|return
literal|"UNKNOWN"
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_state - Set current connection state  * @wpa_s: Pointer to wpa_supplicant data  * @state: The new connection state  *  * This function is called whenever the connection state changes, e.g.,  * association is completed for WPA/WPA2 4-Way Handshake is started.  */
end_comment

begin_function
name|void
name|wpa_supplicant_set_state
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|wpa_states
name|state
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"State: %s -> %s"
argument_list|,
name|wpa_supplicant_state_txt
argument_list|(
name|wpa_s
operator|->
name|wpa_state
argument_list|)
argument_list|,
name|wpa_supplicant_state_txt
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_dbus_notify_state_change
argument_list|(
name|wpa_s
argument_list|,
name|state
argument_list|,
name|wpa_s
operator|->
name|wpa_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|WPA_COMPLETED
operator|&&
name|wpa_s
operator|->
name|new_connection
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_CTRL_IFACE
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|CONFIG_NO_STDOUT_DEBUG
argument_list|)
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_CONNECTED
literal|"- Connection to "
name|MACSTR
literal|" completed %s [id=%d id_str=%s]"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_s
operator|->
name|reassociated_connection
condition|?
literal|"(reauth)"
else|:
literal|"(auth)"
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|id
else|:
operator|-
literal|1
argument_list|,
name|ssid
operator|&&
name|ssid
operator|->
name|id_str
condition|?
name|ssid
operator|->
name|id_str
else|:
literal|""
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_CTRL_IFACE || !CONFIG_NO_STDOUT_DEBUG */
name|wpa_s
operator|->
name|new_connection
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|reassociated_connection
operator|=
literal|1
expr_stmt|;
name|wpa_drv_set_operstate
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|WPA_DISCONNECTED
operator|||
name|state
operator|==
name|WPA_ASSOCIATING
operator|||
name|state
operator|==
name|WPA_ASSOCIATED
condition|)
block|{
name|wpa_s
operator|->
name|new_connection
operator|=
literal|1
expr_stmt|;
name|wpa_drv_set_operstate
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|wpa_state
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_get_state - Get the connection state  * @wpa_s: Pointer to wpa_supplicant data  * Returns: The current connection state (WPA_*)  */
end_comment

begin_function
name|wpa_states
name|wpa_supplicant_get_state
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
return|return
name|wpa_s
operator|->
name|wpa_state
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_terminate
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_TERMINATING
literal|"- signal %d "
literal|"received"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
block|}
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_clear_status
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|mgmt_group_cipher
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|key_mgmt
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|wpa_state
operator|=
name|WPA_DISCONNECTED
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_reload_configuration - Reload configuration data  * @wpa_s: Pointer to wpa_supplicant data  * Returns: 0 on success or -1 if configuration parsing failed  *  * This function can be used to request that the configuration data is reloaded  * (e.g., after configuration file change). This function is reloading  * configuration only for one interface, so this may need to be called multiple  * times if %wpa_supplicant is controlling multiple interfaces and all  * interfaces need reconfiguration.  */
end_comment

begin_function
name|int
name|wpa_supplicant_reload_configuration
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_config
modifier|*
name|conf
decl_stmt|;
name|int
name|reconf_ctrl
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|confname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|conf
operator|=
name|wpa_config_read
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to parse the configuration "
literal|"file '%s' - exiting"
argument_list|,
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|reconf_ctrl
operator|=
operator|!
operator|!
name|conf
operator|->
name|ctrl_interface
operator|!=
operator|!
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
operator|||
operator|(
name|conf
operator|->
name|ctrl_interface
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
operator|&&
name|os_strcmp
argument_list|(
name|conf
operator|->
name|ctrl_interface
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|reconf_ctrl
operator|&&
name|wpa_s
operator|->
name|ctrl_iface
condition|)
block|{
name|wpa_supplicant_ctrl_iface_deinit
argument_list|(
name|wpa_s
operator|->
name|ctrl_iface
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ctrl_iface
operator|=
name|NULL
expr_stmt|;
block|}
name|eapol_sm_invalidate_cached_session
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * TODO: should notify EAPOL SM about changes in opensc_engine_path, 	 * pkcs11_engine_path, pkcs11_module_path. 	 */
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_PSK
condition|)
block|{
comment|/* 		 * Clear forced success to clear EAP state for next 		 * authentication. 		 */
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_sm_set_fast_reauth
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|fast_reauth
argument_list|)
expr_stmt|;
name|rsn_preauth_deinit
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|wpa_config_free
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|=
name|conf
expr_stmt|;
if|if
condition|(
name|reconf_ctrl
condition|)
name|wpa_s
operator|->
name|ctrl_iface
operator|=
name|wpa_supplicant_ctrl_iface_init
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_clear_status
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Reconfiguration completed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_reconfig
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Signal %d received - reconfiguring"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_supplicant_reload_configuration
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_gen_assoc_event
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|ssid
operator|=
name|wpa_supplicant_get_ssid
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_supplicant_initiate_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Already associated with a configured network - "
literal|"generating associated event"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_ASSOC
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_scan
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|enabled
decl_stmt|,
name|scan_req
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|disconnected
operator|&&
operator|!
name|wpa_s
operator|->
name|scan_req
condition|)
return|return;
name|enabled
operator|=
literal|0
expr_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|ssid
condition|)
block|{
if|if
condition|(
operator|!
name|ssid
operator|->
name|disabled
condition|)
block|{
name|enabled
operator|++
expr_stmt|;
break|break;
block|}
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|enabled
operator|&&
operator|!
name|wpa_s
operator|->
name|scan_req
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No enabled networks - do not scan"
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_INACTIVE
argument_list|)
expr_stmt|;
return|return;
block|}
name|scan_req
operator|=
name|wpa_s
operator|->
name|scan_req
expr_stmt|;
name|wpa_s
operator|->
name|scan_req
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|!=
literal|0
operator|&&
name|wpa_s
operator|->
name|driver
operator|&&
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|driver
operator|->
name|name
argument_list|,
literal|"wired"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Using wired driver - overriding "
literal|"ap_scan configuration"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|0
condition|)
block|{
name|wpa_supplicant_gen_assoc_event
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_DISCONNECTED
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_INACTIVE
condition|)
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_SCANNING
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|prev_scan_ssid
operator|!=
name|BROADCAST_SSID_SCAN
condition|)
block|{
while|while
condition|(
name|ssid
condition|)
block|{
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|prev_scan_ssid
condition|)
block|{
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
break|break;
block|}
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
block|}
block|}
while|while
condition|(
name|ssid
condition|)
block|{
if|if
condition|(
operator|!
name|ssid
operator|->
name|disabled
operator|&&
operator|(
name|ssid
operator|->
name|scan_ssid
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
operator|)
condition|)
break|break;
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|scan_req
operator|!=
literal|2
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
condition|)
block|{
comment|/* 		 * ap_scan=2 mode - try to associate with each SSID instead of 		 * scanning for each scan_ssid=1 network. 		 */
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpa_supplicant_scan: Reached "
literal|"end of scan list - go back to beginning"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|BROADCAST_SSID_SCAN
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ssid
operator|->
name|next
condition|)
block|{
comment|/* Continue from the next SSID on the next attempt. */
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|ssid
expr_stmt|;
block|}
else|else
block|{
comment|/* Start from the beginning of the SSID list. */
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|BROADCAST_SSID_SCAN
expr_stmt|;
block|}
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Starting AP scan (%s SSID)"
argument_list|,
name|ssid
condition|?
literal|"specific"
else|:
literal|"broadcast"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan SSID"
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|ssid
expr_stmt|;
block|}
else|else
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|BROADCAST_SSID_SCAN
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|scan_res_tried
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
condition|)
block|{
name|wpa_s
operator|->
name|scan_res_tried
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Trying to get current scan results "
literal|"first without requesting a new scan to speed up "
literal|"initial association"
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
condition|)
block|{
name|ret
operator|=
name|ieee80211_sta_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid_len
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|wpa_drv_scan
argument_list|(
name|wpa_s
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid_len
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to initiate AP scan."
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|wpa_cipher
name|cipher_suite2driver
parameter_list|(
name|int
name|cipher
parameter_list|)
block|{
switch|switch
condition|(
name|cipher
condition|)
block|{
case|case
name|WPA_CIPHER_NONE
case|:
return|return
name|CIPHER_NONE
return|;
case|case
name|WPA_CIPHER_WEP40
case|:
return|return
name|CIPHER_WEP40
return|;
case|case
name|WPA_CIPHER_WEP104
case|:
return|return
name|CIPHER_WEP104
return|;
case|case
name|WPA_CIPHER_CCMP
case|:
return|return
name|CIPHER_CCMP
return|;
case|case
name|WPA_CIPHER_TKIP
case|:
default|default:
return|return
name|CIPHER_TKIP
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|wpa_key_mgmt
name|key_mgmt2driver
parameter_list|(
name|int
name|key_mgmt
parameter_list|)
block|{
switch|switch
condition|(
name|key_mgmt
condition|)
block|{
case|case
name|WPA_KEY_MGMT_NONE
case|:
return|return
name|KEY_MGMT_NONE
return|;
case|case
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
case|:
return|return
name|KEY_MGMT_802_1X_NO_WPA
return|;
case|case
name|WPA_KEY_MGMT_IEEE8021X
case|:
return|return
name|KEY_MGMT_802_1X
return|;
case|case
name|WPA_KEY_MGMT_WPA_NONE
case|:
return|return
name|KEY_MGMT_WPA_NONE
return|;
case|case
name|WPA_KEY_MGMT_PSK
case|:
default|default:
return|return
name|KEY_MGMT_PSK
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_suites_from_ai
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_ie_data
modifier|*
name|ie
parameter_list|)
block|{
name|int
name|ret
init|=
name|wpa_sm_parse_own_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|ret
operator|==
operator|-
literal|2
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Failed to parse WPA IE "
literal|"from association info"
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Using WPA IE from AssocReq to set cipher "
literal|"suites"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver used disabled group "
literal|"cipher 0x%x (mask 0x%x) - reject"
argument_list|,
name|ie
operator|->
name|group_cipher
argument_list|,
name|ssid
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver used disabled pairwise "
literal|"cipher 0x%x (mask 0x%x) - reject"
argument_list|,
name|ie
operator|->
name|pairwise_cipher
argument_list|,
name|ssid
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver used disabled key "
literal|"management 0x%x (mask 0x%x) - reject"
argument_list|,
name|ie
operator|->
name|key_mgmt
argument_list|,
name|ssid
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|capabilities
operator|&
name|WPA_CAPABILITY_MGMT_FRAME_PROTECTION
operator|)
operator|&&
name|ssid
operator|->
name|ieee80211w
operator|==
name|IEEE80211W_REQUIRED
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver associated with an AP "
literal|"that does not support management frame protection - "
literal|"reject"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_suites - Set authentication and encryption parameters  * @wpa_s: Pointer to wpa_supplicant data  * @bss: Scan results for the selected BSS, or %NULL if not available  * @ssid: Configuration data for the selected network  * @wpa_ie: Buffer for the WPA/RSN IE  * @wpa_ie_len: Maximum wpa_ie buffer size on input. This is changed to be the  * used buffer length in case the functions returns success.  * Returns: 0 on success or -1 on failure  *  * This function is used to configure authentication and encryption parameters  * based on the network configuration and scan result for the selected BSS (if  * available).  */
end_comment

begin_function
name|int
name|wpa_supplicant_set_suites
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|u8
modifier|*
name|wpa_ie
parameter_list|,
name|size_t
modifier|*
name|wpa_ie_len
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|sel
decl_stmt|,
name|proto
decl_stmt|;
if|if
condition|(
name|bss
operator|&&
name|bss
operator|->
name|rsn_ie_len
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|bss
operator|->
name|rsn_ie
argument_list|,
name|bss
operator|->
name|rsn_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
operator|&&
operator|(
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
operator|&&
operator|(
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: using IEEE 802.11i/D9.0"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
operator|&&
name|bss
operator|->
name|wpa_ie_len
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_WPA
operator|)
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|bss
operator|->
name|wpa_ie
argument_list|,
name|bss
operator|->
name|wpa_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
operator|&&
operator|(
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
operator|&&
operator|(
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using IEEE 802.11i/D3.0"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select WPA/RSN"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
condition|)
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
else|else
name|proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_suites_from_ai
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_memset
argument_list|(
operator|&
name|ie
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
argument_list|)
expr_stmt|;
name|ie
operator|.
name|group_cipher
operator|=
name|ssid
operator|->
name|group_cipher
expr_stmt|;
name|ie
operator|.
name|pairwise_cipher
operator|=
name|ssid
operator|->
name|pairwise_cipher
expr_stmt|;
name|ie
operator|.
name|key_mgmt
operator|=
name|ssid
operator|->
name|key_mgmt
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|ie
operator|.
name|mgmt_group_cipher
operator|=
name|ssid
operator|->
name|ieee80211w
operator|!=
name|NO_IEEE80211W
condition|?
name|WPA_CIPHER_AES_128_CMAC
else|:
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Set cipher suites based "
literal|"on configuration"
argument_list|)
expr_stmt|;
block|}
else|else
name|proto
operator|=
name|ie
operator|.
name|proto
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Selected cipher suites: group %d "
literal|"pairwise %d key_mgmt %d proto %d"
argument_list|,
name|ie
operator|.
name|group_cipher
argument_list|,
name|ie
operator|.
name|pairwise_cipher
argument_list|,
name|ie
operator|.
name|key_mgmt
argument_list|,
name|proto
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|ssid
operator|->
name|ieee80211w
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Selected mgmt group cipher %d"
argument_list|,
name|ie
operator|.
name|mgmt_group_cipher
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_PROTO
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|bss
condition|?
name|bss
operator|->
name|wpa_ie
else|:
name|NULL
argument_list|,
name|bss
condition|?
name|bss
operator|->
name|wpa_ie_len
else|:
literal|0
argument_list|)
operator|||
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|bss
condition|?
name|bss
operator|->
name|rsn_ie
else|:
name|NULL
argument_list|,
name|bss
condition|?
name|bss
operator|->
name|rsn_ie_len
else|:
literal|0
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|sel
operator|=
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK CCMP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK TKIP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_WEP104
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP104
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK WEP104"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_WEP40
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP40
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK WEP40"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select group cipher."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sel
operator|=
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK CCMP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK TKIP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_NONE
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK NONE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select pairwise "
literal|"cipher."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sel
operator|=
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT 802.1X"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT WPA-PSK"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_WPA_NONE
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT WPA-NONE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select authenticated "
literal|"key management type."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_KEY_MGMT
argument_list|,
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_PAIRWISE
argument_list|,
name|wpa_s
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_GROUP
argument_list|,
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|sel
operator|=
name|ie
operator|.
name|mgmt_group_cipher
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ieee80211w
operator|==
name|NO_IEEE80211W
operator|||
operator|!
operator|(
name|ie
operator|.
name|capabilities
operator|&
name|WPA_CAPABILITY_MGMT_FRAME_PROTECTION
operator|)
condition|)
name|sel
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_AES_128_CMAC
condition|)
block|{
name|wpa_s
operator|->
name|mgmt_group_cipher
operator|=
name|WPA_CIPHER_AES_128_CMAC
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using MGMT group cipher "
literal|"AES-128-CMAC"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_s
operator|->
name|mgmt_group_cipher
operator|=
literal|0
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: not using MGMT group cipher"
argument_list|)
expr_stmt|;
block|}
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_MGMT_GROUP
argument_list|,
name|wpa_s
operator|->
name|mgmt_group_cipher
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
if|if
condition|(
name|wpa_sm_set_assoc_wpa_ie_default
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_ie
argument_list|,
name|wpa_ie_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to generate WPA IE."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
name|wpa_sm_set_pmk
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
else|else
name|wpa_sm_set_pmk_from_pmksa
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_associate - Request association  * @wpa_s: Pointer to wpa_supplicant data  * @bss: Scan results for the selected BSS, or %NULL if not available  * @ssid: Configuration data for the selected network  *  * This function is used to request %wpa_supplicant to associate with a BSS.  */
end_comment

begin_function
name|void
name|wpa_supplicant_associate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|u8
name|wpa_ie
index|[
literal|80
index|]
decl_stmt|;
name|size_t
name|wpa_ie_len
decl_stmt|;
name|int
name|use_crypt
decl_stmt|,
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|int
name|algs
init|=
name|AUTH_ALG_OPEN_SYSTEM
decl_stmt|;
name|wpa_cipher
name|cipher_pairwise
decl_stmt|,
name|cipher_group
decl_stmt|;
name|struct
name|wpa_driver_associate_params
name|params
decl_stmt|;
name|int
name|wep_keys_set
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
name|int
name|assoc_failed
init|=
literal|0
decl_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Trying to associate with "
name|MACSTR
literal|" (SSID='%s' freq=%d MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Trying to associate with SSID '%s'"
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
comment|/* Starting new association, so clear the possibly used WPA IE from the 	 * previous association. */
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|leap
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|non_leap
operator|==
literal|0
condition|)
name|algs
operator|=
name|AUTH_ALG_LEAP
expr_stmt|;
else|else
name|algs
operator||=
name|AUTH_ALG_LEAP
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Automatic auth_alg selection: 0x%x"
argument_list|,
name|algs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
condition|)
block|{
name|algs
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_OPEN
condition|)
name|algs
operator||=
name|AUTH_ALG_OPEN_SYSTEM
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_SHARED
condition|)
name|algs
operator||=
name|AUTH_ALG_SHARED_KEY
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_LEAP
condition|)
name|algs
operator||=
name|AUTH_ALG_LEAP
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Overriding auth_alg selection: 0x%x"
argument_list|,
name|algs
argument_list|)
expr_stmt|;
block|}
name|wpa_drv_set_auth_alg
argument_list|(
name|wpa_s
argument_list|,
name|algs
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|&&
operator|(
name|bss
operator|->
name|wpa_ie_len
operator|||
name|bss
operator|->
name|rsn_ie_len
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_PSK
operator|)
operator|)
condition|)
block|{
name|int
name|try_opportunistic
decl_stmt|;
name|try_opportunistic
operator|=
name|ssid
operator|->
name|proactive_key_caching
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
expr_stmt|;
if|if
condition|(
name|pmksa_cache_set_current
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|,
name|try_opportunistic
argument_list|)
operator|==
literal|0
condition|)
name|eapol_sm_notify_pmkid_attempt
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ssid
argument_list|,
name|wpa_ie
argument_list|,
operator|&
name|wpa_ie_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to set WPA key "
literal|"management and encryption suites"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_PSK
operator||
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_WPA_NONE
operator|)
condition|)
block|{
name|wpa_ie_len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|,
name|wpa_ie
argument_list|,
operator|&
name|wpa_ie_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to set WPA key "
literal|"management and encryption suites (no scan "
literal|"results)"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|bss
condition|?
name|bss
operator|->
name|bssid
else|:
name|NULL
argument_list|)
expr_stmt|;
name|use_crypt
operator|=
literal|1
expr_stmt|;
name|cipher_pairwise
operator|=
name|cipher_suite2driver
argument_list|(
name|wpa_s
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
name|cipher_group
operator|=
name|cipher_suite2driver
argument_list|(
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
condition|)
name|use_crypt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
block|{
name|use_crypt
operator|=
literal|1
expr_stmt|;
name|wep_keys_set
operator|=
literal|1
expr_stmt|;
name|wpa_set_wep_key
argument_list|(
name|wpa_s
argument_list|,
name|i
operator|==
name|ssid
operator|->
name|wep_tx_keyidx
argument_list|,
name|i
argument_list|,
name|ssid
operator|->
name|wep_key
index|[
name|i
index|]
argument_list|,
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
operator|(
name|ssid
operator|->
name|eapol_flags
operator|&
operator|(
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
operator||
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
operator|)
operator|)
operator|==
literal|0
operator|&&
operator|!
name|wep_keys_set
condition|)
block|{
name|use_crypt
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* Assume that dynamic WEP-104 keys will be used and 			 * set cipher suites in order for drivers to expect 			 * encryption. */
name|cipher_pairwise
operator|=
name|cipher_group
operator|=
name|CIPHER_WEP104
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* Set the key before (and later after) association */
name|wpa_supplicant_set_wpa_none_key
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
name|wpa_drv_set_drop_unencrypted
argument_list|(
name|wpa_s
argument_list|,
name|use_crypt
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ASSOCIATING
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|params
operator|.
name|bssid
operator|=
name|bss
operator|->
name|bssid
expr_stmt|;
name|params
operator|.
name|ssid
operator|=
name|bss
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
name|params
operator|.
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|ssid
operator|=
name|ssid
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
literal|1
operator|&&
name|ssid
operator|->
name|frequency
operator|>
literal|0
operator|&&
name|params
operator|.
name|freq
operator|==
literal|0
condition|)
name|params
operator|.
name|freq
operator|=
name|ssid
operator|->
name|frequency
expr_stmt|;
comment|/* Initial channel for IBSS */
name|params
operator|.
name|wpa_ie
operator|=
name|wpa_ie
expr_stmt|;
name|params
operator|.
name|wpa_ie_len
operator|=
name|wpa_ie_len
expr_stmt|;
name|params
operator|.
name|pairwise_suite
operator|=
name|cipher_pairwise
expr_stmt|;
name|params
operator|.
name|group_suite
operator|=
name|cipher_group
expr_stmt|;
name|params
operator|.
name|key_mgmt_suite
operator|=
name|key_mgmt2driver
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|algs
expr_stmt|;
name|params
operator|.
name|mode
operator|=
name|ssid
operator|->
name|mode
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
name|params
operator|.
name|wep_key
index|[
name|i
index|]
operator|=
name|ssid
operator|->
name|wep_key
index|[
name|i
index|]
expr_stmt|;
name|params
operator|.
name|wep_key_len
index|[
name|i
index|]
operator|=
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
expr_stmt|;
block|}
name|params
operator|.
name|wep_tx_keyidx
operator|=
name|ssid
operator|->
name|wep_tx_keyidx
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
switch|switch
condition|(
name|ssid
operator|->
name|ieee80211w
condition|)
block|{
case|case
name|NO_IEEE80211W
case|:
name|params
operator|.
name|mgmt_frame_protection
operator|=
name|NO_MGMT_FRAME_PROTECTION
expr_stmt|;
break|break;
case|case
name|IEEE80211W_OPTIONAL
case|:
name|params
operator|.
name|mgmt_frame_protection
operator|=
name|MGMT_FRAME_PROTECTION_OPTIONAL
expr_stmt|;
break|break;
case|case
name|IEEE80211W_REQUIRED
case|:
name|params
operator|.
name|mgmt_frame_protection
operator|=
name|MGMT_FRAME_PROTECTION_REQUIRED
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
condition|)
name|ret
operator|=
name|ieee80211_sta_associate
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|wpa_drv_associate
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Association request to the driver "
literal|"failed"
argument_list|)
expr_stmt|;
comment|/* try to continue anyway; new association will be tried again 		 * after timeout */
name|assoc_failed
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* Set the key after the association just in case association 		 * cleared the previously configured key. */
name|wpa_supplicant_set_wpa_none_key
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
comment|/* No need to timeout authentication since there is no key 		 * management. */
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_COMPLETED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Timeout for IEEE 802.11 authentication and association */
name|int
name|timeout
decl_stmt|;
if|if
condition|(
name|assoc_failed
condition|)
name|timeout
operator|=
literal|5
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
condition|)
name|timeout
operator|=
literal|10
expr_stmt|;
else|else
name|timeout
operator|=
literal|60
expr_stmt|;
name|wpa_supplicant_req_auth_timeout
argument_list|(
name|wpa_s
argument_list|,
name|timeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wep_keys_set
operator|&&
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
operator|==
literal|0
operator|&&
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SET_KEYS_AFTER_ASSOC
condition|)
block|{
comment|/* Set static WEP keys again */
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NUM_WEP_KEYS
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|j
index|]
condition|)
block|{
name|wpa_set_wep_key
argument_list|(
name|wpa_s
argument_list|,
name|j
operator|==
name|ssid
operator|->
name|wep_tx_keyidx
argument_list|,
name|j
argument_list|,
name|ssid
operator|->
name|wep_key
index|[
name|j
index|]
argument_list|,
name|ssid
operator|->
name|wep_key_len
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|!=
name|ssid
condition|)
block|{
comment|/* 		 * Do not allow EAP session resumption between different 		 * network configurations. 		 */
name|eapol_sm_invalidate_cached_session
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_initiate_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_disassociate - Disassociate the current connection  * @wpa_s: Pointer to wpa_supplicant data  * @reason_code: IEEE 802.11 reason code for the disassociate frame  *  * This function is used to request %wpa_supplicant to disassociate with the  * current AP.  */
end_comment

begin_function
name|void
name|wpa_supplicant_disassociate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|u8
modifier|*
name|addr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
condition|)
name|ieee80211_sta_disassociate
argument_list|(
name|wpa_s
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
else|else
name|wpa_drv_disassociate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|addr
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_deauthenticate - Deauthenticate the current connection  * @wpa_s: Pointer to wpa_supplicant data  * @reason_code: IEEE 802.11 reason code for the deauthenticate frame  *  * This function is used to request %wpa_supplicant to disassociate with the  * current AP.  */
end_comment

begin_function
name|void
name|wpa_supplicant_deauthenticate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|u8
modifier|*
name|addr
init|=
name|NULL
decl_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
condition|)
name|ieee80211_sta_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
else|else
name|wpa_drv_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|addr
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_get_scan_results - Get scan results  * @wpa_s: Pointer to wpa_supplicant data  * Returns: 0 on success, -1 on failure  *  * This function is request the current scan results from the driver and stores  * a local copy of the results in wpa_s->scan_results.  */
end_comment

begin_function
name|int
name|wpa_supplicant_get_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
define|#
directive|define
name|SCAN_AP_LIMIT
value|128
name|struct
name|wpa_scan_result
modifier|*
name|results
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|int
name|num
decl_stmt|;
name|results
operator|=
name|os_malloc
argument_list|(
name|SCAN_AP_LIMIT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|results
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to allocate memory for scan "
literal|"results"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
condition|)
block|{
name|num
operator|=
name|ieee80211_sta_get_scan_results
argument_list|(
name|wpa_s
argument_list|,
name|results
argument_list|,
name|SCAN_AP_LIMIT
argument_list|)
expr_stmt|;
block|}
else|else
name|num
operator|=
name|wpa_drv_get_scan_results
argument_list|(
name|wpa_s
argument_list|,
name|results
argument_list|,
name|SCAN_AP_LIMIT
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan results: %d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to get scan results"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|results
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|num
operator|>
name|SCAN_AP_LIMIT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Not enough room for all APs (%d< %d)"
argument_list|,
name|num
argument_list|,
name|SCAN_AP_LIMIT
argument_list|)
expr_stmt|;
name|num
operator|=
name|SCAN_AP_LIMIT
expr_stmt|;
block|}
comment|/* Free unneeded memory for unused scan result entries */
name|tmp
operator|=
name|os_realloc
argument_list|(
name|results
argument_list|,
name|num
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|||
name|num
operator|==
literal|0
condition|)
block|{
name|results
operator|=
name|tmp
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|scan_results
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_results
operator|=
name|results
expr_stmt|;
name|wpa_s
operator|->
name|num_scan_results
operator|=
name|num
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_WPA
end_ifndef

begin_function
specifier|static
name|int
name|wpa_get_beacon_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_scan_result
modifier|*
name|results
decl_stmt|,
modifier|*
name|curr
init|=
name|NULL
decl_stmt|;
name|results
operator|=
name|wpa_s
operator|->
name|scan_results
expr_stmt|;
if|if
condition|(
name|results
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|num_scan_results
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|results
index|[
name|i
index|]
operator|.
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
operator|(
operator|(
name|results
index|[
name|i
index|]
operator|.
name|ssid_len
operator|==
name|ssid
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|results
index|[
name|i
index|]
operator|.
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
operator|)
operator|||
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
operator|)
condition|)
block|{
name|curr
operator|=
operator|&
name|results
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|curr
condition|)
block|{
if|if
condition|(
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|curr
operator|->
name|wpa_ie
argument_list|,
name|curr
operator|->
name|wpa_ie_len
argument_list|)
operator|||
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|curr
operator|->
name|rsn_ie
argument_list|,
name|curr
operator|->
name|rsn_ie_len
argument_list|)
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_get_beacon_ie
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_get_beacon_ie
argument_list|(
name|wpa_s
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/* No WPA/RSN IE found in the cached scan results. Try to get updated 	 * scan results from the driver. */
if|if
condition|(
name|wpa_supplicant_get_scan_results
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
name|wpa_get_beacon_ie
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_WPA */
end_comment

begin_comment
comment|/**  * wpa_supplicant_get_ssid - Get a pointer to the current network structure  * @wpa_s: Pointer to wpa_supplicant data  * Returns: A pointer to the current network structure or %NULL on failure  */
end_comment

begin_function
name|struct
name|wpa_ssid
modifier|*
name|wpa_supplicant_get_ssid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|entry
decl_stmt|;
name|u8
name|ssid
index|[
name|MAX_SSID_LEN
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|ssid_len
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|wired
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
condition|)
block|{
if|if
condition|(
name|ieee80211_sta_get_ssid
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|ssid_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Could not read SSID from "
literal|"MLME."
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
name|res
operator|=
name|wpa_drv_get_ssid
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Could not read SSID from "
literal|"driver."
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ssid_len
operator|=
name|res
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
condition|)
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Could not read BSSID from driver."
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wired
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|driver
operator|&&
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|driver
operator|->
name|name
argument_list|,
literal|"wired"
argument_list|)
operator|==
literal|0
expr_stmt|;
name|entry
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
operator|!
name|entry
operator|->
name|disabled
operator|&&
operator|(
operator|(
name|ssid_len
operator|==
name|entry
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|entry
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
operator|)
operator|||
name|wired
operator|)
operator|&&
operator|(
operator|!
name|entry
operator|->
name|bssid_set
operator|||
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|entry
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
name|entry
return|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_WPA
end_ifndef

begin_function
specifier|static
name|u8
modifier|*
name|_wpa_alloc_eapol
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|u16
name|data_len
parameter_list|,
name|size_t
modifier|*
name|msg_len
parameter_list|,
name|void
modifier|*
modifier|*
name|data_pos
parameter_list|)
block|{
return|return
name|wpa_alloc_eapol
argument_list|(
name|wpa_s
argument_list|,
name|type
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|msg_len
argument_list|,
name|data_pos
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_wpa_ether_send
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dest
parameter_list|,
name|u16
name|proto
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
return|return
name|wpa_ether_send
argument_list|(
name|wpa_s
argument_list|,
name|dest
argument_list|,
name|proto
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|_wpa_supplicant_req_scan
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|int
name|sec
parameter_list|,
name|int
name|usec
parameter_list|)
block|{
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|sec
argument_list|,
name|usec
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|_wpa_supplicant_cancel_auth_timeout
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|_wpa_supplicant_set_state
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|wpa_states
name|state
parameter_list|)
block|{
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|wpa_states
name|_wpa_supplicant_get_state
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|)
block|{
return|return
name|wpa_supplicant_get_state
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|_wpa_supplicant_disassociate
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|wpa_supplicant_disassociate
argument_list|(
name|wpa_s
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|_wpa_supplicant_deauthenticate
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|_wpa_supplicant_get_ssid
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|)
block|{
return|return
name|wpa_supplicant_get_ssid
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_get_bssid
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|use_client_mlme
condition|)
block|{
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_set_key
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
return|return
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|alg
argument_list|,
name|addr
argument_list|,
name|key_idx
argument_list|,
name|set_tx
argument_list|,
name|seq
argument_list|,
name|seq_len
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_mlme_setprotection
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|protection_type
parameter_list|,
name|int
name|key_type
parameter_list|)
block|{
return|return
name|wpa_drv_mlme_setprotection
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|protection_type
argument_list|,
name|key_type
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_add_pmkid
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
return|return
name|wpa_drv_add_pmkid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|,
name|pmkid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_remove_pmkid
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
return|return
name|wpa_drv_remove_pmkid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|,
name|pmkid
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_WPA */
end_comment

begin_function
specifier|static
name|int
name|wpa_supplicant_set_driver
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_supplicant_drivers
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"No driver interfaces build into "
literal|"wpa_supplicant."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
comment|/* default to first driver in the list */
name|wpa_s
operator|->
name|driver
operator|=
name|wpa_supplicant_drivers
index|[
literal|0
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_supplicant_drivers
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|name
argument_list|,
name|wpa_supplicant_drivers
index|[
name|i
index|]
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|driver
operator|=
name|wpa_supplicant_drivers
index|[
name|i
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Unsupported driver '%s'.\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_rx_eapol
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RX EAPOL from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"RX EAPOL"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Ignored received EAPOL frame since "
literal|"no key management is configured"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|eapol_received
operator|==
literal|0
condition|)
block|{
comment|/* Timeout for completing IEEE 802.1X and WPA authentication */
name|wpa_supplicant_req_auth_timeout
argument_list|(
name|wpa_s
argument_list|,
operator|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
condition|?
literal|70
else|:
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|eapol_received
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|countermeasures
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: Countermeasures - dropped EAPOL "
literal|"packet"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Source address of the incoming EAPOL frame could be compared to the 	 * current BSSID. However, it is possible that a centralized 	 * Authenticator could be using another MAC address than the BSSID of 	 * an AP, so just allow any address to be used for now. The replies are 	 * still sent to the current BSSID (if available), though. */
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|last_eapol_src
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_PSK
operator|&&
name|eapol_sm_rx_eapol
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|>
literal|0
condition|)
return|return;
name|wpa_drv_poll
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_sm_rx_eapol
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_driver_init - Initialize driver interface parameters  * @wpa_s: Pointer to wpa_supplicant data  * @wait_for_interface: 0 = do not wait for the interface (reports a failure if  * the interface is not present), 1 = wait until the interface is available  * Returns: 0 on success, -1 on failure  *  * This function is called to initialize driver interface parameters.  * wpa_drv_init() must have been called before this function to initialize the  * driver interface.  */
end_comment

begin_function
name|int
name|wpa_supplicant_driver_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|wait_for_interface
parameter_list|)
block|{
specifier|static
name|int
name|interface_count
init|=
literal|0
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|driver
operator|->
name|send_eapol
condition|)
block|{
specifier|const
name|u8
modifier|*
name|addr
init|=
name|wpa_drv_get_mac_addr
argument_list|(
name|wpa_s
argument_list|)
decl_stmt|;
if|if
condition|(
name|addr
condition|)
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_s
operator|->
name|l2
operator|=
name|l2_packet_init
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_drv_get_mac_addr
argument_list|(
name|wpa_s
argument_list|)
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|wpa_supplicant_rx_eapol
argument_list|,
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|l2
condition|)
break|break;
elseif|else
if|if
condition|(
operator|!
name|wait_for_interface
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Waiting for interface.."
argument_list|)
expr_stmt|;
name|os_sleep
argument_list|(
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|l2
operator|&&
name|l2_packet_get_own_addr
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to get own L2 address"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Own MAC address: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|bridge_ifname
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Receiving packets from bridge interface"
literal|" '%s'"
argument_list|,
name|wpa_s
operator|->
name|bridge_ifname
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2_br
operator|=
name|l2_packet_init
argument_list|(
name|wpa_s
operator|->
name|bridge_ifname
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|wpa_supplicant_rx_eapol
argument_list|,
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|l2_br
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to open l2_packet "
literal|"connection for the bridge interface '%s'"
argument_list|,
name|wpa_s
operator|->
name|bridge_ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
comment|/* Backwards compatibility call to set_wpa() handler. This is called 	 * only just after init and just before deinit, so these handler can be 	 * used to implement same functionality. */
if|if
condition|(
name|wpa_drv_set_wpa
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
if|if
condition|(
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
operator|<
literal|0
operator|||
operator|!
operator|(
name|capa
operator|.
name|flags
operator|&
operator|(
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2
operator|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Driver does not support WPA."
argument_list|)
expr_stmt|;
comment|/* Continue to allow non-WPA modes to be used. */
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to enable WPA in the "
literal|"driver."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Make sure that TKIP countermeasures are not left enabled (could 	 * happen if wpa_supplicant is killed during countermeasures. */
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_drop_unencrypted
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|BROADCAST_SSID_SCAN
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|interface_count
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
name|interface_count
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_daemon
parameter_list|(
specifier|const
name|char
modifier|*
name|pid_file
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Daemonize.."
argument_list|)
expr_stmt|;
return|return
name|os_daemonize
argument_list|(
name|pid_file
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpa_supplicant_alloc
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|wpa_s
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wpa_s
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_s
operator|->
name|scan_req
operator|=
literal|1
expr_stmt|;
return|return
name|wpa_s
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_init_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_interface
modifier|*
name|iface
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Initializing interface '%s' conf '%s' driver "
literal|"'%s' ctrl_interface '%s' bridge '%s'"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|confname
condition|?
name|iface
operator|->
name|confname
else|:
literal|"N/A"
argument_list|,
name|iface
operator|->
name|driver
condition|?
name|iface
operator|->
name|driver
else|:
literal|"default"
argument_list|,
name|iface
operator|->
name|ctrl_interface
condition|?
name|iface
operator|->
name|ctrl_interface
else|:
literal|"N/A"
argument_list|,
name|iface
operator|->
name|bridge_ifname
condition|?
name|iface
operator|->
name|bridge_ifname
else|:
literal|"N/A"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_driver
argument_list|(
name|wpa_s
argument_list|,
name|iface
operator|->
name|driver
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|iface
operator|->
name|confname
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_BACKEND_FILE
name|wpa_s
operator|->
name|confname
operator|=
name|os_rel2abs_path
argument_list|(
name|iface
operator|->
name|confname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|confname
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to get absolute path "
literal|"for configuration file '%s'."
argument_list|,
name|iface
operator|->
name|confname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configuration file '%s' -> '%s'"
argument_list|,
name|iface
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* CONFIG_BACKEND_FILE */
name|wpa_s
operator|->
name|confname
operator|=
name|os_strdup
argument_list|(
name|iface
operator|->
name|confname
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_BACKEND_FILE */
name|wpa_s
operator|->
name|conf
operator|=
name|wpa_config_read
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to read or parse "
literal|"configuration '%s'."
argument_list|,
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 		 * Override ctrl_interface and driver_param if set on command 		 * line. 		 */
if|if
condition|(
name|iface
operator|->
name|ctrl_interface
condition|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
operator|=
name|os_strdup
argument_list|(
name|iface
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iface
operator|->
name|driver_param
condition|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
operator|=
name|os_strdup
argument_list|(
name|iface
operator|->
name|driver_param
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|wpa_s
operator|->
name|conf
operator|=
name|wpa_config_alloc_empty
argument_list|(
name|iface
operator|->
name|ctrl_interface
argument_list|,
name|iface
operator|->
name|driver_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"\nNo configuration found."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|iface
operator|->
name|ifname
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"\nInterface name is required."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_strlen
argument_list|(
name|iface
operator|->
name|ifname
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"\nToo long interface name '%s'."
argument_list|,
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_strncpy
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|bridge_ifname
condition|)
block|{
if|if
condition|(
name|os_strlen
argument_list|(
name|iface
operator|->
name|bridge_ifname
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|bridge_ifname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"\nToo long bridge interface "
literal|"name '%s'."
argument_list|,
name|iface
operator|->
name|bridge_ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_strncpy
argument_list|(
name|wpa_s
operator|->
name|bridge_ifname
argument_list|,
name|iface
operator|->
name|bridge_ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|bridge_ifname
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_init_eapol
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|struct
name|eapol_ctx
modifier|*
name|ctx
decl_stmt|;
name|ctx
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to allocate EAPOL context."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ctx
operator|->
name|ctx
operator|=
name|wpa_s
expr_stmt|;
name|ctx
operator|->
name|msg_ctx
operator|=
name|wpa_s
expr_stmt|;
name|ctx
operator|->
name|eapol_send_ctx
operator|=
name|wpa_s
expr_stmt|;
name|ctx
operator|->
name|preauth
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|eapol_done_cb
operator|=
name|wpa_supplicant_notify_eapol_done
expr_stmt|;
name|ctx
operator|->
name|eapol_send
operator|=
name|wpa_supplicant_eapol_send
expr_stmt|;
name|ctx
operator|->
name|set_wep_key
operator|=
name|wpa_eapol_set_wep_key
expr_stmt|;
name|ctx
operator|->
name|set_config_blob
operator|=
name|wpa_supplicant_set_config_blob
expr_stmt|;
name|ctx
operator|->
name|get_config_blob
operator|=
name|wpa_supplicant_get_config_blob
expr_stmt|;
name|ctx
operator|->
name|aborted_cached
operator|=
name|wpa_supplicant_aborted_cached
expr_stmt|;
name|ctx
operator|->
name|opensc_engine_path
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|opensc_engine_path
expr_stmt|;
name|ctx
operator|->
name|pkcs11_engine_path
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|pkcs11_engine_path
expr_stmt|;
name|ctx
operator|->
name|pkcs11_module_path
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|pkcs11_module_path
expr_stmt|;
name|wpa_s
operator|->
name|eapol
operator|=
name|eapol_sm_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|eapol
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize EAPOL state "
literal|"machines."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_init_wpa
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NO_WPA
name|struct
name|wpa_sm_ctx
modifier|*
name|ctx
decl_stmt|;
name|ctx
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to allocate WPA context."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ctx
operator|->
name|ctx
operator|=
name|wpa_s
expr_stmt|;
name|ctx
operator|->
name|set_state
operator|=
name|_wpa_supplicant_set_state
expr_stmt|;
name|ctx
operator|->
name|get_state
operator|=
name|_wpa_supplicant_get_state
expr_stmt|;
name|ctx
operator|->
name|req_scan
operator|=
name|_wpa_supplicant_req_scan
expr_stmt|;
name|ctx
operator|->
name|deauthenticate
operator|=
name|_wpa_supplicant_deauthenticate
expr_stmt|;
name|ctx
operator|->
name|disassociate
operator|=
name|_wpa_supplicant_disassociate
expr_stmt|;
name|ctx
operator|->
name|set_key
operator|=
name|wpa_supplicant_set_key
expr_stmt|;
name|ctx
operator|->
name|scan
operator|=
name|wpa_supplicant_scan
expr_stmt|;
name|ctx
operator|->
name|get_ssid
operator|=
name|_wpa_supplicant_get_ssid
expr_stmt|;
name|ctx
operator|->
name|get_bssid
operator|=
name|wpa_supplicant_get_bssid
expr_stmt|;
name|ctx
operator|->
name|ether_send
operator|=
name|_wpa_ether_send
expr_stmt|;
name|ctx
operator|->
name|get_beacon_ie
operator|=
name|wpa_supplicant_get_beacon_ie
expr_stmt|;
name|ctx
operator|->
name|alloc_eapol
operator|=
name|_wpa_alloc_eapol
expr_stmt|;
name|ctx
operator|->
name|cancel_auth_timeout
operator|=
name|_wpa_supplicant_cancel_auth_timeout
expr_stmt|;
name|ctx
operator|->
name|add_pmkid
operator|=
name|wpa_supplicant_add_pmkid
expr_stmt|;
name|ctx
operator|->
name|remove_pmkid
operator|=
name|wpa_supplicant_remove_pmkid
expr_stmt|;
name|ctx
operator|->
name|set_config_blob
operator|=
name|wpa_supplicant_set_config_blob
expr_stmt|;
name|ctx
operator|->
name|get_config_blob
operator|=
name|wpa_supplicant_get_config_blob
expr_stmt|;
name|ctx
operator|->
name|mlme_setprotection
operator|=
name|wpa_supplicant_mlme_setprotection
expr_stmt|;
name|wpa_s
operator|->
name|wpa
operator|=
name|wpa_sm_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize WPA state "
literal|"machine"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_WPA */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_init_iface2
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|wait_for_interface
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|ifname
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Initializing interface (2) '%s'"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_init_eapol
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* RSNA Supplicant Key Management - INITIALIZE */
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* Initialize driver interface and register driver event handler before 	 * L2 receive handler so that association events are processed before 	 * EAPOL-Key packets if both become available for the same select() 	 * call. */
name|wpa_s
operator|->
name|drv_priv
operator|=
name|wpa_drv_init
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize driver interface"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_drv_set_param
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Driver interface rejected "
literal|"driver_param '%s'"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ifname
operator|=
name|wpa_drv_get_ifname
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifname
operator|&&
name|os_strcmp
argument_list|(
name|ifname
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Driver interface replaced interface "
literal|"name with '%s'"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|os_strncpy
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_supplicant_init_wpa
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_sm_set_ifname
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|bridge_ifname
index|[
literal|0
index|]
condition|?
name|wpa_s
operator|->
name|bridge_ifname
else|:
name|NULL
argument_list|)
expr_stmt|;
name|wpa_sm_set_fast_reauth
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|fast_reauth
argument_list|)
expr_stmt|;
name|wpa_sm_set_eapol
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigPMKLifetime
operator|&&
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|RSNA_PMK_LIFETIME
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigPMKLifetime
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Invalid WPA parameter value for "
literal|"dot11RSNAConfigPMKLifetime"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigPMKReauthThreshold
operator|&&
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|RSNA_PMK_REAUTH_THRESHOLD
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigPMKReauthThreshold
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Invalid WPA parameter value for "
literal|"dot11RSNAConfigPMKReauthThreshold"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigSATimeout
operator|&&
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|RSNA_SA_TIMEOUT
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigSATimeout
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Invalid WPA parameter value for "
literal|"dot11RSNAConfigSATimeout"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_supplicant_driver_init
argument_list|(
name|wpa_s
argument_list|,
name|wait_for_interface
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|wpa_sm_set_own_addr
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ctrl_iface
operator|=
name|wpa_supplicant_ctrl_iface_init
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ctrl_iface
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize control interface '%s'.\n"
literal|"You may have another wpa_supplicant process "
literal|"already running or the file was\n"
literal|"left by an unclean termination of wpa_supplicant "
literal|"in which case you will need\n"
literal|"to manually remove this file before starting "
literal|"wpa_supplicant again.\n"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
operator|==
literal|0
operator|&&
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_USER_SPACE_MLME
condition|)
block|{
name|wpa_s
operator|->
name|use_client_mlme
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ieee80211_sta_init
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_deinit_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
condition|)
block|{
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
comment|/* Backwards compatibility call to set_wpa() handler. This is 		 * called only just after init and just before deinit, so these 		 * handler can be used to implement same functionality. */
if|if
condition|(
name|wpa_drv_set_wpa
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to disable WPA in the "
literal|"driver."
argument_list|)
expr_stmt|;
block|}
name|wpa_drv_set_drop_unencrypted
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|wpas_dbus_unregister_iface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_cleanup
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
condition|)
name|wpa_drv_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_add_iface - Add a new network interface  * @global: Pointer to global data from wpa_supplicant_init()  * @iface: Interface configuration options  * Returns: Pointer to the created interface or %NULL on failure  *  * This function is used to add new network interfaces for %wpa_supplicant.  * This can be called before wpa_supplicant_run() to add interfaces before the  * main event loop has been started. In addition, new interfaces can be added  * dynamically while %wpa_supplicant is already running. This could happen,  * e.g., when a hotplug network adapter is inserted.  */
end_comment

begin_function
name|struct
name|wpa_supplicant
modifier|*
name|wpa_supplicant_add_iface
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|struct
name|wpa_interface
modifier|*
name|iface
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
if|if
condition|(
name|global
operator|==
name|NULL
operator|||
name|iface
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_s
operator|=
name|wpa_supplicant_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wpa_supplicant_init_iface
argument_list|(
name|wpa_s
argument_list|,
name|iface
argument_list|)
operator|||
name|wpa_supplicant_init_iface2
argument_list|(
name|wpa_s
argument_list|,
name|global
operator|->
name|params
operator|.
name|wait_for_interface
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to add interface %s"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|wpa_supplicant_deinit_iface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_s
operator|->
name|global
operator|=
name|global
expr_stmt|;
comment|/* Register the interface with the dbus control interface */
if|if
condition|(
name|wpas_dbus_register_iface
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_supplicant_deinit_iface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_s
operator|->
name|next
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
name|global
operator|->
name|ifaces
operator|=
name|wpa_s
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Added interface %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return
name|wpa_s
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_remove_iface - Remove a network interface  * @global: Pointer to global data from wpa_supplicant_init()  * @wpa_s: Pointer to the network interface to be removed  * Returns: 0 if interface was removed, -1 if interface was not found  *  * This function can be used to dynamically remove network interfaces from  * %wpa_supplicant, e.g., when a hotplug network adapter is ejected. In  * addition, this function is used to remove all remaining interfaces when  * %wpa_supplicant is terminated.  */
end_comment

begin_function
name|int
name|wpa_supplicant_remove_iface
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|prev
decl_stmt|;
comment|/* Remove interface from the global list of interfaces */
name|prev
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
if|if
condition|(
name|prev
operator|==
name|wpa_s
condition|)
block|{
name|global
operator|->
name|ifaces
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|prev
operator|&&
name|prev
operator|->
name|next
operator|!=
name|wpa_s
condition|)
name|prev
operator|=
name|prev
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|prev
operator|->
name|next
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Removing interface %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|wpa_supplicant_deinit_iface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_get_iface - Get a new network interface  * @global: Pointer to global data from wpa_supplicant_init()  * @ifname: Interface name  * Returns: Pointer to the interface or %NULL if not found  */
end_comment

begin_function
name|struct
name|wpa_supplicant
modifier|*
name|wpa_supplicant_get_iface
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpa_s
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_init - Initialize %wpa_supplicant  * @params: Parameters for %wpa_supplicant  * Returns: Pointer to global %wpa_supplicant data, or %NULL on failure  *  * This function is used to initialize %wpa_supplicant. After successful  * initialization, the returned data pointer can be used to add and remove  * network interfaces, and eventually, to deinitialize %wpa_supplicant.  */
end_comment

begin_function
name|struct
name|wpa_global
modifier|*
name|wpa_supplicant_init
parameter_list|(
name|struct
name|wpa_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|params
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_debug_open_file
argument_list|(
name|params
operator|->
name|wpa_debug_file_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_debug_syslog
condition|)
name|wpa_debug_open_syslog
argument_list|()
expr_stmt|;
name|ret
operator|=
name|eap_peer_register_methods
argument_list|()
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to register EAP methods"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|2
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Two or more EAP methods used "
literal|"the same EAP type."
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|global
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|global
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|global
operator|->
name|params
operator|.
name|daemonize
operator|=
name|params
operator|->
name|daemonize
expr_stmt|;
name|global
operator|->
name|params
operator|.
name|wait_for_interface
operator|=
name|params
operator|->
name|wait_for_interface
expr_stmt|;
name|global
operator|->
name|params
operator|.
name|wait_for_monitor
operator|=
name|params
operator|->
name|wait_for_monitor
expr_stmt|;
name|global
operator|->
name|params
operator|.
name|dbus_ctrl_interface
operator|=
name|params
operator|->
name|dbus_ctrl_interface
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|pid_file
condition|)
name|global
operator|->
name|params
operator|.
name|pid_file
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|pid_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ctrl_interface
condition|)
name|global
operator|->
name|params
operator|.
name|ctrl_interface
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
name|wpa_debug_level
operator|=
name|global
operator|->
name|params
operator|.
name|wpa_debug_level
operator|=
name|params
operator|->
name|wpa_debug_level
expr_stmt|;
name|wpa_debug_show_keys
operator|=
name|global
operator|->
name|params
operator|.
name|wpa_debug_show_keys
operator|=
name|params
operator|->
name|wpa_debug_show_keys
expr_stmt|;
name|wpa_debug_timestamp
operator|=
name|global
operator|->
name|params
operator|.
name|wpa_debug_timestamp
operator|=
name|params
operator|->
name|wpa_debug_timestamp
expr_stmt|;
if|if
condition|(
name|eloop_init
argument_list|(
name|global
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize event loop"
argument_list|)
expr_stmt|;
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|global
operator|->
name|ctrl_iface
operator|=
name|wpa_supplicant_global_ctrl_iface_init
argument_list|(
name|global
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|ctrl_iface
operator|==
name|NULL
condition|)
block|{
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|global
operator|->
name|params
operator|.
name|dbus_ctrl_interface
condition|)
block|{
name|global
operator|->
name|dbus_ctrl_iface
operator|=
name|wpa_supplicant_dbus_ctrl_iface_init
argument_list|(
name|global
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|dbus_ctrl_iface
operator|==
name|NULL
condition|)
block|{
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|global
operator|->
name|params
operator|.
name|wait_for_interface
operator|&&
name|global
operator|->
name|params
operator|.
name|daemonize
operator|&&
name|wpa_supplicant_daemon
argument_list|(
name|global
operator|->
name|params
operator|.
name|pid_file
argument_list|)
condition|)
block|{
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|global
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_run - Run the %wpa_supplicant main event loop  * @global: Pointer to global data from wpa_supplicant_init()  * Returns: 0 after successful event loop run, -1 on failure  *  * This function starts the main event loop and continues running as long as  * there are any remaining events. In most cases, this function is running as  * long as the %wpa_supplicant process in still in use.  */
end_comment

begin_function
name|int
name|wpa_supplicant_run
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
if|if
condition|(
operator|!
name|global
operator|->
name|params
operator|.
name|wait_for_interface
operator|&&
name|global
operator|->
name|params
operator|.
name|daemonize
operator|&&
name|wpa_supplicant_daemon
argument_list|(
name|global
operator|->
name|params
operator|.
name|pid_file
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|global
operator|->
name|params
operator|.
name|wait_for_monitor
condition|)
block|{
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
if|if
condition|(
name|wpa_s
operator|->
name|ctrl_iface
condition|)
name|wpa_supplicant_ctrl_iface_wait
argument_list|(
name|wpa_s
operator|->
name|ctrl_iface
argument_list|)
expr_stmt|;
block|}
name|eloop_register_signal_terminate
argument_list|(
name|wpa_supplicant_terminate
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_signal_reconfig
argument_list|(
name|wpa_supplicant_reconfig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_run
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_deinit - Deinitialize %wpa_supplicant  * @global: Pointer to global data from wpa_supplicant_init()  *  * This function is called to deinitialize %wpa_supplicant and to free all  * allocated resources. Remaining network interfaces will also be removed.  */
end_comment

begin_function
name|void
name|wpa_supplicant_deinit
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
if|if
condition|(
name|global
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|global
operator|->
name|ifaces
condition|)
name|wpa_supplicant_remove_iface
argument_list|(
name|global
argument_list|,
name|global
operator|->
name|ifaces
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|ctrl_iface
condition|)
name|wpa_supplicant_global_ctrl_iface_deinit
argument_list|(
name|global
operator|->
name|ctrl_iface
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|dbus_ctrl_iface
condition|)
name|wpa_supplicant_dbus_ctrl_iface_deinit
argument_list|(
name|global
operator|->
name|dbus_ctrl_iface
argument_list|)
expr_stmt|;
name|eap_peer_unregister_methods
argument_list|()
expr_stmt|;
name|eloop_destroy
argument_list|()
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|params
operator|.
name|pid_file
condition|)
block|{
name|os_daemonize_terminate
argument_list|(
name|global
operator|->
name|params
operator|.
name|pid_file
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|global
operator|->
name|params
operator|.
name|pid_file
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|global
operator|->
name|params
operator|.
name|ctrl_interface
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|global
argument_list|)
expr_stmt|;
name|wpa_debug_close_syslog
argument_list|()
expr_stmt|;
name|wpa_debug_close_file
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant  * Copyright (c) 2003-2005, Jouni Malinen<jkmaline@cc.hut.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_define
define|#
directive|define
name|OPENSSL_DISABLE_OLD_DES_SUPPORT
end_define

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eapol_sm.h"
end_include

begin_include
include|#
directive|include
file|"eap.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"version.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|wpa_supplicant_version
init|=
literal|"wpa_supplicant v"
name|VERSION_STR
literal|"\n"
literal|"Copyright (c) 2003-2005, Jouni Malinen<jkmaline@cc.hut.fi> and contributors"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|wpa_supplicant_license
init|=
literal|"This program is free software. You can distribute it and/or modify it\n"
literal|"under the terms of the GNU General Public License version 2.\n"
literal|"\n"
literal|"Alternatively, this software may be distributed under the terms of the\n"
literal|"BSD license. See README and COPYING for more details.\n"
ifdef|#
directive|ifdef
name|EAP_TLS_FUNCS
literal|"\nThis product includes software developed by the OpenSSL Project\n"
literal|"for use in the OpenSSL Toolkit (http://www.openssl.org/)\n"
endif|#
directive|endif
comment|/* EAP_TLS_FUNCS */
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license
init|=
literal|"This program is free software; you can redistribute it and/or modify\n"
literal|"it under the terms of the GNU General Public License version 2 as\n"
literal|"published by the Free Software Foundation.\n"
literal|"\n"
literal|"This program is distributed in the hope that it will be useful,\n"
literal|"but WITHOUT ANY WARRANTY; without even the implied warranty of\n"
literal|"MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n"
literal|"GNU General Public License for more details.\n"
literal|"\n"
literal|"You should have received a copy of the GNU General Public License\n"
literal|"along with this program; if not, write to the Free Software\n"
literal|"Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA\n"
literal|"\n"
literal|"Alternatively, this software may be distributed under the terms of the\n"
literal|"BSD license.\n"
literal|"\n"
literal|"Redistribution and use in source and binary forms, with or without\n"
literal|"modification, are permitted provided that the following conditions are\n"
literal|"met:\n"
literal|"\n"
literal|"1. Redistributions of source code must retain the above copyright\n"
literal|"   notice, this list of conditions and the following disclaimer.\n"
literal|"\n"
literal|"2. Redistributions in binary form must reproduce the above copyright\n"
literal|"   notice, this list of conditions and the following disclaimer in the\n"
literal|"   documentation and/or other materials provided with the distribution.\n"
literal|"\n"
literal|"3. Neither the name(s) of the above-listed copyright holder(s) nor the\n"
literal|"   names of its contributors may be used to endorse or promote products\n"
literal|"   derived from this software without specific prior written permission.\n"
literal|"\n"
literal|"THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n"
literal|"\"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n"
literal|"LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n"
literal|"A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n"
literal|"OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n"
literal|"SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n"
literal|"LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n"
literal|"DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n"
literal|"THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n"
literal|"(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n"
literal|"OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n"
literal|"\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|wpa_driver_ops
modifier|*
name|wpa_supplicant_drivers
index|[]
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|wpa_supplicant_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpa_supplicant_driver_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|wait_for_interface
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_supplicant_associate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpa_supplicant_set_suites
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|u8
modifier|*
name|wpa_ie
parameter_list|,
name|int
modifier|*
name|wpa_ie_len
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_show_keys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_timestamp
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|wpa_msg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|level
parameter_list|,
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
specifier|const
name|int
name|buflen
init|=
literal|2048
decl_stmt|;
name|int
name|len
decl_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate message buffer for:\n"
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vprintf
argument_list|(
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return;
block|}
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|len
operator|=
name|vsnprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|level
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|wpa_supplicant_ctrl_iface_send
argument_list|(
name|wpa_s
argument_list|,
name|level
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpa_eapol_send
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|type
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|u8
modifier|*
name|msg
decl_stmt|,
modifier|*
name|dst
decl_stmt|,
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|size_t
name|msglen
decl_stmt|;
name|struct
name|l2_ethhdr
modifier|*
name|ethhdr
decl_stmt|;
name|struct
name|ieee802_1x_hdr
modifier|*
name|hdr
decl_stmt|;
name|int
name|res
decl_stmt|;
comment|/* TODO: could add l2_packet_sendmsg that allows fragments to avoid 	 * extra copy here */
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_PSK
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
condition|)
block|{
comment|/* Current SSID is not using IEEE 802.1X/EAP, so drop possible 		 * EAPOL frames (mainly, EAPOL-Start) from EAPOL state 		 * machines. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: drop TX EAPOL in non-IEEE 802.1X "
literal|"mode (type=%d len=%lu)"
argument_list|,
name|type
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|cur_pmksa
operator|&&
name|type
operator|==
name|IEEE802_1X_TYPE_EAPOL_START
condition|)
block|{
comment|/* Trying to use PMKSA caching - do not send EAPOL-Start frames 		 * since they will trigger full EAPOL authentication. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKSA caching - do not send "
literal|"EAPOL-Start"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSSID not set when trying to send an "
literal|"EAPOL frame"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|==
literal|0
operator|&&
name|memcmp
argument_list|(
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|dst
operator|=
name|bssid
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Using current BSSID "
name|MACSTR
literal|" from the driver as the EAPOL destination"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dst
operator|=
name|wpa_s
operator|->
name|last_eapol_src
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Using the source address of the"
literal|" last received EAPOL frame "
name|MACSTR
literal|" as "
literal|"the EAPOL destination"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* BSSID was already set (from (Re)Assoc event, so use it as 		 * the EAPOL destination. */
name|dst
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
block|}
name|msglen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ethhdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|len
expr_stmt|;
name|msg
operator|=
name|malloc
argument_list|(
name|msglen
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ethhdr
operator|=
operator|(
expr|struct
name|l2_ethhdr
operator|*
operator|)
name|msg
expr_stmt|;
name|memcpy
argument_list|(
name|ethhdr
operator|->
name|h_dest
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ethhdr
operator|->
name|h_source
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ethhdr
operator|->
name|h_proto
operator|=
name|htons
argument_list|(
name|ETH_P_EAPOL
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_hdr
operator|*
operator|)
operator|(
name|ethhdr
operator|+
literal|1
operator|)
expr_stmt|;
name|hdr
operator|->
name|version
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|eapol_version
expr_stmt|;
name|hdr
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TX EAPOL"
argument_list|,
name|msg
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
name|res
operator|=
name|l2_packet_send
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|,
name|msg
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|int
name|wpa_eapol_send_preauth
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|type
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|u8
modifier|*
name|msg
decl_stmt|;
name|size_t
name|msglen
decl_stmt|;
name|struct
name|l2_ethhdr
modifier|*
name|ethhdr
decl_stmt|;
name|struct
name|ieee802_1x_hdr
modifier|*
name|hdr
decl_stmt|;
name|int
name|res
decl_stmt|;
comment|/* TODO: could add l2_packet_sendmsg that allows fragments to avoid 	 * extra copy here */
if|if
condition|(
name|wpa_s
operator|->
name|l2_preauth
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|msglen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ethhdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|len
expr_stmt|;
name|msg
operator|=
name|malloc
argument_list|(
name|msglen
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ethhdr
operator|=
operator|(
expr|struct
name|l2_ethhdr
operator|*
operator|)
name|msg
expr_stmt|;
name|memcpy
argument_list|(
name|ethhdr
operator|->
name|h_dest
argument_list|,
name|wpa_s
operator|->
name|preauth_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ethhdr
operator|->
name|h_source
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ethhdr
operator|->
name|h_proto
operator|=
name|htons
argument_list|(
name|ETH_P_RSN_PREAUTH
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_hdr
operator|*
operator|)
operator|(
name|ethhdr
operator|+
literal|1
operator|)
expr_stmt|;
name|hdr
operator|->
name|version
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|eapol_version
expr_stmt|;
name|hdr
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|hdr
operator|->
name|length
operator|=
name|htons
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TX EAPOL (preauth)"
argument_list|,
name|msg
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
name|res
operator|=
name|l2_packet_send
argument_list|(
name|wpa_s
operator|->
name|l2_preauth
argument_list|,
name|msg
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_eapol_set_wep_key - set WEP key for the driver  * @ctx: pointer to wpa_supplicant data  * @unicast: 1 = individual unicast key, 0 = broadcast key  * @keyidx: WEP key index (0..3)  * @key: pointer to key data  * @keylen: key length in bytes  *  * Returns 0 on success or< 0 on error.  */
end_comment

begin_function
specifier|static
name|int
name|wpa_eapol_set_wep_key
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|unicast
parameter_list|,
name|int
name|keyidx
parameter_list|,
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_s
operator|->
name|keys_cleared
operator|=
literal|0
expr_stmt|;
return|return
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_WEP
argument_list|,
name|unicast
condition|?
name|wpa_s
operator|->
name|bssid
else|:
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|keyidx
argument_list|,
name|unicast
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Configure default/group WEP key for static WEP */
end_comment

begin_function
specifier|static
name|int
name|wpa_set_wep_key
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|set_tx
parameter_list|,
name|int
name|keyidx
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_s
operator|->
name|keys_cleared
operator|=
literal|0
expr_stmt|;
return|return
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_WEP
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
name|keyidx
argument_list|,
name|set_tx
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_set_wpa_none_key
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|u8
name|key
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|wpa_alg
name|alg
decl_stmt|;
name|u8
name|seq
index|[
literal|6
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
comment|/* IBSS/WPA-None uses only one key (Group) for both receiving and 	 * sending unicast and multicast packets. */
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|IEEE80211_MODE_IBSS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: Invalid mode %d (not IBSS/ad-hoc) "
literal|"for WPA-None"
argument_list|,
name|ssid
operator|->
name|mode
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: No PSK configured for WPA-None"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|wpa_s
operator|->
name|group_cipher
condition|)
block|{
case|case
name|WPA_CIPHER_CCMP
case|:
name|memcpy
argument_list|(
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|keylen
operator|=
literal|16
expr_stmt|;
name|alg
operator|=
name|WPA_ALG_CCMP
expr_stmt|;
break|break;
case|case
name|WPA_CIPHER_TKIP
case|:
comment|/* WPA-None uses the same Michael MIC key for both TX and RX */
name|memcpy
argument_list|(
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|16
operator|+
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|key
operator|+
literal|16
operator|+
literal|8
argument_list|,
name|ssid
operator|->
name|psk
operator|+
literal|16
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|keylen
operator|=
literal|32
expr_stmt|;
name|alg
operator|=
name|WPA_ALG_TKIP
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: Invalid group cipher %d for "
literal|"WPA-None"
argument_list|,
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: should actually remember the previously used seq#, both for TX 	 * and RX from each STA.. */
return|return
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|alg
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|seq
argument_list|,
literal|6
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_notify_eapol_done
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: EAPOL processing complete"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_blacklist
modifier|*
name|wpa_blacklist_get
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|;
name|e
operator|=
name|wpa_s
operator|->
name|blacklist
expr_stmt|;
while|while
condition|(
name|e
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|e
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|e
return|;
name|e
operator|=
name|e
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_blacklist_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|;
name|e
operator|=
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
condition|)
block|{
name|e
operator|->
name|count
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSSID "
name|MACSTR
literal|" blacklist count "
literal|"incremented to %d"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
name|e
operator|->
name|count
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|e
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|e
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
name|e
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|e
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|e
operator|->
name|count
operator|=
literal|1
expr_stmt|;
name|e
operator|->
name|next
operator|=
name|wpa_s
operator|->
name|blacklist
expr_stmt|;
name|wpa_s
operator|->
name|blacklist
operator|=
name|e
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Added BSSID "
name|MACSTR
literal|" into blacklist"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_blacklist_del
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|e
operator|=
name|wpa_s
operator|->
name|blacklist
expr_stmt|;
while|while
condition|(
name|e
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|e
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|blacklist
operator|=
name|e
operator|->
name|next
expr_stmt|;
block|}
else|else
block|{
name|prev
operator|->
name|next
operator|=
name|e
operator|->
name|next
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Removed BSSID "
name|MACSTR
literal|" from "
literal|"blacklist"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|e
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|prev
operator|=
name|e
expr_stmt|;
name|e
operator|=
name|e
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_blacklist_clear
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|e
operator|=
name|wpa_s
operator|->
name|blacklist
expr_stmt|;
name|wpa_s
operator|->
name|blacklist
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|e
condition|)
block|{
name|prev
operator|=
name|e
expr_stmt|;
name|e
operator|=
name|e
operator|->
name|next
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Removed BSSID "
name|MACSTR
literal|" from "
literal|"blacklist (clear)"
argument_list|,
name|MAC2STR
argument_list|(
name|prev
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|wpa_ssid_txt
parameter_list|(
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
specifier|static
name|char
name|ssid_txt
index|[
name|MAX_SSID_LEN
operator|+
literal|1
index|]
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|ssid_len
operator|>
name|MAX_SSID_LEN
condition|)
name|ssid_len
operator|=
name|MAX_SSID_LEN
expr_stmt|;
name|memcpy
argument_list|(
name|ssid_txt
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid_txt
index|[
name|ssid_len
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|pos
operator|=
name|ssid_txt
init|;
operator|*
name|pos
operator|!=
literal|'\0'
condition|;
name|pos
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|u8
operator|)
operator|*
name|pos
operator|<
literal|32
operator|||
operator|(
name|u8
operator|)
operator|*
name|pos
operator|>=
literal|127
condition|)
operator|*
name|pos
operator|=
literal|'_'
expr_stmt|;
block|}
return|return
name|ssid_txt
return|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_req_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|sec
parameter_list|,
name|int
name|usec
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Setting scan request: %d sec %d usec"
argument_list|,
name|sec
argument_list|,
name|usec
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
argument_list|,
name|usec
argument_list|,
name|wpa_supplicant_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_cancel_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Cancelling scan request"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Authentication with "
name|MACSTR
literal|" timed out."
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_disassociate
argument_list|(
name|wpa_s
argument_list|,
name|REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_req_auth_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|sec
parameter_list|,
name|int
name|usec
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Setting authentication timeout: %d sec "
literal|"%d usec"
argument_list|,
name|sec
argument_list|,
name|usec
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
argument_list|,
name|usec
argument_list|,
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_cancel_auth_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Cancelling authentication timeout"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_blacklist_del
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_initiate_eapol
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|eapol_config
name|eapol_conf
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_eap_fail
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
name|eapol_sm_notify_portControl
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|ForceAuthorized
argument_list|)
expr_stmt|;
else|else
name|eapol_sm_notify_portControl
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|Auto
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|eapol_conf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|eapol_conf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
name|eapol_conf
operator|.
name|accept_802_1x_keys
operator|=
literal|1
expr_stmt|;
name|eapol_conf
operator|.
name|required_keys
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|eapol_flags
operator|&
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
condition|)
block|{
name|eapol_conf
operator|.
name|required_keys
operator||=
name|EAPOL_REQUIRE_KEY_UNICAST
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|eapol_flags
operator|&
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
condition|)
block|{
name|eapol_conf
operator|.
name|required_keys
operator||=
name|EAPOL_REQUIRE_KEY_BROADCAST
expr_stmt|;
block|}
block|}
name|eapol_conf
operator|.
name|fast_reauth
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|fast_reauth
expr_stmt|;
name|eapol_conf
operator|.
name|workaround
operator|=
name|ssid
operator|->
name|eap_workaround
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|ssid
argument_list|,
operator|&
name|eapol_conf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_set_non_wpa_policy
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
expr_stmt|;
else|else
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_NONE
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_wpa_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie_len
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_rsn_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie_len
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|assoc_wpa_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|assoc_wpa_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|assoc_wpa_ie_len
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|>
literal|5
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_WEP104
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP104
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|>
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_WEP40
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP40
expr_stmt|;
break|break;
block|}
block|}
name|wpa_s
operator|->
name|cur_pmksa
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_select_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
condition|)
return|return
literal|0
return|;
name|ssid
operator|=
name|wpa_supplicant_get_ssid
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No network configuration found for the "
literal|"current AP"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Network configuration found for the current "
literal|"AP"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_PSK
operator||
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_WPA_NONE
operator|)
condition|)
block|{
name|u8
name|wpa_ie
index|[
literal|80
index|]
decl_stmt|;
name|int
name|wpa_ie_len
decl_stmt|;
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|,
name|wpa_ie
argument_list|,
operator|&
name|wpa_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_supplicant_initiate_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_cleanup
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|scard_deinit
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scard
operator|=
name|NULL
expr_stmt|;
name|eapol_sm_register_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_XSUPPLICANT_IFACE
if|if
condition|(
name|wpa_s
operator|->
name|dot1x_s
operator|>
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|wpa_s
operator|->
name|dot1x_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|dot1x_s
operator|=
operator|-
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_XSUPPLICANT_IFACE */
name|wpa_supplicant_ctrl_iface_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|!=
name|NULL
condition|)
block|{
name|wpa_config_free
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|=
name|NULL
expr_stmt|;
block|}
name|free
argument_list|(
name|wpa_s
operator|->
name|assoc_wpa_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|assoc_wpa_ie
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_wpa_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_rsn_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|confname
operator|=
name|NULL
expr_stmt|;
name|eapol_sm_deinit
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|eapol
operator|=
name|NULL
expr_stmt|;
name|rsn_preauth_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|pmksa_candidate_free
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|pmksa_cache_free
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_blacklist_clear
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|scan_results
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_results
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|num_scan_results
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_clear_keys
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|u8
modifier|*
name|bcast
init|=
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|keys_cleared
condition|)
block|{
comment|/* Some drivers (e.g., ndiswrapper& NDIS drivers) seem to have 		 * timing issues with keys being cleared just before new keys 		 * are set or just after association or something similar. This 		 * shows up in group key handshake failing often because of the 		 * client not receiving the first encrypted packets correctly. 		 * Skipping some of the extra key clearing steps seems to help 		 * in completing group key handshake more reliably. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No keys have been configured - "
literal|"skip key clearing"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|bcast
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|bcast
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|bcast
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|bcast
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|keys_cleared
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_stop_countermeasures
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|countermeasures
condition|)
block|{
name|wpa_s
operator|->
name|countermeasures
operator|=
literal|0
expr_stmt|;
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: TKIP countermeasures stopped"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_mark_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|wpa_state
operator|=
name|WPA_DISCONNECTED
expr_stmt|;
name|memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_PSK
condition|)
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_find_assoc_pmkid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|wpa_parse_wpa_ie
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_wpa_ie
argument_list|,
name|wpa_s
operator|->
name|assoc_wpa_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
operator|||
name|ie
operator|.
name|pmkid
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ie
operator|.
name|num_pmkid
condition|;
name|i
operator|++
control|)
block|{
name|wpa_s
operator|->
name|cur_pmksa
operator|=
name|pmksa_cache_get
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ie
operator|.
name|pmkid
operator|+
name|i
operator|*
name|PMKID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|cur_pmksa
condition|)
block|{
name|eapol_sm_notify_pmkid_attempt
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKID from assoc IE %sfound from PMKSA "
literal|"cache"
argument_list|,
name|wpa_s
operator|->
name|cur_pmksa
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_add_pmkid_candidate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: No data in PMKID candidate event"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKID candidate event - bssid="
name|MACSTR
literal|" index=%d preauth=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|pmkid_candidate
operator|.
name|bssid
argument_list|)
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|index
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|preauth
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|pmkid_candidate
operator|.
name|preauth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Ignored PMKID candidate without "
literal|"preauth flag"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pmksa_candidate_add
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|bssid
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|index
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_dynamic_keys
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
operator|!
operator|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|eapol_flags
operator|&
operator|(
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
operator||
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
operator|)
operator|)
condition|)
block|{
comment|/* IEEE 802.1X, but not using dynamic WEP keys (i.e., either 		 * plaintext or static WEP keys). */
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_associnfo
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|int
name|l
decl_stmt|,
name|len
decl_stmt|;
name|u8
modifier|*
name|p
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Association info event"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"req_ies"
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"resp_ies"
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|assoc_wpa_ie
condition|)
block|{
name|free
argument_list|(
name|wpa_s
operator|->
name|assoc_wpa_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|assoc_wpa_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|assoc_wpa_ie_len
operator|=
literal|0
expr_stmt|;
block|}
name|p
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
expr_stmt|;
name|l
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
expr_stmt|;
comment|/* Go through the IEs and make a copy of the WPA/RSN IE, if present. */
while|while
condition|(
name|l
operator|>=
literal|2
condition|)
block|{
name|len
operator|=
name|p
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|l
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Truncated IE in assoc_info"
argument_list|,
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|p
index|[
literal|0
index|]
operator|==
name|GENERIC_INFO_ELEM
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|6
operator|&&
operator|(
name|memcmp
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
literal|"\x00\x50\xF2\x01\x01\x00"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
name|p
index|[
literal|0
index|]
operator|==
name|RSN_INFO_ELEM
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|2
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|assoc_wpa_ie
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|assoc_wpa_ie
operator|==
name|NULL
condition|)
break|break;
name|wpa_s
operator|->
name|assoc_wpa_ie_len
operator|=
name|len
expr_stmt|;
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|assoc_wpa_ie
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"assoc_wpa_ie"
argument_list|,
name|wpa_s
operator|->
name|assoc_wpa_ie
argument_list|,
name|wpa_s
operator|->
name|assoc_wpa_ie_len
argument_list|)
expr_stmt|;
name|wpa_find_assoc_pmkid
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
block|}
name|l
operator|-=
name|len
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
block|}
comment|/* WPA/RSN IE from Beacon/ProbeResp */
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_wpa_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie_len
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_rsn_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie_len
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
expr_stmt|;
name|l
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies_len
expr_stmt|;
comment|/* Go through the IEs and make a copy of the WPA/RSN IEs, if present. 	 */
while|while
condition|(
name|l
operator|>=
literal|2
condition|)
block|{
name|len
operator|=
name|p
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|l
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Truncated IE in beacon_ies"
argument_list|,
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|ap_wpa_ie
operator|==
name|NULL
operator|&&
name|p
index|[
literal|0
index|]
operator|==
name|GENERIC_INFO_ELEM
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|6
operator|&&
name|memcmp
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
literal|"\x00\x50\xF2\x01\x01\x00"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|ap_wpa_ie
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_wpa_ie
condition|)
block|{
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|ap_wpa_ie
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie_len
operator|=
name|len
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|ap_rsn_ie
operator|==
name|NULL
operator|&&
name|p
index|[
literal|0
index|]
operator|==
name|RSN_INFO_ELEM
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|2
condition|)
block|{
name|wpa_s
operator|->
name|ap_rsn_ie
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_rsn_ie
condition|)
block|{
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|ap_rsn_ie
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie_len
operator|=
name|len
expr_stmt|;
block|}
block|}
name|l
operator|-=
name|len
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpa_supplicant_event
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|wpa_event_type
name|event
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|int
name|pairwise
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|EVENT_ASSOC
case|:
name|wpa_s
operator|->
name|wpa_state
operator|=
name|WPA_ASSOCIATED
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Association event - clear replay "
literal|"counter"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wpa_s
operator|->
name|rx_replay_counter
argument_list|,
literal|0
argument_list|,
name|WPA_REPLAY_COUNTER_LEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|rx_replay_counter_set
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|renew_snonce
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|>=
literal|0
operator|&&
name|memcmp
argument_list|(
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Associated to a new BSS: "
literal|"BSSID="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_dynamic_keys
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_select_config
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Associated with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set portEnabled first to FALSE in order to get EAP state 		 * machine out of the SUCCESS state and eapSuccess cleared. 		 * Without this, EAPOL PAE state machine may transit to 		 * AUTHENTICATING state based on obsolete eapSuccess and then 		 * trigger BE_AUTH to SUCCESS and PAE to AUTHENTICATED without 		 * ever giving chance to EAP state machine to reset the state. 		 */
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_PSK
condition|)
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* 802.1X::portControl = Auto */
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|eapol_received
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Timeout for receiving the first EAPOL packet */
name|wpa_supplicant_req_auth_timeout
argument_list|(
name|wpa_s
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|EVENT_DISASSOC
case|:
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* At least Host AP driver and a Prism3 card seemed to 			 * be generating streams of disconnected events when 			 * configuring IBSS for WPA-None. Ignore them for now. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Disconnect event - ignore in "
literal|"IBSS/WPA-None mode"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_ASSOCIATED
condition|)
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Disconnect event - remove keys"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_dynamic_keys
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_s
operator|->
name|keys_cleared
operator|=
literal|0
expr_stmt|;
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|EVENT_MICHAEL_MIC_FAILURE
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"Michael MIC failure detected"
argument_list|)
expr_stmt|;
name|pairwise
operator|=
operator|(
name|data
operator|&&
name|data
operator|->
name|michael_mic_failure
operator|.
name|unicast
operator|)
expr_stmt|;
name|wpa_supplicant_key_request
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
name|pairwise
argument_list|)
expr_stmt|;
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|last_michael_mic_error
operator|&&
name|now
operator|-
name|wpa_s
operator|->
name|last_michael_mic_error
operator|<=
literal|60
condition|)
block|{
comment|/* initialize countermeasures */
name|wpa_s
operator|->
name|countermeasures
operator|=
literal|1
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"TKIP countermeasures "
literal|"started"
argument_list|)
expr_stmt|;
comment|/* Need to wait for completion of request frame. We do 			 * not get any callback for the message completion, so 			 * just wait a short while and hope for the best. */
name|usleep
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|REASON_MICHAEL_MIC_FAILURE
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_stop_countermeasures
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|60
argument_list|,
literal|0
argument_list|,
name|wpa_supplicant_stop_countermeasures
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* TODO: mark the AP rejected for 60 second. STA is 			 * allowed to associate with another AP.. */
block|}
name|wpa_s
operator|->
name|last_michael_mic_error
operator|=
name|now
expr_stmt|;
break|break;
case|case
name|EVENT_SCAN_RESULTS
case|:
name|wpa_supplicant_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_ASSOCINFO
case|:
name|wpa_supplicant_associnfo
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_INTERFACE_STATUS
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|data
operator|->
name|interface_status
operator|.
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
break|break;
switch|switch
condition|(
name|data
operator|->
name|interface_status
operator|.
name|ievent
condition|)
block|{
case|case
name|EVENT_INTERFACE_ADDED
case|:
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|interface_removed
condition|)
break|break;
name|wpa_s
operator|->
name|interface_removed
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configured interface was "
literal|"added."
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_driver_init
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to initialize "
literal|"the driver after interface was "
literal|"added."
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|EVENT_INTERFACE_REMOVED
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configured interface was "
literal|"removed."
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|interface_removed
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|EVENT_PMKID_CANDIDATE
case|:
name|wpa_supplicant_add_pmkid_candidate
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown event %d"
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_terminate
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|head
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Signal %d received - terminating"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
block|}
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpa_supplicant_reload_configuration
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_config
modifier|*
name|conf
decl_stmt|;
name|int
name|reconf_ctrl
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|confname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|conf
operator|=
name|wpa_config_read
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to parse the configuration "
literal|"file '%s' - exiting"
argument_list|,
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|reconf_ctrl
operator|=
operator|!
operator|!
name|conf
operator|->
name|ctrl_interface
operator|!=
operator|!
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
operator|||
operator|(
name|conf
operator|->
name|ctrl_interface
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
operator|&&
name|strcmp
argument_list|(
name|conf
operator|->
name|ctrl_interface
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|reconf_ctrl
condition|)
name|wpa_supplicant_ctrl_iface_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rsn_preauth_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_config_free
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|=
name|conf
expr_stmt|;
if|if
condition|(
name|reconf_ctrl
condition|)
name|wpa_supplicant_ctrl_iface_init
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Reconfiguration completed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_function
specifier|static
name|void
name|wpa_supplicant_reconfig
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Signal %d received - reconfiguring"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|head
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_supplicant_reload_configuration
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_function
specifier|static
name|void
name|wpa_supplicant_gen_assoc_event
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|ssid
operator|=
name|wpa_supplicant_get_ssid
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Already associated with a configured network - "
literal|"generating associated event"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_ASSOC
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_scan
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|0
condition|)
block|{
name|wpa_supplicant_gen_assoc_event
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
condition|)
block|{
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return;
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_DISCONNECTED
condition|)
name|wpa_s
operator|->
name|wpa_state
operator|=
name|WPA_SCANNING
expr_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|prev_scan_ssid
operator|!=
name|BROADCAST_SSID_SCAN
condition|)
block|{
while|while
condition|(
name|ssid
condition|)
block|{
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|prev_scan_ssid
condition|)
block|{
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
break|break;
block|}
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
block|}
block|}
while|while
condition|(
name|ssid
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|scan_ssid
condition|)
break|break;
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Starting AP scan (%s SSID)"
argument_list|,
name|ssid
condition|?
literal|"specific"
else|:
literal|"broadcast"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan SSID"
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|ssid
expr_stmt|;
block|}
else|else
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|BROADCAST_SSID_SCAN
expr_stmt|;
if|if
condition|(
name|wpa_drv_scan
argument_list|(
name|wpa_s
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid_len
else|:
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to initiate AP scan."
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|wpa_cipher
name|cipher_suite2driver
parameter_list|(
name|int
name|cipher
parameter_list|)
block|{
switch|switch
condition|(
name|cipher
condition|)
block|{
case|case
name|WPA_CIPHER_NONE
case|:
return|return
name|CIPHER_NONE
return|;
case|case
name|WPA_CIPHER_WEP40
case|:
return|return
name|CIPHER_WEP40
return|;
case|case
name|WPA_CIPHER_WEP104
case|:
return|return
name|CIPHER_WEP104
return|;
case|case
name|WPA_CIPHER_CCMP
case|:
return|return
name|CIPHER_CCMP
return|;
case|case
name|WPA_CIPHER_TKIP
case|:
default|default:
return|return
name|CIPHER_TKIP
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|wpa_key_mgmt
name|key_mgmt2driver
parameter_list|(
name|int
name|key_mgmt
parameter_list|)
block|{
switch|switch
condition|(
name|key_mgmt
condition|)
block|{
case|case
name|WPA_KEY_MGMT_NONE
case|:
return|return
name|KEY_MGMT_NONE
return|;
case|case
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
case|:
return|return
name|KEY_MGMT_802_1X_NO_WPA
return|;
case|case
name|WPA_KEY_MGMT_IEEE8021X
case|:
return|return
name|KEY_MGMT_802_1X
return|;
case|case
name|WPA_KEY_MGMT_WPA_NONE
case|:
return|return
name|KEY_MGMT_WPA_NONE
return|;
case|case
name|WPA_KEY_MGMT_PSK
case|:
default|default:
return|return
name|KEY_MGMT_PSK
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_suites_from_ai
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_ie_data
modifier|*
name|ie
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|assoc_wpa_ie
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_parse_wpa_ie
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_wpa_ie
argument_list|,
name|wpa_s
operator|->
name|assoc_wpa_ie_len
argument_list|,
name|ie
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Failed to parse WPA IE from "
literal|"association info"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Using WPA IE from AssocReq to set cipher "
literal|"suites"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver used disabled group "
literal|"cipher 0x%x (mask 0x%x) - reject"
argument_list|,
name|ie
operator|->
name|group_cipher
argument_list|,
name|ssid
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver used disabled pairwise "
literal|"cipher 0x%x (mask 0x%x) - reject"
argument_list|,
name|ie
operator|->
name|pairwise_cipher
argument_list|,
name|ssid
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver used disabled key "
literal|"management 0x%x (mask 0x%x) - reject"
argument_list|,
name|ie
operator|->
name|key_mgmt
argument_list|,
name|ssid
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_set_suites
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|u8
modifier|*
name|wpa_ie
parameter_list|,
name|int
modifier|*
name|wpa_ie_len
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|sel
decl_stmt|,
name|proto
decl_stmt|;
name|u8
modifier|*
name|ap_ie
decl_stmt|;
name|size_t
name|ap_ie_len
decl_stmt|;
if|if
condition|(
name|bss
operator|&&
name|bss
operator|->
name|rsn_ie_len
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: using IEEE 802.11i/D9.0"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
name|ap_ie
operator|=
name|bss
operator|->
name|rsn_ie
expr_stmt|;
name|ap_ie_len
operator|=
name|bss
operator|->
name|rsn_ie_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using IEEE 802.11i/D3.0"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
name|ap_ie
operator|=
name|bss
operator|->
name|wpa_ie
expr_stmt|;
name|ap_ie_len
operator|=
name|bss
operator|->
name|wpa_ie_len
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
condition|)
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
else|else
name|proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
name|ap_ie
operator|=
name|NULL
expr_stmt|;
name|ap_ie_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_suites_from_ai
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
condition|)
block|{
name|memset
argument_list|(
operator|&
name|ie
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
argument_list|)
expr_stmt|;
name|ie
operator|.
name|group_cipher
operator|=
name|ssid
operator|->
name|group_cipher
expr_stmt|;
name|ie
operator|.
name|pairwise_cipher
operator|=
name|ssid
operator|->
name|pairwise_cipher
expr_stmt|;
name|ie
operator|.
name|key_mgmt
operator|=
name|ssid
operator|->
name|key_mgmt
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Set cipher suites based "
literal|"on configuration"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ap_ie
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|wpa_s
argument_list|,
name|ap_ie
argument_list|,
name|ap_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to parse WPA IE for "
literal|"the selected BSS."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Selected cipher suites: group %d "
literal|"pairwise %d key_mgmt %d"
argument_list|,
name|ie
operator|.
name|group_cipher
argument_list|,
name|ie
operator|.
name|pairwise_cipher
argument_list|,
name|ie
operator|.
name|key_mgmt
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|proto
operator|=
name|proto
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_wpa_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bss
operator|&&
name|bss
operator|->
name|wpa_ie_len
condition|)
block|{
name|wpa_s
operator|->
name|ap_wpa_ie
operator|=
name|malloc
argument_list|(
name|bss
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_wpa_ie
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: malloc failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|ap_wpa_ie
argument_list|,
name|bss
operator|->
name|wpa_ie
argument_list|,
name|bss
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie_len
operator|=
name|bss
operator|->
name|wpa_ie_len
expr_stmt|;
block|}
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_rsn_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bss
operator|&&
name|bss
operator|->
name|rsn_ie_len
condition|)
block|{
name|wpa_s
operator|->
name|ap_rsn_ie
operator|=
name|malloc
argument_list|(
name|bss
operator|->
name|rsn_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_rsn_ie
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: malloc failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|ap_rsn_ie
argument_list|,
name|bss
operator|->
name|rsn_ie
argument_list|,
name|bss
operator|->
name|rsn_ie_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie_len
operator|=
name|bss
operator|->
name|rsn_ie_len
expr_stmt|;
block|}
name|sel
operator|=
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK CCMP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK TKIP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_WEP104
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP104
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK WEP104"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_WEP40
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP40
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK WEP40"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select group cipher."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sel
operator|=
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK CCMP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK TKIP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_NONE
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK NONE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select pairwise "
literal|"cipher."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sel
operator|=
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT 802.1X"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT WPA-PSK"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_WPA_NONE
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT WPA-NONE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select authenticated "
literal|"key management type."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|wpa_ie_len
operator|=
name|wpa_gen_wpa_ie
argument_list|(
name|wpa_s
argument_list|,
name|wpa_ie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|wpa_ie_len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to generate WPA IE."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Own WPA IE"
argument_list|,
name|wpa_ie
argument_list|,
operator|*
name|wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|assoc_wpa_ie
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * Make a copy of the WPA/RSN IE so that 4-Way Handshake gets 		 * the correct version of the IE even if PMKSA caching is 		 * aborted (which would remove PMKID from IE generation). 		 */
name|wpa_s
operator|->
name|assoc_wpa_ie
operator|=
name|malloc
argument_list|(
operator|*
name|wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|assoc_wpa_ie
condition|)
block|{
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|assoc_wpa_ie
argument_list|,
name|wpa_ie
argument_list|,
operator|*
name|wpa_ie_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|assoc_wpa_ie_len
operator|=
operator|*
name|wpa_ie_len
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|wpa_s
operator|->
name|pmk_len
operator|=
name|PMK_LEN
expr_stmt|;
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|pmk
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|cur_pmksa
condition|)
block|{
name|wpa_s
operator|->
name|pmk_len
operator|=
name|wpa_s
operator|->
name|cur_pmksa
operator|->
name|pmk_len
expr_stmt|;
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|pmk
argument_list|,
name|wpa_s
operator|->
name|cur_pmksa
operator|->
name|pmk
argument_list|,
name|wpa_s
operator|->
name|pmk_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_s
operator|->
name|pmk_len
operator|=
name|PMK_LEN
expr_stmt|;
name|memset
argument_list|(
name|wpa_s
operator|->
name|pmk
argument_list|,
literal|0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_XSUPPLICANT_IFACE
name|wpa_s
operator|->
name|ext_pmk_received
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_XSUPPLICANT_IFACE */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_associate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|u8
name|wpa_ie
index|[
literal|80
index|]
decl_stmt|;
name|int
name|wpa_ie_len
decl_stmt|;
name|int
name|use_crypt
decl_stmt|;
name|int
name|algs
init|=
name|AUTH_ALG_OPEN_SYSTEM
decl_stmt|;
name|int
name|cipher_pairwise
decl_stmt|,
name|cipher_group
decl_stmt|;
name|struct
name|wpa_driver_associate_params
name|params
decl_stmt|;
name|int
name|wep_keys_set
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Trying to associate with "
name|MACSTR
literal|" (SSID='%s' freq=%d MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Trying to associate with SSID '%s'"
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
comment|/* Starting new association, so clear the possibly used WPA IE from the 	 * previous association. */
name|free
argument_list|(
name|wpa_s
operator|->
name|assoc_wpa_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|assoc_wpa_ie
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|assoc_wpa_ie_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|leap
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|non_leap
operator|==
literal|0
condition|)
name|algs
operator|=
name|AUTH_ALG_LEAP
expr_stmt|;
else|else
name|algs
operator||=
name|AUTH_ALG_LEAP
expr_stmt|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Automatic auth_alg selection: 0x%x"
argument_list|,
name|algs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
condition|)
block|{
name|algs
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_OPEN
condition|)
name|algs
operator||=
name|AUTH_ALG_OPEN_SYSTEM
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_SHARED
condition|)
name|algs
operator||=
name|AUTH_ALG_SHARED_KEY
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|&
name|WPA_AUTH_ALG_LEAP
condition|)
name|algs
operator||=
name|AUTH_ALG_LEAP
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Overriding auth_alg selection: 0x%x"
argument_list|,
name|algs
argument_list|)
expr_stmt|;
block|}
name|wpa_drv_set_auth_alg
argument_list|(
name|wpa_s
argument_list|,
name|algs
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|&&
operator|(
name|bss
operator|->
name|wpa_ie_len
operator|||
name|bss
operator|->
name|rsn_ie_len
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_PSK
operator|)
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|cur_pmksa
operator|=
name|pmksa_cache_get
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|cur_pmksa
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKID"
argument_list|,
name|wpa_s
operator|->
name|cur_pmksa
operator|->
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
name|eapol_sm_notify_pmkid_attempt
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ssid
argument_list|,
name|wpa_ie
argument_list|,
operator|&
name|wpa_ie_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to set WPA key "
literal|"management and encryption suites"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_PSK
operator||
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_WPA_NONE
operator|)
condition|)
block|{
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|,
name|wpa_ie
argument_list|,
operator|&
name|wpa_ie_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to set WPA key "
literal|"management and encryption suites (no scan "
literal|"results)"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|bss
condition|?
name|bss
operator|->
name|bssid
else|:
name|NULL
argument_list|)
expr_stmt|;
name|use_crypt
operator|=
literal|1
expr_stmt|;
name|cipher_pairwise
operator|=
name|cipher_suite2driver
argument_list|(
name|wpa_s
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
name|cipher_group
operator|=
name|cipher_suite2driver
argument_list|(
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
condition|)
name|use_crypt
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
block|{
name|use_crypt
operator|=
literal|1
expr_stmt|;
name|wep_keys_set
operator|=
literal|1
expr_stmt|;
name|wpa_set_wep_key
argument_list|(
name|wpa_s
argument_list|,
name|i
operator|==
name|ssid
operator|->
name|wep_tx_keyidx
argument_list|,
name|i
argument_list|,
name|ssid
operator|->
name|wep_key
index|[
name|i
index|]
argument_list|,
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
operator|(
name|ssid
operator|->
name|eapol_flags
operator|&
operator|(
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
operator||
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
operator|)
operator|)
operator|==
literal|0
operator|&&
operator|!
name|wep_keys_set
condition|)
block|{
name|use_crypt
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* Assume that dynamic WEP-104 keys will be used and 			 * set cipher suites in order for drivers to expect 			 * encryption. */
name|cipher_pairwise
operator|=
name|cipher_group
operator|=
name|CIPHER_WEP104
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* Set the key before (and later after) association */
name|wpa_supplicant_set_wpa_none_key
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
name|wpa_drv_set_drop_unencrypted
argument_list|(
name|wpa_s
argument_list|,
name|use_crypt
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wpa_state
operator|=
name|WPA_ASSOCIATING
expr_stmt|;
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|params
operator|.
name|bssid
operator|=
name|bss
operator|->
name|bssid
expr_stmt|;
name|params
operator|.
name|ssid
operator|=
name|bss
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
name|params
operator|.
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|ssid
operator|=
name|ssid
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
block|}
name|params
operator|.
name|wpa_ie
operator|=
name|wpa_ie
expr_stmt|;
name|params
operator|.
name|wpa_ie_len
operator|=
name|wpa_ie_len
expr_stmt|;
name|params
operator|.
name|pairwise_suite
operator|=
name|cipher_pairwise
expr_stmt|;
name|params
operator|.
name|group_suite
operator|=
name|cipher_group
expr_stmt|;
name|params
operator|.
name|key_mgmt_suite
operator|=
name|key_mgmt2driver
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|algs
expr_stmt|;
name|params
operator|.
name|mode
operator|=
name|ssid
operator|->
name|mode
expr_stmt|;
if|if
condition|(
name|wpa_drv_associate
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Association request to the driver "
literal|"failed"
argument_list|)
expr_stmt|;
comment|/* try to continue anyway; new association will be tried again 		 * after timeout */
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* Set the key after the association just in case association 		 * cleared the previously configured key. */
name|wpa_supplicant_set_wpa_none_key
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
comment|/* No need to timeout authentication since there is no key 		 * management. */
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Timeout for IEEE 802.11 authentication and association */
name|wpa_supplicant_req_auth_timeout
argument_list|(
name|wpa_s
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wep_keys_set
operator|&&
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
operator|==
literal|0
operator|&&
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SET_KEYS_AFTER_ASSOC
condition|)
block|{
comment|/* Set static WEP keys again */
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
block|{
name|wpa_set_wep_key
argument_list|(
name|wpa_s
argument_list|,
name|i
operator|==
name|ssid
operator|->
name|wep_tx_keyidx
argument_list|,
name|i
argument_list|,
name|ssid
operator|->
name|wep_key
index|[
name|i
index|]
argument_list|,
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_supplicant_initiate_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_disassociate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|u8
modifier|*
name|addr
init|=
name|NULL
decl_stmt|;
name|wpa_s
operator|->
name|wpa_state
operator|=
name|WPA_DISCONNECTED
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_drv_disassociate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|addr
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_deauthenticate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|u8
modifier|*
name|addr
init|=
name|NULL
decl_stmt|;
name|wpa_s
operator|->
name|wpa_state
operator|=
name|WPA_DISCONNECTED
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_drv_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|addr
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_imsi_identity
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|aka
init|=
literal|0
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|ssid
operator|->
name|eap_methods
decl_stmt|;
while|while
condition|(
name|pos
operator|&&
operator|*
name|pos
operator|!=
name|EAP_TYPE_NONE
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
name|EAP_TYPE_AKA
condition|)
block|{
name|aka
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|identity
operator|==
name|NULL
operator|&&
name|wpa_s
operator|->
name|imsi
condition|)
block|{
name|ssid
operator|->
name|identity
operator|=
name|malloc
argument_list|(
literal|1
operator|+
name|wpa_s
operator|->
name|imsi_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|identity
condition|)
block|{
name|ssid
operator|->
name|identity
index|[
literal|0
index|]
operator|=
name|aka
condition|?
literal|'0'
else|:
literal|'1'
expr_stmt|;
name|memcpy
argument_list|(
name|ssid
operator|->
name|identity
operator|+
literal|1
argument_list|,
name|wpa_s
operator|->
name|imsi
argument_list|,
name|wpa_s
operator|->
name|imsi_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|identity_len
operator|=
literal|1
operator|+
name|wpa_s
operator|->
name|imsi_len
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"permanent identity from "
literal|"IMSI"
argument_list|,
name|ssid
operator|->
name|identity
argument_list|,
name|ssid
operator|->
name|identity_len
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_scard_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|pcsc
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|scard
operator|!=
name|NULL
condition|)
block|{
name|wpa_supplicant_imsi_identity
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Selected network is configured to use SIM - "
literal|"initialize PCSC"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scard
operator|=
name|scard_init
argument_list|(
name|SCARD_TRY_BOTH
argument_list|,
name|ssid
operator|->
name|pin
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|scard
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to initialize SIM "
literal|"(pcsc-lite)"
argument_list|)
expr_stmt|;
comment|/* TODO: what to do here? */
return|return;
block|}
name|eapol_sm_register_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|scard_get_imsi
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to get IMSI from SIM"
argument_list|)
expr_stmt|;
comment|/* TODO: what to do here? */
return|return;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IMSI"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|wpa_s
operator|->
name|imsi
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|imsi
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|imsi
condition|)
block|{
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|imsi
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|imsi_len
operator|=
name|len
expr_stmt|;
name|wpa_supplicant_imsi_identity
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_scan_result
modifier|*
name|wpa_supplicant_select_bss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|group
parameter_list|,
name|struct
name|wpa_scan_result
modifier|*
name|results
parameter_list|,
name|int
name|num
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
modifier|*
name|selected_ssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|struct
name|wpa_scan_result
modifier|*
name|bss
decl_stmt|,
modifier|*
name|selected
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Selecting BSS from priority group %d"
argument_list|,
name|group
operator|->
name|priority
argument_list|)
expr_stmt|;
name|bss
operator|=
name|NULL
expr_stmt|;
name|ssid
operator|=
name|NULL
expr_stmt|;
comment|/* First, try to find WPA-enabled AP */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
operator|&&
operator|!
name|selected
condition|;
name|i
operator|++
control|)
block|{
name|bss
operator|=
operator|&
name|results
index|[
name|i
index|]
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%d: "
name|MACSTR
literal|" ssid='%s' "
literal|"wpa_ie_len=%lu rsn_ie_len=%lu"
argument_list|,
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|bss
operator|->
name|wpa_ie_len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|bss
operator|->
name|rsn_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|e
operator|=
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
operator|)
operator|&&
name|e
operator|->
name|count
operator|>
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - blacklisted"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bss
operator|->
name|wpa_ie_len
operator|==
literal|0
operator|&&
name|bss
operator|->
name|rsn_ie_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - no WPA/RSN IE"
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|ssid
operator|=
name|group
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|pnext
control|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|ssid_len
operator|!=
name|ssid
operator|->
name|ssid_len
operator|||
name|memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"SSID mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ssid
operator|->
name|bssid_set
operator|&&
name|memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"BSSID mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
operator|(
operator|(
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|rsn_ie
argument_list|,
name|bss
operator|->
name|rsn_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_WPA
operator|)
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|wpa_ie
argument_list|,
name|bss
operator|->
name|wpa_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"could not parse WPA/RSN IE"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|proto
operator|&
name|ssid
operator|->
name|proto
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"proto mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"PTK cipher mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"GTK cipher mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - "
literal|"key mgmt mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|selected
operator|=
name|bss
expr_stmt|;
operator|*
name|selected_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* If no WPA-enabled AP found, try to find non-WPA AP, if configuration 	 * allows this. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
operator|&&
operator|!
name|selected
condition|;
name|i
operator|++
control|)
block|{
name|bss
operator|=
operator|&
name|results
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|e
operator|=
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
operator|)
operator|&&
name|e
operator|->
name|count
operator|>
literal|1
condition|)
block|{
continue|continue;
block|}
for|for
control|(
name|ssid
operator|=
name|group
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|pnext
control|)
block|{
if|if
condition|(
name|bss
operator|->
name|ssid_len
operator|==
name|ssid
operator|->
name|ssid_len
operator|&&
name|memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
operator|&&
operator|(
operator|!
name|ssid
operator|->
name|bssid_set
operator|||
name|memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_NONE
operator|)
operator|||
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
operator|)
condition|)
block|{
name|selected
operator|=
name|bss
expr_stmt|;
operator|*
name|selected_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected non-WPA AP "
name|MACSTR
literal|" ssid='%s'"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
name|selected
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_get_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
define|#
directive|define
name|SCAN_AP_LIMIT
value|128
name|struct
name|wpa_scan_result
modifier|*
name|results
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|int
name|num
decl_stmt|;
name|results
operator|=
name|malloc
argument_list|(
name|SCAN_AP_LIMIT
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|results
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to allocate memory for scan "
literal|"results"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|num
operator|=
name|wpa_drv_get_scan_results
argument_list|(
name|wpa_s
argument_list|,
name|results
argument_list|,
name|SCAN_AP_LIMIT
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan results: %d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to get scan results"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|results
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|num
operator|>
name|SCAN_AP_LIMIT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Not enough room for all APs (%d< %d)"
argument_list|,
name|num
argument_list|,
name|SCAN_AP_LIMIT
argument_list|)
expr_stmt|;
name|num
operator|=
name|SCAN_AP_LIMIT
expr_stmt|;
block|}
comment|/* Free unneeded memory for unused scan result entries */
name|tmp
operator|=
name|realloc
argument_list|(
name|results
argument_list|,
name|num
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|||
name|num
operator|==
literal|0
condition|)
block|{
name|results
operator|=
name|tmp
expr_stmt|;
block|}
name|free
argument_list|(
name|wpa_s
operator|->
name|scan_results
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_results
operator|=
name|results
expr_stmt|;
name|wpa_s
operator|->
name|num_scan_results
operator|=
name|num
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|num
decl_stmt|,
name|prio
decl_stmt|;
name|struct
name|wpa_scan_result
modifier|*
name|selected
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|struct
name|wpa_scan_result
modifier|*
name|results
decl_stmt|;
if|if
condition|(
name|wpa_supplicant_get_scan_results
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to get scan results - try "
literal|"scanning again"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|results
operator|=
name|wpa_s
operator|->
name|scan_results
expr_stmt|;
name|num
operator|=
name|wpa_s
operator|->
name|num_scan_results
expr_stmt|;
while|while
condition|(
name|selected
operator|==
name|NULL
condition|)
block|{
for|for
control|(
name|prio
operator|=
literal|0
init|;
name|prio
operator|<
name|wpa_s
operator|->
name|conf
operator|->
name|num_prio
condition|;
name|prio
operator|++
control|)
block|{
name|selected
operator|=
name|wpa_supplicant_select_bss
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|pssid
index|[
name|prio
index|]
argument_list|,
name|results
argument_list|,
name|num
argument_list|,
operator|&
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|selected
condition|)
break|break;
block|}
if|if
condition|(
name|selected
operator|==
name|NULL
operator|&&
name|wpa_s
operator|->
name|blacklist
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No APs found - clear blacklist "
literal|"and try again"
argument_list|)
expr_stmt|;
name|wpa_blacklist_clear
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|selected
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|selected
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|reassociate
operator|||
name|memcmp
argument_list|(
name|selected
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_supplicant_scard_init
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Already associated with the "
literal|"selected AP."
argument_list|)
expr_stmt|;
block|}
name|rsn_preauth_scan_results
argument_list|(
name|wpa_s
argument_list|,
name|results
argument_list|,
name|num
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No suitable AP found."
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_get_beacon_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_scan_result
modifier|*
name|results
decl_stmt|,
modifier|*
name|curr
init|=
name|NULL
decl_stmt|;
name|results
operator|=
name|wpa_s
operator|->
name|scan_results
expr_stmt|;
if|if
condition|(
name|results
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|num_scan_results
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|results
index|[
name|i
index|]
operator|.
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|curr
operator|=
operator|&
name|results
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|curr
condition|)
block|{
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_wpa_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_wpa_ie_len
operator|=
name|curr
operator|->
name|wpa_ie_len
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|wpa_ie_len
condition|)
block|{
name|wpa_s
operator|->
name|ap_wpa_ie
operator|=
name|malloc
argument_list|(
name|wpa_s
operator|->
name|ap_wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_wpa_ie
condition|)
block|{
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|ap_wpa_ie
argument_list|,
name|curr
operator|->
name|wpa_ie
argument_list|,
name|curr
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|wpa_s
operator|->
name|ap_wpa_ie
operator|=
name|NULL
expr_stmt|;
block|}
name|free
argument_list|(
name|wpa_s
operator|->
name|ap_rsn_ie
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_rsn_ie_len
operator|=
name|curr
operator|->
name|rsn_ie_len
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|rsn_ie_len
condition|)
block|{
name|wpa_s
operator|->
name|ap_rsn_ie
operator|=
name|malloc
argument_list|(
name|wpa_s
operator|->
name|ap_rsn_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_rsn_ie
condition|)
block|{
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|ap_rsn_ie
argument_list|,
name|curr
operator|->
name|rsn_ie
argument_list|,
name|curr
operator|->
name|rsn_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|wpa_s
operator|->
name|ap_rsn_ie
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpa_supplicant_get_beacon_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_get_beacon_ie
argument_list|(
name|wpa_s
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/* No WPA/RSN IE found in the cached scan results. Try to get updated 	 * scan results from the driver. */
if|if
condition|(
name|wpa_supplicant_get_scan_results
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
name|wpa_get_beacon_ie
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_XSUPPLICANT_IFACE
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_dot1x_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|u8
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|recv
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Receive from dot1x (Xsupplicant) socket "
literal|"==> %d"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recv"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|res
operator|!=
name|PMK_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPA: Invalid master key length (%d) "
literal|"from dot1x"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Master key (dot1x)"
argument_list|,
name|buf
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
block|{
name|memcpy
argument_list|(
name|wpa_s
operator|->
name|pmk
argument_list|,
name|buf
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ext_pmk_received
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA: Not in IEEE 802.1X mode - dropping "
literal|"dot1x PMK update (%d)"
argument_list|,
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_802_1x_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|AF_LOCAL
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_LOCAL
expr_stmt|;
name|addr
operator|.
name|sun_path
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|snprintf
argument_list|(
name|addr
operator|.
name|sun_path
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
operator|-
literal|1
argument_list|,
literal|"wpa_supplicant"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|dot1x_s
operator|=
name|s
expr_stmt|;
name|eloop_register_read_sock
argument_list|(
name|s
argument_list|,
name|wpa_supplicant_dot1x_receive
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_XSUPPLICANT_IFACE */
end_comment

begin_function
specifier|static
name|int
name|wpa_supplicant_set_driver
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_supplicant_drivers
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"No driver interfaces build into "
literal|"wpa_supplicant."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
comment|/* default to first driver in the list */
name|wpa_s
operator|->
name|driver
operator|=
name|wpa_supplicant_drivers
index|[
literal|0
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_supplicant_drivers
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|wpa_supplicant_drivers
index|[
name|i
index|]
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|driver
operator|=
name|wpa_supplicant_drivers
index|[
name|i
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|printf
argument_list|(
literal|"Unsupported driver '%s'.\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_fd_workaround
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|s
decl_stmt|,
name|i
decl_stmt|;
comment|/* When started from pcmcia-cs scripts, wpa_supplicant might start with 	 * fd 0, 1, and 2 closed. This will cause some issues because many 	 * places in wpa_supplicant are still printing out to stdout. As a 	 * workaround, make sure that fd's 0, 1, and 2 are not used for other 	 * sockets. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|s
operator|=
name|open
argument_list|(
literal|"/dev/null"
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|>
literal|2
condition|)
block|{
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_driver_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|wait_for_interface
parameter_list|)
block|{
specifier|static
name|int
name|interface_count
init|=
literal|0
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|wpa_s
operator|->
name|l2
operator|=
name|l2_packet_init
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_drv_get_mac_addr
argument_list|(
name|wpa_s
argument_list|)
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|wpa_supplicant_rx_eapol
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|l2
condition|)
break|break;
elseif|else
if|if
condition|(
operator|!
name|wait_for_interface
condition|)
return|return
operator|-
literal|1
return|;
name|printf
argument_list|(
literal|"Waiting for interface..\n"
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|l2_packet_get_own_addr
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to get own L2 address\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Own MAC address: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_set_wpa
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to enable WPA in the driver.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Make sure that TKIP countermeasures are not left enabled (could 	 * happen if wpa_supplicant is killed during countermeasures. */
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_drop_unencrypted
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|BROADCAST_SSID_SCAN
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|interface_count
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
name|interface_count
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"%s\n\n%s\n"
literal|"usage:\n"
literal|"  wpa_supplicant [-BddehLqqvw] -i<ifname> -c<config file> "
literal|"[-D<driver>] \\\n"
literal|"      [-P<pid file>] "
literal|"[-N -i<ifname> -c<conf> [-D<driver>] ...]\n"
literal|"\n"
literal|"drivers:\n"
argument_list|,
name|wpa_supplicant_version
argument_list|,
name|wpa_supplicant_license
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_supplicant_drivers
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"  %s = %s\n"
argument_list|,
name|wpa_supplicant_drivers
index|[
name|i
index|]
operator|->
name|name
argument_list|,
name|wpa_supplicant_drivers
index|[
name|i
index|]
operator|->
name|desc
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"options:\n"
literal|"  -B = run daemon in the background\n"
literal|"  -d = increase debugging verbosity (-dd even more)\n"
literal|"  -K = include keys (passwords, etc.) in debug output\n"
literal|"  -t = include timestamp in debug messages\n"
ifdef|#
directive|ifdef
name|CONFIG_XSUPPLICANT_IFACE
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
literal|"  -e = use external IEEE 802.1X Supplicant (e.g., "
literal|"xsupplicant)\n"
literal|"       (this disables the internal Supplicant)\n"
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
endif|#
directive|endif
comment|/* CONFIG_XSUPPLICANT_IFACE */
literal|"  -h = show this help text\n"
literal|"  -L = show license (GPL and BSD)\n"
literal|"  -q = decrease debugging verbosity (-qq even less)\n"
literal|"  -v = show version\n"
literal|"  -w = wait for interface to be added, if needed\n"
literal|"  -N = start describing new interface\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|license
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s\n\n%s\n"
argument_list|,
name|wpa_supplicant_version
argument_list|,
name|wpa_supplicant_full_license
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpa_supplicant_alloc
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|wpa_s
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wpa_s
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wpa_s
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ctrl_sock
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_XSUPPLICANT_IFACE
name|wpa_s
operator|->
name|dot1x_s
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_XSUPPLICANT_IFACE */
return|return
name|wpa_s
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|confname
parameter_list|,
specifier|const
name|char
modifier|*
name|driver
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Initializing interface '%s' conf '%s' driver "
literal|"'%s'"
argument_list|,
name|ifname
argument_list|,
name|confname
argument_list|,
name|driver
condition|?
name|driver
else|:
literal|"default"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_driver
argument_list|(
name|wpa_s
argument_list|,
name|driver
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|confname
condition|)
block|{
name|wpa_s
operator|->
name|confname
operator|=
name|rel2abs_path
argument_list|(
name|confname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|confname
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to get absolute path "
literal|"for configuration file '%s'."
argument_list|,
name|confname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configuration file '%s' -> '%s'"
argument_list|,
name|confname
argument_list|,
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|=
name|wpa_config_read
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to read configuration file '%s'.\n"
argument_list|,
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
operator|==
name|NULL
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"\nNo networks (SSID) configured.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ifname
operator|==
name|NULL
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"\nInterface name is required.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|ifname
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Too long interface name '%s'.\n"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|strncpy
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_init2
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|disable_eapol
parameter_list|,
name|int
name|wait_for_interface
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|ifname
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Initializing interface (2) '%s'"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|disable_eapol
condition|)
block|{
name|struct
name|eapol_ctx
modifier|*
name|ctx
decl_stmt|;
name|ctx
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate EAPOL context.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
name|ctx
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ctx
operator|=
name|wpa_s
expr_stmt|;
name|ctx
operator|->
name|msg_ctx
operator|=
name|wpa_s
expr_stmt|;
name|ctx
operator|->
name|preauth
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|eapol_done_cb
operator|=
name|wpa_supplicant_notify_eapol_done
expr_stmt|;
name|ctx
operator|->
name|eapol_send
operator|=
name|wpa_eapol_send
expr_stmt|;
name|ctx
operator|->
name|set_wep_key
operator|=
name|wpa_eapol_set_wep_key
expr_stmt|;
name|wpa_s
operator|->
name|eapol
operator|=
name|eapol_sm_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|eapol
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Failed to initialize EAPOL state machines.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
comment|/* RSNA Supplicant Key Management - INITIALIZE */
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* Initialize driver interface and register driver event handler before 	 * L2 receive handler so that association events are processed before 	 * EAPOL-Key packets if both become available for the same select() 	 * call. */
name|wpa_s
operator|->
name|drv_priv
operator|=
name|wpa_drv_init
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to initialize driver interface\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ifname
operator|=
name|wpa_drv_get_ifname
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifname
operator|&&
name|strcmp
argument_list|(
name|ifname
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Driver interface replaced interface "
literal|"name with '%s'"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|renew_snonce
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_driver_init
argument_list|(
name|wpa_s
argument_list|,
name|wait_for_interface
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_supplicant_ctrl_iface_init
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to initialize control interface '%s'.\n"
literal|"You may have another wpa_supplicant process already "
literal|"running or the file was\n"
literal|"left by an unclean termination of wpa_supplicant in "
literal|"which case you will need\n"
literal|"to manually remove this file before starting "
literal|"wpa_supplicant again.\n"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_XSUPPLICANT_IFACE
if|if
condition|(
name|disable_eapol
condition|)
name|wpa_supplicant_802_1x_init
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_XSUPPLICANT_IFACE */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
condition|)
block|{
if|if
condition|(
name|wpa_drv_set_wpa
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to disable WPA in the "
literal|"driver.\n"
argument_list|)
expr_stmt|;
block|}
name|wpa_drv_set_drop_unencrypted
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_drv_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_cleanup
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|head
decl_stmt|,
modifier|*
name|wpa_s
decl_stmt|;
name|int
name|c
decl_stmt|;
specifier|const
name|char
modifier|*
name|confname
decl_stmt|,
modifier|*
name|driver
decl_stmt|,
modifier|*
name|ifname
decl_stmt|;
name|char
modifier|*
name|pid_file
init|=
name|NULL
decl_stmt|;
name|int
name|daemonize
init|=
literal|0
decl_stmt|,
name|wait_for_interface
init|=
literal|0
decl_stmt|,
name|disable_eapol
init|=
literal|0
decl_stmt|,
name|exitcode
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
name|WSADATA
name|wsaData
decl_stmt|;
if|if
condition|(
name|WSAStartup
argument_list|(
name|MAKEWORD
argument_list|(
literal|2
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|wsaData
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Could not find a usable WinSock.dll\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
name|head
operator|=
name|wpa_s
operator|=
name|wpa_supplicant_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_s
operator|->
name|head
operator|=
name|head
expr_stmt|;
name|wpa_supplicant_fd_workaround
argument_list|()
expr_stmt|;
name|eloop_init
argument_list|(
name|head
argument_list|)
expr_stmt|;
name|ifname
operator|=
name|confname
operator|=
name|driver
operator|=
name|NULL
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"Bc:D:dehi:KLNP:qtvw"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0
condition|)
break|break;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'B'
case|:
name|daemonize
operator|++
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|confname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|driver
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|wpa_debug_level
operator|--
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_XSUPPLICANT_IFACE
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
case|case
literal|'e'
case|:
name|disable_eapol
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
endif|#
directive|endif
comment|/* CONFIG_XSUPPLICANT_IFACE */
case|case
literal|'h'
case|:
name|usage
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
case|case
literal|'i'
case|:
name|ifname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
name|wpa_debug_show_keys
operator|++
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|license
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
case|case
literal|'P'
case|:
name|pid_file
operator|=
name|rel2abs_path
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|wpa_debug_level
operator|++
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|wpa_debug_timestamp
operator|++
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|wpa_supplicant_version
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
case|case
literal|'w'
case|:
name|wait_for_interface
operator|++
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
if|if
condition|(
name|wpa_supplicant_init
argument_list|(
name|wpa_s
argument_list|,
name|confname
argument_list|,
name|driver
argument_list|,
name|ifname
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_s
operator|->
name|next
operator|=
name|wpa_supplicant_alloc
argument_list|()
expr_stmt|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_s
operator|->
name|head
operator|=
name|head
expr_stmt|;
name|ifname
operator|=
name|confname
operator|=
name|driver
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|wpa_supplicant_init
argument_list|(
name|wpa_s
argument_list|,
name|confname
argument_list|,
name|driver
argument_list|,
name|ifname
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|exitcode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wait_for_interface
operator|&&
name|daemonize
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Daemonize.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|daemon
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"daemon"
argument_list|)
expr_stmt|;
name|exitcode
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
for|for
control|(
name|wpa_s
operator|=
name|head
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_supplicant_init2
argument_list|(
name|wpa_s
argument_list|,
name|disable_eapol
argument_list|,
name|wait_for_interface
argument_list|)
condition|)
block|{
name|exitcode
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|wait_for_interface
operator|&&
name|daemonize
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Daemonize.."
argument_list|)
expr_stmt|;
if|if
condition|(
name|daemon
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"daemon"
argument_list|)
expr_stmt|;
name|exitcode
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
if|if
condition|(
name|pid_file
condition|)
block|{
name|FILE
modifier|*
name|f
init|=
name|fopen
argument_list|(
name|pid_file
argument_list|,
literal|"w"
argument_list|)
decl_stmt|;
if|if
condition|(
name|f
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%u\n"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
name|eloop_register_signal
argument_list|(
name|SIGINT
argument_list|,
name|wpa_supplicant_terminate
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_signal
argument_list|(
name|SIGTERM
argument_list|,
name|wpa_supplicant_terminate
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
name|eloop_register_signal
argument_list|(
name|SIGHUP
argument_list|,
name|wpa_supplicant_reconfig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
name|eloop_run
argument_list|()
expr_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|head
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
name|cleanup
label|:
name|wpa_s
operator|=
name|head
expr_stmt|;
while|while
condition|(
name|wpa_s
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|prev
decl_stmt|;
name|wpa_supplicant_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|prev
operator|=
name|wpa_s
expr_stmt|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|eloop_destroy
argument_list|()
expr_stmt|;
if|if
condition|(
name|pid_file
condition|)
block|{
name|unlink
argument_list|(
name|pid_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pid_file
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
name|WSACleanup
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
return|return
name|exitcode
return|;
block|}
end_function

end_unit


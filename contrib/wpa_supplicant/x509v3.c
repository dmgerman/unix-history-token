begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * X.509v3 certificate parsing and processing (RFC 3280 profile)  * Copyright (c) 2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_INTERNAL_X509
end_ifdef

begin_include
include|#
directive|include
file|"asn1.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_include
include|#
directive|include
file|"x509v3.h"
end_include

begin_function
specifier|static
name|void
name|x509_free_name
parameter_list|(
name|struct
name|x509_name
modifier|*
name|name
parameter_list|)
block|{
name|os_free
argument_list|(
name|name
operator|->
name|cn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|name
operator|->
name|c
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|name
operator|->
name|l
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|name
operator|->
name|st
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|name
operator|->
name|o
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|name
operator|->
name|ou
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|name
operator|->
name|email
argument_list|)
expr_stmt|;
name|name
operator|->
name|cn
operator|=
name|name
operator|->
name|c
operator|=
name|name
operator|->
name|l
operator|=
name|name
operator|->
name|st
operator|=
name|name
operator|->
name|o
operator|=
name|name
operator|->
name|ou
operator|=
name|NULL
expr_stmt|;
name|name
operator|->
name|email
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * x509_certificate_free - Free an X.509 certificate  * @cert: Certificate to be freed  */
end_comment

begin_function
name|void
name|x509_certificate_free
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|)
block|{
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|cert
operator|->
name|next
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: x509_certificate_free: cer=%p "
literal|"was still on a list (next=%p)\n"
argument_list|,
name|cert
argument_list|,
name|cert
operator|->
name|next
argument_list|)
expr_stmt|;
block|}
name|x509_free_name
argument_list|(
operator|&
name|cert
operator|->
name|issuer
argument_list|)
expr_stmt|;
name|x509_free_name
argument_list|(
operator|&
name|cert
operator|->
name|subject
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cert
operator|->
name|public_key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cert
operator|->
name|sign_value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * x509_certificate_free - Free an X.509 certificate chain  * @cert: Pointer to the first certificate in the chain  */
end_comment

begin_function
name|void
name|x509_certificate_chain_free
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|)
block|{
name|struct
name|x509_certificate
modifier|*
name|next
decl_stmt|;
while|while
condition|(
name|cert
condition|)
block|{
name|next
operator|=
name|cert
operator|->
name|next
expr_stmt|;
name|cert
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|cert
operator|=
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|x509_str_compare
parameter_list|(
specifier|const
name|char
modifier|*
name|a
parameter_list|,
specifier|const
name|char
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
operator|!
name|a
operator|&&
name|b
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|a
operator|&&
operator|!
name|b
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|a
operator|&&
operator|!
name|b
condition|)
return|return
literal|0
return|;
return|return
name|os_strcmp
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * x509_name_compare - Compare X.509 certificate names  * @a: Certificate name  * @b: Certifiatte name  * Returns:<0, 0, or>0 based on whether a is less than, equal to, or  * greater than b  */
end_comment

begin_function
name|int
name|x509_name_compare
parameter_list|(
name|struct
name|x509_name
modifier|*
name|a
parameter_list|,
name|struct
name|x509_name
modifier|*
name|b
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|!
name|a
operator|&&
name|b
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|a
operator|&&
operator|!
name|b
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|a
operator|&&
operator|!
name|b
condition|)
return|return
literal|0
return|;
name|res
operator|=
name|x509_str_compare
argument_list|(
name|a
operator|->
name|cn
argument_list|,
name|b
operator|->
name|cn
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|res
operator|=
name|x509_str_compare
argument_list|(
name|a
operator|->
name|c
argument_list|,
name|b
operator|->
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|res
operator|=
name|x509_str_compare
argument_list|(
name|a
operator|->
name|l
argument_list|,
name|b
operator|->
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|res
operator|=
name|x509_str_compare
argument_list|(
name|a
operator|->
name|st
argument_list|,
name|b
operator|->
name|st
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|res
operator|=
name|x509_str_compare
argument_list|(
name|a
operator|->
name|o
argument_list|,
name|b
operator|->
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|res
operator|=
name|x509_str_compare
argument_list|(
name|a
operator|->
name|ou
argument_list|,
name|b
operator|->
name|ou
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|res
operator|=
name|x509_str_compare
argument_list|(
name|a
operator|->
name|email
argument_list|,
name|b
operator|->
name|email
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_algorithm_identifier
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|x509_algorithm_identifier
modifier|*
name|id
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|next
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
comment|/* 	 * AlgorithmIdentifier ::= SEQUENCE { 	 *     algorithm            OBJECT IDENTIFIER, 	 *     parameters           ANY DEFINED BY algorithm OPTIONAL 	 * } 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected SEQUENCE "
literal|"(AlgorithmIdentifier) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|end
operator|>
name|buf
operator|+
name|len
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|next
operator|=
name|end
expr_stmt|;
if|if
condition|(
name|asn1_get_oid
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|id
operator|->
name|oid
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* TODO: optional parameters */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_public_key
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|next
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
comment|/* 	 * SubjectPublicKeyInfo ::= SEQUENCE { 	 *     algorithm            AlgorithmIdentifier, 	 *     subjectPublicKey     BIT STRING 	 * } 	 */
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected SEQUENCE "
literal|"(SubjectPublicKeyInfo) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|hdr
operator|.
name|length
operator|>
name|end
condition|)
return|return
operator|-
literal|1
return|;
name|end
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
operator|*
name|next
operator|=
name|end
expr_stmt|;
if|if
condition|(
name|x509_parse_algorithm_identifier
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|cert
operator|->
name|public_key_alg
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_BITSTRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected BITSTRING "
literal|"(subjectPublicKey) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hdr
operator|.
name|length
operator|<
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
if|if
condition|(
operator|*
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: BITSTRING - %d unused bits"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
comment|/* 		 * TODO: should this be rejected? X.509 certificates are 		 * unlikely to use such a construction. Now we would end up 		 * including the extra bits in the buffer which may also be 		 * ok. 		 */
block|}
name|os_free
argument_list|(
name|cert
operator|->
name|public_key
argument_list|)
expr_stmt|;
name|cert
operator|->
name|public_key
operator|=
name|os_malloc
argument_list|(
name|hdr
operator|.
name|length
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|->
name|public_key
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to allocate memory for "
literal|"public key"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|cert
operator|->
name|public_key
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|hdr
operator|.
name|length
operator|-
literal|1
argument_list|)
expr_stmt|;
name|cert
operator|->
name|public_key_len
operator|=
name|hdr
operator|.
name|length
operator|-
literal|1
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: subjectPublicKey"
argument_list|,
name|cert
operator|->
name|public_key
argument_list|,
name|cert
operator|->
name|public_key_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_name
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|x509_name
modifier|*
name|name
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|next
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|set_pos
decl_stmt|,
modifier|*
name|set_end
decl_stmt|,
modifier|*
name|seq_pos
decl_stmt|,
modifier|*
name|seq_end
decl_stmt|;
name|struct
name|asn1_oid
name|oid
decl_stmt|;
name|char
modifier|*
modifier|*
name|fieldp
decl_stmt|;
comment|/* 	 * Name ::= CHOICE { RDNSequence } 	 * RDNSequence ::= SEQUENCE OF RelativeDistinguishedName 	 * RelativeDistinguishedName ::= SET OF AttributeTypeAndValue 	 * AttributeTypeAndValue ::= SEQUENCE { 	 *     type     AttributeType, 	 *     value    AttributeValue 	 * } 	 * AttributeType ::= OBJECT IDENTIFIER 	 * AttributeValue ::= ANY DEFINED BY AttributeType 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected SEQUENCE "
literal|"(Name / RDNSequencer) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|hdr
operator|.
name|length
operator|>
name|buf
operator|+
name|len
condition|)
return|return
operator|-
literal|1
return|;
name|end
operator|=
operator|*
name|next
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SET
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected SET "
literal|"(RelativeDistinguishedName) - found class "
literal|"%d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
name|x509_free_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|set_pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|pos
operator|=
name|set_end
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|set_pos
argument_list|,
name|set_end
operator|-
name|set_pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected SEQUENCE "
literal|"(AttributeTypeAndValue) - found class %d "
literal|"tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
name|x509_free_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|seq_pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|seq_end
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|asn1_get_oid
argument_list|(
name|seq_pos
argument_list|,
name|seq_end
operator|-
name|seq_pos
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|seq_pos
argument_list|)
condition|)
block|{
name|x509_free_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|asn1_get_next
argument_list|(
name|seq_pos
argument_list|,
name|seq_end
operator|-
name|seq_pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse "
literal|"AttributeValue"
argument_list|)
expr_stmt|;
name|x509_free_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* RFC 3280: 		 * MUST: country, organization, organizational-unit, 		 * distinguished name qualifier, state or province name, 		 * common name, serial number. 		 * SHOULD: locality, title, surname, given name, initials, 		 * pseudonym, generation qualifier. 		 * MUST: domainComponent (RFC 2247). 		 */
name|fieldp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|oid
operator|.
name|len
operator|==
literal|4
operator|&&
name|oid
operator|.
name|oid
index|[
literal|0
index|]
operator|==
literal|2
operator|&&
name|oid
operator|.
name|oid
index|[
literal|1
index|]
operator|==
literal|5
operator|&&
name|oid
operator|.
name|oid
index|[
literal|2
index|]
operator|==
literal|4
condition|)
block|{
comment|/* id-at ::= 2.5.4 */
switch|switch
condition|(
name|oid
operator|.
name|oid
index|[
literal|3
index|]
condition|)
block|{
case|case
literal|3
case|:
comment|/* commonName */
name|fieldp
operator|=
operator|&
name|name
operator|->
name|cn
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/*  countryName */
name|fieldp
operator|=
operator|&
name|name
operator|->
name|c
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* localityName */
name|fieldp
operator|=
operator|&
name|name
operator|->
name|l
expr_stmt|;
break|break;
case|case
literal|8
case|:
comment|/* stateOrProvinceName */
name|fieldp
operator|=
operator|&
name|name
operator|->
name|st
expr_stmt|;
break|break;
case|case
literal|10
case|:
comment|/* organizationName */
name|fieldp
operator|=
operator|&
name|name
operator|->
name|o
expr_stmt|;
break|break;
case|case
literal|11
case|:
comment|/* organizationalUnitName */
name|fieldp
operator|=
operator|&
name|name
operator|->
name|ou
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|oid
operator|.
name|len
operator|==
literal|7
operator|&&
name|oid
operator|.
name|oid
index|[
literal|0
index|]
operator|==
literal|1
operator|&&
name|oid
operator|.
name|oid
index|[
literal|1
index|]
operator|==
literal|2
operator|&&
name|oid
operator|.
name|oid
index|[
literal|2
index|]
operator|==
literal|840
operator|&&
name|oid
operator|.
name|oid
index|[
literal|3
index|]
operator|==
literal|113549
operator|&&
name|oid
operator|.
name|oid
index|[
literal|4
index|]
operator|==
literal|1
operator|&&
name|oid
operator|.
name|oid
index|[
literal|5
index|]
operator|==
literal|9
operator|&&
name|oid
operator|.
name|oid
index|[
literal|6
index|]
operator|==
literal|1
condition|)
block|{
comment|/* 1.2.840.113549.1.9.1 - e-mailAddress */
name|fieldp
operator|=
operator|&
name|name
operator|->
name|email
expr_stmt|;
block|}
if|if
condition|(
name|fieldp
operator|==
name|NULL
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unrecognized OID"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|oid
operator|.
name|oid
argument_list|,
name|oid
operator|.
name|len
operator|*
sizeof|sizeof
argument_list|(
name|oid
operator|.
name|oid
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: Attribute Data"
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|os_free
argument_list|(
operator|*
name|fieldp
argument_list|)
expr_stmt|;
operator|*
name|fieldp
operator|=
name|os_malloc
argument_list|(
name|hdr
operator|.
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|fieldp
operator|==
name|NULL
condition|)
block|{
name|x509_free_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
operator|*
name|fieldp
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
operator|(
operator|*
name|fieldp
operator|)
index|[
name|hdr
operator|.
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * x509_name_string - Convert an X.509 certificate name into a string  * @name: Name to convert  * @buf: Buffer for the string  * @len: Maximum buffer length  */
end_comment

begin_function
name|void
name|x509_name_string
parameter_list|(
name|struct
name|x509_name
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|name
operator|->
name|c
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"C=%s, "
argument_list|,
name|name
operator|->
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
goto|goto
name|done
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|st
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"ST=%s, "
argument_list|,
name|name
operator|->
name|st
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
goto|goto
name|done
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|l
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"L=%s, "
argument_list|,
name|name
operator|->
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
goto|goto
name|done
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|o
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"O=%s, "
argument_list|,
name|name
operator|->
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
goto|goto
name|done
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|ou
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"OU=%s, "
argument_list|,
name|name
operator|->
name|ou
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
goto|goto
name|done
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|cn
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"CN=%s, "
argument_list|,
name|name
operator|->
name|cn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
goto|goto
name|done
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|>
name|buf
operator|+
literal|1
operator|&&
name|pos
index|[
operator|-
literal|1
index|]
operator|==
literal|' '
operator|&&
name|pos
index|[
operator|-
literal|2
index|]
operator|==
literal|','
condition|)
block|{
operator|*
name|pos
operator|--
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|pos
operator|--
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|email
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"/emailAddress=%s"
argument_list|,
name|name
operator|->
name|email
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
goto|goto
name|done
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|done
label|:
name|end
index|[
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_time
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u8
name|asn1_tag
parameter_list|,
name|os_time_t
modifier|*
name|val
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|int
name|year
decl_stmt|,
name|month
decl_stmt|,
name|day
decl_stmt|,
name|hour
decl_stmt|,
name|min
decl_stmt|,
name|sec
decl_stmt|;
comment|/* 	 * Time ::= CHOICE { 	 *     utcTime        UTCTime, 	 *     generalTime    GeneralizedTime 	 * } 	 * 	 * UTCTime: YYMMDDHHMMSSZ 	 * GeneralizedTime: YYYYMMDDHHMMSSZ 	 */
name|pos
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|buf
expr_stmt|;
switch|switch
condition|(
name|asn1_tag
condition|)
block|{
case|case
name|ASN1_TAG_UTCTIME
case|:
if|if
condition|(
name|len
operator|!=
literal|13
operator|||
name|buf
index|[
literal|12
index|]
operator|!=
literal|'Z'
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unrecognized "
literal|"UTCTime format"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|pos
argument_list|,
literal|"%02d"
argument_list|,
operator|&
name|year
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse "
literal|"UTCTime year"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|year
operator|<
literal|50
condition|)
name|year
operator|+=
literal|2000
expr_stmt|;
else|else
name|year
operator|+=
literal|1900
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_GENERALIZEDTIME
case|:
if|if
condition|(
name|len
operator|!=
literal|15
operator|||
name|buf
index|[
literal|14
index|]
operator|!=
literal|'Z'
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unrecognized "
literal|"GeneralizedTime format"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|pos
argument_list|,
literal|"%04d"
argument_list|,
operator|&
name|year
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse "
literal|"GeneralizedTime year"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|4
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected UTCTime or "
literal|"GeneralizedTime - found tag 0x%x"
argument_list|,
name|asn1_tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|pos
argument_list|,
literal|"%02d"
argument_list|,
operator|&
name|month
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse Time "
literal|"(month)"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|pos
argument_list|,
literal|"%02d"
argument_list|,
operator|&
name|day
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse Time "
literal|"(day)"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|pos
argument_list|,
literal|"%02d"
argument_list|,
operator|&
name|hour
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse Time "
literal|"(hour)"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|pos
argument_list|,
literal|"%02d"
argument_list|,
operator|&
name|min
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse Time "
literal|"(min)"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|pos
argument_list|,
literal|"%02d"
argument_list|,
operator|&
name|sec
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse Time "
literal|"(sec)"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_mktime
argument_list|(
name|year
argument_list|,
name|month
argument_list|,
name|day
argument_list|,
name|hour
argument_list|,
name|min
argument_list|,
name|sec
argument_list|,
name|val
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to convert Time"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_validity
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|next
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|plen
decl_stmt|;
comment|/* 	 * Validity ::= SEQUENCE { 	 *     notBefore      Time, 	 *     notAfter       Time 	 * } 	 * 	 * RFC 3280, 4.1.2.5: 	 * CAs conforming to this profile MUST always encode certificate 	 * validity dates through the year 2049 as UTCTime; certificate 	 * validity dates in 2050 or later MUST be encoded as GeneralizedTime. 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected SEQUENCE "
literal|"(Validity) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|plen
operator|=
name|hdr
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|plen
operator|>
name|buf
operator|+
name|len
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|next
operator|=
name|pos
operator|+
name|plen
expr_stmt|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|plen
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|x509_parse_time
argument_list|(
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|,
name|hdr
operator|.
name|tag
argument_list|,
operator|&
name|cert
operator|->
name|not_before
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse notBefore "
literal|"Time"
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
name|plen
operator|=
operator|*
name|next
operator|-
name|pos
expr_stmt|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|plen
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|x509_parse_time
argument_list|(
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|,
name|hdr
operator|.
name|tag
argument_list|,
operator|&
name|cert
operator|->
name|not_after
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse notAfter "
literal|"Time"
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: Validity: notBefore: %lu notAfter: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cert
operator|->
name|not_before
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cert
operator|->
name|not_after
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_id_ce_oid
parameter_list|(
name|struct
name|asn1_oid
modifier|*
name|oid
parameter_list|)
block|{
comment|/* id-ce arc from X.509 for standard X.509v3 extensions */
return|return
name|oid
operator|->
name|len
operator|>=
literal|4
operator|&&
name|oid
operator|->
name|oid
index|[
literal|0
index|]
operator|==
literal|2
comment|/* joint-iso-ccitt */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|1
index|]
operator|==
literal|5
comment|/* ds */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|2
index|]
operator|==
literal|29
comment|/* id-ce */
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_ext_key_usage
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
comment|/* 	 * KeyUsage ::= BIT STRING { 	 *     digitalSignature        (0), 	 *     nonRepudiation          (1), 	 *     keyEncipherment         (2), 	 *     dataEncipherment        (3), 	 *     keyAgreement            (4), 	 *     keyCertSign             (5), 	 *     cRLSign                 (6), 	 *     encipherOnly            (7), 	 *     decipherOnly            (8) } 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_BITSTRING
operator|||
name|hdr
operator|.
name|length
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected BIT STRING in "
literal|"KeyUsage; found %d tag 0x%x len %d"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cert
operator|->
name|extensions_present
operator||=
name|X509_EXT_KEY_USAGE
expr_stmt|;
name|cert
operator|->
name|key_usage
operator|=
name|asn1_bit_string_to_long
argument_list|(
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: KeyUsage 0x%lx"
argument_list|,
name|cert
operator|->
name|key_usage
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_ext_basic_constraints
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
name|unsigned
name|long
name|value
decl_stmt|;
name|size_t
name|left
decl_stmt|;
comment|/* 	 * BasicConstraints ::= SEQUENCE { 	 * cA                      BOOLEAN DEFAULT FALSE, 	 * pathLenConstraint       INTEGER (0..MAX) OPTIONAL } 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected SEQUENCE in "
literal|"BasicConstraints; found %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cert
operator|->
name|extensions_present
operator||=
name|X509_EXT_BASIC_CONSTRAINTS
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|length
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse "
literal|"BasicConstraints"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hdr
operator|.
name|tag
operator|==
name|ASN1_TAG_BOOLEAN
condition|)
block|{
if|if
condition|(
name|hdr
operator|.
name|length
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unexpected "
literal|"Boolean length (%u) in BasicConstraints"
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cert
operator|->
name|ca
operator|=
name|hdr
operator|.
name|payload
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
operator|==
name|pos
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: BasicConstraints - cA=%d"
argument_list|,
name|cert
operator|->
name|ca
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse "
literal|"BasicConstraints"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_INTEGER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected INTEGER in "
literal|"BasicConstraints; found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|left
operator|=
name|hdr
operator|.
name|length
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|left
condition|)
block|{
name|value
operator|<<=
literal|8
expr_stmt|;
name|value
operator||=
operator|*
name|pos
operator|++
expr_stmt|;
name|left
operator|--
expr_stmt|;
block|}
name|cert
operator|->
name|path_len_constraint
operator|=
name|value
expr_stmt|;
name|cert
operator|->
name|extensions_present
operator||=
name|X509_EXT_PATH_LEN_CONSTRAINT
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: BasicConstraints - cA=%d "
literal|"pathLenConstraint=%lu"
argument_list|,
name|cert
operator|->
name|ca
argument_list|,
name|cert
operator|->
name|path_len_constraint
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_extension_data
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|,
name|struct
name|asn1_oid
modifier|*
name|oid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
operator|!
name|x509_id_ce_oid
argument_list|(
name|oid
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* TODO: add other extensions required by RFC 3280, Ch 4.2: 	 * certificate policies (section 4.2.1.5) 	 * the subject alternative name (section 4.2.1.7) 	 * name constraints (section 4.2.1.11) 	 * policy constraints (section 4.2.1.12) 	 * extended key usage (section 4.2.1.13) 	 * inhibit any-policy (section 4.2.1.15) 	 */
switch|switch
condition|(
name|oid
operator|->
name|oid
index|[
literal|3
index|]
condition|)
block|{
case|case
literal|15
case|:
comment|/* id-ce-keyUsage */
return|return
name|x509_parse_ext_key_usage
argument_list|(
name|cert
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
return|;
case|case
literal|19
case|:
comment|/* id-ce-basicConstraints */
return|return
name|x509_parse_ext_basic_constraints
argument_list|(
name|cert
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
return|;
default|default:
return|return
literal|1
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_extension
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|next
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|;
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
name|struct
name|asn1_oid
name|oid
decl_stmt|;
name|int
name|critical_ext
init|=
literal|0
decl_stmt|,
name|res
decl_stmt|;
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
comment|/* 	 * Extension  ::=  SEQUENCE  { 	 *     extnID      OBJECT IDENTIFIER, 	 *     critical    BOOLEAN DEFAULT FALSE, 	 *     extnValue   OCTET STRING 	 * } 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unexpected ASN.1 header in "
literal|"Extensions: class %d tag 0x%x; expected SEQUENCE"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
operator|*
name|next
operator|=
name|end
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|asn1_get_oid
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|pos
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unexpected ASN.1 data for "
literal|"Extension (expected OID)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
operator|(
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_BOOLEAN
operator|&&
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_OCTETSTRING
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unexpected ASN.1 header in "
literal|"Extensions: class %d tag 0x%x; expected BOOLEAN "
literal|"or OCTET STRING"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hdr
operator|.
name|tag
operator|==
name|ASN1_TAG_BOOLEAN
condition|)
block|{
if|if
condition|(
name|hdr
operator|.
name|length
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unexpected "
literal|"Boolean length (%u)"
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|critical_ext
operator|=
name|hdr
operator|.
name|payload
index|[
literal|0
index|]
expr_stmt|;
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|&&
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_PRIVATE
operator|)
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_OCTETSTRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unexpected ASN.1 header "
literal|"in Extensions: class %d tag 0x%x; "
literal|"expected OCTET STRING"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|asn1_oid_to_str
argument_list|(
operator|&
name|oid
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Extension: extnID=%s critical=%d"
argument_list|,
name|buf
argument_list|,
name|critical_ext
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: extnValue"
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|res
operator|=
name|x509_parse_extension_data
argument_list|(
name|cert
argument_list|,
operator|&
name|oid
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
name|res
return|;
if|if
condition|(
name|res
operator|==
literal|1
operator|&&
name|critical_ext
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"X509: Unknown critical extension %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_extensions
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|;
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
comment|/* Extensions  ::=  SEQUENCE SIZE (1..MAX) OF Extension */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unexpected ASN.1 data "
literal|"for Extensions: class %d tag 0x%x; "
literal|"expected SEQUENCE"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|x509_parse_extension
argument_list|(
name|cert
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|pos
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_parse_tbs_certificate
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|next
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|;
name|char
name|sbuf
index|[
literal|128
index|]
decl_stmt|;
name|unsigned
name|long
name|value
decl_stmt|;
comment|/* tbsCertificate TBSCertificate ::= SEQUENCE */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: tbsCertificate did not start "
literal|"with a valid SEQUENCE - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|end
operator|=
operator|*
name|next
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
comment|/* 	 * version [0]  EXPLICIT Version DEFAULT v1 	 * Version  ::=  INTEGER  {  v1(0), v2(1), v3(2)  } 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|class
operator|==
name|ASN1_CLASS_CONTEXT_SPECIFIC
condition|)
block|{
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_INTEGER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: No INTEGER tag found for "
literal|"version field - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hdr
operator|.
name|length
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unexpected version field "
literal|"length %u (expected 1)"
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|left
operator|=
name|hdr
operator|.
name|length
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|left
condition|)
block|{
name|value
operator|<<=
literal|8
expr_stmt|;
name|value
operator||=
operator|*
name|pos
operator|++
expr_stmt|;
name|left
operator|--
expr_stmt|;
block|}
name|cert
operator|->
name|version
operator|=
name|value
expr_stmt|;
if|if
condition|(
name|cert
operator|->
name|version
operator|!=
name|X509_CERT_V1
operator|&&
name|cert
operator|->
name|version
operator|!=
name|X509_CERT_V2
operator|&&
name|cert
operator|->
name|version
operator|!=
name|X509_CERT_V3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unsupported version %d"
argument_list|,
name|cert
operator|->
name|version
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
name|cert
operator|->
name|version
operator|=
name|X509_CERT_V1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: Version X.509v%d"
argument_list|,
name|cert
operator|->
name|version
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* serialNumber CertificateSerialNumber ::= INTEGER */
if|if
condition|(
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_INTEGER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: No INTEGER tag found for "
literal|"serialNumber; class=%d tag=0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|left
operator|=
name|hdr
operator|.
name|length
expr_stmt|;
while|while
condition|(
name|left
condition|)
block|{
name|cert
operator|->
name|serial_number
operator|<<=
literal|8
expr_stmt|;
name|cert
operator|->
name|serial_number
operator||=
operator|*
name|pos
operator|++
expr_stmt|;
name|left
operator|--
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: serialNumber %lu"
argument_list|,
name|cert
operator|->
name|serial_number
argument_list|)
expr_stmt|;
comment|/* signature AlgorithmIdentifier */
if|if
condition|(
name|x509_parse_algorithm_identifier
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|cert
operator|->
name|signature
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* issuer Name */
if|if
condition|(
name|x509_parse_name
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|cert
operator|->
name|issuer
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|x509_name_string
argument_list|(
operator|&
name|cert
operator|->
name|issuer
argument_list|,
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: issuer %s"
argument_list|,
name|sbuf
argument_list|)
expr_stmt|;
comment|/* validity Validity */
if|if
condition|(
name|x509_parse_validity
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|cert
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* subject Name */
if|if
condition|(
name|x509_parse_name
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|cert
operator|->
name|subject
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|x509_name_string
argument_list|(
operator|&
name|cert
operator|->
name|subject
argument_list|,
name|sbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sbuf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: subject %s"
argument_list|,
name|sbuf
argument_list|)
expr_stmt|;
comment|/* subjectPublicKeyInfo SubjectPublicKeyInfo */
if|if
condition|(
name|x509_parse_public_key
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|cert
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|pos
operator|==
name|end
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|cert
operator|->
name|version
operator|==
name|X509_CERT_V1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_CONTEXT_SPECIFIC
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected Context-Specific"
literal|" tag to parse optional tbsCertificate "
literal|"field(s); parsed class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hdr
operator|.
name|tag
operator|==
literal|1
condition|)
block|{
comment|/* issuerUniqueID  [1]  IMPLICIT UniqueIdentifier OPTIONAL */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: issuerUniqueID"
argument_list|)
expr_stmt|;
comment|/* TODO: parse UniqueIdentifier ::= BIT STRING */
if|if
condition|(
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
operator|==
name|end
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_CONTEXT_SPECIFIC
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected Context-Specific"
literal|" tag to parse optional tbsCertificate "
literal|"field(s); parsed class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|hdr
operator|.
name|tag
operator|==
literal|2
condition|)
block|{
comment|/* subjectUniqueID [2]  IMPLICIT UniqueIdentifier OPTIONAL */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: subjectUniqueID"
argument_list|)
expr_stmt|;
comment|/* TODO: parse UniqueIdentifier ::= BIT STRING */
if|if
condition|(
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
operator|==
name|end
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_CONTEXT_SPECIFIC
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected Context-Specific"
literal|" tag to parse optional tbsCertificate "
literal|"field(s); parsed class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|hdr
operator|.
name|tag
operator|!=
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Ignored unexpected "
literal|"Context-Specific tag %d in optional "
literal|"tbsCertificate fields"
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* extensions      [3]  EXPLICIT Extensions OPTIONAL */
if|if
condition|(
name|cert
operator|->
name|version
operator|!=
name|X509_CERT_V3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: X.509%d certificate and "
literal|"Extensions data which are only allowed for "
literal|"version 3"
argument_list|,
name|cert
operator|->
name|version
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|x509_parse_extensions
argument_list|(
name|cert
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Ignored extra tbsCertificate data"
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_rsadsi_oid
parameter_list|(
name|struct
name|asn1_oid
modifier|*
name|oid
parameter_list|)
block|{
return|return
name|oid
operator|->
name|len
operator|>=
literal|4
operator|&&
name|oid
operator|->
name|oid
index|[
literal|0
index|]
operator|==
literal|1
comment|/* iso */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|1
index|]
operator|==
literal|2
comment|/* member-body */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|2
index|]
operator|==
literal|840
comment|/* us */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|3
index|]
operator|==
literal|113549
comment|/* rsadsi */
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_pkcs_oid
parameter_list|(
name|struct
name|asn1_oid
modifier|*
name|oid
parameter_list|)
block|{
return|return
name|oid
operator|->
name|len
operator|>=
literal|5
operator|&&
name|x509_rsadsi_oid
argument_list|(
name|oid
argument_list|)
operator|&&
name|oid
operator|->
name|oid
index|[
literal|4
index|]
operator|==
literal|1
comment|/* pkcs */
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_digest_oid
parameter_list|(
name|struct
name|asn1_oid
modifier|*
name|oid
parameter_list|)
block|{
return|return
name|oid
operator|->
name|len
operator|>=
literal|5
operator|&&
name|x509_rsadsi_oid
argument_list|(
name|oid
argument_list|)
operator|&&
name|oid
operator|->
name|oid
index|[
literal|4
index|]
operator|==
literal|2
comment|/* digestAlgorithm */
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_sha1_oid
parameter_list|(
name|struct
name|asn1_oid
modifier|*
name|oid
parameter_list|)
block|{
return|return
name|oid
operator|->
name|len
operator|==
literal|6
operator|&&
name|oid
operator|->
name|oid
index|[
literal|0
index|]
operator|==
literal|1
comment|/* iso */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|1
index|]
operator|==
literal|3
comment|/* identified-organization */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|2
index|]
operator|==
literal|14
comment|/* oiw */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|3
index|]
operator|==
literal|3
comment|/* secsig */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|4
index|]
operator|==
literal|2
comment|/* algorithms */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|5
index|]
operator|==
literal|26
comment|/* id-sha1 */
return|;
block|}
end_function

begin_comment
comment|/**  * x509_certificate_parse - Parse a X.509 certificate in DER format  * @buf: Pointer to the X.509 certificate in DER format  * @len: Buffer length  * Returns: Pointer to the parsed certificate or %NULL on failure  *  * Caller is responsible for freeing the returned certificate by calling  * x509_certificate_free().  */
end_comment

begin_function
name|struct
name|x509_certificate
modifier|*
name|x509_certificate_parse
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|hash_start
decl_stmt|;
name|struct
name|x509_certificate
modifier|*
name|cert
decl_stmt|;
name|cert
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cert
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|cert
operator|+
literal|1
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|cert
operator|->
name|cert_start
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|cert
operator|+
literal|1
operator|)
expr_stmt|;
name|cert
operator|->
name|cert_len
operator|=
name|len
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|len
expr_stmt|;
comment|/* RFC 3280 - X.509 v3 certificate / ASN.1 DER */
comment|/* Certificate ::= SEQUENCE */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Certificate did not start with "
literal|"a valid SEQUENCE - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|hdr
operator|.
name|length
operator|>
name|end
condition|)
block|{
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|pos
operator|+
name|hdr
operator|.
name|length
operator|<
name|end
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: Ignoring extra data after DER "
literal|"encoded certificate"
argument_list|,
name|pos
operator|+
name|hdr
operator|.
name|length
argument_list|,
name|end
operator|-
name|pos
operator|+
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
block|}
name|hash_start
operator|=
name|pos
expr_stmt|;
name|cert
operator|->
name|tbs_cert_start
operator|=
name|cert
operator|->
name|cert_start
operator|+
operator|(
name|hash_start
operator|-
name|buf
operator|)
expr_stmt|;
if|if
condition|(
name|x509_parse_tbs_certificate
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|cert
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
block|{
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cert
operator|->
name|tbs_cert_len
operator|=
name|pos
operator|-
name|hash_start
expr_stmt|;
comment|/* signatureAlgorithm AlgorithmIdentifier */
if|if
condition|(
name|x509_parse_algorithm_identifier
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|cert
operator|->
name|signature_alg
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
block|{
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* signatureValue BIT STRING */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_BITSTRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected BITSTRING "
literal|"(signatureValue) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|hdr
operator|.
name|length
operator|<
literal|1
condition|)
block|{
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
if|if
condition|(
operator|*
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: BITSTRING - %d unused bits"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
comment|/* PKCS #1 v1.5 10.2.1: 		 * It is an error if the length in bits of the signature S is 		 * not a multiple of eight. 		 */
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_free
argument_list|(
name|cert
operator|->
name|sign_value
argument_list|)
expr_stmt|;
name|cert
operator|->
name|sign_value
operator|=
name|os_malloc
argument_list|(
name|hdr
operator|.
name|length
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|->
name|sign_value
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to allocate memory for "
literal|"signatureValue"
argument_list|)
expr_stmt|;
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|cert
operator|->
name|sign_value
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|hdr
operator|.
name|length
operator|-
literal|1
argument_list|)
expr_stmt|;
name|cert
operator|->
name|sign_value_len
operator|=
name|hdr
operator|.
name|length
operator|-
literal|1
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: signature"
argument_list|,
name|cert
operator|->
name|sign_value
argument_list|,
name|cert
operator|->
name|sign_value_len
argument_list|)
expr_stmt|;
return|return
name|cert
return|;
block|}
end_function

begin_comment
comment|/**  * x509_certificate_check_signature - Verify certificate signature  * @issuer: Issuer certificate  * @cert: Certificate to be verified  * Returns: 0 if cert has a valid signature that was signed by the issuer,  * -1 if not  */
end_comment

begin_function
name|int
name|x509_certificate_check_signature
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|issuer
parameter_list|,
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|)
block|{
name|struct
name|crypto_public_key
modifier|*
name|pk
decl_stmt|;
name|u8
modifier|*
name|data
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|next
decl_stmt|,
modifier|*
name|da_end
decl_stmt|;
name|size_t
name|data_len
decl_stmt|;
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
name|struct
name|asn1_oid
name|oid
decl_stmt|;
name|u8
name|hash
index|[
literal|20
index|]
decl_stmt|;
name|size_t
name|hash_len
decl_stmt|;
if|if
condition|(
operator|!
name|x509_pkcs_oid
argument_list|(
operator|&
name|cert
operator|->
name|signature
operator|.
name|oid
argument_list|)
operator|||
name|cert
operator|->
name|signature
operator|.
name|oid
operator|.
name|len
operator|!=
literal|7
operator|||
name|cert
operator|->
name|signature
operator|.
name|oid
operator|.
name|oid
index|[
literal|5
index|]
operator|!=
literal|1
comment|/* pkcs-1 */
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unrecognized signature "
literal|"algorithm"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pk
operator|=
name|crypto_public_key_import
argument_list|(
name|issuer
operator|->
name|public_key
argument_list|,
name|issuer
operator|->
name|public_key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pk
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|data_len
operator|=
name|cert
operator|->
name|sign_value_len
expr_stmt|;
name|data
operator|=
name|os_malloc
argument_list|(
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|crypto_public_key_free
argument_list|(
name|pk
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|crypto_public_key_decrypt_pkcs1
argument_list|(
name|pk
argument_list|,
name|cert
operator|->
name|sign_value
argument_list|,
name|cert
operator|->
name|sign_value_len
argument_list|,
name|data
argument_list|,
operator|&
name|data_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to decrypt signature"
argument_list|)
expr_stmt|;
name|crypto_public_key_free
argument_list|(
name|pk
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|crypto_public_key_free
argument_list|(
name|pk
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: Signature data D"
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
comment|/* 	 * PKCS #1 v1.5, 10.1.2: 	 * 	 * DigestInfo ::= SEQUENCE { 	 *     digestAlgorithm DigestAlgorithmIdentifier, 	 *     digest Digest 	 * } 	 * 	 * DigestAlgorithmIdentifier ::= AlgorithmIdentifier 	 * 	 * Digest ::= OCTET STRING 	 * 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|data
argument_list|,
name|data_len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected SEQUENCE "
literal|"(DigestInfo) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
comment|/* 	 * X.509: 	 * AlgorithmIdentifier ::= SEQUENCE { 	 *     algorithm            OBJECT IDENTIFIER, 	 *     parameters           ANY DEFINED BY algorithm OPTIONAL 	 * } 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected SEQUENCE "
literal|"(AlgorithmIdentifier) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|da_end
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|asn1_get_oid
argument_list|(
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|next
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Failed to parse digestAlgorithm"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|x509_sha1_oid
argument_list|(
operator|&
name|oid
argument_list|)
condition|)
block|{
if|if
condition|(
name|cert
operator|->
name|signature
operator|.
name|oid
operator|.
name|oid
index|[
literal|6
index|]
operator|!=
literal|5
comment|/* sha-1WithRSAEncryption */
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: digestAlgorithm SHA1 "
literal|"does not match with certificate "
literal|"signatureAlgorithm (%lu)"
argument_list|,
name|cert
operator|->
name|signature
operator|.
name|oid
operator|.
name|oid
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
goto|goto
name|skip_digest_oid
goto|;
block|}
if|if
condition|(
operator|!
name|x509_digest_oid
argument_list|(
operator|&
name|oid
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unrecognized digestAlgorithm"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|oid
operator|.
name|oid
index|[
literal|5
index|]
condition|)
block|{
case|case
literal|5
case|:
comment|/* md5 */
if|if
condition|(
name|cert
operator|->
name|signature
operator|.
name|oid
operator|.
name|oid
index|[
literal|6
index|]
operator|!=
literal|4
comment|/* md5WithRSAEncryption */
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: digestAlgorithm MD5 does "
literal|"not match with certificate "
literal|"signatureAlgorithm (%lu)"
argument_list|,
name|cert
operator|->
name|signature
operator|.
name|oid
operator|.
name|oid
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
literal|2
case|:
comment|/* md2 */
case|case
literal|4
case|:
comment|/* md4 */
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Unsupported digestAlgorithm "
literal|"(%lu)"
argument_list|,
name|oid
operator|.
name|oid
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|skip_digest_oid
label|:
comment|/* Digest ::= OCTET STRING */
name|pos
operator|=
name|da_end
expr_stmt|;
name|end
operator|=
name|data
operator|+
name|data_len
expr_stmt|;
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_OCTETSTRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Expected OCTETSTRING "
literal|"(Digest) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: Decrypted Digest"
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cert
operator|->
name|signature
operator|.
name|oid
operator|.
name|oid
index|[
literal|6
index|]
condition|)
block|{
case|case
literal|4
case|:
comment|/* md5WithRSAEncryption */
name|md5_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|cert
operator|->
name|tbs_cert_start
argument_list|,
operator|&
name|cert
operator|->
name|tbs_cert_len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|hash_len
operator|=
literal|16
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: Certificate hash (MD5)"
argument_list|,
name|hash
argument_list|,
name|hash_len
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* sha-1WithRSAEncryption */
name|sha1_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|cert
operator|->
name|tbs_cert_start
argument_list|,
operator|&
name|cert
operator|->
name|tbs_cert_len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|hash_len
operator|=
literal|20
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"X509: Certificate hash (SHA1)"
argument_list|,
name|hash
argument_list|,
name|hash_len
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* md2WithRSAEncryption */
case|case
literal|11
case|:
comment|/* sha256WithRSAEncryption */
case|case
literal|12
case|:
comment|/* sha384WithRSAEncryption */
case|case
literal|13
case|:
comment|/* sha512WithRSAEncryption */
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"X509: Unsupported certificate signature "
literal|"algorithm (%lu)"
argument_list|,
name|cert
operator|->
name|signature
operator|.
name|oid
operator|.
name|oid
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hdr
operator|.
name|length
operator|!=
name|hash_len
operator|||
name|os_memcmp
argument_list|(
name|hdr
operator|.
name|payload
argument_list|,
name|hash
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"X509: Certificate Digest does not match "
literal|"with calculated tbsCertificate hash"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Certificate Digest matches with "
literal|"calculated tbsCertificate hash"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_valid_issuer
parameter_list|(
specifier|const
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|)
block|{
if|if
condition|(
operator|(
name|cert
operator|->
name|extensions_present
operator|&
name|X509_EXT_BASIC_CONSTRAINTS
operator|)
operator|&&
operator|!
name|cert
operator|->
name|ca
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Non-CA certificate used as an "
literal|"issuer"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|cert
operator|->
name|extensions_present
operator|&
name|X509_EXT_KEY_USAGE
operator|)
operator|&&
operator|!
operator|(
name|cert
operator|->
name|key_usage
operator|&
name|X509_KEY_USAGE_KEY_CERT_SIGN
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Issuer certificate did not have "
literal|"keyCertSign bit in Key Usage"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * x509_certificate_chain_validate - Validate X.509 certificate chain  * @trusted: List of trusted certificates  * @chain: Certificate chain to be validated (first chain must be issued by  * signed by the second certificate in the chain and so on)  * @reason: Buffer for returning failure reason (X509_VALIDATE_*)  * Returns: 0 if chain is valid, -1 if not  */
end_comment

begin_function
name|int
name|x509_certificate_chain_validate
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|trusted
parameter_list|,
name|struct
name|x509_certificate
modifier|*
name|chain
parameter_list|,
name|int
modifier|*
name|reason
parameter_list|)
block|{
name|int
name|idx
decl_stmt|,
name|chain_trusted
init|=
literal|0
decl_stmt|;
name|struct
name|x509_certificate
modifier|*
name|cert
decl_stmt|,
modifier|*
name|trust
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
operator|*
name|reason
operator|=
name|X509_VALIDATE_OK
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Validate certificate chain"
argument_list|)
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
for|for
control|(
name|cert
operator|=
name|chain
operator|,
name|idx
operator|=
literal|0
init|;
name|cert
condition|;
name|cert
operator|=
name|cert
operator|->
name|next
operator|,
name|idx
operator|++
control|)
block|{
name|x509_name_string
argument_list|(
operator|&
name|cert
operator|->
name|subject
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: %d: %s"
argument_list|,
name|idx
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain_trusted
condition|)
continue|continue;
if|if
condition|(
name|now
operator|.
name|sec
operator|<
name|cert
operator|->
name|not_before
operator|||
name|now
operator|.
name|sec
operator|>
name|cert
operator|->
name|not_after
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"X509: Certificate not valid "
literal|"(now=%lu not_before=%lu not_after=%lu)"
argument_list|,
name|now
operator|.
name|sec
argument_list|,
name|cert
operator|->
name|not_before
argument_list|,
name|cert
operator|->
name|not_after
argument_list|)
expr_stmt|;
operator|*
name|reason
operator|=
name|X509_VALIDATE_CERTIFICATE_EXPIRED
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|cert
operator|->
name|next
condition|)
block|{
if|if
condition|(
name|x509_name_compare
argument_list|(
operator|&
name|cert
operator|->
name|issuer
argument_list|,
operator|&
name|cert
operator|->
name|next
operator|->
name|subject
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Certificate "
literal|"chain issuer name mismatch"
argument_list|)
expr_stmt|;
operator|*
name|reason
operator|=
name|X509_VALIDATE_CERTIFICATE_UNKNOWN
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|x509_valid_issuer
argument_list|(
name|cert
operator|->
name|next
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|*
name|reason
operator|=
name|X509_VALIDATE_BAD_CERTIFICATE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: validate pathLenConstraint */
if|if
condition|(
name|x509_certificate_check_signature
argument_list|(
name|cert
operator|->
name|next
argument_list|,
name|cert
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Invalid "
literal|"certificate signature within "
literal|"chain"
argument_list|)
expr_stmt|;
operator|*
name|reason
operator|=
name|X509_VALIDATE_BAD_CERTIFICATE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
for|for
control|(
name|trust
operator|=
name|trusted
init|;
name|trust
condition|;
name|trust
operator|=
name|trust
operator|->
name|next
control|)
block|{
if|if
condition|(
name|x509_name_compare
argument_list|(
operator|&
name|cert
operator|->
name|issuer
argument_list|,
operator|&
name|trust
operator|->
name|subject
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|trust
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Found issuer from the "
literal|"list of trusted certificates"
argument_list|)
expr_stmt|;
if|if
condition|(
name|x509_valid_issuer
argument_list|(
name|trust
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|*
name|reason
operator|=
name|X509_VALIDATE_BAD_CERTIFICATE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|x509_certificate_check_signature
argument_list|(
name|trust
argument_list|,
name|cert
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Invalid "
literal|"certificate signature"
argument_list|)
expr_stmt|;
operator|*
name|reason
operator|=
name|X509_VALIDATE_BAD_CERTIFICATE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Trusted certificate "
literal|"found to complete the chain"
argument_list|)
expr_stmt|;
name|chain_trusted
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|chain_trusted
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Did not find any of the issuers "
literal|"from the list of trusted certificates"
argument_list|)
expr_stmt|;
if|if
condition|(
name|trusted
condition|)
block|{
operator|*
name|reason
operator|=
name|X509_VALIDATE_UNKNOWN_CA
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Certificate chain validation "
literal|"disabled - ignore unknown CA issue"
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"X509: Certificate chain valid"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * x509_certificate_get_subject - Get a certificate based on Subject name  * @chain: Certificate chain to search through  * @name: Subject name to search for  * Returns: Pointer to the certificate with the given Subject name or  * %NULL on failure  */
end_comment

begin_function
name|struct
name|x509_certificate
modifier|*
name|x509_certificate_get_subject
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|chain
parameter_list|,
name|struct
name|x509_name
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|x509_certificate
modifier|*
name|cert
decl_stmt|;
for|for
control|(
name|cert
operator|=
name|chain
init|;
name|cert
condition|;
name|cert
operator|=
name|cert
operator|->
name|next
control|)
block|{
if|if
condition|(
name|x509_name_compare
argument_list|(
operator|&
name|cert
operator|->
name|subject
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|cert
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * x509_certificate_self_signed - Is the certificate self-signed?  * @cert: Certificate  * Returns: 1 if certificate is self-signed, 0 if not  */
end_comment

begin_function
name|int
name|x509_certificate_self_signed
parameter_list|(
name|struct
name|x509_certificate
modifier|*
name|cert
parameter_list|)
block|{
return|return
name|x509_name_compare
argument_list|(
operator|&
name|cert
operator|->
name|issuer
argument_list|,
operator|&
name|cert
operator|->
name|subject
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_INTERNAL_X509 */
end_comment

end_unit


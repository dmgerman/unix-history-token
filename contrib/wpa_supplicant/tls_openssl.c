begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / SSL/TLS interface functions for openssl  * Copyright (c) 2004-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_SMARTCARD
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
end_ifndef

begin_define
define|#
directive|define
name|OPENSSL_NO_ENGINE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pkcs12.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509v3.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
end_ifndef

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_ENGINE */
end_comment

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"tls.h"
end_include

begin_if
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x0090800fL
end_if

begin_define
define|#
directive|define
name|OPENSSL_d2i_TYPE
value|const unsigned char **
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|OPENSSL_d2i_TYPE
value|unsigned char **
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|tls_openssl_ref_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tls_connection
block|{
name|SSL
modifier|*
name|ssl
decl_stmt|;
name|BIO
modifier|*
name|ssl_in
decl_stmt|,
modifier|*
name|ssl_out
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|ENGINE
modifier|*
name|engine
decl_stmt|;
comment|/* functional reference to the engine */
name|EVP_PKEY
modifier|*
name|private_key
decl_stmt|;
comment|/* the private key if using engine */
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
name|char
modifier|*
name|subject_match
decl_stmt|,
modifier|*
name|altsubject_match
decl_stmt|;
name|int
name|read_alerts
decl_stmt|,
name|write_alerts
decl_stmt|,
name|failed
decl_stmt|;
name|u8
modifier|*
name|pre_shared_secret
decl_stmt|;
name|size_t
name|pre_shared_secret_len
decl_stmt|;
block|}
struct|;
end_struct

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NO_STDOUT_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|_tls_show_errors
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|long
name|err
decl_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
comment|/* Just ignore the errors, since stdout is disabled */
block|}
block|}
end_function

begin_define
define|#
directive|define
name|tls_show_errors
parameter_list|(
name|l
parameter_list|,
name|f
parameter_list|,
name|t
parameter_list|)
value|_tls_show_errors()
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CONFIG_NO_STDOUT_DEBUG */
end_comment

begin_function
specifier|static
name|void
name|tls_show_errors
parameter_list|(
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|func
parameter_list|,
specifier|const
name|char
modifier|*
name|txt
parameter_list|)
block|{
name|unsigned
name|long
name|err
decl_stmt|;
name|wpa_printf
argument_list|(
name|level
argument_list|,
literal|"OpenSSL: %s - %s %s"
argument_list|,
name|func
argument_list|,
name|txt
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: pending error: %s"
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_STDOUT_DEBUG */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
end_ifdef

begin_comment
comment|/* Windows CryptoAPI and access to certificate stores */
end_comment

begin_include
include|#
directive|include
file|<wincrypt.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__MINGW32_VERSION
end_ifdef

begin_comment
comment|/*  * MinGW does not yet include all the needed definitions for CryptoAPI, so  * define here whatever extra is needed.  */
end_comment

begin_define
define|#
directive|define
name|CALG_SSL3_SHAMD5
value|(ALG_CLASS_HASH | ALG_TYPE_ANY | ALG_SID_SSL3SHAMD5)
end_define

begin_define
define|#
directive|define
name|CERT_SYSTEM_STORE_CURRENT_USER
value|(1<< 16)
end_define

begin_define
define|#
directive|define
name|CERT_STORE_READONLY_FLAG
value|0x00008000
end_define

begin_define
define|#
directive|define
name|CERT_STORE_OPEN_EXISTING_FLAG
value|0x00004000
end_define

begin_define
define|#
directive|define
name|CRYPT_ACQUIRE_COMPARE_KEY_FLAG
value|0x00000004
end_define

begin_function_decl
specifier|static
name|BOOL
name|WINAPI
function_decl|(
modifier|*
name|CryptAcquireCertificatePrivateKey
function_decl|)
parameter_list|(
name|PCCERT_CONTEXT
name|pCert
parameter_list|,
name|DWORD
name|dwFlags
parameter_list|,
name|void
modifier|*
name|pvReserved
parameter_list|,
name|HCRYPTPROV
modifier|*
name|phCryptProv
parameter_list|,
name|DWORD
modifier|*
name|pdwKeySpec
parameter_list|,
name|BOOL
modifier|*
name|pfCallerFreeProv
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_comment
comment|/* to be loaded from crypt32.dll */
end_comment

begin_function_decl
specifier|static
name|PCCERT_CONTEXT
name|WINAPI
function_decl|(
modifier|*
name|CertEnumCertificatesInStore
function_decl|)
parameter_list|(
name|HCERTSTORE
name|hCertStore
parameter_list|,
name|PCCERT_CONTEXT
name|pPrevCertContext
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_comment
comment|/* to be loaded from crypt32.dll */
end_comment

begin_function
specifier|static
name|int
name|mingw_load_crypto_func
parameter_list|(
name|void
parameter_list|)
block|{
name|HINSTANCE
name|dll
decl_stmt|;
comment|/* MinGW does not yet have full CryptoAPI support, so load the needed 	 * function here. */
if|if
condition|(
name|CryptAcquireCertificatePrivateKey
condition|)
return|return
literal|0
return|;
name|dll
operator|=
name|LoadLibrary
argument_list|(
literal|"crypt32"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dll
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CryptoAPI: Could not load crypt32 "
literal|"library"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|CryptAcquireCertificatePrivateKey
operator|=
name|GetProcAddress
argument_list|(
name|dll
argument_list|,
literal|"CryptAcquireCertificatePrivateKey"
argument_list|)
expr_stmt|;
if|if
condition|(
name|CryptAcquireCertificatePrivateKey
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CryptoAPI: Could not get "
literal|"CryptAcquireCertificatePrivateKey() address from "
literal|"crypt32 library"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|CertEnumCertificatesInStore
operator|=
operator|(
name|void
operator|*
operator|)
name|GetProcAddress
argument_list|(
name|dll
argument_list|,
literal|"CertEnumCertificatesInStore"
argument_list|)
expr_stmt|;
if|if
condition|(
name|CertEnumCertificatesInStore
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CryptoAPI: Could not get "
literal|"CertEnumCertificatesInStore() address from "
literal|"crypt32 library"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* __MINGW32_VERSION */
end_comment

begin_function
specifier|static
name|int
name|mingw_load_crypto_func
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __MINGW32_VERSION */
end_comment

begin_struct
struct|struct
name|cryptoapi_rsa_data
block|{
specifier|const
name|CERT_CONTEXT
modifier|*
name|cert
decl_stmt|;
name|HCRYPTPROV
name|crypt_prov
decl_stmt|;
name|DWORD
name|key_spec
decl_stmt|;
name|BOOL
name|free_crypt_prov
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|cryptoapi_error
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: %s; err=%u"
argument_list|,
name|msg
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_rsa_pub_enc
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - not implemented"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_rsa_pub_dec
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - not implemented"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_rsa_priv_enc
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|struct
name|cryptoapi_rsa_data
modifier|*
name|priv
init|=
operator|(
expr|struct
name|cryptoapi_rsa_data
operator|*
operator|)
name|rsa
operator|->
name|meth
operator|->
name|app_data
decl_stmt|;
name|HCRYPTHASH
name|hash
decl_stmt|;
name|DWORD
name|hash_size
decl_stmt|,
name|len
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
block|{
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|ERR_R_PASSED_NULL_PARAMETER
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|padding
operator|!=
name|RSA_PKCS1_PADDING
condition|)
block|{
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|RSA_R_UNKNOWN_PADDING_TYPE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|flen
operator|!=
literal|16
comment|/* MD5 */
operator|+
literal|20
comment|/* SHA-1 */
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s - only MD5-SHA1 hash supported"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|RSA_R_INVALID_MESSAGE_LENGTH
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|CryptCreateHash
argument_list|(
name|priv
operator|->
name|crypt_prov
argument_list|,
name|CALG_SSL3_SHAMD5
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|hash
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"CryptCreateHash failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|hash_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|CryptGetHashParam
argument_list|(
name|hash
argument_list|,
name|HP_HASHSIZE
argument_list|,
operator|(
name|BYTE
operator|*
operator|)
operator|&
name|hash_size
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"CryptGetHashParam failed"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|int
operator|)
name|hash_size
operator|!=
name|flen
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: Invalid hash size (%u != %d)"
argument_list|,
operator|(
name|unsigned
operator|)
name|hash_size
argument_list|,
name|flen
argument_list|)
expr_stmt|;
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|RSA_R_INVALID_MESSAGE_LENGTH
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|CryptSetHashParam
argument_list|(
name|hash
argument_list|,
name|HP_HASHVAL
argument_list|,
operator|(
name|BYTE
operator|*
operator|)
name|from
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"CryptSetHashParam failed"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|len
operator|=
name|RSA_size
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|CryptSignHash
argument_list|(
name|hash
argument_list|,
name|priv
operator|->
name|key_spec
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"CryptSignHash failed"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|to
index|[
name|i
index|]
operator|=
name|buf
index|[
name|len
operator|-
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|ret
operator|=
name|len
expr_stmt|;
name|err
label|:
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|CryptDestroyHash
argument_list|(
name|hash
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_rsa_priv_dec
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - not implemented"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cryptoapi_free_data
parameter_list|(
name|struct
name|cryptoapi_rsa_data
modifier|*
name|priv
parameter_list|)
block|{
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|priv
operator|->
name|crypt_prov
operator|&&
name|priv
operator|->
name|free_crypt_prov
condition|)
name|CryptReleaseContext
argument_list|(
name|priv
operator|->
name|crypt_prov
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|cert
condition|)
name|CertFreeCertificateContext
argument_list|(
name|priv
operator|->
name|cert
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_finish
parameter_list|(
name|RSA
modifier|*
name|rsa
parameter_list|)
block|{
name|cryptoapi_free_data
argument_list|(
operator|(
expr|struct
name|cryptoapi_rsa_data
operator|*
operator|)
name|rsa
operator|->
name|meth
operator|->
name|app_data
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|rsa
operator|->
name|meth
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|meth
operator|=
name|NULL
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|CERT_CONTEXT
modifier|*
name|cryptoapi_find_cert
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|DWORD
name|store
parameter_list|)
block|{
name|HCERTSTORE
name|cs
decl_stmt|;
specifier|const
name|CERT_CONTEXT
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|cs
operator|=
name|CertOpenStore
argument_list|(
operator|(
name|LPCSTR
operator|)
name|CERT_STORE_PROV_SYSTEM
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|store
operator||
name|CERT_STORE_OPEN_EXISTING_FLAG
operator||
name|CERT_STORE_READONLY_FLAG
argument_list|,
literal|L"MY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cs
operator|==
name|NULL
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"Failed to open 'My system store'"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"cert://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|unsigned
name|short
name|wbuf
index|[
literal|255
index|]
decl_stmt|;
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|name
operator|+
literal|7
argument_list|,
operator|-
literal|1
argument_list|,
name|wbuf
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|ret
operator|=
name|CertFindCertificateInStore
argument_list|(
name|cs
argument_list|,
name|X509_ASN_ENCODING
operator||
name|PKCS_7_ASN_ENCODING
argument_list|,
literal|0
argument_list|,
name|CERT_FIND_SUBJECT_STR
argument_list|,
name|wbuf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"hash://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|CRYPT_HASH_BLOB
name|blob
decl_stmt|;
name|int
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|hash
init|=
name|name
operator|+
literal|7
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|hash
argument_list|)
operator|/
literal|2
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|&&
name|hexstr2bin
argument_list|(
name|hash
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|blob
operator|.
name|cbData
operator|=
name|len
expr_stmt|;
name|blob
operator|.
name|pbData
operator|=
name|buf
expr_stmt|;
name|ret
operator|=
name|CertFindCertificateInStore
argument_list|(
name|cs
argument_list|,
name|X509_ASN_ENCODING
operator||
name|PKCS_7_ASN_ENCODING
argument_list|,
literal|0
argument_list|,
name|CERT_FIND_HASH
argument_list|,
operator|&
name|blob
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
name|CertCloseStore
argument_list|(
name|cs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_cryptoapi_cert
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|X509
modifier|*
name|cert
init|=
name|NULL
decl_stmt|;
name|RSA
modifier|*
name|rsa
init|=
name|NULL
decl_stmt|,
modifier|*
name|pub_rsa
decl_stmt|;
name|struct
name|cryptoapi_rsa_data
modifier|*
name|priv
decl_stmt|;
name|RSA_METHOD
modifier|*
name|rsa_meth
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
operator|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"cert://"
argument_list|,
literal|7
argument_list|)
operator|!=
literal|0
operator|&&
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"hash://"
argument_list|,
literal|7
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|priv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|priv
argument_list|)
argument_list|)
expr_stmt|;
name|rsa_meth
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rsa_meth
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|==
name|NULL
operator|||
name|rsa_meth
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"CryptoAPI: Failed to allocate memory "
literal|"for CryptoAPI RSA method"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rsa_meth
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|priv
operator|->
name|cert
operator|=
name|cryptoapi_find_cert
argument_list|(
name|name
argument_list|,
name|CERT_SYSTEM_STORE_CURRENT_USER
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|cert
operator|==
name|NULL
condition|)
block|{
name|priv
operator|->
name|cert
operator|=
name|cryptoapi_find_cert
argument_list|(
name|name
argument_list|,
name|CERT_SYSTEM_STORE_LOCAL_MACHINE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|priv
operator|->
name|cert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: Could not find certificate "
literal|"'%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|cert
operator|=
name|d2i_X509
argument_list|(
name|NULL
argument_list|,
operator|(
name|OPENSSL_d2i_TYPE
operator|)
operator|&
name|priv
operator|->
name|cert
operator|->
name|pbCertEncoded
argument_list|,
name|priv
operator|->
name|cert
operator|->
name|cbCertEncoded
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: Could not process X509 DER "
literal|"encoding"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|mingw_load_crypto_func
argument_list|()
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|CryptAcquireCertificatePrivateKey
argument_list|(
name|priv
operator|->
name|cert
argument_list|,
name|CRYPT_ACQUIRE_COMPARE_KEY_FLAG
argument_list|,
name|NULL
argument_list|,
operator|&
name|priv
operator|->
name|crypt_prov
argument_list|,
operator|&
name|priv
operator|->
name|key_spec
argument_list|,
operator|&
name|priv
operator|->
name|free_crypt_prov
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"Failed to acquire a private key for the "
literal|"certificate"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|rsa_meth
operator|->
name|name
operator|=
literal|"Microsoft CryptoAPI RSA Method"
expr_stmt|;
name|rsa_meth
operator|->
name|rsa_pub_enc
operator|=
name|cryptoapi_rsa_pub_enc
expr_stmt|;
name|rsa_meth
operator|->
name|rsa_pub_dec
operator|=
name|cryptoapi_rsa_pub_dec
expr_stmt|;
name|rsa_meth
operator|->
name|rsa_priv_enc
operator|=
name|cryptoapi_rsa_priv_enc
expr_stmt|;
name|rsa_meth
operator|->
name|rsa_priv_dec
operator|=
name|cryptoapi_rsa_priv_dec
expr_stmt|;
name|rsa_meth
operator|->
name|finish
operator|=
name|cryptoapi_finish
expr_stmt|;
name|rsa_meth
operator|->
name|flags
operator|=
name|RSA_METHOD_FLAG_NO_CHECK
expr_stmt|;
name|rsa_meth
operator|->
name|app_data
operator|=
operator|(
name|char
operator|*
operator|)
name|priv
expr_stmt|;
name|rsa
operator|=
name|RSA_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|rsa
operator|==
name|NULL
condition|)
block|{
name|SSLerr
argument_list|(
name|SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|SSL_use_certificate
argument_list|(
name|ssl
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
name|rsa
operator|=
name|NULL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|pub_rsa
operator|=
name|cert
operator|->
name|cert_info
operator|->
name|key
operator|->
name|pkey
operator|->
name|pkey
operator|.
name|rsa
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|cert
operator|=
name|NULL
expr_stmt|;
name|rsa
operator|->
name|n
operator|=
name|BN_dup
argument_list|(
name|pub_rsa
operator|->
name|n
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|e
operator|=
name|BN_dup
argument_list|(
name|pub_rsa
operator|->
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|RSA_set_method
argument_list|(
name|rsa
argument_list|,
name|rsa_meth
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|SSL_use_RSAPrivateKey
argument_list|(
name|ssl
argument_list|,
name|rsa
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
if|if
condition|(
name|cert
condition|)
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsa
condition|)
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
else|else
block|{
name|os_free
argument_list|(
name|rsa_meth
argument_list|)
expr_stmt|;
name|cryptoapi_free_data
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_cryptoapi_ca_cert
parameter_list|(
name|SSL_CTX
modifier|*
name|ssl_ctx
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|HCERTSTORE
name|cs
decl_stmt|;
name|PCCERT_CONTEXT
name|ctx
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|cert
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|store
decl_stmt|;
ifdef|#
directive|ifdef
name|UNICODE
name|WCHAR
modifier|*
name|wstore
decl_stmt|;
endif|#
directive|endif
comment|/* UNICODE */
if|if
condition|(
name|mingw_load_crypto_func
argument_list|()
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"cert_store://"
argument_list|,
literal|13
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|store
operator|=
name|name
operator|+
literal|13
expr_stmt|;
ifdef|#
directive|ifdef
name|UNICODE
name|wstore
operator|=
name|os_malloc
argument_list|(
operator|(
name|os_strlen
argument_list|(
name|store
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|WCHAR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wstore
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wsprintf
argument_list|(
name|wstore
argument_list|,
literal|L"%S"
argument_list|,
name|store
argument_list|)
expr_stmt|;
name|cs
operator|=
name|CertOpenSystemStore
argument_list|(
literal|0
argument_list|,
name|wstore
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wstore
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* UNICODE */
name|cs
operator|=
name|CertOpenSystemStore
argument_list|(
literal|0
argument_list|,
name|store
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* UNICODE */
if|if
condition|(
name|cs
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: failed to open system cert store "
literal|"'%s': error=%d"
argument_list|,
name|__func__
argument_list|,
name|store
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
operator|(
name|ctx
operator|=
name|CertEnumCertificatesInStore
argument_list|(
name|cs
argument_list|,
name|ctx
argument_list|)
operator|)
condition|)
block|{
name|cert
operator|=
name|d2i_X509
argument_list|(
name|NULL
argument_list|,
operator|(
name|OPENSSL_d2i_TYPE
operator|)
operator|&
name|ctx
operator|->
name|pbCertEncoded
argument_list|,
name|ctx
operator|->
name|cbCertEncoded
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: Could not process "
literal|"X509 DER encoding for CA cert"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|cert
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Loaded CA certificate for "
literal|"system certificate store: subject='%s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509_STORE_add_cert
argument_list|(
name|ssl_ctx
operator|->
name|cert_store
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to add ca_cert to OpenSSL "
literal|"certificate store"
argument_list|)
expr_stmt|;
block|}
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|CertCloseStore
argument_list|(
name|cs
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: failed to close system cert store "
literal|"'%s': error=%d"
argument_list|,
name|__func__
argument_list|,
name|name
operator|+
literal|13
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_function
specifier|static
name|int
name|tls_cryptoapi_cert
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_function
specifier|static
name|void
name|ssl_info_cb
parameter_list|(
specifier|const
name|SSL
modifier|*
name|ssl
parameter_list|,
name|int
name|where
parameter_list|,
name|int
name|ret
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|w
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: (where=0x%x ret=0x%x)"
argument_list|,
name|where
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|w
operator|=
name|where
operator|&
operator|~
name|SSL_ST_MASK
expr_stmt|;
if|if
condition|(
name|w
operator|&
name|SSL_ST_CONNECT
condition|)
name|str
operator|=
literal|"SSL_connect"
expr_stmt|;
elseif|else
if|if
condition|(
name|w
operator|&
name|SSL_ST_ACCEPT
condition|)
name|str
operator|=
literal|"SSL_accept"
expr_stmt|;
else|else
name|str
operator|=
literal|"undefined"
expr_stmt|;
if|if
condition|(
name|where
operator|&
name|SSL_CB_LOOP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: %s:%s"
argument_list|,
name|str
argument_list|,
name|SSL_state_string_long
argument_list|(
name|ssl
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|where
operator|&
name|SSL_CB_ALERT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SSL: SSL3 alert: %s:%s:%s"
argument_list|,
name|where
operator|&
name|SSL_CB_READ
condition|?
literal|"read (remote end reported an error)"
else|:
literal|"write (local SSL3 detected an error)"
argument_list|,
name|SSL_alert_type_string_long
argument_list|(
name|ret
argument_list|)
argument_list|,
name|SSL_alert_desc_string_long
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|>>
literal|8
operator|)
operator|==
name|SSL3_AL_FATAL
condition|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
name|SSL_get_app_data
argument_list|(
operator|(
name|SSL
operator|*
operator|)
name|ssl
argument_list|)
decl_stmt|;
if|if
condition|(
name|where
operator|&
name|SSL_CB_READ
condition|)
name|conn
operator|->
name|read_alerts
operator|++
expr_stmt|;
else|else
name|conn
operator|->
name|write_alerts
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|where
operator|&
name|SSL_CB_EXIT
operator|&&
name|ret
operator|<=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: %s:%s in %s"
argument_list|,
name|str
argument_list|,
name|ret
operator|==
literal|0
condition|?
literal|"failed"
else|:
literal|"error"
argument_list|,
name|SSL_state_string_long
argument_list|(
name|ssl
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
end_ifndef

begin_comment
comment|/**  * tls_engine_load_dynamic_generic - load any openssl engine  * @pre: an array of commands and values that load an engine initialized  *       in the engine specific function  * @post: an array of commands and values that initialize an already loaded  *        engine (or %NULL if not required)  * @id: the engine id of the engine to load (only required if post is not %NULL  *  * This function is a generic function that loads any openssl engine.  *  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
specifier|static
name|int
name|tls_engine_load_dynamic_generic
parameter_list|(
specifier|const
name|char
modifier|*
name|pre
index|[]
parameter_list|,
specifier|const
name|char
modifier|*
name|post
index|[]
parameter_list|,
specifier|const
name|char
modifier|*
name|id
parameter_list|)
block|{
name|ENGINE
modifier|*
name|engine
decl_stmt|;
specifier|const
name|char
modifier|*
name|dynamic_id
init|=
literal|"dynamic"
decl_stmt|;
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|engine
condition|)
block|{
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: engine '%s' is already "
literal|"available"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
name|dynamic_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|engine
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ENGINE: Can't find engine %s [%s]"
argument_list|,
name|dynamic_id
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Perform the pre commands. This will load the engine. */
while|while
condition|(
name|pre
operator|&&
name|pre
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: '%s' '%s'"
argument_list|,
name|pre
index|[
literal|0
index|]
argument_list|,
name|pre
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ENGINE_ctrl_cmd_string
argument_list|(
name|engine
argument_list|,
name|pre
index|[
literal|0
index|]
argument_list|,
name|pre
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ENGINE: ctrl cmd_string failed: "
literal|"%s %s [%s]"
argument_list|,
name|pre
index|[
literal|0
index|]
argument_list|,
name|pre
index|[
literal|1
index|]
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pre
operator|+=
literal|2
expr_stmt|;
block|}
comment|/* 	 * Free the reference to the "dynamic" engine. The loaded engine can 	 * now be looked up using ENGINE_by_id(). 	 */
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|engine
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ENGINE: Can't find engine %s [%s]"
argument_list|,
name|id
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|post
operator|&&
name|post
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: '%s' '%s'"
argument_list|,
name|post
index|[
literal|0
index|]
argument_list|,
name|post
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ENGINE_ctrl_cmd_string
argument_list|(
name|engine
argument_list|,
name|post
index|[
literal|0
index|]
argument_list|,
name|post
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: ctrl cmd_string failed:"
literal|" %s %s [%s]"
argument_list|,
name|post
index|[
literal|0
index|]
argument_list|,
name|post
index|[
literal|1
index|]
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|ENGINE_remove
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|post
operator|+=
literal|2
expr_stmt|;
block|}
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * tls_engine_load_dynamic_pkcs11 - load the pkcs11 engine provided by opensc  * @pkcs11_so_path: pksc11_so_path from the configuration  * @pcks11_module_path: pkcs11_module_path from the configuration  */
end_comment

begin_function
specifier|static
name|int
name|tls_engine_load_dynamic_pkcs11
parameter_list|(
specifier|const
name|char
modifier|*
name|pkcs11_so_path
parameter_list|,
specifier|const
name|char
modifier|*
name|pkcs11_module_path
parameter_list|)
block|{
name|char
modifier|*
name|engine_id
init|=
literal|"pkcs11"
decl_stmt|;
specifier|const
name|char
modifier|*
name|pre_cmd
index|[]
init|=
block|{
literal|"SO_PATH"
block|,
name|NULL
comment|/* pkcs11_so_path */
block|,
literal|"ID"
block|,
name|NULL
comment|/* engine_id */
block|,
literal|"LIST_ADD"
block|,
literal|"1"
block|,
comment|/* "NO_VCHECK", "1", */
literal|"LOAD"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
name|post_cmd
index|[]
init|=
block|{
literal|"MODULE_PATH"
block|,
name|NULL
comment|/* pkcs11_module_path */
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|pkcs11_so_path
operator|||
operator|!
name|pkcs11_module_path
condition|)
return|return
literal|0
return|;
name|pre_cmd
index|[
literal|1
index|]
operator|=
name|pkcs11_so_path
expr_stmt|;
name|pre_cmd
index|[
literal|3
index|]
operator|=
name|engine_id
expr_stmt|;
name|post_cmd
index|[
literal|1
index|]
operator|=
name|pkcs11_module_path
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: Loading pkcs11 Engine from %s"
argument_list|,
name|pkcs11_so_path
argument_list|)
expr_stmt|;
return|return
name|tls_engine_load_dynamic_generic
argument_list|(
name|pre_cmd
argument_list|,
name|post_cmd
argument_list|,
name|engine_id
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * tls_engine_load_dynamic_opensc - load the opensc engine provided by opensc  * @opensc_so_path: opensc_so_path from the configuration  */
end_comment

begin_function
specifier|static
name|int
name|tls_engine_load_dynamic_opensc
parameter_list|(
specifier|const
name|char
modifier|*
name|opensc_so_path
parameter_list|)
block|{
name|char
modifier|*
name|engine_id
init|=
literal|"opensc"
decl_stmt|;
specifier|const
name|char
modifier|*
name|pre_cmd
index|[]
init|=
block|{
literal|"SO_PATH"
block|,
name|NULL
comment|/* opensc_so_path */
block|,
literal|"ID"
block|,
name|NULL
comment|/* engine_id */
block|,
literal|"LIST_ADD"
block|,
literal|"1"
block|,
literal|"LOAD"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|opensc_so_path
condition|)
return|return
literal|0
return|;
name|pre_cmd
index|[
literal|1
index|]
operator|=
name|opensc_so_path
expr_stmt|;
name|pre_cmd
index|[
literal|3
index|]
operator|=
name|engine_id
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: Loading OpenSC Engine from %s"
argument_list|,
name|opensc_so_path
argument_list|)
expr_stmt|;
return|return
name|tls_engine_load_dynamic_generic
argument_list|(
name|pre_cmd
argument_list|,
name|NULL
argument_list|,
name|engine_id
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_ENGINE */
end_comment

begin_function
name|void
modifier|*
name|tls_init
parameter_list|(
specifier|const
name|struct
name|tls_config
modifier|*
name|conf
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl
decl_stmt|;
if|if
condition|(
name|tls_openssl_ref_count
operator|==
literal|0
condition|)
block|{
name|SSL_load_error_strings
argument_list|()
expr_stmt|;
name|SSL_library_init
argument_list|()
expr_stmt|;
comment|/* TODO: if /dev/urandom is available, PRNG is seeded 		 * automatically. If this is not the case, random data should 		 * be added here. */
ifdef|#
directive|ifdef
name|PKCS12_FUNCS
name|PKCS12_PBE_add
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* PKCS12_FUNCS */
block|}
name|tls_openssl_ref_count
operator|++
expr_stmt|;
name|ssl
operator|=
name|SSL_CTX_new
argument_list|(
name|TLSv1_method
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssl
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|SSL_CTX_set_info_callback
argument_list|(
name|ssl
argument_list|,
name|ssl_info_cb
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
if|if
condition|(
name|conf
operator|&&
operator|(
name|conf
operator|->
name|opensc_engine_path
operator|||
name|conf
operator|->
name|pkcs11_engine_path
operator|||
name|conf
operator|->
name|pkcs11_module_path
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: Loading dynamic engine"
argument_list|)
expr_stmt|;
name|ERR_load_ENGINE_strings
argument_list|()
expr_stmt|;
name|ENGINE_load_dynamic
argument_list|()
expr_stmt|;
if|if
condition|(
name|tls_engine_load_dynamic_opensc
argument_list|(
name|conf
operator|->
name|opensc_engine_path
argument_list|)
operator|||
name|tls_engine_load_dynamic_pkcs11
argument_list|(
name|conf
operator|->
name|pkcs11_engine_path
argument_list|,
name|conf
operator|->
name|pkcs11_module_path
argument_list|)
condition|)
block|{
name|tls_deinit
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
return|return
name|ssl
return|;
block|}
end_function

begin_function
name|void
name|tls_deinit
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl
init|=
name|ssl_ctx
decl_stmt|;
name|SSL_CTX_free
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
name|tls_openssl_ref_count
operator|--
expr_stmt|;
if|if
condition|(
name|tls_openssl_ref_count
operator|==
literal|0
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|ENGINE_cleanup
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
name|ERR_free_strings
argument_list|()
expr_stmt|;
name|EVP_cleanup
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|tls_engine_init
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|engine_id
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
specifier|const
name|char
modifier|*
name|key_id
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|engine_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: Engine ID not set"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|pin
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: Smartcard PIN not set"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|key_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: Key Id not set"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|conn
operator|->
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
name|engine_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|engine
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: engine %s not available [%s]"
argument_list|,
name|engine_id
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|ENGINE_init
argument_list|(
name|conn
operator|->
name|engine
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: engine init failed "
literal|"(engine: %s) [%s]"
argument_list|,
name|engine_id
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: engine initialized"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ENGINE_ctrl_cmd_string
argument_list|(
name|conn
operator|->
name|engine
argument_list|,
literal|"PIN"
argument_list|,
name|pin
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: cannot set pin [%s]"
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|conn
operator|->
name|private_key
operator|=
name|ENGINE_load_private_key
argument_list|(
name|conn
operator|->
name|engine
argument_list|,
name|key_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|private_key
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: cannot load private key with id"
literal|" '%s' [%s]"
argument_list|,
name|key_id
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|TLS_SET_PARAMS_ENGINE_PRV_INIT_FAILED
expr_stmt|;
goto|goto
name|err
goto|;
block|}
return|return
literal|0
return|;
name|err
label|:
if|if
condition|(
name|conn
operator|->
name|engine
condition|)
block|{
name|ENGINE_free
argument_list|(
name|conn
operator|->
name|engine
argument_list|)
expr_stmt|;
name|conn
operator|->
name|engine
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|conn
operator|->
name|private_key
condition|)
block|{
name|EVP_PKEY_free
argument_list|(
name|conn
operator|->
name|private_key
argument_list|)
expr_stmt|;
name|conn
operator|->
name|private_key
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
else|#
directive|else
comment|/* OPENSSL_NO_ENGINE */
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
block|}
end_function

begin_function
specifier|static
name|void
name|tls_engine_deinit
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: engine deinit"
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|private_key
condition|)
block|{
name|EVP_PKEY_free
argument_list|(
name|conn
operator|->
name|private_key
argument_list|)
expr_stmt|;
name|conn
operator|->
name|private_key
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|conn
operator|->
name|engine
condition|)
block|{
name|ENGINE_finish
argument_list|(
name|conn
operator|->
name|engine
argument_list|)
expr_stmt|;
name|conn
operator|->
name|engine
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
block|}
end_function

begin_function
name|int
name|tls_get_errors
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|err
decl_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS - SSL error: %s"
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
name|struct
name|tls_connection
modifier|*
name|tls_connection_init
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl
init|=
name|ssl_ctx
decl_stmt|;
name|struct
name|tls_connection
modifier|*
name|conn
decl_stmt|;
name|conn
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|conn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|conn
operator|->
name|ssl
operator|=
name|SSL_new
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|ssl
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to initialize new SSL connection"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|SSL_set_app_data
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|SSL_set_options
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_OP_NO_SSLv2
operator||
name|SSL_OP_NO_SSLv3
operator||
name|SSL_OP_SINGLE_DH_USE
argument_list|)
expr_stmt|;
name|conn
operator|->
name|ssl_in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|ssl_in
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to create a new BIO for ssl_in"
argument_list|)
expr_stmt|;
name|SSL_free
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|conn
operator|->
name|ssl_out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|ssl_out
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to create a new BIO for ssl_out"
argument_list|)
expr_stmt|;
name|SSL_free
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|conn
operator|->
name|ssl_in
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|SSL_set_bio
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|conn
operator|->
name|ssl_in
argument_list|,
name|conn
operator|->
name|ssl_out
argument_list|)
expr_stmt|;
return|return
name|conn
return|;
block|}
end_function

begin_function
name|void
name|tls_connection_deinit
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return;
name|os_free
argument_list|(
name|conn
operator|->
name|pre_shared_secret
argument_list|)
expr_stmt|;
name|SSL_free
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|tls_engine_deinit
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|subject_match
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|altsubject_match
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|tls_connection_established
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
name|conn
condition|?
name|SSL_is_init_finished
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
else|:
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_shutdown
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Shutdown previous TLS connection without notifying the peer 	 * because the connection was already terminated in practice 	 * and "close notify" shutdown alert would confuse AS. */
name|SSL_set_quiet_shutdown
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SSL_shutdown
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_match_altsubject_component
parameter_list|(
name|X509
modifier|*
name|cert
parameter_list|,
name|int
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|GENERAL_NAME
modifier|*
name|gen
decl_stmt|;
name|void
modifier|*
name|ext
decl_stmt|;
name|int
name|i
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|;
name|ext
operator|=
name|X509_get_ext_d2i
argument_list|(
name|cert
argument_list|,
name|NID_subject_alt_name
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ext
operator|&&
name|i
operator|<
name|sk_GENERAL_NAME_num
argument_list|(
name|ext
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|gen
operator|=
name|sk_GENERAL_NAME_value
argument_list|(
name|ext
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen
operator|->
name|type
operator|!=
name|type
condition|)
continue|continue;
if|if
condition|(
name|os_strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|gen
operator|->
name|d
operator|.
name|ia5
operator|->
name|data
argument_list|)
operator|==
name|len
operator|&&
name|os_memcmp
argument_list|(
name|value
argument_list|,
name|gen
operator|->
name|d
operator|.
name|ia5
operator|->
name|data
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
name|found
operator|++
expr_stmt|;
block|}
return|return
name|found
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_match_altsubject
parameter_list|(
name|X509
modifier|*
name|cert
parameter_list|,
specifier|const
name|char
modifier|*
name|match
parameter_list|)
block|{
name|int
name|type
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|pos
operator|=
name|match
expr_stmt|;
do|do
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"EMAIL:"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|type
operator|=
name|GEN_EMAIL
expr_stmt|;
name|pos
operator|+=
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"DNS:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|type
operator|=
name|GEN_DNS
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"URI:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|type
operator|=
name|GEN_URI
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Invalid altSubjectName "
literal|"match '%s'"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|end
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
while|while
condition|(
name|end
condition|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|end
operator|+
literal|1
argument_list|,
literal|"EMAIL:"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|||
name|os_strncmp
argument_list|(
name|end
operator|+
literal|1
argument_list|,
literal|"DNS:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|os_strncmp
argument_list|(
name|end
operator|+
literal|1
argument_list|,
literal|"URI:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|end
operator|=
name|os_strchr
argument_list|(
name|end
operator|+
literal|1
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|end
condition|)
name|len
operator|=
name|end
operator|-
name|pos
expr_stmt|;
else|else
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_match_altsubject_component
argument_list|(
name|cert
argument_list|,
name|type
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
operator|>
literal|0
condition|)
return|return
literal|1
return|;
name|pos
operator|=
name|end
operator|+
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|end
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_verify_cb
parameter_list|(
name|int
name|preverify_ok
parameter_list|,
name|X509_STORE_CTX
modifier|*
name|x509_ctx
parameter_list|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|X509
modifier|*
name|err_cert
decl_stmt|;
name|int
name|err
decl_stmt|,
name|depth
decl_stmt|;
name|SSL
modifier|*
name|ssl
decl_stmt|;
name|struct
name|tls_connection
modifier|*
name|conn
decl_stmt|;
name|char
modifier|*
name|match
decl_stmt|,
modifier|*
name|altmatch
decl_stmt|;
name|err_cert
operator|=
name|X509_STORE_CTX_get_current_cert
argument_list|(
name|x509_ctx
argument_list|)
expr_stmt|;
name|err
operator|=
name|X509_STORE_CTX_get_error
argument_list|(
name|x509_ctx
argument_list|)
expr_stmt|;
name|depth
operator|=
name|X509_STORE_CTX_get_error_depth
argument_list|(
name|x509_ctx
argument_list|)
expr_stmt|;
name|ssl
operator|=
name|X509_STORE_CTX_get_ex_data
argument_list|(
name|x509_ctx
argument_list|,
name|SSL_get_ex_data_X509_STORE_CTX_idx
argument_list|()
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|err_cert
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|=
name|SSL_get_app_data
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
name|match
operator|=
name|conn
condition|?
name|conn
operator|->
name|subject_match
else|:
name|NULL
expr_stmt|;
name|altmatch
operator|=
name|conn
condition|?
name|conn
operator|->
name|altsubject_match
else|:
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|preverify_ok
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TLS: Certificate verification failed,"
literal|" error %d (%s) depth %d for '%s'"
argument_list|,
name|err
argument_list|,
name|X509_verify_cert_error_string
argument_list|(
name|err
argument_list|)
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: tls_verify_cb - "
literal|"preverify_ok=%d err=%d (%s) depth=%d buf='%s'"
argument_list|,
name|preverify_ok
argument_list|,
name|err
argument_list|,
name|X509_verify_cert_error_string
argument_list|(
name|err
argument_list|)
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|==
literal|0
operator|&&
name|match
operator|&&
name|os_strstr
argument_list|(
name|buf
argument_list|,
name|match
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TLS: Subject '%s' did not "
literal|"match with '%s'"
argument_list|,
name|buf
argument_list|,
name|match
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|depth
operator|==
literal|0
operator|&&
name|altmatch
operator|&&
operator|!
name|tls_match_altsubject
argument_list|(
name|err_cert
argument_list|,
name|altmatch
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TLS: altSubjectName match "
literal|"'%s' not found"
argument_list|,
name|altmatch
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
name|preverify_ok
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
end_ifndef

begin_function
specifier|static
name|int
name|tls_load_ca_der
parameter_list|(
name|void
modifier|*
name|_ssl_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_cert
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|_ssl_ctx
decl_stmt|;
name|X509_LOOKUP
modifier|*
name|lookup
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|lookup
operator|=
name|X509_STORE_add_lookup
argument_list|(
name|ssl_ctx
operator|->
name|cert_store
argument_list|,
name|X509_LOOKUP_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|lookup
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed add lookup for X509 store"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|X509_LOOKUP_load_file
argument_list|(
name|lookup
argument_list|,
name|ca_cert
argument_list|,
name|X509_FILETYPE_ASN1
argument_list|)
condition|)
block|{
name|unsigned
name|long
name|err
init|=
name|ERR_peek_error
argument_list|()
decl_stmt|;
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed load CA in DER format"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ERR_GET_LIB
argument_list|(
name|err
argument_list|)
operator|==
name|ERR_LIB_X509
operator|&&
name|ERR_GET_REASON
argument_list|(
name|err
argument_list|)
operator|==
name|X509_R_CERT_ALREADY_IN_HASH_TABLE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - ignoring "
literal|"cert already in hash table error"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_STDIO */
end_comment

begin_function
specifier|static
name|int
name|tls_connection_ca_cert
parameter_list|(
name|void
modifier|*
name|_ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|ca_cert_blob
parameter_list|,
name|size_t
name|ca_cert_blob_len
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_path
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|_ssl_ctx
decl_stmt|;
if|if
condition|(
name|ca_cert_blob
condition|)
block|{
name|X509
modifier|*
name|cert
init|=
name|d2i_X509
argument_list|(
name|NULL
argument_list|,
operator|(
name|OPENSSL_d2i_TYPE
operator|)
operator|&
name|ca_cert_blob
argument_list|,
name|ca_cert_blob_len
argument_list|)
decl_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to parse ca_cert_blob"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|X509_STORE_add_cert
argument_list|(
name|ssl_ctx
operator|->
name|cert_store
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|unsigned
name|long
name|err
init|=
name|ERR_peek_error
argument_list|()
decl_stmt|;
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to add ca_cert_blob to "
literal|"certificate store"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ERR_GET_LIB
argument_list|(
name|err
argument_list|)
operator|==
name|ERR_LIB_X509
operator|&&
name|ERR_GET_REASON
argument_list|(
name|err
argument_list|)
operator|==
name|X509_R_CERT_ALREADY_IN_HASH_TABLE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - ignoring "
literal|"cert already in hash table error"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - added ca_cert_blob "
literal|"to certificate store"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_PEER
argument_list|,
name|tls_verify_cb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
if|if
condition|(
name|ca_cert
operator|&&
name|tls_cryptoapi_ca_cert
argument_list|(
name|ssl_ctx
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
name|ca_cert
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Added CA certificates from "
literal|"system certificate store"
argument_list|)
expr_stmt|;
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_PEER
argument_list|,
name|tls_verify_cb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
if|if
condition|(
name|ca_cert
operator|||
name|ca_path
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
if|if
condition|(
name|SSL_CTX_load_verify_locations
argument_list|(
name|ssl_ctx
argument_list|,
name|ca_cert
argument_list|,
name|ca_path
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to load root certificates"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ca_cert
operator|&&
name|tls_load_ca_der
argument_list|(
name|ssl_ctx
argument_list|,
name|ca_cert
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - loaded "
literal|"DER format CA certificate"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Trusted root "
literal|"certificate(s) loaded"
argument_list|)
expr_stmt|;
name|tls_get_errors
argument_list|(
name|ssl_ctx
argument_list|)
expr_stmt|;
block|}
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_PEER
argument_list|,
name|tls_verify_cb
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* OPENSSL_NO_STDIO */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - OPENSSL_NO_STDIO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
block|}
else|else
block|{
comment|/* No ca_cert configured - do not try to verify server 		 * certificate */
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_NONE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_global_ca_cert
parameter_list|(
name|SSL_CTX
modifier|*
name|ssl_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_cert
parameter_list|)
block|{
if|if
condition|(
name|ca_cert
condition|)
block|{
if|if
condition|(
name|SSL_CTX_load_verify_locations
argument_list|(
name|ssl_ctx
argument_list|,
name|ca_cert
argument_list|,
name|NULL
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to load root certificates"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Trusted root "
literal|"certificate(s) loaded"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
comment|/* Add the same CAs to the client certificate requests */
name|SSL_CTX_set_client_CA_list
argument_list|(
name|ssl_ctx
argument_list|,
name|SSL_load_client_CA_file
argument_list|(
name|ca_cert
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_global_set_verify
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|int
name|check_crl
parameter_list|)
block|{
name|int
name|flags
decl_stmt|;
if|if
condition|(
name|check_crl
condition|)
block|{
name|X509_STORE
modifier|*
name|cs
init|=
name|SSL_CTX_get_cert_store
argument_list|(
name|ssl_ctx
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to get "
literal|"certificate store when enabling "
literal|"check_crl"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|flags
operator|=
name|X509_V_FLAG_CRL_CHECK
expr_stmt|;
if|if
condition|(
name|check_crl
operator|==
literal|2
condition|)
name|flags
operator||=
name|X509_V_FLAG_CRL_CHECK_ALL
expr_stmt|;
name|X509_STORE_set_flags
argument_list|(
name|cs
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_set_subject_match
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|subject_match
parameter_list|,
specifier|const
name|char
modifier|*
name|altsubject_match
parameter_list|)
block|{
name|os_free
argument_list|(
name|conn
operator|->
name|subject_match
argument_list|)
expr_stmt|;
name|conn
operator|->
name|subject_match
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|subject_match
condition|)
block|{
name|conn
operator|->
name|subject_match
operator|=
name|os_strdup
argument_list|(
name|subject_match
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|subject_match
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|conn
operator|->
name|altsubject_match
argument_list|)
expr_stmt|;
name|conn
operator|->
name|altsubject_match
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|altsubject_match
condition|)
block|{
name|conn
operator|->
name|altsubject_match
operator|=
name|os_strdup
argument_list|(
name|altsubject_match
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|altsubject_match
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_set_verify
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|verify_peer
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|verify_peer
condition|)
block|{
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_PEER
operator||
name|SSL_VERIFY_FAIL_IF_NO_PEER_CERT
operator||
name|SSL_VERIFY_CLIENT_ONCE
argument_list|,
name|tls_verify_cb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_NONE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|SSL_set_accept_state
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_client_cert
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|client_cert_blob
parameter_list|,
name|size_t
name|client_cert_blob_len
parameter_list|)
block|{
if|if
condition|(
name|client_cert
operator|==
name|NULL
operator|&&
name|client_cert_blob
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|client_cert_blob
operator|&&
name|SSL_use_certificate_ASN1
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|client_cert_blob
argument_list|,
name|client_cert_blob_len
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_certificate_ASN1 --> "
literal|"OK"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|client_cert_blob
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_certificate_ASN1 failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|client_cert
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
if|if
condition|(
name|SSL_use_certificate_file
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|client_cert
argument_list|,
name|SSL_FILETYPE_ASN1
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_certificate_file (DER)"
literal|" --> OK"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_certificate_file (DER) failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SSL_use_certificate_file
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|client_cert
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_certificate_file (PEM)"
literal|" --> OK"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_certificate_file (PEM) failed"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* OPENSSL_NO_STDIO */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - OPENSSL_NO_STDIO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_global_client_cert
parameter_list|(
name|SSL_CTX
modifier|*
name|ssl_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
if|if
condition|(
name|client_cert
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|SSL_CTX_use_certificate_file
argument_list|(
name|ssl_ctx
argument_list|,
name|client_cert
argument_list|,
name|SSL_FILETYPE_ASN1
argument_list|)
operator|!=
literal|1
operator|&&
name|SSL_CTX_use_certificate_file
argument_list|(
name|ssl_ctx
argument_list|,
name|client_cert
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to load client certificate"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* OPENSSL_NO_STDIO */
if|if
condition|(
name|client_cert
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - OPENSSL_NO_STDIO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_passwd_cb
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|rwflag
parameter_list|,
name|void
modifier|*
name|password
parameter_list|)
block|{
if|if
condition|(
name|password
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|os_strncpy
argument_list|(
name|buf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|password
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|buf
index|[
name|size
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|os_strlen
argument_list|(
name|buf
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PKCS12_FUNCS
end_ifdef

begin_function
specifier|static
name|int
name|tls_parse_pkcs12
parameter_list|(
name|SSL_CTX
modifier|*
name|ssl_ctx
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
name|PKCS12
modifier|*
name|p12
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|pkey
decl_stmt|;
name|X509
modifier|*
name|cert
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|certs
expr_stmt|;
name|int
name|res
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|pkey
operator|=
name|NULL
expr_stmt|;
name|cert
operator|=
name|NULL
expr_stmt|;
name|certs
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|PKCS12_parse
argument_list|(
name|p12
argument_list|,
name|passwd
argument_list|,
operator|&
name|pkey
argument_list|,
operator|&
name|cert
argument_list|,
operator|&
name|certs
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"Failed to parse PKCS12 file"
argument_list|)
expr_stmt|;
name|PKCS12_free
argument_list|(
name|p12
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Successfully parsed PKCS12 data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
condition|)
block|{
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|cert
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Got certificate from PKCS12: "
literal|"subject='%s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssl
condition|)
block|{
if|if
condition|(
name|SSL_use_certificate
argument_list|(
name|ssl
argument_list|,
name|cert
argument_list|)
operator|!=
literal|1
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SSL_CTX_use_certificate
argument_list|(
name|ssl_ctx
argument_list|,
name|cert
argument_list|)
operator|!=
literal|1
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pkey
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Got private key from PKCS12"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssl
condition|)
block|{
if|if
condition|(
name|SSL_use_PrivateKey
argument_list|(
name|ssl
argument_list|,
name|pkey
argument_list|)
operator|!=
literal|1
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SSL_CTX_use_PrivateKey
argument_list|(
name|ssl_ctx
argument_list|,
name|pkey
argument_list|)
operator|!=
literal|1
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|certs
condition|)
block|{
while|while
condition|(
operator|(
name|cert
operator|=
name|sk_X509_pop
argument_list|(
name|certs
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|cert
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: additional certificate"
literal|" from PKCS12: subject='%s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
comment|/* 			 * There is no SSL equivalent for the chain cert - so 			 * always add it to the context... 			 */
if|if
condition|(
name|SSL_CTX_add_extra_chain_cert
argument_list|(
name|ssl_ctx
argument_list|,
name|cert
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|res
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|sk_X509_free
argument_list|(
name|certs
argument_list|)
expr_stmt|;
block|}
name|PKCS12_free
argument_list|(
name|p12
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|tls_get_errors
argument_list|(
name|ssl_ctx
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PKCS12_FUNCS */
end_comment

begin_function
specifier|static
name|int
name|tls_read_pkcs12
parameter_list|(
name|SSL_CTX
modifier|*
name|ssl_ctx
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PKCS12_FUNCS
name|FILE
modifier|*
name|f
decl_stmt|;
name|PKCS12
modifier|*
name|p12
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|private_key
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p12
operator|=
name|d2i_PKCS12_fp
argument_list|(
name|f
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|p12
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to use PKCS#12 file"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|tls_parse_pkcs12
argument_list|(
name|ssl_ctx
argument_list|,
name|ssl
argument_list|,
name|p12
argument_list|,
name|passwd
argument_list|)
return|;
else|#
directive|else
comment|/* PKCS12_FUNCS */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: PKCS12 support disabled - cannot read "
literal|"p12/pfx files"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* PKCS12_FUNCS */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_read_pkcs12_blob
parameter_list|(
name|SSL_CTX
modifier|*
name|ssl_ctx
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|u8
modifier|*
name|blob
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PKCS12_FUNCS
name|PKCS12
modifier|*
name|p12
decl_stmt|;
name|p12
operator|=
name|d2i_PKCS12
argument_list|(
name|NULL
argument_list|,
operator|(
name|OPENSSL_d2i_TYPE
operator|)
operator|&
name|blob
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p12
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to use PKCS#12 blob"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|tls_parse_pkcs12
argument_list|(
name|ssl_ctx
argument_list|,
name|ssl
argument_list|,
name|p12
argument_list|,
name|passwd
argument_list|)
return|;
else|#
directive|else
comment|/* PKCS12_FUNCS */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: PKCS12 support disabled - cannot parse "
literal|"p12/pfx blobs"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* PKCS12_FUNCS */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_engine_private_key
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
if|if
condition|(
name|SSL_use_PrivateKey
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|conn
operator|->
name|private_key
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_ERROR
argument_list|,
name|__func__
argument_list|,
literal|"ENGINE: cannot use private key for TLS"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|SSL_check_private_key
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Private key failed verification"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* OPENSSL_NO_ENGINE */
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"SSL: Configuration uses engine, but "
literal|"engine support was not compiled in"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_private_key
parameter_list|(
name|void
modifier|*
name|_ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key_passwd
parameter_list|,
specifier|const
name|u8
modifier|*
name|private_key_blob
parameter_list|,
name|size_t
name|private_key_blob_len
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|_ssl_ctx
decl_stmt|;
name|char
modifier|*
name|passwd
decl_stmt|;
name|int
name|ok
decl_stmt|;
if|if
condition|(
name|private_key
operator|==
name|NULL
operator|&&
name|private_key_blob
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|private_key_passwd
condition|)
block|{
name|passwd
operator|=
name|os_strdup
argument_list|(
name|private_key_passwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|passwd
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
name|passwd
operator|=
name|NULL
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|tls_passwd_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb_userdata
argument_list|(
name|ssl_ctx
argument_list|,
name|passwd
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|private_key_blob
condition|)
block|{
if|if
condition|(
name|SSL_use_PrivateKey_ASN1
argument_list|(
name|EVP_PKEY_RSA
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|private_key_blob
argument_list|,
name|private_key_blob_len
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_PrivateKey_"
literal|"ASN1(EVP_PKEY_RSA) --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_PrivateKey_ASN1(EVP_PKEY_RSA)"
literal|" failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SSL_use_PrivateKey_ASN1
argument_list|(
name|EVP_PKEY_DSA
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|private_key_blob
argument_list|,
name|private_key_blob_len
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_PrivateKey_"
literal|"ASN1(EVP_PKEY_DSA) --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_PrivateKey_ASN1(EVP_PKEY_DSA)"
literal|" failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SSL_use_RSAPrivateKey_ASN1
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|private_key_blob
argument_list|,
name|private_key_blob_len
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: "
literal|"SSL_use_RSAPrivateKey_ASN1 --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_RSAPrivateKey_ASN1 failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tls_read_pkcs12_blob
argument_list|(
name|ssl_ctx
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
name|private_key_blob
argument_list|,
name|private_key_blob_len
argument_list|,
name|passwd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: PKCS#12 as blob --> "
literal|"OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
break|break;
block|}
while|while
condition|(
operator|!
name|ok
operator|&&
name|private_key
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
if|if
condition|(
name|SSL_use_PrivateKey_file
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|private_key
argument_list|,
name|SSL_FILETYPE_ASN1
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: "
literal|"SSL_use_PrivateKey_File (DER) --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_PrivateKey_File (DER) "
literal|"failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SSL_use_PrivateKey_file
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|private_key
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: "
literal|"SSL_use_PrivateKey_File (PEM) --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_PrivateKey_File (PEM) "
literal|"failed"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* OPENSSL_NO_STDIO */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - OPENSSL_NO_STDIO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
if|if
condition|(
name|tls_read_pkcs12
argument_list|(
name|ssl_ctx
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
name|private_key
argument_list|,
name|passwd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Reading PKCS#12 file "
literal|"--> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tls_cryptoapi_cert
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|private_key
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Using CryptoAPI to "
literal|"access certificate store --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
break|break;
block|}
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Failed to load private key"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
name|ERR_clear_error
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SSL_check_private_key
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Private key failed "
literal|"verification"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: Private key loaded successfully"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_global_private_key
parameter_list|(
name|SSL_CTX
modifier|*
name|ssl_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key_passwd
parameter_list|)
block|{
name|char
modifier|*
name|passwd
decl_stmt|;
if|if
condition|(
name|private_key
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|private_key_passwd
condition|)
block|{
name|passwd
operator|=
name|os_strdup
argument_list|(
name|private_key_passwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|passwd
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
name|passwd
operator|=
name|NULL
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|tls_passwd_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb_userdata
argument_list|(
name|ssl_ctx
argument_list|,
name|passwd
argument_list|)
expr_stmt|;
if|if
condition|(
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
name|SSL_CTX_use_PrivateKey_file
argument_list|(
name|ssl_ctx
argument_list|,
name|private_key
argument_list|,
name|SSL_FILETYPE_ASN1
argument_list|)
operator|!=
literal|1
operator|&&
name|SSL_CTX_use_PrivateKey_file
argument_list|(
name|ssl_ctx
argument_list|,
name|private_key
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
operator|!=
literal|1
operator|&&
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
name|tls_read_pkcs12
argument_list|(
name|ssl_ctx
argument_list|,
name|NULL
argument_list|,
name|private_key
argument_list|,
name|passwd
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to load private key"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
name|ERR_clear_error
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SSL_CTX_check_private_key
argument_list|(
name|ssl_ctx
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Private key failed verification"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_dh
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|dh_file
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|OPENSSL_NO_DH
if|if
condition|(
name|dh_file
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TLS: openssl does not include DH support, but "
literal|"dh_file specified"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
else|#
directive|else
comment|/* OPENSSL_NO_DH */
name|DH
modifier|*
name|dh
decl_stmt|;
name|BIO
modifier|*
name|bio
decl_stmt|;
comment|/* TODO: add support for dh_blob */
if|if
condition|(
name|dh_file
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bio
operator|=
name|BIO_new_file
argument_list|(
name|dh_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to open DH file '%s': %s"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dh
operator|=
name|PEM_read_bio_DHparams
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_DSA
while|while
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|DSA
modifier|*
name|dsa
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Failed to parse DH file '%s': %s -"
literal|" trying to parse as DSA params"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|bio
operator|=
name|BIO_new_file
argument_list|(
name|dh_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio
operator|==
name|NULL
condition|)
break|break;
name|dsa
operator|=
name|PEM_read_bio_DSAparams
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Failed to parse DSA file "
literal|"'%s': %s"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: DH file in DSA param format"
argument_list|)
expr_stmt|;
name|dh
operator|=
name|DSA_dup_DH
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
name|DSA_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to convert DSA "
literal|"params into DH params"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* !OPENSSL_NO_DSA */
if|if
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to read/parse DH/DSA file "
literal|"'%s'"
argument_list|,
name|dh_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|SSL_set_tmp_dh
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|dh
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to set DH params from '%s': "
literal|"%s"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_DH */
block|}
end_function

begin_function
name|int
name|tls_connection_get_keys
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|struct
name|tls_keys
modifier|*
name|keys
parameter_list|)
block|{
name|SSL
modifier|*
name|ssl
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|keys
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ssl
operator|=
name|conn
operator|->
name|ssl
expr_stmt|;
if|if
condition|(
name|ssl
operator|==
name|NULL
operator|||
name|ssl
operator|->
name|s3
operator|==
name|NULL
operator|||
name|ssl
operator|->
name|session
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
name|keys
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|keys
operator|->
name|master_key
operator|=
name|ssl
operator|->
name|session
operator|->
name|master_key
expr_stmt|;
name|keys
operator|->
name|master_key_len
operator|=
name|ssl
operator|->
name|session
operator|->
name|master_key_length
expr_stmt|;
name|keys
operator|->
name|client_random
operator|=
name|ssl
operator|->
name|s3
operator|->
name|client_random
expr_stmt|;
name|keys
operator|->
name|client_random_len
operator|=
name|SSL3_RANDOM_SIZE
expr_stmt|;
name|keys
operator|->
name|server_random
operator|=
name|ssl
operator|->
name|s3
operator|->
name|server_random
expr_stmt|;
name|keys
operator|->
name|server_random_len
operator|=
name|SSL3_RANDOM_SIZE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_prf
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|int
name|server_random_first
parameter_list|,
name|u8
modifier|*
name|out
parameter_list|,
name|size_t
name|out_len
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|tls_connection_handshake
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
name|in_len
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|,
name|u8
modifier|*
modifier|*
name|appl_data
parameter_list|,
name|size_t
modifier|*
name|appl_data_len
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|u8
modifier|*
name|out_data
decl_stmt|;
if|if
condition|(
name|appl_data
condition|)
operator|*
name|appl_data
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Give TLS handshake data from the server (if available) to OpenSSL 	 * for processing. 	 */
if|if
condition|(
name|in_data
operator|&&
name|BIO_write
argument_list|(
name|conn
operator|->
name|ssl_in
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Handshake failed - BIO_write"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Initiate TLS handshake or continue the existing handshake */
name|res
operator|=
name|SSL_connect
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|1
condition|)
block|{
name|int
name|err
init|=
name|SSL_get_error
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|res
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|SSL_ERROR_WANT_READ
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: SSL_connect - want "
literal|"more data"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|err
operator|==
name|SSL_ERROR_WANT_WRITE
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: SSL_connect - want to "
literal|"write"
argument_list|)
expr_stmt|;
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"SSL_connect"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|failed
operator|++
expr_stmt|;
block|}
block|}
comment|/* Get the TLS handshake data to be sent to the server */
name|res
operator|=
name|BIO_ctrl_pending
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: %d bytes pending from ssl_out"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|out_data
operator|=
name|os_malloc
argument_list|(
name|res
operator|==
literal|0
condition|?
literal|1
else|:
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|out_data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: Failed to allocate memory for "
literal|"handshake output (%d bytes)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
block|}
operator|*
name|out_len
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|res
operator|==
literal|0
condition|?
literal|0
else|:
name|BIO_read
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|,
name|out_data
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Handshake failed - BIO_read"
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
block|}
operator|*
name|out_len
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|out_len
operator|=
name|res
expr_stmt|;
if|if
condition|(
name|SSL_is_init_finished
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
operator|&&
name|appl_data
condition|)
block|{
operator|*
name|appl_data
operator|=
name|os_malloc
argument_list|(
name|in_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|appl_data
condition|)
block|{
name|res
operator|=
name|SSL_read
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
operator|*
name|appl_data
argument_list|,
name|in_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to read possible "
literal|"Application Data"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
operator|*
name|appl_data
argument_list|)
expr_stmt|;
operator|*
name|appl_data
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
operator|*
name|appl_data_len
operator|=
name|res
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"SSL: Application"
literal|" Data in Finish message"
argument_list|,
operator|*
name|appl_data
argument_list|,
operator|*
name|appl_data_len
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|out_data
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|tls_connection_server_handshake
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
name|in_len
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|u8
modifier|*
name|out_data
decl_stmt|;
name|char
name|buf
index|[
literal|10
index|]
decl_stmt|;
if|if
condition|(
name|in_data
operator|&&
name|BIO_write
argument_list|(
name|conn
operator|->
name|ssl_in
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Handshake failed - BIO_write"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|SSL_read
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: Unexpected data from SSL_read "
literal|"(res=%d)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
name|res
operator|=
name|BIO_ctrl_pending
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: %d bytes pending from ssl_out"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|out_data
operator|=
name|os_malloc
argument_list|(
name|res
operator|==
literal|0
condition|?
literal|1
else|:
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|out_data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: Failed to allocate memory for "
literal|"handshake output (%d bytes)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
block|}
operator|*
name|out_len
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|res
operator|==
literal|0
condition|?
literal|0
else|:
name|BIO_read
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|,
name|out_data
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Handshake failed - BIO_read"
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
block|}
operator|*
name|out_len
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|out_len
operator|=
name|res
expr_stmt|;
return|return
name|out_data
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_encrypt
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
name|in_len
parameter_list|,
name|u8
modifier|*
name|out_data
parameter_list|,
name|size_t
name|out_len
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Give plaintext data for OpenSSL to encrypt into the TLS tunnel. */
if|if
condition|(
operator|(
name|res
operator|=
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_in
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|res
operator|=
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
name|res
operator|=
name|SSL_write
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Encryption failed - SSL_write"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
comment|/* Read encrypted data to be sent to the server */
name|res
operator|=
name|BIO_read
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|,
name|out_data
argument_list|,
name|out_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Encryption failed - BIO_read"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_decrypt
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
name|in_len
parameter_list|,
name|u8
modifier|*
name|out_data
parameter_list|,
name|size_t
name|out_len
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
comment|/* Give encrypted data from TLS tunnel for OpenSSL to decrypt. */
name|res
operator|=
name|BIO_write
argument_list|(
name|conn
operator|->
name|ssl_in
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Decryption failed - BIO_write"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
if|if
condition|(
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
comment|/* Read decrypted data for further processing */
name|res
operator|=
name|SSL_read
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|out_data
argument_list|,
name|out_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Decryption failed - SSL_read"
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_resumed
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
name|conn
condition|?
name|conn
operator|->
name|ssl
operator|->
name|hit
else|:
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|EAP_FAST
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_FAST_DYNAMIC
argument_list|)
end_if

begin_comment
comment|/* Pre-shared secred requires a patch to openssl, so this function is  * commented out unless explicitly needed for EAP-FAST in order to be able to  * build this file with unmodified openssl. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|tls_sess_sec_cb
argument_list|(
name|SSL
operator|*
name|s
argument_list|,
name|void
operator|*
name|secret
argument_list|,
name|int
operator|*
name|secret_len
argument_list|,
name|STACK_OF
argument_list|(
name|SSL_CIPHER
argument_list|)
operator|*
name|peer_ciphers
argument_list|,
name|SSL_CIPHER
operator|*
operator|*
name|cipher
argument_list|,
name|void
operator|*
name|arg
argument_list|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|pre_shared_secret
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|os_memcpy
argument_list|(
name|secret
argument_list|,
name|conn
operator|->
name|pre_shared_secret
argument_list|,
name|conn
operator|->
name|pre_shared_secret_len
argument_list|)
expr_stmt|;
operator|*
name|secret_len
operator|=
name|conn
operator|->
name|pre_shared_secret_len
expr_stmt|;
return|return
literal|1
return|;
block|}
end_decl_stmt

begin_function
name|int
name|tls_connection_set_master_key
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|key_len
operator|>
name|SSL_MAX_MASTER_KEY_LENGTH
condition|)
return|return
operator|-
literal|1
return|;
name|os_free
argument_list|(
name|conn
operator|->
name|pre_shared_secret
argument_list|)
expr_stmt|;
name|conn
operator|->
name|pre_shared_secret
operator|=
name|NULL
expr_stmt|;
name|conn
operator|->
name|pre_shared_secret_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
name|conn
operator|->
name|pre_shared_secret
operator|=
name|os_malloc
argument_list|(
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|pre_shared_secret
condition|)
block|{
name|os_memcpy
argument_list|(
name|conn
operator|->
name|pre_shared_secret
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|conn
operator|->
name|pre_shared_secret_len
operator|=
name|key_len
expr_stmt|;
block|}
if|if
condition|(
name|SSL_set_session_secret_cb
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|tls_sess_sec_cb
argument_list|,
name|conn
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|SSL_set_session_secret_cb
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_FAST || EAP_FAST_DYNAMIC */
end_comment

begin_function
name|int
name|tls_connection_set_cipher_list
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
name|ciphers
parameter_list|)
block|{
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
modifier|*
name|c
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|==
name|NULL
operator|||
name|ciphers
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|pos
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|c
operator|=
name|ciphers
expr_stmt|;
while|while
condition|(
operator|*
name|c
operator|!=
name|TLS_CIPHER_NONE
condition|)
block|{
specifier|const
name|char
modifier|*
name|suite
decl_stmt|;
switch|switch
condition|(
operator|*
name|c
condition|)
block|{
case|case
name|TLS_CIPHER_RC4_SHA
case|:
name|suite
operator|=
literal|"RC4-SHA"
expr_stmt|;
break|break;
case|case
name|TLS_CIPHER_AES128_SHA
case|:
name|suite
operator|=
literal|"AES128-SHA"
expr_stmt|;
break|break;
case|case
name|TLS_CIPHER_RSA_DHE_AES128_SHA
case|:
name|suite
operator|=
literal|"DHE-RSA-AES128-SHA"
expr_stmt|;
break|break;
case|case
name|TLS_CIPHER_ANON_DH_AES128_SHA
case|:
name|suite
operator|=
literal|"ADH-AES128-SHA"
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Unsupported "
literal|"cipher selection: %d"
argument_list|,
operator|*
name|c
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|":%s"
argument_list|,
name|suite
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
break|break;
name|pos
operator|+=
name|ret
expr_stmt|;
name|c
operator|++
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: cipher suites: %s"
argument_list|,
name|buf
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|SSL_set_cipher_list
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|buf
operator|+
literal|1
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Cipher suite configuration failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_get_cipher
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|name
operator|=
name|SSL_get_cipher
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|buf
index|[
name|buflen
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_enable_workaround
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
name|SSL_set_options
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|EAP_FAST
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_FAST_DYNAMIC
argument_list|)
end_if

begin_comment
comment|/* ClientHello TLS extensions require a patch to openssl, so this function is  * commented out unless explicitly needed for EAP-FAST in order to be able to  * build this file with unmodified openssl. */
end_comment

begin_function
name|int
name|tls_connection_client_hello_ext
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|ext_type
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|SSL_set_hello_extension
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|ext_type
argument_list|,
operator|(
name|void
operator|*
operator|)
name|data
argument_list|,
name|data_len
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_FAST || EAP_FAST_DYNAMIC */
end_comment

begin_function
name|int
name|tls_connection_get_failed
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|conn
operator|->
name|failed
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_read_alerts
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|conn
operator|->
name|read_alerts
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_write_alerts
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|conn
operator|->
name|write_alerts
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_set_params
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|tls_connection_params
modifier|*
name|params
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|unsigned
name|long
name|err
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s: Clearing pending SSL error: %s"
argument_list|,
name|__func__
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tls_connection_set_subject_match
argument_list|(
name|conn
argument_list|,
name|params
operator|->
name|subject_match
argument_list|,
name|params
operator|->
name|altsubject_match
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|tls_connection_ca_cert
argument_list|(
name|tls_ctx
argument_list|,
name|conn
argument_list|,
name|params
operator|->
name|ca_cert
argument_list|,
name|params
operator|->
name|ca_cert_blob
argument_list|,
name|params
operator|->
name|ca_cert_blob_len
argument_list|,
name|params
operator|->
name|ca_path
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|tls_connection_client_cert
argument_list|(
name|conn
argument_list|,
name|params
operator|->
name|client_cert
argument_list|,
name|params
operator|->
name|client_cert_blob
argument_list|,
name|params
operator|->
name|client_cert_blob_len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|->
name|engine
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: Initializing TLS engine"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|tls_engine_init
argument_list|(
name|conn
argument_list|,
name|params
operator|->
name|engine_id
argument_list|,
name|params
operator|->
name|pin
argument_list|,
name|params
operator|->
name|key_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|tls_connection_engine_private_key
argument_list|(
name|conn
argument_list|)
condition|)
return|return
name|TLS_SET_PARAMS_ENGINE_PRV_VERIFY_FAILED
return|;
block|}
elseif|else
if|if
condition|(
name|tls_connection_private_key
argument_list|(
name|tls_ctx
argument_list|,
name|conn
argument_list|,
name|params
operator|->
name|private_key
argument_list|,
name|params
operator|->
name|private_key_passwd
argument_list|,
name|params
operator|->
name|private_key_blob
argument_list|,
name|params
operator|->
name|private_key_blob_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to load private key '%s'"
argument_list|,
name|params
operator|->
name|private_key
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tls_connection_dh
argument_list|(
name|conn
argument_list|,
name|params
operator|->
name|dh_file
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to load DH file '%s'"
argument_list|,
name|params
operator|->
name|dh_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tls_get_errors
argument_list|(
name|tls_ctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_global_set_params
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
specifier|const
name|struct
name|tls_connection_params
modifier|*
name|params
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|tls_ctx
decl_stmt|;
name|unsigned
name|long
name|err
decl_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s: Clearing pending SSL error: %s"
argument_list|,
name|__func__
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tls_global_ca_cert
argument_list|(
name|ssl_ctx
argument_list|,
name|params
operator|->
name|ca_cert
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|tls_global_client_cert
argument_list|(
name|ssl_ctx
argument_list|,
name|params
operator|->
name|client_cert
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|tls_global_private_key
argument_list|(
name|ssl_ctx
argument_list|,
name|params
operator|->
name|private_key
argument_list|,
name|params
operator|->
name|private_key_passwd
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_keyblock_size
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
specifier|const
name|EVP_CIPHER
modifier|*
name|c
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|h
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|->
name|enc_read_ctx
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|->
name|enc_read_ctx
operator|->
name|cipher
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|->
name|read_hash
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|c
operator|=
name|conn
operator|->
name|ssl
operator|->
name|enc_read_ctx
operator|->
name|cipher
expr_stmt|;
name|h
operator|=
name|conn
operator|->
name|ssl
operator|->
name|read_hash
expr_stmt|;
return|return
literal|2
operator|*
operator|(
name|EVP_CIPHER_key_length
argument_list|(
name|c
argument_list|)
operator|+
name|EVP_MD_size
argument_list|(
name|h
argument_list|)
operator|+
name|EVP_CIPHER_iv_length
argument_list|(
name|c
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|tls_capabilities
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_set_ia
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|tls_ia
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_ia_send_phase_finished
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|final
parameter_list|,
name|u8
modifier|*
name|out_data
parameter_list|,
name|size_t
name|out_len
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_ia_final_phase_finished
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_ia_permute_inner_secret
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

end_unit


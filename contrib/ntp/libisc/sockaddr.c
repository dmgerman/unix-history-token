begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 1999-2003  Internet Software Consortium.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: sockaddr.c,v 1.48.2.1.2.10 2004/05/15 03:46:12 jinmei Exp $ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_define
define|#
directive|define
name|ISC_ONLY_IPV6
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<isc/buffer.h>
end_include

begin_comment
comment|/*  * We currently don't need hashing here  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_include
include|#
directive|include
file|<isc/hash.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<isc/msgs.h>
end_include

begin_include
include|#
directive|include
file|<isc/netaddr.h>
end_include

begin_include
include|#
directive|include
file|<isc/print.h>
end_include

begin_include
include|#
directive|include
file|<isc/region.h>
end_include

begin_include
include|#
directive|include
file|<isc/sockaddr.h>
end_include

begin_include
include|#
directive|include
file|<isc/string.h>
end_include

begin_include
include|#
directive|include
file|<isc/util.h>
end_include

begin_function
name|isc_boolean_t
name|isc_sockaddr_equal
parameter_list|(
specifier|const
name|isc_sockaddr_t
modifier|*
name|a
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|b
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|a
operator|!=
name|NULL
operator|&&
name|b
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|length
operator|!=
name|b
operator|->
name|length
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
comment|/* 	 * We don't just memcmp because the sin_zero field isn't always 	 * zero. 	 */
if|if
condition|(
name|a
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
operator|!=
name|b
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
switch|switch
condition|(
name|a
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|a
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
argument_list|,
operator|&
name|b
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|a
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_port
operator|!=
name|b
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_port
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
break|break;
case|case
name|AF_INET6
case|:
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|a
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|,
operator|&
name|b
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|a
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESCOPEID
if|if
condition|(
name|a
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_scope_id
operator|!=
name|b
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_scope_id
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
endif|#
directive|endif
if|if
condition|(
name|a
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_port
operator|!=
name|b
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_port
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
break|break;
default|default:
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|a
operator|->
name|type
argument_list|,
operator|&
name|b
operator|->
name|type
argument_list|,
name|a
operator|->
name|length
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isc_sockaddr_eqaddr
parameter_list|(
specifier|const
name|isc_sockaddr_t
modifier|*
name|a
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|b
parameter_list|)
block|{
name|REQUIRE
argument_list|(
name|a
operator|!=
name|NULL
operator|&&
name|b
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|length
operator|!=
name|b
operator|->
name|length
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
operator|!=
name|b
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
switch|switch
condition|(
name|a
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|a
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
argument_list|,
operator|&
name|b
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|a
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
break|break;
case|case
name|AF_INET6
case|:
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|a
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|,
operator|&
name|b
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|a
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESCOPEID
if|if
condition|(
name|a
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_scope_id
operator|!=
name|b
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_scope_id
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
endif|#
directive|endif
break|break;
default|default:
if|if
condition|(
name|memcmp
argument_list|(
operator|&
name|a
operator|->
name|type
argument_list|,
operator|&
name|b
operator|->
name|type
argument_list|,
name|a
operator|->
name|length
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
return|return
operator|(
name|ISC_TRUE
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isc_sockaddr_eqaddrprefix
parameter_list|(
specifier|const
name|isc_sockaddr_t
modifier|*
name|a
parameter_list|,
specifier|const
name|isc_sockaddr_t
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|prefixlen
parameter_list|)
block|{
name|isc_netaddr_t
name|na
decl_stmt|,
name|nb
decl_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|na
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|nb
argument_list|,
name|b
argument_list|)
expr_stmt|;
return|return
operator|(
name|isc_netaddr_eqprefix
argument_list|(
operator|&
name|na
argument_list|,
operator|&
name|nb
argument_list|,
name|prefixlen
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_result_t
name|isc_sockaddr_totext
parameter_list|(
specifier|const
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|,
name|isc_buffer_t
modifier|*
name|target
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_netaddr_t
name|netaddr
decl_stmt|;
name|char
name|pbuf
index|[
sizeof|sizeof
argument_list|(
literal|"65000"
argument_list|)
index|]
decl_stmt|;
name|unsigned
name|int
name|plen
decl_stmt|;
name|isc_region_t
name|avail
decl_stmt|;
name|REQUIRE
argument_list|(
name|sockaddr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Do the port first, giving us the opportunity to check for 	 * unsupported address families before calling 	 * isc_netaddr_fromsockaddr(). 	 */
switch|switch
condition|(
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|snprintf
argument_list|(
name|pbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|pbuf
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|ntohs
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|snprintf
argument_list|(
name|pbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|pbuf
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
name|ntohs
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_port
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ISC_R_FAILURE
operator|)
return|;
block|}
name|plen
operator|=
name|strlen
argument_list|(
name|pbuf
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|plen
operator|<
sizeof|sizeof
argument_list|(
name|pbuf
argument_list|)
argument_list|)
expr_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|sockaddr
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_netaddr_totext
argument_list|(
operator|&
name|netaddr
argument_list|,
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
return|return
operator|(
name|result
operator|)
return|;
if|if
condition|(
literal|1
operator|+
name|plen
operator|+
literal|1
operator|>
name|isc_buffer_availablelength
argument_list|(
name|target
argument_list|)
condition|)
return|return
operator|(
name|ISC_R_NOSPACE
operator|)
return|;
name|isc_buffer_putmem
argument_list|(
name|target
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
literal|"#"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|isc_buffer_putmem
argument_list|(
name|target
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|pbuf
argument_list|,
name|plen
argument_list|)
expr_stmt|;
comment|/* 	 * Null terminate after used region. 	 */
name|isc_buffer_availableregion
argument_list|(
name|target
argument_list|,
operator|&
name|avail
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|avail
operator|.
name|length
operator|>=
literal|1
argument_list|)
expr_stmt|;
name|avail
operator|.
name|base
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|ISC_R_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|isc_sockaddr_format
parameter_list|(
specifier|const
name|isc_sockaddr_t
modifier|*
name|sa
parameter_list|,
name|char
modifier|*
name|array
parameter_list|,
name|unsigned
name|int
name|size
parameter_list|)
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_buffer_t
name|buf
decl_stmt|;
name|isc_buffer_init
argument_list|(
operator|&
name|buf
argument_list|,
name|array
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_sockaddr_totext
argument_list|(
name|sa
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|ISC_R_SUCCESS
condition|)
block|{
comment|/* 		 * The message is the same as in netaddr.c. 		 */
name|snprintf
argument_list|(
name|array
argument_list|,
name|size
argument_list|,
name|isc_msgcat_get
argument_list|(
name|isc_msgcat
argument_list|,
name|ISC_MSGSET_NETADDR
argument_list|,
name|ISC_MSG_UNKNOWNADDR
argument_list|,
literal|"<unknown address, family %u>"
argument_list|)
argument_list|,
name|sa
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
argument_list|)
expr_stmt|;
name|array
index|[
name|size
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/*  * We currently don't need hashing here  */
end_comment

begin_if
unit|unsigned int isc_sockaddr_hash(const isc_sockaddr_t *sockaddr, isc_boolean_t address_only) { 	unsigned int length = 0; 	const unsigned char *s = NULL; 	unsigned int h = 0; 	unsigned int g; 	unsigned int p = 0; 	const struct in6_addr *in6;  	REQUIRE(sockaddr != NULL);  	switch (sockaddr->type.sa.sa_family) { 	case AF_INET: 		s = (const unsigned char *)&sockaddr->type.sin.sin_addr; 		p = ntohs(sockaddr->type.sin.sin_port); 		length = sizeof(sockaddr->type.sin.sin_addr.s_addr); 		break;
if|#
directive|if
name|ISC_PLATFORM_HAVEIPV6
end_if

begin_endif
unit|case AF_INET6: 		in6 =&sockaddr->type.sin6.sin6_addr; 		if (IN6_IS_ADDR_V4MAPPED(in6)) { 			s = (const unsigned char *)&in6[12]; 			length = sizeof(sockaddr->type.sin.sin_addr.s_addr); 		} else { 			s = (const unsigned char *)in6; 			length = sizeof(sockaddr->type.sin6.sin6_addr); 		} 		p = ntohs(sockaddr->type.sin6.sin6_port); 		break;
endif|#
directive|endif
end_endif

begin_comment
unit|default: 		UNEXPECTED_ERROR(__FILE__, __LINE__, 				 isc_msgcat_get(isc_msgcat, 						ISC_MSGSET_SOCKADDR, 						ISC_MSG_UNKNOWNFAMILY, 						"unknown address family: %d"), 					     (int)sockaddr->type.sa.sa_family); 		s = (const unsigned char *)&sockaddr->type; 		length = sockaddr->length; 		p = 0; 	}  	h = isc_hash_calc(s, length, ISC_TRUE); 	if (!address_only) { 		g = isc_hash_calc((const unsigned char *)&p, sizeof(p), 				  ISC_TRUE); 		h = h ^ g;
comment|/* XXX: we should concatenate h and p first */
end_comment

begin_endif
unit|}  	return (h); }
endif|#
directive|endif
end_endif

begin_function
name|void
name|isc_sockaddr_any
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|)
block|{
name|memset
argument_list|(
name|sockaddr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_port
operator|=
literal|0
expr_stmt|;
name|sockaddr
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|sockaddr
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isc_sockaddr_any6
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVEIPV6
name|memset
argument_list|(
name|sockaddr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
operator|=
name|in6addr_any
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_port
operator|=
literal|0
expr_stmt|;
name|sockaddr
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|sockaddr
argument_list|,
name|link
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|isc_sockaddr_fromin
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|,
specifier|const
name|struct
name|in_addr
modifier|*
name|ina
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
name|memset
argument_list|(
name|sockaddr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
operator|=
operator|*
name|ina
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|sockaddr
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isc_sockaddr_anyofpf
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|,
name|int
name|pf
parameter_list|)
block|{
switch|switch
condition|(
name|pf
condition|)
block|{
case|case
name|AF_INET
case|:
name|isc_sockaddr_any
argument_list|(
name|sockaddr
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|isc_sockaddr_any6
argument_list|(
name|sockaddr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|isc_sockaddr_fromin6
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|,
specifier|const
name|struct
name|in6_addr
modifier|*
name|ina6
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
name|memset
argument_list|(
name|sockaddr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
operator|=
operator|*
name|ina6
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|sockaddr
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isc_sockaddr_v6fromin
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|,
specifier|const
name|struct
name|in_addr
modifier|*
name|ina
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
name|memset
argument_list|(
name|sockaddr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|10
index|]
operator|=
literal|0xff
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|11
index|]
operator|=
literal|0xff
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|12
index|]
argument_list|,
name|ina
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
argument_list|)
expr_stmt|;
name|ISC_LINK_INIT
argument_list|(
name|sockaddr
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|isc_sockaddr_pf
parameter_list|(
specifier|const
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|)
block|{
comment|/* 	 * Get the protocol family of 'sockaddr'. 	 */
if|#
directive|if
operator|(
name|AF_INET
operator|==
name|PF_INET
operator|&&
name|AF_INET6
operator|==
name|PF_INET6
operator|)
comment|/* 	 * Assume that PF_xxx == AF_xxx for all AF and PF. 	 */
return|return
operator|(
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
operator|)
return|;
else|#
directive|else
switch|switch
condition|(
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
return|return
operator|(
name|PF_INET
operator|)
return|;
case|case
name|AF_INET6
case|:
return|return
operator|(
name|PF_INET6
operator|)
return|;
default|default:
name|FATAL_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
name|isc_msgcat_get
argument_list|(
name|isc_msgcat
argument_list|,
name|ISC_MSGSET_SOCKADDR
argument_list|,
name|ISC_MSG_UNKNOWNFAMILY
argument_list|,
literal|"unknown address family: %d"
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|isc_sockaddr_fromnetaddr
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|,
specifier|const
name|isc_netaddr_t
modifier|*
name|na
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
name|memset
argument_list|(
name|sockaddr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_family
operator|=
name|na
operator|->
name|family
expr_stmt|;
switch|switch
condition|(
name|na
operator|->
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sockaddr
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_addr
operator|=
name|na
operator|->
name|type
operator|.
name|in
expr_stmt|;
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|sockaddr
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|memcpy
argument_list|(
operator|&
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_addr
argument_list|,
operator|&
name|na
operator|->
name|type
operator|.
name|in6
argument_list|,
literal|16
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESCOPEID
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_scope_id
operator|=
name|isc_netaddr_getzone
argument_list|(
name|na
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
break|break;
default|default:
name|INSIST
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ISC_LINK_INIT
argument_list|(
name|sockaddr
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|isc_sockaddr_setport
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|,
name|in_port_t
name|port
parameter_list|)
block|{
switch|switch
condition|(
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
break|break;
default|default:
name|FATAL_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
name|isc_msgcat_get
argument_list|(
name|isc_msgcat
argument_list|,
name|ISC_MSGSET_SOCKADDR
argument_list|,
name|ISC_MSG_UNKNOWNFAMILY
argument_list|,
literal|"unknown address family: %d"
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|in_port_t
name|isc_sockaddr_getport
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|)
block|{
name|in_port_t
name|port
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|port
operator|=
name|ntohs
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin
operator|.
name|sin_port
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|port
operator|=
name|ntohs
argument_list|(
name|sockaddr
operator|->
name|type
operator|.
name|sin6
operator|.
name|sin6_port
argument_list|)
expr_stmt|;
break|break;
default|default:
name|FATAL_ERROR
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
name|isc_msgcat_get
argument_list|(
name|isc_msgcat
argument_list|,
name|ISC_MSGSET_SOCKADDR
argument_list|,
name|ISC_MSG_UNKNOWNFAMILY
argument_list|,
literal|"unknown address family: %d"
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|port
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isc_sockaddr_ismulticast
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|)
block|{
name|isc_netaddr_t
name|netaddr
decl_stmt|;
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|sockaddr
argument_list|)
expr_stmt|;
return|return
operator|(
name|isc_netaddr_ismulticast
argument_list|(
operator|&
name|netaddr
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isc_sockaddr_isexperimental
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|)
block|{
name|isc_netaddr_t
name|netaddr
decl_stmt|;
if|if
condition|(
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|sockaddr
argument_list|)
expr_stmt|;
return|return
operator|(
name|isc_netaddr_isexperimental
argument_list|(
operator|&
name|netaddr
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isc_sockaddr_issitelocal
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|)
block|{
name|isc_netaddr_t
name|netaddr
decl_stmt|;
if|if
condition|(
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|sockaddr
argument_list|)
expr_stmt|;
return|return
operator|(
name|isc_netaddr_issitelocal
argument_list|(
operator|&
name|netaddr
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

begin_function
name|isc_boolean_t
name|isc_sockaddr_islinklocal
parameter_list|(
name|isc_sockaddr_t
modifier|*
name|sockaddr
parameter_list|)
block|{
name|isc_netaddr_t
name|netaddr
decl_stmt|;
if|if
condition|(
name|sockaddr
operator|->
name|type
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
name|isc_netaddr_fromsockaddr
argument_list|(
operator|&
name|netaddr
argument_list|,
name|sockaddr
argument_list|)
expr_stmt|;
return|return
operator|(
name|isc_netaddr_islinklocal
argument_list|(
operator|&
name|netaddr
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|ISC_FALSE
operator|)
return|;
block|}
end_function

end_unit


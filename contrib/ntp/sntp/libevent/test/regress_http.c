begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003-2007 Niels Provos<provos@citi.umich.edu>  * Copyright (c) 2007-2012 Niels Provos and Nick Mathewson  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"util-internal.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32
end_ifdef

begin_include
include|#
directive|include
file|<winsock2.h>
end_include

begin_include
include|#
directive|include
file|<ws2tcpip.h>
end_include

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"event2/event-config.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|EVENT__HAVE_SYS_TIME_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|_WIN32
end_ifndef

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"event2/dns.h"
end_include

begin_include
include|#
directive|include
file|"event2/event.h"
end_include

begin_include
include|#
directive|include
file|"event2/http.h"
end_include

begin_include
include|#
directive|include
file|"event2/buffer.h"
end_include

begin_include
include|#
directive|include
file|"event2/bufferevent.h"
end_include

begin_include
include|#
directive|include
file|"event2/util.h"
end_include

begin_include
include|#
directive|include
file|"log-internal.h"
end_include

begin_include
include|#
directive|include
file|"http-internal.h"
end_include

begin_include
include|#
directive|include
file|"regress.h"
end_include

begin_include
include|#
directive|include
file|"regress_testutils.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|evhttp
modifier|*
name|http
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* set if a test needs to call loopexit on a base */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|event_base
modifier|*
name|exit_base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
specifier|const
name|BASIC_REQUEST_BODY
index|[]
init|=
literal|"This is funny"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|IMPL_HTTP_REQUEST_ERROR_CB
parameter_list|(
name|name
parameter_list|,
name|expecting_error
parameter_list|)
define|\
value|static void                                                              \ 	http_request_error_cb_with_##name##_(enum evhttp_request_error error,    \ 	                                     void *arg)                          \ 	{                                                                        \ 		if (error != expecting_error) { 									 \ 			fprintf(stderr, "FAILED\n"); 									 \ 			exit(1); 														 \ 		} 																	 \ 		test_ok = 1; 														 \ 	}
end_define

begin_macro
name|IMPL_HTTP_REQUEST_ERROR_CB
argument_list|(
argument|cancel
argument_list|,
argument|EVREQ_HTTP_REQUEST_CANCEL
argument_list|)
end_macro

begin_function_decl
specifier|static
name|void
name|http_basic_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_chunked_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_post_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_put_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_delete_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_delay_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_large_delay_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_badreq_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_dispatcher_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_on_complete_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|http_bind
parameter_list|(
name|struct
name|evhttp
modifier|*
name|myhttp
parameter_list|,
name|ev_uint16_t
modifier|*
name|pport
parameter_list|,
name|int
name|ipv6
parameter_list|)
block|{
name|int
name|port
decl_stmt|;
name|struct
name|evhttp_bound_socket
modifier|*
name|sock
decl_stmt|;
if|if
condition|(
name|ipv6
condition|)
name|sock
operator|=
name|evhttp_bind_socket_with_handle
argument_list|(
name|myhttp
argument_list|,
literal|"::1"
argument_list|,
operator|*
name|pport
argument_list|)
expr_stmt|;
else|else
name|sock
operator|=
name|evhttp_bind_socket_with_handle
argument_list|(
name|myhttp
argument_list|,
literal|"127.0.0.1"
argument_list|,
operator|*
name|pport
argument_list|)
expr_stmt|;
if|if
condition|(
name|sock
operator|==
name|NULL
condition|)
name|event_errx
argument_list|(
literal|1
argument_list|,
literal|"Could not start web server"
argument_list|)
expr_stmt|;
name|port
operator|=
name|regress_get_socket_port
argument_list|(
name|evhttp_bound_socket_get_fd
argument_list|(
name|sock
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pport
operator|=
operator|(
name|ev_uint16_t
operator|)
name|port
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|evhttp
modifier|*
name|http_setup
parameter_list|(
name|ev_uint16_t
modifier|*
name|pport
parameter_list|,
name|struct
name|event_base
modifier|*
name|base
parameter_list|,
name|int
name|ipv6
parameter_list|)
block|{
name|struct
name|evhttp
modifier|*
name|myhttp
decl_stmt|;
comment|/* Try a few different ports */
name|myhttp
operator|=
name|evhttp_new
argument_list|(
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|http_bind
argument_list|(
name|myhttp
argument_list|,
name|pport
argument_list|,
name|ipv6
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
comment|/* Register a callback for certain types of requests */
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/test"
argument_list|,
name|http_basic_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/chunked"
argument_list|,
name|http_chunked_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/streamed"
argument_list|,
name|http_chunked_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/postit"
argument_list|,
name|http_post_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/putit"
argument_list|,
name|http_put_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/deleteit"
argument_list|,
name|http_delete_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/delay"
argument_list|,
name|http_delay_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/largedelay"
argument_list|,
name|http_large_delay_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/badrequest"
argument_list|,
name|http_badreq_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/oncomplete"
argument_list|,
name|http_on_complete_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|myhttp
argument_list|,
literal|"/"
argument_list|,
name|http_dispatcher_cb
argument_list|,
name|base
argument_list|)
expr_stmt|;
return|return
operator|(
name|myhttp
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|NI_MAXSERV
end_ifndef

begin_define
define|#
directive|define
name|NI_MAXSERV
value|1024
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|evutil_socket_t
name|http_connect
parameter_list|(
specifier|const
name|char
modifier|*
name|address
parameter_list|,
name|u_short
name|port
parameter_list|)
block|{
comment|/* Stupid code for connecting */
name|struct
name|evutil_addrinfo
name|ai
decl_stmt|,
modifier|*
name|aitop
decl_stmt|;
name|char
name|strport
index|[
name|NI_MAXSERV
index|]
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|slen
decl_stmt|;
name|evutil_socket_t
name|fd
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ai
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ai
argument_list|)
argument_list|)
expr_stmt|;
name|ai
operator|.
name|ai_family
operator|=
name|AF_INET
expr_stmt|;
name|ai
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
name|evutil_snprintf
argument_list|(
name|strport
argument_list|,
sizeof|sizeof
argument_list|(
name|strport
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|evutil_getaddrinfo
argument_list|(
name|address
argument_list|,
name|strport
argument_list|,
operator|&
name|ai
argument_list|,
operator|&
name|aitop
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|event_warn
argument_list|(
literal|"getaddrinfo"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|sa
operator|=
name|aitop
operator|->
name|ai_addr
expr_stmt|;
name|slen
operator|=
name|aitop
operator|->
name|ai_addrlen
expr_stmt|;
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
name|event_err
argument_list|(
literal|1
argument_list|,
literal|"socket failed"
argument_list|)
expr_stmt|;
name|evutil_make_socket_nonblocking
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|connect
argument_list|(
name|fd
argument_list|,
name|sa
argument_list|,
name|slen
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|_WIN32
name|int
name|tmp_err
init|=
name|WSAGetLastError
argument_list|()
decl_stmt|;
if|if
condition|(
name|tmp_err
operator|!=
name|WSAEINPROGRESS
operator|&&
name|tmp_err
operator|!=
name|WSAEINVAL
operator|&&
name|tmp_err
operator|!=
name|WSAEWOULDBLOCK
condition|)
name|event_err
argument_list|(
literal|1
argument_list|,
literal|"connect failed"
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|errno
operator|!=
name|EINPROGRESS
condition|)
name|event_err
argument_list|(
literal|1
argument_list|,
literal|"connect failed"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|evutil_freeaddrinfo
argument_list|(
name|aitop
argument_list|)
expr_stmt|;
return|return
operator|(
name|fd
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Helper: do a strcmp on the contents of buf and the string s. */
end_comment

begin_function
specifier|static
name|int
name|evbuffer_datacmp
parameter_list|(
name|struct
name|evbuffer
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|size_t
name|b_sz
init|=
name|evbuffer_get_length
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|size_t
name|s_sz
init|=
name|strlen
argument_list|(
name|s
argument_list|)
decl_stmt|;
name|unsigned
name|char
modifier|*
name|d
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|b_sz
operator|<
name|s_sz
condition|)
return|return
operator|-
literal|1
return|;
name|d
operator|=
name|evbuffer_pullup
argument_list|(
name|buf
argument_list|,
name|s_sz
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|memcmp
argument_list|(
name|d
argument_list|,
name|s
argument_list|,
name|s_sz
argument_list|)
operator|)
condition|)
return|return
name|r
return|;
if|if
condition|(
name|b_sz
operator|>
name|s_sz
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Helper: Return true iff buf contains s */
end_comment

begin_function
specifier|static
name|int
name|evbuffer_contains
parameter_list|(
name|struct
name|evbuffer
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|struct
name|evbuffer_ptr
name|ptr
decl_stmt|;
name|ptr
operator|=
name|evbuffer_search
argument_list|(
name|buf
argument_list|,
name|s
argument_list|,
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|ptr
operator|.
name|pos
operator|!=
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_readcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|what
init|=
name|BASIC_REQUEST_BODY
decl_stmt|;
name|struct
name|event_base
modifier|*
name|my_base
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|evbuffer_contains
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|what
argument_list|)
condition|)
block|{
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|evhttp_request_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|enum
name|message_read_status
name|done
decl_stmt|;
comment|/* req->kind = EVHTTP_RESPONSE; */
name|done
operator|=
name|evhttp_parse_firstline_
argument_list|(
name|req
argument_list|,
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|done
operator|!=
name|ALL_DATA_READ
condition|)
goto|goto
name|out
goto|;
name|done
operator|=
name|evhttp_parse_headers_
argument_list|(
name|req
argument_list|,
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|done
operator|!=
name|ALL_DATA_READ
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|done
operator|==
literal|1
operator|&&
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Type"
argument_list|)
operator|!=
name|NULL
condition|)
name|test_ok
operator|++
expr_stmt|;
name|out
label|:
name|evhttp_request_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|bufferevent_disable
argument_list|(
name|bev
argument_list|,
name|EV_READ
argument_list|)
expr_stmt|;
if|if
condition|(
name|exit_base
condition|)
name|event_base_loopexit
argument_list|(
name|exit_base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|my_base
condition|)
name|event_base_loopexit
argument_list|(
name|my_base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No way to exit loop!\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|http_writecb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|bufferevent_get_output
argument_list|(
name|bev
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* enable reading of the reply */
name|bufferevent_enable
argument_list|(
name|bev
argument_list|,
name|EV_READ
argument_list|)
expr_stmt|;
name|test_ok
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|http_errorcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|test_ok
operator|=
operator|-
literal|2
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|found_multi
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|found_multi2
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|http_basic_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evbuffer
modifier|*
name|evb
init|=
name|evbuffer_new
argument_list|()
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
decl_stmt|;
name|int
name|empty
init|=
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Empty"
argument_list|)
operator|!=
name|NULL
decl_stmt|;
name|event_debug
argument_list|(
operator|(
literal|"%s: called\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evb
argument_list|,
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_request_get_connection
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evhttp_connection_get_server
argument_list|(
name|evcon
argument_list|)
operator|==
name|http
argument_list|)
expr_stmt|;
comment|/* For multi-line headers test */
block|{
specifier|const
name|char
modifier|*
name|multi
init|=
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"X-Multi"
argument_list|)
decl_stmt|;
if|if
condition|(
name|multi
condition|)
block|{
name|found_multi
operator|=
operator|!
name|strcmp
argument_list|(
name|multi
argument_list|,
literal|"aaaaaaaa a END"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"END"
argument_list|,
name|multi
operator|+
name|strlen
argument_list|(
name|multi
argument_list|)
operator|-
literal|3
argument_list|)
operator|==
literal|0
condition|)
name|test_ok
operator|++
expr_stmt|;
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"X-Last"
argument_list|)
condition|)
name|test_ok
operator|++
expr_stmt|;
block|}
block|}
block|{
specifier|const
name|char
modifier|*
name|multi2
init|=
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"X-Multi-Extra-WS"
argument_list|)
decl_stmt|;
if|if
condition|(
name|multi2
condition|)
block|{
name|found_multi2
operator|=
operator|!
name|strcmp
argument_list|(
name|multi2
argument_list|,
literal|"libevent 2.1"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* injecting a bad content-length */
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"X-Negative"
argument_list|)
condition|)
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Length"
argument_list|,
literal|"-100"
argument_list|)
expr_stmt|;
comment|/* allow sending of an empty reply */
name|evhttp_send_reply
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"Everything is fine"
argument_list|,
operator|!
name|empty
condition|?
name|evb
else|:
name|NULL
argument_list|)
expr_stmt|;
name|end
label|:
name|evbuffer_free
argument_list|(
name|evb
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
specifier|const
modifier|*
specifier|const
name|CHUNKS
index|[]
init|=
block|{
literal|"This is funny"
block|,
literal|"but not hilarious."
block|,
literal|"bwv 1052"
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|chunk_req_state
block|{
name|struct
name|event_base
modifier|*
name|base
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
decl_stmt|;
name|int
name|i
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|http_chunked_trickle_cb
parameter_list|(
name|evutil_socket_t
name|fd
parameter_list|,
name|short
name|events
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evbuffer
modifier|*
name|evb
init|=
name|evbuffer_new
argument_list|()
decl_stmt|;
name|struct
name|chunk_req_state
modifier|*
name|state
init|=
name|arg
decl_stmt|;
name|struct
name|timeval
name|when
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evb
argument_list|,
literal|"%s"
argument_list|,
name|CHUNKS
index|[
name|state
operator|->
name|i
index|]
argument_list|)
expr_stmt|;
name|evhttp_send_reply_chunk
argument_list|(
name|state
operator|->
name|req
argument_list|,
name|evb
argument_list|)
expr_stmt|;
name|evbuffer_free
argument_list|(
name|evb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|state
operator|->
name|i
operator|<
call|(
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|CHUNKS
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|CHUNKS
index|[
literal|0
index|]
argument_list|)
argument_list|)
condition|)
block|{
name|event_base_once
argument_list|(
name|state
operator|->
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|http_chunked_trickle_cb
argument_list|,
name|state
argument_list|,
operator|&
name|when
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|evhttp_send_reply_end
argument_list|(
name|state
operator|->
name|req
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|state
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|http_chunked_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|timeval
name|when
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|struct
name|chunk_req_state
modifier|*
name|state
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|chunk_req_state
argument_list|)
argument_list|)
decl_stmt|;
name|event_debug
argument_list|(
operator|(
literal|"%s: called\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|state
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|chunk_req_state
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|->
name|req
operator|=
name|req
expr_stmt|;
name|state
operator|->
name|base
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|evhttp_request_get_uri
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"/streamed"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Length"
argument_list|,
literal|"39"
argument_list|)
expr_stmt|;
block|}
comment|/* generate a chunked/streamed reply */
name|evhttp_send_reply_start
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"Everything is fine"
argument_list|)
expr_stmt|;
comment|/* but trickle it across several iterations to ensure we're not 	 * assuming it comes all at once */
name|event_base_once
argument_list|(
name|arg
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|http_chunked_trickle_cb
argument_list|,
name|state
argument_list|,
operator|&
name|when
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_complete_write
parameter_list|(
name|evutil_socket_t
name|fd
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bufferevent
modifier|*
name|bev
init|=
name|arg
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
init|=
literal|"host\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
decl_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_basic_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
decl_stmt|;
name|evutil_socket_t
name|fd
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|,
name|port2
init|=
literal|0
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* bind to a second socket */
if|if
condition|(
name|http_bind
argument_list|(
name|http
argument_list|,
operator|&
name|port2
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED (bind)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* first half of the http request */
name|http_request
operator|=
literal|"GET /test HTTP/1.1\r\n"
literal|"Host: some"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|evutil_timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|10000
expr_stmt|;
name|event_base_once
argument_list|(
name|data
operator|->
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|http_complete_write
argument_list|,
name|bev
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|test_ok
operator|==
literal|3
argument_list|)
expr_stmt|;
comment|/* connect to the second port */
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port2
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"GET /test HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|test_ok
operator|==
literal|5
argument_list|)
expr_stmt|;
comment|/* Connect to the second port again. This time, send an absolute uri. */
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port2
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"GET http://somehost.net/test HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|test_ok
operator|==
literal|7
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|end
label|:
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_delay_reply
parameter_list|(
name|evutil_socket_t
name|fd
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|arg
decl_stmt|;
name|evhttp_send_reply
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"Everything is fine"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|++
name|test_ok
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_delay_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|evutil_timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|200
operator|*
literal|1000
expr_stmt|;
name|event_base_once
argument_list|(
name|arg
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|http_delay_reply
argument_list|,
name|req
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_badreq_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evbuffer
modifier|*
name|buf
init|=
name|evbuffer_new
argument_list|()
decl_stmt|;
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Type"
argument_list|,
literal|"text/xml; charset=UTF-8"
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|buf
argument_list|,
literal|"Hello, %s!"
argument_list|,
literal|"127.0.0.1"
argument_list|)
expr_stmt|;
name|evhttp_send_reply
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"OK"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|evbuffer_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_badreq_errorcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|event_debug
argument_list|(
operator|(
literal|"%s: called (what=%04x, arg=%p)"
operator|,
name|__func__
operator|,
name|what
operator|,
name|arg
operator|)
argument_list|)
expr_stmt|;
comment|/* ignore */
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|SHUT_WR
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|_WIN32
end_ifdef

begin_define
define|#
directive|define
name|SHUT_WR
value|SD_SEND
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|SHUT_WR
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|http_badreq_readcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|what
init|=
literal|"Hello, 127.0.0.1"
decl_stmt|;
specifier|const
name|char
modifier|*
name|bad_request
init|=
literal|"400 Bad Request"
decl_stmt|;
if|if
condition|(
name|evbuffer_contains
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|bad_request
argument_list|)
condition|)
block|{
name|TT_FAIL
argument_list|(
operator|(
literal|"%s:bad request detected"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|bufferevent_disable
argument_list|(
name|bev
argument_list|,
name|EV_READ
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|evbuffer_contains
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|what
argument_list|)
condition|)
block|{
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|evhttp_request_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|enum
name|message_read_status
name|done
decl_stmt|;
comment|/* req->kind = EVHTTP_RESPONSE; */
name|done
operator|=
name|evhttp_parse_firstline_
argument_list|(
name|req
argument_list|,
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|done
operator|!=
name|ALL_DATA_READ
condition|)
goto|goto
name|out
goto|;
name|done
operator|=
name|evhttp_parse_headers_
argument_list|(
name|req
argument_list|,
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|done
operator|!=
name|ALL_DATA_READ
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|done
operator|==
literal|1
operator|&&
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Type"
argument_list|)
operator|!=
name|NULL
condition|)
name|test_ok
operator|++
expr_stmt|;
name|out
label|:
name|evhttp_request_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|evbuffer_drain
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|evbuffer_get_length
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|shutdown
argument_list|(
name|bufferevent_getfd
argument_list|(
name|bev
argument_list|)
argument_list|,
name|SHUT_WR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_badreq_successcb
parameter_list|(
name|evutil_socket_t
name|fd
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|event_debug
argument_list|(
operator|(
literal|"%s: called (what=%04x, arg=%p)"
operator|,
name|__func__
operator|,
name|what
operator|,
name|arg
operator|)
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|exit_base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_bad_request_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
init|=
name|NULL
decl_stmt|;
name|evutil_socket_t
name|fd
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|,
name|port2
init|=
literal|0
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* bind to a second socket */
if|if
condition|(
name|http_bind
argument_list|(
name|http
argument_list|,
operator|&
name|port2
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|TT_DIE
argument_list|(
operator|(
literal|"Bind socket failed"
operator|)
argument_list|)
expr_stmt|;
comment|/* NULL request test */
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd
argument_list|,
operator|>=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_badreq_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_badreq_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|bufferevent_enable
argument_list|(
name|bev
argument_list|,
name|EV_READ
argument_list|)
expr_stmt|;
comment|/* real NULL request */
name|http_request
operator|=
literal|""
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|shutdown
argument_list|(
name|fd
argument_list|,
name|SHUT_WR
argument_list|)
expr_stmt|;
name|timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|10000
expr_stmt|;
name|event_base_once
argument_list|(
name|data
operator|->
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|http_badreq_successcb
argument_list|,
name|bev
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_ok
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Second answer (BAD REQUEST) on connection close */
comment|/* connect to the second port */
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port2
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_badreq_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_badreq_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|bufferevent_enable
argument_list|(
name|bev
argument_list|,
name|EV_READ
argument_list|)
expr_stmt|;
comment|/* first half of the http request */
name|http_request
operator|=
literal|"GET /badrequest HTTP/1.0\r\n"
expr|\
literal|"Connection: Keep-Alive\r\n"
expr|\
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|10000
expr_stmt|;
name|event_base_once
argument_list|(
name|data
operator|->
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|http_badreq_successcb
argument_list|,
name|bev
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|end
label|:
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
if|if
condition|(
name|bev
condition|)
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|evhttp_connection
modifier|*
name|delayed_client
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|http_large_delay_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|evutil_timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|500000
expr_stmt|;
name|event_base_once
argument_list|(
name|arg
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|http_delay_reply
argument_list|,
name|req
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
name|evhttp_connection_fail_
argument_list|(
name|delayed_client
argument_list|,
name|EVREQ_HTTP_EOF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * HTTP DELETE test,  just piggyback on the basic test  */
end_comment

begin_function
specifier|static
name|void
name|http_delete_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evbuffer
modifier|*
name|evb
init|=
name|evbuffer_new
argument_list|()
decl_stmt|;
name|int
name|empty
init|=
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Empty"
argument_list|)
operator|!=
name|NULL
decl_stmt|;
comment|/* Expecting a DELETE request */
if|if
condition|(
name|evhttp_request_get_command
argument_list|(
name|req
argument_list|)
operator|!=
name|EVHTTP_REQ_DELETE
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED (delete type)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|event_debug
argument_list|(
operator|(
literal|"%s: called\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evb
argument_list|,
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* allow sending of an empty reply */
name|evhttp_send_reply
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"Everything is fine"
argument_list|,
operator|!
name|empty
condition|?
name|evb
else|:
name|NULL
argument_list|)
expr_stmt|;
name|evbuffer_free
argument_list|(
name|evb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_delete_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
decl_stmt|;
name|evutil_socket_t
name|fd
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd
argument_list|,
operator|>=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"DELETE /deleteit HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_sent_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|ev_uintptr_t
name|val
init|=
operator|(
name|ev_uintptr_t
operator|)
name|arg
decl_stmt|;
name|struct
name|evbuffer
modifier|*
name|b
decl_stmt|;
if|if
condition|(
name|val
operator|!=
literal|0xDEADBEEF
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED on_complete_cb argument\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|b
operator|=
name|evhttp_request_get_output_buffer
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|b
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED on_complete_cb output buffer not written\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|event_debug
argument_list|(
operator|(
literal|"%s: called\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
operator|++
name|test_ok
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_on_complete_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evbuffer
modifier|*
name|evb
init|=
name|evbuffer_new
argument_list|()
decl_stmt|;
name|evhttp_request_set_on_complete_cb
argument_list|(
name|req
argument_list|,
name|http_sent_cb
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|0xDEADBEEF
argument_list|)
expr_stmt|;
name|event_debug
argument_list|(
operator|(
literal|"%s: called\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evb
argument_list|,
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* allow sending of an empty reply */
name|evhttp_send_reply
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"Everything is fine"
argument_list|,
name|evb
argument_list|)
expr_stmt|;
name|evbuffer_free
argument_list|(
name|evb
argument_list|)
expr_stmt|;
operator|++
name|test_ok
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_on_complete_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
decl_stmt|;
name|evutil_socket_t
name|fd
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd
argument_list|,
operator|>=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"GET /oncomplete HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_allowed_methods_eventcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|output
init|=
name|arg
decl_stmt|;
if|if
condition|(
operator|(
name|what
operator|&
operator|(
name|BEV_EVENT_ERROR
operator||
name|BEV_EVENT_EOF
operator|)
operator|)
condition|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
name|n
operator|=
name|evbuffer_remove
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
literal|0
condition|)
block|{
name|buf
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|output
condition|)
name|free
argument_list|(
operator|*
name|output
argument_list|)
expr_stmt|;
operator|*
name|output
operator|=
name|strdup
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
name|event_base_loopexit
argument_list|(
name|exit_base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|http_allowed_methods_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev1
decl_stmt|,
modifier|*
name|bev2
decl_stmt|,
modifier|*
name|bev3
decl_stmt|;
name|evutil_socket_t
name|fd1
init|=
operator|-
literal|1
decl_stmt|,
name|fd2
init|=
operator|-
literal|1
decl_stmt|,
name|fd3
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|char
modifier|*
name|result1
init|=
name|NULL
decl_stmt|,
modifier|*
name|result2
init|=
name|NULL
decl_stmt|,
modifier|*
name|result3
init|=
name|NULL
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fd1
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd1
argument_list|,
operator|>=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* GET is out; PATCH is in. */
name|evhttp_set_allowed_methods
argument_list|(
name|http
argument_list|,
name|EVHTTP_REQ_PATCH
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev1
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_enable
argument_list|(
name|bev1
argument_list|,
name|EV_READ
operator||
name|EV_WRITE
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|http_allowed_methods_eventcb
argument_list|,
operator|&
name|result1
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"GET /index.html HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev1
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|fd2
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd2
argument_list|,
operator|>=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bev2
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_enable
argument_list|(
name|bev2
argument_list|,
name|EV_READ
operator||
name|EV_WRITE
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev2
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|http_allowed_methods_eventcb
argument_list|,
operator|&
name|result2
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"PATCH /test HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev2
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|fd3
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd3
argument_list|,
operator|>=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bev3
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_enable
argument_list|(
name|bev3
argument_list|,
name|EV_READ
operator||
name|EV_WRITE
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev3
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|http_allowed_methods_eventcb
argument_list|,
operator|&
name|result3
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"FLOOP /test HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev3
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev1
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev2
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev3
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
comment|/* Method known but disallowed */
name|tt_assert
argument_list|(
name|result1
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
operator|!
name|strncmp
argument_list|(
name|result1
argument_list|,
literal|"HTTP/1.1 501 "
argument_list|,
name|strlen
argument_list|(
literal|"HTTP/1.1 501 "
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Method known and allowed */
name|tt_assert
argument_list|(
name|result2
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
operator|!
name|strncmp
argument_list|(
name|result2
argument_list|,
literal|"HTTP/1.1 200 "
argument_list|,
name|strlen
argument_list|(
literal|"HTTP/1.1 200 "
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Method unknown */
name|tt_assert
argument_list|(
name|result3
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
operator|!
name|strncmp
argument_list|(
name|result3
argument_list|,
literal|"HTTP/1.1 501 "
argument_list|,
name|strlen
argument_list|(
literal|"HTTP/1.1 501 "
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|result1
condition|)
name|free
argument_list|(
name|result1
argument_list|)
expr_stmt|;
if|if
condition|(
name|result2
condition|)
name|free
argument_list|(
name|result2
argument_list|)
expr_stmt|;
if|if
condition|(
name|result3
condition|)
name|free
argument_list|(
name|result3
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd1
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd2
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd2
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd3
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd3
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|http_request_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|http_request_empty_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|http_connection_test_
parameter_list|(
name|struct
name|basic_test_data
modifier|*
name|data
parameter_list|,
name|int
name|persistent
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
name|struct
name|evdns_base
modifier|*
name|dnsbase
parameter_list|,
name|int
name|ipv6
parameter_list|)
block|{
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
name|ipv6
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|dnsbase
argument_list|,
name|address
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evhttp_connection_get_base
argument_list|(
name|evcon
argument_list|)
operator|==
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|tt_assert
argument_list|(
name|evhttp_connection_get_server
argument_list|(
name|evcon
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule a request to the HTTP 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|test_ok
argument_list|)
expr_stmt|;
comment|/* try to make another request over the same connection */
name|test_ok
operator|=
literal|0
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* 	 * if our connections are not supposed to be persistent; request 	 * a close from the server. 	 */
if|if
condition|(
operator|!
name|persistent
condition|)
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Connection"
argument_list|,
literal|"close"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* make another request: request empty reply */
name|test_ok
operator|=
literal|0
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_empty_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Empty"
argument_list|,
literal|"itis"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_connection_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|http_connection_test_
argument_list|(
name|arg
argument_list|,
literal|0
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_persist_connection_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|http_connection_test_
argument_list|(
name|arg
argument_list|,
literal|1
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|regress_dns_server_table
name|search_table
index|[]
init|=
block|{
block|{
literal|"localhost"
block|,
literal|"A"
block|,
literal|"127.0.0.1"
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|http_connection_async_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|struct
name|evdns_base
modifier|*
name|dns_base
init|=
name|NULL
decl_stmt|;
name|ev_uint16_t
name|portnum
init|=
literal|0
decl_stmt|;
name|char
name|address
index|[
literal|64
index|]
decl_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|tt_assert
argument_list|(
name|regress_dnsserver
argument_list|(
name|data
operator|->
name|base
argument_list|,
operator|&
name|portnum
argument_list|,
name|search_table
argument_list|)
argument_list|)
expr_stmt|;
name|dns_base
operator|=
name|evdns_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
literal|0
comment|/* init name servers */
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|dns_base
argument_list|)
expr_stmt|;
comment|/* Add ourself as the only nameserver, and make sure we really are 	 * the only nameserver. */
name|evutil_snprintf
argument_list|(
name|address
argument_list|,
sizeof|sizeof
argument_list|(
name|address
argument_list|)
argument_list|,
literal|"127.0.0.1:%d"
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|evdns_base_nameserver_ip_add
argument_list|(
name|dns_base
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|dns_base
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule a request to the HTTP 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|test_ok
argument_list|)
expr_stmt|;
comment|/* try to make another request over the same connection */
name|test_ok
operator|=
literal|0
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* 	 * if our connections are not supposed to be persistent; request 	 * a close from the server. 	 */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Connection"
argument_list|,
literal|"close"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* make another request: request empty reply */
name|test_ok
operator|=
literal|0
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_empty_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Empty"
argument_list|,
literal|"itis"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
if|if
condition|(
name|dns_base
condition|)
name|evdns_base_free
argument_list|(
name|dns_base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regress_clean_dnsserver
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_request_never_call
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_do_cancel
parameter_list|(
name|evutil_socket_t
name|fd
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|arg
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|event_base
modifier|*
name|base
decl_stmt|;
name|evutil_timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|500
operator|*
literal|1000
expr_stmt|;
name|base
operator|=
name|evhttp_connection_get_base
argument_list|(
name|evhttp_request_get_connection
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|evhttp_cancel_request
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|base
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
operator|++
name|test_ok
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_cancel_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule a request to the HTTP 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_never_call
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|evhttp_request_set_error_cb
argument_list|(
name|req
argument_list|,
name|http_request_error_cb_with_cancel_
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
name|tt_int_op
argument_list|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/delay"
argument_list|)
argument_list|,
operator|!=
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|evutil_timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|100
operator|*
literal|1000
expr_stmt|;
name|event_base_once
argument_list|(
name|data
operator|->
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|http_do_cancel
argument_list|,
name|req
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* try to make another request over the same connection */
name|test_ok
operator|=
literal|0
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
name|tt_int_op
argument_list|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
argument_list|,
operator|!=
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* make another request: request empty reply */
name|test_ok
operator|=
literal|0
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_empty_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Empty"
argument_list|,
literal|"itis"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
name|tt_int_op
argument_list|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
argument_list|,
operator|!=
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_request_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|what
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|!=
name|HTTP_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Type"
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
operator|!=
name|strlen
argument_list|(
name|what
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_datacmp
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
name|what
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|test_ok
operator|=
literal|1
expr_stmt|;
name|EVUTIL_ASSERT
argument_list|(
name|exit_base
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|exit_base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_request_expect_error
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|==
name|HTTP_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|test_ok
operator|=
literal|1
expr_stmt|;
name|EVUTIL_ASSERT
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* test virtual hosts */
end_comment

begin_function
specifier|static
name|void
name|http_virtual_host_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp
modifier|*
name|second
init|=
name|NULL
decl_stmt|,
modifier|*
name|third
init|=
name|NULL
decl_stmt|;
name|evutil_socket_t
name|fd
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* virtual host */
name|second
operator|=
name|evhttp_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|second
argument_list|,
literal|"/funnybunny"
argument_list|,
name|http_basic_cb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|third
operator|=
name|evhttp_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|evhttp_set_cb
argument_list|(
name|third
argument_list|,
literal|"/blackcoffee"
argument_list|,
name|http_basic_cb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_add_virtual_host
argument_list|(
name|http
argument_list|,
literal|"foo.com"
argument_list|,
name|second
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't add vhost"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_add_virtual_host
argument_list|(
name|http
argument_list|,
literal|"bar.*.foo.com"
argument_list|,
name|third
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't add wildcarded vhost"
argument_list|)
expr_stmt|;
block|}
comment|/* add some aliases to the vhosts */
name|tt_assert
argument_list|(
name|evhttp_add_server_alias
argument_list|(
name|second
argument_list|,
literal|"manolito.info"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evhttp_add_server_alias
argument_list|(
name|third
argument_list|,
literal|"bonkers.org"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* make a request with a different host and expect an error */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_expect_error
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/funnybunny"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|test_ok
operator|==
literal|1
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
comment|/* make a request with the right host and expect a response */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"foo.com"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/funnybunny"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|test_ok
operator|==
literal|1
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
comment|/* make a request with the right host and expect a response */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"bar.magic.foo.com"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/blackcoffee"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
argument|test_ok ==
literal|1
argument_list|)
name|test_ok
operator|=
literal|0
expr_stmt|;
comment|/* make a request with the right host and expect a response */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"manolito.info"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/funnybunny"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
argument|test_ok ==
literal|1
argument_list|)
name|test_ok
operator|=
literal|0
expr_stmt|;
comment|/* make a request with the right host and expect a response */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* Add the Host header. This time with the optional port. */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"bonkers.org:8000"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/blackcoffee"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
argument|test_ok ==
literal|1
argument_list|)
name|test_ok
operator|=
literal|0
expr_stmt|;
comment|/* Now make a raw request with an absolute URI. */
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* The host in the URI should override the Host: header */
name|http_request
operator|=
literal|"GET http://manolito.info/funnybunny HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* test date header and content length */
end_comment

begin_function
specifier|static
name|void
name|http_request_empty_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|!=
name|HTTP_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Date"
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Length"
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Length"
argument_list|)
argument_list|,
literal|"0"
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|test_ok
operator|=
literal|1
expr_stmt|;
name|EVUTIL_ASSERT
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * HTTP DISPATCHER test  */
end_comment

begin_function
name|void
name|http_dispatcher_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evbuffer
modifier|*
name|evb
init|=
name|evbuffer_new
argument_list|()
decl_stmt|;
name|event_debug
argument_list|(
operator|(
literal|"%s: called\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evb
argument_list|,
literal|"DISPATCHER_TEST"
argument_list|)
expr_stmt|;
name|evhttp_send_reply
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"Everything is fine"
argument_list|,
name|evb
argument_list|)
expr_stmt|;
name|evbuffer_free
argument_list|(
name|evb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_dispatcher_test_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|event_base
modifier|*
name|base
init|=
name|arg
decl_stmt|;
specifier|const
name|char
modifier|*
name|what
init|=
literal|"DISPATCHER_TEST"
decl_stmt|;
if|if
condition|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|!=
name|HTTP_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Type"
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (content type)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
operator|!=
name|strlen
argument_list|(
name|what
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (length %lu vs %lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|strlen
argument_list|(
name|what
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_datacmp
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
name|what
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (data)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|test_ok
operator|=
literal|1
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_dispatcher_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* also bind to local host */
name|evhttp_connection_set_local_address
argument_list|(
name|evcon
argument_list|,
literal|"127.0.0.1"
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule an HTTP GET request 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_dispatcher_test_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/?arg=val"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * HTTP POST test.  */
end_comment

begin_function_decl
name|void
name|http_postrequest_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|POST_DATA
value|"Okay.  Not really printf"
end_define

begin_function
specifier|static
name|void
name|http_post_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule an HTTP POST request 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_postrequest_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evhttp_request_get_output_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
name|POST_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_POST
argument_list|,
literal|"/postit"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_postrequest_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
comment|/* Now try with 100-continue. */
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Expect"
argument_list|,
literal|"100-continue"
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evhttp_request_get_output_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
name|POST_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_POST
argument_list|,
literal|"/postit"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|end
label|:
empty_stmt|;
block|}
end_function

begin_function
name|void
name|http_post_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evbuffer
modifier|*
name|evb
decl_stmt|;
name|event_debug
argument_list|(
operator|(
literal|"%s: called\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
comment|/* Yes, we are expecting a post request */
if|if
condition|(
name|evhttp_request_get_command
argument_list|(
name|req
argument_list|)
operator|!=
name|EVHTTP_REQ_POST
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED (post type)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
operator|!=
name|strlen
argument_list|(
name|POST_DATA
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED (length: %lu vs %lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|strlen
argument_list|(
name|POST_DATA
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_datacmp
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
name|POST_DATA
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED (data)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Got :%s\n"
argument_list|,
name|evbuffer_pullup
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Want:%s\n"
argument_list|,
name|POST_DATA
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|evb
operator|=
name|evbuffer_new
argument_list|()
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evb
argument_list|,
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
name|evhttp_send_reply
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"Everything is fine"
argument_list|,
name|evb
argument_list|)
expr_stmt|;
name|evbuffer_free
argument_list|(
name|evb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|http_postrequest_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|what
init|=
name|BASIC_REQUEST_BODY
decl_stmt|;
name|struct
name|event_base
modifier|*
name|base
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (timeout)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|!=
name|HTTP_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (response code)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Type"
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (content type)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
operator|!=
name|strlen
argument_list|(
name|what
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (length %lu vs %lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|strlen
argument_list|(
name|what
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_datacmp
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
name|what
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (data)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|test_ok
operator|=
literal|1
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * HTTP PUT test, basically just like POST, but ...  */
end_comment

begin_function_decl
name|void
name|http_putrequest_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|PUT_DATA
value|"Hi, I'm some PUT data"
end_define

begin_function
specifier|static
name|void
name|http_put_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* 	 * Schedule the HTTP PUT request 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_putrequest_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"someotherhost"
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evhttp_request_get_output_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
name|PUT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_PUT
argument_list|,
literal|"/putit"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|end
label|:
empty_stmt|;
block|}
end_function

begin_function
name|void
name|http_put_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evbuffer
modifier|*
name|evb
decl_stmt|;
name|event_debug
argument_list|(
operator|(
literal|"%s: called\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
comment|/* Expecting a PUT request */
if|if
condition|(
name|evhttp_request_get_command
argument_list|(
name|req
argument_list|)
operator|!=
name|EVHTTP_REQ_PUT
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED (put type)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
operator|!=
name|strlen
argument_list|(
name|PUT_DATA
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED (length: %lu vs %lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|strlen
argument_list|(
name|PUT_DATA
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_datacmp
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
name|PUT_DATA
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"FAILED (data)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Got :%s\n"
argument_list|,
name|evbuffer_pullup
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Want:%s\n"
argument_list|,
name|PUT_DATA
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|evb
operator|=
name|evbuffer_new
argument_list|()
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evb
argument_list|,
literal|"That ain't funny"
argument_list|)
expr_stmt|;
name|evhttp_send_reply
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"Everything is great"
argument_list|,
name|evb
argument_list|)
expr_stmt|;
name|evbuffer_free
argument_list|(
name|evb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|http_putrequest_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|event_base
modifier|*
name|base
init|=
name|arg
decl_stmt|;
specifier|const
name|char
modifier|*
name|what
init|=
literal|"That ain't funny"
decl_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (timeout)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|!=
name|HTTP_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (response code)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Type"
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (content type)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
operator|!=
name|strlen
argument_list|(
name|what
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (length %lu vs %lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|strlen
argument_list|(
name|what
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_datacmp
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
name|what
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED (data)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|test_ok
operator|=
literal|1
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_failure_readcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|what
init|=
literal|"400 Bad Request"
decl_stmt|;
if|if
condition|(
name|evbuffer_contains
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|what
argument_list|)
condition|)
block|{
name|test_ok
operator|=
literal|2
expr_stmt|;
name|bufferevent_disable
argument_list|(
name|bev
argument_list|,
name|EV_READ
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Testing that the HTTP server can deal with a malformed request.  */
end_comment

begin_function
specifier|static
name|void
name|http_failure_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
decl_stmt|;
name|evutil_socket_t
name|fd
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd
argument_list|,
operator|>=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_failure_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"illegal request\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|close_detect_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|==
name|HTTP_OK
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|1
expr_stmt|;
name|end
label|:
name|evutil_timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|150000
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|close_detect_launch
parameter_list|(
name|evutil_socket_t
name|fd
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|arg
decl_stmt|;
name|struct
name|event_base
modifier|*
name|base
init|=
name|evhttp_connection_get_base
argument_list|(
name|evcon
argument_list|)
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
decl_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|close_detect_done
argument_list|,
name|base
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_fail_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|close_detect_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|arg
decl_stmt|;
name|struct
name|event_base
modifier|*
name|base
init|=
name|evhttp_connection_get_base
argument_list|(
name|evcon
argument_list|)
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
if|if
condition|(
name|req
operator|!=
name|NULL
operator|&&
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|!=
name|HTTP_OK
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Failed"
argument_list|)
expr_stmt|;
block|}
name|evutil_timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
comment|/* longer than the http time out */
name|tv
operator|.
name|tv_usec
operator|=
literal|600000
expr_stmt|;
comment|/* longer than the http time out */
comment|/* launch a new request on the persistent connection in .3 seconds */
name|event_base_once
argument_list|(
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|close_detect_launch
argument_list|,
name|evcon
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
name|end
label|:
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_close_detection_
parameter_list|(
name|struct
name|basic_test_data
modifier|*
name|data
parameter_list|,
name|int
name|with_delay
parameter_list|)
block|{
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
specifier|const
name|struct
name|timeval
name|sec_tenth
init|=
block|{
literal|0
block|,
literal|100000
block|}
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* .1 second timeout */
name|evhttp_set_timeout_tv
argument_list|(
name|http
argument_list|,
operator|&
name|sec_tenth
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|evhttp_connection_set_timeout_tv
argument_list|(
name|evcon
argument_list|,
operator|&
name|sec_tenth
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|delayed_client
operator|=
name|evcon
expr_stmt|;
comment|/* 	 * At this point, we want to schedule a request to the HTTP 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|close_detect_cb
argument_list|,
name|evcon
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
name|with_delay
condition|?
literal|"/largedelay"
else|:
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* at this point, the http server should have no connection */
name|tt_assert
argument_list|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|http
operator|->
name|connections
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_close_detection_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|http_close_detection_
argument_list|(
name|arg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_close_detection_delay_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|http_close_detection_
argument_list|(
name|arg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_highport_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|int
name|i
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|evhttp
modifier|*
name|myhttp
init|=
name|NULL
decl_stmt|;
comment|/* Try a few different ports */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|50
condition|;
operator|++
name|i
control|)
block|{
name|myhttp
operator|=
name|evhttp_new
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_bind_socket
argument_list|(
name|myhttp
argument_list|,
literal|"127.0.0.1"
argument_list|,
literal|65535
operator|-
name|i
argument_list|)
operator|==
literal|0
condition|)
block|{
name|test_ok
operator|=
literal|1
expr_stmt|;
name|evhttp_free
argument_list|(
name|myhttp
argument_list|)
expr_stmt|;
return|return;
block|}
name|evhttp_free
argument_list|(
name|myhttp
argument_list|)
expr_stmt|;
block|}
name|tt_fail_msg
argument_list|(
literal|"Couldn't get a high port"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_bad_header_test
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|struct
name|evkeyvalq
name|headers
decl_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_add_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"One"
argument_list|,
literal|"Two"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_add_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"One"
argument_list|,
literal|"Two\r\n Three"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_add_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"One\r"
argument_list|,
literal|"Two"
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_add_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"One\n"
argument_list|,
literal|"Two"
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_add_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"One"
argument_list|,
literal|"Two\r"
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_add_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"One"
argument_list|,
literal|"Two\n"
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|validate_header
parameter_list|(
specifier|const
name|struct
name|evkeyvalq
modifier|*
name|headers
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|real_val
init|=
name|evhttp_find_header
argument_list|(
name|headers
argument_list|,
name|key
argument_list|)
decl_stmt|;
name|tt_assert
argument_list|(
name|real_val
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|real_val
argument_list|,
name|value
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|end
label|:
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_parse_query_test
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|struct
name|evkeyvalq
name|headers
decl_stmt|;
name|int
name|r
decl_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=test"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q"
argument_list|,
literal|"test"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=test&foo=bar"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q"
argument_list|,
literal|"test"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"foo"
argument_list|,
literal|"bar"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=test+foo"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q"
argument_list|,
literal|"test foo"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=test%0Afoo"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q"
argument_list|,
literal|"test\nfoo"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=test%0Dfoo"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q"
argument_list|,
literal|"test\rfoo"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=test&&q2"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=test+this"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q"
argument_list|,
literal|"test this"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=test&q2=foo"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q"
argument_list|,
literal|"test"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q2"
argument_list|,
literal|"foo"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q&q2=foo"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=foo&q2"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=foo&q2&q3=x"
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|r
operator|=
name|evhttp_parse_query
argument_list|(
literal|"http://www.test.com/?q=&q2=&q3="
argument_list|,
operator|&
name|headers
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|r
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q"
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q2"
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|validate_header
argument_list|(
operator|&
name|headers
argument_list|,
literal|"q3"
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
name|end
label|:
name|evhttp_clear_headers
argument_list|(
operator|&
name|headers
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_parse_uri_test
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
specifier|const
name|int
name|nonconform
init|=
operator|(
name|ptr
operator|!=
name|NULL
operator|)
decl_stmt|;
specifier|const
name|unsigned
name|parse_flags
init|=
name|nonconform
condition|?
name|EVHTTP_URI_NONCONFORMANT
else|:
literal|0
decl_stmt|;
name|struct
name|evhttp_uri
modifier|*
name|uri
init|=
name|NULL
decl_stmt|;
name|char
name|url_tmp
index|[
literal|4096
index|]
decl_stmt|;
define|#
directive|define
name|URI_PARSE
parameter_list|(
name|uri
parameter_list|)
define|\
value|evhttp_uri_parse_with_flags((uri), parse_flags)
define|#
directive|define
name|TT_URI
parameter_list|(
name|want
parameter_list|)
value|do { 						\ 	char *ret = evhttp_uri_join(uri, url_tmp, sizeof(url_tmp));	\ 	tt_want(ret != NULL);						\ 	tt_want(ret == url_tmp);					\ 	if (strcmp(ret,want) != 0)					\ 		TT_FAIL(("\"%s\" != \"%s\"",ret,want));			\ 	} while(0)
name|tt_want
argument_list|(
name|evhttp_uri_join
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_join
argument_list|(
name|NULL
argument_list|,
name|url_tmp
argument_list|,
literal|0
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_join
argument_list|(
name|NULL
argument_list|,
name|url_tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|url_tmp
argument_list|)
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* bad URIs: parsing */
define|#
directive|define
name|BAD
parameter_list|(
name|s
parameter_list|)
value|do {							\ 		if (URI_PARSE(s) != NULL)				\ 			TT_FAIL(("Expected error parsing \"%s\"",s));	\ 	} while(0)
comment|/* Nonconformant URIs we can parse: parsing */
define|#
directive|define
name|NCF
parameter_list|(
name|s
parameter_list|)
value|do {							\ 		uri = URI_PARSE(s);					\ 		if (uri != NULL&& !nonconform) {			\ 			TT_FAIL(("Expected error parsing \"%s\"",s));	\ 		} else if (uri == NULL&& nonconform) {			\ 			TT_FAIL(("Couldn't parse nonconformant URI \"%s\"", \ 				s));					\ 		}							\ 		if (uri) {						\ 			tt_want(evhttp_uri_join(uri, url_tmp,		\ 				sizeof(url_tmp)));			\ 			evhttp_uri_free(uri);				\ 		}							\ 	} while(0)
name|NCF
argument_list|(
literal|"http://www.test.com/ why hello"
argument_list|)
expr_stmt|;
name|NCF
argument_list|(
literal|"http://www.test.com/why-hello\x01"
argument_list|)
expr_stmt|;
name|NCF
argument_list|(
literal|"http://www.test.com/why-hello?\x01"
argument_list|)
expr_stmt|;
name|NCF
argument_list|(
literal|"http://www.test.com/why-hello#\x01"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://www.\x01.test.com/why-hello"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://www.%7test.com/why-hello"
argument_list|)
expr_stmt|;
name|NCF
argument_list|(
literal|"http://www.test.com/why-hell%7o"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"h%3ttp://www.test.com/why-hello"
argument_list|)
expr_stmt|;
name|NCF
argument_list|(
literal|"http://www.test.com/why-hello%7"
argument_list|)
expr_stmt|;
name|NCF
argument_list|(
literal|"http://www.test.com/why-hell%7o"
argument_list|)
expr_stmt|;
name|NCF
argument_list|(
literal|"http://www.test.com/foo?ba%r"
argument_list|)
expr_stmt|;
name|NCF
argument_list|(
literal|"http://www.test.com/foo#ba%r"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"99:99/foo"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://www.test.com:999x/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://www.test.com:x/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[hello-there]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[::1]]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[::1/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[foob/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[ffff:ffff:ffff:ffff:Ffff:ffff:ffff:"
literal|"ffff:ffff:ffff:ffff:ffff:ffff:ffff]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[vX.foo]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[vX.foo]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[v.foo]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[v5.fo%o]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[v5X]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[v5]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://[]/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://f\x01red@www.example.com/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://f%0red@www.example.com/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://www.example.com:9999999999999999999999999999999999999/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"http://www.example.com:hihi/"
argument_list|)
expr_stmt|;
name|BAD
argument_list|(
literal|"://www.example.com/"
argument_list|)
expr_stmt|;
comment|/* bad URIs: joining */
name|uri
operator|=
name|evhttp_uri_new
argument_list|()
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
literal|"www.example.com"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_join
argument_list|(
name|uri
argument_list|,
name|url_tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|url_tmp
argument_list|)
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* not enough space: */
name|tt_want
argument_list|(
name|evhttp_uri_join
argument_list|(
name|uri
argument_list|,
name|url_tmp
argument_list|,
literal|3
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* host is set, but path doesn't start with "/": */
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_path
argument_list|(
name|uri
argument_list|,
literal|"hi_mom"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_join
argument_list|(
name|uri
argument_list|,
name|url_tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|url_tmp
argument_list|)
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_join
argument_list|(
name|uri
argument_list|,
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
name|url_tmp
argument_list|)
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_join
argument_list|(
name|uri
argument_list|,
name|url_tmp
argument_list|,
literal|0
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"mailto:foo@bar"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|uri
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|!
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"mailto"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|!
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"foo@bar"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"mailto:foo@bar"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|evhttp_uri_new
argument_list|()
expr_stmt|;
comment|/* Bad URI usage: setting invalid values */
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_scheme
argument_list|(
name|uri
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_scheme
argument_list|(
name|uri
argument_list|,
literal|"33"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_scheme
argument_list|(
name|uri
argument_list|,
literal|"hi!"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_userinfo
argument_list|(
name|uri
argument_list|,
literal|"hello@"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
literal|"[1.2.3.4]"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
literal|"["
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
literal|"www.[foo].com"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_port
argument_list|(
name|uri
argument_list|,
operator|-
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_path
argument_list|(
name|uri
argument_list|,
literal|"hello?world"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_query
argument_list|(
name|uri
argument_list|,
literal|"hello#world"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
operator|-
literal|1
operator|==
name|evhttp_uri_set_fragment
argument_list|(
name|uri
argument_list|,
literal|"hello#world"
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Valid URI usage: setting valid values */
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_scheme
argument_list|(
name|uri
argument_list|,
literal|"http"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_scheme
argument_list|(
name|uri
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_userinfo
argument_list|(
name|uri
argument_list|,
literal|"username:pass"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_userinfo
argument_list|(
name|uri
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
literal|"www.example.com"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
literal|"1.2.3.4"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
literal|"[1:2:3:4::]"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
literal|"[v7.wobblewobble]"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_host
argument_list|(
name|uri
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_port
argument_list|(
name|uri
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_port
argument_list|(
name|uri
argument_list|,
literal|80
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_port
argument_list|(
name|uri
argument_list|,
literal|65535
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_path
argument_list|(
name|uri
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_path
argument_list|(
name|uri
argument_list|,
literal|"/documents/public/index.html"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_path
argument_list|(
name|uri
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_query
argument_list|(
name|uri
argument_list|,
literal|"key=val&key2=val2"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_query
argument_list|(
name|uri
argument_list|,
literal|"keyvalblarg"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_query
argument_list|(
name|uri
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_query
argument_list|(
name|uri
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_fragment
argument_list|(
name|uri
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_fragment
argument_list|(
name|uri
argument_list|,
literal|"here?i?am"
argument_list|)
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
literal|0
operator|==
name|evhttp_uri_set_fragment
argument_list|(
name|uri
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
comment|/* Valid parsing */
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"http://www.test.com/?q=t%33est"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"http"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"www.test.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"q=t%33est"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"http://www.test.com/?q=t%33est"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"http://%77ww.test.com"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"http"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"%77ww.test.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"http://%77ww.test.com"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"http://www.test.com?q=test"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"http"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"www.test.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"q=test"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"http://www.test.com?q=test"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"http://www.test.com#fragment"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"http"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"www.test.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want_str_op
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
argument_list|,
operator|==
argument_list|,
literal|"fragment"
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"http://www.test.com#fragment"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"http://8000/"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"http"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"8000"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"http://8000/"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"http://:8000/"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"http"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
literal|8000
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"http://:8000/"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"http://www.test.com:/"
argument_list|)
expr_stmt|;
comment|/* empty port */
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"http"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"www.test.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want_str_op
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
operator|==
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"http://www.test.com/"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"http://www.test.com:"
argument_list|)
expr_stmt|;
comment|/* empty port 2 */
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"http"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"www.test.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"http://www.test.com"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"ftp://www.test.com/?q=test"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"ftp"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"www.test.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"q=test"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"ftp://www.test.com/?q=test"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"ftp://[::1]:999/?q=test"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"ftp"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"[::1]"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"q=test"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
literal|999
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"ftp://[::1]:999/?q=test"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"ftp://[ff00::127.0.0.1]/?q=test"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"ftp"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"[ff00::127.0.0.1]"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"q=test"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"ftp://[ff00::127.0.0.1]/?q=test"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"ftp://[v99.not_(any:time)_soon]/?q=test"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"ftp"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"[v99.not_(any:time)_soon]"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"q=test"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"ftp://[v99.not_(any:time)_soon]/?q=test"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"scheme://user:pass@foo.com:42/?q=test&s=some+thing#fragment"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"scheme"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"user:pass"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"foo.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
literal|42
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"q=test&s=some+thing"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"fragment"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"scheme://user:pass@foo.com:42/?q=test&s=some+thing#fragment"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"scheme://user@foo.com/#fragment"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"scheme"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"user"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"foo.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"fragment"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"scheme://user@foo.com/#fragment"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"scheme://%75ser@foo.com/#frag@ment"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"scheme"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"%75ser"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"foo.com"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"frag@ment"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"scheme://%75ser@foo.com/#frag@ment"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"file:///some/path/to/the/file"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"file"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/some/path/to/the/file"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"file:///some/path/to/the/file"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"///some/path/to/the-file"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|uri
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/some/path/to/the-file"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"///some/path/to/the-file"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"/s:ome/path/to/the-file?q=99#fred"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|uri
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"/s:ome/path/to/the-file"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"q=99"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"fred"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"/s:ome/path/to/the-file?q=99#fred"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"relative/path/with/co:lon"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|uri
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"relative/path/with/co:lon"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"relative/path/with/co:lon"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"bob?q=99&q2=q?33#fr?ed"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|uri
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"bob"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"q=99&q2=q?33"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"fr?ed"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"bob?q=99&q2=q?33#fr?ed"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|uri
operator|=
name|URI_PARSE
argument_list|(
literal|"#fr?ed"
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|uri
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_scheme
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_userinfo
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_host
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_port
argument_list|(
name|uri
argument_list|)
operator|==
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_path
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|evhttp_uri_get_query
argument_list|(
name|uri
argument_list|)
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|tt_want
argument_list|(
name|strcmp
argument_list|(
name|evhttp_uri_get_fragment
argument_list|(
name|uri
argument_list|)
argument_list|,
literal|"fr?ed"
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|TT_URI
argument_list|(
literal|"#fr?ed"
argument_list|)
expr_stmt|;
name|evhttp_uri_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|URI_PARSE
undef|#
directive|undef
name|TT_URI
undef|#
directive|undef
name|BAD
block|}
end_function

begin_function
specifier|static
name|void
name|http_uriencode_test
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|char
modifier|*
name|s
init|=
name|NULL
decl_stmt|,
modifier|*
name|s2
init|=
name|NULL
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|int
name|bytes_decoded
decl_stmt|;
define|#
directive|define
name|ENC
parameter_list|(
name|from
parameter_list|,
name|want
parameter_list|,
name|plus
parameter_list|)
value|do {				\ 		s = evhttp_uriencode((from), -1, (plus));	\ 		tt_assert(s);					\ 		tt_str_op(s,==,(want));				\ 		sz = -1;					\ 		s2 = evhttp_uridecode((s), (plus),&sz);	\ 		tt_assert(s2);					\ 		tt_str_op(s2,==,(from));			\ 		tt_int_op(sz,==,strlen(from));			\ 		free(s);					\ 		free(s2);					\ 		s = s2 = NULL;					\ 	} while (0)
define|#
directive|define
name|DEC
parameter_list|(
name|from
parameter_list|,
name|want
parameter_list|,
name|dp
parameter_list|)
value|do {					\ 		s = evhttp_uridecode((from),(dp),&sz);		\ 		tt_assert(s);					\ 		tt_str_op(s,==,(want));				\ 		tt_int_op(sz,==,strlen(want));			\ 		free(s);					\ 		s = NULL;					\ 	} while (0)
define|#
directive|define
name|OLD_DEC
parameter_list|(
name|from
parameter_list|,
name|want
parameter_list|)
value|do {				\ 		s = evhttp_decode_uri((from));			\ 		tt_assert(s);					\ 		tt_str_op(s,==,(want));				\ 		free(s);					\ 		s = NULL;					\ 	} while (0)
name|ENC
argument_list|(
literal|"Hello"
argument_list|,
literal|"Hello"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|"99"
argument_list|,
literal|"99"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|""
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789-.~_"
argument_list|,
literal|"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789-.~_"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|" "
argument_list|,
literal|"%20"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|" "
argument_list|,
literal|"+"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|"\xff\xf0\xe0"
argument_list|,
literal|"%FF%F0%E0"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|"\x01\x19"
argument_list|,
literal|"%01%19"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|"http://www.ietf.org/rfc/rfc3986.txt"
argument_list|,
literal|"http%3A%2F%2Fwww.ietf.org%2Frfc%2Frfc3986.txt"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|"1+2=3"
argument_list|,
literal|"1%2B2%3D3"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ENC
argument_list|(
literal|"1+2=3"
argument_list|,
literal|"1%2B2%3D3"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Now try encoding with internal NULs. */
name|s
operator|=
name|evhttp_uriencode
argument_list|(
literal|"hello\0world"
argument_list|,
literal|11
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|tt_str_op
argument_list|(
name|s
argument_list|,
operator|==
argument_list|,
literal|"hello%00world"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
name|NULL
expr_stmt|;
comment|/* Now try decoding just part of string. */
name|s
operator|=
name|malloc
argument_list|(
literal|6
operator|+
literal|1
comment|/* NUL byte */
argument_list|)
expr_stmt|;
name|bytes_decoded
operator|=
name|evhttp_decode_uri_internal
argument_list|(
literal|"hello%20%20"
argument_list|,
literal|6
argument_list|,
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|bytes_decoded
argument_list|,
operator|==
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|tt_str_op
argument_list|(
name|s
argument_list|,
operator|==
argument_list|,
literal|"hello%"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
name|NULL
expr_stmt|;
comment|/* Now try out some decoding cases that we don't generate with 	 * encode_uri: Make sure that malformed stuff doesn't crash... */
name|DEC
argument_list|(
literal|"%%xhello th+ere \xff"
argument_list|,
literal|"%%xhello th+ere \xff"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Make sure plus decoding works */
name|DEC
argument_list|(
literal|"plus+should%20work+"
argument_list|,
literal|"plus should work "
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Try some lowercase hex */
name|DEC
argument_list|(
literal|"%f0%a0%b0"
argument_list|,
literal|"\xf0\xa0\xb0"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Try an internal NUL. */
name|sz
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|evhttp_uridecode
argument_list|(
literal|"%00%00x%00%00"
argument_list|,
literal|1
argument_list|,
operator|&
name|sz
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|sz
argument_list|,
operator|==
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
operator|!
name|memcmp
argument_list|(
name|s
argument_list|,
literal|"\0\0x\0\0"
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
name|NULL
expr_stmt|;
comment|/* Try with size == NULL */
name|sz
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|evhttp_uridecode
argument_list|(
literal|"%00%00x%00%00"
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
operator|!
name|memcmp
argument_list|(
name|s
argument_list|,
literal|"\0\0x\0\0"
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
name|NULL
expr_stmt|;
comment|/* Test out the crazy old behavior of the deprecated 	 * evhttp_decode_uri */
name|OLD_DEC
argument_list|(
literal|"http://example.com/normal+path/?key=val+with+spaces"
argument_list|,
literal|"http://example.com/normal+path/?key=val with spaces"
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|s
condition|)
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s2
condition|)
name|free
argument_list|(
name|s2
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|ENC
undef|#
directive|undef
name|DEC
undef|#
directive|undef
name|OLD_DEC
block|}
end_function

begin_function
specifier|static
name|void
name|http_base_test
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|struct
name|event_base
modifier|*
name|base
init|=
name|NULL
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
decl_stmt|;
name|evutil_socket_t
name|fd
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|base
operator|=
name|event_base_new
argument_list|()
expr_stmt|;
name|tt_assert
argument_list|(
name|base
argument_list|)
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd
argument_list|,
operator|>=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|base
argument_list|)
expr_stmt|;
name|bufferevent_base_set
argument_list|(
name|base
argument_list|,
name|bev
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"GET /test HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|base
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|base
condition|)
name|event_base_free
argument_list|(
name|base
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * the server is just going to close the connection if it times out during  * reading the headers.  */
end_comment

begin_function
specifier|static
name|void
name|http_incomplete_readcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|test_ok
operator|=
operator|-
literal|1
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|exit_base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_incomplete_errorcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|what
operator|==
operator|(
name|BEV_EVENT_READING
operator||
name|BEV_EVENT_EOF
operator|)
condition|)
name|test_ok
operator|++
expr_stmt|;
else|else
name|test_ok
operator|=
operator|-
literal|2
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|exit_base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_incomplete_writecb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|arg
operator|!=
name|NULL
condition|)
block|{
name|evutil_socket_t
name|fd
init|=
operator|*
operator|(
name|evutil_socket_t
operator|*
operator|)
name|arg
decl_stmt|;
comment|/* terminate the write side to simulate EOF */
name|shutdown
argument_list|(
name|fd
argument_list|,
name|SHUT_WR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|bufferevent_get_output
argument_list|(
name|bev
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* enable reading of the reply */
name|bufferevent_enable
argument_list|(
name|bev
argument_list|,
name|EV_READ
argument_list|)
expr_stmt|;
name|test_ok
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|http_incomplete_test_
parameter_list|(
name|struct
name|basic_test_data
modifier|*
name|data
parameter_list|,
name|int
name|use_timeout
parameter_list|)
block|{
name|struct
name|bufferevent
modifier|*
name|bev
decl_stmt|;
name|evutil_socket_t
name|fd
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|tv_start
decl_stmt|,
name|tv_end
decl_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_set_timeout
argument_list|(
name|http
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd
argument_list|,
operator|>=
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_incomplete_readcb
argument_list|,
name|http_incomplete_writecb
argument_list|,
name|http_incomplete_errorcb
argument_list|,
name|use_timeout
condition|?
name|NULL
else|:
operator|&
name|fd
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"GET /test HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_start
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_end
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|evutil_timersub
argument_list|(
operator|&
name|tv_end
argument_list|,
operator|&
name|tv_start
argument_list|,
operator|&
name|tv_end
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_timeout
condition|)
block|{
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_timeout
operator|&&
name|tv_end
operator|.
name|tv_sec
operator|>=
literal|3
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"time"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|use_timeout
operator|&&
name|tv_end
operator|.
name|tv_sec
operator|>=
literal|1
condition|)
block|{
comment|/* we should be done immediately */
name|tt_abort_msg
argument_list|(
literal|"time"
argument_list|)
expr_stmt|;
block|}
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_incomplete_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|http_incomplete_test_
argument_list|(
name|arg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_incomplete_timeout_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|http_incomplete_test_
argument_list|(
name|arg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * the server is going to reply with chunked data.  */
end_comment

begin_function
specifier|static
name|void
name|http_chunked_readcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
comment|/* nothing here */
block|}
end_function

begin_function
specifier|static
name|void
name|http_chunked_errorcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|test_ok
condition|)
goto|goto
name|out
goto|;
name|test_ok
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|what
operator|&
name|BEV_EVENT_EOF
operator|)
operator|!=
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|header
decl_stmt|;
name|enum
name|message_read_status
name|done
decl_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* req->kind = EVHTTP_RESPONSE; */
name|done
operator|=
name|evhttp_parse_firstline_
argument_list|(
name|req
argument_list|,
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|done
operator|!=
name|ALL_DATA_READ
condition|)
goto|goto
name|out
goto|;
name|done
operator|=
name|evhttp_parse_headers_
argument_list|(
name|req
argument_list|,
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|done
operator|!=
name|ALL_DATA_READ
condition|)
goto|goto
name|out
goto|;
name|header
operator|=
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Transfer-Encoding"
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|header
argument_list|,
literal|"chunked"
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|header
operator|=
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Connection"
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|header
argument_list|,
literal|"close"
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|header
operator|=
name|evbuffer_readln
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|EVBUFFER_EOL_CRLF
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
comment|/* 13 chars */
if|if
condition|(
name|strcmp
argument_list|(
name|header
argument_list|,
literal|"d"
argument_list|)
condition|)
block|{
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|header
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|evbuffer_pullup
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
literal|13
argument_list|)
argument_list|,
literal|"This is funny"
argument_list|,
literal|13
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|evbuffer_drain
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
literal|13
operator|+
literal|2
argument_list|)
expr_stmt|;
name|header
operator|=
name|evbuffer_readln
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|EVBUFFER_EOL_CRLF
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
comment|/* 18 chars */
if|if
condition|(
name|strcmp
argument_list|(
name|header
argument_list|,
literal|"12"
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|evbuffer_pullup
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
literal|18
argument_list|)
argument_list|,
literal|"but not hilarious."
argument_list|,
literal|18
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|evbuffer_drain
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
literal|18
operator|+
literal|2
argument_list|)
expr_stmt|;
name|header
operator|=
name|evbuffer_readln
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|EVBUFFER_EOL_CRLF
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
comment|/* 8 chars */
if|if
condition|(
name|strcmp
argument_list|(
name|header
argument_list|,
literal|"8"
argument_list|)
condition|)
block|{
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|header
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|evbuffer_pullup
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
literal|8
argument_list|)
argument_list|,
literal|"bwv 1052."
argument_list|,
literal|8
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|evbuffer_drain
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
literal|8
operator|+
literal|2
argument_list|)
expr_stmt|;
name|header
operator|=
name|evbuffer_readln
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|EVBUFFER_EOL_CRLF
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
comment|/* 0 chars */
if|if
condition|(
name|strcmp
argument_list|(
name|header
argument_list|,
literal|"0"
argument_list|)
condition|)
block|{
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|header
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|header
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|2
expr_stmt|;
block|}
name|out
label|:
if|if
condition|(
name|req
condition|)
name|evhttp_request_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_chunked_writecb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|bufferevent_get_output
argument_list|(
name|bev
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* enable reading of the reply */
name|bufferevent_enable
argument_list|(
name|bev
argument_list|,
name|EV_READ
argument_list|)
expr_stmt|;
name|test_ok
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|http_chunked_request_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|!=
name|HTTP_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Transfer-Encoding"
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
operator|!=
literal|13
operator|+
literal|18
operator|+
literal|8
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|evbuffer_pullup
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
literal|13
operator|+
literal|18
operator|+
literal|8
argument_list|)
argument_list|,
literal|"This is funnybut not hilarious.bwv 1052"
argument_list|,
literal|13
operator|+
literal|18
operator|+
literal|8
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|test_ok
operator|=
literal|1
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_chunk_out_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
decl_stmt|;
name|evutil_socket_t
name|fd
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|tv_start
decl_stmt|,
name|tv_end
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_chunked_readcb
argument_list|,
name|http_chunked_writecb
argument_list|,
name|http_chunked_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|http_request
operator|=
literal|"GET /chunked HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_start
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_end
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|evutil_timersub
argument_list|(
operator|&
name|tv_end
argument_list|,
operator|&
name|tv_start
argument_list|,
operator|&
name|tv_end
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|tv_end
operator|.
name|tv_sec
argument_list|,
operator|<
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* now try again with the regular connection object */
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* make two requests to check the keepalive behavior */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|test_ok
operator|=
literal|0
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_chunked_request_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/chunked"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|test_ok
operator|==
literal|1
argument_list|)
expr_stmt|;
block|}
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_stream_out_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule a request to the HTTP 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|"This is funnybut not hilarious.bwv 1052"
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/streamed"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_stream_in_chunk
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evbuffer
modifier|*
name|reply
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
operator|!=
name|HTTP_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|evbuffer_add_buffer
argument_list|(
name|reply
argument_list|,
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_stream_in_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|event_base_loopexit
argument_list|(
name|exit_base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Makes a request and reads the response in chunks.  */
end_comment

begin_function
specifier|static
name|void
name|http_stream_in_test_
parameter_list|(
name|struct
name|basic_test_data
modifier|*
name|data
parameter_list|,
name|char
specifier|const
modifier|*
name|url
parameter_list|,
name|size_t
name|expected_len
parameter_list|,
name|char
specifier|const
modifier|*
name|expected
parameter_list|)
block|{
name|struct
name|evhttp_connection
modifier|*
name|evcon
decl_stmt|;
name|struct
name|evbuffer
modifier|*
name|reply
init|=
name|evbuffer_new
argument_list|()
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_stream_in_done
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|evhttp_request_set_chunked_cb
argument_list|(
name|req
argument_list|,
name|http_stream_in_chunk
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
name|url
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|evbuffer_get_length
argument_list|(
name|reply
argument_list|)
operator|!=
name|expected_len
condition|)
block|{
name|TT_DIE
argument_list|(
operator|(
literal|"reply length %lu; expected %lu; FAILED (%s)\n"
operator|,
operator|(
name|unsigned
name|long
operator|)
name|evbuffer_get_length
argument_list|(
name|reply
argument_list|)
operator|,
operator|(
name|unsigned
name|long
operator|)
name|expected_len
operator|,
operator|(
name|char
operator|*
operator|)
name|evbuffer_pullup
argument_list|(
name|reply
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|evbuffer_pullup
argument_list|(
name|reply
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|,
name|expected
argument_list|,
name|expected_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Memory mismatch"
argument_list|)
expr_stmt|;
block|}
name|test_ok
operator|=
literal|1
expr_stmt|;
name|end
label|:
if|if
condition|(
name|reply
condition|)
name|evbuffer_free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_stream_in_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|http_stream_in_test_
argument_list|(
name|arg
argument_list|,
literal|"/chunked"
argument_list|,
literal|13
operator|+
literal|18
operator|+
literal|8
argument_list|,
literal|"This is funnybut not hilarious.bwv 1052"
argument_list|)
expr_stmt|;
name|http_stream_in_test_
argument_list|(
name|arg
argument_list|,
literal|"/test"
argument_list|,
name|strlen
argument_list|(
name|BASIC_REQUEST_BODY
argument_list|)
argument_list|,
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_stream_in_cancel_chunk
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tt_int_op
argument_list|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
argument_list|,
operator|==
argument_list|,
name|HTTP_OK
argument_list|)
expr_stmt|;
name|end
label|:
name|evhttp_cancel_request
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_stream_in_cancel_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
comment|/* should never be called */
name|tt_fail_msg
argument_list|(
literal|"In cancel done"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_stream_in_cancel_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_stream_in_cancel_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|evhttp_request_set_chunked_cb
argument_list|(
name|req
argument_list|,
name|http_stream_in_cancel_chunk
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/chunked"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|1
expr_stmt|;
name|end
label|:
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_connection_fail_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|arg
decl_stmt|;
name|struct
name|event_base
modifier|*
name|base
init|=
name|evhttp_connection_get_base
argument_list|(
name|evcon
argument_list|)
decl_stmt|;
comment|/* An ENETUNREACH error results in an unrecoverable         * evhttp_connection error (see evhttp_connection_fail_()).  The         * connection will be reset, and the user will be notified with a NULL         * req parameter. */
name|tt_assert
argument_list|(
operator|!
name|req
argument_list|)
expr_stmt|;
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|1
expr_stmt|;
name|end
label|:
name|event_base_loopexit
argument_list|(
name|base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Test unrecoverable evhttp_connection errors by generating an ENETUNREACH  * error on connection. */
end_comment

begin_function
specifier|static
name|void
name|http_connection_fail_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
comment|/* auto detect a port */
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|http
operator|=
name|NULL
expr_stmt|;
comment|/* Pick an unroutable address.  This administratively scoped multicast 	* address should do when working with TCP. */
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"239.10.20.30"
argument_list|,
literal|80
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/*         * At this point, we want to schedule an HTTP GET request         * server using our make request method.         */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_connection_fail_done
argument_list|,
name|evcon
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|end
label|:
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_connection_retry_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
argument_list|,
operator|!=
argument_list|,
name|HTTP_OK
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_find_header
argument_list|(
name|evhttp_request_get_input_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Content-Type"
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"(content type)\n"
argument_list|)
expr_stmt|;
block|}
name|tt_uint_op
argument_list|(
name|evbuffer_get_length
argument_list|(
name|evhttp_request_get_input_buffer
argument_list|(
name|req
argument_list|)
argument_list|)
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|1
expr_stmt|;
name|end
label|:
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|event_base
modifier|*
name|http_make_web_server_base
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|http_make_web_server
parameter_list|(
name|evutil_socket_t
name|fd
parameter_list|,
name|short
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|ev_uint16_t
name|port
init|=
operator|*
operator|(
name|ev_uint16_t
operator|*
operator|)
name|arg
decl_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|http_make_web_server_base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_connection_retry_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|,
name|tv_start
decl_stmt|,
name|tv_end
decl_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
comment|/* auto detect a port */
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|http
operator|=
name|NULL
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|evhttp_connection_set_timeout
argument_list|(
name|evcon
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* also bind to local host */
name|evhttp_connection_set_local_address
argument_list|(
name|evcon
argument_list|,
literal|"127.0.0.1"
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule an HTTP GET request 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_connection_retry_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/?arg=val"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_start
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_end
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|evutil_timersub
argument_list|(
operator|&
name|tv_end
argument_list|,
operator|&
name|tv_start
argument_list|,
operator|&
name|tv_end
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|tv_end
operator|.
name|tv_sec
argument_list|,
operator|<
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * now test the same but with retries 	 */
name|test_ok
operator|=
literal|0
expr_stmt|;
block|{
specifier|const
name|struct
name|timeval
name|tv_timeout
init|=
block|{
literal|0
block|,
literal|500000
block|}
decl_stmt|;
specifier|const
name|struct
name|timeval
name|tv_retry
init|=
block|{
literal|0
block|,
literal|500000
block|}
decl_stmt|;
name|evhttp_connection_set_timeout_tv
argument_list|(
name|evcon
argument_list|,
operator|&
name|tv_timeout
argument_list|)
expr_stmt|;
name|evhttp_connection_set_initial_retry_tv
argument_list|(
name|evcon
argument_list|,
operator|&
name|tv_retry
argument_list|)
expr_stmt|;
block|}
name|evhttp_connection_set_retries
argument_list|(
name|evcon
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_connection_retry_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/?arg=val"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_start
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_end
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* fails fast, .5 sec to wait to retry, fails fast again. */
name|test_timeval_diff_leq
argument_list|(
operator|&
name|tv_start
argument_list|,
operator|&
name|tv_end
argument_list|,
literal|500
argument_list|,
literal|200
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|test_ok
operator|==
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * now test the same but with retries and give it a web server 	 * at the end 	 */
name|test_ok
operator|=
literal|0
expr_stmt|;
name|evhttp_connection_set_timeout
argument_list|(
name|evcon
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|evhttp_connection_set_retries
argument_list|(
name|evcon
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_dispatcher_test_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/?arg=val"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
comment|/* start up a web server .2 seconds after the connection tried 	 * to send a request 	 */
name|evutil_timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|200000
expr_stmt|;
name|http_make_web_server_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|event_base_once
argument_list|(
name|data
operator|->
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|http_make_web_server
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_start
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|evutil_gettimeofday
argument_list|(
operator|&
name|tv_end
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* We'll wait twice as long as we did last time. */
name|test_timeval_diff_leq
argument_list|(
operator|&
name|tv_start
argument_list|,
operator|&
name|tv_end
argument_list|,
literal|1000
argument_list|,
literal|400
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_primitives
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|char
modifier|*
name|escaped
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp
modifier|*
name|http
init|=
name|NULL
decl_stmt|;
name|escaped
operator|=
name|evhttp_htmlescape
argument_list|(
literal|"<script>"
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|escaped
argument_list|)
expr_stmt|;
name|tt_str_op
argument_list|(
name|escaped
argument_list|,
operator|==
argument_list|,
literal|"&lt;script&gt;"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|escaped
argument_list|)
expr_stmt|;
name|escaped
operator|=
name|evhttp_htmlescape
argument_list|(
literal|"\"\'&"
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|escaped
argument_list|)
expr_stmt|;
name|tt_str_op
argument_list|(
name|escaped
argument_list|,
operator|==
argument_list|,
literal|"&quot;&#039;&amp;"
argument_list|)
expr_stmt|;
name|http
operator|=
name|evhttp_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|http
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|evhttp_set_cb
argument_list|(
name|http
argument_list|,
literal|"/test"
argument_list|,
name|http_basic_cb
argument_list|,
name|NULL
argument_list|)
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|evhttp_set_cb
argument_list|(
name|http
argument_list|,
literal|"/test"
argument_list|,
name|http_basic_cb
argument_list|,
name|NULL
argument_list|)
argument_list|,
operator|==
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|evhttp_del_cb
argument_list|(
name|http
argument_list|,
literal|"/test"
argument_list|)
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|evhttp_del_cb
argument_list|(
name|http
argument_list|,
literal|"/test"
argument_list|)
argument_list|,
operator|==
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|evhttp_set_cb
argument_list|(
name|http
argument_list|,
literal|"/test"
argument_list|,
name|http_basic_cb
argument_list|,
name|NULL
argument_list|)
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|escaped
condition|)
name|free
argument_list|(
name|escaped
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_multi_line_header_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
init|=
name|NULL
decl_stmt|;
name|evutil_socket_t
name|fd
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_start_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tt_ptr_op
argument_list|(
name|http
argument_list|,
operator|!=
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|fd
argument_list|,
operator|!=
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tt_ptr_op
argument_list|(
name|bev
argument_list|,
operator|!=
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|http_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|http_start_request
operator|=
literal|"GET /test HTTP/1.1\r\n"
literal|"Host: somehost\r\n"
literal|"Connection: close\r\n"
literal|"X-Multi-Extra-WS:  libevent  \r\n"
literal|"\t\t\t2.1 \r\n"
literal|"X-Multi:  aaaaaaaa\r\n"
literal|" a\r\n"
literal|"\tEND\r\n"
literal|"X-Last: last\r\n"
literal|"\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_start_request
argument_list|,
name|strlen
argument_list|(
name|http_start_request
argument_list|)
argument_list|)
expr_stmt|;
name|found_multi
operator|=
name|found_multi2
operator|=
literal|0
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|found_multi
argument_list|,
operator|==
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|found_multi2
argument_list|,
operator|==
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|test_ok
argument_list|,
operator|==
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|bev
condition|)
name|bufferevent_free
argument_list|(
name|bev
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_request_bad
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
if|if
condition|(
name|req
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|test_ok
operator|=
literal|1
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_negative_content_length_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule a request to the HTTP 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_bad
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* Cause the response to have a negative content-length */
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"X-Negative"
argument_list|,
literal|"makeitso"
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_data_length_constraints_test_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
argument_list|,
operator|==
argument_list|,
name|HTTP_BADREQUEST
argument_list|)
expr_stmt|;
name|end
label|:
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_large_entity_test_done
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|tt_int_op
argument_list|(
name|evhttp_request_get_response_code
argument_list|(
name|req
argument_list|)
argument_list|,
operator|==
argument_list|,
name|HTTP_ENTITYTOOLARGE
argument_list|)
expr_stmt|;
name|end
label|:
name|event_base_loopexit
argument_list|(
name|arg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_data_length_constraints_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|char
name|long_str
index|[
literal|8192
index|]
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
comment|/* also bind to local host */
name|evhttp_connection_set_local_address
argument_list|(
name|evcon
argument_list|,
literal|"127.0.0.1"
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule an HTTP GET request 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_data_length_constraints_test_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|long_str
argument_list|,
literal|'a'
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
name|long_str
index|[
literal|8191
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* Add the information that we care about */
name|evhttp_set_max_headers_size
argument_list|(
name|http
argument_list|,
literal|8191
argument_list|)
expr_stmt|;
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Longheader"
argument_list|,
name|long_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/?arg=val"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_data_length_constraints_test_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
comment|/* GET /?arg=verylongvalue HTTP/1.1 */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
name|long_str
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|evhttp_set_max_body_size
argument_list|(
name|http
argument_list|,
literal|8190
argument_list|)
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_data_length_constraints_test_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evhttp_request_get_output_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|long_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_POST
argument_list|,
literal|"/"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_large_entity_test_done
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Host"
argument_list|,
literal|"somehost"
argument_list|)
expr_stmt|;
name|evhttp_add_header
argument_list|(
name|evhttp_request_get_output_headers
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"Expect"
argument_list|,
literal|"100-continue"
argument_list|)
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evhttp_request_get_output_buffer
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|long_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_POST
argument_list|,
literal|"/"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|1
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Testing client reset of server chunked connections  */
end_comment

begin_struct
struct|struct
name|terminate_state
block|{
name|struct
name|event_base
modifier|*
name|base
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
decl_stmt|;
name|evutil_socket_t
name|fd
decl_stmt|;
name|int
name|gotclosecb
range|:
literal|1
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|terminate_chunked_trickle_cb
parameter_list|(
name|evutil_socket_t
name|fd
parameter_list|,
name|short
name|events
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|terminate_state
modifier|*
name|state
init|=
name|arg
decl_stmt|;
name|struct
name|evbuffer
modifier|*
name|evb
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
if|if
condition|(
name|evhttp_request_get_connection
argument_list|(
name|state
operator|->
name|req
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|test_ok
operator|=
literal|1
expr_stmt|;
name|evhttp_request_free
argument_list|(
name|state
operator|->
name|req
argument_list|)
expr_stmt|;
name|event_base_loopexit
argument_list|(
name|state
operator|->
name|base
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
name|evb
operator|=
name|evbuffer_new
argument_list|()
expr_stmt|;
name|evbuffer_add_printf
argument_list|(
name|evb
argument_list|,
literal|"%p"
argument_list|,
name|evb
argument_list|)
expr_stmt|;
name|evhttp_send_reply_chunk
argument_list|(
name|state
operator|->
name|req
argument_list|,
name|evb
argument_list|)
expr_stmt|;
name|evbuffer_free
argument_list|(
name|evb
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|3000
expr_stmt|;
name|EVUTIL_ASSERT
argument_list|(
name|state
argument_list|)
expr_stmt|;
name|EVUTIL_ASSERT
argument_list|(
name|state
operator|->
name|base
argument_list|)
expr_stmt|;
name|event_base_once
argument_list|(
name|state
operator|->
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|terminate_chunked_trickle_cb
argument_list|,
name|arg
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|terminate_chunked_close_cb
parameter_list|(
name|struct
name|evhttp_connection
modifier|*
name|evcon
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|terminate_state
modifier|*
name|state
init|=
name|arg
decl_stmt|;
name|state
operator|->
name|gotclosecb
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|terminate_chunked_cb
parameter_list|(
name|struct
name|evhttp_request
modifier|*
name|req
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|terminate_state
modifier|*
name|state
init|=
name|arg
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
comment|/* we want to know if this connection closes on us */
name|evhttp_connection_set_closecb
argument_list|(
name|evhttp_request_get_connection
argument_list|(
name|req
argument_list|)
argument_list|,
name|terminate_chunked_close_cb
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|state
operator|->
name|req
operator|=
name|req
expr_stmt|;
name|evhttp_send_reply_start
argument_list|(
name|req
argument_list|,
name|HTTP_OK
argument_list|,
literal|"OK"
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|3000
expr_stmt|;
name|event_base_once
argument_list|(
name|state
operator|->
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|terminate_chunked_trickle_cb
argument_list|,
name|arg
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|terminate_chunked_client
parameter_list|(
name|evutil_socket_t
name|fd
parameter_list|,
name|short
name|event
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|terminate_state
modifier|*
name|state
init|=
name|arg
decl_stmt|;
name|bufferevent_free
argument_list|(
name|state
operator|->
name|bev
argument_list|)
expr_stmt|;
name|evutil_closesocket
argument_list|(
name|state
operator|->
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|terminate_readcb
parameter_list|(
name|struct
name|bufferevent
modifier|*
name|bev
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
comment|/* just drop the data */
name|evbuffer_drain
argument_list|(
name|bufferevent_get_input
argument_list|(
name|bev
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_terminate_chunked_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|bufferevent
modifier|*
name|bev
init|=
name|NULL
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
specifier|const
name|char
modifier|*
name|http_request
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|evutil_socket_t
name|fd
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|terminate_state
name|terminate_state
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evhttp_del_cb
argument_list|(
name|http
argument_list|,
literal|"/test"
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evhttp_set_cb
argument_list|(
name|http
argument_list|,
literal|"/test"
argument_list|,
name|terminate_chunked_cb
argument_list|,
operator|&
name|terminate_state
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|fd
operator|=
name|http_connect
argument_list|(
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Stupid thing to send a request */
name|bev
operator|=
name|bufferevent_socket_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bufferevent_setcb
argument_list|(
name|bev
argument_list|,
name|terminate_readcb
argument_list|,
name|http_writecb
argument_list|,
name|http_errorcb
argument_list|,
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|terminate_state
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|terminate_state
argument_list|)
argument_list|)
expr_stmt|;
name|terminate_state
operator|.
name|base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|terminate_state
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
name|terminate_state
operator|.
name|bev
operator|=
name|bev
expr_stmt|;
name|terminate_state
operator|.
name|gotclosecb
operator|=
literal|0
expr_stmt|;
comment|/* first half of the http request */
name|http_request
operator|=
literal|"GET /test HTTP/1.1\r\n"
literal|"Host: some\r\n\r\n"
expr_stmt|;
name|bufferevent_write
argument_list|(
name|bev
argument_list|,
name|http_request
argument_list|,
name|strlen
argument_list|(
name|http_request
argument_list|)
argument_list|)
expr_stmt|;
name|evutil_timerclear
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|10000
expr_stmt|;
name|event_base_once
argument_list|(
name|data
operator|->
name|base
argument_list|,
operator|-
literal|1
argument_list|,
name|EV_TIMEOUT
argument_list|,
name|terminate_chunked_client
argument_list|,
operator|&
name|terminate_state
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|terminate_state
operator|.
name|gotclosecb
operator|==
literal|0
condition|)
name|test_ok
operator|=
literal|0
expr_stmt|;
name|end
label|:
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
name|evutil_closesocket
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|regress_dns_server_table
name|ipv6_search_table
index|[]
init|=
block|{
block|{
literal|"localhost"
block|,
literal|"AAAA"
block|,
literal|"::1"
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|http_ipv6_for_domain_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|evdns_base
modifier|*
name|dns_base
init|=
name|NULL
decl_stmt|;
name|ev_uint16_t
name|portnum
init|=
literal|0
decl_stmt|;
name|char
name|address
index|[
literal|64
index|]
decl_stmt|;
name|tt_assert
argument_list|(
name|regress_dnsserver
argument_list|(
name|data
operator|->
name|base
argument_list|,
operator|&
name|portnum
argument_list|,
name|ipv6_search_table
argument_list|)
argument_list|)
expr_stmt|;
name|dns_base
operator|=
name|evdns_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
literal|0
comment|/* init name servers */
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|dns_base
argument_list|)
expr_stmt|;
comment|/* Add ourself as the only nameserver, and make sure we really are 	 * the only nameserver. */
name|evutil_snprintf
argument_list|(
name|address
argument_list|,
sizeof|sizeof
argument_list|(
name|address
argument_list|)
argument_list|,
literal|"127.0.0.1:%d"
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|evdns_base_nameserver_ip_add
argument_list|(
name|dns_base
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|http_connection_test_
argument_list|(
name|arg
argument_list|,
literal|0
comment|/* not persistent */
argument_list|,
literal|"localhost"
argument_list|,
name|dns_base
argument_list|,
literal|1
comment|/* ipv6 */
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|dns_base
condition|)
name|evdns_base_free
argument_list|(
name|dns_base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regress_clean_dnsserver
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_request_get_addr_on_close
parameter_list|(
name|struct
name|evhttp_connection
modifier|*
name|evcon
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
specifier|const
name|struct
name|sockaddr
modifier|*
name|storage
decl_stmt|;
name|char
name|addrbuf
index|[
literal|128
index|]
decl_stmt|;
name|char
name|local
index|[]
init|=
literal|"127.0.0.1:"
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|storage
operator|=
name|evhttp_connection_get_addr
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|storage
argument_list|)
expr_stmt|;
name|evutil_format_sockaddr_port_
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|storage
argument_list|,
name|addrbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|addrbuf
argument_list|)
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
operator|!
name|strncmp
argument_list|(
name|addrbuf
argument_list|,
name|local
argument_list|,
sizeof|sizeof
argument_list|(
name|local
argument_list|)
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|test_ok
operator|=
literal|1
expr_stmt|;
return|return;
name|end
label|:
name|test_ok
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_get_addr_test
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|basic_test_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|ev_uint16_t
name|port
init|=
literal|0
decl_stmt|;
name|struct
name|evhttp_connection
modifier|*
name|evcon
init|=
name|NULL
decl_stmt|;
name|struct
name|evhttp_request
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|test_ok
operator|=
literal|0
expr_stmt|;
name|exit_base
operator|=
name|data
operator|->
name|base
expr_stmt|;
name|http
operator|=
name|http_setup
argument_list|(
operator|&
name|port
argument_list|,
name|data
operator|->
name|base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|evcon
operator|=
name|evhttp_connection_base_new
argument_list|(
name|data
operator|->
name|base
argument_list|,
name|NULL
argument_list|,
literal|"127.0.0.1"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|tt_assert
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
name|evhttp_connection_set_closecb
argument_list|(
name|evcon
argument_list|,
name|http_request_get_addr_on_close
argument_list|,
name|arg
argument_list|)
expr_stmt|;
comment|/* 	 * At this point, we want to schedule a request to the HTTP 	 * server using our make request method. 	 */
name|req
operator|=
name|evhttp_request_new
argument_list|(
name|http_request_done
argument_list|,
operator|(
name|void
operator|*
operator|)
name|BASIC_REQUEST_BODY
argument_list|)
expr_stmt|;
comment|/* We give ownership of the request to the connection */
if|if
condition|(
name|evhttp_make_request
argument_list|(
name|evcon
argument_list|,
name|req
argument_list|,
name|EVHTTP_REQ_GET
argument_list|,
literal|"/test"
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|tt_abort_msg
argument_list|(
literal|"Couldn't make request"
argument_list|)
expr_stmt|;
block|}
name|event_base_dispatch
argument_list|(
name|data
operator|->
name|base
argument_list|)
expr_stmt|;
name|http_request_get_addr_on_close
argument_list|(
name|evcon
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|evcon
condition|)
name|evhttp_connection_free
argument_list|(
name|evcon
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
condition|)
name|evhttp_free
argument_list|(
name|http
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|HTTP_LEGACY
parameter_list|(
name|name
parameter_list|)
define|\
value|{ #name, run_legacy_test_fn, TT_ISOLATED|TT_LEGACY,&legacy_setup, \ 		    http_##name##_test }
end_define

begin_define
define|#
directive|define
name|HTTP
parameter_list|(
name|name
parameter_list|)
define|\
value|{ #name, http_##name##_test, TT_ISOLATED,&basic_setup, NULL }
end_define

begin_decl_stmt
name|struct
name|testcase_t
name|http_testcases
index|[]
init|=
block|{
block|{
literal|"primitives"
block|,
name|http_primitives
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"base"
block|,
name|http_base_test
block|,
name|TT_FORK
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"bad_headers"
block|,
name|http_bad_header_test
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"parse_query"
block|,
name|http_parse_query_test
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"parse_uri"
block|,
name|http_parse_uri_test
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"parse_uri_nc"
block|,
name|http_parse_uri_test
block|,
literal|0
block|,
operator|&
name|basic_setup
block|,
operator|(
name|void
operator|*
operator|)
literal|"nc"
block|}
block|,
block|{
literal|"uriencode"
block|,
name|http_uriencode_test
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|,
name|HTTP
argument_list|(
name|basic
argument_list|)
block|,
name|HTTP
argument_list|(
name|cancel
argument_list|)
block|,
name|HTTP
argument_list|(
name|virtual_host
argument_list|)
block|,
name|HTTP
argument_list|(
name|post
argument_list|)
block|,
name|HTTP
argument_list|(
name|put
argument_list|)
block|,
name|HTTP
argument_list|(
name|delete
argument_list|)
block|,
name|HTTP
argument_list|(
name|allowed_methods
argument_list|)
block|,
name|HTTP
argument_list|(
name|failure
argument_list|)
block|,
name|HTTP
argument_list|(
name|connection
argument_list|)
block|,
name|HTTP
argument_list|(
name|persist_connection
argument_list|)
block|,
name|HTTP
argument_list|(
name|connection_async
argument_list|)
block|,
name|HTTP
argument_list|(
name|close_detection
argument_list|)
block|,
name|HTTP
argument_list|(
name|close_detection_delay
argument_list|)
block|,
name|HTTP
argument_list|(
name|bad_request
argument_list|)
block|,
name|HTTP
argument_list|(
name|incomplete
argument_list|)
block|,
name|HTTP
argument_list|(
name|incomplete_timeout
argument_list|)
block|,
name|HTTP
argument_list|(
name|terminate_chunked
argument_list|)
block|,
name|HTTP
argument_list|(
name|on_complete
argument_list|)
block|,
name|HTTP
argument_list|(
name|highport
argument_list|)
block|,
name|HTTP
argument_list|(
name|dispatcher
argument_list|)
block|,
name|HTTP
argument_list|(
name|multi_line_header
argument_list|)
block|,
name|HTTP
argument_list|(
name|negative_content_length
argument_list|)
block|,
name|HTTP
argument_list|(
name|chunk_out
argument_list|)
block|,
name|HTTP
argument_list|(
name|stream_out
argument_list|)
block|,
name|HTTP
argument_list|(
name|stream_in
argument_list|)
block|,
name|HTTP
argument_list|(
name|stream_in_cancel
argument_list|)
block|,
name|HTTP
argument_list|(
name|connection_fail
argument_list|)
block|,
block|{
literal|"connection_retry"
block|,
name|http_connection_retry_test
block|,
name|TT_ISOLATED
operator||
name|TT_OFF_BY_DEFAULT
block|,
operator|&
name|basic_setup
block|,
name|NULL
block|}
block|,
name|HTTP
argument_list|(
name|data_length_constraints
argument_list|)
block|,
name|HTTP
argument_list|(
name|ipv6_for_domain
argument_list|)
block|,
name|HTTP
argument_list|(
name|get_addr
argument_list|)
block|,
name|END_OF_TESTCASES
block|}
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2007-2012 Niels Provos and Nick Mathewson  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/* This file has our secure PRNG code.  On platforms that have arc4random(),  * we just use that.  Otherwise, we include arc4random.c as a bunch of static  * functions, and wrap it lightly.  We don't expose the arc4random*() APIs  * because A) they aren't in our namespace, and B) it's not nice to name your  * APIs after their implementations.  We keep them in a separate file  * so that other people can rip it out and use it for whatever.  */
end_comment

begin_include
include|#
directive|include
file|"event2/event-config.h"
end_include

begin_include
include|#
directive|include
file|"evconfig-private.h"
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|"util-internal.h"
end_include

begin_include
include|#
directive|include
file|"evthread-internal.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|EVENT__HAVE_ARC4RANDOM
end_ifdef

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_function
name|int
name|evutil_secure_rng_set_urandom_device_file
parameter_list|(
name|char
modifier|*
name|fname
parameter_list|)
block|{
operator|(
name|void
operator|)
name|fname
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|evutil_secure_rng_init
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* call arc4random() now to force it to self-initialize */
operator|(
name|void
operator|)
name|arc4random
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|EVENT__DISABLE_THREAD_SUPPORT
end_ifndef

begin_function
name|int
name|evutil_secure_rng_global_setup_locks_
parameter_list|(
specifier|const
name|int
name|enable_locks
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|evutil_free_secure_rng_globals_locks
parameter_list|(
name|void
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|ev_arc4random_buf
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|n
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|EVENT__HAVE_ARC4RANDOM_BUF
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__APPLE__
argument_list|)
name|arc4random_buf
argument_list|(
name|buf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
else|#
directive|else
name|unsigned
name|char
modifier|*
name|b
init|=
name|buf
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|EVENT__HAVE_ARC4RANDOM_BUF
argument_list|)
comment|/* OSX 10.7 introducd arc4random_buf, so if you build your program 	 * there, you'll get surprised when older versions of OSX fail to run. 	 * To solve this, we can check whether the function pointer is set, 	 * and fall back otherwise.  (OSX does this using some linker 	 * trickery.) 	 */
block|{
name|void
function_decl|(
modifier|*
name|tptr
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|)
init|=
operator|(
name|void
argument_list|(
operator|*
argument_list|)
operator|(
name|void
operator|*
call|,
name|size_t
operator|)
operator|)
name|arc4random_buf
function_decl|;
if|if
condition|(
name|tptr
operator|!=
name|NULL
condition|)
block|{
name|arc4random_buf
argument_list|(
name|buf
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
endif|#
directive|endif
comment|/* Make sure that we start out with b at a 4-byte alignment; plenty 	 * of CPUs care about this for 32-bit access. */
if|if
condition|(
name|n
operator|>=
literal|4
operator|&&
operator|(
operator|(
name|ev_uintptr_t
operator|)
name|b
operator|)
operator|&
literal|3
condition|)
block|{
name|ev_uint32_t
name|u
init|=
name|arc4random
argument_list|()
decl_stmt|;
name|int
name|n_bytes
init|=
literal|4
operator|-
operator|(
operator|(
operator|(
name|ev_uintptr_t
operator|)
name|b
operator|)
operator|&
literal|3
operator|)
decl_stmt|;
name|memcpy
argument_list|(
name|b
argument_list|,
operator|&
name|u
argument_list|,
name|n_bytes
argument_list|)
expr_stmt|;
name|b
operator|+=
name|n_bytes
expr_stmt|;
name|n
operator|-=
name|n_bytes
expr_stmt|;
block|}
while|while
condition|(
name|n
operator|>=
literal|4
condition|)
block|{
operator|*
operator|(
name|ev_uint32_t
operator|*
operator|)
name|b
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|b
operator|+=
literal|4
expr_stmt|;
name|n
operator|-=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|n
condition|)
block|{
name|ev_uint32_t
name|u
init|=
name|arc4random
argument_list|()
decl_stmt|;
name|memcpy
argument_list|(
name|b
argument_list|,
operator|&
name|u
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !EVENT__HAVE_ARC4RANDOM { */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|EVENT__ssize_t
end_ifdef

begin_define
define|#
directive|define
name|ssize_t
value|EVENT__ssize_t
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ARC4RANDOM_EXPORT
value|static
end_define

begin_define
define|#
directive|define
name|ARC4_LOCK_
parameter_list|()
value|EVLOCK_LOCK(arc4rand_lock, 0)
end_define

begin_define
define|#
directive|define
name|ARC4_UNLOCK_
parameter_list|()
value|EVLOCK_UNLOCK(arc4rand_lock, 0)
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|EVENT__DISABLE_THREAD_SUPPORT
end_ifndef

begin_decl_stmt
specifier|static
name|void
modifier|*
name|arc4rand_lock
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ARC4RANDOM_UINT32
value|ev_uint32_t
end_define

begin_define
define|#
directive|define
name|ARC4RANDOM_NOSTIR
end_define

begin_define
define|#
directive|define
name|ARC4RANDOM_NORANDOM
end_define

begin_define
define|#
directive|define
name|ARC4RANDOM_NOUNIFORM
end_define

begin_include
include|#
directive|include
file|"./arc4random.c"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|EVENT__DISABLE_THREAD_SUPPORT
end_ifndef

begin_function
name|int
name|evutil_secure_rng_global_setup_locks_
parameter_list|(
specifier|const
name|int
name|enable_locks
parameter_list|)
block|{
name|EVTHREAD_SETUP_GLOBAL_LOCK
argument_list|(
name|arc4rand_lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|evutil_free_secure_rng_globals_locks
parameter_list|(
name|void
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|EVENT__DISABLE_THREAD_SUPPORT
if|if
condition|(
name|arc4rand_lock
operator|!=
name|NULL
condition|)
block|{
name|EVTHREAD_FREE_LOCK
argument_list|(
name|arc4rand_lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|arc4rand_lock
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
name|int
name|evutil_secure_rng_set_urandom_device_file
parameter_list|(
name|char
modifier|*
name|fname
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|TRY_SEED_URANDOM
name|ARC4_LOCK_
argument_list|()
expr_stmt|;
name|arc4random_urandom_filename
operator|=
name|fname
expr_stmt|;
name|ARC4_UNLOCK_
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|evutil_secure_rng_init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|val
decl_stmt|;
name|ARC4_LOCK_
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|arc4_seeded_ok
condition|)
name|arc4_stir
argument_list|()
expr_stmt|;
name|val
operator|=
name|arc4_seeded_ok
condition|?
literal|0
else|:
operator|-
literal|1
expr_stmt|;
name|ARC4_UNLOCK_
argument_list|()
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ev_arc4random_buf
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|n
parameter_list|)
block|{
name|arc4random_buf
argument_list|(
name|buf
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* } !EVENT__HAVE_ARC4RANDOM */
end_comment

begin_function
name|void
name|evutil_secure_rng_get_bytes
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|n
parameter_list|)
block|{
name|ev_arc4random_buf
argument_list|(
name|buf
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|evutil_secure_rng_add_bytes
parameter_list|(
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|n
parameter_list|)
block|{
name|arc4random_addrandom
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf
argument_list|,
name|n
operator|>
operator|(
name|size_t
operator|)
name|INT_MAX
condition|?
name|INT_MAX
else|:
operator|(
name|int
operator|)
name|n
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|evutil_free_secure_rng_globals_
parameter_list|(
name|void
parameter_list|)
block|{
name|evutil_free_secure_rng_globals_locks
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


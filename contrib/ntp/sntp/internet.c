begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  Copyright (C) 1996 N.M. Maclaren     Copyright (C) 1996 The University of Cambridge  This includes all of the code needed to handle Internet addressing.  It is way outside current POSIX, unfortunately.  It should be easy to convert to a system that uses another mechanism.  The signal handling is not necessary for its function, but is an attempt to avoid the program hanging when the name server is inaccessible. */
end_comment

begin_include
include|#
directive|include
file|"header.h"
end_include

begin_include
include|#
directive|include
file|"internet.h"
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_define
define|#
directive|define
name|INTERNET
end_define

begin_include
include|#
directive|include
file|"kludges.h"
end_include

begin_undef
undef|#
directive|undef
name|INTERNET
end_undef

begin_comment
comment|/* Used to force dns resolving to ipv4 or ipv6 addresses. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|pref_family
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* There needs to be some disgusting grobble for handling timeouts, which is identical to the grobble in socket.c. */
end_comment

begin_decl_stmt
specifier|static
name|jmp_buf
name|jump_buffer
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|jump_handler
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|longjmp
argument_list|(
name|jump_buffer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|clear_alarm
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|k
decl_stmt|;
name|k
operator|=
name|errno
expr_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|SIG_DFL
argument_list|)
operator|==
name|SIG_ERR
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"unable to reset signal handler"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|errno
operator|=
name|k
expr_stmt|;
block|}
end_function

begin_function
name|void
name|preferred_family
parameter_list|(
name|int
name|fam
parameter_list|)
block|{
switch|switch
condition|(
name|fam
condition|)
block|{
case|case
name|PREF_FAM_INET
case|:
name|pref_family
operator|=
name|AF_INET
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|PREF_FAM_INET6
case|:
name|pref_family
operator|=
name|AF_INET6
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"unable to set the preferred family"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_IPV6
end_ifdef

begin_function
name|void
name|find_address
parameter_list|(
name|struct
name|sockaddr_storage
modifier|*
name|address
parameter_list|,
name|struct
name|sockaddr_storage
modifier|*
name|anywhere
parameter_list|,
name|struct
name|sockaddr_storage
modifier|*
name|everywhere
parameter_list|,
name|int
modifier|*
name|port
parameter_list|,
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|timespan
parameter_list|)
block|{
comment|/* Locate the specified NTP server and return its Internet address and port  number. */
name|int
name|family
decl_stmt|,
name|rval
decl_stmt|;
name|struct
name|addrinfo
name|hints
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|res
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|res
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
name|address
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|anywhere
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|everywhere
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|jump_buffer
argument_list|)
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"unable to set up access to NTP server %s"
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|jump_handler
argument_list|)
operator|==
name|SIG_ERR
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"unable to set up signal handler"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|timespan
argument_list|)
expr_stmt|;
comment|/* Look up the Internet name or IP number. */
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|pref_family
expr_stmt|;
name|rval
operator|=
name|getaddrinfo
argument_list|(
name|hostname
argument_list|,
literal|"ntp"
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"getaddrinfo failed with %s"
argument_list|,
name|gai_strerror
argument_list|(
name|rval
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Now clear the timer and check the result. */
name|clear_alarm
argument_list|()
expr_stmt|;
comment|/* There can be more than one address in the list, but for now only     use the first. */
name|memcpy
argument_list|(
name|address
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|family
operator|=
name|res
operator|->
name|ai_family
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
name|hints
operator|.
name|ai_family
operator|=
name|AF_INET
expr_stmt|;
name|hints
operator|.
name|ai_flags
operator|=
name|AI_PASSIVE
expr_stmt|;
name|rval
operator|=
name|getaddrinfo
argument_list|(
name|NULL
argument_list|,
literal|"ntp"
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"getaddrinfo failed with %s"
argument_list|,
name|gai_strerror
argument_list|(
name|rval
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|anywhere
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|rval
operator|=
name|getaddrinfo
argument_list|(
literal|"255.255.255.255"
argument_list|,
literal|"ntp"
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"getaddrinfo failed with %s"
argument_list|,
name|gai_strerror
argument_list|(
name|rval
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|everywhere
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|hints
operator|.
name|ai_family
operator|=
name|AF_INET6
expr_stmt|;
name|hints
operator|.
name|ai_flags
operator|=
name|AI_PASSIVE
expr_stmt|;
name|rval
operator|=
name|getaddrinfo
argument_list|(
name|NULL
argument_list|,
literal|"ntp"
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"getaddrinfo failed with %s"
argument_list|,
name|gai_strerror
argument_list|(
name|rval
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|anywhere
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
comment|/* IPv6 do not have broadcast, give it loopback. */
name|hints
operator|.
name|ai_flags
operator|=
literal|0
expr_stmt|;
name|rval
operator|=
name|getaddrinfo
argument_list|(
name|NULL
argument_list|,
literal|"ntp"
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"getaddrinfo failed with %s"
argument_list|,
name|gai_strerror
argument_list|(
name|rval
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|everywhere
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|void
name|find_address
parameter_list|(
name|struct
name|in_addr
modifier|*
name|address
parameter_list|,
name|struct
name|in_addr
modifier|*
name|anywhere
parameter_list|,
name|struct
name|in_addr
modifier|*
name|everywhere
parameter_list|,
name|int
modifier|*
name|port
parameter_list|,
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|timespan
parameter_list|)
block|{
comment|/* Locate the specified NTP server and return its Internet address and port  number. */
name|unsigned
name|long
name|ipaddr
decl_stmt|;
name|struct
name|in_addr
name|nowhere
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|hostent
modifier|*
name|host
decl_stmt|;
name|struct
name|servent
modifier|*
name|service
decl_stmt|;
comment|/* Set up the reserved Internet addresses, attempting not to assume that addresses are 32 bits. */
name|local_to_address
argument_list|(
name|nowhere
argument_list|,
name|INADDR_LOOPBACK
argument_list|)
expr_stmt|;
name|local_to_address
argument_list|(
name|anywhere
argument_list|,
name|INADDR_ANY
argument_list|)
expr_stmt|;
name|local_to_address
argument_list|(
name|everywhere
argument_list|,
name|INADDR_BROADCAST
argument_list|)
expr_stmt|;
comment|/* Check the address, if any.  This assumes that the DNS is reliable, or is at least checked by someone else.  But it doesn't assume that it is accessible, so it needs to set up a timeout. */
if|if
condition|(
name|hostname
operator|==
name|NULL
condition|)
operator|*
name|address
operator|=
operator|*
name|anywhere
expr_stmt|;
else|else
block|{
if|if
condition|(
name|setjmp
argument_list|(
name|jump_buffer
argument_list|)
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"unable to set up access to NTP server %s"
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|jump_handler
argument_list|)
operator|==
name|SIG_ERR
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"unable to set up signal handler"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|timespan
argument_list|)
expr_stmt|;
comment|/* Look up the Internet name or IP number. */
if|if
condition|(
operator|!
name|isdigit
argument_list|(
name|hostname
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
name|host
operator|=
name|gethostbyname
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ipaddr
operator|=
name|inet_addr
argument_list|(
name|hostname
argument_list|)
operator|)
operator|==
operator|(
name|unsigned
name|long
operator|)
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"invalid IP number %s"
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|network_to_address
argument_list|(
name|address
argument_list|,
name|ipaddr
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|host
operator|=
name|gethostbyaddr
argument_list|(
operator|(
name|void
operator|*
operator|)
name|address
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
block|}
comment|/* Now clear the timer and check the result. */
name|clear_alarm
argument_list|()
expr_stmt|;
if|if
condition|(
name|host
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"unable to locate IP address/number"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|host
operator|->
name|h_length
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"the address does not seem to be an Internet one"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|address
operator|=
operator|*
operator|(
operator|(
expr|struct
name|in_addr
operator|*
operator|*
operator|)
name|host
operator|->
name|h_addr_list
operator|)
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|address
argument_list|,
name|nowhere
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|address
argument_list|,
name|anywhere
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
operator|==
literal|0
operator|||
name|memcmp
argument_list|(
name|address
argument_list|,
name|everywhere
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"reserved IP numbers cannot be used"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: using NTP server %s (%s)\n"
argument_list|,
name|argv0
argument_list|,
name|host
operator|->
name|h_name
argument_list|,
name|inet_ntoa
argument_list|(
operator|*
name|address
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Find out the port number (usually from /etc/services), and leave it in  network format.  This is assumed not to be obtained from a network service! Note that a port number is not assumed to be 16 bits. */
if|if
condition|(
operator|(
name|service
operator|=
name|getservbyname
argument_list|(
literal|"ntp"
argument_list|,
literal|"udp"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
operator|*
name|port
operator|=
name|service
operator|->
name|s_port
expr_stmt|;
if|if
condition|(
name|verbose
operator|>
literal|2
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Using port %d for NTP\n"
argument_list|,
name|port_to_integer
argument_list|(
operator|*
name|port
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|port
operator|=
name|NTP_PORT
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: assuming port %d for NTP - check /etc/services\n"
argument_list|,
name|argv0
argument_list|,
name|port_to_integer
argument_list|(
operator|*
name|port
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


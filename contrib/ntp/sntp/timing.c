begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  Copyright (C) 1996 N.M. Maclaren     Copyright (C) 1996 The University of Cambridge  This includes all of the code needed to handle the time.  It assumes rather more than is defined by POSIX, unfortunately.  Systems that do not have the 'X/Open' extensions may need changes. */
end_comment

begin_include
include|#
directive|include
file|"header.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_define
define|#
directive|define
name|TIMING
end_define

begin_include
include|#
directive|include
file|"kludges.h"
end_include

begin_undef
undef|#
directive|undef
name|TIMING
end_undef

begin_define
define|#
directive|define
name|MILLION_L
value|1000000l
end_define

begin_comment
comment|/* For conversion to/from timeval */
end_comment

begin_define
define|#
directive|define
name|MILLION_D
value|1.0e6
end_define

begin_comment
comment|/* Must be equal to MILLION_L */
end_comment

begin_function
name|double
name|current_time
parameter_list|(
name|double
name|offset
parameter_list|)
block|{
comment|/* Get the current UTC time in seconds since the Epoch plus an offset (usually the time from the beginning of the century to the Epoch!) */
name|struct
name|timeval
name|current
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|current
argument_list|,
name|NULL
argument_list|)
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"unable to read current machine/system time"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|offset
operator|+
name|current
operator|.
name|tv_sec
operator|+
literal|1.0e-6
operator|*
name|current
operator|.
name|tv_usec
return|;
block|}
end_function

begin_function
name|time_t
name|convert_time
parameter_list|(
name|double
name|value
parameter_list|,
name|int
modifier|*
name|millisecs
parameter_list|)
block|{
comment|/* Convert the time to the ANSI C form. */
name|time_t
name|result
init|=
operator|(
name|time_t
operator|)
name|value
decl_stmt|;
if|if
condition|(
operator|(
operator|*
name|millisecs
operator|=
call|(
name|int
call|)
argument_list|(
literal|1000.0
operator|*
operator|(
name|value
operator|-
name|result
operator|)
argument_list|)
operator|)
operator|>=
literal|1000
condition|)
block|{
operator|*
name|millisecs
operator|=
literal|0
expr_stmt|;
operator|++
name|result
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|void
name|adjust_time
parameter_list|(
name|double
name|difference
parameter_list|,
name|int
name|immediate
parameter_list|,
name|double
name|ignore
parameter_list|)
block|{
comment|/* Adjust the current UTC time.  This is portable, even if struct timeval uses an unsigned long for tv_sec. */
name|struct
name|timeval
name|old
decl_stmt|,
name|new
decl_stmt|,
name|adjust
decl_stmt|,
name|previous
decl_stmt|;
name|char
name|text
index|[
literal|40
index|]
decl_stmt|;
name|long
name|n
decl_stmt|;
comment|/* Start by converting to timeval format. Note that we have to cater for negative, unsigned values. */
if|if
condition|(
operator|(
name|n
operator|=
operator|(
name|long
operator|)
name|difference
operator|)
operator|>
name|difference
condition|)
operator|--
name|n
expr_stmt|;
name|adjust
operator|.
name|tv_sec
operator|=
name|n
expr_stmt|;
name|adjust
operator|.
name|tv_usec
operator|=
call|(
name|long
call|)
argument_list|(
name|MILLION_D
operator|*
operator|(
name|difference
operator|-
name|n
operator|)
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|old
argument_list|,
name|NULL
argument_list|)
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"unable to read machine/system time"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|new
operator|.
name|tv_sec
operator|=
name|old
operator|.
name|tv_sec
operator|+
name|adjust
operator|.
name|tv_sec
expr_stmt|;
name|new
operator|.
name|tv_usec
operator|=
operator|(
name|n
operator|=
operator|(
name|long
operator|)
name|old
operator|.
name|tv_usec
operator|+
operator|(
name|long
operator|)
name|adjust
operator|.
name|tv_usec
operator|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
block|{
name|new
operator|.
name|tv_usec
operator|+=
name|MILLION_L
expr_stmt|;
operator|--
name|new
operator|.
name|tv_sec
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n
operator|>=
name|MILLION_L
condition|)
block|{
name|new
operator|.
name|tv_usec
operator|-=
name|MILLION_L
expr_stmt|;
operator|++
name|new
operator|.
name|tv_sec
expr_stmt|;
block|}
comment|/* Now diagnose the situation if necessary, and perform the dirty deed. */
if|if
condition|(
name|verbose
operator|>
literal|2
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Times: old=(%ld,%.6ld) new=(%ld,%.6ld) adjust=(%ld,%.6ld)\n"
argument_list|,
operator|(
name|long
operator|)
name|old
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|old
operator|.
name|tv_usec
argument_list|,
operator|(
name|long
operator|)
name|new
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|new
operator|.
name|tv_usec
argument_list|,
operator|(
name|long
operator|)
name|adjust
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|adjust
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
if|if
condition|(
name|immediate
condition|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|settimeofday
argument_list|(
operator|&
name|new
argument_list|,
name|NULL
argument_list|)
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"unable to reset current system time"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|previous
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|previous
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|adjtime
argument_list|(
operator|&
name|adjust
argument_list|,
operator|&
name|previous
argument_list|)
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"unable to adjust current system time"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|previous
operator|.
name|tv_sec
operator|!=
literal|0
operator|||
name|previous
operator|.
name|tv_usec
operator|!=
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|text
argument_list|,
literal|"(%ld,%.6ld)"
argument_list|,
operator|(
name|long
operator|)
name|previous
operator|.
name|tv_sec
argument_list|,
operator|(
name|long
operator|)
name|previous
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
if|if
condition|(
name|previous
operator|.
name|tv_sec
operator|+
literal|1.0e-6
operator|*
name|previous
operator|.
name|tv_usec
operator|>
name|ignore
condition|)
name|fatal
argument_list|(
literal|0
argument_list|,
literal|"outstanding time adjustment %s"
argument_list|,
name|text
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: outstanding time adjustment %s\n"
argument_list|,
name|argv0
argument_list|,
name|text
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

end_unit


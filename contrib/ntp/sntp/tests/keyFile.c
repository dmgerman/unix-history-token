begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"fileHandlingTest.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_types.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_include
include|#
directive|include
file|"unity.h"
end_include

begin_function_decl
name|bool
name|CompareKeys
parameter_list|(
name|struct
name|key
name|expected
parameter_list|,
name|struct
name|key
name|actual
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|bool
name|CompareKeysAlternative
parameter_list|(
name|int
name|key_id
parameter_list|,
name|int
name|key_len
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|key_seq
parameter_list|,
name|struct
name|key
name|actual
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_ReadEmptyKeyFile
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_ReadASCIIKeys
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_ReadHexKeys
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_ReadKeyFileWithComments
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_ReadKeyFileWithInvalidHex
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|bool
name|CompareKeys
parameter_list|(
name|struct
name|key
name|expected
parameter_list|,
name|struct
name|key
name|actual
parameter_list|)
block|{
if|if
condition|(
name|expected
operator|.
name|key_id
operator|!=
name|actual
operator|.
name|key_id
condition|)
block|{
name|printf
argument_list|(
literal|"Expected key_id: %d"
argument_list|,
name|expected
operator|.
name|key_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" but was: %d\n"
argument_list|,
name|actual
operator|.
name|key_id
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|expected
operator|.
name|key_len
operator|!=
name|actual
operator|.
name|key_len
condition|)
block|{
name|printf
argument_list|(
literal|"Expected key_len: %d"
argument_list|,
name|expected
operator|.
name|key_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" but was: %d\n"
argument_list|,
name|actual
operator|.
name|key_len
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|expected
operator|.
name|type
argument_list|,
name|actual
operator|.
name|type
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Expected key_type: %s"
argument_list|,
name|expected
operator|.
name|type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" but was: %s\n"
argument_list|,
name|actual
operator|.
name|type
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|expected
operator|.
name|key_seq
argument_list|,
name|actual
operator|.
name|key_seq
argument_list|,
name|expected
operator|.
name|key_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Key mismatch!\n"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|bool
name|CompareKeysAlternative
parameter_list|(
name|int
name|key_id
parameter_list|,
name|int
name|key_len
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|key_seq
parameter_list|,
name|struct
name|key
name|actual
parameter_list|)
block|{
name|struct
name|key
name|temp
decl_stmt|;
name|temp
operator|.
name|key_id
operator|=
name|key_id
expr_stmt|;
name|temp
operator|.
name|key_len
operator|=
name|key_len
expr_stmt|;
name|strlcpy
argument_list|(
name|temp
operator|.
name|type
argument_list|,
name|type
argument_list|,
sizeof|sizeof
argument_list|(
name|temp
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|temp
operator|.
name|key_seq
argument_list|,
name|key_seq
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
return|return
name|CompareKeys
argument_list|(
name|temp
argument_list|,
name|actual
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|test_ReadEmptyKeyFile
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|key
modifier|*
name|keys
init|=
name|NULL
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|auth_init
argument_list|(
name|CreatePath
argument_list|(
literal|"key-test-empty"
argument_list|,
name|INPUT_DIR
argument_list|)
argument_list|,
operator|&
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NULL
argument_list|(
name|keys
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_ReadASCIIKeys
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|key
modifier|*
name|keys
init|=
name|NULL
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|2
argument_list|,
name|auth_init
argument_list|(
name|CreatePath
argument_list|(
literal|"key-test-ascii"
argument_list|,
name|INPUT_DIR
argument_list|)
argument_list|,
operator|&
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|keys
argument_list|)
expr_stmt|;
name|struct
name|key
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|get_key
argument_list|(
literal|40
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|CompareKeysAlternative
argument_list|(
literal|40
argument_list|,
literal|11
argument_list|,
literal|"MD5"
argument_list|,
literal|"asciikeyTwo"
argument_list|,
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
name|get_key
argument_list|(
literal|50
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|CompareKeysAlternative
argument_list|(
literal|50
argument_list|,
literal|11
argument_list|,
literal|"MD5"
argument_list|,
literal|"asciikeyOne"
argument_list|,
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_ReadHexKeys
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|key
modifier|*
name|keys
init|=
name|NULL
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|3
argument_list|,
name|auth_init
argument_list|(
name|CreatePath
argument_list|(
literal|"key-test-hex"
argument_list|,
name|INPUT_DIR
argument_list|)
argument_list|,
operator|&
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|keys
argument_list|)
expr_stmt|;
name|struct
name|key
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|get_key
argument_list|(
literal|10
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|CompareKeysAlternative
argument_list|(
literal|10
argument_list|,
literal|13
argument_list|,
literal|"MD5"
argument_list|,
literal|"\x01\x23\x45\x67\x89\xab\xcd\xef\x01\x23\x45\x67\x89"
argument_list|,
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
name|get_key
argument_list|(
literal|20
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|char
name|data1
index|[
literal|15
index|]
decl_stmt|;
name|memset
argument_list|(
name|data1
argument_list|,
literal|0x11
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|CompareKeysAlternative
argument_list|(
literal|20
argument_list|,
literal|15
argument_list|,
literal|"MD5"
argument_list|,
name|data1
argument_list|,
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
name|get_key
argument_list|(
literal|30
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|char
name|data2
index|[
literal|13
index|]
decl_stmt|;
name|memset
argument_list|(
name|data2
argument_list|,
literal|0x01
argument_list|,
literal|13
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|CompareKeysAlternative
argument_list|(
literal|30
argument_list|,
literal|13
argument_list|,
literal|"MD5"
argument_list|,
name|data2
argument_list|,
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_ReadKeyFileWithComments
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|key
modifier|*
name|keys
init|=
name|NULL
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|2
argument_list|,
name|auth_init
argument_list|(
name|CreatePath
argument_list|(
literal|"key-test-comments"
argument_list|,
name|INPUT_DIR
argument_list|)
argument_list|,
operator|&
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|keys
argument_list|)
expr_stmt|;
name|struct
name|key
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|get_key
argument_list|(
literal|10
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|char
name|data
index|[
literal|15
index|]
decl_stmt|;
name|memset
argument_list|(
name|data
argument_list|,
literal|0x01
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|CompareKeysAlternative
argument_list|(
literal|10
argument_list|,
literal|15
argument_list|,
literal|"MD5"
argument_list|,
name|data
argument_list|,
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
name|get_key
argument_list|(
literal|34
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|CompareKeysAlternative
argument_list|(
literal|34
argument_list|,
literal|3
argument_list|,
literal|"MD5"
argument_list|,
literal|"xyz"
argument_list|,
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_ReadKeyFileWithInvalidHex
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|key
modifier|*
name|keys
init|=
name|NULL
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|auth_init
argument_list|(
name|CreatePath
argument_list|(
literal|"key-test-invalid-hex"
argument_list|,
name|INPUT_DIR
argument_list|)
argument_list|,
operator|&
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|keys
argument_list|)
expr_stmt|;
name|struct
name|key
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|get_key
argument_list|(
literal|10
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_NULL
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|char
name|data
index|[
literal|15
index|]
decl_stmt|;
name|memset
argument_list|(
name|data
argument_list|,
literal|0x01
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|CompareKeysAlternative
argument_list|(
literal|10
argument_list|,
literal|15
argument_list|,
literal|"MD5"
argument_list|,
name|data
argument_list|,
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
name|get_key
argument_list|(
literal|30
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
comment|// Should not exist, and result should remain NULL.
name|TEST_ASSERT_NULL
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


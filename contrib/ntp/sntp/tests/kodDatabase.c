begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"ntp_workimpl.h"
end_include

begin_include
include|#
directive|include
file|"ntp_types.h"
end_include

begin_include
include|#
directive|include
file|"sntptest.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"sntp-opts.h"
end_include

begin_include
include|#
directive|include
file|"kod_management.h"
end_include

begin_include
include|#
directive|include
file|"ntp_io.h"
end_include

begin_include
include|#
directive|include
file|"unity.h"
end_include

begin_function_decl
name|void
name|setUp
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_SingleEntryHandling
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_MultipleEntryHandling
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_NoMatchInSearch
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_AddDuplicate
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_DeleteEntry
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|setUp
parameter_list|(
name|void
parameter_list|)
block|{
name|kod_init_kod_db
argument_list|(
literal|"/dev/null"
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|init_lib
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_SingleEntryHandling
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
name|HOST
index|[]
init|=
literal|"192.0.2.5"
decl_stmt|;
specifier|const
name|char
name|REASON
index|[]
init|=
literal|"DENY"
decl_stmt|;
name|add_entry
argument_list|(
name|HOST
argument_list|,
name|REASON
argument_list|)
expr_stmt|;
name|struct
name|kod_entry
modifier|*
name|result
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|search_entry
argument_list|(
name|HOST
argument_list|,
operator|&
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|HOST
argument_list|,
name|result
operator|->
name|hostname
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|REASON
argument_list|,
name|result
operator|->
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_MultipleEntryHandling
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
name|HOST1
index|[]
init|=
literal|"192.0.2.3"
decl_stmt|;
specifier|const
name|char
name|REASON1
index|[]
init|=
literal|"DENY"
decl_stmt|;
specifier|const
name|char
name|HOST2
index|[]
init|=
literal|"192.0.5.5"
decl_stmt|;
specifier|const
name|char
name|REASON2
index|[]
init|=
literal|"RATE"
decl_stmt|;
specifier|const
name|char
name|HOST3
index|[]
init|=
literal|"192.0.10.1"
decl_stmt|;
specifier|const
name|char
name|REASON3
index|[]
init|=
literal|"DENY"
decl_stmt|;
name|add_entry
argument_list|(
name|HOST1
argument_list|,
name|REASON1
argument_list|)
expr_stmt|;
name|add_entry
argument_list|(
name|HOST2
argument_list|,
name|REASON2
argument_list|)
expr_stmt|;
name|add_entry
argument_list|(
name|HOST3
argument_list|,
name|REASON3
argument_list|)
expr_stmt|;
name|struct
name|kod_entry
modifier|*
name|result
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|search_entry
argument_list|(
name|HOST1
argument_list|,
operator|&
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|HOST1
argument_list|,
name|result
operator|->
name|hostname
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|REASON1
argument_list|,
name|result
operator|->
name|type
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|search_entry
argument_list|(
name|HOST2
argument_list|,
operator|&
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|HOST2
argument_list|,
name|result
operator|->
name|hostname
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|REASON2
argument_list|,
name|result
operator|->
name|type
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|search_entry
argument_list|(
name|HOST3
argument_list|,
operator|&
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|HOST3
argument_list|,
name|result
operator|->
name|hostname
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|REASON3
argument_list|,
name|result
operator|->
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_NoMatchInSearch
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
name|HOST_ADD
index|[]
init|=
literal|"192.0.2.6"
decl_stmt|;
specifier|const
name|char
name|HOST_NOTADD
index|[]
init|=
literal|"192.0.6.1"
decl_stmt|;
specifier|const
name|char
name|REASON
index|[]
init|=
literal|"DENY"
decl_stmt|;
name|add_entry
argument_list|(
name|HOST_ADD
argument_list|,
name|REASON
argument_list|)
expr_stmt|;
name|struct
name|kod_entry
modifier|*
name|result
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|search_entry
argument_list|(
name|HOST_NOTADD
argument_list|,
operator|&
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|result
operator|==
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_AddDuplicate
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
name|HOST
index|[]
init|=
literal|"192.0.2.3"
decl_stmt|;
specifier|const
name|char
name|REASON1
index|[]
init|=
literal|"RATE"
decl_stmt|;
specifier|const
name|char
name|REASON2
index|[]
init|=
literal|"DENY"
decl_stmt|;
name|add_entry
argument_list|(
name|HOST
argument_list|,
name|REASON1
argument_list|)
expr_stmt|;
name|struct
name|kod_entry
modifier|*
name|result1
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|search_entry
argument_list|(
name|HOST
argument_list|,
operator|&
name|result1
argument_list|)
argument_list|)
expr_stmt|;
comment|/*  	 * Sleeps for two seconds since we want to ensure that 	 * the timestamp is updated to a new value. 	 */
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|add_entry
argument_list|(
name|HOST
argument_list|,
name|REASON2
argument_list|)
expr_stmt|;
name|struct
name|kod_entry
modifier|*
name|result2
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|search_entry
argument_list|(
name|HOST
argument_list|,
operator|&
name|result2
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_FALSE
argument_list|(
name|result1
operator|->
name|timestamp
operator|==
name|result2
operator|->
name|timestamp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|result1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|result2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_DeleteEntry
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
name|HOST1
index|[]
init|=
literal|"192.0.2.1"
decl_stmt|;
specifier|const
name|char
name|HOST2
index|[]
init|=
literal|"192.0.2.2"
decl_stmt|;
specifier|const
name|char
name|HOST3
index|[]
init|=
literal|"192.0.2.3"
decl_stmt|;
specifier|const
name|char
name|REASON
index|[]
init|=
literal|"DENY"
decl_stmt|;
name|add_entry
argument_list|(
name|HOST1
argument_list|,
name|REASON
argument_list|)
expr_stmt|;
name|add_entry
argument_list|(
name|HOST2
argument_list|,
name|REASON
argument_list|)
expr_stmt|;
name|add_entry
argument_list|(
name|HOST3
argument_list|,
name|REASON
argument_list|)
expr_stmt|;
name|struct
name|kod_entry
modifier|*
name|result
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|search_entry
argument_list|(
name|HOST2
argument_list|,
operator|&
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|result
argument_list|)
expr_stmt|;
name|delete_entry
argument_list|(
name|HOST2
argument_list|,
name|REASON
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|search_entry
argument_list|(
name|HOST2
argument_list|,
operator|&
name|result
argument_list|)
argument_list|)
expr_stmt|;
comment|// Ensure that the other entry is still there.
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|search_entry
argument_list|(
name|HOST1
argument_list|,
operator|&
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"unity.h"
end_include

begin_include
include|#
directive|include
file|"ntp_types.h"
end_include

begin_include
include|#
directive|include
file|"sntptest.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_define
define|#
directive|define
name|MD5_LENGTH
value|16
end_define

begin_define
define|#
directive|define
name|SHA1_LENGTH
value|20
end_define

begin_function_decl
name|void
name|test_MakeMd5Mac
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_MakeSHA1Mac
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_VerifyCorrectMD5
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_VerifySHA1
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_VerifyFailure
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_PacketSizeNotMultipleOfFourBytes
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|test_MakeMd5Mac
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|PKT_DATA
init|=
literal|"abcdefgh0123"
decl_stmt|;
specifier|const
name|int
name|PKT_LEN
init|=
name|strlen
argument_list|(
name|PKT_DATA
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|EXPECTED_DIGEST
init|=
literal|"\x52\x6c\xb8\x38\xaf\x06\x5a\xfb\x6c\x98\xbb\xc0\x9b\x0a\x7a\x1b"
decl_stmt|;
name|char
name|actual
index|[
name|MD5_LENGTH
index|]
decl_stmt|;
name|struct
name|key
name|md5
decl_stmt|;
name|md5
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|md5
operator|.
name|key_id
operator|=
literal|10
expr_stmt|;
name|md5
operator|.
name|key_len
operator|=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|md5
operator|.
name|key_seq
argument_list|,
literal|"md5seq"
argument_list|,
name|md5
operator|.
name|key_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|md5
operator|.
name|type
argument_list|,
literal|"MD5"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|MD5_LENGTH
argument_list|,
name|make_mac
argument_list|(
name|PKT_DATA
argument_list|,
name|PKT_LEN
argument_list|,
name|MD5_LENGTH
argument_list|,
operator|&
name|md5
argument_list|,
name|actual
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|memcmp
argument_list|(
name|EXPECTED_DIGEST
argument_list|,
name|actual
argument_list|,
name|MD5_LENGTH
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_MakeSHA1Mac
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|OPENSSL
specifier|const
name|char
modifier|*
name|PKT_DATA
init|=
literal|"abcdefgh0123"
decl_stmt|;
specifier|const
name|int
name|PKT_LEN
init|=
name|strlen
argument_list|(
name|PKT_DATA
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|EXPECTED_DIGEST
init|=
literal|"\x17\xaa\x82\x97\xc7\x17\x13\x6a\x9b\xa9"
literal|"\x63\x85\xb4\xce\xbe\x94\xa0\x97\x16\x1d"
decl_stmt|;
name|char
name|actual
index|[
name|SHA1_LENGTH
index|]
decl_stmt|;
name|struct
name|key
name|sha1
decl_stmt|;
name|sha1
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|sha1
operator|.
name|key_id
operator|=
literal|20
expr_stmt|;
name|sha1
operator|.
name|key_len
operator|=
literal|7
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sha1
operator|.
name|key_seq
argument_list|,
literal|"sha1seq"
argument_list|,
name|sha1
operator|.
name|key_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sha1
operator|.
name|type
argument_list|,
literal|"SHA1"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|SHA1_LENGTH
argument_list|,
name|make_mac
argument_list|(
name|PKT_DATA
argument_list|,
name|PKT_LEN
argument_list|,
name|SHA1_LENGTH
argument_list|,
operator|&
name|sha1
argument_list|,
name|actual
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_MEMORY
argument_list|(
name|EXPECTED_DIGEST
argument_list|,
name|actual
argument_list|,
name|SHA1_LENGTH
argument_list|)
expr_stmt|;
else|#
directive|else
name|TEST_IGNORE_MESSAGE
argument_list|(
literal|"OpenSSL not found, skipping..."
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL */
block|}
end_function

begin_function
name|void
name|test_VerifyCorrectMD5
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|PKT_DATA
init|=
literal|"sometestdata"
comment|/* Data */
literal|"\0\0\0\0"
comment|/* Key-ID (unused) */
literal|"\xc7\x58\x99\xdd\x99\x32\x0f\x71"
comment|/* MAC */
literal|"\x2b\x7b\xfe\x4f\xa2\x32\xcf\xac"
decl_stmt|;
specifier|const
name|int
name|PKT_LEN
init|=
literal|12
decl_stmt|;
name|struct
name|key
name|md5
decl_stmt|;
name|md5
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|md5
operator|.
name|key_id
operator|=
literal|0
expr_stmt|;
name|md5
operator|.
name|key_len
operator|=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|md5
operator|.
name|key_seq
argument_list|,
literal|"md5key"
argument_list|,
name|md5
operator|.
name|key_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|md5
operator|.
name|type
argument_list|,
literal|"MD5"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|auth_md5
argument_list|(
name|PKT_DATA
argument_list|,
name|PKT_LEN
argument_list|,
name|MD5_LENGTH
argument_list|,
operator|&
name|md5
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_VerifySHA1
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|OPENSSL
specifier|const
name|char
modifier|*
name|PKT_DATA
init|=
literal|"sometestdata"
comment|/* Data */
literal|"\0\0\0\0"
comment|/* Key-ID (unused) */
literal|"\xad\x07\xde\x36\x39\xa6\x77\xfa\x5b\xce"
comment|/* MAC */
literal|"\x2d\x8a\x7d\x06\x96\xe6\x0c\xbc\xed\xe1"
decl_stmt|;
specifier|const
name|int
name|PKT_LEN
init|=
literal|12
decl_stmt|;
name|struct
name|key
name|sha1
decl_stmt|;
name|sha1
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|sha1
operator|.
name|key_id
operator|=
literal|0
expr_stmt|;
name|sha1
operator|.
name|key_len
operator|=
literal|7
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sha1
operator|.
name|key_seq
argument_list|,
literal|"sha1key"
argument_list|,
name|sha1
operator|.
name|key_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sha1
operator|.
name|type
argument_list|,
literal|"SHA1"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|auth_md5
argument_list|(
name|PKT_DATA
argument_list|,
name|PKT_LEN
argument_list|,
name|SHA1_LENGTH
argument_list|,
operator|&
name|sha1
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|TEST_IGNORE_MESSAGE
argument_list|(
literal|"OpenSSL not found, skipping..."
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL */
block|}
end_function

begin_function
name|void
name|test_VerifyFailure
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* We use a copy of the MD5 verification code, but modify the 	 * last bit to make sure verification fails. 	 */
specifier|const
name|char
modifier|*
name|PKT_DATA
init|=
literal|"sometestdata"
comment|/* Data */
literal|"\0\0\0\0"
comment|/* Key-ID (unused) */
literal|"\xc7\x58\x99\xdd\x99\x32\x0f\x71"
comment|/* MAC */
literal|"\x2b\x7b\xfe\x4f\xa2\x32\xcf\x00"
decl_stmt|;
comment|/* Last byte is wrong! */
specifier|const
name|int
name|PKT_LEN
init|=
literal|12
decl_stmt|;
name|struct
name|key
name|md5
decl_stmt|;
name|md5
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|md5
operator|.
name|key_id
operator|=
literal|0
expr_stmt|;
name|md5
operator|.
name|key_len
operator|=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|md5
operator|.
name|key_seq
argument_list|,
literal|"md5key"
argument_list|,
name|md5
operator|.
name|key_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|md5
operator|.
name|type
argument_list|,
literal|"MD5"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|TEST_ASSERT_FALSE
argument_list|(
name|auth_md5
argument_list|(
name|PKT_DATA
argument_list|,
name|PKT_LEN
argument_list|,
name|MD5_LENGTH
argument_list|,
operator|&
name|md5
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_PacketSizeNotMultipleOfFourBytes
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|PKT_DATA
init|=
literal|"123456"
decl_stmt|;
specifier|const
name|int
name|PKT_LEN
init|=
literal|6
decl_stmt|;
name|char
name|actual
index|[
name|MD5_LENGTH
index|]
decl_stmt|;
name|struct
name|key
name|md5
decl_stmt|;
name|md5
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|md5
operator|.
name|key_id
operator|=
literal|10
expr_stmt|;
name|md5
operator|.
name|key_len
operator|=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|md5
operator|.
name|key_seq
argument_list|,
literal|"md5seq"
argument_list|,
name|md5
operator|.
name|key_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|md5
operator|.
name|type
argument_list|,
literal|"MD5"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|make_mac
argument_list|(
name|PKT_DATA
argument_list|,
name|PKT_LEN
argument_list|,
name|MD5_LENGTH
argument_list|,
operator|&
name|md5
argument_list|,
name|actual
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


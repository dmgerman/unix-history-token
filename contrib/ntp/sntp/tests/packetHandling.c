begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"ntp_debug.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_types.h"
end_include

begin_include
include|#
directive|include
file|"sntptest.h"
end_include

begin_include
include|#
directive|include
file|"kod_management.h"
end_include

begin_include
include|#
directive|include
file|"main.h"
end_include

begin_include
include|#
directive|include
file|"networking.h"
end_include

begin_include
include|#
directive|include
file|"ntp.h"
end_include

begin_include
include|#
directive|include
file|"unity.h"
end_include

begin_function_decl
name|void
name|setUp
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|LfpEquality
parameter_list|(
specifier|const
name|l_fp
name|expected
parameter_list|,
specifier|const
name|l_fp
name|actual
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_GenerateUnauthenticatedPacket
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_GenerateAuthenticatedPacket
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_OffsetCalculationPositiveOffset
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_OffsetCalculationNegativeOffset
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_HandleUnusableServer
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_HandleUnusablePacket
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_HandleServerAuthenticationFailure
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_HandleKodDemobilize
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_HandleKodRate
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_HandleCorrectPacket
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|setUp
parameter_list|(
name|void
parameter_list|)
block|{
name|init_lib
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|LfpEquality
parameter_list|(
specifier|const
name|l_fp
name|expected
parameter_list|,
specifier|const
name|l_fp
name|actual
parameter_list|)
block|{
if|if
condition|(
name|L_ISEQU
argument_list|(
operator|&
name|expected
argument_list|,
operator|&
name|actual
argument_list|)
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|void
name|test_GenerateUnauthenticatedPacket
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pkt
name|testpkt
decl_stmt|;
name|struct
name|timeval
name|xmt
decl_stmt|;
name|GETTIMEOFDAY
argument_list|(
operator|&
name|xmt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xmt
operator|.
name|tv_sec
operator|+=
name|JAN_1970
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LEN_PKT_NOMAC
argument_list|,
name|generate_pkt
argument_list|(
operator|&
name|testpkt
argument_list|,
operator|&
name|xmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LEAP_NOTINSYNC
argument_list|,
name|PKT_LEAP
argument_list|(
name|testpkt
operator|.
name|li_vn_mode
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|NTP_VERSION
argument_list|,
name|PKT_VERSION
argument_list|(
name|testpkt
operator|.
name|li_vn_mode
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|MODE_CLIENT
argument_list|,
name|PKT_MODE
argument_list|(
name|testpkt
operator|.
name|li_vn_mode
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|STRATUM_UNSPEC
argument_list|,
name|PKT_TO_STRATUM
argument_list|(
name|testpkt
operator|.
name|stratum
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|8
argument_list|,
name|testpkt
operator|.
name|ppoll
argument_list|)
expr_stmt|;
name|l_fp
name|expected_xmt
decl_stmt|,
name|actual_xmt
decl_stmt|;
name|TVTOTS
argument_list|(
operator|&
name|xmt
argument_list|,
operator|&
name|expected_xmt
argument_list|)
expr_stmt|;
name|NTOHL_FP
argument_list|(
operator|&
name|testpkt
operator|.
name|xmt
argument_list|,
operator|&
name|actual_xmt
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|LfpEquality
argument_list|(
name|expected_xmt
argument_list|,
name|actual_xmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_GenerateAuthenticatedPacket
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|key
name|testkey
decl_stmt|;
name|testkey
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|testkey
operator|.
name|key_id
operator|=
literal|30
expr_stmt|;
name|testkey
operator|.
name|key_len
operator|=
literal|9
expr_stmt|;
name|memcpy
argument_list|(
name|testkey
operator|.
name|key_seq
argument_list|,
literal|"123456789"
argument_list|,
name|testkey
operator|.
name|key_len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|testkey
operator|.
name|type
argument_list|,
literal|"MD5"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|struct
name|pkt
name|testpkt
decl_stmt|;
name|struct
name|timeval
name|xmt
decl_stmt|;
name|GETTIMEOFDAY
argument_list|(
operator|&
name|xmt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xmt
operator|.
name|tv_sec
operator|+=
name|JAN_1970
expr_stmt|;
specifier|const
name|int
name|EXPECTED_PKTLEN
init|=
name|LEN_PKT_NOMAC
operator|+
name|MAX_MD5_LEN
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|EXPECTED_PKTLEN
argument_list|,
name|generate_pkt
argument_list|(
operator|&
name|testpkt
argument_list|,
operator|&
name|xmt
argument_list|,
name|testkey
operator|.
name|key_id
argument_list|,
operator|&
name|testkey
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LEAP_NOTINSYNC
argument_list|,
name|PKT_LEAP
argument_list|(
name|testpkt
operator|.
name|li_vn_mode
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|NTP_VERSION
argument_list|,
name|PKT_VERSION
argument_list|(
name|testpkt
operator|.
name|li_vn_mode
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|MODE_CLIENT
argument_list|,
name|PKT_MODE
argument_list|(
name|testpkt
operator|.
name|li_vn_mode
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|STRATUM_UNSPEC
argument_list|,
name|PKT_TO_STRATUM
argument_list|(
name|testpkt
operator|.
name|stratum
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|8
argument_list|,
name|testpkt
operator|.
name|ppoll
argument_list|)
expr_stmt|;
name|l_fp
name|expected_xmt
decl_stmt|,
name|actual_xmt
decl_stmt|;
name|TVTOTS
argument_list|(
operator|&
name|xmt
argument_list|,
operator|&
name|expected_xmt
argument_list|)
expr_stmt|;
name|NTOHL_FP
argument_list|(
operator|&
name|testpkt
operator|.
name|xmt
argument_list|,
operator|&
name|actual_xmt
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|LfpEquality
argument_list|(
name|expected_xmt
argument_list|,
name|actual_xmt
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|testkey
operator|.
name|key_id
argument_list|,
name|ntohl
argument_list|(
name|testpkt
operator|.
name|exten
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|char
name|expected_mac
index|[
name|MAX_MD5_LEN
index|]
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|MAX_MD5_LEN
operator|-
literal|4
argument_list|,
comment|// Remove the key_id, only keep the mac.
name|make_mac
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|testpkt
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
name|MAX_MD5_LEN
argument_list|,
operator|&
name|testkey
argument_list|,
name|expected_mac
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_MEMORY
argument_list|(
name|expected_mac
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|testpkt
operator|.
name|exten
index|[
literal|1
index|]
argument_list|,
name|MAX_MD5_LEN
operator|-
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_OffsetCalculationPositiveOffset
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pkt
name|rpkt
decl_stmt|;
name|rpkt
operator|.
name|precision
operator|=
operator|-
literal|16
expr_stmt|;
comment|// 0,000015259
name|rpkt
operator|.
name|rootdelay
operator|=
name|HTONS_FP
argument_list|(
name|DTOUFP
argument_list|(
literal|0.125
argument_list|)
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|rootdisp
operator|=
name|HTONS_FP
argument_list|(
name|DTOUFP
argument_list|(
literal|0.25
argument_list|)
argument_list|)
expr_stmt|;
comment|// Synch Distance: (0.125+0.25)/2.0 == 0.1875
name|l_fp
name|reftime
decl_stmt|;
name|get_systime
argument_list|(
operator|&
name|reftime
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|reftime
argument_list|,
operator|&
name|rpkt
operator|.
name|reftime
argument_list|)
expr_stmt|;
name|l_fp
name|tmp
decl_stmt|;
comment|// T1 - Originate timestamp
name|tmp
operator|.
name|l_ui
operator|=
literal|1000000000UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|0UL
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|rpkt
operator|.
name|org
argument_list|)
expr_stmt|;
comment|// T2 - Receive timestamp
name|tmp
operator|.
name|l_ui
operator|=
literal|1000000001UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|2147483648UL
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|rpkt
operator|.
name|rec
argument_list|)
expr_stmt|;
comment|// T3 - Transmit timestamp
name|tmp
operator|.
name|l_ui
operator|=
literal|1000000002UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|0UL
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|rpkt
operator|.
name|xmt
argument_list|)
expr_stmt|;
comment|// T4 - Destination timestamp as standard timeval
name|tmp
operator|.
name|l_ui
operator|=
literal|1000000001UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|0UL
expr_stmt|;
name|struct
name|timeval
name|dst
decl_stmt|;
name|TSTOTV
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|.
name|tv_sec
operator|-=
name|JAN_1970
expr_stmt|;
name|double
name|offset
decl_stmt|,
name|precision
decl_stmt|,
name|synch_distance
decl_stmt|;
name|offset_calculation
argument_list|(
operator|&
name|rpkt
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|offset
argument_list|,
operator|&
name|precision
argument_list|,
operator|&
name|synch_distance
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_DOUBLE
argument_list|(
literal|1.25
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_DOUBLE
argument_list|(
literal|1.
operator|/
name|ULOGTOD
argument_list|(
literal|16
argument_list|)
argument_list|,
name|precision
argument_list|)
expr_stmt|;
comment|// 1.1250150000000001 ?
name|TEST_ASSERT_EQUAL_DOUBLE
argument_list|(
literal|1.125015
argument_list|,
name|synch_distance
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_OffsetCalculationNegativeOffset
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pkt
name|rpkt
decl_stmt|;
name|rpkt
operator|.
name|precision
operator|=
operator|-
literal|1
expr_stmt|;
name|rpkt
operator|.
name|rootdelay
operator|=
name|HTONS_FP
argument_list|(
name|DTOUFP
argument_list|(
literal|0.5
argument_list|)
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|rootdisp
operator|=
name|HTONS_FP
argument_list|(
name|DTOUFP
argument_list|(
literal|0.5
argument_list|)
argument_list|)
expr_stmt|;
comment|// Synch Distance is (0.5+0.5)/2.0, or 0.5
name|l_fp
name|reftime
decl_stmt|;
name|get_systime
argument_list|(
operator|&
name|reftime
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|reftime
argument_list|,
operator|&
name|rpkt
operator|.
name|reftime
argument_list|)
expr_stmt|;
name|l_fp
name|tmp
decl_stmt|;
comment|// T1 - Originate timestamp
name|tmp
operator|.
name|l_ui
operator|=
literal|1000000001UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|0UL
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|rpkt
operator|.
name|org
argument_list|)
expr_stmt|;
comment|// T2 - Receive timestamp
name|tmp
operator|.
name|l_ui
operator|=
literal|1000000000UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|2147483648UL
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|rpkt
operator|.
name|rec
argument_list|)
expr_stmt|;
comment|// T3 - Transmit timestamp
name|tmp
operator|.
name|l_ui
operator|=
literal|1000000001UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|2147483648UL
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|rpkt
operator|.
name|xmt
argument_list|)
expr_stmt|;
comment|// T4 - Destination timestamp as standard timeval
name|tmp
operator|.
name|l_ui
operator|=
literal|1000000003UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|0UL
expr_stmt|;
name|struct
name|timeval
name|dst
decl_stmt|;
name|TSTOTV
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|.
name|tv_sec
operator|-=
name|JAN_1970
expr_stmt|;
name|double
name|offset
decl_stmt|,
name|precision
decl_stmt|,
name|synch_distance
decl_stmt|;
name|offset_calculation
argument_list|(
operator|&
name|rpkt
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|offset
argument_list|,
operator|&
name|precision
argument_list|,
operator|&
name|synch_distance
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_DOUBLE
argument_list|(
operator|-
literal|1
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_DOUBLE
argument_list|(
literal|1.
operator|/
name|ULOGTOD
argument_list|(
literal|1
argument_list|)
argument_list|,
name|precision
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_DOUBLE
argument_list|(
literal|1.3333483333333334
argument_list|,
name|synch_distance
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_HandleUnusableServer
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pkt
name|rpkt
decl_stmt|;
name|sockaddr_u
name|host
decl_stmt|;
name|int
name|rpktl
decl_stmt|;
name|ZERO
argument_list|(
name|rpkt
argument_list|)
expr_stmt|;
name|ZERO
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|rpktl
operator|=
name|SERVER_UNUSEABLE
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
operator|-
literal|1
argument_list|,
name|handle_pkt
argument_list|(
name|rpktl
argument_list|,
operator|&
name|rpkt
argument_list|,
operator|&
name|host
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_HandleUnusablePacket
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pkt
name|rpkt
decl_stmt|;
name|sockaddr_u
name|host
decl_stmt|;
name|int
name|rpktl
decl_stmt|;
name|ZERO
argument_list|(
name|rpkt
argument_list|)
expr_stmt|;
name|ZERO
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|rpktl
operator|=
name|PACKET_UNUSEABLE
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|handle_pkt
argument_list|(
name|rpktl
argument_list|,
operator|&
name|rpkt
argument_list|,
operator|&
name|host
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_HandleServerAuthenticationFailure
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pkt
name|rpkt
decl_stmt|;
name|sockaddr_u
name|host
decl_stmt|;
name|int
name|rpktl
decl_stmt|;
name|ZERO
argument_list|(
name|rpkt
argument_list|)
expr_stmt|;
name|ZERO
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|rpktl
operator|=
name|SERVER_AUTH_FAIL
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|handle_pkt
argument_list|(
name|rpktl
argument_list|,
operator|&
name|rpkt
argument_list|,
operator|&
name|host
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_HandleKodDemobilize
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|HOSTNAME
init|=
literal|"192.0.2.1"
decl_stmt|;
specifier|const
name|char
modifier|*
name|REASON
init|=
literal|"DENY"
decl_stmt|;
name|struct
name|pkt
name|rpkt
decl_stmt|;
name|sockaddr_u
name|host
decl_stmt|;
name|int
name|rpktl
decl_stmt|;
name|struct
name|kod_entry
modifier|*
name|entry
decl_stmt|;
name|rpktl
operator|=
name|KOD_DEMOBILIZE
expr_stmt|;
name|ZERO
argument_list|(
name|rpkt
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|rpkt
operator|.
name|refid
argument_list|,
name|REASON
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ZERO
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|host
operator|.
name|sa4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|host
operator|.
name|sa4
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|inet_addr
argument_list|(
name|HOSTNAME
argument_list|)
expr_stmt|;
comment|// Test that the KOD-entry is added to the database.
name|kod_init_kod_db
argument_list|(
literal|"/dev/null"
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|handle_pkt
argument_list|(
name|rpktl
argument_list|,
operator|&
name|rpkt
argument_list|,
operator|&
name|host
argument_list|,
name|HOSTNAME
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|search_entry
argument_list|(
name|HOSTNAME
argument_list|,
operator|&
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_MEMORY
argument_list|(
name|REASON
argument_list|,
name|entry
operator|->
name|type
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_HandleKodRate
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pkt
name|rpkt
decl_stmt|;
name|sockaddr_u
name|host
decl_stmt|;
name|int
name|rpktl
decl_stmt|;
name|ZERO
argument_list|(
name|rpkt
argument_list|)
expr_stmt|;
name|ZERO
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|rpktl
operator|=
name|KOD_RATE
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|handle_pkt
argument_list|(
name|rpktl
argument_list|,
operator|&
name|rpkt
argument_list|,
operator|&
name|host
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_HandleCorrectPacket
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pkt
name|rpkt
decl_stmt|;
name|sockaddr_u
name|host
decl_stmt|;
name|int
name|rpktl
decl_stmt|;
name|l_fp
name|now
decl_stmt|;
comment|// We don't want our testing code to actually change the system clock.
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|STEP
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|SLEW
argument_list|)
argument_list|)
expr_stmt|;
name|get_systime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|rpkt
operator|.
name|reftime
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|rpkt
operator|.
name|org
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|rpkt
operator|.
name|rec
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|rpkt
operator|.
name|xmt
argument_list|)
expr_stmt|;
name|rpktl
operator|=
name|LEN_PKT_NOMAC
expr_stmt|;
name|ZERO
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|AF
argument_list|(
operator|&
name|host
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|handle_pkt
argument_list|(
name|rpktl
argument_list|,
operator|&
name|rpkt
argument_list|,
operator|&
name|host
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* packetHandling.c */
end_comment

end_unit


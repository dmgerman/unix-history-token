begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"sntptest.h"
end_include

begin_include
include|#
directive|include
file|"networking.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"unity.h"
end_include

begin_decl_stmt
specifier|const
name|char
modifier|*
name|Version
init|=
literal|"stub unit test Version string"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Hacks into the key database. */
end_comment

begin_decl_stmt
specifier|extern
name|struct
name|key
modifier|*
name|key_ptr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|key_cnt
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|PrepareAuthenticationTest
parameter_list|(
name|int
name|key_id
parameter_list|,
name|int
name|key_len
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|key_seq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|PrepareAuthenticationTestMD5
parameter_list|(
name|int
name|key_id
parameter_list|,
name|int
name|key_len
parameter_list|,
specifier|const
name|void
modifier|*
name|key_seq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|setUp
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|tearDown
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_TooShortLength
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_LengthNotMultipleOfFour
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_TooShortExtensionFieldLength
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_UnauthenticatedPacketReject
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_CryptoNAKPacketReject
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_AuthenticatedPacketInvalid
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_AuthenticatedPacketUnknownKey
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_ServerVersionTooOld
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_ServerVersionTooNew
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_NonWantedMode
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_KoDRate
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_KoDDeny
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_RejectUnsyncedServer
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_RejectWrongResponseServerMode
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_AcceptNoSentPacketBroadcastMode
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_CorrectUnauthenticatedPacket
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_CorrectAuthenticatedPacketMD5
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_CorrectAuthenticatedPacketSHA1
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* [Bug 2998] There are some issues whith the definition of 'struct pkt'  * when AUTOKEY is undefined -- the formal struct is too small to hold  * all the extension fields that are going to be tested. We have to make  * sure we have the extra bytes, or the test yield undefined results due  * to buffer overrun.   */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|AUTOKEY
end_ifndef

begin_define
define|#
directive|define
name|EXTRA_BUFSIZE
value|256
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|EXTRA_BUFSIZE
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_union
union|union
name|tpkt
block|{
name|struct
name|pkt
name|p
decl_stmt|;
name|u_char
name|b
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|pkt
argument_list|)
operator|+
name|EXTRA_BUFSIZE
index|]
decl_stmt|;
block|}
union|;
end_union

begin_decl_stmt
specifier|static
name|union
name|tpkt
name|testpkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|union
name|tpkt
name|testspkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sockaddr_u
name|testsock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|bool
name|restoreKeyDb
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|PrepareAuthenticationTest
parameter_list|(
name|int
name|key_id
parameter_list|,
name|int
name|key_len
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|key_seq
parameter_list|)
block|{
name|char
name|str
index|[
literal|25
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|str
argument_list|,
literal|25
argument_list|,
literal|"%d"
argument_list|,
name|key_id
argument_list|)
expr_stmt|;
name|ActivateOption
argument_list|(
literal|"-a"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|key_cnt
operator|=
literal|1
expr_stmt|;
name|key_ptr
operator|=
name|emalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|key_ptr
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|key_ptr
operator|->
name|key_id
operator|=
name|key_id
expr_stmt|;
name|key_ptr
operator|->
name|key_len
operator|=
name|key_len
expr_stmt|;
name|memcpy
argument_list|(
name|key_ptr
operator|->
name|type
argument_list|,
literal|"MD5"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|key_len
operator|<
sizeof|sizeof
argument_list|(
name|key_ptr
operator|->
name|key_seq
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|key_ptr
operator|->
name|key_seq
argument_list|,
name|key_seq
argument_list|,
name|key_ptr
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|restoreKeyDb
operator|=
name|true
expr_stmt|;
block|}
end_function

begin_function
name|void
name|PrepareAuthenticationTestMD5
parameter_list|(
name|int
name|key_id
parameter_list|,
name|int
name|key_len
parameter_list|,
specifier|const
name|void
modifier|*
name|key_seq
parameter_list|)
block|{
name|PrepareAuthenticationTest
argument_list|(
name|key_id
argument_list|,
name|key_len
argument_list|,
literal|"MD5"
argument_list|,
name|key_seq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setUp
parameter_list|(
name|void
parameter_list|)
block|{
name|sntptest
argument_list|()
expr_stmt|;
name|restoreKeyDb
operator|=
name|false
expr_stmt|;
comment|/* Initialize the test packet and socket, 	 * so they contain at least some valid data. 	 */
name|testpkt
operator|.
name|p
operator|.
name|li_vn_mode
operator|=
name|PKT_LI_VN_MODE
argument_list|(
name|LEAP_NOWARNING
argument_list|,
name|NTP_VERSION
argument_list|,
name|MODE_SERVER
argument_list|)
expr_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|stratum
operator|=
name|STRATUM_REFCLOCK
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|testpkt
operator|.
name|p
operator|.
name|refid
argument_list|,
literal|"GPS\0"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Set the origin timestamp of the received packet to the 	 * same value as the transmit timestamp of the sent packet. 	 */
name|l_fp
name|tmp
decl_stmt|;
name|tmp
operator|.
name|l_ui
operator|=
literal|1000UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|0UL
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|testpkt
operator|.
name|p
operator|.
name|org
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|testspkt
operator|.
name|p
operator|.
name|xmt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tearDown
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|restoreKeyDb
condition|)
block|{
name|key_cnt
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|key_ptr
argument_list|)
expr_stmt|;
name|key_ptr
operator|=
name|NULL
expr_stmt|;
block|}
name|sntptest_destroy
argument_list|()
expr_stmt|;
comment|/* only on the final test!! if counter == 0 etc... */
block|}
end_function

begin_function
name|void
name|test_TooShortLength
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_EQUAL
argument_list|(
name|PACKET_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
operator|-
literal|1
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|PACKET_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
operator|-
literal|1
argument_list|,
name|MODE_BROADCAST
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_LengthNotMultipleOfFour
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_EQUAL
argument_list|(
name|PACKET_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
operator|+
literal|6
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|PACKET_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
operator|+
literal|3
argument_list|,
name|MODE_BROADCAST
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_TooShortExtensionFieldLength
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* [Bug 2998] We have to get around the formal specification of 	 * the extension field if AUTOKEY is undefined. (At least CLANG 	 * issues a warning in this case. It's just a warning, but 	 * still... 	 */
name|uint32_t
modifier|*
name|pe
init|=
name|testpkt
operator|.
name|p
operator|.
name|exten
operator|+
literal|7
decl_stmt|;
comment|/* The lower 16-bits are the length of the extension field. 	 * This lengths must be multiples of 4 bytes, which gives 	 * a minimum of 4 byte extension field length. 	 */
operator|*
name|pe
operator|=
name|htonl
argument_list|(
literal|3
argument_list|)
expr_stmt|;
comment|/* 3 bytes is too short. */
comment|/* We send in a pkt_len of header size + 4 byte extension 	 * header + 24 byte MAC, this prevents the length error to 	 * be caught at an earlier stage 	 */
name|int
name|pkt_len
init|=
name|LEN_PKT_NOMAC
operator|+
literal|4
operator|+
literal|24
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|PACKET_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|pkt_len
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_UnauthenticatedPacketReject
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Activate authentication option */
name|ActivateOption
argument_list|(
literal|"-a"
argument_list|,
literal|"123"
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|pkt_len
init|=
name|LEN_PKT_NOMAC
decl_stmt|;
comment|/* We demand authentication, but no MAC header is present. */
name|TEST_ASSERT_EQUAL
argument_list|(
name|SERVER_AUTH_FAIL
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|pkt_len
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_CryptoNAKPacketReject
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Activate authentication option */
name|ActivateOption
argument_list|(
literal|"-a"
argument_list|,
literal|"123"
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|pkt_len
init|=
name|LEN_PKT_NOMAC
operator|+
literal|4
decl_stmt|;
comment|/* + 4 byte MAC = Crypto-NAK */
name|TEST_ASSERT_EQUAL
argument_list|(
name|SERVER_AUTH_FAIL
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|pkt_len
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_AuthenticatedPacketInvalid
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Activate authentication option */
name|PrepareAuthenticationTestMD5
argument_list|(
literal|50
argument_list|,
literal|9
argument_list|,
literal|"123456789"
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Prepare the packet. */
name|int
name|pkt_len
init|=
name|LEN_PKT_NOMAC
decl_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|exten
index|[
literal|0
index|]
operator|=
name|htonl
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|int
name|mac_len
init|=
name|make_mac
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
name|pkt_len
argument_list|,
name|MAX_MD5_LEN
argument_list|,
name|key_ptr
argument_list|,
operator|&
name|testpkt
operator|.
name|p
operator|.
name|exten
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
name|pkt_len
operator|+=
literal|4
operator|+
name|mac_len
expr_stmt|;
comment|/* Now, alter the MAC so it becomes invalid. */
name|testpkt
operator|.
name|p
operator|.
name|exten
index|[
literal|1
index|]
operator|+=
literal|1
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|SERVER_AUTH_FAIL
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|pkt_len
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_AuthenticatedPacketUnknownKey
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Activate authentication option */
name|PrepareAuthenticationTestMD5
argument_list|(
literal|30
argument_list|,
literal|9
argument_list|,
literal|"123456789"
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Prepare the packet. Note that the Key-ID expected is 30, but 	 * the packet has a key id of 50. 	 */
name|int
name|pkt_len
init|=
name|LEN_PKT_NOMAC
decl_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|exten
index|[
literal|0
index|]
operator|=
name|htonl
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|int
name|mac_len
init|=
name|make_mac
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
name|pkt_len
argument_list|,
name|MAX_MD5_LEN
argument_list|,
name|key_ptr
argument_list|,
operator|&
name|testpkt
operator|.
name|p
operator|.
name|exten
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
name|pkt_len
operator|+=
literal|4
operator|+
name|mac_len
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|SERVER_AUTH_FAIL
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|pkt_len
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_ServerVersionTooOld
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|li_vn_mode
operator|=
name|PKT_LI_VN_MODE
argument_list|(
name|LEAP_NOWARNING
argument_list|,
name|NTP_OLDVERSION
operator|-
literal|1
argument_list|,
name|MODE_CLIENT
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|PKT_VERSION
argument_list|(
name|testpkt
operator|.
name|p
operator|.
name|li_vn_mode
argument_list|)
operator|<
name|NTP_OLDVERSION
argument_list|)
expr_stmt|;
name|int
name|pkt_len
init|=
name|LEN_PKT_NOMAC
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|SERVER_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|pkt_len
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_ServerVersionTooNew
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|li_vn_mode
operator|=
name|PKT_LI_VN_MODE
argument_list|(
name|LEAP_NOWARNING
argument_list|,
name|NTP_VERSION
operator|+
literal|1
argument_list|,
name|MODE_CLIENT
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|PKT_VERSION
argument_list|(
name|testpkt
operator|.
name|p
operator|.
name|li_vn_mode
argument_list|)
operator|>
name|NTP_VERSION
argument_list|)
expr_stmt|;
name|int
name|pkt_len
init|=
name|LEN_PKT_NOMAC
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|SERVER_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|pkt_len
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_NonWantedMode
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|li_vn_mode
operator|=
name|PKT_LI_VN_MODE
argument_list|(
name|LEAP_NOWARNING
argument_list|,
name|NTP_VERSION
argument_list|,
name|MODE_CLIENT
argument_list|)
expr_stmt|;
comment|/* The packet has a mode of MODE_CLIENT, but process_pkt expects 	 * MODE_SERVER 	 */
name|TEST_ASSERT_EQUAL
argument_list|(
name|SERVER_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Tests bug 1597 */
end_comment

begin_function
name|void
name|test_KoDRate
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|stratum
operator|=
name|STRATUM_PKT_UNSPEC
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|testpkt
operator|.
name|p
operator|.
name|refid
argument_list|,
literal|"RATE"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|KOD_RATE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_KoDDeny
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|stratum
operator|=
name|STRATUM_PKT_UNSPEC
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|testpkt
operator|.
name|p
operator|.
name|refid
argument_list|,
literal|"DENY"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|KOD_DEMOBILIZE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_RejectUnsyncedServer
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|li_vn_mode
operator|=
name|PKT_LI_VN_MODE
argument_list|(
name|LEAP_NOTINSYNC
argument_list|,
name|NTP_VERSION
argument_list|,
name|MODE_SERVER
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|SERVER_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_RejectWrongResponseServerMode
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|l_fp
name|tmp
decl_stmt|;
name|tmp
operator|.
name|l_ui
operator|=
literal|1000UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|0UL
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|testpkt
operator|.
name|p
operator|.
name|org
argument_list|)
expr_stmt|;
name|tmp
operator|.
name|l_ui
operator|=
literal|2000UL
expr_stmt|;
name|tmp
operator|.
name|l_uf
operator|=
literal|0UL
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|testspkt
operator|.
name|p
operator|.
name|xmt
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|PACKET_UNUSEABLE
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_AcceptNoSentPacketBroadcastMode
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|testpkt
operator|.
name|p
operator|.
name|li_vn_mode
operator|=
name|PKT_LI_VN_MODE
argument_list|(
name|LEAP_NOWARNING
argument_list|,
name|NTP_VERSION
argument_list|,
name|MODE_BROADCAST
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LEN_PKT_NOMAC
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
name|MODE_BROADCAST
argument_list|,
name|NULL
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_CorrectUnauthenticatedPacket
parameter_list|(
name|void
parameter_list|)
block|{
name|TEST_ASSERT_FALSE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LEN_PKT_NOMAC
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|LEN_PKT_NOMAC
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_CorrectAuthenticatedPacketMD5
parameter_list|(
name|void
parameter_list|)
block|{
name|PrepareAuthenticationTestMD5
argument_list|(
literal|10
argument_list|,
literal|15
argument_list|,
literal|"123456789abcdef"
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|pkt_len
init|=
name|LEN_PKT_NOMAC
decl_stmt|;
comment|/* Prepare the packet. */
name|testpkt
operator|.
name|p
operator|.
name|exten
index|[
literal|0
index|]
operator|=
name|htonl
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|int
name|mac_len
init|=
name|make_mac
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
name|pkt_len
argument_list|,
name|MAX_MD5_LEN
argument_list|,
name|key_ptr
argument_list|,
operator|&
name|testpkt
operator|.
name|p
operator|.
name|exten
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
name|pkt_len
operator|+=
literal|4
operator|+
name|mac_len
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|pkt_len
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|pkt_len
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_CorrectAuthenticatedPacketSHA1
parameter_list|(
name|void
parameter_list|)
block|{
name|PrepareAuthenticationTest
argument_list|(
literal|20
argument_list|,
literal|15
argument_list|,
literal|"SHA1"
argument_list|,
literal|"abcdefghijklmno"
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|ENABLED_OPT
argument_list|(
name|AUTHENTICATION
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|pkt_len
init|=
name|LEN_PKT_NOMAC
decl_stmt|;
comment|/* Prepare the packet. */
name|testpkt
operator|.
name|p
operator|.
name|exten
index|[
literal|0
index|]
operator|=
name|htonl
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|int
name|mac_len
init|=
name|make_mac
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
name|pkt_len
argument_list|,
name|MAX_MAC_LEN
argument_list|,
name|key_ptr
argument_list|,
operator|&
name|testpkt
operator|.
name|p
operator|.
name|exten
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
name|pkt_len
operator|+=
literal|4
operator|+
name|mac_len
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|pkt_len
argument_list|,
name|process_pkt
argument_list|(
operator|&
name|testpkt
operator|.
name|p
argument_list|,
operator|&
name|testsock
argument_list|,
name|pkt_len
argument_list|,
name|MODE_SERVER
argument_list|,
operator|&
name|testspkt
operator|.
name|p
argument_list|,
literal|"UnitTest"
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"unity.h"
end_include

begin_include
include|#
directive|include
file|"sockaddrtest.h"
end_include

begin_function_decl
name|void
name|setUp
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_IPv4AddressWithPort
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_IPv6AddressWithPort
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_IgnoreIPv6Fields
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_ScopedIPv6AddressWithPort
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_HashEqual
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|test_HashNotEqual
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|setUp
parameter_list|(
name|void
parameter_list|)
block|{
name|init_lib
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_IPv4AddressWithPort
parameter_list|(
name|void
parameter_list|)
block|{
name|sockaddr_u
name|input
init|=
name|CreateSockaddr4
argument_list|(
literal|"192.0.2.10"
argument_list|,
literal|123
argument_list|)
decl_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
literal|"192.0.2.10"
argument_list|,
name|socktoa
argument_list|(
operator|&
name|input
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
literal|"192.0.2.10:123"
argument_list|,
name|sockporttoa
argument_list|(
operator|&
name|input
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_IPv6AddressWithPort
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|ISC_PLATFORM_WANTIPV6
specifier|const
name|struct
name|in6_addr
name|address
init|=
block|{
literal|0x20
block|,
literal|0x01
block|,
literal|0x0d
block|,
literal|0xb8
block|,
literal|0x85
block|,
literal|0xa3
block|,
literal|0x08
block|,
literal|0xd3
block|,
literal|0x13
block|,
literal|0x19
block|,
literal|0x8a
block|,
literal|0x2e
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x73
block|,
literal|0x34
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
name|expected
init|=
literal|"2001:db8:85a3:8d3:1319:8a2e:370:7334"
decl_stmt|;
specifier|const
name|char
modifier|*
name|expected_port
init|=
literal|"[2001:db8:85a3:8d3:1319:8a2e:370:7334]:123"
decl_stmt|;
name|sockaddr_u
name|input
decl_stmt|;
name|memset
argument_list|(
operator|&
name|input
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|input
argument_list|)
argument_list|)
expr_stmt|;
name|AF
argument_list|(
operator|&
name|input
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SET_ADDR6N
argument_list|(
operator|&
name|input
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|SET_PORT
argument_list|(
operator|&
name|input
argument_list|,
literal|123
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|expected
argument_list|,
name|socktoa
argument_list|(
operator|&
name|input
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|expected_port
argument_list|,
name|sockporttoa
argument_list|(
operator|&
name|input
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|TEST_IGNORE_MESSAGE
argument_list|(
literal|"IPV6 disabled in build, skipping."
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* ISC_PLATFORM_HAVEIPV6 */
block|}
end_function

begin_function
name|void
name|test_ScopedIPv6AddressWithPort
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESCOPEID
specifier|const
name|struct
name|in6_addr
name|address
init|=
block|{
block|{
block|{
literal|0xfe
block|,
literal|0x80
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0x12
block|,
literal|0x3f
block|,
literal|0xff
block|,
literal|0xfe
block|,
literal|0x29
block|,
literal|0xff
block|,
literal|0xfa
block|}
block|}
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
name|expected
init|=
literal|"fe80::212:3fff:fe29:fffa%5"
decl_stmt|;
specifier|const
name|char
modifier|*
name|expected_port
init|=
literal|"[fe80::212:3fff:fe29:fffa%5]:123"
decl_stmt|;
name|sockaddr_u
name|input
decl_stmt|;
name|memset
argument_list|(
operator|&
name|input
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|input
argument_list|)
argument_list|)
expr_stmt|;
name|AF
argument_list|(
operator|&
name|input
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SET_ADDR6N
argument_list|(
operator|&
name|input
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|SET_PORT
argument_list|(
operator|&
name|input
argument_list|,
literal|123
argument_list|)
expr_stmt|;
name|SCOPE_VAR
argument_list|(
operator|&
name|input
argument_list|)
operator|=
literal|5
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|expected
argument_list|,
name|socktoa
argument_list|(
operator|&
name|input
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_STRING
argument_list|(
name|expected_port
argument_list|,
name|sockporttoa
argument_list|(
operator|&
name|input
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|TEST_IGNORE_MESSAGE
argument_list|(
literal|"Skipping because ISC_PLATFORM does not have Scope ID"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|test_HashEqual
parameter_list|(
name|void
parameter_list|)
block|{
name|sockaddr_u
name|input1
init|=
name|CreateSockaddr4
argument_list|(
literal|"192.00.2.2"
argument_list|,
literal|123
argument_list|)
decl_stmt|;
name|sockaddr_u
name|input2
init|=
name|CreateSockaddr4
argument_list|(
literal|"192.0.2.2"
argument_list|,
literal|123
argument_list|)
decl_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
name|IsEqual
argument_list|(
name|input1
argument_list|,
name|input2
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|sock_hash
argument_list|(
operator|&
name|input1
argument_list|)
argument_list|,
name|sock_hash
argument_list|(
operator|&
name|input2
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_HashNotEqual
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* These two addresses should not generate the same hash. */
name|sockaddr_u
name|input1
init|=
name|CreateSockaddr4
argument_list|(
literal|"192.0.2.1"
argument_list|,
literal|123
argument_list|)
decl_stmt|;
name|sockaddr_u
name|input2
init|=
name|CreateSockaddr4
argument_list|(
literal|"192.0.2.2"
argument_list|,
literal|123
argument_list|)
decl_stmt|;
name|TEST_ASSERT_FALSE
argument_list|(
name|IsEqual
argument_list|(
name|input1
argument_list|,
name|input2
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_ASSERT_FALSE
argument_list|(
name|sock_hash
argument_list|(
operator|&
name|input1
argument_list|)
operator|==
name|sock_hash
argument_list|(
operator|&
name|input2
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_IgnoreIPv6Fields
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|ISC_PLATFORM_WANTIPV6
specifier|const
name|struct
name|in6_addr
name|address
init|=
block|{
literal|0x20
block|,
literal|0x01
block|,
literal|0x0d
block|,
literal|0xb8
block|,
literal|0x85
block|,
literal|0xa3
block|,
literal|0x08
block|,
literal|0xd3
block|,
literal|0x13
block|,
literal|0x19
block|,
literal|0x8a
block|,
literal|0x2e
block|,
literal|0x03
block|,
literal|0x70
block|,
literal|0x73
block|,
literal|0x34
block|}
decl_stmt|;
name|sockaddr_u
name|input1
decl_stmt|,
name|input2
decl_stmt|;
name|input1
operator|.
name|sa6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|input1
operator|.
name|sa6
operator|.
name|sin6_addr
operator|=
name|address
expr_stmt|;
name|input1
operator|.
name|sa6
operator|.
name|sin6_flowinfo
operator|=
literal|30L
expr_stmt|;
comment|// This value differs from input2.
name|SET_PORT
argument_list|(
operator|&
name|input1
argument_list|,
name|NTP_PORT
argument_list|)
expr_stmt|;
name|input2
operator|.
name|sa6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|input2
operator|.
name|sa6
operator|.
name|sin6_addr
operator|=
name|address
expr_stmt|;
name|input2
operator|.
name|sa6
operator|.
name|sin6_flowinfo
operator|=
literal|10L
expr_stmt|;
comment|// This value differs from input1.
name|SET_PORT
argument_list|(
operator|&
name|input2
argument_list|,
name|NTP_PORT
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|sock_hash
argument_list|(
operator|&
name|input1
argument_list|)
argument_list|,
name|sock_hash
argument_list|(
operator|&
name|input2
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|TEST_IGNORE_MESSAGE
argument_list|(
literal|"IPV6 disabled in build, skipping."
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* ISC_PLATFORM_HAVEIPV6 */
block|}
end_function

end_unit


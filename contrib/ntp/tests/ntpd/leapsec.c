begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//#include "ntpdtest.h"
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"ntp.h"
end_include

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_leapsec.h"
end_include

begin_include
include|#
directive|include
file|"unity.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"test-libntp.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
name|leap1
index|[]
init|=
literal|"#\n"
literal|"#@ 	3610569600\n"
literal|"#\n"
literal|"2272060800 10	# 1 Jan 1972\n"
literal|"2287785600	11	# 1 Jul 1972\n"
literal|"2303683200	12	# 1 Jan 1973\n"
literal|"2335219200	13	# 1 Jan 1974\n"
literal|"2366755200	14	# 1 Jan 1975\n"
literal|"2398291200	15	# 1 Jan 1976\n"
literal|"2429913600	16	# 1 Jan 1977\n"
literal|"2461449600	17	# 1 Jan 1978\n"
literal|"2492985600	18	# 1 Jan 1979\n"
literal|"2524521600	19	# 1 Jan 1980\n"
literal|"   \t  \n"
literal|"2571782400	20	# 1 Jul 1981\n"
literal|"2603318400	21	# 1 Jul 1982\n"
literal|"2634854400	22	# 1 Jul 1983\n"
literal|"2698012800	23	# 1 Jul 1985\n"
literal|"2776982400	24	# 1 Jan 1988\n"
literal|"2840140800	25	# 1 Jan 1990\n"
literal|"2871676800	26	# 1 Jan 1991\n"
literal|"2918937600	27	# 1 Jul 1992\n"
literal|"2950473600	28	# 1 Jul 1993\n"
literal|"2982009600	29	# 1 Jul 1994\n"
literal|"3029443200	30	# 1 Jan 1996\n"
literal|"3076704000	31	# 1 Jul 1997\n"
literal|"3124137600	32	# 1 Jan 1999\n"
literal|"3345062400	33	# 1 Jan 2006\n"
literal|"3439756800	34	# 1 Jan 2009\n"
literal|"3550089600	35	# 1 Jul 2012\n"
literal|"#\n"
literal|"#h	dc2e6b0b 5aade95d a0587abd 4e0dacb4 e4d5049e\n"
literal|"#\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|leap2
index|[]
init|=
literal|"#\n"
literal|"#@ 	2950473700\n"
literal|"#\n"
literal|"2272060800 10	# 1 Jan 1972\n"
literal|"2287785600	11	# 1 Jul 1972\n"
literal|"2303683200	12	# 1 Jan 1973\n"
literal|"2335219200	13	# 1 Jan 1974\n"
literal|"2366755200	14	# 1 Jan 1975\n"
literal|"2398291200	15	# 1 Jan 1976\n"
literal|"2429913600	16	# 1 Jan 1977\n"
literal|"2461449600	17	# 1 Jan 1978\n"
literal|"2492985600	18	# 1 Jan 1979\n"
literal|"2524521600	19	# 1 Jan 1980\n"
literal|"2571782400	20	# 1 Jul 1981\n"
literal|"2603318400	21	# 1 Jul 1982\n"
literal|"2634854400	22	# 1 Jul 1983\n"
literal|"2698012800	23	# 1 Jul 1985\n"
literal|"2776982400	24	# 1 Jan 1988\n"
literal|"2840140800	25	# 1 Jan 1990\n"
literal|"2871676800	26	# 1 Jan 1991\n"
literal|"2918937600	27	# 1 Jul 1992\n"
literal|"2950473600	28	# 1 Jul 1993\n"
literal|"#\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|// Faked table with a leap second removal at 2009
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|leap3
index|[]
init|=
literal|"#\n"
literal|"#@ 	3610569600\n"
literal|"#\n"
literal|"2272060800 10	# 1 Jan 1972\n"
literal|"2287785600	11	# 1 Jul 1972\n"
literal|"2303683200	12	# 1 Jan 1973\n"
literal|"2335219200	13	# 1 Jan 1974\n"
literal|"2366755200	14	# 1 Jan 1975\n"
literal|"2398291200	15	# 1 Jan 1976\n"
literal|"2429913600	16	# 1 Jan 1977\n"
literal|"2461449600	17	# 1 Jan 1978\n"
literal|"2492985600	18	# 1 Jan 1979\n"
literal|"2524521600	19	# 1 Jan 1980\n"
literal|"2571782400	20	# 1 Jul 1981\n"
literal|"2603318400	21	# 1 Jul 1982\n"
literal|"2634854400	22	# 1 Jul 1983\n"
literal|"2698012800	23	# 1 Jul 1985\n"
literal|"2776982400	24	# 1 Jan 1988\n"
literal|"2840140800	25	# 1 Jan 1990\n"
literal|"2871676800	26	# 1 Jan 1991\n"
literal|"2918937600	27	# 1 Jul 1992\n"
literal|"2950473600	28	# 1 Jul 1993\n"
literal|"2982009600	29	# 1 Jul 1994\n"
literal|"3029443200	30	# 1 Jan 1996\n"
literal|"3076704000	31	# 1 Jul 1997\n"
literal|"3124137600	32	# 1 Jan 1999\n"
literal|"3345062400	33	# 1 Jan 2006\n"
literal|"3439756800	32	# 1 Jan 2009\n"
literal|"3550089600	33	# 1 Jul 2012\n"
literal|"#\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|// short table with good hash
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|leap_ghash
index|[]
init|=
literal|"#\n"
literal|"#@ 	3610569600\n"
literal|"#$ 	3610566000\n"
literal|"#\n"
literal|"2272060800 10	# 1 Jan 1972\n"
literal|"2287785600	11	# 1 Jul 1972\n"
literal|"2303683200	12	# 1 Jan 1973\n"
literal|"2335219200	13	# 1 Jan 1974\n"
literal|"2366755200	14	# 1 Jan 1975\n"
literal|"2398291200	15	# 1 Jan 1976\n"
literal|"2429913600	16	# 1 Jan 1977\n"
literal|"2461449600	17	# 1 Jan 1978\n"
literal|"2492985600	18	# 1 Jan 1979\n"
literal|"2524521600	19	# 1 Jan 1980\n"
literal|"#\n"
literal|"#h 4b304e10 95642b3f c10b91f9 90791725 25f280d0\n"
literal|"#\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|// short table with bad hash
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|leap_bhash
index|[]
init|=
literal|"#\n"
literal|"#@ 	3610569600\n"
literal|"#$ 	3610566000\n"
literal|"#\n"
literal|"2272060800 10	# 1 Jan 1972\n"
literal|"2287785600	11	# 1 Jul 1972\n"
literal|"2303683200	12	# 1 Jan 1973\n"
literal|"2335219200	13	# 1 Jan 1974\n"
literal|"2366755200	14	# 1 Jan 1975\n"
literal|"2398291200	15	# 1 Jan 1976\n"
literal|"2429913600	16	# 1 Jan 1977\n"
literal|"2461449600	17	# 1 Jan 1978\n"
literal|"2492985600	18	# 1 Jan 1979\n"
literal|"2524521600	19	# 1 Jan 1980\n"
literal|"#\n"
literal|"#h	dc2e6b0b 5aade95d a0587abd 4e0dacb4 e4d5049e\n"
literal|"#\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|// short table with malformed hash
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|leap_mhash
index|[]
init|=
literal|"#\n"
literal|"#@ 	3610569600\n"
literal|"#$ 	3610566000\n"
literal|"#\n"
literal|"2272060800 10	# 1 Jan 1972\n"
literal|"2287785600	11	# 1 Jul 1972\n"
literal|"2303683200	12	# 1 Jan 1973\n"
literal|"2335219200	13	# 1 Jan 1974\n"
literal|"2366755200	14	# 1 Jan 1975\n"
literal|"2398291200	15	# 1 Jan 1976\n"
literal|"2429913600	16	# 1 Jan 1977\n"
literal|"2461449600	17	# 1 Jan 1978\n"
literal|"2492985600	18	# 1 Jan 1979\n"
literal|"2524521600	19	# 1 Jan 1980\n"
literal|"#\n"
literal|"#h f2349a02 788b9534 a8f2e141 f2029Q6d 4064a7ee\n"
literal|"#\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|// short table with only 4 hash groups
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|leap_shash
index|[]
init|=
literal|"#\n"
literal|"#@ 	3610569600\n"
literal|"#$ 	3610566000\n"
literal|"#\n"
literal|"2272060800 10	# 1 Jan 1972\n"
literal|"2287785600	11	# 1 Jul 1972\n"
literal|"2303683200	12	# 1 Jan 1973\n"
literal|"2335219200	13	# 1 Jan 1974\n"
literal|"2366755200	14	# 1 Jan 1975\n"
literal|"2398291200	15	# 1 Jan 1976\n"
literal|"2429913600	16	# 1 Jan 1977\n"
literal|"2461449600	17	# 1 Jan 1978\n"
literal|"2492985600	18	# 1 Jan 1979\n"
literal|"2524521600	19	# 1 Jan 1980\n"
literal|"#\n"
literal|"#h f2349a02 788b9534 a8f2e141 f2029Q6d\n"
literal|"#\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|// table with good hash and truncated/missing leading zeros
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|leap_gthash
index|[]
init|=
block|{
literal|"#\n"
literal|"#$	 3535228800\n"
literal|"#\n"
literal|"#	Updated through IERS Bulletin C46\n"
literal|"#	File expires on:  28 June 2014\n"
literal|"#\n"
literal|"#@	3612902400\n"
literal|"#\n"
literal|"2272060800	10	# 1 Jan 1972\n"
literal|"2287785600	11	# 1 Jul 1972\n"
literal|"2303683200	12	# 1 Jan 1973\n"
literal|"2335219200	13	# 1 Jan 1974\n"
literal|"2366755200	14	# 1 Jan 1975\n"
literal|"2398291200	15	# 1 Jan 1976\n"
literal|"2429913600	16	# 1 Jan 1977\n"
literal|"2461449600	17	# 1 Jan 1978\n"
literal|"2492985600	18	# 1 Jan 1979\n"
literal|"2524521600	19	# 1 Jan 1980\n"
literal|"2571782400	20	# 1 Jul 1981\n"
literal|"2603318400	21	# 1 Jul 1982\n"
literal|"2634854400	22	# 1 Jul 1983\n"
literal|"2698012800	23	# 1 Jul 1985\n"
literal|"2776982400	24	# 1 Jan 1988\n"
literal|"2840140800	25	# 1 Jan 1990\n"
literal|"2871676800	26	# 1 Jan 1991\n"
literal|"2918937600	27	# 1 Jul 1992\n"
literal|"2950473600	28	# 1 Jul 1993\n"
literal|"2982009600	29	# 1 Jul 1994\n"
literal|"3029443200	30	# 1 Jan 1996\n"
literal|"3076704000	31	# 1 Jul 1997\n"
literal|"3124137600	32	# 1 Jan 1999\n"
literal|"3345062400	33	# 1 Jan 2006\n"
literal|"3439756800	34	# 1 Jan 2009\n"
literal|"3550089600	35	# 1 Jul 2012\n"
literal|"#\n"
literal|"#h	1151a8f e85a5069 9000fcdb 3d5e5365 1d505b37"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|lsec2006
init|=
literal|3345062400u
decl_stmt|;
end_decl_stmt

begin_comment
comment|// +33, 1 Jan 2006, 00:00:00 utc
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|lsec2009
init|=
literal|3439756800u
decl_stmt|;
end_decl_stmt

begin_comment
comment|// +34, 1 Jan 2009, 00:00:00 utc
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|lsec2012
init|=
literal|3550089600u
decl_stmt|;
end_decl_stmt

begin_comment
comment|// +35, 1 Jul 2012, 00:00:00 utc
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|lsec2015
init|=
literal|3644697600u
decl_stmt|;
end_decl_stmt

begin_comment
comment|// +36, 1 Jul 2015, 00:00:00 utc
end_comment

begin_function
name|int
name|stringreader
parameter_list|(
name|void
modifier|*
name|farg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|cpp
init|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|farg
decl_stmt|;
if|if
condition|(
operator|*
operator|*
name|cpp
condition|)
return|return
operator|*
operator|(
operator|*
name|cpp
operator|)
operator|++
return|;
else|else
return|return
name|EOF
return|;
block|}
end_function

begin_function
specifier|static
name|int
comment|/*BOOL*/
name|setup_load_table
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|,
name|int
name|blim
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_table_t
modifier|*
name|pt
init|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|rc
operator|=
operator|(
name|pt
operator|!=
name|NULL
operator|)
operator|&&
name|leapsec_load
argument_list|(
name|pt
argument_list|,
name|stringreader
argument_list|,
operator|&
name|cp
argument_list|,
name|blim
argument_list|)
expr_stmt|;
name|rc
operator|=
name|rc
operator|&&
name|leapsec_set_table
argument_list|(
name|pt
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
comment|/*BOOL*/
name|setup_clear_table
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_table_t
modifier|*
name|pt
init|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|pt
condition|)
name|leapsec_clear
argument_list|(
name|pt
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_set_table
argument_list|(
name|pt
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|CalendarToString
parameter_list|(
specifier|const
name|struct
name|calendar
name|cal
parameter_list|)
block|{
name|char
modifier|*
name|ss
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
argument_list|)
operator|*
literal|100
argument_list|)
decl_stmt|;
name|char
name|buffer
index|[
literal|100
index|]
init|=
literal|""
decl_stmt|;
operator|*
name|ss
operator|=
literal|'\0'
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%u"
argument_list|,
name|cal
operator|.
name|year
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|u_int
operator|)
name|cal
operator|.
name|month
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|u_int
operator|)
name|cal
operator|.
name|monthday
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
literal|" ("
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|u_int
operator|)
name|cal
operator|.
name|yearday
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
literal|") "
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|u_int
operator|)
name|cal
operator|.
name|hour
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|u_int
operator|)
name|cal
operator|.
name|minute
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|u_int
operator|)
name|cal
operator|.
name|second
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ss
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
comment|//ss<< cal.year<< "-"<< (u_int)cal.month<< "-"<< (u_int)cal.monthday<< " ("<< cal.yearday<< ") "<< (u_int)cal.hour<< ":"<< (u_int)cal.minute<< ":"<< (u_int)cal.second;
return|return
name|ss
return|;
block|}
end_function

begin_function
name|int
name|IsEqual
parameter_list|(
specifier|const
name|struct
name|calendar
name|expected
parameter_list|,
specifier|const
name|struct
name|calendar
name|actual
parameter_list|)
block|{
if|if
condition|(
name|expected
operator|.
name|year
operator|==
name|actual
operator|.
name|year
operator|&&
operator|(
name|expected
operator|.
name|yearday
operator|==
name|actual
operator|.
name|yearday
operator|||
operator|(
name|expected
operator|.
name|month
operator|==
name|actual
operator|.
name|month
operator|&&
name|expected
operator|.
name|monthday
operator|==
name|actual
operator|.
name|monthday
operator|)
operator|)
operator|&&
name|expected
operator|.
name|hour
operator|==
name|actual
operator|.
name|hour
operator|&&
name|expected
operator|.
name|minute
operator|==
name|actual
operator|.
name|minute
operator|&&
name|expected
operator|.
name|second
operator|==
name|actual
operator|.
name|second
condition|)
block|{
return|return
name|TRUE
return|;
block|}
else|else
block|{
name|char
modifier|*
name|p_exp
init|=
name|CalendarToString
argument_list|(
name|expected
argument_list|)
decl_stmt|;
name|char
modifier|*
name|p_act
init|=
name|CalendarToString
argument_list|(
name|actual
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"expected: %s but was %s"
argument_list|,
name|p_exp
argument_list|,
name|p_act
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_exp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p_act
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
end_function

begin_comment
comment|//-------------------------
end_comment

begin_function
name|void
name|setUp
parameter_list|(
name|void
parameter_list|)
block|{
name|ntpcal_set_timefunc
argument_list|(
name|timefunc
argument_list|)
expr_stmt|;
name|settime
argument_list|(
literal|1970
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|leapsec_ut_pristine
argument_list|()
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|tearDown
parameter_list|(
name|void
parameter_list|)
block|{
name|ntpcal_set_timefunc
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// VALIDATION TESTS
end_comment

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_function
name|void
name|test_ValidateGood
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
init|=
name|leap_ghash
decl_stmt|;
name|int
name|rc
init|=
name|leapsec_validate
argument_list|(
name|stringreader
argument_list|,
operator|&
name|cp
argument_list|)
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSVALID_GOODHASH
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_function
name|void
name|test_ValidateNoHash
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
init|=
name|leap2
decl_stmt|;
name|int
name|rc
init|=
name|leapsec_validate
argument_list|(
name|stringreader
argument_list|,
operator|&
name|cp
argument_list|)
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSVALID_NOHASH
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_function
name|void
name|test_ValidateBad
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
init|=
name|leap_bhash
decl_stmt|;
name|int
name|rc
init|=
name|leapsec_validate
argument_list|(
name|stringreader
argument_list|,
operator|&
name|cp
argument_list|)
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSVALID_BADHASH
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_function
name|void
name|test_ValidateMalformed
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
init|=
name|leap_mhash
decl_stmt|;
name|int
name|rc
init|=
name|leapsec_validate
argument_list|(
name|stringreader
argument_list|,
operator|&
name|cp
argument_list|)
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSVALID_BADFORMAT
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_function
name|void
name|test_ValidateMalformedShort
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
init|=
name|leap_shash
decl_stmt|;
name|int
name|rc
init|=
name|leapsec_validate
argument_list|(
name|stringreader
argument_list|,
operator|&
name|cp
argument_list|)
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSVALID_BADFORMAT
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_function
name|void
name|test_ValidateNoLeadZero
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
init|=
name|leap_gthash
decl_stmt|;
name|int
name|rc
init|=
name|leapsec_validate
argument_list|(
name|stringreader
argument_list|,
operator|&
name|cp
argument_list|)
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSVALID_GOODHASH
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// BASIC FUNCTIONS
end_comment

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// test table selection
end_comment

begin_function
name|void
name|test_tableSelect
parameter_list|(
name|void
parameter_list|)
block|{
name|leap_table_t
modifier|*
name|pt1
decl_stmt|,
modifier|*
name|pt2
decl_stmt|,
modifier|*
name|pt3
decl_stmt|,
modifier|*
name|pt4
decl_stmt|;
name|pt1
operator|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|pt2
operator|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_MESSAGE
argument_list|(
name|pt1
argument_list|,
name|pt2
argument_list|,
literal|"first"
argument_list|)
expr_stmt|;
name|pt1
operator|=
name|leapsec_get_table
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|pt2
operator|=
name|leapsec_get_table
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_MESSAGE
argument_list|(
name|pt1
argument_list|,
name|pt2
argument_list|,
literal|"second"
argument_list|)
expr_stmt|;
name|pt1
operator|=
name|leapsec_get_table
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|pt2
operator|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_EQUAL
argument_list|(
name|pt1
argument_list|,
name|pt2
argument_list|)
expr_stmt|;
name|pt1
operator|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|pt2
operator|=
name|leapsec_get_table
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_EQUAL
argument_list|(
name|pt1
argument_list|,
name|pt2
argument_list|)
expr_stmt|;
name|leapsec_set_table
argument_list|(
name|pt1
argument_list|)
expr_stmt|;
name|pt2
operator|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|pt3
operator|=
name|leapsec_get_table
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|pt1
argument_list|,
name|pt2
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_EQUAL
argument_list|(
name|pt2
argument_list|,
name|pt3
argument_list|)
expr_stmt|;
name|pt1
operator|=
name|pt3
expr_stmt|;
name|leapsec_set_table
argument_list|(
name|pt1
argument_list|)
expr_stmt|;
name|pt2
operator|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|pt3
operator|=
name|leapsec_get_table
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|pt1
argument_list|,
name|pt2
argument_list|)
expr_stmt|;
name|TEST_ASSERT_NOT_EQUAL
argument_list|(
name|pt2
argument_list|,
name|pt3
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// load file& check expiration
end_comment

begin_function
name|void
name|test_loadFileExpire
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
init|=
name|leap1
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|leap_table_t
modifier|*
name|pt
init|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|rc
operator|=
name|leapsec_load
argument_list|(
name|pt
argument_list|,
name|stringreader
argument_list|,
operator|&
name|cp
argument_list|,
name|FALSE
argument_list|)
operator|&&
name|leapsec_set_table
argument_list|(
name|pt
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL_MESSAGE
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|,
literal|"first"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_expired
argument_list|(
literal|3439756800u
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_expired
argument_list|(
literal|3610569601u
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// load file& check time-to-live
end_comment

begin_function
name|void
name|test_loadFileTTL
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
init|=
name|leap1
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|leap_table_t
modifier|*
name|pt
init|=
name|leapsec_get_table
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|time_t
name|pivot
init|=
literal|0x70000000u
decl_stmt|;
specifier|const
name|uint32_t
name|limit
init|=
literal|3610569600u
decl_stmt|;
name|rc
operator|=
name|leapsec_load
argument_list|(
name|pt
argument_list|,
name|stringreader
argument_list|,
operator|&
name|cp
argument_list|,
name|FALSE
argument_list|)
operator|&&
name|leapsec_set_table
argument_list|(
name|pt
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|//
comment|// exactly 1 day to live
name|rc
operator|=
name|leapsec_daystolive
argument_list|(
name|limit
operator|-
literal|86400
argument_list|,
operator|&
name|pivot
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// less than 1 day to live
name|rc
operator|=
name|leapsec_daystolive
argument_list|(
name|limit
operator|-
literal|86399
argument_list|,
operator|&
name|pivot
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// hit expiration exactly
name|rc
operator|=
name|leapsec_daystolive
argument_list|(
name|limit
argument_list|,
operator|&
name|pivot
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// expired since 1 sec
name|rc
operator|=
name|leapsec_daystolive
argument_list|(
name|limit
operator|+
literal|1
argument_list|,
operator|&
name|pivot
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
operator|-
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// RANDOM QUERY TESTS
end_comment

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// test query in pristine state (bug#2745 misbehaviour)
end_comment

begin_function
name|void
name|test_lsQueryPristineState
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// ad-hoc jump: leap second at 2009.01.01 -60days
end_comment

begin_function
name|void
name|test_ls2009faraway
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// test 60 days before leap. Nothing scheduled or indicated.
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|60
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|33
argument_list|,
name|qr
operator|.
name|tai_offs
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|tai_diff
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// ad-hoc jump: leap second at 2009.01.01 -1week
end_comment

begin_function
name|void
name|test_ls2009weekaway
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// test 7 days before leap. Leap scheduled, but not yet indicated.
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|7
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|33
argument_list|,
name|qr
operator|.
name|tai_offs
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|qr
operator|.
name|tai_diff
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_SCHEDULE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// ad-hoc jump: leap second at 2009.01.01 -1hr
end_comment

begin_function
name|void
name|test_ls2009houraway
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// test 1 hour before leap. 61 true seconds to go.
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
name|SECSPERHR
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|33
argument_list|,
name|qr
operator|.
name|tai_offs
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|qr
operator|.
name|tai_diff
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ANNOUNCE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// ad-hoc jump: leap second at 2009.01.01 -1sec
end_comment

begin_function
name|void
name|test_ls2009secaway
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// test 1 second before leap (last boundary...) 2 true seconds to go.
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|33
argument_list|,
name|qr
operator|.
name|tai_offs
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|qr
operator|.
name|tai_diff
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ALERT
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// ad-hoc jump to leap second at 2009.01.01
end_comment

begin_function
name|void
name|test_ls2009onspot
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// test on-spot: treat leap second as already gone.
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|34
argument_list|,
name|qr
operator|.
name|tai_offs
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|tai_diff
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// test handling of the leap second at 2009.01.01 without table
end_comment

begin_function
name|void
name|test_ls2009nodata
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_clear_table
argument_list|()
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// test on-spot with empty table
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|tai_offs
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|tai_diff
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// test handling of the leap second at 2009.01.01 with culled data
end_comment

begin_function
name|void
name|test_ls2009limdata
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|// test on-spot with limited table - this is tricky.
comment|// The table used ends 2012; depending on the build date, the 2009 entry
comment|// might be included or culled. The resulting TAI offset must be either
comment|// 34 or 35 seconds, depending on the build date of the test.
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
literal|34
operator|<=
name|qr
operator|.
name|tai_offs
argument_list|)
expr_stmt|;
name|TEST_ASSERT_TRUE
argument_list|(
literal|35
operator|>=
name|qr
operator|.
name|tai_offs
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|tai_diff
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// Far-distance forward jump into a transiton window.
end_comment

begin_function
name|void
name|test_qryJumpFarAhead
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|int
name|last
decl_stmt|,
name|idx
decl_stmt|;
name|int
name|mode
decl_stmt|;
for|for
control|(
name|mode
operator|=
literal|0
init|;
name|mode
operator|<
literal|2
condition|;
operator|++
name|mode
control|)
block|{
name|leapsec_ut_pristine
argument_list|()
expr_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|leapsec_electric
argument_list|(
name|mode
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2006
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// Forward jump into the next transition window
end_comment

begin_function
name|void
name|test_qryJumpAheadToTransition
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|int
name|last
decl_stmt|,
name|idx
decl_stmt|;
name|int
name|mode
decl_stmt|;
for|for
control|(
name|mode
operator|=
literal|0
init|;
name|mode
operator|<
literal|2
condition|;
operator|++
name|mode
control|)
block|{
name|leapsec_ut_pristine
argument_list|()
expr_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|leapsec_electric
argument_list|(
name|mode
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|+
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// Forward jump over the next transition window
end_comment

begin_function
name|void
name|test_qryJumpAheadOverTransition
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|int
name|last
decl_stmt|,
name|idx
decl_stmt|;
name|int
name|mode
decl_stmt|;
for|for
control|(
name|mode
operator|=
literal|0
init|;
name|mode
operator|<
literal|2
condition|;
operator|++
name|mode
control|)
block|{
name|leapsec_ut_pristine
argument_list|()
expr_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|leapsec_electric
argument_list|(
name|mode
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|+
literal|5
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// TABLE MODIFICATION AT RUNTIME
end_comment

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// add dynamic leap second (like from peer/clock)
end_comment

begin_function
name|void
name|test_addDynamic
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
specifier|static
specifier|const
name|uint32_t
name|insns
index|[]
init|=
block|{
literal|2982009600u
block|,
comment|//	29	# 1 Jul 1994
literal|3029443200u
block|,
comment|//	30	# 1 Jan 1996
literal|3076704000u
block|,
comment|//	31	# 1 Jul 1997
literal|3124137600u
block|,
comment|//	32	# 1 Jan 1999
literal|3345062400u
block|,
comment|//	33	# 1 Jan 2006
literal|3439756800u
block|,
comment|//	34	# 1 Jan 2009
literal|3550089600u
block|,
comment|//	35	# 1 Jul 2012
literal|0
comment|// sentinel
block|}
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap2
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|int
name|idx
decl_stmt|;
for|for
control|(
name|idx
operator|=
literal|1
init|;
name|insns
index|[
name|idx
index|]
condition|;
operator|++
name|idx
control|)
block|{
name|rc
operator|=
name|leapsec_add_dyn
argument_list|(
name|TRUE
argument_list|,
name|insns
index|[
name|idx
index|]
operator|-
literal|20
operator|*
name|SECSPERDAY
operator|-
literal|100
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
comment|// try to slip in a previous entry
name|rc
operator|=
name|leapsec_add_dyn
argument_list|(
name|TRUE
argument_list|,
name|insns
index|[
literal|0
index|]
operator|-
literal|20
operator|*
name|SECSPERDAY
operator|-
literal|100
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|//leap_table_t  * pt = leapsec_get_table(0);
comment|//leapsec_dump(pt, (leapsec_dumper)fprintf, stdout);
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// add fixed leap seconds (like from network packet)
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* currently unused -- possibly revived later */
end_comment

begin_comment
unit|void FAILtest_addFixed(void) { 	int            rc; 	leap_result_t  qr;  	static const struct { uint32_t tt; int of; } insns[] = { 		{2982009600u, 29},
comment|//	# 1 Jul 1994
end_comment

begin_comment
unit|{3029443200u, 30},
comment|//	# 1 Jan 1996
end_comment

begin_comment
unit|{3076704000u, 31},
comment|//	# 1 Jul 1997
end_comment

begin_comment
unit|{3124137600u, 32},
comment|//	# 1 Jan 1999
end_comment

begin_comment
unit|{3345062400u, 33},
comment|//	# 1 Jan 2006
end_comment

begin_comment
unit|{3439756800u, 34},
comment|//	# 1 Jan 2009
end_comment

begin_comment
unit|{3550089600u, 35},
comment|//	# 1 Jul 2012
end_comment

begin_comment
unit|{0,0}
comment|// sentinel
end_comment

begin_comment
unit|};  	rc = setup_load_table(leap2, FALSE); 	TEST_ASSERT_EQUAL(1, rc);  	int idx;
comment|// try to get in BAD time stamps...
end_comment

begin_comment
unit|for (idx=0; insns[idx].tt; ++idx) { 	    rc = leapsec_add_fix( 		insns[idx].of, 		insns[idx].tt - 20*SECSPERDAY - 100, 		insns[idx].tt + SECSPERDAY, 		NULL); 		TEST_ASSERT_EQUAL(FALSE, rc); 	}
comment|// now do it right
end_comment

begin_comment
unit|for (idx=0; insns[idx].tt; ++idx) { 		rc = leapsec_add_fix( 		    insns[idx].of, 		    insns[idx].tt, 		    insns[idx].tt + SECSPERDAY, 		    NULL); 		TEST_ASSERT_EQUAL(TRUE, rc); 	}
comment|// try to slip in a previous entry
end_comment

begin_comment
unit|rc = leapsec_add_fix( 	    insns[0].of, 	    insns[0].tt, 	    insns[0].tt + SECSPERDAY, 	    NULL); 	TEST_ASSERT_EQUAL(FALSE, rc);
comment|//leap_table_t * pt = leapsec_get_table(0);
end_comment

begin_comment
comment|//leapsec_dump(pt, (leapsec_dumper)fprintf, stdout);
end_comment

begin_endif
unit|return; }
endif|#
directive|endif
end_endif

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// add fixed leap seconds (like from network packet)
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* currently unused -- possibly revived later */
end_comment

begin_comment
unit|void FAILtest_addFixedExtend(void) { 	int            rc; 	leap_result_t  qr; 	int            last, idx;  	static const struct { uint32_t tt; int of; } insns[] = { 		{2982009600u, 29},
comment|//	# 1 Jul 1994
end_comment

begin_comment
unit|{3029443200u, 30},
comment|//	# 1 Jan 1996
end_comment

begin_comment
unit|{0,0}
comment|// sentinel
end_comment

begin_comment
unit|};  	rc = setup_load_table(leap2, FALSE); 	TEST_ASSERT_EQUAL(1, rc);  	for (last=idx=0; insns[idx].tt; ++idx) { 		last = idx; 		rc = leapsec_add_fix( 		    insns[idx].of, 		    insns[idx].tt, 		    insns[idx].tt + SECSPERDAY, 		    NULL); 		TEST_ASSERT_EQUAL(TRUE, rc); 	}
comment|// try to extend the expiration of the last entry
end_comment

begin_comment
unit|rc = leapsec_add_fix( 	    insns[last].of, 	    insns[last].tt, 	    insns[last].tt + 128*SECSPERDAY, 	    NULL); 	TEST_ASSERT_EQUAL(TRUE, rc);
comment|// try to extend the expiration of the last entry with wrong offset
end_comment

begin_comment
unit|rc = leapsec_add_fix( 	    insns[last].of+1, 	    insns[last].tt, 	    insns[last].tt + 129*SECSPERDAY, 	    NULL); 	TEST_ASSERT_EQUAL(FALSE, rc);
comment|//leap_table_t * pt = leapsec_get_table(FALSE);
end_comment

begin_comment
comment|//leapsec_dump(pt, (leapsec_dumper)fprintf, stdout);
end_comment

begin_endif
unit|return; }
endif|#
directive|endif
end_endif

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// add fixed leap seconds (like from network packet) in an otherwise
end_comment

begin_comment
comment|// empty table and test queries before / between /after the tabulated
end_comment

begin_comment
comment|// values.
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* currently unused -- possibly revived later */
end_comment

begin_comment
unit|void FAILtest_setFixedExtend(void) { 	int            rc; 	leap_result_t  qr; 	int            last, idx;  	static const struct { uint32_t tt; int of; } insns[] = { 		{2982009600u, 29},
comment|//	# 1 Jul 1994
end_comment

begin_comment
unit|{3029443200u, 30},
comment|//	# 1 Jan 1996
end_comment

begin_comment
unit|{0,0}
comment|// sentinel
end_comment

begin_comment
unit|};  	for (last=idx=0; insns[idx].tt; ++idx) { 		last = idx; 		rc = leapsec_add_fix( 		    insns[idx].of, 		    insns[idx].tt, 		    insns[idx].tt + 128*SECSPERDAY, 		    NULL); 		TEST_ASSERT_EQUAL(TRUE, rc); 	}  	rc = leapsec_query(&qr, insns[0].tt - 86400, NULL); 	TEST_ASSERT_EQUAL(28, qr.tai_offs);  	rc = leapsec_query(&qr, insns[0].tt + 86400, NULL); 	TEST_ASSERT_EQUAL(29, qr.tai_offs);  	rc = leapsec_query(&qr, insns[1].tt - 86400, NULL); 	TEST_ASSERT_EQUAL(29, qr.tai_offs);  	rc = leapsec_query(&qr, insns[1].tt + 86400, NULL); 	TEST_ASSERT_EQUAL(30, qr.tai_offs);
comment|//leap_table_t * pt = leapsec_get_table(0);
end_comment

begin_comment
comment|//leapsec_dump(pt, (leapsec_dumper)fprintf, stdout);
end_comment

begin_endif
unit|return; }
endif|#
directive|endif
end_endif

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// AUTOKEY LEAP TRANSFER TESTS
end_comment

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// Check if the offset can be applied to an empty table ONCE
end_comment

begin_function
name|void
name|test_taiEmptyTable
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|leapsec_autokey_tai
argument_list|(
literal|35
argument_list|,
name|lsec2015
operator|-
literal|30
operator|*
literal|86400
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_autokey_tai
argument_list|(
literal|35
argument_list|,
name|lsec2015
operator|-
literal|29
operator|*
literal|86400
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// Check that with fixed entries the operation fails
end_comment

begin_function
name|void
name|test_taiTableFixed
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_autokey_tai
argument_list|(
literal|35
argument_list|,
name|lsec2015
operator|-
literal|30
operator|*
literal|86400
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// test adjustment with a dynamic entry already there
end_comment

begin_function
name|void
name|test_taiTableDynamic
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_era_t
name|era
decl_stmt|;
name|rc
operator|=
name|leapsec_add_dyn
argument_list|(
name|TRUE
argument_list|,
name|lsec2015
operator|-
literal|20
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|leapsec_query_era
argument_list|(
operator|&
name|era
argument_list|,
name|lsec2015
operator|-
literal|10
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|era
operator|.
name|taiof
argument_list|)
expr_stmt|;
name|leapsec_query_era
argument_list|(
operator|&
name|era
argument_list|,
name|lsec2015
operator|+
literal|10
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|era
operator|.
name|taiof
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_autokey_tai
argument_list|(
literal|35
argument_list|,
name|lsec2015
operator|-
literal|19
operator|*
literal|86400
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_autokey_tai
argument_list|(
literal|35
argument_list|,
name|lsec2015
operator|-
literal|19
operator|*
literal|86400
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|leapsec_query_era
argument_list|(
operator|&
name|era
argument_list|,
name|lsec2015
operator|-
literal|10
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|35
argument_list|,
name|era
operator|.
name|taiof
argument_list|)
expr_stmt|;
name|leapsec_query_era
argument_list|(
operator|&
name|era
argument_list|,
name|lsec2015
operator|+
literal|10
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|36
argument_list|,
name|era
operator|.
name|taiof
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// test adjustment with a dynamic entry already there in dead zone
end_comment

begin_function
name|void
name|test_taiTableDynamicDeadZone
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|leapsec_add_dyn
argument_list|(
name|TRUE
argument_list|,
name|lsec2015
operator|-
literal|20
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_autokey_tai
argument_list|(
literal|35
argument_list|,
name|lsec2015
operator|-
literal|5
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_autokey_tai
argument_list|(
literal|35
argument_list|,
name|lsec2015
operator|+
literal|5
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// SEQUENCE TESTS
end_comment

begin_comment
comment|// =====================================================================
end_comment

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// leap second insert at 2009.01.01, electric mode
end_comment

begin_function
name|void
name|test_ls2009seqInsElectric
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|leapsec_electric
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|leapsec_electric
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|60
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|7
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_SCHEDULE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
name|SECSPERHR
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ANNOUNCE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ALERT
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
comment|// second call, same time frame: no trigger!
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// leap second insert at 2009.01.01, dumb mode
end_comment

begin_function
name|void
name|test_ls2009seqInsDumb
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|leapsec_electric
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|60
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|7
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_SCHEDULE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
name|SECSPERHR
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ANNOUNCE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ALERT
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ALERT
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|+
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
operator|-
literal|1
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
comment|// second call, same time frame: no trigger!
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// fake leap second remove at 2009.01.01, electric mode
end_comment

begin_function
name|void
name|test_ls2009seqDelElectric
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|leapsec_electric
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|leapsec_electric
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|60
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|7
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_SCHEDULE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
name|SECSPERHR
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ANNOUNCE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ALERT
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
comment|// second call, same time frame: no trigger!
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// fake leap second remove at 2009.01.01. dumb mode
end_comment

begin_function
name|void
name|test_ls2009seqDelDumb
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap3
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|leapsec_electric
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|60
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|7
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_SCHEDULE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
name|SECSPERHR
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ANNOUNCE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ALERT
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
operator|-
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
comment|// second call, same time frame: no trigger!
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2009
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// leap second insert at 2012.07.01, electric mode
end_comment

begin_function
name|void
name|test_ls2012seqInsElectric
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|leapsec_electric
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|leapsec_electric
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
operator|-
literal|60
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
operator|-
literal|7
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_SCHEDULE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
operator|-
name|SECSPERHR
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ANNOUNCE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
operator|-
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ALERT
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
comment|// second call, same time frame: no trigger!
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// leap second insert at 2012.07.01, dumb mode
end_comment

begin_function
name|void
name|test_ls2012seqInsDumb
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|rc
operator|=
name|setup_load_table
argument_list|(
name|leap1
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|leapsec_electric
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
operator|-
literal|60
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
operator|-
literal|7
operator|*
name|SECSPERDAY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_SCHEDULE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
operator|-
name|SECSPERHR
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ANNOUNCE
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
operator|-
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ALERT
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
comment|// This is just 1 sec before transition!
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_ALERT
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
comment|// NOW the insert/backwarp must happen
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
operator|+
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|TRUE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
operator|-
literal|1
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
comment|// second call with transition time: no trigger!
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|lsec2012
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// test repeated query on empty table in dumb mode
end_comment

begin_function
name|void
name|test_lsEmptyTableDumb
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
comment|//const
name|time_t
name|pivot
decl_stmt|;
name|pivot
operator|=
name|lsec2012
expr_stmt|;
comment|//	const
comment|//time_t   pivot(lsec2012);
specifier|const
name|uint32_t
name|t0
init|=
name|lsec2012
operator|-
literal|10
decl_stmt|;
specifier|const
name|uint32_t
name|tE
init|=
name|lsec2012
operator|+
literal|10
decl_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|leapsec_electric
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|uint32_t
name|t
decl_stmt|;
for|for
control|(
name|t
operator|=
name|t0
init|;
name|t
operator|!=
name|tE
condition|;
operator|++
name|t
control|)
block|{
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|t
argument_list|,
operator|&
name|pivot
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|// ----------------------------------------------------------------------
end_comment

begin_comment
comment|// test repeated query on empty table in electric mode
end_comment

begin_function
name|void
name|test_lsEmptyTableElectric
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|leap_result_t
name|qr
decl_stmt|;
name|leapsec_electric
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|1
argument_list|,
name|leapsec_electric
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|//const
name|time_t
name|pivot
decl_stmt|;
comment|//(lsec2012);
name|pivot
operator|=
name|lsec2012
expr_stmt|;
specifier|const
name|uint32_t
name|t0
init|=
name|lsec2012
operator|-
literal|10
decl_stmt|;
specifier|const
name|uint32_t
name|tE
init|=
name|lsec2012
operator|+
literal|10
decl_stmt|;
name|time_t
name|t
decl_stmt|;
for|for
control|(
name|t
operator|=
name|t0
init|;
name|t
operator|!=
name|tE
condition|;
operator|++
name|t
control|)
block|{
name|rc
operator|=
name|leapsec_query
argument_list|(
operator|&
name|qr
argument_list|,
name|t
argument_list|,
operator|&
name|pivot
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|FALSE
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
literal|0
argument_list|,
name|qr
operator|.
name|warped
argument_list|)
expr_stmt|;
name|TEST_ASSERT_EQUAL
argument_list|(
name|LSPROX_NOWARN
argument_list|,
name|qr
operator|.
name|proximity
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

end_unit


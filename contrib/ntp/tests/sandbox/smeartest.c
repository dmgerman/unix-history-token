begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<ntp.h>
end_include

begin_include
include|#
directive|include
file|<ntp_fp.h>
end_include

begin_include
include|#
directive|include
file|<ntp_assert.h>
end_include

begin_comment
comment|/*  * we want to test a refid format of:  * 254.x.y.x  *  * where x.y.z are 24 bits containing 2 (signed) integer bits  * and 22 fractional bits.  *  * we want functions to convert to/from this format, with unit tests.  *  * Interesting test cases include:  * 254.0.0.0  * 254.0.0.1  * 254.127.255.255  * 254.128.0.0  * 254.255.255.255  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|progname
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_function_decl
name|l_fp
name|convertRefIDToLFP
parameter_list|(
name|uint32_t
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|uint32_t
name|convertLFPToRefID
parameter_list|(
name|l_fp
name|num
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * The smear data in the refid is the bottom 3 bytes of the refid,  * 2 bits of integer  * 22 bits of fraction  */
end_comment

begin_function
name|l_fp
name|convertRefIDToLFP
parameter_list|(
name|uint32_t
name|r
parameter_list|)
block|{
name|l_fp
name|temp
decl_stmt|;
name|r
operator|=
name|ntohl
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%03d %08x: "
argument_list|,
operator|(
name|r
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|,
operator|(
name|r
operator|&
literal|0x00FFFFFF
operator|)
argument_list|)
expr_stmt|;
name|temp
operator|.
name|l_uf
operator|=
operator|(
name|r
operator|<<
literal|10
operator|)
expr_stmt|;
comment|/* 22 fractional bits */
name|temp
operator|.
name|l_ui
operator|=
operator|(
name|r
operator|>>
literal|22
operator|)
operator|&
literal|0x3
expr_stmt|;
name|temp
operator|.
name|l_ui
operator||=
operator|~
operator|(
name|temp
operator|.
name|l_ui
operator|&
literal|2
operator|)
operator|+
literal|1
expr_stmt|;
return|return
name|temp
return|;
block|}
end_function

begin_function
name|uint32_t
name|convertLFPToRefID
parameter_list|(
name|l_fp
name|num
parameter_list|)
block|{
name|uint32_t
name|temp
decl_stmt|;
comment|/* round the input with the highest bit to shift out from the 	 * fraction, then keep just two bits from the integral part. 	 * 	 * TODO: check for overflows; should we clamp/saturate or just 	 * complain? 	 */
name|L_ADDUF
argument_list|(
operator|&
name|num
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
name|num
operator|.
name|l_ui
operator|&=
literal|3
expr_stmt|;
comment|/* combine integral and fractional part to 24 bits */
name|temp
operator|=
operator|(
name|num
operator|.
name|l_ui
operator|<<
literal|22
operator|)
operator||
operator|(
name|num
operator|.
name|l_uf
operator|>>
literal|10
operator|)
expr_stmt|;
comment|/* put in the leading 254.0.0.0 */
name|temp
operator||=
name|UINT32_C
argument_list|(
literal|0xFE000000
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%03d %08x: "
argument_list|,
operator|(
name|temp
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
argument_list|,
operator|(
name|temp
operator|&
literal|0x00FFFFFF
operator|)
argument_list|)
expr_stmt|;
return|return
name|htonl
argument_list|(
name|temp
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Tests start here */
end_comment

begin_function_decl
name|void
name|rtol
parameter_list|(
name|uint32_t
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|rtol
parameter_list|(
name|uint32_t
name|r
parameter_list|)
block|{
name|l_fp
name|l
decl_stmt|;
name|printf
argument_list|(
literal|"rtol: "
argument_list|)
expr_stmt|;
name|l
operator|=
name|convertRefIDToLFP
argument_list|(
name|htonl
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"refid %#x, smear %s\n"
argument_list|,
name|r
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|l
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function_decl
name|void
name|rtoltor
parameter_list|(
name|uint32_t
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|rtoltor
parameter_list|(
name|uint32_t
name|r
parameter_list|)
block|{
name|l_fp
name|l
decl_stmt|;
name|printf
argument_list|(
literal|"rtoltor: "
argument_list|)
expr_stmt|;
name|l
operator|=
name|convertRefIDToLFP
argument_list|(
name|htonl
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|=
name|convertLFPToRefID
argument_list|(
name|l
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"smear %s, refid %#.8x\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|l
argument_list|,
literal|8
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function_decl
name|void
name|ltor
parameter_list|(
name|l_fp
name|l
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|ltor
parameter_list|(
name|l_fp
name|l
parameter_list|)
block|{
name|uint32_t
name|r
decl_stmt|;
name|printf
argument_list|(
literal|"ltor: "
argument_list|)
expr_stmt|;
name|r
operator|=
name|convertLFPToRefID
argument_list|(
name|l
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"smear %s, refid %#.8x\n"
argument_list|,
name|lfptoa
argument_list|(
operator|&
name|l
argument_list|,
literal|8
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|main
parameter_list|()
block|{
name|l_fp
name|l
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|init_lib
argument_list|()
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe800000
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe800001
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe8ffffe
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe8fffff
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfef00000
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfef00001
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfefffffe
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfeffffff
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe000000
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe000001
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe6ffffe
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe6fffff
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe700000
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe700001
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe7ffffe
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfe7fffff
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe800000
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe800001
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe8ffffe
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe8fffff
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfef00000
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfef00001
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfefffffe
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfeffffff
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe000000
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe000001
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe6ffffe
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe6fffff
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe700000
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe700001
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe7ffffe
argument_list|)
expr_stmt|;
name|rtoltor
argument_list|(
literal|0xfe7fffff
argument_list|)
expr_stmt|;
name|rc
operator|=
name|atolfp
argument_list|(
literal|"-.932087"
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
literal|1
operator|==
name|rc
argument_list|)
expr_stmt|;
name|ltor
argument_list|(
name|l
argument_list|)
expr_stmt|;
name|rtol
argument_list|(
literal|0xfec458b0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%x -> %d.%d.%d.%d\n"
argument_list|,
literal|0xfec458b0
argument_list|,
literal|0xfe
argument_list|,
literal|0xc4
argument_list|,
literal|0x58
argument_list|,
literal|0xb0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * /src/NTP/REPOSITORY/v4/parseutil/testdcf.c,v 3.18 1996/12/01 16:05:04 kardel Exp  *    * testdcf.c,v 3.18 1996/12/01 16:05:04 kardel Exp  *  * simple DCF77 100/200ms pulse test program (via 50Baud serial line)  *  * Copyright (c) 1993,1994,1995,1996, 1998 by Frank Kardel  * Friedrich-Alexander Universität Erlangen-Nürnberg, Germany  *                                      * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * This program may not be sold or used for profit without prior  * written consent of the author.  */
end_comment

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_comment
comment|/*  * state flags  */
end_comment

begin_define
define|#
directive|define
name|DCFB_ANNOUNCE
value|0x0001
end_define

begin_comment
comment|/* switch time zone warning (DST switch) */
end_comment

begin_define
define|#
directive|define
name|DCFB_DST
value|0x0002
end_define

begin_comment
comment|/* DST in effect */
end_comment

begin_define
define|#
directive|define
name|DCFB_LEAP
value|0x0004
end_define

begin_comment
comment|/* LEAP warning (1 hour prior to occurence) */
end_comment

begin_define
define|#
directive|define
name|DCFB_ALTERNATE
value|0x0008
end_define

begin_comment
comment|/* alternate antenna used */
end_comment

begin_struct
struct|struct
name|clocktime
comment|/* clock time broken up from time code */
block|{
name|long
name|wday
decl_stmt|;
name|long
name|day
decl_stmt|;
name|long
name|month
decl_stmt|;
name|long
name|year
decl_stmt|;
name|long
name|hour
decl_stmt|;
name|long
name|minute
decl_stmt|;
name|long
name|second
decl_stmt|;
name|long
name|usecond
decl_stmt|;
name|long
name|utcoffset
decl_stmt|;
comment|/* in minutes */
name|long
name|flags
decl_stmt|;
comment|/* current clock status */
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|clocktime
name|clocktime_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|TIMES10
parameter_list|(
name|_X_
parameter_list|)
value|(((_X_)<< 3) + ((_X_)<< 1))
end_define

begin_comment
comment|/*  * parser related return/error codes  */
end_comment

begin_define
define|#
directive|define
name|CVT_MASK
value|0x0000000F
end_define

begin_comment
comment|/* conversion exit code */
end_comment

begin_define
define|#
directive|define
name|CVT_NONE
value|0x00000001
end_define

begin_comment
comment|/* format not applicable */
end_comment

begin_define
define|#
directive|define
name|CVT_FAIL
value|0x00000002
end_define

begin_comment
comment|/* conversion failed - error code returned */
end_comment

begin_define
define|#
directive|define
name|CVT_OK
value|0x00000004
end_define

begin_comment
comment|/* conversion succeeded */
end_comment

begin_define
define|#
directive|define
name|CVT_BADFMT
value|0x00000010
end_define

begin_comment
comment|/* general format error - (unparsable) */
end_comment

begin_comment
comment|/*  * DCF77 raw time code  *  * From "Zur Zeit", Physikalisch-Technische Bundesanstalt (PTB), Braunschweig  * und Berlin, Maerz 1989  *  * Timecode transmission:  * AM:  *	time marks are send every second except for the second before the  *	next minute mark  *	time marks consist of a reduction of transmitter power to 25%  *	of the nominal level  *	the falling edge is the time indication (on time)  *	time marks of a 100ms duration constitute a logical 0  *	time marks of a 200ms duration constitute a logical 1  * FM:  *	see the spec. (basically a (non-)inverted psuedo random phase shift)  *  * Encoding:  * Second	Contents  * 0  - 10	AM: free, FM: 0  * 11 - 14	free  * 15		R     - alternate antenna  * 16		A1    - expect zone change (1 hour before)  * 17 - 18	Z1,Z2 - time zone  *		 0  0 illegal  *		 0  1 MEZ  (MET)  *		 1  0 MESZ (MED, MET DST)  *		 1  1 illegal  * 19		A2    - expect leap insertion/deletion (1 hour before)  * 20		S     - start of time code (1)  * 21 - 24	M1    - BCD (lsb first) Minutes  * 25 - 27	M10   - BCD (lsb first) 10 Minutes  * 28		P1    - Minute Parity (even)  * 29 - 32	H1    - BCD (lsb first) Hours  * 33 - 34      H10   - BCD (lsb first) 10 Hours  * 35		P2    - Hour Parity (even)  * 36 - 39	D1    - BCD (lsb first) Days  * 40 - 41	D10   - BCD (lsb first) 10 Days  * 42 - 44	DW    - BCD (lsb first) day of week (1: Monday -> 7: Sunday)  * 45 - 49	MO    - BCD (lsb first) Month  * 50           MO0   - 10 Months  * 51 - 53	Y1    - BCD (lsb first) Years  * 54 - 57	Y10   - BCD (lsb first) 10 Years  * 58 		P3    - Date Parity (even)  * 59		      - usually missing (minute indication), except for leap insertion  */
end_comment

begin_struct
specifier|static
struct|struct
name|rawdcfcode
block|{
name|char
name|offset
decl_stmt|;
comment|/* start bit */
block|}
name|rawdcfcode
index|[]
init|=
block|{
block|{
literal|0
block|}
block|,
block|{
literal|15
block|}
block|,
block|{
literal|16
block|}
block|,
block|{
literal|17
block|}
block|,
block|{
literal|19
block|}
block|,
block|{
literal|20
block|}
block|,
block|{
literal|21
block|}
block|,
block|{
literal|25
block|}
block|,
block|{
literal|28
block|}
block|,
block|{
literal|29
block|}
block|,
block|{
literal|33
block|}
block|,
block|{
literal|35
block|}
block|,
block|{
literal|36
block|}
block|,
block|{
literal|40
block|}
block|,
block|{
literal|42
block|}
block|,
block|{
literal|45
block|}
block|,
block|{
literal|49
block|}
block|,
block|{
literal|50
block|}
block|,
block|{
literal|54
block|}
block|,
block|{
literal|58
block|}
block|,
block|{
literal|59
block|}
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DCF_M
value|0
end_define

begin_define
define|#
directive|define
name|DCF_R
value|1
end_define

begin_define
define|#
directive|define
name|DCF_A1
value|2
end_define

begin_define
define|#
directive|define
name|DCF_Z
value|3
end_define

begin_define
define|#
directive|define
name|DCF_A2
value|4
end_define

begin_define
define|#
directive|define
name|DCF_S
value|5
end_define

begin_define
define|#
directive|define
name|DCF_M1
value|6
end_define

begin_define
define|#
directive|define
name|DCF_M10
value|7
end_define

begin_define
define|#
directive|define
name|DCF_P1
value|8
end_define

begin_define
define|#
directive|define
name|DCF_H1
value|9
end_define

begin_define
define|#
directive|define
name|DCF_H10
value|10
end_define

begin_define
define|#
directive|define
name|DCF_P2
value|11
end_define

begin_define
define|#
directive|define
name|DCF_D1
value|12
end_define

begin_define
define|#
directive|define
name|DCF_D10
value|13
end_define

begin_define
define|#
directive|define
name|DCF_DW
value|14
end_define

begin_define
define|#
directive|define
name|DCF_MO
value|15
end_define

begin_define
define|#
directive|define
name|DCF_MO0
value|16
end_define

begin_define
define|#
directive|define
name|DCF_Y1
value|17
end_define

begin_define
define|#
directive|define
name|DCF_Y10
value|18
end_define

begin_define
define|#
directive|define
name|DCF_P3
value|19
end_define

begin_struct
specifier|static
struct|struct
name|partab
block|{
name|char
name|offset
decl_stmt|;
comment|/* start bit of parity field */
block|}
name|partab
index|[]
init|=
block|{
block|{
literal|21
block|}
block|,
block|{
literal|29
block|}
block|,
block|{
literal|36
block|}
block|,
block|{
literal|59
block|}
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DCF_P_P1
value|0
end_define

begin_define
define|#
directive|define
name|DCF_P_P2
value|1
end_define

begin_define
define|#
directive|define
name|DCF_P_P3
value|2
end_define

begin_define
define|#
directive|define
name|DCF_Z_MET
value|0x2
end_define

begin_define
define|#
directive|define
name|DCF_Z_MED
value|0x1
end_define

begin_function
specifier|static
name|unsigned
name|long
name|ext_bf
parameter_list|(
specifier|register
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
specifier|register
name|int
name|idx
parameter_list|)
block|{
specifier|register
name|unsigned
name|long
name|sum
init|=
literal|0
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|first
decl_stmt|;
name|first
operator|=
name|rawdcfcode
index|[
name|idx
index|]
operator|.
name|offset
expr_stmt|;
for|for
control|(
name|i
operator|=
name|rawdcfcode
index|[
name|idx
operator|+
literal|1
index|]
operator|.
name|offset
operator|-
literal|1
init|;
name|i
operator|>=
name|first
condition|;
name|i
operator|--
control|)
block|{
name|sum
operator|<<=
literal|1
expr_stmt|;
name|sum
operator||=
operator|(
name|buf
index|[
name|i
index|]
operator|!=
literal|'-'
operator|)
expr_stmt|;
block|}
return|return
name|sum
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|pcheck
parameter_list|(
specifier|register
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
specifier|register
name|int
name|idx
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|last
decl_stmt|;
specifier|register
name|unsigned
name|psum
init|=
literal|1
decl_stmt|;
name|last
operator|=
name|partab
index|[
name|idx
operator|+
literal|1
index|]
operator|.
name|offset
expr_stmt|;
for|for
control|(
name|i
operator|=
name|partab
index|[
name|idx
index|]
operator|.
name|offset
init|;
name|i
operator|<
name|last
condition|;
name|i
operator|++
control|)
name|psum
operator|^=
operator|(
name|buf
index|[
name|i
index|]
operator|!=
literal|'-'
operator|)
expr_stmt|;
return|return
name|psum
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|long
name|convert_rawdcf
parameter_list|(
specifier|register
name|unsigned
name|char
modifier|*
name|buffer
parameter_list|,
specifier|register
name|int
name|size
parameter_list|,
specifier|register
name|clocktime_t
modifier|*
name|clock_time
parameter_list|)
block|{
if|if
condition|(
name|size
operator|<
literal|57
condition|)
block|{
name|printf
argument_list|(
literal|"%-30s"
argument_list|,
literal|"*** INCOMPLETE"
argument_list|)
expr_stmt|;
return|return
name|CVT_NONE
return|;
block|}
comment|/* 	 * check Start and Parity bits 	 */
if|if
condition|(
operator|(
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_S
argument_list|)
operator|==
literal|1
operator|)
operator|&&
name|pcheck
argument_list|(
name|buffer
argument_list|,
name|DCF_P_P1
argument_list|)
operator|&&
name|pcheck
argument_list|(
name|buffer
argument_list|,
name|DCF_P_P2
argument_list|)
operator|&&
name|pcheck
argument_list|(
name|buffer
argument_list|,
name|DCF_P_P3
argument_list|)
condition|)
block|{
comment|/* 		 * buffer OK 		 */
name|clock_time
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|->
name|usecond
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|->
name|second
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|->
name|minute
operator|=
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_M10
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|minute
operator|=
name|TIMES10
argument_list|(
name|clock_time
operator|->
name|minute
argument_list|)
operator|+
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_M1
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|hour
operator|=
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_H10
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|hour
operator|=
name|TIMES10
argument_list|(
name|clock_time
operator|->
name|hour
argument_list|)
operator|+
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_H1
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|day
operator|=
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_D10
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|day
operator|=
name|TIMES10
argument_list|(
name|clock_time
operator|->
name|day
argument_list|)
operator|+
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_D1
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|month
operator|=
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_MO0
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|month
operator|=
name|TIMES10
argument_list|(
name|clock_time
operator|->
name|month
argument_list|)
operator|+
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_MO
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|year
operator|=
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_Y10
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|year
operator|=
name|TIMES10
argument_list|(
name|clock_time
operator|->
name|year
argument_list|)
operator|+
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_Y1
argument_list|)
expr_stmt|;
name|clock_time
operator|->
name|wday
operator|=
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_DW
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_Z
argument_list|)
condition|)
block|{
case|case
name|DCF_Z_MET
case|:
name|clock_time
operator|->
name|utcoffset
operator|=
operator|-
literal|60
expr_stmt|;
break|break;
case|case
name|DCF_Z_MED
case|:
name|clock_time
operator|->
name|flags
operator||=
name|DCFB_DST
expr_stmt|;
name|clock_time
operator|->
name|utcoffset
operator|=
operator|-
literal|120
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%-30s"
argument_list|,
literal|"*** BAD TIME ZONE"
argument_list|)
expr_stmt|;
return|return
name|CVT_FAIL
operator||
name|CVT_BADFMT
return|;
block|}
if|if
condition|(
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_A1
argument_list|)
condition|)
name|clock_time
operator|->
name|flags
operator||=
name|DCFB_ANNOUNCE
expr_stmt|;
if|if
condition|(
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_A2
argument_list|)
condition|)
name|clock_time
operator|->
name|flags
operator||=
name|DCFB_LEAP
expr_stmt|;
if|if
condition|(
name|ext_bf
argument_list|(
name|buffer
argument_list|,
name|DCF_R
argument_list|)
condition|)
name|clock_time
operator|->
name|flags
operator||=
name|DCFB_ALTERNATE
expr_stmt|;
return|return
name|CVT_OK
return|;
block|}
else|else
block|{
comment|/* 		 * bad format - not for us 		 */
name|printf
argument_list|(
literal|"%-30s"
argument_list|,
literal|"*** BAD FORMAT (invalid/parity)"
argument_list|)
expr_stmt|;
return|return
name|CVT_FAIL
operator||
name|CVT_BADFMT
return|;
block|}
block|}
end_function

begin_function
name|char
name|type
parameter_list|(
name|unsigned
name|int
name|c
parameter_list|)
block|{
name|c
operator|^=
literal|0xFF
expr_stmt|;
return|return
operator|(
name|c
operator|>
literal|0xF
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|wday
index|[
literal|8
index|]
init|=
block|{
literal|"??"
block|,
literal|"Mo"
block|,
literal|"Tu"
block|,
literal|"We"
block|,
literal|"Th"
block|,
literal|"Fr"
block|,
literal|"Sa"
block|,
literal|"Su"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|pat
index|[]
init|=
literal|"-\\|/"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LINES
value|(24-2)
end_define

begin_comment
comment|/* error lines after which the two headlines are repeated */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
if|if
condition|(
operator|(
name|argc
operator|!=
literal|2
operator|)
operator|&&
operator|(
name|argc
operator|!=
literal|3
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [-f|-t|-ft|-tf]<device>\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|unsigned
name|char
name|c
decl_stmt|;
name|char
modifier|*
name|file
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|int
name|offset
init|=
literal|15
decl_stmt|;
name|int
name|trace
init|=
literal|0
decl_stmt|;
name|int
name|errs
init|=
name|LINES
operator|+
literal|1
decl_stmt|;
comment|/* 		 * SIMPLE(!) argument "parser" 		 */
if|if
condition|(
name|argc
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-f"
argument_list|)
operator|==
literal|0
condition|)
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-t"
argument_list|)
operator|==
literal|0
condition|)
name|trace
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-ft"
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-tf"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|offset
operator|=
literal|0
expr_stmt|;
name|trace
operator|=
literal|1
expr_stmt|;
block|}
name|file
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
block|}
else|else
block|{
name|file
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|file
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|TIOCM_RTS
name|int
name|on
init|=
name|TIOCM_RTS
decl_stmt|;
endif|#
directive|endif
name|struct
name|timeval
name|t
decl_stmt|,
name|tt
decl_stmt|,
name|tlast
decl_stmt|;
name|char
name|buf
index|[
literal|61
index|]
decl_stmt|;
name|clocktime_t
name|clock_time
decl_stmt|;
name|struct
name|termios
name|term
decl_stmt|;
name|int
name|rtc
init|=
name|CVT_NONE
decl_stmt|;
if|if
condition|(
name|tcgetattr
argument_list|(
name|fd
argument_list|,
operator|&
name|term
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"tcgetattr"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|term
operator|.
name|c_cc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|term
operator|.
name|c_cc
argument_list|)
argument_list|)
expr_stmt|;
name|term
operator|.
name|c_cc
index|[
name|VMIN
index|]
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|NO_PARENB_IGNPAR
comment|/* Was: defined(SYS_IRIX4) || defined (SYS_IRIX5) */
comment|/* somehow doesn't grok PARENB& IGNPAR (mj) */
name|term
operator|.
name|c_cflag
operator|=
name|B50
operator||
name|CS8
operator||
name|CREAD
operator||
name|CLOCAL
expr_stmt|;
else|#
directive|else
name|term
operator|.
name|c_cflag
operator|=
name|B50
operator||
name|CS8
operator||
name|CREAD
operator||
name|CLOCAL
operator||
name|PARENB
expr_stmt|;
endif|#
directive|endif
name|term
operator|.
name|c_iflag
operator|=
name|IGNPAR
expr_stmt|;
name|term
operator|.
name|c_oflag
operator|=
literal|0
expr_stmt|;
name|term
operator|.
name|c_lflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tcsetattr
argument_list|(
name|fd
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|term
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"tcsetattr"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|I_POP
while|while
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|I_POP
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
empty_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|TIOCMBIC
argument_list|)
operator|&&
name|defined
argument_list|(
name|TIOCM_RTS
argument_list|)
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|TIOCMBIC
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|on
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"TIOCM_RTS"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|printf
argument_list|(
literal|"  DCF77 monitor - Copyright (C) 1993-1996, Frank Kardel\n\n"
argument_list|)
expr_stmt|;
name|clock_time
operator|.
name|hour
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|minute
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|day
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|wday
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|month
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|year
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|buf
index|[
literal|60
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|60
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
literal|'.'
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|tlast
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|read
argument_list|(
name|fd
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
condition|)
block|{
name|gettimeofday
argument_list|(
operator|&
name|t
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
name|tt
operator|=
name|t
expr_stmt|;
name|t
operator|.
name|tv_sec
operator|-=
name|tlast
operator|.
name|tv_sec
expr_stmt|;
name|t
operator|.
name|tv_usec
operator|-=
name|tlast
operator|.
name|tv_usec
expr_stmt|;
if|if
condition|(
name|t
operator|.
name|tv_usec
operator|<
literal|0
condition|)
block|{
name|t
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
name|t
operator|.
name|tv_sec
operator|-=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|errs
operator|>
name|LINES
condition|)
block|{
name|printf
argument_list|(
literal|"  %s"
argument_list|,
operator|&
literal|"PTB private....RADMLSMin....PHour..PMDay..DayMonthYear....P\n"
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %s"
argument_list|,
operator|&
literal|"---------------RADMLS1248124P124812P1248121241248112481248P\n"
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
name|errs
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|t
operator|.
name|tv_sec
operator|>
literal|1
operator|||
operator|(
name|t
operator|.
name|tv_sec
operator|==
literal|1
operator|&&
name|t
operator|.
name|tv_usec
operator|>
literal|500000
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%c %.*s "
argument_list|,
name|pat
index|[
name|i
operator|%
operator|(
sizeof|sizeof
argument_list|(
name|pat
argument_list|)
operator|-
literal|1
operator|)
index|]
argument_list|,
literal|59
operator|-
name|offset
argument_list|,
operator|&
name|buf
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rtc
operator|=
name|convert_rawdcf
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
operator|&
name|clock_time
argument_list|)
operator|)
operator|!=
name|CVT_OK
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|clock_time
operator|.
name|hour
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|minute
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|day
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|wday
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|month
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|year
operator|=
literal|0
expr_stmt|;
name|clock_time
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|errs
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|c
operator|^
literal|0xFF
operator|)
operator|+
literal|1
operator|)
operator|&
operator|(
name|c
operator|^
literal|0xFF
operator|)
condition|)
name|buf
index|[
literal|0
index|]
operator|=
literal|'?'
expr_stmt|;
else|else
name|buf
index|[
literal|0
index|]
operator|=
name|type
argument_list|(
name|c
argument_list|)
condition|?
literal|'#'
else|:
literal|'-'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|60
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
literal|'.'
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|(
name|c
operator|^
literal|0xFF
operator|)
operator|+
literal|1
operator|)
operator|&
operator|(
name|c
operator|^
literal|0xFF
operator|)
condition|)
name|buf
index|[
name|i
index|]
operator|=
literal|'?'
expr_stmt|;
else|else
name|buf
index|[
name|i
index|]
operator|=
name|type
argument_list|(
name|c
argument_list|)
condition|?
literal|'#'
else|:
literal|'-'
expr_stmt|;
name|printf
argument_list|(
literal|"%c %.*s "
argument_list|,
name|pat
index|[
name|i
operator|%
operator|(
sizeof|sizeof
argument_list|(
name|pat
argument_list|)
operator|-
literal|1
operator|)
index|]
argument_list|,
literal|59
operator|-
name|offset
argument_list|,
operator|&
name|buf
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rtc
operator|==
name|CVT_OK
condition|)
block|{
name|printf
argument_list|(
literal|"%s, %2d:%02d:%02d, %d.%02d.%02d,<%s%s%s%s>"
argument_list|,
name|wday
index|[
name|clock_time
operator|.
name|wday
index|]
argument_list|,
operator|(
name|int
operator|)
name|clock_time
operator|.
name|hour
argument_list|,
operator|(
name|int
operator|)
name|clock_time
operator|.
name|minute
argument_list|,
operator|(
name|int
operator|)
name|i
argument_list|,
operator|(
name|int
operator|)
name|clock_time
operator|.
name|day
argument_list|,
operator|(
name|int
operator|)
name|clock_time
operator|.
name|month
argument_list|,
operator|(
name|int
operator|)
name|clock_time
operator|.
name|year
argument_list|,
operator|(
name|clock_time
operator|.
name|flags
operator|&
name|DCFB_ALTERNATE
operator|)
condition|?
literal|"R"
else|:
literal|"_"
argument_list|,
operator|(
name|clock_time
operator|.
name|flags
operator|&
name|DCFB_ANNOUNCE
operator|)
condition|?
literal|"A"
else|:
literal|"_"
argument_list|,
operator|(
name|clock_time
operator|.
name|flags
operator|&
name|DCFB_DST
operator|)
condition|?
literal|"D"
else|:
literal|"_"
argument_list|,
operator|(
name|clock_time
operator|.
name|flags
operator|&
name|DCFB_LEAP
operator|)
condition|?
literal|"L"
else|:
literal|"_"
argument_list|)
expr_stmt|;
if|if
condition|(
name|trace
operator|&&
operator|(
name|i
operator|==
literal|0
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|errs
operator|++
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|60
condition|)
block|{
name|i
operator|++
expr_stmt|;
block|}
name|tlast
operator|=
name|tt
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2004, 2007, 2009  Internet Systems Consortium, Inc. ("ISC")  * Copyright (C) 2001  Internet Software Consortium.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id: ntpaths.c,v 1.15 2009/07/14 22:54:57 each Exp $ */
end_comment

begin_comment
comment|/*  * This module fetches the required path information that is specific  * to NT systems which can have its configuration and system files  * almost anywhere. It can be used to override whatever the application  * had previously assigned to the pointer. Basic information about the  * file locations are stored in the registry.  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<isc/bind_registry.h>
end_include

begin_include
include|#
directive|include
file|<isc/ntpaths.h>
end_include

begin_comment
comment|/*  * Module Variables  */
end_comment

begin_decl_stmt
specifier|static
name|char
name|systemDir
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|namedBase
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|ns_confFile
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|lwresd_confFile
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|lwresd_resolvconfFile
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|rndc_confFile
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|ns_defaultpidfile
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|lwresd_defaultpidfile
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|local_state_dir
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|sys_conf_dir
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|rndc_keyFile
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|session_keyFile
index|[
name|MAX_PATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|DWORD
name|baseLen
init|=
name|MAX_PATH
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|BOOL
name|Initialized
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|isc_ntpaths_init
parameter_list|()
block|{
name|HKEY
name|hKey
decl_stmt|;
name|BOOL
name|keyFound
init|=
name|TRUE
decl_stmt|;
name|memset
argument_list|(
name|namedBase
argument_list|,
literal|0
argument_list|,
name|MAX_PATH
argument_list|)
expr_stmt|;
if|if
condition|(
name|RegOpenKeyEx
argument_list|(
name|HKEY_LOCAL_MACHINE
argument_list|,
name|BIND_SUBKEY
argument_list|,
literal|0
argument_list|,
name|KEY_READ
argument_list|,
operator|&
name|hKey
argument_list|)
operator|!=
name|ERROR_SUCCESS
condition|)
name|keyFound
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|keyFound
operator|==
name|TRUE
condition|)
block|{
comment|/* Get the named directory */
if|if
condition|(
name|RegQueryValueEx
argument_list|(
name|hKey
argument_list|,
literal|"InstallDir"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
name|namedBase
argument_list|,
operator|&
name|baseLen
argument_list|)
operator|!=
name|ERROR_SUCCESS
condition|)
name|keyFound
operator|=
name|FALSE
expr_stmt|;
name|RegCloseKey
argument_list|(
name|hKey
argument_list|)
expr_stmt|;
block|}
name|GetSystemDirectory
argument_list|(
name|systemDir
argument_list|,
name|MAX_PATH
argument_list|)
expr_stmt|;
if|if
condition|(
name|keyFound
operator|==
name|FALSE
condition|)
comment|/* Use the System Directory as a default */
name|strcpy
argument_list|(
name|namedBase
argument_list|,
name|systemDir
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ns_confFile
argument_list|,
name|namedBase
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ns_confFile
argument_list|,
literal|"\\etc\\named.conf"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|lwresd_confFile
argument_list|,
name|namedBase
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|lwresd_confFile
argument_list|,
literal|"\\etc\\lwresd.conf"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|lwresd_resolvconfFile
argument_list|,
name|systemDir
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|lwresd_resolvconfFile
argument_list|,
literal|"\\Drivers\\etc\\resolv.conf"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|rndc_keyFile
argument_list|,
name|namedBase
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|rndc_keyFile
argument_list|,
literal|"\\etc\\rndc.key"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|session_keyFile
argument_list|,
name|namedBase
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|session_keyFile
argument_list|,
literal|"\\etc\\session.key"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|rndc_confFile
argument_list|,
name|namedBase
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|rndc_confFile
argument_list|,
literal|"\\etc\\rndc.conf"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ns_defaultpidfile
argument_list|,
name|namedBase
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|ns_defaultpidfile
argument_list|,
literal|"\\etc\\named.pid"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|lwresd_defaultpidfile
argument_list|,
name|namedBase
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|lwresd_defaultpidfile
argument_list|,
literal|"\\etc\\lwresd.pid"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|local_state_dir
argument_list|,
name|namedBase
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|local_state_dir
argument_list|,
literal|"\\bin"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|sys_conf_dir
argument_list|,
name|namedBase
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|sys_conf_dir
argument_list|,
literal|"\\etc"
argument_list|)
expr_stmt|;
name|Initialized
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|isc_ntpaths_get
parameter_list|(
name|int
name|ind
parameter_list|)
block|{
if|if
condition|(
operator|!
name|Initialized
condition|)
name|isc_ntpaths_init
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|ind
condition|)
block|{
case|case
name|NAMED_CONF_PATH
case|:
return|return
operator|(
name|ns_confFile
operator|)
return|;
break|break;
case|case
name|LWRES_CONF_PATH
case|:
return|return
operator|(
name|lwresd_confFile
operator|)
return|;
break|break;
case|case
name|RESOLV_CONF_PATH
case|:
return|return
operator|(
name|lwresd_resolvconfFile
operator|)
return|;
break|break;
case|case
name|RNDC_CONF_PATH
case|:
return|return
operator|(
name|rndc_confFile
operator|)
return|;
break|break;
case|case
name|NAMED_PID_PATH
case|:
return|return
operator|(
name|ns_defaultpidfile
operator|)
return|;
break|break;
case|case
name|LWRESD_PID_PATH
case|:
return|return
operator|(
name|lwresd_defaultpidfile
operator|)
return|;
break|break;
case|case
name|LOCAL_STATE_DIR
case|:
return|return
operator|(
name|local_state_dir
operator|)
return|;
break|break;
case|case
name|SYS_CONF_DIR
case|:
return|return
operator|(
name|sys_conf_dir
operator|)
return|;
break|break;
case|case
name|RNDC_KEY_PATH
case|:
return|return
operator|(
name|rndc_keyFile
operator|)
return|;
break|break;
case|case
name|SESSION_KEY_PATH
case|:
return|return
operator|(
name|session_keyFile
operator|)
return|;
break|break;
default|default:
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
end_function

end_unit


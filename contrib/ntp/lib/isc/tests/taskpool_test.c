begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2011, 2012  Internet Systems Consortium, Inc. ("ISC")  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND ISC DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS.  IN NO EVENT SHALL ISC BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE  * OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* $Id$ */
end_comment

begin_comment
comment|/*! \file */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<atf-c.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<isc/task.h>
end_include

begin_include
include|#
directive|include
file|<isc/taskpool.h>
end_include

begin_include
include|#
directive|include
file|"isctest.h"
end_include

begin_comment
comment|/*  * Individual unit tests  */
end_comment

begin_comment
comment|/* Create a taskpool */
end_comment

begin_expr_stmt
name|ATF_TC
argument_list|(
name|create_pool
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|create_pool
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"create a taskpool"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|create_pool
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_taskpool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
name|UNUSED
argument_list|(
name|tc
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_test_begin
argument_list|(
name|NULL
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_taskpool_create
argument_list|(
name|taskmgr
argument_list|,
name|mctx
argument_list|,
literal|8
argument_list|,
literal|2
argument_list|,
operator|&
name|pool
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|isc_taskpool_size
argument_list|(
name|pool
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|isc_taskpool_destroy
argument_list|(
operator|&
name|pool
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|isc_test_end
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Resize a taskpool */
end_comment

begin_expr_stmt
name|ATF_TC
argument_list|(
name|expand_pool
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|expand_pool
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"expand a taskpool"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|expand_pool
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_taskpool_t
modifier|*
name|pool1
init|=
name|NULL
decl_stmt|,
modifier|*
name|pool2
init|=
name|NULL
decl_stmt|,
modifier|*
name|hold
init|=
name|NULL
decl_stmt|;
name|UNUSED
argument_list|(
name|tc
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_test_begin
argument_list|(
name|NULL
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_taskpool_create
argument_list|(
name|taskmgr
argument_list|,
name|mctx
argument_list|,
literal|10
argument_list|,
literal|2
argument_list|,
operator|&
name|pool1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|isc_taskpool_size
argument_list|(
name|pool1
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* resizing to a smaller size should have no effect */
name|hold
operator|=
name|pool1
expr_stmt|;
name|result
operator|=
name|isc_taskpool_expand
argument_list|(
operator|&
name|pool1
argument_list|,
literal|5
argument_list|,
operator|&
name|pool2
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|isc_taskpool_size
argument_list|(
name|pool2
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|pool2
argument_list|,
name|hold
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|pool1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pool1
operator|=
name|pool2
expr_stmt|;
name|pool2
operator|=
name|NULL
expr_stmt|;
comment|/* resizing to the same size should have no effect */
name|hold
operator|=
name|pool1
expr_stmt|;
name|result
operator|=
name|isc_taskpool_expand
argument_list|(
operator|&
name|pool1
argument_list|,
literal|10
argument_list|,
operator|&
name|pool2
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|isc_taskpool_size
argument_list|(
name|pool2
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|pool2
argument_list|,
name|hold
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|pool1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pool1
operator|=
name|pool2
expr_stmt|;
name|pool2
operator|=
name|NULL
expr_stmt|;
comment|/* resizing to larger size should make a new pool */
name|hold
operator|=
name|pool1
expr_stmt|;
name|result
operator|=
name|isc_taskpool_expand
argument_list|(
operator|&
name|pool1
argument_list|,
literal|20
argument_list|,
operator|&
name|pool2
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|isc_taskpool_size
argument_list|(
name|pool2
argument_list|)
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|pool2
operator|!=
name|hold
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|pool1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|isc_taskpool_destroy
argument_list|(
operator|&
name|pool2
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|pool2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|isc_test_end
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Get tasks */
end_comment

begin_expr_stmt
name|ATF_TC
argument_list|(
name|get_tasks
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|get_tasks
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"create a taskpool"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|get_tasks
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_taskpool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
name|isc_task_t
modifier|*
name|task1
init|=
name|NULL
decl_stmt|,
modifier|*
name|task2
init|=
name|NULL
decl_stmt|,
modifier|*
name|task3
init|=
name|NULL
decl_stmt|;
name|UNUSED
argument_list|(
name|tc
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_test_begin
argument_list|(
name|NULL
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_taskpool_create
argument_list|(
name|taskmgr
argument_list|,
name|mctx
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
operator|&
name|pool
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|isc_taskpool_size
argument_list|(
name|pool
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* two tasks in pool; make sure we can access them more than twice */
name|isc_taskpool_gettask
argument_list|(
name|pool
argument_list|,
operator|&
name|task1
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ISCAPI_TASK_VALID
argument_list|(
name|task1
argument_list|)
argument_list|)
expr_stmt|;
name|isc_taskpool_gettask
argument_list|(
name|pool
argument_list|,
operator|&
name|task2
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ISCAPI_TASK_VALID
argument_list|(
name|task2
argument_list|)
argument_list|)
expr_stmt|;
name|isc_taskpool_gettask
argument_list|(
name|pool
argument_list|,
operator|&
name|task3
argument_list|)
expr_stmt|;
name|ATF_REQUIRE
argument_list|(
name|ISCAPI_TASK_VALID
argument_list|(
name|task3
argument_list|)
argument_list|)
expr_stmt|;
name|isc_task_destroy
argument_list|(
operator|&
name|task1
argument_list|)
expr_stmt|;
name|isc_task_destroy
argument_list|(
operator|&
name|task2
argument_list|)
expr_stmt|;
name|isc_task_destroy
argument_list|(
operator|&
name|task3
argument_list|)
expr_stmt|;
name|isc_taskpool_destroy
argument_list|(
operator|&
name|pool
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|isc_test_end
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Get tasks */
end_comment

begin_expr_stmt
name|ATF_TC
argument_list|(
name|set_privilege
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
name|ATF_TC_HEAD
argument_list|(
argument|set_privilege
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|atf_tc_set_md_var
argument_list|(
name|tc
argument_list|,
literal|"descr"
argument_list|,
literal|"create a taskpool"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ATF_TC_BODY
argument_list|(
argument|set_privilege
argument_list|,
argument|tc
argument_list|)
end_macro

begin_block
block|{
name|isc_result_t
name|result
decl_stmt|;
name|isc_taskpool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
name|isc_task_t
modifier|*
name|task1
init|=
name|NULL
decl_stmt|,
modifier|*
name|task2
init|=
name|NULL
decl_stmt|,
modifier|*
name|task3
init|=
name|NULL
decl_stmt|;
name|UNUSED
argument_list|(
name|tc
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_test_begin
argument_list|(
name|NULL
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|result
operator|=
name|isc_taskpool_create
argument_list|(
name|taskmgr
argument_list|,
name|mctx
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
operator|&
name|pool
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|result
argument_list|,
name|ISC_R_SUCCESS
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|isc_taskpool_size
argument_list|(
name|pool
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|isc_taskpool_setprivilege
argument_list|(
name|pool
argument_list|,
name|ISC_TRUE
argument_list|)
expr_stmt|;
name|isc_taskpool_gettask
argument_list|(
name|pool
argument_list|,
operator|&
name|task1
argument_list|)
expr_stmt|;
name|isc_taskpool_gettask
argument_list|(
name|pool
argument_list|,
operator|&
name|task2
argument_list|)
expr_stmt|;
name|isc_taskpool_gettask
argument_list|(
name|pool
argument_list|,
operator|&
name|task3
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|ISCAPI_TASK_VALID
argument_list|(
name|task1
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|ISCAPI_TASK_VALID
argument_list|(
name|task2
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|ISCAPI_TASK_VALID
argument_list|(
name|task3
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|isc_task_privilege
argument_list|(
name|task1
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|isc_task_privilege
argument_list|(
name|task2
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
name|isc_task_privilege
argument_list|(
name|task3
argument_list|)
argument_list|)
expr_stmt|;
name|isc_taskpool_setprivilege
argument_list|(
name|pool
argument_list|,
name|ISC_FALSE
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
operator|!
name|isc_task_privilege
argument_list|(
name|task1
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
operator|!
name|isc_task_privilege
argument_list|(
name|task2
argument_list|)
argument_list|)
expr_stmt|;
name|ATF_CHECK
argument_list|(
operator|!
name|isc_task_privilege
argument_list|(
name|task3
argument_list|)
argument_list|)
expr_stmt|;
name|isc_task_destroy
argument_list|(
operator|&
name|task1
argument_list|)
expr_stmt|;
name|isc_task_destroy
argument_list|(
operator|&
name|task2
argument_list|)
expr_stmt|;
name|isc_task_destroy
argument_list|(
operator|&
name|task3
argument_list|)
expr_stmt|;
name|isc_taskpool_destroy
argument_list|(
operator|&
name|pool
argument_list|)
expr_stmt|;
name|ATF_REQUIRE_EQ
argument_list|(
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|isc_test_end
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Main  */
end_comment

begin_macro
name|ATF_TP_ADD_TCS
argument_list|(
argument|tp
argument_list|)
end_macro

begin_block
block|{
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|create_pool
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|expand_pool
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|get_tasks
argument_list|)
expr_stmt|;
name|ATF_TP_ADD_TC
argument_list|(
name|tp
argument_list|,
name|set_privilege
argument_list|)
expr_stmt|;
return|return
operator|(
name|atf_no_error
argument_list|()
operator|)
return|;
block|}
end_block

end_unit


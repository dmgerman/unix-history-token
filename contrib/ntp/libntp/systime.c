begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * systime -- routines to fiddle a UNIX clock.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_PARAM_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UTMP_H
end_ifdef

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_UTMP_H */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UTMPX_H
end_ifdef

begin_include
include|#
directive|include
file|<utmpx.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_UTMPX_H */
end_comment

begin_include
include|#
directive|include
file|"ntp_machine.h"
end_include

begin_include
include|#
directive|include
file|"ntp_fp.h"
end_include

begin_include
include|#
directive|include
file|"ntp_syslog.h"
end_include

begin_include
include|#
directive|include
file|"ntp_unixtime.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_if
if|#
directive|if
name|defined
name|SYS_WINNT
end_if

begin_include
include|#
directive|include
file|"ntp_timer.h"
end_include

begin_decl_stmt
specifier|extern
name|DWORD
name|units_per_tick
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|last_Adj
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|systime_10ms_ticks
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* adj sysclock in 10ms increments */
end_comment

begin_define
define|#
directive|define
name|MAXFREQ
value|500e-6
end_define

begin_comment
comment|/*  * These routines (init_systime, get_systime, step_systime, adj_systime)  * implement an interface between the (more or less) system independent  * bits of NTP and the peculiarities of dealing with the Unix system  * clock.  */
end_comment

begin_decl_stmt
name|double
name|sys_residual
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* residual from previous adjustment */
end_comment

begin_decl_stmt
name|double
name|sys_maxfreq
init|=
name|MAXFREQ
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* max frequency correction */
end_comment

begin_comment
comment|/*  * get_systime - return the system time in timestamp format biased by  * the current time offset.  */
end_comment

begin_function
name|void
name|get_systime
parameter_list|(
name|l_fp
modifier|*
name|now
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|HAVE_CLOCK_GETTIME
argument_list|)
operator|||
name|defined
argument_list|(
name|HAVE_GETCLOCK
argument_list|)
name|struct
name|timespec
name|ts
decl_stmt|;
else|#
directive|else
name|struct
name|timeval
name|tv
decl_stmt|;
endif|#
directive|endif
name|double
name|dtemp
decl_stmt|;
comment|/* 	 * We use nanosecond time if we can get it. Watch out for 	 * rounding wiggles, which may overflow the fraction. 	 */
if|#
directive|if
name|defined
argument_list|(
name|HAVE_CLOCK_GETTIME
argument_list|)
operator|||
name|defined
argument_list|(
name|HAVE_GETCLOCK
argument_list|)
ifdef|#
directive|ifdef
name|HAVE_CLOCK_GETTIME
operator|(
name|void
operator|)
name|clock_gettime
argument_list|(
name|CLOCK_REALTIME
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
else|#
directive|else
operator|(
name|void
operator|)
name|getclock
argument_list|(
name|TIMEOFDAY
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|now
operator|->
name|l_i
operator|=
name|ts
operator|.
name|tv_sec
operator|+
name|JAN_1970
expr_stmt|;
name|dtemp
operator|=
name|ts
operator|.
name|tv_nsec
operator|*
name|FRAC
operator|/
literal|1e9
expr_stmt|;
if|if
condition|(
name|dtemp
operator|>=
name|FRAC
condition|)
name|now
operator|->
name|l_i
operator|++
expr_stmt|;
name|now
operator|->
name|l_uf
operator|=
operator|(
name|u_int32
operator|)
name|dtemp
expr_stmt|;
else|#
directive|else
comment|/* HAVE_CLOCK_GETTIME */
operator|(
name|void
operator|)
name|GETTIMEOFDAY
argument_list|(
operator|&
name|tv
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|now
operator|->
name|l_i
operator|=
name|tv
operator|.
name|tv_sec
operator|+
name|JAN_1970
expr_stmt|;
if|if
condition|(
name|systime_10ms_ticks
condition|)
block|{
comment|/* fake better than 10ms resolution by interpolating  	   	accumulated residual (in adj_systime(), see below) */
name|dtemp
operator|=
name|tv
operator|.
name|tv_usec
operator|/
literal|1e6
expr_stmt|;
if|if
condition|(
name|sys_residual
operator|<
literal|5000e-6
operator|&&
name|sys_residual
operator|>
operator|-
literal|5000e-6
condition|)
block|{
name|dtemp
operator|+=
name|sys_residual
expr_stmt|;
if|if
condition|(
name|dtemp
operator|<
literal|0
condition|)
block|{
name|now
operator|->
name|l_i
operator|--
expr_stmt|;
name|dtemp
operator|++
expr_stmt|;
block|}
block|}
name|dtemp
operator|*=
name|FRAC
expr_stmt|;
block|}
else|else
block|{
name|dtemp
operator|=
name|tv
operator|.
name|tv_usec
operator|*
name|FRAC
operator|/
literal|1e6
expr_stmt|;
block|}
if|if
condition|(
name|dtemp
operator|>=
name|FRAC
condition|)
name|now
operator|->
name|l_i
operator|++
expr_stmt|;
name|now
operator|->
name|l_uf
operator|=
operator|(
name|u_int32
operator|)
name|dtemp
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_CLOCK_GETTIME */
block|}
end_function

begin_comment
comment|/*  * adj_systime - called once every second to make system time adjustments.  * Returns 1 if okay, 0 if trouble.  */
end_comment

begin_function
name|int
name|adj_systime
parameter_list|(
name|double
name|now
parameter_list|)
block|{
name|double
name|dtemp
decl_stmt|;
name|struct
name|timeval
name|adjtv
decl_stmt|;
name|u_char
name|isneg
init|=
literal|0
decl_stmt|;
if|#
directive|if
operator|!
name|defined
name|SYS_WINNT
operator|&&
operator|!
name|defined
name|SYS_CYGWIN32
name|struct
name|timeval
name|oadjtv
decl_stmt|;
else|#
directive|else
name|int
name|rc
decl_stmt|;
name|long
name|dwTimeAdjustment
decl_stmt|;
endif|#
directive|endif
comment|/* 	 * Add the residual from the previous adjustment to the new 	 * adjustment, bound and round. 	 */
name|dtemp
operator|=
name|sys_residual
operator|+
name|now
expr_stmt|;
name|sys_residual
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dtemp
operator|<
literal|0
condition|)
block|{
name|isneg
operator|=
literal|1
expr_stmt|;
name|dtemp
operator|=
operator|-
name|dtemp
expr_stmt|;
block|}
if|if
condition|(
name|systime_10ms_ticks
condition|)
block|{
comment|/* accumulate changes until we have enough to adjust a tick */
if|if
condition|(
name|dtemp
operator|<
literal|5000e-6
condition|)
block|{
if|if
condition|(
name|isneg
condition|)
name|sys_residual
operator|=
operator|-
name|dtemp
expr_stmt|;
else|else
name|sys_residual
operator|=
name|dtemp
expr_stmt|;
name|dtemp
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|isneg
condition|)
name|sys_residual
operator|=
literal|10000e-6
operator|-
name|dtemp
expr_stmt|;
else|else
name|sys_residual
operator|=
name|dtemp
operator|-
literal|10000e-6
expr_stmt|;
name|dtemp
operator|=
literal|10000e-6
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|dtemp
operator|>
name|sys_maxfreq
condition|)
name|dtemp
operator|=
name|sys_maxfreq
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SYS_WINNT
name|dtemp
operator|=
name|dtemp
operator|*
literal|1000000.0
expr_stmt|;
else|#
directive|else
name|dtemp
operator|=
name|dtemp
operator|*
literal|1e6
operator|+
literal|.5
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|isneg
condition|)
name|dtemp
operator|=
operator|-
name|dtemp
expr_stmt|;
name|adjtv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|adjtv
operator|.
name|tv_usec
operator|=
operator|(
name|int32
operator|)
name|dtemp
expr_stmt|;
if|#
directive|if
name|defined
name|SYS_WINNT
operator|||
name|defined
name|SYS_CYGWIN32
comment|/* dtemp is in micro seconds. NT uses 100 ns units, 	 * so a unit change in dwTimeAdjustment corresponds 	 * to slewing 10 ppm.  	 * Calculate the number of 100ns units to add,  	 * and leave the remainder in dtemp */
name|dwTimeAdjustment
operator|=
name|dtemp
operator|/
literal|10
expr_stmt|;
name|dtemp
operator|+=
operator|(
name|double
operator|)
operator|-
name|dwTimeAdjustment
operator|*
literal|10.0
expr_stmt|;
name|dwTimeAdjustment
operator|+=
name|units_per_tick
expr_stmt|;
comment|/* only adjust the clock if adjustment changes */
if|if
condition|(
name|last_Adj
operator|!=
name|dwTimeAdjustment
condition|)
block|{
name|last_Adj
operator|=
name|dwTimeAdjustment
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"SetSystemTimeAdjustment( %ld)\n"
argument_list|,
name|dwTimeAdjustment
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rc
operator|=
operator|!
name|SetSystemTimeAdjustment
argument_list|(
name|dwTimeAdjustment
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
else|else
name|rc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rc
condition|)
else|#
directive|else
comment|/* 	 * Here we do the actual adjustment. If for some reason the adjtime() 	 * call fails, like it is not implemented or something like that, 	 * we honk to the log. If the previous adjustment did not complete, 	 * we correct the residual offset. 	 */
comment|/* casey - we need a posix type thang here */
if|if
condition|(
name|adjtime
argument_list|(
operator|&
name|adjtv
argument_list|,
operator|&
name|oadjtv
argument_list|)
operator|<
literal|0
condition|)
endif|#
directive|endif
comment|/* SYS_WINNT */
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Can't adjust time: %m"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|SYS_WINNT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|SYS_CYGWIN32
argument_list|)
name|sys_residual
operator|+=
name|oadjtv
operator|.
name|tv_usec
operator|/
literal|1e6
expr_stmt|;
else|#
directive|else
name|sys_residual
operator|=
name|dtemp
operator|/
literal|1000000.0
expr_stmt|;
endif|#
directive|endif
comment|/* SYS_WINNT */
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|>
literal|6
condition|)
name|printf
argument_list|(
literal|"adj_systime: adj %.9f -> remaining residual %.9f\n"
argument_list|,
name|now
argument_list|,
name|sys_residual
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * step_systime - step the system clock.  */
end_comment

begin_function
name|int
name|step_systime
parameter_list|(
name|double
name|now
parameter_list|)
block|{
name|struct
name|timeval
name|timetv
decl_stmt|,
name|adjtv
decl_stmt|,
name|oldtimetv
decl_stmt|;
name|int
name|isneg
init|=
literal|0
decl_stmt|;
name|double
name|dtemp
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_CLOCK_GETTIME
argument_list|)
operator|||
name|defined
argument_list|(
name|HAVE_GETCLOCK
argument_list|)
name|struct
name|timespec
name|ts
decl_stmt|;
endif|#
directive|endif
name|dtemp
operator|=
name|sys_residual
operator|+
name|now
expr_stmt|;
if|if
condition|(
name|dtemp
operator|<
literal|0
condition|)
block|{
name|isneg
operator|=
literal|1
expr_stmt|;
name|dtemp
operator|=
operator|-
name|dtemp
expr_stmt|;
name|adjtv
operator|.
name|tv_sec
operator|=
operator|(
name|int32
operator|)
name|dtemp
expr_stmt|;
name|adjtv
operator|.
name|tv_usec
operator|=
call|(
name|u_int32
call|)
argument_list|(
operator|(
name|dtemp
operator|-
operator|(
name|double
operator|)
name|adjtv
operator|.
name|tv_sec
operator|)
operator|*
literal|1e6
operator|+
literal|.5
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|adjtv
operator|.
name|tv_sec
operator|=
operator|(
name|int32
operator|)
name|dtemp
expr_stmt|;
name|adjtv
operator|.
name|tv_usec
operator|=
call|(
name|u_int32
call|)
argument_list|(
operator|(
name|dtemp
operator|-
operator|(
name|double
operator|)
name|adjtv
operator|.
name|tv_sec
operator|)
operator|*
literal|1e6
operator|+
literal|.5
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|HAVE_CLOCK_GETTIME
argument_list|)
operator|||
name|defined
argument_list|(
name|HAVE_GETCLOCK
argument_list|)
ifdef|#
directive|ifdef
name|HAVE_CLOCK_GETTIME
operator|(
name|void
operator|)
name|clock_gettime
argument_list|(
name|CLOCK_REALTIME
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
else|#
directive|else
operator|(
name|void
operator|)
name|getclock
argument_list|(
name|TIMEOFDAY
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|timetv
operator|.
name|tv_sec
operator|=
name|ts
operator|.
name|tv_sec
expr_stmt|;
name|timetv
operator|.
name|tv_usec
operator|=
name|ts
operator|.
name|tv_nsec
operator|/
literal|1000
expr_stmt|;
else|#
directive|else
comment|/*  not HAVE_GETCLOCK */
operator|(
name|void
operator|)
name|GETTIMEOFDAY
argument_list|(
operator|&
name|timetv
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* not HAVE_GETCLOCK */
name|oldtimetv
operator|=
name|timetv
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"step_systime: step %.6f residual %.6f\n"
argument_list|,
name|now
argument_list|,
name|sys_residual
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|isneg
condition|)
block|{
name|timetv
operator|.
name|tv_sec
operator|-=
name|adjtv
operator|.
name|tv_sec
expr_stmt|;
name|timetv
operator|.
name|tv_usec
operator|-=
name|adjtv
operator|.
name|tv_usec
expr_stmt|;
if|if
condition|(
name|timetv
operator|.
name|tv_usec
operator|<
literal|0
condition|)
block|{
name|timetv
operator|.
name|tv_sec
operator|--
expr_stmt|;
name|timetv
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
block|}
block|}
else|else
block|{
name|timetv
operator|.
name|tv_sec
operator|+=
name|adjtv
operator|.
name|tv_sec
expr_stmt|;
name|timetv
operator|.
name|tv_usec
operator|+=
name|adjtv
operator|.
name|tv_usec
expr_stmt|;
if|if
condition|(
name|timetv
operator|.
name|tv_usec
operator|>=
literal|1000000
condition|)
block|{
name|timetv
operator|.
name|tv_sec
operator|++
expr_stmt|;
name|timetv
operator|.
name|tv_usec
operator|-=
literal|1000000
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ntp_set_tod
argument_list|(
operator|&
name|timetv
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Can't set time of day: %m"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|sys_residual
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|NEED_HPUX_ADJTIME
comment|/* 	 * CHECKME: is this correct when called by ntpdate????? 	 */
name|_clear_adjtime
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * FreeBSD, for example, has: 	 * struct utmp { 	 *	   char    ut_line[UT_LINESIZE]; 	 *	   char    ut_name[UT_NAMESIZE]; 	 *	   char    ut_host[UT_HOSTSIZE]; 	 *	   long    ut_time; 	 * }; 	 * and appends line="|", name="date", host="", time for the OLD 	 * and appends line="{", name="date", host="", time for the NEW 	 * to _PATH_WTMP . 	 * 	 * Some OSes have utmp, some have utmpx. 	 */
comment|/* 	 * Write old and new time entries in utmp and wtmp if step adjustment 	 * is greater than one second. 	 * 	 * This might become even Uglier... 	 */
if|if
condition|(
name|oldtimetv
operator|.
name|tv_sec
operator|!=
name|timetv
operator|.
name|tv_sec
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_UTMP_H
name|struct
name|utmp
name|ut
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_UTMPX_H
name|struct
name|utmpx
name|utx
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_UTMP_H
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ut
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ut
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_UTMPX_H
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|utx
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|utx
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* UTMP */
ifdef|#
directive|ifdef
name|UPDATE_UTMP
ifdef|#
directive|ifdef
name|HAVE_PUTUTLINE
name|ut
operator|.
name|ut_type
operator|=
name|OLD_TIME
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ut
operator|.
name|ut_line
argument_list|,
name|OTIME_MSG
argument_list|)
expr_stmt|;
name|ut
operator|.
name|ut_time
operator|=
name|oldtimetv
operator|.
name|tv_sec
expr_stmt|;
name|pututline
argument_list|(
operator|&
name|ut
argument_list|)
expr_stmt|;
name|setutent
argument_list|()
expr_stmt|;
name|ut
operator|.
name|ut_type
operator|=
name|NEW_TIME
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ut
operator|.
name|ut_line
argument_list|,
name|NTIME_MSG
argument_list|)
expr_stmt|;
name|ut
operator|.
name|ut_time
operator|=
name|timetv
operator|.
name|tv_sec
expr_stmt|;
name|pututline
argument_list|(
operator|&
name|ut
argument_list|)
expr_stmt|;
name|endutent
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* not HAVE_PUTUTLINE */
endif|#
directive|endif
comment|/* not HAVE_PUTUTLINE */
endif|#
directive|endif
comment|/* UPDATE_UTMP */
comment|/* UTMPX */
ifdef|#
directive|ifdef
name|UPDATE_UTMPX
ifdef|#
directive|ifdef
name|HAVE_PUTUTXLINE
name|utx
operator|.
name|ut_type
operator|=
name|OLD_TIME
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|utx
operator|.
name|ut_line
argument_list|,
name|OTIME_MSG
argument_list|)
expr_stmt|;
name|utx
operator|.
name|ut_tv
operator|=
name|oldtimetv
expr_stmt|;
name|pututxline
argument_list|(
operator|&
name|utx
argument_list|)
expr_stmt|;
name|setutxent
argument_list|()
expr_stmt|;
name|utx
operator|.
name|ut_type
operator|=
name|NEW_TIME
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|utx
operator|.
name|ut_line
argument_list|,
name|NTIME_MSG
argument_list|)
expr_stmt|;
name|utx
operator|.
name|ut_tv
operator|=
name|timetv
expr_stmt|;
name|pututxline
argument_list|(
operator|&
name|utx
argument_list|)
expr_stmt|;
name|endutxent
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* not HAVE_PUTUTXLINE */
endif|#
directive|endif
comment|/* not HAVE_PUTUTXLINE */
endif|#
directive|endif
comment|/* UPDATE_UTMPX */
comment|/* WTMP */
ifdef|#
directive|ifdef
name|UPDATE_WTMP
ifdef|#
directive|ifdef
name|HAVE_PUTUTLINE
name|utmpname
argument_list|(
name|WTMP_FILE
argument_list|)
expr_stmt|;
name|ut
operator|.
name|ut_type
operator|=
name|OLD_TIME
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ut
operator|.
name|ut_line
argument_list|,
name|OTIME_MSG
argument_list|)
expr_stmt|;
name|ut
operator|.
name|ut_time
operator|=
name|oldtimetv
operator|.
name|tv_sec
expr_stmt|;
name|pututline
argument_list|(
operator|&
name|ut
argument_list|)
expr_stmt|;
name|ut
operator|.
name|ut_type
operator|=
name|NEW_TIME
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ut
operator|.
name|ut_line
argument_list|,
name|NTIME_MSG
argument_list|)
expr_stmt|;
name|ut
operator|.
name|ut_time
operator|=
name|timetv
operator|.
name|tv_sec
expr_stmt|;
name|pututline
argument_list|(
operator|&
name|ut
argument_list|)
expr_stmt|;
name|endutent
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* not HAVE_PUTUTLINE */
endif|#
directive|endif
comment|/* not HAVE_PUTUTLINE */
endif|#
directive|endif
comment|/* UPDATE_WTMP */
comment|/* WTMPX */
ifdef|#
directive|ifdef
name|UPDATE_WTMPX
ifdef|#
directive|ifdef
name|HAVE_PUTUTXLINE
name|utx
operator|.
name|ut_type
operator|=
name|OLD_TIME
expr_stmt|;
name|utx
operator|.
name|ut_tv
operator|=
name|oldtimetv
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|utx
operator|.
name|ut_line
argument_list|,
name|OTIME_MSG
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_UPDWTMPX
name|updwtmpx
argument_list|(
name|WTMPX_FILE
argument_list|,
operator|&
name|utx
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* not HAVE_UPDWTMPX */
endif|#
directive|endif
comment|/* not HAVE_UPDWTMPX */
else|#
directive|else
comment|/* not HAVE_PUTUTXLINE */
endif|#
directive|endif
comment|/* not HAVE_PUTUTXLINE */
ifdef|#
directive|ifdef
name|HAVE_PUTUTXLINE
name|utx
operator|.
name|ut_type
operator|=
name|NEW_TIME
expr_stmt|;
name|utx
operator|.
name|ut_tv
operator|=
name|timetv
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|utx
operator|.
name|ut_line
argument_list|,
name|NTIME_MSG
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_UPDWTMPX
name|updwtmpx
argument_list|(
name|WTMPX_FILE
argument_list|,
operator|&
name|utx
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* not HAVE_UPDWTMPX */
endif|#
directive|endif
comment|/* not HAVE_UPDWTMPX */
else|#
directive|else
comment|/* not HAVE_PUTUTXLINE */
endif|#
directive|endif
comment|/* not HAVE_PUTUTXLINE */
endif|#
directive|endif
comment|/* UPDATE_WTMPX */
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

end_unit


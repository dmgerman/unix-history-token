begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * pretty printing of status information  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_fp.h"
end_include

begin_include
include|#
directive|include
file|"ntp.h"
end_include

begin_include
include|#
directive|include
file|"lib_strbuf.h"
end_include

begin_include
include|#
directive|include
file|"ntp_refclock.h"
end_include

begin_include
include|#
directive|include
file|"ntp_control.h"
end_include

begin_include
include|#
directive|include
file|"ntp_string.h"
end_include

begin_comment
comment|/*  * Structure for turning various constants into a readable string.  */
end_comment

begin_struct
struct|struct
name|codestring
block|{
name|int
name|code
decl_stmt|;
specifier|const
name|char
modifier|*
name|string
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Leap values  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|codestring
name|leap_codes
index|[]
init|=
block|{
block|{
name|LEAP_NOWARNING
block|,
literal|"leap_none"
block|}
block|,
block|{
name|LEAP_ADDSECOND
block|,
literal|"leap_add_sec"
block|}
block|,
block|{
name|LEAP_DELSECOND
block|,
literal|"leap_del_sec"
block|}
block|,
block|{
name|LEAP_NOTINSYNC
block|,
literal|"sync_alarm"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|"leap"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Clock source  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|codestring
name|sync_codes
index|[]
init|=
block|{
block|{
name|CTL_SST_TS_UNSPEC
block|,
literal|"sync_unspec"
block|}
block|,
block|{
name|CTL_SST_TS_ATOM
block|,
literal|"sync_atomic"
block|}
block|,
block|{
name|CTL_SST_TS_LF
block|,
literal|"sync_lf_clock"
block|}
block|,
block|{
name|CTL_SST_TS_HF
block|,
literal|"sync_hf_clock"
block|}
block|,
block|{
name|CTL_SST_TS_UHF
block|,
literal|"sync_uhf_clock"
block|}
block|,
block|{
name|CTL_SST_TS_LOCAL
block|,
literal|"sync_local_proto"
block|}
block|,
block|{
name|CTL_SST_TS_NTP
block|,
literal|"sync_ntp"
block|}
block|,
block|{
name|CTL_SST_TS_UDPTIME
block|,
literal|"sync_udp/time"
block|}
block|,
block|{
name|CTL_SST_TS_WRSTWTCH
block|,
literal|"sync_wristwatch"
block|}
block|,
block|{
name|CTL_SST_TS_TELEPHONE
block|,
literal|"sync_telephone"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|"sync"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Peer selection  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|codestring
name|select_codes
index|[]
init|=
block|{
block|{
name|CTL_PST_SEL_REJECT
block|,
literal|"selreject"
block|}
block|,
block|{
name|CTL_PST_SEL_SANE
block|,
literal|"sel_falsetick"
block|}
block|,
block|{
name|CTL_PST_SEL_CORRECT
block|,
literal|"sel_excess"
block|}
block|,
block|{
name|CTL_PST_SEL_SELCAND
block|,
literal|"sel_outlyer"
block|}
block|,
block|{
name|CTL_PST_SEL_SYNCCAND
block|,
literal|"sel_candidat"
block|}
block|,
block|{
name|CTL_PST_SEL_DISTSYSPEER
block|,
literal|"sel_selected"
block|}
block|,
block|{
name|CTL_PST_SEL_SYSPEER
block|,
literal|"sel_sys.peer"
block|}
block|,
block|{
name|CTL_PST_SEL_PPS
block|,
literal|"sel_pps.peer"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|"sel"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Clock status  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|codestring
name|clock_codes
index|[]
init|=
block|{
block|{
name|CTL_CLK_OKAY
block|,
literal|"clk_okay"
block|}
block|,
block|{
name|CTL_CLK_NOREPLY
block|,
literal|"clk_noreply"
block|}
block|,
block|{
name|CTL_CLK_BADFORMAT
block|,
literal|"clk_badformat"
block|}
block|,
block|{
name|CTL_CLK_FAULT
block|,
literal|"clk_fault"
block|}
block|,
block|{
name|CTL_CLK_PROPAGATION
block|,
literal|"clk_badsignal"
block|}
block|,
block|{
name|CTL_CLK_BADDATE
block|,
literal|"clk_baddate"
block|}
block|,
block|{
name|CTL_CLK_BADTIME
block|,
literal|"clk_badtime"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|"clk"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * System Events  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|codestring
name|sys_codes
index|[]
init|=
block|{
block|{
name|EVNT_UNSPEC
block|,
literal|"event_unspec"
block|}
block|,
block|{
name|EVNT_SYSRESTART
block|,
literal|"event_restart"
block|}
block|,
block|{
name|EVNT_SYSFAULT
block|,
literal|"event_fault"
block|}
block|,
block|{
name|EVNT_SYNCCHG
block|,
literal|"event_sync_chg"
block|}
block|,
block|{
name|EVNT_PEERSTCHG
block|,
literal|"event_peer/strat_chg"
block|}
block|,
block|{
name|EVNT_CLOCKRESET
block|,
literal|"event_clock_reset"
block|}
block|,
block|{
name|EVNT_BADDATETIM
block|,
literal|"event_bad_date"
block|}
block|,
block|{
name|EVNT_CLOCKEXCPT
block|,
literal|"event_clock_excptn"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|"event"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Peer Events  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|codestring
name|peer_codes
index|[]
init|=
block|{
block|{
name|EVNT_UNSPEC
block|,
literal|"event_unspec"
block|}
block|,
block|{
name|EVNT_PEERIPERR
operator|&
operator|~
name|PEER_EVENT
block|,
literal|"event_ip_err"
block|}
block|,
block|{
name|EVNT_PEERAUTH
operator|&
operator|~
name|PEER_EVENT
block|,
literal|"event_authen"
block|}
block|,
block|{
name|EVNT_UNREACH
operator|&
operator|~
name|PEER_EVENT
block|,
literal|"event_unreach"
block|}
block|,
block|{
name|EVNT_REACH
operator|&
operator|~
name|PEER_EVENT
block|,
literal|"event_reach"
block|}
block|,
block|{
name|EVNT_PEERCLOCK
operator|&
operator|~
name|PEER_EVENT
block|,
literal|"event_peer_clock"
block|}
block|,
if|#
directive|if
literal|0
block|{ EVNT_PEERSTRAT& ~PEER_EVENT,	"event_stratum_chg" },
endif|#
directive|endif
block|{
operator|-
literal|1
block|,
literal|"event"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Forwards */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|getcode
name|P
argument_list|(
operator|(
name|int
operator|,
expr|struct
name|codestring
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|getevents
name|P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * getcode - return string corresponding to code  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|getcode
parameter_list|(
name|int
name|code
parameter_list|,
name|struct
name|codestring
modifier|*
name|codetab
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|30
index|]
decl_stmt|;
while|while
condition|(
name|codetab
operator|->
name|code
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|codetab
operator|->
name|code
operator|==
name|code
condition|)
return|return
name|codetab
operator|->
name|string
return|;
name|codetab
operator|++
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s_%d"
argument_list|,
name|codetab
operator|->
name|string
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/*  * getevents - return a descriptive string for the event count  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|getevents
parameter_list|(
name|int
name|cnt
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
return|return
literal|"no events"
return|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d event%s"
argument_list|,
name|cnt
argument_list|,
operator|(
name|cnt
operator|==
literal|1
operator|)
condition|?
literal|""
else|:
literal|"s"
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/*  * statustoa - return a descriptive string for a peer status  */
end_comment

begin_function
name|char
modifier|*
name|statustoa
parameter_list|(
name|int
name|type
parameter_list|,
name|int
name|st
parameter_list|)
block|{
name|char
modifier|*
name|cb
decl_stmt|;
name|u_char
name|pst
decl_stmt|;
name|LIB_GETBUF
argument_list|(
name|cb
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|TYPE_SYS
case|:
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|cb
argument_list|,
name|getcode
argument_list|(
name|CTL_SYS_LI
argument_list|(
name|st
argument_list|)
argument_list|,
name|leap_codes
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
name|getcode
argument_list|(
name|CTL_SYS_SOURCE
argument_list|(
name|st
argument_list|)
operator|&
operator|~
name|CTL_SST_TS_PPS
argument_list|,
name|sync_codes
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CTL_SYS_SOURCE
argument_list|(
name|st
argument_list|)
operator|&
name|CTL_SST_TS_PPS
condition|)
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|"/PPS"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
name|getevents
argument_list|(
name|CTL_SYS_NEVNT
argument_list|(
name|st
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
name|getcode
argument_list|(
name|CTL_SYS_EVENT
argument_list|(
name|st
argument_list|)
argument_list|,
name|sys_codes
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_PEER
case|:
comment|/* 		 * Handcraft the bits 		 */
name|pst
operator|=
operator|(
name|u_char
operator|)
name|CTL_PEER_STATVAL
argument_list|(
name|st
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|pst
operator|&
name|CTL_PST_REACH
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|cb
argument_list|,
literal|"unreach"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|cb
argument_list|,
literal|"reach"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pst
operator|&
name|CTL_PST_CONFIG
condition|)
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", conf"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pst
operator|&
name|CTL_PST_AUTHENABLE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|pst
operator|&
name|CTL_PST_REACH
operator|)
operator|||
operator|(
name|pst
operator|&
name|CTL_PST_AUTHENTIC
operator|)
condition|)
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", auth"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", unauth"
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Now the codes 		 */
if|if
condition|(
operator|(
name|pst
operator|&
literal|0x7
operator|)
operator|!=
name|CTL_PST_SEL_REJECT
condition|)
block|{
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
name|getcode
argument_list|(
name|pst
operator|&
literal|0x7
argument_list|,
name|select_codes
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
name|getevents
argument_list|(
name|CTL_PEER_NEVNT
argument_list|(
name|st
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CTL_PEER_EVENT
argument_list|(
name|st
argument_list|)
operator|!=
name|EVNT_UNSPEC
condition|)
block|{
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
name|getcode
argument_list|(
name|CTL_PEER_EVENT
argument_list|(
name|st
argument_list|)
argument_list|,
name|peer_codes
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TYPE_CLOCK
case|:
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|cb
argument_list|,
name|getcode
argument_list|(
operator|(
operator|(
name|st
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|clock_codes
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
literal|", last_"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|cb
argument_list|,
name|getcode
argument_list|(
operator|(
name|st
operator|)
operator|&
literal|0xff
argument_list|,
name|clock_codes
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|cb
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|eventstr
parameter_list|(
name|int
name|num
parameter_list|)
block|{
return|return
name|getcode
argument_list|(
name|num
operator|&
operator|~
name|PEER_EVENT
argument_list|,
operator|(
name|num
operator|&
name|PEER_EVENT
operator|)
condition|?
name|peer_codes
else|:
name|sys_codes
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|ceventstr
parameter_list|(
name|int
name|num
parameter_list|)
block|{
return|return
name|getcode
argument_list|(
name|num
argument_list|,
name|clock_codes
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|sysstatstr
parameter_list|(
name|int
name|status
parameter_list|)
block|{
return|return
name|statustoa
argument_list|(
name|TYPE_SYS
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|peerstatstr
parameter_list|(
name|int
name|status
parameter_list|)
block|{
return|return
name|statustoa
argument_list|(
name|TYPE_PEER
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|clockstatstr
parameter_list|(
name|int
name|status
parameter_list|)
block|{
return|return
name|statustoa
argument_list|(
name|TYPE_CLOCK
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

end_unit


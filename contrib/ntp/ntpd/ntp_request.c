begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ntp_request.c - respond to information requests  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_include
include|#
directive|include
file|"ntp_io.h"
end_include

begin_include
include|#
directive|include
file|"ntp_request.h"
end_include

begin_include
include|#
directive|include
file|"ntp_control.h"
end_include

begin_include
include|#
directive|include
file|"ntp_refclock.h"
end_include

begin_include
include|#
directive|include
file|"ntp_if.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_assert.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETINET_IN_H
end_ifdef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|"recvbuff.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|KERNEL_PLL
end_ifdef

begin_include
include|#
directive|include
file|"ntp_syscall.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* KERNEL_PLL */
end_comment

begin_comment
comment|/*  * Structure to hold request procedure information  */
end_comment

begin_define
define|#
directive|define
name|NOAUTH
value|0
end_define

begin_define
define|#
directive|define
name|AUTH
value|1
end_define

begin_define
define|#
directive|define
name|NO_REQUEST
value|(-1)
end_define

begin_comment
comment|/*  * Because we now have v6 addresses in the messages, we need to compensate  * for the larger size.  Therefore, we introduce the alternate size to   * keep us friendly with older implementations.  A little ugly.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|client_v6_capable
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the client can handle longer messages */
end_comment

begin_define
define|#
directive|define
name|v6sizeof
parameter_list|(
name|type
parameter_list|)
value|(client_v6_capable ? sizeof(type) : v4sizeof(type))
end_define

begin_struct
struct|struct
name|req_proc
block|{
name|short
name|request_code
decl_stmt|;
comment|/* defined request code */
name|short
name|needs_auth
decl_stmt|;
comment|/* true when authentication needed */
name|short
name|sizeofitem
decl_stmt|;
comment|/* size of request data item (older size)*/
name|short
name|v6_sizeofitem
decl_stmt|;
comment|/* size of request data item (new size)*/
name|void
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
comment|/* routine to handle request */
block|}
struct|;
end_struct

begin_comment
comment|/*  * Universal request codes  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|req_proc
name|univ_codes
index|[]
init|=
block|{
block|{
name|NO_REQUEST
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|req_ack
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|prepare_pkt
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|more_pkt
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|flush_pkt
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|list_peers
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|list_peers_sum
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|peer_info
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|peer_stats
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sys_info
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sys_stats
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mem_stats
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|io_stats
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|timer_stats
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|loop_info
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_conf
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_unconf
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_sys_flag
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|clr_sys_flag
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|setclr_flags
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|,
name|u_long
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|list_restrict4
parameter_list|(
name|restrict_u
modifier|*
parameter_list|,
name|struct
name|info_restrict
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|list_restrict6
parameter_list|(
name|restrict_u
modifier|*
parameter_list|,
name|struct
name|info_restrict
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|list_restrict
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_resaddflags
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_ressubflags
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_unrestrict
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_restrict
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mon_getlist
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|reset_stats
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|reset_peer
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_key_reread
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|trust_key
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|untrust_key
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_trustkey
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|,
name|u_long
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|get_auth_info
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_get_traps
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_set_trap
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|req_clr_trap
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_setclr_trap
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_request_keyid
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_control_keyid
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|get_ctl_stats
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|get_if_stats
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|do_if_reload
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|KERNEL_PLL
end_ifdef

begin_function_decl
specifier|static
name|void
name|get_kernel_info
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* KERNEL_PLL */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|REFCLOCK
end_ifdef

begin_function_decl
specifier|static
name|void
name|get_clock_info
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_clock_fudge
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* REFCLOCK */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|REFCLOCK
end_ifdef

begin_function_decl
specifier|static
name|void
name|get_clkbug_info
parameter_list|(
name|sockaddr_u
modifier|*
parameter_list|,
name|endpt
modifier|*
parameter_list|,
name|struct
name|req_pkt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* REFCLOCK */
end_comment

begin_comment
comment|/*  * ntpd request codes  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|req_proc
name|ntp_codes
index|[]
init|=
block|{
block|{
name|REQ_PEER_LIST
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|list_peers
block|}
block|,
block|{
name|REQ_PEER_LIST_SUM
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|list_peers_sum
block|}
block|,
block|{
name|REQ_PEER_INFO
block|,
name|NOAUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|info_peer_list
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_peer_list
argument_list|)
block|,
name|peer_info
block|}
block|,
block|{
name|REQ_PEER_STATS
block|,
name|NOAUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|info_peer_list
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_peer_list
argument_list|)
block|,
name|peer_stats
block|}
block|,
block|{
name|REQ_SYS_INFO
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|sys_info
block|}
block|,
block|{
name|REQ_SYS_STATS
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|sys_stats
block|}
block|,
block|{
name|REQ_IO_STATS
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|io_stats
block|}
block|,
block|{
name|REQ_MEM_STATS
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|mem_stats
block|}
block|,
block|{
name|REQ_LOOP_INFO
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|loop_info
block|}
block|,
block|{
name|REQ_TIMER_STATS
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|timer_stats
block|}
block|,
block|{
name|REQ_CONFIG
block|,
name|AUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|conf_peer
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_peer
argument_list|)
block|,
name|do_conf
block|}
block|,
block|{
name|REQ_UNCONFIG
block|,
name|AUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|conf_unpeer
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_unpeer
argument_list|)
block|,
name|do_unconf
block|}
block|,
block|{
name|REQ_SET_SYS_FLAG
block|,
name|AUTH
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_sys_flags
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_sys_flags
argument_list|)
block|,
name|set_sys_flag
block|}
block|,
block|{
name|REQ_CLR_SYS_FLAG
block|,
name|AUTH
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_sys_flags
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_sys_flags
argument_list|)
block|,
name|clr_sys_flag
block|}
block|,
block|{
name|REQ_GET_RESTRICT
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|list_restrict
block|}
block|,
block|{
name|REQ_RESADDFLAGS
block|,
name|AUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|conf_restrict
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_restrict
argument_list|)
block|,
name|do_resaddflags
block|}
block|,
block|{
name|REQ_RESSUBFLAGS
block|,
name|AUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|conf_restrict
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_restrict
argument_list|)
block|,
name|do_ressubflags
block|}
block|,
block|{
name|REQ_UNRESTRICT
block|,
name|AUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|conf_restrict
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_restrict
argument_list|)
block|,
name|do_unrestrict
block|}
block|,
block|{
name|REQ_MON_GETLIST
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|mon_getlist
block|}
block|,
block|{
name|REQ_MON_GETLIST_1
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|mon_getlist
block|}
block|,
block|{
name|REQ_RESET_STATS
block|,
name|AUTH
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|reset_flags
argument_list|)
block|,
literal|0
block|,
name|reset_stats
block|}
block|,
block|{
name|REQ_RESET_PEER
block|,
name|AUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|conf_unpeer
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_unpeer
argument_list|)
block|,
name|reset_peer
block|}
block|,
block|{
name|REQ_REREAD_KEYS
block|,
name|AUTH
block|,
literal|0
block|,
literal|0
block|,
name|do_key_reread
block|}
block|,
block|{
name|REQ_TRUSTKEY
block|,
name|AUTH
block|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
block|,
name|trust_key
block|}
block|,
block|{
name|REQ_UNTRUSTKEY
block|,
name|AUTH
block|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
block|,
name|untrust_key
block|}
block|,
block|{
name|REQ_AUTHINFO
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|get_auth_info
block|}
block|,
block|{
name|REQ_TRAPS
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|req_get_traps
block|}
block|,
block|{
name|REQ_ADD_TRAP
block|,
name|AUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|conf_trap
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_trap
argument_list|)
block|,
name|req_set_trap
block|}
block|,
block|{
name|REQ_CLR_TRAP
block|,
name|AUTH
block|,
name|v4sizeof
argument_list|(
expr|struct
name|conf_trap
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_trap
argument_list|)
block|,
name|req_clr_trap
block|}
block|,
block|{
name|REQ_REQUEST_KEY
block|,
name|AUTH
block|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
block|,
name|set_request_keyid
block|}
block|,
block|{
name|REQ_CONTROL_KEY
block|,
name|AUTH
block|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
block|,
name|set_control_keyid
block|}
block|,
block|{
name|REQ_GET_CTLSTATS
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|get_ctl_stats
block|}
block|,
ifdef|#
directive|ifdef
name|KERNEL_PLL
block|{
name|REQ_GET_KERNEL
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
name|get_kernel_info
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|REFCLOCK
block|{
name|REQ_GET_CLOCKINFO
block|,
name|NOAUTH
block|,
sizeof|sizeof
argument_list|(
name|u_int32
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|u_int32
argument_list|)
block|,
name|get_clock_info
block|}
block|,
block|{
name|REQ_SET_CLKFUDGE
block|,
name|AUTH
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_fudge
argument_list|)
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|conf_fudge
argument_list|)
block|,
name|set_clock_fudge
block|}
block|,
block|{
name|REQ_GET_CLKBUGINFO
block|,
name|NOAUTH
block|,
sizeof|sizeof
argument_list|(
name|u_int32
argument_list|)
block|,
sizeof|sizeof
argument_list|(
name|u_int32
argument_list|)
block|,
name|get_clkbug_info
block|}
block|,
endif|#
directive|endif
block|{
name|REQ_IF_STATS
block|,
name|AUTH
block|,
literal|0
block|,
literal|0
block|,
name|get_if_stats
block|}
block|,
block|{
name|REQ_IF_RELOAD
block|,
name|AUTH
block|,
literal|0
block|,
literal|0
block|,
name|do_if_reload
block|}
block|,
block|{
name|NO_REQUEST
block|,
name|NOAUTH
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Authentication keyid used to authenticate requests.  Zero means we  * don't allow writing anything.  */
end_comment

begin_decl_stmt
name|keyid_t
name|info_auth_keyid
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Statistic counters to keep track of requests and responses.  */
end_comment

begin_decl_stmt
name|u_long
name|numrequests
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of requests we've received */
end_comment

begin_decl_stmt
name|u_long
name|numresppkts
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* number of resp packets sent with data */
end_comment

begin_comment
comment|/*  * lazy way to count errors, indexed by the error code  */
end_comment

begin_decl_stmt
name|u_long
name|errorcounter
index|[
name|MAX_INFO_ERR
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * A hack.  To keep the authentication module clear of ntp-ism's, we  * include a time reset variable for its stats here.  */
end_comment

begin_decl_stmt
name|u_long
name|auth_timereset
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Response packet used by these routines.  Also some state information  * so that we can handle packet formatting within a common set of  * subroutines.  Note we try to enter data in place whenever possible,  * but the need to set the more bit correctly means we occasionally  * use the extra buffer and copy.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|resp_pkt
name|rpkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|reqver
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|seqno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nitems
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|itemsize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|databytes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|exbuf
index|[
name|RESP_DATA_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|usingexbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sockaddr_u
modifier|*
name|toaddr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|endpt
modifier|*
name|frominter
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * init_request - initialize request data  */
end_comment

begin_function
name|void
name|init_request
parameter_list|(
name|void
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|numrequests
operator|=
literal|0
expr_stmt|;
name|numresppkts
operator|=
literal|0
expr_stmt|;
name|auth_timereset
operator|=
literal|0
expr_stmt|;
name|info_auth_keyid
operator|=
literal|0
expr_stmt|;
comment|/* by default, can't do this */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|errorcounter
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|errorcounter
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
name|errorcounter
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * req_ack - acknowledge request with no data  */
end_comment

begin_function
specifier|static
name|void
name|req_ack
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|,
name|int
name|errcode
parameter_list|)
block|{
comment|/* 	 * fill in the fields 	 */
name|rpkt
operator|.
name|rm_vn_mode
operator|=
name|RM_VN_MODE
argument_list|(
name|RESP_BIT
argument_list|,
literal|0
argument_list|,
name|reqver
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|auth_seq
operator|=
name|AUTH_SEQ
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|implementation
operator|=
name|inpkt
operator|->
name|implementation
expr_stmt|;
name|rpkt
operator|.
name|request
operator|=
name|inpkt
operator|->
name|request
expr_stmt|;
name|rpkt
operator|.
name|err_nitems
operator|=
name|ERR_NITEMS
argument_list|(
name|errcode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|mbz_itemsize
operator|=
name|MBZ_ITEMSIZE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * send packet and bump counters 	 */
name|sendpkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
operator|-
literal|1
argument_list|,
operator|(
expr|struct
name|pkt
operator|*
operator|)
operator|&
name|rpkt
argument_list|,
name|RESP_HEADER_SIZE
argument_list|)
expr_stmt|;
name|errorcounter
index|[
name|errcode
index|]
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * prepare_pkt - prepare response packet for transmission, return pointer  *		 to storage for data item.  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|prepare_pkt
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|pkt
parameter_list|,
name|size_t
name|structsize
parameter_list|)
block|{
name|DPRINTF
argument_list|(
literal|4
argument_list|,
operator|(
literal|"request: preparing pkt\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Fill in the implementation, request and itemsize fields 	 * since these won't change. 	 */
name|rpkt
operator|.
name|implementation
operator|=
name|pkt
operator|->
name|implementation
expr_stmt|;
name|rpkt
operator|.
name|request
operator|=
name|pkt
operator|->
name|request
expr_stmt|;
name|rpkt
operator|.
name|mbz_itemsize
operator|=
name|MBZ_ITEMSIZE
argument_list|(
name|structsize
argument_list|)
expr_stmt|;
comment|/* 	 * Compute the static data needed to carry on. 	 */
name|toaddr
operator|=
name|srcadr
expr_stmt|;
name|frominter
operator|=
name|inter
expr_stmt|;
name|seqno
operator|=
literal|0
expr_stmt|;
name|nitems
operator|=
literal|0
expr_stmt|;
name|itemsize
operator|=
name|structsize
expr_stmt|;
name|databytes
operator|=
literal|0
expr_stmt|;
name|usingexbuf
operator|=
literal|0
expr_stmt|;
comment|/* 	 * return the beginning of the packet buffer. 	 */
return|return
operator|&
name|rpkt
operator|.
name|u
return|;
block|}
end_function

begin_comment
comment|/*  * more_pkt - return a data pointer for a new item.  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|more_pkt
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * If we were using the extra buffer, send the packet. 	 */
if|if
condition|(
name|usingexbuf
condition|)
block|{
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"request: sending pkt\n"
operator|)
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|rm_vn_mode
operator|=
name|RM_VN_MODE
argument_list|(
name|RESP_BIT
argument_list|,
name|MORE_BIT
argument_list|,
name|reqver
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|auth_seq
operator|=
name|AUTH_SEQ
argument_list|(
literal|0
argument_list|,
name|seqno
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|err_nitems
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|nitems
argument_list|)
expr_stmt|;
name|sendpkt
argument_list|(
name|toaddr
argument_list|,
name|frominter
argument_list|,
operator|-
literal|1
argument_list|,
operator|(
expr|struct
name|pkt
operator|*
operator|)
operator|&
name|rpkt
argument_list|,
name|RESP_HEADER_SIZE
operator|+
name|databytes
argument_list|)
expr_stmt|;
name|numresppkts
operator|++
expr_stmt|;
comment|/* 		 * Copy data out of exbuf into the packet. 		 */
name|memcpy
argument_list|(
operator|&
name|rpkt
operator|.
name|u
operator|.
name|data
index|[
literal|0
index|]
argument_list|,
name|exbuf
argument_list|,
operator|(
name|unsigned
operator|)
name|itemsize
argument_list|)
expr_stmt|;
name|seqno
operator|++
expr_stmt|;
name|databytes
operator|=
literal|0
expr_stmt|;
name|nitems
operator|=
literal|0
expr_stmt|;
name|usingexbuf
operator|=
literal|0
expr_stmt|;
block|}
name|databytes
operator|+=
name|itemsize
expr_stmt|;
name|nitems
operator|++
expr_stmt|;
if|if
condition|(
name|databytes
operator|+
name|itemsize
operator|<=
name|RESP_DATA_SIZE
condition|)
block|{
name|DPRINTF
argument_list|(
literal|4
argument_list|,
operator|(
literal|"request: giving him more data\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * More room in packet.  Give him the 		 * next address. 		 */
return|return
operator|&
name|rpkt
operator|.
name|u
operator|.
name|data
index|[
name|databytes
index|]
return|;
block|}
else|else
block|{
comment|/* 		 * No room in packet.  Give him the extra 		 * buffer unless this was the last in the sequence. 		 */
name|DPRINTF
argument_list|(
literal|4
argument_list|,
operator|(
literal|"request: into extra buffer\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|seqno
operator|==
name|MAXSEQ
condition|)
return|return
name|NULL
return|;
else|else
block|{
name|usingexbuf
operator|=
literal|1
expr_stmt|;
return|return
name|exbuf
return|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * flush_pkt - we're done, return remaining information.  */
end_comment

begin_function
specifier|static
name|void
name|flush_pkt
parameter_list|(
name|void
parameter_list|)
block|{
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"request: flushing packet, %d items\n"
operator|,
name|nitems
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Must send the last packet.  If nothing in here and nothing 	 * has been sent, send an error saying no data to be found. 	 */
if|if
condition|(
name|seqno
operator|==
literal|0
operator|&&
name|nitems
operator|==
literal|0
condition|)
name|req_ack
argument_list|(
name|toaddr
argument_list|,
name|frominter
argument_list|,
operator|(
expr|struct
name|req_pkt
operator|*
operator|)
operator|&
name|rpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
else|else
block|{
name|rpkt
operator|.
name|rm_vn_mode
operator|=
name|RM_VN_MODE
argument_list|(
name|RESP_BIT
argument_list|,
literal|0
argument_list|,
name|reqver
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|auth_seq
operator|=
name|AUTH_SEQ
argument_list|(
literal|0
argument_list|,
name|seqno
argument_list|)
expr_stmt|;
name|rpkt
operator|.
name|err_nitems
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|nitems
argument_list|)
expr_stmt|;
name|sendpkt
argument_list|(
name|toaddr
argument_list|,
name|frominter
argument_list|,
operator|-
literal|1
argument_list|,
operator|(
expr|struct
name|pkt
operator|*
operator|)
operator|&
name|rpkt
argument_list|,
name|RESP_HEADER_SIZE
operator|+
name|databytes
argument_list|)
expr_stmt|;
name|numresppkts
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Given a buffer, return the packet mode  */
end_comment

begin_function
name|int
name|get_packet_mode
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
name|struct
name|req_pkt
modifier|*
name|inpkt
init|=
operator|(
expr|struct
name|req_pkt
operator|*
operator|)
operator|&
name|rbufp
operator|->
name|recv_pkt
decl_stmt|;
return|return
operator|(
name|INFO_MODE
argument_list|(
name|inpkt
operator|->
name|rm_vn_mode
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * process_private - process private mode (7) packets  */
end_comment

begin_function
name|void
name|process_private
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|,
name|int
name|mod_okay
parameter_list|)
block|{
specifier|static
name|u_long
name|quiet_until
decl_stmt|;
name|struct
name|req_pkt
modifier|*
name|inpkt
decl_stmt|;
name|struct
name|req_pkt_tail
modifier|*
name|tailinpkt
decl_stmt|;
name|sockaddr_u
modifier|*
name|srcadr
decl_stmt|;
name|endpt
modifier|*
name|inter
decl_stmt|;
specifier|const
name|struct
name|req_proc
modifier|*
name|proc
decl_stmt|;
name|int
name|ec
decl_stmt|;
name|short
name|temp_size
decl_stmt|;
name|l_fp
name|ftmp
decl_stmt|;
name|double
name|dtemp
decl_stmt|;
name|size_t
name|recv_len
decl_stmt|;
name|size_t
name|noslop_len
decl_stmt|;
name|size_t
name|mac_len
decl_stmt|;
comment|/* 	 * Initialize pointers, for convenience 	 */
name|recv_len
operator|=
name|rbufp
operator|->
name|recv_length
expr_stmt|;
name|inpkt
operator|=
operator|(
expr|struct
name|req_pkt
operator|*
operator|)
operator|&
name|rbufp
operator|->
name|recv_pkt
expr_stmt|;
name|srcadr
operator|=
operator|&
name|rbufp
operator|->
name|recv_srcadr
expr_stmt|;
name|inter
operator|=
name|rbufp
operator|->
name|dstadr
expr_stmt|;
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"process_private: impl %d req %d\n"
operator|,
name|inpkt
operator|->
name|implementation
operator|,
name|inpkt
operator|->
name|request
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do some sanity checks on the packet.  Return a format 	 * error if it fails. 	 */
name|ec
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
operator|++
name|ec
operator|,
name|ISRESPONSE
argument_list|(
name|inpkt
operator|->
name|rm_vn_mode
argument_list|)
operator|)
operator|||
operator|(
operator|++
name|ec
operator|,
name|ISMORE
argument_list|(
name|inpkt
operator|->
name|rm_vn_mode
argument_list|)
operator|)
operator|||
operator|(
operator|++
name|ec
operator|,
name|INFO_VERSION
argument_list|(
name|inpkt
operator|->
name|rm_vn_mode
argument_list|)
operator|>
name|NTP_VERSION
operator|)
operator|||
operator|(
operator|++
name|ec
operator|,
name|INFO_VERSION
argument_list|(
name|inpkt
operator|->
name|rm_vn_mode
argument_list|)
operator|<
name|NTP_OLDVERSION
operator|)
operator|||
operator|(
operator|++
name|ec
operator|,
name|INFO_SEQ
argument_list|(
name|inpkt
operator|->
name|auth_seq
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
operator|++
name|ec
operator|,
name|INFO_ERR
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
operator|++
name|ec
operator|,
name|INFO_MBZ
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
operator|++
name|ec
operator|,
name|rbufp
operator|->
name|recv_length
operator|<
operator|(
name|int
operator|)
name|REQ_LEN_HDR
operator|)
condition|)
block|{
name|NLOG
argument_list|(
argument|NLOG_SYSEVENT
argument_list|)
if|if
condition|(
name|current_time
operator|>=
name|quiet_until
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"process_private: drop test %d"
literal|" failed, pkt from %s"
argument_list|,
name|ec
argument_list|,
name|stoa
argument_list|(
name|srcadr
argument_list|)
argument_list|)
expr_stmt|;
name|quiet_until
operator|=
name|current_time
operator|+
literal|60
expr_stmt|;
block|}
return|return;
block|}
name|reqver
operator|=
name|INFO_VERSION
argument_list|(
name|inpkt
operator|->
name|rm_vn_mode
argument_list|)
expr_stmt|;
comment|/* 	 * Get the appropriate procedure list to search. 	 */
if|if
condition|(
name|inpkt
operator|->
name|implementation
operator|==
name|IMPL_UNIV
condition|)
name|proc
operator|=
name|univ_codes
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|inpkt
operator|->
name|implementation
operator|==
name|IMPL_XNTPD
operator|)
operator|||
operator|(
name|inpkt
operator|->
name|implementation
operator|==
name|IMPL_XNTPD_OLD
operator|)
condition|)
name|proc
operator|=
name|ntp_codes
expr_stmt|;
else|else
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_IMPL
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Search the list for the request codes.  If it isn't one 	 * we know, return an error. 	 */
while|while
condition|(
name|proc
operator|->
name|request_code
operator|!=
name|NO_REQUEST
condition|)
block|{
if|if
condition|(
name|proc
operator|->
name|request_code
operator|==
operator|(
name|short
operator|)
name|inpkt
operator|->
name|request
condition|)
break|break;
name|proc
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|proc
operator|->
name|request_code
operator|==
name|NO_REQUEST
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_REQ
argument_list|)
expr_stmt|;
return|return;
block|}
name|DPRINTF
argument_list|(
literal|4
argument_list|,
operator|(
literal|"found request in tables\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * If we need data, check to see if we have some.  If we 	 * don't, check to see that there is none (picky, picky). 	 */
comment|/* This part is a bit tricky, we want to be sure that the size 	 * returned is either the old or the new size.  We also can find 	 * out if the client can accept both types of messages this way.  	 * 	 * Handle the exception of REQ_CONFIG. It can have two data sizes. 	 */
name|temp_size
operator|=
name|INFO_ITEMSIZE
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|temp_size
operator|!=
name|proc
operator|->
name|sizeofitem
operator|&&
name|temp_size
operator|!=
name|proc
operator|->
name|v6_sizeofitem
operator|)
operator|&&
operator|!
operator|(
name|inpkt
operator|->
name|implementation
operator|==
name|IMPL_XNTPD
operator|&&
name|inpkt
operator|->
name|request
operator|==
name|REQ_CONFIG
operator|&&
name|temp_size
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|old_conf_peer
argument_list|)
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"process_private: wrong item size, received %d, should be %d or %d\n"
operator|,
name|temp_size
operator|,
name|proc
operator|->
name|sizeofitem
operator|,
name|proc
operator|->
name|v6_sizeofitem
operator|)
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|proc
operator|->
name|sizeofitem
operator|!=
literal|0
operator|)
operator|&&
operator|(
call|(
name|size_t
call|)
argument_list|(
name|temp_size
operator|*
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
argument_list|)
operator|>
operator|(
name|recv_len
operator|-
name|REQ_LEN_HDR
operator|)
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"process_private: not enough data\n"
operator|)
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|inpkt
operator|->
name|implementation
condition|)
block|{
case|case
name|IMPL_XNTPD
case|:
name|client_v6_capable
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IMPL_XNTPD_OLD
case|:
name|client_v6_capable
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * If we need to authenticate, do so.  Note that an 	 * authenticatable packet must include a mac field, must 	 * have used key info_auth_keyid and must have included 	 * a time stamp in the appropriate field.  The time stamp 	 * must be within INFO_TS_MAXSKEW of the receive 	 * time stamp. 	 */
if|if
condition|(
name|proc
operator|->
name|needs_auth
operator|&&
name|sys_authenticate
condition|)
block|{
if|if
condition|(
name|recv_len
operator|<
operator|(
name|REQ_LEN_HDR
operator|+
operator|(
name|INFO_ITEMSIZE
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
operator|*
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
operator|)
operator|+
name|REQ_TAIL_MIN
operator|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * For 16-octet digests, regardless of itemsize and 		 * nitems, authenticated requests are a fixed size 		 * with the timestamp, key ID, and digest located 		 * at the end of the packet.  Because the key ID 		 * determining the digest size precedes the digest, 		 * for larger digests the fixed size request scheme 		 * is abandoned and the timestamp, key ID, and digest 		 * are located relative to the start of the packet, 		 * with the digest size determined by the packet size. 		 */
name|noslop_len
operator|=
name|REQ_LEN_HDR
operator|+
name|INFO_ITEMSIZE
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
operator|*
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|inpkt
operator|->
name|tstamp
argument_list|)
expr_stmt|;
comment|/* 32-bit alignment */
name|noslop_len
operator|=
operator|(
name|noslop_len
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
if|if
condition|(
name|recv_len
operator|>
operator|(
name|noslop_len
operator|+
name|MAX_MAC_LEN
operator|)
condition|)
name|mac_len
operator|=
literal|20
expr_stmt|;
else|else
name|mac_len
operator|=
name|recv_len
operator|-
name|noslop_len
expr_stmt|;
name|tailinpkt
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|inpkt
operator|+
name|recv_len
operator|-
operator|(
name|mac_len
operator|+
sizeof|sizeof
argument_list|(
name|inpkt
operator|->
name|tstamp
argument_list|)
operator|)
operator|)
expr_stmt|;
comment|/* 		 * If this guy is restricted from doing this, don't let 		 * him.  If the wrong key was used, or packet doesn't 		 * have mac, return. 		 */
if|if
condition|(
operator|!
name|INFO_IS_AUTH
argument_list|(
name|inpkt
operator|->
name|auth_seq
argument_list|)
operator|||
operator|!
name|info_auth_keyid
operator|||
name|ntohl
argument_list|(
name|tailinpkt
operator|->
name|keyid
argument_list|)
operator|!=
name|info_auth_keyid
condition|)
block|{
name|DPRINTF
argument_list|(
literal|5
argument_list|,
operator|(
literal|"failed auth %d info_auth_keyid %u pkt keyid %u maclen %lu\n"
operator|,
name|INFO_IS_AUTH
argument_list|(
name|inpkt
operator|->
name|auth_seq
argument_list|)
operator|,
name|info_auth_keyid
operator|,
name|ntohl
argument_list|(
name|tailinpkt
operator|->
name|keyid
argument_list|)
operator|,
operator|(
name|u_long
operator|)
name|mac_len
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|msyslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"process_private: failed auth %d info_auth_keyid %u pkt keyid %u maclen %lu\n"
argument_list|,
name|INFO_IS_AUTH
argument_list|(
name|inpkt
operator|->
name|auth_seq
argument_list|)
argument_list|,
name|info_auth_keyid
argument_list|,
name|ntohl
argument_list|(
name|tailinpkt
operator|->
name|keyid
argument_list|)
argument_list|,
operator|(
name|u_long
operator|)
name|mac_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_AUTH
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|recv_len
operator|>
name|REQ_LEN_NOMAC
operator|+
name|MAX_MAC_LEN
condition|)
block|{
name|DPRINTF
argument_list|(
literal|5
argument_list|,
operator|(
literal|"bad pkt length %zu\n"
operator|,
name|recv_len
operator|)
argument_list|)
expr_stmt|;
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"process_private: bad pkt length %zu"
argument_list|,
name|recv_len
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|mod_okay
operator|||
operator|!
name|authhavekey
argument_list|(
name|info_auth_keyid
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|5
argument_list|,
operator|(
literal|"failed auth mod_okay %d\n"
operator|,
name|mod_okay
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|msyslog
argument_list|(
name|LOG_DEBUG
argument_list|,
literal|"process_private: failed auth mod_okay %d\n"
argument_list|,
name|mod_okay
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|mod_okay
condition|)
block|{
name|sys_restricted
operator|++
expr_stmt|;
block|}
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_AUTH
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * calculate absolute time difference between xmit time stamp 		 * and receive time stamp.  If too large, too bad. 		 */
name|NTOHL_FP
argument_list|(
operator|&
name|tailinpkt
operator|->
name|tstamp
argument_list|,
operator|&
name|ftmp
argument_list|)
expr_stmt|;
name|L_SUB
argument_list|(
operator|&
name|ftmp
argument_list|,
operator|&
name|rbufp
operator|->
name|recv_time
argument_list|)
expr_stmt|;
name|LFPTOD
argument_list|(
operator|&
name|ftmp
argument_list|,
name|dtemp
argument_list|)
expr_stmt|;
if|if
condition|(
name|fabs
argument_list|(
name|dtemp
argument_list|)
operator|>
name|INFO_TS_MAXSKEW
condition|)
block|{
comment|/* 			 * He's a loser.  Tell him. 			 */
name|DPRINTF
argument_list|(
literal|5
argument_list|,
operator|(
literal|"xmit/rcv timestamp delta %g> INFO_TS_MAXSKEW %g\n"
operator|,
name|dtemp
operator|,
name|INFO_TS_MAXSKEW
operator|)
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_AUTH
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * So far so good.  See if decryption works out okay. 		 */
if|if
condition|(
operator|!
name|authdecrypt
argument_list|(
name|info_auth_keyid
argument_list|,
operator|(
name|u_int32
operator|*
operator|)
name|inpkt
argument_list|,
name|recv_len
operator|-
name|mac_len
argument_list|,
name|mac_len
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
literal|5
argument_list|,
operator|(
literal|"authdecrypt failed\n"
operator|)
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_AUTH
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"process_private: all okay, into handler\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Packet is okay.  Call the handler to send him data. 	 */
call|(
name|proc
operator|->
name|handler
call|)
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * list_peers - send a list of the peers  */
end_comment

begin_function
specifier|static
name|void
name|list_peers
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|struct
name|info_peer_list
modifier|*
name|ip
decl_stmt|;
name|struct
name|peer
modifier|*
name|pp
decl_stmt|;
name|int
name|skip
init|=
literal|0
decl_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|info_peer_list
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|v6sizeof
argument_list|(
expr|struct
name|info_peer_list
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|pp
operator|=
name|peer_list
init|;
name|pp
operator|!=
name|NULL
operator|&&
name|ip
operator|!=
name|NULL
condition|;
name|pp
operator|=
name|pp
operator|->
name|p_link
control|)
block|{
if|if
condition|(
name|IS_IPV6
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
condition|)
block|{
if|if
condition|(
name|client_v6_capable
condition|)
block|{
name|ip
operator|->
name|addr6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
name|ip
operator|->
name|v6_flag
operator|=
literal|1
expr_stmt|;
name|skip
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|skip
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|ip
operator|->
name|addr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
condition|)
name|ip
operator|->
name|v6_flag
operator|=
literal|0
expr_stmt|;
name|skip
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|skip
condition|)
block|{
name|ip
operator|->
name|port
operator|=
name|NSRCPORT
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
name|ip
operator|->
name|hmode
operator|=
name|pp
operator|->
name|hmode
expr_stmt|;
name|ip
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_CONFIG
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_CONFIG
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|sys_peer
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_SYSPEER
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|status
operator|==
name|CTL_PST_SEL_SYNCCAND
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_SEL_CANDIDATE
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|status
operator|>=
name|CTL_PST_SEL_SYSPEER
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_SHORTLIST
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|info_peer_list
operator|*
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
block|}
block|}
comment|/* for pp */
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * list_peers_sum - return extended peer list  */
end_comment

begin_function
specifier|static
name|void
name|list_peers_sum
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|struct
name|info_peer_summary
modifier|*
name|ips
decl_stmt|;
specifier|register
name|struct
name|peer
modifier|*
name|pp
decl_stmt|;
name|l_fp
name|ltmp
decl_stmt|;
specifier|register
name|int
name|skip
decl_stmt|;
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"wants peer list summary\n"
operator|)
argument_list|)
expr_stmt|;
name|ips
operator|=
operator|(
expr|struct
name|info_peer_summary
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|v6sizeof
argument_list|(
expr|struct
name|info_peer_summary
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|pp
operator|=
name|peer_list
init|;
name|pp
operator|!=
name|NULL
operator|&&
name|ips
operator|!=
name|NULL
condition|;
name|pp
operator|=
name|pp
operator|->
name|p_link
control|)
block|{
name|DPRINTF
argument_list|(
literal|4
argument_list|,
operator|(
literal|"sum: got one\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * Be careful here not to return v6 peers when we 		 * want only v4. 		 */
if|if
condition|(
name|IS_IPV6
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
condition|)
block|{
if|if
condition|(
name|client_v6_capable
condition|)
block|{
name|ips
operator|->
name|srcadr6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
name|ips
operator|->
name|v6_flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|dstadr
condition|)
name|ips
operator|->
name|dstadr6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|sin
argument_list|)
expr_stmt|;
else|else
name|ZERO
argument_list|(
name|ips
operator|->
name|dstadr6
argument_list|)
expr_stmt|;
name|skip
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|skip
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|ips
operator|->
name|srcadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
condition|)
name|ips
operator|->
name|v6_flag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|dstadr
condition|)
block|{
if|if
condition|(
operator|!
name|pp
operator|->
name|processed
condition|)
name|ips
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|sin
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|MDF_BCAST
operator|==
name|pp
operator|->
name|cast_flags
condition|)
name|ips
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|bcast
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pp
operator|->
name|cast_flags
condition|)
block|{
name|ips
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|sin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ips
operator|->
name|dstadr
condition|)
name|ips
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|bcast
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
name|ips
operator|->
name|dstadr
operator|=
literal|0
expr_stmt|;
name|skip
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|skip
condition|)
block|{
name|ips
operator|->
name|srcport
operator|=
name|NSRCPORT
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
name|ips
operator|->
name|stratum
operator|=
name|pp
operator|->
name|stratum
expr_stmt|;
name|ips
operator|->
name|hpoll
operator|=
name|pp
operator|->
name|hpoll
expr_stmt|;
name|ips
operator|->
name|ppoll
operator|=
name|pp
operator|->
name|ppoll
expr_stmt|;
name|ips
operator|->
name|reach
operator|=
name|pp
operator|->
name|reach
expr_stmt|;
name|ips
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|sys_peer
condition|)
name|ips
operator|->
name|flags
operator||=
name|INFO_FLAG_SYSPEER
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_CONFIG
condition|)
name|ips
operator|->
name|flags
operator||=
name|INFO_FLAG_CONFIG
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_REFCLOCK
condition|)
name|ips
operator|->
name|flags
operator||=
name|INFO_FLAG_REFCLOCK
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_PREFER
condition|)
name|ips
operator|->
name|flags
operator||=
name|INFO_FLAG_PREFER
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_BURST
condition|)
name|ips
operator|->
name|flags
operator||=
name|INFO_FLAG_BURST
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|status
operator|==
name|CTL_PST_SEL_SYNCCAND
condition|)
name|ips
operator|->
name|flags
operator||=
name|INFO_FLAG_SEL_CANDIDATE
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|status
operator|>=
name|CTL_PST_SEL_SYSPEER
condition|)
name|ips
operator|->
name|flags
operator||=
name|INFO_FLAG_SHORTLIST
expr_stmt|;
name|ips
operator|->
name|hmode
operator|=
name|pp
operator|->
name|hmode
expr_stmt|;
name|ips
operator|->
name|delay
operator|=
name|HTONS_FP
argument_list|(
name|DTOFP
argument_list|(
name|pp
operator|->
name|delay
argument_list|)
argument_list|)
expr_stmt|;
name|DTOLFP
argument_list|(
name|pp
operator|->
name|offset
argument_list|,
operator|&
name|ltmp
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|ltmp
argument_list|,
operator|&
name|ips
operator|->
name|offset
argument_list|)
expr_stmt|;
name|ips
operator|->
name|dispersion
operator|=
name|HTONS_FP
argument_list|(
name|DTOUFP
argument_list|(
name|SQRT
argument_list|(
name|pp
operator|->
name|disp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ips
operator|=
operator|(
expr|struct
name|info_peer_summary
operator|*
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
block|}
comment|/* for pp */
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * peer_info - send information for one or more peers  */
end_comment

begin_function
specifier|static
name|void
name|peer_info
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|u_short
name|items
decl_stmt|;
name|size_t
name|item_sz
decl_stmt|;
name|char
modifier|*
name|datap
decl_stmt|;
name|struct
name|info_peer_list
name|ipl
decl_stmt|;
name|struct
name|peer
modifier|*
name|pp
decl_stmt|;
name|struct
name|info_peer
modifier|*
name|ip
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
name|sockaddr_u
name|addr
decl_stmt|;
name|l_fp
name|ltmp
decl_stmt|;
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|item_sz
operator|=
name|INFO_ITEMSIZE
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
expr_stmt|;
name|datap
operator|=
name|inpkt
operator|->
name|u
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|item_sz
operator|!=
sizeof|sizeof
argument_list|(
name|ipl
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|ip
operator|=
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|v6sizeof
argument_list|(
expr|struct
name|info_peer
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
operator|&&
name|ip
operator|!=
name|NULL
condition|)
block|{
name|ZERO
argument_list|(
name|ipl
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ipl
argument_list|,
name|datap
argument_list|,
name|item_sz
argument_list|)
expr_stmt|;
name|ZERO_SOCK
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
name|NSRCPORT
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|ipl
operator|.
name|port
expr_stmt|;
if|if
condition|(
name|client_v6_capable
operator|&&
name|ipl
operator|.
name|v6_flag
condition|)
block|{
name|AF
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SOCK_ADDR6
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|ipl
operator|.
name|addr6
expr_stmt|;
block|}
else|else
block|{
name|AF
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|ipl
operator|.
name|addr
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|addr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|datap
operator|+=
name|item_sz
expr_stmt|;
name|pp
operator|=
name|findexistingpeer
argument_list|(
operator|&
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|pp
condition|)
continue|continue;
if|if
condition|(
name|IS_IPV6
argument_list|(
name|srcadr
argument_list|)
condition|)
block|{
if|if
condition|(
name|pp
operator|->
name|dstadr
condition|)
name|ip
operator|->
name|dstadr6
operator|=
operator|(
name|MDF_BCAST
operator|==
name|pp
operator|->
name|cast_flags
operator|)
condition|?
name|SOCK_ADDR6
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|bcast
argument_list|)
else|:
name|SOCK_ADDR6
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|sin
argument_list|)
expr_stmt|;
else|else
name|ZERO
argument_list|(
name|ip
operator|->
name|dstadr6
argument_list|)
expr_stmt|;
name|ip
operator|->
name|srcadr6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
name|ip
operator|->
name|v6_flag
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pp
operator|->
name|dstadr
condition|)
block|{
if|if
condition|(
operator|!
name|pp
operator|->
name|processed
condition|)
name|ip
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|sin
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|MDF_BCAST
operator|==
name|pp
operator|->
name|cast_flags
condition|)
name|ip
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|bcast
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pp
operator|->
name|cast_flags
condition|)
block|{
name|ip
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|sin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ip
operator|->
name|dstadr
condition|)
name|ip
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|bcast
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
name|ip
operator|->
name|dstadr
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|srcadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
condition|)
name|ip
operator|->
name|v6_flag
operator|=
literal|0
expr_stmt|;
block|}
name|ip
operator|->
name|srcport
operator|=
name|NSRCPORT
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
name|ip
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|sys_peer
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_SYSPEER
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_CONFIG
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_CONFIG
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_REFCLOCK
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_REFCLOCK
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_PREFER
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_PREFER
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_BURST
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_BURST
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|status
operator|==
name|CTL_PST_SEL_SYNCCAND
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_SEL_CANDIDATE
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|status
operator|>=
name|CTL_PST_SEL_SYSPEER
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_SHORTLIST
expr_stmt|;
name|ip
operator|->
name|leap
operator|=
name|pp
operator|->
name|leap
expr_stmt|;
name|ip
operator|->
name|hmode
operator|=
name|pp
operator|->
name|hmode
expr_stmt|;
name|ip
operator|->
name|keyid
operator|=
name|pp
operator|->
name|keyid
expr_stmt|;
name|ip
operator|->
name|stratum
operator|=
name|pp
operator|->
name|stratum
expr_stmt|;
name|ip
operator|->
name|ppoll
operator|=
name|pp
operator|->
name|ppoll
expr_stmt|;
name|ip
operator|->
name|hpoll
operator|=
name|pp
operator|->
name|hpoll
expr_stmt|;
name|ip
operator|->
name|precision
operator|=
name|pp
operator|->
name|precision
expr_stmt|;
name|ip
operator|->
name|version
operator|=
name|pp
operator|->
name|version
expr_stmt|;
name|ip
operator|->
name|reach
operator|=
name|pp
operator|->
name|reach
expr_stmt|;
name|ip
operator|->
name|unreach
operator|=
operator|(
name|u_char
operator|)
name|pp
operator|->
name|unreach
expr_stmt|;
name|ip
operator|->
name|flash
operator|=
operator|(
name|u_char
operator|)
name|pp
operator|->
name|flash
expr_stmt|;
name|ip
operator|->
name|flash2
operator|=
operator|(
name|u_short
operator|)
name|pp
operator|->
name|flash
expr_stmt|;
name|ip
operator|->
name|estbdelay
operator|=
name|HTONS_FP
argument_list|(
name|DTOFP
argument_list|(
name|pp
operator|->
name|delay
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ttl
operator|=
operator|(
name|u_char
operator|)
name|pp
operator|->
name|ttl
expr_stmt|;
name|ip
operator|->
name|associd
operator|=
name|htons
argument_list|(
name|pp
operator|->
name|associd
argument_list|)
expr_stmt|;
name|ip
operator|->
name|rootdelay
operator|=
name|HTONS_FP
argument_list|(
name|DTOUFP
argument_list|(
name|pp
operator|->
name|rootdelay
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|rootdispersion
operator|=
name|HTONS_FP
argument_list|(
name|DTOUFP
argument_list|(
name|pp
operator|->
name|rootdisp
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|refid
operator|=
name|pp
operator|->
name|refid
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|reftime
argument_list|,
operator|&
name|ip
operator|->
name|reftime
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|aorg
argument_list|,
operator|&
name|ip
operator|->
name|org
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|rec
argument_list|,
operator|&
name|ip
operator|->
name|rec
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|pp
operator|->
name|xmt
argument_list|,
operator|&
name|ip
operator|->
name|xmt
argument_list|)
expr_stmt|;
name|j
operator|=
name|pp
operator|->
name|filter_nextpt
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NTP_SHIFT
condition|;
name|i
operator|++
operator|,
name|j
operator|--
control|)
block|{
if|if
condition|(
name|j
operator|<
literal|0
condition|)
name|j
operator|=
name|NTP_SHIFT
operator|-
literal|1
expr_stmt|;
name|ip
operator|->
name|filtdelay
index|[
name|i
index|]
operator|=
name|HTONS_FP
argument_list|(
name|DTOFP
argument_list|(
name|pp
operator|->
name|filter_delay
index|[
name|j
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|DTOLFP
argument_list|(
name|pp
operator|->
name|filter_offset
index|[
name|j
index|]
argument_list|,
operator|&
name|ltmp
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|ltmp
argument_list|,
operator|&
name|ip
operator|->
name|filtoffset
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ip
operator|->
name|order
index|[
name|i
index|]
operator|=
call|(
name|u_char
call|)
argument_list|(
operator|(
name|pp
operator|->
name|filter_nextpt
operator|+
name|NTP_SHIFT
operator|-
literal|1
operator|)
operator|-
name|pp
operator|->
name|filter_order
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|order
index|[
name|i
index|]
operator|>=
name|NTP_SHIFT
condition|)
name|ip
operator|->
name|order
index|[
name|i
index|]
operator|-=
name|NTP_SHIFT
expr_stmt|;
block|}
name|DTOLFP
argument_list|(
name|pp
operator|->
name|offset
argument_list|,
operator|&
name|ltmp
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|ltmp
argument_list|,
operator|&
name|ip
operator|->
name|offset
argument_list|)
expr_stmt|;
name|ip
operator|->
name|delay
operator|=
name|HTONS_FP
argument_list|(
name|DTOFP
argument_list|(
name|pp
operator|->
name|delay
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|dispersion
operator|=
name|HTONS_FP
argument_list|(
name|DTOUFP
argument_list|(
name|SQRT
argument_list|(
name|pp
operator|->
name|disp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|selectdisp
operator|=
name|HTONS_FP
argument_list|(
name|DTOUFP
argument_list|(
name|SQRT
argument_list|(
name|pp
operator|->
name|jitter
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|=
name|more_pkt
argument_list|()
expr_stmt|;
block|}
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * peer_stats - send statistics for one or more peers  */
end_comment

begin_function
specifier|static
name|void
name|peer_stats
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|u_short
name|items
decl_stmt|;
name|size_t
name|item_sz
decl_stmt|;
name|char
modifier|*
name|datap
decl_stmt|;
name|struct
name|info_peer_list
name|ipl
decl_stmt|;
name|struct
name|peer
modifier|*
name|pp
decl_stmt|;
name|struct
name|info_peer_stats
modifier|*
name|ip
decl_stmt|;
name|sockaddr_u
name|addr
decl_stmt|;
name|DPRINTF
argument_list|(
literal|1
argument_list|,
operator|(
literal|"peer_stats: called\n"
operator|)
argument_list|)
expr_stmt|;
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|item_sz
operator|=
name|INFO_ITEMSIZE
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
expr_stmt|;
name|datap
operator|=
name|inpkt
operator|->
name|u
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|item_sz
operator|>
sizeof|sizeof
argument_list|(
name|ipl
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|ip
operator|=
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|v6sizeof
argument_list|(
expr|struct
name|info_peer_stats
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
operator|&&
name|ip
operator|!=
name|NULL
condition|)
block|{
name|ZERO
argument_list|(
name|ipl
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ipl
argument_list|,
name|datap
argument_list|,
name|item_sz
argument_list|)
expr_stmt|;
name|ZERO
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|NSRCPORT
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|ipl
operator|.
name|port
expr_stmt|;
if|if
condition|(
name|client_v6_capable
operator|&&
name|ipl
operator|.
name|v6_flag
condition|)
block|{
name|AF
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SOCK_ADDR6
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|ipl
operator|.
name|addr6
expr_stmt|;
block|}
else|else
block|{
name|AF
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|ipl
operator|.
name|addr
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|addr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|DPRINTF
argument_list|(
literal|1
argument_list|,
operator|(
literal|"peer_stats: looking for %s, %d, %d\n"
operator|,
name|stoa
argument_list|(
operator|&
name|addr
argument_list|)
operator|,
name|ipl
operator|.
name|port
operator|,
name|NSRCPORT
argument_list|(
operator|&
name|addr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|datap
operator|+=
name|item_sz
expr_stmt|;
name|pp
operator|=
name|findexistingpeer
argument_list|(
operator|&
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|pp
condition|)
continue|continue;
name|DPRINTF
argument_list|(
literal|1
argument_list|,
operator|(
literal|"peer_stats: found %s\n"
operator|,
name|stoa
argument_list|(
operator|&
name|addr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_IPV4
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
condition|)
block|{
if|if
condition|(
name|pp
operator|->
name|dstadr
condition|)
block|{
if|if
condition|(
operator|!
name|pp
operator|->
name|processed
condition|)
name|ip
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|sin
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|MDF_BCAST
operator|==
name|pp
operator|->
name|cast_flags
condition|)
name|ip
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|bcast
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pp
operator|->
name|cast_flags
condition|)
block|{
name|ip
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|sin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ip
operator|->
name|dstadr
condition|)
name|ip
operator|->
name|dstadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|bcast
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
name|ip
operator|->
name|dstadr
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|srcadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
condition|)
name|ip
operator|->
name|v6_flag
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pp
operator|->
name|dstadr
condition|)
name|ip
operator|->
name|dstadr6
operator|=
operator|(
name|MDF_BCAST
operator|==
name|pp
operator|->
name|cast_flags
operator|)
condition|?
name|SOCK_ADDR6
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|bcast
argument_list|)
else|:
name|SOCK_ADDR6
argument_list|(
operator|&
name|pp
operator|->
name|dstadr
operator|->
name|sin
argument_list|)
expr_stmt|;
else|else
name|ZERO
argument_list|(
name|ip
operator|->
name|dstadr6
argument_list|)
expr_stmt|;
name|ip
operator|->
name|srcadr6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
name|ip
operator|->
name|v6_flag
operator|=
literal|1
expr_stmt|;
block|}
name|ip
operator|->
name|srcport
operator|=
name|NSRCPORT
argument_list|(
operator|&
name|pp
operator|->
name|srcadr
argument_list|)
expr_stmt|;
name|ip
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|sys_peer
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_SYSPEER
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_CONFIG
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_CONFIG
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_REFCLOCK
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_REFCLOCK
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_PREFER
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_PREFER
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_BURST
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_BURST
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|flags
operator|&
name|FLAG_IBURST
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_IBURST
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|status
operator|==
name|CTL_PST_SEL_SYNCCAND
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_SEL_CANDIDATE
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|status
operator|>=
name|CTL_PST_SEL_SYSPEER
condition|)
name|ip
operator|->
name|flags
operator||=
name|INFO_FLAG_SHORTLIST
expr_stmt|;
name|ip
operator|->
name|flags
operator|=
name|htons
argument_list|(
name|ip
operator|->
name|flags
argument_list|)
expr_stmt|;
name|ip
operator|->
name|timereceived
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|pp
operator|->
name|timereceived
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|timetosend
operator|=
name|htonl
argument_list|(
name|pp
operator|->
name|nextdate
operator|-
name|current_time
argument_list|)
expr_stmt|;
name|ip
operator|->
name|timereachable
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|pp
operator|->
name|timereachable
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|sent
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|pp
operator|->
name|sent
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|processed
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|pp
operator|->
name|processed
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|badauth
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|pp
operator|->
name|badauth
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|bogusorg
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|pp
operator|->
name|bogusorg
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|oldpkt
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|pp
operator|->
name|oldpkt
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|seldisp
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|pp
operator|->
name|seldisptoolarge
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|selbroken
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|pp
operator|->
name|selbroken
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|candidate
operator|=
name|pp
operator|->
name|status
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|info_peer_stats
operator|*
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
block|}
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * sys_info - return system info  */
end_comment

begin_function
specifier|static
name|void
name|sys_info
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|struct
name|info_sys
modifier|*
name|is
decl_stmt|;
name|is
operator|=
operator|(
expr|struct
name|info_sys
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|v6sizeof
argument_list|(
expr|struct
name|info_sys
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sys_peer
condition|)
block|{
if|if
condition|(
name|IS_IPV4
argument_list|(
operator|&
name|sys_peer
operator|->
name|srcadr
argument_list|)
condition|)
block|{
name|is
operator|->
name|peer
operator|=
name|NSRCADR
argument_list|(
operator|&
name|sys_peer
operator|->
name|srcadr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
condition|)
name|is
operator|->
name|v6_flag
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|client_v6_capable
condition|)
block|{
name|is
operator|->
name|peer6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|sys_peer
operator|->
name|srcadr
argument_list|)
expr_stmt|;
name|is
operator|->
name|v6_flag
operator|=
literal|1
expr_stmt|;
block|}
name|is
operator|->
name|peer_mode
operator|=
name|sys_peer
operator|->
name|hmode
expr_stmt|;
block|}
else|else
block|{
name|is
operator|->
name|peer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|client_v6_capable
condition|)
block|{
name|is
operator|->
name|v6_flag
operator|=
literal|0
expr_stmt|;
block|}
name|is
operator|->
name|peer_mode
operator|=
literal|0
expr_stmt|;
block|}
name|is
operator|->
name|leap
operator|=
name|sys_leap
expr_stmt|;
name|is
operator|->
name|stratum
operator|=
name|sys_stratum
expr_stmt|;
name|is
operator|->
name|precision
operator|=
name|sys_precision
expr_stmt|;
name|is
operator|->
name|rootdelay
operator|=
name|htonl
argument_list|(
name|DTOFP
argument_list|(
name|sys_rootdelay
argument_list|)
argument_list|)
expr_stmt|;
name|is
operator|->
name|rootdispersion
operator|=
name|htonl
argument_list|(
name|DTOUFP
argument_list|(
name|sys_rootdisp
argument_list|)
argument_list|)
expr_stmt|;
name|is
operator|->
name|frequency
operator|=
name|htonl
argument_list|(
name|DTOFP
argument_list|(
name|sys_jitter
argument_list|)
argument_list|)
expr_stmt|;
name|is
operator|->
name|stability
operator|=
name|htonl
argument_list|(
name|DTOUFP
argument_list|(
name|clock_stability
operator|*
literal|1e6
argument_list|)
argument_list|)
expr_stmt|;
name|is
operator|->
name|refid
operator|=
name|sys_refid
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|sys_reftime
argument_list|,
operator|&
name|is
operator|->
name|reftime
argument_list|)
expr_stmt|;
name|is
operator|->
name|poll
operator|=
name|sys_poll
expr_stmt|;
name|is
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sys_authenticate
condition|)
name|is
operator|->
name|flags
operator||=
name|INFO_FLAG_AUTHENTICATE
expr_stmt|;
if|if
condition|(
name|sys_bclient
condition|)
name|is
operator|->
name|flags
operator||=
name|INFO_FLAG_BCLIENT
expr_stmt|;
ifdef|#
directive|ifdef
name|REFCLOCK
if|if
condition|(
name|cal_enable
condition|)
name|is
operator|->
name|flags
operator||=
name|INFO_FLAG_CAL
expr_stmt|;
endif|#
directive|endif
comment|/* REFCLOCK */
if|if
condition|(
name|kern_enable
condition|)
name|is
operator|->
name|flags
operator||=
name|INFO_FLAG_KERNEL
expr_stmt|;
if|if
condition|(
name|mon_enabled
operator|!=
name|MON_OFF
condition|)
name|is
operator|->
name|flags
operator||=
name|INFO_FLAG_MONITOR
expr_stmt|;
if|if
condition|(
name|ntp_enable
condition|)
name|is
operator|->
name|flags
operator||=
name|INFO_FLAG_NTP
expr_stmt|;
if|if
condition|(
name|hardpps_enable
condition|)
name|is
operator|->
name|flags
operator||=
name|INFO_FLAG_PPS_SYNC
expr_stmt|;
if|if
condition|(
name|stats_control
condition|)
name|is
operator|->
name|flags
operator||=
name|INFO_FLAG_FILEGEN
expr_stmt|;
name|is
operator|->
name|bdelay
operator|=
name|HTONS_FP
argument_list|(
name|DTOFP
argument_list|(
name|sys_bdelay
argument_list|)
argument_list|)
expr_stmt|;
name|HTONL_UF
argument_list|(
name|sys_authdelay
operator|.
name|l_uf
argument_list|,
operator|&
name|is
operator|->
name|authdelay
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * sys_stats - return system statistics  */
end_comment

begin_function
specifier|static
name|void
name|sys_stats
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|struct
name|info_sys_stats
modifier|*
name|ss
decl_stmt|;
name|ss
operator|=
operator|(
expr|struct
name|info_sys_stats
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_sys_stats
argument_list|)
argument_list|)
expr_stmt|;
name|ss
operator|->
name|timeup
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|current_time
argument_list|)
expr_stmt|;
name|ss
operator|->
name|timereset
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|sys_stattime
argument_list|)
argument_list|)
expr_stmt|;
name|ss
operator|->
name|denied
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sys_restricted
argument_list|)
expr_stmt|;
name|ss
operator|->
name|oldversionpkt
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sys_oldversion
argument_list|)
expr_stmt|;
name|ss
operator|->
name|newversionpkt
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sys_newversion
argument_list|)
expr_stmt|;
name|ss
operator|->
name|unknownversion
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sys_declined
argument_list|)
expr_stmt|;
name|ss
operator|->
name|badlength
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sys_badlength
argument_list|)
expr_stmt|;
name|ss
operator|->
name|processed
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sys_processed
argument_list|)
expr_stmt|;
name|ss
operator|->
name|badauth
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sys_badauth
argument_list|)
expr_stmt|;
name|ss
operator|->
name|limitrejected
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sys_limitrejected
argument_list|)
expr_stmt|;
name|ss
operator|->
name|received
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sys_received
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * mem_stats - return memory statistics  */
end_comment

begin_function
specifier|static
name|void
name|mem_stats
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|struct
name|info_mem_stats
modifier|*
name|ms
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|ms
operator|=
operator|(
expr|struct
name|info_mem_stats
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_mem_stats
argument_list|)
argument_list|)
expr_stmt|;
name|ms
operator|->
name|timereset
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|peer_timereset
argument_list|)
argument_list|)
expr_stmt|;
name|ms
operator|->
name|totalpeermem
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|total_peer_structs
argument_list|)
expr_stmt|;
name|ms
operator|->
name|freepeermem
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|peer_free_count
argument_list|)
expr_stmt|;
name|ms
operator|->
name|findpeer_calls
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|findpeer_calls
argument_list|)
expr_stmt|;
name|ms
operator|->
name|allocations
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|peer_allocations
argument_list|)
expr_stmt|;
name|ms
operator|->
name|demobilizations
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|peer_demobilizations
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NTP_HASH_SIZE
condition|;
name|i
operator|++
control|)
name|ms
operator|->
name|hashcount
index|[
name|i
index|]
operator|=
operator|(
name|u_char
operator|)
name|max
argument_list|(
operator|(
name|u_int
operator|)
name|peer_hash_count
index|[
name|i
index|]
argument_list|,
name|UCHAR_MAX
argument_list|)
expr_stmt|;
name|more_pkt
argument_list|()
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * io_stats - return io statistics  */
end_comment

begin_function
specifier|static
name|void
name|io_stats
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|struct
name|info_io_stats
modifier|*
name|io
decl_stmt|;
name|io
operator|=
operator|(
expr|struct
name|info_io_stats
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_io_stats
argument_list|)
argument_list|)
expr_stmt|;
name|io
operator|->
name|timereset
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|io_timereset
argument_list|)
argument_list|)
expr_stmt|;
name|io
operator|->
name|totalrecvbufs
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|total_recvbuffs
argument_list|()
argument_list|)
expr_stmt|;
name|io
operator|->
name|freerecvbufs
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|free_recvbuffs
argument_list|()
argument_list|)
expr_stmt|;
name|io
operator|->
name|fullrecvbufs
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|full_recvbuffs
argument_list|()
argument_list|)
expr_stmt|;
name|io
operator|->
name|lowwater
operator|=
name|htons
argument_list|(
operator|(
name|u_short
operator|)
name|lowater_additions
argument_list|()
argument_list|)
expr_stmt|;
name|io
operator|->
name|dropped
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|packets_dropped
argument_list|)
expr_stmt|;
name|io
operator|->
name|ignored
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|packets_ignored
argument_list|)
expr_stmt|;
name|io
operator|->
name|received
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|packets_received
argument_list|)
expr_stmt|;
name|io
operator|->
name|sent
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|packets_sent
argument_list|)
expr_stmt|;
name|io
operator|->
name|notsent
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|packets_notsent
argument_list|)
expr_stmt|;
name|io
operator|->
name|interrupts
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|handler_calls
argument_list|)
expr_stmt|;
name|io
operator|->
name|int_received
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|handler_pkts
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * timer_stats - return timer statistics  */
end_comment

begin_function
specifier|static
name|void
name|timer_stats
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|struct
name|info_timer_stats
modifier|*
name|ts
decl_stmt|;
name|u_long
name|sincereset
decl_stmt|;
name|ts
operator|=
operator|(
expr|struct
name|info_timer_stats
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ts
argument_list|)
argument_list|)
expr_stmt|;
name|sincereset
operator|=
name|current_time
operator|-
name|timer_timereset
expr_stmt|;
name|ts
operator|->
name|timereset
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|sincereset
argument_list|)
expr_stmt|;
name|ts
operator|->
name|alarms
operator|=
name|ts
operator|->
name|timereset
expr_stmt|;
name|ts
operator|->
name|overflows
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|alarm_overflow
argument_list|)
expr_stmt|;
name|ts
operator|->
name|xmtcalls
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|timer_xmtcalls
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * loop_info - return the current state of the loop filter  */
end_comment

begin_function
specifier|static
name|void
name|loop_info
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|struct
name|info_loop
modifier|*
name|li
decl_stmt|;
name|l_fp
name|ltmp
decl_stmt|;
name|li
operator|=
operator|(
expr|struct
name|info_loop
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_loop
argument_list|)
argument_list|)
expr_stmt|;
name|DTOLFP
argument_list|(
name|last_offset
argument_list|,
operator|&
name|ltmp
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|ltmp
argument_list|,
operator|&
name|li
operator|->
name|last_offset
argument_list|)
expr_stmt|;
name|DTOLFP
argument_list|(
name|drift_comp
operator|*
literal|1e6
argument_list|,
operator|&
name|ltmp
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|ltmp
argument_list|,
operator|&
name|li
operator|->
name|drift_comp
argument_list|)
expr_stmt|;
name|li
operator|->
name|compliance
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|tc_counter
argument_list|)
argument_list|)
expr_stmt|;
name|li
operator|->
name|watchdog_timer
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|sys_epoch
argument_list|)
argument_list|)
expr_stmt|;
name|more_pkt
argument_list|()
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_conf - add a peer to the configuration list  */
end_comment

begin_function
specifier|static
name|void
name|do_conf
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|u_short
name|items
decl_stmt|;
name|size_t
name|item_sz
decl_stmt|;
name|u_int
name|fl
decl_stmt|;
name|char
modifier|*
name|datap
decl_stmt|;
name|struct
name|conf_peer
name|temp_cp
decl_stmt|;
name|sockaddr_u
name|peeraddr
decl_stmt|;
comment|/* 	 * Do a check of everything to see that it looks 	 * okay.  If not, complain about it.  Note we are 	 * very picky here. 	 */
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|item_sz
operator|=
name|INFO_ITEMSIZE
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
expr_stmt|;
name|datap
operator|=
name|inpkt
operator|->
name|u
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|item_sz
operator|>
sizeof|sizeof
argument_list|(
name|temp_cp
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
name|ZERO
argument_list|(
name|temp_cp
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|temp_cp
argument_list|,
name|datap
argument_list|,
name|item_sz
argument_list|)
expr_stmt|;
name|ZERO_SOCK
argument_list|(
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
name|fl
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|temp_cp
operator|.
name|flags
operator|&
name|CONF_FLAG_PREFER
condition|)
name|fl
operator||=
name|FLAG_PREFER
expr_stmt|;
if|if
condition|(
name|temp_cp
operator|.
name|flags
operator|&
name|CONF_FLAG_BURST
condition|)
name|fl
operator||=
name|FLAG_BURST
expr_stmt|;
if|if
condition|(
name|temp_cp
operator|.
name|flags
operator|&
name|CONF_FLAG_IBURST
condition|)
name|fl
operator||=
name|FLAG_IBURST
expr_stmt|;
ifdef|#
directive|ifdef
name|AUTOKEY
if|if
condition|(
name|temp_cp
operator|.
name|flags
operator|&
name|CONF_FLAG_SKEY
condition|)
name|fl
operator||=
name|FLAG_SKEY
expr_stmt|;
endif|#
directive|endif
comment|/* AUTOKEY */
if|if
condition|(
name|client_v6_capable
operator|&&
name|temp_cp
operator|.
name|v6_flag
condition|)
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SOCK_ADDR6
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|temp_cp
operator|.
name|peeraddr6
expr_stmt|;
block|}
else|else
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|temp_cp
operator|.
name|peeraddr
expr_stmt|;
comment|/* 			 * Make sure the address is valid 			 */
if|if
condition|(
operator|!
name|ISREFCLOCKADR
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|&&
name|ISBADADR
argument_list|(
operator|&
name|peeraddr
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|NSRCPORT
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|htons
argument_list|(
name|NTP_PORT
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|peeraddr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* XXX W2DO? minpoll/maxpoll arguments ??? */
if|if
condition|(
name|peer_config
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|temp_cp
operator|.
name|hmode
argument_list|,
name|temp_cp
operator|.
name|version
argument_list|,
name|temp_cp
operator|.
name|minpoll
argument_list|,
name|temp_cp
operator|.
name|maxpoll
argument_list|,
name|fl
argument_list|,
name|temp_cp
operator|.
name|ttl
argument_list|,
name|temp_cp
operator|.
name|keyid
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
name|datap
operator|+=
name|item_sz
expr_stmt|;
block|}
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_unconf - remove a peer from the configuration list  */
end_comment

begin_function
specifier|static
name|void
name|do_unconf
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|u_short
name|items
decl_stmt|;
name|size_t
name|item_sz
decl_stmt|;
name|char
modifier|*
name|datap
decl_stmt|;
name|struct
name|conf_unpeer
name|temp_cp
decl_stmt|;
name|struct
name|peer
modifier|*
name|p
decl_stmt|;
name|sockaddr_u
name|peeraddr
decl_stmt|;
name|int
name|bad
decl_stmt|;
name|int
name|found
decl_stmt|;
comment|/* 	 * This is a bit unstructured, but I like to be careful. 	 * We check to see that every peer exists and is actually 	 * configured.  If so, we remove them.  If not, we return 	 * an error. 	 */
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|item_sz
operator|=
name|INFO_ITEMSIZE
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
expr_stmt|;
name|datap
operator|=
name|inpkt
operator|->
name|u
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|item_sz
operator|>
sizeof|sizeof
argument_list|(
name|temp_cp
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|bad
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
operator|&&
operator|!
name|bad
condition|)
block|{
name|ZERO
argument_list|(
name|temp_cp
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|temp_cp
argument_list|,
name|datap
argument_list|,
name|item_sz
argument_list|)
expr_stmt|;
name|ZERO_SOCK
argument_list|(
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
operator|&&
name|temp_cp
operator|.
name|v6_flag
condition|)
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SOCK_ADDR6
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|temp_cp
operator|.
name|peeraddr6
expr_stmt|;
block|}
else|else
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|temp_cp
operator|.
name|peeraddr
expr_stmt|;
block|}
name|SET_PORT
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|NTP_PORT
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|peeraddr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|found
operator|=
name|FALSE
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
name|DPRINTF
argument_list|(
literal|1
argument_list|,
operator|(
literal|"searching for %s\n"
operator|,
name|stoa
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|found
condition|)
block|{
name|p
operator|=
name|findexistingpeer
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|NULL
argument_list|,
name|p
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|p
condition|)
break|break;
if|if
condition|(
name|FLAG_CONFIG
operator|&
name|p
operator|->
name|flags
condition|)
name|found
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
name|bad
operator|=
name|TRUE
expr_stmt|;
name|datap
operator|+=
name|item_sz
expr_stmt|;
block|}
if|if
condition|(
name|bad
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Now do it in earnest. 	 */
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|datap
operator|=
name|inpkt
operator|->
name|u
operator|.
name|data
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
name|ZERO
argument_list|(
name|temp_cp
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|temp_cp
argument_list|,
name|datap
argument_list|,
name|item_sz
argument_list|)
expr_stmt|;
name|ZERO
argument_list|(
name|peeraddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
operator|&&
name|temp_cp
operator|.
name|v6_flag
condition|)
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SOCK_ADDR6
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|temp_cp
operator|.
name|peeraddr6
expr_stmt|;
block|}
else|else
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|temp_cp
operator|.
name|peeraddr
expr_stmt|;
block|}
name|SET_PORT
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|NTP_PORT
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|peeraddr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|found
operator|=
name|FALSE
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|!
name|found
condition|)
block|{
name|p
operator|=
name|findexistingpeer
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|NULL
argument_list|,
name|p
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|p
condition|)
break|break;
if|if
condition|(
name|FLAG_CONFIG
operator|&
name|p
operator|->
name|flags
condition|)
name|found
operator|=
name|TRUE
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|found
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|NULL
operator|!=
name|p
argument_list|)
expr_stmt|;
name|peer_clear
argument_list|(
name|p
argument_list|,
literal|"GONE"
argument_list|)
expr_stmt|;
name|unpeer
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|datap
operator|+=
name|item_sz
expr_stmt|;
block|}
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * set_sys_flag - set system flags  */
end_comment

begin_function
specifier|static
name|void
name|set_sys_flag
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|setclr_flags
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * clr_sys_flag - clear system flags  */
end_comment

begin_function
specifier|static
name|void
name|clr_sys_flag
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|setclr_flags
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * setclr_flags - do the grunge work of flag setting/clearing  */
end_comment

begin_function
specifier|static
name|void
name|setclr_flags
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|,
name|u_long
name|set
parameter_list|)
block|{
name|struct
name|conf_sys_flags
modifier|*
name|sf
decl_stmt|;
name|u_int32
name|flags
decl_stmt|;
if|if
condition|(
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
operator|>
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"setclr_flags: err_nitems> 1"
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|sf
operator|=
operator|(
expr|struct
name|conf_sys_flags
operator|*
operator|)
operator|&
name|inpkt
operator|->
name|u
expr_stmt|;
name|flags
operator|=
name|ntohl
argument_list|(
name|sf
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
operator|~
operator|(
name|SYS_FLAG_BCLIENT
operator||
name|SYS_FLAG_PPS
operator||
name|SYS_FLAG_NTP
operator||
name|SYS_FLAG_KERNEL
operator||
name|SYS_FLAG_MONITOR
operator||
name|SYS_FLAG_FILEGEN
operator||
name|SYS_FLAG_AUTH
operator||
name|SYS_FLAG_CAL
operator|)
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"setclr_flags: extra flags: %#x"
argument_list|,
name|flags
operator|&
operator|~
operator|(
name|SYS_FLAG_BCLIENT
operator||
name|SYS_FLAG_PPS
operator||
name|SYS_FLAG_NTP
operator||
name|SYS_FLAG_KERNEL
operator||
name|SYS_FLAG_MONITOR
operator||
name|SYS_FLAG_FILEGEN
operator||
name|SYS_FLAG_AUTH
operator||
name|SYS_FLAG_CAL
operator|)
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|flags
operator|&
name|SYS_FLAG_BCLIENT
condition|)
name|proto_config
argument_list|(
name|PROTO_BROADCLIENT
argument_list|,
name|set
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|SYS_FLAG_PPS
condition|)
name|proto_config
argument_list|(
name|PROTO_PPS
argument_list|,
name|set
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|SYS_FLAG_NTP
condition|)
name|proto_config
argument_list|(
name|PROTO_NTP
argument_list|,
name|set
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|SYS_FLAG_KERNEL
condition|)
name|proto_config
argument_list|(
name|PROTO_KERNEL
argument_list|,
name|set
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|SYS_FLAG_MONITOR
condition|)
name|proto_config
argument_list|(
name|PROTO_MONITOR
argument_list|,
name|set
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|SYS_FLAG_FILEGEN
condition|)
name|proto_config
argument_list|(
name|PROTO_FILEGEN
argument_list|,
name|set
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|SYS_FLAG_AUTH
condition|)
name|proto_config
argument_list|(
name|PROTO_AUTHENTICATE
argument_list|,
name|set
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|SYS_FLAG_CAL
condition|)
name|proto_config
argument_list|(
name|PROTO_CAL
argument_list|,
name|set
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * list_restrict4 - recursive helper for list_restrict dumps IPv4  *		    restriction list in reverse order.  */
end_comment

begin_function
specifier|static
name|void
name|list_restrict4
parameter_list|(
name|restrict_u
modifier|*
name|res
parameter_list|,
name|struct
name|info_restrict
modifier|*
modifier|*
name|ppir
parameter_list|)
block|{
name|struct
name|info_restrict
modifier|*
name|pir
decl_stmt|;
if|if
condition|(
name|res
operator|->
name|link
operator|!=
name|NULL
condition|)
name|list_restrict4
argument_list|(
name|res
operator|->
name|link
argument_list|,
name|ppir
argument_list|)
expr_stmt|;
name|pir
operator|=
operator|*
name|ppir
expr_stmt|;
name|pir
operator|->
name|addr
operator|=
name|htonl
argument_list|(
name|res
operator|->
name|u
operator|.
name|v4
operator|.
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
condition|)
name|pir
operator|->
name|v6_flag
operator|=
literal|0
expr_stmt|;
name|pir
operator|->
name|mask
operator|=
name|htonl
argument_list|(
name|res
operator|->
name|u
operator|.
name|v4
operator|.
name|mask
argument_list|)
expr_stmt|;
name|pir
operator|->
name|count
operator|=
name|htonl
argument_list|(
name|res
operator|->
name|count
argument_list|)
expr_stmt|;
name|pir
operator|->
name|flags
operator|=
name|htons
argument_list|(
name|res
operator|->
name|flags
argument_list|)
expr_stmt|;
name|pir
operator|->
name|mflags
operator|=
name|htons
argument_list|(
name|res
operator|->
name|mflags
argument_list|)
expr_stmt|;
operator|*
name|ppir
operator|=
operator|(
expr|struct
name|info_restrict
operator|*
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * list_restrict6 - recursive helper for list_restrict dumps IPv6  *		    restriction list in reverse order.  */
end_comment

begin_function
specifier|static
name|void
name|list_restrict6
parameter_list|(
name|restrict_u
modifier|*
name|res
parameter_list|,
name|struct
name|info_restrict
modifier|*
modifier|*
name|ppir
parameter_list|)
block|{
name|struct
name|info_restrict
modifier|*
name|pir
decl_stmt|;
if|if
condition|(
name|res
operator|->
name|link
operator|!=
name|NULL
condition|)
name|list_restrict6
argument_list|(
name|res
operator|->
name|link
argument_list|,
name|ppir
argument_list|)
expr_stmt|;
name|pir
operator|=
operator|*
name|ppir
expr_stmt|;
name|pir
operator|->
name|addr6
operator|=
name|res
operator|->
name|u
operator|.
name|v6
operator|.
name|addr
expr_stmt|;
name|pir
operator|->
name|mask6
operator|=
name|res
operator|->
name|u
operator|.
name|v6
operator|.
name|mask
expr_stmt|;
name|pir
operator|->
name|v6_flag
operator|=
literal|1
expr_stmt|;
name|pir
operator|->
name|count
operator|=
name|htonl
argument_list|(
name|res
operator|->
name|count
argument_list|)
expr_stmt|;
name|pir
operator|->
name|flags
operator|=
name|htons
argument_list|(
name|res
operator|->
name|flags
argument_list|)
expr_stmt|;
name|pir
operator|->
name|mflags
operator|=
name|htons
argument_list|(
name|res
operator|->
name|mflags
argument_list|)
expr_stmt|;
operator|*
name|ppir
operator|=
operator|(
expr|struct
name|info_restrict
operator|*
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * list_restrict - return the restrict list  */
end_comment

begin_function
specifier|static
name|void
name|list_restrict
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|struct
name|info_restrict
modifier|*
name|ir
decl_stmt|;
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"wants restrict list summary\n"
operator|)
argument_list|)
expr_stmt|;
name|ir
operator|=
operator|(
expr|struct
name|info_restrict
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|v6sizeof
argument_list|(
expr|struct
name|info_restrict
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * The restriction lists are kept sorted in the reverse order 	 * than they were originally.  To preserve the output semantics, 	 * dump each list in reverse order.  A recursive helper function 	 * achieves that. 	 */
name|list_restrict4
argument_list|(
name|restrictlist4
argument_list|,
operator|&
name|ir
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
condition|)
name|list_restrict6
argument_list|(
name|restrictlist6
argument_list|,
operator|&
name|ir
argument_list|)
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_resaddflags - add flags to a restrict entry (or create one)  */
end_comment

begin_function
specifier|static
name|void
name|do_resaddflags
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|do_restrict
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|RESTRICT_FLAGS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_ressubflags - remove flags from a restrict entry  */
end_comment

begin_function
specifier|static
name|void
name|do_ressubflags
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|do_restrict
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|RESTRICT_UNFLAG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_unrestrict - remove a restrict entry from the list  */
end_comment

begin_function
specifier|static
name|void
name|do_unrestrict
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|do_restrict
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|RESTRICT_REMOVE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_restrict - do the dirty stuff of dealing with restrictions  */
end_comment

begin_function
specifier|static
name|void
name|do_restrict
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|,
name|int
name|op
parameter_list|)
block|{
name|char
modifier|*
name|datap
decl_stmt|;
name|struct
name|conf_restrict
name|cr
decl_stmt|;
name|u_short
name|items
decl_stmt|;
name|size_t
name|item_sz
decl_stmt|;
name|sockaddr_u
name|matchaddr
decl_stmt|;
name|sockaddr_u
name|matchmask
decl_stmt|;
name|int
name|bad
decl_stmt|;
comment|/* 	 * Do a check of the flags to make sure that only 	 * the NTPPORT flag is set, if any.  If not, complain 	 * about it.  Note we are very picky here. 	 */
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|item_sz
operator|=
name|INFO_ITEMSIZE
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
expr_stmt|;
name|datap
operator|=
name|inpkt
operator|->
name|u
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|item_sz
operator|>
sizeof|sizeof
argument_list|(
name|cr
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|bad
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
operator|&&
operator|!
name|bad
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|cr
argument_list|,
name|datap
argument_list|,
name|item_sz
argument_list|)
expr_stmt|;
name|cr
operator|.
name|flags
operator|=
name|ntohs
argument_list|(
name|cr
operator|.
name|flags
argument_list|)
expr_stmt|;
name|cr
operator|.
name|mflags
operator|=
name|ntohs
argument_list|(
name|cr
operator|.
name|mflags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|~
name|RESM_NTPONLY
operator|&
name|cr
operator|.
name|mflags
condition|)
name|bad
operator||=
literal|1
expr_stmt|;
if|if
condition|(
operator|~
name|RES_ALLFLAGS
operator|&
name|cr
operator|.
name|flags
condition|)
name|bad
operator||=
literal|2
expr_stmt|;
if|if
condition|(
name|INADDR_ANY
operator|!=
name|cr
operator|.
name|mask
condition|)
block|{
if|if
condition|(
name|client_v6_capable
operator|&&
name|cr
operator|.
name|v6_flag
condition|)
block|{
if|if
condition|(
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
name|cr
operator|.
name|addr6
argument_list|)
condition|)
name|bad
operator||=
literal|4
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|INADDR_ANY
operator|==
name|cr
operator|.
name|addr
condition|)
name|bad
operator||=
literal|8
expr_stmt|;
block|}
block|}
name|datap
operator|+=
name|item_sz
expr_stmt|;
block|}
if|if
condition|(
name|bad
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"do_restrict: bad = %#x"
argument_list|,
name|bad
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Looks okay, try it out.  Needs to reload data pointer and 	 * item counter. (Talos-CAN-0052) 	 */
name|ZERO_SOCK
argument_list|(
operator|&
name|matchaddr
argument_list|)
expr_stmt|;
name|ZERO_SOCK
argument_list|(
operator|&
name|matchmask
argument_list|)
expr_stmt|;
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|datap
operator|=
name|inpkt
operator|->
name|u
operator|.
name|data
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|cr
argument_list|,
name|datap
argument_list|,
name|item_sz
argument_list|)
expr_stmt|;
name|cr
operator|.
name|flags
operator|=
name|ntohs
argument_list|(
name|cr
operator|.
name|flags
argument_list|)
expr_stmt|;
name|cr
operator|.
name|mflags
operator|=
name|ntohs
argument_list|(
name|cr
operator|.
name|mflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
operator|&&
name|cr
operator|.
name|v6_flag
condition|)
block|{
name|AF
argument_list|(
operator|&
name|matchaddr
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|AF
argument_list|(
operator|&
name|matchmask
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SOCK_ADDR6
argument_list|(
operator|&
name|matchaddr
argument_list|)
operator|=
name|cr
operator|.
name|addr6
expr_stmt|;
name|SOCK_ADDR6
argument_list|(
operator|&
name|matchmask
argument_list|)
operator|=
name|cr
operator|.
name|mask6
expr_stmt|;
block|}
else|else
block|{
name|AF
argument_list|(
operator|&
name|matchaddr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|AF
argument_list|(
operator|&
name|matchmask
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|matchaddr
argument_list|)
operator|=
name|cr
operator|.
name|addr
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|matchmask
argument_list|)
operator|=
name|cr
operator|.
name|mask
expr_stmt|;
block|}
name|hack_restrict
argument_list|(
name|op
argument_list|,
operator|&
name|matchaddr
argument_list|,
operator|&
name|matchmask
argument_list|,
name|cr
operator|.
name|mflags
argument_list|,
name|cr
operator|.
name|flags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|datap
operator|+=
name|item_sz
expr_stmt|;
block|}
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * mon_getlist - return monitor data  */
end_comment

begin_function
specifier|static
name|void
name|mon_getlist
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Module entry points and the flags they correspond with  */
end_comment

begin_struct
struct|struct
name|reset_entry
block|{
name|int
name|flag
decl_stmt|;
comment|/* flag this corresponds to */
name|void
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|void
parameter_list|)
function_decl|;
comment|/* routine to handle request */
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|reset_entry
name|reset_entries
index|[]
init|=
block|{
block|{
name|RESET_FLAG_ALLPEERS
block|,
name|peer_all_reset
block|}
block|,
block|{
name|RESET_FLAG_IO
block|,
name|io_clr_stats
block|}
block|,
block|{
name|RESET_FLAG_SYS
block|,
name|proto_clr_stats
block|}
block|,
block|{
name|RESET_FLAG_MEM
block|,
name|peer_clr_stats
block|}
block|,
block|{
name|RESET_FLAG_TIMER
block|,
name|timer_clr_stats
block|}
block|,
block|{
name|RESET_FLAG_AUTH
block|,
name|reset_auth_stats
block|}
block|,
block|{
name|RESET_FLAG_CTL
block|,
name|ctl_clr_stats
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * reset_stats - reset statistic counters here and there  */
end_comment

begin_function
specifier|static
name|void
name|reset_stats
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|struct
name|reset_flags
modifier|*
name|rflags
decl_stmt|;
name|u_long
name|flags
decl_stmt|;
name|struct
name|reset_entry
modifier|*
name|rent
decl_stmt|;
if|if
condition|(
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
operator|>
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"reset_stats: err_nitems> 1"
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|rflags
operator|=
operator|(
expr|struct
name|reset_flags
operator|*
operator|)
operator|&
name|inpkt
operator|->
name|u
expr_stmt|;
name|flags
operator|=
name|ntohl
argument_list|(
name|rflags
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
operator|~
name|RESET_ALLFLAGS
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"reset_stats: reset leaves %#lx"
argument_list|,
name|flags
operator|&
operator|~
name|RESET_ALLFLAGS
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|rent
operator|=
name|reset_entries
init|;
name|rent
operator|->
name|flag
operator|!=
literal|0
condition|;
name|rent
operator|++
control|)
block|{
if|if
condition|(
name|flags
operator|&
name|rent
operator|->
name|flag
condition|)
call|(
modifier|*
name|rent
operator|->
name|handler
call|)
argument_list|()
expr_stmt|;
block|}
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * reset_peer - clear a peer's statistics  */
end_comment

begin_function
specifier|static
name|void
name|reset_peer
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|u_short
name|items
decl_stmt|;
name|size_t
name|item_sz
decl_stmt|;
name|char
modifier|*
name|datap
decl_stmt|;
name|struct
name|conf_unpeer
name|cp
decl_stmt|;
name|struct
name|peer
modifier|*
name|p
decl_stmt|;
name|sockaddr_u
name|peeraddr
decl_stmt|;
name|int
name|bad
decl_stmt|;
comment|/* 	 * We check first to see that every peer exists.  If not, 	 * we return an error. 	 */
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|item_sz
operator|=
name|INFO_ITEMSIZE
argument_list|(
name|inpkt
operator|->
name|mbz_itemsize
argument_list|)
expr_stmt|;
name|datap
operator|=
name|inpkt
operator|->
name|u
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|item_sz
operator|>
sizeof|sizeof
argument_list|(
name|cp
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|bad
operator|=
name|FALSE
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
operator|&&
operator|!
name|bad
condition|)
block|{
name|ZERO
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cp
argument_list|,
name|datap
argument_list|,
name|item_sz
argument_list|)
expr_stmt|;
name|ZERO_SOCK
argument_list|(
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
operator|&&
name|cp
operator|.
name|v6_flag
condition|)
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SOCK_ADDR6
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|cp
operator|.
name|peeraddr6
expr_stmt|;
block|}
else|else
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|cp
operator|.
name|peeraddr
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|peeraddr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|p
operator|=
name|findexistingpeer
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|p
condition|)
name|bad
operator|++
expr_stmt|;
name|datap
operator|+=
name|item_sz
expr_stmt|;
block|}
if|if
condition|(
name|bad
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Now do it in earnest. Needs to reload data pointer and item 	 * counter. (Talos-CAN-0052) 	 */
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|datap
operator|=
name|inpkt
operator|->
name|u
operator|.
name|data
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
name|ZERO
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cp
argument_list|,
name|datap
argument_list|,
name|item_sz
argument_list|)
expr_stmt|;
name|ZERO_SOCK
argument_list|(
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
operator|&&
name|cp
operator|.
name|v6_flag
condition|)
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET6
expr_stmt|;
name|SOCK_ADDR6
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|cp
operator|.
name|peeraddr6
expr_stmt|;
block|}
else|else
block|{
name|AF
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|peeraddr
argument_list|)
operator|=
name|cp
operator|.
name|peeraddr
expr_stmt|;
block|}
name|SET_PORT
argument_list|(
operator|&
name|peeraddr
argument_list|,
literal|123
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|peeraddr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|peeraddr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|p
operator|=
name|findexistingpeer
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|peer_reset
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|findexistingpeer
argument_list|(
operator|&
name|peeraddr
argument_list|,
name|NULL
argument_list|,
name|p
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|datap
operator|+=
name|item_sz
expr_stmt|;
block|}
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_key_reread - reread the encryption key file  */
end_comment

begin_function
specifier|static
name|void
name|do_key_reread
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|rereadkeys
argument_list|()
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * trust_key - make one or more keys trusted  */
end_comment

begin_function
specifier|static
name|void
name|trust_key
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|do_trustkey
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * untrust_key - make one or more keys untrusted  */
end_comment

begin_function
specifier|static
name|void
name|untrust_key
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|do_trustkey
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_trustkey - make keys either trustable or untrustable  */
end_comment

begin_function
specifier|static
name|void
name|do_trustkey
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|,
name|u_long
name|trust
parameter_list|)
block|{
specifier|register
name|u_long
modifier|*
name|kp
decl_stmt|;
specifier|register
name|int
name|items
decl_stmt|;
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|kp
operator|=
operator|(
name|u_long
operator|*
operator|)
operator|&
name|inpkt
operator|->
name|u
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
name|authtrust
argument_list|(
operator|*
name|kp
argument_list|,
name|trust
argument_list|)
expr_stmt|;
name|kp
operator|++
expr_stmt|;
block|}
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * get_auth_info - return some stats concerning the authentication module  */
end_comment

begin_function
specifier|static
name|void
name|get_auth_info
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|struct
name|info_auth
modifier|*
name|ia
decl_stmt|;
name|ia
operator|=
operator|(
expr|struct
name|info_auth
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_auth
argument_list|)
argument_list|)
expr_stmt|;
name|ia
operator|->
name|numkeys
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|authnumkeys
argument_list|)
expr_stmt|;
name|ia
operator|->
name|numfreekeys
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|authnumfreekeys
argument_list|)
expr_stmt|;
name|ia
operator|->
name|keylookups
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|authkeylookups
argument_list|)
expr_stmt|;
name|ia
operator|->
name|keynotfound
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|authkeynotfound
argument_list|)
expr_stmt|;
name|ia
operator|->
name|encryptions
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|authencryptions
argument_list|)
expr_stmt|;
name|ia
operator|->
name|decryptions
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|authdecryptions
argument_list|)
expr_stmt|;
name|ia
operator|->
name|keyuncached
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|authkeyuncached
argument_list|)
expr_stmt|;
name|ia
operator|->
name|expired
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|authkeyexpired
argument_list|)
expr_stmt|;
name|ia
operator|->
name|timereset
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|auth_timereset
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * reset_auth_stats - reset the authentication stat counters.  Done here  *		      to keep ntp-isms out of the authentication module  */
end_comment

begin_function
name|void
name|reset_auth_stats
parameter_list|(
name|void
parameter_list|)
block|{
name|authkeylookups
operator|=
literal|0
expr_stmt|;
name|authkeynotfound
operator|=
literal|0
expr_stmt|;
name|authencryptions
operator|=
literal|0
expr_stmt|;
name|authdecryptions
operator|=
literal|0
expr_stmt|;
name|authkeyuncached
operator|=
literal|0
expr_stmt|;
name|auth_timereset
operator|=
name|current_time
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * req_get_traps - return information about current trap holders  */
end_comment

begin_function
specifier|static
name|void
name|req_get_traps
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|struct
name|info_trap
modifier|*
name|it
decl_stmt|;
name|struct
name|ctl_trap
modifier|*
name|tr
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|num_ctl_traps
operator|==
literal|0
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
name|it
operator|=
operator|(
expr|struct
name|info_trap
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|v6sizeof
argument_list|(
expr|struct
name|info_trap
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|tr
operator|=
name|ctl_traps
init|;
name|i
operator|<
name|COUNTOF
argument_list|(
name|ctl_traps
argument_list|)
condition|;
name|i
operator|++
operator|,
name|tr
operator|++
control|)
block|{
if|if
condition|(
name|tr
operator|->
name|tr_flags
operator|&
name|TRAP_INUSE
condition|)
block|{
if|if
condition|(
name|IS_IPV4
argument_list|(
operator|&
name|tr
operator|->
name|tr_addr
argument_list|)
condition|)
block|{
if|if
condition|(
name|tr
operator|->
name|tr_localaddr
operator|==
name|any_interface
condition|)
name|it
operator|->
name|local_address
operator|=
literal|0
expr_stmt|;
else|else
name|it
operator|->
name|local_address
operator|=
name|NSRCADR
argument_list|(
operator|&
name|tr
operator|->
name|tr_localaddr
operator|->
name|sin
argument_list|)
expr_stmt|;
name|it
operator|->
name|trap_address
operator|=
name|NSRCADR
argument_list|(
operator|&
name|tr
operator|->
name|tr_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_v6_capable
condition|)
name|it
operator|->
name|v6_flag
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|client_v6_capable
condition|)
continue|continue;
name|it
operator|->
name|local_address6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|tr
operator|->
name|tr_localaddr
operator|->
name|sin
argument_list|)
expr_stmt|;
name|it
operator|->
name|trap_address6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|tr
operator|->
name|tr_addr
argument_list|)
expr_stmt|;
name|it
operator|->
name|v6_flag
operator|=
literal|1
expr_stmt|;
block|}
name|it
operator|->
name|trap_port
operator|=
name|NSRCPORT
argument_list|(
operator|&
name|tr
operator|->
name|tr_addr
argument_list|)
expr_stmt|;
name|it
operator|->
name|sequence
operator|=
name|htons
argument_list|(
name|tr
operator|->
name|tr_sequence
argument_list|)
expr_stmt|;
name|it
operator|->
name|settime
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|tr
operator|->
name|tr_settime
argument_list|)
argument_list|)
expr_stmt|;
name|it
operator|->
name|origtime
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|tr
operator|->
name|tr_origtime
argument_list|)
argument_list|)
expr_stmt|;
name|it
operator|->
name|resets
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|tr
operator|->
name|tr_resets
argument_list|)
expr_stmt|;
name|it
operator|->
name|flags
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|tr
operator|->
name|tr_flags
argument_list|)
expr_stmt|;
name|it
operator|=
operator|(
expr|struct
name|info_trap
operator|*
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
block|}
block|}
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * req_set_trap - configure a trap  */
end_comment

begin_function
specifier|static
name|void
name|req_set_trap
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|do_setclr_trap
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * req_clr_trap - unconfigure a trap  */
end_comment

begin_function
specifier|static
name|void
name|req_clr_trap
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|do_setclr_trap
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * do_setclr_trap - do the grunge work of (un)configuring a trap  */
end_comment

begin_function
specifier|static
name|void
name|do_setclr_trap
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|,
name|int
name|set
parameter_list|)
block|{
specifier|register
name|struct
name|conf_trap
modifier|*
name|ct
decl_stmt|;
specifier|register
name|endpt
modifier|*
name|linter
decl_stmt|;
name|int
name|res
decl_stmt|;
name|sockaddr_u
name|laddr
decl_stmt|;
comment|/* 	 * Prepare sockaddr 	 */
name|ZERO_SOCK
argument_list|(
operator|&
name|laddr
argument_list|)
expr_stmt|;
name|AF
argument_list|(
operator|&
name|laddr
argument_list|)
operator|=
name|AF
argument_list|(
name|srcadr
argument_list|)
expr_stmt|;
name|SET_PORT
argument_list|(
operator|&
name|laddr
argument_list|,
name|NTP_PORT
argument_list|)
expr_stmt|;
comment|/* 	 * Restrict ourselves to one item only.  This eliminates 	 * the error reporting problem. 	 */
if|if
condition|(
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
operator|>
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"do_setclr_trap: err_nitems> 1"
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|ct
operator|=
operator|(
expr|struct
name|conf_trap
operator|*
operator|)
operator|&
name|inpkt
operator|->
name|u
expr_stmt|;
comment|/* 	 * Look for the local interface.  If none, use the default. 	 */
if|if
condition|(
name|ct
operator|->
name|local_address
operator|==
literal|0
condition|)
block|{
name|linter
operator|=
name|any_interface
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|IS_IPV4
argument_list|(
operator|&
name|laddr
argument_list|)
condition|)
name|NSRCADR
argument_list|(
operator|&
name|laddr
argument_list|)
operator|=
name|ct
operator|->
name|local_address
expr_stmt|;
else|else
name|SOCK_ADDR6
argument_list|(
operator|&
name|laddr
argument_list|)
operator|=
name|ct
operator|->
name|local_address6
expr_stmt|;
name|linter
operator|=
name|findinterface
argument_list|(
operator|&
name|laddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|linter
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|IS_IPV4
argument_list|(
operator|&
name|laddr
argument_list|)
condition|)
name|NSRCADR
argument_list|(
operator|&
name|laddr
argument_list|)
operator|=
name|ct
operator|->
name|trap_address
expr_stmt|;
else|else
name|SOCK_ADDR6
argument_list|(
operator|&
name|laddr
argument_list|)
operator|=
name|ct
operator|->
name|trap_address6
expr_stmt|;
if|if
condition|(
name|ct
operator|->
name|trap_port
condition|)
name|NSRCPORT
argument_list|(
operator|&
name|laddr
argument_list|)
operator|=
name|ct
operator|->
name|trap_port
expr_stmt|;
else|else
name|SET_PORT
argument_list|(
operator|&
name|laddr
argument_list|,
name|TRAPPORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|set
condition|)
block|{
name|res
operator|=
name|ctlsettrap
argument_list|(
operator|&
name|laddr
argument_list|,
name|linter
argument_list|,
literal|0
argument_list|,
name|INFO_VERSION
argument_list|(
name|inpkt
operator|->
name|rm_vn_mode
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|ctlclrtrap
argument_list|(
operator|&
name|laddr
argument_list|,
name|linter
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * set_request_keyid - set the keyid used to authenticate requests  */
end_comment

begin_function
specifier|static
name|void
name|set_request_keyid
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|keyid_t
modifier|*
name|pkeyid
decl_stmt|;
comment|/* 	 * Restrict ourselves to one item only. 	 */
if|if
condition|(
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
operator|>
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set_request_keyid: err_nitems> 1"
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|pkeyid
operator|=
operator|(
name|keyid_t
operator|*
operator|)
operator|&
name|inpkt
operator|->
name|u
expr_stmt|;
name|info_auth_keyid
operator|=
name|ntohl
argument_list|(
operator|*
name|pkeyid
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * set_control_keyid - set the keyid used to authenticate requests  */
end_comment

begin_function
specifier|static
name|void
name|set_control_keyid
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|keyid_t
modifier|*
name|pkeyid
decl_stmt|;
comment|/* 	 * Restrict ourselves to one item only. 	 */
if|if
condition|(
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
operator|>
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set_control_keyid: err_nitems> 1"
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|pkeyid
operator|=
operator|(
name|keyid_t
operator|*
operator|)
operator|&
name|inpkt
operator|->
name|u
expr_stmt|;
name|ctl_auth_keyid
operator|=
name|ntohl
argument_list|(
operator|*
name|pkeyid
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * get_ctl_stats - return some stats concerning the control message module  */
end_comment

begin_function
specifier|static
name|void
name|get_ctl_stats
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|struct
name|info_control
modifier|*
name|ic
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|info_control
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_control
argument_list|)
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ctltimereset
operator|=
name|htonl
argument_list|(
call|(
name|u_int32
call|)
argument_list|(
name|current_time
operator|-
name|ctltimereset
argument_list|)
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlreq
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlreq
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlbadpkts
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlbadpkts
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlresponses
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlresponses
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlfrags
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlfrags
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlerrors
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlerrors
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctltooshort
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctltooshort
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlinputresp
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlinputresp
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlinputfrag
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlinputfrag
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlinputerr
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlinputerr
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlbadoffset
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlbadoffset
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlbadversion
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlbadversion
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctldatatooshort
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctldatatooshort
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numctlbadop
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numctlbadop
argument_list|)
expr_stmt|;
name|ic
operator|->
name|numasyncmsgs
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|numasyncmsgs
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|KERNEL_PLL
end_ifdef

begin_comment
comment|/*  * get_kernel_info - get kernel pll/pps information  */
end_comment

begin_function
specifier|static
name|void
name|get_kernel_info
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|struct
name|info_kernel
modifier|*
name|ik
decl_stmt|;
name|struct
name|timex
name|ntx
decl_stmt|;
if|if
condition|(
operator|!
name|pll_control
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
name|ZERO
argument_list|(
name|ntx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntp_adjtime
argument_list|(
operator|&
name|ntx
argument_list|)
operator|<
literal|0
condition|)
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"get_kernel_info: ntp_adjtime() failed: %m"
argument_list|)
expr_stmt|;
name|ik
operator|=
operator|(
expr|struct
name|info_kernel
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_kernel
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * pll variables 	 */
name|ik
operator|->
name|offset
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|offset
argument_list|)
expr_stmt|;
name|ik
operator|->
name|freq
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|freq
argument_list|)
expr_stmt|;
name|ik
operator|->
name|maxerror
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|maxerror
argument_list|)
expr_stmt|;
name|ik
operator|->
name|esterror
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|esterror
argument_list|)
expr_stmt|;
name|ik
operator|->
name|status
operator|=
name|htons
argument_list|(
name|ntx
operator|.
name|status
argument_list|)
expr_stmt|;
name|ik
operator|->
name|constant
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|constant
argument_list|)
expr_stmt|;
name|ik
operator|->
name|precision
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|precision
argument_list|)
expr_stmt|;
name|ik
operator|->
name|tolerance
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|tolerance
argument_list|)
expr_stmt|;
comment|/* 	 * pps variables 	 */
name|ik
operator|->
name|ppsfreq
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|ppsfreq
argument_list|)
expr_stmt|;
name|ik
operator|->
name|jitter
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|jitter
argument_list|)
expr_stmt|;
name|ik
operator|->
name|shift
operator|=
name|htons
argument_list|(
name|ntx
operator|.
name|shift
argument_list|)
expr_stmt|;
name|ik
operator|->
name|stabil
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|stabil
argument_list|)
expr_stmt|;
name|ik
operator|->
name|jitcnt
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|jitcnt
argument_list|)
expr_stmt|;
name|ik
operator|->
name|calcnt
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|calcnt
argument_list|)
expr_stmt|;
name|ik
operator|->
name|errcnt
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|errcnt
argument_list|)
expr_stmt|;
name|ik
operator|->
name|stbcnt
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|ntx
operator|.
name|stbcnt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* KERNEL_PLL */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|REFCLOCK
end_ifdef

begin_comment
comment|/*  * get_clock_info - get info about a clock  */
end_comment

begin_function
specifier|static
name|void
name|get_clock_info
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|struct
name|info_clock
modifier|*
name|ic
decl_stmt|;
specifier|register
name|u_int32
modifier|*
name|clkaddr
decl_stmt|;
specifier|register
name|int
name|items
decl_stmt|;
name|struct
name|refclockstat
name|clock_stat
decl_stmt|;
name|sockaddr_u
name|addr
decl_stmt|;
name|l_fp
name|ltmp
decl_stmt|;
name|ZERO_SOCK
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
name|AF
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|addr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SET_PORT
argument_list|(
operator|&
name|addr
argument_list|,
name|NTP_PORT
argument_list|)
expr_stmt|;
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|clkaddr
operator|=
operator|&
name|inpkt
operator|->
name|u
operator|.
name|u32
index|[
literal|0
index|]
expr_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|info_clock
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_clock
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
name|NSRCADR
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
operator|*
name|clkaddr
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|ISREFCLOCKADR
argument_list|(
operator|&
name|addr
argument_list|)
operator|||
name|NULL
operator|==
name|findexistingpeer
argument_list|(
operator|&
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
name|clock_stat
operator|.
name|kv_list
operator|=
operator|(
expr|struct
name|ctl_var
operator|*
operator|)
literal|0
expr_stmt|;
name|refclock_control
argument_list|(
operator|&
name|addr
argument_list|,
name|NULL
argument_list|,
operator|&
name|clock_stat
argument_list|)
expr_stmt|;
name|ic
operator|->
name|clockadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
name|ic
operator|->
name|type
operator|=
name|clock_stat
operator|.
name|type
expr_stmt|;
name|ic
operator|->
name|flags
operator|=
name|clock_stat
operator|.
name|flags
expr_stmt|;
name|ic
operator|->
name|lastevent
operator|=
name|clock_stat
operator|.
name|lastevent
expr_stmt|;
name|ic
operator|->
name|currentstatus
operator|=
name|clock_stat
operator|.
name|currentstatus
expr_stmt|;
name|ic
operator|->
name|polls
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|clock_stat
operator|.
name|polls
argument_list|)
expr_stmt|;
name|ic
operator|->
name|noresponse
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|clock_stat
operator|.
name|noresponse
argument_list|)
expr_stmt|;
name|ic
operator|->
name|badformat
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|clock_stat
operator|.
name|badformat
argument_list|)
expr_stmt|;
name|ic
operator|->
name|baddata
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|clock_stat
operator|.
name|baddata
argument_list|)
expr_stmt|;
name|ic
operator|->
name|timestarted
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|clock_stat
operator|.
name|timereset
argument_list|)
expr_stmt|;
name|DTOLFP
argument_list|(
name|clock_stat
operator|.
name|fudgetime1
argument_list|,
operator|&
name|ltmp
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|ltmp
argument_list|,
operator|&
name|ic
operator|->
name|fudgetime1
argument_list|)
expr_stmt|;
name|DTOLFP
argument_list|(
name|clock_stat
operator|.
name|fudgetime2
argument_list|,
operator|&
name|ltmp
argument_list|)
expr_stmt|;
name|HTONL_FP
argument_list|(
operator|&
name|ltmp
argument_list|,
operator|&
name|ic
operator|->
name|fudgetime2
argument_list|)
expr_stmt|;
name|ic
operator|->
name|fudgeval1
operator|=
name|htonl
argument_list|(
operator|(
name|u_int32
operator|)
name|clock_stat
operator|.
name|fudgeval1
argument_list|)
expr_stmt|;
name|ic
operator|->
name|fudgeval2
operator|=
name|htonl
argument_list|(
name|clock_stat
operator|.
name|fudgeval2
argument_list|)
expr_stmt|;
name|free_varlist
argument_list|(
name|clock_stat
operator|.
name|kv_list
argument_list|)
expr_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|info_clock
operator|*
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
block|}
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * set_clock_fudge - get a clock's fudge factors  */
end_comment

begin_function
specifier|static
name|void
name|set_clock_fudge
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|struct
name|conf_fudge
modifier|*
name|cf
decl_stmt|;
specifier|register
name|int
name|items
decl_stmt|;
name|struct
name|refclockstat
name|clock_stat
decl_stmt|;
name|sockaddr_u
name|addr
decl_stmt|;
name|l_fp
name|ltmp
decl_stmt|;
name|ZERO
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|ZERO
argument_list|(
name|clock_stat
argument_list|)
expr_stmt|;
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|cf
operator|=
operator|(
expr|struct
name|conf_fudge
operator|*
operator|)
operator|&
name|inpkt
operator|->
name|u
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
name|AF
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
name|NSRCADR
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|cf
operator|->
name|clockadr
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|addr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SET_PORT
argument_list|(
operator|&
name|addr
argument_list|,
name|NTP_PORT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ISREFCLOCKADR
argument_list|(
operator|&
name|addr
argument_list|)
operator|||
name|NULL
operator|==
name|findexistingpeer
argument_list|(
operator|&
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|ntohl
argument_list|(
name|cf
operator|->
name|which
argument_list|)
condition|)
block|{
case|case
name|FUDGE_TIME1
case|:
name|NTOHL_FP
argument_list|(
operator|&
name|cf
operator|->
name|fudgetime
argument_list|,
operator|&
name|ltmp
argument_list|)
expr_stmt|;
name|LFPTOD
argument_list|(
operator|&
name|ltmp
argument_list|,
name|clock_stat
operator|.
name|fudgetime1
argument_list|)
expr_stmt|;
name|clock_stat
operator|.
name|haveflags
operator|=
name|CLK_HAVETIME1
expr_stmt|;
break|break;
case|case
name|FUDGE_TIME2
case|:
name|NTOHL_FP
argument_list|(
operator|&
name|cf
operator|->
name|fudgetime
argument_list|,
operator|&
name|ltmp
argument_list|)
expr_stmt|;
name|LFPTOD
argument_list|(
operator|&
name|ltmp
argument_list|,
name|clock_stat
operator|.
name|fudgetime2
argument_list|)
expr_stmt|;
name|clock_stat
operator|.
name|haveflags
operator|=
name|CLK_HAVETIME2
expr_stmt|;
break|break;
case|case
name|FUDGE_VAL1
case|:
name|clock_stat
operator|.
name|fudgeval1
operator|=
name|ntohl
argument_list|(
name|cf
operator|->
name|fudgeval_flags
argument_list|)
expr_stmt|;
name|clock_stat
operator|.
name|haveflags
operator|=
name|CLK_HAVEVAL1
expr_stmt|;
break|break;
case|case
name|FUDGE_VAL2
case|:
name|clock_stat
operator|.
name|fudgeval2
operator|=
name|ntohl
argument_list|(
name|cf
operator|->
name|fudgeval_flags
argument_list|)
expr_stmt|;
name|clock_stat
operator|.
name|haveflags
operator|=
name|CLK_HAVEVAL2
expr_stmt|;
break|break;
case|case
name|FUDGE_FLAGS
case|:
name|clock_stat
operator|.
name|flags
operator|=
call|(
name|u_char
call|)
argument_list|(
name|ntohl
argument_list|(
name|cf
operator|->
name|fudgeval_flags
argument_list|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|clock_stat
operator|.
name|haveflags
operator|=
operator|(
name|CLK_HAVEFLAG1
operator||
name|CLK_HAVEFLAG2
operator||
name|CLK_HAVEFLAG3
operator||
name|CLK_HAVEFLAG4
operator|)
expr_stmt|;
break|break;
default|default:
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"set_clock_fudge: default!"
argument_list|)
expr_stmt|;
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_FMT
argument_list|)
expr_stmt|;
return|return;
block|}
name|refclock_control
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|clock_stat
argument_list|,
operator|(
expr|struct
name|refclockstat
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|REFCLOCK
end_ifdef

begin_comment
comment|/*  * get_clkbug_info - get debugging info about a clock  */
end_comment

begin_function
specifier|static
name|void
name|get_clkbug_info
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|struct
name|info_clkbug
modifier|*
name|ic
decl_stmt|;
specifier|register
name|u_int32
modifier|*
name|clkaddr
decl_stmt|;
specifier|register
name|int
name|items
decl_stmt|;
name|struct
name|refclockbug
name|bug
decl_stmt|;
name|sockaddr_u
name|addr
decl_stmt|;
name|ZERO_SOCK
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
name|AF
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
name|AF_INET
expr_stmt|;
ifdef|#
directive|ifdef
name|ISC_PLATFORM_HAVESALEN
name|addr
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|SOCKLEN
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SET_PORT
argument_list|(
operator|&
name|addr
argument_list|,
name|NTP_PORT
argument_list|)
expr_stmt|;
name|items
operator|=
name|INFO_NITEMS
argument_list|(
name|inpkt
operator|->
name|err_nitems
argument_list|)
expr_stmt|;
name|clkaddr
operator|=
operator|(
name|u_int32
operator|*
operator|)
operator|&
name|inpkt
operator|->
name|u
expr_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|info_clkbug
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|info_clkbug
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|items
operator|--
operator|>
literal|0
condition|)
block|{
name|NSRCADR
argument_list|(
operator|&
name|addr
argument_list|)
operator|=
operator|*
name|clkaddr
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|ISREFCLOCKADR
argument_list|(
operator|&
name|addr
argument_list|)
operator|||
name|NULL
operator|==
name|findexistingpeer
argument_list|(
operator|&
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
name|ZERO
argument_list|(
name|bug
argument_list|)
expr_stmt|;
name|refclock_buginfo
argument_list|(
operator|&
name|addr
argument_list|,
operator|&
name|bug
argument_list|)
expr_stmt|;
if|if
condition|(
name|bug
operator|.
name|nvalues
operator|==
literal|0
operator|&&
name|bug
operator|.
name|ntimes
operator|==
literal|0
condition|)
block|{
name|req_ack
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|INFO_ERR_NODATA
argument_list|)
expr_stmt|;
return|return;
block|}
name|ic
operator|->
name|clockadr
operator|=
name|NSRCADR
argument_list|(
operator|&
name|addr
argument_list|)
expr_stmt|;
name|i
operator|=
name|bug
operator|.
name|nvalues
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|NUMCBUGVALUES
condition|)
name|i
operator|=
name|NUMCBUGVALUES
expr_stmt|;
name|ic
operator|->
name|nvalues
operator|=
operator|(
name|u_char
operator|)
name|i
expr_stmt|;
name|ic
operator|->
name|svalues
operator|=
name|htons
argument_list|(
call|(
name|u_short
call|)
argument_list|(
name|bug
operator|.
name|svalues
operator|&
operator|(
operator|(
literal|1
operator|<<
name|i
operator|)
operator|-
literal|1
operator|)
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|ic
operator|->
name|values
index|[
name|i
index|]
operator|=
name|htonl
argument_list|(
name|bug
operator|.
name|values
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|=
name|bug
operator|.
name|ntimes
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|NUMCBUGTIMES
condition|)
name|i
operator|=
name|NUMCBUGTIMES
expr_stmt|;
name|ic
operator|->
name|ntimes
operator|=
operator|(
name|u_char
operator|)
name|i
expr_stmt|;
name|ic
operator|->
name|stimes
operator|=
name|htonl
argument_list|(
name|bug
operator|.
name|stimes
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
block|{
name|HTONL_FP
argument_list|(
operator|&
name|bug
operator|.
name|times
index|[
name|i
index|]
argument_list|,
operator|&
name|ic
operator|->
name|times
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ic
operator|=
operator|(
expr|struct
name|info_clkbug
operator|*
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
block|}
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * receiver of interface structures  */
end_comment

begin_function
specifier|static
name|void
name|fill_info_if_stats
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|interface_info_t
modifier|*
name|interface_info
parameter_list|)
block|{
name|struct
name|info_if_stats
modifier|*
modifier|*
name|ifsp
init|=
operator|(
expr|struct
name|info_if_stats
operator|*
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|info_if_stats
modifier|*
name|ifs
init|=
operator|*
name|ifsp
decl_stmt|;
name|endpt
modifier|*
name|ep
init|=
name|interface_info
operator|->
name|ep
decl_stmt|;
name|ZERO
argument_list|(
operator|*
name|ifs
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_IPV6
argument_list|(
operator|&
name|ep
operator|->
name|sin
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|client_v6_capable
condition|)
block|{
return|return;
block|}
name|ifs
operator|->
name|v6_flag
operator|=
literal|1
expr_stmt|;
name|ifs
operator|->
name|unaddr
operator|.
name|addr6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|ep
operator|->
name|sin
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|unbcast
operator|.
name|addr6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|ep
operator|->
name|bcast
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|unmask
operator|.
name|addr6
operator|=
name|SOCK_ADDR6
argument_list|(
operator|&
name|ep
operator|->
name|mask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ifs
operator|->
name|v6_flag
operator|=
literal|0
expr_stmt|;
name|ifs
operator|->
name|unaddr
operator|.
name|addr
operator|=
name|SOCK_ADDR4
argument_list|(
operator|&
name|ep
operator|->
name|sin
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|unbcast
operator|.
name|addr
operator|=
name|SOCK_ADDR4
argument_list|(
operator|&
name|ep
operator|->
name|bcast
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|unmask
operator|.
name|addr
operator|=
name|SOCK_ADDR4
argument_list|(
operator|&
name|ep
operator|->
name|mask
argument_list|)
expr_stmt|;
block|}
name|ifs
operator|->
name|v6_flag
operator|=
name|htonl
argument_list|(
name|ifs
operator|->
name|v6_flag
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ifs
operator|->
name|name
argument_list|,
name|ep
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifs
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|family
operator|=
name|htons
argument_list|(
name|ep
operator|->
name|family
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|flags
operator|=
name|htonl
argument_list|(
name|ep
operator|->
name|flags
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|last_ttl
operator|=
name|htonl
argument_list|(
name|ep
operator|->
name|last_ttl
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|num_mcast
operator|=
name|htonl
argument_list|(
name|ep
operator|->
name|num_mcast
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|received
operator|=
name|htonl
argument_list|(
name|ep
operator|->
name|received
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|sent
operator|=
name|htonl
argument_list|(
name|ep
operator|->
name|sent
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|notsent
operator|=
name|htonl
argument_list|(
name|ep
operator|->
name|notsent
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|ifindex
operator|=
name|htonl
argument_list|(
name|ep
operator|->
name|ifindex
argument_list|)
expr_stmt|;
comment|/* scope no longer in endpt, in in6_addr typically */
name|ifs
operator|->
name|scopeid
operator|=
name|ifs
operator|->
name|ifindex
expr_stmt|;
name|ifs
operator|->
name|ifnum
operator|=
name|htonl
argument_list|(
name|ep
operator|->
name|ifnum
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|uptime
operator|=
name|htonl
argument_list|(
name|current_time
operator|-
name|ep
operator|->
name|starttime
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|ignore_packets
operator|=
name|ep
operator|->
name|ignore_packets
expr_stmt|;
name|ifs
operator|->
name|peercnt
operator|=
name|htonl
argument_list|(
name|ep
operator|->
name|peercnt
argument_list|)
expr_stmt|;
name|ifs
operator|->
name|action
operator|=
name|interface_info
operator|->
name|action
expr_stmt|;
operator|*
name|ifsp
operator|=
operator|(
expr|struct
name|info_if_stats
operator|*
operator|)
name|more_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * get_if_stats - get interface statistics  */
end_comment

begin_function
specifier|static
name|void
name|get_if_stats
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|struct
name|info_if_stats
modifier|*
name|ifs
decl_stmt|;
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"wants interface statistics\n"
operator|)
argument_list|)
expr_stmt|;
name|ifs
operator|=
operator|(
expr|struct
name|info_if_stats
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|v6sizeof
argument_list|(
expr|struct
name|info_if_stats
argument_list|)
argument_list|)
expr_stmt|;
name|interface_enumerate
argument_list|(
name|fill_info_if_stats
argument_list|,
operator|&
name|ifs
argument_list|)
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|do_if_reload
parameter_list|(
name|sockaddr_u
modifier|*
name|srcadr
parameter_list|,
name|endpt
modifier|*
name|inter
parameter_list|,
name|struct
name|req_pkt
modifier|*
name|inpkt
parameter_list|)
block|{
name|struct
name|info_if_stats
modifier|*
name|ifs
decl_stmt|;
name|DPRINTF
argument_list|(
literal|3
argument_list|,
operator|(
literal|"wants interface reload\n"
operator|)
argument_list|)
expr_stmt|;
name|ifs
operator|=
operator|(
expr|struct
name|info_if_stats
operator|*
operator|)
name|prepare_pkt
argument_list|(
name|srcadr
argument_list|,
name|inter
argument_list|,
name|inpkt
argument_list|,
name|v6sizeof
argument_list|(
expr|struct
name|info_if_stats
argument_list|)
argument_list|)
expr_stmt|;
name|interface_update
argument_list|(
name|fill_info_if_stats
argument_list|,
operator|&
name|ifs
argument_list|)
expr_stmt|;
name|flush_pkt
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


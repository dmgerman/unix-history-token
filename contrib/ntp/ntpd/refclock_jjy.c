begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * refclock_jjy - clock driver for JJY receivers  */
end_comment

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  Copyright (C) 2001-2015, Takao Abe.  All rights reserved.	      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  Permission to use, copy, modify, and distribute this software     */
end_comment

begin_comment
comment|/*  and its documentation for any purpose is hereby granted	      */
end_comment

begin_comment
comment|/*  without fee, provided that the following conditions are met:      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  One retains the entire copyright notice properly, and both the    */
end_comment

begin_comment
comment|/*  copyright notice and this license. in the documentation and/or    */
end_comment

begin_comment
comment|/*  other materials provided with the distribution.		      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  This software and the name of the author must not be used to      */
end_comment

begin_comment
comment|/*  endorse or promote products derived from this software without    */
end_comment

begin_comment
comment|/*  prior written permission.					      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  THIS SOFTWARE IS PROVIDED "AS IS" WITHOUT EXPRESSED OR IMPLIED    */
end_comment

begin_comment
comment|/*  WARRANTIES OF ANY KIND, INCLUDING, BUT NOT LIMITED TO, THE	      */
end_comment

begin_comment
comment|/*  IMPLIED WARRANTIES OF MERCHANTABLILITY AND FITNESS FOR A	      */
end_comment

begin_comment
comment|/*  PARTICULAR PURPOSE.						      */
end_comment

begin_comment
comment|/*  IN NO EVENT SHALL THE AUTHOR TAKAO ABE BE LIABLE FOR ANY DIRECT,  */
end_comment

begin_comment
comment|/*  INDIRECT, GENERAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES   */
end_comment

begin_comment
comment|/*  ( INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE	      */
end_comment

begin_comment
comment|/*  GOODS OR SERVICES; LOSS OF USE, DATA OR PROFITS; OR BUSINESS      */
end_comment

begin_comment
comment|/*  INTERRUPTION ) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,     */
end_comment

begin_comment
comment|/*  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT ( INCLUDING	      */
end_comment

begin_comment
comment|/*  NEGLIGENCE OR OTHERWISE ) ARISING IN ANY WAY OUT OF THE USE OF    */
end_comment

begin_comment
comment|/*  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  This driver is developed in my private time, and is opened as     */
end_comment

begin_comment
comment|/*  voluntary contributions for the NTP.			      */
end_comment

begin_comment
comment|/*  The manufacturer of the JJY receiver has not participated in      */
end_comment

begin_comment
comment|/*  a development of this driver.				      */
end_comment

begin_comment
comment|/*  The manufacturer does not warrant anything about this driver,     */
end_comment

begin_comment
comment|/*  and is not liable for anything about this driver.		      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  Author     Takao Abe					      */
end_comment

begin_comment
comment|/*  Email      takao_abe@xurb.jp				      */
end_comment

begin_comment
comment|/*  Homepage   http://www.bea.hi-ho.ne.jp/abetakao/		      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  The email address abetakao@bea.hi-ho.ne.jp is never read	      */
end_comment

begin_comment
comment|/*  from 2010, because a few filtering rule are provided by the	      */
end_comment

begin_comment
comment|/*  "hi-ho.ne.jp", and lots of spam mail are reached.		      */
end_comment

begin_comment
comment|/*  New email address for supporting the refclock_jjy is	      */
end_comment

begin_comment
comment|/*  takao_abe@xurb.jp						      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  History							      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2001/07/15							      */
end_comment

begin_comment
comment|/*    [New]    Support the Tristate Ltd. JJY receiver		      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2001/08/04							      */
end_comment

begin_comment
comment|/*    [Change] Log to clockstats even if bad reply		      */
end_comment

begin_comment
comment|/*    [Fix]    PRECISION = (-3) (about 100 ms)			      */
end_comment

begin_comment
comment|/*    [Add]    Support the C-DEX Co.Ltd. JJY receiver		      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2001/12/04							      */
end_comment

begin_comment
comment|/*    [Fix]    C-DEX JST2000 ( fukusima@goto.info.waseda.ac.jp )      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2002/07/12							      */
end_comment

begin_comment
comment|/*    [Fix]    Portability for FreeBSD ( patched by the user )	      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2004/10/31							      */
end_comment

begin_comment
comment|/*    [Change] Command send timing for the Tristate Ltd. JJY receiver */
end_comment

begin_comment
comment|/*	       JJY-01 ( Firmware version 2.01 )			      */
end_comment

begin_comment
comment|/*	       Thanks to Andy Taki for testing under FreeBSD	      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2004/11/28							      */
end_comment

begin_comment
comment|/*    [Add]    Support the Echo Keisokuki LT-2000 receiver	      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2006/11/04							      */
end_comment

begin_comment
comment|/*    [Fix]    C-DEX JST2000					      */
end_comment

begin_comment
comment|/*	       Thanks to Hideo Kuramatsu for the patch		      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2009/04/05							      */
end_comment

begin_comment
comment|/*    [Add]    Support the CITIZEN T.I.C JJY-200 receiver	      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2010/11/20							      */
end_comment

begin_comment
comment|/*    [Change] Bug 1618 ( Harmless )				      */
end_comment

begin_comment
comment|/*	       Code clean up ( Remove unreachable codes ) in	      */
end_comment

begin_comment
comment|/*	       jjy_start()					      */
end_comment

begin_comment
comment|/*    [Change] Change clockstats format of the Tristate JJY01/02      */
end_comment

begin_comment
comment|/*	       Issues more command to get the status of the receiver  */
end_comment

begin_comment
comment|/*	       when "fudge 127.127.40.X flag1 1" is specified	      */
end_comment

begin_comment
comment|/*	       ( DATE,STIM -> DCST,STUS,DATE,STIM )		      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2011/04/30							      */
end_comment

begin_comment
comment|/*    [Add]    Support the Tristate Ltd. TS-GPSclock-01		      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2015/03/29							      */
end_comment

begin_comment
comment|/*    [Add]    Support the Telephone JJY			      */
end_comment

begin_comment
comment|/*    [Change] Split the start up routine into each JJY receivers.    */
end_comment

begin_comment
comment|/*             Change raw data internal bufferring process            */
end_comment

begin_comment
comment|/*             Change over midnight handling of TS-JJY01 and TS-GPS01 */
end_comment

begin_comment
comment|/*             to put DATE command between before and after TIME's.   */
end_comment

begin_comment
comment|/*             Unify the writing clockstats of all JJY receivers.     */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2015/05/15							      */
end_comment

begin_comment
comment|/*    [Add]    Support the SEIKO TIME SYSTEMS TDC-300		      */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/*  2016/05/08							      */
end_comment

begin_comment
comment|/*    [Fix]    C-DEX JST2000                                          */
end_comment

begin_comment
comment|/*             Thanks to Mr. Kuramatsu for the report and the patch.  */
end_comment

begin_comment
comment|/*								      */
end_comment

begin_comment
comment|/**********************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|REFCLOCK
argument_list|)
operator|&&
name|defined
argument_list|(
name|CLOCK_JJY
argument_list|)
end_if

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_include
include|#
directive|include
file|"ntp_io.h"
end_include

begin_include
include|#
directive|include
file|"ntp_tty.h"
end_include

begin_include
include|#
directive|include
file|"ntp_refclock.h"
end_include

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  * Interface definitions  */
end_comment

begin_define
define|#
directive|define
name|DEVICE
value|"/dev/jjy%d"
end_define

begin_comment
comment|/* device name and unit */
end_comment

begin_define
define|#
directive|define
name|SPEED232_TRISTATE_JJY01
value|B9600
end_define

begin_comment
comment|/* UART speed (9600 baud) */
end_comment

begin_define
define|#
directive|define
name|SPEED232_CDEX_JST2000
value|B9600
end_define

begin_comment
comment|/* UART speed (9600 baud) */
end_comment

begin_define
define|#
directive|define
name|SPEED232_ECHOKEISOKUKI_LT2000
value|B9600
end_define

begin_comment
comment|/* UART speed (9600 baud) */
end_comment

begin_define
define|#
directive|define
name|SPEED232_CITIZENTIC_JJY200
value|B4800
end_define

begin_comment
comment|/* UART speed (4800 baud) */
end_comment

begin_define
define|#
directive|define
name|SPEED232_TRISTATE_GPSCLOCK01
value|B38400
end_define

begin_comment
comment|/* USB  speed (38400 baud) */
end_comment

begin_define
define|#
directive|define
name|SPEED232_SEIKO_TIMESYS_TDC_300
value|B2400
end_define

begin_comment
comment|/* UART speed (2400 baud) */
end_comment

begin_define
define|#
directive|define
name|SPEED232_TELEPHONE
value|B2400
end_define

begin_comment
comment|/* UART speed (4800 baud) */
end_comment

begin_define
define|#
directive|define
name|REFID
value|"JJY"
end_define

begin_comment
comment|/* reference ID */
end_comment

begin_define
define|#
directive|define
name|DESCRIPTION
value|"JJY Receiver"
end_define

begin_define
define|#
directive|define
name|PRECISION
value|(-3)
end_define

begin_comment
comment|/* precision assumed (about 100 ms) */
end_comment

begin_comment
comment|/*  * JJY unit control structure  */
end_comment

begin_struct
struct|struct
name|jjyRawDataBreak
block|{
specifier|const
name|char
modifier|*
name|pString
decl_stmt|;
name|int
name|iLength
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|MAX_TIMESTAMP
value|6
end_define

begin_define
define|#
directive|define
name|MAX_RAWBUF
value|100
end_define

begin_define
define|#
directive|define
name|MAX_LOOPBACK
value|5
end_define

begin_struct
struct|struct
name|jjyunit
block|{
comment|/* Set up by the function "jjy_start_xxxxxxxx" */
name|char
name|unittype
decl_stmt|;
comment|/* UNITTYPE_XXXXXXXXXX */
name|short
name|operationmode
decl_stmt|;
comment|/* Echo Keisokuki LT-2000 */
name|int
name|linespeed
decl_stmt|;
comment|/* SPEED232_XXXXXXXXXX */
name|short
name|linediscipline
decl_stmt|;
comment|/* LDISC_CLK or LDISC_RAW */
comment|/* Receiving data */
name|char
name|bInitError
decl_stmt|;
comment|/* Set by jjy_start if any error during initialization */
name|short
name|iProcessState
decl_stmt|;
comment|/* JJY_PROCESS_STATE_XXXXXX */
name|char
name|bReceiveFlag
decl_stmt|;
comment|/* Set and reset by jjy_receive */
name|char
name|bLineError
decl_stmt|;
comment|/* Reset by jjy_poll / Set by jjy_receive_xxxxxxxx*/
name|short
name|iCommandSeq
decl_stmt|;
comment|/* 0:Idle  Non-Zero:Issued */
name|short
name|iReceiveSeq
decl_stmt|;
name|int
name|iLineCount
decl_stmt|;
name|int
name|year
decl_stmt|,
name|month
decl_stmt|,
name|day
decl_stmt|,
name|hour
decl_stmt|,
name|minute
decl_stmt|,
name|second
decl_stmt|,
name|msecond
decl_stmt|;
name|int
name|leapsecond
decl_stmt|;
name|int
name|iTimestampCount
decl_stmt|;
comment|/* TS-JJY01, TS-GPS01, Telephone-JJY */
name|int
name|iTimestamp
index|[
name|MAX_TIMESTAMP
index|]
decl_stmt|;
comment|/* Serial second ( 0 - 86399 ) */
comment|/* LDISC_RAW only */
name|char
name|sRawBuf
index|[
name|MAX_RAWBUF
index|]
decl_stmt|;
name|int
name|iRawBufLen
decl_stmt|;
name|struct
name|jjyRawDataBreak
modifier|*
name|pRawBreak
decl_stmt|;
name|char
name|bWaitBreakString
decl_stmt|;
name|char
name|sLineBuf
index|[
name|MAX_RAWBUF
index|]
decl_stmt|;
name|int
name|iLineBufLen
decl_stmt|;
name|char
name|sTextBuf
index|[
name|MAX_RAWBUF
index|]
decl_stmt|;
name|int
name|iTextBufLen
decl_stmt|;
name|char
name|bSkipCntrlCharOnly
decl_stmt|;
comment|/* Telephone JJY auto measurement of the loopback delay */
name|char
name|bLoopbackMode
decl_stmt|;
name|short
name|iLoopbackCount
decl_stmt|;
name|struct
name|timeval
name|sendTime
index|[
name|MAX_LOOPBACK
index|]
decl_stmt|,
name|delayTime
index|[
name|MAX_LOOPBACK
index|]
decl_stmt|;
name|char
name|bLoopbackTimeout
index|[
name|MAX_LOOPBACK
index|]
decl_stmt|;
name|short
name|iLoopbackValidCount
decl_stmt|;
comment|/* Telephone JJY timer */
name|short
name|iTeljjySilentTimer
decl_stmt|;
name|short
name|iTeljjyStateTimer
decl_stmt|;
comment|/* Telephone JJY control finite state machine */
name|short
name|iClockState
decl_stmt|;
name|short
name|iClockEvent
decl_stmt|;
name|short
name|iClockCommandSeq
decl_stmt|;
comment|/* Modem timer */
name|short
name|iModemSilentCount
decl_stmt|;
name|short
name|iModemSilentTimer
decl_stmt|;
name|short
name|iModemStateTimer
decl_stmt|;
comment|/* Modem control finite state machine */
name|short
name|iModemState
decl_stmt|;
name|short
name|iModemEvent
decl_stmt|;
name|short
name|iModemCommandSeq
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|UNITTYPE_TRISTATE_JJY01
value|1
end_define

begin_define
define|#
directive|define
name|UNITTYPE_CDEX_JST2000
value|2
end_define

begin_define
define|#
directive|define
name|UNITTYPE_ECHOKEISOKUKI_LT2000
value|3
end_define

begin_define
define|#
directive|define
name|UNITTYPE_CITIZENTIC_JJY200
value|4
end_define

begin_define
define|#
directive|define
name|UNITTYPE_TRISTATE_GPSCLOCK01
value|5
end_define

begin_define
define|#
directive|define
name|UNITTYPE_SEIKO_TIMESYS_TDC_300
value|6
end_define

begin_define
define|#
directive|define
name|UNITTYPE_TELEPHONE
value|100
end_define

begin_define
define|#
directive|define
name|JJY_PROCESS_STATE_IDLE
value|0
end_define

begin_define
define|#
directive|define
name|JJY_PROCESS_STATE_POLL
value|1
end_define

begin_define
define|#
directive|define
name|JJY_PROCESS_STATE_RECEIVE
value|2
end_define

begin_define
define|#
directive|define
name|JJY_PROCESS_STATE_DONE
value|3
end_define

begin_define
define|#
directive|define
name|JJY_PROCESS_STATE_ERROR
value|4
end_define

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  *  Function calling structure  *  *  jjy_start  *   |--  jjy_start_tristate_jjy01  *   |--  jjy_start_cdex_jst2000  *   |--  jjy_start_echokeisokuki_lt2000  *   |--  jjy_start_citizentic_jjy200  *   |--  jjy_start_tristate_gpsclock01  *   |--  jjy_start_seiko_tsys_tdc_300  *   |--  jjy_start_telephone  *  *  jjy_shutdown  *  *  jjy_poll  *   |--  jjy_poll_tristate_jjy01  *   |--  jjy_poll_cdex_jst2000  *   |--  jjy_poll_echokeisokuki_lt2000  *   |--  jjy_poll_citizentic_jjy200  *   |--  jjy_poll_tristate_gpsclock01  *   |--  jjy_poll_seiko_tsys_tdc_300  *   |--  jjy_poll_telephone  *         |--  teljjy_control  *               |--  teljjy_XXXX_YYYY ( XXXX_YYYY is an event handler name. )  *                     |--  modem_connect  *                           |--  modem_control  *                                 |--  modem_XXXX_YYYY ( XXXX_YYYY is an event handler name. )  *  *  jjy_receive  *   |  *   |--  jjy_receive_tristate_jjy01  *   |     |--  jjy_synctime  *   |--  jjy_receive_cdex_jst2000  *   |     |--  jjy_synctime  *   |--  jjy_receive_echokeisokuki_lt2000  *   |     |--  jjy_synctime  *   |--  jjy_receive_citizentic_jjy200  *   |     |--  jjy_synctime  *   |--  jjy_receive_tristate_gpsclock01  *   |     |--  jjy_synctime  *   |--  jjy_receive_seiko_tsys_tdc_300  *   |     |--  jjy_synctime  *   |--  jjy_receive_telephone  *         |--  modem_receive  *         |     |--  modem_control  *         |           |--  modem_XXXX_YYYY ( XXXX_YYYY is an event handler name. )  *         |--  teljjy_control  *               |--  teljjy_XXXX_YYYY ( XXXX_YYYY is an event handler name. )  *                     |--  jjy_synctime  *                     |--  modem_disconnect  *                           |--  modem_control  *                                 |--  modem_XXXX_YYYY ( XXXX_YYYY is an event handler name. )  *  *  jjy_timer  *   |--  jjy_timer_telephone  *         |--  modem_timer  *         |     |--  modem_control  *         |           |--  modem_XXXX_YYYY ( XXXX_YYYY is an event handler name. )  *         |--  teljjy_control  *               |--  teljjy_XXXX_YYYY ( XXXX_YYYY is an event handler name. )  *                     |--  modem_disconnect  *                           |--  modem_control  *                                 |--  modem_XXXX_YYYY ( XXXX_YYYY is an event handler name. )  *  * Function prototypes  */
end_comment

begin_function_decl
specifier|static
name|int
name|jjy_start
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_start_tristate_jjy01
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_start_cdex_jst2000
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_start_echokeisokuki_lt2000
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_start_citizentic_jjy200
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_start_tristate_gpsclock01
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_start_seiko_tsys_tdc_300
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_start_telephone
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_shutdown
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_poll
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_poll_tristate_jjy01
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_poll_cdex_jst2000
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_poll_echokeisokuki_lt2000
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_poll_citizentic_jjy200
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_poll_tristate_gpsclock01
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_poll_seiko_tsys_tdc_300
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_poll_telephone
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_receive
parameter_list|(
name|struct
name|recvbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_receive_tristate_jjy01
parameter_list|(
name|struct
name|recvbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_receive_cdex_jst2000
parameter_list|(
name|struct
name|recvbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_receive_echokeisokuki_lt2000
parameter_list|(
name|struct
name|recvbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_receive_citizentic_jjy200
parameter_list|(
name|struct
name|recvbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_receive_tristate_gpsclock01
parameter_list|(
name|struct
name|recvbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_receive_seiko_tsys_tdc_300
parameter_list|(
name|struct
name|recvbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|jjy_receive_telephone
parameter_list|(
name|struct
name|recvbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_timer
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_timer_telephone
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_synctime
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|jjy_write_clockstats
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|getRawDataBreakPosition
parameter_list|(
name|struct
name|jjyunit
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|short
name|getModemState
parameter_list|(
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isModemStateConnect
parameter_list|(
name|short
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isModemStateDisconnect
parameter_list|(
name|short
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|isModemStateTimerOn
parameter_list|(
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|modem_connect
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|modem_disconnect
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_receive
parameter_list|(
name|struct
name|recvbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|modem_timer
parameter_list|(
name|int
parameter_list|,
name|struct
name|peer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|printableString
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Transfer vector  */
end_comment

begin_decl_stmt
name|struct
name|refclock
name|refclock_jjy
init|=
block|{
name|jjy_start
block|,
comment|/* start up driver */
name|jjy_shutdown
block|,
comment|/* shutdown driver */
name|jjy_poll
block|,
comment|/* transmit poll message */
name|noentry
block|,
comment|/* not used */
name|noentry
block|,
comment|/* not used */
name|noentry
block|,
comment|/* not used */
name|jjy_timer
comment|/* 1 second interval timer */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Start up driver return code  */
end_comment

begin_define
define|#
directive|define
name|RC_START_SUCCESS
value|1
end_define

begin_define
define|#
directive|define
name|RC_START_ERROR
value|0
end_define

begin_comment
comment|/*  * Local constants definition  */
end_comment

begin_define
define|#
directive|define
name|MAX_LOGTEXT
value|100
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|TRUE
end_ifndef

begin_define
define|#
directive|define
name|TRUE
value|(0==0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|FALSE
end_ifndef

begin_define
define|#
directive|define
name|FALSE
value|(!TRUE)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Local constants definition for the return code of the jjy_receive_xxxxxxxx */
end_comment

begin_define
define|#
directive|define
name|JJY_RECEIVE_DONE
value|0
end_define

begin_define
define|#
directive|define
name|JJY_RECEIVE_SKIP
value|1
end_define

begin_define
define|#
directive|define
name|JJY_RECEIVE_UNPROCESS
value|2
end_define

begin_define
define|#
directive|define
name|JJY_RECEIVE_WAIT
value|3
end_define

begin_define
define|#
directive|define
name|JJY_RECEIVE_ERROR
value|4
end_define

begin_comment
comment|/* Local constants definition for the 2nd parameter of the jjy_write_clockstats */
end_comment

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MARK_NONE
value|0
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MARK_JJY
value|1
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MARK_SEND
value|2
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MARK_RECEIVE
value|3
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MARK_INFORMATION
value|4
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MARK_ATTENTION
value|5
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MARK_WARNING
value|6
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MARK_ERROR
value|7
end_define

begin_comment
comment|/* Local constants definition for the clockstats messages */
end_comment

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_ECHOBACK
value|"* Echoback"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_IGNORE_REPLY
value|"* Ignore replay : [%s]"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_OVER_MIDNIGHT_2
value|"* Over midnight : timestamp=%d, %d"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_OVER_MIDNIGHT_3
value|"* Over midnight : timestamp=%d, %d, %d"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_TIMESTAMP_UNSURE
value|"* Unsure timestamp : %s"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_LOOPBACK_DELAY
value|"* Loopback delay : %d.%03d mSec."
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_DELAY_ADJUST
value|"* Delay adjustment : %d mSec. ( valid=%hd/%d )"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_DELAY_UNADJUST
value|"* Delay adjustment : None ( valid=%hd/%d )"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_UNEXPECTED_REPLY
value|"# Unexpected reply : [%s]"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_INVALID_LENGTH
value|"# Invalid length : length=%d"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_TOO_MANY_REPLY
value|"# Too many reply : count=%d"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_INVALID_REPLY
value|"# Invalid reply : [%s]"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_SLOW_REPLY_2
value|"# Slow reply : timestamp=%d, %d"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_SLOW_REPLY_3
value|"# Slow reply : timestamp=%d, %d, %d"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATE
value|"# Invalid date : rc=%d year=%d month=%d day=%d"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_TIME
value|"# Invalid time : rc=%d hour=%d minute=%d second=%d"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATETIME
value|"# Invalid time : rc=%d year=%d month=%d day=%d hour=%d minute=%d second=%d"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_LEAP
value|"# Invalid leap : leapsecond=[%s]"
end_define

begin_define
define|#
directive|define
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_STATUS
value|"# Invalid status : status=[%s]"
end_define

begin_comment
comment|/* Debug print macro */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DEBUG_PRINTF_JJY_RECEIVE
parameter_list|(
name|sFunc
parameter_list|,
name|iLen
parameter_list|)
value|{ if ( debug ) { printf ( "refclock_jjy.c : %s : iProcessState=%d bLineError=%d iCommandSeq=%d iLineCount=%d iTimestampCount=%d iLen=%d\n", sFunc, up->iProcessState, up->bLineError, up->iCommandSeq, up->iLineCount, up->iTimestampCount, iLen ) ; } }
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DEBUG_PRINTF_JJY_RECEIVE
parameter_list|(
name|sFunc
parameter_list|,
name|iLen
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_comment
comment|/*  jjy_start - open the devices and initialize data for processing                               */
end_comment

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_start
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|char
name|sDeviceName
index|[
sizeof|sizeof
argument_list|(
name|DEVICE
argument_list|)
operator|+
literal|10
index|]
decl_stmt|,
name|sLog
index|[
literal|60
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : jjy_start : %s  mode=%d  dev=%s  unit=%d\n"
argument_list|,
name|ntoa
argument_list|(
operator|&
name|peer
operator|->
name|srcadr
argument_list|)
argument_list|,
name|peer
operator|->
name|ttl
argument_list|,
name|DEVICE
argument_list|,
name|unit
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* Allocate memory for the unit structure */
name|up
operator|=
name|emalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|up
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|up
operator|==
name|NULL
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"refclock_jjy.c : jjy_start : emalloc"
argument_list|)
expr_stmt|;
return|return
name|RC_START_ERROR
return|;
block|}
name|memset
argument_list|(
name|up
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|up
argument_list|)
argument_list|)
expr_stmt|;
name|up
operator|->
name|bInitError
operator|=
name|FALSE
expr_stmt|;
name|up
operator|->
name|iProcessState
operator|=
name|JJY_PROCESS_STATE_IDLE
expr_stmt|;
name|up
operator|->
name|bReceiveFlag
operator|=
name|FALSE
expr_stmt|;
name|up
operator|->
name|iCommandSeq
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iLineCount
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iTimestampCount
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|bWaitBreakString
operator|=
name|FALSE
expr_stmt|;
name|up
operator|->
name|iRawBufLen
operator|=
name|up
operator|->
name|iLineBufLen
operator|=
name|up
operator|->
name|iTextBufLen
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|bSkipCntrlCharOnly
operator|=
name|TRUE
expr_stmt|;
comment|/* Set up the device name */
name|snprintf
argument_list|(
name|sDeviceName
argument_list|,
sizeof|sizeof
argument_list|(
name|sDeviceName
argument_list|)
argument_list|,
name|DEVICE
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
literal|"mode=%d dev=%s"
argument_list|,
name|peer
operator|->
name|ttl
argument_list|,
name|sDeviceName
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
comment|/* 	 * peer->ttl is a mode number specified by "127.127.40.X mode N" in the ntp.conf 	 */
switch|switch
condition|(
name|peer
operator|->
name|ttl
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
name|rc
operator|=
name|jjy_start_tristate_jjy01
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
break|break ;
case|case
literal|2
case|:
name|rc
operator|=
name|jjy_start_cdex_jst2000
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
break|break ;
case|case
literal|3
case|:
name|rc
operator|=
name|jjy_start_echokeisokuki_lt2000
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
break|break ;
case|case
literal|4
case|:
name|rc
operator|=
name|jjy_start_citizentic_jjy200
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
break|break ;
case|case
literal|5
case|:
name|rc
operator|=
name|jjy_start_tristate_gpsclock01
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
break|break ;
case|case
literal|6
case|:
name|rc
operator|=
name|jjy_start_seiko_tsys_tdc_300
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
break|break ;
case|case
literal|100
case|:
name|rc
operator|=
name|jjy_start_telephone
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
break|break ;
default|default :
if|if
condition|(
literal|101
operator|<=
name|peer
operator|->
name|ttl
operator|&&
name|peer
operator|->
name|ttl
operator|<=
literal|180
condition|)
block|{
name|rc
operator|=
name|jjy_start_telephone
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"JJY receiver [ %s mode %d ] : Unsupported mode"
argument_list|,
name|ntoa
argument_list|(
operator|&
name|peer
operator|->
name|srcadr
argument_list|)
argument_list|,
name|peer
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|up
argument_list|)
expr_stmt|;
return|return
name|RC_START_ERROR
return|;
block|}
block|}
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"JJY receiver [ %s mode %d ] : Initialize error"
argument_list|,
name|ntoa
argument_list|(
operator|&
name|peer
operator|->
name|srcadr
argument_list|)
argument_list|,
name|peer
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|up
argument_list|)
expr_stmt|;
return|return
name|RC_START_ERROR
return|;
block|}
comment|/* Open the device */
name|fd
operator|=
name|refclock_open
argument_list|(
name|sDeviceName
argument_list|,
name|up
operator|->
name|linespeed
argument_list|,
name|up
operator|->
name|linediscipline
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<=
literal|0
condition|)
block|{
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|up
argument_list|)
expr_stmt|;
return|return
name|RC_START_ERROR
return|;
block|}
comment|/* 	 * Initialize variables 	 */
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|pp
operator|->
name|clockdesc
operator|=
name|DESCRIPTION
expr_stmt|;
name|pp
operator|->
name|unitptr
operator|=
name|up
expr_stmt|;
name|pp
operator|->
name|io
operator|.
name|clock_recv
operator|=
name|jjy_receive
expr_stmt|;
name|pp
operator|->
name|io
operator|.
name|srcclock
operator|=
name|peer
expr_stmt|;
name|pp
operator|->
name|io
operator|.
name|datalen
operator|=
literal|0
expr_stmt|;
name|pp
operator|->
name|io
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
if|if
condition|(
operator|!
name|io_addclock
argument_list|(
operator|&
name|pp
operator|->
name|io
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|pp
operator|->
name|io
operator|.
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
name|free
argument_list|(
name|up
argument_list|)
expr_stmt|;
name|pp
operator|->
name|unitptr
operator|=
name|NULL
expr_stmt|;
return|return
name|RC_START_ERROR
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pp
operator|->
name|refid
argument_list|,
name|REFID
argument_list|,
name|strlen
argument_list|(
name|REFID
argument_list|)
argument_list|)
expr_stmt|;
name|peer
operator|->
name|precision
operator|=
name|PRECISION
expr_stmt|;
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
literal|"minpoll=%d maxpoll=%d"
argument_list|,
name|peer
operator|->
name|minpoll
argument_list|,
name|peer
operator|->
name|maxpoll
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
return|return
name|RC_START_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_comment
comment|/*  jjy_shutdown - shutdown the clock                                                             */
end_comment

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_shutdown
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|char
name|sLog
index|[
literal|60
index|]
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
if|if
condition|(
operator|-
literal|1
operator|!=
name|pp
operator|->
name|io
operator|.
name|fd
condition|)
block|{
name|io_closeclock
argument_list|(
operator|&
name|pp
operator|->
name|io
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|NULL
operator|!=
name|up
condition|)
block|{
name|free
argument_list|(
name|up
argument_list|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
literal|"JJY stopped. unit=%d mode=%d"
argument_list|,
name|unit
argument_list|,
name|peer
operator|->
name|ttl
argument_list|)
expr_stmt|;
name|record_clock_stats
argument_list|(
operator|&
name|peer
operator|->
name|srcadr
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_comment
comment|/*  jjy_receive - receive data from the serial interface                                          */
end_comment

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_receive
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
specifier|static
specifier|const
name|char
modifier|*
name|sFunctionName
init|=
literal|"jjy_receive"
decl_stmt|;
endif|#
directive|endif
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
name|l_fp
name|tRecvTimestamp
decl_stmt|;
comment|/* arrival timestamp */
name|int
name|rc
decl_stmt|;
name|char
modifier|*
name|pBuf
decl_stmt|,
name|sLogText
index|[
name|MAX_LOGTEXT
index|]
decl_stmt|;
name|int
name|iLen
decl_stmt|,
name|iCopyLen
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|iReadRawBuf
decl_stmt|,
name|iBreakPosition
decl_stmt|;
comment|/* 	 * Initialize pointers and read the timecode and timestamp 	 */
name|peer
operator|=
name|rbufp
operator|->
name|recv_peer
expr_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
comment|/* 	 * Get next input line 	 */
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pp
operator|->
name|lencode
operator|=
name|refclock_gtraw
argument_list|(
name|rbufp
argument_list|,
name|pp
operator|->
name|a_lastcode
argument_list|,
name|BMAX
operator|-
literal|1
argument_list|,
operator|&
name|tRecvTimestamp
argument_list|)
expr_stmt|;
comment|/* 3rd argument can be BMAX, but the coverity scan tool claim "Memory - corruptions  (OVERRUN)" */
comment|/* "a_lastcode" is defined as "char a_lastcode[BMAX]" in the ntp_refclock.h */
comment|/* To avoid its claim, pass the value BMAX-1. */
comment|/* 		 * Append received charaters to temporary buffer 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pp
operator|->
name|lencode
operator|&&
name|up
operator|->
name|iRawBufLen
operator|<
name|MAX_RAWBUF
operator|-
literal|2
condition|;
name|i
operator|++
operator|,
name|up
operator|->
name|iRawBufLen
operator|++
control|)
block|{
name|up
operator|->
name|sRawBuf
index|[
name|up
operator|->
name|iRawBufLen
index|]
operator|=
name|pp
operator|->
name|a_lastcode
index|[
name|i
index|]
expr_stmt|;
block|}
name|up
operator|->
name|sRawBuf
index|[
name|up
operator|->
name|iRawBufLen
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|pp
operator|->
name|lencode
operator|=
name|refclock_gtlin
argument_list|(
name|rbufp
argument_list|,
name|pp
operator|->
name|a_lastcode
argument_list|,
name|BMAX
argument_list|,
operator|&
name|tRecvTimestamp
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"\nrefclock_jjy.c : %s : Len=%d  "
argument_list|,
name|sFunctionName
argument_list|,
name|pp
operator|->
name|lencode
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pp
operator|->
name|lencode
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|iscntrl
argument_list|(
call|(
name|u_char
call|)
argument_list|(
name|pp
operator|->
name|a_lastcode
index|[
name|i
index|]
operator|&
literal|0x7F
argument_list|)
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"<x%02X>"
argument_list|,
name|pp
operator|->
name|a_lastcode
index|[
name|i
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|pp
operator|->
name|a_lastcode
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * The reply with<CR><LF> gives a blank line 	 */
if|if
condition|(
name|pp
operator|->
name|lencode
operator|==
literal|0
condition|)
return|return ;
comment|/* 	 * Receiving data is not expected 	 */
if|if
condition|(
name|up
operator|->
name|iProcessState
operator|==
name|JJY_PROCESS_STATE_IDLE
operator|||
name|up
operator|->
name|iProcessState
operator|==
name|JJY_PROCESS_STATE_DONE
operator|||
name|up
operator|->
name|iProcessState
operator|==
name|JJY_PROCESS_STATE_ERROR
condition|)
block|{
comment|/* Discard received data */
name|up
operator|->
name|iRawBufLen
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : %s : Discard received data\n"
argument_list|,
name|sFunctionName
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return ;
block|}
comment|/* 	 * We get down to business 	 */
name|pp
operator|->
name|lastrec
operator|=
name|tRecvTimestamp
expr_stmt|;
name|up
operator|->
name|iLineCount
operator|++
expr_stmt|;
name|up
operator|->
name|iProcessState
operator|=
name|JJY_PROCESS_STATE_RECEIVE
expr_stmt|;
name|up
operator|->
name|bReceiveFlag
operator|=
name|TRUE
expr_stmt|;
name|iReadRawBuf
operator|=
literal|0
expr_stmt|;
name|iBreakPosition
operator|=
name|up
operator|->
name|iRawBufLen
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
name|up
operator|->
name|iProcessState
operator|==
name|JJY_PROCESS_STATE_RECEIVE
condition|;
control|)
block|{
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
if|if
condition|(
name|up
operator|->
name|bWaitBreakString
condition|)
block|{
name|iBreakPosition
operator|=
name|getRawDataBreakPosition
argument_list|(
name|up
argument_list|,
name|iReadRawBuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|iBreakPosition
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* Break string have not come yet */
if|if
condition|(
name|up
operator|->
name|iRawBufLen
operator|<
name|MAX_RAWBUF
operator|-
literal|2
operator|||
name|iReadRawBuf
operator|>
literal|0
condition|)
block|{
comment|/* Temporary buffer is not full */
break|break ;
block|}
else|else
block|{
comment|/* Temporary buffer is full */
name|iBreakPosition
operator|=
name|up
operator|->
name|iRawBufLen
operator|-
literal|1
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|iBreakPosition
operator|=
name|up
operator|->
name|iRawBufLen
operator|-
literal|1
expr_stmt|;
block|}
comment|/* Copy charaters from temporary buffer to process buffer */
name|up
operator|->
name|iLineBufLen
operator|=
name|up
operator|->
name|iTextBufLen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|iReadRawBuf
init|;
name|i
operator|<=
name|iBreakPosition
condition|;
name|i
operator|++
control|)
block|{
comment|/* Copy all characters */
name|up
operator|->
name|sLineBuf
index|[
name|up
operator|->
name|iLineBufLen
index|]
operator|=
name|up
operator|->
name|sRawBuf
index|[
name|i
index|]
expr_stmt|;
name|up
operator|->
name|iLineBufLen
operator|++
expr_stmt|;
comment|/* Copy printable characters */
if|if
condition|(
operator|!
name|iscntrl
argument_list|(
operator|(
name|u_char
operator|)
name|up
operator|->
name|sRawBuf
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|up
operator|->
name|sTextBuf
index|[
name|up
operator|->
name|iTextBufLen
index|]
operator|=
name|up
operator|->
name|sRawBuf
index|[
name|i
index|]
expr_stmt|;
name|up
operator|->
name|iTextBufLen
operator|++
expr_stmt|;
block|}
block|}
name|up
operator|->
name|sLineBuf
index|[
name|up
operator|->
name|iLineBufLen
index|]
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|sTextBuf
index|[
name|up
operator|->
name|iTextBufLen
index|]
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"refclock_jjy.c : %s : up->iLineBufLen=%d up->iTextBufLen=%d\n"
argument_list|,
name|sFunctionName
argument_list|,
name|up
operator|->
name|iLineBufLen
argument_list|,
name|up
operator|->
name|iTextBufLen
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|up
operator|->
name|bSkipCntrlCharOnly
operator|&&
name|up
operator|->
name|iTextBufLen
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"refclock_jjy.c : %s : Skip cntrl char only : up->iRawBufLen=%d iReadRawBuf=%d iBreakPosition=%d\n"
argument_list|,
name|sFunctionName
argument_list|,
name|up
operator|->
name|iRawBufLen
argument_list|,
name|iReadRawBuf
argument_list|,
name|iBreakPosition
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|iBreakPosition
operator|+
literal|1
operator|<
name|up
operator|->
name|iRawBufLen
condition|)
block|{
name|iReadRawBuf
operator|=
name|iBreakPosition
operator|+
literal|1
expr_stmt|;
continue|continue ;
block|}
else|else
block|{
break|break ;
block|}
block|}
block|}
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sLineBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iLineBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
name|iCopyLen
operator|=
operator|(
name|iLen
operator|<=
sizeof|sizeof
argument_list|(
name|sLogText
argument_list|)
operator|-
literal|1
condition|?
name|iLen
else|:
sizeof|sizeof
argument_list|(
name|sLogText
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|strncpy
argument_list|(
name|sLogText
argument_list|,
name|pBuf
argument_list|,
name|iCopyLen
argument_list|)
expr_stmt|;
name|sLogText
index|[
name|iCopyLen
index|]
operator|=
literal|0
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_RECEIVE
argument_list|,
name|sLogText
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|up
operator|->
name|unittype
condition|)
block|{
case|case
name|UNITTYPE_TRISTATE_JJY01
case|:
name|rc
operator|=
name|jjy_receive_tristate_jjy01
argument_list|(
name|rbufp
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_CDEX_JST2000
case|:
name|rc
operator|=
name|jjy_receive_cdex_jst2000
argument_list|(
name|rbufp
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_ECHOKEISOKUKI_LT2000
case|:
name|rc
operator|=
name|jjy_receive_echokeisokuki_lt2000
argument_list|(
name|rbufp
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_CITIZENTIC_JJY200
case|:
name|rc
operator|=
name|jjy_receive_citizentic_jjy200
argument_list|(
name|rbufp
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_TRISTATE_GPSCLOCK01
case|:
name|rc
operator|=
name|jjy_receive_tristate_gpsclock01
argument_list|(
name|rbufp
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_SEIKO_TIMESYS_TDC_300
case|:
name|rc
operator|=
name|jjy_receive_seiko_tsys_tdc_300
argument_list|(
name|rbufp
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_TELEPHONE
case|:
name|rc
operator|=
name|jjy_receive_telephone
argument_list|(
name|rbufp
argument_list|)
expr_stmt|;
break|break ;
default|default :
name|rc
operator|=
name|JJY_RECEIVE_ERROR
expr_stmt|;
break|break ;
block|}
switch|switch
condition|(
name|rc
condition|)
block|{
case|case
name|JJY_RECEIVE_DONE
case|:
case|case
name|JJY_RECEIVE_SKIP
case|:
name|up
operator|->
name|iProcessState
operator|=
name|JJY_PROCESS_STATE_DONE
expr_stmt|;
break|break ;
case|case
name|JJY_RECEIVE_ERROR
case|:
name|up
operator|->
name|iProcessState
operator|=
name|JJY_PROCESS_STATE_ERROR
expr_stmt|;
break|break ;
default|default :
break|break ;
block|}
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
if|if
condition|(
name|rc
operator|==
name|JJY_RECEIVE_UNPROCESS
condition|)
block|{
break|break ;
block|}
name|iReadRawBuf
operator|=
name|iBreakPosition
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|iReadRawBuf
operator|>=
name|up
operator|->
name|iRawBufLen
condition|)
block|{
comment|/* Processed all received data */
break|break ;
block|}
block|}
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_CLK
condition|)
block|{
break|break ;
block|}
block|}
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
operator|&&
name|iReadRawBuf
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|iReadRawBuf
init|;
name|j
operator|<
name|up
operator|->
name|iRawBufLen
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
name|up
operator|->
name|sRawBuf
index|[
name|i
index|]
operator|=
name|up
operator|->
name|sRawBuf
index|[
name|j
index|]
expr_stmt|;
block|}
name|up
operator|->
name|iRawBufLen
operator|-=
name|iReadRawBuf
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|iRawBufLen
operator|<
literal|0
condition|)
block|{
name|up
operator|->
name|iRawBufLen
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|up
operator|->
name|bReceiveFlag
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|getRawDataBreakPosition
parameter_list|(
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|,
name|int
name|iStart
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|iStart
operator|>=
name|up
operator|->
name|iRawBufLen
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"refclock_jjy.c : getRawDataBreakPosition : iStart=%d return=-1\n"
argument_list|,
name|iStart
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
name|iStart
init|;
name|i
operator|<
name|up
operator|->
name|iRawBufLen
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|up
operator|->
name|pRawBreak
index|[
name|j
index|]
operator|.
name|pString
operator|!=
name|NULL
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|+
name|up
operator|->
name|pRawBreak
index|[
name|j
index|]
operator|.
name|iLength
operator|<=
name|up
operator|->
name|iRawBufLen
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|up
operator|->
name|sRawBuf
operator|+
name|i
argument_list|,
name|up
operator|->
name|pRawBreak
index|[
name|j
index|]
operator|.
name|pString
argument_list|,
name|up
operator|->
name|pRawBreak
index|[
name|j
index|]
operator|.
name|iLength
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"refclock_jjy.c : getRawDataBreakPosition : iStart=%d return=%d\n"
argument_list|,
name|iStart
argument_list|,
name|i
operator|+
name|up
operator|->
name|pRawBreak
index|[
name|j
index|]
operator|.
name|iLength
operator|-
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|i
operator|+
name|up
operator|->
name|pRawBreak
index|[
name|j
index|]
operator|.
name|iLength
operator|-
literal|1
return|;
block|}
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"refclock_jjy.c : getRawDataBreakPosition : iStart=%d return=-1\n"
argument_list|,
name|iStart
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_comment
comment|/*  jjy_poll - called by the transmit procedure                                                   */
end_comment

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_poll
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|char
name|sLog
index|[
literal|40
index|]
decl_stmt|,
name|sReach
index|[
literal|9
index|]
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|bInitError
condition|)
block|{
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
literal|"Ignore polling because of error during initializing"
argument_list|)
expr_stmt|;
return|return ;
block|}
if|if
condition|(
name|pp
operator|->
name|polls
operator|>
literal|0
operator|&&
name|up
operator|->
name|iLineCount
operator|==
literal|0
condition|)
block|{
comment|/* 		 * No reply for last command 		 */
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_TIMEOUT
argument_list|)
expr_stmt|;
block|}
name|pp
operator|->
name|polls
operator|++
expr_stmt|;
name|sReach
index|[
literal|0
index|]
operator|=
name|peer
operator|->
name|reach
operator|&
literal|0x80
condition|?
literal|'1'
else|:
literal|'0'
expr_stmt|;
name|sReach
index|[
literal|1
index|]
operator|=
name|peer
operator|->
name|reach
operator|&
literal|0x40
condition|?
literal|'1'
else|:
literal|'0'
expr_stmt|;
name|sReach
index|[
literal|2
index|]
operator|=
name|peer
operator|->
name|reach
operator|&
literal|0x20
condition|?
literal|'1'
else|:
literal|'0'
expr_stmt|;
name|sReach
index|[
literal|3
index|]
operator|=
name|peer
operator|->
name|reach
operator|&
literal|0x10
condition|?
literal|'1'
else|:
literal|'0'
expr_stmt|;
name|sReach
index|[
literal|4
index|]
operator|=
name|peer
operator|->
name|reach
operator|&
literal|0x08
condition|?
literal|'1'
else|:
literal|'0'
expr_stmt|;
name|sReach
index|[
literal|5
index|]
operator|=
name|peer
operator|->
name|reach
operator|&
literal|0x04
condition|?
literal|'1'
else|:
literal|'0'
expr_stmt|;
name|sReach
index|[
literal|6
index|]
operator|=
name|peer
operator|->
name|reach
operator|&
literal|0x02
condition|?
literal|'1'
else|:
literal|'0'
expr_stmt|;
name|sReach
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
comment|/* This poll */
name|sReach
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
literal|"polls=%ld reach=%s"
argument_list|,
name|pp
operator|->
name|polls
argument_list|,
name|sReach
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ATTENTION
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|iProcessState
operator|=
name|JJY_PROCESS_STATE_POLL
expr_stmt|;
name|up
operator|->
name|iCommandSeq
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iReceiveSeq
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iLineCount
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|FALSE
expr_stmt|;
name|up
operator|->
name|iRawBufLen
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|up
operator|->
name|unittype
condition|)
block|{
case|case
name|UNITTYPE_TRISTATE_JJY01
case|:
name|jjy_poll_tristate_jjy01
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_CDEX_JST2000
case|:
name|jjy_poll_cdex_jst2000
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_ECHOKEISOKUKI_LT2000
case|:
name|jjy_poll_echokeisokuki_lt2000
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_CITIZENTIC_JJY200
case|:
name|jjy_poll_citizentic_jjy200
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_TRISTATE_GPSCLOCK01
case|:
name|jjy_poll_tristate_gpsclock01
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_SEIKO_TIMESYS_TDC_300
case|:
name|jjy_poll_seiko_tsys_tdc_300
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break ;
case|case
name|UNITTYPE_TELEPHONE
case|:
name|jjy_poll_telephone
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break ;
default|default :
break|break ;
block|}
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_comment
comment|/*  jjy_timer - called at one-second intervals                                                    */
end_comment

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_timer
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : jjy_timer\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|bReceiveFlag
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : jjy_timer : up->bReceiveFlag= TRUE : Timer skipped.\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return ;
block|}
switch|switch
condition|(
name|up
operator|->
name|unittype
condition|)
block|{
case|case
name|UNITTYPE_TELEPHONE
case|:
name|jjy_timer_telephone
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break ;
default|default :
break|break ;
block|}
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_comment
comment|/*  jjy_synctime                                                                                  */
end_comment

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_synctime
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|char
name|sLog
index|[
literal|80
index|]
decl_stmt|,
name|cStatus
decl_stmt|;
specifier|const
name|char
modifier|*
name|pStatus
decl_stmt|;
name|pp
operator|->
name|year
operator|=
name|up
operator|->
name|year
expr_stmt|;
name|pp
operator|->
name|day
operator|=
name|ymd2yd
argument_list|(
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|)
expr_stmt|;
name|pp
operator|->
name|hour
operator|=
name|up
operator|->
name|hour
expr_stmt|;
name|pp
operator|->
name|minute
operator|=
name|up
operator|->
name|minute
expr_stmt|;
name|pp
operator|->
name|second
operator|=
name|up
operator|->
name|second
expr_stmt|;
name|pp
operator|->
name|nsec
operator|=
name|up
operator|->
name|msecond
operator|*
literal|1000000
expr_stmt|;
comment|/*  	 * JST to UTC  	 */
name|pp
operator|->
name|hour
operator|-=
literal|9
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|hour
operator|<
literal|0
condition|)
block|{
name|pp
operator|->
name|hour
operator|+=
literal|24
expr_stmt|;
name|pp
operator|->
name|day
operator|--
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|day
operator|<
literal|1
condition|)
block|{
name|pp
operator|->
name|year
operator|--
expr_stmt|;
name|pp
operator|->
name|day
operator|=
name|ymd2yd
argument_list|(
name|pp
operator|->
name|year
argument_list|,
literal|12
argument_list|,
literal|31
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Process the new sample in the median filter and determine the 	 * timecode timestamp. 	 */
if|if
condition|(
operator|!
name|refclock_process
argument_list|(
name|pp
argument_list|)
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_BADTIME
argument_list|)
expr_stmt|;
return|return ;
block|}
name|pp
operator|->
name|lastref
operator|=
name|pp
operator|->
name|lastrec
expr_stmt|;
name|refclock_receive
argument_list|(
name|peer
argument_list|)
expr_stmt|;
comment|/* 	 * Write into the clockstats file 	 */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
literal|"%04d/%02d/%02d %02d:%02d:%02d.%03d JST   ( %04d/%03d %02d:%02d:%02d.%03d UTC )"
argument_list|,
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|,
name|up
operator|->
name|msecond
argument_list|,
name|pp
operator|->
name|year
argument_list|,
name|pp
operator|->
name|day
argument_list|,
name|pp
operator|->
name|hour
argument_list|,
name|pp
operator|->
name|minute
argument_list|,
name|pp
operator|->
name|second
argument_list|,
call|(
name|int
call|)
argument_list|(
name|pp
operator|->
name|nsec
operator|/
literal|1000000
argument_list|)
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ATTENTION
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|cStatus
operator|=
literal|' '
expr_stmt|;
name|pStatus
operator|=
literal|""
expr_stmt|;
switch|switch
condition|(
name|peer
operator|->
name|status
condition|)
block|{
case|case
literal|0
case|:
name|cStatus
operator|=
literal|' '
expr_stmt|;
name|pStatus
operator|=
literal|"Reject"
expr_stmt|;
break|break ;
case|case
literal|1
case|:
name|cStatus
operator|=
literal|'x'
expr_stmt|;
name|pStatus
operator|=
literal|"FalseTick"
expr_stmt|;
break|break ;
case|case
literal|2
case|:
name|cStatus
operator|=
literal|'.'
expr_stmt|;
name|pStatus
operator|=
literal|"Excess"
expr_stmt|;
break|break ;
case|case
literal|3
case|:
name|cStatus
operator|=
literal|'-'
expr_stmt|;
name|pStatus
operator|=
literal|"Outlier"
expr_stmt|;
break|break ;
case|case
literal|4
case|:
name|cStatus
operator|=
literal|'+'
expr_stmt|;
name|pStatus
operator|=
literal|"Candidate"
expr_stmt|;
break|break ;
case|case
literal|5
case|:
name|cStatus
operator|=
literal|'#'
expr_stmt|;
name|pStatus
operator|=
literal|"Selected"
expr_stmt|;
break|break ;
case|case
literal|6
case|:
name|cStatus
operator|=
literal|'*'
expr_stmt|;
name|pStatus
operator|=
literal|"Sys.Peer"
expr_stmt|;
break|break ;
case|case
literal|7
case|:
name|cStatus
operator|=
literal|'o'
expr_stmt|;
name|pStatus
operator|=
literal|"PPS.Peer"
expr_stmt|;
break|break ;
default|default :
break|break ;
block|}
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
literal|"status %d [%c] %s : offset %3.3f mSec. : jitter %3.3f mSec."
argument_list|,
name|peer
operator|->
name|status
argument_list|,
name|cStatus
argument_list|,
name|pStatus
argument_list|,
name|peer
operator|->
name|offset
operator|*
literal|1000
argument_list|,
name|peer
operator|->
name|jitter
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_INFORMATION
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    The Tristate Ltd. JJY receiver TS-JJY01, TS-JJY02					##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    server  127.127.40.X  mode 1								##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*  Command               Response                                  Remarks                       */
end_comment

begin_comment
comment|/*  --------------------  ----------------------------------------  ----------------------------  */
end_comment

begin_comment
comment|/*  dcst<CR><LF>          VALID<CR><LF> or INVALID<CR><LF>                                        */
end_comment

begin_comment
comment|/*  stus<CR><LF>          ADJUSTED<CR><LF> or UNADJUSTED<CR><LF>                                  */
end_comment

begin_comment
comment|/*  date<CR><LF>          YYYY/MM/DD XXX<CR><LF>                    XXX is the day of the week    */
end_comment

begin_comment
comment|/*  time<CR><LF>          HH:MM:SS<CR><LF>                          Not used by this driver       */
end_comment

begin_comment
comment|/*  stim<CR><LF>          HH:MM:SS<CR><LF>                          Reply at just second          */
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_define
define|#
directive|define
name|TS_JJY01_COMMAND_NUMBER_DATE
value|1
end_define

begin_define
define|#
directive|define
name|TS_JJY01_COMMAND_NUMBER_TIME
value|2
end_define

begin_define
define|#
directive|define
name|TS_JJY01_COMMAND_NUMBER_STIM
value|3
end_define

begin_define
define|#
directive|define
name|TS_JJY01_COMMAND_NUMBER_STUS
value|4
end_define

begin_define
define|#
directive|define
name|TS_JJY01_COMMAND_NUMBER_DCST
value|5
end_define

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_DATE
value|"yyyy/mm/dd www"
end_define

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_STIM
value|"hh:mm:ss"
end_define

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_STUS_ADJUSTED
value|"adjusted"
end_define

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_STUS_UNADJUSTED
value|"unadjusted"
end_define

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_DCST_VALID
value|"valid"
end_define

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_DCST_INVALID
value|"invalid"
end_define

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_LENGTH_DATE
value|14
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_LENGTH_TIME
value|8
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_LENGTH_STIM
value|8
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_LENGTH_STUS_ADJUSTED
value|8
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_LENGTH_STUS_UNADJUSTED
value|10
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_LENGTH_DCST_VALID
value|5
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_define
define|#
directive|define
name|TS_JJY01_REPLY_LENGTH_DCST_INVALID
value|7
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
name|commandNumber
decl_stmt|;
specifier|const
name|char
modifier|*
name|command
decl_stmt|;
name|int
name|commandLength
decl_stmt|;
name|int
name|iExpectedReplyLength
index|[
literal|2
index|]
decl_stmt|;
block|}
name|tristate_jjy01_command_sequence
index|[]
init|=
block|{
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* Idle */
block|{
name|TS_JJY01_COMMAND_NUMBER_DCST
block|,
literal|"dcst\r\n"
block|,
literal|6
block|,
block|{
name|TS_JJY01_REPLY_LENGTH_DCST_VALID
block|,
name|TS_JJY01_REPLY_LENGTH_DCST_INVALID
block|}
block|}
block|,
block|{
name|TS_JJY01_COMMAND_NUMBER_STUS
block|,
literal|"stus\r\n"
block|,
literal|6
block|,
block|{
name|TS_JJY01_REPLY_LENGTH_STUS_ADJUSTED
block|,
name|TS_JJY01_REPLY_LENGTH_STUS_UNADJUSTED
block|}
block|}
block|,
block|{
name|TS_JJY01_COMMAND_NUMBER_TIME
block|,
literal|"time\r\n"
block|,
literal|6
block|,
block|{
name|TS_JJY01_REPLY_LENGTH_TIME
block|,
name|TS_JJY01_REPLY_LENGTH_TIME
block|}
block|}
block|,
block|{
name|TS_JJY01_COMMAND_NUMBER_DATE
block|,
literal|"date\r\n"
block|,
literal|6
block|,
block|{
name|TS_JJY01_REPLY_LENGTH_DATE
block|,
name|TS_JJY01_REPLY_LENGTH_DATE
block|}
block|}
block|,
block|{
name|TS_JJY01_COMMAND_NUMBER_STIM
block|,
literal|"stim\r\n"
block|,
literal|6
block|,
block|{
name|TS_JJY01_REPLY_LENGTH_STIM
block|,
name|TS_JJY01_REPLY_LENGTH_STIM
block|}
block|}
block|,
comment|/* End of command */
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|}
struct|;
end_struct

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_start_tristate_jjy01
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
literal|"Refclock: Tristate Ltd. TS-JJY01, TS-JJY02"
argument_list|)
expr_stmt|;
name|up
operator|->
name|unittype
operator|=
name|UNITTYPE_TRISTATE_JJY01
expr_stmt|;
name|up
operator|->
name|linespeed
operator|=
name|SPEED232_TRISTATE_JJY01
expr_stmt|;
name|up
operator|->
name|linediscipline
operator|=
name|LDISC_CLK
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_receive_tristate_jjy01
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
name|char
modifier|*
name|pBuf
decl_stmt|;
name|char
name|sLog
index|[
literal|100
index|]
decl_stmt|;
name|int
name|iLen
decl_stmt|;
name|int
name|rc
decl_stmt|;
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|int
name|iCmdLen
decl_stmt|;
comment|/* Initialize pointers  */
name|peer
operator|=
name|rbufp
operator|->
name|recv_peer
expr_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sTextBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iTextBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
name|DEBUG_PRINTF_JJY_RECEIVE
argument_list|(
literal|"jjy_receive_tristate_jjy01"
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
comment|/* Check expected reply */
if|if
condition|(
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
operator|==
name|NULL
condition|)
block|{
comment|/* Command sequence has not been started, or has been completed */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_UNEXPECTED_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
comment|/* Check reply length */
if|if
condition|(
name|iLen
operator|!=
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|iExpectedReplyLength
index|[
literal|0
index|]
operator|&&
name|iLen
operator|!=
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|iExpectedReplyLength
index|[
literal|1
index|]
condition|)
block|{
comment|/* Unexpected reply length */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_LENGTH
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
comment|/* Parse reply */
switch|switch
condition|(
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|commandNumber
condition|)
block|{
case|case
name|TS_JJY01_COMMAND_NUMBER_DATE
case|:
comment|/* YYYY/MM/DD WWW */
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%4d/%2d/%2d"
argument_list|,
operator|&
name|up
operator|->
name|year
argument_list|,
operator|&
name|up
operator|->
name|month
argument_list|,
operator|&
name|up
operator|->
name|day
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|3
operator|||
name|up
operator|->
name|year
operator|<
literal|2000
operator|||
literal|2099
operator|<=
name|up
operator|->
name|year
operator|||
name|up
operator|->
name|month
operator|<
literal|1
operator|||
literal|12
operator|<
name|up
operator|->
name|month
operator|||
name|up
operator|->
name|day
operator|<
literal|1
operator|||
literal|31
operator|<
name|up
operator|->
name|day
condition|)
block|{
comment|/* Invalid date */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATE
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
break|break ;
case|case
name|TS_JJY01_COMMAND_NUMBER_TIME
case|:
comment|/* HH:MM:SS */
case|case
name|TS_JJY01_COMMAND_NUMBER_STIM
case|:
comment|/* HH:MM:SS */
if|if
condition|(
name|up
operator|->
name|iTimestampCount
operator|>=
literal|2
condition|)
block|{
comment|/* Too many time reply */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_TOO_MANY_REPLY
argument_list|,
name|up
operator|->
name|iTimestampCount
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%2d:%2d:%2d"
argument_list|,
operator|&
name|up
operator|->
name|hour
argument_list|,
operator|&
name|up
operator|->
name|minute
argument_list|,
operator|&
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|3
operator|||
name|up
operator|->
name|hour
operator|>
literal|23
operator|||
name|up
operator|->
name|minute
operator|>
literal|59
operator|||
name|up
operator|->
name|second
operator|>
literal|60
condition|)
block|{
comment|/* Invalid time */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_TIME
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
name|up
operator|->
name|iTimestamp
index|[
name|up
operator|->
name|iTimestampCount
index|]
operator|=
operator|(
name|up
operator|->
name|hour
operator|*
literal|60
operator|+
name|up
operator|->
name|minute
operator|)
operator|*
literal|60
operator|+
name|up
operator|->
name|second
expr_stmt|;
name|up
operator|->
name|iTimestampCount
operator|++
expr_stmt|;
name|up
operator|->
name|msecond
operator|=
literal|0
expr_stmt|;
break|break ;
case|case
name|TS_JJY01_COMMAND_NUMBER_STUS
case|:
if|if
condition|(
name|strncmp
argument_list|(
name|pBuf
argument_list|,
name|TS_JJY01_REPLY_STUS_ADJUSTED
argument_list|,
name|TS_JJY01_REPLY_LENGTH_STUS_ADJUSTED
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|pBuf
argument_list|,
name|TS_JJY01_REPLY_STUS_UNADJUSTED
argument_list|,
name|TS_JJY01_REPLY_LENGTH_STUS_UNADJUSTED
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Good */
block|}
else|else
block|{
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
break|break ;
case|case
name|TS_JJY01_COMMAND_NUMBER_DCST
case|:
if|if
condition|(
name|strncmp
argument_list|(
name|pBuf
argument_list|,
name|TS_JJY01_REPLY_DCST_VALID
argument_list|,
name|TS_JJY01_REPLY_LENGTH_DCST_VALID
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|pBuf
argument_list|,
name|TS_JJY01_REPLY_DCST_INVALID
argument_list|,
name|TS_JJY01_REPLY_LENGTH_DCST_INVALID
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Good */
block|}
else|else
block|{
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
break|break ;
default|default :
comment|/*  Unexpected reply */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
if|if
condition|(
name|up
operator|->
name|iTimestampCount
operator|==
literal|2
condition|)
block|{
comment|/* Process date and time */
if|if
condition|(
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
operator|-
literal|2
operator|<=
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
operator|&&
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
operator|<=
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
condition|)
block|{
comment|/* 3 commands (time,date,stim) was excuted in two seconds */
name|jjy_synctime
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_DONE
return|;
block|}
elseif|else
if|if
condition|(
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
operator|>
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
condition|)
block|{
comment|/* Over midnight, and date is unsure */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_OVER_MIDNIGHT_2
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_INFORMATION
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_SKIP
return|;
block|}
else|else
block|{
comment|/* Slow reply */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SLOW_REPLY_2
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
block|}
comment|/* Issue next command */
if|if
condition|(
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
operator|!=
name|NULL
condition|)
block|{
name|up
operator|->
name|iCommandSeq
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
operator|==
name|NULL
condition|)
block|{
comment|/* Command sequence completed */
return|return
name|JJY_RECEIVE_DONE
return|;
block|}
name|pCmd
operator|=
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
expr_stmt|;
name|iCmdLen
operator|=
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|commandLength
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
name|iCmdLen
argument_list|)
operator|!=
name|iCmdLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_WAIT
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_poll_tristate_jjy01
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
specifier|static
specifier|const
name|char
modifier|*
name|sFunctionName
init|=
literal|"jjy_poll_tristate_jjy01"
decl_stmt|;
endif|#
directive|endif
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|int
name|iCmdLen
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|FALSE
expr_stmt|;
name|up
operator|->
name|iTimestampCount
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|pp
operator|->
name|sloppyclockflag
operator|&
name|CLK_FLAG1
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Skip "dcst" and "stus" commands */
name|up
operator|->
name|iCommandSeq
operator|=
literal|2
expr_stmt|;
name|up
operator|->
name|iLineCount
operator|=
literal|2
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"%s (refclock_jjy.c) : flag1=%X CLK_FLAG1=%X up->iLineCount=%d\n"
argument_list|,
name|sFunctionName
argument_list|,
name|pp
operator|->
name|sloppyclockflag
argument_list|,
name|CLK_FLAG1
argument_list|,
name|up
operator|->
name|iLineCount
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* 	 * Send a first command 	 */
name|up
operator|->
name|iCommandSeq
operator|++
expr_stmt|;
name|pCmd
operator|=
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
expr_stmt|;
name|iCmdLen
operator|=
name|tristate_jjy01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|commandLength
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
name|iCmdLen
argument_list|)
operator|!=
name|iCmdLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    The C-DEX Co. Ltd. JJY receiver JST2000							##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    server  127.127.40.X  mode 2								##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*  Command               Response                                  Remarks                       */
end_comment

begin_comment
comment|/*  --------------------  ----------------------------------------  ----------------------------  */
end_comment

begin_comment
comment|/*<ENQ>1J<ETX><STX>JYYMMDD HHMMSSS<ETX>                 J is a fixed character        */
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_decl_stmt
specifier|static
name|struct
name|jjyRawDataBreak
name|cdex_jst2000_raw_break
index|[ ]
init|=
block|{
block|{
literal|"\x03"
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_start_cdex_jst2000
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
literal|"Refclock: C-DEX Co. Ltd. JST2000"
argument_list|)
expr_stmt|;
name|up
operator|->
name|unittype
operator|=
name|UNITTYPE_CDEX_JST2000
expr_stmt|;
name|up
operator|->
name|linespeed
operator|=
name|SPEED232_CDEX_JST2000
expr_stmt|;
name|up
operator|->
name|linediscipline
operator|=
name|LDISC_RAW
expr_stmt|;
name|up
operator|->
name|pRawBreak
operator|=
name|cdex_jst2000_raw_break
expr_stmt|;
name|up
operator|->
name|bWaitBreakString
operator|=
name|TRUE
expr_stmt|;
name|up
operator|->
name|bSkipCntrlCharOnly
operator|=
name|FALSE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_receive_cdex_jst2000
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
name|char
modifier|*
name|pBuf
decl_stmt|,
name|sLog
index|[
literal|100
index|]
decl_stmt|;
name|int
name|iLen
decl_stmt|;
name|int
name|rc
decl_stmt|;
comment|/* Initialize pointers */
name|peer
operator|=
name|rbufp
operator|->
name|recv_peer
expr_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sTextBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iTextBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
name|DEBUG_PRINTF_JJY_RECEIVE
argument_list|(
literal|"jjy_receive_cdex_jst2000"
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
comment|/* Check expected reply */
if|if
condition|(
name|up
operator|->
name|iCommandSeq
operator|!=
literal|1
condition|)
block|{
comment|/* Command sequence has not been started, or has been completed */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_UNEXPECTED_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
comment|/* Wait until ETX comes */
if|if
condition|(
name|up
operator|->
name|iLineBufLen
operator|<
literal|17
operator|||
name|up
operator|->
name|sLineBuf
index|[
name|up
operator|->
name|iLineBufLen
operator|-
literal|1
index|]
operator|!=
literal|0x03
condition|)
block|{
return|return
name|JJY_RECEIVE_UNPROCESS
return|;
block|}
comment|/* Check reply length */
if|if
condition|(
name|iLen
operator|!=
literal|15
condition|)
block|{
comment|/* Unexpected reply length */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_LENGTH
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
comment|/* JYYMMDDWHHMMSSS */
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"J%2d%2d%2d%*1d%2d%2d%2d%1d"
argument_list|,
operator|&
name|up
operator|->
name|year
argument_list|,
operator|&
name|up
operator|->
name|month
argument_list|,
operator|&
name|up
operator|->
name|day
argument_list|,
operator|&
name|up
operator|->
name|hour
argument_list|,
operator|&
name|up
operator|->
name|minute
argument_list|,
operator|&
name|up
operator|->
name|second
argument_list|,
operator|&
name|up
operator|->
name|msecond
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|7
operator|||
name|up
operator|->
name|month
operator|<
literal|1
operator|||
name|up
operator|->
name|month
operator|>
literal|12
operator|||
name|up
operator|->
name|day
operator|<
literal|1
operator|||
name|up
operator|->
name|day
operator|>
literal|31
operator|||
name|up
operator|->
name|hour
operator|>
literal|23
operator|||
name|up
operator|->
name|minute
operator|>
literal|59
operator|||
name|up
operator|->
name|second
operator|>
literal|60
condition|)
block|{
comment|/* Invalid date and time */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATETIME
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
name|up
operator|->
name|year
operator|+=
literal|2000
expr_stmt|;
name|up
operator|->
name|msecond
operator|*=
literal|100
expr_stmt|;
name|jjy_synctime
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_DONE
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_poll_cdex_jst2000
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|FALSE
expr_stmt|;
name|up
operator|->
name|iRawBufLen
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iLineBufLen
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iTextBufLen
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Send "<ENQ>1J<ETX>" command 	 */
name|up
operator|->
name|iCommandSeq
operator|++
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
literal|"\0051J\003"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|4
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
literal|"\0051J\003"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    The Echo Keisokuki Co. Ltd. JJY receiver LT2000						##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    server  127.127.40.X  mode 3								##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*  Command               Response                                  Remarks                       */
end_comment

begin_comment
comment|/*  --------------------  ----------------------------------------  ----------------------------  */
end_comment

begin_comment
comment|/*  #                                                               Mode 1 ( Request& Send )     */
end_comment

begin_comment
comment|/*  T                     YYMMDDWHHMMSS<BCC1><BCC2><CR>                                           */
end_comment

begin_comment
comment|/*  C                                                               Mode 2 ( Continuous )         */
end_comment

begin_comment
comment|/*                        YYMMDDWHHMMSS<ST1><ST2><ST3><ST4><CR>     0.5 sec before time stamp     */
end_comment

begin_comment
comment|/*<SUB>                                     Second signal                 */
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_define
define|#
directive|define
name|ECHOKEISOKUKI_LT2000_MODE_REQUEST_SEND
value|1
end_define

begin_define
define|#
directive|define
name|ECHOKEISOKUKI_LT2000_MODE_CONTINUOUS
value|2
end_define

begin_define
define|#
directive|define
name|ECHOKEISOKUKI_LT2000_MODE_SWITCHING_CONTINUOUS
value|3
end_define

begin_define
define|#
directive|define
name|ECHOKEISOKUKI_LT2000_COMMAND_REQUEST_SEND
value|"#"
end_define

begin_define
define|#
directive|define
name|ECHOKEISOKUKI_LT2000_COMMAND_REQUEST_TIME
value|"T"
end_define

begin_define
define|#
directive|define
name|ECHOKEISOKUKI_LT2000_COMMAND_CONTINUOUS
value|"C"
end_define

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_start_echokeisokuki_lt2000
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
literal|"Refclock: Echo Keisokuki Co. Ltd. LT2000"
argument_list|)
expr_stmt|;
name|up
operator|->
name|unittype
operator|=
name|UNITTYPE_ECHOKEISOKUKI_LT2000
expr_stmt|;
name|up
operator|->
name|linespeed
operator|=
name|SPEED232_ECHOKEISOKUKI_LT2000
expr_stmt|;
name|up
operator|->
name|linediscipline
operator|=
name|LDISC_CLK
expr_stmt|;
name|up
operator|->
name|operationmode
operator|=
name|ECHOKEISOKUKI_LT2000_MODE_SWITCHING_CONTINUOUS
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_receive_echokeisokuki_lt2000
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
name|char
modifier|*
name|pBuf
decl_stmt|,
name|sLog
index|[
literal|100
index|]
decl_stmt|,
name|sErr
index|[
literal|60
index|]
decl_stmt|;
name|int
name|iLen
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ibcc
decl_stmt|,
name|ibcc1
decl_stmt|,
name|ibcc2
decl_stmt|;
comment|/* Initialize pointers */
name|peer
operator|=
name|rbufp
operator|->
name|recv_peer
expr_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sTextBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iTextBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
name|DEBUG_PRINTF_JJY_RECEIVE
argument_list|(
literal|"jjy_receive_echokeisokuki_lt2000"
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
comment|/* Check reply length */
if|if
condition|(
operator|(
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_REQUEST_SEND
operator|&&
name|iLen
operator|!=
literal|15
operator|)
operator|||
operator|(
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_CONTINUOUS
operator|&&
name|iLen
operator|!=
literal|17
operator|)
operator|||
operator|(
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_SWITCHING_CONTINUOUS
operator|&&
name|iLen
operator|!=
literal|17
operator|)
condition|)
block|{
comment|/* Unexpected reply length */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_LENGTH
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
if|if
condition|(
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_REQUEST_SEND
operator|&&
name|iLen
operator|==
literal|15
condition|)
block|{
comment|/* YYMMDDWHHMMSS<BCC1><BCC2> */
for|for
control|(
name|i
operator|=
name|ibcc
operator|=
literal|0
init|;
name|i
operator|<
literal|13
condition|;
name|i
operator|++
control|)
block|{
name|ibcc
operator|^=
name|pBuf
index|[
name|i
index|]
expr_stmt|;
block|}
name|ibcc1
operator|=
literal|0x30
operator||
operator|(
operator|(
name|ibcc
operator|>>
literal|4
operator|)
operator|&
literal|0xF
operator|)
expr_stmt|;
name|ibcc2
operator|=
literal|0x30
operator||
operator|(
operator|(
name|ibcc
operator|)
operator|&
literal|0xF
operator|)
expr_stmt|;
if|if
condition|(
name|pBuf
index|[
literal|13
index|]
operator|!=
name|ibcc1
operator|||
name|pBuf
index|[
literal|14
index|]
operator|!=
name|ibcc2
condition|)
block|{
name|snprintf
argument_list|(
name|sErr
argument_list|,
sizeof|sizeof
argument_list|(
name|sErr
argument_list|)
operator|-
literal|1
argument_list|,
literal|" BCC error : Recv=%02X,%02X / Calc=%02X,%02X "
argument_list|,
name|pBuf
index|[
literal|13
index|]
operator|&
literal|0xFF
argument_list|,
name|pBuf
index|[
literal|14
index|]
operator|&
literal|0xFF
argument_list|,
name|ibcc1
argument_list|,
name|ibcc2
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_REPLY
argument_list|,
name|sErr
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
block|}
if|if
condition|(
operator|(
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_REQUEST_SEND
operator|&&
name|iLen
operator|==
literal|15
operator|)
operator|||
operator|(
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_CONTINUOUS
operator|&&
name|iLen
operator|==
literal|17
operator|)
operator|||
operator|(
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_SWITCHING_CONTINUOUS
operator|&&
name|iLen
operator|==
literal|17
operator|)
condition|)
block|{
comment|/* YYMMDDWHHMMSS<BCC1><BCC2> or YYMMDDWHHMMSS<ST1><ST2><ST3><ST4> */
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%2d%2d%2d%*1d%2d%2d%2d"
argument_list|,
operator|&
name|up
operator|->
name|year
argument_list|,
operator|&
name|up
operator|->
name|month
argument_list|,
operator|&
name|up
operator|->
name|day
argument_list|,
operator|&
name|up
operator|->
name|hour
argument_list|,
operator|&
name|up
operator|->
name|minute
argument_list|,
operator|&
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|6
operator|||
name|up
operator|->
name|month
operator|<
literal|1
operator|||
name|up
operator|->
name|month
operator|>
literal|12
operator|||
name|up
operator|->
name|day
operator|<
literal|1
operator|||
name|up
operator|->
name|day
operator|>
literal|31
operator|||
name|up
operator|->
name|hour
operator|>
literal|23
operator|||
name|up
operator|->
name|minute
operator|>
literal|59
operator|||
name|up
operator|->
name|second
operator|>
literal|60
condition|)
block|{
comment|/* Invalid date and time */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATETIME
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
name|up
operator|->
name|year
operator|+=
literal|2000
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_CONTINUOUS
operator|||
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_SWITCHING_CONTINUOUS
condition|)
block|{
comment|/* A time stamp comes on every 0.5 second in the mode 2 of the LT-2000. */
name|up
operator|->
name|msecond
operator|=
literal|500
expr_stmt|;
name|up
operator|->
name|second
operator|--
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|second
operator|<
literal|0
condition|)
block|{
name|up
operator|->
name|second
operator|=
literal|59
expr_stmt|;
name|up
operator|->
name|minute
operator|--
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|minute
operator|<
literal|0
condition|)
block|{
name|up
operator|->
name|minute
operator|=
literal|59
expr_stmt|;
name|up
operator|->
name|hour
operator|--
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|hour
operator|<
literal|0
condition|)
block|{
name|up
operator|->
name|hour
operator|=
literal|23
expr_stmt|;
name|up
operator|->
name|day
operator|--
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|day
operator|<
literal|1
condition|)
block|{
name|up
operator|->
name|month
operator|--
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|month
operator|<
literal|1
condition|)
block|{
name|up
operator|->
name|month
operator|=
literal|12
expr_stmt|;
name|up
operator|->
name|year
operator|--
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
block|}
name|jjy_synctime
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|up
operator|->
name|operationmode
operator|==
name|ECHOKEISOKUKI_LT2000_MODE_SWITCHING_CONTINUOUS
condition|)
block|{
comment|/* Switch from mode 2 to mode 1 in order to restraint of useless time stamp. */
name|iLen
operator|=
name|strlen
argument_list|(
name|ECHOKEISOKUKI_LT2000_COMMAND_REQUEST_SEND
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|ECHOKEISOKUKI_LT2000_COMMAND_REQUEST_SEND
argument_list|,
name|iLen
argument_list|)
operator|!=
name|iLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|ECHOKEISOKUKI_LT2000_COMMAND_REQUEST_SEND
argument_list|)
expr_stmt|;
block|}
return|return
name|JJY_RECEIVE_DONE
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_poll_echokeisokuki_lt2000
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|char
name|sCmd
index|[
literal|2
index|]
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|FALSE
expr_stmt|;
comment|/* 	 * Send "T" or "C" command 	 */
switch|switch
condition|(
name|up
operator|->
name|operationmode
condition|)
block|{
case|case
name|ECHOKEISOKUKI_LT2000_MODE_REQUEST_SEND
case|:
name|sCmd
index|[
literal|0
index|]
operator|=
literal|'T'
expr_stmt|;
break|break ;
case|case
name|ECHOKEISOKUKI_LT2000_MODE_CONTINUOUS
case|:
case|case
name|ECHOKEISOKUKI_LT2000_MODE_SWITCHING_CONTINUOUS
case|:
name|sCmd
index|[
literal|0
index|]
operator|=
literal|'C'
expr_stmt|;
break|break ;
block|}
name|sCmd
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|sCmd
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|sCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    The CITIZEN T.I.C CO., LTD. JJY receiver JJY200						##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    server  127.127.40.X  mode 4								##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*  Command               Response                                  Remarks                       */
end_comment

begin_comment
comment|/*  --------------------  ----------------------------------------  ----------------------------  */
end_comment

begin_comment
comment|/*                        'XX YY/MM/DD W HH:MM:SS<CR>               XX:OK|NG|ER  W:0(Mon)-6(Sun)  */
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_function
specifier|static
name|int
name|jjy_start_citizentic_jjy200
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
literal|"Refclock: CITIZEN T.I.C CO. LTD. JJY200"
argument_list|)
expr_stmt|;
name|up
operator|->
name|unittype
operator|=
name|UNITTYPE_CITIZENTIC_JJY200
expr_stmt|;
name|up
operator|->
name|linespeed
operator|=
name|SPEED232_CITIZENTIC_JJY200
expr_stmt|;
name|up
operator|->
name|linediscipline
operator|=
name|LDISC_CLK
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_receive_citizentic_jjy200
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
name|char
modifier|*
name|pBuf
decl_stmt|,
name|sLog
index|[
literal|100
index|]
decl_stmt|,
name|sMsg
index|[
literal|16
index|]
decl_stmt|;
name|int
name|iLen
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|char
name|cApostrophe
decl_stmt|,
name|sStatus
index|[
literal|3
index|]
decl_stmt|;
name|int
name|iWeekday
decl_stmt|;
comment|/* Initialize pointers */
name|peer
operator|=
name|rbufp
operator|->
name|recv_peer
expr_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sTextBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iTextBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
name|DEBUG_PRINTF_JJY_RECEIVE
argument_list|(
literal|"jjy_receive_citizentic_jjy200"
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
comment|/* 	 * JJY-200 sends a timestamp every second. 	 * So, a timestamp is ignored unless it is right after polled. 	 */
if|if
condition|(
name|up
operator|->
name|iProcessState
operator|!=
name|JJY_PROCESS_STATE_RECEIVE
condition|)
block|{
return|return
name|JJY_RECEIVE_SKIP
return|;
block|}
comment|/* Check reply length */
if|if
condition|(
name|iLen
operator|!=
literal|23
condition|)
block|{
comment|/* Unexpected reply length */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_LENGTH
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
comment|/* 'XX YY/MM/DD W HH:MM:SS<CR> */
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%c%2s %2d/%2d/%2d %1d %2d:%2d:%2d"
argument_list|,
operator|&
name|cApostrophe
argument_list|,
name|sStatus
argument_list|,
operator|&
name|up
operator|->
name|year
argument_list|,
operator|&
name|up
operator|->
name|month
argument_list|,
operator|&
name|up
operator|->
name|day
argument_list|,
operator|&
name|iWeekday
argument_list|,
operator|&
name|up
operator|->
name|hour
argument_list|,
operator|&
name|up
operator|->
name|minute
argument_list|,
operator|&
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|sStatus
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|9
operator|||
name|cApostrophe
operator|!=
literal|'\''
operator|||
operator|(
name|strcmp
argument_list|(
name|sStatus
argument_list|,
literal|"OK"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|sStatus
argument_list|,
literal|"NG"
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|sStatus
argument_list|,
literal|"ER"
argument_list|)
operator|!=
literal|0
operator|)
operator|||
name|up
operator|->
name|month
operator|<
literal|1
operator|||
name|up
operator|->
name|month
operator|>
literal|12
operator|||
name|up
operator|->
name|day
operator|<
literal|1
operator|||
name|up
operator|->
name|day
operator|>
literal|31
operator|||
name|iWeekday
operator|>
literal|6
operator|||
name|up
operator|->
name|hour
operator|>
literal|23
operator|||
name|up
operator|->
name|minute
operator|>
literal|59
operator|||
name|up
operator|->
name|second
operator|>
literal|60
condition|)
block|{
comment|/* Invalid date and time */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATETIME
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|sStatus
argument_list|,
literal|"NG"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|sStatus
argument_list|,
literal|"ER"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Timestamp is unsure */
name|snprintf
argument_list|(
name|sMsg
argument_list|,
sizeof|sizeof
argument_list|(
name|sMsg
argument_list|)
operator|-
literal|1
argument_list|,
literal|"status=%s"
argument_list|,
name|sStatus
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_TIMESTAMP_UNSURE
argument_list|,
name|sMsg
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_WARNING
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_SKIP
return|;
block|}
name|up
operator|->
name|year
operator|+=
literal|2000
expr_stmt|;
name|up
operator|->
name|msecond
operator|=
literal|0
expr_stmt|;
name|jjy_synctime
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_DONE
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_poll_citizentic_jjy200
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    The Tristate Ltd. GPS clock TS-GPS01							##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    server  127.127.40.X  mode 5								##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*  This clock has NMEA mode and command/respose mode.                                            */
end_comment

begin_comment
comment|/*  When this jjy driver are used, set to command/respose mode of this clock                      */
end_comment

begin_comment
comment|/*  by the onboard switch SW4, and make sure the LED-Y is tured on.                               */
end_comment

begin_comment
comment|/*  Other than this JJY driver, the refclock driver type 20, generic NMEA driver,                 */
end_comment

begin_comment
comment|/*  works with the NMEA mode of this clock.                                                       */
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*  Command               Response                                  Remarks                       */
end_comment

begin_comment
comment|/*  --------------------  ----------------------------------------  ----------------------------  */
end_comment

begin_comment
comment|/*  stus<CR><LF>          *R|*G|*U|+U<CR><LF>                                                     */
end_comment

begin_comment
comment|/*  date<CR><LF>          YY/MM/DD<CR><LF>                                                        */
end_comment

begin_comment
comment|/*  time<CR><LF>          HH:MM:SS<CR><LF>                                                        */
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_define
define|#
directive|define
name|TS_GPS01_COMMAND_NUMBER_DATE
value|1
end_define

begin_define
define|#
directive|define
name|TS_GPS01_COMMAND_NUMBER_TIME
value|2
end_define

begin_define
define|#
directive|define
name|TS_GPS01_COMMAND_NUMBER_STUS
value|4
end_define

begin_define
define|#
directive|define
name|TS_GPS01_REPLY_DATE
value|"yyyy/mm/dd"
end_define

begin_define
define|#
directive|define
name|TS_GPS01_REPLY_TIME
value|"hh:mm:ss"
end_define

begin_define
define|#
directive|define
name|TS_GPS01_REPLY_STUS_RTC
value|"*R"
end_define

begin_define
define|#
directive|define
name|TS_GPS01_REPLY_STUS_GPS
value|"*G"
end_define

begin_define
define|#
directive|define
name|TS_GPS01_REPLY_STUS_UTC
value|"*U"
end_define

begin_define
define|#
directive|define
name|TS_GPS01_REPLY_STUS_PPS
value|"+U"
end_define

begin_define
define|#
directive|define
name|TS_GPS01_REPLY_LENGTH_DATE
value|10
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_define
define|#
directive|define
name|TS_GPS01_REPLY_LENGTH_TIME
value|8
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_define
define|#
directive|define
name|TS_GPS01_REPLY_LENGTH_STUS
value|2
end_define

begin_comment
comment|/* Length without<CR><LF> */
end_comment

begin_struct
specifier|static
struct|struct
block|{
name|char
name|commandNumber
decl_stmt|;
specifier|const
name|char
modifier|*
name|command
decl_stmt|;
name|int
name|commandLength
decl_stmt|;
name|int
name|iExpectedReplyLength
decl_stmt|;
block|}
name|tristate_gps01_command_sequence
index|[]
init|=
block|{
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* Idle */
block|{
name|TS_GPS01_COMMAND_NUMBER_STUS
block|,
literal|"stus\r\n"
block|,
literal|6
block|,
name|TS_GPS01_REPLY_LENGTH_STUS
block|}
block|,
block|{
name|TS_GPS01_COMMAND_NUMBER_TIME
block|,
literal|"time\r\n"
block|,
literal|6
block|,
name|TS_GPS01_REPLY_LENGTH_TIME
block|}
block|,
block|{
name|TS_GPS01_COMMAND_NUMBER_DATE
block|,
literal|"date\r\n"
block|,
literal|6
block|,
name|TS_GPS01_REPLY_LENGTH_DATE
block|}
block|,
block|{
name|TS_GPS01_COMMAND_NUMBER_TIME
block|,
literal|"time\r\n"
block|,
literal|6
block|,
name|TS_GPS01_REPLY_LENGTH_TIME
block|}
block|,
comment|/* End of command */
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_start_tristate_gpsclock01
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
literal|"Refclock: Tristate Ltd. TS-GPS01"
argument_list|)
expr_stmt|;
name|up
operator|->
name|unittype
operator|=
name|UNITTYPE_TRISTATE_GPSCLOCK01
expr_stmt|;
name|up
operator|->
name|linespeed
operator|=
name|SPEED232_TRISTATE_GPSCLOCK01
expr_stmt|;
name|up
operator|->
name|linediscipline
operator|=
name|LDISC_CLK
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_receive_tristate_gpsclock01
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
specifier|static
specifier|const
name|char
modifier|*
name|sFunctionName
init|=
literal|"jjy_receive_tristate_gpsclock01"
decl_stmt|;
endif|#
directive|endif
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
name|char
modifier|*
name|pBuf
decl_stmt|;
name|char
name|sLog
index|[
literal|100
index|]
decl_stmt|;
name|int
name|iLen
decl_stmt|;
name|int
name|rc
decl_stmt|;
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|int
name|iCmdLen
decl_stmt|;
comment|/* Initialize pointers */
name|peer
operator|=
name|rbufp
operator|->
name|recv_peer
expr_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sTextBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iTextBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
name|DEBUG_PRINTF_JJY_RECEIVE
argument_list|(
literal|"jjy_receive_tristate_gpsclock01"
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
comment|/* Ignore NMEA data stream */
if|if
condition|(
name|iLen
operator|>
literal|5
operator|&&
operator|(
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"$GP"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"$PFEC"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"%s (refclock_jjy.c) : Skip NMEA stream [%s]\n"
argument_list|,
name|sFunctionName
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|JJY_RECEIVE_WAIT
return|;
block|}
comment|/* 	 * Skip command prompt '$Cmd>' from the TS-GPSclock-01 	 */
if|if
condition|(
name|iLen
operator|==
literal|5
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"$Cmd>"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|JJY_RECEIVE_WAIT
return|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|>
literal|5
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"$Cmd>"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pBuf
operator|+=
literal|5
expr_stmt|;
name|iLen
operator|-=
literal|5
expr_stmt|;
block|}
comment|/* 	 * Ignore NMEA data stream after command prompt 	 */
if|if
condition|(
name|iLen
operator|>
literal|5
operator|&&
operator|(
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"$GP"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"$PFEC"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"%s (refclock_jjy.c) : Skip NMEA stream [%s]\n"
argument_list|,
name|sFunctionName
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|JJY_RECEIVE_WAIT
return|;
block|}
comment|/* Check expected reply */
if|if
condition|(
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
operator|==
name|NULL
condition|)
block|{
comment|/* Command sequence has not been started, or has been completed */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_UNEXPECTED_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
comment|/* Check reply length */
if|if
condition|(
name|iLen
operator|!=
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|iExpectedReplyLength
condition|)
block|{
comment|/* Unexpected reply length */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_LENGTH
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
comment|/* Parse reply */
switch|switch
condition|(
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|commandNumber
condition|)
block|{
case|case
name|TS_GPS01_COMMAND_NUMBER_DATE
case|:
comment|/* YYYY/MM/DD */
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%4d/%2d/%2d"
argument_list|,
operator|&
name|up
operator|->
name|year
argument_list|,
operator|&
name|up
operator|->
name|month
argument_list|,
operator|&
name|up
operator|->
name|day
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|3
operator|||
name|up
operator|->
name|year
operator|<
literal|2000
operator|||
literal|2099
operator|<=
name|up
operator|->
name|year
operator|||
name|up
operator|->
name|month
operator|<
literal|1
operator|||
literal|12
operator|<
name|up
operator|->
name|month
operator|||
name|up
operator|->
name|day
operator|<
literal|1
operator|||
literal|31
operator|<
name|up
operator|->
name|day
condition|)
block|{
comment|/* Invalid date */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATE
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
break|break ;
case|case
name|TS_GPS01_COMMAND_NUMBER_TIME
case|:
comment|/* HH:MM:SS */
if|if
condition|(
name|up
operator|->
name|iTimestampCount
operator|>=
literal|2
condition|)
block|{
comment|/* Too many time reply */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_TOO_MANY_REPLY
argument_list|,
name|up
operator|->
name|iTimestampCount
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%2d:%2d:%2d"
argument_list|,
operator|&
name|up
operator|->
name|hour
argument_list|,
operator|&
name|up
operator|->
name|minute
argument_list|,
operator|&
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|3
operator|||
name|up
operator|->
name|hour
operator|>
literal|23
operator|||
name|up
operator|->
name|minute
operator|>
literal|59
operator|||
name|up
operator|->
name|second
operator|>
literal|60
condition|)
block|{
comment|/* Invalid time */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_TIME
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
name|up
operator|->
name|iTimestamp
index|[
name|up
operator|->
name|iTimestampCount
index|]
operator|=
operator|(
name|up
operator|->
name|hour
operator|*
literal|60
operator|+
name|up
operator|->
name|minute
operator|)
operator|*
literal|60
operator|+
name|up
operator|->
name|second
expr_stmt|;
name|up
operator|->
name|iTimestampCount
operator|++
expr_stmt|;
name|up
operator|->
name|msecond
operator|=
literal|0
expr_stmt|;
break|break ;
case|case
name|TS_GPS01_COMMAND_NUMBER_STUS
case|:
if|if
condition|(
name|strncmp
argument_list|(
name|pBuf
argument_list|,
name|TS_GPS01_REPLY_STUS_RTC
argument_list|,
name|TS_GPS01_REPLY_LENGTH_STUS
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|pBuf
argument_list|,
name|TS_GPS01_REPLY_STUS_GPS
argument_list|,
name|TS_GPS01_REPLY_LENGTH_STUS
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|pBuf
argument_list|,
name|TS_GPS01_REPLY_STUS_UTC
argument_list|,
name|TS_GPS01_REPLY_LENGTH_STUS
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|pBuf
argument_list|,
name|TS_GPS01_REPLY_STUS_PPS
argument_list|,
name|TS_GPS01_REPLY_LENGTH_STUS
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Good */
block|}
else|else
block|{
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
break|break ;
default|default :
comment|/*  Unexpected reply */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
if|if
condition|(
name|up
operator|->
name|iTimestampCount
operator|==
literal|2
condition|)
block|{
comment|/* Process date and time */
if|if
condition|(
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
operator|-
literal|2
operator|<=
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
operator|&&
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
operator|<=
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
condition|)
block|{
comment|/* 3 commands (time,date,stim) was excuted in two seconds */
name|jjy_synctime
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_DONE
return|;
block|}
elseif|else
if|if
condition|(
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
operator|>
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
condition|)
block|{
comment|/* Over midnight, and date is unsure */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_OVER_MIDNIGHT_2
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_INFORMATION
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_SKIP
return|;
block|}
else|else
block|{
comment|/* Slow reply */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SLOW_REPLY_2
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|0
index|]
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
block|}
if|if
condition|(
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
operator|==
name|NULL
condition|)
block|{
comment|/* Command sequence completed */
name|jjy_synctime
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_DONE
return|;
block|}
comment|/* Issue next command */
if|if
condition|(
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
operator|!=
name|NULL
condition|)
block|{
name|up
operator|->
name|iCommandSeq
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
operator|==
name|NULL
condition|)
block|{
comment|/* Command sequence completed */
name|up
operator|->
name|iProcessState
operator|=
name|JJY_PROCESS_STATE_DONE
expr_stmt|;
return|return
name|JJY_RECEIVE_DONE
return|;
block|}
name|pCmd
operator|=
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
expr_stmt|;
name|iCmdLen
operator|=
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|commandLength
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
name|iCmdLen
argument_list|)
operator|!=
name|iCmdLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_WAIT
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_poll_tristate_gpsclock01
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
specifier|static
specifier|const
name|char
modifier|*
name|sFunctionName
init|=
literal|"jjy_poll_tristate_gpsclock01"
decl_stmt|;
endif|#
directive|endif
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|int
name|iCmdLen
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|up
operator|->
name|iTimestampCount
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|pp
operator|->
name|sloppyclockflag
operator|&
name|CLK_FLAG1
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Skip "stus" command */
name|up
operator|->
name|iCommandSeq
operator|=
literal|1
expr_stmt|;
name|up
operator|->
name|iLineCount
operator|=
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"%s (refclock_jjy.c) : flag1=%X CLK_FLAG1=%X up->iLineCount=%d\n"
argument_list|,
name|sFunctionName
argument_list|,
name|pp
operator|->
name|sloppyclockflag
argument_list|,
name|CLK_FLAG1
argument_list|,
name|up
operator|->
name|iLineCount
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* 	 * Send a first command 	 */
name|up
operator|->
name|iCommandSeq
operator|++
expr_stmt|;
name|pCmd
operator|=
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|command
expr_stmt|;
name|iCmdLen
operator|=
name|tristate_gps01_command_sequence
index|[
name|up
operator|->
name|iCommandSeq
index|]
operator|.
name|commandLength
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
name|iCmdLen
argument_list|)
operator|!=
name|iCmdLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    The SEIKO TIME SYSTEMS TDC-300								##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    server  127.127.40.X  mode 6								##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*  Type                  Response                                  Remarks                       */
end_comment

begin_comment
comment|/*  --------------------  ----------------------------------------  ----------------------------  */
end_comment

begin_comment
comment|/*  Type 1<STX>HH:MM:SS<ETX>                                                      */
end_comment

begin_comment
comment|/*  Type 2<STX>YYMMDDHHMMSSWLSCU<ETX>               W:0(Sun)-6(Sat)               */
end_comment

begin_comment
comment|/*  Type 3<STX>YYMMDDWHHMMSS<ETX>                   W:0(Sun)-6(Sat)               */
end_comment

begin_comment
comment|/*<STX><xE5><ETX>                           5 to 10 mSec. before second   */
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_decl_stmt
specifier|static
name|struct
name|jjyRawDataBreak
name|seiko_tsys_tdc_300_raw_break
index|[ ]
init|=
block|{
block|{
literal|"\x03"
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_start_seiko_tsys_tdc_300
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
literal|"Refclock: SEIKO TIME SYSTEMS TDC-300"
argument_list|)
expr_stmt|;
name|up
operator|->
name|unittype
operator|=
name|UNITTYPE_SEIKO_TIMESYS_TDC_300
expr_stmt|;
name|up
operator|->
name|linespeed
operator|=
name|SPEED232_SEIKO_TIMESYS_TDC_300
expr_stmt|;
name|up
operator|->
name|linediscipline
operator|=
name|LDISC_RAW
expr_stmt|;
name|up
operator|->
name|pRawBreak
operator|=
name|seiko_tsys_tdc_300_raw_break
expr_stmt|;
name|up
operator|->
name|bWaitBreakString
operator|=
name|TRUE
expr_stmt|;
name|up
operator|->
name|bSkipCntrlCharOnly
operator|=
name|FALSE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_receive_seiko_tsys_tdc_300
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|char
modifier|*
name|pBuf
decl_stmt|,
name|sLog
index|[
literal|100
index|]
decl_stmt|;
name|int
name|iLen
decl_stmt|,
name|i
decl_stmt|;
name|int
name|rc
decl_stmt|,
name|iWeekday
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|struct
name|tm
modifier|*
name|pTime
decl_stmt|;
comment|/* Initialize pointers */
name|peer
operator|=
name|rbufp
operator|->
name|recv_peer
expr_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sTextBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iTextBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
name|DEBUG_PRINTF_JJY_RECEIVE
argument_list|(
literal|"jjy_receive_seiko_tsys_tdc_300"
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
comment|/* 	 * TDC-300 sends a timestamp every second. 	 * So, a timestamp is ignored unless it is right after polled. 	 */
if|if
condition|(
name|up
operator|->
name|iProcessState
operator|!=
name|JJY_PROCESS_STATE_RECEIVE
condition|)
block|{
return|return
name|JJY_RECEIVE_SKIP
return|;
block|}
comment|/* Process timestamp */
name|up
operator|->
name|iReceiveSeq
operator|++
expr_stmt|;
switch|switch
condition|(
name|iLen
condition|)
block|{
case|case
literal|8
case|:
comment|/* Type 1 :<STX>HH:MM:SS<ETX> */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iLen
condition|;
name|i
operator|++
control|)
block|{
name|pBuf
index|[
name|i
index|]
operator|&=
literal|0x7F
expr_stmt|;
block|}
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
operator|+
literal|1
argument_list|,
literal|"%2d:%2d:%2d"
argument_list|,
operator|&
name|up
operator|->
name|hour
argument_list|,
operator|&
name|up
operator|->
name|minute
argument_list|,
operator|&
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|3
operator|||
name|up
operator|->
name|hour
operator|>
literal|23
operator|||
name|up
operator|->
name|minute
operator|>
literal|59
operator|||
name|up
operator|->
name|second
operator|>
literal|60
condition|)
block|{
comment|/* Invalid time */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_TIME
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
elseif|else
if|if
condition|(
name|up
operator|->
name|hour
operator|==
literal|23
operator|&&
name|up
operator|->
name|minute
operator|==
literal|59
operator|&&
name|up
operator|->
name|second
operator|>=
literal|55
condition|)
block|{
comment|/* Uncertainty date guard */
return|return
name|JJY_RECEIVE_WAIT
return|;
block|}
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|pTime
operator|=
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|up
operator|->
name|year
operator|=
name|pTime
operator|->
name|tm_year
expr_stmt|;
name|up
operator|->
name|month
operator|=
name|pTime
operator|->
name|tm_mon
operator|+
literal|1
expr_stmt|;
name|up
operator|->
name|day
operator|=
name|pTime
operator|->
name|tm_mday
expr_stmt|;
break|break ;
case|case
literal|17
case|:
comment|/* Type 2 :<STX>YYMMDDHHMMSSWLSCU<ETX> */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iLen
condition|;
name|i
operator|++
control|)
block|{
name|pBuf
index|[
name|i
index|]
operator|&=
literal|0x7F
expr_stmt|;
block|}
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
operator|+
literal|1
argument_list|,
literal|"%2d%2d%2d%2d%2d%2d%1d"
argument_list|,
operator|&
name|up
operator|->
name|year
argument_list|,
operator|&
name|up
operator|->
name|month
argument_list|,
operator|&
name|up
operator|->
name|day
argument_list|,
operator|&
name|up
operator|->
name|hour
argument_list|,
operator|&
name|up
operator|->
name|minute
argument_list|,
operator|&
name|up
operator|->
name|second
argument_list|,
operator|&
name|iWeekday
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|7
operator|||
name|up
operator|->
name|month
operator|<
literal|1
operator|||
name|up
operator|->
name|month
operator|>
literal|12
operator|||
name|up
operator|->
name|day
operator|<
literal|1
operator|||
name|up
operator|->
name|day
operator|>
literal|31
operator|||
name|iWeekday
operator|>
literal|6
operator|||
name|up
operator|->
name|hour
operator|>
literal|23
operator|||
name|up
operator|->
name|minute
operator|>
literal|59
operator|||
name|up
operator|->
name|second
operator|>
literal|60
condition|)
block|{
comment|/* Invalid date and time */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATETIME
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
break|break ;
case|case
literal|13
case|:
comment|/* Type 3 :<STX>YYMMDDWHHMMSS<ETX> */
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%2d%2d%2d%1d%2d%2d%2d"
argument_list|,
operator|&
name|up
operator|->
name|year
argument_list|,
operator|&
name|up
operator|->
name|month
argument_list|,
operator|&
name|up
operator|->
name|day
argument_list|,
operator|&
name|iWeekday
argument_list|,
operator|&
name|up
operator|->
name|hour
argument_list|,
operator|&
name|up
operator|->
name|minute
argument_list|,
operator|&
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|7
operator|||
name|up
operator|->
name|month
operator|<
literal|1
operator|||
name|up
operator|->
name|month
operator|>
literal|12
operator|||
name|up
operator|->
name|day
operator|<
literal|1
operator|||
name|up
operator|->
name|day
operator|>
literal|31
operator|||
name|iWeekday
operator|>
literal|6
operator|||
name|up
operator|->
name|hour
operator|>
literal|23
operator|||
name|up
operator|->
name|minute
operator|>
literal|59
operator|||
name|up
operator|->
name|second
operator|>
literal|60
condition|)
block|{
comment|/* Invalid date and time */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATETIME
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
return|return
name|JJY_RECEIVE_WAIT
return|;
case|case
literal|1
case|:
comment|/* Type 3 :<STX><xE5><ETX> */
if|if
condition|(
operator|(
operator|*
name|pBuf
operator|&
literal|0xFF
operator|)
operator|!=
literal|0xE5
condition|)
block|{
comment|/* Invalid second signal */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_REPLY
argument_list|,
name|up
operator|->
name|sLineBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
elseif|else
if|if
condition|(
name|up
operator|->
name|iReceiveSeq
operator|==
literal|1
condition|)
block|{
comment|/* Wait for next timestamp */
name|up
operator|->
name|iReceiveSeq
operator|--
expr_stmt|;
return|return
name|JJY_RECEIVE_WAIT
return|;
block|}
elseif|else
if|if
condition|(
name|up
operator|->
name|iReceiveSeq
operator|>=
literal|3
condition|)
block|{
comment|/* Unexpected second signal */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_UNEXPECTED_REPLY
argument_list|,
name|up
operator|->
name|sLineBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
break|break ;
default|default :
comment|/* Unexpected reply length */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_INVALID_LENGTH
argument_list|,
name|iLen
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
return|return
name|JJY_RECEIVE_ERROR
return|;
block|}
name|up
operator|->
name|year
operator|+=
literal|2000
expr_stmt|;
name|up
operator|->
name|msecond
operator|=
literal|0
expr_stmt|;
name|jjy_synctime
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_DONE
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_poll_seiko_tsys_tdc_300
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    Telephone JJY										##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    server  127.127.40.X  mode 100 to 180							##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*  Prompt                Command               Response              Remarks                     */
end_comment

begin_comment
comment|/*  --------------------  --------------------  --------------------  --------------------------  */
end_comment

begin_comment
comment|/*  Name<SP>?<SP>         TJJY<CR>              Welcome messages      TJJY is a guest user ID     */
end_comment

begin_comment
comment|/*>                     4DATE<CR>             YYYYMMDD<CR>                                      */
end_comment

begin_comment
comment|/*>                     LEAPSEC<CR>           XX<CR>                One of<SP>0, +1, -1        */
end_comment

begin_comment
comment|/*>                     TIME<CR>              HHMMSS<CR>            3 times on second           */
end_comment

begin_comment
comment|/*>                     BYE<CR>               Sayounara messages                                */
end_comment

begin_comment
comment|/*                                                                                                */
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_decl_stmt
specifier|static
name|struct
name|jjyRawDataBreak
name|teljjy_raw_break
index|[ ]
init|=
block|{
block|{
literal|"\r\n"
block|,
literal|2
block|}
block|,
block|{
literal|"\r"
block|,
literal|1
block|}
block|,
block|{
literal|"\n"
block|,
literal|1
block|}
block|,
block|{
literal|"Name ? "
block|,
literal|7
block|}
block|,
block|{
literal|">"
block|,
literal|1
block|}
block|,
block|{
literal|"+++"
block|,
literal|3
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|TELJJY_STATE_IDLE
value|0
end_define

begin_define
define|#
directive|define
name|TELJJY_STATE_DAILOUT
value|1
end_define

begin_define
define|#
directive|define
name|TELJJY_STATE_LOGIN
value|2
end_define

begin_define
define|#
directive|define
name|TELJJY_STATE_CONNECT
value|3
end_define

begin_define
define|#
directive|define
name|TELJJY_STATE_BYE
value|4
end_define

begin_define
define|#
directive|define
name|TELJJY_EVENT_NULL
value|0
end_define

begin_define
define|#
directive|define
name|TELJJY_EVENT_START
value|1
end_define

begin_define
define|#
directive|define
name|TELJJY_EVENT_CONNECT
value|2
end_define

begin_define
define|#
directive|define
name|TELJJY_EVENT_DISCONNECT
value|3
end_define

begin_define
define|#
directive|define
name|TELJJY_EVENT_COMMAND
value|4
end_define

begin_define
define|#
directive|define
name|TELJJY_EVENT_LOGIN
value|5
end_define

begin_comment
comment|/* Posted by the jjy_receive_telephone */
end_comment

begin_define
define|#
directive|define
name|TELJJY_EVENT_PROMPT
value|6
end_define

begin_comment
comment|/* Posted by the jjy_receive_telephone */
end_comment

begin_define
define|#
directive|define
name|TELJJY_EVENT_DATA
value|7
end_define

begin_comment
comment|/* Posted by the jjy_receive_telephone */
end_comment

begin_define
define|#
directive|define
name|TELJJY_EVENT_ERROR
value|8
end_define

begin_comment
comment|/* Posted by the jjy_receive_telephone */
end_comment

begin_define
define|#
directive|define
name|TELJJY_EVENT_SILENT
value|9
end_define

begin_comment
comment|/* Posted by the jjy_timer_telephone */
end_comment

begin_define
define|#
directive|define
name|TELJJY_EVENT_TIMEOUT
value|10
end_define

begin_comment
comment|/* Posted by the jjy_timer_telephone */
end_comment

begin_function_decl
specifier|static
name|void
name|teljjy_control
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_idle_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_idle_dialout
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_dial_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_dial_login
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_dial_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_login_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_login_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_login_conn
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_login_login
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_login_silent
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_login_error
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_conn_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_conn_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_conn_send
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_conn_data
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_conn_silent
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_conn_error
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_bye_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_bye_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|teljjy_bye_modem
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|pTeljjyHandler
index|[ ]
index|[
literal|5
index|]
function_decl|)
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
init|=
block|{
comment|/*STATE_IDLE           STATE_DAILOUT       STATE_LOGIN           STATE_CONNECT       STATE_BYE        */
comment|/* NULL       */
block|{
name|teljjy_idle_ignore
operator|,
function_decl|teljjy_dial_ignore
operator|,
function_decl|teljjy_login_ignore
operator|,
function_decl|teljjy_conn_ignore
operator|,
function_decl|teljjy_bye_ignore
end_function_decl

begin_comment
unit|},
comment|/* START      */
end_comment

begin_block
block|{
name|teljjy_idle_dialout
operator|,
name|teljjy_dial_ignore
operator|,
name|teljjy_login_ignore
operator|,
name|teljjy_conn_ignore
operator|,
name|teljjy_bye_ignore
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* CONNECT    */
end_comment

begin_block
block|{
name|teljjy_idle_ignore
operator|,
name|teljjy_dial_login
operator|,
name|teljjy_login_ignore
operator|,
name|teljjy_conn_ignore
operator|,
name|teljjy_bye_ignore
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* DISCONNECT */
end_comment

begin_block
block|{
name|teljjy_idle_ignore
operator|,
name|teljjy_dial_disc
operator|,
name|teljjy_login_disc
operator|,
name|teljjy_conn_disc
operator|,
name|teljjy_bye_disc
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* COMMAND    */
end_comment

begin_block
block|{
name|teljjy_idle_ignore
operator|,
name|teljjy_dial_ignore
operator|,
name|teljjy_login_ignore
operator|,
name|teljjy_conn_ignore
operator|,
name|teljjy_bye_modem
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* LOGIN      */
end_comment

begin_block
block|{
name|teljjy_idle_ignore
operator|,
name|teljjy_dial_ignore
operator|,
name|teljjy_login_login
operator|,
name|teljjy_conn_error
operator|,
name|teljjy_bye_ignore
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* PROMPT     */
end_comment

begin_block
block|{
name|teljjy_idle_ignore
operator|,
name|teljjy_dial_ignore
operator|,
name|teljjy_login_conn
operator|,
name|teljjy_conn_send
operator|,
name|teljjy_bye_ignore
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* DATA       */
end_comment

begin_block
block|{
name|teljjy_idle_ignore
operator|,
name|teljjy_dial_ignore
operator|,
name|teljjy_login_ignore
operator|,
name|teljjy_conn_data
operator|,
name|teljjy_bye_ignore
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* ERROR      */
end_comment

begin_block
block|{
name|teljjy_idle_ignore
operator|,
name|teljjy_dial_ignore
operator|,
name|teljjy_login_error
operator|,
name|teljjy_conn_error
operator|,
name|teljjy_bye_ignore
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* SILENT     */
end_comment

begin_block
block|{
name|teljjy_idle_ignore
operator|,
name|teljjy_dial_ignore
operator|,
name|teljjy_login_silent
operator|,
name|teljjy_conn_silent
operator|,
name|teljjy_bye_ignore
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* TIMEOUT    */
end_comment

begin_block
block|{
name|teljjy_idle_ignore
operator|,
name|teljjy_dial_disc
operator|,
name|teljjy_login_error
operator|,
name|teljjy_conn_error
operator|,
name|teljjy_bye_modem
block|}
end_block

begin_decl_stmt
unit|} ;
specifier|static
name|short
name|iTeljjyNextState
index|[ ]
index|[
literal|5
index|]
init|=
block|{
comment|/*STATE_IDLE            STATE_DAILOUT         STATE_LOGIN           STATE_CONNECT         STATE_BYE         */
comment|/* NULL       */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_DAILOUT
block|,
name|TELJJY_STATE_LOGIN
block|,
name|TELJJY_STATE_CONNECT
block|,
name|TELJJY_STATE_BYE
block|}
block|,
comment|/* START      */
block|{
name|TELJJY_STATE_DAILOUT
block|,
name|TELJJY_STATE_DAILOUT
block|,
name|TELJJY_STATE_LOGIN
block|,
name|TELJJY_STATE_CONNECT
block|,
name|TELJJY_STATE_BYE
block|}
block|,
comment|/* CONNECT    */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_LOGIN
block|,
name|TELJJY_STATE_LOGIN
block|,
name|TELJJY_STATE_CONNECT
block|,
name|TELJJY_STATE_BYE
block|}
block|,
comment|/* DISCONNECT */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_IDLE
block|}
block|,
comment|/* COMMAND    */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_DAILOUT
block|,
name|TELJJY_STATE_LOGIN
block|,
name|TELJJY_STATE_CONNECT
block|,
name|TELJJY_STATE_BYE
block|}
block|,
comment|/* LOGIN      */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_DAILOUT
block|,
name|TELJJY_STATE_LOGIN
block|,
name|TELJJY_STATE_BYE
block|,
name|TELJJY_STATE_BYE
block|}
block|,
comment|/* PROMPT     */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_DAILOUT
block|,
name|TELJJY_STATE_CONNECT
block|,
name|TELJJY_STATE_BYE
block|,
name|TELJJY_STATE_BYE
block|}
block|,
comment|/* DATA       */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_DAILOUT
block|,
name|TELJJY_STATE_LOGIN
block|,
name|TELJJY_STATE_CONNECT
block|,
name|TELJJY_STATE_BYE
block|}
block|,
comment|/* ERROR      */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_DAILOUT
block|,
name|TELJJY_STATE_BYE
block|,
name|TELJJY_STATE_BYE
block|,
name|TELJJY_STATE_BYE
block|}
block|,
comment|/* SILENT     */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_DAILOUT
block|,
name|TELJJY_STATE_LOGIN
block|,
name|TELJJY_STATE_CONNECT
block|,
name|TELJJY_STATE_BYE
block|}
block|,
comment|/* TIMEOUT    */
block|{
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_IDLE
block|,
name|TELJJY_STATE_BYE
block|,
name|TELJJY_STATE_BYE
block|,
name|TELJJY_STATE_BYE
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|iTeljjyPostEvent
index|[ ]
index|[
literal|5
index|]
init|=
block|{
comment|/*STATE_IDLE         STATE_DAILOUT      STATE_LOGIN           STATE_CONNECT         STATE_BYE         */
comment|/* NULL       */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* START      */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* CONNECT    */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* DISCONNECT */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* COMMAND    */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* LOGIN      */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_COMMAND
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* PROMPT     */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_PROMPT
block|,
name|TELJJY_EVENT_COMMAND
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* DATA       */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* ERROR      */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_COMMAND
block|,
name|TELJJY_EVENT_COMMAND
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* SILENT     */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|}
block|,
comment|/* TIMEOUT    */
block|{
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_NULL
block|,
name|TELJJY_EVENT_COMMAND
block|,
name|TELJJY_EVENT_COMMAND
block|,
name|TELJJY_EVENT_NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|iTeljjySilentTimeout
index|[
literal|5
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|10
block|,
literal|5
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|iTeljjyStateTimeout
index|[
literal|5
index|]
init|=
block|{
literal|0
block|,
literal|120
block|,
literal|60
block|,
literal|60
block|,
literal|40
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|TELJJY_STAY_CLOCK_STATE
value|0
end_define

begin_define
define|#
directive|define
name|TELJJY_CHANGE_CLOCK_STATE
value|1
end_define

begin_comment
comment|/* Command and replay */
end_comment

begin_define
define|#
directive|define
name|TELJJY_REPLY_NONE
value|0
end_define

begin_define
define|#
directive|define
name|TELJJY_REPLY_4DATE
value|1
end_define

begin_define
define|#
directive|define
name|TELJJY_REPLY_TIME
value|2
end_define

begin_define
define|#
directive|define
name|TELJJY_REPLY_LEAPSEC
value|3
end_define

begin_define
define|#
directive|define
name|TELJJY_REPLY_LOOP
value|4
end_define

begin_define
define|#
directive|define
name|TELJJY_REPLY_PROMPT
value|5
end_define

begin_define
define|#
directive|define
name|TELJJY_REPLY_LOOPBACK
value|6
end_define

begin_define
define|#
directive|define
name|TELJJY_REPLY_COM
value|7
end_define

begin_define
define|#
directive|define
name|TELJJY_COMMAND_START_SKIP_LOOPBACK
value|7
end_define

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|command
decl_stmt|;
name|int
name|commandLength
decl_stmt|;
name|int
name|iEchobackReplyLength
decl_stmt|;
name|int
name|iExpectedReplyType
decl_stmt|;
name|int
name|iExpectedReplyLength
decl_stmt|;
block|}
name|teljjy_command_sequence
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* Idle */
block|{
literal|"LOOP\r"
block|,
literal|5
block|,
literal|4
block|,
name|TELJJY_REPLY_LOOP
block|,
literal|0
block|}
block|,
comment|/* Getting into loopback mode */
block|{
literal|">"
block|,
literal|1
block|,
literal|1
block|,
name|TELJJY_REPLY_LOOPBACK
block|,
literal|0
block|}
block|,
comment|/* Loopback measuring of delay time */
block|{
literal|">"
block|,
literal|1
block|,
literal|1
block|,
name|TELJJY_REPLY_LOOPBACK
block|,
literal|0
block|}
block|,
comment|/* Loopback measuring of delay time */
block|{
literal|">"
block|,
literal|1
block|,
literal|1
block|,
name|TELJJY_REPLY_LOOPBACK
block|,
literal|0
block|}
block|,
comment|/* Loopback measuring of delay time */
block|{
literal|">"
block|,
literal|1
block|,
literal|1
block|,
name|TELJJY_REPLY_LOOPBACK
block|,
literal|0
block|}
block|,
comment|/* Loopback measuring of delay time */
block|{
literal|">"
block|,
literal|1
block|,
literal|1
block|,
name|TELJJY_REPLY_LOOPBACK
block|,
literal|0
block|}
block|,
comment|/* Loopback measuring of delay time */
block|{
literal|"COM\r"
block|,
literal|4
block|,
literal|3
block|,
name|TELJJY_REPLY_COM
block|,
literal|0
block|}
block|,
comment|/* Exit from loopback mode */
comment|/* TELJJY_COMMAND_START_SKIP_LOOPBACK */
block|{
literal|"TIME\r"
block|,
literal|5
block|,
literal|4
block|,
name|TELJJY_REPLY_TIME
block|,
literal|6
block|}
block|,
block|{
literal|"4DATE\r"
block|,
literal|6
block|,
literal|5
block|,
name|TELJJY_REPLY_4DATE
block|,
literal|8
block|}
block|,
block|{
literal|"LEAPSEC\r"
block|,
literal|8
block|,
literal|7
block|,
name|TELJJY_REPLY_LEAPSEC
block|,
literal|2
block|}
block|,
block|{
literal|"TIME\r"
block|,
literal|5
block|,
literal|4
block|,
name|TELJJY_REPLY_TIME
block|,
literal|6
block|}
block|,
block|{
literal|"BYE\r"
block|,
literal|4
block|,
literal|3
block|,
name|TELJJY_REPLY_NONE
block|,
literal|0
block|}
block|,
comment|/* End of command */
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|TELJJY_LOOPBACK_DELAY_THRESHOLD
value|700
end_define

begin_comment
comment|/* Milli second */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DEBUG_TELJJY_PRINTF
parameter_list|(
name|sFunc
parameter_list|)
value|{ if ( debug ) { printf ( "refclock_jjy.c : %s : iClockState=%d iClockEvent=%d iTeljjySilentTimer=%d iTeljjyStateTimer=%d iClockCommandSeq=%d\n", sFunc, up->iClockState, up->iClockEvent, up->iTeljjySilentTimer, up->iTeljjyStateTimer, up->iClockCommandSeq ) ; } }
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DEBUG_TELJJY_PRINTF
parameter_list|(
name|sFunc
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_start_telephone
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|char
name|sLog
index|[
literal|80
index|]
decl_stmt|,
name|sFirstThreeDigits
index|[
literal|4
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|iNumberOfDigitsOfPhoneNumber
decl_stmt|,
name|iCommaCount
decl_stmt|,
name|iCommaPosition
decl_stmt|;
name|int
name|iFirstThreeDigitsCount
decl_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
literal|"Refclock: Telephone JJY"
argument_list|)
expr_stmt|;
name|up
operator|->
name|unittype
operator|=
name|UNITTYPE_TELEPHONE
expr_stmt|;
name|up
operator|->
name|linespeed
operator|=
name|SPEED232_TELEPHONE
expr_stmt|;
name|up
operator|->
name|linediscipline
operator|=
name|LDISC_RAW
expr_stmt|;
name|up
operator|->
name|pRawBreak
operator|=
name|teljjy_raw_break
expr_stmt|;
name|up
operator|->
name|bWaitBreakString
operator|=
name|TRUE
expr_stmt|;
name|up
operator|->
name|bSkipCntrlCharOnly
operator|=
name|TRUE
expr_stmt|;
name|up
operator|->
name|iClockState
operator|=
name|TELJJY_STATE_IDLE
expr_stmt|;
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_NULL
expr_stmt|;
comment|/* Check the telephone number */
if|if
condition|(
name|sys_phone
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"refclock_jjy.c : jjy_start_telephone : phone in the ntpd.conf must be specified."
argument_list|)
expr_stmt|;
name|up
operator|->
name|bInitError
operator|=
name|TRUE
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|sys_phone
index|[
literal|1
index|]
operator|!=
name|NULL
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"refclock_jjy.c : jjy_start_telephone : phone in the ntpd.conf should be only one."
argument_list|)
expr_stmt|;
name|up
operator|->
name|bInitError
operator|=
name|TRUE
expr_stmt|;
return|return
literal|1
return|;
block|}
name|iNumberOfDigitsOfPhoneNumber
operator|=
name|iCommaCount
operator|=
name|iCommaPosition
operator|=
name|iFirstThreeDigitsCount
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|sys_phone
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isdigit
argument_list|(
operator|(
name|u_char
operator|)
name|sys_phone
index|[
literal|0
index|]
index|[
name|i
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|iFirstThreeDigitsCount
operator|<
sizeof|sizeof
argument_list|(
name|sFirstThreeDigits
argument_list|)
operator|-
literal|1
condition|)
block|{
name|sFirstThreeDigits
index|[
name|iFirstThreeDigitsCount
operator|++
index|]
operator|=
name|sys_phone
index|[
literal|0
index|]
index|[
name|i
index|]
expr_stmt|;
block|}
name|iNumberOfDigitsOfPhoneNumber
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sys_phone
index|[
literal|0
index|]
index|[
name|i
index|]
operator|==
literal|','
condition|)
block|{
name|iCommaCount
operator|++
expr_stmt|;
if|if
condition|(
name|iCommaCount
operator|>
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"refclock_jjy.c : jjy_start_telephone : phone in the ntpd.conf should be zero or one comma."
argument_list|)
expr_stmt|;
name|up
operator|->
name|bInitError
operator|=
name|TRUE
expr_stmt|;
return|return
literal|1
return|;
block|}
name|iFirstThreeDigitsCount
operator|=
literal|0
expr_stmt|;
name|iCommaPosition
operator|=
name|i
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sys_phone
index|[
literal|0
index|]
index|[
name|i
index|]
operator|!=
literal|'-'
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"refclock_jjy.c : jjy_start_telephone : phone in the ntpd.conf should be a number or a hyphen."
argument_list|)
expr_stmt|;
name|up
operator|->
name|bInitError
operator|=
name|TRUE
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
name|sFirstThreeDigits
index|[
name|iFirstThreeDigitsCount
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iCommaCount
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|iCommaPosition
operator|!=
literal|1
operator|||
operator|*
name|sys_phone
index|[
literal|0
index|]
operator|!=
literal|'0'
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"refclock_jjy.c : jjy_start_telephone : Getting an outside line should be '0,'."
argument_list|)
expr_stmt|;
name|up
operator|->
name|bInitError
operator|=
name|TRUE
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
if|if
condition|(
name|iNumberOfDigitsOfPhoneNumber
operator|-
name|iCommaPosition
operator|<
literal|6
operator|||
literal|10
operator|<
name|iNumberOfDigitsOfPhoneNumber
operator|-
name|iCommaPosition
condition|)
block|{
comment|/* Too short or too long */
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"refclock_jjy.c : jjy_start_telephone : phone=%s : Number of digits should be 6 to 10."
argument_list|,
name|sys_phone
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|up
operator|->
name|bInitError
operator|=
name|TRUE
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|sFirstThreeDigits
operator|+
name|iCommaPosition
argument_list|,
literal|"00"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|sFirstThreeDigits
operator|+
name|iCommaPosition
argument_list|,
literal|"10"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|sFirstThreeDigits
operator|+
name|iCommaPosition
argument_list|,
literal|"11"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|sFirstThreeDigits
operator|+
name|iCommaPosition
argument_list|,
literal|"12"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|sFirstThreeDigits
operator|+
name|iCommaPosition
argument_list|,
literal|"171"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|sFirstThreeDigits
operator|+
name|iCommaPosition
argument_list|,
literal|"177"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
operator|(
name|sFirstThreeDigits
index|[
literal|0
index|]
operator|==
literal|'0'
operator|&&
name|sFirstThreeDigits
index|[
literal|2
index|]
operator|==
literal|'0'
operator|)
condition|)
block|{
comment|/* Not allowed because of emergency numbers or special service numbers */
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"refclock_jjy.c : jjy_start_telephone : phone=%s : First 2 or 3 digits are not allowed."
argument_list|,
name|sys_phone
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|up
operator|->
name|bInitError
operator|=
name|TRUE
expr_stmt|;
return|return
literal|1
return|;
block|}
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
literal|"phone=%s"
argument_list|,
name|sys_phone
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|minpoll
operator|<
literal|8
condition|)
block|{
comment|/* minpoll must be greater or equal to 8 ( 256 seconds = about 4 minutes ) */
name|int
name|oldminpoll
init|=
name|peer
operator|->
name|minpoll
decl_stmt|;
name|peer
operator|->
name|minpoll
operator|=
literal|8
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|ppoll
operator|<
name|peer
operator|->
name|minpoll
condition|)
block|{
name|peer
operator|->
name|ppoll
operator|=
name|peer
operator|->
name|minpoll
expr_stmt|;
block|}
if|if
condition|(
name|peer
operator|->
name|maxpoll
operator|<
name|peer
operator|->
name|minpoll
condition|)
block|{
name|peer
operator|->
name|maxpoll
operator|=
name|peer
operator|->
name|minpoll
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
literal|"minpoll=%d -> %d"
argument_list|,
name|oldminpoll
argument_list|,
name|peer
operator|->
name|minpoll
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_JJY
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|jjy_receive_telephone
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
specifier|static
specifier|const
name|char
modifier|*
name|sFunctionName
init|=
literal|"jjy_receive_telephone"
decl_stmt|;
endif|#
directive|endif
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|char
modifier|*
name|pBuf
decl_stmt|;
name|int
name|iLen
decl_stmt|;
name|short
name|iPreviousModemState
decl_stmt|;
name|peer
operator|=
name|rbufp
operator|->
name|recv_peer
expr_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|DEBUG_TELJJY_PRINTF
argument_list|(
name|sFunctionName
argument_list|)
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|iClockState
operator|==
name|TELJJY_STATE_IDLE
operator|||
name|up
operator|->
name|iClockState
operator|==
name|TELJJY_STATE_DAILOUT
operator|||
name|up
operator|->
name|iClockState
operator|==
name|TELJJY_STATE_BYE
condition|)
block|{
name|iPreviousModemState
operator|=
name|getModemState
argument_list|(
name|up
argument_list|)
expr_stmt|;
name|modem_receive
argument_list|(
name|rbufp
argument_list|)
expr_stmt|;
if|if
condition|(
name|iPreviousModemState
operator|!=
name|up
operator|->
name|iModemState
condition|)
block|{
comment|/* Modem state is changed just now. */
if|if
condition|(
name|isModemStateDisconnect
argument_list|(
name|up
operator|->
name|iModemState
argument_list|)
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_DISCONNECT
expr_stmt|;
name|teljjy_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isModemStateConnect
argument_list|(
name|up
operator|->
name|iModemState
argument_list|)
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_CONNECT
expr_stmt|;
name|teljjy_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|JJY_RECEIVE_WAIT
return|;
block|}
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sTextBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iTextBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
name|up
operator|->
name|iTeljjySilentTimer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iLen
operator|==
literal|7
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"Name ? "
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_LOGIN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|==
literal|1
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|">"
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_PROMPT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|>=
literal|1
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"?"
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_ERROR
expr_stmt|;
block|}
else|else
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_DATA
expr_stmt|;
block|}
name|teljjy_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
return|return
name|JJY_RECEIVE_WAIT
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_poll_telephone
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
specifier|static
specifier|const
name|char
modifier|*
name|sFunctionName
init|=
literal|"jjy_poll_telephone"
decl_stmt|;
endif|#
directive|endif
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|DEBUG_TELJJY_PRINTF
argument_list|(
name|sFunctionName
argument_list|)
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|iClockState
operator|==
name|TELJJY_STATE_IDLE
condition|)
block|{
name|up
operator|->
name|iRawBufLen
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iLineBufLen
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iTextBufLen
operator|=
literal|0
expr_stmt|;
block|}
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_START
expr_stmt|;
name|teljjy_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|jjy_timer_telephone
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
specifier|static
specifier|const
name|char
modifier|*
name|sFunctionName
init|=
literal|"jjy_timer_telephone"
decl_stmt|;
endif|#
directive|endif
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|short
name|iPreviousModemState
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|DEBUG_TELJJY_PRINTF
argument_list|(
name|sFunctionName
argument_list|)
expr_stmt|;
if|if
condition|(
name|iTeljjySilentTimeout
index|[
name|up
operator|->
name|iClockState
index|]
operator|!=
literal|0
condition|)
block|{
name|up
operator|->
name|iTeljjySilentTimer
operator|++
expr_stmt|;
if|if
condition|(
name|iTeljjySilentTimeout
index|[
name|up
operator|->
name|iClockState
index|]
operator|<=
name|up
operator|->
name|iTeljjySilentTimer
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_SILENT
expr_stmt|;
name|teljjy_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|iTeljjyStateTimeout
index|[
name|up
operator|->
name|iClockState
index|]
operator|!=
literal|0
condition|)
block|{
name|up
operator|->
name|iTeljjyStateTimer
operator|++
expr_stmt|;
if|if
condition|(
name|iTeljjyStateTimeout
index|[
name|up
operator|->
name|iClockState
index|]
operator|<=
name|up
operator|->
name|iTeljjyStateTimer
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_TIMEOUT
expr_stmt|;
name|teljjy_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|isModemStateTimerOn
argument_list|(
name|up
argument_list|)
condition|)
block|{
name|iPreviousModemState
operator|=
name|getModemState
argument_list|(
name|up
argument_list|)
expr_stmt|;
name|modem_timer
argument_list|(
name|unit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|iPreviousModemState
operator|!=
name|up
operator|->
name|iModemState
condition|)
block|{
comment|/* Modem state is changed just now. */
if|if
condition|(
name|isModemStateDisconnect
argument_list|(
name|up
operator|->
name|iModemState
argument_list|)
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_DISCONNECT
expr_stmt|;
name|teljjy_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isModemStateConnect
argument_list|(
name|up
operator|->
name|iModemState
argument_list|)
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_CONNECT
expr_stmt|;
name|teljjy_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|teljjy_control
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|;
name|short
name|iPostEvent
init|=
name|TELJJY_EVENT_NULL
decl_stmt|;
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_control"
argument_list|)
expr_stmt|;
name|rc
operator|=
call|(
modifier|*
name|pTeljjyHandler
index|[
name|up
operator|->
name|iClockEvent
index|]
index|[
name|up
operator|->
name|iClockState
index|]
call|)
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|TELJJY_CHANGE_CLOCK_STATE
condition|)
block|{
name|iPostEvent
operator|=
name|iTeljjyPostEvent
index|[
name|up
operator|->
name|iClockEvent
index|]
index|[
name|up
operator|->
name|iClockState
index|]
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : teljjy_control : iClockState=%hd -> %hd  iPostEvent=%hd\n"
argument_list|,
name|up
operator|->
name|iClockState
argument_list|,
name|iTeljjyNextState
index|[
name|up
operator|->
name|iClockEvent
index|]
index|[
name|up
operator|->
name|iClockState
index|]
argument_list|,
name|iPostEvent
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|up
operator|->
name|iTeljjySilentTimer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|iClockState
operator|!=
name|iTeljjyNextState
index|[
name|up
operator|->
name|iClockEvent
index|]
index|[
name|up
operator|->
name|iClockState
index|]
condition|)
block|{
comment|/* Telephone JJY state is changing now */
name|up
operator|->
name|iTeljjyStateTimer
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|FALSE
expr_stmt|;
name|up
operator|->
name|iClockCommandSeq
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iTimestampCount
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iLoopbackCount
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LOOPBACK
condition|;
name|i
operator|++
control|)
block|{
name|up
operator|->
name|bLoopbackTimeout
index|[
name|i
index|]
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|iTeljjyNextState
index|[
name|up
operator|->
name|iClockEvent
index|]
index|[
name|up
operator|->
name|iClockState
index|]
operator|==
name|TELJJY_STATE_IDLE
condition|)
block|{
comment|/* Telephone JJY state is changing to IDLE just now */
name|up
operator|->
name|iProcessState
operator|=
name|JJY_PROCESS_STATE_DONE
expr_stmt|;
block|}
block|}
name|up
operator|->
name|iClockState
operator|=
name|iTeljjyNextState
index|[
name|up
operator|->
name|iClockEvent
index|]
index|[
name|up
operator|->
name|iClockState
index|]
expr_stmt|;
block|}
if|if
condition|(
name|iPostEvent
operator|!=
name|TELJJY_EVENT_NULL
condition|)
block|{
name|up
operator|->
name|iClockEvent
operator|=
name|iPostEvent
expr_stmt|;
name|teljjy_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
name|up
operator|->
name|iClockEvent
operator|=
name|TELJJY_EVENT_NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|teljjy_setDelay
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|char
name|sLog
index|[
literal|60
index|]
decl_stmt|;
name|int
name|milliSecond
decl_stmt|,
name|microSecond
decl_stmt|;
name|gettimeofday
argument_list|(
operator|&
operator|(
name|up
operator|->
name|delayTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|up
operator|->
name|delayTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_sec
operator|-=
name|up
operator|->
name|sendTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_sec
expr_stmt|;
name|up
operator|->
name|delayTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_usec
operator|-=
name|up
operator|->
name|sendTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_usec
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|delayTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_usec
operator|<
literal|0
condition|)
block|{
name|up
operator|->
name|delayTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_sec
operator|--
expr_stmt|;
name|up
operator|->
name|delayTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
block|}
name|milliSecond
operator|=
name|up
operator|->
name|delayTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_usec
operator|/
literal|1000
expr_stmt|;
name|microSecond
operator|=
name|up
operator|->
name|delayTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_usec
operator|-
name|milliSecond
operator|*
literal|1000
expr_stmt|;
name|milliSecond
operator|+=
name|up
operator|->
name|delayTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|.
name|tv_sec
operator|*
literal|1000
expr_stmt|;
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_LOOPBACK_DELAY
argument_list|,
name|milliSecond
argument_list|,
name|microSecond
argument_list|)
expr_stmt|;
if|if
condition|(
name|milliSecond
operator|>
name|TELJJY_LOOPBACK_DELAY_THRESHOLD
condition|)
block|{
comment|/* Delay> 700 mS */
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_WARNING
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Delay<= 700 mS */
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_INFORMATION
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_getDelay
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|struct
name|timeval
name|maxTime
decl_stmt|,
name|minTime
decl_stmt|,
name|averTime
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|minIndex
init|=
literal|0
decl_stmt|,
name|maxIndex
init|=
literal|0
decl_stmt|,
name|iAverCount
init|=
literal|0
decl_stmt|;
name|int
name|iThresholdSecond
decl_stmt|,
name|iThresholdMicroSecond
decl_stmt|;
name|int
name|iPercent
decl_stmt|;
name|minTime
operator|.
name|tv_sec
operator|=
name|minTime
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|maxTime
operator|.
name|tv_sec
operator|=
name|maxTime
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|iThresholdSecond
operator|=
name|TELJJY_LOOPBACK_DELAY_THRESHOLD
operator|/
literal|1000
expr_stmt|;
name|iThresholdMicroSecond
operator|=
operator|(
name|TELJJY_LOOPBACK_DELAY_THRESHOLD
operator|-
operator|(
name|TELJJY_LOOPBACK_DELAY_THRESHOLD
operator|/
literal|1000
operator|)
operator|*
literal|1000
operator|)
operator|*
literal|1000
expr_stmt|;
name|up
operator|->
name|iLoopbackValidCount
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LOOPBACK
operator|&&
name|i
operator|<
name|up
operator|->
name|iLoopbackCount
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|up
operator|->
name|bLoopbackTimeout
index|[
name|i
index|]
operator|||
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
operator|>
name|iThresholdSecond
operator|||
operator|(
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
operator|==
name|iThresholdSecond
operator|&&
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_usec
operator|>
name|iThresholdMicroSecond
operator|)
condition|)
block|{
continue|continue ;
block|}
if|if
condition|(
name|up
operator|->
name|iLoopbackValidCount
operator|==
literal|0
condition|)
block|{
name|minTime
operator|.
name|tv_sec
operator|=
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
expr_stmt|;
name|minTime
operator|.
name|tv_usec
operator|=
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_usec
expr_stmt|;
name|maxTime
operator|.
name|tv_sec
operator|=
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
expr_stmt|;
name|maxTime
operator|.
name|tv_usec
operator|=
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_usec
expr_stmt|;
name|minIndex
operator|=
name|maxIndex
operator|=
name|i
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|minTime
operator|.
name|tv_sec
operator|>
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
operator|||
operator|(
name|minTime
operator|.
name|tv_sec
operator|==
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
operator|&&
name|minTime
operator|.
name|tv_usec
operator|>
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_usec
operator|)
condition|)
block|{
name|minTime
operator|.
name|tv_sec
operator|=
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
expr_stmt|;
name|minTime
operator|.
name|tv_usec
operator|=
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_usec
expr_stmt|;
name|minIndex
operator|=
name|i
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|maxTime
operator|.
name|tv_sec
operator|<
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
operator|||
operator|(
name|maxTime
operator|.
name|tv_sec
operator|==
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
operator|&&
name|maxTime
operator|.
name|tv_usec
operator|<
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_usec
operator|)
condition|)
block|{
name|maxTime
operator|.
name|tv_sec
operator|=
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
expr_stmt|;
name|maxTime
operator|.
name|tv_usec
operator|=
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_usec
expr_stmt|;
name|maxIndex
operator|=
name|i
expr_stmt|;
block|}
name|up
operator|->
name|iLoopbackValidCount
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|up
operator|->
name|iLoopbackValidCount
operator|<
literal|2
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|averTime
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LOOPBACK
operator|&&
name|i
operator|<
name|up
operator|->
name|iLoopbackCount
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|up
operator|->
name|bLoopbackTimeout
index|[
name|i
index|]
operator|||
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
operator|>
name|iThresholdSecond
operator|||
operator|(
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_sec
operator|==
name|iThresholdSecond
operator|&&
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_usec
operator|>
name|iThresholdMicroSecond
operator|)
condition|)
block|{
continue|continue ;
block|}
if|if
condition|(
name|up
operator|->
name|iLoopbackValidCount
operator|>=
literal|3
operator|&&
name|i
operator|==
name|maxIndex
condition|)
block|{
continue|continue ;
block|}
if|if
condition|(
name|up
operator|->
name|iLoopbackValidCount
operator|>=
literal|4
operator|&&
name|i
operator|==
name|minIndex
condition|)
block|{
continue|continue ;
block|}
name|averTime
operator|.
name|tv_usec
operator|+=
name|up
operator|->
name|delayTime
index|[
name|i
index|]
operator|.
name|tv_usec
expr_stmt|;
name|iAverCount
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|iAverCount
operator|==
literal|0
condition|)
block|{
comment|/* This is never happened. */
comment|/* Previous for-if-for blocks assure iAverCount> 0. */
comment|/* This code avoids a claim by the coverity scan tool. */
return|return
operator|-
literal|1
return|;
block|}
comment|/* mode 101 = 1%, mode 150 = 50%, mode 180 = 80% */
name|iPercent
operator|=
operator|(
name|peer
operator|->
name|ttl
operator|-
literal|100
operator|)
expr_stmt|;
comment|/* Average delay time in milli second */
return|return
operator|(
operator|(
name|averTime
operator|.
name|tv_usec
operator|/
name|iAverCount
operator|)
operator|*
name|iPercent
operator|)
operator|/
literal|100000
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_idle_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_idle_ignore"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_STAY_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_idle_dialout
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_idle_dialout"
argument_list|)
expr_stmt|;
name|modem_connect
argument_list|(
name|peer
operator|->
name|refclkunit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_dial_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_dial_ignore"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_STAY_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_dial_login
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_dial_login"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_dial_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_dial_disc"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_login_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_login_ignore"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_STAY_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_login_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_login_disc"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_login_conn
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_login_conn"
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|FALSE
expr_stmt|;
name|up
operator|->
name|iClockCommandSeq
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iTimestampCount
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iLoopbackCount
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LOOPBACK
condition|;
name|i
operator|++
control|)
block|{
name|up
operator|->
name|bLoopbackTimeout
index|[
name|i
index|]
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_login_login
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|int
name|iCmdLen
decl_stmt|;
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_login_login"
argument_list|)
expr_stmt|;
comment|/* Send a guest user ID */
name|pCmd
operator|=
literal|"TJJY\r"
expr_stmt|;
comment|/* Send login ID */
name|iCmdLen
operator|=
name|strlen
argument_list|(
name|pCmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
name|iCmdLen
argument_list|)
operator|!=
name|iCmdLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
return|return
name|TELJJY_STAY_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_login_silent
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_login_silent"
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
literal|"\r"
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
literal|"\r"
argument_list|)
expr_stmt|;
name|up
operator|->
name|iTeljjySilentTimer
operator|=
literal|0
expr_stmt|;
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_login_error
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_login_error"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_conn_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_conn_ignore"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_STAY_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_conn_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_conn_disc"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_conn_send
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|int
name|i
decl_stmt|,
name|iLen
decl_stmt|,
name|iNextClockState
decl_stmt|;
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_conn_send"
argument_list|)
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|iClockCommandSeq
operator|>
literal|0
operator|&&
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|command
operator|==
name|NULL
condition|)
block|{
comment|/* Command sequence has been completed */
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
if|if
condition|(
name|up
operator|->
name|iClockCommandSeq
operator|==
literal|0
operator|&&
name|peer
operator|->
name|ttl
operator|==
literal|100
condition|)
block|{
comment|/* Skip loopback */
name|up
operator|->
name|iClockCommandSeq
operator|=
name|TELJJY_COMMAND_START_SKIP_LOOPBACK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|up
operator|->
name|iClockCommandSeq
operator|==
literal|0
operator|&&
name|peer
operator|->
name|ttl
operator|!=
literal|100
condition|)
block|{
comment|/* Loopback start */
name|up
operator|->
name|iLoopbackCount
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_LOOPBACK
condition|;
name|i
operator|++
control|)
block|{
name|up
operator|->
name|bLoopbackTimeout
index|[
name|i
index|]
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|up
operator|->
name|iClockCommandSeq
operator|>
literal|0
operator|&&
name|peer
operator|->
name|ttl
operator|!=
literal|100
operator|&&
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyType
operator|==
name|TELJJY_REPLY_LOOPBACK
operator|&&
name|up
operator|->
name|iLoopbackCount
operator|<
name|MAX_LOOPBACK
condition|)
block|{
comment|/* Loopback character comes */
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : teljjy_conn_send : iLoopbackCount=%d\n"
argument_list|,
name|up
operator|->
name|iLoopbackCount
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|teljjy_setDelay
argument_list|(
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
name|up
operator|->
name|iLoopbackCount
operator|++
expr_stmt|;
block|}
name|up
operator|->
name|iClockCommandSeq
operator|++
expr_stmt|;
name|pCmd
operator|=
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|command
expr_stmt|;
name|iLen
operator|=
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|commandLength
expr_stmt|;
if|if
condition|(
name|pCmd
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
name|iLen
argument_list|)
operator|!=
name|iLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyType
operator|==
name|TELJJY_REPLY_LOOPBACK
condition|)
block|{
comment|/* Loopback character and timestamp */
name|gettimeofday
argument_list|(
operator|&
operator|(
name|up
operator|->
name|sendTime
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLoopbackMode
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
comment|/* Regular command */
name|up
operator|->
name|bLoopbackMode
operator|=
name|FALSE
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
operator|+
literal|1
index|]
operator|.
name|command
operator|==
name|NULL
condition|)
block|{
comment|/* Last command of the command sequence */
name|iNextClockState
operator|=
name|TELJJY_CHANGE_CLOCK_STATE
expr_stmt|;
block|}
else|else
block|{
comment|/* More commands to be issued */
name|iNextClockState
operator|=
name|TELJJY_STAY_CLOCK_STATE
expr_stmt|;
block|}
block|}
else|else
block|{
name|iNextClockState
operator|=
name|TELJJY_CHANGE_CLOCK_STATE
expr_stmt|;
block|}
return|return
name|iNextClockState
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_conn_data
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|char
modifier|*
name|pBuf
decl_stmt|;
name|int
name|iLen
decl_stmt|,
name|rc
decl_stmt|;
name|char
name|sLog
index|[
literal|80
index|]
decl_stmt|;
name|char
name|bAdjustment
decl_stmt|;
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_conn_data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sTextBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iTextBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
if|if
condition|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iEchobackReplyLength
operator|==
name|iLen
operator|&&
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyType
operator|==
name|TELJJY_REPLY_LOOPBACK
operator|&&
name|up
operator|->
name|sTextBuf
index|[
literal|0
index|]
operator|==
operator|*
operator|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|command
operator|)
operator|&&
name|up
operator|->
name|iLoopbackCount
operator|<
name|MAX_LOOPBACK
condition|)
block|{
comment|/* Loopback */
name|teljjy_setDelay
argument_list|(
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
name|up
operator|->
name|iLoopbackCount
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iEchobackReplyLength
operator|==
name|iLen
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|command
argument_list|,
name|iLen
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Maybe echoback */
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_INFORMATION
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_ECHOBACK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyLength
operator|==
name|iLen
operator|&&
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyType
operator|==
name|TELJJY_REPLY_4DATE
condition|)
block|{
comment|/* 4DATE<CR> -> YYYYMMDD<CR> */
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%4d%2d%2d"
argument_list|,
operator|&
name|up
operator|->
name|year
argument_list|,
operator|&
name|up
operator|->
name|month
argument_list|,
operator|&
name|up
operator|->
name|day
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|3
operator|||
name|up
operator|->
name|year
operator|<
literal|2000
operator|||
literal|2099
operator|<=
name|up
operator|->
name|year
operator|||
name|up
operator|->
name|month
operator|<
literal|1
operator|||
literal|12
operator|<
name|up
operator|->
name|month
operator|||
name|up
operator|->
name|day
operator|<
literal|1
operator|||
literal|31
operator|<
name|up
operator|->
name|day
condition|)
block|{
comment|/* Invalid date */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_DATE
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|year
argument_list|,
name|up
operator|->
name|month
argument_list|,
name|up
operator|->
name|day
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyLength
operator|==
name|iLen
operator|&&
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyType
operator|==
name|TELJJY_REPLY_LEAPSEC
operator|&&
operator|(
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|" 0"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"+1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"-1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* LEAPSEC<CR> -> XX<CR> ( One of<SP>0, +1, -1 ) */
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%2d"
argument_list|,
operator|&
name|up
operator|->
name|leapsecond
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|1
operator|||
name|up
operator|->
name|leapsecond
operator|<
operator|-
literal|1
operator|||
literal|1
operator|<
name|up
operator|->
name|leapsecond
condition|)
block|{
comment|/* Invalid leap second */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_LEAP
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyLength
operator|==
name|iLen
operator|&&
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyType
operator|==
name|TELJJY_REPLY_TIME
condition|)
block|{
comment|/* TIME<CR> -> HHMMSS<CR> ( 3 times on second ) */
name|rc
operator|=
name|sscanf
argument_list|(
name|pBuf
argument_list|,
literal|"%2d%2d%2d"
argument_list|,
operator|&
name|up
operator|->
name|hour
argument_list|,
operator|&
name|up
operator|->
name|minute
argument_list|,
operator|&
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|3
operator|||
name|up
operator|->
name|hour
operator|>
literal|23
operator|||
name|up
operator|->
name|minute
operator|>
literal|59
operator|||
name|up
operator|->
name|second
operator|>
literal|60
condition|)
block|{
comment|/* Invalid time */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_SSCANF_INVALID_TIME
argument_list|,
name|rc
argument_list|,
name|up
operator|->
name|hour
argument_list|,
name|up
operator|->
name|minute
argument_list|,
name|up
operator|->
name|second
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
block|}
name|up
operator|->
name|iTimestamp
index|[
name|up
operator|->
name|iTimestampCount
index|]
operator|=
operator|(
name|up
operator|->
name|hour
operator|*
literal|60
operator|+
name|up
operator|->
name|minute
operator|)
operator|*
literal|60
operator|+
name|up
operator|->
name|second
expr_stmt|;
name|up
operator|->
name|iTimestampCount
operator|++
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|iTimestampCount
operator|==
literal|6
operator|&&
operator|!
name|up
operator|->
name|bLineError
condition|)
block|{
if|#
directive|if
name|DEBUG
name|printf
argument_list|(
literal|"refclock_jjy.c : teljjy_conn_data : bLineError=%d iTimestamp=%d, %d, %d\n"
argument_list|,
name|up
operator|->
name|bLineError
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|3
index|]
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|4
index|]
argument_list|,
name|up
operator|->
name|iTimestamp
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|bAdjustment
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|ttl
operator|==
literal|100
condition|)
block|{
comment|/* mode=100 */
name|up
operator|->
name|msecond
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* mode=101 to 110 */
name|up
operator|->
name|msecond
operator|=
name|teljjy_getDelay
argument_list|(
name|peer
argument_list|,
name|up
argument_list|)
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|msecond
operator|<
literal|0
condition|)
block|{
name|up
operator|->
name|msecond
operator|=
literal|0
expr_stmt|;
name|bAdjustment
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|up
operator|->
name|iTimestamp
index|[
literal|3
index|]
operator|-
literal|15
operator|)
operator|<=
name|up
operator|->
name|iTimestamp
index|[
literal|2
index|]
operator|&&
name|up
operator|->
name|iTimestamp
index|[
literal|2
index|]
operator|<=
name|up
operator|->
name|iTimestamp
index|[
literal|3
index|]
operator|&&
operator|(
name|up
operator|->
name|iTimestamp
index|[
literal|3
index|]
operator|+
literal|1
operator|)
operator|==
name|up
operator|->
name|iTimestamp
index|[
literal|4
index|]
operator|&&
operator|(
name|up
operator|->
name|iTimestamp
index|[
literal|4
index|]
operator|+
literal|1
operator|)
operator|==
name|up
operator|->
name|iTimestamp
index|[
literal|5
index|]
condition|)
block|{
comment|/* Non over midnight */
name|jjy_synctime
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|ttl
operator|!=
literal|100
condition|)
block|{
if|if
condition|(
name|bAdjustment
condition|)
block|{
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_DELAY_ADJUST
argument_list|,
name|up
operator|->
name|msecond
argument_list|,
name|up
operator|->
name|iLoopbackValidCount
argument_list|,
name|MAX_LOOPBACK
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_INFORMATION
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_DELAY_UNADJUST
argument_list|,
name|up
operator|->
name|iLoopbackValidCount
argument_list|,
name|MAX_LOOPBACK
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iEchobackReplyLength
operator|!=
name|iLen
operator|&&
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyType
operator|==
name|TELJJY_REPLY_LOOPBACK
condition|)
block|{
comment|/* Loopback noise ( Unexpected replay ) */
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_IGNORE_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_WARNING
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|up
operator|->
name|bLineError
operator|=
name|TRUE
expr_stmt|;
name|snprintf
argument_list|(
name|sLog
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
literal|1
argument_list|,
name|JJY_CLOCKSTATS_MESSAGE_UNEXPECTED_REPLY
argument_list|,
name|pBuf
argument_list|)
expr_stmt|;
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_ERROR
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
return|return
name|TELJJY_STAY_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_conn_silent
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_conn_silent"
argument_list|)
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|iClockCommandSeq
operator|>=
literal|1
operator|&&
name|up
operator|->
name|iClockCommandSeq
operator|<
name|TELJJY_COMMAND_START_SKIP_LOOPBACK
condition|)
block|{
comment|/* Loopback */
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : teljjy_conn_silent : call teljjy_conn_send\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|teljjy_command_sequence
index|[
name|up
operator|->
name|iClockCommandSeq
index|]
operator|.
name|iExpectedReplyType
operator|==
name|TELJJY_REPLY_LOOPBACK
condition|)
block|{
name|up
operator|->
name|bLoopbackTimeout
index|[
name|up
operator|->
name|iLoopbackCount
index|]
operator|=
name|TRUE
expr_stmt|;
block|}
name|up
operator|->
name|iTeljjySilentTimer
operator|=
literal|0
expr_stmt|;
return|return
name|teljjy_conn_send
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
return|;
block|}
else|else
block|{
name|pCmd
operator|=
literal|"\r"
expr_stmt|;
block|}
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
name|up
operator|->
name|iTeljjySilentTimer
operator|=
literal|0
expr_stmt|;
return|return
name|TELJJY_STAY_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_conn_error
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_conn_error"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_bye_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_bye_ignore"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_STAY_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_bye_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_bye_disc"
argument_list|)
expr_stmt|;
return|return
name|TELJJY_CHANGE_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|teljjy_bye_modem
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_TELJJY_PRINTF
argument_list|(
literal|"teljjy_bye_modem"
argument_list|)
expr_stmt|;
name|modem_disconnect
argument_list|(
name|peer
operator|->
name|refclkunit
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
name|TELJJY_STAY_CLOCK_STATE
return|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    Modem control finite state machine							##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/* struct jjyunit.iModemState */
end_comment

begin_define
define|#
directive|define
name|MODEM_STATE_DISCONNECT
value|0
end_define

begin_define
define|#
directive|define
name|MODEM_STATE_INITIALIZE
value|1
end_define

begin_define
define|#
directive|define
name|MODEM_STATE_DAILING
value|2
end_define

begin_define
define|#
directive|define
name|MODEM_STATE_CONNECT
value|3
end_define

begin_define
define|#
directive|define
name|MODEM_STATE_ESCAPE
value|4
end_define

begin_comment
comment|/* struct jjyunit.iModemEvent */
end_comment

begin_define
define|#
directive|define
name|MODEM_EVENT_NULL
value|0
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_INITIALIZE
value|1
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_DIALOUT
value|2
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_DISCONNECT
value|3
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_OK
value|4
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_CONNECT
value|5
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_RING
value|6
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_NO_CARRIER
value|7
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_ERROR
value|8
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_CONNECT_X
value|9
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_NO_DAILTONE
value|10
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_BUSY
value|11
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_NO_ANSWER
value|12
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_RESP_UNKNOWN
value|13
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_SILENT
value|14
end_define

begin_define
define|#
directive|define
name|MODEM_EVENT_TIMEOUT
value|15
end_define

begin_comment
comment|/* Function prototypes */
end_comment

begin_function_decl
specifier|static
name|void
name|modem_control
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_disc_ignore
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_disc_init
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_init_ignore
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_init_start
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_init_disc
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_init_resp00
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_init_resp04
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_dial_ignore
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_dial_dialout
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_dial_escape
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_dial_connect
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_dial_disc
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_conn_ignore
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_conn_escape
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_esc_ignore
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_esc_escape
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_esc_data
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_esc_silent
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|modem_esc_disc
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
function_decl|(
modifier|*
name|pModemHandler
index|[ ]
index|[
literal|5
index|]
function_decl|)
parameter_list|(
name|struct
name|peer
modifier|*
parameter_list|,
name|struct
name|refclockproc
modifier|*
parameter_list|,
name|struct
name|jjyunit
modifier|*
parameter_list|)
init|=
block|{
comment|/*STATE_DISCONNECT   STATE_INITIALIZE   STATE_DAILING       STATE_CONNECT      STATE_ESCAPE     */
comment|/* NULL                 */
block|{
name|modem_disc_ignore
operator|,
function_decl|modem_init_ignore
operator|,
function_decl|modem_dial_ignore
operator|,
function_decl|modem_conn_ignore
operator|,
function_decl|modem_esc_ignore
end_function_decl

begin_comment
unit|},
comment|/* INITIALIZE           */
end_comment

begin_block
block|{
name|modem_disc_init
operator|,
name|modem_init_start
operator|,
name|modem_dial_ignore
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_ignore
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* DIALOUT              */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_dialout
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_ignore
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* DISCONNECT           */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_disc
operator|,
name|modem_dial_escape
operator|,
name|modem_conn_escape
operator|,
name|modem_esc_escape
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 0: OK          */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_resp00
operator|,
name|modem_dial_ignore
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 1: CONNECT     */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_connect
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 2: RING        */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_ignore
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 3: NO CARRIER  */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_disc
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 4: ERROR       */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_resp04
operator|,
name|modem_dial_disc
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 5: CONNECT     */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_connect
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 6: NO DAILTONE */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_disc
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 7: BUSY        */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_disc
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 8: NO ANSWER   */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_disc
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* RESP: 9: UNKNOWN     */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_ignore
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_data
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* SILENT               */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_ignore
operator|,
name|modem_dial_ignore
operator|,
name|modem_conn_ignore
operator|,
name|modem_esc_silent
block|}
end_block

begin_operator
operator|,
end_operator

begin_comment
comment|/* TIMEOUT              */
end_comment

begin_block
block|{
name|modem_disc_ignore
operator|,
name|modem_init_disc
operator|,
name|modem_dial_escape
operator|,
name|modem_conn_escape
operator|,
name|modem_esc_disc
block|}
end_block

begin_decl_stmt
unit|} ;
specifier|static
name|short
name|iModemNextState
index|[ ]
index|[
literal|5
index|]
init|=
block|{
comment|/*STATE_DISCONNECT        STATE_INITIALIZE        STATE_DAILING        STATE_CONNECT        STATE_ESCAPE           */
comment|/* NULL                 */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DAILING
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* INITIALIZE           */
block|{
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DAILING
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* DIALOUT              */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DAILING
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* DISCONNECT           */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_ESCAPE
block|,
name|MODEM_STATE_ESCAPE
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 0: OK          */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_DAILING
block|,
name|MODEM_STATE_DAILING
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 1: CONNECT     */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 2: RING        */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DAILING
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 3: NO CARRIER  */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 4: ERROR       */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_DAILING
block|,
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 5: CONNECT X   */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 6: NO DAILTONE */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 7: BUSY        */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 8: NO ANSWER   */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* RESP: 9: UNKNOWN     */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DAILING
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_ESCAPE
block|}
block|,
comment|/* SILENT               */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_INITIALIZE
block|,
name|MODEM_STATE_DAILING
block|,
name|MODEM_STATE_CONNECT
block|,
name|MODEM_STATE_DISCONNECT
block|}
block|,
comment|/* TIMEOUT              */
block|{
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_DISCONNECT
block|,
name|MODEM_STATE_ESCAPE
block|,
name|MODEM_STATE_ESCAPE
block|,
name|MODEM_STATE_DISCONNECT
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|iModemPostEvent
index|[ ]
index|[
literal|5
index|]
init|=
block|{
comment|/*STATE_DISCONNECT        STATE_INITIALIZE     STATE_DAILING           STATE_CONNECT           STATE_ESCAPE     */
comment|/* NULL                 */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* INITIALIZE           */
block|{
name|MODEM_EVENT_INITIALIZE
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* DIALOUT              */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* DISCONNECT           */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_DISCONNECT
block|,
name|MODEM_EVENT_DISCONNECT
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 0: OK          */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_DIALOUT
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 1: CONNECT     */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 2: RING        */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 3: NO CARRIER  */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 4: ERROR       */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_DIALOUT
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 5: CONNECT X   */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 6: NO DAILTONE */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 7: BUSY        */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 8: NO ANSWER   */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* RESP: 9: UNKNOWN     */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* SILENT               */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|}
block|,
comment|/* TIMEOUT              */
block|{
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_NULL
block|,
name|MODEM_EVENT_DISCONNECT
block|,
name|MODEM_EVENT_DISCONNECT
block|,
name|MODEM_EVENT_NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|iModemSilentTimeout
index|[
literal|5
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|5
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|short
name|iModemStateTimeout
index|[
literal|5
index|]
init|=
block|{
literal|0
block|,
literal|20
block|,
literal|90
block|,
literal|0
block|,
literal|20
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|STAY_MODEM_STATE
value|0
end_define

begin_define
define|#
directive|define
name|CHANGE_MODEM_STATE
value|1
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DEBUG_MODEM_PRINTF
parameter_list|(
name|sFunc
parameter_list|)
value|{ if ( debug ) { printf ( "refclock_jjy.c : %s : iModemState=%d iModemEvent=%d iModemSilentTimer=%d iModemStateTimer=%d\n", sFunc, up->iModemState, up->iModemEvent, up->iModemSilentTimer, up->iModemStateTimer ) ; } }
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DEBUG_MODEM_PRINTF
parameter_list|(
name|sFunc
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|short
name|getModemState
parameter_list|(
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
return|return
name|up
operator|->
name|iModemState
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|isModemStateConnect
parameter_list|(
name|short
name|iCheckState
parameter_list|)
block|{
return|return
operator|(
name|iCheckState
operator|==
name|MODEM_STATE_CONNECT
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|isModemStateDisconnect
parameter_list|(
name|short
name|iCheckState
parameter_list|)
block|{
return|return
operator|(
name|iCheckState
operator|==
name|MODEM_STATE_DISCONNECT
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|isModemStateTimerOn
parameter_list|(
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
return|return
operator|(
name|iModemSilentTimeout
index|[
name|up
operator|->
name|iModemState
index|]
operator|!=
literal|0
operator|||
name|iModemStateTimeout
index|[
name|up
operator|->
name|iModemState
index|]
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|modem_connect
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_connect"
argument_list|)
expr_stmt|;
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_INITIALIZE
expr_stmt|;
name|modem_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|modem_disconnect
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_disconnect"
argument_list|)
expr_stmt|;
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_DISCONNECT
expr_stmt|;
name|modem_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|modem_receive
parameter_list|(
name|struct
name|recvbuf
modifier|*
name|rbufp
parameter_list|)
block|{
name|struct
name|peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|char
modifier|*
name|pBuf
decl_stmt|;
name|int
name|iLen
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
specifier|static
specifier|const
name|char
modifier|*
name|sFunctionName
init|=
literal|"modem_receive"
decl_stmt|;
endif|#
directive|endif
name|peer
operator|=
name|rbufp
operator|->
name|recv_peer
expr_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|DEBUG_MODEM_PRINTF
argument_list|(
name|sFunctionName
argument_list|)
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|linediscipline
operator|==
name|LDISC_RAW
condition|)
block|{
name|pBuf
operator|=
name|up
operator|->
name|sTextBuf
expr_stmt|;
name|iLen
operator|=
name|up
operator|->
name|iTextBufLen
expr_stmt|;
block|}
else|else
block|{
name|pBuf
operator|=
name|pp
operator|->
name|a_lastcode
expr_stmt|;
name|iLen
operator|=
name|pp
operator|->
name|lencode
expr_stmt|;
block|}
if|if
condition|(
name|iLen
operator|==
literal|2
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"OK"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_OK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|==
literal|7
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"CONNECT"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_CONNECT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|==
literal|4
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"RING"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_RING
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|==
literal|10
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"NO CARRIER"
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_NO_CARRIER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|==
literal|5
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"ERROR"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_ERROR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|>=
literal|8
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"CONNECT "
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_CONNECT_X
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|==
literal|11
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"NO DAILTONE"
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_NO_DAILTONE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|==
literal|4
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"BUSY"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_BUSY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|iLen
operator|==
literal|9
operator|&&
name|strncmp
argument_list|(
name|pBuf
argument_list|,
literal|"NO ANSWER"
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_NO_ANSWER
expr_stmt|;
block|}
else|else
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_RESP_UNKNOWN
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|char
name|sResp
index|[
literal|40
index|]
decl_stmt|;
name|int
name|iCopyLen
decl_stmt|;
name|iCopyLen
operator|=
operator|(
name|iLen
operator|<=
sizeof|sizeof
argument_list|(
name|sResp
argument_list|)
operator|-
literal|1
condition|?
name|iLen
else|:
sizeof|sizeof
argument_list|(
name|sResp
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|strncpy
argument_list|(
name|sResp
argument_list|,
name|pBuf
argument_list|,
name|iLen
operator|<=
sizeof|sizeof
argument_list|(
name|sResp
argument_list|)
operator|-
literal|1
condition|?
name|iLen
else|:
sizeof|sizeof
argument_list|(
name|sResp
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sResp
index|[
name|iCopyLen
index|]
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"refclock_jjy.c : modem_receive : iLen=%d pBuf=[%s] iModemEvent=%d\n"
argument_list|,
name|iCopyLen
argument_list|,
name|sResp
argument_list|,
name|up
operator|->
name|iModemEvent
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|modem_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|modem_timer
parameter_list|(
name|int
name|unit
parameter_list|,
name|struct
name|peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|refclockproc
modifier|*
name|pp
decl_stmt|;
name|struct
name|jjyunit
modifier|*
name|up
decl_stmt|;
name|pp
operator|=
name|peer
operator|->
name|procptr
expr_stmt|;
name|up
operator|=
name|pp
operator|->
name|unitptr
expr_stmt|;
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_timer"
argument_list|)
expr_stmt|;
if|if
condition|(
name|iModemSilentTimeout
index|[
name|up
operator|->
name|iModemState
index|]
operator|!=
literal|0
condition|)
block|{
name|up
operator|->
name|iModemSilentTimer
operator|++
expr_stmt|;
if|if
condition|(
name|iModemSilentTimeout
index|[
name|up
operator|->
name|iModemState
index|]
operator|<=
name|up
operator|->
name|iModemSilentTimer
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_SILENT
expr_stmt|;
name|modem_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|iModemStateTimeout
index|[
name|up
operator|->
name|iModemState
index|]
operator|!=
literal|0
condition|)
block|{
name|up
operator|->
name|iModemStateTimer
operator|++
expr_stmt|;
if|if
condition|(
name|iModemStateTimeout
index|[
name|up
operator|->
name|iModemState
index|]
operator|<=
name|up
operator|->
name|iModemStateTimer
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_TIMEOUT
expr_stmt|;
name|modem_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|modem_control
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|short
name|iPostEvent
init|=
name|MODEM_EVENT_NULL
decl_stmt|;
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_control"
argument_list|)
expr_stmt|;
name|rc
operator|=
call|(
modifier|*
name|pModemHandler
index|[
name|up
operator|->
name|iModemEvent
index|]
index|[
name|up
operator|->
name|iModemState
index|]
call|)
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|CHANGE_MODEM_STATE
condition|)
block|{
name|iPostEvent
operator|=
name|iModemPostEvent
index|[
name|up
operator|->
name|iModemEvent
index|]
index|[
name|up
operator|->
name|iModemState
index|]
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : modem_control : iModemState=%d -> %d  iPostEvent=%d\n"
argument_list|,
name|up
operator|->
name|iModemState
argument_list|,
name|iModemNextState
index|[
name|up
operator|->
name|iModemEvent
index|]
index|[
name|up
operator|->
name|iModemState
index|]
argument_list|,
name|iPostEvent
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|up
operator|->
name|iModemState
operator|!=
name|iModemNextState
index|[
name|up
operator|->
name|iModemEvent
index|]
index|[
name|up
operator|->
name|iModemState
index|]
condition|)
block|{
name|up
operator|->
name|iModemSilentCount
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iModemStateTimer
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|iModemCommandSeq
operator|=
literal|0
expr_stmt|;
block|}
name|up
operator|->
name|iModemState
operator|=
name|iModemNextState
index|[
name|up
operator|->
name|iModemEvent
index|]
index|[
name|up
operator|->
name|iModemState
index|]
expr_stmt|;
block|}
if|if
condition|(
name|iPostEvent
operator|!=
name|MODEM_EVENT_NULL
condition|)
block|{
name|up
operator|->
name|iModemEvent
operator|=
name|iPostEvent
expr_stmt|;
name|modem_control
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
block|}
name|up
operator|->
name|iModemEvent
operator|=
name|MODEM_EVENT_NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_disc_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_disc_ignore"
argument_list|)
expr_stmt|;
return|return
name|STAY_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_disc_init
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_disc_init"
argument_list|)
expr_stmt|;
return|return
name|CHANGE_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_init_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_init_ignore"
argument_list|)
expr_stmt|;
return|return
name|STAY_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_init_start
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_init_start"
argument_list|)
expr_stmt|;
name|up
operator|->
name|iModemCommandSeq
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : modem_init_start : call modem_init_resp00\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|modem_init_resp00
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_init_resp00
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|char
name|cBuf
index|[
literal|46
index|]
decl_stmt|;
name|int
name|iCmdLen
decl_stmt|;
name|int
name|iErrorCorrection
decl_stmt|,
name|iSpeakerSwitch
decl_stmt|,
name|iSpeakerVolume
decl_stmt|;
name|int
name|iNextModemState
init|=
name|STAY_MODEM_STATE
decl_stmt|;
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_init_resp00"
argument_list|)
expr_stmt|;
name|up
operator|->
name|iModemCommandSeq
operator|++
expr_stmt|;
switch|switch
condition|(
name|up
operator|->
name|iModemCommandSeq
condition|)
block|{
case|case
literal|1
case|:
comment|/* En = Echoback      0:Off      1:On   */
comment|/* Qn = Result codes  0:On       1:Off  */
comment|/* Vn = Result codes  0:Numeric  1:Text */
name|pCmd
operator|=
literal|"ATE0Q0V1\r\n"
expr_stmt|;
break|break ;
case|case
literal|2
case|:
comment|/* Mn = Speaker switch  0:Off  1:On until remote carrier detected  2:On */
if|if
condition|(
operator|(
name|pp
operator|->
name|sloppyclockflag
operator|&
name|CLK_FLAG3
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* fudge 127.127.40.n flag3 0 */
name|iSpeakerSwitch
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* fudge 127.127.40.n flag3 1 */
name|iSpeakerSwitch
operator|=
literal|2
expr_stmt|;
block|}
comment|/* Ln = Speaker volume  0:Very low  1:Low  2:Middle  3:High */
if|if
condition|(
operator|(
name|pp
operator|->
name|sloppyclockflag
operator|&
name|CLK_FLAG4
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* fudge 127.127.40.n flag4 0 */
name|iSpeakerVolume
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* fudge 127.127.40.n flag4 1 */
name|iSpeakerVolume
operator|=
literal|2
expr_stmt|;
block|}
name|pCmd
operator|=
name|cBuf
expr_stmt|;
name|snprintf
argument_list|(
name|cBuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cBuf
argument_list|)
argument_list|,
literal|"ATM%dL%d\r\n"
argument_list|,
name|iSpeakerSwitch
argument_list|,
name|iSpeakerVolume
argument_list|)
expr_stmt|;
break|break ;
case|case
literal|3
case|:
comment|/*&Kn = Flow control  4:XON/XOFF */
name|pCmd
operator|=
literal|"AT&K4\r\n"
expr_stmt|;
break|break ;
case|case
literal|4
case|:
comment|/* +MS = Protocol  V22B:1200,2400bpsiV.22bis) */
name|pCmd
operator|=
literal|"AT+MS=V22B\r\n"
expr_stmt|;
break|break ;
case|case
literal|5
case|:
comment|/* %Cn = Data compression  0:No data compression */
name|pCmd
operator|=
literal|"AT%C0\r\n"
expr_stmt|;
break|break ;
case|case
literal|6
case|:
comment|/* \Nn = Error correction  0:Normal mode  1:Direct mode  2:V42,MNP  3:V42,MNP,Normal */
if|if
condition|(
operator|(
name|pp
operator|->
name|sloppyclockflag
operator|&
name|CLK_FLAG2
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* fudge 127.127.40.n flag2 0 */
name|iErrorCorrection
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* fudge 127.127.40.n flag2 1 */
name|iErrorCorrection
operator|=
literal|3
expr_stmt|;
block|}
name|pCmd
operator|=
name|cBuf
expr_stmt|;
name|snprintf
argument_list|(
name|cBuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cBuf
argument_list|)
argument_list|,
literal|"AT\\N%d\r\n"
argument_list|,
name|iErrorCorrection
argument_list|)
expr_stmt|;
break|break ;
case|case
literal|7
case|:
comment|/* Hn = Hook  0:Hook-On ( Disconnect )  1:Hook-Off ( Connect ) */
name|pCmd
operator|=
literal|"ATH1\r\n"
expr_stmt|;
break|break ;
case|case
literal|8
case|:
comment|/* Initialize completion */
name|pCmd
operator|=
name|NULL
expr_stmt|;
name|iNextModemState
operator|=
name|CHANGE_MODEM_STATE
expr_stmt|;
break|break ;
default|default :
name|pCmd
operator|=
name|NULL
expr_stmt|;
break|break ;
block|}
if|if
condition|(
name|pCmd
operator|!=
name|NULL
condition|)
block|{
name|iCmdLen
operator|=
name|strlen
argument_list|(
name|pCmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
name|iCmdLen
argument_list|)
operator|!=
name|iCmdLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
block|}
return|return
name|iNextModemState
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_init_resp04
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_init_resp04"
argument_list|)
expr_stmt|;
return|return
name|modem_init_resp00
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_init_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_init_disc"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : modem_init_disc : call modem_esc_disc\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|CHANGE_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_dial_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_dial_ignore"
argument_list|)
expr_stmt|;
return|return
name|STAY_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_dial_dialout
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|char
name|sCmd
index|[
literal|46
index|]
decl_stmt|;
name|int
name|iCmdLen
decl_stmt|;
name|char
name|cToneOrPulse
decl_stmt|;
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_dial_dialout"
argument_list|)
expr_stmt|;
comment|/* Tone or Pulse */
if|if
condition|(
operator|(
name|pp
operator|->
name|sloppyclockflag
operator|&
name|CLK_FLAG1
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* fudge 127.127.40.n flag1 0 */
name|cToneOrPulse
operator|=
literal|'T'
expr_stmt|;
block|}
else|else
block|{
comment|/* fudge 127.127.40.n flag1 1 */
name|cToneOrPulse
operator|=
literal|'P'
expr_stmt|;
block|}
comment|/* Connect ( Dial number ) */
name|snprintf
argument_list|(
name|sCmd
argument_list|,
sizeof|sizeof
argument_list|(
name|sCmd
argument_list|)
argument_list|,
literal|"ATDW%c%s\r\n"
argument_list|,
name|cToneOrPulse
argument_list|,
operator|*
name|sys_phone
argument_list|)
expr_stmt|;
comment|/* Send command */
name|iCmdLen
operator|=
name|strlen
argument_list|(
name|sCmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|sCmd
argument_list|,
name|iCmdLen
argument_list|)
operator|!=
name|iCmdLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|sCmd
argument_list|)
expr_stmt|;
return|return
name|STAY_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_dial_escape
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_dial_escape"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : modem_dial_escape : call modem_conn_escape\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|modem_conn_escape
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_dial_connect
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_dial_connect"
argument_list|)
expr_stmt|;
return|return
name|CHANGE_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_dial_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_dial_disc"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : modem_dial_disc : call modem_esc_disc\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|modem_esc_disc
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
return|return
name|CHANGE_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_conn_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_conn_ignore"
argument_list|)
expr_stmt|;
return|return
name|STAY_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_conn_escape
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_conn_escape"
argument_list|)
expr_stmt|;
return|return
name|CHANGE_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_esc_ignore
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_esc_ignore"
argument_list|)
expr_stmt|;
return|return
name|STAY_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_esc_escape
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|int
name|iCmdLen
decl_stmt|;
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_esc_escape"
argument_list|)
expr_stmt|;
comment|/* Escape command ( Go to command mode ) */
name|pCmd
operator|=
literal|"+++"
expr_stmt|;
comment|/* Send command */
name|iCmdLen
operator|=
name|strlen
argument_list|(
name|pCmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
name|iCmdLen
argument_list|)
operator|!=
name|iCmdLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
return|return
name|STAY_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_esc_data
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_esc_data"
argument_list|)
expr_stmt|;
name|up
operator|->
name|iModemSilentTimer
operator|=
literal|0
expr_stmt|;
return|return
name|STAY_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_esc_silent
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_esc_silent"
argument_list|)
expr_stmt|;
name|up
operator|->
name|iModemSilentCount
operator|++
expr_stmt|;
if|if
condition|(
name|up
operator|->
name|iModemSilentCount
operator|<
name|iModemStateTimeout
index|[
name|up
operator|->
name|iModemState
index|]
operator|/
name|iModemSilentTimeout
index|[
name|up
operator|->
name|iModemState
index|]
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : modem_esc_silent : call modem_esc_escape\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|modem_esc_escape
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
expr_stmt|;
name|up
operator|->
name|iModemSilentTimer
operator|=
literal|0
expr_stmt|;
return|return
name|STAY_MODEM_STATE
return|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : modem_esc_silent : call modem_esc_disc\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|modem_esc_disc
argument_list|(
name|peer
argument_list|,
name|pp
argument_list|,
name|up
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/******************************/
end_comment

begin_function
specifier|static
name|int
name|modem_esc_disc
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|struct
name|refclockproc
modifier|*
name|pp
parameter_list|,
name|struct
name|jjyunit
modifier|*
name|up
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pCmd
decl_stmt|;
name|int
name|iCmdLen
decl_stmt|;
name|DEBUG_MODEM_PRINTF
argument_list|(
literal|"modem_esc_disc"
argument_list|)
expr_stmt|;
comment|/* Disconnect */
name|pCmd
operator|=
literal|"ATH0\r\n"
expr_stmt|;
comment|/* Send command */
name|iCmdLen
operator|=
name|strlen
argument_list|(
name|pCmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|pp
operator|->
name|io
operator|.
name|fd
argument_list|,
name|pCmd
argument_list|,
name|iCmdLen
argument_list|)
operator|!=
name|iCmdLen
condition|)
block|{
name|refclock_report
argument_list|(
name|peer
argument_list|,
name|CEVNT_FAULT
argument_list|)
expr_stmt|;
block|}
name|jjy_write_clockstats
argument_list|(
name|peer
argument_list|,
name|JJY_CLOCKSTATS_MARK_SEND
argument_list|,
name|pCmd
argument_list|)
expr_stmt|;
return|return
name|CHANGE_MODEM_STATE
return|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    jjy_write_clockstats									##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_function
specifier|static
name|void
name|jjy_write_clockstats
parameter_list|(
name|struct
name|peer
modifier|*
name|peer
parameter_list|,
name|int
name|iMark
parameter_list|,
specifier|const
name|char
modifier|*
name|pData
parameter_list|)
block|{
name|char
name|sLog
index|[
literal|100
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|pMark
decl_stmt|;
name|int
name|iMarkLen
decl_stmt|,
name|iDataLen
decl_stmt|;
switch|switch
condition|(
name|iMark
condition|)
block|{
case|case
name|JJY_CLOCKSTATS_MARK_JJY
case|:
name|pMark
operator|=
literal|"JJY "
expr_stmt|;
break|break ;
case|case
name|JJY_CLOCKSTATS_MARK_SEND
case|:
name|pMark
operator|=
literal|"--> "
expr_stmt|;
break|break ;
case|case
name|JJY_CLOCKSTATS_MARK_RECEIVE
case|:
name|pMark
operator|=
literal|"<-- "
expr_stmt|;
break|break ;
case|case
name|JJY_CLOCKSTATS_MARK_INFORMATION
case|:
name|pMark
operator|=
literal|"--- "
expr_stmt|;
break|break ;
case|case
name|JJY_CLOCKSTATS_MARK_ATTENTION
case|:
name|pMark
operator|=
literal|"=== "
expr_stmt|;
break|break ;
case|case
name|JJY_CLOCKSTATS_MARK_WARNING
case|:
name|pMark
operator|=
literal|"-W- "
expr_stmt|;
break|break ;
case|case
name|JJY_CLOCKSTATS_MARK_ERROR
case|:
name|pMark
operator|=
literal|"-X- "
expr_stmt|;
break|break ;
default|default :
name|pMark
operator|=
literal|""
expr_stmt|;
break|break ;
block|}
name|iDataLen
operator|=
name|strlen
argument_list|(
name|pData
argument_list|)
expr_stmt|;
name|iMarkLen
operator|=
name|strlen
argument_list|(
name|pMark
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|sLog
argument_list|,
name|pMark
argument_list|)
expr_stmt|;
comment|/* Harmless because of enough length */
name|printableString
argument_list|(
name|sLog
operator|+
name|iMarkLen
argument_list|,
sizeof|sizeof
argument_list|(
name|sLog
argument_list|)
operator|-
name|iMarkLen
argument_list|,
name|pData
argument_list|,
name|iDataLen
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"refclock_jjy.c : clockstats : %s\n"
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|record_clock_stats
argument_list|(
operator|&
name|peer
operator|->
name|srcadr
argument_list|,
name|sLog
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*##    printableString										##*/
end_comment

begin_comment
comment|/*##												##*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_comment
comment|/*################################################################################################*/
end_comment

begin_function
specifier|static
name|void
name|printableString
parameter_list|(
name|char
modifier|*
name|sOutput
parameter_list|,
name|int
name|iOutputLen
parameter_list|,
specifier|const
name|char
modifier|*
name|sInput
parameter_list|,
name|int
name|iInputLen
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|printableControlChar
index|[]
init|=
block|{
literal|"<NUL>"
block|,
literal|"<SOH>"
block|,
literal|"<STX>"
block|,
literal|"<ETX>"
block|,
literal|"<EOT>"
block|,
literal|"<ENQ>"
block|,
literal|"<ACK>"
block|,
literal|"<BEL>"
block|,
literal|"<BS>"
block|,
literal|"<HT>"
block|,
literal|"<LF>"
block|,
literal|"<VT>"
block|,
literal|"<FF>"
block|,
literal|"<CR>"
block|,
literal|"<SO>"
block|,
literal|"<SI>"
block|,
literal|"<DLE>"
block|,
literal|"<DC1>"
block|,
literal|"<DC2>"
block|,
literal|"<DC3>"
block|,
literal|"<DC4>"
block|,
literal|"<NAK>"
block|,
literal|"<SYN>"
block|,
literal|"<ETB>"
block|,
literal|"<CAN>"
block|,
literal|"<EM>"
block|,
literal|"<SUB>"
block|,
literal|"<ESC>"
block|,
literal|"<FS>"
block|,
literal|"<GS>"
block|,
literal|"<RS>"
block|,
literal|"<US>"
block|,
literal|" "
block|}
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|;
name|size_t
name|InputLen
decl_stmt|;
name|size_t
name|OutputLen
decl_stmt|;
name|InputLen
operator|=
operator|(
name|size_t
operator|)
name|iInputLen
expr_stmt|;
name|OutputLen
operator|=
operator|(
name|size_t
operator|)
name|iOutputLen
expr_stmt|;
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|InputLen
operator|&&
name|j
operator|<
name|OutputLen
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isprint
argument_list|(
operator|(
name|unsigned
name|char
operator|)
name|sInput
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|j
operator|+
literal|1
operator|>=
name|OutputLen
condition|)
break|break ;
name|sOutput
index|[
name|j
index|]
operator|=
name|sInput
index|[
name|i
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|sInput
index|[
name|i
index|]
operator|&
literal|0xFF
operator|)
operator|<
name|COUNTOF
argument_list|(
name|printableControlChar
argument_list|)
condition|)
block|{
name|n
operator|=
name|strlen
argument_list|(
name|printableControlChar
index|[
name|sInput
index|[
name|i
index|]
operator|&
literal|0xFF
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|+
name|n
operator|+
literal|1
operator|>=
name|OutputLen
condition|)
break|break ;
name|strlcpy
argument_list|(
name|sOutput
operator|+
name|j
argument_list|,
name|printableControlChar
index|[
name|sInput
index|[
name|i
index|]
operator|&
literal|0xFF
index|]
argument_list|,
name|OutputLen
operator|-
name|j
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|n
operator|=
literal|5
expr_stmt|;
if|if
condition|(
name|j
operator|+
name|n
operator|+
literal|1
operator|>=
name|OutputLen
condition|)
break|break ;
name|snprintf
argument_list|(
name|sOutput
operator|+
name|j
argument_list|,
name|OutputLen
operator|-
name|j
argument_list|,
literal|"<x%X>"
argument_list|,
name|sInput
index|[
name|i
index|]
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
block|}
name|j
operator|+=
name|n
expr_stmt|;
block|}
name|sOutput
index|[
name|min
argument_list|(
name|j
argument_list|,
operator|(
name|size_t
operator|)
name|iOutputLen
operator|-
literal|1
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************************************************/
end_comment

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|int
name|refclock_jjy_bs
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* REFCLOCK */
end_comment

end_unit


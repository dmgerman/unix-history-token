begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* check_y2k.c -- test ntp code constructs for Y2K correctness 	Y2KFixes [*/
end_comment

begin_comment
comment|/* 	Code invoked by `make check`. Not part of ntpd and not to be 	installed.  	On any code I even wonder about, I've cut and pasted the code 	here and ran it as a test case just to be sure.  	For code not in "ntpd" proper, we have tried to call most  	repaired functions from herein to properly test them 	(something never done before!). This has found several bugs, 	not normal Y2K bugs, that will strike in Y2K so repair them 	we did.  	Program exits with 0 on success, 1 on Y2K failure (stdout messages). 	Exit of 2 indicates internal logic bug detected OR failure of 	what should be our correct formulas.  	While "make check" should only check logic for source within that 	specific directory, this check goes outside the scope of the local 	directory.  It's not a perfect world (besides, there is a lot of 	interdependence here, and it really needs to be tested in 	a controled order).    */
end_comment

begin_comment
comment|/* { definitions lifted from ntpd.c to allow us to complie with       "#include ntp.h".  I have not taken the time to reduce the clutter. */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_STAT_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|SYS_WINNT
end_ifndef

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|VMS
argument_list|)
end_if

begin_comment
comment|/*wjm*/
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* VMS */
end_comment

begin_include
include|#
directive|include
file|<sys/signal.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_IOCTL_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SYS_IOCTL_H */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|VMS
argument_list|)
end_if

begin_comment
comment|/*wjm*/
end_comment

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* VMS */
end_comment

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<process.h>
end_include

begin_include
include|#
directive|include
file|<io.h>
end_include

begin_include
include|#
directive|include
file|"../libntp/log.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SYS_WINNT */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_RTPRIO
argument_list|)
end_if

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_RESOURCE_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_LOCK_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/rtprio.h>
end_include

begin_else
else|#
directive|else
end_else

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_PLOCK
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_LOCK_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SCHED_SETSCHEDULER
argument_list|)
end_if

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SCHED_H
end_ifdef

begin_include
include|#
directive|include
file|<sched.h>
end_include

begin_else
else|#
directive|else
end_else

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_SCHED_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/sched.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SYS_MMAN_H
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_TERMIOS_H
end_ifdef

begin_include
include|#
directive|include
file|<termios.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SYS_DOMAINOS
end_ifdef

begin_include
include|#
directive|include
file|<apollo/base.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SYS_DOMAINOS */
end_comment

begin_comment
comment|/* } end definitions lifted from ntpd.c */
end_comment

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"parse.h"
end_include

begin_define
define|#
directive|define
name|GoodLeap
parameter_list|(
name|Year
parameter_list|)
value|(((Year)%4 || (!((Year)%100)&& (Year)%400)) ? 0 : 13 )
end_define

begin_decl_stmt
specifier|volatile
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* debugging requests for parse stuff */
end_comment

begin_decl_stmt
name|char
specifier|const
modifier|*
name|progname
init|=
literal|"check_y2k"
decl_stmt|;
end_decl_stmt

begin_function
name|long
name|Days
parameter_list|(
name|int
name|Year
parameter_list|)
comment|/* return number of days since year "0" */
block|{
name|long
name|Return
decl_stmt|;
comment|/* this is a known to be good algorithm */
name|Return
operator|=
name|Year
operator|*
literal|365
expr_stmt|;
comment|/* first aproximation to the value */
if|if
condition|(
name|Year
operator|>=
literal|1
condition|)
block|{
comment|/* see notes in libparse/parse.c if you want a PROPER 		 * **generic algorithm. */
name|Return
operator|+=
operator|(
name|Year
operator|+
literal|3
operator|)
operator|/
literal|4
expr_stmt|;
comment|/* add in (too many) leap days */
name|Return
operator|-=
operator|(
name|Year
operator|-
literal|1
operator|)
operator|/
literal|100
expr_stmt|;
comment|/* reduce by (too many) centurys */
name|Return
operator|+=
operator|(
name|Year
operator|-
literal|1
operator|)
operator|/
literal|400
expr_stmt|;
comment|/* get final answer */
block|}
return|return
name|Return
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|year0
init|=
literal|1900
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sarting year for NTP time */
end_comment

begin_decl_stmt
specifier|static
name|int
name|yearend
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ending year we test for NTP time. 				    * 32-bit systems: through 2036, the 				      **year in which NTP time overflows. 				    * 64-bit systems: a reasonable upper 				      **limit (well, maybe somewhat beyond 				      **reasonable, but well before the 				      **max time, by which time the earth 				      **will be dead.) */
end_comment

begin_decl_stmt
specifier|static
name|time_t
name|Time
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tm
name|LocalTime
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|Error
parameter_list|(
name|year
parameter_list|)
value|if ( (year)>=2036&& LocalTime.tm_year< 110 ) \ 	Warnings++; else Fatals++
end_define

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|Fatals
decl_stmt|;
name|int
name|Warnings
decl_stmt|;
name|int
name|year
decl_stmt|;
name|Time
operator|=
name|time
argument_list|(
operator|(
name|time_t
operator|*
operator|)
name|NULL
argument_list|)
ifdef|#
directive|ifdef
name|TESTTIMEOFFSET
operator|+
name|test_time_offset
endif|#
directive|endif
expr_stmt|;
name|LocalTime
operator|=
operator|*
name|localtime
argument_list|(
operator|&
name|Time
argument_list|)
expr_stmt|;
name|year
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
operator|>
literal|4
operator|)
comment|/* save max span using year as temp */
condition|?
operator|(
literal|400
operator|*
literal|3
operator|)
comment|/* three greater gregorian cycles */
else|:
operator|(
call|(
name|int
call|)
argument_list|(
literal|0x7FFFFFFF
operator|/
literal|365.242
operator|/
literal|24
operator|/
literal|60
operator|/
literal|60
argument_list|)
operator|*
literal|2
operator|)
expr_stmt|;
comment|/*32-bit limit*/
comment|/* NOTE: will automacially expand test years on 			 * 64 bit machines.... this may cause some of the 			 * existing ntp logic to fail for years beyond 			 * 2036 (the current 32-bit limit). If all checks 			 * fail ONLY beyond year 2036 you may ignore such 			 * errors, at least for a decade or so. */
name|yearend
operator|=
name|year0
operator|+
name|year
expr_stmt|;
name|puts
argument_list|(
literal|" internal self check"
argument_list|)
expr_stmt|;
block|{
comment|/* verify our own logic used to verify repairs */
name|unsigned
name|long
name|days
decl_stmt|;
if|if
condition|(
name|year0
operator|>=
name|yearend
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"year0=%d NOT LESS THAN yearend=%d  (span=%d)\n"
argument_list|,
operator|(
name|int
operator|)
name|year0
argument_list|,
operator|(
name|int
operator|)
name|yearend
argument_list|,
operator|(
name|int
operator|)
name|year
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|{
name|int
name|save_year
decl_stmt|;
name|save_year
operator|=
name|LocalTime
operator|.
name|tm_year
expr_stmt|;
comment|/* save current year */
name|year
operator|=
literal|1980
expr_stmt|;
name|LocalTime
operator|.
name|tm_year
operator|=
name|year
operator|-
literal|1900
expr_stmt|;
name|Fatals
operator|=
name|Warnings
operator|=
literal|0
expr_stmt|;
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
comment|/* should increment Fatals */
if|if
condition|(
name|Fatals
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%4d: %s(%d): FATAL DID NOT INCREMENT  (Fatals=%d Warnings=%d)\n"
argument_list|,
operator|(
name|int
operator|)
name|year
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|int
operator|)
name|Fatals
argument_list|,
operator|(
name|int
operator|)
name|Warnings
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|year
operator|=
literal|2100
expr_stmt|;
comment|/* test year> limit but CURRENT year< limit */
name|Fatals
operator|=
name|Warnings
operator|=
literal|0
expr_stmt|;
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
comment|/* should increment Fatals */
if|if
condition|(
name|Warnings
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%4d: %s(%d): WARNING DID NOT INCREMENT  (Fatals=%d Warnings=%d)\n"
argument_list|,
operator|(
name|int
operator|)
name|year
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|int
operator|)
name|Fatals
argument_list|,
operator|(
name|int
operator|)
name|Warnings
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|Fatals
operator|=
name|Warnings
operator|=
literal|0
expr_stmt|;
name|LocalTime
operator|.
name|tm_year
operator|=
name|year
operator|-
literal|1900
expr_stmt|;
comment|/* everything> limit */
name|Error
argument_list|(
literal|1980
argument_list|)
expr_stmt|;
comment|/* should increment Fatals */
if|if
condition|(
name|Fatals
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%4d: %s(%d): FATALS DID NOT INCREMENT  (Fatals=%d Warnings=%d)\n"
argument_list|,
operator|(
name|int
operator|)
name|year
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|int
operator|)
name|Fatals
argument_list|,
operator|(
name|int
operator|)
name|Warnings
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|LocalTime
operator|.
name|tm_year
operator|=
name|save_year
expr_stmt|;
block|}
name|days
operator|=
literal|365
operator|+
literal|1
expr_stmt|;
comment|/* days in year 0 + 1 more day */
for|for
control|(
name|year
operator|=
literal|1
init|;
name|year
operator|<=
literal|2500
condition|;
name|year
operator|++
control|)
block|{
name|long
name|Test
decl_stmt|;
name|Test
operator|=
name|Days
argument_list|(
name|year
argument_list|)
expr_stmt|;
if|if
condition|(
name|days
operator|!=
name|Test
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%04d: Days() DAY COUNT ERROR: s/b=%ld was=%ld\n"
argument_list|,
name|year
argument_list|,
operator|(
name|long
operator|)
name|days
argument_list|,
operator|(
name|long
operator|)
name|Test
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* would throw off many other tests */
block|}
name|Test
operator|=
name|julian0
argument_list|(
name|year
argument_list|)
expr_stmt|;
comment|/* compare with julian0() macro */
if|if
condition|(
name|days
operator|!=
name|Test
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%04d: julian0() DAY COUNT ERROR: s/b=%ld was=%ld\n"
argument_list|,
name|year
argument_list|,
operator|(
name|long
operator|)
name|days
argument_list|,
operator|(
name|long
operator|)
name|Test
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* would throw off many other tests */
block|}
name|days
operator|+=
literal|365
expr_stmt|;
if|if
condition|(
name|isleap_4
argument_list|(
name|year
argument_list|)
condition|)
name|days
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|isleap_4
argument_list|(
literal|1999
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"isleap_4(1999) REPORTED TRUE\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|isleap_4
argument_list|(
literal|2000
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"isleap_4(2000) REPORTED FALSE\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isleap_4
argument_list|(
literal|2001
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"isleap_4(1999) REPORTED TRUE\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|isleap_tm
argument_list|(
literal|2000
operator|-
literal|1900
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"isleap_tm(100) REPORTED FALSE\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
name|Fatals
operator|=
name|Warnings
operator|=
literal|0
expr_stmt|;
name|puts
argument_list|(
literal|" include/ntp.h"
argument_list|)
expr_stmt|;
block|{
comment|/* test our new isleap_*() #define "functions" */
for|for
control|(
name|year
operator|=
literal|1400
init|;
name|year
operator|<=
literal|2200
condition|;
name|year
operator|++
control|)
block|{
name|int
name|LeapSw
decl_stmt|;
name|int
name|IsLeapSw
decl_stmt|;
name|LeapSw
operator|=
name|GoodLeap
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|IsLeapSw
operator|=
name|isleap_4
argument_list|(
name|year
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|!
name|LeapSw
operator|!=
operator|!
operator|!
name|IsLeapSw
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"  %4d %2d %3d *** ERROR\n"
argument_list|,
name|year
argument_list|,
name|LeapSw
argument_list|,
name|IsLeapSw
argument_list|)
expr_stmt|;
break|break;
block|}
name|IsLeapSw
operator|=
name|isleap_tm
argument_list|(
name|year
operator|-
literal|1900
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|!
name|LeapSw
operator|!=
operator|!
operator|!
name|IsLeapSw
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"  %4d %2d %3d *** ERROR\n"
argument_list|,
name|year
argument_list|,
name|LeapSw
argument_list|,
name|IsLeapSw
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
name|puts
argument_list|(
literal|" include/ntp_calendar.h"
argument_list|)
expr_stmt|;
block|{
comment|/* I belive this is good, but just to be sure... */
comment|/* we are testing this #define */
define|#
directive|define
name|is_leapyear
parameter_list|(
name|y
parameter_list|)
value|(y%4 == 0&& !(y%100 == 0&& !(y%400 == 0)))
for|for
control|(
name|year
operator|=
literal|1400
init|;
name|year
operator|<=
literal|2200
condition|;
name|year
operator|++
control|)
block|{
name|int
name|LeapSw
decl_stmt|;
name|LeapSw
operator|=
name|GoodLeap
argument_list|(
name|year
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|!
name|LeapSw
operator|)
operator|!=
operator|!
operator|(
operator|!
name|is_leapyear
argument_list|(
name|year
argument_list|)
operator|)
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"  %4d %2d *** ERROR\n"
argument_list|,
name|year
argument_list|,
name|LeapSw
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
name|puts
argument_list|(
literal|" libparse/parse.c"
argument_list|)
expr_stmt|;
block|{
name|long
name|Days1970
decl_stmt|;
comment|/* days from 1900 to 1970 */
struct|struct
name|ParseTime
comment|/* womp up a test structure to all cut/paste code */
block|{
name|int
name|year
decl_stmt|;
block|}
name|Clock_Time
struct|,
modifier|*
name|clock_time
struct|;
name|clock_time
operator|=
operator|&
name|Clock_Time
expr_stmt|;
comment|/* first test this #define */
define|#
directive|define
name|days_per_year
parameter_list|(
name|x
parameter_list|)
value|((x) % 4 ? 365 : ((x % 400) ? ((x % 100) ? 366 : 365) : 366))
for|for
control|(
name|year
operator|=
literal|1400
init|;
name|year
operator|<=
literal|2200
condition|;
name|year
operator|++
control|)
block|{
name|int
name|LeapSw
decl_stmt|;
name|int
name|DayCnt
decl_stmt|;
name|LeapSw
operator|=
name|GoodLeap
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|DayCnt
operator|=
operator|(
name|int
operator|)
name|days_per_year
argument_list|(
name|year
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|LeapSw
condition|?
literal|366
else|:
literal|365
operator|)
operator|!=
name|DayCnt
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"  days_per_year() %4d %2d %3d *** ERROR\n"
argument_list|,
name|year
argument_list|,
name|LeapSw
argument_list|,
name|DayCnt
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* test (what is now julian0) calculations */
name|Days1970
operator|=
name|Days
argument_list|(
literal|1970
argument_list|)
expr_stmt|;
comment|/* get days since 1970 using a known good */
for|for
control|(
name|year
operator|=
literal|1970
init|;
name|year
operator|<
name|yearend
condition|;
name|year
operator|++
control|)
block|{
name|unsigned
name|long
name|t
decl_stmt|;
name|long
name|DaysYear
decl_stmt|;
name|clock_time
operator|->
name|year
operator|=
name|year
expr_stmt|;
comment|/* here is the code we are testing, cut and pasted out of the source */
if|#
directive|if
literal|0
comment|/* old BUGGY code that has Y2K (and many other) failures */
comment|/* ghealton: this logic FAILED with great frequency when run 	     * over a period of time, including for year 2000. True, it 	     * had more successes than failures, but that's not really good 	     * enough for critical time distribution software. 	     * It is so awful I wonder if it has had a history of failure  	     * and fixes? */
block|t =  (clock_time->year - 1970) * 365;         t += (clock_time->year>> 2) - (1970>> 2);         t -= clock_time->year / 100 - 1970 / 100;         t += clock_time->year / 400 - 1970 / 400;
comment|/* (immediate feare of rounding errors on integer 		 * **divisions proved well founded) */
else|#
directive|else
comment|/* my replacement, based on Days() above */
name|t
operator|=
name|julian0
argument_list|(
name|year
argument_list|)
operator|-
name|julian0
argument_list|(
literal|1970
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* compare result in t against trusted calculations */
name|DaysYear
operator|=
name|Days
argument_list|(
name|year
argument_list|)
expr_stmt|;
comment|/* get days to this year */
if|if
condition|(
name|t
operator|!=
name|DaysYear
operator|-
name|Days1970
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"  %4d 1970=%-8ld %4d=%-8ld %-3ld  t=%-8ld  *** ERROR ***\n"
argument_list|,
name|year
argument_list|,
operator|(
name|long
operator|)
name|Days1970
argument_list|,
name|year
argument_list|,
operator|(
name|long
operator|)
name|DaysYear
argument_list|,
call|(
name|long
call|)
argument_list|(
name|DaysYear
operator|-
name|Days1970
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|t
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
literal|1
comment|/* { */
block|{
name|debug
operator|=
literal|1
expr_stmt|;
comment|/* enable debugging */
for|for
control|(
name|year
operator|=
literal|1970
init|;
name|year
operator|<
name|yearend
condition|;
name|year
operator|++
control|)
block|{
comment|/* (limited by theory unix 2038 related bug lives by, but 		 * ends in yearend) */
name|clocktime_t
name|ct
decl_stmt|;
name|time_t
name|Observed
decl_stmt|;
name|time_t
name|Expected
decl_stmt|;
name|u_long
name|Flag
decl_stmt|;
name|unsigned
name|long
name|t
decl_stmt|;
name|ct
operator|.
name|day
operator|=
literal|1
expr_stmt|;
name|ct
operator|.
name|month
operator|=
literal|1
expr_stmt|;
name|ct
operator|.
name|year
operator|=
name|year
expr_stmt|;
name|ct
operator|.
name|hour
operator|=
name|ct
operator|.
name|minute
operator|=
name|ct
operator|.
name|second
operator|=
name|ct
operator|.
name|usecond
operator|=
literal|0
expr_stmt|;
name|ct
operator|.
name|utcoffset
operator|=
literal|0
expr_stmt|;
name|ct
operator|.
name|utctime
operator|=
literal|0
expr_stmt|;
name|ct
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|Flag
operator|=
literal|0
expr_stmt|;
name|Observed
operator|=
name|parse_to_unixtime
argument_list|(
operator|&
name|ct
argument_list|,
operator|&
name|Flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ct
operator|.
name|year
operator|!=
name|year
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%04d: parse_to_unixtime(,%d) CORRUPTED ct.year: was %d\n"
argument_list|,
operator|(
name|int
operator|)
name|year
argument_list|,
operator|(
name|int
operator|)
name|Flag
argument_list|,
operator|(
name|int
operator|)
name|ct
operator|.
name|year
argument_list|)
expr_stmt|;
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
break|break;
block|}
name|t
operator|=
name|julian0
argument_list|(
name|year
argument_list|)
operator|-
name|julian0
argument_list|(
literal|1970
argument_list|)
expr_stmt|;
comment|/* Julian day from 1970 */
name|Expected
operator|=
name|t
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
expr_stmt|;
if|if
condition|(
name|Observed
operator|!=
name|Expected
operator|||
name|Flag
condition|)
block|{
comment|/* time difference */
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%04d: parse_to_unixtime(,%d) FAILURE: was=%lu s/b=%lu  (%ld)\n"
argument_list|,
name|year
argument_list|,
operator|(
name|int
operator|)
name|Flag
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|Observed
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|Expected
argument_list|,
operator|(
operator|(
name|long
operator|)
name|Observed
operator|-
operator|(
name|long
operator|)
name|Expected
operator|)
argument_list|)
expr_stmt|;
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|year
operator|>=
name|YEAR_PIVOT
operator|+
literal|1900
condition|)
block|{
comment|/* check year % 100 code we put into parse_to_unixtime() */
name|ct
operator|.
name|utctime
operator|=
literal|0
expr_stmt|;
name|ct
operator|.
name|year
operator|=
name|year
operator|%
literal|100
expr_stmt|;
name|Flag
operator|=
literal|0
expr_stmt|;
name|Observed
operator|=
name|parse_to_unixtime
argument_list|(
operator|&
name|ct
argument_list|,
operator|&
name|Flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|Observed
operator|!=
name|Expected
operator|||
name|Flag
condition|)
block|{
comment|/* time difference */
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%04d: parse_to_unixtime(%d,%d) FAILURE: was=%lu s/b=%lu  (%ld)\n"
argument_list|,
name|year
argument_list|,
operator|(
name|int
operator|)
name|ct
operator|.
name|year
argument_list|,
operator|(
name|int
operator|)
name|Flag
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|Observed
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|Expected
argument_list|,
operator|(
operator|(
name|long
operator|)
name|Observed
operator|-
operator|(
name|long
operator|)
name|Expected
operator|)
argument_list|)
expr_stmt|;
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* check year - 1900 code we put into parse_to_unixtime() */
name|ct
operator|.
name|utctime
operator|=
literal|0
expr_stmt|;
name|ct
operator|.
name|year
operator|=
name|year
operator|-
literal|1900
expr_stmt|;
name|Flag
operator|=
literal|0
expr_stmt|;
name|Observed
operator|=
name|parse_to_unixtime
argument_list|(
operator|&
name|ct
argument_list|,
operator|&
name|Flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|Observed
operator|!=
name|Expected
operator|||
name|Flag
condition|)
block|{
comment|/* time difference */
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%04d: parse_to_unixtime(%d,%d) FAILURE: was=%lu s/b=%lu  (%ld)\n"
argument_list|,
name|year
argument_list|,
operator|(
name|int
operator|)
name|ct
operator|.
name|year
argument_list|,
operator|(
name|int
operator|)
name|Flag
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|Observed
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|Expected
argument_list|,
operator|(
operator|(
name|long
operator|)
name|Observed
operator|-
operator|(
name|long
operator|)
name|Expected
operator|)
argument_list|)
expr_stmt|;
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* } */
block|}
block|}
name|puts
argument_list|(
literal|" libntp/caljulian.c"
argument_list|)
expr_stmt|;
block|{
comment|/* test caljulian() */
name|struct
name|calendar
name|ot
decl_stmt|;
name|u_long
name|ntp_time
decl_stmt|;
comment|/* NTP time */
name|year
operator|=
name|year0
expr_stmt|;
comment|/* calculate the basic year */
name|printf
argument_list|(
literal|"  starting year %04d\n"
argument_list|,
operator|(
name|int
operator|)
name|year0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  ending year   %04d\n"
argument_list|,
operator|(
name|int
operator|)
name|yearend
argument_list|)
expr_stmt|;
name|ntp_time
operator|=
name|julian0
argument_list|(
name|year0
argument_list|)
expr_stmt|;
comment|/* NTP starts in 1900-01-01 */
if|#
directive|if
name|DAY_NTP_STARTS
operator|==
literal|693596
name|ntp_time
operator|-=
literal|365
expr_stmt|;
comment|/* BIAS required for successful test */
endif|#
directive|endif
if|if
condition|(
name|DAY_NTP_STARTS
operator|!=
name|ntp_time
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%04d: DAY_NTP_STARTS (%ld) NOT TRUE VALUE OF %ld (%ld)\n"
argument_list|,
operator|(
name|int
operator|)
name|year0
argument_list|,
operator|(
name|long
operator|)
name|DAY_NTP_STARTS
argument_list|,
operator|(
name|long
operator|)
name|ntp_time
argument_list|,
operator|(
name|long
operator|)
name|DAY_NTP_STARTS
operator|-
operator|(
name|long
operator|)
name|ntp_time
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
name|year
operator|<
name|yearend
condition|;
name|year
operator|++
control|)
block|{
comment|/* 01-01 for the current year */
name|ntp_time
operator|=
name|Days
argument_list|(
name|year
argument_list|)
operator|-
name|Days
argument_list|(
name|year0
argument_list|)
expr_stmt|;
comment|/* days into NTP time */
name|ntp_time
operator|*=
literal|24
operator|*
literal|60
operator|*
literal|60
expr_stmt|;
comment|/* convert into seconds */
name|caljulian
argument_list|(
name|ntp_time
argument_list|,
operator|&
name|ot
argument_list|)
expr_stmt|;
comment|/* convert January 1 */
if|if
condition|(
name|ot
operator|.
name|year
operator|!=
name|year
operator|||
name|ot
operator|.
name|month
operator|!=
literal|1
operator|||
name|ot
operator|.
name|monthday
operator|!=
literal|1
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%lu: EXPECTED %04d-01-01: FOUND %04d-%02d-%02d\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ntp_time
argument_list|,
name|year
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|year
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|month
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|monthday
argument_list|)
expr_stmt|;
break|break;
block|}
name|ntp_time
operator|+=
operator|(
literal|31
operator|+
literal|28
operator|-
literal|1
operator|)
operator|*
operator|(
literal|24
operator|*
literal|60
operator|*
literal|60
operator|)
expr_stmt|;
comment|/* advance to 02-28 */
name|caljulian
argument_list|(
name|ntp_time
argument_list|,
operator|&
name|ot
argument_list|)
expr_stmt|;
comment|/* convert Feb 28 */
if|if
condition|(
name|ot
operator|.
name|year
operator|!=
name|year
operator|||
name|ot
operator|.
name|month
operator|!=
literal|2
operator|||
name|ot
operator|.
name|monthday
operator|!=
literal|28
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%lu: EXPECTED %04d-02-28: FOUND %04d-%02d-%02d\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ntp_time
argument_list|,
name|year
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|year
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|month
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|monthday
argument_list|)
expr_stmt|;
break|break;
block|}
block|{
name|int
name|m
decl_stmt|;
comment|/* expected month */
name|int
name|d
decl_stmt|;
comment|/* expected day */
name|m
operator|=
name|isleap_4
argument_list|(
name|year
argument_list|)
condition|?
literal|2
else|:
literal|3
expr_stmt|;
name|d
operator|=
name|isleap_4
argument_list|(
name|year
argument_list|)
condition|?
literal|29
else|:
literal|1
expr_stmt|;
name|ntp_time
operator|+=
operator|(
literal|24
operator|*
literal|60
operator|*
literal|60
operator|)
expr_stmt|;
comment|/* advance to the next day */
name|caljulian
argument_list|(
name|ntp_time
argument_list|,
operator|&
name|ot
argument_list|)
expr_stmt|;
comment|/* convert this day */
if|if
condition|(
name|ot
operator|.
name|year
operator|!=
name|year
operator|||
name|ot
operator|.
name|month
operator|!=
name|m
operator|||
name|ot
operator|.
name|monthday
operator|!=
name|d
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%lu: EXPECTED %04d-%02d-%02d: FOUND %04d-%02d-%02d\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ntp_time
argument_list|,
name|year
argument_list|,
name|m
argument_list|,
name|d
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|year
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|month
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|monthday
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
name|puts
argument_list|(
literal|" libntp/caltontp.c"
argument_list|)
expr_stmt|;
block|{
comment|/* test caltontp() */
name|struct
name|calendar
name|ot
decl_stmt|;
name|u_long
name|ntp_time
decl_stmt|;
comment|/* NTP time */
name|year
operator|=
name|year0
expr_stmt|;
comment|/* calculate the basic year */
name|printf
argument_list|(
literal|"  starting year %04d\n"
argument_list|,
operator|(
name|int
operator|)
name|year0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  ending year   %04d\n"
argument_list|,
operator|(
name|int
operator|)
name|yearend
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|year
operator|<
name|yearend
condition|;
name|year
operator|++
control|)
block|{
name|u_long
name|ObservedNtp
decl_stmt|;
comment|/* 01-01 for the current year */
name|ot
operator|.
name|year
operator|=
name|year
expr_stmt|;
name|ot
operator|.
name|month
operator|=
name|ot
operator|.
name|monthday
operator|=
literal|1
expr_stmt|;
comment|/* unused, but set anyway JIC */
name|ot
operator|.
name|yearday
operator|=
literal|1
expr_stmt|;
comment|/* this is the magic value used by caltontp() */
name|ot
operator|.
name|hour
operator|=
name|ot
operator|.
name|minute
operator|=
name|ot
operator|.
name|second
operator|=
literal|0
expr_stmt|;
name|ntp_time
operator|=
name|Days
argument_list|(
name|year
argument_list|)
operator|-
name|Days
argument_list|(
name|year0
argument_list|)
expr_stmt|;
comment|/* days into NTP time */
name|ntp_time
operator|*=
literal|24
operator|*
literal|60
operator|*
literal|60
expr_stmt|;
comment|/* convert into seconds */
name|ObservedNtp
operator|=
name|caltontp
argument_list|(
operator|&
name|ot
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntp_time
operator|!=
name|ObservedNtp
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%d: EXPECTED %lu: FOUND %lu (%ld)\n"
argument_list|,
operator|(
name|int
operator|)
name|year
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ntp_time
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ObservedNtp
argument_list|,
operator|(
name|long
operator|)
name|ntp_time
operator|-
operator|(
name|long
operator|)
name|ObservedNtp
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* now call caljulian as a type of failsafe supercheck */
name|caljulian
argument_list|(
name|ObservedNtp
argument_list|,
operator|&
name|ot
argument_list|)
expr_stmt|;
comment|/* convert January 1 */
if|if
condition|(
name|ot
operator|.
name|year
operator|!=
name|year
operator|||
name|ot
operator|.
name|month
operator|!=
literal|1
operator|||
name|ot
operator|.
name|monthday
operator|!=
literal|1
condition|)
block|{
name|Error
argument_list|(
name|year
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%lu: caljulian FAILSAFE EXPECTED %04d-01-01: FOUND %04d-%02d-%02d\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ObservedNtp
argument_list|,
name|year
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|year
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|month
argument_list|,
operator|(
name|int
operator|)
name|ot
operator|.
name|monthday
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|Warnings
operator|>
literal|0
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%d WARNINGS\n"
argument_list|,
name|Warnings
argument_list|)
expr_stmt|;
if|if
condition|(
name|Fatals
operator|>
literal|0
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%d FATAL ERRORS\n"
argument_list|,
name|Fatals
argument_list|)
expr_stmt|;
return|return
name|Fatals
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Y2KFixes ] */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * NTP simulator engine - Harish Nair  * University of Delaware, 2001  */
end_comment

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_include
include|#
directive|include
file|"ntpsim.h"
end_include

begin_comment
comment|/*  * Defines...  */
end_comment

begin_define
define|#
directive|define
name|SIM_TIME
value|86400
end_define

begin_comment
comment|/* end simulation time */
end_comment

begin_define
define|#
directive|define
name|NET_DLY
value|.001
end_define

begin_comment
comment|/* network delay */
end_comment

begin_define
define|#
directive|define
name|PROC_DLY
value|.001
end_define

begin_comment
comment|/* processing delay */
end_comment

begin_define
define|#
directive|define
name|BEEP_DLY
value|3600
end_define

begin_comment
comment|/* beep interval (s) */
end_comment

begin_define
define|#
directive|define
name|SLEW
value|500e-6
end_define

begin_comment
comment|/* correction rate (PPM) */
end_comment

begin_comment
comment|/*  * Function pointers  */
end_comment

begin_function_decl
name|void
function_decl|(
modifier|*
name|funcPtr
index|[]
function_decl|)
parameter_list|(
name|Node
modifier|*
parameter_list|,
name|Event
parameter_list|)
init|=
block|{
operator|&
name|ndbeep
operator|,
function_decl|&ndeclk
operator|,
function_decl|&ntptmr
operator|,
function_decl|&netpkt
end_function_decl

begin_comment
unit|};
comment|/*  * ntpsim - initialize global variables and event queue and start  */
end_comment

begin_function
name|int
name|ntpsim
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|Event
name|e
decl_stmt|;
name|double
name|maxtime
decl_stmt|;
name|struct
name|timeval
name|seed
decl_stmt|;
comment|/* 	 * Initialize the global node 	 */
name|ntp_node
operator|.
name|time
operator|=
literal|0
expr_stmt|;
comment|/* simulation time */
name|ntp_node
operator|.
name|sim_time
operator|=
name|SIM_TIME
expr_stmt|;
comment|/* end simulation time (-S) */
name|ntp_node
operator|.
name|ntp_time
operator|=
literal|0
expr_stmt|;
comment|/* client disciplined time */
name|ntp_node
operator|.
name|adj
operator|=
literal|0
expr_stmt|;
comment|/* remaining time correction */
name|ntp_node
operator|.
name|slew
operator|=
name|SLEW
expr_stmt|;
comment|/* correction rate (-H) */
name|ntp_node
operator|.
name|clk_time
operator|=
literal|0
expr_stmt|;
comment|/* server time (-O) */
name|ntp_node
operator|.
name|ferr
operator|=
literal|0
expr_stmt|;
comment|/* frequency error (-T) */
name|ntp_node
operator|.
name|fnse
operator|=
literal|0
expr_stmt|;
comment|/* random walk noise (-W) */
name|ntp_node
operator|.
name|ndly
operator|=
name|NET_DLY
expr_stmt|;
comment|/* network delay (-Y) */
name|ntp_node
operator|.
name|snse
operator|=
literal|0
expr_stmt|;
comment|/* phase noise (-C) */
name|ntp_node
operator|.
name|pdly
operator|=
name|PROC_DLY
expr_stmt|;
comment|/* processing delay (-Z) */
name|ntp_node
operator|.
name|bdly
operator|=
name|BEEP_DLY
expr_stmt|;
comment|/* beep interval (-B) */
name|ntp_node
operator|.
name|events
operator|=
name|NULL
expr_stmt|;
name|ntp_node
operator|.
name|rbuflist
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Initialize ntp variables 	 */
name|initializing
operator|=
literal|1
expr_stmt|;
name|init_auth
argument_list|()
expr_stmt|;
name|init_util
argument_list|()
expr_stmt|;
name|init_restrict
argument_list|()
expr_stmt|;
name|init_mon
argument_list|()
expr_stmt|;
name|init_timer
argument_list|()
expr_stmt|;
name|init_lib
argument_list|()
expr_stmt|;
name|init_random
argument_list|()
expr_stmt|;
name|init_request
argument_list|()
expr_stmt|;
name|init_control
argument_list|()
expr_stmt|;
name|init_peer
argument_list|()
expr_stmt|;
name|init_proto
argument_list|()
expr_stmt|;
name|init_io
argument_list|()
expr_stmt|;
name|init_loopfilter
argument_list|()
expr_stmt|;
name|mon_start
argument_list|(
name|MON_OFF
argument_list|)
expr_stmt|;
name|getconfig
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|initializing
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Watch out here, we want the real time, not the silly stuff. 	 */
name|gettimeofday
argument_list|(
operator|&
name|seed
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|srand48
argument_list|(
name|seed
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
comment|/* 	 * Push a beep and timer interrupt on the queue 	 */
name|push
argument_list|(
name|event
argument_list|(
literal|0
argument_list|,
name|BEEP
argument_list|)
argument_list|,
operator|&
name|ntp_node
operator|.
name|events
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|event
argument_list|(
name|ntp_node
operator|.
name|time
operator|+
literal|1.0
argument_list|,
name|TIMER
argument_list|)
argument_list|,
operator|&
name|ntp_node
operator|.
name|events
argument_list|)
expr_stmt|;
comment|/* 	 * Pop the queue until nothing is left or time is exceeded 	 */
name|maxtime
operator|=
name|ntp_node
operator|.
name|time
operator|+
name|ntp_node
operator|.
name|sim_time
expr_stmt|;
while|while
condition|(
name|ntp_node
operator|.
name|time
operator|<=
name|maxtime
operator|&&
name|ntp_node
operator|.
name|events
operator|!=
name|NULL
condition|)
block|{
name|e
operator|=
name|pop
argument_list|(
operator|&
name|ntp_node
operator|.
name|events
argument_list|)
expr_stmt|;
name|ndeclk
argument_list|(
operator|&
name|ntp_node
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|funcPtr
index|[
name|e
operator|.
name|function
index|]
operator|(
operator|&
name|ntp_node
operator|,
name|e
operator|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return an event  */
end_comment

begin_function
name|Event
name|event
parameter_list|(
name|double
name|t
parameter_list|,
name|funcTkn
name|f
parameter_list|)
block|{
name|Event
name|e
decl_stmt|;
name|e
operator|.
name|time
operator|=
name|t
expr_stmt|;
name|e
operator|.
name|function
operator|=
name|f
expr_stmt|;
return|return
operator|(
name|e
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Create an event queue  */
end_comment

begin_function
name|Queue
name|queue
parameter_list|(
name|Event
name|e
parameter_list|,
name|Queue
name|q
parameter_list|)
block|{
name|Queue
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
operator|(
name|Queue
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|List
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|abortsim
argument_list|(
literal|"queue-malloc"
argument_list|)
expr_stmt|;
name|ret
operator|->
name|event
operator|=
name|e
expr_stmt|;
name|ret
operator|->
name|next
operator|=
name|q
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Push an event into the event queue  */
end_comment

begin_function
name|void
name|push
parameter_list|(
name|Event
name|e
parameter_list|,
name|Queue
modifier|*
name|qp
parameter_list|)
block|{
name|Queue
modifier|*
name|tmp
init|=
name|qp
decl_stmt|;
while|while
condition|(
operator|*
name|tmp
operator|!=
name|NULL
operator|&&
operator|(
operator|(
operator|*
name|tmp
operator|)
operator|->
name|event
operator|.
name|time
operator|<
name|e
operator|.
name|time
operator|)
condition|)
name|tmp
operator|=
operator|&
operator|(
operator|(
operator|*
name|tmp
operator|)
operator|->
name|next
operator|)
expr_stmt|;
operator|*
name|tmp
operator|=
name|queue
argument_list|(
name|e
argument_list|,
operator|(
operator|*
name|tmp
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Pop the first event from the event queue  */
end_comment

begin_function
name|Event
name|pop
parameter_list|(
name|Queue
modifier|*
name|qp
parameter_list|)
block|{
name|Event
name|ret
decl_stmt|;
name|Queue
name|tmp
decl_stmt|;
name|tmp
operator|=
operator|*
name|qp
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
name|abortsim
argument_list|(
literal|"pop - empty queue"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|tmp
operator|->
name|event
expr_stmt|;
operator|*
name|qp
operator|=
name|tmp
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Update clocks  */
end_comment

begin_function
name|void
name|ndeclk
parameter_list|(
name|Node
modifier|*
name|n
parameter_list|,
name|Event
name|e
parameter_list|)
block|{
name|node_clock
argument_list|(
name|n
argument_list|,
name|e
operator|.
name|time
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Timer interrupt. Eventually, this results in calling the  * srvr_rplyi() routine below.  */
end_comment

begin_function
name|void
name|ntptmr
parameter_list|(
name|Node
modifier|*
name|n
parameter_list|,
name|Event
name|e
parameter_list|)
block|{
name|struct
name|recvbuf
modifier|*
name|rbuf
decl_stmt|;
name|timer
argument_list|()
expr_stmt|;
comment|/* 	 * Process buffers received. They had better be in order by 	 * receive timestamp. 	 */
while|while
condition|(
name|n
operator|->
name|rbuflist
operator|!=
name|NULL
condition|)
block|{
name|rbuf
operator|=
name|n
operator|->
name|rbuflist
expr_stmt|;
name|n
operator|->
name|rbuflist
operator|=
name|rbuf
operator|->
name|next
expr_stmt|;
call|(
name|rbuf
operator|->
name|receiver
call|)
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Arm the next timer interrupt. 	 */
name|push
argument_list|(
name|event
argument_list|(
name|e
operator|.
name|time
operator|+
operator|(
literal|1
operator|<<
name|EVENT_TIMEOUT
operator|)
argument_list|,
name|TIMER
argument_list|)
argument_list|,
operator|&
name|n
operator|->
name|events
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * srvr_rply() - send packet  */
end_comment

begin_function
name|int
name|srvr_rply
parameter_list|(
name|Node
modifier|*
name|n
parameter_list|,
name|struct
name|sockaddr_storage
modifier|*
name|dest
parameter_list|,
name|struct
name|interface
modifier|*
name|inter
parameter_list|,
name|struct
name|pkt
modifier|*
name|rpkt
parameter_list|)
block|{
name|struct
name|pkt
name|xpkt
decl_stmt|;
name|struct
name|recvbuf
name|rbuf
decl_stmt|;
name|Event
name|xvnt
decl_stmt|;
name|double
name|dtemp
decl_stmt|,
name|etemp
decl_stmt|;
comment|/* 	 * Insert packet header values. We make this look like a 	 * stratum-1 server with a GPS clock, but nobody will ever 	 * notice that. 	 */
name|xpkt
operator|.
name|li_vn_mode
operator|=
name|PKT_LI_VN_MODE
argument_list|(
name|LEAP_NOWARNING
argument_list|,
name|NTP_VERSION
argument_list|,
name|MODE_SERVER
argument_list|)
expr_stmt|;
name|xpkt
operator|.
name|stratum
operator|=
name|STRATUM_TO_PKT
argument_list|(
operator|(
operator|(
name|u_char
operator|)
literal|1
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|xpkt
operator|.
name|refid
argument_list|,
literal|"GPS"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|xpkt
operator|.
name|ppoll
operator|=
name|rpkt
operator|->
name|ppoll
expr_stmt|;
name|xpkt
operator|.
name|precision
operator|=
name|rpkt
operator|->
name|precision
expr_stmt|;
name|xpkt
operator|.
name|rootdelay
operator|=
literal|0
expr_stmt|;
name|xpkt
operator|.
name|rootdispersion
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Insert the timestamps. 	 */
name|xpkt
operator|.
name|org
operator|=
name|rpkt
operator|->
name|xmt
expr_stmt|;
name|dtemp
operator|=
name|poisson
argument_list|(
name|n
operator|->
name|ndly
argument_list|,
name|n
operator|->
name|snse
argument_list|)
expr_stmt|;
comment|/* client->server delay */
name|DTOLFP
argument_list|(
name|dtemp
operator|+
name|n
operator|->
name|clk_time
argument_list|,
operator|&
name|xpkt
operator|.
name|rec
argument_list|)
expr_stmt|;
name|dtemp
operator|+=
name|poisson
argument_list|(
name|n
operator|->
name|pdly
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* server delay */
name|DTOLFP
argument_list|(
name|dtemp
operator|+
name|n
operator|->
name|clk_time
argument_list|,
operator|&
name|xpkt
operator|.
name|xmt
argument_list|)
expr_stmt|;
name|xpkt
operator|.
name|reftime
operator|=
name|xpkt
operator|.
name|xmt
expr_stmt|;
name|dtemp
operator|+=
name|poisson
argument_list|(
name|n
operator|->
name|ndly
argument_list|,
name|n
operator|->
name|snse
argument_list|)
expr_stmt|;
comment|/* server->client delay */
comment|/* 	 * Insert the I/O stuff. 	 */
name|rbuf
operator|.
name|receiver
operator|=
name|receive
expr_stmt|;
name|get_systime
argument_list|(
operator|&
name|rbuf
operator|.
name|recv_time
argument_list|)
expr_stmt|;
name|rbuf
operator|.
name|recv_length
operator|=
name|LEN_PKT_NOMAC
expr_stmt|;
name|rbuf
operator|.
name|recv_pkt
operator|=
name|xpkt
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|rbuf
operator|.
name|srcadr
argument_list|,
name|dest
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|rbuf
operator|.
name|recv_srcadr
argument_list|,
name|dest
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rbuf
operator|.
name|dstadr
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|interface
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|abortsim
argument_list|(
literal|"server-malloc"
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rbuf
operator|.
name|dstadr
argument_list|,
name|inter
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|interface
argument_list|)
argument_list|)
expr_stmt|;
name|rbuf
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Very carefully predict the time of arrival for the received 	 * packet.  	 */
name|LFPTOD
argument_list|(
operator|&
name|xpkt
operator|.
name|org
argument_list|,
name|etemp
argument_list|)
expr_stmt|;
name|etemp
operator|+=
name|dtemp
expr_stmt|;
name|xvnt
operator|=
name|event
argument_list|(
name|etemp
argument_list|,
name|PACKET
argument_list|)
expr_stmt|;
name|xvnt
operator|.
name|rcv_buf
operator|=
name|rbuf
expr_stmt|;
name|push
argument_list|(
name|xvnt
argument_list|,
operator|&
name|n
operator|->
name|events
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * netpkt() - receive packet  */
end_comment

begin_function
name|void
name|netpkt
parameter_list|(
name|Node
modifier|*
name|n
parameter_list|,
name|Event
name|e
parameter_list|)
block|{
name|struct
name|recvbuf
modifier|*
name|rbuf
decl_stmt|;
name|struct
name|recvbuf
modifier|*
name|obuf
decl_stmt|;
comment|/* 	 * Insert the packet on the receive queue and record the arrival 	 * time. 	 */
if|if
condition|(
operator|(
name|rbuf
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|recvbuf
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|abortsim
argument_list|(
literal|"ntprcv-malloc"
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rbuf
argument_list|,
operator|&
name|e
operator|.
name|rcv_buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|recvbuf
argument_list|)
argument_list|)
expr_stmt|;
name|rbuf
operator|->
name|receiver
operator|=
name|receive
expr_stmt|;
name|DTOLFP
argument_list|(
name|n
operator|->
name|ntp_time
argument_list|,
operator|&
name|rbuf
operator|->
name|recv_time
argument_list|)
expr_stmt|;
name|rbuf
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|obuf
operator|=
name|n
operator|->
name|rbuflist
expr_stmt|;
comment|/* 	 * In the present incarnation, no more than one buffer can be on 	 * the queue; however, we sniff the queue anyway as a hint for 	 * further development. 	 */
if|if
condition|(
name|obuf
operator|==
name|NULL
condition|)
block|{
name|n
operator|->
name|rbuflist
operator|=
name|rbuf
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|obuf
operator|->
name|next
operator|!=
name|NULL
condition|)
name|obuf
operator|=
name|obuf
operator|->
name|next
expr_stmt|;
name|obuf
operator|->
name|next
operator|=
name|rbuf
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * ndbeep() - progress indicator  */
end_comment

begin_function
name|void
name|ndbeep
parameter_list|(
name|Node
modifier|*
name|n
parameter_list|,
name|Event
name|e
parameter_list|)
block|{
specifier|static
name|int
name|first_time
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|dash
init|=
literal|"-----------------"
decl_stmt|;
if|if
condition|(
name|n
operator|->
name|bdly
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|first_time
condition|)
block|{
name|printf
argument_list|(
literal|"\t%4c    T    %4c\t%4c  T+ERR  %3c\t%5cT+ERR+NTP\n"
argument_list|,
literal|' '
argument_list|,
literal|' '
argument_list|,
literal|' '
argument_list|,
literal|' '
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t%s\t%s\t%s\n"
argument_list|,
name|dash
argument_list|,
name|dash
argument_list|,
name|dash
argument_list|)
expr_stmt|;
name|first_time
operator|=
literal|0
expr_stmt|;
name|push
argument_list|(
name|event
argument_list|(
name|n
operator|->
name|bdly
argument_list|,
name|BEEP
argument_list|)
argument_list|,
operator|&
name|n
operator|->
name|events
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|event
argument_list|(
name|n
operator|->
name|sim_time
argument_list|,
name|BEEP
argument_list|)
argument_list|,
operator|&
name|n
operator|->
name|events
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t%16.6f\t%16.6f\t%16.6f\n"
argument_list|,
name|n
operator|->
name|time
argument_list|,
name|n
operator|->
name|clk_time
argument_list|,
name|n
operator|->
name|ntp_time
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"\t%16.6f\t%16.6f\t%16.6f\n"
argument_list|,
name|n
operator|->
name|time
argument_list|,
name|n
operator|->
name|clk_time
argument_list|,
name|n
operator|->
name|ntp_time
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|event
argument_list|(
name|e
operator|.
name|time
operator|+
name|n
operator|->
name|bdly
argument_list|,
name|BEEP
argument_list|)
argument_list|,
operator|&
name|n
operator|->
name|events
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Abort simulation  */
end_comment

begin_function
name|void
name|abortsim
parameter_list|(
name|char
modifier|*
name|errmsg
parameter_list|)
block|{
name|perror
argument_list|(
name|errmsg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * cmd_args.c = command-line argument processing  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_cmdargs.h"
end_include

begin_comment
comment|/*  * Definitions of things either imported from or exported to outside  */
end_comment

begin_decl_stmt
specifier|extern
name|char
specifier|const
modifier|*
name|progname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|listen_to_virtual_ips
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|ntp_options
init|=
literal|"aAbc:dD:f:gk:l:LmnN:p:P:qr:s:t:v:V:x"
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETINFO
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|check_netinfo
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * getstartup - search through the options looking for a debugging flag  */
end_comment

begin_function
name|void
name|getstartup
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|errflg
decl_stmt|;
specifier|extern
name|int
name|priority_done
decl_stmt|;
name|int
name|c
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|debug
operator|=
literal|0
expr_stmt|;
comment|/* no debugging by default */
endif|#
directive|endif
comment|/* 	 * This is a big hack.	We don't really want to read command line 	 * configuration until everything else is initialized, since 	 * the ability to configure the system may depend on storage 	 * and the like having been initialized.  Except that we also 	 * don't want to initialize anything until after detaching from 	 * the terminal, but we won't know to do that until we've 	 * parsed the command line.  Do that now, crudely, and do it 	 * again later.  Our ntp_getopt() is explicitly reusable, by the 	 * way.  Your own mileage may vary. 	 * 	 * This hack is even called twice (to allow complete logging to file) 	 */
name|errflg
operator|=
literal|0
expr_stmt|;
name|progname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
comment|/* 	 * Decode argument list 	 */
while|while
condition|(
operator|(
name|c
operator|=
name|ntp_getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|ntp_options
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|c
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
case|case
literal|'d'
case|:
operator|++
name|debug
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|debug
operator|=
operator|(
name|int
operator|)
name|atol
argument_list|(
name|ntp_optarg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Debug1: %s -> %x = %d\n"
argument_list|,
name|ntp_optarg
argument_list|,
name|debug
argument_list|,
name|debug
argument_list|)
expr_stmt|;
break|break;
else|#
directive|else
case|case
literal|'d'
case|:
case|case
literal|'D'
case|:
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"ntpd not compiled with -DDEBUG option - no DEBUG support"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ntpd not compiled with -DDEBUG option - no DEBUG support"
argument_list|)
expr_stmt|;
operator|++
name|errflg
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
literal|'L'
case|:
name|listen_to_virtual_ips
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
block|{
name|FILE
modifier|*
name|new_file
decl_stmt|;
name|new_file
operator|=
name|fopen
argument_list|(
name|ntp_optarg
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_file
operator|!=
name|NULL
condition|)
block|{
name|NLOG
argument_list|(
argument|NLOG_SYSINFO
argument_list|)
name|msyslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"logging to file %s"
argument_list|,
name|ntp_optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|syslog_file
operator|!=
name|NULL
operator|&&
name|fileno
argument_list|(
name|syslog_file
argument_list|)
operator|!=
name|fileno
argument_list|(
name|new_file
argument_list|)
condition|)
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|syslog_file
argument_list|)
expr_stmt|;
name|syslog_file
operator|=
name|new_file
expr_stmt|;
name|syslogit
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Cannot open log file %s"
argument_list|,
name|ntp_optarg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'n'
case|:
case|case
literal|'q'
case|:
operator|++
name|nofork
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|priority_done
operator|=
name|strcmp
argument_list|(
name|ntp_optarg
argument_list|,
literal|"high"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
operator|++
name|errflg
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|errflg
operator|||
name|ntp_optind
operator|!=
name|argc
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [ -abdgmnqx ] [ -c config_file ] [ -e e_delay ]\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t[ -f freq_file ] [ -k key_file ] [ -l log_file ]\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t[ -p pid_file ] [ -r broad_delay ] [ -s statdir ]\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t[ -t trust_key ] [ -v sys_var ] [ -V default_sysvar ]\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SCHED_SETSCHEDULER
argument_list|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t[ -P fixed_process_priority ]\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|ntp_optind
operator|=
literal|0
expr_stmt|;
comment|/* reset ntp_optind to restart ntp_getopt */
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_SETVBUF
specifier|static
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|setvbuf
argument_list|(
name|stdout
argument_list|,
name|buf
argument_list|,
name|_IOLBF
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
else|#
directive|else
name|setlinebuf
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * getCmdOpts - get command line options  */
end_comment

begin_function
name|void
name|getCmdOpts
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
specifier|extern
name|char
modifier|*
name|config_file
decl_stmt|;
name|int
name|errflg
decl_stmt|;
name|int
name|c
decl_stmt|;
comment|/* 	 * Initialize, initialize 	 */
name|errflg
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|debug
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
name|progname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
comment|/* 	 * Decode argument list 	 */
while|while
condition|(
operator|(
name|c
operator|=
name|ntp_getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|ntp_options
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
name|proto_config
argument_list|(
name|PROTO_AUTHENTICATE
argument_list|,
literal|1
argument_list|,
literal|0.
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|proto_config
argument_list|(
name|PROTO_AUTHENTICATE
argument_list|,
literal|0
argument_list|,
literal|0.
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|proto_config
argument_list|(
name|PROTO_BROADCLIENT
argument_list|,
literal|1
argument_list|,
literal|0.
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|config_file
operator|=
name|ntp_optarg
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_NETINFO
name|check_netinfo
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'d'
case|:
ifdef|#
directive|ifdef
name|DEBUG
name|debug
operator|++
expr_stmt|;
else|#
directive|else
name|errflg
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
break|break;
case|case
literal|'D'
case|:
ifdef|#
directive|ifdef
name|DEBUG
name|debug
operator|=
operator|(
name|int
operator|)
name|atol
argument_list|(
name|ntp_optarg
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Debug2: %s -> %x = %d\n"
argument_list|,
name|ntp_optarg
argument_list|,
name|debug
argument_list|,
name|debug
argument_list|)
expr_stmt|;
else|#
directive|else
name|errflg
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
break|break;
case|case
literal|'f'
case|:
name|stats_config
argument_list|(
name|STATS_FREQ_FILE
argument_list|,
name|ntp_optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|allow_panic
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|getauthkeys
argument_list|(
name|ntp_optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
comment|/* already done at pre-scan */
case|case
literal|'l'
case|:
comment|/* already done at pre-scan */
break|break;
case|case
literal|'m'
case|:
name|proto_config
argument_list|(
name|PROTO_MULTICAST_ADD
argument_list|,
name|htonl
argument_list|(
name|INADDR_NTP
argument_list|)
argument_list|,
literal|0.
argument_list|)
expr_stmt|;
name|sys_bclient
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
comment|/* already done at pre-scan */
break|break;
case|case
literal|'N'
case|:
comment|/* already done at pre-scan */
break|break;
case|case
literal|'p'
case|:
name|stats_config
argument_list|(
name|STATS_PID_FILE
argument_list|,
name|ntp_optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SCHED_SETSCHEDULER
argument_list|)
name|config_priority
operator|=
operator|(
name|int
operator|)
name|atol
argument_list|(
name|ntp_optarg
argument_list|)
expr_stmt|;
name|config_priority_override
operator|=
literal|1
expr_stmt|;
else|#
directive|else
name|errflg
operator|++
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'q'
case|:
name|mode_ntpdate
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
do|do
block|{
name|double
name|tmp
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|ntp_optarg
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"command line broadcast delay value %s undecodable"
argument_list|,
name|ntp_optarg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|proto_config
argument_list|(
name|PROTO_BROADDELAY
argument_list|,
literal|0
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
literal|0
condition|)
do|;
break|break;
case|case
literal|'s'
case|:
name|stats_config
argument_list|(
name|STATS_STATSDIR
argument_list|,
name|ntp_optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
do|do
block|{
name|u_long
name|tkey
decl_stmt|;
name|tkey
operator|=
operator|(
name|int
operator|)
name|atol
argument_list|(
name|ntp_optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tkey
operator|<=
literal|0
operator|||
name|tkey
operator|>
name|NTP_MAXKEY
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"command line trusted key %s is invalid"
argument_list|,
name|ntp_optarg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|authtrust
argument_list|(
name|tkey
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
literal|0
condition|)
do|;
break|break;
case|case
literal|'v'
case|:
case|case
literal|'V'
case|:
name|set_sys_var
argument_list|(
name|ntp_optarg
argument_list|,
name|strlen
argument_list|(
name|ntp_optarg
argument_list|)
operator|+
literal|1
argument_list|,
name|RW
operator||
operator|(
operator|(
name|c
operator|==
literal|'V'
operator|)
condition|?
name|DEF
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|allow_step
operator|=
name|FALSE
expr_stmt|;
break|break;
default|default:
name|errflg
operator|++
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|errflg
operator|||
name|ntp_optind
operator|!=
name|argc
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [ -abdgmnx ] [ -c config_file ] [ -e e_delay ]\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t[ -f freq_file ] [ -k key_file ] [ -l log_file ]\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t[ -p pid_file ] [ -r broad_delay ] [ -s statdir ]\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t[ -t trust_key ] [ -v sys_var ] [ -V default_sysvar ]\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SCHED_SETSCHEDULER
argument_list|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t\t[ -P fixed_process_priority ]\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

end_unit


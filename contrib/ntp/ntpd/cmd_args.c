begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * cmd_args.c = command-line argument processing  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_config.h"
end_include

begin_include
include|#
directive|include
file|"ntp_cmdargs.h"
end_include

begin_include
include|#
directive|include
file|"ntpd-opts.h"
end_include

begin_comment
comment|/*  * Definitions of things either imported from or exported to outside  */
end_comment

begin_decl_stmt
specifier|extern
name|char
specifier|const
modifier|*
name|progname
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETINFO
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|check_netinfo
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * getCmdOpts - apply most command line options  *  * A few options are examined earlier in ntpd.c ntpdmain() and  * ports/winnt/ntpd/ntservice.c main().  */
end_comment

begin_function
name|void
name|getCmdOpts
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|extern
specifier|const
name|char
modifier|*
name|config_file
decl_stmt|;
name|int
name|errflg
decl_stmt|;
comment|/* 	 * Initialize, initialize 	 */
name|errflg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ipv4_works
operator|&&
name|ipv6_works
condition|)
block|{
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|IPV4
argument_list|)
condition|)
name|ipv6_works
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|IPV6
argument_list|)
condition|)
name|ipv4_works
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|ipv4_works
operator|&&
operator|!
name|ipv6_works
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Neither IPv4 nor IPv6 networking detected, fatal."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|IPV4
argument_list|)
operator|&&
operator|!
name|ipv4_works
condition|)
name|msyslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"-4/--ipv4 ignored, IPv4 networking not found."
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|IPV6
argument_list|)
operator|&&
operator|!
name|ipv6_works
condition|)
name|msyslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"-6/--ipv6 ignored, IPv6 networking not found."
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|AUTHREQ
argument_list|)
condition|)
name|proto_config
argument_list|(
name|PROTO_AUTHENTICATE
argument_list|,
literal|1
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|AUTHNOREQ
argument_list|)
condition|)
name|proto_config
argument_list|(
name|PROTO_AUTHENTICATE
argument_list|,
literal|0
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|BCASTSYNC
argument_list|)
condition|)
name|proto_config
argument_list|(
name|PROTO_BROADCLIENT
argument_list|,
literal|1
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|CONFIGFILE
argument_list|)
condition|)
block|{
name|config_file
operator|=
name|OPT_ARG
argument_list|(
name|CONFIGFILE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_NETINFO
name|check_netinfo
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|DRIFTFILE
argument_list|)
condition|)
name|stats_config
argument_list|(
name|STATS_FREQ_FILE
argument_list|,
name|OPT_ARG
argument_list|(
name|DRIFTFILE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|PANICGATE
argument_list|)
condition|)
name|allow_panic
operator|=
name|TRUE
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_DROPROOT
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|JAILDIR
argument_list|)
condition|)
block|{
name|droproot
operator|=
literal|1
expr_stmt|;
name|chrootdir
operator|=
name|OPT_ARG
argument_list|(
name|JAILDIR
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|KEYFILE
argument_list|)
condition|)
name|getauthkeys
argument_list|(
name|OPT_ARG
argument_list|(
name|KEYFILE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|PIDFILE
argument_list|)
condition|)
name|stats_config
argument_list|(
name|STATS_PID_FILE
argument_list|,
name|OPT_ARG
argument_list|(
name|PIDFILE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|QUIT
argument_list|)
condition|)
name|mode_ntpdate
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|PROPAGATIONDELAY
argument_list|)
condition|)
do|do
block|{
name|double
name|tmp
decl_stmt|;
specifier|const
name|char
modifier|*
name|my_ntp_optarg
init|=
name|OPT_ARG
argument_list|(
name|PROPAGATIONDELAY
argument_list|)
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|my_ntp_optarg
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"command line broadcast delay value %s undecodable"
argument_list|,
name|my_ntp_optarg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|proto_config
argument_list|(
name|PROTO_BROADDELAY
argument_list|,
literal|0
argument_list|,
name|tmp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
literal|0
condition|)
do|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|STATSDIR
argument_list|)
condition|)
name|stats_config
argument_list|(
name|STATS_STATSDIR
argument_list|,
name|OPT_ARG
argument_list|(
name|STATSDIR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|TRUSTEDKEY
argument_list|)
condition|)
block|{
name|int
name|ct
init|=
name|STACKCT_OPT
argument_list|(
name|TRUSTEDKEY
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|pp
init|=
name|STACKLST_OPT
argument_list|(
name|TRUSTEDKEY
argument_list|)
decl_stmt|;
do|do
block|{
name|u_long
name|tkey
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
init|=
operator|*
name|pp
operator|++
decl_stmt|;
name|tkey
operator|=
operator|(
name|int
operator|)
name|atol
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|tkey
operator|==
literal|0
operator|||
name|tkey
operator|>
name|NTP_MAXKEY
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"command line trusted key %s is invalid"
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|authtrust
argument_list|(
name|tkey
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|--
name|ct
operator|>
literal|0
condition|)
do|;
block|}
ifdef|#
directive|ifdef
name|HAVE_DROPROOT
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|USER
argument_list|)
condition|)
block|{
name|droproot
operator|=
literal|1
expr_stmt|;
name|user
operator|=
name|estrdup
argument_list|(
name|OPT_ARG
argument_list|(
name|USER
argument_list|)
argument_list|)
expr_stmt|;
name|group
operator|=
name|strrchr
argument_list|(
name|user
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|!=
name|NULL
condition|)
block|{
name|size_t
name|len
decl_stmt|;
operator|*
name|group
operator|++
operator|=
literal|'\0'
expr_stmt|;
comment|/* get rid of the ':' */
name|len
operator|=
name|group
operator|-
name|user
expr_stmt|;
name|group
operator|=
name|estrdup
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|user
operator|=
name|erealloc
argument_list|(
name|user
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|VAR
argument_list|)
condition|)
block|{
name|int
name|ct
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|pp
decl_stmt|;
specifier|const
name|char
modifier|*
name|v_assign
decl_stmt|;
name|ct
operator|=
name|STACKCT_OPT
argument_list|(
name|VAR
argument_list|)
expr_stmt|;
name|pp
operator|=
name|STACKLST_OPT
argument_list|(
name|VAR
argument_list|)
expr_stmt|;
do|do
block|{
name|v_assign
operator|=
operator|*
name|pp
operator|++
expr_stmt|;
name|set_sys_var
argument_list|(
name|v_assign
argument_list|,
name|strlen
argument_list|(
name|v_assign
argument_list|)
operator|+
literal|1
argument_list|,
name|RW
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|ct
operator|>
literal|0
condition|)
do|;
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|DVAR
argument_list|)
condition|)
block|{
name|int
name|ct
init|=
name|STACKCT_OPT
argument_list|(
name|DVAR
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|pp
init|=
name|STACKLST_OPT
argument_list|(
name|DVAR
argument_list|)
decl_stmt|;
do|do
block|{
specifier|const
name|char
modifier|*
name|my_ntp_optarg
init|=
operator|*
name|pp
operator|++
decl_stmt|;
name|set_sys_var
argument_list|(
name|my_ntp_optarg
argument_list|,
name|strlen
argument_list|(
name|my_ntp_optarg
argument_list|)
operator|+
literal|1
argument_list|,
call|(
name|u_short
call|)
argument_list|(
name|RW
operator||
name|DEF
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|ct
operator|>
literal|0
condition|)
do|;
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|SLEW
argument_list|)
condition|)
name|loop_config
argument_list|(
name|LOOP_MAX
argument_list|,
literal|600
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|UPDATEINTERVAL
argument_list|)
condition|)
block|{
name|long
name|val
init|=
name|OPT_VALUE_UPDATEINTERVAL
decl_stmt|;
if|if
condition|(
name|val
operator|>=
literal|0
condition|)
name|interface_interval
operator|=
name|val
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"command line interface update interval %ld must not be negative\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"command line interface update interval %ld must not be negative"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|errflg
operator|++
expr_stmt|;
block|}
block|}
comment|/* save list of servers from cmd line for config_peers() use */
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|cmdline_server_count
operator|=
name|argc
expr_stmt|;
name|cmdline_servers
operator|=
name|argv
expr_stmt|;
block|}
comment|/* display usage& exit with any option processing errors */
if|if
condition|(
name|errflg
condition|)
name|optionUsage
argument_list|(
operator|&
name|ntpdOptions
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* does not return */
block|}
end_function

end_unit


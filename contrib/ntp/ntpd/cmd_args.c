begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * cmd_args.c = command-line argument processing  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_cmdargs.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SIM
end_ifdef

begin_include
include|#
directive|include
file|"ntpsim.h"
end_include

begin_include
include|#
directive|include
file|"ntpdsim-opts.h"
end_include

begin_define
define|#
directive|define
name|OPTSTRUCT
value|ntpdsimOptions
end_define

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"ntpd-opts.h"
end_include

begin_define
define|#
directive|define
name|OPTSTRUCT
value|ntpdOptions
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SIM */
end_comment

begin_comment
comment|/*  * Definitions of things either imported from or exported to outside  */
end_comment

begin_decl_stmt
specifier|extern
name|char
specifier|const
modifier|*
name|progname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
specifier|const
name|char
modifier|*
name|specific_interface
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|short
name|default_ai_family
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETINFO
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|check_netinfo
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * getCmdOpts - get command line options  */
end_comment

begin_function
name|void
name|getCmdOpts
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
specifier|extern
specifier|const
name|char
modifier|*
name|config_file
decl_stmt|;
name|int
name|errflg
decl_stmt|;
name|tOptions
modifier|*
name|myOptions
init|=
operator|&
name|OPTSTRUCT
decl_stmt|;
comment|/* 	 * Initialize, initialize 	 */
name|errflg
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|WHICH_IDX_IPV4
condition|)
block|{
case|case
name|INDEX_OPT_IPV4
case|:
name|default_ai_family
operator|=
name|AF_INET
expr_stmt|;
break|break;
case|case
name|INDEX_OPT_IPV6
case|:
name|default_ai_family
operator|=
name|AF_INET6
expr_stmt|;
break|break;
default|default:
comment|/* ai_fam_templ = ai_fam_default;	*/
break|break;
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|AUTHREQ
argument_list|)
condition|)
name|proto_config
argument_list|(
name|PROTO_AUTHENTICATE
argument_list|,
literal|1
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|AUTHNOREQ
argument_list|)
condition|)
name|proto_config
argument_list|(
name|PROTO_AUTHENTICATE
argument_list|,
literal|0
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|BCASTSYNC
argument_list|)
condition|)
name|proto_config
argument_list|(
name|PROTO_BROADCLIENT
argument_list|,
literal|1
argument_list|,
literal|0.
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|CONFIGFILE
argument_list|)
condition|)
block|{
name|config_file
operator|=
name|OPT_ARG
argument_list|(
name|CONFIGFILE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_NETINFO
name|check_netinfo
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|DRIFTFILE
argument_list|)
condition|)
name|stats_config
argument_list|(
name|STATS_FREQ_FILE
argument_list|,
name|OPT_ARG
argument_list|(
name|DRIFTFILE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|PANICGATE
argument_list|)
condition|)
name|allow_panic
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|JAILDIR
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_DROPROOT
name|droproot
operator|=
literal|1
expr_stmt|;
name|chrootdir
operator|=
name|OPT_ARG
argument_list|(
name|JAILDIR
argument_list|)
expr_stmt|;
else|#
directive|else
name|errflg
operator|++
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|KEYFILE
argument_list|)
condition|)
name|getauthkeys
argument_list|(
name|OPT_ARG
argument_list|(
name|KEYFILE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|PIDFILE
argument_list|)
condition|)
name|stats_config
argument_list|(
name|STATS_PID_FILE
argument_list|,
name|OPT_ARG
argument_list|(
name|PIDFILE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|QUIT
argument_list|)
condition|)
name|mode_ntpdate
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|PROPAGATIONDELAY
argument_list|)
condition|)
do|do
block|{
name|double
name|tmp
decl_stmt|;
specifier|const
name|char
modifier|*
name|my_ntp_optarg
init|=
name|OPT_ARG
argument_list|(
name|PROPAGATIONDELAY
argument_list|)
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|my_ntp_optarg
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"command line broadcast delay value %s undecodable"
argument_list|,
name|my_ntp_optarg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|proto_config
argument_list|(
name|PROTO_BROADDELAY
argument_list|,
literal|0
argument_list|,
name|tmp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
literal|0
condition|)
do|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|STATSDIR
argument_list|)
condition|)
name|stats_config
argument_list|(
name|STATS_STATSDIR
argument_list|,
name|OPT_ARG
argument_list|(
name|STATSDIR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|TRUSTEDKEY
argument_list|)
condition|)
block|{
name|int
name|ct
init|=
name|STACKCT_OPT
argument_list|(
name|TRUSTEDKEY
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|pp
init|=
name|STACKLST_OPT
argument_list|(
name|TRUSTEDKEY
argument_list|)
decl_stmt|;
do|do
block|{
name|u_long
name|tkey
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
init|=
operator|*
name|pp
operator|++
decl_stmt|;
name|tkey
operator|=
operator|(
name|int
operator|)
name|atol
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|tkey
operator|==
literal|0
operator|||
name|tkey
operator|>
name|NTP_MAXKEY
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"command line trusted key %s is invalid"
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|authtrust
argument_list|(
name|tkey
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|--
name|ct
operator|>
literal|0
condition|)
do|;
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|USER
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_DROPROOT
name|char
modifier|*
name|ntp_optarg
init|=
name|OPT_ARG
argument_list|(
name|USER
argument_list|)
decl_stmt|;
name|droproot
operator|=
literal|1
expr_stmt|;
name|user
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|ntp_optarg
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
name|errflg
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|user
argument_list|,
name|ntp_optarg
argument_list|,
name|strlen
argument_list|(
name|ntp_optarg
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|group
operator|=
name|rindex
argument_list|(
name|user
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
condition|)
operator|*
name|group
operator|++
operator|=
literal|'\0'
expr_stmt|;
comment|/* get rid of the ':' */
block|}
else|#
directive|else
name|errflg
operator|++
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|VAR
argument_list|)
condition|)
block|{
name|int
name|ct
init|=
name|STACKCT_OPT
argument_list|(
name|VAR
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|pp
init|=
name|STACKLST_OPT
argument_list|(
name|VAR
argument_list|)
decl_stmt|;
do|do
block|{
specifier|const
name|char
modifier|*
name|my_ntp_optarg
init|=
operator|*
name|pp
operator|++
decl_stmt|;
name|set_sys_var
argument_list|(
name|my_ntp_optarg
argument_list|,
name|strlen
argument_list|(
name|my_ntp_optarg
argument_list|)
operator|+
literal|1
argument_list|,
call|(
name|u_short
call|)
argument_list|(
name|RW
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|ct
operator|>
literal|0
condition|)
do|;
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|DVAR
argument_list|)
condition|)
block|{
name|int
name|ct
init|=
name|STACKCT_OPT
argument_list|(
name|DVAR
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|pp
init|=
name|STACKLST_OPT
argument_list|(
name|DVAR
argument_list|)
decl_stmt|;
do|do
block|{
specifier|const
name|char
modifier|*
name|my_ntp_optarg
init|=
operator|*
name|pp
operator|++
decl_stmt|;
name|set_sys_var
argument_list|(
name|my_ntp_optarg
argument_list|,
name|strlen
argument_list|(
name|my_ntp_optarg
argument_list|)
operator|+
literal|1
argument_list|,
call|(
name|u_short
call|)
argument_list|(
name|RW
operator||
name|DEF
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|ct
operator|>
literal|0
condition|)
do|;
block|}
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|SLEW
argument_list|)
condition|)
name|clock_max
operator|=
literal|600
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|UPDATEINTERVAL
argument_list|)
condition|)
block|{
name|long
name|val
init|=
name|OPT_VALUE_UPDATEINTERVAL
decl_stmt|;
if|if
condition|(
name|val
operator|>=
literal|0
condition|)
name|interface_interval
operator|=
name|val
expr_stmt|;
else|else
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"command line interface update interval %ld must be greater or equal to 0"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|errflg
operator|++
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|SIM
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|SIMBROADCASTDELAY
argument_list|)
condition|)
name|sscanf
argument_list|(
name|OPT_ARG
argument_list|(
name|SIMBROADCASTDELAY
argument_list|)
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|ntp_node
operator|.
name|bdly
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|PHASENOISE
argument_list|)
condition|)
name|sscanf
argument_list|(
name|OPT_ARG
argument_list|(
name|PHASENOISE
argument_list|)
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|ntp_node
operator|.
name|snse
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|SIMSLEW
argument_list|)
condition|)
name|sscanf
argument_list|(
name|OPT_ARG
argument_list|(
name|SIMSLEW
argument_list|)
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|ntp_node
operator|.
name|slew
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|SERVERTIME
argument_list|)
condition|)
name|sscanf
argument_list|(
name|OPT_ARG
argument_list|(
name|SERVERTIME
argument_list|)
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|ntp_node
operator|.
name|clk_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|ENDSIMTIME
argument_list|)
condition|)
name|sscanf
argument_list|(
name|OPT_ARG
argument_list|(
name|ENDSIMTIME
argument_list|)
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|ntp_node
operator|.
name|sim_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|FREQERR
argument_list|)
condition|)
name|sscanf
argument_list|(
name|OPT_ARG
argument_list|(
name|FREQERR
argument_list|)
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|ntp_node
operator|.
name|ferr
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|WALKNOISE
argument_list|)
condition|)
name|sscanf
argument_list|(
name|OPT_ARG
argument_list|(
name|WALKNOISE
argument_list|)
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|ntp_node
operator|.
name|fnse
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|NDELAY
argument_list|)
condition|)
name|sscanf
argument_list|(
name|OPT_ARG
argument_list|(
name|NDELAY
argument_list|)
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|ntp_node
operator|.
name|ndly
argument_list|)
expr_stmt|;
if|if
condition|(
name|HAVE_OPT
argument_list|(
name|PDELAY
argument_list|)
condition|)
name|sscanf
argument_list|(
name|OPT_ARG
argument_list|(
name|PDELAY
argument_list|)
argument_list|,
literal|"%lf"
argument_list|,
operator|&
name|ntp_node
operator|.
name|pdly
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SIM */
if|if
condition|(
name|errflg
operator|||
name|argc
condition|)
block|{
name|printf
argument_list|(
literal|"argc is<%d>\n"
argument_list|,
name|argc
argument_list|)
expr_stmt|;
name|optionUsage
argument_list|(
name|myOptions
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

end_unit


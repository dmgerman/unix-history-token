begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<yaml.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|help
init|=
literal|0
decl_stmt|;
name|int
name|canonical
init|=
literal|0
decl_stmt|;
name|int
name|unicode
init|=
literal|0
decl_stmt|;
name|int
name|k
decl_stmt|;
name|int
name|done
init|=
literal|0
decl_stmt|;
name|yaml_parser_t
name|parser
decl_stmt|;
name|yaml_emitter_t
name|emitter
decl_stmt|;
name|yaml_document_t
name|document
decl_stmt|;
comment|/* Clear the objects. */
name|memset
argument_list|(
operator|&
name|parser
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|parser
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|emitter
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|emitter
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|document
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|document
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Analyze command line options. */
for|for
control|(
name|k
operator|=
literal|1
init|;
name|k
operator|<
name|argc
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|k
index|]
argument_list|,
literal|"-h"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|argv
index|[
name|k
index|]
argument_list|,
literal|"--help"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|help
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|k
index|]
argument_list|,
literal|"-c"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|argv
index|[
name|k
index|]
argument_list|,
literal|"--canonical"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|canonical
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|k
index|]
argument_list|,
literal|"-u"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|argv
index|[
name|k
index|]
argument_list|,
literal|"--unicode"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|unicode
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unrecognized option: %s\n"
literal|"Try `%s --help` for more information.\n"
argument_list|,
name|argv
index|[
name|k
index|]
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
comment|/* Display the help string. */
if|if
condition|(
name|help
condition|)
block|{
name|printf
argument_list|(
literal|"%s [--canonical] [--unicode]<input>output\n"
literal|"or\n%s -h | --help\nReformat a YAML stream\n\nOptions:\n"
literal|"-h, --help\t\tdisplay this help and exit\n"
literal|"-c, --canonical\t\toutput in the canonical YAML format\n"
literal|"-u, --unicode\t\toutput unescaped non-ASCII characters\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Initialize the parser and emitter objects. */
if|if
condition|(
operator|!
name|yaml_parser_initialize
argument_list|(
operator|&
name|parser
argument_list|)
condition|)
goto|goto
name|parser_error
goto|;
if|if
condition|(
operator|!
name|yaml_emitter_initialize
argument_list|(
operator|&
name|emitter
argument_list|)
condition|)
goto|goto
name|emitter_error
goto|;
comment|/* Set the parser parameters. */
name|yaml_parser_set_input_file
argument_list|(
operator|&
name|parser
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
comment|/* Set the emitter parameters. */
name|yaml_emitter_set_output_file
argument_list|(
operator|&
name|emitter
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|yaml_emitter_set_canonical
argument_list|(
operator|&
name|emitter
argument_list|,
name|canonical
argument_list|)
expr_stmt|;
name|yaml_emitter_set_unicode
argument_list|(
operator|&
name|emitter
argument_list|,
name|unicode
argument_list|)
expr_stmt|;
comment|/* The main loop. */
while|while
condition|(
operator|!
name|done
condition|)
block|{
comment|/* Get the next event. */
if|if
condition|(
operator|!
name|yaml_parser_load
argument_list|(
operator|&
name|parser
argument_list|,
operator|&
name|document
argument_list|)
condition|)
goto|goto
name|parser_error
goto|;
comment|/* Check if this is the stream end. */
if|if
condition|(
operator|!
name|yaml_document_get_root_node
argument_list|(
operator|&
name|document
argument_list|)
condition|)
block|{
name|done
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Emit the event. */
if|if
condition|(
operator|!
name|yaml_emitter_dump
argument_list|(
operator|&
name|emitter
argument_list|,
operator|&
name|document
argument_list|)
condition|)
goto|goto
name|emitter_error
goto|;
block|}
name|yaml_parser_delete
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|yaml_emitter_delete
argument_list|(
operator|&
name|emitter
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|parser_error
label|:
comment|/* Display a parser error message. */
switch|switch
condition|(
name|parser
operator|.
name|error
condition|)
block|{
case|case
name|YAML_MEMORY_ERROR
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Memory error: Not enough memory for parsing\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|YAML_READER_ERROR
case|:
if|if
condition|(
name|parser
operator|.
name|problem_value
operator|!=
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Reader error: %s: #%X at %d\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_value
argument_list|,
name|parser
operator|.
name|problem_offset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Reader error: %s at %d\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_offset
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|YAML_SCANNER_ERROR
case|:
if|if
condition|(
name|parser
operator|.
name|context
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Scanner error: %s at line %d, column %d\n"
literal|"%s at line %d, column %d\n"
argument_list|,
name|parser
operator|.
name|context
argument_list|,
name|parser
operator|.
name|context_mark
operator|.
name|line
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|context_mark
operator|.
name|column
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|line
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|column
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Scanner error: %s at line %d, column %d\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|line
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|column
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|YAML_PARSER_ERROR
case|:
if|if
condition|(
name|parser
operator|.
name|context
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Parser error: %s at line %d, column %d\n"
literal|"%s at line %d, column %d\n"
argument_list|,
name|parser
operator|.
name|context
argument_list|,
name|parser
operator|.
name|context_mark
operator|.
name|line
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|context_mark
operator|.
name|column
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|line
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|column
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Parser error: %s at line %d, column %d\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|line
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|column
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|YAML_COMPOSER_ERROR
case|:
if|if
condition|(
name|parser
operator|.
name|context
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Composer error: %s at line %d, column %d\n"
literal|"%s at line %d, column %d\n"
argument_list|,
name|parser
operator|.
name|context
argument_list|,
name|parser
operator|.
name|context_mark
operator|.
name|line
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|context_mark
operator|.
name|column
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|line
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|column
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Composer error: %s at line %d, column %d\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|line
operator|+
literal|1
argument_list|,
name|parser
operator|.
name|problem_mark
operator|.
name|column
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* Couldn't happen. */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Internal error\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|yaml_parser_delete
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|yaml_emitter_delete
argument_list|(
operator|&
name|emitter
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
name|emitter_error
label|:
comment|/* Display an emitter error message. */
switch|switch
condition|(
name|emitter
operator|.
name|error
condition|)
block|{
case|case
name|YAML_MEMORY_ERROR
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Memory error: Not enough memory for emitting\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|YAML_WRITER_ERROR
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Writer error: %s\n"
argument_list|,
name|emitter
operator|.
name|problem
argument_list|)
expr_stmt|;
break|break;
case|case
name|YAML_EMITTER_ERROR
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Emitter error: %s\n"
argument_list|,
name|emitter
operator|.
name|problem
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Couldn't happen. */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Internal error\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|yaml_parser_delete
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|yaml_emitter_delete
argument_list|(
operator|&
name|emitter
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

end_unit


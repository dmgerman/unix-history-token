begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<yaml.h>
end_include

begin_macro
name|YAML_DECLARE
argument_list|(
argument|int
argument_list|)
end_macro

begin_macro
name|yaml_parser_update_buffer
argument_list|(
argument|yaml_parser_t *parser
argument_list|,
argument|size_t length
argument_list|)
end_macro

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|NDEBUG
end_ifdef

begin_undef
undef|#
directive|undef
name|NDEBUG
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_comment
comment|/*  * Test cases are stolen from  * http://www.cl.cam.ac.uk/~mgk25/ucs/examples/UTF-8-test.txt  */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|char
modifier|*
name|title
decl_stmt|;
name|char
modifier|*
name|test
decl_stmt|;
name|int
name|result
decl_stmt|;
block|}
name|test_case
typedef|;
end_typedef

begin_decl_stmt
name|test_case
name|utf8_sequences
index|[]
init|=
block|{
comment|/* {"title", "test 1|test 2|...|test N!", (0 or 1)}, */
block|{
literal|"a simple test"
block|,
literal|"'test' is '\xd0\xbf\xd1\x80\xd0\xbe\xd0\xb2\xd0\xb5\xd1\x80\xd0\xba\xd0\xb0' in Russian!"
block|,
literal|1
block|}
block|,
block|{
literal|"an empty line"
block|,
literal|"!"
block|,
literal|1
block|}
block|,
block|{
literal|"u-0 is a control character"
block|,
literal|"\x00!"
block|,
literal|0
block|}
block|,
block|{
literal|"u-80 is a control character"
block|,
literal|"\xc2\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"u-800 is valid"
block|,
literal|"\xe0\xa0\x80!"
block|,
literal|1
block|}
block|,
block|{
literal|"u-10000 is valid"
block|,
literal|"\xf0\x90\x80\x80!"
block|,
literal|1
block|}
block|,
block|{
literal|"5 bytes sequences are not allowed"
block|,
literal|"\xf8\x88\x80\x80\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"6 bytes sequences are not allowed"
block|,
literal|"\xfc\x84\x80\x80\x80\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"u-7f is a control character"
block|,
literal|"\x7f!"
block|,
literal|0
block|}
block|,
block|{
literal|"u-7FF is valid"
block|,
literal|"\xdf\xbf!"
block|,
literal|1
block|}
block|,
block|{
literal|"u-FFFF is a control character"
block|,
literal|"\xef\xbf\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"u-1FFFFF is too large"
block|,
literal|"\xf7\xbf\xbf\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"u-3FFFFFF is 5 bytes"
block|,
literal|"\xfb\xbf\xbf\xbf\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"u-7FFFFFFF is 6 bytes"
block|,
literal|"\xfd\xbf\xbf\xbf\xbf\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"u-D7FF"
block|,
literal|"\xed\x9f\xbf!"
block|,
literal|1
block|}
block|,
block|{
literal|"u-E000"
block|,
literal|"\xee\x80\x80!"
block|,
literal|1
block|}
block|,
block|{
literal|"u-FFFD"
block|,
literal|"\xef\xbf\xbd!"
block|,
literal|1
block|}
block|,
block|{
literal|"u-10FFFF"
block|,
literal|"\xf4\x8f\xbf\xbf!"
block|,
literal|1
block|}
block|,
block|{
literal|"u-110000"
block|,
literal|"\xf4\x90\x80\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"first continuation byte"
block|,
literal|"\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"last continuation byte"
block|,
literal|"\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"2 continuation bytes"
block|,
literal|"\x80\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"3 continuation bytes"
block|,
literal|"\x80\xbf\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"4 continuation bytes"
block|,
literal|"\x80\xbf\x80\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"5 continuation bytes"
block|,
literal|"\x80\xbf\x80\xbf\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"6 continuation bytes"
block|,
literal|"\x80\xbf\x80\xbf\x80\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"7 continuation bytes"
block|,
literal|"\x80\xbf\x80\xbf\x80\xbf\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"sequence of all 64 possible continuation bytes"
block|,
literal|"\x80|\x81|\x82|\x83|\x84|\x85|\x86|\x87|\x88|\x89|\x8a|\x8b|\x8c|\x8d|\x8e|\x8f|"
literal|"\x90|\x91|\x92|\x93|\x94|\x95|\x96|\x97|\x98|\x99|\x9a|\x9b|\x9c|\x9d|\x9e|\x9f|"
literal|"\xa0|\xa1|\xa2|\xa3|\xa4|\xa5|\xa6|\xa7|\xa8|\xa9|\xaa|\xab|\xac|\xad|\xae|\xaf|"
literal|"\xb0|\xb1|\xb2|\xb3|\xb4|\xb5|\xb6|\xb7|\xb8|\xb9|\xba|\xbb|\xbc|\xbd|\xbe|\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"32 first bytes of 2-byte sequences {0xc0-0xdf}"
block|,
literal|"\xc0 |\xc1 |\xc2 |\xc3 |\xc4 |\xc5 |\xc6 |\xc7 |\xc8 |\xc9 |\xca |\xcb |\xcc |\xcd |\xce |\xcf |"
literal|"\xd0 |\xd1 |\xd2 |\xd3 |\xd4 |\xd5 |\xd6 |\xd7 |\xd8 |\xd9 |\xda |\xdb |\xdc |\xdd |\xde |\xdf !"
block|,
literal|0
block|}
block|,
block|{
literal|"16 first bytes of 3-byte sequences {0xe0-0xef}"
block|,
literal|"\xe0 |\xe1 |\xe2 |\xe3 |\xe4 |\xe5 |\xe6 |\xe7 |\xe8 |\xe9 |\xea |\xeb |\xec |\xed |\xee |\xef !"
block|,
literal|0
block|}
block|,
block|{
literal|"8 first bytes of 4-byte sequences {0xf0-0xf7}"
block|,
literal|"\xf0 |\xf1 |\xf2 |\xf3 |\xf4 |\xf5 |\xf6 |\xf7 !"
block|,
literal|0
block|}
block|,
block|{
literal|"4 first bytes of 5-byte sequences {0xf8-0xfb}"
block|,
literal|"\xf8 |\xf9 |\xfa |\xfb !"
block|,
literal|0
block|}
block|,
block|{
literal|"2 first bytes of 6-byte sequences {0xfc-0xfd}"
block|,
literal|"\xfc |\xfd !"
block|,
literal|0
block|}
block|,
block|{
literal|"sequences with last byte missing {u-0}"
block|,
literal|"\xc0|\xe0\x80|\xf0\x80\x80|\xf8\x80\x80\x80|\xfc\x80\x80\x80\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"sequences with last byte missing {u-...FF}"
block|,
literal|"\xdf|\xef\xbf|\xf7\xbf\xbf|\xfb\xbf\xbf\xbf|\xfd\xbf\xbf\xbf\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"impossible bytes"
block|,
literal|"\xfe|\xff|\xfe\xfe\xff\xff!"
block|,
literal|0
block|}
block|,
block|{
literal|"overlong sequences {u-2f}"
block|,
literal|"\xc0\xaf|\xe0\x80\xaf|\xf0\x80\x80\xaf|\xf8\x80\x80\x80\xaf|\xfc\x80\x80\x80\x80\xaf!"
block|,
literal|0
block|}
block|,
block|{
literal|"maximum overlong sequences"
block|,
literal|"\xc1\xbf|\xe0\x9f\xbf|\xf0\x8f\xbf\xbf|\xf8\x87\xbf\xbf\xbf|\xfc\x83\xbf\xbf\xbf\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"overlong representation of the NUL character"
block|,
literal|"\xc0\x80|\xe0\x80\x80|\xf0\x80\x80\x80|\xf8\x80\x80\x80\x80|\xfc\x80\x80\x80\x80\x80!"
block|,
literal|0
block|}
block|,
block|{
literal|"single UTF-16 surrogates"
block|,
literal|"\xed\xa0\x80|\xed\xad\xbf|\xed\xae\x80|\xed\xaf\xbf|\xed\xb0\x80|\xed\xbe\x80|\xed\xbf\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"paired UTF-16 surrogates"
block|,
literal|"\xed\xa0\x80\xed\xb0\x80|\xed\xa0\x80\xed\xbf\xbf|\xed\xad\xbf\xed\xb0\x80|"
literal|"\xed\xad\xbf\xed\xbf\xbf|\xed\xae\x80\xed\xb0\x80|\xed\xae\x80\xed\xbf\xbf|"
literal|"\xed\xaf\xbf\xed\xb0\x80|\xed\xaf\xbf\xed\xbf\xbf!"
block|,
literal|0
block|}
block|,
block|{
literal|"other illegal code positions"
block|,
literal|"\xef\xbf\xbe|\xef\xbf\xbf!"
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|test_case
name|boms
index|[]
init|=
block|{
comment|/* {"title", "test!", lenth}, */
block|{
literal|"no bom (utf-8)"
block|,
literal|"Hi is \xd0\x9f\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82!"
block|,
literal|13
block|}
block|,
block|{
literal|"bom (utf-8)"
block|,
literal|"\xef\xbb\xbfHi is \xd0\x9f\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82!"
block|,
literal|13
block|}
block|,
block|{
literal|"bom (utf-16-le)"
block|,
literal|"\xff\xfeH\x00i\x00 \x00i\x00s\x00 \x00\x1f\x04@\x04"
literal|"8\x04"
literal|"2\x04"
literal|"5\x04"
literal|"B\x04!"
block|,
literal|13
block|}
block|,
block|{
literal|"bom (utf-16-be)"
block|,
literal|"\xfe\xff\x00H\x00i\x00 \x00i\x00s\x00 \x04\x1f\x04@\x04"
literal|"8\x04"
literal|"2\x04"
literal|"5\x04"
literal|"B!"
block|,
literal|13
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|bom_original
init|=
literal|"Hi is \xd0\x9f\xd1\x80\xd0\xb8\xd0\xb2\xd0\xb5\xd1\x82"
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|check_utf8_sequences
parameter_list|(
name|void
parameter_list|)
block|{
name|yaml_parser_t
name|parser
decl_stmt|;
name|int
name|failed
init|=
literal|0
decl_stmt|;
name|int
name|k
decl_stmt|;
name|printf
argument_list|(
literal|"checking utf-8 sequences...\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|utf8_sequences
index|[
name|k
index|]
operator|.
name|test
condition|;
name|k
operator|++
control|)
block|{
name|char
modifier|*
name|title
init|=
name|utf8_sequences
index|[
name|k
index|]
operator|.
name|title
decl_stmt|;
name|int
name|check
init|=
name|utf8_sequences
index|[
name|k
index|]
operator|.
name|result
decl_stmt|;
name|int
name|result
decl_stmt|;
name|char
modifier|*
name|start
init|=
name|utf8_sequences
index|[
name|k
index|]
operator|.
name|test
decl_stmt|;
name|char
modifier|*
name|end
init|=
name|start
decl_stmt|;
name|printf
argument_list|(
literal|"\t%s:\n"
argument_list|,
name|title
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
while|while
condition|(
operator|*
name|end
operator|!=
literal|'|'
operator|&&
operator|*
name|end
operator|!=
literal|'!'
condition|)
name|end
operator|++
expr_stmt|;
name|yaml_parser_initialize
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|yaml_parser_set_input_string
argument_list|(
operator|&
name|parser
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|start
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
name|result
operator|=
name|yaml_parser_update_buffer
argument_list|(
operator|&
name|parser
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|check
condition|)
block|{
name|printf
argument_list|(
literal|"\t\t- "
argument_list|)
expr_stmt|;
name|failed
operator|++
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"\t\t+ "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|parser
operator|.
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"(no error)\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|parser
operator|.
name|error
operator|==
name|YAML_READER_ERROR
condition|)
block|{
if|if
condition|(
name|parser
operator|.
name|problem_value
operator|!=
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"(reader error: %s: #%X at %d)\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_value
argument_list|,
name|parser
operator|.
name|problem_offset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"(reader error: %s at %d)\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_offset
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|end
operator|==
literal|'!'
condition|)
break|break;
name|start
operator|=
operator|++
name|end
expr_stmt|;
name|yaml_parser_delete
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
block|}
empty_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"checking utf-8 sequences: %d fail(s)\n"
argument_list|,
name|failed
argument_list|)
expr_stmt|;
return|return
name|failed
return|;
block|}
end_function

begin_function
name|int
name|check_boms
parameter_list|(
name|void
parameter_list|)
block|{
name|yaml_parser_t
name|parser
decl_stmt|;
name|int
name|failed
init|=
literal|0
decl_stmt|;
name|int
name|k
decl_stmt|;
name|printf
argument_list|(
literal|"checking boms...\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|boms
index|[
name|k
index|]
operator|.
name|test
condition|;
name|k
operator|++
control|)
block|{
name|char
modifier|*
name|title
init|=
name|boms
index|[
name|k
index|]
operator|.
name|title
decl_stmt|;
name|int
name|check
init|=
name|boms
index|[
name|k
index|]
operator|.
name|result
decl_stmt|;
name|int
name|result
decl_stmt|;
name|char
modifier|*
name|start
init|=
name|boms
index|[
name|k
index|]
operator|.
name|test
decl_stmt|;
name|char
modifier|*
name|end
init|=
name|start
decl_stmt|;
while|while
condition|(
operator|*
name|end
operator|!=
literal|'!'
condition|)
name|end
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"\t%s: "
argument_list|,
name|title
argument_list|)
expr_stmt|;
name|yaml_parser_initialize
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|yaml_parser_set_input_string
argument_list|(
operator|&
name|parser
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|start
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
name|result
operator|=
name|yaml_parser_update_buffer
argument_list|(
operator|&
name|parser
argument_list|,
name|end
operator|-
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
block|{
name|printf
argument_list|(
literal|"- (reader error: %s at %d)\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_offset
argument_list|)
expr_stmt|;
name|failed
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|parser
operator|.
name|unread
operator|!=
name|check
condition|)
block|{
name|printf
argument_list|(
literal|"- (length=%d while expected length=%d)\n"
argument_list|,
name|parser
operator|.
name|unread
argument_list|,
name|check
argument_list|)
expr_stmt|;
name|failed
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|memcmp
argument_list|(
name|parser
operator|.
name|buffer
operator|.
name|start
argument_list|,
name|bom_original
argument_list|,
name|check
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"- (value '%s' does not equal to the original value '%s')\n"
argument_list|,
name|parser
operator|.
name|buffer
operator|.
name|start
argument_list|,
name|bom_original
argument_list|)
expr_stmt|;
name|failed
operator|++
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"+\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|yaml_parser_delete
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"checking boms: %d fail(s)\n"
argument_list|,
name|failed
argument_list|)
expr_stmt|;
return|return
name|failed
return|;
block|}
end_function

begin_define
define|#
directive|define
name|LONG
value|100000
end_define

begin_function
name|int
name|check_long_utf8
parameter_list|(
name|void
parameter_list|)
block|{
name|yaml_parser_t
name|parser
decl_stmt|;
name|int
name|k
init|=
literal|0
decl_stmt|;
name|int
name|j
decl_stmt|;
name|int
name|failed
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|ch0
decl_stmt|,
name|ch1
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buffer
init|=
name|malloc
argument_list|(
literal|3
operator|+
name|LONG
operator|*
literal|2
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checking a long utf8 sequence...\n"
argument_list|)
expr_stmt|;
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\xef'
expr_stmt|;
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\xbb'
expr_stmt|;
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\xbf'
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|LONG
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|%
literal|2
condition|)
block|{
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\xd0'
expr_stmt|;
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\x90'
expr_stmt|;
block|}
else|else
block|{
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\xd0'
expr_stmt|;
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\xaf'
expr_stmt|;
block|}
block|}
name|yaml_parser_initialize
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|yaml_parser_set_input_string
argument_list|(
operator|&
name|parser
argument_list|,
name|buffer
argument_list|,
literal|3
operator|+
name|LONG
operator|*
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|LONG
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|parser
operator|.
name|unread
condition|)
block|{
if|if
condition|(
operator|!
name|yaml_parser_update_buffer
argument_list|(
operator|&
name|parser
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\treader error: %s at %d\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_offset
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|parser
operator|.
name|unread
condition|)
block|{
name|printf
argument_list|(
literal|"\tnot enough characters at %d\n"
argument_list|,
name|k
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|k
operator|%
literal|2
condition|)
block|{
name|ch0
operator|=
literal|'\xd0'
expr_stmt|;
name|ch1
operator|=
literal|'\x90'
expr_stmt|;
block|}
else|else
block|{
name|ch0
operator|=
literal|'\xd0'
expr_stmt|;
name|ch1
operator|=
literal|'\xaf'
expr_stmt|;
block|}
if|if
condition|(
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|0
index|]
operator|!=
name|ch0
operator|||
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|1
index|]
operator|!=
name|ch1
condition|)
block|{
name|printf
argument_list|(
literal|"\tincorrect UTF-8 sequence: %X %X instead of %X %X\n"
argument_list|,
operator|(
name|int
operator|)
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|0
index|]
argument_list|,
operator|(
name|int
operator|)
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|1
index|]
argument_list|,
operator|(
name|int
operator|)
name|ch0
argument_list|,
operator|(
name|int
operator|)
name|ch1
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|parser
operator|.
name|buffer
operator|.
name|pointer
operator|+=
literal|2
expr_stmt|;
name|parser
operator|.
name|unread
operator|-=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|failed
condition|)
block|{
if|if
condition|(
operator|!
name|yaml_parser_update_buffer
argument_list|(
operator|&
name|parser
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\treader error: %s at %d\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_offset
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"\texpected NUL, found %X (eof=%d, unread=%d)\n"
argument_list|,
operator|(
name|int
operator|)
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|0
index|]
argument_list|,
name|parser
operator|.
name|eof
argument_list|,
name|parser
operator|.
name|unread
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|yaml_parser_delete
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checking a long utf8 sequence: %d fail(s)\n"
argument_list|,
name|failed
argument_list|)
expr_stmt|;
return|return
name|failed
return|;
block|}
end_function

begin_function
name|int
name|check_long_utf16
parameter_list|(
name|void
parameter_list|)
block|{
name|yaml_parser_t
name|parser
decl_stmt|;
name|int
name|k
init|=
literal|0
decl_stmt|;
name|int
name|j
decl_stmt|;
name|int
name|failed
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|ch0
decl_stmt|,
name|ch1
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buffer
init|=
name|malloc
argument_list|(
literal|2
operator|+
name|LONG
operator|*
literal|2
argument_list|)
decl_stmt|;
name|assert
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checking a long utf16 sequence...\n"
argument_list|)
expr_stmt|;
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\xff'
expr_stmt|;
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\xfe'
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|LONG
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|j
operator|%
literal|2
condition|)
block|{
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\x10'
expr_stmt|;
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\x04'
expr_stmt|;
block|}
else|else
block|{
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'/'
expr_stmt|;
name|buffer
index|[
name|k
operator|++
index|]
operator|=
literal|'\x04'
expr_stmt|;
block|}
block|}
name|yaml_parser_initialize
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|yaml_parser_set_input_string
argument_list|(
operator|&
name|parser
argument_list|,
name|buffer
argument_list|,
literal|2
operator|+
name|LONG
operator|*
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|LONG
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|parser
operator|.
name|unread
condition|)
block|{
if|if
condition|(
operator|!
name|yaml_parser_update_buffer
argument_list|(
operator|&
name|parser
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\treader error: %s at %d\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_offset
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|parser
operator|.
name|unread
condition|)
block|{
name|printf
argument_list|(
literal|"\tnot enough characters at %d\n"
argument_list|,
name|k
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|k
operator|%
literal|2
condition|)
block|{
name|ch0
operator|=
literal|'\xd0'
expr_stmt|;
name|ch1
operator|=
literal|'\x90'
expr_stmt|;
block|}
else|else
block|{
name|ch0
operator|=
literal|'\xd0'
expr_stmt|;
name|ch1
operator|=
literal|'\xaf'
expr_stmt|;
block|}
if|if
condition|(
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|0
index|]
operator|!=
name|ch0
operator|||
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|1
index|]
operator|!=
name|ch1
condition|)
block|{
name|printf
argument_list|(
literal|"\tincorrect UTF-8 sequence: %X %X instead of %X %X\n"
argument_list|,
operator|(
name|int
operator|)
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|0
index|]
argument_list|,
operator|(
name|int
operator|)
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|1
index|]
argument_list|,
operator|(
name|int
operator|)
name|ch0
argument_list|,
operator|(
name|int
operator|)
name|ch1
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|parser
operator|.
name|buffer
operator|.
name|pointer
operator|+=
literal|2
expr_stmt|;
name|parser
operator|.
name|unread
operator|-=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|failed
condition|)
block|{
if|if
condition|(
operator|!
name|yaml_parser_update_buffer
argument_list|(
operator|&
name|parser
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"\treader error: %s at %d\n"
argument_list|,
name|parser
operator|.
name|problem
argument_list|,
name|parser
operator|.
name|problem_offset
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"\texpected NUL, found %X (eof=%d, unread=%d)\n"
argument_list|,
operator|(
name|int
operator|)
name|parser
operator|.
name|buffer
operator|.
name|pointer
index|[
literal|0
index|]
argument_list|,
name|parser
operator|.
name|eof
argument_list|,
name|parser
operator|.
name|unread
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|yaml_parser_delete
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"checking a long utf16 sequence: %d fail(s)\n"
argument_list|,
name|failed
argument_list|)
expr_stmt|;
return|return
name|failed
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|check_utf8_sequences
argument_list|()
operator|+
name|check_boms
argument_list|()
operator|+
name|check_long_utf8
argument_list|()
operator|+
name|check_long_utf16
argument_list|()
return|;
block|}
end_function

end_unit


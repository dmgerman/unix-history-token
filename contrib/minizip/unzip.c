begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* unzip.c -- IO for uncompress .zip files using zlib    Version 1.1, February 14h, 2010    part of the MiniZip project - ( http://www.winimage.com/zLibDll/minizip.html )           Copyright (C) 1998-2010 Gilles Vollant (minizip) ( http://www.winimage.com/zLibDll/minizip.html )           Modifications of Unzip for Zip64          Copyright (C) 2007-2008 Even Rouault           Modifications for Zip64 support on both zip and unzip          Copyright (C) 2009-2010 Mathias Svensson ( http://result42.com )           For more info read MiniZip_info.txt     ------------------------------------------------------------------------------------   Decryption code comes from crypt.c by Info-ZIP but has been greatly reduced in terms of   compatibility with older software. The following is from the original crypt.c.   Code woven in by Terry Thorsen 1/2003.    Copyright (c) 1990-2000 Info-ZIP.  All rights reserved.    See the accompanying file LICENSE, version 2000-Apr-09 or later   (the contents of which are also included in zip.h) for terms of use.   If, for some reason, all these files are missing, the Info-ZIP license   also may be found at:  ftp://ftp.info-zip.org/pub/infozip/license.html          crypt.c (full version) by Info-ZIP.      Last revised:  [see crypt.h]    The encryption/decryption parts of this source code (as opposed to the   non-echoing password parts) were originally written in Europe.  The   whole source package can be freely distributed, including from the USA.   (Prior to January 2000, re-export from the US was a violation of US law.)          This encryption code is a direct transcription of the algorithm from   Roger Schlafly, described by Phil Katz in the file appnote.txt.  This   file (appnote.txt) is distributed with the PKZIP program (even in the   version without encryption capabilities).          ------------------------------------------------------------------------------------          Changes in unzip.c          2007-2008 - Even Rouault - Addition of cpl_unzGetCurrentFileZStreamPos   2007-2008 - Even Rouault - Decoration of symbol names unz* -> cpl_unz*   2007-2008 - Even Rouault - Remove old C style function prototypes   2007-2008 - Even Rouault - Add unzip support for ZIP64          Copyright (C) 2007-2008 Even Rouault           Oct-2009 - Mathias Svensson - Removed cpl_* from symbol names (Even Rouault added them but since this is now moved to a new project (minizip64) I renamed them again).   Oct-2009 - Mathias Svensson - Fixed problem if uncompressed size was> 4G and compressed size was<4G                                 should only read the compressed/uncompressed size from the Zip64 format if                                 the size from normal header was 0xFFFFFFFF   Oct-2009 - Mathias Svensson - Applied some bug fixes from paches recived from Gilles Vollant         Oct-2009 - Mathias Svensson - Applied support to unzip files with compression mathod BZIP2 (bzip2 lib is required)                                 Patch created by Daniel Borca    Jan-2010 - back to unzip and minizip 1.0 name scheme, with compatibility layer    Copyright (C) 1998 - 2010 Gilles Vollant, Even Rouault, Mathias Svensson  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|NOUNCRYPT
end_ifndef

begin_define
define|#
directive|define
name|NOUNCRYPT
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"zlib.h"
end_include

begin_include
include|#
directive|include
file|"unzip.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|STDC
end_ifdef

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|NO_ERRNO_H
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|local
end_ifndef

begin_define
define|#
directive|define
name|local
value|static
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* compile with -Dlocal if your debugger can't find static symbols */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|CASESENSITIVITYDEFAULT_NO
end_ifndef

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|unix
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|CASESENSITIVITYDEFAULT_YES
argument_list|)
end_if

begin_define
define|#
directive|define
name|CASESENSITIVITYDEFAULT_NO
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|UNZ_BUFSIZE
end_ifndef

begin_define
define|#
directive|define
name|UNZ_BUFSIZE
value|(16384)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|UNZ_MAXFILENAMEINZIP
end_ifndef

begin_define
define|#
directive|define
name|UNZ_MAXFILENAMEINZIP
value|(256)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|ALLOC
end_ifndef

begin_define
define|#
directive|define
name|ALLOC
parameter_list|(
name|size
parameter_list|)
value|(malloc(size))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|TRYFREE
end_ifndef

begin_define
define|#
directive|define
name|TRYFREE
parameter_list|(
name|p
parameter_list|)
value|{if (p) free(p);}
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|SIZECENTRALDIRITEM
value|(0x2e)
end_define

begin_define
define|#
directive|define
name|SIZEZIPLOCALHEADER
value|(0x1e)
end_define

begin_decl_stmt
specifier|const
name|char
name|unz_copyright
index|[]
init|=
literal|" unzip 1.01 Copyright 1998-2004 Gilles Vollant - http://www.winimage.com/zLibDll"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* unz_file_info_interntal contain internal info about a file in zipfile*/
end_comment

begin_typedef
typedef|typedef
struct|struct
name|unz_file_info64_internal_s
block|{
name|ZPOS64_T
name|offset_curfile
decl_stmt|;
comment|/* relative offset of local header 8 bytes */
block|}
name|unz_file_info64_internal
typedef|;
end_typedef

begin_comment
comment|/* file_in_zip_read_info_s contain internal information about a file in zipfile,     when reading and decompress it */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|char
modifier|*
name|read_buffer
decl_stmt|;
comment|/* internal buffer for compressed data */
name|z_stream
name|stream
decl_stmt|;
comment|/* zLib stream structure for inflate */
ifdef|#
directive|ifdef
name|HAVE_BZIP2
name|bz_stream
name|bstream
decl_stmt|;
comment|/* bzLib stream structure for bziped */
endif|#
directive|endif
name|ZPOS64_T
name|pos_in_zipfile
decl_stmt|;
comment|/* position in byte on the zipfile, for fseek*/
name|uLong
name|stream_initialised
decl_stmt|;
comment|/* flag set if stream structure is initialised*/
name|ZPOS64_T
name|offset_local_extrafield
decl_stmt|;
comment|/* offset of the local extra field */
name|uInt
name|size_local_extrafield
decl_stmt|;
comment|/* size of the local extra field */
name|ZPOS64_T
name|pos_local_extrafield
decl_stmt|;
comment|/* position in the local extra field in read*/
name|ZPOS64_T
name|total_out_64
decl_stmt|;
name|uLong
name|crc32
decl_stmt|;
comment|/* crc32 of all data uncompressed */
name|uLong
name|crc32_wait
decl_stmt|;
comment|/* crc32 we must obtain after decompress all */
name|ZPOS64_T
name|rest_read_compressed
decl_stmt|;
comment|/* number of byte to be decompressed */
name|ZPOS64_T
name|rest_read_uncompressed
decl_stmt|;
comment|/*number of byte to be obtained after decomp*/
name|zlib_filefunc64_32_def
name|z_filefunc
decl_stmt|;
name|voidpf
name|filestream
decl_stmt|;
comment|/* io structore of the zipfile */
name|uLong
name|compression_method
decl_stmt|;
comment|/* compression method (0==store) */
name|ZPOS64_T
name|byte_before_the_zipfile
decl_stmt|;
comment|/* byte before the zipfile, (>0 for sfx)*/
name|int
name|raw
decl_stmt|;
block|}
name|file_in_zip64_read_info_s
typedef|;
end_typedef

begin_comment
comment|/* unz64_s contain internal information about the zipfile */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|zlib_filefunc64_32_def
name|z_filefunc
decl_stmt|;
name|int
name|is64bitOpenFunction
decl_stmt|;
name|voidpf
name|filestream
decl_stmt|;
comment|/* io structore of the zipfile */
name|unz_global_info64
name|gi
decl_stmt|;
comment|/* public global information */
name|ZPOS64_T
name|byte_before_the_zipfile
decl_stmt|;
comment|/* byte before the zipfile, (>0 for sfx)*/
name|ZPOS64_T
name|num_file
decl_stmt|;
comment|/* number of the current file in the zipfile*/
name|ZPOS64_T
name|pos_in_central_dir
decl_stmt|;
comment|/* pos of the current file in the central dir*/
name|ZPOS64_T
name|current_file_ok
decl_stmt|;
comment|/* flag about the usability of the current file*/
name|ZPOS64_T
name|central_pos
decl_stmt|;
comment|/* position of the beginning of the central dir*/
name|ZPOS64_T
name|size_central_dir
decl_stmt|;
comment|/* size of the central directory  */
name|ZPOS64_T
name|offset_central_dir
decl_stmt|;
comment|/* offset of start of central directory with                                    respect to the starting disk number */
name|unz_file_info64
name|cur_file_info
decl_stmt|;
comment|/* public info about the current file in zip*/
name|unz_file_info64_internal
name|cur_file_info_internal
decl_stmt|;
comment|/* private info about it*/
name|file_in_zip64_read_info_s
modifier|*
name|pfile_in_zip_read
decl_stmt|;
comment|/* structure about the current                                         file if we are decompressing it */
name|int
name|encrypted
decl_stmt|;
name|int
name|isZip64
decl_stmt|;
ifndef|#
directive|ifndef
name|NOUNCRYPT
name|unsigned
name|long
name|keys
index|[
literal|3
index|]
decl_stmt|;
comment|/* keys defining the pseudo-random sequence */
specifier|const
name|z_crc_t
modifier|*
name|pcrc_32_tab
decl_stmt|;
endif|#
directive|endif
block|}
name|unz64_s
typedef|;
end_typedef

begin_ifndef
ifndef|#
directive|ifndef
name|NOUNCRYPT
end_ifndef

begin_include
include|#
directive|include
file|"crypt.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ===========================================================================      Read a byte from a gz_stream; update next_in and avail_in. Return EOF    for end of file.    IN assertion: the stream s has been sucessfully opened for reading. */
end_comment

begin_decl_stmt
name|local
name|int
name|unz64local_getByte
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|,
name|int
operator|*
name|pi
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|unz64local_getByte
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|int
modifier|*
name|pi
parameter_list|)
block|{
name|unsigned
name|char
name|c
decl_stmt|;
name|int
name|err
init|=
operator|(
name|int
operator|)
name|ZREAD64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|==
literal|1
condition|)
block|{
operator|*
name|pi
operator|=
operator|(
name|int
operator|)
name|c
expr_stmt|;
return|return
name|UNZ_OK
return|;
block|}
else|else
block|{
if|if
condition|(
name|ZERROR64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|)
condition|)
return|return
name|UNZ_ERRNO
return|;
else|else
return|return
name|UNZ_EOF
return|;
block|}
block|}
end_function

begin_comment
comment|/* ===========================================================================    Reads a long in LSB order from the given gz_stream. Sets */
end_comment

begin_decl_stmt
name|local
name|int
name|unz64local_getShort
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|,
name|uLong
operator|*
name|pX
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|unz64local_getShort
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|uLong
modifier|*
name|pX
parameter_list|)
block|{
name|uLong
name|x
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|uLong
operator|)
name|i
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|uLong
operator|)
name|i
operator|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
operator|*
name|pX
operator|=
name|x
expr_stmt|;
else|else
operator|*
name|pX
operator|=
literal|0
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_decl_stmt
name|local
name|int
name|unz64local_getLong
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|,
name|uLong
operator|*
name|pX
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|unz64local_getLong
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|uLong
modifier|*
name|pX
parameter_list|)
block|{
name|uLong
name|x
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|uLong
operator|)
name|i
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|uLong
operator|)
name|i
operator|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|uLong
operator|)
name|i
operator|)
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|uLong
operator|)
name|i
operator|)
operator|<<
literal|24
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
operator|*
name|pX
operator|=
name|x
expr_stmt|;
else|else
operator|*
name|pX
operator|=
literal|0
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_decl_stmt
name|local
name|int
name|unz64local_getLong64
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|,
name|ZPOS64_T
operator|*
name|pX
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|unz64local_getLong64
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|ZPOS64_T
modifier|*
name|pX
parameter_list|)
block|{
name|ZPOS64_T
name|x
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|ZPOS64_T
operator|)
name|i
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|24
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|40
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|48
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
name|err
operator|=
name|unz64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|56
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
operator|*
name|pX
operator|=
name|x
expr_stmt|;
else|else
operator|*
name|pX
operator|=
literal|0
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* My own strcmpi / strcasecmp */
end_comment

begin_function
name|local
name|int
name|strcmpcasenosensitive_internal
parameter_list|(
specifier|const
name|char
modifier|*
name|fileName1
parameter_list|,
specifier|const
name|char
modifier|*
name|fileName2
parameter_list|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
name|char
name|c1
init|=
operator|*
operator|(
name|fileName1
operator|++
operator|)
decl_stmt|;
name|char
name|c2
init|=
operator|*
operator|(
name|fileName2
operator|++
operator|)
decl_stmt|;
if|if
condition|(
operator|(
name|c1
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
name|c1
operator|<=
literal|'z'
operator|)
condition|)
name|c1
operator|-=
literal|0x20
expr_stmt|;
if|if
condition|(
operator|(
name|c2
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
name|c2
operator|<=
literal|'z'
operator|)
condition|)
name|c2
operator|-=
literal|0x20
expr_stmt|;
if|if
condition|(
name|c1
operator|==
literal|'\0'
condition|)
return|return
operator|(
operator|(
name|c2
operator|==
literal|'\0'
operator|)
condition|?
literal|0
else|:
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|c2
operator|==
literal|'\0'
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|c1
operator|<
name|c2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|c1
operator|>
name|c2
condition|)
return|return
literal|1
return|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CASESENSITIVITYDEFAULT_NO
end_ifdef

begin_define
define|#
directive|define
name|CASESENSITIVITYDEFAULTVALUE
value|2
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|CASESENSITIVITYDEFAULTVALUE
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|STRCMPCASENOSENTIVEFUNCTION
end_ifndef

begin_define
define|#
directive|define
name|STRCMPCASENOSENTIVEFUNCTION
value|strcmpcasenosensitive_internal
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*    Compare two filename (fileName1,fileName2).    If iCaseSenisivity = 1, comparision is case sensitivity (like strcmp)    If iCaseSenisivity = 2, comparision is not case sensitivity (like strcmpi                                                                 or strcasecmp)    If iCaseSenisivity = 0, case sensitivity is defaut of your operating system         (like 1 on Unix, 2 on Windows)  */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzStringFileNameCompare
parameter_list|(
specifier|const
name|char
modifier|*
name|fileName1
parameter_list|,
specifier|const
name|char
modifier|*
name|fileName2
parameter_list|,
name|int
name|iCaseSensitivity
parameter_list|)
block|{
if|if
condition|(
name|iCaseSensitivity
operator|==
literal|0
condition|)
name|iCaseSensitivity
operator|=
name|CASESENSITIVITYDEFAULTVALUE
expr_stmt|;
if|if
condition|(
name|iCaseSensitivity
operator|==
literal|1
condition|)
return|return
name|strcmp
argument_list|(
name|fileName1
argument_list|,
name|fileName2
argument_list|)
return|;
return|return
name|STRCMPCASENOSENTIVEFUNCTION
argument_list|(
name|fileName1
argument_list|,
name|fileName2
argument_list|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|BUFREADCOMMENT
end_ifndef

begin_define
define|#
directive|define
name|BUFREADCOMMENT
value|(0x400)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   Locate the Central directory of a zipfile (at the end, just before     the global comment) */
end_comment

begin_decl_stmt
name|local
name|ZPOS64_T
name|unz64local_SearchCentralDir
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|ZPOS64_T
name|unz64local_SearchCentralDir
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|ZPOS64_T
name|uSizeFile
decl_stmt|;
name|ZPOS64_T
name|uBackRead
decl_stmt|;
name|ZPOS64_T
name|uMaxBack
init|=
literal|0xffff
decl_stmt|;
comment|/* maximum size of global comment */
name|ZPOS64_T
name|uPosFound
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
literal|0
argument_list|,
name|ZLIB_FILEFUNC_SEEK_END
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
name|uSizeFile
operator|=
name|ZTELL64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|)
expr_stmt|;
if|if
condition|(
name|uMaxBack
operator|>
name|uSizeFile
condition|)
name|uMaxBack
operator|=
name|uSizeFile
expr_stmt|;
name|buf
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ALLOC
argument_list|(
name|BUFREADCOMMENT
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|uBackRead
operator|=
literal|4
expr_stmt|;
while|while
condition|(
name|uBackRead
operator|<
name|uMaxBack
condition|)
block|{
name|uLong
name|uReadSize
decl_stmt|;
name|ZPOS64_T
name|uReadPos
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|uBackRead
operator|+
name|BUFREADCOMMENT
operator|>
name|uMaxBack
condition|)
name|uBackRead
operator|=
name|uMaxBack
expr_stmt|;
else|else
name|uBackRead
operator|+=
name|BUFREADCOMMENT
expr_stmt|;
name|uReadPos
operator|=
name|uSizeFile
operator|-
name|uBackRead
expr_stmt|;
name|uReadSize
operator|=
operator|(
operator|(
name|BUFREADCOMMENT
operator|+
literal|4
operator|)
operator|<
operator|(
name|uSizeFile
operator|-
name|uReadPos
operator|)
operator|)
condition|?
operator|(
name|BUFREADCOMMENT
operator|+
literal|4
operator|)
else|:
call|(
name|uLong
call|)
argument_list|(
name|uSizeFile
operator|-
name|uReadPos
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|uReadPos
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|ZREAD64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|buf
argument_list|,
name|uReadSize
argument_list|)
operator|!=
name|uReadSize
condition|)
break|break;
for|for
control|(
name|i
operator|=
operator|(
name|int
operator|)
name|uReadSize
operator|-
literal|3
init|;
operator|(
name|i
operator|--
operator|)
operator|>
literal|0
condition|;
control|)
if|if
condition|(
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|)
operator|)
operator|==
literal|0x50
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|1
operator|)
operator|)
operator|==
literal|0x4b
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|2
operator|)
operator|)
operator|==
literal|0x05
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|3
operator|)
operator|)
operator|==
literal|0x06
operator|)
condition|)
block|{
name|uPosFound
operator|=
name|uReadPos
operator|+
name|i
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|uPosFound
operator|!=
literal|0
condition|)
break|break;
block|}
name|TRYFREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|uPosFound
return|;
block|}
end_function

begin_comment
comment|/*   Locate the Central directory 64 of a zipfile (at the end, just before     the global comment) */
end_comment

begin_decl_stmt
name|local
name|ZPOS64_T
name|unz64local_SearchCentralDir64
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|ZPOS64_T
name|unz64local_SearchCentralDir64
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|ZPOS64_T
name|uSizeFile
decl_stmt|;
name|ZPOS64_T
name|uBackRead
decl_stmt|;
name|ZPOS64_T
name|uMaxBack
init|=
literal|0xffff
decl_stmt|;
comment|/* maximum size of global comment */
name|ZPOS64_T
name|uPosFound
init|=
literal|0
decl_stmt|;
name|uLong
name|uL
decl_stmt|;
name|ZPOS64_T
name|relativeOffset
decl_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
literal|0
argument_list|,
name|ZLIB_FILEFUNC_SEEK_END
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
name|uSizeFile
operator|=
name|ZTELL64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|)
expr_stmt|;
if|if
condition|(
name|uMaxBack
operator|>
name|uSizeFile
condition|)
name|uMaxBack
operator|=
name|uSizeFile
expr_stmt|;
name|buf
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ALLOC
argument_list|(
name|BUFREADCOMMENT
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|uBackRead
operator|=
literal|4
expr_stmt|;
while|while
condition|(
name|uBackRead
operator|<
name|uMaxBack
condition|)
block|{
name|uLong
name|uReadSize
decl_stmt|;
name|ZPOS64_T
name|uReadPos
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|uBackRead
operator|+
name|BUFREADCOMMENT
operator|>
name|uMaxBack
condition|)
name|uBackRead
operator|=
name|uMaxBack
expr_stmt|;
else|else
name|uBackRead
operator|+=
name|BUFREADCOMMENT
expr_stmt|;
name|uReadPos
operator|=
name|uSizeFile
operator|-
name|uBackRead
expr_stmt|;
name|uReadSize
operator|=
operator|(
operator|(
name|BUFREADCOMMENT
operator|+
literal|4
operator|)
operator|<
operator|(
name|uSizeFile
operator|-
name|uReadPos
operator|)
operator|)
condition|?
operator|(
name|BUFREADCOMMENT
operator|+
literal|4
operator|)
else|:
call|(
name|uLong
call|)
argument_list|(
name|uSizeFile
operator|-
name|uReadPos
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|uReadPos
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|ZREAD64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|buf
argument_list|,
name|uReadSize
argument_list|)
operator|!=
name|uReadSize
condition|)
break|break;
for|for
control|(
name|i
operator|=
operator|(
name|int
operator|)
name|uReadSize
operator|-
literal|3
init|;
operator|(
name|i
operator|--
operator|)
operator|>
literal|0
condition|;
control|)
if|if
condition|(
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|)
operator|)
operator|==
literal|0x50
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|1
operator|)
operator|)
operator|==
literal|0x4b
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|2
operator|)
operator|)
operator|==
literal|0x06
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|3
operator|)
operator|)
operator|==
literal|0x07
operator|)
condition|)
block|{
name|uPosFound
operator|=
name|uReadPos
operator|+
name|i
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|uPosFound
operator|!=
literal|0
condition|)
break|break;
block|}
name|TRYFREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|uPosFound
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Zip64 end of central directory locator */
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|uPosFound
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* the signature, already checked */
if|if
condition|(
name|unz64local_getLong
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
return|return
literal|0
return|;
comment|/* number of the disk with the start of the zip64 end of  central directory */
if|if
condition|(
name|unz64local_getLong
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|uL
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* relative offset of the zip64 end of central directory record */
if|if
condition|(
name|unz64local_getLong64
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|relativeOffset
argument_list|)
operator|!=
name|UNZ_OK
condition|)
return|return
literal|0
return|;
comment|/* total number of disks */
if|if
condition|(
name|unz64local_getLong
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|uL
operator|!=
literal|1
condition|)
return|return
literal|0
return|;
comment|/* Goto end of central directory record */
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|relativeOffset
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* the signature */
if|if
condition|(
name|unz64local_getLong
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|uL
operator|!=
literal|0x06064b50
condition|)
return|return
literal|0
return|;
return|return
name|relativeOffset
return|;
block|}
end_function

begin_comment
comment|/*   Open a Zip file. path contain the full pathname (by example,      on a Windows NT computer "c:\\test\\zlib114.zip" or on an Unix computer      "zlib/zlib114.zip".      If the zipfile cannot be opened (file doesn't exist or in not valid), the        return value is NULL.      Else, the return value is a unzFile Handle, usable with other function        of this unzip package. */
end_comment

begin_function
name|local
name|unzFile
name|unzOpenInternal
parameter_list|(
specifier|const
name|void
modifier|*
name|path
parameter_list|,
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc64_32_def
parameter_list|,
name|int
name|is64bitOpenFunction
parameter_list|)
block|{
name|unz64_s
name|us
decl_stmt|;
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|ZPOS64_T
name|central_pos
decl_stmt|;
name|uLong
name|uL
decl_stmt|;
name|uLong
name|number_disk
decl_stmt|;
comment|/* number of the current dist, used for                                    spaning ZIP, unsupported, always 0*/
name|uLong
name|number_disk_with_CD
decl_stmt|;
comment|/* number the the disk with central dir, used                                    for spaning ZIP, unsupported, always 0*/
name|ZPOS64_T
name|number_entry_CD
decl_stmt|;
comment|/* total number of entries in                                    the central dir                                    (same than number_entry on nospan) */
name|int
name|err
init|=
name|UNZ_OK
decl_stmt|;
if|if
condition|(
name|unz_copyright
index|[
literal|0
index|]
operator|!=
literal|' '
condition|)
return|return
name|NULL
return|;
name|us
operator|.
name|z_filefunc
operator|.
name|zseek32_file
operator|=
name|NULL
expr_stmt|;
name|us
operator|.
name|z_filefunc
operator|.
name|ztell32_file
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|pzlib_filefunc64_32_def
operator|==
name|NULL
condition|)
name|fill_fopen64_filefunc
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
operator|.
name|zfile_func64
argument_list|)
expr_stmt|;
else|else
name|us
operator|.
name|z_filefunc
operator|=
operator|*
name|pzlib_filefunc64_32_def
expr_stmt|;
name|us
operator|.
name|is64bitOpenFunction
operator|=
name|is64bitOpenFunction
expr_stmt|;
name|us
operator|.
name|filestream
operator|=
name|ZOPEN64
argument_list|(
name|us
operator|.
name|z_filefunc
argument_list|,
name|path
argument_list|,
name|ZLIB_FILEFUNC_MODE_READ
operator||
name|ZLIB_FILEFUNC_MODE_EXISTING
argument_list|)
expr_stmt|;
if|if
condition|(
name|us
operator|.
name|filestream
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|central_pos
operator|=
name|unz64local_SearchCentralDir64
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|)
expr_stmt|;
if|if
condition|(
name|central_pos
condition|)
block|{
name|uLong
name|uS
decl_stmt|;
name|ZPOS64_T
name|uL64
decl_stmt|;
name|us
operator|.
name|isZip64
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
name|central_pos
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* the signature, already checked */
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* size of zip64 end of central directory record */
if|if
condition|(
name|unz64local_getLong64
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|uL64
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* version made by */
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|uS
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* version needed to extract */
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|uS
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* number of this disk */
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|number_disk
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* number of the disk with the start of the central directory */
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|number_disk_with_CD
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* total number of entries in the central directory on this disk */
if|if
condition|(
name|unz64local_getLong64
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|us
operator|.
name|gi
operator|.
name|number_entry
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* total number of entries in the central directory */
if|if
condition|(
name|unz64local_getLong64
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|number_entry_CD
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
operator|(
name|number_entry_CD
operator|!=
name|us
operator|.
name|gi
operator|.
name|number_entry
operator|)
operator|||
operator|(
name|number_disk_with_CD
operator|!=
literal|0
operator|)
operator|||
operator|(
name|number_disk
operator|!=
literal|0
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
comment|/* size of the central directory */
if|if
condition|(
name|unz64local_getLong64
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|us
operator|.
name|size_central_dir
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* offset of start of central directory with respect to the           starting disk number */
if|if
condition|(
name|unz64local_getLong64
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|us
operator|.
name|offset_central_dir
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|us
operator|.
name|gi
operator|.
name|size_comment
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|central_pos
operator|=
name|unz64local_SearchCentralDir
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|)
expr_stmt|;
if|if
condition|(
name|central_pos
operator|==
literal|0
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|us
operator|.
name|isZip64
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
name|central_pos
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* the signature, already checked */
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* number of this disk */
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|number_disk
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* number of the disk with the start of the central directory */
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|number_disk_with_CD
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* total number of entries in the central dir on this disk */
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|us
operator|.
name|gi
operator|.
name|number_entry
operator|=
name|uL
expr_stmt|;
comment|/* total number of entries in the central dir */
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|number_entry_CD
operator|=
name|uL
expr_stmt|;
if|if
condition|(
operator|(
name|number_entry_CD
operator|!=
name|us
operator|.
name|gi
operator|.
name|number_entry
operator|)
operator|||
operator|(
name|number_disk_with_CD
operator|!=
literal|0
operator|)
operator|||
operator|(
name|number_disk
operator|!=
literal|0
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
comment|/* size of the central directory */
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|us
operator|.
name|size_central_dir
operator|=
name|uL
expr_stmt|;
comment|/* offset of start of central directory with respect to the             starting disk number */
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|us
operator|.
name|offset_central_dir
operator|=
name|uL
expr_stmt|;
comment|/* zipfile comment length */
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|,
operator|&
name|us
operator|.
name|gi
operator|.
name|size_comment
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|central_pos
operator|<
name|us
operator|.
name|offset_central_dir
operator|+
name|us
operator|.
name|size_central_dir
operator|)
operator|&&
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|UNZ_OK
condition|)
block|{
name|ZCLOSE64
argument_list|(
name|us
operator|.
name|z_filefunc
argument_list|,
name|us
operator|.
name|filestream
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|us
operator|.
name|byte_before_the_zipfile
operator|=
name|central_pos
operator|-
operator|(
name|us
operator|.
name|offset_central_dir
operator|+
name|us
operator|.
name|size_central_dir
operator|)
expr_stmt|;
name|us
operator|.
name|central_pos
operator|=
name|central_pos
expr_stmt|;
name|us
operator|.
name|pfile_in_zip_read
operator|=
name|NULL
expr_stmt|;
name|us
operator|.
name|encrypted
operator|=
literal|0
expr_stmt|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|unz64_s
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
block|{
operator|*
name|s
operator|=
name|us
expr_stmt|;
name|unzGoToFirstFile
argument_list|(
operator|(
name|unzFile
operator|)
name|s
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|unzFile
operator|)
name|s
return|;
block|}
end_function

begin_function
specifier|extern
name|unzFile
name|ZEXPORT
name|unzOpen2
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|zlib_filefunc_def
modifier|*
name|pzlib_filefunc32_def
parameter_list|)
block|{
if|if
condition|(
name|pzlib_filefunc32_def
operator|!=
name|NULL
condition|)
block|{
name|zlib_filefunc64_32_def
name|zlib_filefunc64_32_def_fill
decl_stmt|;
name|fill_zlib_filefunc64_32_def_from_filefunc32
argument_list|(
operator|&
name|zlib_filefunc64_32_def_fill
argument_list|,
name|pzlib_filefunc32_def
argument_list|)
expr_stmt|;
return|return
name|unzOpenInternal
argument_list|(
name|path
argument_list|,
operator|&
name|zlib_filefunc64_32_def_fill
argument_list|,
literal|0
argument_list|)
return|;
block|}
else|else
return|return
name|unzOpenInternal
argument_list|(
name|path
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|unzFile
name|ZEXPORT
name|unzOpen2_64
parameter_list|(
specifier|const
name|void
modifier|*
name|path
parameter_list|,
name|zlib_filefunc64_def
modifier|*
name|pzlib_filefunc_def
parameter_list|)
block|{
if|if
condition|(
name|pzlib_filefunc_def
operator|!=
name|NULL
condition|)
block|{
name|zlib_filefunc64_32_def
name|zlib_filefunc64_32_def_fill
decl_stmt|;
name|zlib_filefunc64_32_def_fill
operator|.
name|zfile_func64
operator|=
operator|*
name|pzlib_filefunc_def
expr_stmt|;
name|zlib_filefunc64_32_def_fill
operator|.
name|ztell32_file
operator|=
name|NULL
expr_stmt|;
name|zlib_filefunc64_32_def_fill
operator|.
name|zseek32_file
operator|=
name|NULL
expr_stmt|;
return|return
name|unzOpenInternal
argument_list|(
name|path
argument_list|,
operator|&
name|zlib_filefunc64_32_def_fill
argument_list|,
literal|1
argument_list|)
return|;
block|}
else|else
return|return
name|unzOpenInternal
argument_list|(
name|path
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|unzFile
name|ZEXPORT
name|unzOpen
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
return|return
name|unzOpenInternal
argument_list|(
name|path
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|unzFile
name|ZEXPORT
name|unzOpen64
parameter_list|(
specifier|const
name|void
modifier|*
name|path
parameter_list|)
block|{
return|return
name|unzOpenInternal
argument_list|(
name|path
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*   Close a ZipFile opened with unzOpen.   If there is files inside the .Zip opened with unzOpenCurrentFile (see later),     these files MUST be closed with unzCloseCurrentFile before call unzClose.   return UNZ_OK if there is no problem. */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzClose
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|pfile_in_zip_read
operator|!=
name|NULL
condition|)
name|unzCloseCurrentFile
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|ZCLOSE64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|)
expr_stmt|;
name|TRYFREE
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|UNZ_OK
return|;
block|}
end_function

begin_comment
comment|/*   Write info about the ZipFile in the *pglobal_info structure.   No preparation of the structure is needed   return UNZ_OK if there is no problem. */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGetGlobalInfo64
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|unz_global_info64
modifier|*
name|pglobal_info
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
operator|*
name|pglobal_info
operator|=
name|s
operator|->
name|gi
expr_stmt|;
return|return
name|UNZ_OK
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGetGlobalInfo
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|unz_global_info
modifier|*
name|pglobal_info32
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
comment|/* to do : check if number_entry is not truncated */
name|pglobal_info32
operator|->
name|number_entry
operator|=
operator|(
name|uLong
operator|)
name|s
operator|->
name|gi
operator|.
name|number_entry
expr_stmt|;
name|pglobal_info32
operator|->
name|size_comment
operator|=
name|s
operator|->
name|gi
operator|.
name|size_comment
expr_stmt|;
return|return
name|UNZ_OK
return|;
block|}
end_function

begin_comment
comment|/*    Translate date/time from Dos format to tm_unz (readable more easilty) */
end_comment

begin_function
name|local
name|void
name|unz64local_DosDateToTmuDate
parameter_list|(
name|ZPOS64_T
name|ulDosDate
parameter_list|,
name|tm_unz
modifier|*
name|ptm
parameter_list|)
block|{
name|ZPOS64_T
name|uDate
decl_stmt|;
name|uDate
operator|=
call|(
name|ZPOS64_T
call|)
argument_list|(
name|ulDosDate
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|ptm
operator|->
name|tm_mday
operator|=
call|(
name|uInt
call|)
argument_list|(
name|uDate
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
name|ptm
operator|->
name|tm_mon
operator|=
call|(
name|uInt
call|)
argument_list|(
operator|(
operator|(
operator|(
name|uDate
operator|)
operator|&
literal|0x1E0
operator|)
operator|/
literal|0x20
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ptm
operator|->
name|tm_year
operator|=
call|(
name|uInt
call|)
argument_list|(
operator|(
operator|(
name|uDate
operator|&
literal|0x0FE00
operator|)
operator|/
literal|0x0200
operator|)
operator|+
literal|1980
argument_list|)
expr_stmt|;
name|ptm
operator|->
name|tm_hour
operator|=
call|(
name|uInt
call|)
argument_list|(
operator|(
name|ulDosDate
operator|&
literal|0xF800
operator|)
operator|/
literal|0x800
argument_list|)
expr_stmt|;
name|ptm
operator|->
name|tm_min
operator|=
call|(
name|uInt
call|)
argument_list|(
operator|(
name|ulDosDate
operator|&
literal|0x7E0
operator|)
operator|/
literal|0x20
argument_list|)
expr_stmt|;
name|ptm
operator|->
name|tm_sec
operator|=
call|(
name|uInt
call|)
argument_list|(
literal|2
operator|*
operator|(
name|ulDosDate
operator|&
literal|0x1f
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   Get Info about the current file in the zipfile, with internal only info */
end_comment

begin_decl_stmt
name|local
name|int
name|unz64local_GetCurrentFileInfoInternal
name|OF
argument_list|(
operator|(
name|unzFile
name|file
operator|,
name|unz_file_info64
operator|*
name|pfile_info
operator|,
name|unz_file_info64_internal
operator|*
name|pfile_info_internal
operator|,
name|char
operator|*
name|szFileName
operator|,
name|uLong
name|fileNameBufferSize
operator|,
name|void
operator|*
name|extraField
operator|,
name|uLong
name|extraFieldBufferSize
operator|,
name|char
operator|*
name|szComment
operator|,
name|uLong
name|commentBufferSize
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|unz64local_GetCurrentFileInfoInternal
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|unz_file_info64
modifier|*
name|pfile_info
parameter_list|,
name|unz_file_info64_internal
modifier|*
name|pfile_info_internal
parameter_list|,
name|char
modifier|*
name|szFileName
parameter_list|,
name|uLong
name|fileNameBufferSize
parameter_list|,
name|void
modifier|*
name|extraField
parameter_list|,
name|uLong
name|extraFieldBufferSize
parameter_list|,
name|char
modifier|*
name|szComment
parameter_list|,
name|uLong
name|commentBufferSize
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|unz_file_info64
name|file_info
decl_stmt|;
name|unz_file_info64_internal
name|file_info_internal
decl_stmt|;
name|int
name|err
init|=
name|UNZ_OK
decl_stmt|;
name|uLong
name|uMagic
decl_stmt|;
name|long
name|lSeek
init|=
literal|0
decl_stmt|;
name|uLong
name|uL
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|s
operator|->
name|pos_in_central_dir
operator|+
name|s
operator|->
name|byte_before_the_zipfile
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* we check the magic */
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
block|{
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uMagic
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
elseif|else
if|if
condition|(
name|uMagic
operator|!=
literal|0x02014b50
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
block|}
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|version
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|version_needed
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|flag
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|compression_method
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|dosDate
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|unz64local_DosDateToTmuDate
argument_list|(
name|file_info
operator|.
name|dosDate
argument_list|,
operator|&
name|file_info
operator|.
name|tmu_date
argument_list|)
expr_stmt|;
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|crc
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|file_info
operator|.
name|compressed_size
operator|=
name|uL
expr_stmt|;
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|file_info
operator|.
name|uncompressed_size
operator|=
name|uL
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|size_filename
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|size_file_extra
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|size_file_comment
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|disk_num_start
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|internal_fa
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|external_fa
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|// relative offset of local header
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|file_info_internal
operator|.
name|offset_curfile
operator|=
name|uL
expr_stmt|;
name|lSeek
operator|+=
name|file_info
operator|.
name|size_filename
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|szFileName
operator|!=
name|NULL
operator|)
condition|)
block|{
name|uLong
name|uSizeRead
decl_stmt|;
if|if
condition|(
name|file_info
operator|.
name|size_filename
operator|<
name|fileNameBufferSize
condition|)
block|{
operator|*
operator|(
name|szFileName
operator|+
name|file_info
operator|.
name|size_filename
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|uSizeRead
operator|=
name|file_info
operator|.
name|size_filename
expr_stmt|;
block|}
else|else
name|uSizeRead
operator|=
name|fileNameBufferSize
expr_stmt|;
if|if
condition|(
operator|(
name|file_info
operator|.
name|size_filename
operator|>
literal|0
operator|)
operator|&&
operator|(
name|fileNameBufferSize
operator|>
literal|0
operator|)
condition|)
if|if
condition|(
name|ZREAD64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|szFileName
argument_list|,
name|uSizeRead
argument_list|)
operator|!=
name|uSizeRead
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|lSeek
operator|-=
name|uSizeRead
expr_stmt|;
block|}
comment|// Read extrafield
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|extraField
operator|!=
name|NULL
operator|)
condition|)
block|{
name|ZPOS64_T
name|uSizeRead
decl_stmt|;
if|if
condition|(
name|file_info
operator|.
name|size_file_extra
operator|<
name|extraFieldBufferSize
condition|)
name|uSizeRead
operator|=
name|file_info
operator|.
name|size_file_extra
expr_stmt|;
else|else
name|uSizeRead
operator|=
name|extraFieldBufferSize
expr_stmt|;
if|if
condition|(
name|lSeek
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ZSEEK64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|lSeek
argument_list|,
name|ZLIB_FILEFUNC_SEEK_CUR
argument_list|)
operator|==
literal|0
condition|)
name|lSeek
operator|=
literal|0
expr_stmt|;
else|else
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|file_info
operator|.
name|size_file_extra
operator|>
literal|0
operator|)
operator|&&
operator|(
name|extraFieldBufferSize
operator|>
literal|0
operator|)
condition|)
if|if
condition|(
name|ZREAD64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|extraField
argument_list|,
operator|(
name|uLong
operator|)
name|uSizeRead
argument_list|)
operator|!=
name|uSizeRead
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|lSeek
operator|+=
name|file_info
operator|.
name|size_file_extra
operator|-
operator|(
name|uLong
operator|)
name|uSizeRead
expr_stmt|;
block|}
else|else
name|lSeek
operator|+=
name|file_info
operator|.
name|size_file_extra
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|file_info
operator|.
name|size_file_extra
operator|!=
literal|0
operator|)
condition|)
block|{
name|uLong
name|acc
init|=
literal|0
decl_stmt|;
comment|// since lSeek now points to after the extra field we need to move back
name|lSeek
operator|-=
name|file_info
operator|.
name|size_file_extra
expr_stmt|;
if|if
condition|(
name|lSeek
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ZSEEK64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|lSeek
argument_list|,
name|ZLIB_FILEFUNC_SEEK_CUR
argument_list|)
operator|==
literal|0
condition|)
name|lSeek
operator|=
literal|0
expr_stmt|;
else|else
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
block|}
while|while
condition|(
name|acc
operator|<
name|file_info
operator|.
name|size_file_extra
condition|)
block|{
name|uLong
name|headerId
decl_stmt|;
name|uLong
name|dataSize
decl_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|headerId
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|dataSize
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/* ZIP64 extra fields */
if|if
condition|(
name|headerId
operator|==
literal|0x0001
condition|)
block|{
name|uLong
name|uL
decl_stmt|;
if|if
condition|(
name|file_info
operator|.
name|uncompressed_size
operator|==
name|MAXU32
condition|)
block|{
if|if
condition|(
name|unz64local_getLong64
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|uncompressed_size
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
block|}
if|if
condition|(
name|file_info
operator|.
name|compressed_size
operator|==
name|MAXU32
condition|)
block|{
if|if
condition|(
name|unz64local_getLong64
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info
operator|.
name|compressed_size
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
block|}
if|if
condition|(
name|file_info_internal
operator|.
name|offset_curfile
operator|==
name|MAXU32
condition|)
block|{
comment|/* Relative Header offset */
if|if
condition|(
name|unz64local_getLong64
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|file_info_internal
operator|.
name|offset_curfile
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
block|}
if|if
condition|(
name|file_info
operator|.
name|disk_num_start
operator|==
name|MAXU32
condition|)
block|{
comment|/* Disk Start Number */
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ZSEEK64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|dataSize
argument_list|,
name|ZLIB_FILEFUNC_SEEK_CUR
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
block|}
name|acc
operator|+=
literal|2
operator|+
literal|2
operator|+
name|dataSize
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|szComment
operator|!=
name|NULL
operator|)
condition|)
block|{
name|uLong
name|uSizeRead
decl_stmt|;
if|if
condition|(
name|file_info
operator|.
name|size_file_comment
operator|<
name|commentBufferSize
condition|)
block|{
operator|*
operator|(
name|szComment
operator|+
name|file_info
operator|.
name|size_file_comment
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|uSizeRead
operator|=
name|file_info
operator|.
name|size_file_comment
expr_stmt|;
block|}
else|else
name|uSizeRead
operator|=
name|commentBufferSize
expr_stmt|;
if|if
condition|(
name|lSeek
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ZSEEK64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|lSeek
argument_list|,
name|ZLIB_FILEFUNC_SEEK_CUR
argument_list|)
operator|==
literal|0
condition|)
name|lSeek
operator|=
literal|0
expr_stmt|;
else|else
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|file_info
operator|.
name|size_file_comment
operator|>
literal|0
operator|)
operator|&&
operator|(
name|commentBufferSize
operator|>
literal|0
operator|)
condition|)
if|if
condition|(
name|ZREAD64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|szComment
argument_list|,
name|uSizeRead
argument_list|)
operator|!=
name|uSizeRead
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
name|lSeek
operator|+=
name|file_info
operator|.
name|size_file_comment
operator|-
name|uSizeRead
expr_stmt|;
block|}
else|else
name|lSeek
operator|+=
name|file_info
operator|.
name|size_file_comment
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|pfile_info
operator|!=
name|NULL
operator|)
condition|)
operator|*
name|pfile_info
operator|=
name|file_info
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|pfile_info_internal
operator|!=
name|NULL
operator|)
condition|)
operator|*
name|pfile_info_internal
operator|=
name|file_info_internal
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*   Write info about the ZipFile in the *pglobal_info structure.   No preparation of the structure is needed   return UNZ_OK if there is no problem. */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGetCurrentFileInfo64
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|unz_file_info64
modifier|*
name|pfile_info
parameter_list|,
name|char
modifier|*
name|szFileName
parameter_list|,
name|uLong
name|fileNameBufferSize
parameter_list|,
name|void
modifier|*
name|extraField
parameter_list|,
name|uLong
name|extraFieldBufferSize
parameter_list|,
name|char
modifier|*
name|szComment
parameter_list|,
name|uLong
name|commentBufferSize
parameter_list|)
block|{
return|return
name|unz64local_GetCurrentFileInfoInternal
argument_list|(
name|file
argument_list|,
name|pfile_info
argument_list|,
name|NULL
argument_list|,
name|szFileName
argument_list|,
name|fileNameBufferSize
argument_list|,
name|extraField
argument_list|,
name|extraFieldBufferSize
argument_list|,
name|szComment
argument_list|,
name|commentBufferSize
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGetCurrentFileInfo
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|unz_file_info
modifier|*
name|pfile_info
parameter_list|,
name|char
modifier|*
name|szFileName
parameter_list|,
name|uLong
name|fileNameBufferSize
parameter_list|,
name|void
modifier|*
name|extraField
parameter_list|,
name|uLong
name|extraFieldBufferSize
parameter_list|,
name|char
modifier|*
name|szComment
parameter_list|,
name|uLong
name|commentBufferSize
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|unz_file_info64
name|file_info64
decl_stmt|;
name|err
operator|=
name|unz64local_GetCurrentFileInfoInternal
argument_list|(
name|file
argument_list|,
operator|&
name|file_info64
argument_list|,
name|NULL
argument_list|,
name|szFileName
argument_list|,
name|fileNameBufferSize
argument_list|,
name|extraField
argument_list|,
name|extraFieldBufferSize
argument_list|,
name|szComment
argument_list|,
name|commentBufferSize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|pfile_info
operator|!=
name|NULL
operator|)
condition|)
block|{
name|pfile_info
operator|->
name|version
operator|=
name|file_info64
operator|.
name|version
expr_stmt|;
name|pfile_info
operator|->
name|version_needed
operator|=
name|file_info64
operator|.
name|version_needed
expr_stmt|;
name|pfile_info
operator|->
name|flag
operator|=
name|file_info64
operator|.
name|flag
expr_stmt|;
name|pfile_info
operator|->
name|compression_method
operator|=
name|file_info64
operator|.
name|compression_method
expr_stmt|;
name|pfile_info
operator|->
name|dosDate
operator|=
name|file_info64
operator|.
name|dosDate
expr_stmt|;
name|pfile_info
operator|->
name|crc
operator|=
name|file_info64
operator|.
name|crc
expr_stmt|;
name|pfile_info
operator|->
name|size_filename
operator|=
name|file_info64
operator|.
name|size_filename
expr_stmt|;
name|pfile_info
operator|->
name|size_file_extra
operator|=
name|file_info64
operator|.
name|size_file_extra
expr_stmt|;
name|pfile_info
operator|->
name|size_file_comment
operator|=
name|file_info64
operator|.
name|size_file_comment
expr_stmt|;
name|pfile_info
operator|->
name|disk_num_start
operator|=
name|file_info64
operator|.
name|disk_num_start
expr_stmt|;
name|pfile_info
operator|->
name|internal_fa
operator|=
name|file_info64
operator|.
name|internal_fa
expr_stmt|;
name|pfile_info
operator|->
name|external_fa
operator|=
name|file_info64
operator|.
name|external_fa
expr_stmt|;
name|pfile_info
operator|->
name|tmu_date
operator|=
name|file_info64
operator|.
name|tmu_date
operator|,
name|pfile_info
operator|->
name|compressed_size
operator|=
operator|(
name|uLong
operator|)
name|file_info64
operator|.
name|compressed_size
expr_stmt|;
name|pfile_info
operator|->
name|uncompressed_size
operator|=
operator|(
name|uLong
operator|)
name|file_info64
operator|.
name|uncompressed_size
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*   Set the current file of the zipfile to the first file.   return UNZ_OK if there is no problem */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGoToFirstFile
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|int
name|err
init|=
name|UNZ_OK
decl_stmt|;
name|unz64_s
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
name|s
operator|->
name|pos_in_central_dir
operator|=
name|s
operator|->
name|offset_central_dir
expr_stmt|;
name|s
operator|->
name|num_file
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|unz64local_GetCurrentFileInfoInternal
argument_list|(
name|file
argument_list|,
operator|&
name|s
operator|->
name|cur_file_info
argument_list|,
operator|&
name|s
operator|->
name|cur_file_info_internal
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|s
operator|->
name|current_file_ok
operator|=
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*   Set the current file of the zipfile to the next file.   return UNZ_OK if there is no problem   return UNZ_END_OF_LIST_OF_FILE if the actual file was the latest. */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGoToNextFile
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
operator|!
name|s
operator|->
name|current_file_ok
condition|)
return|return
name|UNZ_END_OF_LIST_OF_FILE
return|;
if|if
condition|(
name|s
operator|->
name|gi
operator|.
name|number_entry
operator|!=
literal|0xffff
condition|)
comment|/* 2^16 files overflow hack */
if|if
condition|(
name|s
operator|->
name|num_file
operator|+
literal|1
operator|==
name|s
operator|->
name|gi
operator|.
name|number_entry
condition|)
return|return
name|UNZ_END_OF_LIST_OF_FILE
return|;
name|s
operator|->
name|pos_in_central_dir
operator|+=
name|SIZECENTRALDIRITEM
operator|+
name|s
operator|->
name|cur_file_info
operator|.
name|size_filename
operator|+
name|s
operator|->
name|cur_file_info
operator|.
name|size_file_extra
operator|+
name|s
operator|->
name|cur_file_info
operator|.
name|size_file_comment
expr_stmt|;
name|s
operator|->
name|num_file
operator|++
expr_stmt|;
name|err
operator|=
name|unz64local_GetCurrentFileInfoInternal
argument_list|(
name|file
argument_list|,
operator|&
name|s
operator|->
name|cur_file_info
argument_list|,
operator|&
name|s
operator|->
name|cur_file_info_internal
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|s
operator|->
name|current_file_ok
operator|=
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*   Try locate the file szFileName in the zipfile.   For the iCaseSensitivity signification, see unzStringFileNameCompare    return value :   UNZ_OK if the file is found. It becomes the current file.   UNZ_END_OF_LIST_OF_FILE if the file is not found */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzLocateFile
parameter_list|(
name|unzFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|szFileName
parameter_list|,
name|int
name|iCaseSensitivity
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* We remember the 'current' position in the file so that we can jump      * back there if we fail.      */
name|unz_file_info64
name|cur_file_infoSaved
decl_stmt|;
name|unz_file_info64_internal
name|cur_file_info_internalSaved
decl_stmt|;
name|ZPOS64_T
name|num_fileSaved
decl_stmt|;
name|ZPOS64_T
name|pos_in_central_dirSaved
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
if|if
condition|(
name|strlen
argument_list|(
name|szFileName
argument_list|)
operator|>=
name|UNZ_MAXFILENAMEINZIP
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
operator|!
name|s
operator|->
name|current_file_ok
condition|)
return|return
name|UNZ_END_OF_LIST_OF_FILE
return|;
comment|/* Save the current state */
name|num_fileSaved
operator|=
name|s
operator|->
name|num_file
expr_stmt|;
name|pos_in_central_dirSaved
operator|=
name|s
operator|->
name|pos_in_central_dir
expr_stmt|;
name|cur_file_infoSaved
operator|=
name|s
operator|->
name|cur_file_info
expr_stmt|;
name|cur_file_info_internalSaved
operator|=
name|s
operator|->
name|cur_file_info_internal
expr_stmt|;
name|err
operator|=
name|unzGoToFirstFile
argument_list|(
name|file
argument_list|)
expr_stmt|;
while|while
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
block|{
name|char
name|szCurrentFileName
index|[
name|UNZ_MAXFILENAMEINZIP
operator|+
literal|1
index|]
decl_stmt|;
name|err
operator|=
name|unzGetCurrentFileInfo64
argument_list|(
name|file
argument_list|,
name|NULL
argument_list|,
name|szCurrentFileName
argument_list|,
sizeof|sizeof
argument_list|(
name|szCurrentFileName
argument_list|)
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
block|{
if|if
condition|(
name|unzStringFileNameCompare
argument_list|(
name|szCurrentFileName
argument_list|,
name|szFileName
argument_list|,
name|iCaseSensitivity
argument_list|)
operator|==
literal|0
condition|)
return|return
name|UNZ_OK
return|;
name|err
operator|=
name|unzGoToNextFile
argument_list|(
name|file
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* We failed, so restore the state of the 'current file' to where we      * were.      */
name|s
operator|->
name|num_file
operator|=
name|num_fileSaved
expr_stmt|;
name|s
operator|->
name|pos_in_central_dir
operator|=
name|pos_in_central_dirSaved
expr_stmt|;
name|s
operator|->
name|cur_file_info
operator|=
name|cur_file_infoSaved
expr_stmt|;
name|s
operator|->
name|cur_file_info_internal
operator|=
name|cur_file_info_internalSaved
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* /////////////////////////////////////////// // Contributed by Ryan Haksi (mailto://cryogen@infoserve.net) // I need random access // // Further optimization could be realized by adding an ability // to cache the directory in memory. The goal being a single // comprehensive file read to put the file I need in a memory. */
end_comment

begin_comment
comment|/* typedef struct unz_file_pos_s {     ZPOS64_T pos_in_zip_directory;   // offset in file     ZPOS64_T num_of_file;            // # of file } unz_file_pos; */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGetFilePos64
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|unz64_file_pos
modifier|*
name|file_pos
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
operator|||
name|file_pos
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
operator|!
name|s
operator|->
name|current_file_ok
condition|)
return|return
name|UNZ_END_OF_LIST_OF_FILE
return|;
name|file_pos
operator|->
name|pos_in_zip_directory
operator|=
name|s
operator|->
name|pos_in_central_dir
expr_stmt|;
name|file_pos
operator|->
name|num_of_file
operator|=
name|s
operator|->
name|num_file
expr_stmt|;
return|return
name|UNZ_OK
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGetFilePos
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|unz_file_pos
modifier|*
name|file_pos
parameter_list|)
block|{
name|unz64_file_pos
name|file_pos64
decl_stmt|;
name|int
name|err
init|=
name|unzGetFilePos64
argument_list|(
name|file
argument_list|,
operator|&
name|file_pos64
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
block|{
name|file_pos
operator|->
name|pos_in_zip_directory
operator|=
operator|(
name|uLong
operator|)
name|file_pos64
operator|.
name|pos_in_zip_directory
expr_stmt|;
name|file_pos
operator|->
name|num_of_file
operator|=
operator|(
name|uLong
operator|)
name|file_pos64
operator|.
name|num_of_file
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGoToFilePos64
parameter_list|(
name|unzFile
name|file
parameter_list|,
specifier|const
name|unz64_file_pos
modifier|*
name|file_pos
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
operator|||
name|file_pos
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
comment|/* jump to the right spot */
name|s
operator|->
name|pos_in_central_dir
operator|=
name|file_pos
operator|->
name|pos_in_zip_directory
expr_stmt|;
name|s
operator|->
name|num_file
operator|=
name|file_pos
operator|->
name|num_of_file
expr_stmt|;
comment|/* set the current file */
name|err
operator|=
name|unz64local_GetCurrentFileInfoInternal
argument_list|(
name|file
argument_list|,
operator|&
name|s
operator|->
name|cur_file_info
argument_list|,
operator|&
name|s
operator|->
name|cur_file_info_internal
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* return results */
name|s
operator|->
name|current_file_ok
operator|=
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGoToFilePos
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|unz_file_pos
modifier|*
name|file_pos
parameter_list|)
block|{
name|unz64_file_pos
name|file_pos64
decl_stmt|;
if|if
condition|(
name|file_pos
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|file_pos64
operator|.
name|pos_in_zip_directory
operator|=
name|file_pos
operator|->
name|pos_in_zip_directory
expr_stmt|;
name|file_pos64
operator|.
name|num_of_file
operator|=
name|file_pos
operator|->
name|num_of_file
expr_stmt|;
return|return
name|unzGoToFilePos64
argument_list|(
name|file
argument_list|,
operator|&
name|file_pos64
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* // Unzip Helper Functions - should be here? /////////////////////////////////////////// */
end_comment

begin_comment
comment|/*   Read the local header of the current zipfile   Check the coherency of the local header and info in the end of central         directory about this file   store in *piSizeVar the size of extra info in local header         (filename and size of extra field data) */
end_comment

begin_function
name|local
name|int
name|unz64local_CheckCurrentFileCoherencyHeader
parameter_list|(
name|unz64_s
modifier|*
name|s
parameter_list|,
name|uInt
modifier|*
name|piSizeVar
parameter_list|,
name|ZPOS64_T
modifier|*
name|poffset_local_extrafield
parameter_list|,
name|uInt
modifier|*
name|psize_local_extrafield
parameter_list|)
block|{
name|uLong
name|uMagic
decl_stmt|,
name|uData
decl_stmt|,
name|uFlags
decl_stmt|;
name|uLong
name|size_filename
decl_stmt|;
name|uLong
name|size_extra_field
decl_stmt|;
name|int
name|err
init|=
name|UNZ_OK
decl_stmt|;
operator|*
name|piSizeVar
operator|=
literal|0
expr_stmt|;
operator|*
name|poffset_local_extrafield
operator|=
literal|0
expr_stmt|;
operator|*
name|psize_local_extrafield
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|s
operator|->
name|cur_file_info_internal
operator|.
name|offset_curfile
operator|+
name|s
operator|->
name|byte_before_the_zipfile
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|UNZ_ERRNO
return|;
if|if
condition|(
name|err
operator|==
name|UNZ_OK
condition|)
block|{
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uMagic
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
elseif|else
if|if
condition|(
name|uMagic
operator|!=
literal|0x04034b50
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
block|}
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uData
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
comment|/*     else if ((err==UNZ_OK)&& (uData!=s->cur_file_info.wVersion))         err=UNZ_BADZIPFILE; */
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uFlags
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uData
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|uData
operator|!=
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
operator|!=
literal|0
operator|)
operator|&&
comment|/* #ifdef HAVE_BZIP2 */
operator|(
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
operator|!=
name|Z_BZIP2ED
operator|)
operator|&&
comment|/* #endif */
operator|(
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
operator|!=
name|Z_DEFLATED
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uData
argument_list|)
operator|!=
name|UNZ_OK
condition|)
comment|/* date/time */
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uData
argument_list|)
operator|!=
name|UNZ_OK
condition|)
comment|/* crc */
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|uData
operator|!=
name|s
operator|->
name|cur_file_info
operator|.
name|crc
operator|)
operator|&&
operator|(
operator|(
name|uFlags
operator|&
literal|8
operator|)
operator|==
literal|0
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uData
argument_list|)
operator|!=
name|UNZ_OK
condition|)
comment|/* size compr */
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
elseif|else
if|if
condition|(
name|uData
operator|!=
literal|0xFFFFFFFF
operator|&&
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|uData
operator|!=
name|s
operator|->
name|cur_file_info
operator|.
name|compressed_size
operator|)
operator|&&
operator|(
operator|(
name|uFlags
operator|&
literal|8
operator|)
operator|==
literal|0
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
if|if
condition|(
name|unz64local_getLong
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|uData
argument_list|)
operator|!=
name|UNZ_OK
condition|)
comment|/* size uncompr */
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
elseif|else
if|if
condition|(
name|uData
operator|!=
literal|0xFFFFFFFF
operator|&&
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|uData
operator|!=
name|s
operator|->
name|cur_file_info
operator|.
name|uncompressed_size
operator|)
operator|&&
operator|(
operator|(
name|uFlags
operator|&
literal|8
operator|)
operator|==
literal|0
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|size_filename
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
operator|&&
operator|(
name|size_filename
operator|!=
name|s
operator|->
name|cur_file_info
operator|.
name|size_filename
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
operator|*
name|piSizeVar
operator|+=
operator|(
name|uInt
operator|)
name|size_filename
expr_stmt|;
if|if
condition|(
name|unz64local_getShort
argument_list|(
operator|&
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
operator|&
name|size_extra_field
argument_list|)
operator|!=
name|UNZ_OK
condition|)
name|err
operator|=
name|UNZ_ERRNO
expr_stmt|;
operator|*
name|poffset_local_extrafield
operator|=
name|s
operator|->
name|cur_file_info_internal
operator|.
name|offset_curfile
operator|+
name|SIZEZIPLOCALHEADER
operator|+
name|size_filename
expr_stmt|;
operator|*
name|psize_local_extrafield
operator|=
operator|(
name|uInt
operator|)
name|size_extra_field
expr_stmt|;
operator|*
name|piSizeVar
operator|+=
operator|(
name|uInt
operator|)
name|size_extra_field
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*   Open for reading data the current file in the zipfile.   If there is no error and the file is opened, the return value is UNZ_OK. */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzOpenCurrentFile3
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|int
modifier|*
name|method
parameter_list|,
name|int
modifier|*
name|level
parameter_list|,
name|int
name|raw
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|)
block|{
name|int
name|err
init|=
name|UNZ_OK
decl_stmt|;
name|uInt
name|iSizeVar
decl_stmt|;
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|file_in_zip64_read_info_s
modifier|*
name|pfile_in_zip_read_info
decl_stmt|;
name|ZPOS64_T
name|offset_local_extrafield
decl_stmt|;
comment|/* offset of the local extra field */
name|uInt
name|size_local_extrafield
decl_stmt|;
comment|/* size of the local extra field */
ifndef|#
directive|ifndef
name|NOUNCRYPT
name|char
name|source
index|[
literal|12
index|]
decl_stmt|;
else|#
directive|else
if|if
condition|(
name|password
operator|!=
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
endif|#
directive|endif
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
operator|!
name|s
operator|->
name|current_file_ok
condition|)
return|return
name|UNZ_PARAMERROR
return|;
if|if
condition|(
name|s
operator|->
name|pfile_in_zip_read
operator|!=
name|NULL
condition|)
name|unzCloseCurrentFile
argument_list|(
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|unz64local_CheckCurrentFileCoherencyHeader
argument_list|(
name|s
argument_list|,
operator|&
name|iSizeVar
argument_list|,
operator|&
name|offset_local_extrafield
argument_list|,
operator|&
name|size_local_extrafield
argument_list|)
operator|!=
name|UNZ_OK
condition|)
return|return
name|UNZ_BADZIPFILE
return|;
name|pfile_in_zip_read_info
operator|=
operator|(
name|file_in_zip64_read_info_s
operator|*
operator|)
name|ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|file_in_zip64_read_info_s
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|==
name|NULL
condition|)
return|return
name|UNZ_INTERNALERROR
return|;
name|pfile_in_zip_read_info
operator|->
name|read_buffer
operator|=
operator|(
name|char
operator|*
operator|)
name|ALLOC
argument_list|(
name|UNZ_BUFSIZE
argument_list|)
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|offset_local_extrafield
operator|=
name|offset_local_extrafield
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|size_local_extrafield
operator|=
name|size_local_extrafield
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|pos_local_extrafield
operator|=
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|raw
operator|=
name|raw
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|->
name|read_buffer
operator|==
name|NULL
condition|)
block|{
name|TRYFREE
argument_list|(
name|pfile_in_zip_read_info
argument_list|)
expr_stmt|;
return|return
name|UNZ_INTERNALERROR
return|;
block|}
name|pfile_in_zip_read_info
operator|->
name|stream_initialised
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|method
operator|!=
name|NULL
condition|)
operator|*
name|method
operator|=
operator|(
name|int
operator|)
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
expr_stmt|;
if|if
condition|(
name|level
operator|!=
name|NULL
condition|)
block|{
operator|*
name|level
operator|=
literal|6
expr_stmt|;
switch|switch
condition|(
name|s
operator|->
name|cur_file_info
operator|.
name|flag
operator|&
literal|0x06
condition|)
block|{
case|case
literal|6
case|:
operator|*
name|level
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|4
case|:
operator|*
name|level
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
operator|*
name|level
operator|=
literal|9
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|(
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
operator|!=
literal|0
operator|)
operator|&&
comment|/* #ifdef HAVE_BZIP2 */
operator|(
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
operator|!=
name|Z_BZIP2ED
operator|)
operator|&&
comment|/* #endif */
operator|(
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
operator|!=
name|Z_DEFLATED
operator|)
condition|)
name|err
operator|=
name|UNZ_BADZIPFILE
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|crc32_wait
operator|=
name|s
operator|->
name|cur_file_info
operator|.
name|crc
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|crc32
operator|=
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|total_out_64
operator|=
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|compression_method
operator|=
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|filestream
operator|=
name|s
operator|->
name|filestream
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|z_filefunc
operator|=
name|s
operator|->
name|z_filefunc
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|byte_before_the_zipfile
operator|=
name|s
operator|->
name|byte_before_the_zipfile
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|total_out
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
operator|==
name|Z_BZIP2ED
operator|)
operator|&&
operator|(
operator|!
name|raw
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_BZIP2
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|bzalloc
operator|=
operator|(
name|void
operator|*
call|(
modifier|*
call|)
argument_list|(
name|void
operator|*
argument_list|,
name|int
argument_list|,
name|int
argument_list|)
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|bzfree
operator|=
operator|(
name|free_func
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|opaque
operator|=
operator|(
name|voidpf
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|state
operator|=
operator|(
name|voidpf
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|zalloc
operator|=
operator|(
name|alloc_func
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|zfree
operator|=
operator|(
name|free_func
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|opaque
operator|=
operator|(
name|voidpf
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_in
operator|=
operator|(
name|voidpf
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|BZ2_bzDecompressInit
argument_list|(
operator|&
name|pfile_in_zip_read_info
operator|->
name|bstream
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|Z_OK
condition|)
name|pfile_in_zip_read_info
operator|->
name|stream_initialised
operator|=
name|Z_BZIP2ED
expr_stmt|;
else|else
block|{
name|TRYFREE
argument_list|(
name|pfile_in_zip_read_info
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
else|#
directive|else
name|pfile_in_zip_read_info
operator|->
name|raw
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
operator|(
name|s
operator|->
name|cur_file_info
operator|.
name|compression_method
operator|==
name|Z_DEFLATED
operator|)
operator|&&
operator|(
operator|!
name|raw
operator|)
condition|)
block|{
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|zalloc
operator|=
operator|(
name|alloc_func
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|zfree
operator|=
operator|(
name|free_func
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|opaque
operator|=
operator|(
name|voidpf
operator|)
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_in
operator|=
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|inflateInit2
argument_list|(
operator|&
name|pfile_in_zip_read_info
operator|->
name|stream
argument_list|,
operator|-
name|MAX_WBITS
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|Z_OK
condition|)
name|pfile_in_zip_read_info
operator|->
name|stream_initialised
operator|=
name|Z_DEFLATED
expr_stmt|;
else|else
block|{
name|TRYFREE
argument_list|(
name|pfile_in_zip_read_info
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
comment|/* windowBits is passed< 0 to tell that there is no zlib header.          * Note that in this case inflate *requires* an extra "dummy" byte          * after the compressed stream in order to complete decompression and          * return Z_STREAM_END.          * In unzip, i don't wait absolutely Z_STREAM_END because I known the          * size of both compressed and uncompressed data          */
block|}
name|pfile_in_zip_read_info
operator|->
name|rest_read_compressed
operator|=
name|s
operator|->
name|cur_file_info
operator|.
name|compressed_size
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|rest_read_uncompressed
operator|=
name|s
operator|->
name|cur_file_info
operator|.
name|uncompressed_size
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|pos_in_zipfile
operator|=
name|s
operator|->
name|cur_file_info_internal
operator|.
name|offset_curfile
operator|+
name|SIZEZIPLOCALHEADER
operator|+
name|iSizeVar
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
operator|=
operator|(
name|uInt
operator|)
literal|0
expr_stmt|;
name|s
operator|->
name|pfile_in_zip_read
operator|=
name|pfile_in_zip_read_info
expr_stmt|;
name|s
operator|->
name|encrypted
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|NOUNCRYPT
if|if
condition|(
name|password
operator|!=
name|NULL
condition|)
block|{
name|int
name|i
decl_stmt|;
name|s
operator|->
name|pcrc_32_tab
operator|=
name|get_crc_table
argument_list|()
expr_stmt|;
name|init_keys
argument_list|(
name|password
argument_list|,
name|s
operator|->
name|keys
argument_list|,
name|s
operator|->
name|pcrc_32_tab
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|s
operator|->
name|pfile_in_zip_read
operator|->
name|pos_in_zipfile
operator|+
name|s
operator|->
name|pfile_in_zip_read
operator|->
name|byte_before_the_zipfile
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|UNZ_INTERNALERROR
return|;
if|if
condition|(
name|ZREAD64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|source
argument_list|,
literal|12
argument_list|)
operator|<
literal|12
condition|)
return|return
name|UNZ_INTERNALERROR
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|12
condition|;
name|i
operator|++
control|)
name|zdecode
argument_list|(
name|s
operator|->
name|keys
argument_list|,
name|s
operator|->
name|pcrc_32_tab
argument_list|,
name|source
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|s
operator|->
name|pfile_in_zip_read
operator|->
name|pos_in_zipfile
operator|+=
literal|12
expr_stmt|;
name|s
operator|->
name|encrypted
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|UNZ_OK
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzOpenCurrentFile
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
return|return
name|unzOpenCurrentFile3
argument_list|(
name|file
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzOpenCurrentFilePassword
parameter_list|(
name|unzFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|)
block|{
return|return
name|unzOpenCurrentFile3
argument_list|(
name|file
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|password
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzOpenCurrentFile2
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|int
modifier|*
name|method
parameter_list|,
name|int
modifier|*
name|level
parameter_list|,
name|int
name|raw
parameter_list|)
block|{
return|return
name|unzOpenCurrentFile3
argument_list|(
name|file
argument_list|,
name|method
argument_list|,
name|level
argument_list|,
name|raw
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/** Addition for GDAL : START */
end_comment

begin_function
specifier|extern
name|ZPOS64_T
name|ZEXPORT
name|unzGetCurrentFileZStreamPos64
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|file_in_zip64_read_info_s
modifier|*
name|pfile_in_zip_read_info
decl_stmt|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|//UNZ_PARAMERROR;
name|pfile_in_zip_read_info
operator|=
name|s
operator|->
name|pfile_in_zip_read
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|//UNZ_PARAMERROR;
return|return
name|pfile_in_zip_read_info
operator|->
name|pos_in_zipfile
operator|+
name|pfile_in_zip_read_info
operator|->
name|byte_before_the_zipfile
return|;
block|}
end_function

begin_comment
comment|/** Addition for GDAL : END */
end_comment

begin_comment
comment|/*   Read bytes from the current file.   buf contain buffer where data must be copied   len the size of buf.    return the number of byte copied if somes bytes are copied   return 0 if the end of file was reached   return<0 with error code if there is an error     (UNZ_ERRNO for IO error, or zLib error for uncompress error) */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzReadCurrentFile
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|voidp
name|buf
parameter_list|,
name|unsigned
name|len
parameter_list|)
block|{
name|int
name|err
init|=
name|UNZ_OK
decl_stmt|;
name|uInt
name|iRead
init|=
literal|0
decl_stmt|;
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|file_in_zip64_read_info_s
modifier|*
name|pfile_in_zip_read_info
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
name|pfile_in_zip_read_info
operator|=
name|s
operator|->
name|pfile_in_zip_read
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|->
name|read_buffer
operator|==
name|NULL
condition|)
return|return
name|UNZ_END_OF_LIST_OF_FILE
return|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_out
operator|=
operator|(
name|Bytef
operator|*
operator|)
name|buf
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_out
operator|=
operator|(
name|uInt
operator|)
name|len
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|>
name|pfile_in_zip_read_info
operator|->
name|rest_read_uncompressed
operator|)
operator|&&
operator|(
operator|!
operator|(
name|pfile_in_zip_read_info
operator|->
name|raw
operator|)
operator|)
condition|)
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_out
operator|=
operator|(
name|uInt
operator|)
name|pfile_in_zip_read_info
operator|->
name|rest_read_uncompressed
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|>
name|pfile_in_zip_read_info
operator|->
name|rest_read_compressed
operator|+
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
operator|)
operator|&&
operator|(
name|pfile_in_zip_read_info
operator|->
name|raw
operator|)
condition|)
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_out
operator|=
operator|(
name|uInt
operator|)
name|pfile_in_zip_read_info
operator|->
name|rest_read_compressed
operator|+
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
expr_stmt|;
while|while
condition|(
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_out
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
operator|==
literal|0
operator|)
operator|&&
operator|(
name|pfile_in_zip_read_info
operator|->
name|rest_read_compressed
operator|>
literal|0
operator|)
condition|)
block|{
name|uInt
name|uReadThis
init|=
name|UNZ_BUFSIZE
decl_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|->
name|rest_read_compressed
operator|<
name|uReadThis
condition|)
name|uReadThis
operator|=
operator|(
name|uInt
operator|)
name|pfile_in_zip_read_info
operator|->
name|rest_read_compressed
expr_stmt|;
if|if
condition|(
name|uReadThis
operator|==
literal|0
condition|)
return|return
name|UNZ_EOF
return|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|pfile_in_zip_read_info
operator|->
name|z_filefunc
argument_list|,
name|pfile_in_zip_read_info
operator|->
name|filestream
argument_list|,
name|pfile_in_zip_read_info
operator|->
name|pos_in_zipfile
operator|+
name|pfile_in_zip_read_info
operator|->
name|byte_before_the_zipfile
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|UNZ_ERRNO
return|;
if|if
condition|(
name|ZREAD64
argument_list|(
name|pfile_in_zip_read_info
operator|->
name|z_filefunc
argument_list|,
name|pfile_in_zip_read_info
operator|->
name|filestream
argument_list|,
name|pfile_in_zip_read_info
operator|->
name|read_buffer
argument_list|,
name|uReadThis
argument_list|)
operator|!=
name|uReadThis
condition|)
return|return
name|UNZ_ERRNO
return|;
ifndef|#
directive|ifndef
name|NOUNCRYPT
if|if
condition|(
name|s
operator|->
name|encrypted
condition|)
block|{
name|uInt
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|uReadThis
condition|;
name|i
operator|++
control|)
name|pfile_in_zip_read_info
operator|->
name|read_buffer
index|[
name|i
index|]
operator|=
name|zdecode
argument_list|(
name|s
operator|->
name|keys
argument_list|,
name|s
operator|->
name|pcrc_32_tab
argument_list|,
name|pfile_in_zip_read_info
operator|->
name|read_buffer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|pfile_in_zip_read_info
operator|->
name|pos_in_zipfile
operator|+=
name|uReadThis
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|rest_read_compressed
operator|-=
name|uReadThis
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_in
operator|=
operator|(
name|Bytef
operator|*
operator|)
name|pfile_in_zip_read_info
operator|->
name|read_buffer
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
operator|=
operator|(
name|uInt
operator|)
name|uReadThis
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pfile_in_zip_read_info
operator|->
name|compression_method
operator|==
literal|0
operator|)
operator|||
operator|(
name|pfile_in_zip_read_info
operator|->
name|raw
operator|)
condition|)
block|{
name|uInt
name|uDoCopy
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
operator|==
literal|0
operator|)
operator|&&
operator|(
name|pfile_in_zip_read_info
operator|->
name|rest_read_compressed
operator|==
literal|0
operator|)
condition|)
return|return
operator|(
name|iRead
operator|==
literal|0
operator|)
condition|?
name|UNZ_EOF
else|:
name|iRead
return|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_out
operator|<
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
condition|)
name|uDoCopy
operator|=
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_out
expr_stmt|;
else|else
name|uDoCopy
operator|=
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|uDoCopy
condition|;
name|i
operator|++
control|)
operator|*
operator|(
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_out
operator|+
name|i
operator|)
operator|=
operator|*
operator|(
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_in
operator|+
name|i
operator|)
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|total_out_64
operator|=
name|pfile_in_zip_read_info
operator|->
name|total_out_64
operator|+
name|uDoCopy
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|crc32
operator|=
name|crc32
argument_list|(
name|pfile_in_zip_read_info
operator|->
name|crc32
argument_list|,
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_out
argument_list|,
name|uDoCopy
argument_list|)
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|rest_read_uncompressed
operator|-=
name|uDoCopy
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
operator|-=
name|uDoCopy
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_out
operator|-=
name|uDoCopy
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_out
operator|+=
name|uDoCopy
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_in
operator|+=
name|uDoCopy
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|total_out
operator|+=
name|uDoCopy
expr_stmt|;
name|iRead
operator|+=
name|uDoCopy
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pfile_in_zip_read_info
operator|->
name|compression_method
operator|==
name|Z_BZIP2ED
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_BZIP2
name|uLong
name|uTotalOutBefore
decl_stmt|,
name|uTotalOutAfter
decl_stmt|;
specifier|const
name|Bytef
modifier|*
name|bufBefore
decl_stmt|;
name|uLong
name|uOutThis
decl_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|next_in
operator|=
operator|(
name|char
operator|*
operator|)
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_in
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|avail_in
operator|=
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|total_in_lo32
operator|=
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|total_in
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|total_in_hi32
operator|=
literal|0
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|next_out
operator|=
operator|(
name|char
operator|*
operator|)
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_out
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|avail_out
operator|=
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_out
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|total_out_lo32
operator|=
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|total_out
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|total_out_hi32
operator|=
literal|0
expr_stmt|;
name|uTotalOutBefore
operator|=
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|total_out_lo32
expr_stmt|;
name|bufBefore
operator|=
operator|(
specifier|const
name|Bytef
operator|*
operator|)
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|next_out
expr_stmt|;
name|err
operator|=
name|BZ2_bzDecompress
argument_list|(
operator|&
name|pfile_in_zip_read_info
operator|->
name|bstream
argument_list|)
expr_stmt|;
name|uTotalOutAfter
operator|=
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|total_out_lo32
expr_stmt|;
name|uOutThis
operator|=
name|uTotalOutAfter
operator|-
name|uTotalOutBefore
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|total_out_64
operator|=
name|pfile_in_zip_read_info
operator|->
name|total_out_64
operator|+
name|uOutThis
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|crc32
operator|=
name|crc32
argument_list|(
name|pfile_in_zip_read_info
operator|->
name|crc32
argument_list|,
name|bufBefore
argument_list|,
call|(
name|uInt
call|)
argument_list|(
name|uOutThis
argument_list|)
argument_list|)
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|rest_read_uncompressed
operator|-=
name|uOutThis
expr_stmt|;
name|iRead
operator|+=
call|(
name|uInt
call|)
argument_list|(
name|uTotalOutAfter
operator|-
name|uTotalOutBefore
argument_list|)
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_in
operator|=
operator|(
name|Bytef
operator|*
operator|)
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|next_in
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_in
operator|=
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|avail_in
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|total_in
operator|=
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|total_in_lo32
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_out
operator|=
operator|(
name|Bytef
operator|*
operator|)
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|next_out
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|avail_out
operator|=
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|avail_out
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|total_out
operator|=
name|pfile_in_zip_read_info
operator|->
name|bstream
operator|.
name|total_out_lo32
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|BZ_STREAM_END
condition|)
return|return
operator|(
name|iRead
operator|==
literal|0
operator|)
condition|?
name|UNZ_EOF
else|:
name|iRead
return|;
if|if
condition|(
name|err
operator|!=
name|BZ_OK
condition|)
break|break;
endif|#
directive|endif
block|}
comment|// end Z_BZIP2ED
else|else
block|{
name|ZPOS64_T
name|uTotalOutBefore
decl_stmt|,
name|uTotalOutAfter
decl_stmt|;
specifier|const
name|Bytef
modifier|*
name|bufBefore
decl_stmt|;
name|ZPOS64_T
name|uOutThis
decl_stmt|;
name|int
name|flush
init|=
name|Z_SYNC_FLUSH
decl_stmt|;
name|uTotalOutBefore
operator|=
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|total_out
expr_stmt|;
name|bufBefore
operator|=
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|next_out
expr_stmt|;
comment|/*             if ((pfile_in_zip_read_info->rest_read_uncompressed ==                      pfile_in_zip_read_info->stream.avail_out)&&                 (pfile_in_zip_read_info->rest_read_compressed == 0))                 flush = Z_FINISH;             */
name|err
operator|=
name|inflate
argument_list|(
operator|&
name|pfile_in_zip_read_info
operator|->
name|stream
argument_list|,
name|flush
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|msg
operator|!=
name|NULL
operator|)
condition|)
name|err
operator|=
name|Z_DATA_ERROR
expr_stmt|;
name|uTotalOutAfter
operator|=
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|total_out
expr_stmt|;
name|uOutThis
operator|=
name|uTotalOutAfter
operator|-
name|uTotalOutBefore
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|total_out_64
operator|=
name|pfile_in_zip_read_info
operator|->
name|total_out_64
operator|+
name|uOutThis
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|crc32
operator|=
name|crc32
argument_list|(
name|pfile_in_zip_read_info
operator|->
name|crc32
argument_list|,
name|bufBefore
argument_list|,
call|(
name|uInt
call|)
argument_list|(
name|uOutThis
argument_list|)
argument_list|)
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|rest_read_uncompressed
operator|-=
name|uOutThis
expr_stmt|;
name|iRead
operator|+=
call|(
name|uInt
call|)
argument_list|(
name|uTotalOutAfter
operator|-
name|uTotalOutBefore
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|Z_STREAM_END
condition|)
return|return
operator|(
name|iRead
operator|==
literal|0
operator|)
condition|?
name|UNZ_EOF
else|:
name|iRead
return|;
if|if
condition|(
name|err
operator|!=
name|Z_OK
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|err
operator|==
name|Z_OK
condition|)
return|return
name|iRead
return|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*   Give the current position in uncompressed data */
end_comment

begin_function
specifier|extern
name|z_off_t
name|ZEXPORT
name|unztell
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|file_in_zip64_read_info_s
modifier|*
name|pfile_in_zip_read_info
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
name|pfile_in_zip_read_info
operator|=
name|s
operator|->
name|pfile_in_zip_read
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
return|return
operator|(
name|z_off_t
operator|)
name|pfile_in_zip_read_info
operator|->
name|stream
operator|.
name|total_out
return|;
block|}
end_function

begin_function
specifier|extern
name|ZPOS64_T
name|ZEXPORT
name|unztell64
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|file_in_zip64_read_info_s
modifier|*
name|pfile_in_zip_read_info
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
operator|(
name|ZPOS64_T
operator|)
operator|-
literal|1
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
name|pfile_in_zip_read_info
operator|=
name|s
operator|->
name|pfile_in_zip_read
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|==
name|NULL
condition|)
return|return
operator|(
name|ZPOS64_T
operator|)
operator|-
literal|1
return|;
return|return
name|pfile_in_zip_read_info
operator|->
name|total_out_64
return|;
block|}
end_function

begin_comment
comment|/*   return 1 if the end of file was reached, 0 elsewhere */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzeof
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|file_in_zip64_read_info_s
modifier|*
name|pfile_in_zip_read_info
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
name|pfile_in_zip_read_info
operator|=
name|s
operator|->
name|pfile_in_zip_read
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|->
name|rest_read_uncompressed
operator|==
literal|0
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Read extra field from the current file (opened by unzOpenCurrentFile) This is the local-header version of the extra field (sometimes, there is more info in the local-header version than in the central-header)    if buf==NULL, it return the size of the local extra field that can be read    if buf!=NULL, len is the size of the buffer, the extra header is copied in     buf.   the return value is the number of bytes copied in buf, or (if<0)     the error code */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGetLocalExtrafield
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|voidp
name|buf
parameter_list|,
name|unsigned
name|len
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|file_in_zip64_read_info_s
modifier|*
name|pfile_in_zip_read_info
decl_stmt|;
name|uInt
name|read_now
decl_stmt|;
name|ZPOS64_T
name|size_to_read
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
name|pfile_in_zip_read_info
operator|=
name|s
operator|->
name|pfile_in_zip_read
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|size_to_read
operator|=
operator|(
name|pfile_in_zip_read_info
operator|->
name|size_local_extrafield
operator|-
name|pfile_in_zip_read_info
operator|->
name|pos_local_extrafield
operator|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|(
name|int
operator|)
name|size_to_read
return|;
if|if
condition|(
name|len
operator|>
name|size_to_read
condition|)
name|read_now
operator|=
operator|(
name|uInt
operator|)
name|size_to_read
expr_stmt|;
else|else
name|read_now
operator|=
operator|(
name|uInt
operator|)
name|len
expr_stmt|;
if|if
condition|(
name|read_now
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|pfile_in_zip_read_info
operator|->
name|z_filefunc
argument_list|,
name|pfile_in_zip_read_info
operator|->
name|filestream
argument_list|,
name|pfile_in_zip_read_info
operator|->
name|offset_local_extrafield
operator|+
name|pfile_in_zip_read_info
operator|->
name|pos_local_extrafield
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|UNZ_ERRNO
return|;
if|if
condition|(
name|ZREAD64
argument_list|(
name|pfile_in_zip_read_info
operator|->
name|z_filefunc
argument_list|,
name|pfile_in_zip_read_info
operator|->
name|filestream
argument_list|,
name|buf
argument_list|,
name|read_now
argument_list|)
operator|!=
name|read_now
condition|)
return|return
name|UNZ_ERRNO
return|;
return|return
operator|(
name|int
operator|)
name|read_now
return|;
block|}
end_function

begin_comment
comment|/*   Close the file in zip opened with unzOpenCurrentFile   Return UNZ_CRCERROR if all the file was read but the CRC is not good */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzCloseCurrentFile
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|int
name|err
init|=
name|UNZ_OK
decl_stmt|;
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|file_in_zip64_read_info_s
modifier|*
name|pfile_in_zip_read_info
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
name|pfile_in_zip_read_info
operator|=
name|s
operator|->
name|pfile_in_zip_read
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
if|if
condition|(
operator|(
name|pfile_in_zip_read_info
operator|->
name|rest_read_uncompressed
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|!
name|pfile_in_zip_read_info
operator|->
name|raw
operator|)
condition|)
block|{
if|if
condition|(
name|pfile_in_zip_read_info
operator|->
name|crc32
operator|!=
name|pfile_in_zip_read_info
operator|->
name|crc32_wait
condition|)
name|err
operator|=
name|UNZ_CRCERROR
expr_stmt|;
block|}
name|TRYFREE
argument_list|(
name|pfile_in_zip_read_info
operator|->
name|read_buffer
argument_list|)
expr_stmt|;
name|pfile_in_zip_read_info
operator|->
name|read_buffer
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|pfile_in_zip_read_info
operator|->
name|stream_initialised
operator|==
name|Z_DEFLATED
condition|)
name|inflateEnd
argument_list|(
operator|&
name|pfile_in_zip_read_info
operator|->
name|stream
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_BZIP2
elseif|else
if|if
condition|(
name|pfile_in_zip_read_info
operator|->
name|stream_initialised
operator|==
name|Z_BZIP2ED
condition|)
name|BZ2_bzDecompressEnd
argument_list|(
operator|&
name|pfile_in_zip_read_info
operator|->
name|bstream
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pfile_in_zip_read_info
operator|->
name|stream_initialised
operator|=
literal|0
expr_stmt|;
name|TRYFREE
argument_list|(
name|pfile_in_zip_read_info
argument_list|)
expr_stmt|;
name|s
operator|->
name|pfile_in_zip_read
operator|=
name|NULL
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*   Get the global comment string of the ZipFile, in the szComment buffer.   uSizeBuf is the size of the szComment buffer.   return the number of byte copied or an error code<0 */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzGetGlobalComment
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|char
modifier|*
name|szComment
parameter_list|,
name|uLong
name|uSizeBuf
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|uLong
name|uReadThis
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
operator|(
name|int
operator|)
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
name|uReadThis
operator|=
name|uSizeBuf
expr_stmt|;
if|if
condition|(
name|uReadThis
operator|>
name|s
operator|->
name|gi
operator|.
name|size_comment
condition|)
name|uReadThis
operator|=
name|s
operator|->
name|gi
operator|.
name|size_comment
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|s
operator|->
name|central_pos
operator|+
literal|22
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|UNZ_ERRNO
return|;
if|if
condition|(
name|uReadThis
operator|>
literal|0
condition|)
block|{
operator|*
name|szComment
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|ZREAD64
argument_list|(
name|s
operator|->
name|z_filefunc
argument_list|,
name|s
operator|->
name|filestream
argument_list|,
name|szComment
argument_list|,
name|uReadThis
argument_list|)
operator|!=
name|uReadThis
condition|)
return|return
name|UNZ_ERRNO
return|;
block|}
if|if
condition|(
operator|(
name|szComment
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|uSizeBuf
operator|>
name|s
operator|->
name|gi
operator|.
name|size_comment
operator|)
condition|)
operator|*
operator|(
name|szComment
operator|+
name|s
operator|->
name|gi
operator|.
name|size_comment
operator|)
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|int
operator|)
name|uReadThis
return|;
block|}
end_function

begin_comment
comment|/* Additions by RX '2004 */
end_comment

begin_function
specifier|extern
name|ZPOS64_T
name|ZEXPORT
name|unzGetOffset64
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|//UNZ_PARAMERROR;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
operator|!
name|s
operator|->
name|current_file_ok
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|s
operator|->
name|gi
operator|.
name|number_entry
operator|!=
literal|0
operator|&&
name|s
operator|->
name|gi
operator|.
name|number_entry
operator|!=
literal|0xffff
condition|)
if|if
condition|(
name|s
operator|->
name|num_file
operator|==
name|s
operator|->
name|gi
operator|.
name|number_entry
condition|)
return|return
literal|0
return|;
return|return
name|s
operator|->
name|pos_in_central_dir
return|;
block|}
end_function

begin_function
specifier|extern
name|uLong
name|ZEXPORT
name|unzGetOffset
parameter_list|(
name|unzFile
name|file
parameter_list|)
block|{
name|ZPOS64_T
name|offset64
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|//UNZ_PARAMERROR;
name|offset64
operator|=
name|unzGetOffset64
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
operator|(
name|uLong
operator|)
name|offset64
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzSetOffset64
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|ZPOS64_T
name|pos
parameter_list|)
block|{
name|unz64_s
modifier|*
name|s
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|UNZ_PARAMERROR
return|;
name|s
operator|=
operator|(
name|unz64_s
operator|*
operator|)
name|file
expr_stmt|;
name|s
operator|->
name|pos_in_central_dir
operator|=
name|pos
expr_stmt|;
name|s
operator|->
name|num_file
operator|=
name|s
operator|->
name|gi
operator|.
name|number_entry
expr_stmt|;
comment|/* hack */
name|err
operator|=
name|unz64local_GetCurrentFileInfoInternal
argument_list|(
name|file
argument_list|,
operator|&
name|s
operator|->
name|cur_file_info
argument_list|,
operator|&
name|s
operator|->
name|cur_file_info_internal
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|s
operator|->
name|current_file_ok
operator|=
operator|(
name|err
operator|==
name|UNZ_OK
operator|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzSetOffset
parameter_list|(
name|unzFile
name|file
parameter_list|,
name|uLong
name|pos
parameter_list|)
block|{
return|return
name|unzSetOffset64
argument_list|(
name|file
argument_list|,
name|pos
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ioapi.h -- IO base function header for compress/uncompress .zip    part of the MiniZip project - ( http://www.winimage.com/zLibDll/minizip.html )           Copyright (C) 1998-2010 Gilles Vollant (minizip) ( http://www.winimage.com/zLibDll/minizip.html )           Modifications for Zip64 support          Copyright (C) 2009-2010 Mathias Svensson ( http://result42.com )           For more info read MiniZip_info.txt  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|&&
operator|(
operator|!
operator|(
name|defined
argument_list|(
name|_CRT_SECURE_NO_WARNINGS
argument_list|)
operator|)
operator|)
end_if

begin_define
define|#
directive|define
name|_CRT_SECURE_NO_WARNINGS
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__APPLE__
argument_list|)
operator|||
name|defined
argument_list|(
name|IOAPI_NO_64
argument_list|)
end_if

begin_comment
comment|// In darwin and perhaps other BSD variants off_t is a 64 bit value, hence no need for specific 64 bit functions
end_comment

begin_define
define|#
directive|define
name|FOPEN_FUNC
parameter_list|(
name|filename
parameter_list|,
name|mode
parameter_list|)
value|fopen(filename, mode)
end_define

begin_define
define|#
directive|define
name|FTELLO_FUNC
parameter_list|(
name|stream
parameter_list|)
value|ftello(stream)
end_define

begin_define
define|#
directive|define
name|FSEEKO_FUNC
parameter_list|(
name|stream
parameter_list|,
name|offset
parameter_list|,
name|origin
parameter_list|)
value|fseeko(stream, offset, origin)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|FOPEN_FUNC
parameter_list|(
name|filename
parameter_list|,
name|mode
parameter_list|)
value|fopen64(filename, mode)
end_define

begin_define
define|#
directive|define
name|FTELLO_FUNC
parameter_list|(
name|stream
parameter_list|)
value|ftello64(stream)
end_define

begin_define
define|#
directive|define
name|FSEEKO_FUNC
parameter_list|(
name|stream
parameter_list|,
name|offset
parameter_list|,
name|origin
parameter_list|)
value|fseeko64(stream, offset, origin)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ioapi.h"
end_include

begin_function
name|voidpf
name|call_zopen64
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pfilefunc
parameter_list|,
specifier|const
name|void
modifier|*
name|filename
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|zopen64_file
operator|!=
name|NULL
condition|)
return|return
operator|(
operator|*
operator|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|zopen64_file
operator|)
operator|)
operator|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|opaque
operator|,
name|filename
operator|,
name|mode
operator|)
return|;
else|else
block|{
return|return
operator|(
operator|*
operator|(
name|pfilefunc
operator|->
name|zopen32_file
operator|)
operator|)
operator|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|opaque
operator|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|filename
operator|,
name|mode
operator|)
return|;
block|}
block|}
end_function

begin_function
name|long
name|call_zseek64
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pfilefunc
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|ZPOS64_T
name|offset
parameter_list|,
name|int
name|origin
parameter_list|)
block|{
if|if
condition|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|zseek64_file
operator|!=
name|NULL
condition|)
return|return
operator|(
operator|*
operator|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|zseek64_file
operator|)
operator|)
operator|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|opaque
operator|,
name|filestream
operator|,
name|offset
operator|,
name|origin
operator|)
return|;
else|else
block|{
name|uLong
name|offsetTruncated
init|=
operator|(
name|uLong
operator|)
name|offset
decl_stmt|;
if|if
condition|(
name|offsetTruncated
operator|!=
name|offset
condition|)
return|return
operator|-
literal|1
return|;
else|else
return|return
operator|(
operator|*
operator|(
name|pfilefunc
operator|->
name|zseek32_file
operator|)
operator|)
operator|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|opaque
operator|,
name|filestream
operator|,
name|offsetTruncated
operator|,
name|origin
operator|)
return|;
block|}
block|}
end_function

begin_function
name|ZPOS64_T
name|call_ztell64
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pfilefunc
parameter_list|,
name|voidpf
name|filestream
parameter_list|)
block|{
if|if
condition|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|zseek64_file
operator|!=
name|NULL
condition|)
return|return
operator|(
operator|*
operator|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|ztell64_file
operator|)
operator|)
operator|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|opaque
operator|,
name|filestream
operator|)
return|;
else|else
block|{
name|uLong
name|tell_uLong
init|=
operator|(
operator|*
operator|(
name|pfilefunc
operator|->
name|ztell32_file
operator|)
operator|)
operator|(
name|pfilefunc
operator|->
name|zfile_func64
operator|.
name|opaque
expr|,
name|filestream
operator|)
decl_stmt|;
if|if
condition|(
operator|(
name|tell_uLong
operator|)
operator|==
name|MAXU32
condition|)
return|return
operator|(
name|ZPOS64_T
operator|)
operator|-
literal|1
return|;
else|else
return|return
name|tell_uLong
return|;
block|}
block|}
end_function

begin_function
name|void
name|fill_zlib_filefunc64_32_def_from_filefunc32
parameter_list|(
name|zlib_filefunc64_32_def
modifier|*
name|p_filefunc64_32
parameter_list|,
specifier|const
name|zlib_filefunc_def
modifier|*
name|p_filefunc32
parameter_list|)
block|{
name|p_filefunc64_32
operator|->
name|zfile_func64
operator|.
name|zopen64_file
operator|=
name|NULL
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zopen32_file
operator|=
name|p_filefunc32
operator|->
name|zopen_file
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zfile_func64
operator|.
name|zerror_file
operator|=
name|p_filefunc32
operator|->
name|zerror_file
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zfile_func64
operator|.
name|zread_file
operator|=
name|p_filefunc32
operator|->
name|zread_file
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zfile_func64
operator|.
name|zwrite_file
operator|=
name|p_filefunc32
operator|->
name|zwrite_file
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zfile_func64
operator|.
name|ztell64_file
operator|=
name|NULL
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zfile_func64
operator|.
name|zseek64_file
operator|=
name|NULL
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zfile_func64
operator|.
name|zclose_file
operator|=
name|p_filefunc32
operator|->
name|zclose_file
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zfile_func64
operator|.
name|zerror_file
operator|=
name|p_filefunc32
operator|->
name|zerror_file
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zfile_func64
operator|.
name|opaque
operator|=
name|p_filefunc32
operator|->
name|opaque
expr_stmt|;
name|p_filefunc64_32
operator|->
name|zseek32_file
operator|=
name|p_filefunc32
operator|->
name|zseek_file
expr_stmt|;
name|p_filefunc64_32
operator|->
name|ztell32_file
operator|=
name|p_filefunc32
operator|->
name|ztell_file
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|voidpf
name|ZCALLBACK
name|fopen_file_func
name|OF
argument_list|(
operator|(
name|voidpf
name|opaque
operator|,
specifier|const
name|char
operator|*
name|filename
operator|,
name|int
name|mode
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uLong
name|ZCALLBACK
name|fread_file_func
name|OF
argument_list|(
operator|(
name|voidpf
name|opaque
operator|,
name|voidpf
name|stream
operator|,
name|void
operator|*
name|buf
operator|,
name|uLong
name|size
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uLong
name|ZCALLBACK
name|fwrite_file_func
name|OF
argument_list|(
operator|(
name|voidpf
name|opaque
operator|,
name|voidpf
name|stream
operator|,
specifier|const
name|void
operator|*
name|buf
operator|,
name|uLong
name|size
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ZPOS64_T
name|ZCALLBACK
name|ftell64_file_func
name|OF
argument_list|(
operator|(
name|voidpf
name|opaque
operator|,
name|voidpf
name|stream
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|ZCALLBACK
name|fseek64_file_func
name|OF
argument_list|(
operator|(
name|voidpf
name|opaque
operator|,
name|voidpf
name|stream
operator|,
name|ZPOS64_T
name|offset
operator|,
name|int
name|origin
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ZCALLBACK
name|fclose_file_func
name|OF
argument_list|(
operator|(
name|voidpf
name|opaque
operator|,
name|voidpf
name|stream
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ZCALLBACK
name|ferror_file_func
name|OF
argument_list|(
operator|(
name|voidpf
name|opaque
operator|,
name|voidpf
name|stream
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|voidpf
name|ZCALLBACK
name|fopen_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|FILE
modifier|*
name|file
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|mode_fopen
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|mode
operator|&
name|ZLIB_FILEFUNC_MODE_READWRITEFILTER
operator|)
operator|==
name|ZLIB_FILEFUNC_MODE_READ
condition|)
name|mode_fopen
operator|=
literal|"rb"
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|ZLIB_FILEFUNC_MODE_EXISTING
condition|)
name|mode_fopen
operator|=
literal|"r+b"
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|ZLIB_FILEFUNC_MODE_CREATE
condition|)
name|mode_fopen
operator|=
literal|"wb"
expr_stmt|;
if|if
condition|(
operator|(
name|filename
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|mode_fopen
operator|!=
name|NULL
operator|)
condition|)
name|file
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
name|mode_fopen
argument_list|)
expr_stmt|;
return|return
name|file
return|;
block|}
end_function

begin_function
specifier|static
name|voidpf
name|ZCALLBACK
name|fopen64_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
specifier|const
name|void
modifier|*
name|filename
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|FILE
modifier|*
name|file
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|mode_fopen
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|mode
operator|&
name|ZLIB_FILEFUNC_MODE_READWRITEFILTER
operator|)
operator|==
name|ZLIB_FILEFUNC_MODE_READ
condition|)
name|mode_fopen
operator|=
literal|"rb"
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|ZLIB_FILEFUNC_MODE_EXISTING
condition|)
name|mode_fopen
operator|=
literal|"r+b"
expr_stmt|;
elseif|else
if|if
condition|(
name|mode
operator|&
name|ZLIB_FILEFUNC_MODE_CREATE
condition|)
name|mode_fopen
operator|=
literal|"wb"
expr_stmt|;
if|if
condition|(
operator|(
name|filename
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|mode_fopen
operator|!=
name|NULL
operator|)
condition|)
name|file
operator|=
name|FOPEN_FUNC
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|filename
argument_list|,
name|mode_fopen
argument_list|)
expr_stmt|;
return|return
name|file
return|;
block|}
end_function

begin_function
specifier|static
name|uLong
name|ZCALLBACK
name|fread_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
name|voidpf
name|stream
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uLong
name|size
parameter_list|)
block|{
name|uLong
name|ret
decl_stmt|;
name|ret
operator|=
operator|(
name|uLong
operator|)
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
operator|(
name|size_t
operator|)
name|size
argument_list|,
operator|(
name|FILE
operator|*
operator|)
name|stream
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|uLong
name|ZCALLBACK
name|fwrite_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
name|voidpf
name|stream
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|uLong
name|size
parameter_list|)
block|{
name|uLong
name|ret
decl_stmt|;
name|ret
operator|=
operator|(
name|uLong
operator|)
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
operator|(
name|size_t
operator|)
name|size
argument_list|,
operator|(
name|FILE
operator|*
operator|)
name|stream
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|long
name|ZCALLBACK
name|ftell_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
name|voidpf
name|stream
parameter_list|)
block|{
name|long
name|ret
decl_stmt|;
name|ret
operator|=
name|ftell
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|stream
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ZPOS64_T
name|ZCALLBACK
name|ftell64_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
name|voidpf
name|stream
parameter_list|)
block|{
name|ZPOS64_T
name|ret
decl_stmt|;
name|ret
operator|=
name|FTELLO_FUNC
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|stream
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|long
name|ZCALLBACK
name|fseek_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
name|voidpf
name|stream
parameter_list|,
name|uLong
name|offset
parameter_list|,
name|int
name|origin
parameter_list|)
block|{
name|int
name|fseek_origin
init|=
literal|0
decl_stmt|;
name|long
name|ret
decl_stmt|;
switch|switch
condition|(
name|origin
condition|)
block|{
case|case
name|ZLIB_FILEFUNC_SEEK_CUR
case|:
name|fseek_origin
operator|=
name|SEEK_CUR
expr_stmt|;
break|break;
case|case
name|ZLIB_FILEFUNC_SEEK_END
case|:
name|fseek_origin
operator|=
name|SEEK_END
expr_stmt|;
break|break;
case|case
name|ZLIB_FILEFUNC_SEEK_SET
case|:
name|fseek_origin
operator|=
name|SEEK_SET
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fseek
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|stream
argument_list|,
name|offset
argument_list|,
name|fseek_origin
argument_list|)
operator|!=
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|long
name|ZCALLBACK
name|fseek64_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
name|voidpf
name|stream
parameter_list|,
name|ZPOS64_T
name|offset
parameter_list|,
name|int
name|origin
parameter_list|)
block|{
name|int
name|fseek_origin
init|=
literal|0
decl_stmt|;
name|long
name|ret
decl_stmt|;
switch|switch
condition|(
name|origin
condition|)
block|{
case|case
name|ZLIB_FILEFUNC_SEEK_CUR
case|:
name|fseek_origin
operator|=
name|SEEK_CUR
expr_stmt|;
break|break;
case|case
name|ZLIB_FILEFUNC_SEEK_END
case|:
name|fseek_origin
operator|=
name|SEEK_END
expr_stmt|;
break|break;
case|case
name|ZLIB_FILEFUNC_SEEK_SET
case|:
name|fseek_origin
operator|=
name|SEEK_SET
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|FSEEKO_FUNC
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|stream
argument_list|,
name|offset
argument_list|,
name|fseek_origin
argument_list|)
operator|!=
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ZCALLBACK
name|fclose_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
name|voidpf
name|stream
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|fclose
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|stream
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ZCALLBACK
name|ferror_file_func
parameter_list|(
name|voidpf
name|opaque
parameter_list|,
name|voidpf
name|stream
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ferror
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|stream
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|fill_fopen_filefunc
parameter_list|(
name|pzlib_filefunc_def
parameter_list|)
name|zlib_filefunc_def
modifier|*
name|pzlib_filefunc_def
decl_stmt|;
block|{
name|pzlib_filefunc_def
operator|->
name|zopen_file
operator|=
name|fopen_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zread_file
operator|=
name|fread_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zwrite_file
operator|=
name|fwrite_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|ztell_file
operator|=
name|ftell_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zseek_file
operator|=
name|fseek_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zclose_file
operator|=
name|fclose_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zerror_file
operator|=
name|ferror_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|opaque
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fill_fopen64_filefunc
parameter_list|(
name|zlib_filefunc64_def
modifier|*
name|pzlib_filefunc_def
parameter_list|)
block|{
name|pzlib_filefunc_def
operator|->
name|zopen64_file
operator|=
name|fopen64_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zread_file
operator|=
name|fread_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zwrite_file
operator|=
name|fwrite_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|ztell64_file
operator|=
name|ftell64_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zseek64_file
operator|=
name|fseek64_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zclose_file
operator|=
name|fclose_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|zerror_file
operator|=
name|ferror_file_func
expr_stmt|;
name|pzlib_filefunc_def
operator|->
name|opaque
operator|=
name|NULL
expr_stmt|;
block|}
end_function

end_unit


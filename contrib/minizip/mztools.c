begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   Additional tools for Minizip   Code: Xavier Roche '2004   License: Same as ZLIB (www.gzip.org) */
end_comment

begin_comment
comment|/* Code */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"zlib.h"
end_include

begin_include
include|#
directive|include
file|"unzip.h"
end_include

begin_define
define|#
directive|define
name|READ_8
parameter_list|(
name|adr
parameter_list|)
value|((unsigned char)*(adr))
end_define

begin_define
define|#
directive|define
name|READ_16
parameter_list|(
name|adr
parameter_list|)
value|( READ_8(adr) | (READ_8(adr+1)<< 8) )
end_define

begin_define
define|#
directive|define
name|READ_32
parameter_list|(
name|adr
parameter_list|)
value|( READ_16(adr) | (READ_16((adr)+2)<< 16) )
end_define

begin_define
define|#
directive|define
name|WRITE_8
parameter_list|(
name|buff
parameter_list|,
name|n
parameter_list|)
value|do { \   *((unsigned char*)(buff)) = (unsigned char) ((n)& 0xff); \ } while(0)
end_define

begin_define
define|#
directive|define
name|WRITE_16
parameter_list|(
name|buff
parameter_list|,
name|n
parameter_list|)
value|do { \   WRITE_8((unsigned char*)(buff), n); \   WRITE_8(((unsigned char*)(buff)) + 1, (n)>> 8); \ } while(0)
end_define

begin_define
define|#
directive|define
name|WRITE_32
parameter_list|(
name|buff
parameter_list|,
name|n
parameter_list|)
value|do { \   WRITE_16((unsigned char*)(buff), (n)& 0xffff); \   WRITE_16((unsigned char*)(buff) + 2, (n)>> 16); \ } while(0)
end_define

begin_function
specifier|extern
name|int
name|ZEXPORT
name|unzRepair
parameter_list|(
name|file
parameter_list|,
name|fileOut
parameter_list|,
name|fileOutTmp
parameter_list|,
name|nRecovered
parameter_list|,
name|bytesRecovered
parameter_list|)
specifier|const
name|char
modifier|*
name|file
decl_stmt|;
specifier|const
name|char
modifier|*
name|fileOut
decl_stmt|;
specifier|const
name|char
modifier|*
name|fileOutTmp
decl_stmt|;
name|uLong
modifier|*
name|nRecovered
decl_stmt|;
name|uLong
modifier|*
name|bytesRecovered
decl_stmt|;
block|{
name|int
name|err
init|=
name|Z_OK
decl_stmt|;
name|FILE
modifier|*
name|fpZip
init|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"rb"
argument_list|)
decl_stmt|;
name|FILE
modifier|*
name|fpOut
init|=
name|fopen
argument_list|(
name|fileOut
argument_list|,
literal|"wb"
argument_list|)
decl_stmt|;
name|FILE
modifier|*
name|fpOutCD
init|=
name|fopen
argument_list|(
name|fileOutTmp
argument_list|,
literal|"wb"
argument_list|)
decl_stmt|;
if|if
condition|(
name|fpZip
operator|!=
name|NULL
operator|&&
name|fpOut
operator|!=
name|NULL
condition|)
block|{
name|int
name|entries
init|=
literal|0
decl_stmt|;
name|uLong
name|totalBytes
init|=
literal|0
decl_stmt|;
name|char
name|header
index|[
literal|30
index|]
decl_stmt|;
name|char
name|filename
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|extra
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|offset
init|=
literal|0
decl_stmt|;
name|int
name|offsetCD
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|fread
argument_list|(
name|header
argument_list|,
literal|1
argument_list|,
literal|30
argument_list|,
name|fpZip
argument_list|)
operator|==
literal|30
condition|)
block|{
name|int
name|currentOffset
init|=
name|offset
decl_stmt|;
comment|/* File entry */
if|if
condition|(
name|READ_32
argument_list|(
name|header
argument_list|)
operator|==
literal|0x04034b50
condition|)
block|{
name|unsigned
name|int
name|version
init|=
name|READ_16
argument_list|(
name|header
operator|+
literal|4
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|gpflag
init|=
name|READ_16
argument_list|(
name|header
operator|+
literal|6
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|method
init|=
name|READ_16
argument_list|(
name|header
operator|+
literal|8
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|filetime
init|=
name|READ_16
argument_list|(
name|header
operator|+
literal|10
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|filedate
init|=
name|READ_16
argument_list|(
name|header
operator|+
literal|12
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|crc
init|=
name|READ_32
argument_list|(
name|header
operator|+
literal|14
argument_list|)
decl_stmt|;
comment|/* crc */
name|unsigned
name|int
name|cpsize
init|=
name|READ_32
argument_list|(
name|header
operator|+
literal|18
argument_list|)
decl_stmt|;
comment|/* compressed size */
name|unsigned
name|int
name|uncpsize
init|=
name|READ_32
argument_list|(
name|header
operator|+
literal|22
argument_list|)
decl_stmt|;
comment|/* uncompressed sz */
name|unsigned
name|int
name|fnsize
init|=
name|READ_16
argument_list|(
name|header
operator|+
literal|26
argument_list|)
decl_stmt|;
comment|/* file name length */
name|unsigned
name|int
name|extsize
init|=
name|READ_16
argument_list|(
name|header
operator|+
literal|28
argument_list|)
decl_stmt|;
comment|/* extra field length */
name|filename
index|[
literal|0
index|]
operator|=
name|extra
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* Header */
if|if
condition|(
name|fwrite
argument_list|(
name|header
argument_list|,
literal|1
argument_list|,
literal|30
argument_list|,
name|fpOut
argument_list|)
operator|==
literal|30
condition|)
block|{
name|offset
operator|+=
literal|30
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
comment|/* Filename */
if|if
condition|(
name|fnsize
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|fnsize
operator|<
sizeof|sizeof
argument_list|(
name|filename
argument_list|)
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
name|filename
argument_list|,
literal|1
argument_list|,
name|fnsize
argument_list|,
name|fpZip
argument_list|)
operator|==
name|fnsize
condition|)
block|{
if|if
condition|(
name|fwrite
argument_list|(
name|filename
argument_list|,
literal|1
argument_list|,
name|fnsize
argument_list|,
name|fpOut
argument_list|)
operator|==
name|fnsize
condition|)
block|{
name|offset
operator|+=
name|fnsize
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_STREAM_ERROR
expr_stmt|;
break|break;
block|}
comment|/* Extra field */
if|if
condition|(
name|extsize
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|extsize
operator|<
sizeof|sizeof
argument_list|(
name|extra
argument_list|)
condition|)
block|{
if|if
condition|(
name|fread
argument_list|(
name|extra
argument_list|,
literal|1
argument_list|,
name|extsize
argument_list|,
name|fpZip
argument_list|)
operator|==
name|extsize
condition|)
block|{
if|if
condition|(
name|fwrite
argument_list|(
name|extra
argument_list|,
literal|1
argument_list|,
name|extsize
argument_list|,
name|fpOut
argument_list|)
operator|==
name|extsize
condition|)
block|{
name|offset
operator|+=
name|extsize
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
comment|/* Data */
block|{
name|int
name|dataSize
init|=
name|cpsize
decl_stmt|;
if|if
condition|(
name|dataSize
operator|==
literal|0
condition|)
block|{
name|dataSize
operator|=
name|uncpsize
expr_stmt|;
block|}
if|if
condition|(
name|dataSize
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
name|data
init|=
name|malloc
argument_list|(
name|dataSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|fread
argument_list|(
name|data
argument_list|,
literal|1
argument_list|,
name|dataSize
argument_list|,
name|fpZip
argument_list|)
operator|==
name|dataSize
condition|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|fwrite
argument_list|(
name|data
argument_list|,
literal|1
argument_list|,
name|dataSize
argument_list|,
name|fpOut
argument_list|)
operator|==
name|dataSize
condition|)
block|{
name|offset
operator|+=
name|dataSize
expr_stmt|;
name|totalBytes
operator|+=
name|dataSize
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
block|}
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|Z_OK
condition|)
block|{
break|break;
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_MEM_ERROR
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* Central directory entry */
block|{
name|char
name|header
index|[
literal|46
index|]
decl_stmt|;
name|char
modifier|*
name|comment
init|=
literal|""
decl_stmt|;
name|int
name|comsize
init|=
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|comment
argument_list|)
decl_stmt|;
name|WRITE_32
argument_list|(
name|header
argument_list|,
literal|0x02014b50
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|4
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|6
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|8
argument_list|,
name|gpflag
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|10
argument_list|,
name|method
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|12
argument_list|,
name|filetime
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|14
argument_list|,
name|filedate
argument_list|)
expr_stmt|;
name|WRITE_32
argument_list|(
name|header
operator|+
literal|16
argument_list|,
name|crc
argument_list|)
expr_stmt|;
name|WRITE_32
argument_list|(
name|header
operator|+
literal|20
argument_list|,
name|cpsize
argument_list|)
expr_stmt|;
name|WRITE_32
argument_list|(
name|header
operator|+
literal|24
argument_list|,
name|uncpsize
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|28
argument_list|,
name|fnsize
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|30
argument_list|,
name|extsize
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|32
argument_list|,
name|comsize
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|34
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disk # */
name|WRITE_16
argument_list|(
name|header
operator|+
literal|36
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* int attrb */
name|WRITE_32
argument_list|(
name|header
operator|+
literal|38
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* ext attrb */
name|WRITE_32
argument_list|(
name|header
operator|+
literal|42
argument_list|,
name|currentOffset
argument_list|)
expr_stmt|;
comment|/* Header */
if|if
condition|(
name|fwrite
argument_list|(
name|header
argument_list|,
literal|1
argument_list|,
literal|46
argument_list|,
name|fpOutCD
argument_list|)
operator|==
literal|46
condition|)
block|{
name|offsetCD
operator|+=
literal|46
expr_stmt|;
comment|/* Filename */
if|if
condition|(
name|fnsize
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|fwrite
argument_list|(
name|filename
argument_list|,
literal|1
argument_list|,
name|fnsize
argument_list|,
name|fpOutCD
argument_list|)
operator|==
name|fnsize
condition|)
block|{
name|offsetCD
operator|+=
name|fnsize
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_STREAM_ERROR
expr_stmt|;
break|break;
block|}
comment|/* Extra field */
if|if
condition|(
name|extsize
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|fwrite
argument_list|(
name|extra
argument_list|,
literal|1
argument_list|,
name|extsize
argument_list|,
name|fpOutCD
argument_list|)
operator|==
name|extsize
condition|)
block|{
name|offsetCD
operator|+=
name|extsize
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
comment|/* Comment field */
if|if
condition|(
name|comsize
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|fwrite
argument_list|(
name|comment
argument_list|,
literal|1
argument_list|,
name|comsize
argument_list|,
name|fpOutCD
argument_list|)
operator|==
name|comsize
condition|)
block|{
name|offsetCD
operator|+=
name|comsize
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
comment|/* Success */
name|entries
operator|++
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
block|}
comment|/* Final central directory  */
block|{
name|int
name|entriesZip
init|=
name|entries
decl_stmt|;
name|char
name|header
index|[
literal|22
index|]
decl_stmt|;
name|char
modifier|*
name|comment
init|=
literal|""
decl_stmt|;
comment|// "ZIP File recovered by zlib/minizip/mztools";
name|int
name|comsize
init|=
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|comment
argument_list|)
decl_stmt|;
if|if
condition|(
name|entriesZip
operator|>
literal|0xffff
condition|)
block|{
name|entriesZip
operator|=
literal|0xffff
expr_stmt|;
block|}
name|WRITE_32
argument_list|(
name|header
argument_list|,
literal|0x06054b50
argument_list|)
expr_stmt|;
name|WRITE_16
argument_list|(
name|header
operator|+
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disk # */
name|WRITE_16
argument_list|(
name|header
operator|+
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disk # */
name|WRITE_16
argument_list|(
name|header
operator|+
literal|8
argument_list|,
name|entriesZip
argument_list|)
expr_stmt|;
comment|/* hack */
name|WRITE_16
argument_list|(
name|header
operator|+
literal|10
argument_list|,
name|entriesZip
argument_list|)
expr_stmt|;
comment|/* hack */
name|WRITE_32
argument_list|(
name|header
operator|+
literal|12
argument_list|,
name|offsetCD
argument_list|)
expr_stmt|;
comment|/* size of CD */
name|WRITE_32
argument_list|(
name|header
operator|+
literal|16
argument_list|,
name|offset
argument_list|)
expr_stmt|;
comment|/* offset to CD */
name|WRITE_16
argument_list|(
name|header
operator|+
literal|20
argument_list|,
name|comsize
argument_list|)
expr_stmt|;
comment|/* comment */
comment|/* Header */
if|if
condition|(
name|fwrite
argument_list|(
name|header
argument_list|,
literal|1
argument_list|,
literal|22
argument_list|,
name|fpOutCD
argument_list|)
operator|==
literal|22
condition|)
block|{
comment|/* Comment field */
if|if
condition|(
name|comsize
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|fwrite
argument_list|(
name|comment
argument_list|,
literal|1
argument_list|,
name|comsize
argument_list|,
name|fpOutCD
argument_list|)
operator|!=
name|comsize
condition|)
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
block|}
block|}
comment|/* Final merge (file + central directory) */
name|fclose
argument_list|(
name|fpOutCD
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|Z_OK
condition|)
block|{
name|fpOutCD
operator|=
name|fopen
argument_list|(
name|fileOutTmp
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fpOutCD
operator|!=
name|NULL
condition|)
block|{
name|int
name|nRead
decl_stmt|;
name|char
name|buffer
index|[
literal|8192
index|]
decl_stmt|;
while|while
condition|(
operator|(
name|nRead
operator|=
operator|(
name|int
operator|)
name|fread
argument_list|(
name|buffer
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|fpOutCD
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|int
operator|)
name|fwrite
argument_list|(
name|buffer
argument_list|,
literal|1
argument_list|,
name|nRead
argument_list|,
name|fpOut
argument_list|)
operator|!=
name|nRead
condition|)
block|{
name|err
operator|=
name|Z_ERRNO
expr_stmt|;
break|break;
block|}
block|}
name|fclose
argument_list|(
name|fpOutCD
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Close */
name|fclose
argument_list|(
name|fpZip
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fpOut
argument_list|)
expr_stmt|;
comment|/* Wipe temporary file */
operator|(
name|void
operator|)
name|remove
argument_list|(
name|fileOutTmp
argument_list|)
expr_stmt|;
comment|/* Number of recovered entries */
if|if
condition|(
name|err
operator|==
name|Z_OK
condition|)
block|{
if|if
condition|(
name|nRecovered
operator|!=
name|NULL
condition|)
block|{
operator|*
name|nRecovered
operator|=
name|entries
expr_stmt|;
block|}
if|if
condition|(
name|bytesRecovered
operator|!=
name|NULL
condition|)
block|{
operator|*
name|bytesRecovered
operator|=
name|totalBytes
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|err
operator|=
name|Z_STREAM_ERROR
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

end_unit


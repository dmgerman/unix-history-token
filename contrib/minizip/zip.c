begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* zip.c -- IO on .zip files using zlib    Version 1.1, February 14h, 2010    part of the MiniZip project - ( http://www.winimage.com/zLibDll/minizip.html )           Copyright (C) 1998-2010 Gilles Vollant (minizip) ( http://www.winimage.com/zLibDll/minizip.html )           Modifications for Zip64 support          Copyright (C) 2009-2010 Mathias Svensson ( http://result42.com )           For more info read MiniZip_info.txt           Changes    Oct-2009 - Mathias Svensson - Remove old C style function prototypes    Oct-2009 - Mathias Svensson - Added Zip64 Support when creating new file archives    Oct-2009 - Mathias Svensson - Did some code cleanup and refactoring to get better overview of some functions.    Oct-2009 - Mathias Svensson - Added zipRemoveExtraInfoBlock to strip extra field data from its ZIP64 data                                  It is used when recreting zip archive with RAW when deleting items from a zip.                                  ZIP64 data is automaticly added to items that needs it, and existing ZIP64 data need to be removed.    Oct-2009 - Mathias Svensson - Added support for BZIP2 as compression mode (bzip2 lib is required)    Jan-2010 - back to unzip and minizip 1.0 name scheme, with compatibility layer  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|"zlib.h"
end_include

begin_include
include|#
directive|include
file|"zip.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|STDC
end_ifdef

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|NO_ERRNO_H
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|local
end_ifndef

begin_define
define|#
directive|define
name|local
value|static
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* compile with -Dlocal if your debugger can't find static symbols */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|VERSIONMADEBY
end_ifndef

begin_define
define|#
directive|define
name|VERSIONMADEBY
value|(0x0)
end_define

begin_comment
comment|/* platform depedent */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|Z_BUFSIZE
end_ifndef

begin_define
define|#
directive|define
name|Z_BUFSIZE
value|(64*1024)
end_define

begin_comment
comment|//(16384)
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|Z_MAXFILENAMEINZIP
end_ifndef

begin_define
define|#
directive|define
name|Z_MAXFILENAMEINZIP
value|(256)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|ALLOC
end_ifndef

begin_define
define|#
directive|define
name|ALLOC
parameter_list|(
name|size
parameter_list|)
value|(malloc(size))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|TRYFREE
end_ifndef

begin_define
define|#
directive|define
name|TRYFREE
parameter_list|(
name|p
parameter_list|)
value|{if (p) free(p);}
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* #define SIZECENTRALDIRITEM (0x2e) #define SIZEZIPLOCALHEADER (0x1e) */
end_comment

begin_comment
comment|/* I've found an old Unix (a SunOS 4.1.3_U1) without all SEEK_* defined.... */
end_comment

begin_comment
comment|// NOT sure that this work on ALL platform
end_comment

begin_define
define|#
directive|define
name|MAKEULONG64
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((ZPOS64_T)(((unsigned long)(a)) | ((ZPOS64_T)((unsigned long)(b)))<< 32))
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|SEEK_CUR
end_ifndef

begin_define
define|#
directive|define
name|SEEK_CUR
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|SEEK_END
end_ifndef

begin_define
define|#
directive|define
name|SEEK_END
value|2
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|SEEK_SET
end_ifndef

begin_define
define|#
directive|define
name|SEEK_SET
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|DEF_MEM_LEVEL
end_ifndef

begin_if
if|#
directive|if
name|MAX_MEM_LEVEL
operator|>=
literal|8
end_if

begin_define
define|#
directive|define
name|DEF_MEM_LEVEL
value|8
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DEF_MEM_LEVEL
value|MAX_MEM_LEVEL
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|const
name|char
name|zip_copyright
index|[]
init|=
literal|" zip 1.01 Copyright 1998-2004 Gilles Vollant - http://www.winimage.com/zLibDll"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SIZEDATA_INDATABLOCK
value|(4096-(4*4))
end_define

begin_define
define|#
directive|define
name|LOCALHEADERMAGIC
value|(0x04034b50)
end_define

begin_define
define|#
directive|define
name|CENTRALHEADERMAGIC
value|(0x02014b50)
end_define

begin_define
define|#
directive|define
name|ENDHEADERMAGIC
value|(0x06054b50)
end_define

begin_define
define|#
directive|define
name|ZIP64ENDHEADERMAGIC
value|(0x6064b50)
end_define

begin_define
define|#
directive|define
name|ZIP64ENDLOCHEADERMAGIC
value|(0x7064b50)
end_define

begin_define
define|#
directive|define
name|FLAG_LOCALHEADER_OFFSET
value|(0x06)
end_define

begin_define
define|#
directive|define
name|CRC_LOCALHEADER_OFFSET
value|(0x0e)
end_define

begin_define
define|#
directive|define
name|SIZECENTRALHEADER
value|(0x2e)
end_define

begin_comment
comment|/* 46 */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|linkedlist_datablock_internal_s
block|{
name|struct
name|linkedlist_datablock_internal_s
modifier|*
name|next_datablock
decl_stmt|;
name|uLong
name|avail_in_this_block
decl_stmt|;
name|uLong
name|filled_in_this_block
decl_stmt|;
name|uLong
name|unused
decl_stmt|;
comment|/* for future use and alignement */
name|unsigned
name|char
name|data
index|[
name|SIZEDATA_INDATABLOCK
index|]
decl_stmt|;
block|}
name|linkedlist_datablock_internal
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|linkedlist_data_s
block|{
name|linkedlist_datablock_internal
modifier|*
name|first_block
decl_stmt|;
name|linkedlist_datablock_internal
modifier|*
name|last_block
decl_stmt|;
block|}
name|linkedlist_data
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|z_stream
name|stream
decl_stmt|;
comment|/* zLib stream structure for inflate */
ifdef|#
directive|ifdef
name|HAVE_BZIP2
name|bz_stream
name|bstream
decl_stmt|;
comment|/* bzLib stream structure for bziped */
endif|#
directive|endif
name|int
name|stream_initialised
decl_stmt|;
comment|/* 1 is stream is initialised */
name|uInt
name|pos_in_buffered_data
decl_stmt|;
comment|/* last written byte in buffered_data */
name|ZPOS64_T
name|pos_local_header
decl_stmt|;
comment|/* offset of the local header of the file                                      currenty writing */
name|char
modifier|*
name|central_header
decl_stmt|;
comment|/* central header data for the current file */
name|uLong
name|size_centralExtra
decl_stmt|;
name|uLong
name|size_centralheader
decl_stmt|;
comment|/* size of the central header for cur file */
name|uLong
name|size_centralExtraFree
decl_stmt|;
comment|/* Extra bytes allocated to the centralheader but that are not used */
name|uLong
name|flag
decl_stmt|;
comment|/* flag of the file currently writing */
name|int
name|method
decl_stmt|;
comment|/* compression method of file currenty wr.*/
name|int
name|raw
decl_stmt|;
comment|/* 1 for directly writing raw data */
name|Byte
name|buffered_data
index|[
name|Z_BUFSIZE
index|]
decl_stmt|;
comment|/* buffer contain compressed data to be writ*/
name|uLong
name|dosDate
decl_stmt|;
name|uLong
name|crc32
decl_stmt|;
name|int
name|encrypt
decl_stmt|;
name|int
name|zip64
decl_stmt|;
comment|/* Add ZIP64 extened information in the extra field */
name|ZPOS64_T
name|pos_zip64extrainfo
decl_stmt|;
name|ZPOS64_T
name|totalCompressedData
decl_stmt|;
name|ZPOS64_T
name|totalUncompressedData
decl_stmt|;
ifndef|#
directive|ifndef
name|NOCRYPT
name|unsigned
name|long
name|keys
index|[
literal|3
index|]
decl_stmt|;
comment|/* keys defining the pseudo-random sequence */
specifier|const
name|z_crc_t
modifier|*
name|pcrc_32_tab
decl_stmt|;
name|int
name|crypt_header_size
decl_stmt|;
endif|#
directive|endif
block|}
name|curfile64_info
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|zlib_filefunc64_32_def
name|z_filefunc
decl_stmt|;
name|voidpf
name|filestream
decl_stmt|;
comment|/* io structore of the zipfile */
name|linkedlist_data
name|central_dir
decl_stmt|;
comment|/* datablock with central dir in construction*/
name|int
name|in_opened_file_inzip
decl_stmt|;
comment|/* 1 if a file in the zip is currently writ.*/
name|curfile64_info
name|ci
decl_stmt|;
comment|/* info on the file curretly writing */
name|ZPOS64_T
name|begin_pos
decl_stmt|;
comment|/* position of the beginning of the zipfile */
name|ZPOS64_T
name|add_position_when_writting_offset
decl_stmt|;
name|ZPOS64_T
name|number_entry
decl_stmt|;
ifndef|#
directive|ifndef
name|NO_ADDFILEINEXISTINGZIP
name|char
modifier|*
name|globalcomment
decl_stmt|;
endif|#
directive|endif
block|}
name|zip64_internal
typedef|;
end_typedef

begin_ifndef
ifndef|#
directive|ifndef
name|NOCRYPT
end_ifndef

begin_define
define|#
directive|define
name|INCLUDECRYPTINGCODE_IFCRYPTALLOWED
end_define

begin_include
include|#
directive|include
file|"crypt.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|local
name|linkedlist_datablock_internal
modifier|*
name|allocate_new_datablock
parameter_list|()
block|{
name|linkedlist_datablock_internal
modifier|*
name|ldi
decl_stmt|;
name|ldi
operator|=
operator|(
name|linkedlist_datablock_internal
operator|*
operator|)
name|ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|linkedlist_datablock_internal
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldi
operator|!=
name|NULL
condition|)
block|{
name|ldi
operator|->
name|next_datablock
operator|=
name|NULL
expr_stmt|;
name|ldi
operator|->
name|filled_in_this_block
operator|=
literal|0
expr_stmt|;
name|ldi
operator|->
name|avail_in_this_block
operator|=
name|SIZEDATA_INDATABLOCK
expr_stmt|;
block|}
return|return
name|ldi
return|;
block|}
end_function

begin_function
name|local
name|void
name|free_datablock
parameter_list|(
name|linkedlist_datablock_internal
modifier|*
name|ldi
parameter_list|)
block|{
while|while
condition|(
name|ldi
operator|!=
name|NULL
condition|)
block|{
name|linkedlist_datablock_internal
modifier|*
name|ldinext
init|=
name|ldi
operator|->
name|next_datablock
decl_stmt|;
name|TRYFREE
argument_list|(
name|ldi
argument_list|)
expr_stmt|;
name|ldi
operator|=
name|ldinext
expr_stmt|;
block|}
block|}
end_function

begin_function
name|local
name|void
name|init_linkedlist
parameter_list|(
name|linkedlist_data
modifier|*
name|ll
parameter_list|)
block|{
name|ll
operator|->
name|first_block
operator|=
name|ll
operator|->
name|last_block
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|local
name|void
name|free_linkedlist
parameter_list|(
name|linkedlist_data
modifier|*
name|ll
parameter_list|)
block|{
name|free_datablock
argument_list|(
name|ll
operator|->
name|first_block
argument_list|)
expr_stmt|;
name|ll
operator|->
name|first_block
operator|=
name|ll
operator|->
name|last_block
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|local
name|int
name|add_data_in_datablock
parameter_list|(
name|linkedlist_data
modifier|*
name|ll
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|uLong
name|len
parameter_list|)
block|{
name|linkedlist_datablock_internal
modifier|*
name|ldi
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|from_copy
decl_stmt|;
if|if
condition|(
name|ll
operator|==
name|NULL
condition|)
return|return
name|ZIP_INTERNALERROR
return|;
if|if
condition|(
name|ll
operator|->
name|last_block
operator|==
name|NULL
condition|)
block|{
name|ll
operator|->
name|first_block
operator|=
name|ll
operator|->
name|last_block
operator|=
name|allocate_new_datablock
argument_list|()
expr_stmt|;
if|if
condition|(
name|ll
operator|->
name|first_block
operator|==
name|NULL
condition|)
return|return
name|ZIP_INTERNALERROR
return|;
block|}
name|ldi
operator|=
name|ll
operator|->
name|last_block
expr_stmt|;
name|from_copy
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|uInt
name|copy_this
decl_stmt|;
name|uInt
name|i
decl_stmt|;
name|unsigned
name|char
modifier|*
name|to_copy
decl_stmt|;
if|if
condition|(
name|ldi
operator|->
name|avail_in_this_block
operator|==
literal|0
condition|)
block|{
name|ldi
operator|->
name|next_datablock
operator|=
name|allocate_new_datablock
argument_list|()
expr_stmt|;
if|if
condition|(
name|ldi
operator|->
name|next_datablock
operator|==
name|NULL
condition|)
return|return
name|ZIP_INTERNALERROR
return|;
name|ldi
operator|=
name|ldi
operator|->
name|next_datablock
expr_stmt|;
name|ll
operator|->
name|last_block
operator|=
name|ldi
expr_stmt|;
block|}
if|if
condition|(
name|ldi
operator|->
name|avail_in_this_block
operator|<
name|len
condition|)
name|copy_this
operator|=
operator|(
name|uInt
operator|)
name|ldi
operator|->
name|avail_in_this_block
expr_stmt|;
else|else
name|copy_this
operator|=
operator|(
name|uInt
operator|)
name|len
expr_stmt|;
name|to_copy
operator|=
operator|&
operator|(
name|ldi
operator|->
name|data
index|[
name|ldi
operator|->
name|filled_in_this_block
index|]
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|copy_this
condition|;
name|i
operator|++
control|)
operator|*
operator|(
name|to_copy
operator|+
name|i
operator|)
operator|=
operator|*
operator|(
name|from_copy
operator|+
name|i
operator|)
expr_stmt|;
name|ldi
operator|->
name|filled_in_this_block
operator|+=
name|copy_this
expr_stmt|;
name|ldi
operator|->
name|avail_in_this_block
operator|-=
name|copy_this
expr_stmt|;
name|from_copy
operator|+=
name|copy_this
expr_stmt|;
name|len
operator|-=
name|copy_this
expr_stmt|;
block|}
return|return
name|ZIP_OK
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|NO_ADDFILEINEXISTINGZIP
end_ifndef

begin_comment
comment|/* ===========================================================================    Inputs a long in LSB order to the given file    nbByte == 1, 2 ,4 or 8 (byte, short or long, ZPOS64_T) */
end_comment

begin_decl_stmt
name|local
name|int
name|zip64local_putValue
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|,
name|ZPOS64_T
name|x
operator|,
name|int
name|nbByte
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|zip64local_putValue
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|ZPOS64_T
name|x
parameter_list|,
name|int
name|nbByte
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbByte
condition|;
name|n
operator|++
control|)
block|{
name|buf
index|[
name|n
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|x
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|x
operator|>>=
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|!=
literal|0
condition|)
block|{
comment|/* data overflow - hack for ZIP64 (X Roche) */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbByte
condition|;
name|n
operator|++
control|)
block|{
name|buf
index|[
name|n
index|]
operator|=
literal|0xff
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ZWRITE64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|buf
argument_list|,
name|nbByte
argument_list|)
operator|!=
operator|(
name|uLong
operator|)
name|nbByte
condition|)
return|return
name|ZIP_ERRNO
return|;
else|else
return|return
name|ZIP_OK
return|;
block|}
end_function

begin_decl_stmt
name|local
name|void
name|zip64local_putValue_inmemory
name|OF
argument_list|(
operator|(
name|void
operator|*
name|dest
operator|,
name|ZPOS64_T
name|x
operator|,
name|int
name|nbByte
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|void
name|zip64local_putValue_inmemory
parameter_list|(
name|void
modifier|*
name|dest
parameter_list|,
name|ZPOS64_T
name|x
parameter_list|,
name|int
name|nbByte
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|buf
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|dest
decl_stmt|;
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbByte
condition|;
name|n
operator|++
control|)
block|{
name|buf
index|[
name|n
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|x
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|x
operator|>>=
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|!=
literal|0
condition|)
block|{
comment|/* data overflow - hack for ZIP64 */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbByte
condition|;
name|n
operator|++
control|)
block|{
name|buf
index|[
name|n
index|]
operator|=
literal|0xff
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_function
name|local
name|uLong
name|zip64local_TmzDateToDosDate
parameter_list|(
specifier|const
name|tm_zip
modifier|*
name|ptm
parameter_list|)
block|{
name|uLong
name|year
init|=
operator|(
name|uLong
operator|)
name|ptm
operator|->
name|tm_year
decl_stmt|;
if|if
condition|(
name|year
operator|>=
literal|1980
condition|)
name|year
operator|-=
literal|1980
expr_stmt|;
elseif|else
if|if
condition|(
name|year
operator|>=
literal|80
condition|)
name|year
operator|-=
literal|80
expr_stmt|;
return|return
call|(
name|uLong
call|)
argument_list|(
operator|(
operator|(
name|ptm
operator|->
name|tm_mday
operator|)
operator|+
operator|(
literal|32
operator|*
operator|(
name|ptm
operator|->
name|tm_mon
operator|+
literal|1
operator|)
operator|)
operator|+
operator|(
literal|512
operator|*
name|year
operator|)
operator|)
operator|<<
literal|16
argument_list|)
operator||
operator|(
operator|(
name|ptm
operator|->
name|tm_sec
operator|/
literal|2
operator|)
operator|+
operator|(
literal|32
operator|*
name|ptm
operator|->
name|tm_min
operator|)
operator|+
operator|(
literal|2048
operator|*
operator|(
name|uLong
operator|)
name|ptm
operator|->
name|tm_hour
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/****************************************************************************/
end_comment

begin_decl_stmt
name|local
name|int
name|zip64local_getByte
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|,
name|int
operator|*
name|pi
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|zip64local_getByte
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|int
modifier|*
name|pi
parameter_list|)
block|{
name|unsigned
name|char
name|c
decl_stmt|;
name|int
name|err
init|=
operator|(
name|int
operator|)
name|ZREAD64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|==
literal|1
condition|)
block|{
operator|*
name|pi
operator|=
operator|(
name|int
operator|)
name|c
expr_stmt|;
return|return
name|ZIP_OK
return|;
block|}
else|else
block|{
if|if
condition|(
name|ZERROR64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|)
condition|)
return|return
name|ZIP_ERRNO
return|;
else|else
return|return
name|ZIP_EOF
return|;
block|}
block|}
end_function

begin_comment
comment|/* ===========================================================================    Reads a long in LSB order from the given gz_stream. Sets */
end_comment

begin_decl_stmt
name|local
name|int
name|zip64local_getShort
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|,
name|uLong
operator|*
name|pX
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|zip64local_getShort
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|uLong
modifier|*
name|pX
parameter_list|)
block|{
name|uLong
name|x
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|uLong
operator|)
name|i
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|uLong
operator|)
name|i
operator|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
operator|*
name|pX
operator|=
name|x
expr_stmt|;
else|else
operator|*
name|pX
operator|=
literal|0
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_decl_stmt
name|local
name|int
name|zip64local_getLong
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|,
name|uLong
operator|*
name|pX
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|zip64local_getLong
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|uLong
modifier|*
name|pX
parameter_list|)
block|{
name|uLong
name|x
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|uLong
operator|)
name|i
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|uLong
operator|)
name|i
operator|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|uLong
operator|)
name|i
operator|)
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|uLong
operator|)
name|i
operator|)
operator|<<
literal|24
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
operator|*
name|pX
operator|=
name|x
expr_stmt|;
else|else
operator|*
name|pX
operator|=
literal|0
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_decl_stmt
name|local
name|int
name|zip64local_getLong64
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|,
name|ZPOS64_T
operator|*
name|pX
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|int
name|zip64local_getLong64
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|,
name|ZPOS64_T
modifier|*
name|pX
parameter_list|)
block|{
name|ZPOS64_T
name|x
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|ZPOS64_T
operator|)
name|i
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|24
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|32
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|40
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|48
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_getByte
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|x
operator|+=
operator|(
operator|(
name|ZPOS64_T
operator|)
name|i
operator|)
operator|<<
literal|56
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
operator|*
name|pX
operator|=
name|x
expr_stmt|;
else|else
operator|*
name|pX
operator|=
literal|0
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|BUFREADCOMMENT
end_ifndef

begin_define
define|#
directive|define
name|BUFREADCOMMENT
value|(0x400)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   Locate the Central directory of a zipfile (at the end, just before     the global comment) */
end_comment

begin_decl_stmt
name|local
name|ZPOS64_T
name|zip64local_SearchCentralDir
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|ZPOS64_T
name|zip64local_SearchCentralDir
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|ZPOS64_T
name|uSizeFile
decl_stmt|;
name|ZPOS64_T
name|uBackRead
decl_stmt|;
name|ZPOS64_T
name|uMaxBack
init|=
literal|0xffff
decl_stmt|;
comment|/* maximum size of global comment */
name|ZPOS64_T
name|uPosFound
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
literal|0
argument_list|,
name|ZLIB_FILEFUNC_SEEK_END
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
name|uSizeFile
operator|=
name|ZTELL64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|)
expr_stmt|;
if|if
condition|(
name|uMaxBack
operator|>
name|uSizeFile
condition|)
name|uMaxBack
operator|=
name|uSizeFile
expr_stmt|;
name|buf
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ALLOC
argument_list|(
name|BUFREADCOMMENT
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|uBackRead
operator|=
literal|4
expr_stmt|;
while|while
condition|(
name|uBackRead
operator|<
name|uMaxBack
condition|)
block|{
name|uLong
name|uReadSize
decl_stmt|;
name|ZPOS64_T
name|uReadPos
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|uBackRead
operator|+
name|BUFREADCOMMENT
operator|>
name|uMaxBack
condition|)
name|uBackRead
operator|=
name|uMaxBack
expr_stmt|;
else|else
name|uBackRead
operator|+=
name|BUFREADCOMMENT
expr_stmt|;
name|uReadPos
operator|=
name|uSizeFile
operator|-
name|uBackRead
expr_stmt|;
name|uReadSize
operator|=
operator|(
operator|(
name|BUFREADCOMMENT
operator|+
literal|4
operator|)
operator|<
operator|(
name|uSizeFile
operator|-
name|uReadPos
operator|)
operator|)
condition|?
operator|(
name|BUFREADCOMMENT
operator|+
literal|4
operator|)
else|:
call|(
name|uLong
call|)
argument_list|(
name|uSizeFile
operator|-
name|uReadPos
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|uReadPos
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|ZREAD64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|buf
argument_list|,
name|uReadSize
argument_list|)
operator|!=
name|uReadSize
condition|)
break|break;
for|for
control|(
name|i
operator|=
operator|(
name|int
operator|)
name|uReadSize
operator|-
literal|3
init|;
operator|(
name|i
operator|--
operator|)
operator|>
literal|0
condition|;
control|)
if|if
condition|(
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|)
operator|)
operator|==
literal|0x50
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|1
operator|)
operator|)
operator|==
literal|0x4b
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|2
operator|)
operator|)
operator|==
literal|0x05
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|3
operator|)
operator|)
operator|==
literal|0x06
operator|)
condition|)
block|{
name|uPosFound
operator|=
name|uReadPos
operator|+
name|i
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|uPosFound
operator|!=
literal|0
condition|)
break|break;
block|}
name|TRYFREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|uPosFound
return|;
block|}
end_function

begin_comment
comment|/* Locate the End of Zip64 Central directory locator and from there find the CD of a zipfile (at the end, just before the global comment) */
end_comment

begin_decl_stmt
name|local
name|ZPOS64_T
name|zip64local_SearchCentralDir64
name|OF
argument_list|(
operator|(
specifier|const
name|zlib_filefunc64_32_def
operator|*
name|pzlib_filefunc_def
operator|,
name|voidpf
name|filestream
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|ZPOS64_T
name|zip64local_SearchCentralDir64
parameter_list|(
specifier|const
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc_def
parameter_list|,
name|voidpf
name|filestream
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|ZPOS64_T
name|uSizeFile
decl_stmt|;
name|ZPOS64_T
name|uBackRead
decl_stmt|;
name|ZPOS64_T
name|uMaxBack
init|=
literal|0xffff
decl_stmt|;
comment|/* maximum size of global comment */
name|ZPOS64_T
name|uPosFound
init|=
literal|0
decl_stmt|;
name|uLong
name|uL
decl_stmt|;
name|ZPOS64_T
name|relativeOffset
decl_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
literal|0
argument_list|,
name|ZLIB_FILEFUNC_SEEK_END
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
name|uSizeFile
operator|=
name|ZTELL64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|)
expr_stmt|;
if|if
condition|(
name|uMaxBack
operator|>
name|uSizeFile
condition|)
name|uMaxBack
operator|=
name|uSizeFile
expr_stmt|;
name|buf
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ALLOC
argument_list|(
name|BUFREADCOMMENT
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|uBackRead
operator|=
literal|4
expr_stmt|;
while|while
condition|(
name|uBackRead
operator|<
name|uMaxBack
condition|)
block|{
name|uLong
name|uReadSize
decl_stmt|;
name|ZPOS64_T
name|uReadPos
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|uBackRead
operator|+
name|BUFREADCOMMENT
operator|>
name|uMaxBack
condition|)
name|uBackRead
operator|=
name|uMaxBack
expr_stmt|;
else|else
name|uBackRead
operator|+=
name|BUFREADCOMMENT
expr_stmt|;
name|uReadPos
operator|=
name|uSizeFile
operator|-
name|uBackRead
expr_stmt|;
name|uReadSize
operator|=
operator|(
operator|(
name|BUFREADCOMMENT
operator|+
literal|4
operator|)
operator|<
operator|(
name|uSizeFile
operator|-
name|uReadPos
operator|)
operator|)
condition|?
operator|(
name|BUFREADCOMMENT
operator|+
literal|4
operator|)
else|:
call|(
name|uLong
call|)
argument_list|(
name|uSizeFile
operator|-
name|uReadPos
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|uReadPos
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|ZREAD64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|buf
argument_list|,
name|uReadSize
argument_list|)
operator|!=
name|uReadSize
condition|)
break|break;
for|for
control|(
name|i
operator|=
operator|(
name|int
operator|)
name|uReadSize
operator|-
literal|3
init|;
operator|(
name|i
operator|--
operator|)
operator|>
literal|0
condition|;
control|)
block|{
comment|// Signature "0x07064b50" Zip64 end of central directory locater
if|if
condition|(
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|)
operator|)
operator|==
literal|0x50
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|1
operator|)
operator|)
operator|==
literal|0x4b
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|2
operator|)
operator|)
operator|==
literal|0x06
operator|)
operator|&&
operator|(
operator|(
operator|*
operator|(
name|buf
operator|+
name|i
operator|+
literal|3
operator|)
operator|)
operator|==
literal|0x07
operator|)
condition|)
block|{
name|uPosFound
operator|=
name|uReadPos
operator|+
name|i
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|uPosFound
operator|!=
literal|0
condition|)
break|break;
block|}
name|TRYFREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|uPosFound
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Zip64 end of central directory locator */
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|uPosFound
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* the signature, already checked */
if|if
condition|(
name|zip64local_getLong
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
return|return
literal|0
return|;
comment|/* number of the disk with the start of the zip64 end of  central directory */
if|if
condition|(
name|zip64local_getLong
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|uL
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* relative offset of the zip64 end of central directory record */
if|if
condition|(
name|zip64local_getLong64
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|relativeOffset
argument_list|)
operator|!=
name|ZIP_OK
condition|)
return|return
literal|0
return|;
comment|/* total number of disks */
if|if
condition|(
name|zip64local_getLong
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|uL
operator|!=
literal|1
condition|)
return|return
literal|0
return|;
comment|/* Goto Zip64 end of central directory record */
if|if
condition|(
name|ZSEEK64
argument_list|(
operator|*
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
name|relativeOffset
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* the signature */
if|if
condition|(
name|zip64local_getLong
argument_list|(
name|pzlib_filefunc_def
argument_list|,
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|uL
operator|!=
literal|0x06064b50
condition|)
comment|// signature of 'Zip64 end of central directory'
return|return
literal|0
return|;
return|return
name|relativeOffset
return|;
block|}
end_function

begin_function
name|int
name|LoadCentralDirectoryRecord
parameter_list|(
name|zip64_internal
modifier|*
name|pziinit
parameter_list|)
block|{
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
name|ZPOS64_T
name|byte_before_the_zipfile
decl_stmt|;
comment|/* byte before the zipfile, (>0 for sfx)*/
name|ZPOS64_T
name|size_central_dir
decl_stmt|;
comment|/* size of the central directory  */
name|ZPOS64_T
name|offset_central_dir
decl_stmt|;
comment|/* offset of start of central directory */
name|ZPOS64_T
name|central_pos
decl_stmt|;
name|uLong
name|uL
decl_stmt|;
name|uLong
name|number_disk
decl_stmt|;
comment|/* number of the current dist, used for                               spaning ZIP, unsupported, always 0*/
name|uLong
name|number_disk_with_CD
decl_stmt|;
comment|/* number the the disk with central dir, used                               for spaning ZIP, unsupported, always 0*/
name|ZPOS64_T
name|number_entry
decl_stmt|;
name|ZPOS64_T
name|number_entry_CD
decl_stmt|;
comment|/* total number of entries in                                 the central dir                                 (same than number_entry on nospan) */
name|uLong
name|VersionMadeBy
decl_stmt|;
name|uLong
name|VersionNeeded
decl_stmt|;
name|uLong
name|size_comment
decl_stmt|;
name|int
name|hasZIP64Record
init|=
literal|0
decl_stmt|;
comment|// check first if we find a ZIP64 record
name|central_pos
operator|=
name|zip64local_SearchCentralDir64
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|)
expr_stmt|;
if|if
condition|(
name|central_pos
operator|>
literal|0
condition|)
block|{
name|hasZIP64Record
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|central_pos
operator|==
literal|0
condition|)
block|{
name|central_pos
operator|=
name|zip64local_SearchCentralDir
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|)
expr_stmt|;
block|}
comment|/* disable to allow appending to empty ZIP archive         if (central_pos==0)             err=ZIP_ERRNO; */
if|if
condition|(
name|hasZIP64Record
condition|)
block|{
name|ZPOS64_T
name|sizeEndOfCentralDirectory
decl_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
name|central_pos
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* the signature, already checked */
if|if
condition|(
name|zip64local_getLong
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* size of zip64 end of central directory record */
if|if
condition|(
name|zip64local_getLong64
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|sizeEndOfCentralDirectory
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* version made by */
if|if
condition|(
name|zip64local_getShort
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|VersionMadeBy
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* version needed to extract */
if|if
condition|(
name|zip64local_getShort
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|VersionNeeded
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* number of this disk */
if|if
condition|(
name|zip64local_getLong
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|number_disk
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* number of the disk with the start of the central directory */
if|if
condition|(
name|zip64local_getLong
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|number_disk_with_CD
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* total number of entries in the central directory on this disk */
if|if
condition|(
name|zip64local_getLong64
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|number_entry
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* total number of entries in the central directory */
if|if
condition|(
name|zip64local_getLong64
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|number_entry_CD
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
if|if
condition|(
operator|(
name|number_entry_CD
operator|!=
name|number_entry
operator|)
operator|||
operator|(
name|number_disk_with_CD
operator|!=
literal|0
operator|)
operator|||
operator|(
name|number_disk
operator|!=
literal|0
operator|)
condition|)
name|err
operator|=
name|ZIP_BADZIPFILE
expr_stmt|;
comment|/* size of the central directory */
if|if
condition|(
name|zip64local_getLong64
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|size_central_dir
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* offset of start of central directory with respect to the     starting disk number */
if|if
condition|(
name|zip64local_getLong64
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|offset_central_dir
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|// TODO..
comment|// read the comment from the standard central header.
name|size_comment
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|// Read End of central Directory info
if|if
condition|(
name|ZSEEK64
argument_list|(
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
name|central_pos
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* the signature, already checked */
if|if
condition|(
name|zip64local_getLong
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* number of this disk */
if|if
condition|(
name|zip64local_getShort
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|number_disk
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* number of the disk with the start of the central directory */
if|if
condition|(
name|zip64local_getShort
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|number_disk_with_CD
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
comment|/* total number of entries in the central dir on this disk */
name|number_entry
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|zip64local_getShort
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
else|else
name|number_entry
operator|=
name|uL
expr_stmt|;
comment|/* total number of entries in the central dir */
name|number_entry_CD
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|zip64local_getShort
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
else|else
name|number_entry_CD
operator|=
name|uL
expr_stmt|;
if|if
condition|(
operator|(
name|number_entry_CD
operator|!=
name|number_entry
operator|)
operator|||
operator|(
name|number_disk_with_CD
operator|!=
literal|0
operator|)
operator|||
operator|(
name|number_disk
operator|!=
literal|0
operator|)
condition|)
name|err
operator|=
name|ZIP_BADZIPFILE
expr_stmt|;
comment|/* size of the central directory */
name|size_central_dir
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|zip64local_getLong
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
else|else
name|size_central_dir
operator|=
name|uL
expr_stmt|;
comment|/* offset of start of central directory with respect to the starting disk number */
name|offset_central_dir
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|zip64local_getLong
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|uL
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
else|else
name|offset_central_dir
operator|=
name|uL
expr_stmt|;
comment|/* zipfile global comment length */
if|if
condition|(
name|zip64local_getShort
argument_list|(
operator|&
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
operator|&
name|size_comment
argument_list|)
operator|!=
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|central_pos
operator|<
name|offset_central_dir
operator|+
name|size_central_dir
operator|)
operator|&&
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
condition|)
name|err
operator|=
name|ZIP_BADZIPFILE
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|ZIP_OK
condition|)
block|{
name|ZCLOSE64
argument_list|(
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|)
expr_stmt|;
return|return
name|ZIP_ERRNO
return|;
block|}
if|if
condition|(
name|size_comment
operator|>
literal|0
condition|)
block|{
name|pziinit
operator|->
name|globalcomment
operator|=
operator|(
name|char
operator|*
operator|)
name|ALLOC
argument_list|(
name|size_comment
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pziinit
operator|->
name|globalcomment
condition|)
block|{
name|size_comment
operator|=
name|ZREAD64
argument_list|(
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
name|pziinit
operator|->
name|globalcomment
argument_list|,
name|size_comment
argument_list|)
expr_stmt|;
name|pziinit
operator|->
name|globalcomment
index|[
name|size_comment
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|byte_before_the_zipfile
operator|=
name|central_pos
operator|-
operator|(
name|offset_central_dir
operator|+
name|size_central_dir
operator|)
expr_stmt|;
name|pziinit
operator|->
name|add_position_when_writting_offset
operator|=
name|byte_before_the_zipfile
expr_stmt|;
block|{
name|ZPOS64_T
name|size_central_dir_to_read
init|=
name|size_central_dir
decl_stmt|;
name|size_t
name|buf_size
init|=
name|SIZEDATA_INDATABLOCK
decl_stmt|;
name|void
modifier|*
name|buf_read
init|=
operator|(
name|void
operator|*
operator|)
name|ALLOC
argument_list|(
name|buf_size
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
name|offset_central_dir
operator|+
name|byte_before_the_zipfile
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
while|while
condition|(
operator|(
name|size_central_dir_to_read
operator|>
literal|0
operator|)
operator|&&
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
condition|)
block|{
name|ZPOS64_T
name|read_this
init|=
name|SIZEDATA_INDATABLOCK
decl_stmt|;
if|if
condition|(
name|read_this
operator|>
name|size_central_dir_to_read
condition|)
name|read_this
operator|=
name|size_central_dir_to_read
expr_stmt|;
if|if
condition|(
name|ZREAD64
argument_list|(
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
name|buf_read
argument_list|,
operator|(
name|uLong
operator|)
name|read_this
argument_list|)
operator|!=
name|read_this
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|add_data_in_datablock
argument_list|(
operator|&
name|pziinit
operator|->
name|central_dir
argument_list|,
name|buf_read
argument_list|,
operator|(
name|uLong
operator|)
name|read_this
argument_list|)
expr_stmt|;
name|size_central_dir_to_read
operator|-=
name|read_this
expr_stmt|;
block|}
name|TRYFREE
argument_list|(
name|buf_read
argument_list|)
expr_stmt|;
block|}
name|pziinit
operator|->
name|begin_pos
operator|=
name|byte_before_the_zipfile
expr_stmt|;
name|pziinit
operator|->
name|number_entry
operator|=
name|number_entry_CD
expr_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|pziinit
operator|->
name|z_filefunc
argument_list|,
name|pziinit
operator|->
name|filestream
argument_list|,
name|offset_central_dir
operator|+
name|byte_before_the_zipfile
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !NO_ADDFILEINEXISTINGZIP*/
end_comment

begin_comment
comment|/************************************************************/
end_comment

begin_function
specifier|extern
name|zipFile
name|ZEXPORT
name|zipOpen3
parameter_list|(
specifier|const
name|void
modifier|*
name|pathname
parameter_list|,
name|int
name|append
parameter_list|,
name|zipcharpc
modifier|*
name|globalcomment
parameter_list|,
name|zlib_filefunc64_32_def
modifier|*
name|pzlib_filefunc64_32_def
parameter_list|)
block|{
name|zip64_internal
name|ziinit
decl_stmt|;
name|zip64_internal
modifier|*
name|zi
decl_stmt|;
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
name|ziinit
operator|.
name|z_filefunc
operator|.
name|zseek32_file
operator|=
name|NULL
expr_stmt|;
name|ziinit
operator|.
name|z_filefunc
operator|.
name|ztell32_file
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|pzlib_filefunc64_32_def
operator|==
name|NULL
condition|)
name|fill_fopen64_filefunc
argument_list|(
operator|&
name|ziinit
operator|.
name|z_filefunc
operator|.
name|zfile_func64
argument_list|)
expr_stmt|;
else|else
name|ziinit
operator|.
name|z_filefunc
operator|=
operator|*
name|pzlib_filefunc64_32_def
expr_stmt|;
name|ziinit
operator|.
name|filestream
operator|=
name|ZOPEN64
argument_list|(
name|ziinit
operator|.
name|z_filefunc
argument_list|,
name|pathname
argument_list|,
operator|(
name|append
operator|==
name|APPEND_STATUS_CREATE
operator|)
condition|?
operator|(
name|ZLIB_FILEFUNC_MODE_READ
operator||
name|ZLIB_FILEFUNC_MODE_WRITE
operator||
name|ZLIB_FILEFUNC_MODE_CREATE
operator|)
else|:
operator|(
name|ZLIB_FILEFUNC_MODE_READ
operator||
name|ZLIB_FILEFUNC_MODE_WRITE
operator||
name|ZLIB_FILEFUNC_MODE_EXISTING
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ziinit
operator|.
name|filestream
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|append
operator|==
name|APPEND_STATUS_CREATEAFTER
condition|)
name|ZSEEK64
argument_list|(
name|ziinit
operator|.
name|z_filefunc
argument_list|,
name|ziinit
operator|.
name|filestream
argument_list|,
literal|0
argument_list|,
name|SEEK_END
argument_list|)
expr_stmt|;
name|ziinit
operator|.
name|begin_pos
operator|=
name|ZTELL64
argument_list|(
name|ziinit
operator|.
name|z_filefunc
argument_list|,
name|ziinit
operator|.
name|filestream
argument_list|)
expr_stmt|;
name|ziinit
operator|.
name|in_opened_file_inzip
operator|=
literal|0
expr_stmt|;
name|ziinit
operator|.
name|ci
operator|.
name|stream_initialised
operator|=
literal|0
expr_stmt|;
name|ziinit
operator|.
name|number_entry
operator|=
literal|0
expr_stmt|;
name|ziinit
operator|.
name|add_position_when_writting_offset
operator|=
literal|0
expr_stmt|;
name|init_linkedlist
argument_list|(
operator|&
operator|(
name|ziinit
operator|.
name|central_dir
operator|)
argument_list|)
expr_stmt|;
name|zi
operator|=
operator|(
name|zip64_internal
operator|*
operator|)
name|ALLOC
argument_list|(
sizeof|sizeof
argument_list|(
name|zip64_internal
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zi
operator|==
name|NULL
condition|)
block|{
name|ZCLOSE64
argument_list|(
name|ziinit
operator|.
name|z_filefunc
argument_list|,
name|ziinit
operator|.
name|filestream
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* now we add file in a zipfile */
ifndef|#
directive|ifndef
name|NO_ADDFILEINEXISTINGZIP
name|ziinit
operator|.
name|globalcomment
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|append
operator|==
name|APPEND_STATUS_ADDINZIP
condition|)
block|{
comment|// Read and Cache Central Directory Records
name|err
operator|=
name|LoadCentralDirectoryRecord
argument_list|(
operator|&
name|ziinit
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|globalcomment
condition|)
block|{
operator|*
name|globalcomment
operator|=
name|ziinit
operator|.
name|globalcomment
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* !NO_ADDFILEINEXISTINGZIP*/
if|if
condition|(
name|err
operator|!=
name|ZIP_OK
condition|)
block|{
ifndef|#
directive|ifndef
name|NO_ADDFILEINEXISTINGZIP
name|TRYFREE
argument_list|(
name|ziinit
operator|.
name|globalcomment
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* !NO_ADDFILEINEXISTINGZIP*/
name|TRYFREE
argument_list|(
name|zi
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
operator|*
name|zi
operator|=
name|ziinit
expr_stmt|;
return|return
operator|(
name|zipFile
operator|)
name|zi
return|;
block|}
block|}
end_function

begin_function
specifier|extern
name|zipFile
name|ZEXPORT
name|zipOpen2
parameter_list|(
specifier|const
name|char
modifier|*
name|pathname
parameter_list|,
name|int
name|append
parameter_list|,
name|zipcharpc
modifier|*
name|globalcomment
parameter_list|,
name|zlib_filefunc_def
modifier|*
name|pzlib_filefunc32_def
parameter_list|)
block|{
if|if
condition|(
name|pzlib_filefunc32_def
operator|!=
name|NULL
condition|)
block|{
name|zlib_filefunc64_32_def
name|zlib_filefunc64_32_def_fill
decl_stmt|;
name|fill_zlib_filefunc64_32_def_from_filefunc32
argument_list|(
operator|&
name|zlib_filefunc64_32_def_fill
argument_list|,
name|pzlib_filefunc32_def
argument_list|)
expr_stmt|;
return|return
name|zipOpen3
argument_list|(
name|pathname
argument_list|,
name|append
argument_list|,
name|globalcomment
argument_list|,
operator|&
name|zlib_filefunc64_32_def_fill
argument_list|)
return|;
block|}
else|else
return|return
name|zipOpen3
argument_list|(
name|pathname
argument_list|,
name|append
argument_list|,
name|globalcomment
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|zipFile
name|ZEXPORT
name|zipOpen2_64
parameter_list|(
specifier|const
name|void
modifier|*
name|pathname
parameter_list|,
name|int
name|append
parameter_list|,
name|zipcharpc
modifier|*
name|globalcomment
parameter_list|,
name|zlib_filefunc64_def
modifier|*
name|pzlib_filefunc_def
parameter_list|)
block|{
if|if
condition|(
name|pzlib_filefunc_def
operator|!=
name|NULL
condition|)
block|{
name|zlib_filefunc64_32_def
name|zlib_filefunc64_32_def_fill
decl_stmt|;
name|zlib_filefunc64_32_def_fill
operator|.
name|zfile_func64
operator|=
operator|*
name|pzlib_filefunc_def
expr_stmt|;
name|zlib_filefunc64_32_def_fill
operator|.
name|ztell32_file
operator|=
name|NULL
expr_stmt|;
name|zlib_filefunc64_32_def_fill
operator|.
name|zseek32_file
operator|=
name|NULL
expr_stmt|;
return|return
name|zipOpen3
argument_list|(
name|pathname
argument_list|,
name|append
argument_list|,
name|globalcomment
argument_list|,
operator|&
name|zlib_filefunc64_32_def_fill
argument_list|)
return|;
block|}
else|else
return|return
name|zipOpen3
argument_list|(
name|pathname
argument_list|,
name|append
argument_list|,
name|globalcomment
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|zipFile
name|ZEXPORT
name|zipOpen
parameter_list|(
specifier|const
name|char
modifier|*
name|pathname
parameter_list|,
name|int
name|append
parameter_list|)
block|{
return|return
name|zipOpen3
argument_list|(
operator|(
specifier|const
name|void
operator|*
operator|)
name|pathname
argument_list|,
name|append
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|zipFile
name|ZEXPORT
name|zipOpen64
parameter_list|(
specifier|const
name|void
modifier|*
name|pathname
parameter_list|,
name|int
name|append
parameter_list|)
block|{
return|return
name|zipOpen3
argument_list|(
name|pathname
argument_list|,
name|append
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|Write_LocalFileHeader
parameter_list|(
name|zip64_internal
modifier|*
name|zi
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|uInt
name|size_extrafield_local
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_local
parameter_list|)
block|{
comment|/* write the local header */
name|int
name|err
decl_stmt|;
name|uInt
name|size_filename
init|=
operator|(
name|uInt
operator|)
name|strlen
argument_list|(
name|filename
argument_list|)
decl_stmt|;
name|uInt
name|size_extrafield
init|=
name|size_extrafield_local
decl_stmt|;
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|LOCALHEADERMAGIC
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
block|{
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|zip64
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|45
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* version needed to extract */
else|else
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|20
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* version needed to extract */
block|}
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|flag
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|method
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|dosDate
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|// CRC / Compressed size / Uncompressed size will be filled in later and rewritten later
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* crc 32, unknown */
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
block|{
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|zip64
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0xFFFFFFFF
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* compressed size, unknown */
else|else
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* compressed size, unknown */
block|}
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
block|{
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|zip64
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0xFFFFFFFF
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* uncompressed size, unknown */
else|else
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* uncompressed size, unknown */
block|}
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|size_filename
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|zip64
condition|)
block|{
name|size_extrafield
operator|+=
literal|20
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|size_extrafield
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
operator|&&
operator|(
name|size_filename
operator|>
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|ZWRITE64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|filename
argument_list|,
name|size_filename
argument_list|)
operator|!=
name|size_filename
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
operator|&&
operator|(
name|size_extrafield_local
operator|>
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|ZWRITE64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|extrafield_local
argument_list|,
name|size_extrafield_local
argument_list|)
operator|!=
name|size_extrafield_local
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
operator|&&
operator|(
name|zi
operator|->
name|ci
operator|.
name|zip64
operator|)
condition|)
block|{
comment|// write the Zip64 extended info
name|short
name|HeaderID
init|=
literal|1
decl_stmt|;
name|short
name|DataSize
init|=
literal|16
decl_stmt|;
name|ZPOS64_T
name|CompressedSize
init|=
literal|0
decl_stmt|;
name|ZPOS64_T
name|UncompressedSize
init|=
literal|0
decl_stmt|;
comment|// Remember position of Zip64 extended info for the local file header. (needed when we update size after done with file)
name|zi
operator|->
name|ci
operator|.
name|pos_zip64extrainfo
operator|=
name|ZTELL64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|)
expr_stmt|;
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|short
operator|)
name|HeaderID
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|short
operator|)
name|DataSize
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|ZPOS64_T
operator|)
name|UncompressedSize
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|ZPOS64_T
operator|)
name|CompressedSize
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*  NOTE.  When writing RAW the ZIP64 extended information in extrafield_local and extrafield_global needs to be stripped  before calling this function it can be done with zipRemoveExtraInfoBlock   It is not done here because then we need to realloc a new buffer since parameters are 'const' and I want to minimize  unnecessary allocations.  */
end_comment

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipOpenNewFileInZip4_64
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|zip_fileinfo
modifier|*
name|zipfi
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_local
parameter_list|,
name|uInt
name|size_extrafield_local
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_global
parameter_list|,
name|uInt
name|size_extrafield_global
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|raw
parameter_list|,
name|int
name|windowBits
parameter_list|,
name|int
name|memLevel
parameter_list|,
name|int
name|strategy
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
name|uLong
name|crcForCrypting
parameter_list|,
name|uLong
name|versionMadeBy
parameter_list|,
name|uLong
name|flagBase
parameter_list|,
name|int
name|zip64
parameter_list|)
block|{
name|zip64_internal
modifier|*
name|zi
decl_stmt|;
name|uInt
name|size_filename
decl_stmt|;
name|uInt
name|size_comment
decl_stmt|;
name|uInt
name|i
decl_stmt|;
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
ifdef|#
directive|ifdef
name|NOCRYPT
operator|(
name|crcForCrypting
operator|)
expr_stmt|;
if|if
condition|(
name|password
operator|!=
name|NULL
condition|)
return|return
name|ZIP_PARAMERROR
return|;
endif|#
directive|endif
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|ZIP_PARAMERROR
return|;
ifdef|#
directive|ifdef
name|HAVE_BZIP2
if|if
condition|(
operator|(
name|method
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|method
operator|!=
name|Z_DEFLATED
operator|)
operator|&&
operator|(
name|method
operator|!=
name|Z_BZIP2ED
operator|)
condition|)
return|return
name|ZIP_PARAMERROR
return|;
else|#
directive|else
if|if
condition|(
operator|(
name|method
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|method
operator|!=
name|Z_DEFLATED
operator|)
condition|)
return|return
name|ZIP_PARAMERROR
return|;
endif|#
directive|endif
name|zi
operator|=
operator|(
name|zip64_internal
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
name|zi
operator|->
name|in_opened_file_inzip
operator|==
literal|1
condition|)
block|{
name|err
operator|=
name|zipCloseFileInZip
argument_list|(
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|ZIP_OK
condition|)
return|return
name|err
return|;
block|}
if|if
condition|(
name|filename
operator|==
name|NULL
condition|)
name|filename
operator|=
literal|"-"
expr_stmt|;
if|if
condition|(
name|comment
operator|==
name|NULL
condition|)
name|size_comment
operator|=
literal|0
expr_stmt|;
else|else
name|size_comment
operator|=
operator|(
name|uInt
operator|)
name|strlen
argument_list|(
name|comment
argument_list|)
expr_stmt|;
name|size_filename
operator|=
operator|(
name|uInt
operator|)
name|strlen
argument_list|(
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|zipfi
operator|==
name|NULL
condition|)
name|zi
operator|->
name|ci
operator|.
name|dosDate
operator|=
literal|0
expr_stmt|;
else|else
block|{
if|if
condition|(
name|zipfi
operator|->
name|dosDate
operator|!=
literal|0
condition|)
name|zi
operator|->
name|ci
operator|.
name|dosDate
operator|=
name|zipfi
operator|->
name|dosDate
expr_stmt|;
else|else
name|zi
operator|->
name|ci
operator|.
name|dosDate
operator|=
name|zip64local_TmzDateToDosDate
argument_list|(
operator|&
name|zipfi
operator|->
name|tmz_date
argument_list|)
expr_stmt|;
block|}
name|zi
operator|->
name|ci
operator|.
name|flag
operator|=
name|flagBase
expr_stmt|;
if|if
condition|(
operator|(
name|level
operator|==
literal|8
operator|)
operator|||
operator|(
name|level
operator|==
literal|9
operator|)
condition|)
name|zi
operator|->
name|ci
operator|.
name|flag
operator||=
literal|2
expr_stmt|;
if|if
condition|(
name|level
operator|==
literal|2
condition|)
name|zi
operator|->
name|ci
operator|.
name|flag
operator||=
literal|4
expr_stmt|;
if|if
condition|(
name|level
operator|==
literal|1
condition|)
name|zi
operator|->
name|ci
operator|.
name|flag
operator||=
literal|6
expr_stmt|;
if|if
condition|(
name|password
operator|!=
name|NULL
condition|)
name|zi
operator|->
name|ci
operator|.
name|flag
operator||=
literal|1
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|crc32
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|method
operator|=
name|method
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|encrypt
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream_initialised
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|raw
operator|=
name|raw
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|pos_local_header
operator|=
name|ZTELL64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|)
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|size_centralheader
operator|=
name|SIZECENTRALHEADER
operator|+
name|size_filename
operator|+
name|size_extrafield_global
operator|+
name|size_comment
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|size_centralExtraFree
operator|=
literal|32
expr_stmt|;
comment|// Extra space we have reserved in case we need to add ZIP64 extra info data
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|=
operator|(
name|char
operator|*
operator|)
name|ALLOC
argument_list|(
operator|(
name|uInt
operator|)
name|zi
operator|->
name|ci
operator|.
name|size_centralheader
operator|+
name|zi
operator|->
name|ci
operator|.
name|size_centralExtraFree
argument_list|)
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|size_centralExtra
operator|=
name|size_extrafield_global
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
argument_list|,
operator|(
name|uLong
operator|)
name|CENTRALHEADERMAGIC
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* version info */
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|4
argument_list|,
operator|(
name|uLong
operator|)
name|versionMadeBy
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|6
argument_list|,
operator|(
name|uLong
operator|)
literal|20
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|8
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|flag
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|10
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|method
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|12
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|dosDate
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|16
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*crc*/
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|20
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*compr size*/
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|24
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*uncompr size*/
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|28
argument_list|,
operator|(
name|uLong
operator|)
name|size_filename
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|30
argument_list|,
operator|(
name|uLong
operator|)
name|size_extrafield_global
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|32
argument_list|,
operator|(
name|uLong
operator|)
name|size_comment
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|34
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/*disk nm start*/
if|if
condition|(
name|zipfi
operator|==
name|NULL
condition|)
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|36
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
else|else
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|36
argument_list|,
operator|(
name|uLong
operator|)
name|zipfi
operator|->
name|internal_fa
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|zipfi
operator|==
name|NULL
condition|)
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|38
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|else
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|38
argument_list|,
operator|(
name|uLong
operator|)
name|zipfi
operator|->
name|external_fa
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|pos_local_header
operator|>=
literal|0xffffffff
condition|)
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|42
argument_list|,
operator|(
name|uLong
operator|)
literal|0xffffffff
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|else
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|42
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|pos_local_header
operator|-
name|zi
operator|->
name|add_position_when_writting_offset
argument_list|,
literal|4
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size_filename
condition|;
name|i
operator|++
control|)
operator|*
operator|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
name|SIZECENTRALHEADER
operator|+
name|i
operator|)
operator|=
operator|*
operator|(
name|filename
operator|+
name|i
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size_extrafield_global
condition|;
name|i
operator|++
control|)
operator|*
operator|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
name|SIZECENTRALHEADER
operator|+
name|size_filename
operator|+
name|i
operator|)
operator|=
operator|*
operator|(
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|extrafield_global
operator|)
operator|+
name|i
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size_comment
condition|;
name|i
operator|++
control|)
operator|*
operator|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
name|SIZECENTRALHEADER
operator|+
name|size_filename
operator|+
name|size_extrafield_global
operator|+
name|i
operator|)
operator|=
operator|*
operator|(
name|comment
operator|+
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|==
name|NULL
condition|)
return|return
name|ZIP_INTERNALERROR
return|;
name|zi
operator|->
name|ci
operator|.
name|zip64
operator|=
name|zip64
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|totalCompressedData
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|totalUncompressedData
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|pos_zip64extrainfo
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|Write_LocalFileHeader
argument_list|(
name|zi
argument_list|,
name|filename
argument_list|,
name|size_extrafield_local
argument_list|,
name|extrafield_local
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_BZIP2
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|avail_in
operator|=
operator|(
name|uInt
operator|)
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|avail_out
operator|=
operator|(
name|uInt
operator|)
name|Z_BUFSIZE
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|next_out
operator|=
operator|(
name|char
operator|*
operator|)
name|zi
operator|->
name|ci
operator|.
name|buffered_data
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_in_hi32
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_in_lo32
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_out_hi32
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_out_lo32
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_in
operator|=
operator|(
name|uInt
operator|)
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_out
operator|=
operator|(
name|uInt
operator|)
name|Z_BUFSIZE
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|next_out
operator|=
name|zi
operator|->
name|ci
operator|.
name|buffered_data
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_in
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_out
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|data_type
operator|=
name|Z_BINARY
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_BZIP2
if|if
condition|(
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
operator|&&
operator|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_DEFLATED
operator|||
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_BZIP2ED
operator|)
operator|&&
operator|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
operator|)
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
operator|&&
operator|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_DEFLATED
operator|)
operator|&&
operator|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
operator|)
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_DEFLATED
condition|)
block|{
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|zalloc
operator|=
operator|(
name|alloc_func
operator|)
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|zfree
operator|=
operator|(
name|free_func
operator|)
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|opaque
operator|=
operator|(
name|voidpf
operator|)
literal|0
expr_stmt|;
if|if
condition|(
name|windowBits
operator|>
literal|0
condition|)
name|windowBits
operator|=
operator|-
name|windowBits
expr_stmt|;
name|err
operator|=
name|deflateInit2
argument_list|(
operator|&
name|zi
operator|->
name|ci
operator|.
name|stream
argument_list|,
name|level
argument_list|,
name|Z_DEFLATED
argument_list|,
name|windowBits
argument_list|,
name|memLevel
argument_list|,
name|strategy
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|Z_OK
condition|)
name|zi
operator|->
name|ci
operator|.
name|stream_initialised
operator|=
name|Z_DEFLATED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_BZIP2ED
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_BZIP2
comment|// Init BZip stuff here
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|bzalloc
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|bzfree
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|opaque
operator|=
operator|(
name|voidpf
operator|)
literal|0
expr_stmt|;
name|err
operator|=
name|BZ2_bzCompressInit
argument_list|(
operator|&
name|zi
operator|->
name|ci
operator|.
name|bstream
argument_list|,
name|level
argument_list|,
literal|0
argument_list|,
literal|35
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|BZ_OK
condition|)
name|zi
operator|->
name|ci
operator|.
name|stream_initialised
operator|=
name|Z_BZIP2ED
expr_stmt|;
endif|#
directive|endif
block|}
block|}
ifndef|#
directive|ifndef
name|NOCRYPT
name|zi
operator|->
name|ci
operator|.
name|crypt_header_size
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|==
name|Z_OK
operator|)
operator|&&
operator|(
name|password
operator|!=
name|NULL
operator|)
condition|)
block|{
name|unsigned
name|char
name|bufHead
index|[
name|RAND_HEAD_LEN
index|]
decl_stmt|;
name|unsigned
name|int
name|sizeHead
decl_stmt|;
name|zi
operator|->
name|ci
operator|.
name|encrypt
operator|=
literal|1
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|pcrc_32_tab
operator|=
name|get_crc_table
argument_list|()
expr_stmt|;
comment|/*init_keys(password,zi->ci.keys,zi->ci.pcrc_32_tab);*/
name|sizeHead
operator|=
name|crypthead
argument_list|(
name|password
argument_list|,
name|bufHead
argument_list|,
name|RAND_HEAD_LEN
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|keys
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|pcrc_32_tab
argument_list|,
name|crcForCrypting
argument_list|)
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|crypt_header_size
operator|=
name|sizeHead
expr_stmt|;
if|if
condition|(
name|ZWRITE64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|bufHead
argument_list|,
name|sizeHead
argument_list|)
operator|!=
name|sizeHead
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|err
operator|==
name|Z_OK
condition|)
name|zi
operator|->
name|in_opened_file_inzip
operator|=
literal|1
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipOpenNewFileInZip4
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|zip_fileinfo
modifier|*
name|zipfi
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_local
parameter_list|,
name|uInt
name|size_extrafield_local
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_global
parameter_list|,
name|uInt
name|size_extrafield_global
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|raw
parameter_list|,
name|int
name|windowBits
parameter_list|,
name|int
name|memLevel
parameter_list|,
name|int
name|strategy
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
name|uLong
name|crcForCrypting
parameter_list|,
name|uLong
name|versionMadeBy
parameter_list|,
name|uLong
name|flagBase
parameter_list|)
block|{
return|return
name|zipOpenNewFileInZip4_64
argument_list|(
name|file
argument_list|,
name|filename
argument_list|,
name|zipfi
argument_list|,
name|extrafield_local
argument_list|,
name|size_extrafield_local
argument_list|,
name|extrafield_global
argument_list|,
name|size_extrafield_global
argument_list|,
name|comment
argument_list|,
name|method
argument_list|,
name|level
argument_list|,
name|raw
argument_list|,
name|windowBits
argument_list|,
name|memLevel
argument_list|,
name|strategy
argument_list|,
name|password
argument_list|,
name|crcForCrypting
argument_list|,
name|versionMadeBy
argument_list|,
name|flagBase
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipOpenNewFileInZip3
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|zip_fileinfo
modifier|*
name|zipfi
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_local
parameter_list|,
name|uInt
name|size_extrafield_local
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_global
parameter_list|,
name|uInt
name|size_extrafield_global
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|raw
parameter_list|,
name|int
name|windowBits
parameter_list|,
name|int
name|memLevel
parameter_list|,
name|int
name|strategy
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
name|uLong
name|crcForCrypting
parameter_list|)
block|{
return|return
name|zipOpenNewFileInZip4_64
argument_list|(
name|file
argument_list|,
name|filename
argument_list|,
name|zipfi
argument_list|,
name|extrafield_local
argument_list|,
name|size_extrafield_local
argument_list|,
name|extrafield_global
argument_list|,
name|size_extrafield_global
argument_list|,
name|comment
argument_list|,
name|method
argument_list|,
name|level
argument_list|,
name|raw
argument_list|,
name|windowBits
argument_list|,
name|memLevel
argument_list|,
name|strategy
argument_list|,
name|password
argument_list|,
name|crcForCrypting
argument_list|,
name|VERSIONMADEBY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipOpenNewFileInZip3_64
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|zip_fileinfo
modifier|*
name|zipfi
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_local
parameter_list|,
name|uInt
name|size_extrafield_local
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_global
parameter_list|,
name|uInt
name|size_extrafield_global
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|raw
parameter_list|,
name|int
name|windowBits
parameter_list|,
name|int
name|memLevel
parameter_list|,
name|int
name|strategy
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
name|uLong
name|crcForCrypting
parameter_list|,
name|int
name|zip64
parameter_list|)
block|{
return|return
name|zipOpenNewFileInZip4_64
argument_list|(
name|file
argument_list|,
name|filename
argument_list|,
name|zipfi
argument_list|,
name|extrafield_local
argument_list|,
name|size_extrafield_local
argument_list|,
name|extrafield_global
argument_list|,
name|size_extrafield_global
argument_list|,
name|comment
argument_list|,
name|method
argument_list|,
name|level
argument_list|,
name|raw
argument_list|,
name|windowBits
argument_list|,
name|memLevel
argument_list|,
name|strategy
argument_list|,
name|password
argument_list|,
name|crcForCrypting
argument_list|,
name|VERSIONMADEBY
argument_list|,
literal|0
argument_list|,
name|zip64
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipOpenNewFileInZip2
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|zip_fileinfo
modifier|*
name|zipfi
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_local
parameter_list|,
name|uInt
name|size_extrafield_local
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_global
parameter_list|,
name|uInt
name|size_extrafield_global
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|raw
parameter_list|)
block|{
return|return
name|zipOpenNewFileInZip4_64
argument_list|(
name|file
argument_list|,
name|filename
argument_list|,
name|zipfi
argument_list|,
name|extrafield_local
argument_list|,
name|size_extrafield_local
argument_list|,
name|extrafield_global
argument_list|,
name|size_extrafield_global
argument_list|,
name|comment
argument_list|,
name|method
argument_list|,
name|level
argument_list|,
name|raw
argument_list|,
operator|-
name|MAX_WBITS
argument_list|,
name|DEF_MEM_LEVEL
argument_list|,
name|Z_DEFAULT_STRATEGY
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|VERSIONMADEBY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipOpenNewFileInZip2_64
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|zip_fileinfo
modifier|*
name|zipfi
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_local
parameter_list|,
name|uInt
name|size_extrafield_local
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_global
parameter_list|,
name|uInt
name|size_extrafield_global
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|raw
parameter_list|,
name|int
name|zip64
parameter_list|)
block|{
return|return
name|zipOpenNewFileInZip4_64
argument_list|(
name|file
argument_list|,
name|filename
argument_list|,
name|zipfi
argument_list|,
name|extrafield_local
argument_list|,
name|size_extrafield_local
argument_list|,
name|extrafield_global
argument_list|,
name|size_extrafield_global
argument_list|,
name|comment
argument_list|,
name|method
argument_list|,
name|level
argument_list|,
name|raw
argument_list|,
operator|-
name|MAX_WBITS
argument_list|,
name|DEF_MEM_LEVEL
argument_list|,
name|Z_DEFAULT_STRATEGY
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|VERSIONMADEBY
argument_list|,
literal|0
argument_list|,
name|zip64
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipOpenNewFileInZip64
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|zip_fileinfo
modifier|*
name|zipfi
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_local
parameter_list|,
name|uInt
name|size_extrafield_local
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_global
parameter_list|,
name|uInt
name|size_extrafield_global
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|zip64
parameter_list|)
block|{
return|return
name|zipOpenNewFileInZip4_64
argument_list|(
name|file
argument_list|,
name|filename
argument_list|,
name|zipfi
argument_list|,
name|extrafield_local
argument_list|,
name|size_extrafield_local
argument_list|,
name|extrafield_global
argument_list|,
name|size_extrafield_global
argument_list|,
name|comment
argument_list|,
name|method
argument_list|,
name|level
argument_list|,
literal|0
argument_list|,
operator|-
name|MAX_WBITS
argument_list|,
name|DEF_MEM_LEVEL
argument_list|,
name|Z_DEFAULT_STRATEGY
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|VERSIONMADEBY
argument_list|,
literal|0
argument_list|,
name|zip64
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipOpenNewFileInZip
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|zip_fileinfo
modifier|*
name|zipfi
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_local
parameter_list|,
name|uInt
name|size_extrafield_local
parameter_list|,
specifier|const
name|void
modifier|*
name|extrafield_global
parameter_list|,
name|uInt
name|size_extrafield_global
parameter_list|,
specifier|const
name|char
modifier|*
name|comment
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|level
parameter_list|)
block|{
return|return
name|zipOpenNewFileInZip4_64
argument_list|(
name|file
argument_list|,
name|filename
argument_list|,
name|zipfi
argument_list|,
name|extrafield_local
argument_list|,
name|size_extrafield_local
argument_list|,
name|extrafield_global
argument_list|,
name|size_extrafield_global
argument_list|,
name|comment
argument_list|,
name|method
argument_list|,
name|level
argument_list|,
literal|0
argument_list|,
operator|-
name|MAX_WBITS
argument_list|,
name|DEF_MEM_LEVEL
argument_list|,
name|Z_DEFAULT_STRATEGY
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|VERSIONMADEBY
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|local
name|int
name|zip64FlushWriteBuffer
parameter_list|(
name|zip64_internal
modifier|*
name|zi
parameter_list|)
block|{
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|encrypt
operator|!=
literal|0
condition|)
block|{
ifndef|#
directive|ifndef
name|NOCRYPT
name|uInt
name|i
decl_stmt|;
name|int
name|t
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
condition|;
name|i
operator|++
control|)
name|zi
operator|->
name|ci
operator|.
name|buffered_data
index|[
name|i
index|]
operator|=
name|zencode
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|keys
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|pcrc_32_tab
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|buffered_data
index|[
name|i
index|]
argument_list|,
name|t
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|ZWRITE64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|buffered_data
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
argument_list|)
operator|!=
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|totalCompressedData
operator|+=
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_BZIP2
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_BZIP2ED
condition|)
block|{
name|zi
operator|->
name|ci
operator|.
name|totalUncompressedData
operator|+=
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_in_lo32
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_in_lo32
operator|=
literal|0
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_in_hi32
operator|=
literal|0
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|zi
operator|->
name|ci
operator|.
name|totalUncompressedData
operator|+=
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_in
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_in
operator|=
literal|0
expr_stmt|;
block|}
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
operator|=
literal|0
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipWriteInFileInZip
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|)
block|{
name|zip64_internal
modifier|*
name|zi
decl_stmt|;
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|ZIP_PARAMERROR
return|;
name|zi
operator|=
operator|(
name|zip64_internal
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
name|zi
operator|->
name|in_opened_file_inzip
operator|==
literal|0
condition|)
return|return
name|ZIP_PARAMERROR
return|;
name|zi
operator|->
name|ci
operator|.
name|crc32
operator|=
name|crc32
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|crc32
argument_list|,
name|buf
argument_list|,
operator|(
name|uInt
operator|)
name|len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_BZIP2
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_BZIP2ED
operator|&&
operator|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
operator|)
condition|)
block|{
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|next_in
operator|=
operator|(
name|void
operator|*
operator|)
name|buf
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|avail_in
operator|=
name|len
expr_stmt|;
name|err
operator|=
name|BZ_RUN_OK
expr_stmt|;
while|while
condition|(
operator|(
name|err
operator|==
name|BZ_RUN_OK
operator|)
operator|&&
operator|(
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|avail_in
operator|>
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|avail_out
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|zip64FlushWriteBuffer
argument_list|(
name|zi
argument_list|)
operator|==
name|ZIP_ERRNO
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|avail_out
operator|=
operator|(
name|uInt
operator|)
name|Z_BUFSIZE
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|next_out
operator|=
operator|(
name|char
operator|*
operator|)
name|zi
operator|->
name|ci
operator|.
name|buffered_data
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|!=
name|BZ_RUN_OK
condition|)
break|break;
if|if
condition|(
operator|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_BZIP2ED
operator|)
operator|&&
operator|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
operator|)
condition|)
block|{
name|uLong
name|uTotalOutBefore_lo
init|=
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_out_lo32
decl_stmt|;
comment|//          uLong uTotalOutBefore_hi = zi->ci.bstream.total_out_hi32;
name|err
operator|=
name|BZ2_bzCompress
argument_list|(
operator|&
name|zi
operator|->
name|ci
operator|.
name|bstream
argument_list|,
name|BZ_RUN
argument_list|)
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
operator|+=
call|(
name|uInt
call|)
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_out_lo32
operator|-
name|uTotalOutBefore_lo
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|err
operator|==
name|BZ_RUN_OK
condition|)
name|err
operator|=
name|ZIP_OK
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|next_in
operator|=
operator|(
name|Bytef
operator|*
operator|)
name|buf
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_in
operator|=
name|len
expr_stmt|;
while|while
condition|(
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
operator|&&
operator|(
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_in
operator|>
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_out
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|zip64FlushWriteBuffer
argument_list|(
name|zi
argument_list|)
operator|==
name|ZIP_ERRNO
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_out
operator|=
operator|(
name|uInt
operator|)
name|Z_BUFSIZE
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|next_out
operator|=
name|zi
operator|->
name|ci
operator|.
name|buffered_data
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|!=
name|ZIP_OK
condition|)
break|break;
if|if
condition|(
operator|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_DEFLATED
operator|)
operator|&&
operator|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
operator|)
condition|)
block|{
name|uLong
name|uTotalOutBefore
init|=
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_out
decl_stmt|;
name|err
operator|=
name|deflate
argument_list|(
operator|&
name|zi
operator|->
name|ci
operator|.
name|stream
argument_list|,
name|Z_NO_FLUSH
argument_list|)
expr_stmt|;
if|if
condition|(
name|uTotalOutBefore
operator|>
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_out
condition|)
block|{
name|int
name|bBreak
init|=
literal|0
decl_stmt|;
name|bBreak
operator|++
expr_stmt|;
block|}
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
operator|+=
call|(
name|uInt
call|)
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_out
operator|-
name|uTotalOutBefore
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uInt
name|copy_this
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_in
operator|<
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_out
condition|)
name|copy_this
operator|=
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_in
expr_stmt|;
else|else
name|copy_this
operator|=
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_out
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|copy_this
condition|;
name|i
operator|++
control|)
operator|*
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|next_out
operator|)
operator|+
name|i
operator|)
operator|=
operator|*
operator|(
operator|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|next_in
operator|)
operator|+
name|i
operator|)
expr_stmt|;
block|{
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_in
operator|-=
name|copy_this
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_out
operator|-=
name|copy_this
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|next_in
operator|+=
name|copy_this
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|next_out
operator|+=
name|copy_this
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_in
operator|+=
name|copy_this
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_out
operator|+=
name|copy_this
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
operator|+=
name|copy_this
expr_stmt|;
block|}
block|}
block|}
comment|// while(...)
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipCloseFileInZipRaw
parameter_list|(
name|zipFile
name|file
parameter_list|,
name|uLong
name|uncompressed_size
parameter_list|,
name|uLong
name|crc32
parameter_list|)
block|{
return|return
name|zipCloseFileInZipRaw64
argument_list|(
name|file
argument_list|,
name|uncompressed_size
argument_list|,
name|crc32
argument_list|)
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipCloseFileInZipRaw64
parameter_list|(
name|zipFile
name|file
parameter_list|,
name|ZPOS64_T
name|uncompressed_size
parameter_list|,
name|uLong
name|crc32
parameter_list|)
block|{
name|zip64_internal
modifier|*
name|zi
decl_stmt|;
name|ZPOS64_T
name|compressed_size
decl_stmt|;
name|uLong
name|invalidValue
init|=
literal|0xffffffff
decl_stmt|;
name|short
name|datasize
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|ZIP_PARAMERROR
return|;
name|zi
operator|=
operator|(
name|zip64_internal
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
name|zi
operator|->
name|in_opened_file_inzip
operator|==
literal|0
condition|)
return|return
name|ZIP_PARAMERROR
return|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_in
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_DEFLATED
operator|)
operator|&&
operator|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
operator|)
condition|)
block|{
while|while
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
block|{
name|uLong
name|uTotalOutBefore
decl_stmt|;
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_out
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|zip64FlushWriteBuffer
argument_list|(
name|zi
argument_list|)
operator|==
name|ZIP_ERRNO
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|avail_out
operator|=
operator|(
name|uInt
operator|)
name|Z_BUFSIZE
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|next_out
operator|=
name|zi
operator|->
name|ci
operator|.
name|buffered_data
expr_stmt|;
block|}
name|uTotalOutBefore
operator|=
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_out
expr_stmt|;
name|err
operator|=
name|deflate
argument_list|(
operator|&
name|zi
operator|->
name|ci
operator|.
name|stream
argument_list|,
name|Z_FINISH
argument_list|)
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
operator|+=
call|(
name|uInt
call|)
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|total_out
operator|-
name|uTotalOutBefore
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_BZIP2ED
operator|)
operator|&&
operator|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_BZIP2
name|err
operator|=
name|BZ_FINISH_OK
expr_stmt|;
while|while
condition|(
name|err
operator|==
name|BZ_FINISH_OK
condition|)
block|{
name|uLong
name|uTotalOutBefore
decl_stmt|;
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|avail_out
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|zip64FlushWriteBuffer
argument_list|(
name|zi
argument_list|)
operator|==
name|ZIP_ERRNO
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|avail_out
operator|=
operator|(
name|uInt
operator|)
name|Z_BUFSIZE
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|next_out
operator|=
operator|(
name|char
operator|*
operator|)
name|zi
operator|->
name|ci
operator|.
name|buffered_data
expr_stmt|;
block|}
name|uTotalOutBefore
operator|=
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_out_lo32
expr_stmt|;
name|err
operator|=
name|BZ2_bzCompress
argument_list|(
operator|&
name|zi
operator|->
name|ci
operator|.
name|bstream
argument_list|,
name|BZ_FINISH
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|BZ_STREAM_END
condition|)
name|err
operator|=
name|Z_STREAM_END
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
operator|+=
call|(
name|uInt
call|)
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|bstream
operator|.
name|total_out_lo32
operator|-
name|uTotalOutBefore
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|==
name|BZ_FINISH_OK
condition|)
name|err
operator|=
name|ZIP_OK
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|err
operator|==
name|Z_STREAM_END
condition|)
name|err
operator|=
name|ZIP_OK
expr_stmt|;
comment|/* this is normal */
if|if
condition|(
operator|(
name|zi
operator|->
name|ci
operator|.
name|pos_in_buffered_data
operator|>
literal|0
operator|)
operator|&&
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
condition|)
block|{
if|if
condition|(
name|zip64FlushWriteBuffer
argument_list|(
name|zi
argument_list|)
operator|==
name|ZIP_ERRNO
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_DEFLATED
operator|)
operator|&&
operator|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
operator|)
condition|)
block|{
name|int
name|tmp_err
init|=
name|deflateEnd
argument_list|(
operator|&
name|zi
operator|->
name|ci
operator|.
name|stream
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|tmp_err
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream_initialised
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|HAVE_BZIP2
elseif|else
if|if
condition|(
operator|(
name|zi
operator|->
name|ci
operator|.
name|method
operator|==
name|Z_BZIP2ED
operator|)
operator|&&
operator|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
operator|)
condition|)
block|{
name|int
name|tmperr
init|=
name|BZ2_bzCompressEnd
argument_list|(
operator|&
name|zi
operator|->
name|ci
operator|.
name|bstream
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|tmperr
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|stream_initialised
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|zi
operator|->
name|ci
operator|.
name|raw
condition|)
block|{
name|crc32
operator|=
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|crc32
expr_stmt|;
name|uncompressed_size
operator|=
name|zi
operator|->
name|ci
operator|.
name|totalUncompressedData
expr_stmt|;
block|}
name|compressed_size
operator|=
name|zi
operator|->
name|ci
operator|.
name|totalCompressedData
expr_stmt|;
ifndef|#
directive|ifndef
name|NOCRYPT
name|compressed_size
operator|+=
name|zi
operator|->
name|ci
operator|.
name|crypt_header_size
expr_stmt|;
endif|#
directive|endif
comment|// update Current Item crc and sizes,
if|if
condition|(
name|compressed_size
operator|>=
literal|0xffffffff
operator|||
name|uncompressed_size
operator|>=
literal|0xffffffff
operator|||
name|zi
operator|->
name|ci
operator|.
name|pos_local_header
operator|>=
literal|0xffffffff
condition|)
block|{
comment|/*version Made by*/
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|4
argument_list|,
operator|(
name|uLong
operator|)
literal|45
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/*version needed*/
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|6
argument_list|,
operator|(
name|uLong
operator|)
literal|45
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|16
argument_list|,
name|crc32
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*crc*/
if|if
condition|(
name|compressed_size
operator|>=
literal|0xffffffff
condition|)
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|20
argument_list|,
name|invalidValue
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*compr size*/
else|else
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|20
argument_list|,
name|compressed_size
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*compr size*/
comment|/// set internal file attributes field
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|stream
operator|.
name|data_type
operator|==
name|Z_ASCII
condition|)
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|36
argument_list|,
operator|(
name|uLong
operator|)
name|Z_ASCII
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|uncompressed_size
operator|>=
literal|0xffffffff
condition|)
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|24
argument_list|,
name|invalidValue
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*uncompr size*/
else|else
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|24
argument_list|,
name|uncompressed_size
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*uncompr size*/
comment|// Add ZIP64 extra info field for uncompressed size
if|if
condition|(
name|uncompressed_size
operator|>=
literal|0xffffffff
condition|)
name|datasize
operator|+=
literal|8
expr_stmt|;
comment|// Add ZIP64 extra info field for compressed size
if|if
condition|(
name|compressed_size
operator|>=
literal|0xffffffff
condition|)
name|datasize
operator|+=
literal|8
expr_stmt|;
comment|// Add ZIP64 extra info field for relative offset to local file header of current file
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|pos_local_header
operator|>=
literal|0xffffffff
condition|)
name|datasize
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|datasize
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
if|if
condition|(
call|(
name|uLong
call|)
argument_list|(
name|datasize
operator|+
literal|4
argument_list|)
operator|>
name|zi
operator|->
name|ci
operator|.
name|size_centralExtraFree
condition|)
block|{
comment|// we can not write more data to the buffer that we have room for.
return|return
name|ZIP_BADZIPFILE
return|;
block|}
name|p
operator|=
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
name|zi
operator|->
name|ci
operator|.
name|size_centralheader
expr_stmt|;
comment|// Add Extra Information Header for 'ZIP64 information'
name|zip64local_putValue_inmemory
argument_list|(
name|p
argument_list|,
literal|0x0001
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// HeaderID
name|p
operator|+=
literal|2
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|p
argument_list|,
name|datasize
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// DataSize
name|p
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|uncompressed_size
operator|>=
literal|0xffffffff
condition|)
block|{
name|zip64local_putValue_inmemory
argument_list|(
name|p
argument_list|,
name|uncompressed_size
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|compressed_size
operator|>=
literal|0xffffffff
condition|)
block|{
name|zip64local_putValue_inmemory
argument_list|(
name|p
argument_list|,
name|compressed_size
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|pos_local_header
operator|>=
literal|0xffffffff
condition|)
block|{
name|zip64local_putValue_inmemory
argument_list|(
name|p
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|pos_local_header
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|8
expr_stmt|;
block|}
comment|// Update how much extra free space we got in the memory buffer
comment|// and increase the centralheader size so the new ZIP64 fields are included
comment|// ( 4 below is the size of HeaderID and DataSize field )
name|zi
operator|->
name|ci
operator|.
name|size_centralExtraFree
operator|-=
name|datasize
operator|+
literal|4
expr_stmt|;
name|zi
operator|->
name|ci
operator|.
name|size_centralheader
operator|+=
name|datasize
operator|+
literal|4
expr_stmt|;
comment|// Update the extra info size field
name|zi
operator|->
name|ci
operator|.
name|size_centralExtra
operator|+=
name|datasize
operator|+
literal|4
expr_stmt|;
name|zip64local_putValue_inmemory
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
operator|+
literal|30
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|size_centralExtra
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|add_data_in_datablock
argument_list|(
operator|&
name|zi
operator|->
name|central_dir
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|central_header
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|ci
operator|.
name|size_centralheader
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|zi
operator|->
name|ci
operator|.
name|central_header
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
block|{
comment|// Update the LocalFileHeader with the new values.
name|ZPOS64_T
name|cur_pos_inzip
init|=
name|ZTELL64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSEEK64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|pos_local_header
operator|+
literal|14
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|crc32
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* crc 32, unknown */
if|if
condition|(
name|uncompressed_size
operator|>=
literal|0xffffffff
operator|||
name|compressed_size
operator|>=
literal|0xffffffff
condition|)
block|{
if|if
condition|(
name|zi
operator|->
name|ci
operator|.
name|pos_zip64extrainfo
operator|>
literal|0
condition|)
block|{
comment|// Update the size in the ZIP64 extended field.
if|if
condition|(
name|ZSEEK64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|zi
operator|->
name|ci
operator|.
name|pos_zip64extrainfo
operator|+
literal|4
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* compressed size, unknown */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|uncompressed_size
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* uncompressed size, unknown */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|compressed_size
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
name|err
operator|=
name|ZIP_BADZIPFILE
expr_stmt|;
comment|// Caller passed zip64 = 0, so no room for zip64 info -> fatal
block|}
else|else
block|{
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* compressed size, unknown */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|compressed_size
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* uncompressed size, unknown */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|uncompressed_size
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ZSEEK64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|cur_pos_inzip
argument_list|,
name|ZLIB_FILEFUNC_SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
block|}
name|zi
operator|->
name|number_entry
operator|++
expr_stmt|;
name|zi
operator|->
name|in_opened_file_inzip
operator|=
literal|0
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipCloseFileInZip
parameter_list|(
name|zipFile
name|file
parameter_list|)
block|{
return|return
name|zipCloseFileInZipRaw
argument_list|(
name|file
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|Write_Zip64EndOfCentralDirectoryLocator
parameter_list|(
name|zip64_internal
modifier|*
name|zi
parameter_list|,
name|ZPOS64_T
name|zip64eocd_pos_inzip
parameter_list|)
block|{
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
name|ZPOS64_T
name|pos
init|=
name|zip64eocd_pos_inzip
operator|-
name|zi
operator|->
name|add_position_when_writting_offset
decl_stmt|;
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|ZIP64ENDLOCHEADERMAGIC
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*num disks*/
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* number of the disk with the start of the central directory */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*relative offset*/
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* Relative offset to the Zip64EndOfCentralDirectory */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|pos
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/*total disks*/
comment|/* Do not support spawning of disk so always say 1 here*/
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* number of the disk with the start of the central directory */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|1
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|Write_Zip64EndOfCentralDirectoryRecord
parameter_list|(
name|zip64_internal
modifier|*
name|zi
parameter_list|,
name|uLong
name|size_centraldir
parameter_list|,
name|ZPOS64_T
name|centraldir_pos_inzip
parameter_list|)
block|{
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
name|uLong
name|Zip64DataSize
init|=
literal|44
decl_stmt|;
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|ZIP64ENDHEADERMAGIC
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* size of this 'zip64 end of central directory' */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|ZPOS64_T
operator|)
name|Zip64DataSize
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|// why ZPOS64_T of this ?
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* version made by */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|45
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* version needed */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|45
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* number of this disk */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* number of the disk with the start of the central directory */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* total number of entries in the central dir on this disk */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|zi
operator|->
name|number_entry
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* total number of entries in the central dir */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|zi
operator|->
name|number_entry
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* size of the central directory */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|ZPOS64_T
operator|)
name|size_centraldir
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* offset of start of central directory with respect to the starting disk number */
block|{
name|ZPOS64_T
name|pos
init|=
name|centraldir_pos_inzip
operator|-
name|zi
operator|->
name|add_position_when_writting_offset
decl_stmt|;
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|ZPOS64_T
operator|)
name|pos
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|Write_EndOfCentralDirectoryRecord
parameter_list|(
name|zip64_internal
modifier|*
name|zi
parameter_list|,
name|uLong
name|size_centraldir
parameter_list|,
name|ZPOS64_T
name|centraldir_pos_inzip
parameter_list|)
block|{
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
comment|/*signature*/
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|ENDHEADERMAGIC
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* number of this disk */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* number of the disk with the start of the central directory */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* total number of entries in the central dir on this disk */
block|{
block|{
if|if
condition|(
name|zi
operator|->
name|number_entry
operator|>=
literal|0xFFFF
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0xffff
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// use value in ZIP64 record
else|else
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|number_entry
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* total number of entries in the central dir */
block|{
if|if
condition|(
name|zi
operator|->
name|number_entry
operator|>=
literal|0xFFFF
condition|)
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0xffff
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// use value in ZIP64 record
else|else
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|zi
operator|->
name|number_entry
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* size of the central directory */
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|size_centraldir
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
comment|/* offset of start of central directory with respect to the starting disk number */
block|{
name|ZPOS64_T
name|pos
init|=
name|centraldir_pos_inzip
operator|-
name|zi
operator|->
name|add_position_when_writting_offset
decl_stmt|;
if|if
condition|(
name|pos
operator|>=
literal|0xffffffff
condition|)
block|{
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
literal|0xffffffff
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
call|(
name|uLong
call|)
argument_list|(
name|centraldir_pos_inzip
operator|-
name|zi
operator|->
name|add_position_when_writting_offset
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|Write_GlobalComment
parameter_list|(
name|zip64_internal
modifier|*
name|zi
parameter_list|,
specifier|const
name|char
modifier|*
name|global_comment
parameter_list|)
block|{
name|int
name|err
init|=
name|ZIP_OK
decl_stmt|;
name|uInt
name|size_global_comment
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|global_comment
operator|!=
name|NULL
condition|)
name|size_global_comment
operator|=
operator|(
name|uInt
operator|)
name|strlen
argument_list|(
name|global_comment
argument_list|)
expr_stmt|;
name|err
operator|=
name|zip64local_putValue
argument_list|(
operator|&
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
operator|(
name|uLong
operator|)
name|size_global_comment
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
operator|&&
name|size_global_comment
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|ZWRITE64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|global_comment
argument_list|,
name|size_global_comment
argument_list|)
operator|!=
name|size_global_comment
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipClose
parameter_list|(
name|zipFile
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|global_comment
parameter_list|)
block|{
name|zip64_internal
modifier|*
name|zi
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|uLong
name|size_centraldir
init|=
literal|0
decl_stmt|;
name|ZPOS64_T
name|centraldir_pos_inzip
decl_stmt|;
name|ZPOS64_T
name|pos
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
return|return
name|ZIP_PARAMERROR
return|;
name|zi
operator|=
operator|(
name|zip64_internal
operator|*
operator|)
name|file
expr_stmt|;
if|if
condition|(
name|zi
operator|->
name|in_opened_file_inzip
operator|==
literal|1
condition|)
block|{
name|err
operator|=
name|zipCloseFileInZip
argument_list|(
name|file
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|NO_ADDFILEINEXISTINGZIP
if|if
condition|(
name|global_comment
operator|==
name|NULL
condition|)
name|global_comment
operator|=
name|zi
operator|->
name|globalcomment
expr_stmt|;
endif|#
directive|endif
name|centraldir_pos_inzip
operator|=
name|ZTELL64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
block|{
name|linkedlist_datablock_internal
modifier|*
name|ldi
init|=
name|zi
operator|->
name|central_dir
operator|.
name|first_block
decl_stmt|;
while|while
condition|(
name|ldi
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|err
operator|==
name|ZIP_OK
operator|)
operator|&&
operator|(
name|ldi
operator|->
name|filled_in_this_block
operator|>
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|ZWRITE64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|,
name|ldi
operator|->
name|data
argument_list|,
name|ldi
operator|->
name|filled_in_this_block
argument_list|)
operator|!=
name|ldi
operator|->
name|filled_in_this_block
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
block|}
name|size_centraldir
operator|+=
name|ldi
operator|->
name|filled_in_this_block
expr_stmt|;
name|ldi
operator|=
name|ldi
operator|->
name|next_datablock
expr_stmt|;
block|}
block|}
name|free_linkedlist
argument_list|(
operator|&
operator|(
name|zi
operator|->
name|central_dir
operator|)
argument_list|)
expr_stmt|;
name|pos
operator|=
name|centraldir_pos_inzip
operator|-
name|zi
operator|->
name|add_position_when_writting_offset
expr_stmt|;
if|if
condition|(
name|pos
operator|>=
literal|0xffffffff
operator|||
name|zi
operator|->
name|number_entry
operator|>
literal|0xFFFF
condition|)
block|{
name|ZPOS64_T
name|Zip64EOCDpos
init|=
name|ZTELL64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|)
decl_stmt|;
name|Write_Zip64EndOfCentralDirectoryRecord
argument_list|(
name|zi
argument_list|,
name|size_centraldir
argument_list|,
name|centraldir_pos_inzip
argument_list|)
expr_stmt|;
name|Write_Zip64EndOfCentralDirectoryLocator
argument_list|(
name|zi
argument_list|,
name|Zip64EOCDpos
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|Write_EndOfCentralDirectoryRecord
argument_list|(
name|zi
argument_list|,
name|size_centraldir
argument_list|,
name|centraldir_pos_inzip
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|Write_GlobalComment
argument_list|(
name|zi
argument_list|,
name|global_comment
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZCLOSE64
argument_list|(
name|zi
operator|->
name|z_filefunc
argument_list|,
name|zi
operator|->
name|filestream
argument_list|)
operator|!=
literal|0
condition|)
if|if
condition|(
name|err
operator|==
name|ZIP_OK
condition|)
name|err
operator|=
name|ZIP_ERRNO
expr_stmt|;
ifndef|#
directive|ifndef
name|NO_ADDFILEINEXISTINGZIP
name|TRYFREE
argument_list|(
name|zi
operator|->
name|globalcomment
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TRYFREE
argument_list|(
name|zi
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|extern
name|int
name|ZEXPORT
name|zipRemoveExtraInfoBlock
parameter_list|(
name|char
modifier|*
name|pData
parameter_list|,
name|int
modifier|*
name|dataLen
parameter_list|,
name|short
name|sHeader
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|pData
decl_stmt|;
name|int
name|size
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pNewHeader
decl_stmt|;
name|char
modifier|*
name|pTmp
decl_stmt|;
name|short
name|header
decl_stmt|;
name|short
name|dataSize
decl_stmt|;
name|int
name|retVal
init|=
name|ZIP_OK
decl_stmt|;
if|if
condition|(
name|pData
operator|==
name|NULL
operator|||
operator|*
name|dataLen
operator|<
literal|4
condition|)
return|return
name|ZIP_PARAMERROR
return|;
name|pNewHeader
operator|=
operator|(
name|char
operator|*
operator|)
name|ALLOC
argument_list|(
operator|*
name|dataLen
argument_list|)
expr_stmt|;
name|pTmp
operator|=
name|pNewHeader
expr_stmt|;
while|while
condition|(
name|p
operator|<
operator|(
name|pData
operator|+
operator|*
name|dataLen
operator|)
condition|)
block|{
name|header
operator|=
operator|*
operator|(
name|short
operator|*
operator|)
name|p
expr_stmt|;
name|dataSize
operator|=
operator|*
operator|(
operator|(
operator|(
name|short
operator|*
operator|)
name|p
operator|)
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|header
operator|==
name|sHeader
condition|)
comment|// Header found.
block|{
name|p
operator|+=
name|dataSize
operator|+
literal|4
expr_stmt|;
comment|// skip it. do not copy to temp buffer
block|}
else|else
block|{
comment|// Extra Info block should not be removed, So copy it to the temp buffer.
name|memcpy
argument_list|(
name|pTmp
argument_list|,
name|p
argument_list|,
name|dataSize
operator|+
literal|4
argument_list|)
expr_stmt|;
name|p
operator|+=
name|dataSize
operator|+
literal|4
expr_stmt|;
name|size
operator|+=
name|dataSize
operator|+
literal|4
expr_stmt|;
block|}
block|}
if|if
condition|(
name|size
operator|<
operator|*
name|dataLen
condition|)
block|{
comment|// clean old extra info block.
name|memset
argument_list|(
name|pData
argument_list|,
literal|0
argument_list|,
operator|*
name|dataLen
argument_list|)
expr_stmt|;
comment|// copy the new extra info block over the old
if|if
condition|(
name|size
operator|>
literal|0
condition|)
name|memcpy
argument_list|(
name|pData
argument_list|,
name|pNewHeader
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|// set the new extra info size
operator|*
name|dataLen
operator|=
name|size
expr_stmt|;
name|retVal
operator|=
name|ZIP_OK
expr_stmt|;
block|}
else|else
name|retVal
operator|=
name|ZIP_ERRNO
expr_stmt|;
name|TRYFREE
argument_list|(
name|pNewHeader
argument_list|)
expr_stmt|;
return|return
name|retVal
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * dnssec.c  *  * contains the cryptographic function needed for DNSSEC in ldns  * The crypto library used is openssl  *  * (c) NLnet Labs, 2004-2008  *  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<ldns/dnssec.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/md5.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|ldns_rr
modifier|*
name|ldns_dnssec_get_rrsig_for_name_and_type
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|,
specifier|const
name|ldns_rr_type
name|type
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|rrs
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|ldns_rr
modifier|*
name|candidate
decl_stmt|;
if|if
condition|(
operator|!
name|name
operator|||
operator|!
name|rrs
condition|)
block|{
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|candidate
operator|=
name|ldns_rr_list_rr
argument_list|(
name|rrs
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|candidate
argument_list|)
operator|==
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|candidate
argument_list|)
argument_list|,
name|name
argument_list|)
operator|==
literal|0
operator|&&
name|ldns_rdf2rr_type
argument_list|(
name|ldns_rr_rrsig_typecovered
argument_list|(
name|candidate
argument_list|)
argument_list|)
operator|==
name|type
condition|)
block|{
return|return
name|candidate
return|;
block|}
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|ldns_rr
modifier|*
name|ldns_dnssec_get_dnskey_for_rrsig
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|rrsig
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|rrs
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|ldns_rr
modifier|*
name|candidate
decl_stmt|;
if|if
condition|(
operator|!
name|rrsig
operator|||
operator|!
name|rrs
condition|)
block|{
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|candidate
operator|=
name|ldns_rr_list_rr
argument_list|(
name|rrs
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|candidate
argument_list|)
operator|==
name|LDNS_RR_TYPE_DNSKEY
condition|)
block|{
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|candidate
argument_list|)
argument_list|,
name|ldns_rr_rrsig_signame
argument_list|(
name|rrsig
argument_list|)
argument_list|)
operator|==
literal|0
operator|&&
name|ldns_rdf2native_int16
argument_list|(
name|ldns_rr_rrsig_keytag
argument_list|(
name|rrsig
argument_list|)
argument_list|)
operator|==
name|ldns_calc_keytag
argument_list|(
name|candidate
argument_list|)
condition|)
block|{
return|return
name|candidate
return|;
block|}
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_nsec_get_bitmap
parameter_list|(
name|ldns_rr
modifier|*
name|nsec
parameter_list|)
block|{
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|nsec
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC
condition|)
block|{
return|return
name|ldns_rr_rdf
argument_list|(
name|nsec
argument_list|,
literal|1
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|nsec
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
return|return
name|ldns_rr_rdf
argument_list|(
name|nsec
argument_list|,
literal|5
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_comment
comment|/*return the owner name of the closest encloser for name from the list of rrs */
end_comment

begin_comment
comment|/* this is NOT the hash, but the original name! */
end_comment

begin_decl_stmt
name|ldns_rdf
modifier|*
name|ldns_dnssec_nsec3_closest_encloser
argument_list|(
name|ldns_rdf
operator|*
name|qname
argument_list|,
name|ATTR_UNUSED
argument_list|(
argument|ldns_rr_type qtype
argument_list|)
argument_list|,
name|ldns_rr_list
operator|*
name|nsec3s
argument_list|)
block|{
comment|/* remember parameters, they must match */
name|uint8_t
name|algorithm
decl_stmt|;
name|uint32_t
name|iterations
decl_stmt|;
name|uint8_t
name|salt_length
decl_stmt|;
name|uint8_t
modifier|*
name|salt
decl_stmt|;
name|ldns_rdf
modifier|*
name|sname
decl_stmt|,
modifier|*
name|hashed_sname
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|bool
name|flag
decl_stmt|;
name|bool
name|exact_match_found
decl_stmt|;
name|bool
name|in_range_found
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|ldns_rdf
modifier|*
name|zone_name
decl_stmt|;
name|size_t
name|nsec_i
decl_stmt|;
name|ldns_rr
modifier|*
name|nsec
decl_stmt|;
name|ldns_rdf
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|qname
operator|||
operator|!
name|nsec3s
operator|||
name|ldns_rr_list_rr_count
argument_list|(
name|nsec3s
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|nsec
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsec3s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|algorithm
operator|=
name|ldns_nsec3_algorithm
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|salt_length
operator|=
name|ldns_nsec3_salt_length
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|salt
operator|=
name|ldns_nsec3_salt_data
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|iterations
operator|=
name|ldns_nsec3_iterations
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|sname
operator|=
name|ldns_rdf_clone
argument_list|(
name|qname
argument_list|)
expr_stmt|;
name|flag
operator|=
name|false
expr_stmt|;
name|zone_name
operator|=
name|ldns_dname_left_chop
argument_list|(
name|ldns_rr_owner
argument_list|(
name|nsec
argument_list|)
argument_list|)
expr_stmt|;
comment|/* algorithm from nsec3-07 8.3 */
while|while
condition|(
name|ldns_dname_label_count
argument_list|(
name|sname
argument_list|)
operator|>
literal|0
condition|)
block|{
name|exact_match_found
operator|=
name|false
expr_stmt|;
name|in_range_found
operator|=
name|false
expr_stmt|;
name|hashed_sname
operator|=
name|ldns_nsec3_hash_name
argument_list|(
name|sname
argument_list|,
name|algorithm
argument_list|,
name|iterations
argument_list|,
name|salt_length
argument_list|,
name|salt
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_dname_cat
argument_list|(
name|hashed_sname
argument_list|,
name|zone_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|salt
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|zone_name
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|sname
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|nsec_i
operator|=
literal|0
init|;
name|nsec_i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsec3s
argument_list|)
condition|;
name|nsec_i
operator|++
control|)
block|{
name|nsec
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsec3s
argument_list|,
name|nsec_i
argument_list|)
expr_stmt|;
comment|/* check values of iterations etc! */
comment|/* exact match? */
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|nsec
argument_list|)
argument_list|,
name|hashed_sname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|exact_match_found
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ldns_nsec_covers_name
argument_list|(
name|nsec
argument_list|,
name|hashed_sname
argument_list|)
condition|)
block|{
name|in_range_found
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|exact_match_found
operator|&&
name|in_range_found
condition|)
block|{
name|flag
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|exact_match_found
operator|&&
name|flag
condition|)
block|{
name|result
operator|=
name|ldns_rdf_clone
argument_list|(
name|sname
argument_list|)
expr_stmt|;
comment|/* RFC 5155: 8.3. 2.** "The proof is complete" */
name|ldns_rdf_deep_free
argument_list|(
name|hashed_sname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
elseif|else
if|if
condition|(
name|exact_match_found
operator|&&
operator|!
name|flag
condition|)
block|{
comment|/* error! */
name|ldns_rdf_deep_free
argument_list|(
name|hashed_sname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
name|flag
operator|=
name|false
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|hashed_sname
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|sname
expr_stmt|;
name|sname
operator|=
name|ldns_dname_left_chop
argument_list|(
name|sname
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|LDNS_FREE
argument_list|(
name|salt
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|zone_name
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|sname
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_decl_stmt

begin_function
name|bool
name|ldns_dnssec_pkt_has_rrsigs
parameter_list|(
specifier|const
name|ldns_pkt
modifier|*
name|pkt
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_pkt_ancount
argument_list|(
name|pkt
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|ldns_pkt_answer
argument_list|(
name|pkt
argument_list|)
argument_list|,
name|i
argument_list|)
argument_list|)
operator|==
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
return|return
name|true
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_pkt_nscount
argument_list|(
name|pkt
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|ldns_pkt_authority
argument_list|(
name|pkt
argument_list|)
argument_list|,
name|i
argument_list|)
argument_list|)
operator|==
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
return|return
name|true
return|;
block|}
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_dnssec_pkt_get_rrsigs_for_name_and_type
parameter_list|(
specifier|const
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|uint16_t
name|t_netorder
decl_stmt|;
name|ldns_rr_list
modifier|*
name|sigs
decl_stmt|;
name|ldns_rr_list
modifier|*
name|sigs_covered
decl_stmt|;
name|ldns_rdf
modifier|*
name|rdf_t
decl_stmt|;
name|sigs
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|pkt
argument_list|,
name|name
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
name|t_netorder
operator|=
name|htons
argument_list|(
name|type
argument_list|)
expr_stmt|;
comment|/* rdf are in network order! */
name|rdf_t
operator|=
name|ldns_rdf_new
argument_list|(
name|LDNS_RDF_TYPE_TYPE
argument_list|,
name|LDNS_RDF_SIZE_WORD
argument_list|,
operator|&
name|t_netorder
argument_list|)
expr_stmt|;
name|sigs_covered
operator|=
name|ldns_rr_list_subtype_by_rdf
argument_list|(
name|sigs
argument_list|,
name|rdf_t
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|rdf_t
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|sigs
argument_list|)
expr_stmt|;
return|return
name|sigs_covered
return|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_dnssec_pkt_get_rrsigs_for_type
parameter_list|(
specifier|const
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|uint16_t
name|t_netorder
decl_stmt|;
name|ldns_rr_list
modifier|*
name|sigs
decl_stmt|;
name|ldns_rr_list
modifier|*
name|sigs_covered
decl_stmt|;
name|ldns_rdf
modifier|*
name|rdf_t
decl_stmt|;
name|sigs
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|pkt
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
name|t_netorder
operator|=
name|htons
argument_list|(
name|type
argument_list|)
expr_stmt|;
comment|/* rdf are in network order! */
name|rdf_t
operator|=
name|ldns_rdf_new
argument_list|(
name|LDNS_RDF_TYPE_TYPE
argument_list|,
literal|2
argument_list|,
operator|&
name|t_netorder
argument_list|)
expr_stmt|;
name|sigs_covered
operator|=
name|ldns_rr_list_subtype_by_rdf
argument_list|(
name|sigs
argument_list|,
name|rdf_t
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|rdf_t
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|sigs
argument_list|)
expr_stmt|;
return|return
name|sigs_covered
return|;
block|}
end_function

begin_comment
comment|/* used only on the public key RR */
end_comment

begin_function
name|uint16_t
name|ldns_calc_keytag
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|key
parameter_list|)
block|{
name|uint16_t
name|ac16
decl_stmt|;
name|ldns_buffer
modifier|*
name|keybuf
decl_stmt|;
name|size_t
name|keysize
decl_stmt|;
if|if
condition|(
operator|!
name|key
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|key
argument_list|)
operator|!=
name|LDNS_RR_TYPE_DNSKEY
operator|&&
name|ldns_rr_get_type
argument_list|(
name|key
argument_list|)
operator|!=
name|LDNS_RR_TYPE_KEY
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/* rdata to buf - only put the rdata in a buffer */
name|keybuf
operator|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MIN_BUFLEN
argument_list|)
expr_stmt|;
comment|/* grows */
if|if
condition|(
operator|!
name|keybuf
condition|)
block|{
return|return
literal|0
return|;
block|}
operator|(
name|void
operator|)
name|ldns_rr_rdata2buffer_wire
argument_list|(
name|keybuf
argument_list|,
name|key
argument_list|)
expr_stmt|;
comment|/* the current pos in the buffer is the keysize */
name|keysize
operator|=
name|ldns_buffer_position
argument_list|(
name|keybuf
argument_list|)
expr_stmt|;
name|ac16
operator|=
name|ldns_calc_keytag_raw
argument_list|(
name|ldns_buffer_begin
argument_list|(
name|keybuf
argument_list|)
argument_list|,
name|keysize
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|keybuf
argument_list|)
expr_stmt|;
return|return
name|ac16
return|;
block|}
end_function

begin_function
name|uint16_t
name|ldns_calc_keytag_raw
parameter_list|(
name|uint8_t
modifier|*
name|key
parameter_list|,
name|size_t
name|keysize
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|uint32_t
name|ac32
decl_stmt|;
name|uint16_t
name|ac16
decl_stmt|;
if|if
condition|(
name|keysize
operator|<
literal|4
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/* look at the algorithm field, copied from 2535bis */
if|if
condition|(
name|key
index|[
literal|3
index|]
operator|==
name|LDNS_RSAMD5
condition|)
block|{
name|ac16
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|keysize
operator|>
literal|4
condition|)
block|{
name|memmove
argument_list|(
operator|&
name|ac16
argument_list|,
name|key
operator|+
name|keysize
operator|-
literal|3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|ac16
operator|=
name|ntohs
argument_list|(
name|ac16
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|ac16
return|;
block|}
else|else
block|{
name|ac32
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|size_t
operator|)
name|i
operator|<
name|keysize
condition|;
operator|++
name|i
control|)
block|{
name|ac32
operator|+=
operator|(
name|i
operator|&
literal|1
operator|)
condition|?
name|key
index|[
name|i
index|]
else|:
name|key
index|[
name|i
index|]
operator|<<
literal|8
expr_stmt|;
block|}
name|ac32
operator|+=
operator|(
name|ac32
operator|>>
literal|16
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
return|return
call|(
name|uint16_t
call|)
argument_list|(
name|ac32
operator|&
literal|0xFFFF
argument_list|)
return|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
name|DSA
modifier|*
name|ldns_key_buf2dsa
parameter_list|(
name|ldns_buffer
modifier|*
name|key
parameter_list|)
block|{
return|return
name|ldns_key_buf2dsa_raw
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|key
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|key
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|DSA
modifier|*
name|ldns_key_buf2dsa_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|uint8_t
name|T
decl_stmt|;
name|uint16_t
name|length
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|;
name|DSA
modifier|*
name|dsa
decl_stmt|;
name|BIGNUM
modifier|*
name|Q
decl_stmt|;
name|BIGNUM
modifier|*
name|P
decl_stmt|;
name|BIGNUM
modifier|*
name|G
decl_stmt|;
name|BIGNUM
modifier|*
name|Y
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
name|T
operator|=
operator|(
name|uint8_t
operator|)
name|key
index|[
literal|0
index|]
expr_stmt|;
name|length
operator|=
operator|(
literal|64
operator|+
name|T
operator|*
literal|8
operator|)
expr_stmt|;
name|offset
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|T
operator|>
literal|8
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|len
operator|<
operator|(
name|size_t
operator|)
literal|1
operator|+
name|SHA_DIGEST_LENGTH
operator|+
literal|3
operator|*
name|length
condition|)
return|return
name|NULL
return|;
name|Q
operator|=
name|BN_bin2bn
argument_list|(
name|key
operator|+
name|offset
argument_list|,
name|SHA_DIGEST_LENGTH
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|SHA_DIGEST_LENGTH
expr_stmt|;
name|P
operator|=
name|BN_bin2bn
argument_list|(
name|key
operator|+
name|offset
argument_list|,
operator|(
name|int
operator|)
name|length
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|length
expr_stmt|;
name|G
operator|=
name|BN_bin2bn
argument_list|(
name|key
operator|+
name|offset
argument_list|,
operator|(
name|int
operator|)
name|length
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|length
expr_stmt|;
name|Y
operator|=
name|BN_bin2bn
argument_list|(
name|key
operator|+
name|offset
argument_list|,
operator|(
name|int
operator|)
name|length
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|length
expr_stmt|;
comment|/* create the key and set its properties */
if|if
condition|(
operator|!
name|Q
operator|||
operator|!
name|P
operator|||
operator|!
name|G
operator|||
operator|!
name|Y
operator|||
operator|!
operator|(
name|dsa
operator|=
name|DSA_new
argument_list|()
operator|)
condition|)
block|{
name|BN_free
argument_list|(
name|Q
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|P
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|G
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|Y
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|dsa
operator|->
name|p
operator|=
name|P
expr_stmt|;
name|dsa
operator|->
name|q
operator|=
name|Q
expr_stmt|;
name|dsa
operator|->
name|g
operator|=
name|G
expr_stmt|;
name|dsa
operator|->
name|pub_key
operator|=
name|Y
expr_stmt|;
endif|#
directive|endif
comment|/* splint */
return|return
name|dsa
return|;
block|}
end_function

begin_function
name|RSA
modifier|*
name|ldns_key_buf2rsa
parameter_list|(
name|ldns_buffer
modifier|*
name|key
parameter_list|)
block|{
return|return
name|ldns_key_buf2rsa_raw
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|key
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|key
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|RSA
modifier|*
name|ldns_key_buf2rsa_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|uint16_t
name|offset
decl_stmt|;
name|uint16_t
name|exp
decl_stmt|;
name|uint16_t
name|int16
decl_stmt|;
name|RSA
modifier|*
name|rsa
decl_stmt|;
name|BIGNUM
modifier|*
name|modulus
decl_stmt|;
name|BIGNUM
modifier|*
name|exponent
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|key
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|<
literal|3
condition|)
return|return
name|NULL
return|;
comment|/* need some smart comment here XXX*/
comment|/* the exponent is too large so it's places 		 * futher...???? */
name|memmove
argument_list|(
operator|&
name|int16
argument_list|,
name|key
operator|+
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|exp
operator|=
name|ntohs
argument_list|(
name|int16
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|exp
operator|=
name|key
index|[
literal|0
index|]
expr_stmt|;
name|offset
operator|=
literal|1
expr_stmt|;
block|}
comment|/* key length at least one */
if|if
condition|(
name|len
operator|<
operator|(
name|size_t
operator|)
name|offset
operator|+
name|exp
operator|+
literal|1
condition|)
return|return
name|NULL
return|;
comment|/* Exponent */
name|exponent
operator|=
name|BN_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|exponent
condition|)
return|return
name|NULL
return|;
operator|(
name|void
operator|)
name|BN_bin2bn
argument_list|(
name|key
operator|+
name|offset
argument_list|,
operator|(
name|int
operator|)
name|exp
argument_list|,
name|exponent
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|exp
expr_stmt|;
comment|/* Modulus */
name|modulus
operator|=
name|BN_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|modulus
condition|)
block|{
name|BN_free
argument_list|(
name|exponent
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* length of the buffer must match the key length! */
operator|(
name|void
operator|)
name|BN_bin2bn
argument_list|(
name|key
operator|+
name|offset
argument_list|,
call|(
name|int
call|)
argument_list|(
name|len
operator|-
name|offset
argument_list|)
argument_list|,
name|modulus
argument_list|)
expr_stmt|;
name|rsa
operator|=
name|RSA_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
condition|)
block|{
name|BN_free
argument_list|(
name|exponent
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|modulus
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|rsa
operator|->
name|n
operator|=
name|modulus
expr_stmt|;
name|rsa
operator|->
name|e
operator|=
name|exponent
expr_stmt|;
endif|#
directive|endif
comment|/* splint */
return|return
name|rsa
return|;
block|}
end_function

begin_function
name|int
name|ldns_digest_evp
parameter_list|(
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|,
name|unsigned
name|char
modifier|*
name|dest
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|md
parameter_list|)
block|{
name|EVP_MD_CTX
modifier|*
name|ctx
decl_stmt|;
name|ctx
operator|=
name|EVP_MD_CTX_create
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
condition|)
return|return
name|false
return|;
if|if
condition|(
operator|!
name|EVP_DigestInit_ex
argument_list|(
name|ctx
argument_list|,
name|md
argument_list|,
name|NULL
argument_list|)
operator|||
operator|!
name|EVP_DigestUpdate
argument_list|(
name|ctx
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
operator|||
operator|!
name|EVP_DigestFinal_ex
argument_list|(
name|ctx
argument_list|,
name|dest
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|EVP_MD_CTX_destroy
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|EVP_MD_CTX_destroy
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_function
name|ldns_rr
modifier|*
name|ldns_key_rr2ds
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|key
parameter_list|,
name|ldns_hash
name|h
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|tmp
decl_stmt|;
name|ldns_rr
modifier|*
name|ds
decl_stmt|;
name|uint16_t
name|keytag
decl_stmt|;
name|uint8_t
name|sha1hash
decl_stmt|;
name|uint8_t
modifier|*
name|digest
decl_stmt|;
name|ldns_buffer
modifier|*
name|data_buf
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_GOST
specifier|const
name|EVP_MD
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|key
argument_list|)
operator|!=
name|LDNS_RR_TYPE_DNSKEY
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ds
operator|=
name|ldns_rr_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ds
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ldns_rr_set_type
argument_list|(
name|ds
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|ds
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|ldns_rr_owner
argument_list|(
name|key
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_set_ttl
argument_list|(
name|ds
argument_list|,
name|ldns_rr_ttl
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_set_class
argument_list|(
name|ds
argument_list|,
name|ldns_rr_get_class
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|h
condition|)
block|{
default|default:
case|case
name|LDNS_SHA1
case|:
name|digest
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|LDNS_SHA1_DIGEST_LENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|digest
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
break|break;
case|case
name|LDNS_SHA256
case|:
name|digest
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|LDNS_SHA256_DIGEST_LENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|digest
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
break|break;
case|case
name|LDNS_HASH_GOST
case|:
ifdef|#
directive|ifdef
name|USE_GOST
operator|(
name|void
operator|)
name|ldns_key_EVP_load_gost_id
argument_list|()
expr_stmt|;
name|md
operator|=
name|EVP_get_digestbyname
argument_list|(
literal|"md_gost94"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|md
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|digest
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|EVP_MD_size
argument_list|(
name|md
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|digest
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
break|break;
else|#
directive|else
comment|/* not implemented */
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
endif|#
directive|endif
case|case
name|LDNS_SHA384
case|:
ifdef|#
directive|ifdef
name|USE_ECDSA
name|digest
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|SHA384_DIGEST_LENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|digest
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
break|break;
else|#
directive|else
comment|/* not implemented */
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
endif|#
directive|endif
block|}
name|data_buf
operator|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data_buf
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* keytag */
name|keytag
operator|=
name|htons
argument_list|(
name|ldns_calc_keytag
argument_list|(
operator|(
name|ldns_rr
operator|*
operator|)
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_INT16
argument_list|,
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|,
operator|&
name|keytag
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|ds
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* copy the algorithm field */
if|if
condition|(
operator|(
name|tmp
operator|=
name|ldns_rr_rdf
argument_list|(
name|key
argument_list|,
literal|2
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|data_buf
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
name|ldns_rr_push_rdf
argument_list|(
name|ds
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* digest hash type */
name|sha1hash
operator|=
operator|(
name|uint8_t
operator|)
name|h
expr_stmt|;
name|tmp
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_INT8
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|,
operator|&
name|sha1hash
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|ds
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* digest */
comment|/* owner name */
name|tmp
operator|=
name|ldns_rdf_clone
argument_list|(
name|ldns_rr_owner
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_dname2canonical
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rdf2buffer_wire
argument_list|(
name|data_buf
argument_list|,
name|tmp
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|data_buf
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
comment|/* all the rdata's */
if|if
condition|(
name|ldns_rr_rdata2buffer_wire
argument_list|(
name|data_buf
argument_list|,
operator|(
name|ldns_rr
operator|*
operator|)
name|key
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|data_buf
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
switch|switch
condition|(
name|h
condition|)
block|{
case|case
name|LDNS_SHA1
case|:
operator|(
name|void
operator|)
name|ldns_sha1
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|data_buf
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_buffer_position
argument_list|(
name|data_buf
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|digest
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_HEX
argument_list|,
name|LDNS_SHA1_DIGEST_LENGTH
argument_list|,
name|digest
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|ds
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDNS_SHA256
case|:
operator|(
name|void
operator|)
name|ldns_sha256
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|data_buf
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_buffer_position
argument_list|(
name|data_buf
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|digest
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_HEX
argument_list|,
name|LDNS_SHA256_DIGEST_LENGTH
argument_list|,
name|digest
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|ds
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDNS_HASH_GOST
case|:
ifdef|#
directive|ifdef
name|USE_GOST
if|if
condition|(
operator|!
name|ldns_digest_evp
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|data_buf
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_buffer_position
argument_list|(
name|data_buf
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|digest
argument_list|,
name|md
argument_list|)
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|data_buf
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|tmp
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_HEX
argument_list|,
operator|(
name|size_t
operator|)
name|EVP_MD_size
argument_list|(
name|md
argument_list|)
argument_list|,
name|digest
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|ds
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|LDNS_SHA384
case|:
ifdef|#
directive|ifdef
name|USE_ECDSA
operator|(
name|void
operator|)
name|SHA384
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|data_buf
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_buffer_position
argument_list|(
name|data_buf
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|digest
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_HEX
argument_list|,
name|SHA384_DIGEST_LENGTH
argument_list|,
name|digest
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|ds
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
name|LDNS_FREE
argument_list|(
name|digest
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|data_buf
argument_list|)
expr_stmt|;
return|return
name|ds
return|;
block|}
end_function

begin_comment
comment|/* From RFC3845:  *  * 2.1.2.  The List of Type Bit Map(s) Field  *   *    The RR type space is split into 256 window blocks, each representing  *    the low-order 8 bits of the 16-bit RR type space.  Each block that  *    has at least one active RR type is encoded using a single octet  *    window number (from 0 to 255), a single octet bitmap length (from 1  *    to 32) indicating the number of octets used for the window block's  *    bitmap, and up to 32 octets (256 bits) of bitmap.  *   *    Window blocks are present in the NSEC RR RDATA in increasing  *    numerical order.  *   *    "|" denotes concatenation  *   *    Type Bit Map(s) Field = ( Window Block # | Bitmap Length | Bitmap ) +  *   *<cut>  *   *    Blocks with no types present MUST NOT be included.  Trailing zero  *    octets in the bitmap MUST be omitted.  The length of each block's  *    bitmap is determined by the type code with the largest numerical  *    value within that block, among the set of RR types present at the  *    NSEC RR's owner name.  Trailing zero octets not specified MUST be  *    interpreted as zero octets.  */
end_comment

begin_function
name|ldns_rdf
modifier|*
name|ldns_dnssec_create_nsec_bitmap
parameter_list|(
name|ldns_rr_type
name|rr_type_list
index|[]
parameter_list|,
name|size_t
name|size
parameter_list|,
name|ldns_rr_type
name|nsec_type
parameter_list|)
block|{
name|uint8_t
name|window
decl_stmt|;
comment|/*  most significant octet of type */
name|uint8_t
name|subtype
decl_stmt|;
comment|/* least significant octet of type */
name|uint16_t
name|windows
index|[
literal|256
index|]
comment|/* Max subtype per window */
ifndef|#
directive|ifndef
name|S_SPLINT_S
init|=
block|{
literal|0
block|}
comment|/* Initialize ALL elements with 0 */
endif|#
directive|endif
decl_stmt|;
name|ldns_rr_type
modifier|*
name|d
decl_stmt|;
comment|/* used to traverse rr_type_list*/
name|size_t
name|i
decl_stmt|;
comment|/* used to traverse windows array */
name|size_t
name|sz
decl_stmt|;
comment|/* size needed for type bitmap rdf */
name|uint8_t
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
comment|/* rdf data */
name|uint8_t
modifier|*
name|dptr
decl_stmt|;
comment|/* used to itraverse rdf data */
name|ldns_rdf
modifier|*
name|rdf
decl_stmt|;
comment|/* bitmap rdf to return */
if|if
condition|(
name|nsec_type
operator|!=
name|LDNS_RR_TYPE_NSEC
operator|&&
name|nsec_type
operator|!=
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* Which other windows need to be in the bitmap rdf? 	 */
for|for
control|(
name|d
operator|=
name|rr_type_list
init|;
name|d
operator|<
name|rr_type_list
operator|+
name|size
condition|;
name|d
operator|++
control|)
block|{
name|window
operator|=
operator|*
name|d
operator|>>
literal|8
expr_stmt|;
name|subtype
operator|=
operator|*
name|d
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|windows
index|[
name|window
index|]
operator|<
name|subtype
condition|)
block|{
name|windows
index|[
name|window
index|]
operator|=
name|subtype
expr_stmt|;
block|}
block|}
comment|/* How much space do we need in the rdf for those windows? 	 */
name|sz
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|windows
index|[
name|i
index|]
condition|)
block|{
name|sz
operator|+=
name|windows
index|[
name|i
index|]
operator|/
literal|8
operator|+
literal|3
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sz
operator|>
literal|0
condition|)
block|{
comment|/* Format rdf data according RFC3845 Section 2.1.2 (see above) 		 */
name|dptr
operator|=
name|data
operator|=
name|LDNS_CALLOC
argument_list|(
name|uint8_t
argument_list|,
name|sz
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
block|{
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|windows
index|[
name|i
index|]
condition|)
block|{
operator|*
name|dptr
operator|++
operator|=
operator|(
name|uint8_t
operator|)
name|i
expr_stmt|;
operator|*
name|dptr
operator|++
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|windows
index|[
name|i
index|]
operator|/
literal|8
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* Now let windows[i] index the bitmap 				 * within data 				 */
name|windows
index|[
name|i
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|dptr
operator|-
name|data
argument_list|)
expr_stmt|;
name|dptr
operator|+=
name|dptr
index|[
operator|-
literal|1
index|]
expr_stmt|;
block|}
block|}
block|}
comment|/* Set the bits? 	 */
for|for
control|(
name|d
operator|=
name|rr_type_list
init|;
name|d
operator|<
name|rr_type_list
operator|+
name|size
condition|;
name|d
operator|++
control|)
block|{
name|subtype
operator|=
operator|*
name|d
operator|&
literal|0xff
expr_stmt|;
name|data
index|[
name|windows
index|[
operator|*
name|d
operator|>>
literal|8
index|]
operator|+
name|subtype
operator|/
literal|8
index|]
operator||=
operator|(
literal|0x80
operator|>>
operator|(
name|subtype
operator|%
literal|8
operator|)
operator|)
expr_stmt|;
block|}
comment|/* Allocate and return rdf structure for the data 	 */
name|rdf
operator|=
name|ldns_rdf_new
argument_list|(
name|LDNS_RDF_TYPE_BITMAP
argument_list|,
name|sz
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdf
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|rdf
return|;
block|}
end_function

begin_function
name|int
name|ldns_dnssec_rrsets_contains_type
parameter_list|(
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|ldns_dnssec_rrsets
modifier|*
name|cur_rrset
init|=
name|rrsets
decl_stmt|;
while|while
condition|(
name|cur_rrset
condition|)
block|{
if|if
condition|(
name|cur_rrset
operator|->
name|type
operator|==
name|type
condition|)
block|{
return|return
literal|1
return|;
block|}
name|cur_rrset
operator|=
name|cur_rrset
operator|->
name|next
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ldns_rr
modifier|*
name|ldns_dnssec_create_nsec
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|from
parameter_list|,
name|ldns_dnssec_name
modifier|*
name|to
parameter_list|,
name|ldns_rr_type
name|nsec_type
parameter_list|)
block|{
name|ldns_rr
modifier|*
name|nsec_rr
decl_stmt|;
name|ldns_rr_type
name|types
index|[
literal|65536
index|]
decl_stmt|;
name|size_t
name|type_count
init|=
literal|0
decl_stmt|;
name|ldns_dnssec_rrsets
modifier|*
name|cur_rrsets
decl_stmt|;
name|int
name|on_delegation_point
decl_stmt|;
if|if
condition|(
operator|!
name|from
operator|||
operator|!
name|to
operator|||
operator|(
name|nsec_type
operator|!=
name|LDNS_RR_TYPE_NSEC
operator|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|nsec_rr
operator|=
name|ldns_rr_new
argument_list|()
expr_stmt|;
name|ldns_rr_set_type
argument_list|(
name|nsec_rr
argument_list|,
name|nsec_type
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|nsec_rr
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|ldns_dnssec_name_name
argument_list|(
name|from
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|nsec_rr
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|ldns_dnssec_name_name
argument_list|(
name|to
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|on_delegation_point
operator|=
name|ldns_dnssec_rrsets_contains_type
argument_list|(
name|from
operator|->
name|rrsets
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|)
operator|&&
operator|!
name|ldns_dnssec_rrsets_contains_type
argument_list|(
name|from
operator|->
name|rrsets
argument_list|,
name|LDNS_RR_TYPE_SOA
argument_list|)
expr_stmt|;
name|cur_rrsets
operator|=
name|from
operator|->
name|rrsets
expr_stmt|;
while|while
condition|(
name|cur_rrsets
condition|)
block|{
comment|/* Do not include non-authoritative rrsets on the delegation point 		 * in the type bitmap */
if|if
condition|(
operator|(
name|on_delegation_point
operator|&&
operator|(
name|cur_rrsets
operator|->
name|type
operator|==
name|LDNS_RR_TYPE_NS
operator|||
name|cur_rrsets
operator|->
name|type
operator|==
name|LDNS_RR_TYPE_DS
operator|)
operator|)
operator|||
operator|(
operator|!
name|on_delegation_point
operator|&&
name|cur_rrsets
operator|->
name|type
operator|!=
name|LDNS_RR_TYPE_RRSIG
operator|&&
name|cur_rrsets
operator|->
name|type
operator|!=
name|LDNS_RR_TYPE_NSEC
operator|)
condition|)
block|{
name|types
index|[
name|type_count
index|]
operator|=
name|cur_rrsets
operator|->
name|type
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
block|}
name|cur_rrsets
operator|=
name|cur_rrsets
operator|->
name|next
expr_stmt|;
block|}
name|types
index|[
name|type_count
index|]
operator|=
name|LDNS_RR_TYPE_RRSIG
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
name|types
index|[
name|type_count
index|]
operator|=
name|LDNS_RR_TYPE_NSEC
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|nsec_rr
argument_list|,
name|ldns_dnssec_create_nsec_bitmap
argument_list|(
name|types
argument_list|,
name|type_count
argument_list|,
name|nsec_type
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|nsec_rr
return|;
block|}
end_function

begin_function
name|ldns_rr
modifier|*
name|ldns_dnssec_create_nsec3
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|from
parameter_list|,
name|ldns_dnssec_name
modifier|*
name|to
parameter_list|,
name|ldns_rdf
modifier|*
name|zone_name
parameter_list|,
name|uint8_t
name|algorithm
parameter_list|,
name|uint8_t
name|flags
parameter_list|,
name|uint16_t
name|iterations
parameter_list|,
name|uint8_t
name|salt_length
parameter_list|,
name|uint8_t
modifier|*
name|salt
parameter_list|)
block|{
name|ldns_rr
modifier|*
name|nsec_rr
decl_stmt|;
name|ldns_rr_type
name|types
index|[
literal|65536
index|]
decl_stmt|;
name|size_t
name|type_count
init|=
literal|0
decl_stmt|;
name|ldns_dnssec_rrsets
modifier|*
name|cur_rrsets
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|int
name|on_delegation_point
decl_stmt|;
if|if
condition|(
operator|!
name|from
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|nsec_rr
operator|=
name|ldns_rr_new_frm_type
argument_list|(
name|LDNS_RR_TYPE_NSEC3
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|nsec_rr
argument_list|,
name|ldns_nsec3_hash_name
argument_list|(
name|ldns_dnssec_name_name
argument_list|(
name|from
argument_list|)
argument_list|,
name|algorithm
argument_list|,
name|iterations
argument_list|,
name|salt_length
argument_list|,
name|salt
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_dname_cat
argument_list|(
name|ldns_rr_owner
argument_list|(
name|nsec_rr
argument_list|)
argument_list|,
name|zone_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|nsec_rr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ldns_nsec3_add_param_rdfs
argument_list|(
name|nsec_rr
argument_list|,
name|algorithm
argument_list|,
name|flags
argument_list|,
name|iterations
argument_list|,
name|salt_length
argument_list|,
name|salt
argument_list|)
expr_stmt|;
name|on_delegation_point
operator|=
name|ldns_dnssec_rrsets_contains_type
argument_list|(
name|from
operator|->
name|rrsets
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|)
operator|&&
operator|!
name|ldns_dnssec_rrsets_contains_type
argument_list|(
name|from
operator|->
name|rrsets
argument_list|,
name|LDNS_RR_TYPE_SOA
argument_list|)
expr_stmt|;
name|cur_rrsets
operator|=
name|from
operator|->
name|rrsets
expr_stmt|;
while|while
condition|(
name|cur_rrsets
condition|)
block|{
comment|/* Do not include non-authoritative rrsets on the delegation point 		 * in the type bitmap. Potentionally not skipping insecure 		 * delegation should have been done earlier, in function 		 * ldns_dnssec_zone_create_nsec3s, or even earlier in: 		 * ldns_dnssec_zone_sign_nsec3_flg . 		 */
if|if
condition|(
operator|(
name|on_delegation_point
operator|&&
operator|(
name|cur_rrsets
operator|->
name|type
operator|==
name|LDNS_RR_TYPE_NS
operator|||
name|cur_rrsets
operator|->
name|type
operator|==
name|LDNS_RR_TYPE_DS
operator|)
operator|)
operator|||
operator|(
operator|!
name|on_delegation_point
operator|&&
name|cur_rrsets
operator|->
name|type
operator|!=
name|LDNS_RR_TYPE_RRSIG
operator|)
condition|)
block|{
name|types
index|[
name|type_count
index|]
operator|=
name|cur_rrsets
operator|->
name|type
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
block|}
name|cur_rrsets
operator|=
name|cur_rrsets
operator|->
name|next
expr_stmt|;
block|}
comment|/* always add rrsig type if this is not an unsigned 	 * delegation 	 */
if|if
condition|(
name|type_count
operator|>
literal|0
operator|&&
operator|!
operator|(
name|type_count
operator|==
literal|1
operator|&&
name|types
index|[
literal|0
index|]
operator|==
name|LDNS_RR_TYPE_NS
operator|)
condition|)
block|{
name|types
index|[
name|type_count
index|]
operator|=
name|LDNS_RR_TYPE_RRSIG
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
block|}
comment|/* leave next rdata empty if they weren't precomputed yet */
if|if
condition|(
name|to
operator|&&
name|to
operator|->
name|hashed_name
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_rr_set_rdf
argument_list|(
name|nsec_rr
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|to
operator|->
name|hashed_name
argument_list|)
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|ldns_rr_set_rdf
argument_list|(
name|nsec_rr
argument_list|,
name|NULL
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_push_rdf
argument_list|(
name|nsec_rr
argument_list|,
name|ldns_dnssec_create_nsec_bitmap
argument_list|(
name|types
argument_list|,
name|type_count
argument_list|,
name|LDNS_RR_TYPE_NSEC3
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|nsec_rr
return|;
block|}
end_function

begin_function
name|ldns_rr
modifier|*
name|ldns_create_nsec
parameter_list|(
name|ldns_rdf
modifier|*
name|cur_owner
parameter_list|,
name|ldns_rdf
modifier|*
name|next_owner
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrs
parameter_list|)
block|{
comment|/* we do not do any check here - garbage in, garbage out */
comment|/* the the start and end names - get the type from the 	 * before rrlist */
comment|/* inefficient, just give it a name, a next name, and a list of rrs */
comment|/* we make 1 big uberbitmap first, then windows */
comment|/* todo: make something more efficient :) */
name|uint16_t
name|i
decl_stmt|;
name|ldns_rr
modifier|*
name|i_rr
decl_stmt|;
name|uint16_t
name|i_type
decl_stmt|;
name|ldns_rr
modifier|*
name|nsec
init|=
name|NULL
decl_stmt|;
name|ldns_rr_type
name|i_type_list
index|[
literal|65536
index|]
decl_stmt|;
name|size_t
name|type_count
init|=
literal|0
decl_stmt|;
name|nsec
operator|=
name|ldns_rr_new
argument_list|()
expr_stmt|;
name|ldns_rr_set_type
argument_list|(
name|nsec
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|nsec
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|cur_owner
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|nsec
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|next_owner
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|i_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|rrs
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rdf_compare
argument_list|(
name|cur_owner
argument_list|,
name|ldns_rr_owner
argument_list|(
name|i_rr
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|i_type
operator|=
name|ldns_rr_get_type
argument_list|(
name|i_rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|i_type
operator|!=
name|LDNS_RR_TYPE_RRSIG
operator|&&
name|i_type
operator|!=
name|LDNS_RR_TYPE_NSEC
condition|)
block|{
if|if
condition|(
name|type_count
operator|==
literal|0
operator|||
name|i_type_list
index|[
name|type_count
operator|-
literal|1
index|]
operator|!=
name|i_type
condition|)
block|{
name|i_type_list
index|[
name|type_count
index|]
operator|=
name|i_type
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
block|}
block|}
block|}
block|}
name|i_type_list
index|[
name|type_count
index|]
operator|=
name|LDNS_RR_TYPE_RRSIG
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
name|i_type_list
index|[
name|type_count
index|]
operator|=
name|LDNS_RR_TYPE_NSEC
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|nsec
argument_list|,
name|ldns_dnssec_create_nsec_bitmap
argument_list|(
name|i_type_list
argument_list|,
name|type_count
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|nsec
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_nsec3_hash_name
parameter_list|(
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|uint8_t
name|algorithm
parameter_list|,
name|uint16_t
name|iterations
parameter_list|,
name|uint8_t
name|salt_length
parameter_list|,
name|uint8_t
modifier|*
name|salt
parameter_list|)
block|{
name|size_t
name|hashed_owner_str_len
decl_stmt|;
name|ldns_rdf
modifier|*
name|cann
decl_stmt|;
name|ldns_rdf
modifier|*
name|hashed_owner
decl_stmt|;
name|unsigned
name|char
modifier|*
name|hashed_owner_str
decl_stmt|;
name|char
modifier|*
name|hashed_owner_b32
decl_stmt|;
name|size_t
name|hashed_owner_b32_len
decl_stmt|;
name|uint32_t
name|cur_it
decl_stmt|;
comment|/* define to contain the largest possible hash, which is 	 * sha1 at the moment */
name|unsigned
name|char
name|hash
index|[
name|LDNS_SHA1_DIGEST_LENGTH
index|]
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
comment|/* TODO: mnemonic list for hash algs SHA-1, default to 1 now (sha1) */
if|if
condition|(
name|algorithm
operator|!=
name|LDNS_SHA1
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* prepare the owner name according to the draft section bla */
name|cann
operator|=
name|ldns_rdf_clone
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cann
condition|)
block|{
ifdef|#
directive|ifdef
name|STDERR_MSGS
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Memory error\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|NULL
return|;
block|}
name|ldns_dname2canonical
argument_list|(
name|cann
argument_list|)
expr_stmt|;
name|hashed_owner_str_len
operator|=
name|salt_length
operator|+
name|ldns_rdf_size
argument_list|(
name|cann
argument_list|)
expr_stmt|;
name|hashed_owner_str
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|hashed_owner_str_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hashed_owner_str
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|cann
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
name|hashed_owner_str
argument_list|,
name|ldns_rdf_data
argument_list|(
name|cann
argument_list|)
argument_list|,
name|ldns_rdf_size
argument_list|(
name|cann
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hashed_owner_str
operator|+
name|ldns_rdf_size
argument_list|(
name|cann
argument_list|)
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|cann
argument_list|)
expr_stmt|;
for|for
control|(
name|cur_it
operator|=
name|iterations
operator|+
literal|1
init|;
name|cur_it
operator|>
literal|0
condition|;
name|cur_it
operator|--
control|)
block|{
operator|(
name|void
operator|)
name|ldns_sha1
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|hashed_owner_str
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|hashed_owner_str_len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|hashed_owner_str
argument_list|)
expr_stmt|;
name|hashed_owner_str_len
operator|=
name|salt_length
operator|+
name|LDNS_SHA1_DIGEST_LENGTH
expr_stmt|;
name|hashed_owner_str
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|hashed_owner_str_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hashed_owner_str
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
name|hashed_owner_str
argument_list|,
name|hash
argument_list|,
name|LDNS_SHA1_DIGEST_LENGTH
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hashed_owner_str
operator|+
name|LDNS_SHA1_DIGEST_LENGTH
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|)
expr_stmt|;
name|hashed_owner_str_len
operator|=
name|LDNS_SHA1_DIGEST_LENGTH
operator|+
name|salt_length
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|hashed_owner_str
argument_list|)
expr_stmt|;
name|hashed_owner_str
operator|=
name|hash
expr_stmt|;
name|hashed_owner_str_len
operator|=
name|LDNS_SHA1_DIGEST_LENGTH
expr_stmt|;
name|hashed_owner_b32
operator|=
name|LDNS_XMALLOC
argument_list|(
name|char
argument_list|,
name|ldns_b32_ntop_calculate_size
argument_list|(
name|hashed_owner_str_len
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hashed_owner_b32
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|hashed_owner_b32_len
operator|=
operator|(
name|size_t
operator|)
name|ldns_b32_ntop_extended_hex
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|hashed_owner_str
argument_list|,
name|hashed_owner_str_len
argument_list|,
name|hashed_owner_b32
argument_list|,
name|ldns_b32_ntop_calculate_size
argument_list|(
name|hashed_owner_str_len
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|hashed_owner_b32_len
operator|<
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|STDERR_MSGS
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error in base32 extended hex encoding "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"of hashed owner name (name: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stderr
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|", return code: %u)\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|hashed_owner_b32_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|LDNS_FREE
argument_list|(
name|hashed_owner_b32
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|hashed_owner_b32
index|[
name|hashed_owner_b32_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|status
operator|=
name|ldns_str2rdf_dname
argument_list|(
operator|&
name|hashed_owner
argument_list|,
name|hashed_owner_b32
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
ifdef|#
directive|ifdef
name|STDERR_MSGS
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error creating rdf from %s\n"
argument_list|,
name|hashed_owner_b32
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|LDNS_FREE
argument_list|(
name|hashed_owner_b32
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|LDNS_FREE
argument_list|(
name|hashed_owner_b32
argument_list|)
expr_stmt|;
return|return
name|hashed_owner
return|;
block|}
end_function

begin_function
name|void
name|ldns_nsec3_add_param_rdfs
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|,
name|uint8_t
name|algorithm
parameter_list|,
name|uint8_t
name|flags
parameter_list|,
name|uint16_t
name|iterations
parameter_list|,
name|uint8_t
name|salt_length
parameter_list|,
name|uint8_t
modifier|*
name|salt
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|salt_rdf
init|=
name|NULL
decl_stmt|;
name|uint8_t
modifier|*
name|salt_data
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|old
decl_stmt|;
name|old
operator|=
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_INT8
argument_list|,
literal|1
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|algorithm
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|old
condition|)
name|ldns_rdf_deep_free
argument_list|(
name|old
argument_list|)
expr_stmt|;
name|old
operator|=
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_INT8
argument_list|,
literal|1
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|flags
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|old
condition|)
name|ldns_rdf_deep_free
argument_list|(
name|old
argument_list|)
expr_stmt|;
name|old
operator|=
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|ldns_native2rdf_int16
argument_list|(
name|LDNS_RDF_TYPE_INT16
argument_list|,
name|iterations
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|old
condition|)
name|ldns_rdf_deep_free
argument_list|(
name|old
argument_list|)
expr_stmt|;
name|salt_data
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|salt_length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|salt_data
condition|)
block|{
comment|/* no way to return error */
return|return;
block|}
name|salt_data
index|[
literal|0
index|]
operator|=
name|salt_length
expr_stmt|;
name|memcpy
argument_list|(
name|salt_data
operator|+
literal|1
argument_list|,
name|salt
argument_list|,
name|salt_length
argument_list|)
expr_stmt|;
name|salt_rdf
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_NSEC3_SALT
argument_list|,
name|salt_length
operator|+
literal|1
argument_list|,
name|salt_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|salt_rdf
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|salt_data
argument_list|)
expr_stmt|;
comment|/* no way to return error */
return|return;
block|}
name|old
operator|=
name|ldns_rr_set_rdf
argument_list|(
name|rr
argument_list|,
name|salt_rdf
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|old
condition|)
name|ldns_rdf_deep_free
argument_list|(
name|old
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|salt_data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rr_list_delegation_only
parameter_list|(
name|ldns_rdf
modifier|*
name|origin
parameter_list|,
name|ldns_rr_list
modifier|*
name|rr_list
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_rr
decl_stmt|;
if|if
condition|(
operator|!
name|origin
operator|||
operator|!
name|rr_list
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rr_list
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cur_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|rr_list
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|cur_rr
argument_list|)
argument_list|,
name|origin
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|cur_rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_NS
condition|)
block|{
return|return
literal|0
return|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* this will NOT return the NSEC3  completed, you will have to run the    finalize function on the rrlist later! */
end_comment

begin_function
name|ldns_rr
modifier|*
name|ldns_create_nsec3
parameter_list|(
name|ldns_rdf
modifier|*
name|cur_owner
parameter_list|,
name|ldns_rdf
modifier|*
name|cur_zone
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrs
parameter_list|,
name|uint8_t
name|algorithm
parameter_list|,
name|uint8_t
name|flags
parameter_list|,
name|uint16_t
name|iterations
parameter_list|,
name|uint8_t
name|salt_length
parameter_list|,
name|uint8_t
modifier|*
name|salt
parameter_list|,
name|bool
name|emptynonterminal
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|ldns_rr
modifier|*
name|i_rr
decl_stmt|;
name|uint16_t
name|i_type
decl_stmt|;
name|ldns_rr
modifier|*
name|nsec
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|hashed_owner
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|ldns_rr_type
name|i_type_list
index|[
literal|1024
index|]
decl_stmt|;
name|size_t
name|type_count
init|=
literal|0
decl_stmt|;
name|hashed_owner
operator|=
name|ldns_nsec3_hash_name
argument_list|(
name|cur_owner
argument_list|,
name|algorithm
argument_list|,
name|iterations
argument_list|,
name|salt_length
argument_list|,
name|salt
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_dname_cat
argument_list|(
name|hashed_owner
argument_list|,
name|cur_zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|hashed_owner
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|nsec
operator|=
name|ldns_rr_new_frm_type
argument_list|(
name|LDNS_RR_TYPE_NSEC3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|nsec
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|hashed_owner
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ldns_rr_set_type
argument_list|(
name|nsec
argument_list|,
name|LDNS_RR_TYPE_NSEC3
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|nsec
argument_list|,
name|hashed_owner
argument_list|)
expr_stmt|;
name|ldns_nsec3_add_param_rdfs
argument_list|(
name|nsec
argument_list|,
name|algorithm
argument_list|,
name|flags
argument_list|,
name|iterations
argument_list|,
name|salt_length
argument_list|,
name|salt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_set_rdf
argument_list|(
name|nsec
argument_list|,
name|NULL
argument_list|,
literal|4
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|i_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|rrs
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rdf_compare
argument_list|(
name|cur_owner
argument_list|,
name|ldns_rr_owner
argument_list|(
name|i_rr
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|i_type
operator|=
name|ldns_rr_get_type
argument_list|(
name|i_rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|type_count
operator|==
literal|0
operator|||
name|i_type_list
index|[
name|type_count
operator|-
literal|1
index|]
operator|!=
name|i_type
condition|)
block|{
name|i_type_list
index|[
name|type_count
index|]
operator|=
name|i_type
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
block|}
block|}
block|}
comment|/* add RRSIG anyway, but only if this is not an ENT or 	 * an unsigned delegation */
if|if
condition|(
operator|!
name|emptynonterminal
operator|&&
operator|!
name|rr_list_delegation_only
argument_list|(
name|cur_zone
argument_list|,
name|rrs
argument_list|)
condition|)
block|{
name|i_type_list
index|[
name|type_count
index|]
operator|=
name|LDNS_RR_TYPE_RRSIG
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
block|}
comment|/* and SOA if owner == zone */
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|cur_zone
argument_list|,
name|cur_owner
argument_list|)
operator|==
literal|0
condition|)
block|{
name|i_type_list
index|[
name|type_count
index|]
operator|=
name|LDNS_RR_TYPE_SOA
expr_stmt|;
name|type_count
operator|++
expr_stmt|;
block|}
name|ldns_rr_push_rdf
argument_list|(
name|nsec
argument_list|,
name|ldns_dnssec_create_nsec_bitmap
argument_list|(
name|i_type_list
argument_list|,
name|type_count
argument_list|,
name|LDNS_RR_TYPE_NSEC3
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|nsec
return|;
block|}
end_function

begin_function
name|uint8_t
name|ldns_nsec3_algorithm
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec3_rr
parameter_list|)
block|{
if|if
condition|(
name|nsec3_rr
operator|&&
operator|(
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
operator|||
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3PARAM
operator|)
operator|&&
operator|(
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|0
argument_list|)
operator|!=
name|NULL
operator|)
operator|&&
name|ldns_rdf_size
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|0
argument_list|)
argument_list|)
operator|>
literal|0
condition|)
block|{
return|return
name|ldns_rdf2native_int8
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|0
argument_list|)
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|uint8_t
name|ldns_nsec3_flags
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec3_rr
parameter_list|)
block|{
if|if
condition|(
name|nsec3_rr
operator|&&
operator|(
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
operator|||
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3PARAM
operator|)
operator|&&
operator|(
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|1
argument_list|)
operator|!=
name|NULL
operator|)
operator|&&
name|ldns_rdf_size
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|1
argument_list|)
argument_list|)
operator|>
literal|0
condition|)
block|{
return|return
name|ldns_rdf2native_int8
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|1
argument_list|)
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|bool
name|ldns_nsec3_optout
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec3_rr
parameter_list|)
block|{
return|return
operator|(
name|ldns_nsec3_flags
argument_list|(
name|nsec3_rr
argument_list|)
operator|&
name|LDNS_NSEC3_VARS_OPTOUT_MASK
operator|)
return|;
block|}
end_function

begin_function
name|uint16_t
name|ldns_nsec3_iterations
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec3_rr
parameter_list|)
block|{
if|if
condition|(
name|nsec3_rr
operator|&&
operator|(
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
operator|||
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3PARAM
operator|)
operator|&&
operator|(
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|2
argument_list|)
operator|!=
name|NULL
operator|)
operator|&&
name|ldns_rdf_size
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|2
argument_list|)
argument_list|)
operator|>
literal|0
condition|)
block|{
return|return
name|ldns_rdf2native_int16
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|2
argument_list|)
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_nsec3_salt
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec3_rr
parameter_list|)
block|{
if|if
condition|(
name|nsec3_rr
operator|&&
operator|(
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
operator|||
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3PARAM
operator|)
condition|)
block|{
return|return
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|3
argument_list|)
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|uint8_t
name|ldns_nsec3_salt_length
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec3_rr
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|salt_rdf
init|=
name|ldns_nsec3_salt
argument_list|(
name|nsec3_rr
argument_list|)
decl_stmt|;
if|if
condition|(
name|salt_rdf
operator|&&
name|ldns_rdf_size
argument_list|(
name|salt_rdf
argument_list|)
operator|>
literal|0
condition|)
block|{
return|return
operator|(
name|uint8_t
operator|)
name|ldns_rdf_data
argument_list|(
name|salt_rdf
argument_list|)
index|[
literal|0
index|]
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* allocs data, free with LDNS_FREE() */
end_comment

begin_function
name|uint8_t
modifier|*
name|ldns_nsec3_salt_data
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec3_rr
parameter_list|)
block|{
name|uint8_t
name|salt_length
decl_stmt|;
name|uint8_t
modifier|*
name|salt
decl_stmt|;
name|ldns_rdf
modifier|*
name|salt_rdf
init|=
name|ldns_nsec3_salt
argument_list|(
name|nsec3_rr
argument_list|)
decl_stmt|;
if|if
condition|(
name|salt_rdf
operator|&&
name|ldns_rdf_size
argument_list|(
name|salt_rdf
argument_list|)
operator|>
literal|0
condition|)
block|{
name|salt_length
operator|=
name|ldns_rdf_data
argument_list|(
name|salt_rdf
argument_list|)
index|[
literal|0
index|]
expr_stmt|;
name|salt
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|salt_length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|salt
condition|)
return|return
name|NULL
return|;
name|memcpy
argument_list|(
name|salt
argument_list|,
operator|&
name|ldns_rdf_data
argument_list|(
name|salt_rdf
argument_list|)
index|[
literal|1
index|]
argument_list|,
name|salt_length
argument_list|)
expr_stmt|;
return|return
name|salt
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_nsec3_next_owner
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec3_rr
parameter_list|)
block|{
if|if
condition|(
operator|!
name|nsec3_rr
operator|||
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
return|return
name|NULL
return|;
block|}
else|else
block|{
return|return
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|4
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_nsec3_bitmap
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec3_rr
parameter_list|)
block|{
if|if
condition|(
operator|!
name|nsec3_rr
operator|||
name|ldns_rr_get_type
argument_list|(
name|nsec3_rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
return|return
name|NULL
return|;
block|}
else|else
block|{
return|return
name|ldns_rr_rdf
argument_list|(
name|nsec3_rr
argument_list|,
literal|5
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_nsec3_hash_name_frm_nsec3
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec
parameter_list|,
name|ldns_rdf
modifier|*
name|name
parameter_list|)
block|{
name|uint8_t
name|algorithm
decl_stmt|;
name|uint16_t
name|iterations
decl_stmt|;
name|uint8_t
name|salt_length
decl_stmt|;
name|uint8_t
modifier|*
name|salt
init|=
literal|0
decl_stmt|;
name|ldns_rdf
modifier|*
name|hashed_owner
decl_stmt|;
name|algorithm
operator|=
name|ldns_nsec3_algorithm
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|salt_length
operator|=
name|ldns_nsec3_salt_length
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|salt
operator|=
name|ldns_nsec3_salt_data
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|iterations
operator|=
name|ldns_nsec3_iterations
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|hashed_owner
operator|=
name|ldns_nsec3_hash_name
argument_list|(
name|name
argument_list|,
name|algorithm
argument_list|,
name|iterations
argument_list|,
name|salt_length
argument_list|,
name|salt
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|salt
argument_list|)
expr_stmt|;
return|return
name|hashed_owner
return|;
block|}
end_function

begin_function
name|bool
name|ldns_nsec_bitmap_covers_type
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|bitmap
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|uint8_t
modifier|*
name|dptr
decl_stmt|;
name|uint8_t
modifier|*
name|dend
decl_stmt|;
comment|/* From RFC3845 Section 2.1.2: 	 * 	 *	"The RR type space is split into 256 window blocks, each re- 	 *	 presenting the low-order 8 bits of the 16-bit RR type space." 	 */
name|uint8_t
name|window
init|=
name|type
operator|>>
literal|8
decl_stmt|;
name|uint8_t
name|subtype
init|=
name|type
operator|&
literal|0xff
decl_stmt|;
if|if
condition|(
operator|!
name|bitmap
condition|)
block|{
return|return
name|false
return|;
block|}
name|assert
argument_list|(
name|ldns_rdf_get_type
argument_list|(
name|bitmap
argument_list|)
operator|==
name|LDNS_RDF_TYPE_BITMAP
argument_list|)
expr_stmt|;
name|dptr
operator|=
name|ldns_rdf_data
argument_list|(
name|bitmap
argument_list|)
expr_stmt|;
name|dend
operator|=
name|ldns_rdf_data
argument_list|(
name|bitmap
argument_list|)
operator|+
name|ldns_rdf_size
argument_list|(
name|bitmap
argument_list|)
expr_stmt|;
comment|/* Type Bitmap = ( Window Block # | Bitmap Length | Bitmap ) + 	 *                 dptr[0]          dptr[1]         dptr[2:] 	 */
while|while
condition|(
name|dptr
operator|<
name|dend
operator|&&
name|dptr
index|[
literal|0
index|]
operator|<=
name|window
condition|)
block|{
if|if
condition|(
name|dptr
index|[
literal|0
index|]
operator|==
name|window
operator|&&
name|subtype
operator|/
literal|8
operator|<
name|dptr
index|[
literal|1
index|]
operator|&&
name|dptr
operator|+
name|dptr
index|[
literal|1
index|]
operator|+
literal|2
operator|<=
name|dend
condition|)
block|{
return|return
name|dptr
index|[
literal|2
operator|+
name|subtype
operator|/
literal|8
index|]
operator|&
operator|(
literal|0x80
operator|>>
operator|(
name|subtype
operator|%
literal|8
operator|)
operator|)
return|;
block|}
name|dptr
operator|+=
name|dptr
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
comment|/* next window */
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_nsec_bitmap_set_type
parameter_list|(
name|ldns_rdf
modifier|*
name|bitmap
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|uint8_t
modifier|*
name|dptr
decl_stmt|;
name|uint8_t
modifier|*
name|dend
decl_stmt|;
comment|/* From RFC3845 Section 2.1.2: 	 * 	 *	"The RR type space is split into 256 window blocks, each re- 	 *	 presenting the low-order 8 bits of the 16-bit RR type space." 	 */
name|uint8_t
name|window
init|=
name|type
operator|>>
literal|8
decl_stmt|;
name|uint8_t
name|subtype
init|=
name|type
operator|&
literal|0xff
decl_stmt|;
if|if
condition|(
operator|!
name|bitmap
condition|)
block|{
return|return
name|false
return|;
block|}
name|assert
argument_list|(
name|ldns_rdf_get_type
argument_list|(
name|bitmap
argument_list|)
operator|==
name|LDNS_RDF_TYPE_BITMAP
argument_list|)
expr_stmt|;
name|dptr
operator|=
name|ldns_rdf_data
argument_list|(
name|bitmap
argument_list|)
expr_stmt|;
name|dend
operator|=
name|ldns_rdf_data
argument_list|(
name|bitmap
argument_list|)
operator|+
name|ldns_rdf_size
argument_list|(
name|bitmap
argument_list|)
expr_stmt|;
comment|/* Type Bitmap = ( Window Block # | Bitmap Length | Bitmap ) + 	 *                 dptr[0]          dptr[1]         dptr[2:] 	 */
while|while
condition|(
name|dptr
operator|<
name|dend
operator|&&
name|dptr
index|[
literal|0
index|]
operator|<=
name|window
condition|)
block|{
if|if
condition|(
name|dptr
index|[
literal|0
index|]
operator|==
name|window
operator|&&
name|subtype
operator|/
literal|8
operator|<
name|dptr
index|[
literal|1
index|]
operator|&&
name|dptr
operator|+
name|dptr
index|[
literal|1
index|]
operator|+
literal|2
operator|<=
name|dend
condition|)
block|{
name|dptr
index|[
literal|2
operator|+
name|subtype
operator|/
literal|8
index|]
operator||=
operator|(
literal|0x80
operator|>>
operator|(
name|subtype
operator|%
literal|8
operator|)
operator|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
name|dptr
operator|+=
name|dptr
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
comment|/* next window */
block|}
return|return
name|LDNS_STATUS_TYPE_NOT_IN_BITMAP
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_nsec_bitmap_clear_type
parameter_list|(
name|ldns_rdf
modifier|*
name|bitmap
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|uint8_t
modifier|*
name|dptr
decl_stmt|;
name|uint8_t
modifier|*
name|dend
decl_stmt|;
comment|/* From RFC3845 Section 2.1.2: 	 * 	 *	"The RR type space is split into 256 window blocks, each re- 	 *	 presenting the low-order 8 bits of the 16-bit RR type space." 	 */
name|uint8_t
name|window
init|=
name|type
operator|>>
literal|8
decl_stmt|;
name|uint8_t
name|subtype
init|=
name|type
operator|&
literal|0xff
decl_stmt|;
if|if
condition|(
operator|!
name|bitmap
condition|)
block|{
return|return
name|false
return|;
block|}
name|assert
argument_list|(
name|ldns_rdf_get_type
argument_list|(
name|bitmap
argument_list|)
operator|==
name|LDNS_RDF_TYPE_BITMAP
argument_list|)
expr_stmt|;
name|dptr
operator|=
name|ldns_rdf_data
argument_list|(
name|bitmap
argument_list|)
expr_stmt|;
name|dend
operator|=
name|ldns_rdf_data
argument_list|(
name|bitmap
argument_list|)
operator|+
name|ldns_rdf_size
argument_list|(
name|bitmap
argument_list|)
expr_stmt|;
comment|/* Type Bitmap = ( Window Block # | Bitmap Length | Bitmap ) + 	 *                 dptr[0]          dptr[1]         dptr[2:] 	 */
while|while
condition|(
name|dptr
operator|<
name|dend
operator|&&
name|dptr
index|[
literal|0
index|]
operator|<=
name|window
condition|)
block|{
if|if
condition|(
name|dptr
index|[
literal|0
index|]
operator|==
name|window
operator|&&
name|subtype
operator|/
literal|8
operator|<
name|dptr
index|[
literal|1
index|]
operator|&&
name|dptr
operator|+
name|dptr
index|[
literal|1
index|]
operator|+
literal|2
operator|<=
name|dend
condition|)
block|{
name|dptr
index|[
literal|2
operator|+
name|subtype
operator|/
literal|8
index|]
operator|&=
operator|~
operator|(
literal|0x80
operator|>>
operator|(
name|subtype
operator|%
literal|8
operator|)
operator|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
name|dptr
operator|+=
name|dptr
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
comment|/* next window */
block|}
return|return
name|LDNS_STATUS_TYPE_NOT_IN_BITMAP
return|;
block|}
end_function

begin_function
name|bool
name|ldns_nsec_covers_name
parameter_list|(
specifier|const
name|ldns_rr
modifier|*
name|nsec
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|nsec_owner
init|=
name|ldns_rr_owner
argument_list|(
name|nsec
argument_list|)
decl_stmt|;
name|ldns_rdf
modifier|*
name|hash_next
decl_stmt|;
name|char
modifier|*
name|next_hash_str
decl_stmt|;
name|ldns_rdf
modifier|*
name|nsec_next
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|ldns_rdf
modifier|*
name|chopped_dname
decl_stmt|;
name|bool
name|result
decl_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|nsec
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC
condition|)
block|{
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|nsec
argument_list|,
literal|0
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|nsec_next
operator|=
name|ldns_rdf_clone
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|nsec
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
name|false
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|nsec
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
name|hash_next
operator|=
name|ldns_nsec3_next_owner
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|next_hash_str
operator|=
name|ldns_rdf2str
argument_list|(
name|hash_next
argument_list|)
expr_stmt|;
name|nsec_next
operator|=
name|ldns_dname_new_frm_str
argument_list|(
name|next_hash_str
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|next_hash_str
argument_list|)
expr_stmt|;
name|chopped_dname
operator|=
name|ldns_dname_left_chop
argument_list|(
name|nsec_owner
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_dname_cat
argument_list|(
name|nsec_next
argument_list|,
name|chopped_dname
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|chopped_dname
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"error catting: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ldns_rdf_deep_free
argument_list|(
name|nsec_next
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* in the case of the last nsec */
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|nsec_owner
argument_list|,
name|nsec_next
argument_list|)
operator|>
literal|0
condition|)
block|{
name|result
operator|=
operator|(
name|ldns_dname_compare
argument_list|(
name|nsec_owner
argument_list|,
name|name
argument_list|)
operator|<=
literal|0
operator|||
name|ldns_dname_compare
argument_list|(
name|name
argument_list|,
name|nsec_next
argument_list|)
operator|<
literal|0
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|nsec_owner
argument_list|,
name|nsec_next
argument_list|)
operator|<
literal|0
condition|)
block|{
name|result
operator|=
operator|(
name|ldns_dname_compare
argument_list|(
name|nsec_owner
argument_list|,
name|name
argument_list|)
operator|<=
literal|0
operator|&&
name|ldns_dname_compare
argument_list|(
name|name
argument_list|,
name|nsec_next
argument_list|)
operator|<
literal|0
operator|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|true
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|nsec_next
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_comment
comment|/* sig may be null - if so look in the packet */
end_comment

begin_function
name|ldns_status
name|ldns_pkt_verify_time
parameter_list|(
name|ldns_pkt
modifier|*
name|p
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rdf
modifier|*
name|o
parameter_list|,
name|ldns_rr_list
modifier|*
name|k
parameter_list|,
name|ldns_rr_list
modifier|*
name|s
parameter_list|,
name|time_t
name|check_time
parameter_list|,
name|ldns_rr_list
modifier|*
name|good_keys
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|rrset
decl_stmt|;
name|ldns_rr_list
modifier|*
name|sigs
decl_stmt|;
name|ldns_rr_list
modifier|*
name|sigs_covered
decl_stmt|;
name|ldns_rdf
modifier|*
name|rdf_t
decl_stmt|;
name|ldns_rr_type
name|t_netorder
decl_stmt|;
if|if
condition|(
operator|!
name|k
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
comment|/* return LDNS_STATUS_CRYPTO_NO_DNSKEY; */
block|}
if|if
condition|(
name|t
operator|==
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
comment|/* we don't have RRSIG(RRSIG) (yet? ;-) ) */
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
name|s
condition|)
block|{
comment|/* if s is not NULL, the sigs are given to use */
name|sigs
operator|=
name|s
expr_stmt|;
block|}
else|else
block|{
comment|/* otherwise get them from the packet */
name|sigs
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|p
argument_list|,
name|o
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sigs
condition|)
block|{
comment|/* no sigs */
return|return
name|LDNS_STATUS_ERR
return|;
comment|/* return LDNS_STATUS_CRYPTO_NO_RRSIG; */
block|}
block|}
comment|/* rrsig are subtyped, so now we need to find the correct 	 * sigs for the type t 	 */
name|t_netorder
operator|=
name|htons
argument_list|(
name|t
argument_list|)
expr_stmt|;
comment|/* rdf are in network order! */
comment|/* a type identifier is a 16-bit number, so the size is 2 bytes */
name|rdf_t
operator|=
name|ldns_rdf_new
argument_list|(
name|LDNS_RDF_TYPE_TYPE
argument_list|,
literal|2
argument_list|,
operator|&
name|t_netorder
argument_list|)
expr_stmt|;
name|sigs_covered
operator|=
name|ldns_rr_list_subtype_by_rdf
argument_list|(
name|sigs
argument_list|,
name|rdf_t
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|rdf_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sigs_covered
condition|)
block|{
if|if
condition|(
operator|!
name|s
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|sigs
argument_list|)
expr_stmt|;
block|}
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|sigs_covered
argument_list|)
expr_stmt|;
name|rrset
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|p
argument_list|,
name|o
argument_list|,
name|t
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rrset
condition|)
block|{
if|if
condition|(
operator|!
name|s
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|sigs
argument_list|)
expr_stmt|;
block|}
return|return
name|LDNS_STATUS_ERR
return|;
block|}
return|return
name|ldns_verify_time
argument_list|(
name|rrset
argument_list|,
name|sigs
argument_list|,
name|k
argument_list|,
name|check_time
argument_list|,
name|good_keys
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_pkt_verify
parameter_list|(
name|ldns_pkt
modifier|*
name|p
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rdf
modifier|*
name|o
parameter_list|,
name|ldns_rr_list
modifier|*
name|k
parameter_list|,
name|ldns_rr_list
modifier|*
name|s
parameter_list|,
name|ldns_rr_list
modifier|*
name|good_keys
parameter_list|)
block|{
return|return
name|ldns_pkt_verify_time
argument_list|(
name|p
argument_list|,
name|t
argument_list|,
name|o
argument_list|,
name|k
argument_list|,
name|s
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|good_keys
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_function
name|ldns_status
name|ldns_dnssec_chain_nsec3_list
parameter_list|(
name|ldns_rr_list
modifier|*
name|nsec3_rrs
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|char
modifier|*
name|next_nsec_owner_str
decl_stmt|;
name|ldns_rdf
modifier|*
name|next_nsec_owner_label
decl_stmt|;
name|ldns_rdf
modifier|*
name|next_nsec_rdf
decl_stmt|;
name|ldns_status
name|status
init|=
name|LDNS_STATUS_OK
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsec3_rrs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
name|ldns_rr_list_rr_count
argument_list|(
name|nsec3_rrs
argument_list|)
operator|-
literal|1
condition|)
block|{
name|next_nsec_owner_label
operator|=
name|ldns_dname_label
argument_list|(
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsec3_rrs
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|next_nsec_owner_str
operator|=
name|ldns_rdf2str
argument_list|(
name|next_nsec_owner_label
argument_list|)
expr_stmt|;
if|if
condition|(
name|next_nsec_owner_str
index|[
name|strlen
argument_list|(
name|next_nsec_owner_str
argument_list|)
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|)
block|{
name|next_nsec_owner_str
index|[
name|strlen
argument_list|(
name|next_nsec_owner_str
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|status
operator|=
name|ldns_str2rdf_b32_ext
argument_list|(
operator|&
name|next_nsec_rdf
argument_list|,
name|next_nsec_owner_str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ldns_rr_set_rdf
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsec3_rrs
argument_list|,
name|i
argument_list|)
argument_list|,
name|next_nsec_rdf
argument_list|,
literal|4
argument_list|)
condition|)
block|{
comment|/* todo: error */
block|}
name|ldns_rdf_deep_free
argument_list|(
name|next_nsec_owner_label
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|next_nsec_owner_str
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|next_nsec_owner_label
operator|=
name|ldns_dname_label
argument_list|(
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsec3_rrs
argument_list|,
name|i
operator|+
literal|1
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|next_nsec_owner_str
operator|=
name|ldns_rdf2str
argument_list|(
name|next_nsec_owner_label
argument_list|)
expr_stmt|;
if|if
condition|(
name|next_nsec_owner_str
index|[
name|strlen
argument_list|(
name|next_nsec_owner_str
argument_list|)
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|)
block|{
name|next_nsec_owner_str
index|[
name|strlen
argument_list|(
name|next_nsec_owner_str
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|status
operator|=
name|ldns_str2rdf_b32_ext
argument_list|(
operator|&
name|next_nsec_rdf
argument_list|,
name|next_nsec_owner_str
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|next_nsec_owner_label
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|next_nsec_owner_str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ldns_rr_set_rdf
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsec3_rrs
argument_list|,
name|i
argument_list|)
argument_list|,
name|next_nsec_rdf
argument_list|,
literal|4
argument_list|)
condition|)
block|{
comment|/* todo: error */
block|}
block|}
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|int
name|qsort_rr_compare_nsec3
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
specifier|const
name|ldns_rr
modifier|*
name|rr1
init|=
operator|*
operator|(
specifier|const
name|ldns_rr
operator|*
operator|*
operator|)
name|a
decl_stmt|;
specifier|const
name|ldns_rr
modifier|*
name|rr2
init|=
operator|*
operator|(
specifier|const
name|ldns_rr
operator|*
operator|*
operator|)
name|b
decl_stmt|;
if|if
condition|(
name|rr1
operator|==
name|NULL
operator|&&
name|rr2
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|rr1
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|rr2
operator|==
name|NULL
condition|)
block|{
return|return
literal|1
return|;
block|}
return|return
name|ldns_rdf_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr1
argument_list|)
argument_list|,
name|ldns_rr_owner
argument_list|(
name|rr2
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ldns_rr_list_sort_nsec3
parameter_list|(
name|ldns_rr_list
modifier|*
name|unsorted
parameter_list|)
block|{
name|qsort
argument_list|(
name|unsorted
operator|->
name|_rrs
argument_list|,
name|ldns_rr_list_rr_count
argument_list|(
name|unsorted
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ldns_rr
operator|*
argument_list|)
argument_list|,
name|qsort_rr_compare_nsec3
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|int
name|ldns_dnssec_default_add_to_signatures
argument_list|(
name|ATTR_UNUSED
argument_list|(
name|ldns_rr
operator|*
name|sig
argument_list|)
argument_list|,
name|ATTR_UNUSED
argument_list|(
name|void
operator|*
name|n
argument_list|)
argument_list|)
block|{
return|return
name|LDNS_SIGNATURE_LEAVE_ADD_NEW
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|int
name|ldns_dnssec_default_leave_signatures
argument_list|(
name|ATTR_UNUSED
argument_list|(
name|ldns_rr
operator|*
name|sig
argument_list|)
argument_list|,
name|ATTR_UNUSED
argument_list|(
name|void
operator|*
name|n
argument_list|)
argument_list|)
block|{
return|return
name|LDNS_SIGNATURE_LEAVE_NO_ADD
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|int
name|ldns_dnssec_default_delete_signatures
argument_list|(
name|ATTR_UNUSED
argument_list|(
name|ldns_rr
operator|*
name|sig
argument_list|)
argument_list|,
name|ATTR_UNUSED
argument_list|(
name|void
operator|*
name|n
argument_list|)
argument_list|)
block|{
return|return
name|LDNS_SIGNATURE_REMOVE_NO_ADD
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|int
name|ldns_dnssec_default_replace_signatures
argument_list|(
name|ATTR_UNUSED
argument_list|(
name|ldns_rr
operator|*
name|sig
argument_list|)
argument_list|,
name|ATTR_UNUSED
argument_list|(
name|void
operator|*
name|n
argument_list|)
argument_list|)
block|{
return|return
name|LDNS_SIGNATURE_REMOVE_ADD_NEW
return|;
block|}
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
name|ldns_rdf
modifier|*
name|ldns_convert_dsa_rrsig_asn12rdf
parameter_list|(
specifier|const
name|ldns_buffer
modifier|*
name|sig
parameter_list|,
specifier|const
name|long
name|sig_len
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|sigdata_rdf
decl_stmt|;
name|DSA_SIG
modifier|*
name|dsasig
decl_stmt|;
name|unsigned
name|char
modifier|*
name|dsasig_data
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|sig
argument_list|)
decl_stmt|;
name|size_t
name|byte_offset
decl_stmt|;
name|dsasig
operator|=
name|d2i_DSA_SIG
argument_list|(
name|NULL
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|*
operator|)
operator|&
name|dsasig_data
argument_list|,
name|sig_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsasig
condition|)
block|{
name|DSA_SIG_free
argument_list|(
name|dsasig
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|dsasig_data
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
literal|41
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsasig_data
condition|)
block|{
name|DSA_SIG_free
argument_list|(
name|dsasig
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|dsasig_data
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|byte_offset
operator|=
call|(
name|size_t
call|)
argument_list|(
literal|20
operator|-
name|BN_num_bytes
argument_list|(
name|dsasig
operator|->
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|byte_offset
operator|>
literal|20
condition|)
block|{
name|DSA_SIG_free
argument_list|(
name|dsasig
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|dsasig_data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|dsasig_data
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
name|byte_offset
argument_list|)
expr_stmt|;
name|BN_bn2bin
argument_list|(
name|dsasig
operator|->
name|r
argument_list|,
operator|&
name|dsasig_data
index|[
literal|1
operator|+
name|byte_offset
index|]
argument_list|)
expr_stmt|;
name|byte_offset
operator|=
call|(
name|size_t
call|)
argument_list|(
literal|20
operator|-
name|BN_num_bytes
argument_list|(
name|dsasig
operator|->
name|s
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|byte_offset
operator|>
literal|20
condition|)
block|{
name|DSA_SIG_free
argument_list|(
name|dsasig
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|dsasig_data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|dsasig_data
index|[
literal|21
index|]
argument_list|,
literal|0
argument_list|,
name|byte_offset
argument_list|)
expr_stmt|;
name|BN_bn2bin
argument_list|(
name|dsasig
operator|->
name|s
argument_list|,
operator|&
name|dsasig_data
index|[
literal|21
operator|+
name|byte_offset
index|]
argument_list|)
expr_stmt|;
name|sigdata_rdf
operator|=
name|ldns_rdf_new
argument_list|(
name|LDNS_RDF_TYPE_B64
argument_list|,
literal|41
argument_list|,
name|dsasig_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sigdata_rdf
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|dsasig_data
argument_list|)
expr_stmt|;
block|}
name|DSA_SIG_free
argument_list|(
name|dsasig
argument_list|)
expr_stmt|;
return|return
name|sigdata_rdf
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_convert_dsa_rrsig_rdf2asn1
parameter_list|(
name|ldns_buffer
modifier|*
name|target_buffer
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|sig_rdf
parameter_list|)
block|{
comment|/* the EVP api wants the DER encoding of the signature... */
name|BIGNUM
modifier|*
name|R
decl_stmt|,
modifier|*
name|S
decl_stmt|;
name|DSA_SIG
modifier|*
name|dsasig
decl_stmt|;
name|unsigned
name|char
modifier|*
name|raw_sig
init|=
name|NULL
decl_stmt|;
name|int
name|raw_sig_len
decl_stmt|;
if|if
condition|(
name|ldns_rdf_size
argument_list|(
name|sig_rdf
argument_list|)
operator|<
literal|1
operator|+
literal|2
operator|*
name|SHA_DIGEST_LENGTH
condition|)
return|return
name|LDNS_STATUS_SYNTAX_RDATA_ERR
return|;
comment|/* extract the R and S field from the sig buffer */
name|R
operator|=
name|BN_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|R
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
operator|(
name|void
operator|)
name|BN_bin2bn
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_rdf_data
argument_list|(
name|sig_rdf
argument_list|)
operator|+
literal|1
argument_list|,
name|SHA_DIGEST_LENGTH
argument_list|,
name|R
argument_list|)
expr_stmt|;
name|S
operator|=
name|BN_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|S
condition|)
block|{
name|BN_free
argument_list|(
name|R
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
operator|(
name|void
operator|)
name|BN_bin2bn
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_rdf_data
argument_list|(
name|sig_rdf
argument_list|)
operator|+
literal|21
argument_list|,
name|SHA_DIGEST_LENGTH
argument_list|,
name|S
argument_list|)
expr_stmt|;
name|dsasig
operator|=
name|DSA_SIG_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|dsasig
condition|)
block|{
name|BN_free
argument_list|(
name|R
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|S
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|dsasig
operator|->
name|r
operator|=
name|R
expr_stmt|;
name|dsasig
operator|->
name|s
operator|=
name|S
expr_stmt|;
name|raw_sig_len
operator|=
name|i2d_DSA_SIG
argument_list|(
name|dsasig
argument_list|,
operator|&
name|raw_sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|raw_sig_len
operator|<
literal|0
condition|)
block|{
name|DSA_SIG_free
argument_list|(
name|dsasig
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raw_sig
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_SSL_ERR
return|;
block|}
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|target_buffer
argument_list|,
operator|(
name|size_t
operator|)
name|raw_sig_len
argument_list|)
condition|)
block|{
name|ldns_buffer_write
argument_list|(
name|target_buffer
argument_list|,
name|raw_sig
argument_list|,
operator|(
name|size_t
operator|)
name|raw_sig_len
argument_list|)
expr_stmt|;
block|}
name|DSA_SIG_free
argument_list|(
name|dsasig
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|raw_sig
argument_list|)
expr_stmt|;
return|return
name|ldns_buffer_status
argument_list|(
name|target_buffer
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|USE_ECDSA
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|S_SPLINT_S
end_ifndef

begin_function
name|ldns_rdf
modifier|*
name|ldns_convert_ecdsa_rrsig_asn12rdf
parameter_list|(
specifier|const
name|ldns_buffer
modifier|*
name|sig
parameter_list|,
specifier|const
name|long
name|sig_len
parameter_list|)
block|{
name|ECDSA_SIG
modifier|*
name|ecdsa_sig
decl_stmt|;
name|unsigned
name|char
modifier|*
name|data
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|sig
argument_list|)
decl_stmt|;
name|ldns_rdf
modifier|*
name|rdf
decl_stmt|;
name|ecdsa_sig
operator|=
name|d2i_ECDSA_SIG
argument_list|(
name|NULL
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|*
operator|)
operator|&
name|data
argument_list|,
name|sig_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ecdsa_sig
condition|)
return|return
name|NULL
return|;
comment|/* "r | s". */
name|data
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|BN_num_bytes(ecdsa_sig->r) + BN_num_bytes(ecdsa_sig->s)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
block|{
name|ECDSA_SIG_free
argument_list|(
name|ecdsa_sig
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|BN_bn2bin
argument_list|(
name|ecdsa_sig
operator|->
name|r
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|BN_bn2bin
argument_list|(
name|ecdsa_sig
operator|->
name|s
argument_list|,
name|data
operator|+
name|BN_num_bytes
argument_list|(
name|ecdsa_sig
operator|->
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|rdf
operator|=
name|ldns_rdf_new
argument_list|(
name|LDNS_RDF_TYPE_B64
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|BN_num_bytes
argument_list|(
name|ecdsa_sig
operator|->
name|r
argument_list|)
operator|+
name|BN_num_bytes
argument_list|(
name|ecdsa_sig
operator|->
name|s
argument_list|)
argument_list|)
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|ECDSA_SIG_free
argument_list|(
name|ecdsa_sig
argument_list|)
expr_stmt|;
return|return
name|rdf
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_convert_ecdsa_rrsig_rdf2asn1
parameter_list|(
name|ldns_buffer
modifier|*
name|target_buffer
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|sig_rdf
parameter_list|)
block|{
name|ECDSA_SIG
modifier|*
name|sig
decl_stmt|;
name|int
name|raw_sig_len
decl_stmt|;
name|long
name|bnsize
init|=
operator|(
name|long
operator|)
name|ldns_rdf_size
argument_list|(
name|sig_rdf
argument_list|)
operator|/
literal|2
decl_stmt|;
comment|/* if too short, or not even length, do not bother */
if|if
condition|(
name|bnsize
operator|<
literal|16
operator|||
operator|(
name|size_t
operator|)
name|bnsize
operator|*
literal|2
operator|!=
name|ldns_rdf_size
argument_list|(
name|sig_rdf
argument_list|)
condition|)
return|return
name|LDNS_STATUS_ERR
return|;
comment|/* use the raw data to parse two evenly long BIGNUMs, "r | s". */
name|sig
operator|=
name|ECDSA_SIG_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|sig
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
name|sig
operator|->
name|r
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|ldns_rdf_data
argument_list|(
name|sig_rdf
argument_list|)
argument_list|,
name|bnsize
argument_list|,
name|sig
operator|->
name|r
argument_list|)
expr_stmt|;
name|sig
operator|->
name|s
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|ldns_rdf_data
argument_list|(
name|sig_rdf
argument_list|)
operator|+
name|bnsize
argument_list|,
name|bnsize
argument_list|,
name|sig
operator|->
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sig
operator|->
name|r
operator|||
operator|!
name|sig
operator|->
name|s
condition|)
block|{
name|ECDSA_SIG_free
argument_list|(
name|sig
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|raw_sig_len
operator|=
name|i2d_ECDSA_SIG
argument_list|(
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|target_buffer
argument_list|,
operator|(
name|size_t
operator|)
name|raw_sig_len
argument_list|)
condition|)
block|{
name|unsigned
name|char
modifier|*
name|pp
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_current
argument_list|(
name|target_buffer
argument_list|)
decl_stmt|;
name|raw_sig_len
operator|=
name|i2d_ECDSA_SIG
argument_list|(
name|sig
argument_list|,
operator|&
name|pp
argument_list|)
expr_stmt|;
name|ldns_buffer_skip
argument_list|(
name|target_buffer
argument_list|,
operator|(
name|ssize_t
operator|)
name|raw_sig_len
argument_list|)
expr_stmt|;
block|}
name|ECDSA_SIG_free
argument_list|(
name|sig
argument_list|)
expr_stmt|;
return|return
name|ldns_buffer_status
argument_list|(
name|target_buffer
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* S_SPLINT_S */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USE_ECDSA */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * dname.c  *  * dname specific rdata implementations  * A dname is a rdf structure with type LDNS_RDF_TYPE_DNAME  * It is not a /real/ type! All function must therefor check  * for LDNS_RDF_TYPE_DNAME.  *  * a Net::DNS like library for C  *  * (c) NLnet Labs, 2004-2006  *  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETINET_IN_H
end_ifdef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_SOCKET_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETDB_H
end_ifdef

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_ARPA_INET_H
end_ifdef

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Returns whether the last label in the name is a root label (a empty label).  * Note that it is not enough to just test the last character to be 0,  * because it may be part of the last label itself.  */
end_comment

begin_function
specifier|static
name|bool
name|ldns_dname_last_label_is_root_label
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|dname
parameter_list|)
block|{
name|size_t
name|src_pos
decl_stmt|;
name|size_t
name|len
init|=
literal|0
decl_stmt|;
for|for
control|(
name|src_pos
operator|=
literal|0
init|;
name|src_pos
operator|<
name|ldns_rdf_size
argument_list|(
name|dname
argument_list|)
condition|;
name|src_pos
operator|+=
name|len
operator|+
literal|1
control|)
block|{
name|len
operator|=
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
index|[
name|src_pos
index|]
expr_stmt|;
block|}
name|assert
argument_list|(
name|src_pos
operator|==
name|ldns_rdf_size
argument_list|(
name|dname
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|src_pos
operator|>
literal|0
operator|&&
name|len
operator|==
literal|0
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_dname_cat_clone
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|rd1
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|rd2
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|new
decl_stmt|;
name|uint16_t
name|new_size
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|uint16_t
name|left_size
decl_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|rd1
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
operator|||
name|ldns_rdf_get_type
argument_list|(
name|rd2
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* remove root label if it is present at the end of the left 	 * rd, by reducing the size with 1 	 */
name|left_size
operator|=
name|ldns_rdf_size
argument_list|(
name|rd1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dname_last_label_is_root_label
argument_list|(
name|rd1
argument_list|)
condition|)
block|{
name|left_size
operator|--
expr_stmt|;
block|}
comment|/* we overwrite the nullbyte of rd1 */
name|new_size
operator|=
name|left_size
operator|+
name|ldns_rdf_size
argument_list|(
name|rd2
argument_list|)
expr_stmt|;
name|buf
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|new_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* put the two dname's after each other */
name|memcpy
argument_list|(
name|buf
argument_list|,
name|ldns_rdf_data
argument_list|(
name|rd1
argument_list|)
argument_list|,
name|left_size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
operator|+
name|left_size
argument_list|,
name|ldns_rdf_data
argument_list|(
name|rd2
argument_list|)
argument_list|,
name|ldns_rdf_size
argument_list|(
name|rd2
argument_list|)
argument_list|)
expr_stmt|;
name|new
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|new_size
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|new
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_dname_cat
parameter_list|(
name|ldns_rdf
modifier|*
name|rd1
parameter_list|,
name|ldns_rdf
modifier|*
name|rd2
parameter_list|)
block|{
name|uint16_t
name|left_size
decl_stmt|;
name|uint16_t
name|size
decl_stmt|;
name|uint8_t
modifier|*
name|newd
decl_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|rd1
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
operator|||
name|ldns_rdf_get_type
argument_list|(
name|rd2
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
comment|/* remove root label if it is present at the end of the left 	 * rd, by reducing the size with 1 	 */
name|left_size
operator|=
name|ldns_rdf_size
argument_list|(
name|rd1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dname_last_label_is_root_label
argument_list|(
name|rd1
argument_list|)
condition|)
block|{
name|left_size
operator|--
expr_stmt|;
block|}
name|size
operator|=
name|left_size
operator|+
name|ldns_rdf_size
argument_list|(
name|rd2
argument_list|)
expr_stmt|;
name|newd
operator|=
name|LDNS_XREALLOC
argument_list|(
name|ldns_rdf_data
argument_list|(
name|rd1
argument_list|)
argument_list|,
name|uint8_t
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newd
condition|)
block|{
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|ldns_rdf_set_data
argument_list|(
name|rd1
argument_list|,
name|newd
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ldns_rdf_data
argument_list|(
name|rd1
argument_list|)
operator|+
name|left_size
argument_list|,
name|ldns_rdf_data
argument_list|(
name|rd2
argument_list|)
argument_list|,
name|ldns_rdf_size
argument_list|(
name|rd2
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rdf_set_size
argument_list|(
name|rd1
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_dname_reverse
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|dname
parameter_list|)
block|{
name|size_t
name|rd_size
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|ldns_rdf
modifier|*
name|new
decl_stmt|;
name|size_t
name|src_pos
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|assert
argument_list|(
name|ldns_rdf_get_type
argument_list|(
name|dname
argument_list|)
operator|==
name|LDNS_RDF_TYPE_DNAME
argument_list|)
expr_stmt|;
name|rd_size
operator|=
name|ldns_rdf_size
argument_list|(
name|dname
argument_list|)
expr_stmt|;
name|buf
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|rd_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|new
operator|=
name|ldns_rdf_new
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|rd_size
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* If dname ends in a root label, the reverse should too. 	 */
if|if
condition|(
name|ldns_dname_last_label_is_root_label
argument_list|(
name|dname
argument_list|)
condition|)
block|{
name|buf
index|[
name|rd_size
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|rd_size
operator|-=
literal|1
expr_stmt|;
block|}
for|for
control|(
name|src_pos
operator|=
literal|0
init|;
name|src_pos
operator|<
name|rd_size
condition|;
name|src_pos
operator|+=
name|len
operator|+
literal|1
control|)
block|{
name|len
operator|=
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
index|[
name|src_pos
index|]
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|buf
index|[
name|rd_size
operator|-
name|src_pos
operator|-
name|len
operator|-
literal|1
index|]
argument_list|,
operator|&
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
index|[
name|src_pos
index|]
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|new
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_dname_clone_from
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|d
parameter_list|,
name|uint16_t
name|n
parameter_list|)
block|{
name|uint8_t
modifier|*
name|data
decl_stmt|;
name|uint8_t
name|label_size
decl_stmt|;
name|size_t
name|data_size
decl_stmt|;
if|if
condition|(
operator|!
name|d
operator|||
name|ldns_rdf_get_type
argument_list|(
name|d
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
operator|||
name|ldns_dname_label_count
argument_list|(
name|d
argument_list|)
operator|<
name|n
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|data
operator|=
name|ldns_rdf_data
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|data_size
operator|=
name|ldns_rdf_size
argument_list|(
name|d
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|label_size
operator|=
name|data
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
name|data
operator|+=
name|label_size
expr_stmt|;
if|if
condition|(
name|data_size
operator|<
name|label_size
condition|)
block|{
comment|/* this label is very broken */
return|return
name|NULL
return|;
block|}
name|data_size
operator|-=
name|label_size
expr_stmt|;
name|n
operator|--
expr_stmt|;
block|}
return|return
name|ldns_dname_new_frm_data
argument_list|(
name|data_size
argument_list|,
name|data
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_dname_left_chop
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|d
parameter_list|)
block|{
name|uint8_t
name|label_pos
decl_stmt|;
name|ldns_rdf
modifier|*
name|chop
decl_stmt|;
if|if
condition|(
operator|!
name|d
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|d
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ldns_dname_label_count
argument_list|(
name|d
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* root label */
return|return
name|NULL
return|;
block|}
comment|/* 05blaat02nl00 */
name|label_pos
operator|=
name|ldns_rdf_data
argument_list|(
name|d
argument_list|)
index|[
literal|0
index|]
expr_stmt|;
name|chop
operator|=
name|ldns_dname_new_frm_data
argument_list|(
name|ldns_rdf_size
argument_list|(
name|d
argument_list|)
operator|-
name|label_pos
operator|-
literal|1
argument_list|,
name|ldns_rdf_data
argument_list|(
name|d
argument_list|)
operator|+
name|label_pos
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
name|chop
return|;
block|}
end_function

begin_function
name|uint8_t
name|ldns_dname_label_count
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|r
parameter_list|)
block|{
name|uint16_t
name|src_pos
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|size_t
name|r_size
decl_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
block|{
return|return
literal|0
return|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|src_pos
operator|=
literal|0
expr_stmt|;
name|r_size
operator|=
name|ldns_rdf_size
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|r
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
condition|)
block|{
return|return
literal|0
return|;
block|}
else|else
block|{
name|len
operator|=
name|ldns_rdf_data
argument_list|(
name|r
argument_list|)
index|[
name|src_pos
index|]
expr_stmt|;
comment|/* start of the label */
comment|/* single root label */
if|if
condition|(
literal|1
operator|==
name|r_size
condition|)
block|{
return|return
literal|0
return|;
block|}
else|else
block|{
while|while
condition|(
operator|(
name|len
operator|>
literal|0
operator|)
operator|&&
name|src_pos
operator|<
name|r_size
condition|)
block|{
name|src_pos
operator|++
expr_stmt|;
name|src_pos
operator|+=
name|len
expr_stmt|;
name|len
operator|=
name|ldns_rdf_data
argument_list|(
name|r
argument_list|)
index|[
name|src_pos
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
block|}
return|return
name|i
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_dname_new
parameter_list|(
name|uint16_t
name|s
parameter_list|,
name|void
modifier|*
name|d
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|rd
decl_stmt|;
name|rd
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_rdf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rd
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ldns_rdf_set_size
argument_list|(
name|rd
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|ldns_rdf_set_type
argument_list|(
name|rd
argument_list|,
name|LDNS_RDF_TYPE_DNAME
argument_list|)
expr_stmt|;
name|ldns_rdf_set_data
argument_list|(
name|rd
argument_list|,
name|d
argument_list|)
expr_stmt|;
return|return
name|rd
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_dname_new_frm_str
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
return|return
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|str
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_dname_new_frm_data
parameter_list|(
name|uint16_t
name|size
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|)
block|{
return|return
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|size
argument_list|,
name|data
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ldns_dname2canonical
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|rd
parameter_list|)
block|{
name|uint8_t
modifier|*
name|rdd
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|rd
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
condition|)
block|{
return|return;
block|}
name|rdd
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|ldns_rdf_data
argument_list|(
name|rd
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rdf_size
argument_list|(
name|rd
argument_list|)
condition|;
name|i
operator|++
operator|,
name|rdd
operator|++
control|)
block|{
operator|*
name|rdd
operator|=
operator|(
name|uint8_t
operator|)
name|LDNS_DNAME_NORMALIZE
argument_list|(
operator|(
name|int
operator|)
operator|*
name|rdd
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|bool
name|ldns_dname_is_subdomain
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|sub
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|parent
parameter_list|)
block|{
name|uint8_t
name|sub_lab
decl_stmt|;
name|uint8_t
name|par_lab
decl_stmt|;
name|int8_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ldns_rdf
modifier|*
name|tmp_sub
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|tmp_par
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|sub_clone
decl_stmt|;
name|ldns_rdf
modifier|*
name|parent_clone
decl_stmt|;
name|bool
name|result
init|=
name|true
decl_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|sub
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
operator|||
name|ldns_rdf_get_type
argument_list|(
name|parent
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
operator|||
name|ldns_rdf_compare
argument_list|(
name|sub
argument_list|,
name|parent
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|false
return|;
block|}
comment|/* would be nicer if we do not have to clone... */
name|sub_clone
operator|=
name|ldns_dname_clone_from
argument_list|(
name|sub
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|parent_clone
operator|=
name|ldns_dname_clone_from
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_dname2canonical
argument_list|(
name|sub_clone
argument_list|)
expr_stmt|;
name|ldns_dname2canonical
argument_list|(
name|parent_clone
argument_list|)
expr_stmt|;
name|sub_lab
operator|=
name|ldns_dname_label_count
argument_list|(
name|sub_clone
argument_list|)
expr_stmt|;
name|par_lab
operator|=
name|ldns_dname_label_count
argument_list|(
name|parent_clone
argument_list|)
expr_stmt|;
comment|/* if sub sits above parent, it cannot be a child/sub domain */
if|if
condition|(
name|sub_lab
operator|<
name|par_lab
condition|)
block|{
name|result
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
comment|/* check all labels the from the parent labels, from right to left. 		 * When they /all/ match we have found a subdomain 		 */
name|j
operator|=
name|sub_lab
operator|-
literal|1
expr_stmt|;
comment|/* we count from zero, thank you */
for|for
control|(
name|i
operator|=
name|par_lab
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|tmp_sub
operator|=
name|ldns_dname_label
argument_list|(
name|sub_clone
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|tmp_par
operator|=
name|ldns_dname_label
argument_list|(
name|parent_clone
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp_sub
operator|||
operator|!
name|tmp_par
condition|)
block|{
comment|/* deep free does null check */
name|ldns_rdf_deep_free
argument_list|(
name|tmp_sub
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|tmp_par
argument_list|)
expr_stmt|;
name|result
operator|=
name|false
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ldns_rdf_compare
argument_list|(
name|tmp_sub
argument_list|,
name|tmp_par
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* they are not equal */
name|ldns_rdf_deep_free
argument_list|(
name|tmp_sub
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|tmp_par
argument_list|)
expr_stmt|;
name|result
operator|=
name|false
expr_stmt|;
break|break;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|tmp_sub
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|tmp_par
argument_list|)
expr_stmt|;
name|j
operator|--
expr_stmt|;
block|}
block|}
name|ldns_rdf_deep_free
argument_list|(
name|sub_clone
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|parent_clone
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|int
name|ldns_dname_compare
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|dname1
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|dname2
parameter_list|)
block|{
name|size_t
name|lc1
decl_stmt|,
name|lc2
decl_stmt|,
name|lc1f
decl_stmt|,
name|lc2f
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|int
name|result
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|lp1
decl_stmt|,
modifier|*
name|lp2
decl_stmt|;
comment|/* see RFC4034 for this algorithm */
comment|/* this algorithm assumes the names are normalized to case */
comment|/* only when both are not NULL we can say anything about them */
if|if
condition|(
operator|!
name|dname1
operator|&&
operator|!
name|dname2
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|dname1
operator|||
operator|!
name|dname2
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
comment|/* asserts must happen later as we are looking in the 	 * dname, which could be NULL. But this case is handled 	 * above 	 */
name|assert
argument_list|(
name|ldns_rdf_get_type
argument_list|(
name|dname1
argument_list|)
operator|==
name|LDNS_RDF_TYPE_DNAME
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ldns_rdf_get_type
argument_list|(
name|dname2
argument_list|)
operator|==
name|LDNS_RDF_TYPE_DNAME
argument_list|)
expr_stmt|;
name|lc1
operator|=
name|ldns_dname_label_count
argument_list|(
name|dname1
argument_list|)
expr_stmt|;
name|lc2
operator|=
name|ldns_dname_label_count
argument_list|(
name|dname2
argument_list|)
expr_stmt|;
if|if
condition|(
name|lc1
operator|==
literal|0
operator|&&
name|lc2
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|lc1
operator|==
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|lc2
operator|==
literal|0
condition|)
block|{
return|return
literal|1
return|;
block|}
name|lc1
operator|--
expr_stmt|;
name|lc2
operator|--
expr_stmt|;
comment|/* we start at the last label */
while|while
condition|(
name|true
condition|)
block|{
comment|/* find the label first */
name|lc1f
operator|=
name|lc1
expr_stmt|;
name|lp1
operator|=
name|ldns_rdf_data
argument_list|(
name|dname1
argument_list|)
expr_stmt|;
while|while
condition|(
name|lc1f
operator|>
literal|0
condition|)
block|{
name|lp1
operator|+=
operator|*
name|lp1
operator|+
literal|1
expr_stmt|;
name|lc1f
operator|--
expr_stmt|;
block|}
comment|/* and find the other one */
name|lc2f
operator|=
name|lc2
expr_stmt|;
name|lp2
operator|=
name|ldns_rdf_data
argument_list|(
name|dname2
argument_list|)
expr_stmt|;
while|while
condition|(
name|lc2f
operator|>
literal|0
condition|)
block|{
name|lp2
operator|+=
operator|*
name|lp2
operator|+
literal|1
expr_stmt|;
name|lc2f
operator|--
expr_stmt|;
block|}
comment|/* now check the label character for character. */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
call|(
name|size_t
call|)
argument_list|(
operator|*
name|lp1
operator|+
literal|1
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
operator|*
name|lp2
condition|)
block|{
comment|/* apparently label 1 is larger */
name|result
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|LDNS_DNAME_NORMALIZE
argument_list|(
operator|(
name|int
operator|)
operator|*
operator|(
name|lp1
operator|+
name|i
operator|)
argument_list|)
operator|<
name|LDNS_DNAME_NORMALIZE
argument_list|(
operator|(
name|int
operator|)
operator|*
operator|(
name|lp2
operator|+
name|i
operator|)
argument_list|)
condition|)
block|{
name|result
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
elseif|else
if|if
condition|(
name|LDNS_DNAME_NORMALIZE
argument_list|(
operator|(
name|int
operator|)
operator|*
operator|(
name|lp1
operator|+
name|i
operator|)
argument_list|)
operator|>
name|LDNS_DNAME_NORMALIZE
argument_list|(
operator|(
name|int
operator|)
operator|*
operator|(
name|lp2
operator|+
name|i
operator|)
argument_list|)
condition|)
block|{
name|result
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
if|if
condition|(
operator|*
name|lp1
operator|<
operator|*
name|lp2
condition|)
block|{
comment|/* apparently label 2 is larger */
name|result
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|lc1
operator|==
literal|0
operator|&&
name|lc2
operator|>
literal|0
condition|)
block|{
name|result
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
elseif|else
if|if
condition|(
name|lc1
operator|>
literal|0
operator|&&
name|lc2
operator|==
literal|0
condition|)
block|{
name|result
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
elseif|else
if|if
condition|(
name|lc1
operator|==
literal|0
operator|&&
name|lc2
operator|==
literal|0
condition|)
block|{
name|result
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|lc1
operator|--
expr_stmt|;
name|lc2
operator|--
expr_stmt|;
block|}
name|done
label|:
return|return
name|result
return|;
block|}
end_function

begin_function
name|int
name|ldns_dname_is_wildcard
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|dname
parameter_list|)
block|{
return|return
operator|(
name|ldns_dname_label_count
argument_list|(
name|dname
argument_list|)
operator|>
literal|0
operator|&&
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
index|[
literal|0
index|]
operator|==
literal|1
operator|&&
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
index|[
literal|1
index|]
operator|==
literal|'*'
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ldns_dname_match_wildcard
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|dname
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|wildcard
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|wc_chopped
decl_stmt|;
name|int
name|result
decl_stmt|;
comment|/* check whether it really is a wildcard */
if|if
condition|(
name|ldns_dname_is_wildcard
argument_list|(
name|wildcard
argument_list|)
condition|)
block|{
comment|/* ok, so the dname needs to be a subdomain of the wildcard 		 * without the * 		 */
name|wc_chopped
operator|=
name|ldns_dname_left_chop
argument_list|(
name|wildcard
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|int
operator|)
name|ldns_dname_is_subdomain
argument_list|(
name|dname
argument_list|,
name|wc_chopped
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|wc_chopped
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
operator|(
name|ldns_dname_compare
argument_list|(
name|dname
argument_list|,
name|wildcard
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* nsec test: does prev<= middle< next  * -1 = yes  * 0 = error/can't tell  * 1 = no  */
end_comment

begin_function
name|int
name|ldns_dname_interval
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|prev
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|middle
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|next
parameter_list|)
block|{
name|int
name|prev_check
decl_stmt|,
name|next_check
decl_stmt|;
name|assert
argument_list|(
name|ldns_rdf_get_type
argument_list|(
name|prev
argument_list|)
operator|==
name|LDNS_RDF_TYPE_DNAME
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ldns_rdf_get_type
argument_list|(
name|middle
argument_list|)
operator|==
name|LDNS_RDF_TYPE_DNAME
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ldns_rdf_get_type
argument_list|(
name|next
argument_list|)
operator|==
name|LDNS_RDF_TYPE_DNAME
argument_list|)
expr_stmt|;
name|prev_check
operator|=
name|ldns_dname_compare
argument_list|(
name|prev
argument_list|,
name|middle
argument_list|)
expr_stmt|;
name|next_check
operator|=
name|ldns_dname_compare
argument_list|(
name|middle
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/*<= next. This cannot be the case for nsec, because then we would 	 * have gotten the nsec of next... 	 */
if|if
condition|(
name|next_check
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/*<= */
if|if
condition|(
operator|(
name|prev_check
operator|==
operator|-
literal|1
operator|||
name|prev_check
operator|==
literal|0
operator|)
operator|&&
comment|/*< */
name|next_check
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
return|return
literal|1
return|;
block|}
block|}
end_function

begin_function
name|bool
name|ldns_dname_str_absolute
parameter_list|(
specifier|const
name|char
modifier|*
name|dname_str
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|dname_str
operator|&&
name|strcmp
argument_list|(
name|dname_str
argument_list|,
literal|"."
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|dname_str
operator|||
name|strlen
argument_list|(
name|dname_str
argument_list|)
operator|<
literal|2
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|dname_str
index|[
name|strlen
argument_list|(
name|dname_str
argument_list|)
operator|-
literal|1
index|]
operator|!=
literal|'.'
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|dname_str
index|[
name|strlen
argument_list|(
name|dname_str
argument_list|)
operator|-
literal|2
index|]
operator|!=
literal|'\\'
condition|)
return|return
literal|1
return|;
comment|/* ends in . and no \ before it */
comment|/* so we have the case of ends in . and there is \ before it */
for|for
control|(
name|s
operator|=
name|dname_str
init|;
operator|*
name|s
condition|;
name|s
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|s
operator|==
literal|'\\'
condition|)
block|{
if|if
condition|(
name|s
index|[
literal|1
index|]
operator|&&
name|s
index|[
literal|2
index|]
operator|&&
name|s
index|[
literal|3
index|]
comment|/* check length */
operator|&&
name|isdigit
argument_list|(
name|s
index|[
literal|1
index|]
argument_list|)
operator|&&
name|isdigit
argument_list|(
name|s
index|[
literal|2
index|]
argument_list|)
operator|&&
name|isdigit
argument_list|(
name|s
index|[
literal|3
index|]
argument_list|)
condition|)
name|s
operator|+=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|s
index|[
literal|1
index|]
operator|||
name|isdigit
argument_list|(
name|s
index|[
literal|1
index|]
argument_list|)
condition|)
comment|/* escape of nul,0-9 */
return|return
literal|0
return|;
comment|/* parse error */
else|else
name|s
operator|++
expr_stmt|;
comment|/* another character escaped */
block|}
elseif|else
if|if
condition|(
operator|!
operator|*
operator|(
name|s
operator|+
literal|1
operator|)
operator|&&
operator|*
name|s
operator|==
literal|'.'
condition|)
return|return
literal|1
return|;
comment|/* trailing dot, unescaped */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|bool
name|ldns_dname_absolute
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|rdf
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|ldns_rdf2str
argument_list|(
name|rdf
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
condition|)
block|{
name|bool
name|r
init|=
name|ldns_dname_str_absolute
argument_list|(
name|str
argument_list|)
decl_stmt|;
name|LDNS_FREE
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_dname_label
parameter_list|(
specifier|const
name|ldns_rdf
modifier|*
name|rdf
parameter_list|,
name|uint8_t
name|labelpos
parameter_list|)
block|{
name|uint8_t
name|labelcnt
decl_stmt|;
name|uint16_t
name|src_pos
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|ldns_rdf
modifier|*
name|tmpnew
decl_stmt|;
name|size_t
name|s
decl_stmt|;
name|uint8_t
modifier|*
name|data
decl_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|rdf
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|labelcnt
operator|=
literal|0
expr_stmt|;
name|src_pos
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|ldns_rdf_size
argument_list|(
name|rdf
argument_list|)
expr_stmt|;
name|len
operator|=
name|ldns_rdf_data
argument_list|(
name|rdf
argument_list|)
index|[
name|src_pos
index|]
expr_stmt|;
comment|/* label start */
while|while
condition|(
operator|(
name|len
operator|>
literal|0
operator|)
operator|&&
name|src_pos
operator|<
name|s
condition|)
block|{
if|if
condition|(
name|labelcnt
operator|==
name|labelpos
condition|)
block|{
comment|/* found our label */
name|data
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|len
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
name|data
argument_list|,
name|ldns_rdf_data
argument_list|(
name|rdf
argument_list|)
operator|+
name|src_pos
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|data
index|[
name|len
operator|+
literal|2
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|tmpnew
operator|=
name|ldns_rdf_new
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|len
operator|+
literal|2
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmpnew
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|tmpnew
return|;
block|}
name|src_pos
operator|++
expr_stmt|;
name|src_pos
operator|+=
name|len
expr_stmt|;
name|len
operator|=
name|ldns_rdf_data
argument_list|(
name|rdf
argument_list|)
index|[
name|src_pos
index|]
expr_stmt|;
name|labelcnt
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

end_unit


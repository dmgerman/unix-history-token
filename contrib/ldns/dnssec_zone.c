begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * special zone file structures and functions for better dnssec handling  */
end_comment

begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_function
name|ldns_dnssec_rrs
modifier|*
name|ldns_dnssec_rrs_new
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_dnssec_rrs
modifier|*
name|new_rrs
decl_stmt|;
name|new_rrs
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_dnssec_rrs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_rrs
condition|)
return|return
name|NULL
return|;
name|new_rrs
operator|->
name|rr
operator|=
name|NULL
expr_stmt|;
name|new_rrs
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
return|return
name|new_rrs
return|;
block|}
end_function

begin_function
name|INLINE
name|void
name|ldns_dnssec_rrs_free_internal
parameter_list|(
name|ldns_dnssec_rrs
modifier|*
name|rrs
parameter_list|,
name|int
name|deep
parameter_list|)
block|{
name|ldns_dnssec_rrs
modifier|*
name|next
decl_stmt|;
while|while
condition|(
name|rrs
condition|)
block|{
name|next
operator|=
name|rrs
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|deep
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|rrs
operator|->
name|rr
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|rrs
argument_list|)
expr_stmt|;
name|rrs
operator|=
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_rrs_free
parameter_list|(
name|ldns_dnssec_rrs
modifier|*
name|rrs
parameter_list|)
block|{
name|ldns_dnssec_rrs_free_internal
argument_list|(
name|rrs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_rrs_deep_free
parameter_list|(
name|ldns_dnssec_rrs
modifier|*
name|rrs
parameter_list|)
block|{
name|ldns_dnssec_rrs_free_internal
argument_list|(
name|rrs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_dnssec_rrs_add_rr
parameter_list|(
name|ldns_dnssec_rrs
modifier|*
name|rrs
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|int
name|cmp
decl_stmt|;
name|ldns_dnssec_rrs
modifier|*
name|new_rrs
decl_stmt|;
if|if
condition|(
operator|!
name|rrs
operator|||
operator|!
name|rr
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
comment|/* this could be done more efficiently; name and type should already 	   be equal */
name|cmp
operator|=
name|ldns_rr_compare
argument_list|(
name|rrs
operator|->
name|rr
argument_list|,
name|rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmp
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|rrs
operator|->
name|next
condition|)
block|{
return|return
name|ldns_dnssec_rrs_add_rr
argument_list|(
name|rrs
operator|->
name|next
argument_list|,
name|rr
argument_list|)
return|;
block|}
else|else
block|{
name|new_rrs
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|new_rrs
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
name|rrs
operator|->
name|next
operator|=
name|new_rrs
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|cmp
operator|>
literal|0
condition|)
block|{
comment|/* put the current old rr in the new next, put the new 		   rr in the current container */
name|new_rrs
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|new_rrs
operator|->
name|rr
operator|=
name|rrs
operator|->
name|rr
expr_stmt|;
name|new_rrs
operator|->
name|next
operator|=
name|rrs
operator|->
name|next
expr_stmt|;
name|rrs
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
name|rrs
operator|->
name|next
operator|=
name|new_rrs
expr_stmt|;
block|}
comment|/* Silently ignore equal rr's */
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_rrs_print_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
name|ldns_dnssec_rrs
modifier|*
name|rrs
parameter_list|)
block|{
if|if
condition|(
operator|!
name|rrs
condition|)
block|{
if|if
condition|(
operator|(
name|fmt
operator|->
name|flags
operator|&
name|LDNS_COMMENT_LAYOUT
operator|)
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";<void>"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rrs
operator|->
name|rr
condition|)
block|{
name|ldns_rr_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|rrs
operator|->
name|rr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rrs
operator|->
name|next
condition|)
block|{
name|ldns_dnssec_rrs_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|rrs
operator|->
name|next
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_rrs_print
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|ldns_dnssec_rrs
modifier|*
name|rrs
parameter_list|)
block|{
name|ldns_dnssec_rrs_print_fmt
argument_list|(
name|out
argument_list|,
name|ldns_output_format_default
argument_list|,
name|rrs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ldns_dnssec_rrsets
modifier|*
name|ldns_dnssec_rrsets_new
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_dnssec_rrsets
modifier|*
name|new_rrsets
decl_stmt|;
name|new_rrsets
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_dnssec_rrsets
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_rrsets
condition|)
return|return
name|NULL
return|;
name|new_rrsets
operator|->
name|rrs
operator|=
name|NULL
expr_stmt|;
name|new_rrsets
operator|->
name|type
operator|=
literal|0
expr_stmt|;
name|new_rrsets
operator|->
name|signatures
operator|=
name|NULL
expr_stmt|;
name|new_rrsets
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
return|return
name|new_rrsets
return|;
block|}
end_function

begin_function
name|INLINE
name|void
name|ldns_dnssec_rrsets_free_internal
parameter_list|(
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|,
name|int
name|deep
parameter_list|)
block|{
if|if
condition|(
name|rrsets
condition|)
block|{
if|if
condition|(
name|rrsets
operator|->
name|rrs
condition|)
block|{
name|ldns_dnssec_rrs_free_internal
argument_list|(
name|rrsets
operator|->
name|rrs
argument_list|,
name|deep
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rrsets
operator|->
name|next
condition|)
block|{
name|ldns_dnssec_rrsets_free_internal
argument_list|(
name|rrsets
operator|->
name|next
argument_list|,
name|deep
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rrsets
operator|->
name|signatures
condition|)
block|{
name|ldns_dnssec_rrs_free_internal
argument_list|(
name|rrsets
operator|->
name|signatures
argument_list|,
name|deep
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|rrsets
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_rrsets_free
parameter_list|(
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|)
block|{
name|ldns_dnssec_rrsets_free_internal
argument_list|(
name|rrsets
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_rrsets_deep_free
parameter_list|(
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|)
block|{
name|ldns_dnssec_rrsets_free_internal
argument_list|(
name|rrsets
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ldns_rr_type
name|ldns_dnssec_rrsets_type
parameter_list|(
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|)
block|{
if|if
condition|(
name|rrsets
condition|)
block|{
return|return
name|rrsets
operator|->
name|type
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|ldns_status
name|ldns_dnssec_rrsets_set_type
parameter_list|(
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
if|if
condition|(
name|rrsets
condition|)
block|{
name|rrsets
operator|->
name|type
operator|=
name|type
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
return|return
name|LDNS_STATUS_ERR
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_dnssec_rrsets
modifier|*
name|ldns_dnssec_rrsets_new_frm_rr
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|ldns_dnssec_rrsets
modifier|*
name|new_rrsets
decl_stmt|;
name|ldns_rr_type
name|rr_type
decl_stmt|;
name|bool
name|rrsig
decl_stmt|;
name|new_rrsets
operator|=
name|ldns_dnssec_rrsets_new
argument_list|()
expr_stmt|;
name|rr_type
operator|=
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rr_type
operator|==
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
name|rrsig
operator|=
name|true
expr_stmt|;
name|rr_type
operator|=
name|ldns_rdf2rr_type
argument_list|(
name|ldns_rr_rrsig_typecovered
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rrsig
operator|=
name|false
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rrsig
condition|)
block|{
name|new_rrsets
operator|->
name|rrs
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|new_rrsets
operator|->
name|rrs
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
block|}
else|else
block|{
name|new_rrsets
operator|->
name|signatures
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|new_rrsets
operator|->
name|signatures
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
block|}
name|new_rrsets
operator|->
name|type
operator|=
name|rr_type
expr_stmt|;
return|return
name|new_rrsets
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_dnssec_rrsets_add_rr
parameter_list|(
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|ldns_dnssec_rrsets
modifier|*
name|new_rrsets
decl_stmt|;
name|ldns_rr_type
name|rr_type
decl_stmt|;
name|bool
name|rrsig
init|=
name|false
decl_stmt|;
name|ldns_status
name|result
init|=
name|LDNS_STATUS_OK
decl_stmt|;
if|if
condition|(
operator|!
name|rrsets
operator|||
operator|!
name|rr
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|rr_type
operator|=
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rr_type
operator|==
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
name|rrsig
operator|=
name|true
expr_stmt|;
name|rr_type
operator|=
name|ldns_rdf2rr_type
argument_list|(
name|ldns_rr_rrsig_typecovered
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rrsets
operator|->
name|rrs
operator|&&
name|rrsets
operator|->
name|type
operator|==
literal|0
operator|&&
operator|!
name|rrsets
operator|->
name|signatures
condition|)
block|{
if|if
condition|(
operator|!
name|rrsig
condition|)
block|{
name|rrsets
operator|->
name|rrs
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|rrsets
operator|->
name|rrs
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
name|rrsets
operator|->
name|type
operator|=
name|rr_type
expr_stmt|;
block|}
else|else
block|{
name|rrsets
operator|->
name|signatures
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|rrsets
operator|->
name|signatures
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
name|rrsets
operator|->
name|type
operator|=
name|rr_type
expr_stmt|;
block|}
return|return
name|LDNS_STATUS_OK
return|;
block|}
if|if
condition|(
name|rr_type
operator|>
name|ldns_dnssec_rrsets_type
argument_list|(
name|rrsets
argument_list|)
condition|)
block|{
if|if
condition|(
name|rrsets
operator|->
name|next
condition|)
block|{
name|result
operator|=
name|ldns_dnssec_rrsets_add_rr
argument_list|(
name|rrsets
operator|->
name|next
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|new_rrsets
operator|=
name|ldns_dnssec_rrsets_new_frm_rr
argument_list|(
name|rr
argument_list|)
expr_stmt|;
name|rrsets
operator|->
name|next
operator|=
name|new_rrsets
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rr_type
operator|<
name|ldns_dnssec_rrsets_type
argument_list|(
name|rrsets
argument_list|)
condition|)
block|{
comment|/* move the current one into the new next,  		   replace field of current with data from new rr */
name|new_rrsets
operator|=
name|ldns_dnssec_rrsets_new
argument_list|()
expr_stmt|;
name|new_rrsets
operator|->
name|rrs
operator|=
name|rrsets
operator|->
name|rrs
expr_stmt|;
name|new_rrsets
operator|->
name|type
operator|=
name|rrsets
operator|->
name|type
expr_stmt|;
name|new_rrsets
operator|->
name|signatures
operator|=
name|rrsets
operator|->
name|signatures
expr_stmt|;
name|new_rrsets
operator|->
name|next
operator|=
name|rrsets
operator|->
name|next
expr_stmt|;
if|if
condition|(
operator|!
name|rrsig
condition|)
block|{
name|rrsets
operator|->
name|rrs
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|rrsets
operator|->
name|rrs
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
name|rrsets
operator|->
name|signatures
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|rrsets
operator|->
name|rrs
operator|=
name|NULL
expr_stmt|;
name|rrsets
operator|->
name|signatures
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|rrsets
operator|->
name|signatures
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
block|}
name|rrsets
operator|->
name|type
operator|=
name|rr_type
expr_stmt|;
name|rrsets
operator|->
name|next
operator|=
name|new_rrsets
expr_stmt|;
block|}
else|else
block|{
comment|/* equal, add to current rrsets */
if|if
condition|(
name|rrsig
condition|)
block|{
if|if
condition|(
name|rrsets
operator|->
name|signatures
condition|)
block|{
name|result
operator|=
name|ldns_dnssec_rrs_add_rr
argument_list|(
name|rrsets
operator|->
name|signatures
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rrsets
operator|->
name|signatures
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|rrsets
operator|->
name|signatures
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|rrsets
operator|->
name|rrs
condition|)
block|{
name|result
operator|=
name|ldns_dnssec_rrs_add_rr
argument_list|(
name|rrsets
operator|->
name|rrs
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rrsets
operator|->
name|rrs
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|rrsets
operator|->
name|rrs
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
block|}
block|}
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ldns_dnssec_rrsets_print_soa_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|,
name|bool
name|follow
parameter_list|,
name|bool
name|show_soa
parameter_list|)
block|{
if|if
condition|(
operator|!
name|rrsets
condition|)
block|{
if|if
condition|(
operator|(
name|fmt
operator|->
name|flags
operator|&
name|LDNS_COMMENT_LAYOUT
operator|)
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";<void>\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rrsets
operator|->
name|rrs
operator|&&
operator|(
name|show_soa
operator|||
name|ldns_rr_get_type
argument_list|(
name|rrsets
operator|->
name|rrs
operator|->
name|rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_SOA
operator|)
condition|)
block|{
name|ldns_dnssec_rrs_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|rrsets
operator|->
name|rrs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrsets
operator|->
name|signatures
condition|)
block|{
name|ldns_dnssec_rrs_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|rrsets
operator|->
name|signatures
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|follow
operator|&&
name|rrsets
operator|->
name|next
condition|)
block|{
name|ldns_dnssec_rrsets_print_soa_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|rrsets
operator|->
name|next
argument_list|,
name|follow
argument_list|,
name|show_soa
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_rrsets_print_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|,
name|bool
name|follow
parameter_list|)
block|{
name|ldns_dnssec_rrsets_print_soa_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|rrsets
argument_list|,
name|follow
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_rrsets_print
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|ldns_dnssec_rrsets
modifier|*
name|rrsets
parameter_list|,
name|bool
name|follow
parameter_list|)
block|{
name|ldns_dnssec_rrsets_print_fmt
argument_list|(
name|out
argument_list|,
name|ldns_output_format_default
argument_list|,
name|rrsets
argument_list|,
name|follow
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ldns_dnssec_name
modifier|*
name|ldns_dnssec_name_new
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_dnssec_name
modifier|*
name|new_name
decl_stmt|;
name|new_name
operator|=
name|LDNS_CALLOC
argument_list|(
name|ldns_dnssec_name
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_name
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* 	 * not needed anymore because CALLOC initalizes everything to zero.  	new_name->name = NULL; 	new_name->rrsets = NULL; 	new_name->name_alloced = false; 	new_name->nsec = NULL; 	new_name->nsec_signatures = NULL;  	new_name->is_glue = false; 	new_name->hashed_name = NULL;  	 */
return|return
name|new_name
return|;
block|}
end_function

begin_function
name|ldns_dnssec_name
modifier|*
name|ldns_dnssec_name_new_frm_rr
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|ldns_dnssec_name
modifier|*
name|new_name
init|=
name|ldns_dnssec_name_new
argument_list|()
decl_stmt|;
name|new_name
operator|->
name|name
operator|=
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dnssec_name_add_rr
argument_list|(
name|new_name
argument_list|,
name|rr
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_dnssec_name_free
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|new_name
return|;
block|}
end_function

begin_function
name|INLINE
name|void
name|ldns_dnssec_name_free_internal
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|,
name|int
name|deep
parameter_list|)
block|{
if|if
condition|(
name|name
condition|)
block|{
if|if
condition|(
name|name
operator|->
name|name_alloced
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|name
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|rrsets
condition|)
block|{
name|ldns_dnssec_rrsets_free_internal
argument_list|(
name|name
operator|->
name|rrsets
argument_list|,
name|deep
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|nsec
operator|&&
name|deep
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|name
operator|->
name|nsec
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|nsec_signatures
condition|)
block|{
name|ldns_dnssec_rrs_free_internal
argument_list|(
name|name
operator|->
name|nsec_signatures
argument_list|,
name|deep
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|hashed_name
condition|)
block|{
if|if
condition|(
name|deep
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|name
operator|->
name|hashed_name
argument_list|)
expr_stmt|;
block|}
block|}
name|LDNS_FREE
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_name_free
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|)
block|{
name|ldns_dnssec_name_free_internal
argument_list|(
name|name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_name_deep_free
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|)
block|{
name|ldns_dnssec_name_free_internal
argument_list|(
name|name
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_dnssec_name_name
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|name
condition|)
block|{
return|return
name|name
operator|->
name|name
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|bool
name|ldns_dnssec_name_is_glue
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|name
condition|)
block|{
return|return
name|name
operator|->
name|is_glue
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_name_set_name
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|rrset
parameter_list|,
name|ldns_rdf
modifier|*
name|dname
parameter_list|)
block|{
if|if
condition|(
name|rrset
operator|&&
name|dname
condition|)
block|{
name|rrset
operator|->
name|name
operator|=
name|dname
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_name_set_nsec
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|rrset
parameter_list|,
name|ldns_rr
modifier|*
name|nsec
parameter_list|)
block|{
if|if
condition|(
name|rrset
operator|&&
name|nsec
condition|)
block|{
name|rrset
operator|->
name|nsec
operator|=
name|nsec
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ldns_dnssec_name_cmp
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
name|ldns_dnssec_name
modifier|*
name|na
init|=
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|a
decl_stmt|;
name|ldns_dnssec_name
modifier|*
name|nb
init|=
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|b
decl_stmt|;
if|if
condition|(
name|na
operator|&&
name|nb
condition|)
block|{
return|return
name|ldns_dname_compare
argument_list|(
name|ldns_dnssec_name_name
argument_list|(
name|na
argument_list|)
argument_list|,
name|ldns_dnssec_name_name
argument_list|(
name|nb
argument_list|)
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|na
condition|)
block|{
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|nb
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|ldns_status
name|ldns_dnssec_name_add_rr
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|ldns_status
name|result
init|=
name|LDNS_STATUS_OK
decl_stmt|;
name|ldns_rr_type
name|rr_type
decl_stmt|;
name|ldns_rr_type
name|typecovered
init|=
literal|0
decl_stmt|;
comment|/* special handling for NSEC3 and NSECX covering RRSIGS */
if|if
condition|(
operator|!
name|name
operator|||
operator|!
name|rr
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|rr_type
operator|=
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rr_type
operator|==
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
name|typecovered
operator|=
name|ldns_rdf2rr_type
argument_list|(
name|ldns_rr_rrsig_typecovered
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rr_type
operator|==
name|LDNS_RR_TYPE_NSEC
operator|||
name|rr_type
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
comment|/* XX check if is already set (and error?) */
name|name
operator|->
name|nsec
operator|=
name|rr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|typecovered
operator|==
name|LDNS_RR_TYPE_NSEC
operator|||
name|typecovered
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
if|if
condition|(
name|name
operator|->
name|nsec_signatures
condition|)
block|{
name|result
operator|=
name|ldns_dnssec_rrs_add_rr
argument_list|(
name|name
operator|->
name|nsec_signatures
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|name
operator|->
name|nsec_signatures
operator|=
name|ldns_dnssec_rrs_new
argument_list|()
expr_stmt|;
name|name
operator|->
name|nsec_signatures
operator|->
name|rr
operator|=
name|rr
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* it's a 'normal' RR, add it to the right rrset */
if|if
condition|(
name|name
operator|->
name|rrsets
condition|)
block|{
name|result
operator|=
name|ldns_dnssec_rrsets_add_rr
argument_list|(
name|name
operator|->
name|rrsets
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|name
operator|->
name|rrsets
operator|=
name|ldns_dnssec_rrsets_new
argument_list|()
expr_stmt|;
name|result
operator|=
name|ldns_dnssec_rrsets_add_rr
argument_list|(
name|name
operator|->
name|rrsets
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|ldns_dnssec_rrsets
modifier|*
name|ldns_dnssec_name_find_rrset
parameter_list|(
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|ldns_dnssec_rrsets
modifier|*
name|result
decl_stmt|;
name|result
operator|=
name|name
operator|->
name|rrsets
expr_stmt|;
while|while
condition|(
name|result
condition|)
block|{
if|if
condition|(
name|result
operator|->
name|type
operator|==
name|type
condition|)
block|{
return|return
name|result
return|;
block|}
else|else
block|{
name|result
operator|=
name|result
operator|->
name|next
expr_stmt|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|ldns_dnssec_rrsets
modifier|*
name|ldns_dnssec_zone_find_rrset
parameter_list|(
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|,
name|ldns_rdf
modifier|*
name|dname
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|)
block|{
name|ldns_rbnode_t
modifier|*
name|node
decl_stmt|;
if|if
condition|(
operator|!
name|zone
operator|||
operator|!
name|dname
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|node
operator|=
name|ldns_rbtree_search
argument_list|(
name|zone
operator|->
name|names
argument_list|,
name|dname
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
return|return
name|ldns_dnssec_name_find_rrset
argument_list|(
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|node
operator|->
name|data
argument_list|,
name|type
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ldns_dnssec_name_print_soa_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|,
name|bool
name|show_soa
parameter_list|)
block|{
if|if
condition|(
name|name
condition|)
block|{
if|if
condition|(
name|name
operator|->
name|rrsets
condition|)
block|{
name|ldns_dnssec_rrsets_print_soa_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|name
operator|->
name|rrsets
argument_list|,
name|true
argument_list|,
name|show_soa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fmt
operator|->
name|flags
operator|&
name|LDNS_COMMENT_LAYOUT
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";; Empty nonterminal: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|name
operator|->
name|name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|nsec
condition|)
block|{
name|ldns_rr_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|name
operator|->
name|nsec
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|->
name|nsec_signatures
condition|)
block|{
name|ldns_dnssec_rrs_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|name
operator|->
name|nsec_signatures
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|fmt
operator|->
name|flags
operator|&
name|LDNS_COMMENT_LAYOUT
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";<void>\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_name_print_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|)
block|{
name|ldns_dnssec_name_print_soa_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|name
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_name_print
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|)
block|{
name|ldns_dnssec_name_print_fmt
argument_list|(
name|out
argument_list|,
name|ldns_output_format_default
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ldns_dnssec_zone
modifier|*
name|ldns_dnssec_zone_new
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_dnssec_zone
modifier|*
name|zone
init|=
name|LDNS_MALLOC
argument_list|(
name|ldns_dnssec_zone
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|zone
condition|)
return|return
name|NULL
return|;
name|zone
operator|->
name|soa
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|names
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|hashed_names
operator|=
name|NULL
expr_stmt|;
name|zone
operator|->
name|_nsec3params
operator|=
name|NULL
expr_stmt|;
return|return
name|zone
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|rr_is_rrsig_covering
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|)
block|{
return|return
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_RRSIG
operator|&&
name|ldns_rdf2rr_type
argument_list|(
name|ldns_rr_rrsig_typecovered
argument_list|(
name|rr
argument_list|)
argument_list|)
operator|==
name|t
return|;
block|}
end_function

begin_comment
comment|/* When the zone is first read into an list and then inserted into an  * ldns_dnssec_zone (rbtree) the nodes of the rbtree are allocated close (next)  * to each other. Because ldns-verify-zone (the only program that uses this  * function) uses the rbtree mostly for sequentual walking, this results  * in a speed increase (of 15% on linux) because we have less CPU-cache misses.  */
end_comment

begin_define
define|#
directive|define
name|FASTER_DNSSEC_ZONE_NEW_FRM_FP
value|1
end_define

begin_comment
comment|/* Because of L2 cache efficiency */
end_comment

begin_function
name|ldns_status
name|ldns_dnssec_zone_new_frm_fp_l
parameter_list|(
name|ldns_dnssec_zone
modifier|*
modifier|*
name|z
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|ldns_rdf
modifier|*
name|origin
parameter_list|,
name|uint32_t
name|ttl
parameter_list|,
name|ldns_rr_class
name|ATTR_UNUSED
parameter_list|(
name|c
parameter_list|)
parameter_list|,
name|int
modifier|*
name|line_nr
parameter_list|)
block|{
name|ldns_rr
modifier|*
name|cur_rr
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ldns_rdf
modifier|*
name|my_origin
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|my_prev
init|=
name|NULL
decl_stmt|;
name|ldns_dnssec_zone
modifier|*
name|newzone
init|=
name|ldns_dnssec_zone_new
argument_list|()
decl_stmt|;
comment|/* when reading NSEC3s, there is a chance that we encounter nsecs 	   for empty nonterminals, whose nonterminals we cannot derive yet 	   because the needed information is to be read later. in that case 	   we keep a list of those nsec3's and retry to add them later */
name|ldns_rr_list
modifier|*
name|todo_nsec3s
init|=
name|ldns_rr_list_new
argument_list|()
decl_stmt|;
name|ldns_rr_list
modifier|*
name|todo_nsec3_rrsigs
init|=
name|ldns_rr_list_new
argument_list|()
decl_stmt|;
name|ldns_status
name|status
init|=
name|LDNS_STATUS_MEM_ERR
decl_stmt|;
ifdef|#
directive|ifdef
name|FASTER_DNSSEC_ZONE_NEW_FRM_FP
name|ldns_zone
modifier|*
name|zone
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|ldns_zone_new_frm_fp_l
argument_list|(
operator|&
name|zone
argument_list|,
name|fp
argument_list|,
name|origin
argument_list|,
name|ttl
argument_list|,
name|c
argument_list|,
name|line_nr
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
goto|goto
name|error
goto|;
else|#
directive|else
name|uint32_t
name|my_ttl
init|=
name|ttl
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|newzone
operator|||
operator|!
name|todo_nsec3s
operator|||
operator|!
name|todo_nsec3_rrsigs
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|origin
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|my_origin
operator|=
name|ldns_rdf_clone
argument_list|(
name|origin
argument_list|)
operator|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
operator|(
name|my_prev
operator|=
name|ldns_rdf_clone
argument_list|(
name|origin
argument_list|)
operator|)
condition|)
goto|goto
name|error
goto|;
block|}
ifdef|#
directive|ifdef
name|FASTER_DNSSEC_ZONE_NEW_FRM_FP
if|if
condition|(
name|ldns_dnssec_zone_add_rr
argument_list|(
name|newzone
argument_list|,
name|ldns_zone_soa
argument_list|(
name|zone
argument_list|)
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
goto|goto
name|error
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|zone
argument_list|)
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cur_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|zone
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|status
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
else|#
directive|else
while|while
condition|(
operator|!
name|feof
argument_list|(
name|fp
argument_list|)
condition|)
block|{
name|status
operator|=
name|ldns_rr_new_frm_fp_l
argument_list|(
operator|&
name|cur_rr
argument_list|,
name|fp
argument_list|,
operator|&
name|my_ttl
argument_list|,
operator|&
name|my_origin
argument_list|,
operator|&
name|my_prev
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|LDNS_STATUS_OK
case|:
name|status
operator|=
name|ldns_dnssec_zone_add_rr
argument_list|(
name|newzone
argument_list|,
name|cur_rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_DNSSEC_NSEC3_ORIGINAL_NOT_FOUND
condition|)
block|{
if|if
condition|(
name|rr_is_rrsig_covering
argument_list|(
name|cur_rr
argument_list|,
name|LDNS_RR_TYPE_NSEC3
argument_list|)
condition|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|todo_nsec3_rrsigs
argument_list|,
name|cur_rr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|todo_nsec3s
argument_list|,
name|cur_rr
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
goto|goto
name|error
goto|;
break|break;
case|case
name|LDNS_STATUS_SYNTAX_EMPTY
case|:
comment|/* empty line was seen */
case|case
name|LDNS_STATUS_SYNTAX_TTL
case|:
comment|/* the ttl was set*/
case|case
name|LDNS_STATUS_SYNTAX_ORIGIN
case|:
comment|/* the origin was set*/
name|status
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
break|break;
case|case
name|LDNS_STATUS_SYNTAX_INCLUDE
case|:
comment|/* $include not implemented */
name|status
operator|=
name|LDNS_STATUS_SYNTAX_INCLUDE_ERR_NOTIMPL
expr_stmt|;
break|break;
default|default:
goto|goto
name|error
goto|;
block|}
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|todo_nsec3s
argument_list|)
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_dnssec_zone_add_empty_nonterminals
argument_list|(
name|newzone
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|status
operator|==
name|LDNS_STATUS_OK
operator|&&
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|todo_nsec3s
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cur_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|todo_nsec3s
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_dnssec_zone_add_rr
argument_list|(
name|newzone
argument_list|,
name|cur_rr
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|todo_nsec3_rrsigs
argument_list|)
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|status
operator|==
name|LDNS_STATUS_OK
operator|&&
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|todo_nsec3_rrsigs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cur_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|todo_nsec3_rrsigs
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_dnssec_zone_add_rr
argument_list|(
name|newzone
argument_list|,
name|cur_rr
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|z
condition|)
block|{
operator|*
name|z
operator|=
name|newzone
expr_stmt|;
name|newzone
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|ldns_dnssec_zone_free
argument_list|(
name|newzone
argument_list|)
expr_stmt|;
block|}
name|error
label|:
ifdef|#
directive|ifdef
name|FASTER_DNSSEC_ZONE_NEW_FRM_FP
if|if
condition|(
name|zone
condition|)
block|{
name|ldns_zone_free
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ldns_rr_list_free
argument_list|(
name|todo_nsec3_rrsigs
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|todo_nsec3s
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_origin
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|my_origin
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|my_prev
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|my_prev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|newzone
condition|)
block|{
name|ldns_dnssec_zone_free
argument_list|(
name|newzone
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
name|ldns_status
name|ldns_dnssec_zone_new_frm_fp
parameter_list|(
name|ldns_dnssec_zone
modifier|*
modifier|*
name|z
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|ldns_rdf
modifier|*
name|origin
parameter_list|,
name|uint32_t
name|ttl
parameter_list|,
name|ldns_rr_class
name|ATTR_UNUSED
parameter_list|(
name|c
parameter_list|)
parameter_list|)
block|{
return|return
name|ldns_dnssec_zone_new_frm_fp_l
argument_list|(
name|z
argument_list|,
name|fp
argument_list|,
name|origin
argument_list|,
name|ttl
argument_list|,
name|c
argument_list|,
name|NULL
argument_list|)
return|;
block|}
specifier|static
name|void
name|ldns_dnssec_name_node_free
parameter_list|(
name|ldns_rbnode_t
modifier|*
name|node
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
operator|(
name|void
operator|)
name|arg
expr_stmt|;
name|ldns_dnssec_name_free
argument_list|(
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|node
operator|->
name|data
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
specifier|static
name|void
name|ldns_dnssec_name_node_deep_free
parameter_list|(
name|ldns_rbnode_t
modifier|*
name|node
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
operator|(
name|void
operator|)
name|arg
expr_stmt|;
name|ldns_dnssec_name_deep_free
argument_list|(
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|node
operator|->
name|data
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
name|void
name|ldns_dnssec_zone_free
parameter_list|(
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|)
block|{
if|if
condition|(
name|zone
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|names
condition|)
block|{
comment|/* destroy all name structures within the tree */
name|ldns_traverse_postorder
argument_list|(
name|zone
operator|->
name|names
argument_list|,
name|ldns_dnssec_name_node_free
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|zone
operator|->
name|names
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
block|}
name|void
name|ldns_dnssec_zone_deep_free
parameter_list|(
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|)
block|{
if|if
condition|(
name|zone
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|names
condition|)
block|{
comment|/* destroy all name structures within the tree */
name|ldns_traverse_postorder
argument_list|(
name|zone
operator|->
name|names
argument_list|,
name|ldns_dnssec_name_node_deep_free
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|zone
operator|->
name|names
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* use for dname comparison in tree */
name|int
name|ldns_dname_compare_v
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
name|ldns_dname_compare
argument_list|(
operator|(
name|ldns_rdf
operator|*
operator|)
name|a
argument_list|,
operator|(
name|ldns_rdf
operator|*
operator|)
name|b
argument_list|)
return|;
block|}
specifier|static
name|void
name|ldns_dnssec_name_make_hashed_name
argument_list|(
name|ldns_dnssec_zone
operator|*
name|zone
argument_list|,
name|ldns_dnssec_name
operator|*
name|name
argument_list|,
name|ldns_rr
operator|*
name|nsec3rr
argument_list|)
decl_stmt|;
specifier|static
name|void
name|ldns_hashed_names_node_free
parameter_list|(
name|ldns_rbnode_t
modifier|*
name|node
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
operator|(
name|void
operator|)
name|arg
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
specifier|static
name|void
name|ldns_dnssec_zone_hashed_names_from_nsec3
parameter_list|(
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|,
name|ldns_rr
modifier|*
name|nsec3rr
parameter_list|)
block|{
name|ldns_rbnode_t
modifier|*
name|current_node
decl_stmt|;
name|ldns_dnssec_name
modifier|*
name|current_name
decl_stmt|;
name|assert
argument_list|(
name|zone
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|nsec3rr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|hashed_names
condition|)
block|{
name|ldns_traverse_postorder
argument_list|(
name|zone
operator|->
name|hashed_names
argument_list|,
name|ldns_hashed_names_node_free
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|zone
operator|->
name|hashed_names
argument_list|)
expr_stmt|;
block|}
name|zone
operator|->
name|_nsec3params
operator|=
name|nsec3rr
expr_stmt|;
comment|/* So this is a NSEC3 zone. 	* Calculate hashes for all names already in the zone 	*/
name|zone
operator|->
name|hashed_names
operator|=
name|ldns_rbtree_create
argument_list|(
name|ldns_dname_compare_v
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone
operator|->
name|hashed_names
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
for|for
control|(
name|current_node
operator|=
name|ldns_rbtree_first
argument_list|(
name|zone
operator|->
name|names
argument_list|)
init|;
name|current_node
operator|!=
name|LDNS_RBTREE_NULL
condition|;
name|current_node
operator|=
name|ldns_rbtree_next
argument_list|(
name|current_node
argument_list|)
control|)
block|{
name|current_name
operator|=
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|current_node
operator|->
name|data
expr_stmt|;
name|ldns_dnssec_name_make_hashed_name
argument_list|(
name|zone
argument_list|,
name|current_name
argument_list|,
name|nsec3rr
argument_list|)
expr_stmt|;
block|}
block|}
specifier|static
name|void
name|ldns_dnssec_name_make_hashed_name
parameter_list|(
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|,
name|ldns_dnssec_name
modifier|*
name|name
parameter_list|,
name|ldns_rr
modifier|*
name|nsec3rr
parameter_list|)
block|{
name|ldns_rbnode_t
modifier|*
name|new_node
decl_stmt|;
name|assert
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|zone
operator|->
name|_nsec3params
condition|)
block|{
if|if
condition|(
operator|!
name|nsec3rr
condition|)
block|{
return|return;
block|}
name|ldns_dnssec_zone_hashed_names_from_nsec3
argument_list|(
name|zone
argument_list|,
name|nsec3rr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|nsec3rr
condition|)
block|{
name|nsec3rr
operator|=
name|zone
operator|->
name|_nsec3params
expr_stmt|;
block|}
name|name
operator|->
name|hashed_name
operator|=
name|ldns_nsec3_hash_name_frm_nsec3
argument_list|(
name|nsec3rr
argument_list|,
name|name
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* Also store in zone->hashed_names */
if|if
condition|(
operator|(
name|new_node
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_rbnode_t
argument_list|)
operator|)
condition|)
block|{
name|new_node
operator|->
name|key
operator|=
name|name
operator|->
name|hashed_name
expr_stmt|;
name|new_node
operator|->
name|data
operator|=
name|name
expr_stmt|;
if|if
condition|(
name|ldns_rbtree_insert
argument_list|(
name|zone
operator|->
name|hashed_names
argument_list|,
name|new_node
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|new_node
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|static
name|ldns_rbnode_t
modifier|*
name|ldns_dnssec_zone_find_nsec3_original
parameter_list|(
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|hashed_name
decl_stmt|;
name|hashed_name
operator|=
name|ldns_dname_label
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|hashed_name
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
operator|&&
operator|!
name|zone
operator|->
name|_nsec3params
condition|)
block|{
name|ldns_dnssec_zone_hashed_names_from_nsec3
argument_list|(
name|zone
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zone
operator|->
name|hashed_names
operator|==
name|NULL
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|hashed_name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ldns_rbtree_search
argument_list|(
name|zone
operator|->
name|hashed_names
argument_list|,
name|hashed_name
argument_list|)
return|;
block|}
name|ldns_status
name|ldns_dnssec_zone_add_rr
parameter_list|(
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|ldns_status
name|result
init|=
name|LDNS_STATUS_OK
decl_stmt|;
name|ldns_dnssec_name
modifier|*
name|cur_name
decl_stmt|;
name|ldns_rbnode_t
modifier|*
name|cur_node
decl_stmt|;
name|ldns_rr_type
name|type_covered
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|zone
operator|||
operator|!
name|rr
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
operator|!
name|zone
operator|->
name|names
condition|)
block|{
name|zone
operator|->
name|names
operator|=
name|ldns_rbtree_create
argument_list|(
name|ldns_dname_compare_v
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|zone
operator|->
name|names
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
comment|/* we need the original of the hashed name if this is 	   an NSEC3, or an RRSIG that covers an NSEC3 */
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
name|type_covered
operator|=
name|ldns_rdf2rr_type
argument_list|(
name|ldns_rr_rrsig_typecovered
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
operator|||
name|type_covered
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
name|cur_node
operator|=
name|ldns_dnssec_zone_find_nsec3_original
argument_list|(
name|zone
argument_list|,
name|rr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cur_node
condition|)
block|{
return|return
name|LDNS_STATUS_DNSSEC_NSEC3_ORIGINAL_NOT_FOUND
return|;
block|}
block|}
else|else
block|{
name|cur_node
operator|=
name|ldns_rbtree_search
argument_list|(
name|zone
operator|->
name|names
argument_list|,
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cur_node
condition|)
block|{
comment|/* add */
name|cur_name
operator|=
name|ldns_dnssec_name_new_frm_rr
argument_list|(
name|rr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cur_name
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
name|cur_node
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_rbnode_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cur_node
condition|)
block|{
name|ldns_dnssec_name_free
argument_list|(
name|cur_name
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|cur_node
operator|->
name|key
operator|=
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
expr_stmt|;
name|cur_node
operator|->
name|data
operator|=
name|cur_name
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rbtree_insert
argument_list|(
name|zone
operator|->
name|names
argument_list|,
name|cur_node
argument_list|)
expr_stmt|;
name|ldns_dnssec_name_make_hashed_name
argument_list|(
name|zone
argument_list|,
name|cur_name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cur_name
operator|=
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|cur_node
operator|->
name|data
expr_stmt|;
name|result
operator|=
name|ldns_dnssec_name_add_rr
argument_list|(
name|cur_name
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_SOA
condition|)
block|{
name|zone
operator|->
name|soa
operator|=
name|cur_name
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
name|void
name|ldns_dnssec_zone_names_print_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
name|ldns_rbtree_t
modifier|*
name|tree
parameter_list|,
name|bool
name|print_soa
parameter_list|)
block|{
name|ldns_rbnode_t
modifier|*
name|node
decl_stmt|;
name|ldns_dnssec_name
modifier|*
name|name
decl_stmt|;
name|node
operator|=
name|ldns_rbtree_first
argument_list|(
name|tree
argument_list|)
expr_stmt|;
while|while
condition|(
name|node
operator|!=
name|LDNS_RBTREE_NULL
condition|)
block|{
name|name
operator|=
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|node
operator|->
name|data
expr_stmt|;
name|ldns_dnssec_name_print_soa_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|name
argument_list|,
name|print_soa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fmt
operator|->
name|flags
operator|&
name|LDNS_COMMENT_LAYOUT
operator|)
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";\n"
argument_list|)
expr_stmt|;
name|node
operator|=
name|ldns_rbtree_next
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
block|}
name|void
name|ldns_dnssec_zone_names_print
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|ldns_rbtree_t
modifier|*
name|tree
parameter_list|,
name|bool
name|print_soa
parameter_list|)
block|{
name|ldns_dnssec_zone_names_print_fmt
argument_list|(
name|out
argument_list|,
name|ldns_output_format_default
argument_list|,
name|tree
argument_list|,
name|print_soa
argument_list|)
expr_stmt|;
block|}
name|void
name|ldns_dnssec_zone_print_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|)
block|{
if|if
condition|(
name|zone
condition|)
block|{
if|if
condition|(
name|zone
operator|->
name|soa
condition|)
block|{
if|if
condition|(
operator|(
name|fmt
operator|->
name|flags
operator|&
name|LDNS_COMMENT_LAYOUT
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";; Zone: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|ldns_dnssec_name_name
argument_list|(
name|zone
operator|->
name|soa
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n;\n"
argument_list|)
expr_stmt|;
block|}
name|ldns_dnssec_rrsets_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|ldns_dnssec_name_find_rrset
argument_list|(
name|zone
operator|->
name|soa
argument_list|,
name|LDNS_RR_TYPE_SOA
argument_list|)
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fmt
operator|->
name|flags
operator|&
name|LDNS_COMMENT_LAYOUT
operator|)
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|zone
operator|->
name|names
condition|)
block|{
name|ldns_dnssec_zone_names_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|zone
operator|->
name|names
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|void
name|ldns_dnssec_zone_print
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|)
block|{
name|ldns_dnssec_zone_print_fmt
argument_list|(
name|out
argument_list|,
name|ldns_output_format_default
argument_list|,
name|zone
argument_list|)
expr_stmt|;
block|}
name|ldns_status
name|ldns_dnssec_zone_add_empty_nonterminals
parameter_list|(
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|)
block|{
name|ldns_dnssec_name
modifier|*
name|new_name
decl_stmt|;
name|ldns_rdf
modifier|*
name|cur_name
decl_stmt|;
name|ldns_rdf
modifier|*
name|next_name
decl_stmt|;
name|ldns_rbnode_t
modifier|*
name|cur_node
decl_stmt|,
modifier|*
name|next_node
decl_stmt|,
modifier|*
name|new_node
decl_stmt|;
comment|/* for the detection */
name|uint16_t
name|i
decl_stmt|,
name|cur_label_count
decl_stmt|,
name|next_label_count
decl_stmt|;
name|uint16_t
name|soa_label_count
init|=
literal|0
decl_stmt|;
name|ldns_rdf
modifier|*
name|l1
decl_stmt|,
modifier|*
name|l2
decl_stmt|;
name|int
name|lpos
decl_stmt|;
if|if
condition|(
operator|!
name|zone
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
name|zone
operator|->
name|soa
operator|&&
name|zone
operator|->
name|soa
operator|->
name|name
condition|)
block|{
name|soa_label_count
operator|=
name|ldns_dname_label_count
argument_list|(
name|zone
operator|->
name|soa
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
name|cur_node
operator|=
name|ldns_rbtree_first
argument_list|(
name|zone
operator|->
name|names
argument_list|)
expr_stmt|;
while|while
condition|(
name|cur_node
operator|!=
name|LDNS_RBTREE_NULL
condition|)
block|{
name|next_node
operator|=
name|ldns_rbtree_next
argument_list|(
name|cur_node
argument_list|)
expr_stmt|;
comment|/* skip glue */
while|while
condition|(
name|next_node
operator|!=
name|LDNS_RBTREE_NULL
operator|&&
name|next_node
operator|->
name|data
operator|&&
operator|(
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|next_node
operator|->
name|data
operator|)
operator|->
name|is_glue
condition|)
block|{
name|next_node
operator|=
name|ldns_rbtree_next
argument_list|(
name|next_node
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|next_node
operator|==
name|LDNS_RBTREE_NULL
condition|)
block|{
name|next_node
operator|=
name|ldns_rbtree_first
argument_list|(
name|zone
operator|->
name|names
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cur_node
operator|->
name|data
operator|||
operator|!
name|next_node
operator|->
name|data
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|cur_name
operator|=
operator|(
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|cur_node
operator|->
name|data
operator|)
operator|->
name|name
expr_stmt|;
name|next_name
operator|=
operator|(
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|next_node
operator|->
name|data
operator|)
operator|->
name|name
expr_stmt|;
name|cur_label_count
operator|=
name|ldns_dname_label_count
argument_list|(
name|cur_name
argument_list|)
expr_stmt|;
name|next_label_count
operator|=
name|ldns_dname_label_count
argument_list|(
name|next_name
argument_list|)
expr_stmt|;
comment|/* Since the names are in canonical order, we can 		 * recognize empty non-terminals by their labels; 		 * every label after the first one on the next owner 		 * name is a non-terminal if it either does not exist 		 * in the current name or is different from the same 		 * label in the current name (counting from the end) 		 */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|next_label_count
operator|-
name|soa_label_count
condition|;
name|i
operator|++
control|)
block|{
name|lpos
operator|=
operator|(
name|int
operator|)
name|cur_label_count
operator|-
operator|(
name|int
operator|)
name|next_label_count
operator|+
operator|(
name|int
operator|)
name|i
expr_stmt|;
if|if
condition|(
name|lpos
operator|>=
literal|0
condition|)
block|{
name|l1
operator|=
name|ldns_dname_clone_from
argument_list|(
name|cur_name
argument_list|,
operator|(
name|uint8_t
operator|)
name|lpos
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|l1
operator|=
name|NULL
expr_stmt|;
block|}
name|l2
operator|=
name|ldns_dname_clone_from
argument_list|(
name|next_name
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|l1
operator|||
name|ldns_dname_compare
argument_list|(
name|l1
argument_list|,
name|l2
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* We have an empty nonterminal, add it to the 				 * tree 				 */
name|new_name
operator|=
name|ldns_dnssec_name_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|new_name
condition|)
block|{
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|new_name
operator|->
name|name
operator|=
name|ldns_dname_clone_from
argument_list|(
name|next_name
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_name
operator|->
name|name
condition|)
block|{
name|ldns_dnssec_name_free
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|new_name
operator|->
name|name_alloced
operator|=
name|true
expr_stmt|;
name|new_node
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_rbnode_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_node
condition|)
block|{
name|ldns_dnssec_name_free
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|new_node
operator|->
name|key
operator|=
name|new_name
operator|->
name|name
expr_stmt|;
name|new_node
operator|->
name|data
operator|=
name|new_name
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rbtree_insert
argument_list|(
name|zone
operator|->
name|names
argument_list|,
name|new_node
argument_list|)
expr_stmt|;
name|ldns_dnssec_name_make_hashed_name
argument_list|(
name|zone
argument_list|,
name|new_name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|l1
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|l2
argument_list|)
expr_stmt|;
block|}
comment|/* we might have inserted a new node after 		 * the current one so we can't just use next() 		 */
if|if
condition|(
name|next_node
operator|!=
name|ldns_rbtree_first
argument_list|(
name|zone
operator|->
name|names
argument_list|)
condition|)
block|{
name|cur_node
operator|=
name|next_node
expr_stmt|;
block|}
else|else
block|{
name|cur_node
operator|=
name|LDNS_RBTREE_NULL
expr_stmt|;
block|}
block|}
return|return
name|LDNS_STATUS_OK
return|;
block|}
name|bool
name|ldns_dnssec_zone_is_nsec3_optout
parameter_list|(
name|ldns_dnssec_zone
modifier|*
name|zone
parameter_list|)
block|{
name|ldns_rr
modifier|*
name|nsec3
decl_stmt|;
name|ldns_rbnode_t
modifier|*
name|node
decl_stmt|;
if|if
condition|(
name|ldns_dnssec_name_find_rrset
argument_list|(
name|zone
operator|->
name|soa
argument_list|,
name|LDNS_RR_TYPE_NSEC3PARAM
argument_list|)
condition|)
block|{
name|node
operator|=
name|ldns_rbtree_first
argument_list|(
name|zone
operator|->
name|names
argument_list|)
expr_stmt|;
while|while
condition|(
name|node
operator|!=
name|LDNS_RBTREE_NULL
condition|)
block|{
name|nsec3
operator|=
operator|(
operator|(
name|ldns_dnssec_name
operator|*
operator|)
name|node
operator|->
name|data
operator|)
operator|->
name|nsec
expr_stmt|;
if|if
condition|(
name|nsec3
operator|&&
name|ldns_rr_get_type
argument_list|(
name|nsec3
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
operator|&&
name|ldns_nsec3_optout
argument_list|(
name|nsec3
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
name|node
operator|=
name|ldns_rbtree_next
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|false
return|;
block|}
end_function

end_unit


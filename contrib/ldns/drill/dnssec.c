begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * dnssec.c  * Some DNSSEC helper function are defined here  * and tracing is done  * (c) 2005 NLnet Labs  *  * See the file LICENSE for the license  *  */
end_comment

begin_include
include|#
directive|include
file|"drill.h"
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_comment
comment|/* get rr_type from a server from a server */
end_comment

begin_function
name|ldns_rr_list
modifier|*
name|get_rr
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|zname
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|)
block|{
comment|/* query, retrieve, extract and return */
name|ldns_pkt
modifier|*
name|p
decl_stmt|;
name|ldns_rr_list
modifier|*
name|found
decl_stmt|;
name|p
operator|=
name|ldns_pkt_new
argument_list|()
expr_stmt|;
name|found
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ldns_resolver_send
argument_list|(
operator|&
name|p
argument_list|,
name|res
argument_list|,
name|zname
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|found
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|t
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
block|}
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|found
return|;
block|}
end_function

begin_function
name|void
name|drill_pkt_print
parameter_list|(
name|FILE
modifier|*
name|fd
parameter_list|,
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_pkt
modifier|*
name|p
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|new_nss
decl_stmt|;
name|ldns_rr_list
modifier|*
name|hostnames
decl_stmt|;
name|char
modifier|*
name|answerfrom_str
decl_stmt|;
if|if
condition|(
name|verbosity
operator|<
literal|5
condition|)
block|{
return|return;
block|}
name|hostnames
operator|=
name|ldns_get_rr_list_name_by_addr
argument_list|(
name|r
argument_list|,
name|ldns_pkt_answerfrom
argument_list|(
name|p
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|new_nss
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|fd
argument_list|,
name|new_nss
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|new_nss
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|";; Received %d bytes from %s#%d("
argument_list|,
operator|(
name|int
operator|)
name|ldns_pkt_size
argument_list|(
name|p
argument_list|)
argument_list|,
name|ldns_rdf2str
argument_list|(
name|ldns_pkt_answerfrom
argument_list|(
name|p
argument_list|)
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|ldns_resolver_port
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
comment|/* if we can resolve this print it, other print the ip again */
if|if
condition|(
name|hostnames
condition|)
block|{
name|ldns_rdf_print
argument_list|(
name|fd
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|hostnames
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|hostnames
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|answerfrom_str
operator|=
name|ldns_rdf2str
argument_list|(
name|ldns_pkt_answerfrom
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|answerfrom_str
condition|)
block|{
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s"
argument_list|,
name|answerfrom_str
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|answerfrom_str
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|") in %u ms\n\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_querytime
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|drill_pkt_print_footer
parameter_list|(
name|FILE
modifier|*
name|fd
parameter_list|,
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_pkt
modifier|*
name|p
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|hostnames
decl_stmt|;
name|char
modifier|*
name|answerfrom_str
decl_stmt|;
if|if
condition|(
name|verbosity
operator|<
literal|5
condition|)
block|{
return|return;
block|}
name|hostnames
operator|=
name|ldns_get_rr_list_name_by_addr
argument_list|(
name|r
argument_list|,
name|ldns_pkt_answerfrom
argument_list|(
name|p
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|";; Received %d bytes from %s#%d("
argument_list|,
operator|(
name|int
operator|)
name|ldns_pkt_size
argument_list|(
name|p
argument_list|)
argument_list|,
name|ldns_rdf2str
argument_list|(
name|ldns_pkt_answerfrom
argument_list|(
name|p
argument_list|)
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|ldns_resolver_port
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
comment|/* if we can resolve this print it, other print the ip again */
if|if
condition|(
name|hostnames
condition|)
block|{
name|ldns_rdf_print
argument_list|(
name|fd
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|hostnames
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|hostnames
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|answerfrom_str
operator|=
name|ldns_rdf2str
argument_list|(
name|ldns_pkt_answerfrom
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|answerfrom_str
condition|)
block|{
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"%s"
argument_list|,
name|answerfrom_str
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|answerfrom_str
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|") in %u ms\n\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_querytime
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * generic function to get some RRset from a nameserver  * and possible some signatures too (that would be the day...)  */
end_comment

begin_function
name|ldns_pkt_type
name|get_dnssec_rr
parameter_list|(
name|ldns_pkt
modifier|*
name|p
parameter_list|,
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rr_list
modifier|*
modifier|*
name|rrlist
parameter_list|,
name|ldns_rr_list
modifier|*
modifier|*
name|sig
parameter_list|)
block|{
name|ldns_pkt_type
name|pt
init|=
name|LDNS_PACKET_UNKNOWN
decl_stmt|;
name|ldns_rr_list
modifier|*
name|sigs
init|=
name|NULL
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
if|if
condition|(
name|rrlist
condition|)
block|{
operator|*
name|rrlist
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|LDNS_PACKET_UNKNOWN
return|;
block|}
name|pt
operator|=
name|ldns_pkt_reply_type
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
condition|)
block|{
if|if
condition|(
name|rrlist
condition|)
block|{
operator|*
name|rrlist
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|p
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|rrlist
condition|)
block|{
operator|*
name|rrlist
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|p
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sig
condition|)
block|{
name|sigs
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|p
argument_list|,
name|name
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sigs
condition|)
block|{
name|sigs
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|p
argument_list|,
name|name
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* A DS-referral - get the DS records if they are there */
if|if
condition|(
name|rrlist
condition|)
block|{
operator|*
name|rrlist
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|t
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sig
condition|)
block|{
name|sigs
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sig
condition|)
block|{
operator|*
name|sig
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|sigs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
comment|/* only add the sigs that cover this type */
if|if
condition|(
name|t
operator|==
name|ldns_rdf2rr_type
argument_list|(
name|ldns_rr_rrsig_typecovered
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|sigs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
condition|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
operator|*
name|sig
argument_list|,
name|ldns_rr_clone
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|sigs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|sigs
argument_list|)
expr_stmt|;
if|if
condition|(
name|pt
operator|==
name|LDNS_PACKET_NXDOMAIN
operator|||
name|pt
operator|==
name|LDNS_PACKET_NODATA
condition|)
block|{
return|return
name|pt
return|;
block|}
else|else
block|{
return|return
name|LDNS_PACKET_ANSWER
return|;
block|}
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_denial
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|,
name|ldns_rr_list
modifier|*
modifier|*
name|nsec_rrs
parameter_list|,
name|ldns_rr_list
modifier|*
modifier|*
name|nsec_rr_sigs
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|HAVE_SSL
name|uint16_t
name|nsec_i
decl_stmt|;
name|ldns_rr_list
modifier|*
name|nsecs
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"VERIFY DENIAL FROM:\n"
argument_list|)
expr_stmt|;
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|LDNS_STATUS_CRYPTO_NO_RRSIG
expr_stmt|;
comment|/* Try to see if there are NSECS in the packet */
name|nsecs
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|pkt
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsecs
condition|)
block|{
for|for
control|(
name|nsec_i
operator|=
literal|0
init|;
name|nsec_i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsecs
argument_list|)
condition|;
name|nsec_i
operator|++
control|)
block|{
comment|/* there are four options: 			 * - name equals ownername and is covered by the type bitmap 			 * - name equals ownername but is not covered by the type bitmap 			 * - name falls within nsec coverage but is not equal to the owner name 			 * - name falls outside of nsec coverage 			 */
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|nsec_i
argument_list|)
argument_list|)
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 				printf("CHECKING NSEC:\n"); 				ldns_rr_print(stdout, ldns_rr_list_rr(nsecs, nsec_i)); 				printf("DAWASEM\n"); 				*/
if|if
condition|(
name|ldns_nsec_bitmap_covers_type
argument_list|(
name|ldns_nsec_get_bitmap
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|nsec_i
argument_list|)
argument_list|)
argument_list|,
name|type
argument_list|)
condition|)
block|{
comment|/* Error, according to the nsec this rrset is signed */
name|result
operator|=
name|LDNS_STATUS_CRYPTO_NO_RRSIG
expr_stmt|;
block|}
else|else
block|{
comment|/* ok nsec denies existence */
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|";; Existence of data set with this type denied by NSEC\n"
argument_list|)
expr_stmt|;
block|}
comment|/*printf(";; Verifiably insecure.\n");*/
if|if
condition|(
name|nsec_rrs
operator|&&
name|nsec_rr_sigs
condition|)
block|{
operator|(
name|void
operator|)
name|get_dnssec_rr
argument_list|(
name|pkt
argument_list|,
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|nsec_i
argument_list|)
argument_list|)
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|,
name|nsec_rrs
argument_list|,
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|nsecs
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|ldns_nsec_covers_name
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|nsec_i
argument_list|)
argument_list|,
name|name
argument_list|)
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|";; Existence of data set with this name denied by NSEC\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nsec_rrs
operator|&&
name|nsec_rr_sigs
condition|)
block|{
operator|(
name|void
operator|)
name|get_dnssec_rr
argument_list|(
name|pkt
argument_list|,
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|nsec_i
argument_list|)
argument_list|)
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|,
name|nsec_rrs
argument_list|,
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|nsecs
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
else|else
block|{
comment|/* nsec has nothing to do with this data */
block|}
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|nsecs
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|nsecs
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|pkt
argument_list|,
name|LDNS_RR_TYPE_NSEC3
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
operator|)
condition|)
block|{
name|ldns_rr_list
modifier|*
name|sigs
init|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|pkt
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
decl_stmt|;
name|ldns_rr
modifier|*
name|q
init|=
name|ldns_rr_new
argument_list|()
decl_stmt|;
name|ldns_rr
modifier|*
name|match
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|sigs
condition|)
block|{
if|if
condition|(
name|q
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|nsecs
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
if|if
condition|(
operator|!
name|q
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|nsecs
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|sigs
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|ldns_rr_set_question
argument_list|(
name|q
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ldns_rr_set_ttl
argument_list|(
name|q
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|q
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ldns_rr_owner
argument_list|(
name|q
argument_list|)
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|sigs
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|nsecs
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|ldns_rr_set_type
argument_list|(
name|q
argument_list|,
name|type
argument_list|)
expr_stmt|;
comment|/* result = ldns_dnssec_verify_denial_nsec3(q, nsecs, sigs, ldns_pkt_get_rcode(pkt), type, ldns_pkt_ancount(pkt) == 0); */
name|result
operator|=
name|ldns_dnssec_verify_denial_nsec3_match
argument_list|(
name|q
argument_list|,
name|nsecs
argument_list|,
name|sigs
argument_list|,
name|ldns_pkt_get_rcode
argument_list|(
name|pkt
argument_list|)
argument_list|,
name|type
argument_list|,
name|ldns_pkt_ancount
argument_list|(
name|pkt
argument_list|)
operator|==
literal|0
argument_list|,
operator|&
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|LDNS_STATUS_OK
operator|&&
name|match
operator|&&
name|nsec_rrs
operator|&&
name|nsec_rr_sigs
condition|)
block|{
operator|(
name|void
operator|)
name|get_dnssec_rr
argument_list|(
name|pkt
argument_list|,
name|ldns_rr_owner
argument_list|(
name|match
argument_list|)
argument_list|,
name|LDNS_RR_TYPE_NSEC3
argument_list|,
name|nsec_rrs
argument_list|,
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|nsecs
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|sigs
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
else|#
directive|else
operator|(
name|void
operator|)
name|pkt
expr_stmt|;
operator|(
name|void
operator|)
name|name
expr_stmt|;
operator|(
name|void
operator|)
name|type
expr_stmt|;
operator|(
name|void
operator|)
name|nsec_rrs
expr_stmt|;
operator|(
name|void
operator|)
name|nsec_rr_sigs
expr_stmt|;
return|return
name|LDNS_STATUS_ERR
return|;
endif|#
directive|endif
comment|/* HAVE_SSL */
block|}
end_function

begin_comment
comment|/* NSEC3 draft -07 */
end_comment

begin_comment
comment|/*return hash name match*/
end_comment

begin_function
name|ldns_rr
modifier|*
name|ldns_nsec3_exact_match
parameter_list|(
name|ldns_rdf
modifier|*
name|qname
parameter_list|,
name|ldns_rr_type
name|qtype
parameter_list|,
name|ldns_rr_list
modifier|*
name|nsec3s
parameter_list|)
block|{
name|uint8_t
name|algorithm
decl_stmt|;
name|uint32_t
name|iterations
decl_stmt|;
name|uint8_t
name|salt_length
decl_stmt|;
name|uint8_t
modifier|*
name|salt
decl_stmt|;
name|ldns_rdf
modifier|*
name|sname
init|=
name|NULL
decl_stmt|,
modifier|*
name|hashed_sname
init|=
name|NULL
decl_stmt|;
name|size_t
name|nsec_i
decl_stmt|;
name|ldns_rr
modifier|*
name|nsec
decl_stmt|;
name|ldns_rr
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
specifier|const
name|ldns_rr_descriptor
modifier|*
name|descriptor
decl_stmt|;
name|ldns_rdf
modifier|*
name|zone_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|";; finding exact match for "
argument_list|)
expr_stmt|;
name|descriptor
operator|=
name|ldns_rr_descript
argument_list|(
name|qtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor
operator|&&
name|descriptor
operator|->
name|_name
condition|)
block|{
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|descriptor
operator|->
name|_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"TYPE%d "
argument_list|,
name|qtype
argument_list|)
expr_stmt|;
block|}
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|qname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|qname
operator|||
operator|!
name|nsec3s
operator|||
name|ldns_rr_list_rr_count
argument_list|(
name|nsec3s
argument_list|)
operator|<
literal|1
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"no qname, nsec3s or list empty\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
name|nsec
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsec3s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|algorithm
operator|=
name|ldns_nsec3_algorithm
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|salt_length
operator|=
name|ldns_nsec3_salt_length
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|salt
operator|=
name|ldns_nsec3_salt_data
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|iterations
operator|=
name|ldns_nsec3_iterations
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
if|if
condition|(
name|salt
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|sname
operator|=
name|ldns_rdf_clone
argument_list|(
name|qname
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|";; owner name hashes to: "
argument_list|)
expr_stmt|;
block|}
name|hashed_sname
operator|=
name|ldns_nsec3_hash_name
argument_list|(
name|sname
argument_list|,
name|algorithm
argument_list|,
name|iterations
argument_list|,
name|salt_length
argument_list|,
name|salt
argument_list|)
expr_stmt|;
if|if
condition|(
name|hashed_sname
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|zone_name
operator|=
name|ldns_dname_left_chop
argument_list|(
name|ldns_rr_owner
argument_list|(
name|nsec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone_name
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|ldns_dname_cat
argument_list|(
name|hashed_sname
argument_list|,
name|zone_name
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
goto|goto
name|done
goto|;
block|}
empty_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|hashed_sname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|nsec_i
operator|=
literal|0
init|;
name|nsec_i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsec3s
argument_list|)
condition|;
name|nsec_i
operator|++
control|)
block|{
name|nsec
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsec3s
argument_list|,
name|nsec_i
argument_list|)
expr_stmt|;
comment|/* check values of iterations etc! */
comment|/* exact match? */
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|nsec
argument_list|)
argument_list|,
name|hashed_sname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|result
operator|=
name|nsec
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|done
label|:
name|ldns_rdf_deep_free
argument_list|(
name|zone_name
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|sname
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|hashed_sname
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|salt
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
if|if
condition|(
name|result
condition|)
block|{
name|printf
argument_list|(
literal|";; Found.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|";; Not foud.\n"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/*return the owner name of the closest encloser for name from the list of rrs */
end_comment

begin_comment
comment|/* this is NOT the hash, but the original name! */
end_comment

begin_function
name|ldns_rdf
modifier|*
name|ldns_nsec3_closest_encloser
parameter_list|(
name|ldns_rdf
modifier|*
name|qname
parameter_list|,
name|ldns_rr_type
name|qtype
parameter_list|,
name|ldns_rr_list
modifier|*
name|nsec3s
parameter_list|)
block|{
comment|/* remember parameters, they must match */
name|uint8_t
name|algorithm
decl_stmt|;
name|uint32_t
name|iterations
decl_stmt|;
name|uint8_t
name|salt_length
decl_stmt|;
name|uint8_t
modifier|*
name|salt
decl_stmt|;
name|ldns_rdf
modifier|*
name|sname
init|=
name|NULL
decl_stmt|,
modifier|*
name|hashed_sname
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|bool
name|flag
decl_stmt|;
name|bool
name|exact_match_found
decl_stmt|;
name|bool
name|in_range_found
decl_stmt|;
name|ldns_rdf
modifier|*
name|zone_name
init|=
name|NULL
decl_stmt|;
name|size_t
name|nsec_i
decl_stmt|;
name|ldns_rr
modifier|*
name|nsec
decl_stmt|;
name|ldns_rdf
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|qname
operator|||
operator|!
name|nsec3s
operator|||
name|ldns_rr_list_rr_count
argument_list|(
name|nsec3s
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|";; finding closest encloser for type %d "
argument_list|,
name|qtype
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|qname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|nsec
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsec3s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|algorithm
operator|=
name|ldns_nsec3_algorithm
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|salt_length
operator|=
name|ldns_nsec3_salt_length
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|salt
operator|=
name|ldns_nsec3_salt_data
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
name|iterations
operator|=
name|ldns_nsec3_iterations
argument_list|(
name|nsec
argument_list|)
expr_stmt|;
if|if
condition|(
name|salt
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|sname
operator|=
name|ldns_rdf_clone
argument_list|(
name|qname
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|flag
operator|=
name|false
expr_stmt|;
name|zone_name
operator|=
name|ldns_dname_left_chop
argument_list|(
name|ldns_rr_owner
argument_list|(
name|nsec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone_name
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/* algorithm from nsec3-07 8.3 */
while|while
condition|(
name|ldns_dname_label_count
argument_list|(
name|sname
argument_list|)
operator|>
literal|0
condition|)
block|{
name|exact_match_found
operator|=
name|false
expr_stmt|;
name|in_range_found
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|";; "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|sname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" hashes to: "
argument_list|)
expr_stmt|;
block|}
name|hashed_sname
operator|=
name|ldns_nsec3_hash_name
argument_list|(
name|sname
argument_list|,
name|algorithm
argument_list|,
name|iterations
argument_list|,
name|salt_length
argument_list|,
name|salt
argument_list|)
expr_stmt|;
if|if
condition|(
name|hashed_sname
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|ldns_dname_cat
argument_list|(
name|hashed_sname
argument_list|,
name|zone_name
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|hashed_sname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|nsec_i
operator|=
literal|0
init|;
name|nsec_i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsec3s
argument_list|)
condition|;
name|nsec_i
operator|++
control|)
block|{
name|nsec
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsec3s
argument_list|,
name|nsec_i
argument_list|)
expr_stmt|;
comment|/* check values of iterations etc! */
comment|/* exact match? */
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|nsec
argument_list|)
argument_list|,
name|hashed_sname
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|";; exact match found\n"
argument_list|)
expr_stmt|;
block|}
name|exact_match_found
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ldns_nsec_covers_name
argument_list|(
name|nsec
argument_list|,
name|hashed_sname
argument_list|)
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|";; in range of an nsec\n"
argument_list|)
expr_stmt|;
block|}
name|in_range_found
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|exact_match_found
operator|&&
name|in_range_found
condition|)
block|{
name|flag
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|exact_match_found
operator|&&
name|flag
condition|)
block|{
name|result
operator|=
name|ldns_rdf_clone
argument_list|(
name|sname
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|exact_match_found
operator|&&
operator|!
name|flag
condition|)
block|{
comment|// error!
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|";; the closest encloser is the same name (ie. this is an exact match, ie there is no closest encloser)\n"
argument_list|)
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|hashed_sname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
name|flag
operator|=
name|false
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|hashed_sname
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|sname
expr_stmt|;
name|sname
operator|=
name|ldns_dname_left_chop
argument_list|(
name|sname
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
block|}
name|done
label|:
name|LDNS_FREE
argument_list|(
name|salt
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|zone_name
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|";; no closest encloser found\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* todo checks from end of 6.2. here or in caller? */
return|return
name|result
return|;
block|}
end_function

end_unit


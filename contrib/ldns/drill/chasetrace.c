begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * chasetrace.c  * Where all the hard work concerning chasing  * and tracing is done  * (c) 2005, 2006 NLnet Labs  *  * See the file LICENSE for the license  *  */
end_comment

begin_include
include|#
directive|include
file|"drill.h"
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_comment
comment|/**  * trace down from the root to name  */
end_comment

begin_comment
comment|/* same naive method as in drill0.9   * We resolver _ALL_ the names, which is ofcourse not needed  * We _do_ use the local resolver to do that, so it still is  * fast, but it can be made to run much faster  */
end_comment

begin_function
name|ldns_pkt
modifier|*
name|do_trace
parameter_list|(
name|ldns_resolver
modifier|*
name|local_res
parameter_list|,
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|)
block|{
name|ldns_resolver
modifier|*
name|res
decl_stmt|;
name|ldns_pkt
modifier|*
name|p
decl_stmt|;
name|ldns_rr_list
modifier|*
name|new_nss_a
decl_stmt|;
name|ldns_rr_list
modifier|*
name|new_nss_aaaa
decl_stmt|;
name|ldns_rr_list
modifier|*
name|final_answer
decl_stmt|;
name|ldns_rr_list
modifier|*
name|new_nss
decl_stmt|;
name|ldns_rr_list
modifier|*
name|ns_addr
decl_stmt|;
name|uint16_t
name|loop_count
decl_stmt|;
name|ldns_rdf
modifier|*
name|pop
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|loop_count
operator|=
literal|0
expr_stmt|;
name|new_nss_a
operator|=
name|NULL
expr_stmt|;
name|new_nss_aaaa
operator|=
name|NULL
expr_stmt|;
name|new_nss
operator|=
name|NULL
expr_stmt|;
name|ns_addr
operator|=
name|NULL
expr_stmt|;
name|final_answer
operator|=
name|NULL
expr_stmt|;
name|p
operator|=
name|ldns_pkt_new
argument_list|()
expr_stmt|;
name|res
operator|=
name|ldns_resolver_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
if|if
condition|(
name|res
condition|)
block|{
name|ldns_resolver_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
name|error
argument_list|(
literal|"Memory allocation failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"Memory allocation failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* transfer some properties of local_res to res, 	 * because they were given on the commandline */
name|ldns_resolver_set_ip6
argument_list|(
name|res
argument_list|,
name|ldns_resolver_ip6
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_port
argument_list|(
name|res
argument_list|,
name|ldns_resolver_port
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_debug
argument_list|(
name|res
argument_list|,
name|ldns_resolver_debug
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_dnssec
argument_list|(
name|res
argument_list|,
name|ldns_resolver_dnssec
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_fail
argument_list|(
name|res
argument_list|,
name|ldns_resolver_fail
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_usevc
argument_list|(
name|res
argument_list|,
name|ldns_resolver_usevc
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_random
argument_list|(
name|res
argument_list|,
name|ldns_resolver_random
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_source
argument_list|(
name|res
argument_list|,
name|ldns_resolver_source
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_recursive
argument_list|(
name|res
argument_list|,
name|false
argument_list|)
expr_stmt|;
comment|/* setup the root nameserver in the new resolver */
name|status
operator|=
name|ldns_resolver_push_nameserver_rr_list
argument_list|(
name|res
argument_list|,
name|global_dns_root
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error adding root servers to resolver: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|global_dns_root
argument_list|)
expr_stmt|;
name|ldns_resolver_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* this must be a real query to local_res */
name|status
operator|=
name|ldns_resolver_send
argument_list|(
operator|&
name|p
argument_list|,
name|res
argument_list|,
name|ldns_dname_new_frm_str
argument_list|(
literal|"."
argument_list|)
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* p can still be NULL */
if|if
condition|(
name|ldns_pkt_empty
argument_list|(
name|p
argument_list|)
condition|)
block|{
name|warning
argument_list|(
literal|"No root server information received"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
if|if
condition|(
operator|!
name|ldns_pkt_empty
argument_list|(
name|p
argument_list|)
condition|)
block|{
name|drill_pkt_print
argument_list|(
name|stdout
argument_list|,
name|local_res
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|error
argument_list|(
literal|"cannot use local resolver"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|status
operator|=
name|ldns_resolver_send
argument_list|(
operator|&
name|p
argument_list|,
name|res
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
operator|&&
name|ldns_pkt_reply_type
argument_list|(
name|p
argument_list|)
operator|==
name|LDNS_PACKET_REFERRAL
condition|)
block|{
if|if
condition|(
operator|!
name|p
condition|)
block|{
comment|/* some error occurred, bail out */
return|return
name|NULL
return|;
block|}
name|new_nss_a
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_A
argument_list|,
name|LDNS_SECTION_ADDITIONAL
argument_list|)
expr_stmt|;
name|new_nss_aaaa
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_AAAA
argument_list|,
name|LDNS_SECTION_ADDITIONAL
argument_list|)
expr_stmt|;
name|new_nss
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|!=
operator|-
literal|1
condition|)
block|{
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|new_nss
argument_list|)
expr_stmt|;
block|}
comment|/* checks itself for verbosity */
name|drill_pkt_print_footer
argument_list|(
name|stdout
argument_list|,
name|local_res
argument_list|,
name|p
argument_list|)
expr_stmt|;
comment|/* remove the old nameserver from the resolver */
while|while
condition|(
name|ldns_resolver_pop_nameserver
argument_list|(
name|res
argument_list|)
condition|)
block|{
comment|/* do it */
block|}
comment|/* also check for new_nss emptyness */
if|if
condition|(
operator|!
name|new_nss_aaaa
operator|&&
operator|!
name|new_nss_a
condition|)
block|{
comment|/*  			 * no nameserver found!!!  			 * try to resolve the names we do got  			 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|new_nss
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
comment|/* get the name of the nameserver */
name|pop
operator|=
name|ldns_rr_rdf
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|new_nss
argument_list|,
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pop
condition|)
block|{
break|break;
block|}
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|new_nss
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|pop
argument_list|)
expr_stmt|;
comment|/* retrieve it's addresses */
name|ns_addr
operator|=
name|ldns_rr_list_cat_clone
argument_list|(
name|ns_addr
argument_list|,
name|ldns_get_rr_list_addr_by_name
argument_list|(
name|local_res
argument_list|,
name|pop
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ns_addr
condition|)
block|{
if|if
condition|(
name|ldns_resolver_push_nameserver_rr_list
argument_list|(
name|res
argument_list|,
name|ns_addr
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|error
argument_list|(
literal|"Error adding new nameservers"
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ldns_rr_list_free
argument_list|(
name|ns_addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|ns_addr
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"Could not find the nameserver ip addr; abort"
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
comment|/* add the new ones */
if|if
condition|(
name|new_nss_aaaa
condition|)
block|{
if|if
condition|(
name|ldns_resolver_push_nameserver_rr_list
argument_list|(
name|res
argument_list|,
name|new_nss_aaaa
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|error
argument_list|(
literal|"adding new nameservers"
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|new_nss_a
condition|)
block|{
if|if
condition|(
name|ldns_resolver_push_nameserver_rr_list
argument_list|(
name|res
argument_list|,
name|new_nss_a
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|error
argument_list|(
literal|"adding new nameservers"
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|loop_count
operator|++
operator|>
literal|20
condition|)
block|{
comment|/* unlikely that we are doing something usefull */
name|error
argument_list|(
literal|"Looks like we are looping"
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|status
operator|=
name|ldns_resolver_send
argument_list|(
operator|&
name|p
argument_list|,
name|res
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|new_nss_aaaa
operator|=
name|NULL
expr_stmt|;
name|new_nss_a
operator|=
name|NULL
expr_stmt|;
name|ns_addr
operator|=
name|NULL
expr_stmt|;
block|}
name|status
operator|=
name|ldns_resolver_send
argument_list|(
operator|&
name|p
argument_list|,
name|res
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|new_nss
operator|=
name|ldns_pkt_authority
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|final_answer
operator|=
name|ldns_pkt_answer
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|!=
operator|-
literal|1
condition|)
block|{
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|final_answer
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|new_nss
argument_list|)
expr_stmt|;
block|}
name|drill_pkt_print_footer
argument_list|(
name|stdout
argument_list|,
name|local_res
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * Chase the given rr to a known and trusted key  *  * Based on drill 0.9  *  * the last argument prev_key_list, if not null, and type == DS, then the ds  * rr list we have must all be a ds for the keys in this list  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
name|ldns_status
name|do_chase
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|type
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|,
name|ldns_rr_list
modifier|*
name|trusted_keys
parameter_list|,
name|ldns_pkt
modifier|*
name|pkt_o
parameter_list|,
name|uint16_t
name|qflags
parameter_list|,
name|ldns_rr_list
modifier|*
name|ATTR_UNUSED
parameter_list|(
name|prev_key_list
parameter_list|)
parameter_list|,
name|int
name|verbosity
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|rrset
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
name|ldns_rr
modifier|*
name|orig_rr
init|=
name|NULL
decl_stmt|;
comment|/* 	ldns_rr_list *sigs; 	ldns_rr *cur_sig; 	uint16_t sig_i; 	ldns_rr_list *keys; */
name|ldns_pkt
modifier|*
name|pkt
decl_stmt|;
name|ldns_status
name|tree_result
decl_stmt|;
name|ldns_dnssec_data_chain
modifier|*
name|chain
decl_stmt|;
name|ldns_dnssec_trust_tree
modifier|*
name|tree
decl_stmt|;
specifier|const
name|ldns_rr_descriptor
modifier|*
name|descriptor
decl_stmt|;
name|descriptor
operator|=
name|ldns_rr_descript
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|ldns_dname2canonical
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|pkt
operator|=
name|ldns_pkt_clone
argument_list|(
name|pkt_o
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|name
condition|)
block|{
name|mesg
argument_list|(
literal|"No name to chase"
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_EMPTY_LABEL
return|;
block|}
if|if
condition|(
name|verbosity
operator|!=
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|";; Chasing: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor
operator|&&
name|descriptor
operator|->
name|_name
condition|)
block|{
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|descriptor
operator|->
name|_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" type %d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|trusted_keys
operator|||
name|ldns_rr_list_rr_count
argument_list|(
name|trusted_keys
argument_list|)
operator|<
literal|1
condition|)
block|{
name|warning
argument_list|(
literal|"No trusted keys specified"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pkt
condition|)
block|{
name|rrset
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|pkt
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rrset
condition|)
block|{
comment|/* nothing in answer, try authority */
name|rrset
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|pkt
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
block|}
comment|/* answer might be a cname, chase that first, then chase 		   cname target? (TODO) */
if|if
condition|(
operator|!
name|rrset
condition|)
block|{
name|rrset
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|pkt
argument_list|,
name|name
argument_list|,
name|LDNS_RR_TYPE_CNAME
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rrset
condition|)
block|{
comment|/* nothing in answer, try authority */
name|rrset
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|pkt
argument_list|,
name|name
argument_list|,
name|LDNS_RR_TYPE_CNAME
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* no packet? */
if|if
condition|(
name|verbosity
operator|>=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|LDNS_STATUS_MEM_ERR
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
if|if
condition|(
operator|!
name|rrset
condition|)
block|{
comment|/* not found in original packet, try again */
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|pkt
operator|=
name|NULL
expr_stmt|;
name|pkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|c
argument_list|,
name|qflags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pkt
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|LDNS_STATUS_NETWORK_ERR
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|LDNS_STATUS_NETWORK_ERR
return|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
block|}
name|rrset
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|pkt
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
block|}
name|orig_rr
operator|=
name|ldns_rr_new
argument_list|()
expr_stmt|;
comment|/* if the answer had no answer section, we need to construct our own rr (for instance if  * the rr qe asked for doesn't exist. This rr will be destroyed when the chain is freed */
if|if
condition|(
name|ldns_pkt_ancount
argument_list|(
name|pkt
argument_list|)
operator|<
literal|1
condition|)
block|{
name|ldns_rr_set_type
argument_list|(
name|orig_rr
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|orig_rr
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|chain
operator|=
name|ldns_dnssec_build_data_chain
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|rrset
argument_list|,
name|pkt
argument_list|,
name|ldns_rr_clone
argument_list|(
name|orig_rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* chase the first answer */
name|chain
operator|=
name|ldns_dnssec_build_data_chain
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|rrset
argument_list|,
name|pkt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"\n\nDNSSEC Data Chain:\n"
argument_list|)
expr_stmt|;
name|ldns_dnssec_data_chain_print
argument_list|(
name|stdout
argument_list|,
name|chain
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
name|tree
operator|=
name|ldns_dnssec_derive_trust_tree
argument_list|(
name|chain
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"\n\nDNSSEC Trust tree:\n"
argument_list|)
expr_stmt|;
name|ldns_dnssec_trust_tree_print
argument_list|(
name|stdout
argument_list|,
name|tree
argument_list|,
literal|0
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|trusted_keys
argument_list|)
operator|>
literal|0
condition|)
block|{
name|tree_result
operator|=
name|ldns_dnssec_trust_tree_contains_keys
argument_list|(
name|tree
argument_list|,
name|trusted_keys
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree_result
operator|==
name|LDNS_STATUS_DNSSEC_EXISTENCE_DENIED
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Existence denied or verifiably insecure\n"
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tree_result
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"No trusted keys found in tree: first error was: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|tree_result
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|tree_result
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"You have not provided any trusted keys.\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|ldns_rr_free
argument_list|(
name|orig_rr
argument_list|)
expr_stmt|;
name|ldns_dnssec_trust_tree_free
argument_list|(
name|tree
argument_list|)
expr_stmt|;
name|ldns_dnssec_data_chain_deep_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|rrset
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
comment|/*	ldns_rr_free(orig_rr);*/
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * securechasetrace.c  * Where all the hard work concerning secure tracing is done  *  * (c) 2005, 2006 NLnet Labs  *  * See the file LICENSE for the license  *  */
end_comment

begin_include
include|#
directive|include
file|"drill.h"
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_define
define|#
directive|define
name|SELF
value|"[S]"
end_define

begin_comment
comment|/* self sig ok */
end_comment

begin_define
define|#
directive|define
name|TRUST
value|"[T]"
end_define

begin_comment
comment|/* chain from parent */
end_comment

begin_define
define|#
directive|define
name|BOGUS
value|"[B]"
end_define

begin_comment
comment|/* bogus */
end_comment

begin_define
define|#
directive|define
name|UNSIGNED
value|"[U]"
end_define

begin_comment
comment|/* no relevant dnssec data found */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* See if there is a key/ds in trusted that matches  * a ds in *ds.   */
end_comment

begin_comment
unit|static ldns_rr_list * ds_key_match(ldns_rr_list *ds, ldns_rr_list *trusted) { 	size_t i, j; 	bool match; 	ldns_rr *rr_i, *rr_j; 	ldns_rr_list *keys;  	if (!trusted || !ds) { 		return NULL; 	}  	match = false; 	keys = ldns_rr_list_new(); 	if (!keys) { 		return NULL; 	}  	if (!ds || !trusted) { 		return NULL; 	}  	for (i = 0; i< ldns_rr_list_rr_count(trusted); i++) { 		rr_i = ldns_rr_list_rr(trusted, i); 		for (j = 0; j< ldns_rr_list_rr_count(ds); j++) {  			rr_j = ldns_rr_list_rr(ds, j); 			if (ldns_rr_compare_ds(rr_i, rr_j)) { 				match = true;
comment|/* only allow unique RRs to match */
end_comment

begin_endif
unit|ldns_rr_set_push_rr(keys, rr_i);  			} 		} 	} 	if (match) { 		return keys; 	} else { 		return NULL; 	} }
endif|#
directive|endif
end_endif

begin_function
name|ldns_pkt
modifier|*
name|get_dnssec_pkt
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|)
block|{
name|ldns_pkt
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|p
operator|=
name|ldns_resolver_query
argument_list|(
name|r
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
return|return
name|NULL
return|;
block|}
else|else
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
return|return
name|p
return|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_comment
comment|/*   * retrieve keys for this zone  */
end_comment

begin_function
specifier|static
name|ldns_pkt_type
name|get_key
parameter_list|(
name|ldns_pkt
modifier|*
name|p
parameter_list|,
name|ldns_rdf
modifier|*
name|apexname
parameter_list|,
name|ldns_rr_list
modifier|*
modifier|*
name|rrlist
parameter_list|,
name|ldns_rr_list
modifier|*
modifier|*
name|opt_sig
parameter_list|)
block|{
return|return
name|get_dnssec_rr
argument_list|(
name|p
argument_list|,
name|apexname
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|,
name|rrlist
argument_list|,
name|opt_sig
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * check to see if we can find a DS rrset here which we can then follow  */
end_comment

begin_function
specifier|static
name|ldns_pkt_type
name|get_ds
parameter_list|(
name|ldns_pkt
modifier|*
name|p
parameter_list|,
name|ldns_rdf
modifier|*
name|ownername
parameter_list|,
name|ldns_rr_list
modifier|*
modifier|*
name|rrlist
parameter_list|,
name|ldns_rr_list
modifier|*
modifier|*
name|opt_sig
parameter_list|)
block|{
return|return
name|get_dnssec_rr
argument_list|(
name|p
argument_list|,
name|ownername
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
name|rrlist
argument_list|,
name|opt_sig
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_function
name|void
name|remove_resolver_nameservers
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|pop
decl_stmt|;
comment|/* remove the old nameserver from the resolver */
while|while
condition|(
operator|(
name|pop
operator|=
name|ldns_resolver_pop_nameserver
argument_list|(
name|res
argument_list|)
operator|)
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|pop
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|show_current_nameservers
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Current nameservers for resolver object:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_resolver_nameserver_count
argument_list|(
name|res
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|ldns_resolver_nameservers
argument_list|(
name|res
argument_list|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*ldns_pkt **/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
name|int
name|do_secure_trace
parameter_list|(
name|ldns_resolver
modifier|*
name|local_res
parameter_list|,
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|,
name|ldns_rr_list
modifier|*
name|trusted_keys
parameter_list|,
name|ldns_rdf
modifier|*
name|start_name
parameter_list|)
block|{
name|ldns_resolver
modifier|*
name|res
decl_stmt|;
name|ldns_pkt
modifier|*
name|p
decl_stmt|,
modifier|*
name|local_p
decl_stmt|;
name|ldns_rr_list
modifier|*
name|new_nss
decl_stmt|;
name|ldns_rr_list
modifier|*
name|ns_addr
decl_stmt|;
name|ldns_rdf
modifier|*
name|pop
decl_stmt|;
name|ldns_rdf
modifier|*
modifier|*
name|labels
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|status
decl_stmt|,
name|st
decl_stmt|;
name|ssize_t
name|i
decl_stmt|;
name|size_t
name|j
decl_stmt|;
name|size_t
name|k
decl_stmt|;
name|size_t
name|l
decl_stmt|;
name|uint8_t
name|labels_count
init|=
literal|0
decl_stmt|;
comment|/* dnssec */
name|ldns_rr_list
modifier|*
name|key_list
decl_stmt|;
name|ldns_rr_list
modifier|*
name|key_sig_list
decl_stmt|;
name|ldns_rr_list
modifier|*
name|ds_list
decl_stmt|;
name|ldns_rr_list
modifier|*
name|ds_sig_list
decl_stmt|;
name|ldns_rr_list
modifier|*
name|correct_key_list
decl_stmt|;
name|ldns_rr_list
modifier|*
name|trusted_ds_rrs
decl_stmt|;
name|bool
name|new_keys_trusted
init|=
name|false
decl_stmt|;
name|ldns_rr_list
modifier|*
name|current_correct_keys
decl_stmt|;
name|ldns_rr_list
modifier|*
name|dataset
decl_stmt|;
name|ldns_rr_list
modifier|*
name|nsec_rrs
init|=
name|NULL
decl_stmt|;
name|ldns_rr_list
modifier|*
name|nsec_rr_sigs
init|=
name|NULL
decl_stmt|;
comment|/* empty non-terminal check */
name|bool
name|ent
decl_stmt|;
name|ldns_rr
modifier|*
name|nsecrr
decl_stmt|;
comment|/* The nsec that proofs the non-terminal */
name|ldns_rdf
modifier|*
name|hashed_name
decl_stmt|;
comment|/* The query hashed with nsec3 params */
name|ldns_rdf
modifier|*
name|label0
decl_stmt|;
comment|/* The first label of an nsec3 owner name */
comment|/* glue handling */
name|ldns_rr_list
modifier|*
name|new_ns_addr
decl_stmt|;
name|ldns_rr_list
modifier|*
name|old_ns_addr
decl_stmt|;
name|ldns_rr
modifier|*
name|ns_rr
decl_stmt|;
name|int
name|result
init|=
literal|0
decl_stmt|;
comment|/* printing niceness */
specifier|const
name|ldns_rr_descriptor
modifier|*
name|descriptor
decl_stmt|;
name|descriptor
operator|=
name|ldns_rr_descript
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|new_nss
operator|=
name|NULL
expr_stmt|;
name|ns_addr
operator|=
name|NULL
expr_stmt|;
name|key_list
operator|=
name|NULL
expr_stmt|;
name|ds_list
operator|=
name|NULL
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
name|local_p
operator|=
name|NULL
expr_stmt|;
name|res
operator|=
name|ldns_resolver_new
argument_list|()
expr_stmt|;
name|key_sig_list
operator|=
name|NULL
expr_stmt|;
name|ds_sig_list
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|error
argument_list|(
literal|"Memory allocation failed"
argument_list|)
expr_stmt|;
name|result
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|result
return|;
block|}
name|correct_key_list
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|correct_key_list
condition|)
block|{
name|error
argument_list|(
literal|"Memory allocation failed"
argument_list|)
expr_stmt|;
name|result
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|result
return|;
block|}
name|trusted_ds_rrs
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|trusted_ds_rrs
condition|)
block|{
name|error
argument_list|(
literal|"Memory allocation failed"
argument_list|)
expr_stmt|;
name|result
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|result
return|;
block|}
comment|/* Add all preset trusted DS signatures to the list of trusted DS RRs. */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|trusted_keys
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|ldns_rr
modifier|*
name|one_rr
init|=
name|ldns_rr_list_rr
argument_list|(
name|trusted_keys
argument_list|,
name|j
argument_list|)
decl_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|one_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_DS
condition|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|trusted_ds_rrs
argument_list|,
name|ldns_rr_clone
argument_list|(
name|one_rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* transfer some properties of local_res to res */
name|ldns_resolver_set_ip6
argument_list|(
name|res
argument_list|,
name|ldns_resolver_ip6
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_port
argument_list|(
name|res
argument_list|,
name|ldns_resolver_port
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_debug
argument_list|(
name|res
argument_list|,
name|ldns_resolver_debug
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_fail
argument_list|(
name|res
argument_list|,
name|ldns_resolver_fail
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_usevc
argument_list|(
name|res
argument_list|,
name|ldns_resolver_usevc
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_random
argument_list|(
name|res
argument_list|,
name|ldns_resolver_random
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_source
argument_list|(
name|res
argument_list|,
name|ldns_resolver_source
argument_list|(
name|local_res
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_recursive
argument_list|(
name|local_res
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ldns_resolver_set_recursive
argument_list|(
name|res
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_resolver_set_dnssec_cd
argument_list|(
name|res
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_resolver_set_dnssec
argument_list|(
name|res
argument_list|,
name|true
argument_list|)
expr_stmt|;
comment|/* setup the root nameserver in the new resolver */
name|status
operator|=
name|ldns_resolver_push_nameserver_rr_list
argument_list|(
name|res
argument_list|,
name|global_dns_root
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"ERRRRR: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|global_dns_root
argument_list|)
expr_stmt|;
name|result
operator|=
name|status
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|labels_count
operator|=
name|ldns_dname_label_count
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|start_name
condition|)
block|{
if|if
condition|(
name|ldns_dname_is_subdomain
argument_list|(
name|name
argument_list|,
name|start_name
argument_list|)
condition|)
block|{
name|labels_count
operator|-=
name|ldns_dname_label_count
argument_list|(
name|start_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error; "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stderr
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" is not a subdomain of "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stderr
argument_list|,
name|start_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|labels
operator|=
name|LDNS_XMALLOC
argument_list|(
name|ldns_rdf
operator|*
argument_list|,
name|labels_count
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|labels
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|labels
index|[
literal|0
index|]
operator|=
name|ldns_dname_new_frm_str
argument_list|(
name|LDNS_ROOT_LABEL_STR
argument_list|)
expr_stmt|;
name|labels
index|[
literal|1
index|]
operator|=
name|ldns_rdf_clone
argument_list|(
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
operator|(
name|ssize_t
operator|)
name|labels_count
operator|+
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|labels
index|[
name|i
index|]
operator|=
name|ldns_dname_left_chop
argument_list|(
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* get the nameserver for the label 	 * ask: dnskey and ds for the label 	 */
for|for
control|(
name|i
operator|=
operator|(
name|ssize_t
operator|)
name|labels_count
operator|+
literal|1
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|status
operator|=
name|ldns_resolver_send
argument_list|(
operator|&
name|local_p
argument_list|,
name|res
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|local_p
argument_list|)
expr_stmt|;
block|}
name|new_nss
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|local_p
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_nss
condition|)
block|{
comment|/* if it's a delegation, servers put them in the auth section */
name|new_nss
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|local_p
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
block|}
comment|/* if this is the final step there might not be nameserver records 		   of course if the data is in the apex, there are, so cover both 		   cases */
if|if
condition|(
name|new_nss
operator|||
name|i
operator|>
literal|1
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|new_nss
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|ns_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|new_nss
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|pop
operator|=
name|ldns_rr_rdf
argument_list|(
name|ns_rr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pop
condition|)
block|{
name|printf
argument_list|(
literal|"nopo\n"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* retrieve it's addresses */
comment|/* trust glue? */
name|new_ns_addr
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ldns_dname_is_subdomain
argument_list|(
name|pop
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|new_ns_addr
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|local_p
argument_list|,
name|pop
argument_list|,
name|LDNS_RR_TYPE_A
argument_list|,
name|LDNS_SECTION_ADDITIONAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|new_ns_addr
operator|||
name|ldns_rr_list_rr_count
argument_list|(
name|new_ns_addr
argument_list|)
operator|==
literal|0
condition|)
block|{
name|new_ns_addr
operator|=
name|ldns_get_rr_list_addr_by_name
argument_list|(
name|res
argument_list|,
name|pop
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|new_ns_addr
operator|||
name|ldns_rr_list_rr_count
argument_list|(
name|new_ns_addr
argument_list|)
operator|==
literal|0
condition|)
block|{
name|new_ns_addr
operator|=
name|ldns_get_rr_list_addr_by_name
argument_list|(
name|local_res
argument_list|,
name|pop
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|new_ns_addr
condition|)
block|{
name|old_ns_addr
operator|=
name|ns_addr
expr_stmt|;
name|ns_addr
operator|=
name|ldns_rr_list_cat_clone
argument_list|(
name|ns_addr
argument_list|,
name|new_ns_addr
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|old_ns_addr
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|new_ns_addr
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|new_nss
argument_list|)
expr_stmt|;
if|if
condition|(
name|ns_addr
condition|)
block|{
name|remove_resolver_nameservers
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_resolver_push_nameserver_rr_list
argument_list|(
name|res
argument_list|,
name|ns_addr
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|error
argument_list|(
literal|"Error adding new nameservers"
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|local_p
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|ns_addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|ldns_verify_denial
argument_list|(
name|local_p
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|,
operator|&
name|nsec_rrs
argument_list|,
operator|&
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
comment|/* verify the nsec3 themselves*/
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"NSEC(3) Records to verify:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|nsec_rrs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"With signatures:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"correct keys:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|correct_key_list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|nsec_rrs
argument_list|,
name|nsec_rr_sigs
argument_list|,
name|trusted_keys
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|TRUST
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Existence denied: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 						if (descriptor&& descriptor->_name) { 							printf(" %s", descriptor->_name); 						} else { 							printf(" TYPE%u", t); 						} 	*/
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|" NS\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|nsec_rrs
argument_list|,
name|nsec_rr_sigs
argument_list|,
name|correct_key_list
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|SELF
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Existence denied: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 						if (descriptor&& descriptor->_name) { 							printf(" %s", descriptor->_name); 						} else { 							printf(" TYPE%u", t); 						} 	*/
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|" NS\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|BOGUS
argument_list|)
expr_stmt|;
name|result
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|";; Error verifying denial of existence for name "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 						printf(" type "); 						if (descriptor&& descriptor->_name) { 							printf("%s", descriptor->_name); 						} else { 							printf("TYPE%u", t); 						} 	*/
name|printf
argument_list|(
literal|"NS: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|st
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|BOGUS
argument_list|)
expr_stmt|;
name|result
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|";; Error verifying denial of existence for name "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"NS: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* there might be an empty non-terminal, in which case we need to continue */
name|ent
operator|=
name|false
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsec_rrs
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|nsecrr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsec_rrs
argument_list|,
name|j
argument_list|)
expr_stmt|;
comment|/* For NSEC when the next name is a subdomain of the question */
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|nsecrr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC
operator|&&
name|ldns_dname_is_subdomain
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|nsecrr
argument_list|,
literal|0
argument_list|)
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|ent
operator|=
name|true
expr_stmt|;
comment|/* For NSEC3, the hash matches the name and the type bitmap is empty*/
block|}
elseif|else
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|nsecrr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
name|hashed_name
operator|=
name|ldns_nsec3_hash_name_frm_nsec3
argument_list|(
name|nsecrr
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|label0
operator|=
name|ldns_dname_label
argument_list|(
name|ldns_rr_owner
argument_list|(
name|nsecrr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|hashed_name
operator|&&
name|label0
operator|&&
name|ldns_dname_compare
argument_list|(
name|hashed_name
argument_list|,
name|label0
argument_list|)
operator|==
literal|0
operator|&&
name|ldns_nsec3_bitmap
argument_list|(
name|nsecrr
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ent
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|label0
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|label0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hashed_name
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|hashed_name
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|ent
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|nsec_rrs
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|local_p
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|";; There is an empty non-terminal here, continue\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|ldns_resolver_nameserver_count
argument_list|(
name|res
argument_list|)
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"No nameservers found for this node"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|ldns_pkt_free
argument_list|(
name|local_p
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|";; Domain: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* retrieve keys for current domain, and verify them 		   if they match an already trusted DS, or if one of the 		   keys used to sign these is trusted, add the keys to 		   the trusted list */
name|p
operator|=
name|get_dnssec_pkt
argument_list|(
name|res
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|get_key
argument_list|(
name|p
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|,
operator|&
name|key_list
argument_list|,
operator|&
name|key_sig_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|key_sig_list
condition|)
block|{
if|if
condition|(
name|key_list
condition|)
block|{
name|current_correct_keys
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|key_list
argument_list|,
name|key_sig_list
argument_list|,
name|key_list
argument_list|,
name|current_correct_keys
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
comment|/* add all signed keys (don't just add current_correct, you'd miss 					 * the zsk's then */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|key_list
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|correct_key_list
argument_list|,
name|ldns_rr_clone
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|key_list
argument_list|,
name|j
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* check whether these keys were signed 					 * by a trusted keys. if so, these 					 * keys are also trusted */
name|new_keys_trusted
operator|=
name|false
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|current_correct_keys
argument_list|)
condition|;
name|k
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|trusted_ds_rrs
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|ldns_rr_compare_ds
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|current_correct_keys
argument_list|,
name|k
argument_list|)
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|trusted_ds_rrs
argument_list|,
name|j
argument_list|)
argument_list|)
condition|)
block|{
name|new_keys_trusted
operator|=
name|true
expr_stmt|;
block|}
block|}
block|}
comment|/* also all keys are trusted if one of the current correct keys is trusted */
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|current_correct_keys
argument_list|)
condition|;
name|k
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|trusted_keys
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|ldns_rr_compare
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|current_correct_keys
argument_list|,
name|k
argument_list|)
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|trusted_keys
argument_list|,
name|j
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|new_keys_trusted
operator|=
name|true
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|new_keys_trusted
condition|)
block|{
name|ldns_rr_list_push_rr_list
argument_list|(
name|trusted_keys
argument_list|,
name|key_list
argument_list|)
expr_stmt|;
name|print_rr_list_abbr
argument_list|(
name|stdout
argument_list|,
name|key_list
argument_list|,
name|TRUST
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|key_list
argument_list|)
expr_stmt|;
name|key_list
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|";; Signature ok but no chain to a trusted key or ds record\n"
argument_list|)
expr_stmt|;
block|}
name|print_rr_list_abbr
argument_list|(
name|stdout
argument_list|,
name|key_list
argument_list|,
name|SELF
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|key_list
argument_list|)
expr_stmt|;
name|key_list
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
block|{
name|print_rr_list_abbr
argument_list|(
name|stdout
argument_list|,
name|key_list
argument_list|,
name|BOGUS
argument_list|)
expr_stmt|;
name|result
operator|=
literal|2
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|key_list
argument_list|)
expr_stmt|;
name|key_list
operator|=
name|NULL
expr_stmt|;
block|}
name|ldns_rr_list_free
argument_list|(
name|current_correct_keys
argument_list|)
expr_stmt|;
name|current_correct_keys
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|";; No DNSKEY record found for "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|key_sig_list
argument_list|)
expr_stmt|;
name|key_sig_list
operator|=
name|NULL
expr_stmt|;
comment|/* check the DS records for the next child domain */
if|if
condition|(
name|i
operator|>
literal|1
condition|)
block|{
name|p
operator|=
name|get_dnssec_pkt
argument_list|(
name|res
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|get_ds
argument_list|(
name|p
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|,
operator|&
name|ds_list
argument_list|,
operator|&
name|ds_sig_list
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ds_list
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ds_sig_list
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|ds_sig_list
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|get_dnssec_pkt
argument_list|(
name|res
argument_list|,
name|name
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|get_ds
argument_list|(
name|p
argument_list|,
name|NULL
argument_list|,
operator|&
name|ds_list
argument_list|,
operator|&
name|ds_sig_list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ds_sig_list
condition|)
block|{
if|if
condition|(
name|ds_list
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"VERIFYING:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"DS LIST:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|ds_list
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"SIGS:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|ds_sig_list
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"KEYS:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|correct_key_list
argument_list|)
expr_stmt|;
block|}
name|current_correct_keys
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|ds_list
argument_list|,
name|ds_sig_list
argument_list|,
name|correct_key_list
argument_list|,
name|current_correct_keys
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
comment|/* if the ds is signed by a trusted key and a key from correct keys 						   matches that ds, add that key to the trusted keys */
name|new_keys_trusted
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Checking if signing key is trusted:\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|current_correct_keys
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"New key: "
argument_list|)
expr_stmt|;
name|ldns_rr_print
argument_list|(
name|stdout
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|current_correct_keys
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|trusted_keys
argument_list|)
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"\tTrusted key: "
argument_list|)
expr_stmt|;
name|ldns_rr_print
argument_list|(
name|stdout
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|trusted_keys
argument_list|,
name|k
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_rr_compare
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|current_correct_keys
argument_list|,
name|j
argument_list|)
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|trusted_keys
argument_list|,
name|k
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Key is now trusted!\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|l
operator|=
literal|0
init|;
name|l
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|ds_list
argument_list|)
condition|;
name|l
operator|++
control|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|trusted_ds_rrs
argument_list|,
name|ldns_rr_clone
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|ds_list
argument_list|,
name|l
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|new_keys_trusted
operator|=
name|true
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|new_keys_trusted
condition|)
block|{
name|print_rr_list_abbr
argument_list|(
name|stdout
argument_list|,
name|ds_list
argument_list|,
name|TRUST
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|print_rr_list_abbr
argument_list|(
name|stdout
argument_list|,
name|ds_list
argument_list|,
name|SELF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|result
operator|=
literal|3
expr_stmt|;
name|print_rr_list_abbr
argument_list|(
name|stdout
argument_list|,
name|ds_list
argument_list|,
name|BOGUS
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_free
argument_list|(
name|current_correct_keys
argument_list|)
expr_stmt|;
name|current_correct_keys
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* wait apparently there were no keys either, go back to the ds packet */
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|ds_sig_list
argument_list|)
expr_stmt|;
name|p
operator|=
name|get_dnssec_pkt
argument_list|(
name|res
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|get_ds
argument_list|(
name|p
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|,
operator|&
name|ds_list
argument_list|,
operator|&
name|ds_sig_list
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_verify_denial
argument_list|(
name|p
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
operator|&
name|nsec_rrs
argument_list|,
operator|&
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"NSEC(3) Records to verify:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|nsec_rrs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"With signatures:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"correct keys:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|correct_key_list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|nsec_rrs
argument_list|,
name|nsec_rr_sigs
argument_list|,
name|trusted_keys
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|TRUST
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Existence denied: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" DS"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|nsec_rrs
argument_list|,
name|nsec_rr_sigs
argument_list|,
name|correct_key_list
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|SELF
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Existence denied: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" DS"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
literal|4
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|BOGUS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Error verifying denial of existence for "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" DS"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|st
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_CRYPTO_NO_RRSIG
condition|)
block|{
name|printf
argument_list|(
literal|";; No DS for "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"[B] Unable to verify denial of existence for "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|labels
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" DS: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|";; No ds record for delegation\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|ds_list
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* if this is the last label, just verify the data and stop */
name|p
operator|=
name|get_dnssec_pkt
argument_list|(
name|res
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|,
name|t
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|get_dnssec_rr
argument_list|(
name|p
argument_list|,
name|labels
index|[
name|i
index|]
argument_list|,
name|t
argument_list|,
operator|&
name|dataset
argument_list|,
operator|&
name|key_sig_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataset
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|dataset
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|key_sig_list
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|key_sig_list
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/* If this is a wildcard, you must be able to deny exact match */
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|dataset
argument_list|,
name|key_sig_list
argument_list|,
name|trusted_keys
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|TRUST
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|dataset
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|dataset
argument_list|,
name|key_sig_list
argument_list|,
name|correct_key_list
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|SELF
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|dataset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
literal|5
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|BOGUS
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|dataset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|";; Error: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|st
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|UNSIGNED
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|dataset
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|dataset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|ldns_verify_denial
argument_list|(
name|p
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
operator|&
name|nsec_rrs
argument_list|,
operator|&
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
comment|/* verify the nsec3 themselves*/
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"NSEC(3) Records to verify:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|nsec_rrs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"With signatures:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"correct keys:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|correct_key_list
argument_list|)
expr_stmt|;
comment|/* 						printf("trusted keys at %p:\n", trusted_keys); 						ldns_rr_list_print(stdout, trusted_keys); */
block|}
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|nsec_rrs
argument_list|,
name|nsec_rr_sigs
argument_list|,
name|trusted_keys
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|TRUST
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Existence denied: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor
operator|&&
name|descriptor
operator|->
name|_name
condition|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|descriptor
operator|->
name|_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" TYPE%u"
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|st
operator|=
name|ldns_verify
argument_list|(
name|nsec_rrs
argument_list|,
name|nsec_rr_sigs
argument_list|,
name|correct_key_list
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|SELF
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Existence denied: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor
operator|&&
name|descriptor
operator|->
name|_name
condition|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|descriptor
operator|->
name|_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" TYPE%u"
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
literal|6
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s "
argument_list|,
name|BOGUS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Error verifying denial of existence for "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" type "
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor
operator|&&
name|descriptor
operator|->
name|_name
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|descriptor
operator|->
name|_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"TYPE%u"
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|": %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|st
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|nsec_rrs
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|nsec_rr_sigs
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* */
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_CRYPTO_NO_RRSIG
condition|)
block|{
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|UNSIGNED
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"No data found for: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" type "
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor
operator|&&
name|descriptor
operator|->
name|_name
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|descriptor
operator|->
name|_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"TYPE%u"
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"[B] Unable to verify denial of existence for "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" type "
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor
operator|&&
name|descriptor
operator|->
name|_name
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|descriptor
operator|->
name|_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"TYPE%u"
argument_list|,
name|t
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|new_nss
operator|=
name|NULL
expr_stmt|;
name|ns_addr
operator|=
name|NULL
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|key_list
argument_list|)
expr_stmt|;
name|key_list
operator|=
name|NULL
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|key_sig_list
argument_list|)
expr_stmt|;
name|key_sig_list
operator|=
name|NULL
expr_stmt|;
name|ds_list
operator|=
name|NULL
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|ds_sig_list
argument_list|)
expr_stmt|;
name|ds_sig_list
operator|=
name|NULL
expr_stmt|;
block|}
name|printf
argument_list|(
literal|";;"
name|SELF
literal|" self sig OK; "
name|BOGUS
literal|" bogus; "
name|TRUST
literal|" trusted\n"
argument_list|)
expr_stmt|;
comment|/* verbose mode? 	printf("Trusted keys:\n"); 	ldns_rr_list_print(stdout, trusted_keys); 	printf("trusted dss:\n"); 	ldns_rr_list_print(stdout, trusted_ds_rrs); 	*/
name|done
label|:
name|ldns_rr_list_deep_free
argument_list|(
name|trusted_ds_rrs
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|correct_key_list
argument_list|)
expr_stmt|;
name|ldns_resolver_deep_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|labels
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|ssize_t
operator|)
name|labels_count
operator|+
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|labels
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|labels
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

end_unit


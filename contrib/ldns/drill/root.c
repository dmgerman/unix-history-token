begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * root.c  * Function to handle to the rootservers  * and to update and prime them  * (c) 2005 NLnet Labs  *  * See the file LICENSE for the license  *  */
end_comment

begin_include
include|#
directive|include
file|"drill.h"
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_comment
comment|/* a global list of the root-servers */
end_comment

begin_decl_stmt
name|ldns_rr_list
modifier|*
name|global_dns_root
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* put a hardcoded list in the root and  * init the root rrlist structure */
end_comment

begin_function
name|void
name|init_root
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_rr
modifier|*
name|r
decl_stmt|;
name|global_dns_root
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"A.ROOT-SERVERS.NET.      3600000      A     198.41.0.4"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"A.ROOT-SERVERS.NET.      3600000      AAAA  2001:503:BA3E::2:30"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"B.ROOT-SERVERS.NET.      3600000      A     192.228.79.201"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"C.ROOT-SERVERS.NET.      3600000      A     192.33.4.12"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"D.ROOT-SERVERS.NET.      3600000      A     128.8.10.90"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"E.ROOT-SERVERS.NET.      3600000      A     192.203.230.10"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"F.ROOT-SERVERS.NET.      3600000      A     192.5.5.241"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"F.ROOT-SERVERS.NET.      3600000      AAAA  2001:500:2F::F"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"G.ROOT-SERVERS.NET.      3600000      A     192.112.36.4"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"H.ROOT-SERVERS.NET.      3600000      A     128.63.2.53"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"H.ROOT-SERVERS.NET.      3600000      AAAA  2001:500:1::803F:235"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"I.ROOT-SERVERS.NET.      3600000      A     192.36.148.17"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"J.ROOT-SERVERS.NET.      3600000      A     192.58.128.30"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"J.ROOT-SERVERS.NET.      3600000      AAAA  2001:503:C27::2:30"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"K.ROOT-SERVERS.NET.      3600000      A     193.0.14.129 "
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"K.ROOT-SERVERS.NET.      3600000      AAAA  2001:7FD::1"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"L.ROOT-SERVERS.NET.      3600000      A     199.7.83.42"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"L.ROOT-SERVERS.NET.      3600000      AAAA  2001:500:3::42   "
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"M.ROOT-SERVERS.NET.      3600000      A     202.12.27.33"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
literal|"M.ROOT-SERVERS.NET.      3600000      AAAA  2001:DC3::35"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|global_dns_root
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Read a hints file as root  *  * The file with the given path should contain a list of NS RRs  * for the root zone and A records for those NS RRs.  * Read them, check them, and append the a records to the rr list given.  */
end_comment

begin_function
name|ldns_rr_list
modifier|*
name|read_root_hints
parameter_list|(
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
init|=
name|NULL
decl_stmt|;
name|int
name|line_nr
init|=
literal|0
decl_stmt|;
name|ldns_zone
modifier|*
name|z
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|ldns_rr_list
modifier|*
name|addresses
init|=
name|NULL
decl_stmt|;
name|ldns_rr
modifier|*
name|rr
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to open %s for reading: %s\n"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|status
operator|=
name|ldns_zone_new_frm_fp_l
argument_list|(
operator|&
name|z
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|line_nr
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading root hints file: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
name|addresses
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/*if ((address_family == 0 || address_family == 1)&& 			*/
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_A
condition|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|addresses
argument_list|,
name|ldns_rr_clone
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/*if ((address_family == 0 || address_family == 2)&&*/
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_AAAA
condition|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|addresses
argument_list|,
name|ldns_rr_clone
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ldns_zone_deep_free
argument_list|(
name|z
argument_list|)
expr_stmt|;
return|return
name|addresses
return|;
block|}
block|}
end_function

begin_function
name|void
name|clear_root
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|global_dns_root
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


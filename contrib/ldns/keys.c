begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * keys.c handle private keys for use in DNSSEC  *  * This module should hide some of the openSSL complexities  * and give a general interface for private keys and hmac  * handling  *  * (c) NLnet Labs, 2004-2006  *  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_decl_stmt
name|ldns_lookup_table
name|ldns_signing_algorithms
index|[]
init|=
block|{
block|{
name|LDNS_SIGN_RSAMD5
block|,
literal|"RSAMD5"
block|}
block|,
block|{
name|LDNS_SIGN_RSASHA1
block|,
literal|"RSASHA1"
block|}
block|,
block|{
name|LDNS_SIGN_RSASHA1_NSEC3
block|,
literal|"RSASHA1-NSEC3-SHA1"
block|}
block|,
ifdef|#
directive|ifdef
name|USE_SHA2
block|{
name|LDNS_SIGN_RSASHA256
block|,
literal|"RSASHA256"
block|}
block|,
block|{
name|LDNS_SIGN_RSASHA512
block|,
literal|"RSASHA512"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_GOST
block|{
name|LDNS_SIGN_ECC_GOST
block|,
literal|"ECC-GOST"
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_ECDSA
block|{
name|LDNS_SIGN_ECDSAP256SHA256
block|,
literal|"ECDSAP256SHA256"
block|}
block|,
block|{
name|LDNS_SIGN_ECDSAP384SHA384
block|,
literal|"ECDSAP384SHA384"
block|}
block|,
endif|#
directive|endif
block|{
name|LDNS_SIGN_DSA
block|,
literal|"DSA"
block|}
block|,
block|{
name|LDNS_SIGN_DSA_NSEC3
block|,
literal|"DSA-NSEC3-SHA1"
block|}
block|,
block|{
name|LDNS_SIGN_HMACMD5
block|,
literal|"hmac-md5.sig-alg.reg.int"
block|}
block|,
block|{
name|LDNS_SIGN_HMACSHA1
block|,
literal|"hmac-sha1"
block|}
block|,
block|{
name|LDNS_SIGN_HMACSHA256
block|,
literal|"hmac-sha256"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|ldns_key_list
modifier|*
name|ldns_key_list_new
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_key_list
modifier|*
name|key_list
init|=
name|LDNS_MALLOC
argument_list|(
name|ldns_key_list
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|key_list
condition|)
block|{
return|return
name|NULL
return|;
block|}
else|else
block|{
name|key_list
operator|->
name|_key_count
operator|=
literal|0
expr_stmt|;
name|key_list
operator|->
name|_keys
operator|=
name|NULL
expr_stmt|;
return|return
name|key_list
return|;
block|}
block|}
end_function

begin_function
name|ldns_key
modifier|*
name|ldns_key_new
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_key
modifier|*
name|newkey
decl_stmt|;
name|newkey
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newkey
condition|)
block|{
return|return
name|NULL
return|;
block|}
else|else
block|{
comment|/* some defaults - not sure wether to do this */
name|ldns_key_set_use
argument_list|(
name|newkey
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ldns_key_set_flags
argument_list|(
name|newkey
argument_list|,
name|LDNS_KEY_ZONE_KEY
argument_list|)
expr_stmt|;
name|ldns_key_set_origttl
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_key_set_keytag
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_key_set_inception
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_key_set_expiration
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_key_set_pubkey_owner
argument_list|(
name|newkey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|ldns_key_set_evp_key
argument_list|(
name|newkey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL */
name|ldns_key_set_hmac_key
argument_list|(
name|newkey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_key_set_external_key
argument_list|(
name|newkey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|newkey
return|;
block|}
block|}
end_function

begin_function
name|ldns_status
name|ldns_key_new_frm_fp
parameter_list|(
name|ldns_key
modifier|*
modifier|*
name|k
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
return|return
name|ldns_key_new_frm_fp_l
argument_list|(
name|k
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
name|ldns_status
name|ldns_key_new_frm_engine
parameter_list|(
name|ldns_key
modifier|*
modifier|*
name|key
parameter_list|,
name|ENGINE
modifier|*
name|e
parameter_list|,
name|char
modifier|*
name|key_id
parameter_list|,
name|ldns_algorithm
name|alg
parameter_list|)
block|{
name|ldns_key
modifier|*
name|k
decl_stmt|;
name|k
operator|=
name|ldns_key_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|k
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|k
operator|->
name|_key
operator|.
name|key
operator|=
name|ENGINE_load_private_key
argument_list|(
name|e
argument_list|,
name|key_id
argument_list|,
name|UI_OpenSSL
argument_list|()
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|k
operator|->
name|_key
operator|.
name|key
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|ldns_key_set_algorithm
argument_list|(
name|k
argument_list|,
operator|(
name|ldns_signing_algorithm
operator|)
name|alg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|k
operator|->
name|_key
operator|.
name|key
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_ENGINE_KEY_NOT_LOADED
return|;
block|}
endif|#
directive|endif
comment|/* splint */
operator|*
name|key
operator|=
name|k
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|USE_GOST
end_ifdef

begin_comment
comment|/** store GOST engine reference loaded into OpenSSL library */
end_comment

begin_decl_stmt
name|ENGINE
modifier|*
name|ldns_gost_engine
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ldns_key_EVP_load_gost_id
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|int
name|gost_id
init|=
literal|0
decl_stmt|;
specifier|const
name|EVP_PKEY_ASN1_METHOD
modifier|*
name|meth
decl_stmt|;
name|ENGINE
modifier|*
name|e
decl_stmt|;
if|if
condition|(
name|gost_id
condition|)
return|return
name|gost_id
return|;
comment|/* see if configuration loaded gost implementation from other engine*/
name|meth
operator|=
name|EVP_PKEY_asn1_find_str
argument_list|(
name|NULL
argument_list|,
literal|"gost2001"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|meth
condition|)
block|{
name|EVP_PKEY_asn1_get0_info
argument_list|(
operator|&
name|gost_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|meth
argument_list|)
expr_stmt|;
return|return
name|gost_id
return|;
block|}
comment|/* see if engine can be loaded already */
name|e
operator|=
name|ENGINE_by_id
argument_list|(
literal|"gost"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|e
condition|)
block|{
comment|/* load it ourself, in case statically linked */
name|ENGINE_load_builtin_engines
argument_list|()
expr_stmt|;
name|ENGINE_load_dynamic
argument_list|()
expr_stmt|;
name|e
operator|=
name|ENGINE_by_id
argument_list|(
literal|"gost"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|e
condition|)
block|{
comment|/* no gost engine in openssl */
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|ENGINE_set_default
argument_list|(
name|e
argument_list|,
name|ENGINE_METHOD_ALL
argument_list|)
condition|)
block|{
name|ENGINE_finish
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|e
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|meth
operator|=
name|EVP_PKEY_asn1_find_str
argument_list|(
operator|&
name|e
argument_list|,
literal|"gost2001"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|meth
condition|)
block|{
comment|/* algo not found */
name|ENGINE_finish
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|e
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Note: do not ENGINE_finish and ENGINE_free the acquired engine          * on some platforms this frees up the meth and unloads gost stuff */
name|ldns_gost_engine
operator|=
name|e
expr_stmt|;
name|EVP_PKEY_asn1_get0_info
argument_list|(
operator|&
name|gost_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|meth
argument_list|)
expr_stmt|;
return|return
name|gost_id
return|;
block|}
end_function

begin_function
name|void
name|ldns_key_EVP_unload_gost
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|ldns_gost_engine
condition|)
block|{
name|ENGINE_finish
argument_list|(
name|ldns_gost_engine
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|ldns_gost_engine
argument_list|)
expr_stmt|;
name|ldns_gost_engine
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/** read GOST private key */
end_comment

begin_function
specifier|static
name|EVP_PKEY
modifier|*
name|ldns_key_new_frm_fp_gost_l
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
modifier|*
name|line_nr
parameter_list|)
block|{
name|char
name|token
index|[
literal|16384
index|]
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|pp
decl_stmt|;
name|int
name|gost_id
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pkey
decl_stmt|;
name|ldns_rdf
modifier|*
name|b64rdf
init|=
name|NULL
decl_stmt|;
name|gost_id
operator|=
name|ldns_key_EVP_load_gost_id
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|gost_id
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|fp
argument_list|,
literal|"GostAsn1"
argument_list|,
literal|": "
argument_list|,
name|token
argument_list|,
literal|"\n"
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|NULL
return|;
while|while
condition|(
name|strlen
argument_list|(
name|token
argument_list|)
operator|<
literal|96
condition|)
block|{
comment|/* read more b64 from the file, b64 split on multiple lines */
if|if
condition|(
name|ldns_fget_token_l
argument_list|(
name|fp
argument_list|,
name|token
operator|+
name|strlen
argument_list|(
name|token
argument_list|)
argument_list|,
literal|"\n"
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
operator|-
name|strlen
argument_list|(
name|token
argument_list|)
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ldns_str2rdf_b64
argument_list|(
operator|&
name|b64rdf
argument_list|,
name|token
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
return|return
name|NULL
return|;
name|pp
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_rdf_data
argument_list|(
name|b64rdf
argument_list|)
expr_stmt|;
name|pkey
operator|=
name|d2i_PrivateKey
argument_list|(
name|gost_id
argument_list|,
name|NULL
argument_list|,
operator|&
name|pp
argument_list|,
operator|(
name|int
operator|)
name|ldns_rdf_size
argument_list|(
name|b64rdf
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|b64rdf
argument_list|)
expr_stmt|;
return|return
name|pkey
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|USE_ECDSA
end_ifdef

begin_comment
comment|/** calculate public key from private key */
end_comment

begin_function
specifier|static
name|int
name|ldns_EC_KEY_calc_public
parameter_list|(
name|EC_KEY
modifier|*
name|ec
parameter_list|)
block|{
name|EC_POINT
modifier|*
name|pub_key
decl_stmt|;
specifier|const
name|EC_GROUP
modifier|*
name|group
decl_stmt|;
name|group
operator|=
name|EC_KEY_get0_group
argument_list|(
name|ec
argument_list|)
expr_stmt|;
name|pub_key
operator|=
name|EC_POINT_new
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pub_key
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|EC_POINT_copy
argument_list|(
name|pub_key
argument_list|,
name|EC_GROUP_get0_generator
argument_list|(
name|group
argument_list|)
argument_list|)
condition|)
block|{
name|EC_POINT_free
argument_list|(
name|pub_key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|EC_POINT_mul
argument_list|(
name|group
argument_list|,
name|pub_key
argument_list|,
name|EC_KEY_get0_private_key
argument_list|(
name|ec
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|EC_POINT_free
argument_list|(
name|pub_key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|EC_KEY_set_public_key
argument_list|(
name|ec
argument_list|,
name|pub_key
argument_list|)
operator|==
literal|0
condition|)
block|{
name|EC_POINT_free
argument_list|(
name|pub_key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|EC_POINT_free
argument_list|(
name|pub_key
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/** read ECDSA private key */
end_comment

begin_function
specifier|static
name|EVP_PKEY
modifier|*
name|ldns_key_new_frm_fp_ecdsa_l
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|ldns_algorithm
name|alg
parameter_list|,
name|int
modifier|*
name|line_nr
parameter_list|)
block|{
name|char
name|token
index|[
literal|16384
index|]
decl_stmt|;
name|ldns_rdf
modifier|*
name|b64rdf
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pp
decl_stmt|;
name|BIGNUM
modifier|*
name|bn
decl_stmt|;
name|EVP_PKEY
modifier|*
name|evp_key
decl_stmt|;
name|EC_KEY
modifier|*
name|ec
decl_stmt|;
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|fp
argument_list|,
literal|"PrivateKey"
argument_list|,
literal|": "
argument_list|,
name|token
argument_list|,
literal|"\n"
argument_list|,
sizeof|sizeof
argument_list|(
name|token
argument_list|)
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ldns_str2rdf_b64
argument_list|(
operator|&
name|b64rdf
argument_list|,
name|token
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
return|return
name|NULL
return|;
name|pp
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_rdf_data
argument_list|(
name|b64rdf
argument_list|)
expr_stmt|;
if|if
condition|(
name|alg
operator|==
name|LDNS_ECDSAP256SHA256
condition|)
name|ec
operator|=
name|EC_KEY_new_by_curve_name
argument_list|(
name|NID_X9_62_prime256v1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|alg
operator|==
name|LDNS_ECDSAP384SHA384
condition|)
name|ec
operator|=
name|EC_KEY_new_by_curve_name
argument_list|(
name|NID_secp384r1
argument_list|)
expr_stmt|;
else|else
name|ec
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ec
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|b64rdf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bn
operator|=
name|BN_bin2bn
argument_list|(
name|pp
argument_list|,
operator|(
name|int
operator|)
name|ldns_rdf_size
argument_list|(
name|b64rdf
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|b64rdf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bn
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|EC_KEY_set_private_key
argument_list|(
name|ec
argument_list|,
name|bn
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|bn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ldns_EC_KEY_calc_public
argument_list|(
name|ec
argument_list|)
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|evp_key
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|evp_key
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|EVP_PKEY_assign_EC_KEY
argument_list|(
name|evp_key
argument_list|,
name|ec
argument_list|)
condition|)
block|{
name|EVP_PKEY_free
argument_list|(
name|evp_key
argument_list|)
expr_stmt|;
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|evp_key
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|ldns_status
name|ldns_key_new_frm_fp_l
parameter_list|(
name|ldns_key
modifier|*
modifier|*
name|key
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
modifier|*
name|line_nr
parameter_list|)
block|{
name|ldns_key
modifier|*
name|k
decl_stmt|;
name|char
modifier|*
name|d
decl_stmt|;
name|ldns_signing_algorithm
name|alg
decl_stmt|;
name|ldns_rr
modifier|*
name|key_rr
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|RSA
modifier|*
name|rsa
decl_stmt|;
name|DSA
modifier|*
name|dsa
decl_stmt|;
name|unsigned
name|char
modifier|*
name|hmac
decl_stmt|;
name|size_t
name|hmac_size
decl_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL */
name|k
operator|=
name|ldns_key_new
argument_list|()
expr_stmt|;
name|d
operator|=
name|LDNS_XMALLOC
argument_list|(
name|char
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|k
operator|||
operator|!
name|d
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|alg
operator|=
literal|0
expr_stmt|;
comment|/* the file is highly structured. Do this in sequence */
comment|/* RSA: 	 * Private-key-format: v1.x.  	 * Algorithm: 1 (RSA)  	 */
comment|/* get the key format version number */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|fp
argument_list|,
literal|"Private-key-format"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* no version information */
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_SYNTAX_ERR
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"v1."
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_SYNTAX_VERSION_ERR
return|;
block|}
comment|/* get the algorithm type, our file function strip ( ) so there are 	 * not in the return string! */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|fp
argument_list|,
literal|"Algorithm"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* no alg information */
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_SYNTAX_ALG_ERR
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"1 RSA"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
name|LDNS_SIGN_RSAMD5
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"2 DH"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
operator|(
name|ldns_signing_algorithm
operator|)
name|LDNS_DH
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"3 DSA"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
name|LDNS_SIGN_DSA
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"4 ECC"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
operator|(
name|ldns_signing_algorithm
operator|)
name|LDNS_ECC
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"5 RSASHA1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
name|LDNS_SIGN_RSASHA1
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"6 DSA"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
name|LDNS_SIGN_DSA_NSEC3
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"7 RSASHA1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
name|LDNS_SIGN_RSASHA1_NSEC3
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"8 RSASHA256"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_SHA2
name|alg
operator|=
name|LDNS_SIGN_RSASHA256
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: SHA256 not compiled into this "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"version of ldns\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"10 RSASHA512"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_SHA2
name|alg
operator|=
name|LDNS_SIGN_RSASHA512
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: SHA512 not compiled into this "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"version of ldns\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"12 ECC-GOST"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_GOST
name|alg
operator|=
name|LDNS_SIGN_ECC_GOST
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: ECC-GOST not compiled into this "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"version of ldns, use --enable-gost\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"13 ECDSAP256SHA256"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_ECDSA
name|alg
operator|=
name|LDNS_SIGN_ECDSAP256SHA256
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: ECDSA not compiled into this "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"version of ldns, use --enable-ecdsa\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"14 ECDSAP384SHA384"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|USE_ECDSA
name|alg
operator|=
name|LDNS_SIGN_ECDSAP384SHA384
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: ECDSA not compiled into this "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"version of ldns, use --enable-ecdsa\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"157 HMAC-MD5"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
name|LDNS_SIGN_HMACMD5
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"158 HMAC-SHA1"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
name|LDNS_SIGN_HMACSHA1
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|d
argument_list|,
literal|"159 HMAC-SHA256"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|alg
operator|=
name|LDNS_SIGN_HMACSHA256
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|alg
condition|)
block|{
case|case
name|LDNS_SIGN_RSAMD5
case|:
case|case
name|LDNS_SIGN_RSASHA1
case|:
case|case
name|LDNS_SIGN_RSASHA1_NSEC3
case|:
ifdef|#
directive|ifdef
name|USE_SHA2
case|case
name|LDNS_SIGN_RSASHA256
case|:
case|case
name|LDNS_SIGN_RSASHA512
case|:
endif|#
directive|endif
name|ldns_key_set_algorithm
argument_list|(
name|k
argument_list|,
name|alg
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|rsa
operator|=
name|ldns_key_new_frm_fp_rsa_l
argument_list|(
name|fp
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|ldns_key_set_rsa_key
argument_list|(
name|k
argument_list|,
name|rsa
argument_list|)
expr_stmt|;
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL */
break|break;
case|case
name|LDNS_SIGN_DSA
case|:
case|case
name|LDNS_SIGN_DSA_NSEC3
case|:
name|ldns_key_set_algorithm
argument_list|(
name|k
argument_list|,
name|alg
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|dsa
operator|=
name|ldns_key_new_frm_fp_dsa_l
argument_list|(
name|fp
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|ldns_key_set_dsa_key
argument_list|(
name|k
argument_list|,
name|dsa
argument_list|)
expr_stmt|;
name|DSA_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL */
break|break;
case|case
name|LDNS_SIGN_HMACMD5
case|:
case|case
name|LDNS_SIGN_HMACSHA1
case|:
case|case
name|LDNS_SIGN_HMACSHA256
case|:
name|ldns_key_set_algorithm
argument_list|(
name|k
argument_list|,
name|alg
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|hmac
operator|=
name|ldns_key_new_frm_fp_hmac_l
argument_list|(
name|fp
argument_list|,
name|line_nr
argument_list|,
operator|&
name|hmac_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hmac
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|ldns_key_set_hmac_size
argument_list|(
name|k
argument_list|,
name|hmac_size
argument_list|)
expr_stmt|;
name|ldns_key_set_hmac_key
argument_list|(
name|k
argument_list|,
name|hmac
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL */
break|break;
case|case
name|LDNS_SIGN_ECC_GOST
case|:
name|ldns_key_set_algorithm
argument_list|(
name|k
argument_list|,
name|alg
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SSL
argument_list|)
operator|&&
name|defined
argument_list|(
name|USE_GOST
argument_list|)
if|if
condition|(
operator|!
name|ldns_key_EVP_load_gost_id
argument_list|()
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_CRYPTO_ALGO_NOT_IMPL
return|;
block|}
name|ldns_key_set_evp_key
argument_list|(
name|k
argument_list|,
name|ldns_key_new_frm_fp_gost_l
argument_list|(
name|fp
argument_list|,
name|line_nr
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|S_SPLINT_S
if|if
condition|(
operator|!
name|k
operator|->
name|_key
operator|.
name|key
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_ERR
return|;
block|}
endif|#
directive|endif
comment|/* splint */
endif|#
directive|endif
break|break;
ifdef|#
directive|ifdef
name|USE_ECDSA
case|case
name|LDNS_SIGN_ECDSAP256SHA256
case|:
case|case
name|LDNS_SIGN_ECDSAP384SHA384
case|:
name|ldns_key_set_algorithm
argument_list|(
name|k
argument_list|,
name|alg
argument_list|)
expr_stmt|;
name|ldns_key_set_evp_key
argument_list|(
name|k
argument_list|,
name|ldns_key_new_frm_fp_ecdsa_l
argument_list|(
name|fp
argument_list|,
operator|(
name|ldns_algorithm
operator|)
name|alg
argument_list|,
name|line_nr
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|S_SPLINT_S
if|if
condition|(
operator|!
name|k
operator|->
name|_key
operator|.
name|key
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_ERR
return|;
block|}
endif|#
directive|endif
comment|/* splint */
break|break;
endif|#
directive|endif
default|default:
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_SYNTAX_ALG_ERR
return|;
block|}
name|key_rr
operator|=
name|ldns_key2rr
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|ldns_key_set_keytag
argument_list|(
name|k
argument_list|,
name|ldns_calc_keytag
argument_list|(
name|key_rr
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|key_rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
operator|*
name|key
operator|=
name|k
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
return|return
name|LDNS_STATUS_ERR
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
name|RSA
modifier|*
name|ldns_key_new_frm_fp_rsa
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|)
block|{
return|return
name|ldns_key_new_frm_fp_rsa_l
argument_list|(
name|f
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|RSA
modifier|*
name|ldns_key_new_frm_fp_rsa_l
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|int
modifier|*
name|line_nr
parameter_list|)
block|{
comment|/* we parse  	 * Modulus:  	 * PublicExponent:  	 * PrivateExponent:  	 * Prime1:  	 * Prime2:  	 * Exponent1:  	 * Exponent2:  	 * Coefficient: 	 * 	 * man 3 RSA: 	 * 	 * struct          *     {          *     BIGNUM *n;              // public modulus          *     BIGNUM *e;              // public exponent          *     BIGNUM *d;              // private exponent          *     BIGNUM *p;              // secret prime factor          *     BIGNUM *q;              // secret prime factor          *     BIGNUM *dmp1;           // d mod (p-1)          *     BIGNUM *dmq1;           // d mod (q-1)          *     BIGNUM *iqmp;           // q^-1 mod p          *     // ... 	 * 	 */
name|char
modifier|*
name|d
decl_stmt|;
name|RSA
modifier|*
name|rsa
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|d
operator|=
name|LDNS_XMALLOC
argument_list|(
name|char
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|)
expr_stmt|;
name|buf
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|)
expr_stmt|;
name|rsa
operator|=
name|RSA_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|d
operator|||
operator|!
name|rsa
operator|||
operator|!
name|buf
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* I could use functions again, but that seems an overkill, 	 * allthough this also looks tedious 	 */
comment|/* Modules, rsa->n */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Modulus"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|rsa
operator|->
name|n
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
operator|->
name|n
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* PublicExponent, rsa->e */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"PublicExponent"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|e
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
operator|->
name|e
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* PrivateExponent, rsa->d */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"PrivateExponent"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|d
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
operator|->
name|d
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* Prime1, rsa->p */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Prime1"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|p
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
operator|->
name|p
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* Prime2, rsa->q */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Prime2"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|q
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
operator|->
name|q
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* Exponent1, rsa->dmp1 */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Exponent1"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|dmp1
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
operator|->
name|dmp1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* Exponent2, rsa->dmq1 */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Exponent2"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|dmq1
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
operator|->
name|dmq1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* Coefficient, rsa->iqmp */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Coefficient"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|iqmp
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa
operator|->
name|iqmp
condition|)
block|{
goto|goto
name|error
goto|;
block|}
endif|#
directive|endif
comment|/* splint */
name|LDNS_FREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
return|return
name|rsa
return|;
name|error
label|:
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|DSA
modifier|*
name|ldns_key_new_frm_fp_dsa
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|)
block|{
return|return
name|ldns_key_new_frm_fp_dsa_l
argument_list|(
name|f
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
name|DSA
modifier|*
name|ldns_key_new_frm_fp_dsa_l
argument_list|(
name|FILE
operator|*
name|f
argument_list|,
name|ATTR_UNUSED
argument_list|(
name|int
operator|*
name|line_nr
argument_list|)
argument_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|d
decl_stmt|;
name|DSA
modifier|*
name|dsa
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|d
operator|=
name|LDNS_XMALLOC
argument_list|(
name|char
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|)
expr_stmt|;
name|buf
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|)
expr_stmt|;
name|dsa
operator|=
name|DSA_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|d
operator|||
operator|!
name|dsa
operator|||
operator|!
name|buf
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* the line parser removes the () from the input... */
comment|/* Prime, dsa->p */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Primep"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|dsa
operator|->
name|p
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
operator|->
name|p
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* Subprime, dsa->q */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Subprimeq"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|dsa
operator|->
name|q
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
operator|->
name|q
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* Base, dsa->g */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Baseg"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|dsa
operator|->
name|g
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
operator|->
name|g
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* Private key, dsa->priv_key */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Private_valuex"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|dsa
operator|->
name|priv_key
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
operator|->
name|priv_key
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* Public key, dsa->priv_key */
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Public_valuey"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|dsa
operator|->
name|pub_key
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|char
name|unsigned
operator|*
operator|)
name|buf
argument_list|,
name|i
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
operator|->
name|pub_key
condition|)
block|{
goto|goto
name|error
goto|;
block|}
endif|#
directive|endif
comment|/* splint */
name|LDNS_FREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
return|return
name|dsa
return|;
name|error
label|:
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|DSA_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_decl_stmt

begin_function
name|unsigned
name|char
modifier|*
name|ldns_key_new_frm_fp_hmac
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|size_t
modifier|*
name|hmac_size
parameter_list|)
block|{
return|return
name|ldns_key_new_frm_fp_hmac_l
argument_list|(
name|f
argument_list|,
name|NULL
argument_list|,
name|hmac_size
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|ldns_key_new_frm_fp_hmac_l
argument_list|(
name|FILE
operator|*
name|f
argument_list|,
name|ATTR_UNUSED
argument_list|(
name|int
operator|*
name|line_nr
argument_list|)
argument_list|,
name|size_t
operator|*
name|hmac_size
argument_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|char
modifier|*
name|d
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|d
operator|=
name|LDNS_XMALLOC
argument_list|(
name|char
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|)
expr_stmt|;
name|buf
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|LDNS_MAX_LINELEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|d
operator|||
operator|!
name|buf
condition|)
block|{
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|ldns_fget_keyword_data_l
argument_list|(
name|f
argument_list|,
literal|"Key"
argument_list|,
literal|": "
argument_list|,
name|d
argument_list|,
literal|"\n"
argument_list|,
name|LDNS_MAX_LINELEN
argument_list|,
name|line_nr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
goto|goto
name|error
goto|;
block|}
name|i
operator|=
operator|(
name|size_t
operator|)
name|ldns_b64_pton
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|d
argument_list|,
name|buf
argument_list|,
name|ldns_b64_ntop_calculate_size
argument_list|(
name|strlen
argument_list|(
name|d
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|hmac_size
operator|=
name|i
expr_stmt|;
return|return
name|buf
return|;
name|error
label|:
name|LDNS_FREE
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
operator|*
name|hmac_size
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|USE_GOST
end_ifdef

begin_function
specifier|static
name|EVP_PKEY
modifier|*
name|ldns_gen_gost_key
parameter_list|(
name|void
parameter_list|)
block|{
name|EVP_PKEY_CTX
modifier|*
name|ctx
decl_stmt|;
name|EVP_PKEY
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|int
name|gost_id
init|=
name|ldns_key_EVP_load_gost_id
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|gost_id
condition|)
return|return
name|NULL
return|;
name|ctx
operator|=
name|EVP_PKEY_CTX_new_id
argument_list|(
name|gost_id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
condition|)
block|{
comment|/* the id should be available now */
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|EVP_PKEY_CTX_ctrl_str
argument_list|(
name|ctx
argument_list|,
literal|"paramset"
argument_list|,
literal|"A"
argument_list|)
operator|<=
literal|0
condition|)
block|{
comment|/* cannot set paramset */
name|EVP_PKEY_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|EVP_PKEY_keygen_init
argument_list|(
name|ctx
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|EVP_PKEY_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|EVP_PKEY_keygen
argument_list|(
name|ctx
argument_list|,
operator|&
name|p
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|EVP_PKEY_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|EVP_PKEY_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|EVP_PKEY_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|ldns_key
modifier|*
name|ldns_key_new_frm_algorithm
parameter_list|(
name|ldns_signing_algorithm
name|alg
parameter_list|,
name|uint16_t
name|size
parameter_list|)
block|{
name|ldns_key
modifier|*
name|k
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|DSA
modifier|*
name|d
decl_stmt|;
name|RSA
modifier|*
name|r
decl_stmt|;
ifdef|#
directive|ifdef
name|USE_ECDSA
name|EC_KEY
modifier|*
name|ec
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
else|#
directive|else
name|int
name|i
decl_stmt|;
name|uint16_t
name|offset
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|unsigned
name|char
modifier|*
name|hmac
decl_stmt|;
name|k
operator|=
name|ldns_key_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|k
condition|)
block|{
return|return
name|NULL
return|;
block|}
switch|switch
condition|(
name|alg
condition|)
block|{
case|case
name|LDNS_SIGN_RSAMD5
case|:
case|case
name|LDNS_SIGN_RSASHA1
case|:
case|case
name|LDNS_SIGN_RSASHA1_NSEC3
case|:
case|case
name|LDNS_SIGN_RSASHA256
case|:
case|case
name|LDNS_SIGN_RSASHA512
case|:
ifdef|#
directive|ifdef
name|HAVE_SSL
name|r
operator|=
name|RSA_generate_key
argument_list|(
operator|(
name|int
operator|)
name|size
argument_list|,
name|RSA_F4
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|RSA_check_key
argument_list|(
name|r
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ldns_key_set_rsa_key
argument_list|(
name|k
argument_list|,
name|r
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL */
break|break;
case|case
name|LDNS_SIGN_DSA
case|:
case|case
name|LDNS_SIGN_DSA_NSEC3
case|:
ifdef|#
directive|ifdef
name|HAVE_SSL
name|d
operator|=
name|DSA_generate_parameters
argument_list|(
operator|(
name|int
operator|)
name|size
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|d
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|DSA_generate_key
argument_list|(
name|d
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ldns_key_set_dsa_key
argument_list|(
name|k
argument_list|,
name|d
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL */
break|break;
case|case
name|LDNS_SIGN_HMACMD5
case|:
case|case
name|LDNS_SIGN_HMACSHA1
case|:
case|case
name|LDNS_SIGN_HMACSHA256
case|:
ifdef|#
directive|ifdef
name|HAVE_SSL
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|k
operator|->
name|_key
operator|.
name|key
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* splint */
endif|#
directive|endif
comment|/* HAVE_SSL */
name|size
operator|=
name|size
operator|/
literal|8
expr_stmt|;
name|ldns_key_set_hmac_size
argument_list|(
name|k
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|hmac
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hmac
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|HAVE_SSL
if|if
condition|(
name|RAND_bytes
argument_list|(
name|hmac
argument_list|,
operator|(
name|int
operator|)
name|size
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|hmac
argument_list|)
expr_stmt|;
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|#
directive|else
while|while
condition|(
name|offset
operator|+
sizeof|sizeof
argument_list|(
name|i
argument_list|)
operator|<
name|size
condition|)
block|{
name|i
operator|=
name|random
argument_list|()
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|hmac
index|[
name|offset
index|]
argument_list|,
operator|&
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|offset
operator|<
name|size
condition|)
block|{
name|i
operator|=
name|random
argument_list|()
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|hmac
index|[
name|offset
index|]
argument_list|,
operator|&
name|i
argument_list|,
name|size
operator|-
name|offset
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* HAVE_SSL */
name|ldns_key_set_hmac_key
argument_list|(
name|k
argument_list|,
name|hmac
argument_list|)
expr_stmt|;
name|ldns_key_set_flags
argument_list|(
name|k
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDNS_SIGN_ECC_GOST
case|:
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SSL
argument_list|)
operator|&&
name|defined
argument_list|(
name|USE_GOST
argument_list|)
name|ldns_key_set_evp_key
argument_list|(
name|k
argument_list|,
name|ldns_gen_gost_key
argument_list|()
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|S_SPLINT_S
if|if
condition|(
operator|!
name|k
operator|->
name|_key
operator|.
name|key
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
endif|#
directive|endif
comment|/* splint */
else|#
directive|else
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
endif|#
directive|endif
comment|/* HAVE_SSL and USE_GOST */
break|break;
case|case
name|LDNS_SIGN_ECDSAP256SHA256
case|:
case|case
name|LDNS_SIGN_ECDSAP384SHA384
case|:
ifdef|#
directive|ifdef
name|USE_ECDSA
if|if
condition|(
name|alg
operator|==
name|LDNS_SIGN_ECDSAP256SHA256
condition|)
name|ec
operator|=
name|EC_KEY_new_by_curve_name
argument_list|(
name|NID_X9_62_prime256v1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|alg
operator|==
name|LDNS_SIGN_ECDSAP384SHA384
condition|)
name|ec
operator|=
name|EC_KEY_new_by_curve_name
argument_list|(
name|NID_secp384r1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ec
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|EC_KEY_generate_key
argument_list|(
name|ec
argument_list|)
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|k
operator|->
name|_key
operator|.
name|key
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|k
operator|->
name|_key
operator|.
name|key
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|EVP_PKEY_assign_EC_KEY
argument_list|(
name|k
operator|->
name|_key
operator|.
name|key
argument_list|,
name|ec
argument_list|)
condition|)
block|{
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
endif|#
directive|endif
comment|/* splint */
else|#
directive|else
name|ldns_key_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
endif|#
directive|endif
comment|/* ECDSA */
break|break;
block|}
name|ldns_key_set_algorithm
argument_list|(
name|k
argument_list|,
name|alg
argument_list|)
expr_stmt|;
return|return
name|k
return|;
block|}
end_function

begin_function
name|void
name|ldns_key_print
parameter_list|(
name|FILE
modifier|*
name|output
parameter_list|,
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|ldns_key2str
argument_list|(
name|k
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
condition|)
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"%s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"Unable to convert private key to string\n"
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_algorithm
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|ldns_signing_algorithm
name|l
parameter_list|)
block|{
name|k
operator|->
name|_alg
operator|=
name|l
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_flags
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|uint16_t
name|f
parameter_list|)
block|{
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|flags
operator|=
name|f
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|S_SPLINT_S
end_ifndef

begin_function
name|void
name|ldns_key_set_evp_key
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|EVP_PKEY
modifier|*
name|e
parameter_list|)
block|{
name|k
operator|->
name|_key
operator|.
name|key
operator|=
name|e
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_rsa_key
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|RSA
modifier|*
name|r
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|key
init|=
name|EVP_PKEY_new
argument_list|()
decl_stmt|;
name|EVP_PKEY_set1_RSA
argument_list|(
name|key
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|k
operator|->
name|_key
operator|.
name|key
operator|=
name|key
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_dsa_key
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|DSA
modifier|*
name|d
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|key
init|=
name|EVP_PKEY_new
argument_list|()
decl_stmt|;
name|EVP_PKEY_set1_DSA
argument_list|(
name|key
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|k
operator|->
name|_key
operator|.
name|key
operator|=
name|key
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* splint */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_function
name|void
name|ldns_key_set_hmac_key
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|unsigned
name|char
modifier|*
name|hmac
parameter_list|)
block|{
name|k
operator|->
name|_key
operator|.
name|hmac
operator|.
name|key
operator|=
name|hmac
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_hmac_size
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|size_t
name|hmac_size
parameter_list|)
block|{
name|k
operator|->
name|_key
operator|.
name|hmac
operator|.
name|size
operator|=
name|hmac_size
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_external_key
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|void
modifier|*
name|external_key
parameter_list|)
block|{
name|k
operator|->
name|_key
operator|.
name|external_key
operator|=
name|external_key
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_origttl
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|uint32_t
name|t
parameter_list|)
block|{
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|orig_ttl
operator|=
name|t
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_inception
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|uint32_t
name|i
parameter_list|)
block|{
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|inception
operator|=
name|i
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_expiration
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|uint32_t
name|e
parameter_list|)
block|{
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|expiration
operator|=
name|e
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_pubkey_owner
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|ldns_rdf
modifier|*
name|r
parameter_list|)
block|{
name|k
operator|->
name|_pubkey_owner
operator|=
name|r
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_keytag
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|uint16_t
name|tag
parameter_list|)
block|{
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|keytag
operator|=
name|tag
expr_stmt|;
block|}
end_function

begin_comment
comment|/* read */
end_comment

begin_function
name|size_t
name|ldns_key_list_key_count
parameter_list|(
specifier|const
name|ldns_key_list
modifier|*
name|key_list
parameter_list|)
block|{
return|return
name|key_list
operator|->
name|_key_count
return|;
block|}
end_function

begin_function
name|ldns_key
modifier|*
name|ldns_key_list_key
parameter_list|(
specifier|const
name|ldns_key_list
modifier|*
name|key
parameter_list|,
name|size_t
name|nr
parameter_list|)
block|{
if|if
condition|(
name|nr
operator|<
name|ldns_key_list_key_count
argument_list|(
name|key
argument_list|)
condition|)
block|{
return|return
name|key
operator|->
name|_keys
index|[
name|nr
index|]
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
name|ldns_signing_algorithm
name|ldns_key_algorithm
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
return|return
name|k
operator|->
name|_alg
return|;
block|}
end_function

begin_function
name|void
name|ldns_key_set_use
parameter_list|(
name|ldns_key
modifier|*
name|k
parameter_list|,
name|bool
name|v
parameter_list|)
block|{
if|if
condition|(
name|k
condition|)
block|{
name|k
operator|->
name|_use
operator|=
name|v
expr_stmt|;
block|}
block|}
end_function

begin_function
name|bool
name|ldns_key_use
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
if|if
condition|(
name|k
condition|)
block|{
return|return
name|k
operator|->
name|_use
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|S_SPLINT_S
end_ifndef

begin_function
name|EVP_PKEY
modifier|*
name|ldns_key_evp_key
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
return|return
name|k
operator|->
name|_key
operator|.
name|key
return|;
block|}
end_function

begin_function
name|RSA
modifier|*
name|ldns_key_rsa_key
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
if|if
condition|(
name|k
operator|->
name|_key
operator|.
name|key
condition|)
block|{
return|return
name|EVP_PKEY_get1_RSA
argument_list|(
name|k
operator|->
name|_key
operator|.
name|key
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
name|DSA
modifier|*
name|ldns_key_dsa_key
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
if|if
condition|(
name|k
operator|->
name|_key
operator|.
name|key
condition|)
block|{
return|return
name|EVP_PKEY_get1_DSA
argument_list|(
name|k
operator|->
name|_key
operator|.
name|key
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* splint */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|ldns_key_hmac_key
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
if|if
condition|(
name|k
operator|->
name|_key
operator|.
name|hmac
operator|.
name|key
condition|)
block|{
return|return
name|k
operator|->
name|_key
operator|.
name|hmac
operator|.
name|key
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
name|size_t
name|ldns_key_hmac_size
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
if|if
condition|(
name|k
operator|->
name|_key
operator|.
name|hmac
operator|.
name|size
condition|)
block|{
return|return
name|k
operator|->
name|_key
operator|.
name|hmac
operator|.
name|size
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|void
modifier|*
name|ldns_key_external_key
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
return|return
name|k
operator|->
name|_key
operator|.
name|external_key
return|;
block|}
end_function

begin_function
name|uint32_t
name|ldns_key_origttl
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
return|return
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|orig_ttl
return|;
block|}
end_function

begin_function
name|uint16_t
name|ldns_key_flags
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
return|return
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|flags
return|;
block|}
end_function

begin_function
name|uint32_t
name|ldns_key_inception
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
return|return
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|inception
return|;
block|}
end_function

begin_function
name|uint32_t
name|ldns_key_expiration
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
return|return
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|expiration
return|;
block|}
end_function

begin_function
name|uint16_t
name|ldns_key_keytag
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
return|return
name|k
operator|->
name|_extra
operator|.
name|dnssec
operator|.
name|keytag
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_key_pubkey_owner
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
return|return
name|k
operator|->
name|_pubkey_owner
return|;
block|}
end_function

begin_comment
comment|/* write */
end_comment

begin_function
name|void
name|ldns_key_list_set_use
parameter_list|(
name|ldns_key_list
modifier|*
name|keys
parameter_list|,
name|bool
name|v
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_key_list_key_count
argument_list|(
name|keys
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ldns_key_set_use
argument_list|(
name|ldns_key_list_key
argument_list|(
name|keys
argument_list|,
name|i
argument_list|)
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_key_list_set_key_count
parameter_list|(
name|ldns_key_list
modifier|*
name|key
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|key
operator|->
name|_key_count
operator|=
name|count
expr_stmt|;
block|}
end_function

begin_function
name|bool
name|ldns_key_list_push_key
parameter_list|(
name|ldns_key_list
modifier|*
name|key_list
parameter_list|,
name|ldns_key
modifier|*
name|key
parameter_list|)
block|{
name|size_t
name|key_count
decl_stmt|;
name|ldns_key
modifier|*
modifier|*
name|keys
decl_stmt|;
name|key_count
operator|=
name|ldns_key_list_key_count
argument_list|(
name|key_list
argument_list|)
expr_stmt|;
comment|/* grow the array */
name|keys
operator|=
name|LDNS_XREALLOC
argument_list|(
name|key_list
operator|->
name|_keys
argument_list|,
name|ldns_key
operator|*
argument_list|,
name|key_count
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|keys
condition|)
block|{
return|return
name|false
return|;
block|}
comment|/* add the new member */
name|key_list
operator|->
name|_keys
operator|=
name|keys
expr_stmt|;
name|key_list
operator|->
name|_keys
index|[
name|key_count
index|]
operator|=
name|key
expr_stmt|;
name|ldns_key_list_set_key_count
argument_list|(
name|key_list
argument_list|,
name|key_count
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
name|ldns_key
modifier|*
name|ldns_key_list_pop_key
parameter_list|(
name|ldns_key_list
modifier|*
name|key_list
parameter_list|)
block|{
name|size_t
name|key_count
decl_stmt|;
name|ldns_key
modifier|*
modifier|*
name|a
decl_stmt|;
name|ldns_key
modifier|*
name|pop
decl_stmt|;
if|if
condition|(
operator|!
name|key_list
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|key_count
operator|=
name|ldns_key_list_key_count
argument_list|(
name|key_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|key_count
operator|==
literal|0
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|pop
operator|=
name|ldns_key_list_key
argument_list|(
name|key_list
argument_list|,
name|key_count
argument_list|)
expr_stmt|;
comment|/* shrink the array */
name|a
operator|=
name|LDNS_XREALLOC
argument_list|(
name|key_list
operator|->
name|_keys
argument_list|,
name|ldns_key
operator|*
argument_list|,
name|key_count
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
condition|)
block|{
name|key_list
operator|->
name|_keys
operator|=
name|a
expr_stmt|;
block|}
name|ldns_key_list_set_key_count
argument_list|(
name|key_list
argument_list|,
name|key_count
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
name|pop
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|S_SPLINT_S
end_ifndef

begin_comment
comment|/* data pointer must be large enough (LDNS_MAX_KEYLEN) */
end_comment

begin_function
specifier|static
name|bool
name|ldns_key_rsa2bin
parameter_list|(
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|RSA
modifier|*
name|k
parameter_list|,
name|uint16_t
modifier|*
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
operator|!
name|k
condition|)
block|{
return|return
name|false
return|;
block|}
if|if
condition|(
name|BN_num_bytes
argument_list|(
name|k
operator|->
name|e
argument_list|)
operator|<=
literal|256
condition|)
block|{
comment|/* normally only this path is executed (small factors are 		 * more common  		 */
name|data
index|[
literal|0
index|]
operator|=
operator|(
name|unsigned
name|char
operator|)
name|BN_num_bytes
argument_list|(
name|k
operator|->
name|e
argument_list|)
expr_stmt|;
name|i
operator|=
name|BN_bn2bin
argument_list|(
name|k
operator|->
name|e
argument_list|,
name|data
operator|+
literal|1
argument_list|)
expr_stmt|;
name|j
operator|=
name|BN_bn2bin
argument_list|(
name|k
operator|->
name|n
argument_list|,
name|data
operator|+
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
operator|*
name|size
operator|=
operator|(
name|uint16_t
operator|)
name|i
operator|+
name|j
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|BN_num_bytes
argument_list|(
name|k
operator|->
name|e
argument_list|)
operator|<=
literal|65536
condition|)
block|{
name|data
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* BN_bn2bin does bigendian, _uint16 also */
name|ldns_write_uint16
argument_list|(
name|data
operator|+
literal|1
argument_list|,
operator|(
name|uint16_t
operator|)
name|BN_num_bytes
argument_list|(
name|k
operator|->
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|BN_bn2bin
argument_list|(
name|k
operator|->
name|e
argument_list|,
name|data
operator|+
literal|3
argument_list|)
expr_stmt|;
name|BN_bn2bin
argument_list|(
name|k
operator|->
name|n
argument_list|,
name|data
operator|+
literal|4
operator|+
name|BN_num_bytes
argument_list|(
name|k
operator|->
name|e
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|size
operator|=
operator|(
name|uint16_t
operator|)
name|BN_num_bytes
argument_list|(
name|k
operator|->
name|n
argument_list|)
operator|+
literal|6
expr_stmt|;
block|}
else|else
block|{
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/* data pointer must be large enough (LDNS_MAX_KEYLEN) */
end_comment

begin_function
specifier|static
name|bool
name|ldns_key_dsa2bin
parameter_list|(
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|DSA
modifier|*
name|k
parameter_list|,
name|uint16_t
modifier|*
name|size
parameter_list|)
block|{
name|uint8_t
name|T
decl_stmt|;
if|if
condition|(
operator|!
name|k
condition|)
block|{
return|return
name|false
return|;
block|}
comment|/* See RFC2536 */
operator|*
name|size
operator|=
operator|(
name|uint16_t
operator|)
name|BN_num_bytes
argument_list|(
name|k
operator|->
name|g
argument_list|)
expr_stmt|;
name|T
operator|=
operator|(
operator|*
name|size
operator|-
literal|64
operator|)
operator|/
literal|8
expr_stmt|;
name|memcpy
argument_list|(
name|data
argument_list|,
operator|&
name|T
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|T
operator|>
literal|8
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"DSA key with T> 8 (ie.> 1024 bits)"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" not implemented\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* size = 64 + (T * 8); */
name|data
index|[
literal|0
index|]
operator|=
operator|(
name|unsigned
name|char
operator|)
name|T
expr_stmt|;
name|BN_bn2bin
argument_list|(
name|k
operator|->
name|q
argument_list|,
name|data
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* 20 octects */
name|BN_bn2bin
argument_list|(
name|k
operator|->
name|p
argument_list|,
name|data
operator|+
literal|21
argument_list|)
expr_stmt|;
comment|/* offset octects */
name|BN_bn2bin
argument_list|(
name|k
operator|->
name|g
argument_list|,
name|data
operator|+
literal|21
operator|+
operator|*
name|size
argument_list|)
expr_stmt|;
comment|/* offset octets */
name|BN_bn2bin
argument_list|(
name|k
operator|->
name|pub_key
argument_list|,
name|data
operator|+
literal|21
operator|+
operator|*
name|size
operator|+
operator|*
name|size
argument_list|)
expr_stmt|;
comment|/* offset octets */
operator|*
name|size
operator|=
literal|21
operator|+
operator|(
operator|*
name|size
operator|*
literal|3
operator|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|USE_GOST
end_ifdef

begin_function
specifier|static
name|bool
name|ldns_key_gost2bin
parameter_list|(
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|EVP_PKEY
modifier|*
name|k
parameter_list|,
name|uint16_t
modifier|*
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pp
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|i2d_PUBKEY
argument_list|(
name|k
argument_list|,
operator|&
name|pp
argument_list|)
operator|!=
literal|37
operator|+
literal|64
condition|)
block|{
comment|/* expect 37 byte(ASN header) and 64 byte(X and Y) */
name|CRYPTO_free
argument_list|(
name|pp
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* omit ASN header */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|data
index|[
name|i
index|]
operator|=
name|pp
index|[
name|i
operator|+
literal|37
index|]
expr_stmt|;
name|CRYPTO_free
argument_list|(
name|pp
argument_list|)
expr_stmt|;
operator|*
name|size
operator|=
literal|64
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USE_GOST */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* splint */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_function
name|ldns_rr
modifier|*
name|ldns_key2rr
parameter_list|(
specifier|const
name|ldns_key
modifier|*
name|k
parameter_list|)
block|{
comment|/* this function will convert a the keydata contained in 	 * rsa/dsa pointers to a DNSKEY rr. It will fill in as 	 * much as it can, but it does not know about key-flags 	 * for instance 	 */
name|ldns_rr
modifier|*
name|pubkey
decl_stmt|;
name|ldns_rdf
modifier|*
name|keybin
decl_stmt|;
name|unsigned
name|char
modifier|*
name|bin
init|=
name|NULL
decl_stmt|;
name|uint16_t
name|size
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|RSA
modifier|*
name|rsa
init|=
name|NULL
decl_stmt|;
name|DSA
modifier|*
name|dsa
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
comment|/* HAVE_SSL */
ifdef|#
directive|ifdef
name|USE_ECDSA
name|EC_KEY
modifier|*
name|ec
decl_stmt|;
endif|#
directive|endif
name|int
name|internal_data
init|=
literal|0
decl_stmt|;
name|pubkey
operator|=
name|ldns_rr_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|k
condition|)
block|{
return|return
name|NULL
return|;
block|}
switch|switch
condition|(
name|ldns_key_algorithm
argument_list|(
name|k
argument_list|)
condition|)
block|{
case|case
name|LDNS_SIGN_HMACMD5
case|:
case|case
name|LDNS_SIGN_HMACSHA1
case|:
case|case
name|LDNS_SIGN_HMACSHA256
case|:
name|ldns_rr_set_type
argument_list|(
name|pubkey
argument_list|,
name|LDNS_RR_TYPE_KEY
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ldns_rr_set_type
argument_list|(
name|pubkey
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* zero-th rdf - flags */
name|ldns_rr_push_rdf
argument_list|(
name|pubkey
argument_list|,
name|ldns_native2rdf_int16
argument_list|(
name|LDNS_RDF_TYPE_INT16
argument_list|,
name|ldns_key_flags
argument_list|(
name|k
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* first - proto */
name|ldns_rr_push_rdf
argument_list|(
name|pubkey
argument_list|,
name|ldns_native2rdf_int8
argument_list|(
name|LDNS_RDF_TYPE_INT8
argument_list|,
name|LDNS_DNSSEC_KEYPROTO
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_key_pubkey_owner
argument_list|(
name|k
argument_list|)
condition|)
block|{
name|ldns_rr_set_owner
argument_list|(
name|pubkey
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|ldns_key_pubkey_owner
argument_list|(
name|k
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* third - da algorithm */
switch|switch
condition|(
name|ldns_key_algorithm
argument_list|(
name|k
argument_list|)
condition|)
block|{
case|case
name|LDNS_SIGN_RSAMD5
case|:
case|case
name|LDNS_SIGN_RSASHA1
case|:
case|case
name|LDNS_SIGN_RSASHA1_NSEC3
case|:
case|case
name|LDNS_SIGN_RSASHA256
case|:
case|case
name|LDNS_SIGN_RSASHA512
case|:
name|ldns_rr_push_rdf
argument_list|(
name|pubkey
argument_list|,
name|ldns_native2rdf_int8
argument_list|(
name|LDNS_RDF_TYPE_ALG
argument_list|,
name|ldns_key_algorithm
argument_list|(
name|k
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|rsa
operator|=
name|ldns_key_rsa_key
argument_list|(
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsa
condition|)
block|{
name|bin
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|LDNS_MAX_KEYLEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bin
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|ldns_key_rsa2bin
argument_list|(
name|bin
argument_list|,
name|rsa
argument_list|,
operator|&
name|size
argument_list|)
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|bin
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
name|internal_data
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
name|size
operator|++
expr_stmt|;
break|break;
case|case
name|LDNS_SIGN_DSA
case|:
name|ldns_rr_push_rdf
argument_list|(
name|pubkey
argument_list|,
name|ldns_native2rdf_int8
argument_list|(
name|LDNS_RDF_TYPE_ALG
argument_list|,
name|LDNS_DSA
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|dsa
operator|=
name|ldns_key_dsa_key
argument_list|(
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsa
condition|)
block|{
name|bin
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|LDNS_MAX_KEYLEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bin
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|ldns_key_dsa2bin
argument_list|(
name|bin
argument_list|,
name|dsa
argument_list|,
operator|&
name|size
argument_list|)
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|bin
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|DSA_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
name|internal_data
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* HAVE_SSL */
break|break;
case|case
name|LDNS_SIGN_DSA_NSEC3
case|:
name|ldns_rr_push_rdf
argument_list|(
name|pubkey
argument_list|,
name|ldns_native2rdf_int8
argument_list|(
name|LDNS_RDF_TYPE_ALG
argument_list|,
name|LDNS_DSA_NSEC3
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|dsa
operator|=
name|ldns_key_dsa_key
argument_list|(
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsa
condition|)
block|{
name|bin
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|LDNS_MAX_KEYLEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bin
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|ldns_key_dsa2bin
argument_list|(
name|bin
argument_list|,
name|dsa
argument_list|,
operator|&
name|size
argument_list|)
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|bin
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|DSA_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
name|internal_data
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* HAVE_SSL */
break|break;
case|case
name|LDNS_SIGN_ECC_GOST
case|:
name|ldns_rr_push_rdf
argument_list|(
name|pubkey
argument_list|,
name|ldns_native2rdf_int8
argument_list|(
name|LDNS_RDF_TYPE_ALG
argument_list|,
name|ldns_key_algorithm
argument_list|(
name|k
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SSL
argument_list|)
operator|&&
name|defined
argument_list|(
name|USE_GOST
argument_list|)
name|bin
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|LDNS_MAX_KEYLEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bin
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifndef|#
directive|ifndef
name|S_SPLINT_S
if|if
condition|(
operator|!
name|ldns_key_gost2bin
argument_list|(
name|bin
argument_list|,
name|k
operator|->
name|_key
operator|.
name|key
argument_list|,
operator|&
name|size
argument_list|)
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|bin
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
endif|#
directive|endif
comment|/* splint */
name|internal_data
operator|=
literal|1
expr_stmt|;
else|#
directive|else
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
endif|#
directive|endif
comment|/* HAVE_SSL and USE_GOST */
break|break;
case|case
name|LDNS_SIGN_ECDSAP256SHA256
case|:
case|case
name|LDNS_SIGN_ECDSAP384SHA384
case|:
ifdef|#
directive|ifdef
name|USE_ECDSA
name|ldns_rr_push_rdf
argument_list|(
name|pubkey
argument_list|,
name|ldns_native2rdf_int8
argument_list|(
name|LDNS_RDF_TYPE_ALG
argument_list|,
name|ldns_key_algorithm
argument_list|(
name|k
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|bin
operator|=
name|NULL
expr_stmt|;
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|ec
operator|=
name|EVP_PKEY_get1_EC_KEY
argument_list|(
name|k
operator|->
name|_key
operator|.
name|key
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|EC_KEY_set_conv_form
argument_list|(
name|ec
argument_list|,
name|POINT_CONVERSION_UNCOMPRESSED
argument_list|)
expr_stmt|;
name|size
operator|=
operator|(
name|uint16_t
operator|)
name|i2o_ECPublicKey
argument_list|(
name|ec
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|i2o_ECPublicKey
argument_list|(
name|ec
argument_list|,
operator|&
name|bin
argument_list|)
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|size
operator|>
literal|1
condition|)
block|{
comment|/* move back one byte to shave off the 0x02 				 * 'uncompressed' indicator that openssl made 				 * Actually its 0x04 (from implementation). 				 */
name|assert
argument_list|(
name|bin
index|[
literal|0
index|]
operator|==
name|POINT_CONVERSION_UNCOMPRESSED
argument_list|)
expr_stmt|;
name|size
operator|-=
literal|1
expr_stmt|;
name|memmove
argument_list|(
name|bin
argument_list|,
name|bin
operator|+
literal|1
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
comment|/* down the reference count for ec, its still assigned                          * to the pkey */
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
name|internal_data
operator|=
literal|1
expr_stmt|;
else|#
directive|else
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
endif|#
directive|endif
comment|/* ECDSA */
break|break;
case|case
name|LDNS_SIGN_HMACMD5
case|:
case|case
name|LDNS_SIGN_HMACSHA1
case|:
case|case
name|LDNS_SIGN_HMACSHA256
case|:
name|bin
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|ldns_key_hmac_size(k)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bin
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|pubkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ldns_rr_push_rdf
argument_list|(
name|pubkey
argument_list|,
name|ldns_native2rdf_int8
argument_list|(
name|LDNS_RDF_TYPE_ALG
argument_list|,
name|ldns_key_algorithm
argument_list|(
name|k
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|ldns_key_hmac_size
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|bin
argument_list|,
name|ldns_key_hmac_key
argument_list|(
name|k
argument_list|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|internal_data
operator|=
literal|1
expr_stmt|;
break|break;
block|}
comment|/* fourth the key bin material */
if|if
condition|(
name|internal_data
condition|)
block|{
name|keybin
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_B64
argument_list|,
name|size
argument_list|,
name|bin
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|bin
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|pubkey
argument_list|,
name|keybin
argument_list|)
expr_stmt|;
block|}
return|return
name|pubkey
return|;
block|}
end_function

begin_function
name|void
name|ldns_key_free
parameter_list|(
name|ldns_key
modifier|*
name|key
parameter_list|)
block|{
name|LDNS_FREE
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_deep_free
parameter_list|(
name|ldns_key
modifier|*
name|key
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|hmac
decl_stmt|;
if|if
condition|(
name|ldns_key_pubkey_owner
argument_list|(
name|key
argument_list|)
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|ldns_key_pubkey_owner
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|HAVE_SSL
if|if
condition|(
name|ldns_key_evp_key
argument_list|(
name|key
argument_list|)
condition|)
block|{
name|EVP_PKEY_free
argument_list|(
name|ldns_key_evp_key
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* HAVE_SSL */
if|if
condition|(
name|ldns_key_hmac_key
argument_list|(
name|key
argument_list|)
condition|)
block|{
name|hmac
operator|=
name|ldns_key_hmac_key
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|hmac
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|key
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_key_list_free
parameter_list|(
name|ldns_key_list
modifier|*
name|key_list
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_key_list_key_count
argument_list|(
name|key_list
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ldns_key_deep_free
argument_list|(
name|ldns_key_list_key
argument_list|(
name|key_list
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|key_list
operator|->
name|_keys
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|key_list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ldns_rr
modifier|*
name|ldns_read_anchor_file
parameter_list|(
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
comment|/*char line[LDNS_MAX_PACKETLEN];*/
name|char
modifier|*
name|line
init|=
name|LDNS_XMALLOC
argument_list|(
name|char
argument_list|,
name|LDNS_MAX_PACKETLEN
argument_list|)
decl_stmt|;
name|int
name|c
decl_stmt|;
name|size_t
name|i
init|=
literal|0
decl_stmt|;
name|ldns_rr
modifier|*
name|r
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
if|if
condition|(
operator|!
name|line
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|fp
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to open %s: %s\n"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|line
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|fgetc
argument_list|(
name|fp
argument_list|)
operator|)
operator|&&
name|i
operator|+
literal|1
operator|<
name|LDNS_MAX_PACKETLEN
operator|&&
name|c
operator|!=
name|EOF
condition|)
block|{
name|line
index|[
name|i
index|]
operator|=
name|c
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|line
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"nothing read from %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|line
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
name|status
operator|=
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|r
argument_list|,
name|line
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
operator|&&
operator|(
name|ldns_rr_get_type
argument_list|(
name|r
argument_list|)
operator|==
name|LDNS_RR_TYPE_DNSKEY
operator|||
name|ldns_rr_get_type
argument_list|(
name|r
argument_list|)
operator|==
name|LDNS_RR_TYPE_DS
operator|)
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|line
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error creating DNSKEY or DS rr from %s: %s\n"
argument_list|,
name|filename
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|line
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|ldns_key_get_file_base_name
parameter_list|(
name|ldns_key
modifier|*
name|key
parameter_list|)
block|{
name|ldns_buffer
modifier|*
name|buffer
decl_stmt|;
name|char
modifier|*
name|file_base_name
decl_stmt|;
name|buffer
operator|=
name|ldns_buffer_new
argument_list|(
literal|255
argument_list|)
expr_stmt|;
name|ldns_buffer_printf
argument_list|(
name|buffer
argument_list|,
literal|"K"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rdf2buffer_str_dname
argument_list|(
name|buffer
argument_list|,
name|ldns_key_pubkey_owner
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_buffer_printf
argument_list|(
name|buffer
argument_list|,
literal|"+%03u+%05u"
argument_list|,
name|ldns_key_algorithm
argument_list|(
name|key
argument_list|)
argument_list|,
name|ldns_key_keytag
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|file_base_name
operator|=
name|strdup
argument_list|(
name|ldns_buffer_export
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|file_base_name
return|;
block|}
end_function

begin_function
name|int
name|ldns_key_algo_supported
parameter_list|(
name|int
name|algo
parameter_list|)
block|{
name|ldns_lookup_table
modifier|*
name|lt
init|=
name|ldns_signing_algorithms
decl_stmt|;
while|while
condition|(
name|lt
operator|->
name|name
condition|)
block|{
if|if
condition|(
name|lt
operator|->
name|id
operator|==
name|algo
condition|)
return|return
literal|1
return|;
name|lt
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ldns_signing_algorithm
name|ldns_get_signing_algorithm_by_name
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
comment|/* list of (signing algorithm id, alias_name) */
name|ldns_lookup_table
name|aliases
index|[]
init|=
block|{
comment|/* from bind dnssec-keygen */
block|{
name|LDNS_SIGN_HMACMD5
block|,
literal|"HMAC-MD5"
block|}
block|,
block|{
name|LDNS_SIGN_DSA_NSEC3
block|,
literal|"NSEC3DSA"
block|}
block|,
block|{
name|LDNS_SIGN_RSASHA1_NSEC3
block|,
literal|"NSEC3RSASHA1"
block|}
block|,
comment|/* old ldns usage, now RFC names */
block|{
name|LDNS_SIGN_DSA_NSEC3
block|,
literal|"DSA_NSEC3"
block|}
block|,
block|{
name|LDNS_SIGN_RSASHA1_NSEC3
block|,
literal|"RSASHA1_NSEC3"
block|}
block|,
ifdef|#
directive|ifdef
name|USE_GOST
block|{
name|LDNS_SIGN_ECC_GOST
block|,
literal|"GOST"
block|}
block|,
endif|#
directive|endif
comment|/* compat with possible output */
block|{
name|LDNS_DH
block|,
literal|"DH"
block|}
block|,
block|{
name|LDNS_ECC
block|,
literal|"ECC"
block|}
block|,
block|{
name|LDNS_INDIRECT
block|,
literal|"INDIRECT"
block|}
block|,
block|{
name|LDNS_PRIVATEDNS
block|,
literal|"PRIVATEDNS"
block|}
block|,
block|{
name|LDNS_PRIVATEOID
block|,
literal|"PRIVATEOID"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
name|ldns_lookup_table
modifier|*
name|lt
init|=
name|ldns_signing_algorithms
decl_stmt|;
while|while
condition|(
name|lt
operator|->
name|name
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|lt
operator|->
name|name
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|lt
operator|->
name|id
return|;
name|lt
operator|++
expr_stmt|;
block|}
name|lt
operator|=
name|aliases
expr_stmt|;
while|while
condition|(
name|lt
operator|->
name|name
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|lt
operator|->
name|name
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|lt
operator|->
name|id
return|;
name|lt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|atoi
argument_list|(
name|name
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|atoi
argument_list|(
name|name
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

end_unit

